-- DDL Export
-- Server: 10.253.33.89
-- Database: ROLEMGM
-- Exported: 2026-02-05T02:39:26.000833

USE ROLEMGM;
GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnSplit
-- --------------------------------------------------
CREATE FUNCTION dbo.fnSplit(
    @sInputList VARCHAR(8000) -- List of delimited items
  , @sDelimiter VARCHAR(8000) = ',' -- delimiter that separates items
) RETURNS @List TABLE (item VARCHAR(8000))

BEGIN
DECLARE @sItem VARCHAR(8000)
WHILE CHARINDEX(@sDelimiter,@sInputList,0) <> 0
 BEGIN
 SELECT
  @sItem=RTRIM(LTRIM(SUBSTRING(@sInputList,1,CHARINDEX(@sDelimiter,@sInputList,0)-1))),
  @sInputList=RTRIM(LTRIM(SUBSTRING(@sInputList,CHARINDEX(@sDelimiter,@sInputList,0)+LEN(@sDelimiter),LEN(@sInputList))))
 
 IF LEN(@sItem) > 0
  INSERT INTO @List SELECT @sItem
 END

IF LEN(@sInputList) > 0
 INSERT INTO @List SELECT @sInputList -- Put the last item in
RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.random_password
-- --------------------------------------------------

CREATE Function random_password         
(          
@len int = 8, --Length of the password to be generated          
@password_type char(7) = 'simple'           
--Default is to generate a simple password with lowecase letters.           
--Pass anything other than 'simple' to generate a complex password.           
--The complex password includes numbers, special characters, upper case and lower case letters          
)   
Returns varchar(15)         
AS          
Begin  
/*************************************************************************************************          
  Copyright Â© 2001 Angel Broking Ltd. All rights reserved.          
                                                    
Purpose: To generate a random password          
          
Written by: Manesh Mukherjee          
          
Tested on:  SQL Server 7.0 and SQL Server 2000          
          
Date modified: March-29-2001 01:15 PM          
          
Email:   manesh@angelbroking.com          
          
Examples:          
          
To generate a simple password with a length of 8 characters:          
EXEC random_password2          
          
To generate a simple password with 6 characters:          
EXEC random_password2 6          
          
To generate a complex password with 8 characters:          
EXEC random_password @Password_type = 'complex'          
          
To generate a comples password with 6 characters:          
EXEC random_password 6, 'complex'          
*************************************************************************************************/          
        
DECLARE @password varchar(25), @type tinyint, @bitmap char(6)          
SET @password=''           
--SET @bitmap = '#$%^&~!'           
SET @bitmap = 'aeruoy'           
--@bitmap contains all the vowels, which are a, e, i, o, u and y. These vowels are used to generate slightly readable/rememberable simple passwords          
IF @password_type <> 'simple'         
begin        
  select @password = @password + SUBSTRING(@bitmap,CONVERT(int,ROUND(1 + (RandNum * (5)),0)),1) from Vw_RAND         
  set @len = @len-1        
end        
SET @bitmap = 'aerouy'           
--set @len =len(@password)        
        
WHILE @len > 0          
BEGIN          
 IF @password_type = 'simple' --Generating a simple password          
 BEGIN          
  IF (@len%2) = 0  --Appending a random vowel to @password          
    select @password = @password + SUBSTRING(@bitmap,CONVERT(int,ROUND(1 + (RandNum * (5)),0)),1)   from Vw_RAND               
  ELSE --Appending a random alphabet          
    select @password = @password + CHAR(ROUND(97 + (RandNum * (25)),0))      from Vw_RAND            
  END          
 ELSE --Generating a complex password          
  BEGIN          
  select @type = ROUND(1 + (RandNum * (3)),0)  from Vw_RAND                    
          
   IF @type = 1 --Appending a random lower case alphabet to @password          
    select @password = @password + CHAR(ROUND(97 + (RandNum * (25)),0))     from Vw_RAND             
 ELSE IF @type = 2 --Appending a random upper case alphabet to @password          
    select @password = @password + CHAR(ROUND(65 + (RandNum * (25)),0))     from Vw_RAND            
 ELSE IF @type = 3 --Appending a random number between 0 and 9 to @password          
    select @password = @password + CHAR(ROUND(48 + (RandNum * (9)),0))        from Vw_RAND         
 ELSE IF @type = 4 --Appending a random special character to @password          
--    below ascii code is off. replace with numeric code between 0 and 9      
--    SET @password = @password + CHAR(ROUND(33 + (RAND() * (13)),0))         
    select @password = @password + CHAR(ROUND(48 + (RandNum * (9)),0))     from Vw_RAND             
  END          
  SET @len = @len - 1          
END          
          
return @password --Here's the result          
          
END

GO

-- --------------------------------------------------
-- INDEX dbo.AIAAS_ExEmpActiveLogin_data
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxpty] ON [dbo].[AIAAS_ExEmpActiveLogin_data] ([segment], [BO_LoginId])

GO

-- --------------------------------------------------
-- INDEX dbo.cat_mapping
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_cat] ON [dbo].[cat_mapping] ([cat_code])

GO

-- --------------------------------------------------
-- INDEX dbo.cat_mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_emp_menu] ON [dbo].[cat_mapping] ([cat_code], [menu_code])

GO

-- --------------------------------------------------
-- INDEX dbo.emp_info
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_emp_no] ON [dbo].[emp_info] ([emp_no]) INCLUDE ([Emp_name])

GO

-- --------------------------------------------------
-- INDEX dbo.exclude_cat_mapping
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Idx_Menu_cd] ON [dbo].[exclude_cat_mapping] ([MENU_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.exclude_cat_mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_exclude_cat_mapping_EMP_NO_MENU_CODE] ON [dbo].[exclude_cat_mapping] ([EMP_NO], [MENU_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.EXTRA_CAT_MAPPING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_emp_menu] ON [dbo].[EXTRA_CAT_MAPPING] ([EMP_NO], [MENU_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.EXTRA_CAT_MAPPING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Idx_Menu_cd] ON [dbo].[EXTRA_CAT_MAPPING] ([MENU_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.login_logs
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_userid] ON [dbo].[login_logs] ([userid], [report_path])

GO

-- --------------------------------------------------
-- INDEX dbo.login_logs
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_userid1] ON [dbo].[login_logs] ([userid]) INCLUDE ([report_path], [Access_datetime])

GO

-- --------------------------------------------------
-- INDEX dbo.login_logs
-- --------------------------------------------------
CREATE CLUSTERED INDEX [reppath] ON [dbo].[login_logs] ([report_path])

GO

-- --------------------------------------------------
-- INDEX dbo.menu_cat
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx] ON [dbo].[menu_cat] ([cat_code])

GO

-- --------------------------------------------------
-- INDEX dbo.menu_item
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_active] ON [dbo].[menu_item] ([active]) INCLUDE ([menu_code])

GO

-- --------------------------------------------------
-- INDEX dbo.menu_item
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Head_active] ON [dbo].[menu_item] ([Sub_Head], [active]) INCLUDE ([Head], [menu_name])

GO

-- --------------------------------------------------
-- INDEX dbo.menu_item
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PK__menu_item__7F74FAA2] ON [dbo].[menu_item] ([menu_code])

GO

-- --------------------------------------------------
-- INDEX dbo.menu_item
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [url] ON [dbo].[menu_item] ([menu_url])

GO

-- --------------------------------------------------
-- INDEX dbo.menu_item_audit
-- --------------------------------------------------
CREATE CLUSTERED INDEX [menuid] ON [dbo].[menu_item_audit] ([Menu_url])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.TempUserMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_TempUserMaster_username] ON [dbo].[TempUserMaster] ([username])

GO

-- --------------------------------------------------
-- INDEX dbo.user_login
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_person_name] ON [dbo].[user_login] ([person_name], [access_code]) INCLUDE ([cat_code], [last_login])

GO

-- --------------------------------------------------
-- INDEX dbo.user_login
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_user_login_usertype_access_code_status_login_inactive_date] ON [dbo].[user_login] ([usertype], [access_code], [status], [login_inactive_date])

GO

-- --------------------------------------------------
-- INDEX dbo.user_login
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_USERNAME] ON [dbo].[user_login] ([username], [person_name], [access_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.menu_cat2
-- --------------------------------------------------
ALTER TABLE [dbo].[menu_cat2] ADD CONSTRAINT [PK__menu_cat2__08EA5793] PRIMARY KEY ([cat_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.menu_item
-- --------------------------------------------------
ALTER TABLE [dbo].[menu_item] ADD CONSTRAINT [PK_menu_item] PRIMARY KEY ([menu_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sqlmapoutput
-- --------------------------------------------------
ALTER TABLE [dbo].[sqlmapoutput] ADD CONSTRAINT [PK__sqlmapou__3213E83F507016CE] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__1881A0DE] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_inhouse_pwd_log
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_inhouse_pwd_log] ADD CONSTRAINT [PK_tbl_inhouse_pwd_log] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_TraineeOrTempStaff
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_TraineeOrTempStaff] ADD CONSTRAINT [PK__tbl_TraineeOrTem__6F7F8B4B] PRIMARY KEY ([Username])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.user_login
-- --------------------------------------------------
ALTER TABLE [dbo].[user_login] ADD CONSTRAINT [PK__user_login__01C75768] PRIMARY KEY ([userid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.user_login_28jul2021
-- --------------------------------------------------
ALTER TABLE [dbo].[user_login_28jul2021] ADD CONSTRAINT [PK__user_login__01C757681] PRIMARY KEY ([userid])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AIAAS_30DaysOldTestMenuItem
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[AIAAS_30DaysOldTestMenuItem]                           
AS                            
          
SET NOCOUNT ON          
BEGIN                            
          
select update_on,    
Head+'/'+Sub_head+'/'+Menu_name as OptionName,    
Menu_Desc as MDesc,    
Owner_name, Developer_name='Angel Inhouse'    
INTO #BOUSER         
from Vw_menu_item where active='Y' and head='Test'     
and convert(Datetime,update_on) < getdate()-30    
order by convert(Datetime,update_on)     
                 
DECLARE @COUNT AS INT              
               
select @COUNT=COUNT(DISTINCT OptionName) FROM #BOUSER              
SELECT DISTINCT update_on INTO #SYN FROM #BOUSER              
               
SELECT  ROW_NUMBER() OVER(ORDER BY convert(Datetime,update_on)) AS  'ROWNUM',* INTO #SYN1                              
FROM #SYN              
               
               
--DECLARE @COUNT AS INT                  
if( @COUNT>0)              
BEGIN              
               
DECLARE @TABLEHTML1 AS NVARCHAR(MAX);                                                                                                                                                                    
                                                                
 SET @TABLEHTML1 =                                                                     
 N'Dear Testing Team,<BR><BR>' +                                                                                               
 N'Kindly note : The below mentioned menu-items are still active under Testing enviornment for more than 30 days. AIAAS System will deactivate the below mentioned link at the end of this month. <br>We request you to kindly look into the matter<BR><BR>'   
  
               
 +N'<TABLE  BORDER="1" ALIGN="CENTER" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#FFFFFF" BGCOLOR="#D5C9F1"'    
 +N'STYLE="BORDER:#000000 SOLID 1PX;FONT-SIZE:10PX;FONT-FAMILY:ARIAL">'    
 +N'<TR>'                                             
 +N'<TD HEIGHT="15" COLSPAN="6" BGCOLOR="#2C204B" ALIGN=CENTER><FONT COLOR=WHITE SIZE="3"><B>Menu-Item Under TEST for > 30 days in INHOUSE</B></FONT> </TD>'                                                          
 +N'</TR>' +                                                                                                                                                                      
 +N'<TR>'                                                             
 +N'<TH WIDTH: 69PX; HEIGHT: 21PX; BGCOLOR="#AA98D3">SR. NO</TH> '                                                          
 +N'<TH "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Option</TH> '                                                                                                                                                                    
 +N'<TH "WIDTH: 700PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Description</TH> '                                                                                                                                                                    
 +N'<TH "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Func.Owner</TH> '             
 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Developer</TH> '                                
 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3" noWRAP >Date</TH> '            
 +N'</TR>'+                            
                             
                          
 CAST((          
 SELECT                          
 TD =  ROW_NUMBER() OVER( ORDER BY convert(Datetime,A.update_on),convert(Datetime,A.update_on)),'',                                         
 TD = A.OptionName,'',                                           
 TD = A.MDesc,'',                                           
 TD = A.Owner_name,'',                                           
 TD = A.Developer_name, '',    
 TD = A.update_on, ''    
 FROM #BOUSER A              
      JOIN  #SYN1 B              
      ON A.update_on=B.update_on                              
            --WHERE B.ROWNUM=@COUNT             
        ORDER BY convert(Datetime,A.update_on)                                
      FOR XML PATH('TR'),TYPE        
                
      ) AS NVARCHAR(MAX)) +                             
                                       
                                  
 '</TR>' +                             
 +N' </TABLE><BR><BR><BR><BR>'                             
                                          
 +N' <TABLE> '+                                            
 +N' <TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >FOR ANY INFORMATION EMAIL :- INHOUSE.SUPPORT@ANGELBROKING.COM <BR><BR></TD></TR>'                            
 +N'<TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >Angel Inhouse Auto Audit System (AIAAS)</TD></TR>'                            
 +N'<TR><TD STYLE="FONT-SIZE: 12PX" ,FONT:BOLD >Managed by: Angel Inhouse Software Team</TD></TR>'                            
 +N'</TABLE><BR> <BR>'                                                                                                        
 +N'This is an automated system generated information for your reference. Please do not reply.<BR>Angel Broking'                             
               
               
                                       
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                                       
@RECIPIENTS  = 'bhavin@angelbroking.com',                                                                                
@COPY_RECIPIENTS = 'renil.pillai@angelbroking.com;rohit.patil@angelbroking.com',    
@BLIND_COPY_RECIPIENTS='',                                                                                                   
@PROFILE_NAME = 'DBA',                                                                                                                      
@BODY_FORMAT ='HTML',                                           
@SUBJECT = 'INHOUSE: Menu-Item Under TEST for > 30 days',                                        
@importance='High',    
@BODY = @TABLEHTML1                                                                                                                 
/* PRINT @TABLEHTML1  */    
                                                                    
               
 END              
  END           
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AIAAS_block_UsedLink
-- --------------------------------------------------
CREATE PROC AIAAS_BLOCK_USEDLINK                    
AS                          
                    
SET NOCOUNT ON                         
                  
/* LINK NOT USED SINCE LAST 90 DAYS */                    
SELECT USERID,REPORT_PATH,LAST_ACCESS=MAX(ACCESS_DATETIME )               
INTO #TEMP               
FROM LOGIN_LOGS(NOLOCK)               
GROUP BY USERID,REPORT_PATH                          
HAVING MAX(ACCESS_DATETIME )<= GETDATE()-90                    
                    
SELECT USERNAME,MENU_CODE,'AIAAS' AS MAPPED_BY,GETDATE() AS MAPPED_ON                   
INTO #FX                  
FROM USER_LOGIN A  WITH (NOLOCK),                    
(SELECT * FROM #TEMP WHERE LAST_ACCESS <= GETDATE()-90) B,                    
MENU_ITEM C WITH (NOLOCK)                    
WHERE A.USERID=B.USERID AND STATUS=1 AND B.REPORT_PATH=C.MENU_URL AND C.ACTIVE='Y' AND A.ACCESS_TO NOT IN ('SB','SBMAST')                    
AND USERNAME NOT IN                    
(      
Select USERNAME='E01089'      
union
Select USERNAME='E01072'      
union
Select USERNAME='N00002'      
UNION      
SELECT USERNAME FROM USER_LOGIN WHERE USERNAME IN (SELECT EMP_NO FROM DBO.EMP_INFO WHERE SENIOR='E01089' AND STATUS='A')      
)                    
/* SELECT * FROM EMP_INFO WHERE DESIGNATION LIKE '%DIRECTOR%' */                    
                  
                  
/* LINK NOT USED AT ALL BUT ACTIVATED BEFORE 90 DAYS */                  
SELECT * INTO #F1 FROM MENU_ITEM WITH (NOLOCK) WHERE ACTIVE='Y' AND CONVERT(DATETIME,UPDATE_ON) <= GETDATE()-90                  
                  
SELECT * INTO #F2 FROM                   
(SELECT A.* FROM                   
(SELECT * FROM MENU_ITEM WITH (NOLOCK) WHERE ACTIVE='Y' AND CONVERT(DATETIME,UPDATE_ON) <= GETDATE()-90) A LEFT OUTER JOIN                   
(SELECT DISTINCT REPORT_PATH FROM LOGIN_LOGS WITH (NOLOCK)) B                   
ON A.MENU_URL=B.REPORT_PATH WHERE B.REPORT_PATH IS NULL                  
) X                   
                  
                  
INSERT INTO #FX                  
SELECT USERNAME,MENU_CODE,'AIAAS',GETDATE()                    
FROM USER_LOGIN X WITH (NOLOCK),                   
(SELECT A.*,B.HEAD,B.SUB_HEAD,B.MENU_NAME,B.MENU_URL,B.MENU_DESC FROM CAT_MAPPING A WITH (NOLOCK) JOIN #F2 B ON A.MENU_CODE=B.MENU_CODE) Y                  
WHERE X.CAT_CODE=Y.CAT_CODE                  
AND USERNAME NOT IN                    
(SELECT USERNAME FROM USER_LOGIN WHERE USERNAME IN (SELECT EMP_NO FROM DBO.EMP_INFO WHERE SENIOR in ('E01089','N00002','E01072','E15305','E01088') AND STATUS='A'))                    
                  
INSERT INTO EXCLUDE_CAT_MAPPING            
SELECT * FROM #FX WHERE LEN(USERNAME) <= 10  and username+convert(varchar(10),menu_code) not in           
(select emp_no+convert(varchar(10),menu_code) from EXCLUDE_CAT_MAPPING(nolock))              
                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AIAAS_ExEmpActiveLogin_Fetch
-- --------------------------------------------------

CREATE procedure [dbo].[AIAAS_ExEmpActiveLogin_Fetch]  
as    
set nocount on    
    
truncate table AIAAS_ExEmpActiveLogin_data   
    
--NCDEX    
Select fldusername into #AIAAS_UserInfo_angelcommodity from angelcommodity.inhouse_ncdx.dbo.AIAAS_UserInfo where active='Yes'    
    
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NCDEX',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #AIAAS_UserInfo_angelcommodity a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
    
drop table #AIAAS_UserInfo_angelcommodity    
    
--BSECM    
select fldusername into #aiaas_userinfo_anand from AngelBSECM.inhouse.dbo.AIAAS_UserInfo where active='Yes'    
    
insert into AIAAS_ExEmpActiveLogin_data  
select segment='BSECM',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #aiaas_userinfo_anand a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
    
drop table #aiaas_userinfo_anand    
    
---NSECM    
select fldusername into #aiaas_userinfo_anand1 from AngelNseCM.inhouse.dbo.AIAAS_UserInfo where active='Yes'    
    
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NSECM',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #aiaas_userinfo_anand1 a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
  
drop table #aiaas_userinfo_anand1    
    
--NSEFO    
select fldusername into #aiaas_userinfo_anandfo from angelfo.inhouse.dbo.AIAAS_UserInfo where active='Yes'    
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NSEFO',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #aiaas_userinfo_anandfo a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
  
drop table #aiaas_userinfo_anandfo    
    
--NSX    
select fldusername into #aiaas_userinfo_anandfo1 from angelfo.inhouse_curfo.dbo.AIAAS_UserInfo where active='Yes'    
    
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NSX',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #aiaas_userinfo_anandfo1 a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
  
drop table #aiaas_userinfo_anandfo1    
    
--MCD    
select fldusername into #aiaas_userinfo_angelcommodity1 from angelcommodity.inhouse_mcdcs.dbo.AIAAS_UserInfo where active='Yes'    
    
insert into AIAAS_ExEmpActiveLogin_data  
select segment='MCD',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #aiaas_userinfo_angelcommodity1 a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
  
  
drop table #aiaas_userinfo_angelcommodity1    
    
--MCX    
select fldusername into #aiaas_userinfo_anandcommodity2 from angelcommodity.inhouse_mcdx.dbo.AIAAS_UserInfo where active='Yes'    
    
insert into AIAAS_ExEmpActiveLogin_data  
select segment='MCX',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #aiaas_userinfo_anandcommodity2 a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
  
  
drop table #aiaas_userinfo_anandcommodity2    
    
--NBFC
select fldusername into #aiaas_userinfo_nbfc from ABCSONBFC.inhouse.dbo.AIAAS_UserInfo where active='Yes'    
    
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NBFC',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from        
 #aiaas_userinfo_nbfc a,        
risk.dbo.Vw_EmpInfoBlock  b        
where CHARINDEX(b.emp_no,fldusername) > 0    
  
  
drop table #aiaas_userinfo_nbfc    
    
/* -- Activate Project Tracker for PRMS rRoject Owner and co-ordinator -- */    
insert into extra_cat_mapping  
select distinct emp_no,2714,'system',getdate() from mis.dbo.PRMS_PC_PO where emp_no not in    
(select emp_no from extra_cat_mapping where menu_code=2714)    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AIAAS_ExEmpActiveLogin_Fetch_25032014
-- --------------------------------------------------
CREATE procedure AIAAS_ExEmpActiveLogin_Fetch_25032014  
as  
set nocount on  
truncate table AIAAS_ExEmpActiveLogin_data  
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NCDEX',* from angelcommodity.inhouse_ncdx.dbo.AIAAS_ExEmpActiveLogin  
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='BSECM',* from anand.inhouse.dbo.AIAAS_ExEmpActiveLogin  
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NSECM',* from anand1.inhouse.dbo.AIAAS_ExEmpActiveLogin  
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NSEFO',* from angelfo.inhouse.dbo.AIAAS_ExEmpActiveLogin  
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='NSX',* from angelfo.inhouse_curfo.dbo.AIAAS_ExEmpActiveLogin  
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='MCD',* from angelcommodity.inhouse_mcdcs.dbo.AIAAS_ExEmpActiveLogin  
  
insert into AIAAS_ExEmpActiveLogin_data  
select segment='MCX',* from angelcommodity.inhouse_mcdx.dbo.AIAAS_ExEmpActiveLogin  
  
  
/* -- Activate Project Tracker for PRMS rRoject Owner and co-ordinator -- */  
insert into extra_cat_mapping   
select distinct emp_no,2714,'system',getdate() from intranet.mis.dbo.PRMS_PC_PO where emp_no not in  
(select emp_no from extra_cat_mapping where menu_code=2714)  
  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AIAAS_ExEmpActiveLogin_Fetch_new
-- --------------------------------------------------
CREATE procedure [dbo].[AIAAS_ExEmpActiveLogin_Fetch_new]
as
set nocount on

truncate table AIAAS_ExEmpActiveLogin_data_new

--NCDEX
Select fldusername into #AIAAS_UserInfo_angelcommodity from angelcommodity.inhouse_ncdx.dbo.AIAAS_UserInfo where active='Yes'

insert into AIAAS_ExEmpActiveLogin_data_new
select segment='NCDEX',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
 #AIAAS_UserInfo_angelcommodity a,    
risk.dbo.Vw_EmpInfoBlock  b    
where CHARINDEX(b.emp_no,fldusername) > 0

drop table #AIAAS_UserInfo_angelcommodity

--BSECM
select fldusername into #aiaas_userinfo_anand from AngelBSECM.inhouse.dbo.AIAAS_UserInfo where active='Yes'

insert into AIAAS_ExEmpActiveLogin_data_new
select segment='BSECM',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
 #aiaas_userinfo_anand a,    
risk.dbo.Vw_EmpInfoBlock  b    
where CHARINDEX(b.emp_no,fldusername) > 0

drop table #aiaas_userinfo_anand

---NSECM
select fldusername into #aiaas_userinfo_anand1 from AngelNseCM.inhouse.dbo.AIAAS_UserInfo where active='Yes'

insert into AIAAS_ExEmpActiveLogin_data_new
select segment='NSECM',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
 #aiaas_userinfo_anand1 a,    
risk.dbo.Vw_EmpInfoBlock  b    
where CHARINDEX(b.emp_no,fldusername) > 0
drop table #aiaas_userinfo_anand1

--NSEFO
select fldusername into #aiaas_userinfo_anandfo from angelfo.inhouse.dbo.AIAAS_UserInfo where active='Yes'

insert into AIAAS_ExEmpActiveLogin_data_new
select segment='NSEFO',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
 #aiaas_userinfo_anandfo a,    
risk.dbo.Vw_EmpInfoBlock  b    
where CHARINDEX(b.emp_no,fldusername) > 0
drop table #aiaas_userinfo_anandfo

--NSX
select fldusername into #aiaas_userinfo_anandfo1 from angelfo.inhouse_curfo.dbo.AIAAS_UserInfo where active='Yes'

insert into AIAAS_ExEmpActiveLogin_data_new
select segment='NSX',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
 #aiaas_userinfo_anandfo1 a,    
risk.dbo.Vw_EmpInfoBlock  b    
where CHARINDEX(b.emp_no,fldusername) > 0
drop table #aiaas_userinfo_anandfo1

--MCD
select fldusername into #aiaas_userinfo_angelcommodity1 from angelcommodity.inhouse_mcdcs.dbo.AIAAS_UserInfo where active='Yes'

insert into AIAAS_ExEmpActiveLogin_data_new
select segment='MCD',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
 #aiaas_userinfo_angelcommodity1 a,    
risk.dbo.Vw_EmpInfoBlock  b    
where CHARINDEX(b.emp_no,fldusername) > 0
drop table #aiaas_userinfo_angelcommodity1

--MCX
select fldusername into #aiaas_userinfo_anandcommodity2 from angelcommodity.inhouse_mcdx.dbo.AIAAS_UserInfo where active='Yes'

insert into AIAAS_ExEmpActiveLogin_data_new
select segment='MCX',fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
 #aiaas_userinfo_anandcommodity2 a,    
risk.dbo.Vw_EmpInfoBlock  b    
where CHARINDEX(b.emp_no,fldusername) > 0
drop table #aiaas_userinfo_anandcommodity2


/* -- Activate Project Tracker for PRMS rRoject Owner and co-ordinator -- */
insert into extra_cat_mapping_new
select distinct emp_no,2714,'system',getdate() from mis.dbo.PRMS_PC_PO where emp_no not in
(select emp_no from extra_cat_mapping where menu_code=2714)

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AIAAS_Status
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[AIAAS_Status]                         

AS                          

        

SET NOCOUNT ON        

BEGIN                          







CREATE TABLE #JobInfo(

[job_id] [uniqueidentifier] NULL,

[originating_server] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[name] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[enabled] [tinyint] NULL,

[description] [nvarchar](512) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[start_step_id] [int] NULL,

[category] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[owner] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[notify_level_eventlog] [int] NULL,

[notify_level_email] [int] NULL,

[notify_level_netsend] [int] NULL,

[notify_level_page] [int] NULL,

[notify_email_operator] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[notify_netsend_operator] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[notify_page_operator] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[delete_level] [int] NULL,

[date_created] [datetime] NULL,

[date_modified] [datetime] NULL,

[version_number] [int] NULL,

[last_run_date] [int] NOT NULL,

[last_run_time] [int] NOT NULL,

[last_run_outcome] [int] NOT NULL,

[next_run_date] [int] NOT NULL,

[next_run_time] [int] NOT NULL,

[next_run_schedule_id] [int] NOT NULL,

[current_execution_status] [int] NOT NULL,

[current_execution_step] [nvarchar](128) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,

[current_retry_attempt] [int] NOT NULL,

[has_step] [int] NULL,

[has_schedule] [int] NULL,

[has_target] [int] NULL,

[type] [int] NOT NULL

)



insert into #JobInfo execute [INTRANET].msdb.dbo.sp_help_job 

insert into #JobInfo execute mis.msdb.dbo.sp_help_job 

insert into #JobInfo execute [CSOKYC-6].msdb.dbo.sp_help_job 



select 

originating_server as [server],name,enabled,description,

owner,convert(varchar(11),date_created) as date_created,

convert(varchar(11),date_modified) as date_modified,

convert(varchar(11),last_run_date) as last_run_date,

Case 

when last_run_outcome=0 then 'Failed'

when last_run_outcome=1 then 'Success'

when last_run_outcome=5 then 'Not Scheduled'

else 'Unknown' end as last_run_outcome

,

convert(varchar(11),next_run_date) as next_run_date

into #jobstatemail

from #JobInfo where last_run_outcome=0 order by server,name







DECLARE @COUNT AS INT            

select @COUNT=count(1) FROM #jobstatemail

             

SELECT  ROW_NUMBER() OVER(ORDER BY server,name) AS  'ROWNUM',* INTO #SYN1                            

FROM #jobstatemail

             

             

--DECLARE @COUNT AS INT                

if( @COUNT>0)            

BEGIN            

             

DECLARE @TABLEHTML1 AS NVARCHAR(MAX);                                                                                                                                                                  

                                                              

 SET @TABLEHTML1 =                                                                   

 N'Dear Testing Team,<BR><BR>' +                                                                                             

 N'Kindly note : The below mentioned Jobs failed. <BR><BR>'                

 +N'<TABLE  BORDER="1" ALIGN="CENTER" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#FFFFFF" BGCOLOR="#D5C9F1"'  

 +N'STYLE="BORDER:#000000 SOLID 1PX;FONT-SIZE:10PX;FONT-FAMILY:ARIAL">'  

 +N'<TR>'                                           

 +N'<TD HEIGHT="15" COLSPAN="6" BGCOLOR="#2C204B" ALIGN=CENTER><FONT COLOR=WHITE SIZE="3"><B>Menu-Item Under TEST for > 30 days in INHOUSE</B></FONT> </TD>'                                                        

 +N'</TR>' +                                                                                                                                                                    

 +N'<TR>'                                                           

 +N'<TH WIDTH: 69PX; HEIGHT: 21PX; BGCOLOR="#AA98D3">SR. NO</TH> '                                                        

 +N'<TH "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Server</TH> '                                                                                                                                                                  

 +N'<TH "WIDTH: 700PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Name</TH> '                                                                                                                                                                  

 +N'<TH "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Enabled</TH> '           

 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Description</TH> '                              

 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Owner</TH> '                              

 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Created on </TH> '                              

 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Modified on </TH> '                              

 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Last Run Date</TH> '                              

 +N'<TH  "WIDTH: 500PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Next Run Date</TH> '                              

 +N'</TR>'+                          

                           

                        

 CAST((        

 SELECT                        

 TD =  ROW_NUMBER() OVER( ORDER BY server,name),'',                                       

 TD = A.server,'',                                         

 TD = A.name,'',                                         

 TD = A.enabled,'',                                         

 TD = A.description, '',  

 TD = A.owner, '',  

 TD = A.date_Created, '',

 TD = A.date_modified, '',

 TD = A.last_run_date, '',

 TD = A.last_run_outcome, '',

 TD = A.next_run_date, ''

 FROM #BOUSER A            

      JOIN  #SYN1 B            

      ON A.update_on=B.update_on                            

        ORDER BY server,name                              

      FOR XML PATH('TR'),TYPE        

              

      ) AS NVARCHAR(MAX)) +                           

                                     

                                

 '</TR>' +                           

 +N' </TABLE><BR><BR><BR><BR>'                           

                                        

 +N' <TABLE> '+                                          

 +N' <TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >FOR ANY INFORMATION EMAIL :- INHOUSE.SUPPORT@ANGELBROKING.COM <BR><BR></TD></TR>'                          

 +N'<TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >ANGEL INHOUSE AUTO AUDIT SYSTEM(AIAAS)</TD></TR>'                          

 +N'<TR><TD STYLE="FONT-SIZE: 12PX" ,FONT:BOLD >MANAGED BY ANGEL INHOUSE SOFTWARE TEAM</TD></TR>'                          

 +N'</TABLE><BR> <BR>'                                                                                                      

 +N'THIS IS AN AUTOMATED SYSTEM GENERATED INFORMATION FOR YOUR REFERENCE.PLEASE DO NOT REPLY.<BR>ANGEL BROKING '                           

             

             

                                     

 EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                                     

/* @RECIPIENTS  = 'manesh@angelbroking.com;renil.pillai@angelbroking.com', */

@RECIPIENTS  = 'renil.pillai@angelbroking.com', 

/* @COPY_RECIPIENTS = 'Helpdeskloginmgmt@angelbroking.com;', */                                                                                                        

@BLIND_COPY_RECIPIENTS='renil.pillai@angelbroking.com;',                                                                                                 

@PROFILE_NAME = 'DBA',                                                                                                                    

@BODY_FORMAT ='HTML',                                  

@SUBJECT = 'INHOUSE: Failed Job List',                                      

@BODY = @TABLEHTML1                                                                                                               

PRINT @TABLEHTML1                            

                                                                  

             

 END            

  END         

        

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AIAAS_Upd_SysAdminCat
-- --------------------------------------------------
CREATE procedure [dbo].[AIAAS_Upd_SysAdminCat]
as

set nocount on

insert into cat_mapping
select (select cat_Code from user_login with (nolock) where username='E10398') as Cat_Code,
menu_Code,'System',getdate() from menu_item where active='Y' 
and menu_code not in (select menu_code from Cat_mapping where cat_code=5)

delete from EXTRA_CAT_MAPPING where emp_no='E10398'
/* delete from exclude_cat_mapping where emp_no='E01089' */

delete from cat_mapping where menu_code in
(select menu_Code from menu_item where active='N' ) and cat_code=5

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AngelInhouseOptionsInformation_Email
-- --------------------------------------------------
CREATE procedure [dbo].[AngelInhouseOptionsInformation_Email]            
as                        
SET NOCOUNT ON                        
                        
DECLARE             
@remarks varchar(25),            
@Cat_name  varchar(25),            
@Head  varchar(25),            
@Sub_head  varchar(25),            
@Menu_name  varchar(25),            
@menu_desc  varchar(100),            
@Person_name  varchar(50),            
@Status  varchar(25),            
@Login_inactive_date  varchar(25),            
@email  varchar(50),            
@username  varchar(25),            
@mess varchar(5000)            
            
                  
            
DECLARE error_cursor CURSOR FOR                         
select a.remarks,b.Cat_name,c.Head,c.Sub_head,c.Menu_name,c.menu_desc,Person_name,Status,            
Login_inactive_date,email,username            
from MenuOptionAction a , menu_cat b (nolock),            
menu_item c (nolock), (Select * from user_login (nolock) where status=1 and email <> '') d            
where a.cat_Code=b.Cat_code and a.menu_Code=c.menu_code and a.cat_Code=d.cat_code            
--and username in ('E02069','E00131','E01089')            
order by username            
            
            
            
OPEN error_cursor                        
                        
FETCH NEXT FROM error_cursor                         
INTO @remarks,@Cat_name,@Head,@Sub_head,@Menu_name,@menu_desc,@Person_name,@Status,@Login_inactive_date,@email,@username             
            
            
declare @uname varchar(25),@stCtr int,@pemail as varchar(50)            
set @uname = ''            
set @stCtr=0            
set @pemail = ''            
                        
WHILE @@FETCH_STATUS = 0                        
BEGIN                        
            
if @uname <> @username and @StCtr > 0            
begin            
 --- send mail            
            
  set @mess = @mess +'</table ><br><Br>'            
--  set @mess = @mess +'NOTE: Your login will expire on '+@Login_inactive_date+'. Please change the Password before the expiry Date.<br>'            
  set @mess = @mess +char(10)+char(10)+'by Software Changes Tracker Application.<Br>'             
--  set @mess = @mess +char(10)+'This is system generated error Message. Please do not reply.<br>The option is also available in Angel Inhouse-Support/Whats New and Unchecked Options.<br><br>'                        
  set @mess = @mess +char(10)+'This is system generated Message. Please do not reply.<br><br>'                        
  set @mess = @mess +char(10) +char(10)+'Angel Broking'+char(10) +char(10)+'<br><br><br>Software Department'            
            
          
 /* exec mis.master.dbo.xp_smtp_sendmail                 
  @TO = @pemail,                         
  @from = 'soft@angelbroking.com',                         
--  @BCC = 'manesh@angelbroking.com,shweta.tiwari@angeltrade.com',                         
  @subject = 'Angel-Inhouse Options/Link Changes Information',                         
  @server = 'angelmail.angelbroking.com',                        
  @type='text/html',            
  @message=@mess                        */
exec msdb.dbo.sp_send_dbmail
@profile_name='intranet',
@recipients=@pemail , 
@subject = 'Angel-Inhouse Options/Link Changes Information' ,
@body=@mess,
@body_format = 'HTML'--,
--@mailitem_id = @mailitem_id output
--print @mailitem_id
          
-- print @mess          
            
  set @mess = 'Dear '+@Person_name+',<Br><Br>'+char(10) +char(10)                   
  set @mess = @mess +'Following changes has been done on your Angel inhouse Option/Links:<br><br>'            
  set @mess = @mess +'<table border=1><tr><td><b>Action</b></td><td><b>Menu Heading/Sub-heading/Options</b></td><td><b>Description</b></td></tr>'            
            
end             
            
if @uname <> @username and @StCtr = 0            
begin            
  set @mess = 'Dear '+@Person_name+',<Br><Br>'+char(10) +char(10)                   
  set @mess = @mess +'Following changes has been done on your Angel inhouse Option/Links:<br><br>'            
  set @mess = @mess +'<table border=1><tr><td><b>Action</b></td><td><b>Menu Heading/Sub-heading/Options</b></td><td><b>Description</b></td></tr>'            
          
end              
            
 set @mess = @mess +'<tr><td>'+@remarks+'</td><td>'+@Head+'/'+@Sub_Head+'/'+@Menu_name+'</td><td>'+@menu_desc+'</td></tr>'            
            
  set @uname=@username            
  set @pemail=@email            
  set @stCtr=1            
          
  FETCH NEXT FROM error_cursor                         
  INTO @remarks,@Cat_name,@Head,@Sub_head,@Menu_name,@menu_desc,@Person_name,@Status,@Login_inactive_date,@email,@username             
                        
END                        
  set @mess = @mess +'</table ><br><Br>'            
--  set @mess = @mess +'NOTE: Your login will expire on '+@Login_inactive_date+'. Please change the Password before the expiry Date.<br>'            
  set @mess = @mess +char(10)+char(10)+'by Software Changes Tracker Application.<Br>'             
--  set @mess = @mess +char(10)+'This is system generated error Message. Please do not reply.<br>The option is also available in Angel Inhouse-Support/Whats New and Unchecked Options.<br><br>'                 
  set @mess = @mess +char(10)+'This is system generated Message. Please do not reply.<br><br>'                        
  set @mess = @mess +char(10) +char(10)+'Angel Broking'+char(10) +char(10)+'<br><br><br>Software Department'            
--  EXEC master..xp_smtp_sendmail                         
          
exec msdb.dbo.sp_send_dbmail
@profile_name='intranet',
@recipients=@pemail , 
@subject = 'Angel-Inhouse Options/Link Changes Information' ,
@body=@mess,
@body_format = 'HTML'--,
--@mailitem_id = @mailitem_id output                   
          
-- print @mess          
CLOSE error_cursor                        
DEALLOCATE error_cursor                        
            
          
truncate table cat_mapping_pd             
insert into cat_mapping_pd select cat_Code,Menu_Code from cat_mapping (nolock)            
          
                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BO_DeLoginEmail
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BO_DeLoginEmail]                             
                              
AS                              
            
SET NOCOUNT ON            
BEGIN                              
            
/* deactivate bo login - START */            
            
UPDATE AngelBSECM.bsedb_Ab.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from AngelBSECM.bsedb_Ab.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='BSECM')            
) AND FLDSTATUS=0            
            
            
UPDATE AngelNseCM.MSAJAG.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from AngelNseCM.MSAJAG.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NSECM')            
) AND FLDSTATUS=0            
            
            
UPDATE ANGELFO.NSEFO.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELFO.NSEFO.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NSEFO')            
) AND FLDSTATUS=0            
            
UPDATE ANGELFO.NSECURFO.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELFO.NSECURFO.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NSX')            
) AND FLDSTATUS=0            
            
UPDATE ANGELCOMMODITY.MCDX.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELCOMMODITY.MCDX.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='MCX')            
) AND FLDSTATUS=0            
            
UPDATE ANGELCOMMODITY.MCDXCDS.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELCOMMODITY.MCDXCDS.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='MCD')            
) AND FLDSTATUS=0            
            
UPDATE ANGELCOMMODITY.NCDX.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELCOMMODITY.NCDX.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NCDEX')            
) AND FLDSTATUS=0            

UPDATE ABCSONBFC.NBFC.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ABCSONBFC.NBFC.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NBFC')            
) AND FLDSTATUS=0                
            
/* deactivate BO Login - END */            
/* SELECT * INTO #BOUSER FROM AIAAS_BoExEmpActiveLogin order by segment  */          
          
select a.*,          
Case when b.emp_no is null then 'Quit' else 'Chng' end as [Type]           
INTO #BOUSER           
from AIAAS_BoExEmpActiveLogin a left outer join intranet.risk.dbo.Emp_CostCodeChange b          
on a.emp_no=b.emp_no          
order by segment                
          
          
                   
DECLARE @COUNT AS INT                
                 
select @COUNT=COUNT(DISTINCT BO_Loginid) FROM #BOUSER                
SELECT DISTINCT BO_Loginid INTO #SYN FROM #BOUSER                
                 
SELECT  ROW_NUMBER() OVER(ORDER BY BO_Loginid DESC) AS  'ROWNUM',* INTO #SYN1                                
FROM #SYN                
                 
                 
--DECLARE @COUNT AS INT                    
if( @COUNT>0)                
BEGIN                
                 
DECLARE @TABLEHTML1 AS NVARCHAR(MAX);                                                                                                                                                                      
                                                                  
 SET @TABLEHTML1 =                                                    
 N'Dear All,<BR><BR>' +                    
 N'Kindly note : The below mentioned ex-employees Back-office logins has been deactivated by the system.<BR><BR>'                    
 +N'Ex-employee user information enclosed.<BR><BR>'+                                                
 N'<TABLE  BORDER="1" ALIGN="CENTER" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#FFFFFF" BGCOLOR="#D5C9F1"                             
 STYLE="BORDER:#000000 SOLID 1PX;FONT-SIZE:10PX;FONT-FAMILY:ARIAL">'                                                                                       
                              
 +N'<TR>'                                               
 +N'<TD HEIGHT="15" COLSPAN="8" BGCOLOR="#2C204B" ALIGN=CENTER><FONT COLOR=WHITE SIZE="3"><B>EX-EMPLOYEE IN BACK-OFFICE</B></FONT> </TD>'                                                            
 +N'</TR>' +                                                                                                                                                                        
 +N'<TR>'                                                               
 +N'<TH WIDTH: 69PX; HEIGHT: 21PX; BGCOLOR="#AA98D3">SR. NO</TH> '                                                            
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">SEGMENT</TH> '                                                                                                                                                                      
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">USER ID</TH> '                                                                                                                                                                      
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">EMP.CODE</TH> '               
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">EMP.NAME</TH> '                                  
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">SEPERATION DATE</TH> '              
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">COST CODE</TH> '              
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">TYPE</TH> '              
 +N'</TR>'+                              
                               
                             
 CAST((            
 SELECT                            
 TD =  ROW_NUMBER() OVER( ORDER BY A.BO_LOGINID ,A.BO_LOGINID),'',                                           
 TD = A.SEGMENT,'',                                             
 TD = CONVERT(VARBINARY(MAX),A.BO_LOGINID),'',  --error for xml                                           
 TD = A.EMP_NO,'',                                             
 TD = A.EMP_NAME, '',                                             
 TD = CONVERT(VARCHAR(11),A.SEPARATIONDATE), '',                                             
 TD = A.COSTCODE, '',                                             
 TD = A.TYPE, ''                                             
FROM #BOUSER A                
      JOIN  #SYN1 B                
      ON A.BO_LOGINID=B.BO_LOGINID                                
            --WHERE B.ROWNUM=@COUNT                 
        ORDER BY A.BO_LOGINID                                  
      FOR XML PATH('TR'),TYPE            
                  
      ) AS NVARCHAR(MAX)) +                               
                                         
                                    
 '</TR>' +                               
 +N' </TABLE><BR><BR><BR><BR>'                               
                                            
 +N' <TABLE> '+                                              
 +N' <TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >FOR ANY INFORMATION EMAIL :- INHOUSE.SUPPORT@ANGELBROKING.COM <BR><BR></TD></TR>'                              
 +N'<TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >ANGEL INHOUSE AUTO AUDIT SYSTEM(AIAAS)</TD></TR>'                              
 +N'<TR><TD STYLE="FONT-SIZE: 12PX" ,FONT:BOLD >MANAGED BY ANGEL INHOUSE SOFTWARE TEAM</TD></TR>'            
 +N'</TABLE><BR> <BR>'                                                                                                          
 +N'THIS IS AN AUTOMATED SYSTEM GENERATED INFORMATION FOR YOUR REFERENCE.PLEASE DO NOT REPLY.<BR>ANGEL BROKING '                               
                 
                 
                                         
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                       
@RECIPIENTS  = 'Helpdeskloginmgmt@angelbroking.com;',                                                                                  
@COPY_RECIPIENTS = 'bo.support@angelbroking.com', 
--@RECIPIENTS  =@RECIPIENT,                       
--@RECIPIENTS  = 'MANESH@ANGELBROKING.COM;',                                 
--@BLIND_COPY_RECIPIENTS= 'renil.pillai@angelbroking.com;',                    
--@BLIND_COPY_RECIPIENTS='ZEBA.RAJE@ANGELBROKING.COM;',                                                                                                     
@PROFILE_NAME = 'DBA',                                                                                                                        
@BODY_FORMAT ='HTML',                                             
@SUBJECT = 'EX-EMPLOYEE OF BACK-OFFICE',                                          
@BODY = @TABLEHTML1                                                                                                                   
--PRINT @TABLEHTML1                                
                                                                      
                 
 END                
  END             
        
exec AIAAS_Upd_SysAdminCat        
              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BO_DeLoginEmail_16062016
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BO_DeLoginEmail_16062016]                             
                              
AS                              
            
SET NOCOUNT ON            
BEGIN                              
            
/* deactivate bo login - START */            
            
UPDATE ANAND.bsedb_Ab.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANAND.bsedb_Ab.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='BSECM')            
) AND FLDSTATUS=0            
            
            
UPDATE ANAND1.MSAJAG.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANAND1.MSAJAG.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NSECM')            
) AND FLDSTATUS=0            
            
            
UPDATE ANGELFO.NSEFO.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELFO.NSEFO.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NSEFO')            
) AND FLDSTATUS=0            
            
UPDATE ANGELFO.NSECURFO.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELFO.NSECURFO.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NSX')            
) AND FLDSTATUS=0            
            
UPDATE ANGELCOMMODITY.MCDX.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELCOMMODITY.MCDX.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='MCX')            
) AND FLDSTATUS=0            
            
UPDATE ANGELCOMMODITY.MCDXCDS.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELCOMMODITY.MCDXCDS.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='MCD')            
) AND FLDSTATUS=0            
            
UPDATE ANGELCOMMODITY.NCDX.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from ANGELCOMMODITY.NCDX.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NCDEX')            
) AND FLDSTATUS=0            

UPDATE [172.31.16.57].NBFC.dbo.tblUserControlMaster SET FLDSTATUS=1 WHERE flduserid IN            
(SELECT FLDAUTO from [172.31.16.57].NBFC.dbo.tblpradnyausers WITH (NOLOCK) WHERE FLDUSERNAME IN            
(SELECT BO_LOGINID FROM ROLEMGM.DBO.AIAAS_BoExEmpActiveLogin WITH (NOLOCK) WHERE SEGMENT='NBFC')            
) AND FLDSTATUS=0                
            
/* deactivate BO Login - END */            
/* SELECT * INTO #BOUSER FROM AIAAS_BoExEmpActiveLogin order by segment  */          
          
select a.*,          
Case when b.emp_no is null then 'Quit' else 'Chng' end as [Type]           
INTO #BOUSER           
from AIAAS_BoExEmpActiveLogin a left outer join intranet.risk.dbo.Emp_CostCodeChange b          
on a.emp_no=b.emp_no          
order by segment                
          
          
                   
DECLARE @COUNT AS INT                
                 
select @COUNT=COUNT(DISTINCT BO_Loginid) FROM #BOUSER                
SELECT DISTINCT BO_Loginid INTO #SYN FROM #BOUSER                
                 
SELECT  ROW_NUMBER() OVER(ORDER BY BO_Loginid DESC) AS  'ROWNUM',* INTO #SYN1                                
FROM #SYN                
                 
                 
--DECLARE @COUNT AS INT                    
if( @COUNT>0)                
BEGIN                
                 
DECLARE @TABLEHTML1 AS NVARCHAR(MAX);                                                                                                                                                                      
                                                                  
 SET @TABLEHTML1 =                                                    
 N'Dear All,<BR><BR>' +                    
 N'Kindly note : The below mentioned ex-employees Back-office logins has been deactivated by the system.<BR><BR>'                    
 +N'Ex-employee user information enclosed.<BR><BR>'+                                                
 N'<TABLE  BORDER="1" ALIGN="CENTER" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#FFFFFF" BGCOLOR="#D5C9F1"                             
 STYLE="BORDER:#000000 SOLID 1PX;FONT-SIZE:10PX;FONT-FAMILY:ARIAL">'                                                                                       
                              
 +N'<TR>'                                               
 +N'<TD HEIGHT="15" COLSPAN="8" BGCOLOR="#2C204B" ALIGN=CENTER><FONT COLOR=WHITE SIZE="3"><B>EX-EMPLOYEE IN BACK-OFFICE</B></FONT> </TD>'                                                            
 +N'</TR>' +                                                                                                                                                                        
 +N'<TR>'                                                               
 +N'<TH WIDTH: 69PX; HEIGHT: 21PX; BGCOLOR="#AA98D3">SR. NO</TH> '                                                            
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">SEGMENT</TH> '                                                                                                                                                                      
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">USER ID</TH> '                                                                                                                                                                      
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">EMP.CODE</TH> '               
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">EMP.NAME</TH> '                                  
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">SEPERATION DATE</TH> '              
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">COST CODE</TH> '              
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">TYPE</TH> '              
 +N'</TR>'+                              
                               
                             
 CAST((            
 SELECT                            
 TD =  ROW_NUMBER() OVER( ORDER BY A.BO_LOGINID ,A.BO_LOGINID),'',                                           
 TD = A.SEGMENT,'',                                             
 --TD = A.BO_LOGINID,'',                                             
 TD =CONVERT(VARBINARY(MAX),A.BO_LOGINID),'',
 TD = A.EMP_NO,'',                                             
 TD = A.EMP_NAME, '',                                             
 TD = CONVERT(VARCHAR(11),A.SEPARATIONDATE), '',                                             
 TD = A.COSTCODE, '',                                             
 TD = A.TYPE, ''                                             
FROM #BOUSER A                
      JOIN  #SYN1 B                
      ON A.BO_LOGINID=B.BO_LOGINID                                
            --WHERE B.ROWNUM=@COUNT                 
        ORDER BY A.BO_LOGINID                                  
      FOR XML PATH('TR'),TYPE            
                  
      ) AS NVARCHAR(MAX)) +                               
                                         
                                    
 '</TR>' +                               
 +N' </TABLE><BR><BR><BR><BR>'                               
                                            
 +N' <TABLE> '+                                              
 +N' <TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >FOR ANY INFORMATION EMAIL :- INHOUSE.SUPPORT@ANGELBROKING.COM <BR><BR></TD></TR>'                              
 +N'<TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >ANGEL INHOUSE AUTO AUDIT SYSTEM(AIAAS)</TD></TR>'                              
 +N'<TR><TD STYLE="FONT-SIZE: 12PX" ,FONT:BOLD >MANAGED BY ANGEL INHOUSE SOFTWARE TEAM</TD></TR>'            
 +N'</TABLE><BR> <BR>'                                                                                                          
 +N'THIS IS AN AUTOMATED SYSTEM GENERATED INFORMATION FOR YOUR REFERENCE.PLEASE DO NOT REPLY.<BR>ANGEL BROKING '                               
                 
                 
                                         
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                       
@RECIPIENTS  = 'Helpdeskloginmgmt@angelbroking.com;',                                                                                  
@COPY_RECIPIENTS = 'isms@angelbroking.com;bo.support@angelbroking.com', 
--@RECIPIENTS  =@RECIPIENT,                       
--@RECIPIENTS  = 'MANESH@ANGELBROKING.COM;',                                 
@BLIND_COPY_RECIPIENTS= 'renil.pillai@angelbroking.com;',                    
--@BLIND_COPY_RECIPIENTS='ZEBA.RAJE@ANGELBROKING.COM;',                                                                                                     
@PROFILE_NAME = 'DBA',                                                                                                                        
@BODY_FORMAT ='HTML',                                             
@SUBJECT = 'EX-EMPLOYEE OF BACK-OFFICE',                                          
@BODY = @TABLEHTML1                                                                                                                   
PRINT @TABLEHTML1                                
                                                                      
                 
 END                
  END             
        
exec AIAAS_Upd_SysAdminCat        
              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BO_RM_pswd_automation
-- --------------------------------------------------
CREATE procedure [dbo].[BO_RM_pswd_automation]
as
set nocount on

select NAME=MAX(NAME),SUB_brOKER,BRANCH_coDe into #fileRem        
FROM SUBBROKERS WHERE LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)) NOT IN        
(SELECT  username FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )           
and sub_broker not in (select sbtag from branch) --and sub_broker='RPCB'         
GROUP BY SUB_bROKER,BRANCH_coDe  

select NAME=MAX(NAME),SUB_brOKER,contact_person=max(contact_person) into #filesb        
FROM SUBBROKERS WHERE SUB_BROKER NOT IN        
(SELECT  ACCESS_cODE FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )        
GROUP BY SUB_bROKER       

delete from #filesb where sub_broker in (select sbtag from branch)      

delete from #filesb where sub_broker not in (select sub_broker from #filerem)

declare @k as int, @sb as varchar(10),@p as int
select @k=count(*) from #filesb

declare @sbcd as varchar(10),@Adminpswd as varchar(10),@pswd as varchar(10),@flName as varchar(50),@remCD as varchar(15)

declare @emlCnt as int,@mailid as varchar(100),@mob as varchar(11),@AdminUser varchar(50),@Name Varchar(100)

declare @ss as table                                
(Password varchar(25))                                

while(@k > 0)
begin
begin
		
		select @sb=sub_broker from (
		SELECT ROW_NUMBER()         
		  OVER (order by SUB_brOKER) AS Row,NAME ,sub_broker,contact_person        
		  FROM #filesb) as sb_cd where Row=@k

		select name,sub_broker,Password=space(10),contact_person into #temp_sb from (
		SELECT ROW_NUMBER()         
		  OVER (order by SUB_brOKER) AS Row,NAME ,sub_broker,contact_person        
		  FROM #filesb) as sb_cd where Row=@k

		insert into @ss (password) exec ctcl.dbo.random_password1 8,''                                 
		  update @ss set password=replace(password,'O','x')           
		  update @ss set password=replace(password,'0','q')           
		  update @ss set password=replace(password,'B','e')           
		  update @ss set password=replace(password,'8','n')           
		  update @ss set password=replace(password,'5','k')           
		  update @ss set password=replace(password,'S','d')           
		  update @ss set password=replace(password,'1','w')           
		  update @ss set password=replace(password,'I','z')           
		  update @ss set password=replace(password,'L','v')           
		  update @ss set password=lower(password)           
		      
		  update  #temp_sb set password=b.password from @ss b where #temp_sb.SUB_brOKER=@sb 

		  delete from @ss  

		update #temp_sb set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113 and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114 and  #temp_sb.SUB_brOKER= @sb                             
		update #temp_sb set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122 and  #temp_sb.SUB_brOKER= @sb                             
		update #temp_sb set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118 and  #temp_sb.SUB_brOKER= @sb                             
		                              
		update #temp_sb set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i') and  #temp_sb.SUB_brOKER= @sb                       
		update #temp_sb set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')  and  #temp_sb.SUB_brOKER= @sb  
		update #temp_sb set password = substring(password,1,4)+'e'+substring(password,6,3) where ascii(substring(password,5,1))=ascii('j')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')  and  #temp_sb.SUB_brOKER= @sb                     
		update #temp_sb set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n') and  #temp_sb.SUB_brOKER= @sb                       

		insert into USER_LOGIN        
		(person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)        
		SELECT NAME,SUB_brOKER,password,'USER','SB',SUB_brOKER,35,1,GETDATE(),10,10,GETDATE(),'Dec 31 2010','N','',        
		'','N','','N',0,'System',getDate()        
		from #temp_sb 
		
		select @sbcd=SUB_brOKER,@pswd=password,@flName=contact_person from #temp_sb
		---------------execution procedure call for bo updation-------------
		--exec newUserWithPswd @sbcd,@pswd,@flName,'14','9'

		exec  anand.bsefo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'14','9'
		exec  anand.bsedb_ab.dbo.newUserWithPswd @sbcd,@pswd,@flName,'1369','1160'
		exec  angelcommodity.mcdxcds.dbo.newUserWithPswd @sbcd,@pswd,@flName,'12','7' 
		exec  angelcommodity.mcdx.dbo.newUserWithPswd @sbcd,@pswd,@flName,'93','62' 
		exec  angelcommodity.ncdx.dbo.newUserWithPswd @sbcd,@pswd,@flName,'236','185'
		exec  angelfo.nsefo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'272','234' 
		exec  anand1.msajag.dbo.newUserWithPswd @sbcd,@pswd,@flName,'207','136' 
		exec  angelfo.nsecurfo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'276','13' 

		insert into ctcl.dbo.BO_Client_Password values (@sbcd,@pswd,getdate(),'','Reset','System')

		insert into USER_LOGIN        
		(person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)        
		SELECT NAME,LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),@pswd,        
		'ADMIN','SB',SUB_brOKER,76,1,GETDATE(),10,10,GETDATE(),'Mar 31 2049','N','',        
		'','N','','N',0,'System',getDate()        
		from #fileRem where SUB_brOKER=@sb

		SELECT @AdminUser=LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),@pswd=@pswd
		,@Name=NAME
		from #fileRem where SUB_brOKER=@sb
	

		--EXEC usp_BeeNXTSubbrokerMail @AdminUser,@pswd,@sbcd,@Name


		SELECT @remCD=LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)) from #fileRem where SUB_brOKER=@sb

		select sub_broker=regtag,email=max(regEmailid),mobile=max(regmobile) into #email
		from mis.sb_comp.dbo.bpregmaster 
		where regtag=@sb and isnull(regEmailid,'')<>''
		group by regtag 
		
		select @emlCnt=count(*) from #email
	
		if @emlCnt<>0 
		begin
			select @mailid=email,@mob=mobile from #email 
			exec BO_RM_Automail 'r',@sb,@remCD,@pswd,@mailid,@mob
			---------------execute mail and sms send procedure 
		end
		else
		begin
			exec BO_RM_Automail 'n',@sb,@remCD,'','feedback@angeltrade.com',''
			--------------execute mail for feed back
		end

	drop table #email
	drop table #temp_sb
	
	set @k=@k-1 
end
end
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BO_RM_pswd_automation_29082019
-- --------------------------------------------------
Create  procedure [dbo].[BO_RM_pswd_automation_29082019]
as
set nocount on

select NAME=MAX(NAME),SUB_brOKER,BRANCH_coDe into #fileRem        
FROM SUBBROKERS WHERE LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)) NOT IN        
(SELECT  username FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )           
and sub_broker not in (select sbtag from branch) --and sub_broker='RPCB'         
GROUP BY SUB_bROKER,BRANCH_coDe  

select NAME=MAX(NAME),SUB_brOKER,contact_person=max(contact_person) into #filesb        
FROM SUBBROKERS WHERE SUB_BROKER NOT IN        
(SELECT  ACCESS_cODE FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )        
GROUP BY SUB_bROKER       

delete from #filesb where sub_broker in (select sbtag from branch)      

delete from #filesb where sub_broker not in (select sub_broker from #filerem)

declare @k as int, @sb as varchar(10),@p as int
select @k=count(*) from #filesb

declare @sbcd as varchar(10),@Adminpswd as varchar(10),@pswd as varchar(10),@flName as varchar(50),@remCD as varchar(15)

declare @emlCnt as int,@mailid as varchar(100),@mob as varchar(11),@AdminUser varchar(50),@Name Varchar(100)

declare @ss as table                                
(Password varchar(25))                                

while(@k > 0)
begin
begin
		
		select @sb=sub_broker from (
		SELECT ROW_NUMBER()         
		  OVER (order by SUB_brOKER) AS Row,NAME ,sub_broker,contact_person        
		  FROM #filesb) as sb_cd where Row=@k

		select name,sub_broker,Password=space(10),contact_person into #temp_sb from (
		SELECT ROW_NUMBER()         
		  OVER (order by SUB_brOKER) AS Row,NAME ,sub_broker,contact_person        
		  FROM #filesb) as sb_cd where Row=@k

		insert into @ss (password) exec ctcl.dbo.random_password1 8,''                                 
		  update @ss set password=replace(password,'O','x')           
		  update @ss set password=replace(password,'0','q')           
		  update @ss set password=replace(password,'B','e')           
		  update @ss set password=replace(password,'8','n')           
		  update @ss set password=replace(password,'5','k')           
		  update @ss set password=replace(password,'S','d')           
		  update @ss set password=replace(password,'1','w')           
		  update @ss set password=replace(password,'I','z')           
		  update @ss set password=replace(password,'L','v')           
		  update @ss set password=lower(password)           
		      
		  update  #temp_sb set password=b.password from @ss b where #temp_sb.SUB_brOKER=@sb 

		  delete from @ss  

		update #temp_sb set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113 and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114 and  #temp_sb.SUB_brOKER= @sb                             
		update #temp_sb set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73  and  #temp_sb.SUB_brOKER= @sb                            
		update #temp_sb set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122 and  #temp_sb.SUB_brOKER= @sb                             
		update #temp_sb set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118 and  #temp_sb.SUB_brOKER= @sb                             
		                              
		update #temp_sb set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i') and  #temp_sb.SUB_brOKER= @sb                       
		update #temp_sb set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')  and  #temp_sb.SUB_brOKER= @sb  
		update #temp_sb set password = substring(password,1,4)+'e'+substring(password,6,3) where ascii(substring(password,5,1))=ascii('j')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')  and  #temp_sb.SUB_brOKER= @sb                      
		update #temp_sb set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')  and  #temp_sb.SUB_brOKER= @sb                     
		update #temp_sb set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n') and  #temp_sb.SUB_brOKER= @sb                       

		insert into USER_LOGIN        
		(person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)        
		SELECT NAME,SUB_brOKER,password,'USER','SB',SUB_brOKER,35,1,GETDATE(),10,10,GETDATE(),'Dec 31 2010','N','',        
		'','N','','N',0,'System',getDate()        
		from #temp_sb 
		
		select @sbcd=SUB_brOKER,@pswd=password,@flName=contact_person from #temp_sb
		---------------execution procedure call for bo updation-------------
		--exec newUserWithPswd @sbcd,@pswd,@flName,'14','9'

		exec  anand.bsefo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'14','9'
		exec  anand.bsedb_ab.dbo.newUserWithPswd @sbcd,@pswd,@flName,'1369','1160'
		exec  angelcommodity.mcdxcds.dbo.newUserWithPswd @sbcd,@pswd,@flName,'12','7' 
		exec  angelcommodity.mcdx.dbo.newUserWithPswd @sbcd,@pswd,@flName,'93','62' 
		exec  angelcommodity.ncdx.dbo.newUserWithPswd @sbcd,@pswd,@flName,'236','185'
		exec  angelfo.nsefo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'272','234' 
		exec  anand1.msajag.dbo.newUserWithPswd @sbcd,@pswd,@flName,'207','136' 
		exec  angelfo.nsecurfo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'276','13' 

		insert into ctcl.dbo.BO_Client_Password values (@sbcd,@pswd,getdate(),'','Reset','System')

		insert into USER_LOGIN        
		(person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)        
		SELECT NAME,LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),@pswd,        
		'ADMIN','SB',SUB_brOKER,76,1,GETDATE(),10,10,GETDATE(),'Mar 31 2049','N','',        
		'','N','','N',0,'System',getDate()        
		from #fileRem where SUB_brOKER=@sb

		SELECT @AdminUser=LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),@pswd=@pswd
		,@Name=NAME
		from #fileRem where SUB_brOKER=@sb
	

		--EXEC usp_BeeNXTSubbrokerMail @AdminUser,@pswd,@sbcd,@Name


		SELECT @remCD=LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)) from #fileRem where SUB_brOKER=@sb

		select sub_broker=regtag,email=max(regEmailid),mobile=max(regmobile) into #email
		from mis.sb_comp.dbo.bpregmaster 
		where regtag=@sb and isnull(regEmailid,'')<>''
		group by regtag 
		
		select @emlCnt=count(*) from #email
	
		if @emlCnt<>0 
		begin
			select @mailid=email,@mob=mobile from #email 
			exec BO_RM_Automail 'r',@sb,@remCD,@pswd,@mailid,@mob
			---------------execute mail and sms send procedure 
		end
		else
		begin
			exec BO_RM_Automail 'n',@sb,@remCD,'','feedback@angeltrade.com',''
			--------------execute mail for feed back
		end

	drop table #email
	drop table #temp_sb
	
	set @k=@k-1 
end
end
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BO_RM_pswd_automation_Test
-- --------------------------------------------------
CREATE procedure [dbo].[BO_RM_pswd_automation_Test]  
as  
set nocount on  
  
select NAME=MAX(NAME),SUB_brOKER,BRANCH_coDe into #fileRem          
FROM SUBBROKERS WHERE LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)) NOT IN          
(SELECT  username FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )             
and sub_broker not in (select sbtag from branch) --and sub_broker='RPCB'           
GROUP BY SUB_bROKER,BRANCH_coDe    
  
select NAME=MAX(NAME),SUB_brOKER,contact_person=max(contact_person) into #filesb          
FROM SUBBROKERS WHERE SUB_BROKER NOT IN          
(SELECT  ACCESS_cODE FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )          
GROUP BY SUB_bROKER         
  
delete from #filesb where sub_broker in (select sbtag from branch)        
  
delete from #filesb where sub_broker not in (select sub_broker from #filerem)  
  
declare @k as int, @sb as varchar(10),@p as int  
select @k=count(*) from #filesb  
  
declare @sbcd as varchar(10),@Adminpswd as varchar(10),@pswd as varchar(10),@flName as varchar(50),@remCD as varchar(15)  
  
declare @emlCnt as int,@mailid as varchar(100),@mob as varchar(11),@AdminUser varchar(50),@Name Varchar(100)  
  
declare @ss as table                                  
(Password varchar(25))                                  
  
while(@k > 0)  
begin  
begin  
    
  select @sb=sub_broker from (  
  SELECT ROW_NUMBER()           
    OVER (order by SUB_brOKER) AS Row,NAME ,sub_broker,contact_person          
    FROM #filesb) as sb_cd where Row=@k  
  
  select name,sub_broker,Password=space(10),contact_person into #temp_sb from (  
  SELECT ROW_NUMBER()           
    OVER (order by SUB_brOKER) AS Row,NAME ,sub_broker,contact_person          
    FROM #filesb) as sb_cd where Row=@k  
  
  insert into @ss (password) exec ctcl.dbo.random_password1 8,''                                   
    update @ss set password=replace(password,'O','x')             
    update @ss set password=replace(password,'0','q')             
    update @ss set password=replace(password,'B','e')             
    update @ss set password=replace(password,'8','n')             
    update @ss set password=replace(password,'5','k')             
    update @ss set password=replace(password,'S','d')             
    update @ss set password=replace(password,'1','w')             
    update @ss set password=replace(password,'I','z')             
    update @ss set password=replace(password,'L','v')             
    update @ss set password=lower(password)             
          
    update  #temp_sb set password=b.password from @ss b where #temp_sb.SUB_brOKER=@sb   
  
    delete from @ss    
  
  update #temp_sb set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113 and  #temp_sb.SUB_brOKER= @sb                              
  update #temp_sb set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70  and  #temp_sb.SUB_brOKER= @sb                              
  update #temp_sb set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69  and  #temp_sb.SUB_brOKER= @sb                              
  update #temp_sb set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71  and  #temp_sb.SUB_brOKER= @sb                              
  update #temp_sb set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114 and  #temp_sb.SUB_brOKER= @sb                               
  update #temp_sb set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73  and  #temp_sb.SUB_brOKER= @sb                              
  update #temp_sb set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122 and  #temp_sb.SUB_brOKER= @sb                               
  update #temp_sb set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118 and  #temp_sb.SUB_brOKER= @sb                         
                                  
  update #temp_sb set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i') and  #temp_sb.SUB_brOKER= @sb                         
  update #temp_sb set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')  and  #temp_sb.SUB_brOKER= @sb                        
  update #temp_sb set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')  and  #temp_sb.SUB_brOKER= @sb                        
  update #temp_sb set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')  and  #temp_sb.SUB_brOKER= @sb    
  update #temp_sb set password = substring(password,1,4)+'e'+substring(password,6,3) where ascii(substring(password,5,1))=ascii('j')  and  #temp_sb.SUB_brOKER= @sb                        
  update #temp_sb set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')  and  #temp_sb.SUB_brOKER= @sb                        
  update #temp_sb set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')  and  #temp_sb.SUB_brOKER= @sb                       
  update #temp_sb set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n') and  #temp_sb.SUB_brOKER= @sb                         
  
  insert into USER_LOGIN          
  (person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)          
  SELECT NAME,SUB_brOKER,password,'USER','SB',SUB_brOKER,35,1,GETDATE(),10,10,GETDATE(),'Dec 31 2010','N','',          
  '','N','','N',0,'System',getDate()          
  from #temp_sb   
    
  select @sbcd=SUB_brOKER,@pswd=password,@flName=contact_person from #temp_sb  
  ---------------execution procedure call for bo updation-------------  
  --exec newUserWithPswd @sbcd,@pswd,@flName,'14','9'  
  
  exec  anand.bsefo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'14','9'  
  exec  anand.bsedb_ab.dbo.newUserWithPswd @sbcd,@pswd,@flName,'1369','1160'  
  exec  angelcommodity.mcdxcds.dbo.newUserWithPswd @sbcd,@pswd,@flName,'12','7'   
  exec  angelcommodity.mcdx.dbo.newUserWithPswd @sbcd,@pswd,@flName,'93','62'   
  exec  angelcommodity.ncdx.dbo.newUserWithPswd @sbcd,@pswd,@flName,'236','185'  
  exec  angelfo.nsefo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'272','234'   
  exec  anand1.msajag.dbo.newUserWithPswd @sbcd,@pswd,@flName,'207','136'   
  exec  angelfo.nsecurfo.dbo.newUserWithPswd @sbcd,@pswd,@flName,'276','13'   
  
  insert into ctcl.dbo.BO_Client_Password values (@sbcd,@pswd,getdate(),'','Reset','System')  
  
  insert into USER_LOGIN          
  (person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)          
  SELECT NAME,LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),@pswd,          
  'ADMIN','SB',SUB_brOKER,76,1,GETDATE(),10,10,GETDATE(),'Mar 31 2049','N','',          
  '','N','','N',0,'System',getDate()          
  from #fileRem where SUB_brOKER=@sb  
  
  SELECT @AdminUser=LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),@pswd=@pswd  
  ,@Name=NAME  
  from #fileRem where SUB_brOKER=@sb  
   
  
  --EXEC usp_BeeNXTSubbrokerMail @AdminUser,@pswd,@sbcd,@Name  
  
  
  SELECT @remCD=LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)) from #fileRem where SUB_brOKER=@sb  
  
  select sub_broker=regtag,email=max(regEmailid),mobile=max(regmobile) into #email  
  from mis.sb_comp.dbo.bpregmaster   
  where regtag=@sb and isnull(regEmailid,'')<>''  
  group by regtag   
    
  select @emlCnt=count(*) from #email  
   
  if @emlCnt<>0   
  begin  
   select @mailid=email,@mob=mobile from #email   
   exec BO_RM_Automail 'r',@sb,@remCD,@pswd,@mailid,@mob  
   ---------------execute mail and sms send procedure   
  end  
  else  
  begin  
   exec BO_RM_Automail 'n',@sb,@remCD,'','feedback@angeltrade.com',''  
   --------------execute mail for feed back  
  end  
  
 drop table #email  
 drop table #temp_sb  
   
 set @k=@k-1   
end  
end  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BR_LIMI_UPD
-- --------------------------------------------------
CREATE PROCEDURE BR_LIMI_UPD  
(  
 @BRCODE AS VARCHAR(10),  
 @LIMIT AS MONEY  
)  
    
AS    
  
DECLARE @ISTHERE AS INT    
SELECT @ISTHERE=COUNT(*) FROM INTRANET.RISK.DBO.BR_LIMIT WHERE SBTAG=@BRCODE    
  
IF @ISTHERE > 0     
BEGIN    
 UPDATE INTRANET.RISK.DBO.BR_LIMIT SET LIMIT=@LIMIT WHERE SBTAG = @BRCODE    
END    
  
ELSE    
BEGIN    
 INSERT INTO INTRANET.RISK.DBO.BR_LIMIT (SBTAG,LIMIT) VALUES(@BRCODE,@LIMIT)    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.branch_cat_mapping
-- --------------------------------------------------
create procedure [dbo].[branch_cat_mapping]
as      
set nocount on  

select a.* into #f1
from menu_item a 
right outer join 
(
select * from cat_mapping where cat_code in (select cat_code from user_login where username='E05058' )
) b
 on b.menu_code=a.menu_code     
order by head,sub_head,seq_no


select *,map=case when menu_code is null then '' else 'checked' end
 from #f1 where menu_code in 
(select menu_code from extra_cat_mapping where emp_no='e07262'
union
select menu_code from cat_mapping where cat_code='57')
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Check_Menuaccessiblity
-- --------------------------------------------------
Create Proc [dbo].[Check_Menuaccessiblity](@reppath as varchar(200),@access_to as varchar(12),@access_code as varchar(16))
as
select menu_code from menu_item (nolock) 
where menu_url like @reppath and (applicable_to like '%'+@access_to+'%' 
or @access_code in (select * from user_franchisee(nolock)) and menu_code in (127,336,128,15,17,19,851,1000) )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Check_MenuaccessiblityWithAccess
-- --------------------------------------------------
  
CREATE Proc [dbo].[Check_MenuaccessiblityWithAccess]  
(@menucode as int,@access_to as varchar(12),@access_code as varchar(16),  
@CatCode as int,@user as varchar(16),@userid as int)        
as
Set nocount ON         
declare @menu_code as int      
select @menu_code=menu_code from menu_item (nolock)         
where menu_code=@menucode and  
 (applicable_to like '%'+@access_to+'%'         
 or EXISTS (select * from user_franchisee(nolock) where tag=@access_code)  
 and menu_code in (127,336,128,15,17,19,851,1000) )    
    
 select  a.menu_code,head,sub_head,menu_name,menu_url,seq_no,menu_desc,applicable_to         
 from menu_item a with (nolock) inner join            
 (select distinct menu_Code from            
 (            
 select x.menu_code from            
 (select menu_code from get_menu_option with (nolock)         
 where cat_Code=@CatCode           
 and userid=@userid) x left outer join            
 (select menu_code from exclude_cat_mapping with (nolock)  where  emp_no=@user) y         
 on x.menu_Code=y.menu_code             
 where y.menu_Code is null            
 union            
  select p.menu_code from            
  (            
  select menu_code from get_menu_option_extra with (nolock) where  userid=@userid            
  ) p join   ( select menu_code from extra_cat_mapping (nolock)   where  emp_no=@user) q            
  on p.menu_code=q.menu_Code            
 ) t            
 ) b on a.menu_code=b.menu_Code            
 where a.menu_code=@menu_code      

Set nocount ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHK_USER_EXISTS
-- --------------------------------------------------
CREATE PROCEDURE CHK_USER_EXISTS(@USERNAME VARCHAR(20),@PASS VARCHAR(20))
AS
SET NOCOUNT ON
BEGIN
	SELECT PERSON_NAME,USERTYPE,ACCESS_TO,ACCESS_CODE,CAT_CODE,IP_ACTIVE,IP
	FROM USER_LOGIN WITH(NOLOCK)
	WHERE	 USERNAME = @USERNAME AND USERPASSWORD = @PASS
		 AND LOGIN_INACTIVE_DATE >= GETDATE()
		 AND ACTIVE = 'Y'
END
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_RMNEW_LOGIN
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CREATE_RMNEW_LOGIN]            
AS            
            
------------ SUB_bROKER LOGIN            
           
select NAME=MAX(NAME),SUB_brOKER into #filesb            
FROM INTRANET.RISK.DBO.SUBBROKERS WHERE SUB_BROKER NOT IN            
(SELECT  ACCESS_cODE FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )            
GROUP BY SUB_bROKER            
       
select NAME=MAX(NAME),SUB_brOKER,BRANCH_coDe into #fileRem           
FROM INTRANET.RISK.DBO.SUBBROKERS WHERE LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)) NOT IN            
(SELECT  username FROM USER_LOGIN (NOLOCK) WHERE ACCESS_TO='SB' )            
--GROUP BY SUB_bROKER         
and sub_broker not in (select sbtag from INTRANET.RISK.DBO.branch) --and sub_broker='RPCB'             
GROUP BY SUB_bROKER ,branch_code     
         
delete from #filesb where sub_broker in (select sbtag from INTRANET.RISK.DBO.branch)          
            
insert into USER_LOGIN            
(person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)            
SELECT NAME,SUB_brOKER,SUB_brOKER,'USER','SB',SUB_brOKER,35,1,GETDATE(),10,10,GETDATE(),'Dec 31 2010','N','',            
'','N','','N',0,'System',getDate()            
from #filesb            
            
insert into USER_LOGIN            
(person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedON)            
SELECT NAME,LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),            
LTRIM(RTRIM(BRANCH_coDe))+LTRIM(RTRIM(SUB_brOKER)),            
'ADMIN','SB',SUB_brOKER,76,1,GETDATE(),10,10,GETDATE(),'Dec 31 2010','N','',            
'','N','','N',0,'System',getDate()            
from #fileRem

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DRA_Ipartnet_ForgetLogin
-- --------------------------------------------------

--DRA_Ipartnet_ForgetLogin 'AKZKK','DOFPK2385E',''       

CREATE Procedure [dbo].[DRA_Ipartnet_ForgetLogin]          

(          

@UserID varchar(50),        

@PanNo varchar(50),      

@MachineIp varchar(50)=null      

)          

as          

set nocount on          

Begin          

/*

declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      

*/

declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10), @Name varchar(80)=''      



Declare @Sb varchar(100)



if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @Sb=sb_tag,@Name=Emp_Name fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID

      

Set @UserID=@Sb   

END   

      

if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      

Begin      

set @username=@UserID      

set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      

 if(ISNULL(@access_code,'')<>'')    

 Begin    

  if exists(select * from     

     (    

     select panno from [MIS].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    

     union     

     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    

     )x)    

  Begin    

   declare @PWD varchar(500),@Email varchar(50)        

   

     select top 1 @mobile=c.mobno,@Email=c.EmailID from [MIS].sb_comp.dbo.sb_contact c with(nolock) inner join  [MIS].sb_comp.dbo.sb_broker sb      

         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      

             

     print   @Email

     print  @access_code    

     print @mobile 

   if(isnull(@mobile,'')='')      

   Begin      

   print 'mob'      

   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      

   End      

   print @mobile     

        

    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	select @PWD=userpassword,@Name=Person_Name from user_login with(nolock) where username=@UserID --and usertype='Admin'      



    if(@Email='')

    Begin

    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	select @Email=Email from user_login with(nolock) where username=@UserID 

    end

        

    IF(@Email<>'')      

    BEGIN          

    --exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       

     print 'Email'  

	 print @Name

	 print @Email

	 print @UserID

	 print @PWD

	exec [RISK].DBO.SP_DRA_MailSend @Name,@Email,@UserID, @PWD

    END      

          

    if(isnull(@mobile,'')<>'')      

    Begin      

    set @Message='Dear User, below are the DRA Password :- '+@PWD+'';                  

          

    INSERT INTO [MIMANSA].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            

    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            

              

                

    End      

        

    insert into forget_pwd_log        

    (date_time,pc_ip_name,username,password1,[message])        

    values        

    (getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        

          

    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            

    End      

    else      

    Begin      

    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      

    End              

  End    

  else    

  Begin    

   select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     

  End    

 End    

 else   

 Begin    

 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    

 End       

     

End      

     

      

          

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Email_error
-- --------------------------------------------------
CREATE procedure [dbo].[Email_error]                                  
as                     
            
DECLARE @rc INT                               
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues                               
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                              
EXEC @rc = msdb.dbo.sysmail_start_sp               
                         
SET NOCOUNT ON                                  
                                  
DECLARE                                   
@errDate datetime,                                   
@errPage varchar(500),                                   
@errFromIP varchar(50),                                  
@errLine varchar(8),                                   
@errNum varchar(50),                                  
@errDesc varchar(500),                                  
@errServ varchar(500),                                  
@mess varchar(1500),                                  
@errid int,                                  
@username varchar(25),                                  
@useremail varchar(50),                                  
@errSoln varchar(500),                                
@toEmail varchar(50),                                
@toname  varchar(100),                                
@sub varchar(100)                                
                                
                                
DECLARE error_cursor CURSOR FOR                                   
SELECT errdate, errpage, errFromIp,errline,errnum,errdesc,servsett,idno,username  
FROM error_log                                  
WHERE isnull(email_flag,0)=0                                  
ORDER BY errdate                                   
                    
                                  
OPEN error_cursor                                  
                                  
FETCH NEXT FROM error_cursor                                   
INTO @errDate,@errPage,@errFromIP,@errLine,@errNum,@errDesc,@errServ,@errid,@username                                   
                                  
WHILE @@FETCH_STATUS = 0                                  
BEGIN                                  
  set @mess = 'Err Date : '+convert(varchar(25),@errDate)+'<br>'                                  
  set @mess = @mess +'Error on Page : '+@errPage+'<br>'                                 
  set @mess = @mess +'IP Address : '+@errFromIP+'<br>'                                  
  set @mess = @mess +'Error Line : '+ltrim(rtrim(convert(varchar(10),@errLine)))+'<br>'                                  
  set @mess = @mess +'Error Number : '+@errNum+'<br>'                                  
  set @mess = @mess +'Error Description : '+@errDesc+'<br>'                                  
    
--  set @mess = @mess +'<br>'+'<br>'+'This is system generated error Message. Please do not reply'                                  
                                  
                                  
  set @toEmail='inhouse.support@angelbroking.com'                                
  set @toname =''                                 
                                
  set @useremail=''                                  
  select @useremail=email,@toname=person_name from risk.dbo.user_login where username=@username                                  
  set @mess = @mess +'<br>User : '+@toname+' [email:'+@useremail+']<br>'                                  
                                  
--  print len(@useremail)                                  
  if len(@useremail)=0                                   
  begin                                  
   set @useremail='inhouse.support@angelbroking.com'                                  
  end                                  
 -- print @useremail                                  
                                  
 set @errSoln = ''                                
 set @errSoln = 'Application Error has been registered. Software helpdesk executive will attend you shortly with solution.'+'<br>'                             
 set @errSoln = @errSoln + 'In case you dont receive any call, please contact on 022-42303600  Reena Extn:709 '+'<br>'                      
 set @errSoln = @errSoln + 'Incase error is solved ignore this mail.'                          
-- print @errSoln                            
                            
-- select @errSoln=solution from ErrSoln where errDesc =@errDesc                                
-- print len(@errSoln)                                
-- if len(@errSoln)<>0 and @useremail<>'soft@angelbroking.com'                                
-- begin             
--   set @toEmail=@useremail    
  
   set @toEmail='inhouse.support@angelbroking.com'                                   
   set @useremail='inhouse.support@angelbroking.com'                                  
/*  
   set @mess = ''                               
   set @mess = @mess +'Dear '+@toname+','+'<br>'+'<br>'                                
   set @mess = @mess +'System had noticed below mentioned error while you were accessing the module '+@errPage+'<br>'                                 
   set @mess = @mess +'on '+convert(varchar(25),@errDate)+'.'+'<br>'+'<br>'                                
   set @mess = @mess +'Error Information:'+'<br>'                                
   set @mess = @mess +'------------------'+'<br>'                                
   set @mess = @mess +@errDesc+'<br>'+'<br>'                                    
   set @mess = @mess +'We would like to request you to do the needful as mentioned below:'+'<br>'                                
   set @mess = @mess +@errSoln+'<br>'+'<br>'                                
   set @mess = @mess +'Incase your error is not solved.'+'<br>'                         
   set @mess = @mess +'Please email your error with complete information to inhouse.support@angeltrade.com'+'<br>'+'<br>'+'<br>'                                
*/  
   set @mess = @mess +'Thanking you'+'<br>'+'<br>'                                
   set @mess = @mess +'Angel Inhouse Software Department'+'<br>'                                
   set @mess = @mess +'Angel Group of Companies.'+'<br>'                                
                              
   update error_log set auto_email_reply=1 where idno=@errid                                  
                              
-- end                                    
--  print @mess                                                     
set @sub= 'Inhouse Error id:' + convert(varchar(10),@errid)  
  
  
if (select charindex('/kyc/',@errpage))=1  
Begin  
 set @toEmail='Amit.S@angeltrade.com;AmitS.Ingle@angeltrade.com'  
end  
/*  
if (select charindex('/cms/',@errpage))=1  
Begin  
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'  
end  

if (select charindex('/bpreg/',@errpage))=1  
Begin  
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'  
end  

if (select charindex('/sbreg_cr/',@errpage))=1  
Begin  
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'  
end  

if (select charindex('/sbreg/',@errpage))=1  
Begin  
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'  
end  
  
if (select charindex('/share/',@errpage))=1  
Begin  
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'  
end  
*/  
--print @toemail  
--print @errpage  
  
if @toemail <> 'inhouse.support@angelbroking.com'                                  
begin                    
  
exec msdb.dbo.sp_send_dbmail                           
  @recipients  = @toEmail,               
  @blind_copy_recipients  = 'manesh@angeltrade.com',            
  @profile_name = 'intranet',                               
  --@from = @useremail,                                   
  @subject = @sub,            
  @body_format = 'html',                                   
  --@server = 'angelmail.angelbroking.com',                                  
  @body =@mess                                  
  update error_log set email_flag=1 where idno=@errid                                  
end                                  
  
  FETCH NEXT FROM error_cursor                                   
  INTO @errDate,@errPage,@errFromIP,@errLine,@errNum,@errDesc,@errServ,@errid,@username                                   
                                  
END                                 
                                  
CLOSE error_cursor               
DEALLOCATE error_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Email_error_new
-- --------------------------------------------------
CREATE procedure [dbo].[Email_error_new]                                      
as                         
                
DECLARE @rc INT                                   
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues                                   
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                                  
EXEC @rc = msdb.dbo.sysmail_start_sp                   
                             
SET NOCOUNT ON                                      
                                      
DECLARE                                       
@errDate datetime,                                       
@errPage varchar(500),                                       
@errFromIP varchar(50),                                      
@errLine varchar(8),                                       
@errNum varchar(50),                                      
@errDesc varchar(500),                                      
@errServ varchar(500),                                      
@mess varchar(1500),                                      
@errid int,                                      
@username varchar(25),                                      
@useremail varchar(50),                                      
@errSoln varchar(500),                                    
@toEmail varchar(50),                                    
@toname  varchar(100),                                    
@sub varchar(100),                                    
@devname varchar(100),    
@status varchar(1),                                    
@devemail varchar(100),    
@devmapYN varchar(1)                                    
    
DECLARE error_cursor CURSOR FOR                                       
SELECT errdate, errpage, errFromIp,errline,errnum,errdesc,servsett,idno,username,emp_name,status,email,devMap    
FROM intranet.misc.dbo.Error_developer                                
--WHERE isnull(email_flag,0)=0                                      
ORDER BY errdate                                       
                                      
OPEN error_cursor                                      
                                      
FETCH NEXT FROM error_cursor                                       
INTO @errDate,@errPage,@errFromIP,@errLine,@errNum,@errDesc,@errServ,@errid,@username,@devname,@status,@devemail,@devmapYN                                       
    
                                      
WHILE @@FETCH_STATUS = 0                                      
BEGIN                                      
  set @mess = 'Err Date : '+convert(varchar(25),@errDate)+'<br>'                                      
  set @mess = @mess +'Error on Page : '+@errPage+'<br>'                                     
  set @mess = @mess +'IP Address : '+@errFromIP+'<br>'                                      
  set @mess = @mess +'Error Line : '+ltrim(rtrim(convert(varchar(10),@errLine)))+'<br>'                                      
  set @mess = @mess +'Error Number : '+@errNum+'<br>'                                      
  set @mess = @mess +'Error Description : '+@errDesc+'<br>'                                      
        
--  set @mess = @mess +'<br>'+'<br>'+'This is system generated error Message. Please do not reply'                                      
    
  set @toEmail='inhouse.support@angelbroking.com'                                    
  set @toname =''              
      
  /*    
  if @status='A'     
  Begin    
 set @toEmail=@devemail                             
 set @toname =@devname          
  end    
  else    
  begin    
   set @toEmail='inhouse.support@angelbroking.com'    
   set @toname =@devname +'[ Resigned ]'    
  end    
  */                           
                                    
  set @useremail=''                                      
  select @useremail=email,@toname=person_name from user_login where username=@username                                      
  set @mess = @mess +'<br>User : '+@toname+' [email:'+@useremail+']<br>'                                      
           
--  print len(@useremail)                                      
      
  if len(@useremail)=0                                       
  begin                                 
   set @useremail='inhouse.support@angelbroking.com'                                      
  end                                      
      
 -- print @useremail                                      
                                      
 set @errSoln = ''                                    
 set @errSoln = 'Application Error has been registered. Software helpdesk executive will attend you shortly with solution.'+'<br>'                                 
 set @errSoln = @errSoln + 'In case you dont receive any call, please email us at inhouse.support@angeltrade.com'+'<br>'                          
 set @errSoln = @errSoln + 'Incase error is solved ignore this mail.'                              
-- print @errSoln                                
                                
-- select @errSoln=solution from ErrSoln where errDesc =@errDesc                                    
-- print len(@errSoln)                                    
-- if len(@errSoln)<>0 and @useremail<>'soft@angelbroking.com'                                    
-- begin                 
--   set @toEmail=@useremail        
    
      
   set @toEmail='inhouse.support@angelbroking.com'                                       
   set @useremail='inhouse.support@angelbroking.com'                                      
    
/*      
   set @mess = ''                                   
   set @mess = @mess +'Dear '+@toname+','+'<br>'+'<br>'                                    
   set @mess = @mess +'System had noticed below mentioned error while you were accessing the module '+@errPage+'<br>'                                     
   set @mess = @mess +'on '+convert(varchar(25),@errDate)+'.'+'<br>'+'<br>'                                    
   set @mess = @mess +'Error Information:'+'<br>'                                    
   set @mess = @mess +'------------------'+'<br>'                                    
   set @mess = @mess +@errDesc+'<br>'+'<br>'                                        
   set @mess = @mess +'We would like to request you to do the needful as mentioned below:'+'<br>'                                    
   set @mess = @mess +@errSoln+'<br>'+'<br>'                                    
   set @mess = @mess +'Incase your error is not solved.'+'<br>'                             
   set @mess = @mess +'Please email your error with complete information to inhouse.support@angeltrade.com'+'<br>'+'<br>'+'<br>'                                    
*/      
   set @mess = @mess +'Thanking you'+'<br>'+'<br>'                                    
   set @mess = @mess +'Angel Inhouse Software Department'+'<br>'                                    
   set @mess = @mess +'Angel Group of Companies.'+'<br>'                                    
                                  
   update error_log set auto_email_reply=1 where idno=@errid                                      
                                  
-- end                                        
--  print @mess                                                         
set @sub= 'Inhouse Error id:' + convert(varchar(10),@errid)      
      
      
if (select charindex('/kyc/',@errpage))=1      
Begin      
 set @toEmail='Amit.S@angeltrade.com;AmitS.Ingle@angeltrade.com'      
end      
      
if (select charindex('/cms/',@errpage))=1      
Begin      
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'      
end      
if (select charindex('/bpreg/',@errpage))=1      
Begin      
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'      
end      
if (select charindex('/sbreg_cr/',@errpage))=1      
Begin      
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'      
end      
if (select charindex('/sbreg/',@errpage))=1      
Begin      
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'      
end      
      
if (select charindex('/share/',@errpage))=1      
Begin      
 set @toEmail='Mgs.Sarabjeet@angelbroking.com'      end      
      
--print @toemail      
--print @errpage      
      
if @toemail <> 'inhouse.support@angelbroking.com'                                      
begin                        
      
exec msdb.dbo.sp_send_dbmail                               
  @recipients  = @toEmail,                   
  @blind_copy_recipients  = 'manesh@angeltrade.com',                
  @profile_name = 'intranet',                                   
  --@from = @useremail,                                       
  @subject = @sub,                
  @body_format = 'html',                                       
  --@server = 'angelmail.angelbroking.com',                                      
  @body =@mess                                      
      
end                                      
  update error_log set email_flag=1 where idno=@errid                                      
  FETCH NEXT FROM error_cursor                                       
  INTO @errDate,@errPage,@errFromIP,@errLine,@errNum,@errDesc,@errServ,@errid,@username,@devname,@status,@devemail,@devmapYN                                       
                                      
END                                     
                                      
CLOSE error_cursor                   
DEALLOCATE error_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Email_error_soln
-- --------------------------------------------------
CREATE procedure [dbo].[Email_error_soln]            
as        
  
DECLARE @rc INT                     
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues                     
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                    
EXEC @rc = msdb.dbo.sysmail_start_sp  
      
SET NOCOUNT ON            
            
DECLARE             
@errDate datetime,             
@errPage varchar(500),             
@errFromIP varchar(50),            
@errLine int,             
@errNum varchar(50),            
@errDesc varchar(500),            
@errServ varchar(500),            
@mess varchar(1000),            
@errid int,            
@username varchar(25),            
@useremail varchar(50),            
@errSoln varchar(500),          
@toEmail varchar(50),          
@toname  varchar(100)          
          
          
DECLARE error_cursor CURSOR FOR             
SELECT errdate, errpage, errFromIp,errline,errnum,errdesc,servsett,idno,username            
FROM error_log            
WHERE email_flag=0            
ORDER BY errdate             
            
OPEN error_cursor            
            
FETCH NEXT FROM error_cursor             
INTO @errDate,@errPage,@errFromIP,@errLine,@errNum,@errDesc,@errServ,@errid,@username             
            
WHILE @@FETCH_STATUS = 0            
BEGIN            
  set @mess = 'Err Date : '+convert(varchar(25),@errDate)+'<br>'            
  set @mess = @mess +'Error on Page : '+@errPage+'<br>'            
  set @mess = @mess +'IP Address : '+@errFromIP+'<br>'            
  set @mess = @mess +'Error Line : '+ltrim(rtrim(convert(varchar(10),@errLine)))+'<br>'            
  set @mess = @mess +'Error Number : '+@errNum+'<br>'            
  set @mess = @mess +'Error Description : '+@errDesc+'<br>'            
  set @mess = @mess +'<br>'+'<br>'+'This is system generated error Message. Please do not reply'            
        
  set @toEmail='soft@angelbroking.com'          
  set @toname =''           
          
  set @useremail=''            
  select @useremail=email,@toname=person_name from user_login where username=@username            
          
--  print len(@useremail)            
  if len(@useremail)=0             
  begin            
   set @useremail='soft@angelbroking.com'            
  end            
 -- print @useremail            
        
 set @errSoln = ''          
 select @errSoln=solution from intranet.misc.dbo.ErrSoln where errDesc =@errDesc          
-- print len(@errSoln)          
 if len(@errSoln)<>0 and @useremail<>'soft@angelbroking.com'          
 begin          
     set @toEmail=@useremail            
   set @useremail='soft@angelbroking.com'            
   set @mess = ''          
   set @mess = @mess +'Dear '+@toname+','+'<br>'+'<br>'          
   set @mess = @mess +'System had noticed below mentioned error while you were accessing the module '+@errPage+'<br>'           
   set @mess = @mess +'on '+convert(varchar(25),@errDate)+'.'+'<br>'+'<br>'          
   set @mess = @mess +'Error Information:'+'<br>'          
   set @mess = @mess +'------------------'+'<br>'          
   set @mess = @mess +@errDesc+'<br>'+'<br>'              
   set @mess = @mess +'We would like to request you to do the needful as mentioned below:'+'<br>'          
   set @mess = @mess +@errSoln+'<br>'+'<br>'          
   set @mess = @mess +'Incase your error is not solved.'+'<br>'           
   set @mess = @mess +'Please email your error with complete information to soft@angelbroking.com'+'<br>'+'<br>'+'<br>'          
   set @mess = @mess +'Thanking you'+'<br>'+'<br>'          
   set @mess = @mess +'Software Department'+'<br>'          
   set @mess = @mess +'Angel Group of Companies.'+'<br>'          
        
   update error_log set auto_email_reply=1 where idno=@errid            
        
 end          
--  print @mess          
if @toemail <> 'soft@angelbroking.com'                  
begin    
    
  EXEC msdb.dbo.sp_send_dbmail             
  @recipients  = @toEmail,   
  @profile_name = 'intranet',          
  --@from = @useremail,             
  @subject = 'Reporting Error Generated',             
  --@server = 'angelmail.angelbroking.com',  
  @body_format = 'html',          
  @body =@mess            
end            
  update error_log set email_flag=1 where idno=@errid            
            
  FETCH NEXT FROM error_cursor             
  INTO @errDate,@errPage,@errFromIP,@errLine,@errNum,@errDesc,@errServ,@errid,@username             
            
END        
            
CLOSE error_cursor            
DEALLOCATE error_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Email_Report
-- --------------------------------------------------
CREATE procedure [dbo].[Email_Report]                      
as             
    
DECLARE @rc INT                       
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues                       
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                      
EXEC @rc = msdb.dbo.sysmail_start_sp       
             
SET NOCOUNT ON                      
            
insert into INTRANET.MISC.DBO.appfolder             
select distinct foldername=replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/',''),'Not Mapped' from error_log (nolock)             
where errdate >='Apr  1 2008' and replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/','') not in (select folder from INTRANET.MISC.DBO.appfolder )            
and replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/','') <> ''            
            
insert into INTRANET.MISC.DBO.appfolder             
select distinct           
foldername=replace(replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/',''),'$','AngelInhouse/'),'Not Mapped'           
from (select Errpage=replace(menu_url,'/AngelInhouse/','/$')  from menu_item (nolock) ) a          
where           
isnumeric(replace(replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/','') ,'.',''))=0 and          
replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/','') not like 'www.%'          
AND replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/','')  NOT LIKE '%.AS%'          
and          
replace(replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/',''),'$','AngelInhouse/')        
not in (select folder from INTRANET.MISC.DBO.appfolder )  and replace(substring(Errpage,charindex('/',Errpage,1),charindex('/',Errpage,2)),'/','') <> ''           
                  
DECLARE                       
@empcode varchar(10),                      
@email varchar(100),                      
@empname varchar(100),                
@mess varchar(500),                        
@d1 int,@d2 int,@d3 int,@d4 int,@d5 int            
           
DECLARE error_cursor CURSOR FOR                       
/*            
select b.developer,email,person_name                 
from error_log a (nolock), appfolder b (nolock), risk.dbo.user_login c (nolock)                
where a.errpage like '/'+b.folder+'/%' and b.developer=c.username                
group by b.developer,email,person_name                 
*/            
select * from INTRANET.MISC.DBO.AppError5Days             
            
OPEN error_cursor                                       
FETCH NEXT FROM error_cursor                       
INTO @empcode,@email,@empname,@d1,@d2,@d3,@d4,@d5            
                      
WHILE @@FETCH_STATUS = 0                      
BEGIN                      
                
  set @mess = 'Dear '+@empname+','+'<br>' +'<br>'                 
  set @mess = @mess +'Analyse the Error Tracked by the System and do the needful rectification.'+'<br>'+'<br>'                           
  set @mess = @mess +'No(s) of Error - Day 1 = '+convert(varchar(5),@d1)+', Day 2 = '+convert(varchar(5),@d2)+', Day 3 = '+convert(varchar(5),@d3)+', Day 4 = '+convert(varchar(5),@d4)+' and more then Day 5 = '+convert(varchar(5),@d5)+'<br>'+'<br>'        
  set @mess = @mess +'URL : http://196.1.115.136/rmnew/Error_Analyser.asp?uname='+@empcode+'<br>' +'<br>'                
  set @mess = @mess +'by Software Error Tracker Application' +'<br>'            
  set @mess = @mess +'This is system generated error Message. Please do not reply'+'<br>'+'<br>'+'Angel Broking'+'<br>'+'Software Department'                      
                    
 exec msdb.dbo.sp_send_dbmail              
  @recipients  = @email,                       
  @profile_name = 'intranet',    
  --@from = 'soft@angelbroking.com',                    
  @subject = 'Error Tracker Reporting',                       
  --@server = 'angelmail.angelbroking.com',     
  @body_format = 'html',                     
  @body =@mess                      
                      
  FETCH NEXT FROM error_cursor                       
INTO @empcode,@email,@empname,@d1,@d2,@d3,@d4,@d5            
                      
END                                  
CLOSE error_cursor                      
DEALLOCATE error_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EMP_LOGIN
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[EMP_LOGIN] (@user as varchar(15))    
AS

SET NOCOUNT ON
if @user='BRANCH'
BEGIN
select username,person_name,access_code  from user_login where status=1 and username like 'E%' 
and access_to in('BRANCH')
ORDER BY USERNAME
END


if @user='BRMAST'
BEGIN
select a.username,a.person_name,a.access_code,b.branch_CD from 
(select *  from user_login where status=1 and username like 'E%' 
and access_to in('BRMAST') 
)a
left outer join
BRANCH_MASTER b
on a.access_code=b.BRMAST_CD
ORDER BY USERNAME
END


if @user='REGION'
BEGIN
select a.username,a.person_name,a.access_code,b.CODE from 
(select *  from user_login where status=1 and username like 'E%' 
and access_to in('REGION') 
)a
left outer join
REGION b
on a.access_code=b.REG_CODE
ORDER BY USERNAME
END

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Erro_tarp_notMapped
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Erro_tarp_notMapped]            
AS            
    
DECLARE @RC INT                       
IF NOT EXISTS (SELECT * FROM MSDB.SYS.SERVICE_QUEUES                       
WHERE NAME = N'EXTERNALMAILQUEUE' AND IS_RECEIVE_ENABLED = 1)                      
EXEC @RC = MSDB.DBO.SYSMAIL_START_SP    
    
SELECT  * INTO #ERR FROM ERROR_LOG             
            
SELECT DISTINCT ERRPAGE INTO #PAGE FROM #ERR            
            
UPDATE #PAGE SET ERRPAGE=SUBSTRING(ERRPAGE,2,LEN(ERRPAGE))            
            
SELECT DISTINCT ERRPAGE=SUBSTRING(ERRPAGE,1,CHARINDEX('/',ERRPAGE)-1) 
INTO #TRAP            
FROM #PAGE             
WHERE CHARINDEX('/',ERRPAGE)>1            
            
SELECT FOLDER,DEVELOPER 
INTO #TBL 
FROM APPFOLDER 
WHERE FOLDER NOT IN            
(            
	SELECT * FROM #TRAP             
) AND FOLDER NOT LIKE 'ANGELINHOUSE%'   ORDER BY    DEVELOPER         
            
ALTER TABLE #TBL ADD ID INT IDENTITY            
            
DECLARE                                   
@DEV VARCHAR(10),               
@ID VARCHAR(3),             
@FOLD VARCHAR(50),           
@NAME VARCHAR(50),                
@MESS VARCHAR(5000),                                  
@USEREMAIL VARCHAR(50),                                  
@TOEMAIL VARCHAR(50)                                
                                
                                
DECLARE TRAPING_CURSOR CURSOR FOR                                   
SELECT A.*,B.EMP_NAME FROM #TBL A          
JOIN          
(SELECT EMP_NO,EMP_NAME FROM DBO.EMP_INFO (NOLOCK))  B          
ON A.DEVELOPER=B.EMP_NO  --ORDER BY B.EMP_NAME        
                                  
OPEN TRAPING_CURSOR                                  
                                  
FETCH NEXT FROM TRAPING_CURSOR                                   
INTO @FOLD,@DEV,@ID,@NAME                  
                  
SET @MESS=''                  
          
            
                                  
WHILE @@FETCH_STATUS = 0            
BEGIN          
IF @MESS=''        
BEGIN        
SET @MESS= @MESS+'<BR><TABLE BORDER=1 BORDERCOLOR=BLACK>'                  
END                                
 SET @MESS = @MESS+'<TR><TD>'+@ID+'</TD><TD>'+@FOLD+'</TD><TD>'+ @DEV+'-'+@NAME+'</TD></TR>'            
                  
 FETCH NEXT FROM TRAPING_CURSOR                                   
INTO @FOLD,@DEV,@ID ,@NAME                   
                                   
END                                 
                  
--SET @MESS= LEFT(@MESS,LEN(@MESS)-1)                  
IF LEN(@MESS) > 1                   
BEGIN                  
  SET @MESS= @MESS+'</TABLE>'                  
 DECLARE @HD AS VARCHAR(200)                  
 SET @HD = 'ENCLOSING HEREWITH LIST OF FOLDERS NOT HAVING ERROR TRAPPING. '+'<BR>'                  
 SET @HD = @HD + '---------------------------------------------'+'<BR>'              
 SET @MESS=@HD+@MESS+'<BR>'+'<BR>'+'<BR><BR>THIS IS SYSTEM GENERATED REPORT. PLEASE DO NOT REPLY'+'<BR>'+'<BR>'                  
 --SET @MESS=@MESS+'IN CASE ANY DOUBTS. PLEASE CALL AT SOFTWARE HELPDESK: 022-28358800 EXT: 707'                  
                   
              
 EXEC MSDB.DBO.SP_SEND_DBMAIL                          
 @RECIPIENTS  = 'REENAS.SHAH@ANGELTRADE.COM',                  
 @COPY_RECIPIENTS  = 'SHWETA.TIWARI@ANGELBROKING.COM,renil.pillai@angelbroking.com',                  
-- @TO = 'MANESH@ANGELBROKING.COM',                  
 --@BCC = 'SHWETA.TIWARI@ANGELBROKING.COM,MANESH@ANGELTRADE.COM',                  
 @PROFILE_NAME = 'INTRANET',    
 --@FROM = 'SOFT@ANGELTRADE.COM',                  
 @BODY_FORMAT ='HTML',                             
 @SUBJECT = 'LIST OF FOLDERS NOT HAVING ERROR TARPING',                                   
 @BODY =@MESS                                  
              
--PRINT @MESS              
                   
END                  
                                  
CLOSE TRAPING_CURSOR                                  
DEALLOCATE TRAPING_CURSOR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.error_analyser
-- --------------------------------------------------
CREATE procedure [dbo].[error_analyser](@fdate as varchar(25),@tdate as varchar (25),@user as varchar(11))              
as              
set nocount on              
select x.*,                  
--Soln_status=(case when isnull(y.ErrSoluion,'')='' then 0 else 1 end)                     
Soln_status=(case when isnull(y.SolnType,'')='' then 0 else 1 end)               
into #file                    
from error_log x (nolock)               
left outer join intranet.misc.dbo.err_solution y (nolock)               
on x.errdesc=y.errdesc                 
where errdate>=@fdate and errdate <=@tdate      
and errline not like '%or%'   and errline not like '%em.W%'            
      
    
    
select a.*,c.email,c.person_name from    
(select IDNO=MAX(IDNO),errdate=convert(datetime,convert(varchar(11),errdate)),                          
errpage,errnum,errdesc,errline,nor=count(*),developer,Soln_status    
 from  #file a,intranet.misc.dbo.appfolder b (nolock)    
where a.errpage like '/'+b.folder+'/%'      
and developer=@user        
group by convert(datetime,convert(varchar(11),errdate)),                          
errnum,errpage,errdesc,errline,developer,Soln_status)a    
left outer join     
user_login c (nolock)     
on a.developer=c.username

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXCLUDE_MENU_MAPCATEGORY
-- --------------------------------------------------
CREATE PROCEDURE EXCLUDE_MENU_MAPCATEGORY  
(  
 @MENUCODE INT,  
 @EMP_CODE VARCHAR(10) ,  
 @USERNAME VARCHAR(10)  
)  
             
AS            
SET NOCOUNT ON    
            
 DECLARE @NOR INT              
 SELECT @NOR=COUNT(*) FROM EXCLUDE_CAT_MAPPING (NOLOCK) WHERE MENU_CODE=@MENUCODE AND EMP_NO=@EMP_CODE              
 --PRINT @NOR              
       
 IF @NOR>=1               
 BEGIN              
  INSERT INTO EXCLUDE_CAT_MAPPING_HIST SELECT EMP_NO,MENU_CODE,MAPPED_BY,MAPPED_ON,@USERNAME,GETDATE()          
  FROM EXCLUDE_CAT_MAPPING WHERE MENU_CODE=@MENUCODE AND EMP_NO=@EMP_CODE            
  
  --PRINT 'DATA INSERTED'          
  DELETE FROM EXCLUDE_CAT_MAPPING WHERE MENU_CODE=@MENUCODE AND EMP_NO=@EMP_CODE              
  PRINT 'MAPPING DELETED SUCCESSFULLY'              
    
 END               
  
 ELSE              
 BEGIN              
  INSERT INTO EXCLUDE_CAT_MAPPING VALUES(@EMP_CODE,@MENUCODE,@USERNAME,GETDATE())              
  PRINT 'MAPPING ADDED SUCCESSFULLY'              
 END              
  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXCLUDE_MENU_MAPCATEGORY_test
-- --------------------------------------------------
CREATE PROCEDURE EXCLUDE_MENU_MAPCATEGORY_test      
(      
 @MENUCODE INT,      
 @EMP_CODE VARCHAR(10) ,      
 @USERNAME VARCHAR(10)      
)      
                 
AS                
SET NOCOUNT ON        
                
 DECLARE @NOR INT                  
 SELECT @NOR=COUNT(*) FROM EXCLUDE_CAT_MAPPING (NOLOCK) WHERE MENU_CODE=@MENUCODE AND EMP_NO=@EMP_CODE                  
 --PRINT @NOR                  
           
 IF @NOR>=1                   
 BEGIN                  
  INSERT INTO EXCLUDE_CAT_MAPPING_hist SELECT EMP_NO,MENU_CODE,MAPPED_BY,MAPPED_ON,@USERNAME,GETDATE()              
  FROM EXCLUDE_CAT_MAPPING WHERE MENU_CODE=@MENUCODE AND EMP_NO=@EMP_CODE                
      
  --PRINT 'DATA INSERTED'              
  DELETE FROM EXCLUDE_CAT_MAPPING WHERE MENU_CODE=@MENUCODE AND EMP_NO=@EMP_CODE                  
  PRINT 'MAPPING DELETED SUCCESSFULLY'                  
        
 END                   
      
 ELSE                  
 BEGIN                  
  INSERT INTO EXCLUDE_CAT_MAPPING VALUES(@EMP_CODE,@MENUCODE,@USERNAME,GETDATE())                  
  PRINT 'MAPPING ADDED SUCCESSFULLY'                  
 END                  
      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.extra_menu_MapCategory
-- --------------------------------------------------
CREATE procedure [dbo].[extra_menu_MapCategory](@menucode int,@emp_code varchar(10) ,@username varchar(10))          
           
as          
set nocount on            
declare @nor int            
select @nor=count(*) from extra_cat_mapping (nolock) where menu_code=@menucode and emp_no=@emp_code            
--print @nor            
            
if @nor>=1             
begin            
insert into extra_cat_mapping_hist SELECT EMP_NO,menu_code,Mapped_By,Mapped_On,@username,getdate()        
FROM extra_cat_mapping where menu_code=@menucode and EMP_NO=@emp_code          
--PRINT 'DATA INSERTED'        
 delete from extra_cat_mapping where menu_code=@menucode and emp_no=@emp_code            
 print 'Mapping Deleted Successfully'            
end             
else            
begin            
 insert into extra_cat_mapping values(@emp_Code,@menucode,@username,getDate())            
 print 'Mapping Added Successfully'            
end            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.extra_menu_MapCategory_test
-- --------------------------------------------------
CREATE procedure [dbo].[extra_menu_MapCategory_test](@menucode int,@emp_code varchar(10) ,@username varchar(10))            
             
as            
set nocount on              
declare @nor int              
select @nor=count(*) from extra_cat_mapping  (nolock) where menu_code=@menucode and emp_no=@emp_code              
--print @nor              
              
if @nor=1               
begin              
insert into extra_cat_mapping_hist  SELECT EMP_NO,menu_code,Mapped_By,Mapped_On,@username,getdate()          
FROM extra_cat_mapping where menu_code=@menucode and EMP_NO=@emp_code            
 delete from extra_cat_mapping where menu_code=@menucode and emp_no=@emp_code              
 print 'Mapping Deleted Successfully'              
end               
else              
begin              
 insert into extra_cat_mapping values(@emp_Code,@menucode,@username,getDate())              
 print 'Mapping Added Successfully'              
end              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.extra_rights
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[EXTRA_RIGHTS]
(
	@UNAME AS VARCHAR(11)
)
AS    
	SELECT EMPNO=ISNULL(A.EMP_NO,''),EMPNO1=ISNULL(B.EMP_NO,'') 
	INTO #F1    
	--,FLAG=(CASE WHEN B.EMP_NO='' THEN 'EX' END)    
	FROM     
	(    
		SELECT * FROM EXTRA_CAT_MAPPING WHERE EMP_NO IN (SELECT EMP_NO FROM EMP_INFO WHERE EMP_NO=@UNAME OR EMP_NAME LIKE '%'+@UNAME+'%')    
	) A    
	RIGHT OUTER JOIN    
	(    
		SELECT * FROM EMP_INFO WHERE EMP_NO IN (SELECT EMP_NO FROM EMP_INFO WHERE EMP_NAME LIKE '%'+@UNAME+'%' OR EMP_NO=@UNAME)    
	)B    
	ON A.EMP_NO=B.EMP_NO    

	SELECT DISTINCT EMPNO,FLAG=CASE WHEN EMPNO<>'' THEN 'EXTRA' END 
	FROM #F1 
	WHERE EMPNO<>''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FP_UserLogin
-- --------------------------------------------------
Create Procedure FP_UserLogin
(
@param1 varchar(50)
)
as
set nocount on

select username,userpassword,email,access_to,access_code,username from user_login where username=@param1

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GenericId_email
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GenericId_email]
AS          
          
SET NOCOUNT ON          
          
DECLARE @HTMLBODY1 VARCHAR(8000)=''
          
DECLARE @RC INT          
IF NOT EXISTS (SELECT * FROM MSDB.SYS.SERVICE_QUEUES WHERE NAME = N'EXTERNALMAILQUEUE' AND IS_RECEIVE_ENABLED = 1)          
EXEC @RC = MSDB.DBO.SYSMAIL_START_SP          
          
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000)   
/* SELECT @emailcc=MISC.DBO.FN_GETGLOBALEMAIL('PRMS_BA_Status','TO') */
Set @emailto='isms@angelbroking.com'  
Set @emailcc='renil.pillai@angelbroking.com'  
BEGIN TRY          

	select 
	ROW_NUMBER() OVER ( ORDER BY username ) AS [SrNo],
	username,person_name,access_to,Access_Code 
	into #file1
	from user_login where status=1 and IP_active='N' and access_to not in ('SB','SBMAST','FAMILY')
	and username not like 'd00%'
	and username not in (select emp_no from risk.dbo.emp_info with (nolock))

	declare @subject as varchar(200)
	  
	if (select count(1) from #file1) > 0
	begin  

		Declare @ctr as int = 1,@totctr as int = 0
		select @totctr =COUNT(1) from #file1

		while @ctr <= @totctr
		begin
			select   
			@HTMLBODY1=@HTMLBODY1+'<tr><td>'+username+'</td><td>'+person_name+'</td><td>'+access_to+'</td><td>'+access_code+'</td></tr>'
			from #file1 where SrNo=@ctr
			
			set @ctr=@ctr+1
		end
		
		set @HTMLBODY1='Dear ISMS Team,<br><Br>'  
		+' Application: ANGEL INHOUSE. Enclosing Generic Active Login ID with FREE ACCESS for your reference.<br><br>'  
		+'<table border="1"><tr><td>Login ID</td><td>User Name</td><td>Access level</td><td>Access Code</td></tr>'
		+@HTMLBODY1+'</table><BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>'

		set @subject='Application: ANGEL INHOUSE. Generic Active Login ID with free access'
	
		EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL          
		@RECIPIENTS =@emailto,          
		@COPY_RECIPIENTS = @emailcc,          
		@PROFILE_NAME = 'SQUARE',          
		@BODY_FORMAT ='HTML',          
		@SUBJECT = @subject,          
		@FILE_ATTACHMENTS ='',          
		@BODY =@HTMLBODY1          
end  
          
END TRY          
BEGIN CATCH          
          
	insert into risk.dbo.Appln_ERROR (ErrTime,ErrObject,ErrLine,ErrMessage,ApplnName,DBname)                                  
	select GETDATE(),'GenericId_email',ERROR_LINE(),ERROR_MESSAGE(),'AIAAS alter email',DB_NAME(db_id())                                  

	DECLARE @ErrorMessage NVARCHAR(4000);                                
	SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                
	RAISERROR (@ErrorMessage , 16, 1);     
          
END CATCH          
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GenericId_email_EMP
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GenericId_email_EMP]
AS          
          
SET NOCOUNT ON          
          
DECLARE @HTMLBODY1 NVARCHAR(max)=''
          
DECLARE @RC INT          
IF NOT EXISTS (SELECT * FROM MSDB.SYS.SERVICE_QUEUES WHERE NAME = N'EXTERNALMAILQUEUE' AND IS_RECEIVE_ENABLED = 1)          
EXEC @RC = MSDB.DBO.SYSMAIL_START_SP          
          
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000)   
/* SELECT @emailcc=MISC.DBO.FN_GETGLOBALEMAIL('PRMS_BA_Status','TO') */
Set @emailto='isms@angelbroking.com'  
Set @emailcc='renil.pillai@angelbroking.com'  
BEGIN TRY          

	select ROW_NUMBER() OVER ( ORDER BY username ) AS [SrNo],
	username,person_name,designation,Department,access_to,Access_Code,Costcode  
	into #file1
	from
	(select username,person_name,access_to,Access_Code 
	from user_login where status=1 and IP_active='N' and access_to not in ('SB','SBMAST','FAMILY')
	) a join risk.dbo.emp_info b with (nolock) on a.username=b.emp_no
	
	declare @subject as varchar(200)
	  
	if (select count(1) from #file1) > 0
	begin  

		Declare @ctr as int = 1,@totctr as int = 0
		select @totctr =COUNT(1) from #file1

		while @ctr <= @totctr
		begin
			select   
			@HTMLBODY1=@HTMLBODY1+'<tr><td>'+username+'</td><td>'+person_name+'</td><td>'+designation+'</td><td>'+Department+'</td>
			<td>'+access_to+'</td><td>'+access_code+'</td><td>'+Costcode+'</td></tr>'
			from #file1 where SrNo=@ctr
			
			set @ctr=@ctr+1
		end
		
		set @HTMLBODY1='Dear ISMS Team,<br><Br>'  
		+' Application: ANGEL INHOUSE. Enclosing Employee Active Login ID with FREE ACCESS for your reference.<br><br>'  
		+'<table border="1"><tr><td>Login ID</td><td>User Name</td><td>Designation</td><td>Department</td><td>Access level</td>'
		+'<td>Access Code</td><td>Cost Code</td></tr>'
		+@HTMLBODY1+'</table><BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>'

		set @subject='Application: ANGEL INHOUSE. Employee Active Login ID with FREE ACCESS'
	
		EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL          
		@RECIPIENTS =@emailto,          
		@COPY_RECIPIENTS = @emailcc,          
		@PROFILE_NAME = 'SQUARE',          
		@BODY_FORMAT ='HTML',          
		@SUBJECT = @subject,          
		@FILE_ATTACHMENTS ='',          
		@BODY =@HTMLBODY1          
end  
          
END TRY          
BEGIN CATCH          
          
	insert into risk.dbo.Appln_ERROR (ErrTime,ErrObject,ErrLine,ErrMessage,ApplnName,DBname)                                  
	select GETDATE(),'GenericId_email',ERROR_LINE(),ERROR_MESSAGE(),'AIAAS alter email',DB_NAME(db_id())                                  

	DECLARE @ErrorMessage NVARCHAR(4000);                                
	SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                
	RAISERROR (@ErrorMessage , 16, 1);     
          
END CATCH          
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GenericId_email_EMP_HOD
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GenericId_email_EMP_HOD]
AS          
          
SET NOCOUNT ON          
          
DECLARE @RC INT          
IF NOT EXISTS (SELECT * FROM MSDB.SYS.SERVICE_QUEUES WHERE NAME = N'EXTERNALMAILQUEUE' AND IS_RECEIVE_ENABLED = 1)          
EXEC @RC = MSDB.DBO.SYSMAIL_START_SP          
          
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000)      
/* SELECT @emailcc=MISC.DBO.FN_GETGLOBALEMAIL('PRMS_BA_Status','TO') */
Set @emailcc='isms@angelbroking.com'  
Set @emailbcc='renil.pillai@angelbroking.com'  
BEGIN TRY          

	Create Table #tmpfile
	(
		srno int,
		username varchar(10),
		person_name varchar(200),
		designation varchar(200),
		department varchar(200),
		access_to varchar(10),
		Access_code varchar(10),
		costcode varchar(10),
		emp_name varchar(200),
		email varchar(200) 
	)
	
	select 
	a.username,a.person_name,b.designation,b.Department,a.access_to,a.Access_Code,b.Costcode,c.Emp_name,c.email
	into #file1
	from
	(select username,person_name,access_to,Access_Code 
	from user_login where status=1 and IP_active='N' and access_to not in ('SB','SBMAST','FAMILY')
	) a join risk.dbo.emp_info b with (nolock) on a.username=b.emp_no
	join risk.dbo.emp_info c with (nolock) on b.senior=c.emp_no
	where c.email not in ('dinesh@angelbroking.com') and b.Senior not like 'D00%'
	
	select ROW_NUMBER() OVER ( ORDER BY email,Emp_name ) AS [SrNo],Emp_name, email into #file2 from #file1 group by Emp_name,email
	
	declare @subject as varchar(200),@email as varchar(250),@emp_name as varchar(200)=''
  
	
	if (select count(1) from #file2) > 0
	begin  

		DECLARE @HTMLBODY1 NVARCHAR(max)=''	
		Declare @xctr as int = 1,@xtotctr as int = 0,@ctr as int = 1,@totctr as int = 0
		select @xtotctr =COUNT(1) from #file2

		while @xctr <= @xtotctr
		begin

			select @email=email,@emp_name=emp_name from  #file2 where srno=@xctr
		
			truncate table #tmpfile
			insert into #tmpfile (srno,username,person_name,designation,department,access_to,access_code,costcode,emp_name,email)
			select ROW_NUMBER() OVER ( ORDER BY designation,Emp_name ) AS [SrNo],
			username,person_name,designation,department,access_to,access_code,costcode,emp_name,email 
			from #file1 where email=@email
		
			set @ctr=1
			select @totctr =COUNT(1) from #tmpfile 
			set @HTMLBODY1=''
			
			while @ctr <= @totctr
			begin
				select   
				@HTMLBODY1=@HTMLBODY1+'<tr><td>'+username+'</td><td>'+person_name+'</td><td>'+designation+'</td><td>'+Department+'</td>
				<td>'+access_to+'</td><td>'+access_code+'</td><td>'+Costcode+'</td></tr>'
				from #tmpfile where SrNo=@ctr 
				set @ctr=@ctr+1
			end
			
			set @HTMLBODY1='Dear '+@emp_name+',<br><Br>'  
			+' This is a monthly based activity intiated by ISMS & Helpdesk Login Mgmt Team to evaluate Free access provided to your team members,'
			+'below mentioned employees are having free access to Angel Inhouse applications.<br><Br>'		  
			+'Kindly evaluate their requirement for free access and send your reponse at below mentioned email id in next 7 working days.<br>'
			+'Contact us on email: isms@angelbroking.com <br><Br>'		  
			+'<table border="1"><tr><td>Login ID</td><td>User Name</td><td>Designation</td><td>Department</td><td>Access level</td>'
			+'<td>Access Code</td><td>Cost Code</td></tr>'
			+@HTMLBODY1+'</table><BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>'

			set @subject='Monthly Free access review'
						
			EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL          
			@RECIPIENTS =@email,          
			@COPY_RECIPIENTS = @emailcc,          
			@BLIND_COPY_RECIPIENTS = @emailbcc,          
			@PROFILE_NAME = 'SQUARE',          
			@BODY_FORMAT ='HTML',          
			@SUBJECT = @subject,          
			@FILE_ATTACHMENTS ='',          
			@BODY =@HTMLBODY1          
			
			set @xctr=@xctr+1
			
		end	
	end
		  
END TRY          
BEGIN CATCH          
          
	insert into risk.dbo.Appln_ERROR (ErrTime,ErrObject,ErrLine,ErrMessage,ApplnName,DBname)                                  
	select GETDATE(),'GenericId_email_EMP_HOD',ERROR_LINE(),ERROR_MESSAGE(),'AIAAS alter email',DB_NAME(db_id())                                  

	DECLARE @ErrorMessage NVARCHAR(4000);                                
	SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                
	RAISERROR (@ErrorMessage , 16, 1);     
          
END CATCH          
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_menu
-- --------------------------------------------------
CREATE procedure [dbo].[get_menu](@user as varchar(10),@userid as int,@catcode as int)      
as       
Set nocount on  
 select  a.menu_code,head,sub_head,menu_name,menu_url,seq_no,menu_desc,applicable_to   
 from menu_item a with (nolock) join      
 (       
 select distinct menu_Code from      
 (      
 select x.menu_code from      
 (select menu_code from get_menu_option with (nolock)   
 where cat_Code=@CatCode     
 and userid=@userid) x left outer join      
 (select menu_code from exclude_cat_mapping with (nolock)  where  emp_no=@user) y   
 on x.menu_Code=y.menu_code       
 where y.menu_Code is null      
 union      
  select p.menu_code from      
  (      
  select menu_code from get_menu_option_extra with (nolock) where  userid=@userid      
  ) p join   ( select menu_code from extra_cat_mapping (nolock)   where  emp_no=@user) q      
  on p.menu_code=q.menu_Code      
 ) t      
 ) b on a.menu_code=b.menu_Code      
  order by head,sub_head,seq_no,menu_name    
      
  Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_menu2012
-- --------------------------------------------------
     
CREATE procedure [dbo].[get_menu2012](@user as varchar(10),@userid as int,@catcode as int)            
as             
Set nocount on        
 select  a.menu_code,head,sub_head,menu_name,menu_url,seq_no,menu_desc,applicable_to         
 from menu_item a with (nolock) join            
 (             
 select distinct menu_Code from            
 (            
 select x.menu_code from            
 (select menu_code from get_menu_option with (nolock)         
 where cat_Code=@CatCode           
 and userid=@userid) x left outer join            
 (select menu_code from exclude_cat_mapping with (nolock)  where  emp_no=@user) y         
 on x.menu_Code=y.menu_code             
 where y.menu_Code is null            
 union            
  select p.menu_code from            
  (            
  select menu_code from get_menu_option_extra with (nolock) where  userid=@userid            
  ) p join   ( select menu_code from extra_cat_mapping (nolock)   where  emp_no=@user) q            
  on p.menu_code=q.menu_Code            
 ) t            
 ) b on a.menu_code=b.menu_Code           
  where Head  in ('New RMS','Limit','Surveillance','NCMS','Payout Request','Payout Request','Bond','ARQ')  OR sub_head IN ('Customized ARQ','IPO PRE Printed Forms','B2C','Client Info')      
  order by head,sub_head,seq_no,menu_name          
  --,'KYC'    
            
  Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_menu2012_147
-- --------------------------------------------------

CREATE procedure [dbo].[get_menu2012_147](@user as varchar(10),@userid as int,@catcode as int)          
as           
Set nocount on      
 select  a.menu_code,head,sub_head,menu_name,menu_url,seq_no,menu_desc,applicable_to       
 from menu_item a with (nolock) join          
 (           
 select distinct menu_Code from          
 (          
 select x.menu_code from          
 (select menu_code from get_menu_option with (nolock)       
 where cat_Code=@CatCode         
 and userid=@userid) x left outer join          
 (select menu_code from exclude_cat_mapping with (nolock)  where  emp_no=@user) y       
 on x.menu_Code=y.menu_code           
 where y.menu_Code is null          
 union          
  select p.menu_code from          
  (          
  select menu_code from get_menu_option_extra with (nolock) where  userid=@userid          
  ) p join   ( select menu_code from extra_cat_mapping (nolock)   where  emp_no=@user) q          
  on p.menu_code=q.menu_Code          
 ) t          
 ) b on a.menu_code=b.menu_Code         
  --where Head  in ('New RMS','Limit','Surveillance','NCMS','Payout Request','Accounts Utility','Payout Request','Bond')  OR sub_head IN ('Customized ARQ','IPO PRE Printed Forms','B2C','Client Info')    
  order by head,sub_head,seq_no,menu_name        
  --,'KYC'  
          
  Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_menu2012_bkp_11_Oct_2017
-- --------------------------------------------------



create procedure [dbo].[get_menu2012_bkp_11_Oct_2017](@user as varchar(10),@userid as int,@catcode as int)          
as           
Set nocount on      
 select  a.menu_code,head,sub_head,menu_name,menu_url,seq_no,menu_desc,applicable_to       
 from menu_item a with (nolock) join          
 (           
 select distinct menu_Code from          
 (          
 select x.menu_code from          
 (select menu_code from get_menu_option with (nolock)       
 where cat_Code=@CatCode         
 and userid=@userid) x left outer join          
 (select menu_code from exclude_cat_mapping with (nolock)  where  emp_no=@user) y       
 on x.menu_Code=y.menu_code           
 where y.menu_Code is null          
 union          
  select p.menu_code from          
  (          
  select menu_code from get_menu_option_extra with (nolock) where  userid=@userid          
  ) p join   ( select menu_code from extra_cat_mapping (nolock)   where  emp_no=@user) q          
  on p.menu_code=q.menu_Code          
 ) t          
 ) b on a.menu_code=b.menu_Code         
  where Head  in ('New RMS','Limit','Surveillance','NCMS','Payout Request')  OR sub_head IN ('IPO PRE Printed Forms','B2C','Client Info')    
  order by head,sub_head,seq_no,menu_name        
  --,'KYC'  
          
  Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Get_UserDet
-- --------------------------------------------------
CREATE Procedure Get_UserDet(@userid as int)  
as  
  
set nocount on  
  
select   
userid,a.person_name,a.username,a.userpassword,a.usertype,a.access_to,a.access_code,a.cat_code,a.status,a.last_login,a.NoOfTry,  
a.NoOfLogin,a.login_Activated,a.login_inactive_date,a.active,a.email,a.IP,a.IP_active,a.Gateway,a.Gateway_active,a.session_id,  
a.CreatedBy,a.CreatedOn,a.LastModifiedBy,a.LastModifiedOn,b.cat_name   
into #file1  
from  
(  
Select userid,person_name,username,Risk.[dbo].[Decrypt_New](userpassword)userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedOn,LastModifiedBy,
LastModifiedOn from user_login with (nolock) where userid=@userid) a join  
menu_cat b (nolock)   
on a.cat_Code=b.cat_code   
  
select a.*,isnull(b.Exactive,1) as Exactive from #file1 a left outer join   
(  
select emp_no,Emp_name,separationdate,(Case when isnull(separationDate,convert(Datetime,'Dec 31 2049')) <= GETDATE() then 0 else 1 end) as Exactive   
from risk.dbo.emp_info with (nolock)  
) b on a.username=b.emp_no  
order by access_to,access_code,usertype  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Get_UserDet_06nov2023
-- --------------------------------------------------
CREATE Procedure Get_UserDet_06nov2023(@userid as int)  
as  
  
set nocount on  
  
select   
userid,a.person_name,a.username,a.userpassword,a.usertype,a.access_to,a.access_code,a.cat_code,a.status,a.last_login,a.NoOfTry,  
a.NoOfLogin,a.login_Activated,a.login_inactive_date,a.active,a.email,a.IP,a.IP_active,a.Gateway,a.Gateway_active,a.session_id,  
a.CreatedBy,a.CreatedOn,a.LastModifiedBy,a.LastModifiedOn,b.cat_name   
into #file1  
from  
(  
Select userid,person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedOn,LastModifiedBy,
LastModifiedOn from user_login with (nolock) where userid=@userid) a join  
menu_cat b (nolock)   
on a.cat_Code=b.cat_code   
  
select a.*,isnull(b.Exactive,1) as Exactive from #file1 a left outer join   
(  
select emp_no,Emp_name,separationdate,(Case when isnull(separationDate,convert(Datetime,'Dec 31 2049')) <= GETDATE() then 0 else 1 end) as Exactive   
from risk.dbo.emp_info with (nolock)  
) b on a.username=b.emp_no  
order by access_to,access_code,usertype  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetFltLevel
-- --------------------------------------------------
CREATE procedure GetFltLevel
(
	@Rpt_level as varchar(25),
	@access_to as varchar(25),
	@access_Code as varchar(25)
)                          
as                          
set nocount on                          
                          
                      
                          
                          
 --declare @access_Code as varchar(25),@access_to as varchar(25),@Rpt_level as varchar(25)                  
DECLARE @str as varchar(1000)                
/*                    
 set @access_to ='region'                          
set @access_Code ='mum'                          
set @Rpt_level ='region'                      
*/          
                          
                          
set @str=''                          
if @access_to ='BROKER'                           
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+' as filter_val from intranet.risk.dbo.Vw_RMS_Client_Vertical '                          
End                        
else if @access_to ='BRMAST'                           
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+' as filter_val from intranet.risk.dbo.Vw_RMS_Client_Vertical_BRMAST where '+@access_to+' = '''+@access_Code+''''                           
End                     
else if @access_to ='SBMAST'                           
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+' as filter_val from intranet.risk.dbo.Vw_RMS_Client_Vertical_SBMAST where '+@access_to+' = '''+@access_Code+''''                           
End                    
else if @access_to ='ZONE'                           
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+' as filter_val from intranet.risk.dbo.zone where '+@access_to+' = '''+@access_Code+''''                           
End                   
else if @access_to ='ZNMAST'                           
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+' as filter_val from intranet.risk.dbo.zone where '+@access_to+' = '''+@access_Code+''''                           
End                  
else if @access_to ='REGION'                           
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+'_code as filter_val from intranet.risk.dbo.vw_region_group_branches where '+@access_to+'_CODE = '''+@access_Code+''''                           
End                   
else if @access_to ='RGMAST'                           
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+'_code as filter_val from intranet.risk.dbo.vw_region_group_branches where '+@access_to+'_CODE = '''+@access_Code+''''                           
End                   
                      
Else                          
Begin                          
 set @str=@str + ' select distinct '+@Rpt_level+' as filter_val from Vw_RMS_Client_Vertical where '+@access_to+' = '''+@access_Code+''''                           
end                          
                          
 exec(@str)                          
                          
print @str                          
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetFltLevelVAlid
-- --------------------------------------------------
CREATE procedure GetFltLevelVAlid
(
	@Rpt_level as varchar(25),
	@access_to as varchar(25),
	@access_Code as varchar(25),
	@FltVal as varchar(25)
)                    

as                    
set nocount on                    
     
    
                    
declare @str as varchar(1000)                    
                    
/*                    
declare @access_Code as varchar(25),@access_to as varchar(25),@Rpt_level as varchar(25),@str as varchar(1000)                    
set @access_to ='BROKER'                    
set @access_Code ='CSO'                    
set @Rpt_level ='Client'                    
*/                    
                    
set @str=''                    
if @access_to ='BROKER'                     
Begin                    
 --set @str=@str + ' select distinct '+@Rpt_level+' from Vw_RMS_Client_Vertical '                    
 set @str=@str + ' select count(1) from intranet.risk.dbo.Vw_RMS_Client_Vertical where '+@Rpt_level+' like '''+@FltVal+''''                     
End      
else if @access_to ='BRMAST'           
Begin          
 set @str=@str + ' select count(1) as filter_val from intranet.risk.dbo.Vw_RMS_Client_Vertical_BRMAST where '+@access_to+' = '''+@access_Code+''''           
End     
else if @access_to ='SBMAST'           
Begin          
 set @str=@str + ' select count(1) as filter_val from intranet.risk.dbo.Vw_RMS_Client_Vertical_SBMAST where '+@access_to+' = '''+@access_Code+''''           
End                    
Else                    
Begin                    
 set @str=@str + ' select count(1) from intranet.risk.dbo.Vw_RMS_Client_Vertical where '+@Rpt_level+' like '''+@FltVal+''' and '+@access_to+' = '''+@access_Code+''''                     
end                    
                    
exec(@str)                    
                    
print @str                    
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetUserDataForToday
-- --------------------------------------------------

CREATE PROCEDURE dbo.GetUserDataForToday
    @TargetDate VARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

	SET @TargetDate = CONVERT(VARCHAR, GETDATE(), 109)

    -- This will ensure that only rows with the specified date are selected
    SELECT username, access_code
    FROM dbo.user_login
    WHERE CreatedOn = @TargetDate
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetUserInfo
-- --------------------------------------------------
CREATE procedure GetUserInfo(@emp as varchar(50),@user as varchar(10))
as
select 
c.userid,c.person_name,c.username,c.usertype,c.access_to,c.access_code,c.cat_code,c.status,c.last_login,c.NoOfTry,
c.NoOfLogin,c.login_Activated,c.login_inactive_date,c.active,c.email,c.IP,c.IP_active,c.Gateway,c.Gateway_active,c.session_id,
c.CreatedBy,c.CreatedOn,c.LastModifiedBy,c.LastModifiedOn,c.cat_name,
emp_no=isnull(d.emp_no,''),flag=case when emp_no<>'' then 'ex' end,
AdminUser=(case when e.empcode is not null then 'Yes' else 'No' end)
 from
(
	select 
	a.userid,a.person_name,a.username,a.userpassword,a.usertype,a.access_to,a.access_code,a.cat_code,a.status,
	a.last_login,a.NoOfTry,a.NoOfLogin,a.login_Activated,a.login_inactive_date,a.active,a.email,a.IP,a.IP_active,
	a.Gateway,a.Gateway_active,a.session_id,a.CreatedBy,a.CreatedOn,a.LastModifiedBy,a.LastModifiedOn
	,b.cat_name,xempcode=@user from user_login a (nolock) , menu_cat b (nolock)
	where a.cat_Code=b.cat_code and (username=@emp or person_name like @emp+'%')
)c
left outer join
(
	select distinct emp_no from extra_cat_mapping where emp_no in (
	select emp_no from emp_info where emp_no=@emp or emp_name like @emp+'%')
)d
on c.username=d.emp_no
left outer join (Select empcode from AdminUsers where empcode=@user and activeStatus=1) e
on c.xempcode=e.empcode
order by cat_name, username

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetUSerShiftLog
-- --------------------------------------------------

CREATE procedure GetUSerShiftLog(@user as varchar(10))    
as    
select top 1     
Srno,FromUSer,FromUser_CatCode,FromUSer_Status,FromUSer_Extra_cnt,FromUSer_Exclu_cnt,ToUSer,ToUser_PrevCatCode,ToUser_NewCatCode,ToUser_PrevExtraCnt,ToUser_PrevExcluCnt,RetainYN,UpdatedDate=CONVERT(varchar(25),UpdatedDate),Updatedby    
from UserAccessShiftLog where updatedby=@user    
ORDER BY UpdatedDate DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Inhouse_MenuAdded
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[Inhouse_MenuAdded]                   
                    
AS                    
                    
BEGIN                    
                   
                    
select Menu_code as  user_id,
Head+' -> '+Sub_Head+' -> '+Menu_name as Header,
Menu_url,Owner_name,Developer_Name,Update_on
into #SYNERGYUSER
from menu_item with (nolock) where menu_url not in
(select Menu_url from menu_item_audit with (nolock))
and active='Y'

         
DECLARE @COUNT AS INT      
       
       
select @COUNT=COUNT(DISTINCT USER_ID) FROM #SYNERGYUSER      
SELECT DISTINCT USER_ID INTO #SYN FROM #SYNERGYUSER      
       
SELECT  ROW_NUMBER() OVER(ORDER BY USER_ID DESC) AS  'ROWNUM',* INTO #SYN1                      
FROM #SYN      
       
       
--DECLARE @COUNT AS INT          
if( @COUNT>0)      
BEGIN      
       
DECLARE @TABLEHTML1 AS NVARCHAR(MAX);                                                                                                                                                            
                                                        
 SET @TABLEHTML1 =                                                             
 N'DEAR ALL,<BR><BR>' +                                                                                       
 N'KINDLY NOTE THE MENTIONED LINKS HAD BEEN ACTIVATED IN INHOUSE. KINDLY CHECK ITS <BR><BR>'          
 +N'TESTING STATUS FOR YOUR REFERENCE.<BR><BR>'+                                      
 N'<TABLE  BORDER="1" ALIGN="CENTER" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#FFFFFF" BGCOLOR="#D5C9F1"                   
 STYLE="BORDER:#000000 SOLID 1PX;FONT-SIZE:15PX;FONT-FAMILY:ARIAL">'                                                                                                 
                    
 +N'<TR>'                                     
 +N'<TD HEIGHT="15" COLSPAN="3" BGCOLOR="#2C204B" ALIGN=CENTER><FONT COLOR=WHITE SIZE="3"><B>LINK ADDED IN INHOUSE</B></FONT> </TD>'                                                  
 +N'</TR>' +                                                                                                                                                              
 +N'<TR>'                                                     
 +N'<TH WIDTH: 69PX; HEIGHT: 21PX; BGCOLOR="#AA98D3">Sr.No.</TH> '                                                  
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Header</TH> '                                                                                                                                                            
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">URL</TH> '                        
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Owner</TH> '                        
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Developer</TH> '                        
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">Added date</TH> '                        
 +N'</TR>'+                    
                    
                   
 CAST((SELECT                  
 TD =  ROW_NUMBER() OVER( ORDER BY A.USER_ID ,A.USER_ID),'',                                 
 TD = A.Header,'',                                   
 TD = A.Menu_url,'',    
 TD = A.Owner_name,'',    
 TD = A.Developer_Name,'',    
 TD = A.Update_on,''
      FROM #SYNERGYUSER A      
      JOIN  #SYN1 B      
      ON A.USER_ID=B.USER_ID                      
            --WHERE B.ROWNUM=@COUNT       
        ORDER BY A.USER_ID                        
      FOR XML PATH('TR'),TYPE) AS NVARCHAR(MAX)) +                     
                               
                          
 '</TR>' +                     
 +N' </TABLE><BR><BR><BR><BR>'                     
                                  
 +N' <TABLE> '+                                    
 +N' <TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >FOR ANY INFORMATION EMAIL :- INHOUSE.SUPPORT@ANGELBROKING.COM <BR><BR></TD></TR>'                    
 +N'<TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >ANGEL INHOUSE AUTO AUDIT SYSTEM(AIAAS)</TD></TR>'                    
 +N'<TR><TD STYLE="FONT-SIZE: 12PX" ,FONT:BOLD >MANAGED BY ANGEL INHOUSE SOFTWARE TEAM</TD></TR>'                    
 +N'</TABLE><BR> <BR>'                                                                                                
 +N'THIS IS AN AUTOMATED SYSTEM GENERATED INFORMATION FOR YOUR REFERENCE.PLEASE DO NOT REPLY.<BR>ANGEL BROKING '                     
       
       
                               
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                               
@RECIPIENTS  = 'apptest@angelbroking.com',                                                                     
--@RECIPIENTS  = 'manesh@angelbroking.com',                                                                     
@PROFILE_NAME = 'DBA',                                                                                                              
@BODY_FORMAT ='HTML',                                   
@SUBJECT = 'New Links Added in Inhouse.',                                                                                                                  
@BODY = @TABLEHTML1                                                                                                         
PRINT @TABLEHTML1                      
                                                            
       
END
 
truncate table menu_item_audit        
insert into menu_item_audit select Menu_url from menu_item with (nolock)

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Insp_Set
-- --------------------------------------------------

Create Procedure Insp_Set
as
update emp_info set status='A' where emp_no in
(select username from user_login where access_code like '%RBTRG%' and login_Activated like 'Apr  4 2013%' )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin
-- --------------------------------------------------




--Ipartnet_ForgetLogin 'CBHO019','ATUPD7976K',''       

CREATE Procedure [dbo].[Ipartnet_ForgetLogin]          

(          

@UserID varchar(50),        

@PanNo varchar(50),      

@MachineIp varchar(50)=null      

)          

as          

set nocount on          

Begin          

/*

declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      

*/

declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      



declare @PWD varchar(500),@Email varchar(50)        

   

Declare @Sb varchar(100)







if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @PWD=password from Mimansa.dbo.tbl_Emp_Master with(nolock) where user_id=@UserID --and usertype='Admin'      

END

ELSE

BEGIN

	select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      

END





if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @Sb=sb_tag fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID



      

Set @UserID=@Sb   

END   

      

if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      

Begin      

set @username=@UserID      

set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      

 if(ISNULL(@access_code,'')<>'')    

 Begin    

  if exists(select * from     

     (    

     select panno from [MIS].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    

     union     

     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    

     )x)    

  Begin    

   --declare @PWD varchar(500),@Email varchar(50)        

   

     select top 1 @mobile=c.mobno,@Email=c.EmailID from [MIS].sb_comp.dbo.sb_contact c with(nolock) inner join  [MIS].sb_comp.dbo.sb_broker sb      

         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      

             

     print   @Email

     print  @access_code    

     print @mobile 

   if(isnull(@mobile,'')='')      

   Begin      

   print 'mob'      

   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      

   End      

   print @mobile     

       









   

    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	--select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      



    if(@Email='')

    Begin

    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	select @Email=Email from user_login with(nolock) where username=@UserID 

    end

	Print 'AAA'

Print @PWD



        

    IF(@Email<>'')      

    BEGIN          

    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       

    print 'Email'     

    END      

          

    if(isnull(@mobile,'')<>'')      

    Begin      

    set @Message='Dear User, below are the NXT Password :- '+@PWD+'';                  

          

    INSERT INTO [MIMANSA].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            

    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            

              

                

    End      

        

    --insert into forget_pwd_log        

    --(date_time,pc_ip_name,username,password1,[message])        

    --values        

    --(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        

          



    insert into forget_pwd_log        

    (date_time,pc_ip_name,username,password1,[message])        

	select 

    getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id :- '+ @Email +' and Mobile no:- ' +@mobile     

          

    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            

    End      

    else      

    Begin      

    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      

    End              

  End    

  else    

  Begin    

  select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     

  End    

 End    

 else    

 Begin    

 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    

 End       

     

End      

     

      

          

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_10Oct2018
-- --------------------------------------------------
--Ipartnet_ForgetLogin 'EMT','ANIPS0re362G',''       
Create Procedure [dbo].[Ipartnet_ForgetLogin_10Oct2018]          
(          
@UserID varchar(50),        
@PanNo varchar(50),      
@MachineIp varchar(50)=null      
)          
as          
set nocount on          
Begin          
/*
declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      
*/
declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      
      
      
if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      
Begin      
set @username=@UserID      
set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      
 if(ISNULL(@access_code,'')<>'')    
 Begin    
  if exists(select * from     
     (    
     select panno from [196.1.115.167].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    
     union     
     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    
     )x)    
  Begin    
   declare @PWD varchar(500),@Email varchar(50)        
   select top 1 @mobile=c.mobno,@Email=c.EmailID from [196.1.115.167].sb_comp.dbo.sb_contact c with(nolock) inner join  [196.1.115.167].sb_comp.dbo.sb_broker sb      
         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      
             
     print   @Email
     print  @access_code    
     print @mobile 
   if(isnull(@mobile,'')='')      
   Begin      
   print 'mob'      
   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      
   End      
   print @mobile     
       
   
    select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
    if(@Email='')
    Begin
    select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
    end
        
    IF(@Email<>'')      
    BEGIN          
    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       
    print 'Email'     
    END      
          
    if(isnull(@mobile,'')<>'')      
    Begin      
    set @Message='Dear User, below are the NXT Password :- '+@PWD+'';                  
          
    INSERT INTO [196.1.115.207].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            
    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            
              
                
    End      
        
    insert into forget_pwd_log        
    (date_time,pc_ip_name,username,password1,[message])        
    values        
    (getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        
          
    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            
    End      
    else      
    Begin      
    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      
    End              
  End    
  else    
  Begin    
   select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     
  End    
 End    
 else    
 Begin    
 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    
 End       
     
End      
     
      
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_Bak
-- --------------------------------------------------
--Ipartnet_ForgetLogin 'ACMEMT','',''   
CREATE Procedure [dbo].[Ipartnet_ForgetLogin_Bak]      
(      
@UserID varchar(50)=null,    
@PanNo varchar(50)=null,  
@MachineIp varchar(50)=null  
)      
as      
set nocount on      
Begin      
declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50)  
  
  
if(isnull(@UserID,'')<>'')  
Begin  
set @username=@UserID  
set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)  
  
  
set @mobile=(select top 1 c.mobno from [MIS].sb_comp.dbo.sb_contact c with(nolock) inner join  [MIS].sb_comp.dbo.sb_broker sb  
   on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>'')  
     
if(isnull(@mobile,'')='')  
Begin  
print 'mob'  
set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)  
End     
     
print @mobile  
End  
if(isnull(@PanNo,'')<>'')  
begin  
set @username=(select sbtag from [MIS].sb_comp.dbo.sb_broker with(nolock) where panno=@PanNo)  
  
set @mobile=(select top 1 c.mobno from [MIS].sb_comp.dbo.sb_contact c with(nolock) inner join  [MIS].sb_comp.dbo.sb_broker sb  
   on c.RefNo=sb.RefNo  where sb.panno=@PanNo and ISNULL(c.mobno,'')<>'')  
  
  
  
end  
  
 if(@username<>'')  
 Begin  
  declare @PWD varchar(500),@Email varchar(50)    
  select @PWD=userpassword,@Email=email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'  
  
  IF(@Email<>'')  
  BEGIN      
  exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email    
  END  
    
  if(isnull(@mobile,'')<>'')  
  Begin  
  set @Message='Dear User, below are the NXT Password :- '+@PWD+'';          
  
    
  INSERT INTO [Mimansa].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])        
  VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')        
        
          
  End  
    
    
      
  insert into forget_pwd_log    
  (date_time,pc_ip_name,username,password1,[message])    
  values    
  (getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')    
    
  select @mobile as MobileNo,'Success' as Msg  
    
    
    End  
    else  
    Begin  
     select '' as MobileNo,'Fail' as Msg  
    End  
End      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_Bkp26Mar2021
-- --------------------------------------------------
--Ipartnet_ForgetLogin 'EMT','ANIPS0re362G',''       
CREATE Procedure [dbo].[Ipartnet_ForgetLogin_Bkp26Mar2021]          
(          
@UserID varchar(50),        
@PanNo varchar(50),      
@MachineIp varchar(50)=null      
)          
as          
set nocount on          
Begin          
/*
declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      
*/
declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      

Declare @Sb varchar(100)

if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@UserID)>0
begin

select @Sb=sb_tag fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@UserID
      
Set @UserID=@Sb   
END   
      
if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      
Begin      
set @username=@UserID      
set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      
 if(ISNULL(@access_code,'')<>'')    
 Begin    
  if exists(select * from     
     (    
     select panno from [196.1.115.167].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    
     union     
     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    
     )x)    
  Begin    
   declare @PWD varchar(500),@Email varchar(50)        
   
     select top 1 @mobile=c.mobno,@Email=c.EmailID from [196.1.115.167].sb_comp.dbo.sb_contact c with(nolock) inner join  [196.1.115.167].sb_comp.dbo.sb_broker sb      
         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      
             
     print   @Email
     print  @access_code    
     print @mobile 
   if(isnull(@mobile,'')='')      
   Begin      
   print 'mob'      
   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      
   End      
   print @mobile     
       




   
    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
	select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      

    if(@Email='')
    Begin
    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
	select @Email=Email from user_login with(nolock) where username=@UserID 
    end
        
    IF(@Email<>'')      
    BEGIN          
    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       
    print 'Email'     
    END      
          
    if(isnull(@mobile,'')<>'')      
    Begin      
    set @Message='Dear User, below are the NXT Password :- '+@PWD+'';                  
          
    INSERT INTO [196.1.115.207].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            
    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            
              
                
    End      
        
    --insert into forget_pwd_log        
    --(date_time,pc_ip_name,username,password1,[message])        
    --values        
    --(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        
          

    insert into forget_pwd_log        
    (date_time,pc_ip_name,username,password1,[message])        
	select 
    getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id :- '+ @Email +'and Mobile no:- ' +@mobile     
          
    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            
    End      
    else      
    Begin      
    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      
    End              
  End    
  else    
  Begin    
  select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     
  End    
 End    
 else    
 Begin    
 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    
 End       
     
End      
     
      
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_Bkp31Marc2021
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--Ipartnet_ForgetLogin 'EMT','ANIPS0re362G',''       
CREATE Procedure [dbo].[Ipartnet_ForgetLogin_Bkp31Marc2021]          
(          
@UserID varchar(50),        
@PanNo varchar(50),      
@MachineIp varchar(50)=null      
)          
as          
set nocount on          
Begin          
/*
declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      
*/
declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      

Declare @Sb varchar(100)

if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@UserID)>0
begin

select @Sb=sb_tag fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@UserID
      
Set @UserID=@Sb   
END   
      
if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      
Begin      
set @username=@UserID      
set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      
 if(ISNULL(@access_code,'')<>'')    
 Begin    
  if exists(select * from     
     (    
     select panno from [196.1.115.167].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    
     union     
     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    
     )x)    
  Begin    
   declare @PWD varchar(500),@Email varchar(50)        
   
     select top 1 @mobile=c.mobno,@Email=c.EmailID from [196.1.115.167].sb_comp.dbo.sb_contact c with(nolock) inner join  [196.1.115.167].sb_comp.dbo.sb_broker sb      
         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      
             
     print   @Email
     print  @access_code    
     print @mobile 
   if(isnull(@mobile,'')='')      
   Begin      
   print 'mob'      
   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      
   End      
   print @mobile     
       




   
    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
	select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      

    if(@Email='')
    Begin
    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
	select @Email=Email from user_login with(nolock) where username=@UserID 
    end
        
    IF(@Email<>'')      
    BEGIN          
    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       
    print 'Email'     
    END      
          
    if(isnull(@mobile,'')<>'')      
    Begin      
    set @Message='Dear User, below are the NXT Password :- '+@PWD+' - Angel Broking';                  
          
    INSERT INTO [196.1.115.207].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            
    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            
              
                
    End      
        
    --insert into forget_pwd_log        
    --(date_time,pc_ip_name,username,password1,[message])        
    --values        
    --(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        
          

    insert into forget_pwd_log        
    (date_time,pc_ip_name,username,password1,[message])        
	select 
    getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id :- '+ @Email +'and Mobile no:- ' +@mobile     
          
    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            
    End      
    else      
    Begin      
    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      
    End              
  End    
  else 
  Begin    
   select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     
  End    
 End    
 else    
 Begin    
 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    
 End       
     
End      
     
      
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_Bkp31March2021_5_45PM
-- --------------------------------------------------
--Ipartnet_ForgetLogin 'EMT','ANIPS0re362G',''       
CREATE Procedure [dbo].[Ipartnet_ForgetLogin_Bkp31March2021_5_45PM]          
(          
@UserID varchar(50),        
@PanNo varchar(50),      
@MachineIp varchar(50)=null      
)          
as          
set nocount on          
Begin          
/*
declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      
*/
declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      

Declare @Sb varchar(100)

if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@UserID)>0
begin

select @Sb=sb_tag fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@UserID
      
Set @UserID=@Sb   
END   
      
if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      
Begin      
set @username=@UserID      
set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      
 if(ISNULL(@access_code,'')<>'')    
 Begin    
  if exists(select * from     
     (    
     select panno from [196.1.115.167].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    
     union     
     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    
     )x)    
  Begin    
   declare @PWD varchar(500),@Email varchar(50)        
   
     select top 1 @mobile=c.mobno,@Email=c.EmailID from [196.1.115.167].sb_comp.dbo.sb_contact c with(nolock) inner join  [196.1.115.167].sb_comp.dbo.sb_broker sb      
         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      
             
     print   @Email
     print  @access_code    
     print @mobile 
   if(isnull(@mobile,'')='')      
   Begin      
   print 'mob'      
   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      
   End      
   print @mobile     
       




   
    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
	select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      

    if(@Email='')
    Begin
    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
	select @Email=Email from user_login with(nolock) where username=@UserID 
    end
        
    IF(@Email<>'')      
    BEGIN          
    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       
    print 'Email'     
    END      
          
    if(isnull(@mobile,'')<>'')      
    Begin      
    set @Message='Dear User, below are the NXT Password :- '+@PWD+' - Angel Broking';                  
          
    INSERT INTO [196.1.115.207].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            
    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            
              
                
    End      
        
    --insert into forget_pwd_log        
    --(date_time,pc_ip_name,username,password1,[message])        
    --values        
    --(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        
          

    insert into forget_pwd_log        
    (date_time,pc_ip_name,username,password1,[message])        
	select 
    getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id :- '+ @Email +'and Mobile no:- ' +@mobile     
          
    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            
    End      
    else      
    Begin      
    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      
    End              
  End    
  else 
  Begin    
   select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     
  End    
 End    
 else    
 Begin    
 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    
 End       
     
End      
     
      
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_new_V1
-- --------------------------------------------------





---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


--Ipartnet_ForgetLogin 'EMT','ANIPS0re362G',''       

CREATE Procedure [dbo].[Ipartnet_ForgetLogin_new_V1]          

(          

@UserID varchar(50),        

@PanNo varchar(50),      

@MachineIp varchar(50)=null      

)          

as          

set nocount on          

Begin          

/*

declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      

*/

declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      



Declare @Sb varchar(100)



if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @Sb=sb_tag fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID

      

Set @UserID=@Sb   

END   

      

if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      

Begin      

set @username=@UserID      

set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      

 if(ISNULL(@access_code,'')<>'')    

 Begin    

  if exists(select * from     

     (    

     select panno from [MIS].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    

     union     

     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    

     )x)    

  Begin    

   declare @PWD varchar(500),@Email varchar(50)        

   

     select top 1 @mobile=c.mobno,@Email=c.EmailID from [MIS].sb_comp.dbo.sb_contact c with(nolock) inner join  [MIS].sb_comp.dbo.sb_broker sb      

         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      

             

     print   @Email

     print  @access_code    

     print @mobile 

   if(isnull(@mobile,'')='')      

   Begin      

   print 'mob'      

   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      

   End      

   print @mobile     

       









   

    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      



    if(@Email='')

    Begin

    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	select @Email=Email from user_login with(nolock) where username=@UserID 

    end

        

    IF(@Email<>'')      

    BEGIN          

    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       

    print 'Email'     

    END      

          

    if(isnull(@mobile,'')<>'')      

    Begin      

    set @Message='Dear User, below are the NXT Password :- '+@PWD+'';                  

          

    INSERT INTO [MIMANSA].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            

    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            

              

                

    End      

        

    insert into forget_pwd_log        

    (date_time,pc_ip_name,username,password1,[message])        

    values        

    (getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        

          

    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            

    End      

    else      

    Begin      

    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      

    End              

  End    

  else    

  Begin    

   select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     

  End    

 End    

 else    

 Begin    

 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    

 End       

     

End      

     

      

          

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_UAT
-- --------------------------------------------------



--Ipartnet_ForgetLogin 'CBHO019','ATUPD7976K',''       

CREATE Procedure [dbo].[Ipartnet_ForgetLogin_UAT]          

(          

@UserID varchar(50),        

@PanNo varchar(50),      

@MachineIp varchar(50)=null      

)          

as          

set nocount on          

Begin          

/*

declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      

*/

declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      



declare @PWD varchar(500),@Email varchar(50)        

   

Declare @Sb varchar(100)







if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @PWD=password from Mimansa.dbo.tbl_Emp_Master with(nolock) where user_id=@UserID --and usertype='Admin'      

END

ELSE

BEGIN

	select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      

END





if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @Sb=sb_tag fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID



      

Set @UserID=@Sb   

END   

      

if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      

Begin      

set @username=@UserID      

set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      

 if(ISNULL(@access_code,'')<>'')    

 Begin    

  if exists(select * from     

     (    

     select panno from [MIS].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    

     union     

     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    

     )x)    

  Begin    

   --declare @PWD varchar(500),@Email varchar(50)        

   

     select top 1 @mobile=c.mobno,@Email=c.EmailID from [MIS].sb_comp.dbo.sb_contact c with(nolock) inner join  [MIS].sb_comp.dbo.sb_broker sb      

         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      

             

     print   @Email

     print  @access_code    

     print @mobile 

   if(isnull(@mobile,'')='')      

   Begin      

   print 'mob'      

   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      

   End      

   print @mobile     

       









   

    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	--select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      



    if(@Email='')

    Begin

    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	select @Email=Email from user_login with(nolock) where username=@UserID 

    end

	Print 'AAA'

Print @PWD



        

    IF(@Email<>'')      

    BEGIN          

    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       

    print 'Email'     

    END      

          

    if(isnull(@mobile,'')<>'')      

    Begin      

    set @Message='Dear User, below are the NXT Password :- '+@PWD+'';                  

          

    INSERT INTO [MIMANSA].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            

    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            

              

                

    End      

        

    --insert into forget_pwd_log        

    --(date_time,pc_ip_name,username,password1,[message])        

    --values        

    --(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        

          



    insert into forget_pwd_log        

    (date_time,pc_ip_name,username,password1,[message])        

	select 

    getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id :- '+ @Email +' and Mobile no:- ' +@mobile     

          

    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            

    End      

    else      

    Begin      

    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      

    End              

  End    

  else    

  Begin    

  select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     

  End    

 End    

 else    

 Begin    

 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    

 End       

     

End      

     

      

          

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_V1
-- --------------------------------------------------


--Ipartnet_ForgetLogin 'EMT','ANIPS0re362G',''       

CREATE Procedure [dbo].[Ipartnet_ForgetLogin_V1]          

(          

@UserID varchar(50),        

@PanNo varchar(50),      

@MachineIp varchar(50)=null      

)          

as          

set nocount on          

Begin          

/*

declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      

*/

declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      



declare @PWD varchar(500),@Email varchar(50)        

   

Declare @Sb varchar(100)







if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @PWD=password from Mimansa.dbo.tbl_Emp_Master with(nolock) where user_id=@UserID --and usertype='Admin'      

END

ELSE

BEGIN

	select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      

END





if (select count(1) fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID)>0

begin



select @Sb=sb_tag fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@UserID



      

Set @UserID=@Sb   

END   

      

if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      

Begin      

set @username=@UserID      

set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      

 if(ISNULL(@access_code,'')<>'')    

 Begin    

  if exists(select * from     

     (    

     select panno from [MIS].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    

     union     

     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    

     )x)    

  Begin    

   --declare @PWD varchar(500),@Email varchar(50)        

   

     select top 1 @mobile=c.mobno,@Email=c.EmailID from [MIS].sb_comp.dbo.sb_contact c with(nolock) inner join  [MIS].sb_comp.dbo.sb_broker sb      

         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      

             

     print   @Email

     print  @access_code    

     print @mobile 

   if(isnull(@mobile,'')='')      

   Begin      

   print 'mob'      

   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)      

   End      

   print @mobile     

       









   

    --select @PWD=userpassword from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	--select @PWD=userpassword from user_login with(nolock) where username=@UserID --and usertype='Admin'      



    if(@Email='')

    Begin

    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      

	select @Email=Email from user_login with(nolock) where username=@UserID 

    end

        

    IF(@Email<>'')      

    BEGIN          

    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email       

    print 'Email'     

    END      

          

    if(isnull(@mobile,'')<>'')      

    Begin      

    set @Message='Dear User, below are the NXT Password :- '+@PWD+'';                  

          

    INSERT INTO [MIMANSA].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])            

    VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')            

              

                

    End      

        

    --insert into forget_pwd_log        

    --(date_time,pc_ip_name,username,password1,[message])        

    --values        

    --(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        

          



    insert into forget_pwd_log        

    (date_time,pc_ip_name,username,password1,[message])        

	select 

    getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id :- '+ @Email +'and Mobile no:- ' +@mobile     

          

    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            

    End      

    else      

    Begin      

    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      

    End              

  End    

  else    

  Begin    

  select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     

  End    

 End    

 else    

 Begin    

 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    

 End       

     

End      

     

      

          

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_ForgetLogin_V1_Mobile_2
-- --------------------------------------------------
--EXEC Ipartnet_ForgetLogin_V1_Mobile_2 'CBHO','ATUPD7976K',''       
CREATE Procedure [dbo].[Ipartnet_ForgetLogin_V1_Mobile_2]          
(          
@UserID varchar(50),        
@PanNo varchar(50),      
@MachineIp varchar(50)=null      
)          
as          
set nocount on          
Begin          
/*
declare @UserID varchar(50)='jpfrvvyg',@PanNo varchar(50)='AEHPG0205N'      ,@MachineIp varchar(50)=null      
*/
declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)      

declare @PWD varchar(500),@Email varchar(50)        
   
Declare @Sb varchar(100)


      
if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')      
Begin      
set @username=@UserID      
set @access_code=(select top 1 access_code from user_login with(nolock) where username=@UserID)      
 
 if(ISNULL(@access_code,'')<>'')    
 Begin    
  if exists(select * from     
     (    
     select panno from [196.1.115.167].sb_comp.dbo.sb_broker with(nolock) where sbtag=@access_code and panno=@PanNo    
     union     
     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo    
     )x)    
  Begin    
   --declare @PWD varchar(500),@Email varchar(50)        
   
     select top 1 @mobile=c.mobno,@Email=c.EmailID from [196.1.115.167].sb_comp.dbo.sb_contact c with(nolock) inner join  [196.1.115.167].sb_comp.dbo.sb_broker sb      
         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>''      
            
Create Table #NXT_BNXT_DRA
(
Flag Varchar(10)
)
			 
	Insert into #NXT_BNXT_DRA	
	EXEC [172.31.16.95].NXT.dbo.Usp_Get_Identify_SB_Mobile2_NXT_v1 @UserID


	If (select count(*) from #NXT_BNXT_DRA where Flag in ('NXT_SB','DRA_SB'))>0
	begin 
		select @PWD=userpassword from user_login with(nolock) where username=@UserID 
	END
 
   If (select count(*) from #NXT_BNXT_DRA where Flag='BEENXT_SB')>0
	begin 
		select @PWD=userpassword from [172.31.16.95].nxt.dbo.mf_userlogin with(nolock) where username=@UserID 
	END
 


    if(@Email='')
    Begin
    --select @Email=Email from user_login with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'      
	select @Email=Email from user_login with(nolock) where username=@UserID 
    end
        
    IF(@Email<>'')      
    BEGIN          
    exec [USP_PWD_RESET_MAILER_Ipartner_Mobile_2]   @PWD,@Email       
    print 'Email'     
    END      
        
    --insert into forget_pwd_log        
    --(date_time,pc_ip_name,username,password1,[message])        
    --values        
    --(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')        
          

    insert into [forget_pwd_log_Mobile_2]        
    (date_time,pc_ip_name,username,password1,[message])        
	select 
    getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id :- '+ @Email +'and Mobile no:- ' +@mobile     
          
    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg            
    End      
    else      
    Begin      
    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg      
    End              
  End    
  else    
  Begin    
  select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG     
  End    
 End    
 else    
 Begin    
 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG    
 End       
     
End      
     
      
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ipartnet_UserLogin
-- --------------------------------------------------
--Ipartnet_UserLogin   'E55539'
Create Procedure Ipartnet_UserLogin  
(  
@UserID varchar(50),
@MachineIp varchar(50)  
)  
as  
set nocount on  
Begin  
declare @PWD varchar(500),@Email varchar(50)
select @PWD=userpassword,@Email=email from user_login where username=@UserID 

exec USP_PWD_RESET_MAILER   @PWD,@Email

insert into forget_pwd_log
(date_time,pc_ip_name,username,password1,[message])
values
(getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')

End  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Menu_Acess_List
-- --------------------------------------------------

Create Procedure Menu_Acess_List(@empCode as varchar(10))
as
select x.* from 
(
select * from menu_item where menu_code in (
select Menu_code from cat_mapping where cat_code = (select Cat_code from user_login where username=@empCode)
)
Union all
select * from menu_item where menu_code in (select menu_code from extra_cat_mapping where EMP_NO=@empCode)
) x left outer join
(select * from menu_item where menu_code in (select menu_code from exclude_cat_mapping where EMP_NO=@empCode))
y
on x.menu_code=y.menu_code
where y.menu_code is null
order by x.HEad,x.Sub_head,x.Menu_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.menu_MapCategory
-- --------------------------------------------------
CREATE PROCEDURE MENU_MAPCATEGORY
(
	@MENUCODE INT,
	@CATCODE INT,
	@USERNAME VARCHAR(10)
)
    
AS    
SET NOCOUNT ON    

DECLARE @NOR INT
    
SELECT @NOR=COUNT(*) FROM CAT_MAPPING (NOLOCK) WHERE MENU_CODE=@MENUCODE AND CAT_CODE=@CATCODE    
--PRINT @NOR    
    
IF @NOR=1     
BEGIN    
	INSERT INTO CAT_MAPPING_HIST SELECT CAT_CODE,MENU_CODE,MAPPEDBY,MAPPEDON,@USERNAME,GETDATE()  
	FROM CAT_MAPPING WHERE MENU_CODE=@MENUCODE AND CAT_CODE=@CATCODE    
	PRINT 'DATA INSERTED'  
	DELETE FROM CAT_MAPPING WHERE MENU_CODE=@MENUCODE AND CAT_CODE=@CATCODE    
	PRINT 'MAPPING DELETED SUCCESSFULLY'    
END     

ELSE    
BEGIN    
	INSERT INTO CAT_MAPPING VALUES(@CATCODE,@MENUCODE,@USERNAME,GETDATE())    
	PRINT 'MAPPING ADDED SUCCESSFULLY'    
END    

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.menu_MapCategory_temp
-- --------------------------------------------------
CREATE procedure [dbo].[menu_MapCategory_temp](@menucode int,@catcode int,@username varchar(10))  
   
as  
set nocount on    
declare @nor int    
select @nor=count(*) from temp_cat_mapping (nolock) where menu_code=@menucode and cat_code=@catcode    
--print @nor    
    
if @nor=1     
begin    
insert into cat_mapping_HIST SELECT cat_code,menu_code,MappedBy,MappedOn,@username,getdate()
 FROM temp_cat_mapping where menu_code=@menucode and cat_code=@catcode  
PRINT 'DATA INSERTED'
 delete from temp_cat_mapping where menu_code=@menucode and cat_code=@catcode    
 print 'Mapping Deleted Successfully'    
end     
else    
begin    
 insert into temp_cat_mapping values(@catCode,@menucode,@username,getDate())    
 print 'Mapping Added Successfully'    
end    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MVC_GetUser
-- --------------------------------------------------

CREATE procedure MVC_GetUser(@username as varchar(10),@password as varchar(15))  
as  

select a.*,b.cat_name,isnull(department,a.access_Code) as deptno from
(
select userid,username,person_name,usertype,cat_code,access_code,access_to,status,active,
email
from ROLEMGM.dbo.user_login with (nolock) where username=@username and userpassword=@password 
) a left outer join menu_cat b on a.cat_Code=b.Cat_Code left outer join (select emp_no, department from emp_info where emp_no=@username) c
on a.username=c.emp_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PDA_TBA
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[PDA_TBA] (@user as varchar(15))      
AS  
  
select a.username,a.person_name,a.access_code,b.branch_CD from   
(select *  from user_login where status=1 and username =@user  
	and access_to in('BRMAST')   
)a  
left outer join  
INTRANET.RISK.DBO.BRANCH_MASTER b  
on a.access_code=b.BRMAST_CD  
ORDER BY USERNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin
-- --------------------------------------------------



  

  

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'  

  

  

/*  

  

  

EXEC Prc_AuthenticateLogin 'RFRLHTATH','xpnqx623'    

EXEC [Prc_AuthenticateLogin_NeedtoRelease20Feb2019] 'HOET','hdfc1234'  

  

  

*/  

  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin]  

(  

@USERNAME VARCHAR(50),  

@PASSWORD VARCHAR(50)  

)  

AS  

BEGIN  

  

 --return 0  

  

  

  

  

DECLARE @ACCESS_CODE AS VARCHAR(50)=''  

 DECLARE @BRANCH VARCHAR(50)=''  

IF (@PASSWORD='@SkipPWD')  

BEGIN  

   

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0  

 BEGIN  

   

   

     DECLARE @NOTID AS VARCHAR(MAX)=''  

  

  SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A  

  JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B  

  ON A.ID=B.MAXID   

  

  

  SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME  

     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)  

  

 --addon on 30052018  

  --SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME  

  --UNION  

  --SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A  

 --END  

    

  SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'  

  

 END  

 ELSE   

 BEGIN  

   IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0  

   BEGIN   

   SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT  

   END  

   ELSE   

   BEGIN  

   SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT  

   END  

  

 END  

  

END  

ELSE  

BEGIN  

  

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0  

 BEGIN  

   

  

       

--COLLATE SQL_Latin1_General_CP1_CS_AS   

  --SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A  

  --JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B  

  --ON A.ID=B.MAXID   

  

  

  --SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME  

  --UNION  

  --SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A  

  

  

     

      DECLARE @CNT AS INT =0  

      --Added by Sandeep on 16 May 2018 to get the branch  

       

        

        

      --Ended by Sandeep   

  

      SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME  

      SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)  

  

      SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE  

        

     -- set @CNT=0  

        

         

  

  SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A  

  JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B  

  ON A.ID=B.MAXID   

  

  

    

  SELECT distinct 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH     

  FROM USER_LOGIN with(nolock)   

  WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END  

  ------AND (usertype='ADMIN' or username='EMT')  

  and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))  

  or username in (select username from TempUserMaster  with(nolock))  

  )  

  --and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')  

  --and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB')   

  and access_code not in (select sbtag from [MIS].sb_comp.dbo.VW_ONLY_MF_TAG)  

  --and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])  

    

  --AND (  

  --usertype='ADMIN' or   

  --username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'  

  --,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'  

  --,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'  

  --)  

  --)  

    

 END  

 ELSE   

 BEGIN  

   IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0  

   BEGIN   

   SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT  

   END  

   ELSE   

   BEGIN  

     IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)  

     BEGIN  

      IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)  

      BEGIN  

       SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT   

      END   

     END  

     ELSE  

     BEGIN  

             SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT   

     END  

       

     --SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT  

   END  

  

 END  

  

END  

  

  

  

  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_16May2018
-- --------------------------------------------------
--EXEC PRC_AUTHENTICATELOGIN 'HOET','@SkipPWD'

Create PROCEDURE [dbo].[Prc_AuthenticateLogin_16May2018]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	

	    

		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 DECLARE @ACCESS_CODE AS VARCHAR(50)=''
	     DECLARE @CNT AS INT =0

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT  FROM USER_LOGIN with(nolock) WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END 
		--AND (usertype='ADMIN' or username='EMT')
		AND (usertype='ADMIN' or username in ('EMT','ET','ETPF'))


	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_25May2018
-- --------------------------------------------------
--EXEC PRC_AUTHENTICATELOGIN 'HOET','@SkipPWD'

Create PROCEDURE [dbo].[Prc_AuthenticateLogin_25May2018]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	

	    

		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   FROM USER_LOGIN with(nolock) WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		--AND (usertype='ADMIN' or username='EMT')
		AND (usertype='ADMIN' or username in ('EMT','ET','ETPF'))


	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_30052018
-- --------------------------------------------------
--EXEC PRC_AUTHENTICATELOGIN 'HOET','@SkipPWD'

Create  PROCEDURE [dbo].[Prc_AuthenticateLogin_30052018]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	

	    

		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     --SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	     --set @CNT=0

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   FROM USER_LOGIN with(nolock) WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		--AND (usertype='ADMIN' or username='EMT')
		AND (usertype='ADMIN' or username in ('EMT','ET','ETPF'))


	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_ALL
-- --------------------------------------------------



--EXEC PRC_AUTHENTICATELOGIN 'DHMU','dhmu2016'



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_ALL]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50),

@Source varchar(100)=null

)

AS

BEGIN



IF (@PASSWORD='@SkipPWD')

BEGIN



IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0

	BEGIN

	



	    DECLARE @NOTID AS VARCHAR(MAX)=''



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 





		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A



		

		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT FROM USER_LOGIN WHERE USERNAME =@USERNAME



	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END

ELSE

BEGIN



IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0

	BEGIN

	



	    



		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		--JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		--ON A.ID=B.MAXID 





		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A





		 DECLARE @ACCESS_CODE AS VARCHAR(50)=''

	     DECLARE @CNT AS INT =0



	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME



	     SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 



		if(@Source='Recording')

		Begin

		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT  FROM USER_LOGIN with(nolock) WHERE USERNAME =@USERNAME AND
 ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END 

		--AND (usertype='ADMIN' or username='EMT')

		ENd

		





	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END









END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Bkp20Feb2019
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC Prc_AuthenticateLogin 'N00061','om12345678'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Bkp20Feb2019]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		------AND (usertype='ADMIN' or username='EMT')
		and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		or username in (select username from TempUserMaster  with(nolock))
		)
		and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		
		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer
-- --------------------------------------------------





---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'







--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  



CREATE    PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN

--return 0

--DECLARE @ACCESS_CODE AS VARCHAR(50)=''

-- DECLARE @BRANCH VARCHAR(50)=''



	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

	ON A.Emp_No=B.Emp_no

		where User_ID=@USERNAME

		and ((A.isSuspended	=1 or A.isTerminated=1)

		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

		

		)>0

			BEGIN 

			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

			Return

			END







if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME and  Password=@PASSWORD)>0

BEGIN



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

		,'Dealer'  USERTYPE	

		,'Dealer' ACCESS_TO	

		,User_ID ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME

		and (isSuspended	=0 or isTerminated=0)

		and Password=@PASSWORD







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			

					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0

					BEGIN

						IF NOT EXISTS(SELECT * FROM [INTRANET].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			

	end



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_15July2021
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Prc_authenticatelogin_dealer_15july2021] (
@USERNAME  VARCHAR(50)
,@PASSWORD VARCHAR(50))
AS
BEGIN
    /*
      
        exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] 'CBHO001','@SkipPWD'
      
      
    */
    DECLARE @ACCESS_CODE AS VARCHAR(50)=''
    DECLARE @BRANCH VARCHAR(50)=''

    IF( SELECT Count(*) FROM mimansa.dbo.tbl_emp_master A
						LEFT JOIN mimansa.dbo.tbl_emp_suspension_termination B
						ON A.emp_no = B.emp_no
						WHERE  user_id = @USERNAME
						AND ( ( A.issuspended = 1
                        OR A.isterminated = 1 )
						OR ( B.suspension_date < Getdate()
                        OR B.termination_date <= Getdate()))) > 0
    BEGIN
        SELECT @USERNAME + ' ' + 'Employee Terminated' AS MESSAGE ,0 AS RESULT 
        RETURN
    END
    IF ( @PASSWORD = '@SkipPWD' )
    BEGIN
	print '@SkipPWD'
    IF(SELECT Count(1) FROM   mimansa.dbo.tbl_emp_master WHERE  user_id = @USERNAME) > 0
    BEGIN
        DECLARE @NOTID AS VARCHAR(max)=''

        SELECT @NOTID = A.notificationid
        FROM   (SELECT * 
                FROM   [196.1.115.132].risk.dbo.tbl_mob_notification WITH(nolock)
                WHERE  userid = @USERNAME)A
                JOIN(SELECT Max(id) AS MAXID
                FROM [196.1.115.132].risk.dbo.tbl_mob_notification
                WHERE  userid = @USERNAME)B ON A.id = B.maxid

        SELECT @ACCESS_CODE = access_code
        FROM   rolemgm.dbo.user_login
        WHERE  username = @USERNAME

        SET @BRANCH=(SELECT TOP 1 branch_cd
						FROM   [196.1.115.182].general.dbo.client_details WITH(nolock)
						WHERE  sub_broker = @ACCESS_CODE)

        --addon on 30052018
        --SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
        --UNION
        --SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
        --END
        SELECT 2 AS ID
                ,emp_name  AS NAME
                ,'Dealer'  USERTYPE
                ,'Dealer'  ACCESS_TO
                ,user_id   ACCESS_CODE
                ,email
                ,user_id   UserName
                ,@NOTID    AS DEVICEID
                ,'SUCCESS' AS MESSAGE
                ,1         RESULT
                ,city      BRANCH
                ,password  userpassword
				,'QR'      LOGINTYPE
                ,'Mobile'  LOGINFROM
        FROM   mimansa.dbo.tbl_emp_master
        WHERE  user_id = @USERNAME --and usertype<>'USER'
    --Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 
    END
    --ELSE 
    --BEGIN
    --    IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0
    --    BEGIN 
    --    SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
    --    END
    --    ELSE 
    --    BEGIN
    --    SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
    --    END
    --END
    END
    ELSE
    BEGIN
        IF (SELECT Count(1)
            FROM   [196.1.115.132].mimansa.dbo.tbl_emp_master
            WHERE  user_id = @USERNAME
                    AND password = @PASSWORD) > 0
            BEGIN
                SELECT 1          ID
                        --,First_Name +' '+ Middle_Name+' '+Last_Name NAME  
                        ,emp_name  NAME
                        --,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE
                        ,'Dealer'  USERTYPE
                        ,'Dealer'  ACCESS_TO
                        ,user_id   ACCESS_CODE
                        ,''        EMAIL
                        ,user_id   USERNAME
                        ,ip        DEVICEID
                        ,'Success' MESSAGE
                        ,1         RESULT
                        ,city      BRANCH
                FROM   mimansa.dbo.tbl_emp_master
                WHERE  user_id = @USERNAME
                        AND ( issuspended = 0
                            OR isterminated = 0 )
                        AND password = @PASSWORD
            --AND (
            --usertype='ADMIN' or 
            --username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
            --,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
            --,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
            --)
            --)
            END
        ELSE
            BEGIN
                IF (SELECT Count(*)
                    FROM   mimansa.dbo.tbl_emp_master WITH(nolock)
                    WHERE  user_id = @USERNAME) > 0
                BEGIN
                    IF NOT EXISTS(SELECT *
                                    FROM
                            [196.1.115.132].mimansa.dbo.tbl_emp_master
                            WITH
                            (
                            nolock)
                                    WHERE  password = @PASSWORD)
                        BEGIN
                            SELECT 'Kindly enter valid password!' AS MESSAGE
                                    ,0                             AS RESULT
                        END
                END
                ELSE
                BEGIN
                    SELECT 'Kindly enter valid userid!' AS MESSAGE
                            ,0                           AS RESULT
                END
            --SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
            END
    END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_authenticatelogin_dealer_15july2021_Bkp22July2021
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Prc_authenticatelogin_dealer_15july2021_Bkp22July2021] (
@USERNAME  VARCHAR(50)
,@PASSWORD VARCHAR(50))
AS
BEGIN
    /*
      
        exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] 'CBHO001','@SkipPWD'
      
      
    */
    DECLARE @ACCESS_CODE AS VARCHAR(50)=''
    DECLARE @BRANCH VARCHAR(50)=''

    IF( SELECT Count(*) FROM mimansa.dbo.tbl_emp_master A
						LEFT JOIN mimansa.dbo.tbl_emp_suspension_termination B
						ON A.emp_no = B.emp_no
						WHERE  user_id = @USERNAME
						AND ( ( A.issuspended = 1
                        OR A.isterminated = 1 )
						OR ( B.suspension_date < Getdate()
                        OR B.termination_date <= Getdate()))) > 0
    BEGIN
        SELECT @USERNAME + ' ' + 'Employee Terminated' AS MESSAGE ,0 AS RESULT 
        RETURN
    END
    IF ( @PASSWORD = '@SkipPWD' )
    BEGIN
	print '@SkipPWD'
    IF(SELECT Count(1) FROM   mimansa.dbo.tbl_emp_master WHERE  user_id = @USERNAME) > 0
    BEGIN
        DECLARE @NOTID AS VARCHAR(max)=''

        SELECT @NOTID = A.notificationid
        FROM   (SELECT * 
                FROM   [196.1.115.132].risk.dbo.tbl_mob_notification WITH(nolock)
                WHERE  userid = @USERNAME)A
                JOIN(SELECT Max(id) AS MAXID
                FROM [196.1.115.132].risk.dbo.tbl_mob_notification
                WHERE  userid = @USERNAME)B ON A.id = B.maxid

        SELECT @ACCESS_CODE = access_code
        FROM   rolemgm.dbo.user_login
        WHERE  username = @USERNAME

        SET @BRANCH=(SELECT TOP 1 branch_cd
						FROM   [196.1.115.182].general.dbo.client_details WITH(nolock)
						WHERE  sub_broker = @ACCESS_CODE)

        --addon on 30052018
        --SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
        --UNION
        --SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
        --END
        SELECT 2 AS ID
                ,emp_name  AS NAME
                ,'Dealer'  USERTYPE
                ,'Dealer'  ACCESS_TO
                ,user_id   ACCESS_CODE
                ,email
                ,user_id   UserName
                ,@NOTID    AS DEVICEID
                ,'SUCCESS' AS MESSAGE
                ,1         RESULT
                ,city      BRANCH
                ,password  userpassword
				,'QR'      LOGINTYPE
                ,'Mobile'  LOGINFROM
        FROM   mimansa.dbo.tbl_emp_master
        WHERE  user_id = @USERNAME --and usertype<>'USER'
    --Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 
    END
    --ELSE 
    --BEGIN
    --    IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0
    --    BEGIN 
    --    SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
    --    END
    --    ELSE 
    --    BEGIN
    --    SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
    --    END
    --END
    END
    ELSE
    BEGIN
        IF (SELECT Count(1)
            FROM   [196.1.115.132].mimansa.dbo.tbl_emp_master
            WHERE  user_id = @USERNAME
                    AND password = @PASSWORD) > 0
            BEGIN
                SELECT 1          ID
                        --,First_Name +' '+ Middle_Name+' '+Last_Name NAME  
                        ,emp_name  NAME
                        --,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE
                        ,'Dealer'  USERTYPE
                        ,'Dealer'  ACCESS_TO
                        ,user_id   ACCESS_CODE
                        ,''        EMAIL
                        ,user_id   USERNAME
                        ,ip        DEVICEID
                        ,'Success' MESSAGE
                        ,1         RESULT
                        ,city      BRANCH
                FROM   mimansa.dbo.tbl_emp_master
                WHERE  user_id = @USERNAME
                        AND ( issuspended = 0
                            OR isterminated = 0 )
                        AND password = @PASSWORD
            --AND (
            --usertype='ADMIN' or 
            --username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
            --,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
            --,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
            --)
            --)
            END
        ELSE
            BEGIN
                IF (SELECT Count(*)
                    FROM   mimansa.dbo.tbl_emp_master WITH(nolock)
                    WHERE  user_id = @USERNAME) > 0
                BEGIN
                    IF NOT EXISTS(SELECT *
                                    FROM
                            [196.1.115.132].mimansa.dbo.tbl_emp_master
                            WITH
                            (
                            nolock)
                                    WHERE  password = @PASSWORD)
                        BEGIN
                            SELECT 'Kindly enter valid password!' AS MESSAGE
                                    ,0                             AS RESULT
                        END
                END
                ELSE
                BEGIN
                    SELECT 'Kindly enter valid userid!' AS MESSAGE
                            ,0                           AS RESULT
                END
            --SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
            END
    END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_19March21_Changes
-- --------------------------------------------------
--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

/*

		exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] 'CBHO001','@SkipPWD'


*/


DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''

	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A
	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B
	ON A.Emp_No=B.Emp_no
		where User_ID=@USERNAME
		and ((A.isSuspended	=1 or A.isTerminated=1)
		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))
		
		)>0
			BEGIN 
			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT
			Return
			END


IF (@PASSWORD='@SkipPWD')
BEGIN
 
		IF(SELECT COUNT(1) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME )>0
			BEGIN
	
 
				DECLARE @NOTID AS VARCHAR(MAX)=''

				SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
				JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
				ON A.ID=B.MAXID 


				SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
				SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

			--addon on 30052018
				--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
				--UNION
				--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
			--END
		
				SELECT 2 AS ID,emp_name AS NAME,'QR' USERTYPE ,'Mobile' ACCESS_TO,sb_tag ACCESS_CODE,EMAIL,USER_id UserName,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS 'public int Result',@BRANCH AS BRANCH,password userpassword
				FROM Mimansa.dbo.tbl_Emp_Master WHERE USER_id =@USERNAME --and usertype<>'USER'


				--Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 


			END
			--ELSE 
			--BEGIN
			--		IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0
			--		BEGIN 
			--		SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			--		END
			--		ELSE 
			--		BEGIN
			--		SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			--		END

			--END

END
ELSE
begin








if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME and  Password=@PASSWORD)>0
BEGIN

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE
		,'Dealer'  USERTYPE	
		,'Dealer' ACCESS_TO	
		,User_ID ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME
		and (isSuspended	=0 or isTerminated=0)
		and Password=@PASSWORD



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			
					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0
					BEGIN
						IF NOT EXISTS(SELECT * FROM [196.1.115.132].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			
	end

end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_19March21_Changes_Bkp22July2021
-- --------------------------------------------------
--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes_Bkp22July2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

/*

		exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] 'CBHO001','@SkipPWD'


*/


DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''

	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A
	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B
	ON A.Emp_No=B.Emp_no
		where User_ID=@USERNAME
		and ((A.isSuspended	=1 or A.isTerminated=1)
		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))
		
		)>0
			BEGIN 
			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT
			Return
			END


IF (@PASSWORD='@SkipPWD')
BEGIN
 
		IF(SELECT COUNT(1) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME )>0
			BEGIN
	
 
				DECLARE @NOTID AS VARCHAR(MAX)=''

				SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
				JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
				ON A.ID=B.MAXID 


				SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
				SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

			--addon on 30052018
				--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
				--UNION
				--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
			--END
		
				SELECT 2 AS ID,emp_name AS NAME,'QR' USERTYPE ,'Mobile' ACCESS_TO,sb_tag ACCESS_CODE,EMAIL,USER_id UserName,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS 'public int Result',@BRANCH AS BRANCH,password userpassword
				FROM Mimansa.dbo.tbl_Emp_Master WHERE USER_id =@USERNAME --and usertype<>'USER'


				--Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 


			END
			--ELSE 
			--BEGIN
			--		IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0
			--		BEGIN 
			--		SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			--		END
			--		ELSE 
			--		BEGIN
			--		SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			--		END

			--END

END
ELSE
begin








if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME and  Password=@PASSWORD)>0
BEGIN

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE
		,'Dealer'  USERTYPE	
		,'Dealer' ACCESS_TO	
		,User_ID ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME
		and (isSuspended	=0 or isTerminated=0)
		and Password=@PASSWORD



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			
					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0
					BEGIN
						IF NOT EXISTS(SELECT * FROM [196.1.115.132].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			
	end

end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_bkp18Mar2021
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_bkp18Mar2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

--DECLARE @ACCESS_CODE AS VARCHAR(50)=''
-- DECLARE @BRANCH VARCHAR(50)=''

IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A
left join Mimansa.dbo.tbl_Emp_Suspension_Termination B
ON A.Emp_No=B.Emp_no
where User_ID=@USERNAME
and ((A.isSuspended =1 or A.isTerminated=1)
or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

)>0
BEGIN
SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT
Return
END



if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

SELECT
1 ID
,First_Name +' '+ Middle_Name+' '+Last_Name NAME
--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE
,'Dealer'  USERTYPE
,'Dealer' ACCESS_TO
,User_ID ACCESS_CODE
,'' EMAIL
,User_ID USERNAME
,IP DEVICEID
,'Success' MESSAGE
,1 RESULT
,cITY BRANCH
fROM Mimansa.dbo.tbl_Emp_Master
where User_ID=@USERNAME
and (isSuspended =0 or isTerminated=0)



--AND (
--usertype='ADMIN' or
--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
--)
--)

END
ELSE
BEGIN
IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
BEGIN
SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
END
ELSE
BEGIN
IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
BEGIN
IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
BEGIN
SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT
END
END
ELSE
BEGIN
       SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT
END

--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
END

end

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_Bkp18March2019
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_Bkp18March2019]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

--DECLARE @ACCESS_CODE AS VARCHAR(50)=''
-- DECLARE @BRANCH VARCHAR(50)=''

	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME
		and (isSuspended	=1 or isTerminated=1))>0
			BEGIN 
			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT
			Return
			END



if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE
		,'Dealer'  USERTYPE	
		,'Dealer' ACCESS_TO	
		,User_ID ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME
		and (isSuspended	=0 or isTerminated=0)



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	end

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_C
-- --------------------------------------------------




---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'







--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  



CREATE  PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_C]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN



--DECLARE @ACCESS_CODE AS VARCHAR(50)=''

-- DECLARE @BRANCH VARCHAR(50)=''



	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

	ON A.Emp_No=B.Emp_no

		where User_ID=@USERNAME

		and ((A.isSuspended	=1 or A.isTerminated=1)

		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

		

		)>0

			BEGIN 

			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

			Return

			END







if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME and  Password=@PASSWORD)>0

BEGIN



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

		,'Dealer'  USERTYPE	

		,'Dealer' ACCESS_TO	

		,User_ID ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME

		and (isSuspended	=0 or isTerminated=0)

		and Password=@PASSWORD







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			

					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0

					BEGIN

						IF NOT EXISTS(SELECT * FROM [INTRANET].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			

	end



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_Mobile
-- --------------------------------------------------







--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'







--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_Mobile]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)=null

)

AS

BEGIN



--DECLARE @ACCESS_CODE AS VARCHAR(50)=''

-- DECLARE @BRANCH VARCHAR(50)=''



	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

	ON A.Emp_No=B.Emp_no

		where User_ID=@USERNAME

		and ((A.isSuspended	=1 or A.isTerminated=1)

		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

		

		)>0

			BEGIN 

			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

			Return

			END







if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0

BEGIN



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

		,'Dealer'  USERTYPE	

		,'Dealer' ACCESS_TO	

		,User_ID ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME

		and (isSuspended	=0 or isTerminated=0)

		--and Password=@PASSWORD







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			

					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0

					BEGIN

						IF NOT EXISTS(SELECT * FROM [INTRANET].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			

	end



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_Mobile_NXT
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_Mobile_NXT]
(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN



--DECLARE @ACCESS_CODE AS VARCHAR(50)=''

-- DECLARE @BRANCH VARCHAR(50)=''



IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

ON A.Emp_No=B.Emp_no

where User_ID=@USERNAME

and ((A.isSuspended =1 or A.isTerminated=1)

or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))



)>0

BEGIN

SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

Return

END







if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0

BEGIN



SELECT

1 ID

,First_Name +' '+ Middle_Name+' '+Last_Name NAME

--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

,'Dealer'  USERTYPE

,'Dealer' ACCESS_TO

,User_ID ACCESS_CODE

,'' EMAIL

,User_ID USERNAME

,IP DEVICEID

,'Success' MESSAGE

,1 RESULT

,cITY BRANCH

fROM Mimansa.dbo.tbl_Emp_Master

where User_ID=@USERNAME

and (isSuspended =0 or isTerminated=0)







--AND (

--usertype='ADMIN' or

--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

--)

--)



END

ELSE

BEGIN

IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

BEGIN

SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

END

ELSE

BEGIN

IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)

BEGIN

IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)

BEGIN

SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT

END

END

ELSE

BEGIN

       SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT

END



--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

END



end



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_V1
-- --------------------------------------------------



--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'







--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_V1]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN



/*



		exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] 'CBHO001','@SkipPWD'





*/





DECLARE @ACCESS_CODE AS VARCHAR(50)=''

 DECLARE @BRANCH VARCHAR(50)=''



	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

	ON A.Emp_No=B.Emp_no

		where User_ID=@USERNAME

		and ((A.isSuspended	=1 or A.isTerminated=1)

		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

		

		)>0

			BEGIN 

			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

			Return

			END





IF (@PASSWORD='@SkipPWD')

BEGIN

 

		IF(SELECT COUNT(1) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME )>0

			BEGIN

	

 

				DECLARE @NOTID AS VARCHAR(MAX)=''



				SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A

				JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

				ON A.ID=B.MAXID 





				SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

				SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



			--addon on 30052018

				--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

				--UNION

				--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

			--END

		

				SELECT 2 AS ID,emp_name AS NAME,'QR' USERTYPE ,'Mobile' ACCESS_TO,sb_tag ACCESS_CODE,EMAIL,USER_id UserName,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS 'public int Result',@BRANCH AS BRANCH,password userpassword

				FROM Mimansa.dbo.tbl_Emp_Master WHERE USER_id =@USERNAME --and usertype<>'USER'





				--Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 





			END

			--ELSE 

			--BEGIN

			--		IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0

			--		BEGIN 

			--		SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			--		END

			--		ELSE 

			--		BEGIN

			--		SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			--		END



			--END



END

ELSE

begin

















if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME and  Password=@PASSWORD)>0

BEGIN



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

		,'Dealer'  USERTYPE	

		,'Dealer' ACCESS_TO	

		,User_ID ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME

		and (isSuspended	=0 or isTerminated=0)

		and Password=@PASSWORD







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			

					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0

					BEGIN

						IF NOT EXISTS(SELECT * FROM [INTRANET].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			

	end



end



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_V2
-- --------------------------------------------------




--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_V2]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN



/*



		exec [dbo].[Prc_AuthenticateLogin_Dealer_v2] 'CBHO001','@SkipPWD'





*/





DECLARE @ACCESS_CODE AS VARCHAR(50)=''

 DECLARE @BRANCH VARCHAR(50)=''



	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

	ON A.Emp_No=B.Emp_no

		where User_ID=@USERNAME

		and ((A.isSuspended	=1 or A.isTerminated=1)

		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

		

		)>0

			BEGIN 

			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

			Return

			END





IF (@PASSWORD='@SkipPWD')

BEGIN

 

		IF(SELECT COUNT(1) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME )>0

			BEGIN

	

 

				DECLARE @NOTID AS VARCHAR(MAX)=''



				SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A

				JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

				ON A.ID=B.MAXID 





				SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

				SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



			--addon on 30052018

				--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

				--UNION

				--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

			--END

		

				SELECT 2 AS ID,emp_name AS NAME,'QR' USERTYPE ,'Mobile' ACCESS_TO,@USERNAME ACCESS_CODE,EMAIL,USER_id UserName,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS 'public int Result',@BRANCH AS BRANCH,password userpassword

				FROM Mimansa.dbo.tbl_Emp_Master WHERE USER_id =@USERNAME --and usertype<>'USER'





				--Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 





			END

			--ELSE 

			--BEGIN

			--		IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0

			--		BEGIN 

			--		SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			--		END

			--		ELSE 

			--		BEGIN

			--		SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			--		END



			--END



END

ELSE

begin

















if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME and  Password=@PASSWORD)>0

BEGIN



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

		,'Dealer'  USERTYPE	

		,'Dealer' ACCESS_TO	

		,User_ID ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME

		and (isSuspended	=0 or isTerminated=0)

		and Password=@PASSWORD







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			

					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0

					BEGIN

						IF NOT EXISTS(SELECT * FROM [INTRANET].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			

	end



end



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_authenticatelogin_dealer_v3
-- --------------------------------------------------






CREATE PROCEDURE [dbo].[Prc_authenticatelogin_dealer_v3] (

	 @USERNAME  VARCHAR(50)

	,@PASSWORD VARCHAR(50))

AS

BEGIN

    /*

      

        exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] 'CBHO001','@SkipPWD'

      

      

    */

    DECLARE @ACCESS_CODE AS VARCHAR(50)=''

    DECLARE @BRANCH VARCHAR(50)=''



    IF( SELECT Count(*) FROM mimansa.dbo.tbl_emp_master A

						LEFT JOIN mimansa.dbo.tbl_emp_suspension_termination B

						ON A.emp_no = B.emp_no

						WHERE  user_id = @USERNAME

						AND ( ( A.issuspended = 1

                        OR A.isterminated = 1 )

						OR ( B.suspension_date < Getdate()

                        OR B.termination_date <= Getdate()))) > 0

    BEGIN

        SELECT @USERNAME + ' ' + 'Employee Terminated' AS MESSAGE ,0 AS RESULT 

        RETURN

    END

    IF ( @PASSWORD = '@SkipPWD' )

    BEGIN

	print '@SkipPWD'

    IF(SELECT Count(1) FROM   mimansa.dbo.tbl_emp_master WHERE  user_id = @USERNAME) > 0

    BEGIN

        DECLARE @NOTID AS VARCHAR(max)=''



        SELECT @NOTID = A.notificationid

        FROM   (SELECT * 

                FROM   [INTRANET].risk.dbo.tbl_mob_notification WITH(nolock)

                WHERE  userid = @USERNAME)A

                JOIN(SELECT Max(id) AS MAXID

                FROM [INTRANET].risk.dbo.tbl_mob_notification

                WHERE  userid = @USERNAME)B ON A.id = B.maxid



        SELECT @ACCESS_CODE = access_code

        FROM   rolemgm.dbo.user_login

        WHERE  username = @USERNAME



        SET @BRANCH=(SELECT TOP 1 branch_cd

						FROM   [CSOKYC-6].general.dbo.client_details WITH(nolock)

						WHERE  sub_broker = @ACCESS_CODE)



        --addon on 30052018

        --SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

        --UNION

        --SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

        --END

        SELECT 2 AS ID

                ,emp_name  AS NAME

                ,'Dealer'  USERTYPE

                ,'Dealer'  ACCESS_TO

                ,user_id   ACCESS_CODE

                ,email

                ,user_id   UserName

                ,@NOTID    AS DEVICEID

                ,'SUCCESS' AS MESSAGE

                ,1         RESULT

                ,city      BRANCH

                ,password  userpassword

				,'QR'      LOGINTYPE

                ,'Mobile'  LOGINFROM

        FROM   mimansa.dbo.tbl_emp_master

        WHERE  user_id = @USERNAME --and usertype<>'USER'

    --Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 

    END

    --ELSE 

    --BEGIN

    --    IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0

    --    BEGIN 

    --    SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

    --    END

    --    ELSE 

    --    BEGIN

    --    SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

    --    END

    --END

    END

    ELSE

    BEGIN

        IF (SELECT Count(1)

            FROM   [INTRANET].mimansa.dbo.tbl_emp_master

            WHERE  user_id = @USERNAME

                    AND password = @PASSWORD) > 0

            BEGIN

                SELECT 1          ID

                        --,First_Name +' '+ Middle_Name+' '+Last_Name NAME  

                        ,emp_name  NAME

                        --,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

                        ,'Dealer'  USERTYPE

                        ,'Dealer'  ACCESS_TO

                        ,user_id   ACCESS_CODE

                        ,''        EMAIL

                        ,user_id   USERNAME

                        ,ip        DEVICEID

                        ,'Success' MESSAGE

                        ,1         RESULT

                        ,city      BRANCH

                FROM   mimansa.dbo.tbl_emp_master

                WHERE  user_id = @USERNAME

                        AND ( issuspended = 0

                            OR isterminated = 0 )

                        AND password = @PASSWORD

            --AND (

            --usertype='ADMIN' or 

            --username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

            --,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

            --,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

            --)

            --)

            END

        ELSE

            BEGIN

                IF (SELECT Count(*)

                    FROM   mimansa.dbo.tbl_emp_master WITH(nolock)

                    WHERE  user_id = @USERNAME) > 0

                BEGIN

                    IF NOT EXISTS(SELECT *

                                    FROM

                            [INTRANET].mimansa.dbo.tbl_emp_master

                            WITH

                            (

                            nolock)

                                    WHERE  password = @PASSWORD)

                        BEGIN

                            SELECT 'Kindly enter valid password!' AS MESSAGE

                                    ,0                             AS RESULT

                        END

                END

                ELSE

                BEGIN

                    SELECT 'Kindly enter valid userid!' AS MESSAGE

                            ,0                           AS RESULT

                END

            --SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

            END

    END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Dealer_Valide_Mobile
-- --------------------------------------------------




--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'







--EXEC [Prc_AuthenticateLogin_Dealer_Valide_Mobile] 'CBHO001','CBHO0010'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Dealer_Valide_Mobile]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN



--DECLARE @ACCESS_CODE AS VARCHAR(50)=''

-- DECLARE @BRANCH VARCHAR(50)=''



	--IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

	--left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

	--ON A.Emp_No=B.Emp_no

	--	where User_ID=@USERNAME

	--	and ((A.isSuspended	=1 or A.isTerminated=1)

	--	or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

		

	--	)>0

	--		BEGIN 

	--		SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

	--		Return

	--		END







if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0

BEGIN



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

		,'Dealer'  USERTYPE	

		,'Dealer' ACCESS_TO	

		,User_ID ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME

		and (isSuspended	=0 or isTerminated=0)

		and Password=@PASSWORD







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)



END

			

	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso]

(

	@USERNAME VARCHAR(50),

	@PASSWORD VARCHAR(50)

)

AS

BEGIN



--return 0







/*



		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','@SkipPWD'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO001'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','@SkipPWD'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','nxt@123'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO0011'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'BVIDDPM','vihat711'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO','e6e263np'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'AJYC','rd64vvxe'

		exec [Prc_AuthenticateLogin_DealerAlso] 'BVIDDPM','vihat711'



		



*/







--IF @USERNAME='Excellent'

--BEGIN 

--		Set @USERNAME='HOET'

--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

--END



DECLARE @ACCESS_CODE AS VARCHAR(50)=''

 DECLARE @BRANCH VARCHAR(50)=''

 Declare @Mobno Varchar(100)--, @USERNAME Varchar(100)='CBHO'

Declare @email  Varchar(100)





 if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0

BEGIN

--Print 'A'

		exec [dbo].Prc_authenticatelogin_dealer_v3 @USERNAME,@PASSWORD

end

ELSE 

BEGIN











IF (@PASSWORD='@SkipPWD')

BEGIN

 

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0

	BEGIN

	

 

	    DECLARE @NOTID AS VARCHAR(MAX)=''



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 





		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



	--addon on 30052018

		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

	--END

		

		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'



	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END

ELSE

BEGIN



IF(SELECT COUNT(1) FROM USER_LOGIN UL

--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag

 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()

 

 )>0









	BEGIN

	



	    

--COLLATE SQL_Latin1_General_CP1_CS_AS 

		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		--ON A.ID=B.MAXID 





		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A





		 

	     DECLARE @CNT AS INT =0

	     --Added by Sandeep on 16 May 2018 to get the branch

	    

	     

	     

	     --Ended by Sandeep 



	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



	     SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE

	     

	    -- set @CNT=0

	     

		 -- Changes made on 27 july 2021 (Start)

	      select top 1 @Mobno=mobno  ,@email=emailid from [MIS].SB_Comp.dbo.sb_broker SB with (nolock) 

		inner join 

		[MIS].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='OFF'



		IF(ISNULL(@Mobno,'')='')

		BEGIN

		select top 1 @Mobno=mobno  ,@email=emailid from [MIS].SB_Comp.dbo.sb_broker SB with (nolock) 

		inner join 

		[MIS].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='RES'

	    END



		-- Changes made on 27 july 2021 (End)



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 



			



		

		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,

		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH ,@Mobno as mobno,@email email   

		FROM USER_LOGIN with(nolock) 

		WHERE USERNAME =@USERNAME 

		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))

		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END

		

		------AND (usertype='ADMIN' or username='EMT')

		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))

		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))

		or username in (select username from TempUserMaster  with(nolock))

		)

		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')

		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 

		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down

		and access_code not in (select sbtag from [10.253.78.155].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down

		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))

		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				

		union



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	

		--,'Dealer' USERTYPE	

		,'Dealer' ACCESS_TO	

		,sb_tAG ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		,''

		,''

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)

					BEGIN

						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME and USERPASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END





end





END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_1
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ALWARAJYC','abl12345'  



Create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_1]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'



*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_AuthenticateLogin_Dealer_19March21_Changes @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,ACCESS_CODE USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_11
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso_11] CBHO001,'@SkipPWD'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_11]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
Print 'AAA'
		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
--ELSE 
--BEGIN

ELSe IF (@PASSWORD='@SkipPWD')
BEGIN

Print 'AA'
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_11July2019
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ET002','YR26ECQ7'  

Create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_11July2019]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)
        and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])
						
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_19March21_Changes
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ALWARAJYC','abl12345'  



Create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_19March21_Changes]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		--exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
		exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] @USERNAME,@PASSWORD 
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_22
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ALWARAJYC','abl12345'  



/*
EXEC [Prc_AuthenticateLogin_DealerAlso_22] 'CBHO001','@SkipPWD'  
EXEC [Prc_AuthenticateLogin_DealerAlso_22] 'ALWARAJYC','abl12345'  
EXEC [Prc_AuthenticateLogin_DealerAlso_22] 'ALWARAJYC','abl12345'  



*/


CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_22]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
Print 'A'

IF (@PASSWORD='@SkipPWD')
BEGIN

Print 'BB' 
			IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
				BEGIN
	
 
					DECLARE @NOTID AS VARCHAR(MAX)=''

					SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
					JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
					ON A.ID=B.MAXID 


					SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
					SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

				--addon on 30052018
					--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
					--UNION
					--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
				--END
		
					SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

				END
				ELSE 
				BEGIN
						IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
						BEGIN 
						SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
						END
						ELSE 
						BEGIN
						SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
						END

				END

END
ELSE 
Begin
		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
END

ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp03July2019
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ET002','YR26ECQ7'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp03July2019]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		------AND (usertype='ADMIN' or username='EMT')
		and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)
				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp15July2021
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ALWARAJYC','abl12345'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp15July2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'



*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_AuthenticateLogin_Dealer_19March21_Changes @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp20Mar2021
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ALWARAJYC','abl12345'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp20Mar2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp21Sept2019
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ET002','YR26ECQ7'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp21Sept2019]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)
        and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])
						
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp22Feb2021
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso] 'HOET','hdfc1234'  

Create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp22Feb2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
        and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])
		and access_code not in (select * from dbo.OFRA_Sub_broker)				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp22July2021
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp22July2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'



*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_AuthenticateLogin_Dealer_19March21_Changes @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp22July2021_Before_Live
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp22July2021_Before_Live]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'



*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_AuthenticateLogin_Dealer_19March21_Changes @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp24Nov2021
-- --------------------------------------------------
Create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp24Nov2021]
(
	@USERNAME VARCHAR(50),
	@PASSWORD VARCHAR(50)
)
AS
BEGIN

--return 0



/*

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','nxt@123'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'BVIDDPM','vihat711'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO','e6e263np'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'AJYC','rd64vvxe'
		exec [Prc_AuthenticateLogin_DealerAlso] 'BVIDDPM','vihat711'

		

*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
 Declare @Mobno Varchar(100)--, @USERNAME Varchar(100)='CBHO'
Declare @email  Varchar(100)


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_authenticatelogin_dealer_v3 @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
		 -- Changes made on 27 july 2021 (Start)
	      select top 1 @Mobno=mobno  ,@email=emailid from [196.1.115.167].SB_Comp.dbo.sb_broker SB with (nolock) 
		inner join 
		[196.1.115.167].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='OFF'

		IF(ISNULL(@Mobno,'')='')
		BEGIN
		select top 1 @Mobno=mobno  ,@email=emailid from [196.1.115.167].SB_Comp.dbo.sb_broker SB with (nolock) 
		inner join 
		[196.1.115.167].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='RES'
	    END

		-- Changes made on 27 july 2021 (End)

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 

			

		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH ,@Mobno as mobno,@email email   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		,''
		,''
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Bkp25Feb2021
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_Bkp22Feb2021] 'HOET','hdfc1234'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Bkp25Feb2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
        and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])
		and access_code not in (select * from dbo.OFRA_Sub_broker)				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_FromBackup
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_FromBackup]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap]
(
	@USERNAME VARCHAR(50),
	@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','nxt@123'


		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'DDPM','vihat999'



*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
 Declare @Mobno Varchar(100)--, @USERNAME Varchar(100)='CBHO'
Declare @email  Varchar(100)


 if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_authenticatelogin_dealer_v3 @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 

		select top 1  @Mobno=mobno  ,@email=emailid from [MIS].SB_Comp.dbo.sb_broker SB with (nolock) 
		inner join 
		[MIS].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag=@ACCESS_CODE

		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH ,@Mobno as mobno,@email email   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [MIS].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [MIS].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [10.253.78.155].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		,''
		,''
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Mobile_2
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ALWARAJYC','abl12345'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Mobile_2]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'



*/



DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


DECLARE @NOTID AS VARCHAR(MAX)=''


IF(SELECT COUNT(1) FROM USER_LOGIN UL
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0

	BEGIN
		 
	     DECLARE @CNT AS INT =0
	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    		
		SELECT 1 AS ID, PERSON_NAME AS NAME,[USERTYPE] as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = 'SB' or ACCESS_TO = 'SBMAST'  )
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


--end

--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Mobile_2_Bkp23June2021
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'YYSB003','XRM3TSF6123'  

--EXEC [Prc_AuthenticateLogin_DealerAlso_new333] 'ALWARAJYC','abl12345'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'ALWARAJYC','abl12345'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Mobile_2_Bkp23June2021]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'



*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


-- if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
--BEGIN
----Print 'A'
--		exec [dbo].Prc_AuthenticateLogin_Dealer_19March21_Changes @USERNAME,@PASSWORD
--end
--ELSE 
--BEGIN

DECLARE @NOTID AS VARCHAR(MAX)=''




--IF (@PASSWORD='@SkipPWD')
--BEGIN
 
--IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
--	BEGIN
	
 
--	    DECLARE @NOTID AS VARCHAR(MAX)=''

--		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
--		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
--		ON A.ID=B.MAXID 


--		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

--	--addon on 30052018
--		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
--		--UNION
--		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
--	--END
		
--		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

--	END
--	ELSE 
--	BEGIN
--			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
--			BEGIN 
--			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
--			END
--			ELSE 
--			BEGIN
--			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
--			END

--	END

--END
--ELSE
--BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


--end

--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_New1111
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso] 'HOET','hdfc1234'  

Create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_New1111]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    --SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL
		,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,
		@BRANCH AS BRANCH,userpassword 
		FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     --SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)
	     --SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,
		--CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as 
		USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		--AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
        and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])
		and access_code not in (select * from dbo.OFRA_Sub_broker)				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_new333
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_Bkp22Feb2021] 'HOET','hdfc1234'  

create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_new333]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])
		and access_code not in (select * from dbo.OFRA_Sub_broker)				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_tempremove_182
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_New1111] 'HOET','hdfc1234'  
--EXEC [Prc_AuthenticateLogin_DealerAlso] 'HOET','hdfc1234'  

create PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_tempremove_182]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN


--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    --SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL
		,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,
		@BRANCH AS BRANCH,userpassword 
		FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     --SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)
	     --SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,
		--CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as 
		USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		--AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
        and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])
		and access_code not in (select * from dbo.OFRA_Sub_broker)				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_Test
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC [Prc_AuthenticateLogin_DealerAlso_Test] 'SIT','y7uh8jb9'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_Test]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN

		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		Case when ACCESS_TO='SBMAST' THEN 'SB' ELSE ACCESS_TO END ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN (@CNT=0 or ACCESS_TO='SBMAST')  THEN 'SB' ELSE 'BRANCH' END
		------AND (usertype='ADMIN' or username='EMT')
		and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [MIS].sb_comp.dbo.VW_ONLY_MF_TAG)
		Or username in ('SIT')
		
							
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_V1
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_V1]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN







/*

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_V1] 'CBHO001','@SkipPWD'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_V1] 'CBHO001','cbho001'



		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_V1] 'HOCBHO','nxt@123'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_V1] 'BVIDDPM','vihat711'



		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_V1] 'CBHO','e6e263np'

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'







*/





--Declare @access_code Varchar(100),

 Declare @Mobno Varchar(100)--, @USERNAME Varchar(100)='CBHO'

Declare @email  Varchar(100)



--Select @Mobno





--IF @USERNAME='Excellent'

--BEGIN 

--		Set @USERNAME='HOET'

--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

--END



DECLARE @ACCESS_CODE AS VARCHAR(50)=''

 DECLARE @BRANCH VARCHAR(50)=''





 if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0

BEGIN

Print 'A'

		exec [dbo].[Prc_AuthenticateLogin_Dealer_15July2021] @USERNAME,@PASSWORD

end

ELSE 

BEGIN











IF (@PASSWORD='@SkipPWD')

BEGIN

 Print 'SkipPWD'

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0

	BEGIN

	

 

	    DECLARE @NOTID AS VARCHAR(MAX)=''



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 





		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



	--addon on 30052018

		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

	--END

		

		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 

		'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword 

		FROM USER_LOGIN 

		WHERE USERNAME =@USERNAME 

		--and usertype<>'USER'



	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END

ELSE

BEGIN



IF(SELECT COUNT(1) FROM USER_LOGIN UL

--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag

 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()

 

 )>0









	BEGIN

	



	    

--COLLATE SQL_Latin1_General_CP1_CS_AS 

		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		--ON A.ID=B.MAXID 





		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A





		 

	     DECLARE @CNT AS INT =0

	     --Added by Sandeep on 16 May 2018 to get the branch

	  

	     

	     

	     --Ended by Sandeep 



	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



	     SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE

	     

	    -- set @CNT=0

		-- Changes made on 27 july 2021 (Start)

		select top 1 @Mobno=mobno  ,@email=emailid from [MIS].SB_Comp.dbo.sb_broker SB with (nolock) 

		inner join 

		[MIS].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='OFF'



		IF(ISNULL(@Mobno,'')='')

		BEGIN

		select top 1 @Mobno=mobno  ,@email=emailid from [MIS].SB_Comp.dbo.sb_broker SB with (nolock) 

		inner join 

		[MIS].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='RES'

	    END

	     -- Changes made on 27 july 2021 (End)



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 





		

		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,

		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   ,@Mobno as mobno,@email email 

		FROM USER_LOGIN with(nolock) 

		WHERE USERNAME =@USERNAME 

		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))

		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END

		

		------AND (usertype='ADMIN' or username='EMT')

		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))

		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))

		or username in (select username from TempUserMaster  with(nolock))

		)

		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')

		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 

		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down

		and access_code not in (select sbtag from [10.253.78.155].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down

		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))

		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				

		union



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	

		--,'Dealer' USERTYPE	

		,'Dealer' ACCESS_TO	

		,sb_tAG ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		,''

		,''

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)

					BEGIN

						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END





end



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_V2
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_V2]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN



/*
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso] 'DDPM','vihat999'



*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_AuthenticateLogin_Dealer_V2 @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_DealerAlso_V3
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_DealerAlso_V3]
(
	@USERNAME VARCHAR(50),
	@PASSWORD VARCHAR(50)
)
AS
BEGIN

--return 0



/*

		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO001'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','@SkipPWD'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'HOCBHO','nxt@123'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO001','CBHO0011'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'BVIDDPM','vihat711'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'CBHO','e6e263np'
		exec [dbo].[Prc_AuthenticateLogin_DealerAlso_LiveForCleverTap] 'AJYC','rd64vvxe'
		exec [Prc_AuthenticateLogin_DealerAlso] 'BVIDDPM','vihat711'

		

*/



--IF @USERNAME='Excellent'
--BEGIN 
--		Set @USERNAME='HOET'
--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
--END

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
 Declare @Mobno Varchar(100)--, @USERNAME Varchar(100)='CBHO'
Declare @email  Varchar(100)


 if  (select COUNT(1) from [196.1.115.132].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0
BEGIN
--Print 'A'
		exec [dbo].Prc_authenticatelogin_dealer_v3 @USERNAME,@PASSWORD
end
ELSE 
BEGIN





IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN UL
--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag
 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()
 
 )>0




	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
		 -- Changes made on 27 july 2021 (Start)
	      select top 1 @Mobno=mobno  ,@email=emailid from [196.1.115.167].SB_Comp.dbo.sb_broker SB with (nolock) 
		inner join 
		[196.1.115.167].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='OFF'

		IF(ISNULL(@Mobno,'')='')
		BEGIN
		select top 1 @Mobno=mobno  ,@email=emailid from [196.1.115.167].SB_Comp.dbo.sb_broker SB with (nolock) 
		inner join 
		[196.1.115.167].SB_Comp.dbo.sb_contact SC on SB.refno=SC.refno where sbtag= @ACCESS_CODE AND SC.Addtype='RES'
	    END

		-- Changes made on 27 july 2021 (End)

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 

			

		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,
		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH ,@Mobno as mobno,@email email   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME 
		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))
		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		
		------AND (usertype='ADMIN' or username='EMT')
		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		--and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down
		and access_code not in (select sbtag from [172.31.16.95].NXT.dbo.VW_ONLY_MF_TAG with (nolock))   --Commented for 167 down
		and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG] with (nolock))
		and access_code not in (select * from dbo.OFRA_Sub_broker with (nolock))				
		union

		SELECT 
		1 ID	
		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	
		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	
		--,'Dealer' USERTYPE	
		,'Dealer' ACCESS_TO	
		,sb_tAG ACCESS_CODE	
		,'' EMAIL	
		,User_ID USERNAME	
		,IP DEVICEID	
		,'Success' MESSAGE	
		,1 RESULT	
		,cITY BRANCH
		,''
		,''
		fROM Mimansa.dbo.tbl_Emp_Master
		where User_ID=@USERNAME



		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME and USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END


end


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_NeedtoRelease20Feb2019
-- --------------------------------------------------

--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'



--EXEC Prc_AuthenticateLogin 'N00061','om12345678'  

CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_NeedtoRelease20Feb2019]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	--addon on 30052018
		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A
	--END
		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	

	    
--COLLATE SQL_Latin1_General_CP1_CS_AS 
		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE
	     
	    -- set @CNT=0
	     
	      

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   
		FROM USER_LOGIN with(nolock) 
		WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		------AND (usertype='ADMIN' or username='EMT')
		and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))
		or username in (select username from TempUserMaster  with(nolock))
		)
		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')
		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 
		and access_code not in (select sbtag from [196.1.115.167].sb_comp.dbo.VW_ONLY_MF_TAG)
		
		--AND (
		--usertype='ADMIN' or 
		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'
		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'
		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'
		--)
		--)
		
	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)
					BEGIN
						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)
						BEGIN
							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	
						END	
					END
					ELSE
					BEGIN
					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	
					END
					
					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_Surrogate
-- --------------------------------------------------


--EXEC PRC_AUTHENTICATELOGIN 'HOET','@SkipPWD'



--EXEC Prc_AuthenticateLogin_Surrogate 'E15305','ang15305','PjMA'  



CREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_Surrogate]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50),

@SurrogateID varchar(50)

)

AS

BEGIN



DECLARE @ACCESS_CODE AS VARCHAR(50)='',@ACCESS_TO AS VARCHAR(50)='',@SUR_ACCESS_CODE AS VARCHAR(50)='',@SUR_ACCESS_TO AS VARCHAR(50)=''

DECLARE @BRANCH VARCHAR(50)=''

DECLARE @NOTID AS VARCHAR(MAX)=''







IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0

	BEGIN

	



			    



		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		--ON A.ID=B.MAXID 





		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

		

		DECLARE @CNT AS INT =0

		SELECT @ACCESS_CODE=ACCESS_CODE,@ACCESS_TO=ACCESS_TO FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD

		PRINT @ACCESS_CODE

		PRINT @ACCESS_TO

		IF(ISNULL(@SurrogateID,'')<>'')

			BEGIN

			

					IF(@ACCESS_TO='BROKER')

					BEGIN

							

							SELECT @SUR_ACCESS_CODE=ACCESS_CODE,@SUR_ACCESS_TO=ACCESS_TO FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@SurrogateID

							SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@SUR_ACCESS_CODE)



							SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@SUR_ACCESS_CODE

						     

							

							

							SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@SurrogateID)A

							JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@SurrogateID)B

							ON A.ID=B.MAXID 





							

							SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   FROM USER_LOGIN with(nolock) WHERE
 ACCESS_CODE =@SurrogateID AND ACCESS_TO =@SUR_ACCESS_TO

							--AND (usertype='ADMIN' or username='EMT')

							AND (usertype='ADMIN' or username in ('EMT','ET','ETPF','GDS'))	AND login_inactive_date>GETDATE()

					END	

					ELSE IF (@ACCESS_TO='REGION')

					BEGIN

							PRINT 'REGION'

					END	

					ELSE IF (@ACCESS_TO='BRANCH')

					BEGIN

							PRINT 'hi'

							

							SELECT @SUR_ACCESS_CODE=ACCESS_CODE,@SUR_ACCESS_TO=ACCESS_TO FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE access_code=@SurrogateID

							print @ACCESS_CODE

							print @ACCESS_TO

							SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@SUR_ACCESS_CODE)



							SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@SUR_ACCESS_CODE

						     

							

							

							SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@SurrogateID)A

							JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@SurrogateID)B

							ON A.ID=B.MAXID 





							

							SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   FROM 

							USER_LOGIN with(nolock) WHERE ACCESS_CODE =@SurrogateID AND ACCESS_TO =@SUR_ACCESS_TO

							--AND (usertype='ADMIN' or username='EMT')

							AND (usertype='ADMIN' or username in ('EMT','ET','ETPF','GDS')) AND ACCESS_CODE IN (SELECT DISTINCT SUB_BROKER FROM RISK.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE BRANCH_CD=@ACCESS_CODE) 	AND login_inactive_date>GETDATE()

					

					END	

					

			END

			ELSE

			BEGIN

				

				 --Added by Sandeep on 16 May 2018 to get the branch

			    

			     

			     

				 --Ended by Sandeep 



				PRINT @ACCESS_TO



				 SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

				 SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



				 SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE

			     

				-- set @CNT=0

			     

			      



				SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

				JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

				ON A.ID=B.MAXID 





				

				SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   FROM USER_LOGIN with(nolock) WHERE USERNAME =@USERNAME AND ACCESS_TO =@ACCESS_TO

				--AND (usertype='ADMIN' or username='EMT')

				AND (usertype='ADMIN' or username in ('EMT','ET','ETPF','GDS'))	

			END

		 

				 





	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)

					BEGIN

						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_AuthenticateLogin_tEST
-- --------------------------------------------------
--EXEC PRC_AUTHENTICATELOGIN 'HOET','@SkipPWD'

cREATE PROCEDURE [dbo].[Prc_AuthenticateLogin_tEST]
(
@USERNAME VARCHAR(50),
@PASSWORD VARCHAR(50)
)
AS
BEGIN

DECLARE @ACCESS_CODE AS VARCHAR(50)=''
 DECLARE @BRANCH VARCHAR(50)=''
IF (@PASSWORD='@SkipPWD')
BEGIN
 
IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	
 
	    DECLARE @NOTID AS VARCHAR(MAX)=''

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

		
		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'

	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END
ELSE
BEGIN

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0
	BEGIN
	

	    

		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		--ON A.ID=B.MAXID 


		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME
		--UNION
		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A


		 
	     DECLARE @CNT AS INT =0
	     --Added by Sandeep on 16 May 2018 to get the branch
	    
	     
	     
	     --Ended by Sandeep 

	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME
	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [196.1.115.182].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)

	     SELECT @CNT=COUNT(1) FROM [196.1.115.182].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE

		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A
		JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B
		ON A.ID=B.MAXID 


		
		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   FROM USER_LOGIN with(nolock) WHERE USERNAME =@USERNAME AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END
		--AND (usertype='ADMIN' or username='EMT')
		AND (usertype='ADMIN' or username in ('EMT','ET','ETPF'))


	END
	ELSE 
	BEGIN
			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0
			BEGIN 
			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT
			END
			ELSE 
			BEGIN
			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT
			END

	END

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_ChangePwd
-- --------------------------------------------------
Create Procedure Prc_ChangePwd
(
@UserID varchar(50),
@Password varchar(50),
@Access_To varchar(50)
)
AS
Begin
	if(@Access_To='Broker')
	Begin
	update user_login set userpassword = @Password ,login_inactive_date=getdate()+50 where username=@UserID
	End
	else if(@Access_To='BRMAST')
	Begin
	update user_login set userpassword = @Password ,login_inactive_date=getdate()+35 where username=@UserID
	End
	else if(@Access_To='REGION')
	Begin
	update user_login set userpassword = @Password ,login_inactive_date=getdate()+40 where username=@UserID
	End
	else if(@Access_To='BRANCH')
	Begin
	update user_login set userpassword = @Password ,login_inactive_date=getdate()+30 where username=@UserID
	End 	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_ChangePwd_Ipartner
-- --------------------------------------------------
CREATE Procedure [dbo].[Prc_ChangePwd_Ipartner]  
(  
@UserID varchar(50),  
@OldPass varchar(50),
@Password varchar(50),  
@Access_To varchar(50)  
)  
AS  
Begin  

if(@OldPass<>'')
Begin
		if exists(select * from user_login with(nolock) where username=@UserID and userpassword=@OldPass)
		begin
				if(@Access_To='Broker')  
					 Begin  		
						update user_login set userpassword = @Password ,login_inactive_date=getdate()+50 where username=@UserID  
					 End  
					 else if(@Access_To='BRMAST')  
					 Begin  
					 update user_login set userpassword = @Password ,login_inactive_date=getdate()+35 where username=@UserID  
					 End  
					 else if(@Access_To='REGION')  
					 Begin  
					 update user_login set userpassword = @Password ,login_inactive_date=getdate()+40 where username=@UserID  
					 End  
					 else if(@Access_To='BRANCH')  
					 Begin  
					 update user_login set userpassword = @Password ,login_inactive_date=getdate()+30 where username=@UserID  
					 End    
					  else if(@Access_To='SB')  
					 Begin  
					 update user_login set userpassword = @Password ,login_inactive_date=getdate()+50 where username=@UserID  
					 End   		
		end
		else
		begin
		select 'Invalid Username/Password'
		end
		
End


 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PRC_GETCLIENT_DETAILS
-- --------------------------------------------------


CREATE PROC PRC_GETCLIENT_DETAILS

@CLIENTCODE AS VARCHAR(50)='',

@ACCESS_CODE AS VARCHAR(50)=''



AS BEGIN



SELECT LONG_NAME AS 'NAME',MOBILE_PAGER AS MOB,EMAIL AS EAMIL,L_CITY AS CITY FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WHERE CL_CODE =@CLIENTCODE

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PWC_CheckCatChng
-- --------------------------------------------------


CREATE procedure PWC_CheckCatChng(@user as varchar(10)) 
as

set nocount on

CREATE table #userCatChange
(
username varchar(10),
PrevCat varchar(10),
ChangedCat Varchar(10),
Changedon datetime
)

select ROW_NUMBER() OVER ( ORDER BY history_Date ) AS [SrNo],* into #temp1 from user_login_log where username=@user order by history_Date

declare @totctr as int = 0,@ctr as int = 1,@Catcode as varchar(10)='',@Pcatcode as varchar(10) ='',@histdate as datetime
select @totctr=COUNT(1) from #temp1 

While @ctr <= @totctr
Begin
	if (Select COUNT(1) from #temp1 where srno=@ctr and username=@user and cat_code=@Pcatcode)=0
	begin
		select @user=username,@catcode=Cat_code,@histdate=history_Date from #temp1 where srno=@ctr
		if @Pcatcode<>@catcode
		begin
			insert into #userCatChange select @user,@Pcatcode,@Catcode,@histdate
			set @Pcatcode=@Catcode
		end
	end
	set @ctr=@ctr+1
End

delete from PWC_userCatChange where username=@user
insert into PWC_userCatChange select * from #userCatChange

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PWC_RightsCompare
-- --------------------------------------------------

CREATE procedure PWC_RightsCompare(@ExistCode as varchar(10),@NewCode as varchar(10),@Cdate as varchar(11))
as

set nocount on

declare @cnt as int =0,@mdate as datetime,@catcode as varchar(10)

select @cnt=COUNT(1),@mdate=MAX(history_date) from user_login_log where username=@ExistCode and history_date<=@Cdate+' 23:59:59'
if @cnt > 0 
Begin
	select @CatCode=Cat_code from user_login_log where username=@ExistCode and history_date=@mdate
end
else
begin
	select @CatCode=Cat_code from user_login where username=@ExistCode 
end

select username=@ExistCode,a.menu_code,MIN(flag) as flag into #existing from
(
select menu_code,@CatCode as flag from cat_mapping where cat_code=@CatCode
union
select menu_code,'Extra' as flag from EXTRA_CAT_MAPPING where EMP_NO=@ExistCode and MAPPED_ON <=@Cdate+' 23:59:59'
) a left outer join 
(select menu_code from Exclude_CAT_MAPPING where EMP_NO=@ExistCode and MAPPED_ON <=@Cdate+' 23:59:59')
b on a.menu_Code=b.menu_code
where b.MENU_CODE is null
group by a.menu_code


------------------------- New Code

set @cnt=0
set @CatCode=''

select @cnt=COUNT(1),@mdate=MAX(history_date) from user_login_log where username=@NewCode and history_date<=@Cdate+' 23:59:59'
if @cnt > 0 
Begin
	select @CatCode=Cat_code from user_login_log where username=@NewCode and history_date=@mdate
end
else
begin
	select @CatCode=Cat_code from user_login where username=@NewCode 
end

--select username=@NewCode,a.menu_code,MIN(flag) as flag into #new from
select username=@NewCode,a.menu_code,flag into #new from
(
select menu_code,@CatCode as flag from cat_mapping where cat_code=@CatCode
union
select menu_code,'Extra' as flag from EXTRA_CAT_MAPPING where EMP_NO=@NewCode and MAPPED_ON <=@Cdate+' 23:59:59'
) a left outer join 
(select menu_code from Exclude_CAT_MAPPING where EMP_NO=@NewCode and MAPPED_ON <=@Cdate+' 23:59:59')
b on a.menu_Code=b.menu_code
where b.MENU_CODE is null
--group by a.menu_code

insert into PWC_RightsCompareTbl
select *,@cdate from #existing a full outer join #new b on a.menu_Code=b.menu_Code

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]    
@database varchar(100)    
as    
begin    
    
declare @db_id int    
Select @db_id = db_id(@database)    
    
if @db_id is Null    
return    
    
SET NOCOUNT ON;    
DECLARE @objectid int;    
DECLARE @indexid int;    
DECLARE @partitioncount bigint;    
DECLARE @schemaname nvarchar(130);    
DECLARE @objectname nvarchar(130);    
DECLARE @indexname nvarchar(130);    
DECLARE @partitionnum bigint;    
DECLARE @partitions bigint;    
DECLARE @frag float;    
DECLARE @command nvarchar(4000);    
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function    
-- and convert object and index IDs to names.    
    
SELECT    
object_id AS objectid,    
index_id AS indexid,    
partition_number AS partitionnum,    
avg_fragmentation_in_percent AS frag    
INTO #work_to_do    
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')    
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;    
    
-- Declare the cursor for the list of partitions to be processed.    
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;    
    
-- Open the cursor.    
OPEN partitions;    
    
-- Loop through the partitions.    
WHILE (1=1)    
BEGIN;    
FETCH NEXT    
FROM partitions    
INTO @objectid, @indexid, @partitionnum, @frag;    
IF @@FETCH_STATUS < 0 BREAK;    
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)    
FROM sys.objects AS o    
JOIN sys.schemas as s ON s.schema_id = o.schema_id    
WHERE o.object_id = @objectid;    
SELECT @indexname = QUOTENAME(name)    
FROM sys.indexes    
WHERE object_id = @objectid AND index_id = @indexid;    
SELECT @partitioncount = count (*)    
FROM sys.partitions    
WHERE object_id = @objectid AND index_id = @indexid;    
    
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.    
IF @frag < 30.0    
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';    
IF @frag >= 30.0    
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';    
IF @partitioncount > 1    
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));    
IF @frag >= 30.0    
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)'   
   
EXEC (@command);    
PRINT N'Executed: ' + @command;    
END;    
    
-- Close and deallocate the cursor.    
CLOSE partitions;    
DEALLOCATE partitions;    
    
-- Drop the temporary table.    
DROP TABLE #work_to_do;    
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rmnew_ncollection1
-- --------------------------------------------------
CREATE procedure rmnew_ncollection1 
(
	@user as varchar(25),
	@type as varchar(25)
)
                 
as                    
                
set transaction isolation level read uncommitted                    
                    
set nocount on                    
                    
--declare @brcode as varchar(11)                    
--set @brcode = 'HO'                    
                  
if @type='SB'        
BEGIN                  
      
 select a.*,tradername=sbname into #rep2a                   
 from                  
(      
 select sbtag,sub_broker,abl,acdl,cash_deposit,holding,appr,nonappr,nbfc,nbfc_hold,nbfc_hdfc,fo,sb_ledger,remisior,debit,mcdx,ncdx,mcd,nsx                  
 from INTRANET.RISK.DBO.rm_collection
 where sub_Broker like @user        
 ) a left outer join INTRANET.RISK.DBO.subgroup b on a.sub_broker=b.sub_broker                  
                   
 select a.*,collected=isnull(collected,0),squared_up=isnull(squared_up,0)                    
 into #rep2b                  
 from #rep2a a left outer join                     
 (      
	 select subgroup,collected=sum(isnull(collected,0)),squared_up=sum(isnull(squared_up,0))                     
	 from INTRANET.RISK.DBO.composite_collection a , INTRANET.RISK.DBO.finmast b 
	 where a.party_code=b.party_Code                    
	 group by subgroup                  
 ) b on a.sub_broker=b.subgroup                  
                  
              
 select a.*,limit=isnull(b.limit,0),net_def=debit-isnull(b.limit,0),sb_deposit=isnull(sb_deposit,0) 
 from #rep2b a left outer join INTRANET.RISK.DBO.Vw_sb_limit_deposit b on a.sub_broker=b.sub_broker                    
 where ABL+ACDL+nbfc+fo +mcdx+ncdx+mcd+nsx<> 0                    
 order by debit-isnull(b.limit,0) desc                    
        
END        
        
if @type='SBMAST'        
BEGIN                  
 select a.*,tradername=sbname into #arep2a                   
 from                  
 (select sbtag,sub_broker,abl,acdl,cash_deposit,holding,appr,nonappr,nbfc,nbfc_hold,nbfc_hdfc,fo,sb_ledger,remisior,debit,mcdx,ncdx,mcd,nsx                  
 from INTRANET.RISK.DBO.rm_collection 
 where sub_Broker in (Select sub_BRoker from INTRANET.RISK.DBO.sb_master where sbMast_cd =@user)        
 ) a left outer join INTRANET.RISK.DBO.subgroup b on a.sub_broker=b.sub_broker                  
                   
 select a.*,collected=isnull(collected,0),squared_up=isnull(squared_up,0)                    
 into #arep2b                  
 from #arep2a a left outer join                     
 (select subgroup,collected=sum(collected),squared_up=sum(squared_up)                     
 from INTRANET.RISK.DBO.composite_collection a, INTRANET.RISK.DBO.finmast b 
 where a.party_code=b.party_Code                    
 group by subgroup                  
 ) b on a.sub_broker=b.subgroup                  
                  
              
 select a.*,limit=isnull(b.limit,0),net_def=debit-isnull(b.limit,0),sb_deposit=isnull(sb_deposit,0) 
 from #arep2b a left outer join INTRANET.RISK.DBO.Vw_sb_limit_deposit b on a.sub_broker=b.sub_broker                    
 where ABL+ACDL+nbfc+fo +mcdx+ncdx+mcd+nsx<> 0                    
 order by debit-isnull(b.limit,0) desc                    
        
END        
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rmnew_ncollection1_DISP
-- --------------------------------------------------
CREATE procedure [dbo].[rmnew_ncollection1_DISP] (@user as varchar(25),@type as varchar(25))                 
AS
SET NOCOUNT ON
	IF (select NOR=COUNT(1) from user_login where ACCESS_tO ='sb' AND ACCESS_cODE IN ('SAN','ET','SHRE','TP','AKJ','MDHD') AND ACCESS_CODE=@USER) > 1
	BEGIN
		EXEC rmnew_ncollection1_EX @USER,@TYPE
	END
	ELSE
	BEGIN
		EXEC rmnew_ncollection1 @USER,@TYPE
	END
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rmnew_ncollection1_ex
-- --------------------------------------------------
  
CREATE procedure rmnew_ncollection1_ex (@user as varchar(25),@type as varchar(25))                   
as                      
                  
set transaction isolation level read uncommitted                      
                      
set nocount on                      
                      
--declare @brcode as varchar(11)                      
--set @brcode = 'HO'                      
                    
if @type='SB'          
BEGIN                    
        
 select a.*,tradername=sbname into #rep2a                     
 from                    
(        
 select sbtag,sub_broker,abl,acdl,cash_deposit,holding,appr,nonappr,nbfc,nbfc_hold,nbfc_hdfc,fo,sb_ledger,remisior,debit,mcdx,ncdx,mcd,nsx                    
 from intranet.risk.dbo.rm_collection where sub_Broker like @user          
 ) a left outer join intranet.risk.dbo.subgroup b on a.sub_broker=b.sub_broker                    
                     
 select a.*,collected=isnull(collected,0),squared_up=isnull(squared_up,0)                      
 into #rep2b                    
 from #rep2a a left outer join                       
 (        
 select subgroup,collected=sum(isnull(collected,0)),squared_up=sum(isnull(squared_up,0))                       
 from intranet.risk.dbo.composite_collection a, intranet.risk.dbo.finmast b where a.party_code=b.party_Code                      
 group by subgroup                    
 ) b on a.sub_broker=b.subgroup                    
                    
                
 select a.*,limit=isnull(b.limit,0),net_def=debit-isnull(b.limit,0),sb_deposit=isnull(sb_deposit,0) 
 from #rep2b a   
	left outer join intranet.risk.dbo.Vw_sb_limit_deposit_ex b on a.sub_broker=b.sub_broker                      
 where ABL+ACDL+nbfc+fo +mcdx+ncdx+mcd+nsx<> 0                      
 order by debit-isnull(b.limit,0) desc                      
          
END          
          
if @type='SBMAST'          
BEGIN                    
 select a.*,tradername=sbname into #arep2a                     
 from                    
 (select sbtag,sub_broker,abl,acdl,cash_deposit,holding,appr,nonappr,nbfc,nbfc_hold,nbfc_hdfc,fo,sb_ledger,remisior,debit,mcdx,ncdx,mcd,nsx                    
 from intranet.risk.dbo.rm_collection where sub_Broker in (Select sub_BRoker from intranet.risk.dbo.sb_master where sbMast_cd =@user)          
 ) a left outer join intranet.risk.dbo.subgroup b on a.sub_broker=b.sub_broker                    
                     
 select a.*,collected=isnull(collected,0),squared_up=isnull(squared_up,0)                      
 into #arep2b                    
 from #arep2a a left outer join                       
 (select subgroup,collected=sum(collected),squared_up=sum(squared_up)                       
 from intranet.risk.dbo.composite_collection a, intranet.risk.dbo.finmast b 
 where a.party_code=b.party_Code                      
 group by subgroup                    
 ) b on a.sub_broker=b.subgroup                    
                    
                
 select a.*,limit=isnull(b.limit,0),net_def=debit-isnull(b.limit,0),sb_deposit=isnull(sb_deposit,0) 
 from #arep2b a left outer join intranet.risk.dbo.Vw_sb_limit_deposit_ex b on a.sub_broker=b.sub_broker                      
 where ABL+ACDL+nbfc+fo +mcdx+ncdx+mcd+nsx<> 0                      
 order by debit-isnull(b.limit,0) desc                      
          
END          
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rmnew_SBDEPOSIT_DISP
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RMNEW_SBDEPOSIT_DISP] 
(
	@USER AS VARCHAR(25),
	@TYPE AS VARCHAR(25)
)
                   
AS  
SET NOCOUNT ON  
 IF (SELECT NOR=COUNT(1) FROM USER_LOGIN WHERE ACCESS_TO ='SB' AND ACCESS_CODE IN ('SAN','ET','SHRE','TP','AKJ','MDHD') AND ACCESS_CODE=@USER) > 1  
 BEGIN  
   SELECT A.*,SBNAME FROM   
   (SELECT * FROM INTRANET.RISK.DBO.VW_SP_DEPOSIT WHERE SUB_BROKER=@USER) A  LEFT OUTER JOIN INTRANET.RISK.DBO.SUBGROUP B 
   ON A.SUB_BROKER=B.SUB_BROKER   
 END  
 ELSE  
 BEGIN  
   SELECT A.*,SBNAME FROM   
   (SELECT * FROM INTRANET.RISK.DBO.SB_DEPOSIT WHERE SUB_BROKER=@USER) A  LEFT OUTER JOIN INTRANET.RISK.DBO.SUBGROUP B 
   ON A.SUB_BROKER=B.SUB_BROKER   
 END  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Role_Authorization
-- --------------------------------------------------





CREATE Procedure [dbo].[Role_Authorization]    

as    

set nocount on    

    

 /*Added by renil to check*/    

 select a.* into #menu from menu_item  a join ConfData b on a.Head=b.head and a.Sub_Head=b.subhead and a.menu_name=b.menu   

 select * into #user1 from user_login where status=1 and login_inactive_date > GETDATE() and access_to not in ('SB','SBMAST','Client')

 select * into #cat from cat_mapping    

 /**********/    

   

    

 select username,person_name,usertype,Access_To,Access_Code,Login_activated,b.menu_code,head,sub_head,menu_name,menu_desc,active,applicable_to     

 into #file1     

 from    

 (select username,person_name,usertype,Access_To,Access_Code,Login_activated,cat_Code from #user1 where Login_inactive_date >= GETDATE()) a join    

 (select c.cat_Code,b.* from cat_mapping a, #menu b, #cat c where a.menu_code=b.menu_code and a.cat_code=c.cat_Code And b.menu_Code = c.menu_Code ) b    

 on a.cat_code=b.Cat_Code    

    

    

 insert into #file1    

 select  username,person_name,usertype,Access_To,Access_Code,Login_activated,b.menu_code,head,sub_head,menu_name,menu_desc,active,applicable_to     

 from    

 (select username,person_name,usertype,Access_To,Access_Code,Login_activated,cat_Code from #user1 where Login_inactive_date >= GETDATE()) a join    

 (select a.EMP_NO,b.* from EXTRA_CAT_MAPPING a, #menu b where a.menu_code=b.menu_code ) b    

 on a.username=b.emp_no    

   

  

 select x.*,y.department,y.sub_department,y.Sr_name,z.BrOwner from    

 (select a.* from #file1 a left outer join exclude_cat_mapping b on a.username=b.EMP_NO and a.menu_code=b.MENU_CODE where b.MENU_CODE is null) x    

 join    

  risk.dbo.emp_info y    

 on x.username=y.emp_no    

 left outer join    

 (

	 select a.emp_no,a.CostCode,b.Browner 

	 from risk.dbo.emp_info a join [CSOKYC-6].risk.dbo.browner b on a.CostCode=b.branchcode

 )  z

 on x.username=z.emp_no

 

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Role_Authorization_09Jun2015
-- --------------------------------------------------
CREATE Procedure [dbo].[Role_Authorization_09Jun2015]  
as  
set nocount on  
 
 /*Added by renil to check*/  
 select * into #menu from menu_item  
 select * into #user1 from user_login  
 select * into #cat from cat_mapping  
 /**********/  

 select username,person_name,usertype,Access_To,Access_Code,Login_activated,b.menu_code,head,sub_head,menu_name,menu_desc,active,applicable_to   
 into #file1   
 from  
 (select username,person_name,usertype,Access_To,Access_Code,Login_activated,cat_Code from #user1 where Login_inactive_date >= GETDATE()) a join  
 (select c.cat_Code,b.* from cat_mapping a, #menu b, #cat c where a.menu_code=b.menu_code and a.cat_code=c.cat_Code) b  
 on a.cat_code=b.Cat_Code  
  
  
 insert into #file1  
 select  username,person_name,usertype,Access_To,Access_Code,Login_activated,b.menu_code,head,sub_head,menu_name,menu_desc,active,applicable_to   
 from  
 (select username,person_name,usertype,Access_To,Access_Code,Login_activated,cat_Code from #user1 where Login_inactive_date >= GETDATE()) a join  
 (select a.EMP_NO,b.* from EXTRA_CAT_MAPPING a, #menu b where a.menu_code=b.menu_code ) b  
 on a.username=b.emp_no  
  
 
 select top 10 x.*,y.department,y.sub_department,y.Sr_name  into ##Data from  
 (select a.* from #file1 a left outer join exclude_cat_mapping b on a.username=b.EMP_NO and a.menu_code=b.MENU_CODE where b.MENU_CODE is null) x  
 join  
 /* (select * from risk.dbo.emp_info where Department not in ('Operations','B2C','B2B')) y */  
 risk.dbo.emp_info y  
 on x.username=y.emp_no  
 
 /*For email */


DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                      
             
 SELECT @emailto=MISC.DBO.FN_GETGLOBALEMAIL('FEF_InceCalcEmail','TO')                 
 --SELECT @emailcc=MISC.DBO.FN_GETGLOBALEMAIL('FEF_InceCalcEmail','CC')                 
 --SELECT @emailbcc=MISC.DBO.FN_GETGLOBALEMAIL('FEF_InceCalcEmail','BCC')            
         
DECLARE @filename1 as varchar(100)
select @filename1='d:\upload1\Role_Authorization\LoginAuthorization_'+convert(varchar(25),getdate(),102)+'.txt'                        
     print @filename1 
/* Generate  XLS File */          
declare @s as varchar(max)                        
--set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT [username],[person_name],[usertype],[Access_To],[Access_Code],[Login_activated],[menu_code],[head],[sub_head],[menu_name],[menu_desc],[active],[applicable_to],[department],[sub_department],[Sr_name] FROM INTRANET.ROLEMGM.dbo.##Data" queryout '+@filename1+' -c -Sintranet -Uinhouse -Pinh6014'                                                                                     
set @s = 'EXECUTE master.dbo.xp_cmdshell'+ '''' + 'bcp  "SELECT [username],[person_name],[usertype],[Access_To],[Access_Code],[Login_activated],[menu_code],[head],[sub_head],[menu_name],[menu_desc],[active],[applicable_to],[department],[sub_department],[Sr_name] FROM INTRANET.ROLEMGM.dbo.##Data" queryout '+@filename1 +' -t"|" -c -T ' 
set @s= @s+''''                            
Exec (@s)   

SET @MESS='Dear Team'+',<br><Br><br><Br>Please refer the attached file.<Br><Br>'                
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR>'                          
set @sub ='Login Authorization'          

                
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                          
 @RECIPIENTS ='neha.naiwar@angelbroking.com',                          
 @COPY_RECIPIENTS = 'neha.naiwar@angelbroking.com',                          
 @blind_copy_recipients='neha.naiwar@angelbroking.com',                
 @PROFILE_NAME = 'AngelBroking',                          
 @BODY_FORMAT ='HTML',                          
 @SUBJECT = @sub ,                          
 @FILE_ATTACHMENTS =@filename1,                          
 @BODY =@MESS                              

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fil_head
-- --------------------------------------------------
CREATE procedure [dbo].[rpt_fil_head](@access_to as varchar(15))  
As  
select distinct head from menu_item where menu_code in  
 (select menu_code from cat_mapping where cat_code in  
  (select cat_code  from menu_cat where applicable_to like '%'+@access_to+'%'))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_UATApps
-- --------------------------------------------------
Create Proc [dbo].[Rpt_UATApps](@access_to varchar(12),@access_code  varchar(12))
as
select Head,Sub_Head,menu_name,menu_url,menu_desc,Owner_name,developer_name,applicable_to,
update_by,update_on
from menu_item(nolock) where head='TEST' and active='Y'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_Email_PAssword_new
-- --------------------------------------------------
CREATE procedure [dbo].[SB_Email_PAssword_new](@sb as varchar(10))                                                                    
as                                                                                
SET NOCOUNT ON                                                                                
                             
                                     
--declare @sb as varchar(50)                                                
--set @sb='SHTH'                              
                                                
                                             
                          
                            
create table #temp_sb                           
(                          
sb varchar(15),                          
password varchar(10),                          
emailid varchar(50)                          
)                   
                          
                
                
insert into #temp_sb (sb,emailid)select distinct sbtag,emailid from mis.sb_comp.dbo.bpapplication bp with(nolock) inner join mis.sb_comp.dbo.sb_contact con with(nolock) on con.refno=bp.apprefno inner join mis.sb_comp.dbo.sb_broker sb with(nolock) on      
        
con.refno=sb.refno where bp.appstatus='registered' and con.addtype in ('TER','RES') and sb.sbtag=@sb                
                
if((select count(*) from #temp_sb) < 1)                          
begin                          
insert into #temp_sb (sb,emailid)         
select distinct replace(branch+sbtag,' ',''),emailid from mis.sb_comp.dbo.bpapplication bp with(nolock) inner join  mis.sb_comp.dbo.sb_contact con with(nolock) on con.refno=bp.apprefno inner join           
mis.sb_comp.dbo.sb_broker sb with(nolock) on con.refno=sb.refno where bp.appstatus='registered' and con.addtype in           
('TER','RES') and ltrim(rtrim(replace(sb.branch +sbtag,' ','')))=ltrim(rtrim(replace(@sb,' ','')))                  
end                                       
                                                 
declare @ss as table                                                                                
(Password varchar(25))                                                                                
                                                
                                                
              insert into @ss (password) exec ctcl.dbo.random_password1 8,''                                                                                 
              update @ss set password=replace(password,'O','x')                                                           
              update @ss set password=replace(password,'0','q')                                                           
              update @ss set password=replace(password,'B','e')                                                           
              update @ss set password=replace(password,'8','n')                                                           
              update @ss set password=replace(password,'5','k')                                                           
              update @ss set password=replace(password,'S','d')                                                           
              update @ss set password=replace(password,'1','w')                                                           
              update @ss set password=replace(password,'I','z')                                                           
              update @ss set password=replace(password,'L','v')                                                           
              update @ss set password=lower(password)                                                           
                                                                  
              update  #temp_sb set password=b.password from @ss b where #temp_sb.sb=@sb                                                 
                                                
              delete from @ss                                                  
                                   
            update #temp_sb set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113 and  #temp_sb.sb= @sb                                                                            
            update #temp_sb set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70  and  #temp_sb.sb= @sb                                                                   
            update #temp_sb set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69  and  #temp_sb.sb= @sb                                                                            
            update #temp_sb set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71  and  #temp_sb.sb= @sb                                                                            
            update #temp_sb set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114 and  #temp_sb.sb= @sb                                                                             
            update #temp_sb set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73  and  #temp_sb.sb= @sb                                                     
            update #temp_sb set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122 and  #temp_sb.sb= @sb                                                               
            update #temp_sb set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118 and  #temp_sb.sb= @sb                                         
                                                                                          
            update #temp_sb set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i') and  #temp_sb.sb= @sb                                                                       
            update #temp_sb set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')  and  #temp_sb.sb= @sb                                                   
            update #temp_sb set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')  and  #temp_sb.sb= @sb                                                                      
            update #temp_sb set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')  and  #temp_sb.sb= @sb                                                  
            update #temp_sb set password = substring(password,1,4)+'e'+substring(password,6,3) where ascii(substring(password,5,1))=ascii('j')  and  #temp_sb.sb= @sb                                                                      
            update #temp_sb set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')  and  #temp_sb.sb= @sb                                                                      
            update #temp_sb set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')  and  #temp_sb.sb= @sb                                                                     
            update #temp_sb set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n') and  #temp_sb.sb= @sb                                                                       
                                                
                                              
update user_login set  userpassword = #temp_sb.password from #temp_sb where user_login.username =#temp_sb.sb                                              
                                                
-----------------------for mail                              
                                                                        
DECLARE @rc INT                                                  
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues                                                                       
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                  
EXEC @rc = msdb.dbo.sysmail_start_sp                                                
                                                
DECLARE @pswd as varchar(20),@regtag as varchar(20),@mess as varchar(2000),@email as varchar(50)                                                      
                           
select @pswd=password from #temp_sb                                    
select @regtag=sb from #temp_sb                                                
                            
--megha select distinct @email=regemailid                                 
select distinct @email=emailid                          
from #temp_sb a (NOLOCK)                           
                                                
--set @mess='Dear Sir / Madam<br><br>                                                          
--                                                    
--<b> This is your '''+@pswd+''' new password</b>                                                
--by Software Application                                                      
--'               
                              
                
set @mess='Dear Sir/Madam<br><br>                                     
As per your request for re-setting the Password for In-House, we wish to inform you that                                    
<br>                                     
 the same has been reset. Please find your user id and new password for the In-House.                                      
<br><br>                                    
<b>Login id :-'''+@regtag+''' </b>                                   
<br>                                  
<b> Password :-'''+@pswd+'''</b>                                    
<br><br>                           
Request you to kindly login to your account and reset your password.                                     
<br><br>                                    
www.angelbroking.com  > Partner login>user id>password                                    
<br><br>                                    
Should you require any further clarification, please do call us on (Direct):30817400 between 10:00 am                                     
<br>                                    
to 6:00 pm on all trading days and 10:00 am to 4:00 pm on                                    
<br>                                    
Saturdays or you could also e-mail us at feedback@angeltrade.com                                    
<br><br>                                    
Assuring of our personalized services at all times.                                    
<br><br>                                    
Best Regards,                                    
<br>                                    
Feedback- Quality Assurance Cell  <br> Call us:-091-022-2835 8800 '                                     
                                                              
                                                
exec msdb.dbo.sp_send_dbmail                                                                         
--@recipients  = 'megha.wangane@angeltrade.com',--@email,                                                                                 
@recipients  = @email,--@email,                         
@profile_name = 'feedback',                                                            
----@from = 'feedback@angeltrade.com',                                                                                 
@subject = 'Forgot Password Request Processed - Angel Broking',                                                             
@body_format = 'html',                                                  
@body =@mess                   
   
insert into forget_pwd_log_subbroker values(getdate(),'',@sb,@pswd,'password has been changed')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_LIMI_UPD
-- --------------------------------------------------
CREATE PROCEDURE SB_LIMI_UPD  
(  
 @BRCODE AS VARCHAR(10),  
 @SBCODE AS VARCHAR(10),  
 @LIMIT AS MONEY  
)  
    
AS    
    
DECLARE @BR_LIMIT AS MONEY    
DECLARE @TOTSB_LIMIT AS MONEY    
SELECT @BR_LIMIT=0,@TOTSB_LIMIT=0    
    
SET NOCOUNT ON    
    
SELECT @BR_LIMIT=ISNULL(LIMIT,0) FROM INTRANET.RISK.DBO.BR_LIMIT WHERE SBTAG=@BRCODE    
  
SELECT @TOTSB_LIMIT=ISNULL(SUM(ISNULL(LIMIT,0)),0)   
FROM INTRANET.RISK.DBO.SB_LIMIT   
WHERE SUB_BROKER IN (SELECT DISTINCT SUBGROUP FROM INTRANET.RISK.DBO.FINMAST WHERE SBTAG=@BRCODE)    
    
IF @BR_LIMIT < @TOTSB_LIMIT+@LIMIT    
 BEGIN    
  SELECT RESULT='0'    
 END    
ELSE    
BEGIN    
DECLARE @ISTHERE AS INT    
SELECT @ISTHERE=COUNT(*) FROM INTRANET.RISK.DBO.SB_LIMIT WHERE SUB_BROKER=@SBCODE    
IF @ISTHERE > 0     
 BEGIN    
  UPDATE INTRANET.RISK.DBO.SB_LIMIT SET LIMIT=@LIMIT WHERE SUB_BROKER = @SBCODE    
 END    
ELSE    
 BEGIN    
  INSERT INTO INTRANET.RISK.DBO.SB_LIMIT (SUB_BROKER,LIMIT) VALUES(@SBCODE,@LIMIT)    
 END    
 SELECT RESULT='1'    
END    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_login_detail
-- --------------------------------------------------
CREATE procedure [dbo].[SB_login_detail] 
(
	@fdate as varchar(11), @tdate as varchar(11), @access_to as varchar(15), @access_code as varchar(15)
)    
as    


   
set @fdate=convert(varchar(11),convert(datetime,@fdate,103))  
set @tdate=convert(varchar(11),convert(datetime,@tdate,103))  
set nocount on    

select access_code,last_login,b.branch,username into #t from user_login join    
(select sub_broker,branch=max(branch_code)from intranet.risk.dbo.subbrokers     
group by sub_broker) b    
on  access_code = b.sub_broker    
where access_to = 'SB' and last_login>=@fdate  and last_login <= @tdate+' 23:59:59'    
    
select access_code,branch,#t.username,NoOfLogin=count(*) into #t1    
from #t left outer join Vw_login_logs  on #t.username=Vw_login_logs.username    
where access_datetime>= @fdate  and access_datetime <= @tdate    
group by #t.username,branch,access_code    
    
select distinct access_code,tagtype = (case when B2C_SB is null then 'B2B' else 'B2C' end) into #tt    
from #t1 left outer join mis.remisior.dbo.b2c_sb on Access_code=B2C_SB    
    
select distinct Region=r.region, BranchName=r.name, SBTag=access_code ,NoOfLogin into #temp    
from #t1 left outer join intranet.risk.dbo.region r on branch= code    
    
Select distinct Region, BranchName, SBTag , TagType ,NoOfLogin    
from #temp left outer join #tt on SBTag=#tt.access_code  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generate_inserts
-- --------------------------------------------------
    
    
create PROC [dbo].[sp_generate_inserts]    
(    
 @table_name varchar(776),    -- The table/view for which the INSERT statements will be generated using the existing data    
 @target_table varchar(776) = NULL,  -- Use this parameter to specify a different table name into which the data will be inserted    
 @include_column_list bit = 1,  -- Use this parameter to include/ommit column list in the generated INSERT statement    
 @from varchar(800) = NULL,   -- Use this parameter to filter the rows based on a filter condition (using WHERE)    
 @include_timestamp bit = 0,   -- Specify 1 for this parameter, if you want to include the TIMESTAMP/ROWVERSION column's data in the INSERT statement    
 @debug_mode bit = 0,   -- If @debug_mode is set to 1, the SQL statements constructed by this procedure will be printed for later examination    
 @owner varchar(64) = NULL,  -- Use this parameter if you are not the owner of the table    
 @ommit_images bit = 0,   -- Use this parameter to generate INSERT statements by omitting the 'image' columns    
 @ommit_identity bit = 0,  -- Use this parameter to ommit the identity columns    
 @top int = NULL,   -- Use this parameter to generate INSERT statements only for the TOP n rows    
 @cols_to_include varchar(8000) = NULL, -- List of columns to be included in the INSERT statement    
 @cols_to_exclude varchar(8000) = NULL, -- List of columns to be excluded from the INSERT statement    
 @disable_constraints bit = 0,  -- When 1, disables foreign key constraints and enables them after the INSERT statements    
 @ommit_computed_cols bit = 0  -- When 1, computed columns will not be included in the INSERT statement    
     
)    
AS    
BEGIN    
    
/***********************************************************************************************************    
Procedure: sp_generate_inserts  (Build 22)     
  (Copyright Â© 2002 Narayana Vyas Kondreddi. All rights reserved.)    
                                              
Purpose: To generate INSERT statements from existing data.     
  These INSERTS can be executed to regenerate the data at some other location.    
  This procedure is also useful to create a database setup, where in you can     
  script your data along with your table definitions.    
    
Written by: Narayana Vyas Kondreddi    
         http://vyaskn.tripod.com    
    
Acknowledgements:    
  Divya Kalra -- For beta testing    
  Mark Charsley -- For reporting a problem with scripting uniqueidentifier columns with NULL values    
  Artur Zeygman -- For helping me simplify a bit of code for handling non-dbo owned tables    
  Joris Laperre   -- For reporting a regression bug in handling text/ntext columns    
    
Tested on:  SQL Server 7.0 and SQL Server 2000    
    
Date created: January 17th 2001 21:52 GMT    
    
Date modified: May 1st 2002 19:50 GMT    
    
Email:   vyaskn@hotmail.com    
    
NOTE:  This procedure may not work with tables with too many columns.    
  Results can be unpredictable with huge text columns or SQL Server 2000's sql_variant data types    
  Whenever possible, Use @include_column_list parameter to ommit column list in the INSERT statement, for better results    
  IMPORTANT: This procedure is not tested with internation data (Extended characters or Unicode). If needed    
  you might want to convert the datatypes of character variables in this procedure to their respective unicode counterparts    
  like nchar and nvarchar    
      
    
Example 1: To generate INSERT statements for table 'titles':    
      
  EXEC sp_generate_inserts 'titles'    
    
Example 2:  To ommit the column list in the INSERT statement: (Column list is included by default)    
  IMPORTANT: If you have too many columns, you are advised to ommit column list, as shown below,    
  to avoid erroneous results    
      
  EXEC sp_generate_inserts 'titles', @include_column_list = 0    
    
Example 3: To generate INSERT statements for 'titlesCopy' table from 'titles' table:    
    
  EXEC sp_generate_inserts 'titles', 'titlesCopy'    
    
Example 4: To generate INSERT statements for 'titles' table for only those titles     
  which contain the word 'Computer' in them:    
  NOTE: Do not complicate the FROM or WHERE clause here. It's assumed that you are good with T-SQL if you are using this parameter    
    
  EXEC sp_generate_inserts 'titles', @from = "from titles where title like '%Computer%'"    
    
Example 5:  To specify that you want to include TIMESTAMP column's data as well in the INSERT statement:    
  (By default TIMESTAMP column's data is not scripted)    
    
  EXEC sp_generate_inserts 'titles', @include_timestamp = 1    
    
Example 6: To print the debug information:    
      
  EXEC sp_generate_inserts 'titles', @debug_mode = 1    
    
Example 7:  If you are not the owner of the table, use @owner parameter to specify the owner name    
  To use this option, you must have SELECT permissions on that table    
    
  EXEC sp_generate_inserts Nickstable, @owner = 'Nick'    
    
Example 8:  To generate INSERT statements for the rest of the columns excluding images    
  When using this otion, DO NOT set @include_column_list parameter to 0.    
    
  EXEC sp_generate_inserts imgtable, @ommit_images = 1    
    
Example 9:  To generate INSERT statements excluding (ommiting) IDENTITY columns:    
  (By default IDENTITY columns are included in the INSERT statement)    
    
  EXEC sp_generate_inserts mytable, @ommit_identity = 1    
    
Example 10:  To generate INSERT statements for the TOP 10 rows in the table:    
      
  EXEC sp_generate_inserts mytable, @top = 10    
    
Example 11:  To generate INSERT statements with only those columns you want:    
      
  EXEC sp_generate_inserts titles, @cols_to_include = "'title','title_id','au_id'"    
    
Example 12:  To generate INSERT statements by omitting certain columns:    
      
  EXEC sp_generate_inserts titles, @cols_to_exclude = "'title','title_id','au_id'"    
    
Example 13: To avoid checking the foreign key constraints while loading data with INSERT statements:    
      
  EXEC sp_generate_inserts titles, @disable_constraints = 1    
    
Example 14:  To exclude computed columns from the INSERT statement:    
  EXEC sp_generate_inserts MyTable, @ommit_computed_cols = 1    
***********************************************************************************************************/    
    
SET NOCOUNT ON    
    
--Making sure user only uses either @cols_to_include or @cols_to_exclude    
IF ((@cols_to_include IS NOT NULL) AND (@cols_to_exclude IS NOT NULL))    
 BEGIN    
  RAISERROR('Use either @cols_to_include or @cols_to_exclude. Do not use both the parameters at once',16,1)    
  RETURN -1 --Failure. Reason: Both @cols_to_include and @cols_to_exclude parameters are specified    
 END    
    
--Making sure the @cols_to_include and @cols_to_exclude parameters are receiving values in proper format    
IF ((@cols_to_include IS NOT NULL) AND (PATINDEX('''%''',@cols_to_include) = 0))    
 BEGIN    
  RAISERROR('Invalid use of @cols_to_include property',16,1)    
  PRINT 'Specify column names surrounded by single quotes and separated by commas'    
  PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_include = "''title_id'',''title''"'    
  RETURN -1 --Failure. Reason: Invalid use of @cols_to_include property    
 END    
    
IF ((@cols_to_exclude IS NOT NULL) AND (PATINDEX('''%''',@cols_to_exclude) = 0))    
 BEGIN    
  RAISERROR('Invalid use of @cols_to_exclude property',16,1)    
  PRINT 'Specify column names surrounded by single quotes and separated by commas'    
  PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_exclude = "''title_id'',''title''"'    
  RETURN -1 --Failure. Reason: Invalid use of @cols_to_exclude property    
 END    
    
    
--Checking to see if the database name is specified along wih the table name    
--Your database context should be local to the table for which you want to generate INSERT statements    
--specifying the database name is not allowed    
IF (PARSENAME(@table_name,3)) IS NOT NULL    
 BEGIN    
  RAISERROR('Do not specify the database name. Be in the required database and just specify the table name.',16,1)    
  RETURN -1 --Failure. Reason: Database name is specified along with the table name, which is not allowed    
 END    
    
--Checking for the existence of 'user table' or 'view'    
--This procedure is not written to work on system tables    
--To script the data in system tables, just create a view on the system tables and script the view instead    
    
IF @owner IS NULL    
 BEGIN    
  IF ((OBJECT_ID(@table_name,'U') IS NULL) AND (OBJECT_ID(@table_name,'V') IS NULL))     
   BEGIN    
    RAISERROR('User table or view not found.',16,1)    
    PRINT 'You may see this error, if you are not the owner of this table or view. In that case use @owner parameter to specify the owner name.'    
    PRINT 'Make sure you have SELECT permission on that table or view.'    
    RETURN -1 --Failure. Reason: There is no user table or view with this name    
   END    
 END    
ELSE    
 BEGIN    
  IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @table_name AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @owner)    
   BEGIN    
    RAISERROR('User table or view not found.',16,1)    
    PRINT 'You may see this error, if you are not the owner of this table. In that case use @owner parameter to specify the owner name.'    
    PRINT 'Make sure you have SELECT permission on that table or view.'    
    RETURN -1 --Failure. Reason: There is no user table or view with this name      
   END    
 END    
    
--Variable declarations    
DECLARE  @Column_ID int,       
  @Column_List varchar(8000),     
  @Column_Name varchar(128),     
  @Start_Insert varchar(786),     
  @Data_Type varchar(128),     
  @Actual_Values varchar(8000), --This is the string that will be finally executed to generate INSERT statements    
  @IDN varchar(128)  --Will contain the IDENTITY column's name in the table    
    
--Variable Initialization    
SET @IDN = ''    
SET @Column_ID = 0    
SET @Column_Name = ''    
SET @Column_List = ''    
SET @Actual_Values = ''    
    
IF @owner IS NULL     
 BEGIN    
  SET @Start_Insert = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'     
 END    
ELSE    
 BEGIN    
  SET @Start_Insert = 'INSERT ' + '[' + LTRIM(RTRIM(@owner)) + '].' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'       
 END    
    
    
--To get the first column's ID    
    
SELECT @Column_ID = MIN(ORDINAL_POSITION)      
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)     
WHERE  TABLE_NAME = @table_name AND    
(@owner IS NULL OR TABLE_SCHEMA = @owner)    
    
    
    
--Loop through all the columns of the table, to get the column names and their data types    
WHILE @Column_ID IS NOT NULL    
 BEGIN    
  SELECT  @Column_Name = QUOTENAME(COLUMN_NAME),     
  @Data_Type = DATA_TYPE     
  FROM  INFORMATION_SCHEMA.COLUMNS (NOLOCK)     
  WHERE  ORDINAL_POSITION = @Column_ID AND     
  TABLE_NAME = @table_name AND    
  (@owner IS NULL OR TABLE_SCHEMA = @owner)    
    
    
    
  IF @cols_to_include IS NOT NULL --Selecting only user specified columns    
  BEGIN    
   IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_include) = 0     
   BEGIN    
    GOTO SKIP_LOOP    
   END    
  END    
    
  IF @cols_to_exclude IS NOT NULL --Selecting only user specified columns    
  BEGIN    
   IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_exclude) <> 0     
   BEGIN    
    GOTO SKIP_LOOP    
   END    
  END    
    
  --Making sure to output SET IDENTITY_INSERT ON/OFF in case the table has an IDENTITY column    
  IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsIdentity')) = 1     
  BEGIN    
   IF @ommit_identity = 0 --Determing whether to include or exclude the IDENTITY column    
    SET @IDN = @Column_Name    
   ELSE    
    GOTO SKIP_LOOP       
  END    
      
  --Making sure whether to output computed columns or not    
  IF @ommit_computed_cols = 1    
  BEGIN    
   IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsComputed')) = 1     
   BEGIN    
    GOTO SKIP_LOOP         
   END    
  END    
      
  --Tables with columns of IMAGE data type are not supported for obvious reasons    
  IF(@Data_Type in ('image'))    
   BEGIN    
    IF (@ommit_images = 0)    
     BEGIN    
      RAISERROR('Tables with image columns are not supported.',16,1)    
      PRINT 'Use @ommit_images = 1 parameter to generate INSERTs for the rest of the columns.'    
      PRINT 'DO NOT ommit Column List in the INSERT statements. If you ommit column list using @include_column_list=0, the generated INSERTs will fail.'    
      RETURN -1 --Failure. Reason: There is a column with image data type    
     END    
    ELSE    
     BEGIN    
     GOTO SKIP_LOOP    
     END    
   END    
    
  --Determining the data type of the column and depending on the data type, the VALUES part of    
  --the INSERT statement is generated. Care is taken to handle columns with NULL values. Also    
  --making sure, not to lose any data from flot, real, money, smallmomey, datetime columns    
  SET @Actual_Values = @Actual_Values  +    
  CASE     
   WHEN @Data_Type IN ('char','varchar','nchar','nvarchar')     
    THEN     
     'COALESCE('''''''' + REPLACE(RTRIM(' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'    
   WHEN @Data_Type IN ('datetime','smalldatetime')     
    THEN     
     'COALESCE('''''''' + RTRIM(CONVERT(char,' + @Column_Name + ',109))+'''''''',''NULL'')'    
   WHEN @Data_Type IN ('uniqueidentifier')     
    THEN      
     'COALESCE('''''''' + REPLACE(CONVERT(char(255),RTRIM(' + @Column_Name + ')),'''''''','''''''''''')+'''''''',''NULL'')'    
   WHEN @Data_Type IN ('text','ntext')     
    THEN      
     'COALESCE('''''''' + REPLACE(CONVERT(char(8000),' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'         
   WHEN @Data_Type IN ('binary','varbinary')     
    THEN      
     'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'      
   WHEN @Data_Type IN ('timestamp','rowversion')     
    THEN      
     CASE     
      WHEN @include_timestamp = 0     
       THEN     
        '''DEFAULT'''     
       ELSE     
        'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'      
     END    
   WHEN @Data_Type IN ('float','real','money','smallmoney')    
    THEN    
     'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' +  @Column_Name  + ',2)' + ')),''NULL'')'     
   ELSE     
    'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' +  @Column_Name  + ')' + ')),''NULL'')'     
  END   + '+' +  ''',''' + ' + '    
      
  --Generating the column list for the INSERT statement    
  SET @Column_List = @Column_List +  @Column_Name + ','     
    
  SKIP_LOOP: --The label used in GOTO    
    
  SELECT  @Column_ID = MIN(ORDINAL_POSITION)     
  FROM  INFORMATION_SCHEMA.COLUMNS (NOLOCK)     
  WHERE  TABLE_NAME = @table_name AND     
  ORDINAL_POSITION > @Column_ID AND    
  (@owner IS NULL OR TABLE_SCHEMA = @owner)    
    
    
 --Loop ends here!    
 END    
    
--To get rid of the extra characters that got concatenated during the last run through the loop    
SET @Column_List = LEFT(@Column_List,len(@Column_List) - 1)    
SET @Actual_Values = LEFT(@Actual_Values,len(@Actual_Values) - 6)    
    
IF LTRIM(@Column_List) = ''     
 BEGIN    
  RAISERROR('No columns to select. There should at least be one column to generate the output',16,1)    
  RETURN -1 --Failure. Reason: Looks like all the columns are ommitted using the @cols_to_exclude parameter    
 END    
    
--Forming the final string that will be executed, to output the INSERT statements    
IF (@include_column_list <> 0)    
 BEGIN    
  SET @Actual_Values =     
   'SELECT ' +      
   CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +     
   '''' + RTRIM(@Start_Insert) +     
   ' ''+' + '''(' + RTRIM(@Column_List) +  '''+' + ''')''' +     
   ' +''VALUES(''+ ' +  @Actual_Values  + '+'')''' + ' ' +     
   COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')    
 END    
ELSE IF (@include_column_list = 0)    
 BEGIN    
  SET @Actual_Values =     
   'SELECT ' +     
   CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +     
   '''' + RTRIM(@Start_Insert) +     
   ' '' +''VALUES(''+ ' +  @Actual_Values + '+'')''' + ' ' +     
   COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')    
 END     
    
--Determining whether to ouput any debug information    
IF @debug_mode =1    
 BEGIN    
  PRINT '/*****START OF DEBUG INFORMATION*****'    
  PRINT 'Beginning of the INSERT statement:'    
  PRINT @Start_Insert    
  PRINT ''    
  PRINT 'The column list:'    
  PRINT @Column_List    
  PRINT ''    
  PRINT 'The SELECT statement executed to generate the INSERTs'    
  PRINT @Actual_Values    
  PRINT ''    
  PRINT '*****END OF DEBUG INFORMATION*****/'    
  PRINT ''    
 END    
      
PRINT '--INSERTs generated by ''sp_generate_inserts'' stored procedure written by Vyas'    
PRINT '--Build number: 22'    
PRINT '--Problems/Suggestions? Contact Vyas @ vyaskn@hotmail.com'    
PRINT '--http://vyaskn.tripod.com'    
PRINT ''    
PRINT 'SET NOCOUNT ON'    
PRINT ''    
    
    
--Determining whether to print IDENTITY_INSERT or not    
IF (@IDN <> '')    
 BEGIN    
  PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' ON'    
  PRINT 'GO'    
  PRINT ''    
 END    
    
    
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)    
 BEGIN    
  IF @owner IS NULL    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'    
   END    
  ELSE    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'    
   END    
    
  PRINT 'GO'    
 END    
    
PRINT ''    
PRINT 'PRINT ''Inserting values into ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' + ''''    
    
    
--All the hard work pays off here!!! You'll get your INSERT statements, when the next line executes!    
EXEC (@Actual_Values)    
    
PRINT 'PRINT ''Done'''    
PRINT ''    
    
    
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)    
 BEGIN    
  IF @owner IS NULL    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL'  AS '--Code to enable the previously disabled constraints'    
   END    
  ELSE    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints'    
   END    
    
  PRINT 'GO'    
 END    
    
PRINT ''    
IF (@IDN <> '')    
 BEGIN    
  PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' OFF'    
  PRINT 'GO'    
 END    
    
PRINT 'SET NOCOUNT OFF'    
    
    
SET NOCOUNT OFF    
RETURN 0 --Success. We are done!    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_SYSOBJ
-- --------------------------------------------------
/****************************************************************************
	CREATED BY :: PRASHANT  
	CREATED DATE :: 28 JAN 2011
	PURPOSE :: USE TO GET OBJECTS LIST PRESENT IN DATABASE
****************************************************************************/  
CREATE PROCEDURE SP_SYSOBJ  
(  
	@OBJ_NAME AS VARCHAR(20),  
	@OBJ_TYPE AS VARCHAR(3) = ''  
)  
AS  
BEGIN  
	
	SELECT * 
	FROM SYSOBJECTS 
	WHERE NAME LIKE '%'+@OBJ_NAME+'%' AND TYPE LIKE '%'+@OBJ_TYPE+'%' --'%BATCH%'  
	ORDER BY NAME,TYPE  
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_test_dll
-- --------------------------------------------------
CREATE proc [dbo].[sp_test_dll]
(@access_code as varchar(50))
as
if(@access_code = 'Select')
begin
set @access_code = '%%'
end
select person_name [Name],username [Employee ID],email[Email ID],access_to[Access To],access_code[Access Code] from user_login where access_code like @access_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Upd_Login_Inactive_Date
-- --------------------------------------------------
CREATE Procedure SP_Upd_Login_Inactive_Date
(
		@inactiveDate Datetime,
		@accessCode varchar(10)
)

AS
BEGIN


--IF(@inactiveDate>GETDATE())
--BEGIN

	IF EXISTS(select * from user_login where access_code=@accessCode )
	BEGIN
		Update user_login
		set login_inactive_date=@inactiveDate,status=1 
		where access_code=@accessCode
		select '1' as [Message]
	END
	ELSE
	BEGIN
		select '0' as [Message]
	END
--END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_ValidateDRA
-- --------------------------------------------------
 CREATE proc [dbo].[Spx_ValidateDRA]
  @SbTag varchar(20) 
  AS
  BEGIN
  Declare @Message varchar(50)='Failed'
  Declare @Count1 INT =0

  SELECT  @Count1= Count(SBTAG) FROM  risk.dbo.[tbl_DRA_SBTAG] with(nolock) WHERE SBTAG=@SbTag and sbtag not in (select DRATag from tbl_DRA_Blocked WITH(NOLOCK))
			 
		if @Count1 > 0
		BEGIN
			SET @Message  = 'Success'
		END	 

  Select @Message AS [Message]
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_ValidateOFRA
-- --------------------------------------------------
 CREATE proc [dbo].[Spx_ValidateOFRA]
  @SbTag varchar(20)=''
  AS
  BEGIN
  Declare @Message varchar(50)

  IF EXISTS(select  1 FROM [ROLEMGM].[dbo].[OFRA_Sub_broker] with(nolock) WHERE Sub_broker=@SbTag)
  BEGIN
    set @Message = 'Success'
  END
  else
  BEGIN
    set @Message = 'failed'   
  END
  Select @Message as Message;
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Synergy_DeLoginEmail
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Synergy_DeLoginEmail]                     
            
AS                      
                      
BEGIN                      
                     
                      
 SELECT * INTO #SYNERGYUSER FROM [196.1.115.199].SYNERGY.dbo.SYNERGY_VW_USER_MAST WHERE USER_ID IN            
(SELECT EMP_NO FROM EMP_INFO WITH (NOLOCK) WHERE STATUS <> 'A')  --[196.1.115.245].ROLEMGM.DBO.         
AND USER_ACTIVE_STATUS='Y'          
           
DECLARE @COUNT AS INT        
         
         
select @COUNT=COUNT(DISTINCT USER_ID) FROM #SYNERGYUSER        
SELECT DISTINCT USER_ID INTO #SYN FROM #SYNERGYUSER        
         
SELECT  ROW_NUMBER() OVER(ORDER BY USER_ID DESC) AS  'ROWNUM',* INTO #SYN1                        
FROM #SYN        
         
         
--DECLARE @COUNT AS INT            
if( @COUNT>0)        
BEGIN        
         
DECLARE @TABLEHTML1 AS NVARCHAR(MAX);                                                                                                                                                              
                                                          
 SET @TABLEHTML1 =                                                               
 N'DEAR ALL,<BR><BR>' +                                                                                         
 N'KINDLY DO THE NEEDFUL TO DEACTIVATE THE SYNERGY USER FOR THE EX-EMPLOYEE.<BR><BR>'            
 +N'EX-EMPLOYEE USER INFORMATION ENCLOSED.<BR><BR>'+                                        
 N'<TABLE  BORDER="1" ALIGN="CENTER" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#FFFFFF" BGCOLOR="#D5C9F1"                     
 STYLE="BORDER:#000000 SOLID 1PX;FONT-SIZE:15PX;FONT-FAMILY:ARIAL">'                                                                                                   
                      
 +N'<TR>'                                       
 +N'<TD HEIGHT="15" COLSPAN="3" BGCOLOR="#2C204B" ALIGN=CENTER><FONT COLOR=WHITE SIZE="3"><B>EX-EMPLOYEE IN SYNERGY</B></FONT> </TD>'                                                    
 +N'</TR>' +                                                                                                                                                                
 +N'<TR>'                                                       
 +N'<TH WIDTH: 69PX; HEIGHT: 21PX; BGCOLOR="#AA98D3">SR. NO</TH> '                                                    
 +N'<TH "WIDTH: 182PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">USER ID</TH> '                                                                                                                                                              
 +N'<TH  "WIDTH: 220PX; HEIGHT: 21PX;" BGCOLOR="#AA98D3">USER NAME</TH> '                          
 +N'</TR>'+                      
                       
                     
 CAST((SELECT                    
 TD =  ROW_NUMBER() OVER( ORDER BY A.USER_ID ,A.USER_ID),'',                                   
 TD = A.USER_ID,'',                                     
 TD = USER_NAME, ''                                     
      FROM #SYNERGYUSER A        
      JOIN  #SYN1 B        
      ON A.USER_ID=B.USER_ID                        
            --WHERE B.ROWNUM=@COUNT         
        ORDER BY A.USER_ID                          
      FOR XML PATH('TR'),TYPE) AS NVARCHAR(MAX)) +                       
                                 
                            
 '</TR>' +                       
 +N' </TABLE><BR><BR><BR><BR>'                       
                                    
 +N' <TABLE> '+                                      
 +N' <TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >FOR ANY INFORMATION EMAIL :- INHOUSE.SUPPORT@ANGELBROKING.COM <BR><BR></TD></TR>'                      
 +N'<TR><TD STYLE="FONT-SIZE: 15PX" ,FONT:BOLD >ANGEL INHOUSE AUTO AUDIT SYSTEM(AIAAS)</TD></TR>'                      
 +N'<TR><TD STYLE="FONT-SIZE: 12PX" ,FONT:BOLD >MANAGED BY ANGEL INHOUSE SOFTWARE TEAM</TD></TR>'                      
 +N'</TABLE><BR> <BR>'                                                                  
 +N'THIS IS AN AUTOMATED SYSTEM GENERATED INFORMATION FOR YOUR REFERENCE.PLEASE DO NOT REPLY.<BR>ANGEL BROKING '                       
         
         
                                 
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                                 
@RECIPIENTS  = 'Helpdeskloginmgmt@angelbroking.com;NILESH@ANGELBROKING.COM;JAGANNATH@ANGELBROKING.COM;BHAVIN.SHAH@ANGELBROKING.COM;',                                                                       
     
@COPY_RECIPIENTS = 'RAHULC.SHAH@ANGELBROKING.COM;Helpdeskloginmgmt@angelbroking.com',                                                                                                                     
--@RECIPIENTS  =@RECIPIENT,                                          
@BLIND_COPY_RECIPIENTS= 'AMIT.GHODEKAR@ANGELBROKING.COM;renil.pillai@angelbroking.com;',            
--@BLIND_COPY_RECIPIENTS='ZEBA.RAJE@ANGELBROKING.COM;',                                                                                             
@PROFILE_NAME = 'DBA',                                                                                                                
@BODY_FORMAT ='HTML',                                     
@SUBJECT = 'EX-EMPLOYEE OF SYNERGY',                                                                                                                    
@BODY = @TABLEHTML1                                                                                                           
PRINT @TABLEHTML1                        
                                                              
         
 END        
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Synergy_NonEmpLoginEmail
-- --------------------------------------------------
CREATE procedure [dbo].[Synergy_NonEmpLoginEmail]                    
                    
as                    
                    
begin                    
                   
                  
select * into #synergyuser from [196.1.115.199].synergy.dbo.Synergy_VW_User_Mast where user_id not in                    
(select emp_no from risk.dbo.emp_info with(nolock) )                    
and user_Active_status='Y'                  
                   
declare @tableHTML1 AS nVARCHAR(max);                                                                                                                                                            
                                                             
 SET @tableHTML1 =                                                             
 N'Dear All,<br><br>' +                                                                                       
 N'Kindly find enclosed list of the Non-Employee Login in Synergy for your reference. <br><br>'+                                      
 N'<table  border="1" align="center" cellpadding="0" cellspacing="0" bordercolor="#FFFFFF" bgcolor="#d5c9f1"                   
 style="border:#000000 solid 1px;font-size:15px;font-family:Arial">'                                                                                                 
                    
 +N'<tr>'                                     
 +N'<td height="15" colspan="2" bgcolor="#2C204B" align=center><font color=white size="2"><b>Non-Employee Login in Synergy</b></font> </td>'                                                  
 +N'</tr>' +                                                                                                                                                              
 +N'<tr>'                                                     
 --+N'<th width="1%" bgcolor="#AA98D3">Sr. No</th> '                                                  
 +N'<th width="20%" bgcolor="#AA98D3">USER ID</th> '                                                                                                                                                            
 +N'<th  width="20%" bgcolor="#AA98D3">User Name</th> '                        
 +N'</TR>'+                    
                     
                     
 CAST((SELECT                    
                                   
 TD = USER_ID,'',                                     
 TD = USER_NAME, ''                                     
      FROM #synergyuser                    
      ORDER BY   USER_ID                          
      FOR XML PATH('TR'),TYPE) AS NVARCHAR(MAX)) +                       
                          
 '</TR>' +                     
 +N' </TABLE><BR><BR><BR><BR>'                     
                                  
 +N' <TABLE> '+                                    
 +N' <TR><TD STYLE="FONT-SIZE: 15PX" ,font:bold >For any information Email :- inhouse.support@angelbroking.com <br><br></TD></TR>'                    
 +N'<TR><TD STYLE="FONT-SIZE: 15PX" ,font:bold >Angel Inhouse Auto Audit System(AIAAS)</TD></TR>'                    
 +N'<TR><TD STYLE="FONT-SIZE: 12PX" ,font:bold >managed by Angel Inhouse Software Team</TD></TR>'                    
 +N'</TABLE><BR> <BR>'                                                                                                
 +N'THIS IS AN AUTOMATED SYSTEM GENERATED INFORMATION FOR YOUR REFERENCE.PLEASE DO NOT REPLY.<BR>ANGEL BROKING '                     
                   
                  
                  
 declare @RECIPIENT varchar(4000)                                
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                               
@RECIPIENTS  = 'Helpdeskloginmgmt@angelbroking.com;jagannath@angelbroking.com;siva.kopparapu@angelbroking.com',          
--@COPY_RECIPIENTS = @HOD_email_add,     
--@RECIPIENTS  =@RECIPIENT,                                                                                  
@BLIND_COPY_RECIPIENTS= 'renil.pillai@angelbroking.com',                                                                
@PROFILE_NAME = 'DBA',                                                         
@BODY_FORMAT ='HTML',                                   
@SUBJECT = 'NON-EMPLOYEE OF SYNERGY',                                                                                  
@BODY = @tableHTML1                                                                                                         
 --print @tableHTML1                                                                 
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Team_process_click_email
-- --------------------------------------------------
        
           
CREATE procedure Team_process_click_email (@menucode as int, @username as varchar(10))            
as        
       
--DECLARE  @username varchar(20)      
--SET @username='E01089'      
--SET @username='E21462'      
      
        
select emp_no,emp_name,senior,[status],email       
into #file2       
from        
(        
select emp_no,emp_name,senior,[status],email from emp_info with (nolock) where emp_no='E01089'      
union        
--select emp_no,emp_name,senior,[status],email from emp_info E with (nolock) where emp_no IN         
--(select senior from emp_info with (nolock) where emp_no= @username)       
select b.emp_no,b.emp_name,b.senior,b.[status],b.email from       
(select emp_no,emp_name,senior,[status],email from emp_info E with (nolock) where emp_no= 'E01089' )a      
inner join emp_info b      
on a.senior=b.emp_no      
) a        
      
      
UPDATE #file2      
   SET emp_no = (SELECT  b.emp_no      
                 FROM emp_info b      
                WHERE b.emp_no=@username),      
       emp_name =(SELECT  b.emp_name      
                 FROM emp_info b      
                WHERE b.emp_no=@username),      
       senior=(SELECT  b.senior      
                 FROM emp_info b      
                WHERE b.emp_no=@username),      
       [status]=(SELECT  b.[status]      
                 FROM emp_info b      
                WHERE b.emp_no=@username),      
    email=(SELECT  b.email      
                 FROM emp_info b      
                WHERE b.emp_no=@username)                  
 WHERE #file2.emp_no='P01015'      
      
            
declare @mess as varchar(2000)             
              
select HEAD,SUB_HEAD,MENU_NAME             
INTO #FILE1            
from menu_item M with (nolock)             
where menu_code=@menucode       
and EXISTS            
(            
select distinct sub_head from menu_item with(nolock) where menu_name not like '%report%'        
and  sub_head=M.sub_head         
and             
(            
sub_head not like '%report%'             
and sub_head not like '%upload%'             
--and sub_head not like '%audit%'             
and sub_head not like '%MIS%'             
and sub_head not like '%View%'             
and sub_head not like '%info%'             
)            
and active='Y'        
AND head<>'TEST'          
)           
      
              
 select email,emailtc=max(emailtc)       
into #emailtc       
 from            
 (            
 SELECT email,emailtc='TO' FROM #FILE2 WHERE EMP_NO=@username            
 union all            
 SELECT email,emailtc='CC' FROM #FILE2 WHERE EMP_NO in (SELECT senior FROM #FILE2 WHERE EMP_NO=@username)            
 union all            
 SELECT email,emailtc='BC' FROM emp_info  with(nolock) WHERE EMP_NO='E01089'            
 ) x            
 group by email            
          
--declare @ctr as int            
--SELECT @CTR=COUNT(1) FROM #FILE1            
            
--IF @ctr > 0         
      
          
IF (Select aa=Count(1) FROM #FILE2 WHERE EMP_NO=@username ) > 0          
BEGIN            
          
          
            
 DECLARE @rc INT                                     
 IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues                                     
 WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                                    
 EXEC @rc = msdb.dbo.sysmail_start_sp                     
            
            
 select @mess=            
 '<br><Br>Dear Sir/Madam,<br><Br>'+            
 'Team member : <u>'+Emp_no+' '+emp_name+'</u> have triggered an Inhouse process on :' + convert(varchar(25),getdate())+             
 '<br><br>Option: <b>'+head+' -> '+sub_head+' -> '+menu_name+'</b><br><br><br>Kindly check.<br>'+            
 'by AIAAS'            
 from (select * FROM #FILE2 WHERE EMP_NO=@username) a, #file1 b            
            
 declare @mbc as varchar(50),@mcc as varchar(50),@mto as varchar(50)            
 select @mto=email from #emailtc where emailtc='TO'            
 select @mcc=email from #emailtc where emailtc='CC'            
 select @mbc=email from #emailtc where emailtc='BC'            
            
 --exec msdb.dbo.sp_send_dbmail                            
 --@recipients  = @mto,                                     
 --@copy_recipients  = @mcc,                          
 --@blind_copy_recipients  = @mbc,                          
 --@profile_name = 'intranet',                  
 --@subject = 'ATTENTION!! process clicked',                                     
 --@body_format = 'html',                                   
 --@body =@mess                                    
            
            
END                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.test_ssrs
-- --------------------------------------------------
CREATE proc [dbo].[test_ssrs](@user as varchar(14))
as
select top 5 * from user_login where username=@user

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_empinfo
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[upd_empinfo]                 
AS                 
  --select * into #file from View_Emp_info                 
  SELECT *                 
  INTO   #file                 
  FROM   view_emp_info1                 
                   
  DECLARE  @nor  AS INT                 
                   
  SELECT @nor = Count(* )                 
  FROM   #file                 
                   
  IF @nor > 0                 
    BEGIN                 
      TRUNCATE TABLE emp_info                 
                       
      /*                           
insert into emp_info                              
select Emp_no,Emp_name,email,status,Address,pin,city,emp_region,acntno,state,phone,Department,designation,Senior,   Sr_name ,Branch_cd='TEMP' from #file                                 
update emp_info set branch_cd = b.costcodedefinition from Emp_CostCenter b where emp_info.emp_no=b.emp_no                                 
*/                 
      INSERT INTO emp_info                 
      SELECT emp_no,                 
             emp_name = Replace(emp_name,'''',''),                 
             email,                 
             status,                 
             LEVEL,                 
             categorydesc,                 
             department,                 
             sub_department,                 
             designation,                 
             costcode,                 
             joindate,                 
             separationdate,                 
             sex,                 
             birthdate,                 
             address,                 
             pin,                 
             city,                 
             emp_region,                 
             acntno,                 
             state,                 
             phone,                 
             senior,                 
             sr_name,                 
             branch_cd,                 
             company,                 
             sbu,                 
             lob,                 
             ZONE,                 
             region,                 
             location,                 
             attendanceloc,                 
             locaddress,                 
             panno                 
      FROM   #file                 
                       
      UPDATE user_login                 
      SET    status = 0,login_inactive_date=GETDATE()                 
      WHERE  username IN (SELECT emp_no                 
                          FROM   emp_info                 
                          WHERE  status <> 'A') and status = 1                
                       
      UPDATE user_login                 
      SET    email = b.email                 
      FROM   emp_info b                 
      WHERE  user_login.email = ''                 
             AND user_login.username = b.emp_no                 
              
 
       
             
 begin tran         
 update user_login set email=b.email from emp_info b        
 where user_login.username=b.emp_no        
 and isnull(user_login.email,'')<>isnull(b.email,'')        
 and user_login.status=1        
        
 commit tran         
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_empinfo_08062016
-- --------------------------------------------------



Create PROCEDURE [dbo].[upd_empinfo_08062016]                 
AS                 
  --select * into #file from View_Emp_info                 
  SELECT *                 
  INTO   #file                 
  FROM   view_emp_info1                 
                   
  DECLARE  @nor  AS INT                 
                   
  SELECT @nor = Count(* )                 
  FROM   #file                 
                   
  IF @nor > 0                 
    BEGIN                 
      TRUNCATE TABLE emp_info                 
                       
      /*                           
insert into emp_info                              
select Emp_no,Emp_name,email,status,Address,pin,city,emp_region,acntno,state,phone,Department,designation,Senior,   Sr_name ,Branch_cd='TEMP' from #file                                 
update emp_info set branch_cd = b.costcodedefinition from Emp_CostCenter b where emp_info.emp_no=b.emp_no                                 
*/                 
      INSERT INTO emp_info                 
      SELECT emp_no,                 
             emp_name = Replace(emp_name,'''',''),                 
             email,                 
             status,                 
             LEVEL,                 
             categorydesc,                 
             department,                 
             sub_department,                 
             designation,                 
             costcode,                 
             joindate,                 
             separationdate,                 
             sex,                 
             birthdate,                 
             address,                 
             pin,                 
             city,                 
             emp_region,                 
             acntno,                 
             state,                 
             phone,                 
             senior,                 
             sr_name,                 
             branch_cd,                 
             company,                 
             sbu,                 
             lob,                 
             ZONE,                 
             region,                 
             location,                 
             attendanceloc,                 
             locaddress,                 
             panno                 
      FROM   #file                 
                       
      UPDATE user_login                 
      SET    status = 0,login_inactive_date=GETDATE()                 
      WHERE  username IN (SELECT emp_no                 
                          FROM   emp_info                 
                          WHERE  status <> 'A') and status = 1                
                       
      UPDATE user_login                 
      SET    email = b.email                 
      FROM   emp_info b                 
      WHERE  user_login.email = ''                 
             AND user_login.username = b.emp_no                 
              
              
      INSERT INTO emp_info                 
                 (emp_no,                 
                  emp_name,                 
                  email,                 
                  status,                 
                  LEVEL,                 
                  categorydesc,                 
                  department,                 
                  sub_department,                 
                  designation,                 
                  pin,                 
                  senior)                 
      SELECT emp_no = 'Mindgate',                 
             emp_name = 'Mindgate',                 
             email = 'mindgate.support@angeltrade.com',                 
             status,                 
             LEVEL,                 
             categorydesc,                 
             department,                 
             sub_department,                 
             designation,                 
             '',                 
             'E23266'                 
      FROM   emp_info                 
      WHERE  emp_no = 'e05205'                 
      
       
 update user_login set status=1 where username='N00006'              
            
 /* update emp_info set senior='e01089',sr_name='Manesh Mukherjee' where emp_no='e02031' */           
 /* update emp_info set senior='e01089',sr_name='Manesh Mukherjee' where emp_no='e05205' */   
 /*update emp_info set senior='e01089',sr_name='Manesh Mukherjee' where emp_no='E16003'  */     
      
             
 begin tran         
 update user_login set email=b.email from emp_info b        
 where user_login.username=b.emp_no        
 and isnull(user_login.email,'')<>isnull(b.email,'')        
 and user_login.status=1        
        
 commit tran         
   END 
   
   
   
   
   select * from user_login where username='N00006'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_user_login
-- --------------------------------------------------
CREATE procedure [dbo].[upd_user_login]              
as               
insert into user_login               
    
(person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedOn,LastModifiedBy,            


LastModifiedOn)              
    
select emp_name,emp_no,dbo.random_password(8,''),'ADMIN',              
access_To=(Case when Branch_cd='HO' then 'BROKER' else 'BRANCH' end),              
access_code=(Case when Branch_cd='HO' then 'CSO' else branch_cd end),              
cat_code=(Case when Branch_cd='HO' then 426 else 428 end)  ,    
(case when b.ip is not null then 1 else 0 end),          
--null,0,0,getdate(),getdate()+30,'Y',email,          
null,0,0,getdate(),getdate()+365,'Y',email,  
b.ip,          
'Y','','N',null,'System',convert(varchar(25),getdate()),Null,null              
from risk.dbo.emp_info a (nolock)           
left outer join          
(select branch,ip=max(ip_range) from intranet.risk.dbo.branch_ip_range group by branch )b          
 on a.branch_cd=b.branch              
where emp_no not in (select username from user_login (nolock)) and status='A'              
and isnull(costcode,'') <> ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_EMP_INFO
-- --------------------------------------------------
  
/******************************************************************************      
CREATED BY: RUTVIJ PATIL      
DATE: 10/03/2011      
PURPOSE: USE TO TRUNCATE DATA FROM 245 ROLEMGM EMP_INFO      
  AND INSERT IT FROM 132 RISK EMP_INFO      
      
MODIFIED BY: PROGRAMMER NAME      
DATED: DD/MM/YYYY      
REASON: REASON TO CHANGE STORE PROCEDURE      
******************************************************************************/      
  
CREATE PROCEDURE UPDATE_EMP_INFO  
  
AS  
BEGIN  
  
	BEGIN TRANSACTION
	
	BEGIN TRY
		
		TRUNCATE TABLE ROLEMGM.DBO.EMP_INFO  
		INSERT INTO ROLEMGM.DBO.EMP_INFO  
		SELECT * FROM INTRANET.RISK.DBO.EMP_INFO  
		COMMIT TRANSACTION
		
	END TRY
	
	BEGIN CATCH
	
		ROLLBACK TRANSACTION
	
	END CATCH
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.user_details_inhouse
-- --------------------------------------------------
CREATE procedure [dbo].[user_details_inhouse] (@username as varchar(15),@session_id as varchar(30))  
as  
begin  
 declare @cnt as varchar(10)
set @cnt=0
select username,session_id,email,timestamp=GETDATE() from user_login (nolock)  
where username=@username and session_id=@session_id 

select @cnt=count(username) from user_login (nolock)  
where username=@username and session_id=@session_id 
group by username 
 
if @cnt<>0
begin 
select  * from vw_uer_login (nolock)   
where username=@username  
end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UserAccessShift
-- --------------------------------------------------

CREATE Procedure [dbo].[UserAccessShift](@FromUSer as varchar(10),@ToUser as varchar(10),@user as varchar(10),@flag as int,@RetainYN as char(1))    
as    
set nocount on    
    
if @flag=1     
Begin    
    
select     
'Requested to Transfer Access of <br><br>User: '+a.username+' '+a.person_name+' having Access of :'+a.Access_to+'-'+a.access_code+'<br><Br> To <Br><br>'+b.username+' '+b.person_name+' having Access of :'+b.Access_to+'-'+b.access_code+    
(CAse when @RetainYN='Y' then '<br>(<U>RETAIN</u> existing option for user:'+b.username+')' else '<br>(<U>DO NOT RETAIN</U> existing option.)' end)
as Stat    
from    
(select username,person_name,Access_to,Access_code from user_login with (nolock) where username=@FromUSer) a,    
(select username,person_name,Access_to,Access_code from user_login with (nolock) where username=@ToUser) b     
    
End    
    
if @flag=2     
BEGIN    
 if(select COUNT(1) from user_login where username=@FromUser) = 1 and  (select COUNT(1) from user_login where username=@ToUser) = 1     
 begin    
  declare @NuCatCode as int,@Nu_Status as int,@NuExtraCnt as int,@NuExcluCnt as int,@ExExtraCnt as int,@ExExcluCnt as int,@ToUserCatCode as int    
    
  select username,status,cat_Code into #f1 from user_login where username=@FromUser    
  select * into #f2 from EXTRA_CAT_MAPPING where emp_no=@FromUser    
  select * into #f3 from Exclude_CAT_MAPPING where emp_no=@FromUser    
    
  select @Nu_Status=status,@NuCatCode=Cat_Code from #f1    
  select @NuExtraCnt=count(1) from #f2    
  select @NuExcluCnt=count(1) from #f3    
  select @ExExtraCnt=count(1) from EXTRA_CAT_MAPPING where emp_no=@ToUser    
  select @ExExcluCnt=count(1) from Exclude_CAT_MAPPING where emp_no=@ToUser    
  select @ToUserCatCode=cat_code from user_login where username=@ToUser    
    
  if @RetainYN='N'
  Begin  
	delete from EXTRA_CAT_MAPPING where emp_no=@ToUser    
	delete from Exclude_CAT_MAPPING where emp_no=@ToUser    
  End
  if @RetainYN='Y'
  Begin  
	insert into EXTRA_CAT_MAPPING(EMP_NO,MENU_CODE,MAPPED_BY,MAPPED_ON) 
	select @ToUser,menu_code,@user,GETDATE() from cat_mapping with (nolock) where cat_Code=(select cat_Code from user_login where username=@ToUser)
  End
  
  update user_login set cat_code=@NuCatCode,LastModifiedby=@user,LastModifiedOn=GETDATE() where username=@ToUser    
  insert into EXTRA_CAT_MAPPING select @ToUser,menu_code,@user,GETDATE() from #f2    
  insert into Exclude_CAT_MAPPING select @ToUser,menu_code,@user,GETDATE() from #f3    
    
  insert into UserAccessShiftLog(FromUSer,FromUser_CatCode,FromUSer_Status,FromUSer_Extra_cnt,FromUSer_Exclu_cnt,ToUSer,ToUser_PrevCatCode,ToUser_NewCatCode,ToUser_PrevExtraCnt,ToUser_PrevExcluCnt,UpdatedDate,Updatedby,RetainYN )    
  select @FromUSer,@NuCatCode,@Nu_Status,@NuExtraCnt,@NuExcluCnt,@ToUser,@ToUserCatCode,@NuCatCode,@ExExtraCnt,@ExExcluCnt,GETDATE(),@user,@RetainYN     
     
  select 'Access Successfully Transfered from User:'+@fromuser+' to:'+@touser+'.'+
  (CAse when @RetainYN='Y' then '<br><U>RETAINED</u> existing option' else '<br><U>NOT RETAINED</U> existing option.' end)
   as stat    
 end    
 else    
 begin    
  select 'Either From User or To User does not exists. Please enter Valid input' as stat    
 end    
END    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UserAccessShift_30072016
-- --------------------------------------------------

Create Procedure [dbo].[UserAccessShift_30072016](@FromUSer as varchar(10),@ToUser as varchar(10),@user as varchar(10),@flag as int,@RetainYN as char(1))    
as    
set nocount on    
    
if @flag=1     
Begin    
    
select     
'Requested to Transfer Access of <br><br>User: '+a.username+' '+a.person_name+' having Access of :'+a.Access_to+'-'+a.access_code+'<br><Br> To <Br><br>'+b.username+' '+b.person_name+' having Access of :'+b.Access_to+'-'+b.access_code+    
(CAse when @RetainYN='Y' then '<br>(<U>RETAIN</u> existing option for user:'+b.username+')' else '<br>(<U>DO NOT RETAIN</U> existing option.)' end)
as Stat    
from    
(select username,person_name,Access_to,Access_code from user_login with (nolock) where username=@FromUSer) a,    
(select username,person_name,Access_to,Access_code from user_login with (nolock) where username=@ToUser) b     
    
End    
    
if @flag=2     
BEGIN    
 if(select COUNT(1) from user_login where username=@FromUser) = 1 and  (select COUNT(1) from user_login where username=@ToUser) = 1     
 begin    
  declare @NuCatCode as int,@Nu_Status as int,@NuExtraCnt as int,@NuExcluCnt as int,@ExExtraCnt as int,@ExExcluCnt as int,@ToUserCatCode as int    
    
  select username,status,cat_Code into #f1 from user_login where username=@FromUser    
  select * into #f2 from EXTRA_CAT_MAPPING where emp_no=@FromUser    
  select * into #f3 from Exclude_CAT_MAPPING where emp_no=@FromUser    
    
  select @Nu_Status=status,@NuCatCode=Cat_Code from #f1    
  select @NuExtraCnt=count(1) from #f2    
  select @NuExcluCnt=count(1) from #f3    
  select @ExExtraCnt=count(1) from EXTRA_CAT_MAPPING where emp_no=@ToUser    
  select @ExExcluCnt=count(1) from Exclude_CAT_MAPPING where emp_no=@ToUser    
  select @ToUserCatCode=cat_code from user_login where username=@ToUser    
    
  if @RetainYN='N'
  Begin  
	delete from EXTRA_CAT_MAPPING where emp_no=@ToUser    
	delete from Exclude_CAT_MAPPING where emp_no=@ToUser    
  End
  if @RetainYN='Y'
  Begin  
	insert into EXTRA_CAT_MAPPING(EMP_NO,MENU_CODE,MAPPED_BY,MAPPED_ON) 
	select @ToUser,menu_code,@user,GETDATE() from cat_mapping with (nolock) where cat_Code=(select cat_Code from user_login where username='E01089')
  End
  
  update user_login set cat_code=@NuCatCode,LastModifiedby=@user,LastModifiedOn=GETDATE() where username=@ToUser    
  insert into EXTRA_CAT_MAPPING select @ToUser,menu_code,@user,GETDATE() from #f2    
  insert into Exclude_CAT_MAPPING select @ToUser,menu_code,@user,GETDATE() from #f3    
    
  insert into UserAccessShiftLog(FromUSer,FromUser_CatCode,FromUSer_Status,FromUSer_Extra_cnt,FromUSer_Exclu_cnt,ToUSer,ToUser_PrevCatCode,ToUser_NewCatCode,ToUser_PrevExtraCnt,ToUser_PrevExcluCnt,UpdatedDate,Updatedby,RetainYN )    
  select @FromUSer,@NuCatCode,@Nu_Status,@NuExtraCnt,@NuExcluCnt,@ToUser,@ToUserCatCode,@NuCatCode,@ExExtraCnt,@ExExcluCnt,GETDATE(),@user,@RetainYN     
     
  select 'Access Successfully Transfered from User:'+@fromuser+' to:'+@touser+'.'+
  (CAse when @RetainYN='Y' then '<br><U>RETAINED</u> existing option' else '<br><U>NOT RETAINED</U> existing option.' end)
   as stat    
 end    
 else    
 begin    
  select 'Either From User or To User does not exists. Please enter Valid input' as stat    
 end    
END    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_access_level
-- --------------------------------------------------
CREATE PROCEDURE usp_access_level             
(        
@aceess_to as varchar(50))                       
 as        
        
/*        
declare @aceess_to as varchar(50)        
set @aceess_to ='branch'           
*/        
                          
set nocount on                                 
set transaction isolation level read uncommitted                                          
                 
select Access_level_value,Access_level_name from access_level (nolock) where access_level_Code >=                 
(select access_level_Code from access_level (nolock) where access_level_value=@aceess_to )                
and access_level_active=1  and access_level_code > 0   and access_level_value not in ('RGMAST','ZNMAST')    
order by access_level_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AccessAsExtCode
-- --------------------------------------------------
CREATE proc usp_AccessAsExtCode
(  
    @SrcMenuCode varchar(20),  
    @DesMenuCode varchar(20),  
    @MappedBy varchar(20)  
)  
as  
begin  
set nocount on;  
    declare @Cnt as int  
----Check Both Menu have same access level  
    Select @Cnt=Count(*) from  
    (  
        (Select * from menu_item where menu_code=@SrcMenuCode and [Active]='Y') a inner join  
        (Select * from menu_item where menu_code=@DesMenuCode and [Active]='y') b  
            on a.applicable_to=b.applicable_to  
 
    )  
    if @Cnt<>0  
    begin  
        select 'Y'  
        ---Strat For Category mapping  
        Select emp_no=a.username,menu_code=@DesMenuCode,Mapped_by=@MappedBy+'+System',Mapped_On=getdate()
            from user_login a  inner join cat_mapping b
        on a.Cat_code=b.cat_Code
        where a.[status]=1 and b.menu_code=@SrcMenuCode 
        ----End  
  
        ---Strat For Extra catgory mapping  
        select emp_no,menu_code=@DesMenuCode,mapped_by=@MappedBy+'+System',mapped_on=getdate()
        from extra_cat_mapping   
        where  menu_code=@SrcMenuCode
        ---End  
    end  
    else  
    begin  
        select 'N'  
    end  
set nocount off;  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AccessAsExtUser
-- --------------------------------------------------
CREATE proc usp_AccessAsExtUser
(
    @SrcEmpCode varchar(20),
    @DesEmpCode varchar(20),
    @MappedBy varchar(20)
)
as
begin
set nocount on;
    declare @Cnt as int
----Check Both user have same access level
    Select @Cnt=Count(*) from
    (
        (Select * from user_login where username=@SrcEmpCode and [status]=1) a inner join
        (Select * from user_login where username=@DesEmpCode and [status]=1) b
            on a.access_code=b.access_code
            and a.access_to=b.access_to
    )
    if @Cnt<>0
    begin
        select 'Y'
        ---Strat For Category mapping
        declare @CatCode as int
        Select @CatCode=Cat_code from user_login where username=@SrcEmpCode
        /*update user_login set Cat_code=@CatCode,
        LastModifiedBy=@MappedBy,LastModifiedOn=getdate() where username=@DesEmpCode*/
        ----End

        ---Strat For Extra catgory mapping
        /*--delete from extra_cat_mapping where emp_no=@DesEmpCode
        --insert into extra_cat_mapping*/
        select EMP_NO=@DesEmpCode,menu_code,mapped_by=@MappedBy+' +System',mapped_on=getdate()
        from extra_cat_mapping where emp_no=@SrcEmpCode
        and menu_code not in (select menu_code from extra_cat_mapping where emp_no=@DesEmpCode)
        ---End
    end
    else
    begin
        select 'N'
    end
set nocount off;
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AMD_OFRA_Sub_broker
-- --------------------------------------------------





CREATE PROCEDURE usp_AMD_OFRA_Sub_broker

AS

BEGIN 



TRUNCATE TABLE OFRA_Sub_broker



INSERT INTO OFRA_Sub_broker

	SELECT UL.access_code FROM [MIS].SB_Comp.dbo.sb_broker SB

	inner join rolemgm.dbo.user_login UL

	ON UL.access_code=SB.SBTAG

	WHERE Branch='OFRA'

	--and login_inactive_date>getdate()

	--and status=1







END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AuthenticateLogin_NXTMobileApp
-- --------------------------------------------------




--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'







--EXEC [Prc_AuthenticateLogin_DealerAlso] 'HOCBHO','e6e263np'  



CREATE PROCEDURE [dbo].[USP_AuthenticateLogin_NXTMobileApp]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN





--IF @USERNAME='Excellent'

--BEGIN 

--		Set @USERNAME='HOET'

--		Select @PASSWORD=userpassword from ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

--END



DECLARE @ACCESS_CODE AS VARCHAR(50)=''

 DECLARE @BRANCH VARCHAR(50)=''





 if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME)>0

BEGIN



		exec [dbo].[Prc_AuthenticateLogin_Dealer] @USERNAME,@PASSWORD

end

ELSE 

BEGIN











IF (@PASSWORD='@SkipPWD')

BEGIN

 

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE())>0

	BEGIN

	

 

	    DECLARE @NOTID AS VARCHAR(MAX)=''



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 





		SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

	    SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



	--addon on 30052018

		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

	--END

		

		SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH,userpassword FROM USER_LOGIN WHERE USERNAME =@USERNAME and usertype<>'USER'



	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

			SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END

ELSE

BEGIN



IF(SELECT COUNT(1) FROM USER_LOGIN UL

--INNER JOIN Mimansa.dbo.tbl_Emp_Master EM ON UL.access_code=EM.Sb_Tag

 WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE()

 

 )>0









	BEGIN

	



	    

--COLLATE SQL_Latin1_General_CP1_CS_AS 

		--SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [196.1.115.132].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		--JOIN(SELECT MAX(ID) AS MAXID FROM [196.1.115.132].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		--ON A.ID=B.MAXID 





		--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

		--UNION

		--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A





		 

	     DECLARE @CNT AS INT =0

	     --Added by Sandeep on 16 May 2018 to get the branch

	    

	     

	     

	     --Ended by Sandeep 



	     SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

	     SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



	     SELECT @CNT=COUNT(1) FROM [CSOKYC-6].FRANCHISEE.DBO.FRANCHISEE_MAST WITH(NOLOCK) WHERE TODATE>=GETDATE() AND FTAG=@ACCESS_CODE

	     

	    -- set @CNT=0

	     

	      



		SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO. TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)A

		JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

		ON A.ID=B.MAXID 





		

		SELECT 1 AS ID, PERSON_NAME AS NAME,CASE WHEN @CNT<>0 THEN 'FRANCHISEE' ELSE [USERTYPE] END as USERTYPE ,

		ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME,@NOTID as DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT,@BRANCH AS BRANCH   

		FROM USER_LOGIN with(nolock) 

		WHERE USERNAME =@USERNAME 

		AND (ACCESS_TO = (case when @CNT=0 THEN 'SB'  ELSE 'BRANCH' END) or ACCESS_TO = (case when @CNT=0 THEN 'SBMAST'  ELSE 'BRANCH' END))

		--AND ACCESS_TO =CASE WHEN @CNT=0 THEN 'SB' ELSE 'BRANCH' END

		

		------AND (usertype='ADMIN' or username='EMT')

		--and (usertype='ADMIN' --or username in (select name from [172.31.16.95].nxt_admin.dbo.UserMaster with (nolock))

		and ((usertype='ADMIN' and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG]))

		or username in (select username from TempUserMaster  with(nolock))

		)

		--and access_code not in (select sbtag from mis.sb_comp.dbo.sb_broker where SB_Broker_Type='MF' and Branch='MFSB')

		--and access_code in  (select sbtag  From [196.1.115.167].sb_comp.dbo.sb_broker where isnull(SB_Broker_Type,'')='MF' and branch!='MFSB') 

		and access_code not in (select sbtag from [MIS].sb_comp.dbo.VW_ONLY_MF_TAG)   --Commented for 167 down

        and access_code not in (select * from risk.dbo.[tbl_DRA_SBTAG])

		and access_code not in (select * from dbo.OFRA_Sub_broker)				

		union



		SELECT 

		1 ID	

		,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE	

		--,'Dealer' USERTYPE	

		,'Dealer' ACCESS_TO	

		,sb_tAG ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			IF(SELECT COUNT(*) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME AND USERPASSWORD=@PASSWORD AND STATUS=0)>0

			BEGIN 

			SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			END

			ELSE 

			BEGIN

					IF EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@USERNAME)

					BEGIN

						IF NOT EXISTS(SELECT * FROM ROLEMGM.DBO.USER_LOGIN WITH(NOLOCK) WHERE USERPASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			END



	END



END





end



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_bank_master
-- --------------------------------------------------
CREATE procedure [dbo].[usp_bank_master]
(@accno_u as varchar(5),@accno as varchar(25),@seg as varchar(25),@CMSVerifier as varchar(1))
as
if(@accno_u='')
begin
insert into bank_Accno (accno,segment,CMSVerifier) values(@accno,@seg,@CMSVerifier)
end
else 
begin
update bank_Accno set accno=@accno_u,CMSVerifier=@CMSVerifier where  ACCNO = @accno
end


select * from cat_menu where cat_name like '%IT%'
select noc=count(*) from bank_Accno where accno='132' and segment='ABLCM'

commit tran
select * from bank_Accno where accno='123'
select * from intranet.risk.dbo.bank_Accno

select * from user_login where username like 'E15318'

commit tran
update user_login set userpassword='123'where username like 'E15318'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BeeNXT_Login_Dealer_NXT_2_Mobile
-- --------------------------------------------------



--EXEC PRC_AUTHENTICATELOGIN 'FB','patel444'







--EXEC [Prc_AuthenticateLogin_Dealer] 'ET002','YR26ECQ7'  



CREATE PROCEDURE [dbo].[USP_BeeNXT_Login_Dealer_NXT_2_Mobile]

(

@USERNAME VARCHAR(50),

@PASSWORD VARCHAR(50)

)

AS

BEGIN



/*



		exec [dbo].[Prc_AuthenticateLogin_Dealer_19March21_Changes] 'CBHO001','@SkipPWD'





*/





DECLARE @ACCESS_CODE AS VARCHAR(50)=''

 DECLARE @BRANCH VARCHAR(50)=''



	IF(SELECT COUNT(*) fROM Mimansa.dbo.tbl_Emp_Master A

	left join Mimansa.dbo.tbl_Emp_Suspension_Termination B

	ON A.Emp_No=B.Emp_no

		where User_ID=@USERNAME

		and ((A.isSuspended	=1 or A.isTerminated=1)

		or (B.Suspension_Date<getdate() or B.Termination_Date<=getdate()))

		

		)>0

			BEGIN 

			SELECT @USERNAME +' '+ 'Employee Terminated' AS MESSAGE,0 AS RESULT

			Return

			END





IF (@PASSWORD='@SkipPWD')

BEGIN

 

		IF(SELECT COUNT(1) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME )>0

			BEGIN

	

 

				DECLARE @NOTID AS VARCHAR(MAX)=''



				SELECT @NOTID= A.NOTIFICATIONID FROM (SELECT * FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION with(nolock) WHERE USERID=@USERNAME)A

				JOIN(SELECT MAX(ID) AS MAXID FROM [INTRANET].RISK.DBO.TBL_MOB_NOTIFICATION WHERE USERID=@USERNAME)B

				ON A.ID=B.MAXID 





				SELECT @ACCESS_CODE=ACCESS_CODE FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME

				SET @BRANCH=(SELECT TOP 1 BRANCH_CD FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK) WHERE SUB_BROKER=@ACCESS_CODE)



			--addon on 30052018

				--SELECT TOP 1 *,@NOTID AS DEVICEID,'SUCCESS' AS MESSAGE,1 AS RESULT FROM (SELECT 1 AS ID, EMP_NAME AS NAME,'ADMIN' AS USERTYPE,'EMPLOYEE' AS ACCESS_TO,COSTCODE AS ACCESS_CODE,EMAIL,EMP_NO AS USERNAME   FROM RISK.DBO.EMP_INFO WHERE EMP_NO =@USERNAME

				--UNION

				--SELECT 2 AS ID, PERSON_NAME AS NAME,USERTYPE ,ACCESS_TO,ACCESS_CODE,EMAIL,USERNAME FROM USER_LOGIN WHERE USERNAME =@USERNAME)A

			--END

		

				SELECT 2 AS ID,emp_name AS NAME,'QR' USERTYPE ,'Mobile' ACCESS_TO,sb_tag ACCESS_CODE,EMAIL,USER_id UserName,@NOTID AS DEVICEID, 'SUCCESS' AS MESSAGE,1 AS 'public int Result',@BRANCH AS BRANCH,password userpassword

				FROM Mimansa.dbo.tbl_Emp_Master WHERE USER_id =@USERNAME --and usertype<>'USER'





				--Name,UserType,Access_to,Access_code,Email,UserName,DeviceId,Message,public int Result,Branch,userpassword 





			END

			--ELSE 

			--BEGIN

			--		IF(SELECT COUNT(*) FROM Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME AND USERPASS)>0

			--		BEGIN 

			--		SELECT 'LOGIN DEACTIVATED' AS MESSAGE,0 AS RESULT

			--		END

			--		ELSE 

			--		BEGIN

			--		SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			--		END



			--END



END

ELSE

begin

















if  (select COUNT(1) from [INTRANET].Mimansa.dbo.tbl_Emp_Master where USER_ID=@USERNAME and  Password=@PASSWORD)>0

BEGIN



		SELECT 

		1 ID	

		,Case isnull(First_name,'') when '' then Emp_Name 

		else First_Name +' '+ Middle_Name+' '+Last_Name end as Name

		-- ,First_Name +' '+ Middle_Name+' '+Last_Name NAME	

		--,CASE WHEN isAdmin=1 THEN 'Admin' ELSE 'Dealer' END USERTYPE

		,'Dealer'  USERTYPE	

		,'Dealer' ACCESS_TO	

		,User_ID ACCESS_CODE	

		,'' EMAIL	

		,User_ID USERNAME	

		,IP DEVICEID	

		,'Success' MESSAGE	

		,1 RESULT	

		,cITY BRANCH

		fROM Mimansa.dbo.tbl_Emp_Master

		where User_ID=@USERNAME

		and (isSuspended	=0 or isTerminated=0)

		and Password=@PASSWORD







		--AND (

		--usertype='ADMIN' or 

		--username in ('EMT','ET','ETPF','GDS','RROO','SSSUR','EEEA','SHAY','AKAW','NAAJ','PALC','MUUV','SUVJ','MOAU','GGJV','SIMI','CNBC','AIF','HIN','ICFS','NK','RRGG','SIFA','THST'

		--,'AAGI','AAYJ','AFPR','AICT','AKFI','AKHL','ALC','ALHG','ASHN','BBUP','RVO','DHPA','ANMO','BRIG','DHMU'

		--,'VAHA','CCCR','SUSY','HHAJ','PRPW','DDHB','SHRQ','VIAI','JJHH','SBRB','FB'

		--)

		--)

		

	END

	ELSE 

	BEGIN

			

					IF (SELECT count(*) FROM Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE User_ID=@USERNAME)>0

					BEGIN

						IF NOT EXISTS(SELECT * FROM [INTRANET].Mimansa.dbo.tbl_Emp_Master  WITH(NOLOCK) WHERE PASSWORD=@PASSWORD)

						BEGIN

							SELECT 'Kindly enter valid password!' AS MESSAGE,0 AS RESULT	

						END	

					END

					ELSE

					BEGIN

					        SELECT 'Kindly enter valid userid!' AS MESSAGE,0 AS RESULT	

					END

					

					--SELECT 'Invalid credential!' AS MESSAGE,0 AS RESULT

			

	end



end



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_BeeNXTSubbrokerMail
-- --------------------------------------------------
CREATE Procedure usp_BeeNXTSubbrokerMail
(
	@AdminUser Varchar(100)
	,@pswd Varchar(100)
	,@sbcd Varchar(100)
	,@Name Varchar(100)
	,@recipients Varchar(100)
	,@blind_copy_recipients Varchar(100) =NULL
)
AS
--Declare @AdminUser Varchar(100)
--Declare @pswd Varchar(100)
--Declare @sbcd Varchar(100)
--Declare @Name Varchar(100)
--Declare @EmployeePassword Varchar(100)

BEGIN


--EXEC usp_BeeNXTSubbrokerMail @AdminUser='Yogesh1',@pswd='Yogesh1',@sbcd='Yog',@Name='Yogesh',@recipients='Yogesh.rewatkar@angelbroking.com'

--Select @AdminUser='Yogesh1',@pswd='Yogesh1',@sbcd='Yog',@Name='Yogesh'


DECLARE @HTMLBODY varchar(max)

set @HTMLBODY='

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>



<div>
<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
  <tbody>
    <tr>
      <td align="center" style="vertical-align:top;padding:0px 0px 0px 0px">
        <img src="http://web.angelbackoffice.com/angelbroking/econnect/welcome-mail/logo.jpg" style="display:block">
      </td>
      
    </tr>
    <tr>
    	<td align="center" style="vertical-align:top">
			<img src="http://web.angelbackoffice.com/angelbroking/econnect/welcome-mail/welcome-banner.jpg" style="display:block">
		  </td>
    </tr>
  </tbody>
</table>


<table align="center" cellpadding="0" cellspacing="0" style="min-width:620px;border:solid 1px #ddd;color:#2d2d2d" width="620px">
<tbody>
	<tr>
		<td>
			<table align="center" cellpadding="0" cellspacing="0" style="min-width:620px;padding:40px 25px;color:#2d2d2d" width="620px">
	<tbody>
		<tr>
		  <td align="left" style="vertical-align:top;font-family:&#39;Open Sans&#39;,arial,sans-serif;font-weight:bold;padding-bottom:15px;font-size:16px">
			Dear '+@Name+',
		  </td>
		  
		</tr>
		<tr>
			<td align="left" style="vertical-align:top;font-size:16px;font-family:&#39;Open Sans&#39;,arial,sans-serif;font-size:16px">
			Please find your user id and password for login in BEE NXT Platform - Next Generation Business Platform

		  </td>
		</tr>
		
	</tbody>
</table>
		</td>
	</tr>
	
	<tr>
		<td>
			<table align="center" cellpadding="0" cellspacing="0" style="display:block;margin:auto;padding:10px 25px;border:solid 1px #ddd;color:#2d2d2d" width="333px">
	<tbody style="width:100%;display:block">
		<tr style="width:100%;display:block">
			<td style="font-family:&#39;Open Sans&#39;,arial,sans-serif;font-size:16px">
				Link - <a style="color:#0080c1">beenxt.angelbroking.com</a>
			</td>
			
		</tr>
		<tr style="height:1px;display:block;width:100%;border-top:solid 1px #b7b7b7;margin-top:10px"></tr>
		
		<tr>
			<td style="font-family:&#39;Open Sans&#39;,arial,sans-serif;padding:10px 0"><span style="font-weight:bold;color:#2d2d2d;font-size:16px">Admin login id:</span>      '+@AdminUser+'</td>
		</tr>
		<tr>
			<td style="font-family:&#39;Open Sans&#39;,arial,sans-serif;padding:10px 0"><span style="font-weight:bold;color:#2d2d2d;font-size:16px">Admin password:</span>  '+@pswd+'</td>
		</tr>
		
		<tr style="height:1px;display:block;width:100%;border-top:dashed 1px #b7b7b7;margin-top:10px"></tr>
		
		<tr>
			<td style="font-family:&#39;Open Sans&#39;,arial,sans-serif;padding:10px 0"><span style="font-weight:bold;color:#2d2d2d;font-size:16px">Employee login id:</span>      '+@sbcd+'</td>
		</tr>
		<tr>
			<td style="font-family:&#39;Open Sans&#39;,arial,sans-serif;padding:10px 0"><span style="font-weight:bold;color:#2d2d2d;font-size:16px">Employee password:</span>  '+@pswd+'</td>
		</tr>
	</tbody>
</table>
		</td>
	</tr>
	
	<tr>
		<td>
			<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px;font-family:&#39;Open Sans&#39;,arial,sans-serif;padding:40px 25px;color:#2d2d2d;font-size:16px" width="620px">
	<tbody>
		<tr>
			<td style="font-size:16px">
				Should you require any further clarification, <br> please do call us on (Direct): 30817400 <br> between 10:00 am to 6:00 pm on all trading days and 10:00 am to 4:00 pm on Saturdays or you could also e-mail us at <a href="mailto:mfsd@angelbroking.com" target="_blank">mfsd@angelbroking.com</a>
			</td>
			
			
		</tr>
		<tr>
			<td style="margin:20px 0;display:block">
				
Assuring of our personalized services at all times.


			</td>
		</tr>
		<tr>
			<td>
				Best Regards, <br>
<span style="font-weight:bold">Angel Team</span>
			</td>
		</tr>
	</tbody>
</table>
		</td>
	</tr>
</tbody>
	</table>







<table align="center" width="620" border="0" cellspacing="0" cellpadding="0" style="background-color:#d6d6d6">
  <tbody>
    
    <tr>
      <td align="left" valign="top"><table width="580" border="0" align="center" cellpadding="0" cellspacing="0">
        
      </table></td>
    </tr>
    <tr>
      <td align="left" valign="top"><table width="580" border="0" align="center" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/divider.jpg" width="578" height="34" alt=""></td>
          </tr>
        </tbody>
      </table></td>
    </tr>
    <tr>
      <td align="left" valign="top"><table width="580" border="0" align="center" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td height="70"><table width="173" height="51" border="0" align="left" cellpadding="0" cellspacing="0">
              <tbody>
                <tr>
                  <td align="left" valign="middle"><table width="173" border="0" align="left" cellpadding="0" cellspacing="0">
                    <tbody>
                      <tr>
                        <td width="45" align="left" valign="top"><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/call.jpg" width="38" height="38" alt=""></td>
                        <td align="left" valign="middle"><table width="100%" border="0" cellspacing="0" cellpadding="0">
                          <tbody>
                            <tr>
                              <td height="18" align="left" valign="top" style="font-family:&#39;Arial&#39;,sans-serif;font-size:13px;color:#6e6e6e;text-transform:uppercase;font-weight:normal"> 022-30817400</td>
                              </tr>
                            <tr>
                              <td height="18" align="left" valign="bottom" style="font-family:&#39;Arial&#39;,sans-serif;font-size:13px;color:#6e6e6e;text-transform:uppercase;font-weight:normal">022-4218 5454</td>
                              </tr>
                            </tbody>
                          </table></td>
                        </tr>
                      </tbody>
                    </table></td>
                  </tr>

                </tbody>
              </table>
              <table width="8" border="0" align="left" cellpadding="0" cellspacing="0">
                <tbody>
                  <tr>
                    <td><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/divider-line.jpg" width="8" height="51" alt=""></td>
                    </tr>
                  </tbody>
  </table>
  <table width="173" height="51" border="0" align="left" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td align="left" valign="middle"><table width="130" border="0" align="center" cellpadding="0" cellspacing="0">
          <tbody>
            <tr>
              <td width="45" align="left" valign="top"><a href="http://www.angelbroking.com/?utm_source=newsletter&amp;utm_medium=email" target="_blank"><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/monitor.jpg" width="38" height="38" alt=""></a></td>
              <td align="left" valign="middle"><table width="100%" border="0" cellspacing="0" cellpadding="0">
                <tbody>
                  <tr>
                    <td height="18" align="left" valign="top" style="font-family:&#39;Arial&#39;,sans-serif;font-size:13px;color:#6e6e6e;text-transform:normal;font-weight:normal">Visit Website</td>
                    </tr>
                  </tbody>
                </table></td>
              </tr>
            </tbody>
          </table></td>
        </tr>
      </tbody>
    </table>
              <table width="8" border="0" align="left" cellpadding="0" cellspacing="0">
                <tbody>
                  <tr>
                    <td><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/divider-line.jpg" width="8" height="51" alt=""></td>
                    </tr>
                  </tbody>
                </table>
              <table width="200" height="51" border="0" align="left" cellpadding="0" cellspacing="0">
                <tbody>
                  <tr>
                    <td align="left" valign="middle"><table width="180" border="0" align="center" cellpadding="0" cellspacing="0">
                      <tbody>
                        <tr>
                          <td width="45" align="center" valign="middle"><a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/facebook.jpg" width="38" height="38" alt=""></a></td>
                          <td width="45" align="center" valign="middle"><a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/twitter.jpg" width="38" height="38" alt=""></a></td>
                          <td width="45" align="center" valign="middle"><a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/youtube.jpg" width="38" height="38" alt=""></a></td>
                          <td width="45" align="center" valign="middle"><a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/linkedin.jpg" width="38" height="38" alt=""></a></td>
                          </tr>
                        </tbody>
                      </table></td>
                    </tr>
                  </tbody>
                </table>
              </td>
          </tr>
          <tr>
            <td><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/divider.jpg" width="578" height="15" alt=""></td>
          </tr>
          <tr>
            <td height="35" align="center" valign="middle"><table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tbody>
                <tr>
                  <td height="20" align="center" valign="middle" style="font-family:&#39;Arial&#39;,sans-serif;font-size:12px;color:#666666;text-transform:normal;font-weight:normal">For any feedback or queries please mail us at <a style="color:#666666" href="mailto:mfsd@angelbroking.com" target="_blank">mfsd@angelbroking.com</a></td>
                </tr>
              </tbody>
            </table></td>
          </tr>
        </tbody>
      </table></td>
    </tr>
    <tr>
      <td align="center" valign="top"><table width="580" border="0" align="center" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td><img src="http://web.angelbackoffice.com/angelbroking/econnect/footer/images/divider.jpg" width="578" height="15" alt=""></td>
          </tr>
        </tbody>
      </table></td>
    </tr>
    <tr>
      <td align="center" valign="top"><table width="580" border="0" align="center" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td align="center" valign="middle" style="font-family:&#39;Arial&#39;,sans-serif;font-size:10px;color:#999999;text-transform:normal;font-weight:normal">Angel Broking Private Limited, Registered Office: G-1, Ackruti Trade Center, Road No. 7, MIDC, Andheri (E), Mumbai - 400 093. Tel: (022) 3083 7700. Fax: (022) 2835 8811, website: <a href="http://www.angelbroking.com/" style="color:#999999" target="_blank">www.angelbroking.com</a>, CIN: U67120MH1996PTC101709, SEBI Regn. No.: INZ000161534-BSE Cash/F&amp;O/CD, NSE Cash/F&amp;O/CD, MSEI CD, CDSL Regn. No.: IN - DP - CDSL - 234 -- 2004, PMS Regn. Code: PM/INP000001546, Research Analyst SEBI Regn. No. INH000000164, AMFI Regn. No. ARN â 77404. Investment Adviser SEBI Regn. no. INA000008172, Compliance officer: Ms. Namita Godbole, Tel: (022) 39413940, Email: <a href="http://mailto" style="color:#999999" target="_blank">compliance@angelbroking.com</a>. Angel Commodities Broking Private Ltd. Compliance Officer, Ms. Namita Godbole, SEBI Regn No.: INZ000042935, MCX Member ID:12685 and NCDEX: Member ID 00220 </td>
          </tr>
          </tbody>
      </table></td>
    </tr>
    <tr>
      <td align="center" valign="top"> </td>
    </tr>
  </tbody>
</table>
</div>

</body></html>
'



Print @HTMLBODY

	EXEC msdb.dbo.sp_send_dbmail  
		@profile_name = 'BeeNXT',  
		@recipients=@recipients,
		@blind_copy_recipients='Yogesh.rewatkar@angelbroking.com',
		@subject = 'Welcome to Angel family',  
		@body = @HTMLBODY,
		@body_format = 'HTML'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_cat_disp_options
-- --------------------------------------------------
CREATE procedure [dbo].[usp_cat_disp_options](@cat_code as int)  
As  
select Head,sub_head,menu_name from menu_item a join  
(select distinct menu_code from cat_mapping where cat_code=@cat_code) b  
on a.menu_code=b.menu_code  
where a.active='Y'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_cat_login_info
-- --------------------------------------------------
CREATE procedure usp_cat_login_info(@head as varchar(50),@sub_head as varchar(50),@option as varchar(50),@accessto as varchar(15),@accesscode as varchar(15),@access_to as varchar(15), @access_code as varchar(15))      
As      
--declare @head as varchar(50),@sub_head as varchar(50),@option as varchar(50)    
--declare @access_to as varchar(15), @access_code as varchar(15),@accessto as varchar(15), @accesscode as varchar(15)    
----declare @str as varchar(500),@str1 as varchar(4000)    
--    
--set @access_to ='BRANCH'    
--set @access_code='ACM'    
--    
--set @accessto ='SB'    
--set @accesscode='ALL'    
--set @head='Accounts Utility'    
--set @sub_head='Audit'    
--set @option='Client Bank Info'    
    
declare @str as varchar(1000),@str1 as varchar(4000)      
    
if(@head='ALL')      
begin      
set @head='%'      
end      
if(@sub_head='ALL')      
begin      
set @sub_head='%'      
end      
if(@option='ALL')      
begin      
set @option='%'      
end      
if(@accessto='ALL')      
begin      
set @accessto='%'      
end      
if(@accesscode='ALL')      
begin      
set @accesscode='%'      
end      
      
set nocount on      
      
set @str='select distinct a.username,a.person_name,b.cat_name,last_login=convert(varchar(25) ,a.last_login,113) from      
(select  username,person_name, last_login,cat_code,status,access_to,access_code      
from user_login  where cat_code in(      
select cat_code from cat_mapping where menu_code in(      
select menu_code from menu_item where head like ''%'+@head+'%''       
and sub_head like ''%'+@sub_head+'%'' and menu_name like ''%'+@option+'%'' and active=''Y''))) a join       
menu_cat b      
on a.cat_code = b.cat_code '      
       
      
if(@accessto ='BROKER')      
begin      
set @str1=@str+'where access_to='''+@accessto+''' and access_code like ''%'+@accesscode+'%'' and status=1'      
--print @str1      
end      
      
if(@accessto ='REGION')      
begin      
set @str1=@str+'where access_to='''+@accessto+''' and access_code like ''%'+@accesscode+'%'' and status=1'      
--print @str1      
end      
      
if(@accessto ='BRANCH')      
begin      
set @str1=@str+'where access_code like '''+@accesscode+''' and access_to='''+@accessto+''' and status=1      
union '+@str+'      
where access_to=''BRMAST'' and access_code in(select brmast_cd from  branch_master where branch_cd= '''+@accesscode+''') and status=1'      
--print @str1      
end      
      
if(@accessto ='SB')      
begin      
set @str1=@str+'where access_code like '''+@accesscode+''' and access_to='''+@accessto+''' and status=1      
union '      
+@str+'where access_to=''SBMAST'' and access_code in(select sbmast_cd from  sb_master where sub_broker like '''+@accesscode+''') and status=1'      
end      
      
if(@accessto ='ZONE')      
begin      
set @str1=@str+'where access_to='''+@accessto+''' and access_code like ''%'+@accesscode+'%'' and status=1'      
end      
      
if(@accessto ='CLIENT')      
begin      
set @str1=@str+'where access_to='''+@accessto+''' and access_code like ''%'+@accesscode+'%'' and status=1'      
end      
      
exec (@str1)      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_cat_search
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[USP_CAT_SEARCH]
(
	@CAT_NAME AS VARCHAR(50)
)
              
AS              
/*            
CREATED BY :ROZINA RAJE            
CREATED ON:02 DEC 2009            
          
        
DECLARE @CAT_NAME AS VARCHAR(50)          
SET @CAT_NAME='SYSTEM'          
*/      


SELECT A.CAT_CODE,
	CAT_NAME, 
	ACTIVE, 
	APPLICABLE_TO=ISNULL(A.APPLICABLE_TO,'BROKER'),
	MENU_NAME=COUNT(DISTINCT ISNULL(MENU_CODE,0))    
FROM     
	MENU_CAT A    
	LEFT OUTER JOIN    
	CAT_MAPPING B    
	ON A.CAT_CODE=B.CAT_CODE    
WHERE CAT_NAME LIKE '%'+@CAT_NAME+'%'    
GROUP BY A.CAT_CODE,CAT_NAME,ACTIVE,APPLICABLE_TO              
ORDER BY A.CAT_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CHECK_MENU_RIGHTS
-- --------------------------------------------------
CREATE PROC DBO.USP_CHECK_MENU_RIGHTS  
(  
@MENUCODE AS INT,  
@USERNAME AS VARCHAR(20),
@UPDATEDBY AS VARCHAR(20)
)  
  
AS  
BEGIN  
 SET NOCOUNT ON  
  
  DECLARE @STR AS VARCHAR(200)  
  SELECT @STR = ACCESS_TO FROM USER_LOGIN WHERE USERNAME = @USERNAME   
  SET @STR = '%' + @STR + '%'  
  PRINT(@STR)  
  SELECT * FROM   
  MENU_ITEM WHERE MENU_CODE = @MENUCODE  
  AND APPLICABLE_TO LIKE @STR  
  
  INSERT INTO TBL_CHECK_MENU_RIGHTS_LOG VALUES
  (@MENUCODE,@USERNAME,replace(@STR,'%',''),@UPDATEDBY,getdate())	 
    
 SET NOCOUNT OFF  
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CheckCATEGORY_Maping
-- --------------------------------------------------
CREATE PROCEDURE USP_CheckCATEGORY_Maping  
(  
 @MENUCODE INT,  
 @CATCODE INT,
 @USERNAME as varchar(12)  
)  
      
AS      
SET NOCOUNT ON      
  
      
declare @catstr as varchar(20),@NOR as INT 
set  @NOR=0
select @catstr=applicable_to from menu_cat(nolock) where cat_code=@CATCODE
select @NOR=charindex(@catstr,applicable_to) 
from menu_item(nolock) where menu_code=@MENUCODE and active='Y'
PRINT @NOR      
      
IF @NOR=0       
BEGIN      
 select msg='Option is not allowed to be mapped at this level or Option is Inactive '      
END       
ELSE      
BEGIN      
 select msg=''      
END      
  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CheckCATEGORY_Maping_extra
-- --------------------------------------------------
CREATE PROCEDURE USP_CheckCATEGORY_Maping_extra              
(              
 @MENUCODE INT,              
 @emp varchar(12),            
 @USERNAME  varchar(12)              
)              
                  
AS                  
SET NOCOUNT ON                  
              
                  
declare @catstr as varchar(20),@NOR as INT         
set  @NOR=0        
select @catstr=applicable_to from menu_cat(nolock)       
where cat_code=(select cat_code from user_login where username=@emp)            
      
select @NOR=charindex(@catstr,applicable_to)             
from menu_item(nolock) where menu_code=@MENUCODE and active='Y'            
--PRINT @NOR         
           
                  
IF @NOR=0                   
BEGIN                  
 select msg='Option is not allowed to be mapped at this level or Option is Inactive '                  
 --PRINT @NOR    
END                   
ELSE                  
BEGIN                  
 select msg=''  
 --PRINT @NOR                    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CheckCATEGORY_Maping_extra_test
-- --------------------------------------------------
CREATE PROCEDURE USP_CheckCATEGORY_Maping_extra_test           
(                
 @MENUCODE INT,                
 @emp varchar(12),              
 @USERNAME  varchar(12)                
)                
                    
AS                    
SET NOCOUNT ON                    
                
                    
declare @catstr as varchar(20),@NOR as INT           
set  @NOR=0          
select @catstr=applicable_to from menu_cat(nolock)         
where cat_code=(select cat_code from user_login where username=@emp)              
        
select @NOR=charindex(@catstr,applicable_to)               
from menu_item(nolock) where menu_code=@MENUCODE and active='Y'              
--PRINT @NOR           
             
                    
IF @NOR=0                     
BEGIN                    
 select msg='Option is not allowed to be mapped at this level or Option is Inactive '                    
 --PRINT @NOR      
END                     
ELSE                    
BEGIN                    
 select msg=''    
 --PRINT @NOR                      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Chk_InhouseLogin
-- --------------------------------------------------




--exec Usp_Chk_InhouseLogin 'E66460'
Create Proc Usp_Chk_InhouseLogin
(
 @username varchar (50)
)
AS
BEGIN

	select username,userpassword from user_login where username=@username

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_chkActiveSubBroker
-- --------------------------------------------------
--exec usp_chkActiveSubBroker 'ASLB'

CREATE procedure usp_chkActiveSubBroker
(
  @SubBroker varchar(10)
)

as

set nocount on

begin
  if exists (select 1 from user_login where cast(login_inactive_date as date)> getdate() and status=1 and datediff(month,cast(login_Activated as date),getdate())>6 and access_code=@SubBroker and access_to='SB' )
    begin
    select 1 as Status, 'Activation Greater Than 6 Months' as Remarks
    end
    
   else
     begin
      select 0 as Status, 'Activation Less Than 6 Months' as Remarks
     end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_deactivate_UserLogin_FromBackoffice
-- --------------------------------------------------


CREATE Procedure Usp_deactivate_UserLogin_FromBackoffice

as

begin



select * Into #Final_Update from 

(

	select 

			sbtag, convert(Date,IsActiveDate) InactiveDate,IsActive,convert(date,dateadd(dd,-5,Getdate())) ActualInactiveDate  From [MIS].sb_comp.dbo.sb_broker a with (nolock) 

	inner join [INTRANET].rolemgm.dbo.user_login b with (nolock) 

	on  a.sbtag=b.access_code

	where 

		  IsActive='InActive'

		  and status=1

		  and login_inactive_date>getdate()

		  and access_to='SB'

		  and username is not NULL

		  and SB_Broker_Type is null

	--order by b.last_login desc

) T where InactiveDate	<=ActualInactiveDate

and inactiveDate between dateadd(dd,-15,getdate()) and getdate()



Insert into Sbtag_Deactivated_in_Process_Log(sub_broker,DeactivatedDate)

select sbtag,getdate() from #Final_Update







--BEGIN TRAN



Update A 

Set status=0

--select access_code,sbtag

From rolemgm.dbo.user_login A

inner join 

	(

		SELECT * FROM #Final_Update 

	) B

ON A.ACCESS_CODE=B.SBTAG



Drop table #Final_Update 



--SELECT * FROM [196.1.115.132].rolemgm.dbo.user_login b with (nolock) 

-- WHERE access_code='AYAAY'



 --ROLLBACK

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_email_UnUsedPages
-- --------------------------------------------------
CREATE proc [dbo].[usp_email_UnUsedPages]        
as      
     
SELECT Report_Path,last_access=max(Access_datetime ) into #temp FROM login_logs(nolock) group by report_path      
        
Select a.*,convert(varchar(11),last_access,103) as last_access_date,nod=datediff(day,last_access,getDate()) 
into #t1 
from menu_item a (nolock) left outer join #temp b         
on a.menu_url=b.Report_Path 
where a.active='Y'          
and datediff(day,last_access,getDate())>180 order by head,sub_head,seq_no         

-- select * from #t1    
select a.*,b.cat_code  into #t2 from #t1 a left outer join         
cat_mapping b (nolock)  on a.menu_code=b.menu_code        
        
select a.*,b.person_name,b.username,b.email  into #t3 from #t2 a left outer join user_login b        
on  a.cat_code=b.cat_code where  b.status=1 and b.email<>'' and a.nod>180 and a.cat_code<>'5' and username<>'P00227'      
order by username        
    
Declare @user_id as varchar(15)    
Declare @head as varchar(50),@subhead as varchar(50),@menuitem as varchar(50),@desc as varchar(200),@ldt as varchar(20),    
@Person_name as varchar(50),@mess as varchar(8000),@email as Varchar(50)    
    
DECLARE Mail_Cursor CURSOR FOR Select distinct username from #t3 --where username     
--in ('E16003','E08430','E05206')     
    
    
    
OPEN Mail_Cursor    
    
FETCH NEXT FROM Mail_Cursor     
INTO @user_id    
    
WHILE @@FETCH_STATUS = 0    
BEGIN    
  DECLARE Send_Cursor CURSOR FOR Select Person_name,Head,Sub_Head,menu_name,menu_desc,last_access_date,email from #t3 where username =@user_id    
    
  OPEN Send_Cursor    
    
  FETCH NEXT FROM Send_Cursor     
  INTO @Person_name,@head,@subhead,@menuitem,@desc,@ldt,@email    
      
  Declare @Cnt as integer    
  Set @Cnt = 0       
  WHILE @@FETCH_STATUS = 0    
  BEGIN    
   if(@Cnt = 0)    
   Begin    
    set @mess = 'Dear '+@Person_name+',<Br><Br>'+char(10) +char(10)                         
    set @mess = @mess +'System has identified the below mentioned reports has not been accessed for more than six months.'                  
    set @mess = @mess +'System will deactivate these reports in case if not in use.In case if you want to retain these reports in your login kindly access the same.<br><br>'                  
    set @mess = @mess +'<table border=1><tr><td><b>Menu Heading/Sub-heading/Options</b></td><td><b>Description</b></td><td><b>Last Access Date</b></td></tr>'                  
    Set @Cnt = 1    
   End    
   Set @mess = @mess +'<tr><td>'+@Head+'/'+@subhead+'/'+@menuitem+'</td><td>'+@desc+'</td><td>'+@ldt+'</td></tr>'                  
    
  FETCH NEXT FROM Send_Cursor INTO @Person_name,@head,@subhead,@menuitem,@desc,@ldt,@email    
  END    
    
  CLOSE Send_Cursor    
  DEALLOCATE Send_Cursor    
  Set @mess = @mess +'</table>'                  
      
  exec msdb.dbo.sp_send_dbmail      
  @profile_name='intranet',      
  @recipients=@email,       
  @subject = 'Non-accessed Reports in Angel-Inhouse' ,      
  @body=@mess,      
  @body_format = 'HTML'    
    
FETCH NEXT FROM Mail_Cursor INTO @user_id    
END    
    
CLOSE Mail_Cursor    
DEALLOCATE Mail_Cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Error_Log
-- --------------------------------------------------
CREATE proc [dbo].[usp_Error_Log] 
(
	@ErrPage varchar(500),
	@ErrFromIP varchar(50),
	@ErrLine varchar(10),
	@ErrNum varchar(20),
	@ErrDesc varchar(max)
)
As
begin
	insert into error_log (ErrDate,ErrPage,ErrFromIP,ErrLine,ErrNum,ErrDesc) values
	(GETDATE(),@ErrPage,@ErrFromIP,@ErrLine,@ErrNum,@ErrDesc)
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_exclude_rights
-- --------------------------------------------------

CREATE proc usp_exclude_rights(@catcode as int,@empcode as varchar(20))
as
/*
declare @catcode as int,@empcode as varchar(20)
set @catcode=35
set @empcode ='stl'
*/
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ;
set nocount on ;

with menu( menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc,Owner_name,developer_name,
applicable_to,update_by,update_on,map,show,color,emp_no) 
as 
(select a.*,map=case when b.cat_code is null or emp_no is not null then '' else 'checked' end ,
show=case when b.cat_code is null or b.cat_code=0 then 'disabled' else '' end, color=case when b.cat_code is null then 'red' else 'green' end,
emp_no from menu_item a left outer join (select menu_code,cat_code,emp_no from Vw_exclude_cat_mapping b where cat_code=@catcode and emp_no is null 
union   select menu_code,cat_code,emp_no from Vw_exclude_cat_mapping b where cat_code=35 and emp_no=@empcode ) b 
on a.menu_code=b.menu_code 
 
group by emp_no,a.menu_code,a.Head,a.Sub_Head,a.menu_name,a.menu_url,a.seq_no,a.active,a.menu_desc,a.Owner_name,a.developer_name,
a.applicable_to,a.update_by,a.update_on,b.cat_code
)

select  menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc,Owner_name,developer_name,
applicable_to,update_by,update_on,map=max(map),show,color,emp_no from menu a 
/*where Head like 'risk mana%' and sub_head like 'generate%'*/
group by  show,color,emp_no,a.menu_code,a.Head,a.Sub_Head,a.menu_name,a.menu_url,a.seq_no,a.active,a.menu_desc,a.Owner_name,a.developer_name,
a.applicable_to,a.update_by,a.update_on
 order by head,sub_head,seq_no
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findinJobs
-- --------------------------------------------------
Create Procedure usp_findinJobs(@Str as varchar(500))
as
select b.name,
Case when b.enabled=1 then 'Active' else 'Deactive' end as Status,
date_created,date_modified,a.step_id,a.step_name,a.command
from msdb.dbo.sysjobsteps a, msdb.dbo.sysjobs b
where command like '%'+@Str+'%'
and a.job_id=b.job_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findInUSP
-- --------------------------------------------------

CREATE PROCEDURE USP_FINDINUSP            
	@DBNAME VARCHAR(500),          
	@SRCSTR VARCHAR(500)            
AS            
            
 SET NOCOUNT ON          
 SET @SRCSTR  = '%' + @SRCSTR + '%'            
          
 DECLARE @STR AS VARCHAR(1000)          
 SET @STR=''          
 IF @DBNAME <>''          
 BEGIN          
 SET @DBNAME=@DBNAME+'.DBO.'          
 END          
 ELSE          
 BEGIN          
 SET @DBNAME=DB_NAME()+'.DBO.'          
 END          
 ----PRINT @DBNAME          
          
 SET @STR='SELECT DISTINCT O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '           
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '           
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''            
 --PRINT @STR          
  EXEC(@STR)          
  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FN_CLIENT_REPORT_BKP_16_12_2025
-- --------------------------------------------------
  
        
/*  DESCRIPTION:- FN CLIENT REPORT FOR FN CLIENTS.  ORE-4781        
 REQUESTED BY :- BHAVIKA TIWARI.          
 DEVELPOED BY :- HRISHI ON 16 AUG 2025                        
*/          
CREATE PROC [dbo].[USP_FN_CLIENT_REPORT_BKP_16_12_2025]        
        
AS        
BEGIN        
        
SELECT * INTO #FN_CLIENT FROM RISK.DBO.CLIENT_DETAILS WHERE CL_TYPE IN ('FN')        
SELECT * INTO #CL_BROK FROM ANGELNSECM.MSAJAG.DBO.CLIENT_BROK_DETAILS WHERE CL_CODE IN (SELECT PARTY_CODE FROM #FN_CLIENT)        
SELECT SP_Party_Code,SP_Buy_Brok,SP_Sell_Brok,SP_SCHEME_ID INTO #SCHEME FROM ANGELNSECM.MSAJAG.DBO.SCHEME_MAPPING WHERE SP_Party_Code IN (SELECT PARTY_CODE FROM #FN_CLIENT) AND SP_Trd_Type='DEL'       
      
IF OBJECT_ID(N'TEMPDB..#LEDGER_DATA') IS NOT NULL        
DROP TABLE #LEDGER_DATA        
SELECT * INTO #LEDGER_DATA FROM [CSOKYC-6].GENERAL.DBO.RMS_DTCLFI WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #FN_CLIENT)      
      
IF OBJECT_ID(N'TEMPDB..#MAIN_DATA') IS NOT NULL        
DROP TABLE #MAIN_DATA        
SELECT CONVERT(DATE,RMS_DATE) AS RMS_DATE,PARTY_CODE,SUM(LEDGER) AS LEDGER        
INTO #MAIN_DATA        
FROM #LEDGER_DATA        
--WHERE PARTY_CODE ='ZR1009N'        
GROUP BY CONVERT(DATE,RMS_DATE),PARTY_CODE --1271        
      
--SELECT * FROM #CL_BROK WHERE EXCHANGE='NSE' AND SEGMENT='CAPITAL'      
       
SELECT FN.PARTY_CODE, CL_TYPE, LONG_NAME AS CLIENT_NAME,SUB_BROKER,   
CASE WHEN LAST_INACTIVE_DATE LIKE '%2049%' THEN 'ACTIVE' ELSE 'INACTIVE' END AS STATUS,  
Replace(CONVERT(VARCHAR (10), FIRST_ACTIVE_DATE,103),'/','-') AS ACTIVE_DATE,  
Replace(CONVERT(VARCHAR (10), INACTIVE_FROM,103),'/','-') AS INACTIVE_FROM,  
S.SP_BUY_BROK AS BUY_BROKRAGE,   
S.SP_SELL_BROK AS SELL_BROKRAGE,    
CASE WHEN S.SP_SCHEME_ID='92' THEN 'ITRADE PREMIER' ELSE 'NA' END AS BROKRAGE_PLAN,   
M.LEDGER AS LEDGER_BAL      
FROM #FN_CLIENT FN INNER JOIN #CL_BROK BR ON FN.PARTY_CODE=BR.CL_CODE AND BR.EXCHANGE='NSE' AND BR.SEGMENT='CAPITAL'    
LEFT JOIN #SCHEME S ON S.SP_PARTY_CODE=FN.PARTY_CODE    
LEFT JOIN #MAIN_DATA M ON M.PARTY_CODE=FN.PARTY_CODE      
        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_forgot_password
-- --------------------------------------------------

CREATE procedure [dbo].[usp_forgot_password]
@Ecode varchar(20) ,
@Message varchar(100) out 
as
begin
	declare @email varchar(100);
	declare @password varchar(50);	

	select @email= email from user_login where username=@Ecode and status=1 --and login_inactive_date>=getdate()
	select @password= userpassword from user_login where username=@Ecode and status=1 --and login_inactive_date>=getdate()
	if @email!='' and @password!=''
	begin
		set @password= 'Your Password: '+@password
		print @password
		EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                            
						 @RECIPIENTS =@email,                            
						 @blind_copy_recipients='',                            
						 @PROFILE_NAME = 'AngelBroking',                            
						 @BODY_FORMAT ='HTML',                            
						 @SUBJECT = 'Password Request' ,                            
						 @BODY =@password
	end
	else
	begin
		set @Message= 'User '+@Ecode+' is not active.'	
		Print @Message
	end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_getallcategories
-- --------------------------------------------------
CREATE PROCEDURE USP_getallcategories       
(        
 @MENUCODE INT,        
 --@CATCODE INT,      
 @USERNAME as varchar(12)        
)        
            
AS            
SET NOCOUNT ON            
    
    
select  ROW_NUMBER() OVER (ORDER BY cat_name)  Sequence_no,a.*,map=case when b.cat_code is null then 0 else 1 end    
 from menu_cat a left outer join    
 (select * from cat_mapping where menu_code=@MENUCODE) b    
  on a.cat_code=b.cat_code    
order by cat_name        
            
--declare @catstr as varchar(20),@NOR as INT       
--set  @NOR=0      
--select @catstr=applicable_to from menu_cat(nolock) where cat_code=@CATCODE      
--select @NOR=charindex(@catstr,applicable_to)       
--from menu_item(nolock) where menu_code=@MENUCODE and active='Y'      
--PRINT @NOR            
            
--IF @NOR=0             
--BEGIN            
-- select msg='Option is not allowed to be mapped at this level or Option is Inactive '            
--END             
--ELSE            
--BEGIN            
-- select msg=''            
--END            
        
--SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getClientXsipMandateIDDetail
-- --------------------------------------------------
--exec [usp_getClientXsipMandateDetails] 'n56136'    
    
CREATE PROC [dbo].[usp_getClientXsipMandateIDDetail](    
@mandateid AS VARCHAR(50)    
)    
AS    
BEGIN    
SELECT  a.*    
FROM tblXsipMandateDetails a    
WHERE smandateid = @mandateid     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetExistingMapping
-- --------------------------------------------------
Create proc usp_GetExistingMapping
(
	@SrcEmpCode varchar(20),      
    @DesEmpCode varchar(20)  
)
as
begin
	set nocount on
		----Existing Menu
		Select a.Emp_No,b.Head,b.sub_Head,b.Menu_Name from extra_cat_mapping a inner join
			menu_item b
		on a.menu_code=b.menu_code
		where emp_no=@DesEmpCode
		order by b.Head,b.sub_Head,b.Menu_Name
		
		----Access will provided
		Select a.Emp_No,b.Head,b.sub_Head,b.Menu_Name from extra_cat_mapping a inner join
			menu_item b
		on a.menu_code=b.menu_code
		where emp_no=@SrcEmpCode
		order by b.Head,b.sub_Head,b.Menu_Name
	set nocount off
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetExtraMapping
-- --------------------------------------------------
--usp_GetExtraMapping 426,'125288'    
CREATE Proc [dbo].[usp_GetExtraMapping]    
(      
    @CatCode int,    
    @UserId varchar(50)    
)    
as    
begin    
set nocount on    
    set transaction isolation level read uncommitted     
    select a.*,map=case when b.cat_code is null or b.cat_code=0 then ''  
    when b.cat_code is null or emp_no is not null then 'checked'  else '' end ,    
    show=case when --b.cat_code is null or 
	b.cat_code=0 then 'disabled' else '' end,     
    color=case when b.cat_code is null then 'red' else 'green' end,    
    emp_no from menu_item a left outer join     
    (    
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING_USER b     
        where cat_code=@CatCode and emp_no is null and menu_code not in    
            --(select menu_code from vw_exclude_cat_mapping b   
             (select menu_code from VW_EXCLUDE_CAT_MAPPING_USER b    
            where cat_code=@CatCode and emp_no=@UserId)     
        union     
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING_USER b     
        where cat_code=@CatCode and emp_no=@UserId     
    ) b     
    on a.menu_code=b.menu_code    
    order by head,sub_head,seq_no     
set nocount off    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetExtraMapping_exclude_test
-- --------------------------------------------------
CREATE Proc usp_GetExtraMapping_exclude_test            
(              
    @CatCode int,            
    @UserId varchar(50)            
)            
as            
begin            
set nocount on            
    set transaction isolation level read uncommitted             
    select  dense_rank() over(partition by sub_head order by head,menu_name asc) as id,       
    a.*,map=case when b.cat_code is null or b.cat_code=0 then ''          
    when b.cat_code is null or emp_no is not null then 'checked'  else '' end ,            
    show=case when b.cat_code=0 then 'disabled' else '' end,             
    color=case when b.cat_code is null then 'red' else 'green' end,            
    emp_no from menu_item a left outer join             
    (            
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING_USER b             
        where cat_code=@CatCode and emp_no is null and menu_code not in            
            --(select menu_code from vw_exclude_cat_mapping b           
             (select menu_code from VW_EXCLUDE_CAT_MAPPING_USER b            
            where cat_code=@CatCode and emp_no=@UserId)             
        union             
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING_USER b             
        where cat_code=@CatCode and emp_no=@UserId             
    ) b             
    on a.menu_code=b.menu_code            
    order by head,sub_head,seq_no             
set nocount off            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetExtraMapping_exclude_test_1
-- --------------------------------------------------
--usp_GetExtraMapping_exclude_test '76','DELHIRAIG'

CREATE Proc usp_GetExtraMapping_exclude_test_1            
(              
    @CatCode int,            
    @UserId varchar(50)            
)            
as            
begin            
set nocount on            
    set transaction isolation level read uncommitted             
    select  dense_rank() over(partition by sub_head order by head,menu_name asc) as id,       
    a.*,map=case when b.cat_code is null or b.cat_code=0 then ''          
    when b.cat_code is null or emp_no is not null then 'checked'  else '' end ,            
    show=case when b.cat_code is null or b.cat_code=0 then 'disabled' else '' end,             
    color=case when b.cat_code is null then 'red' else 'green' end,            
    emp_no from menu_item a left outer join             
    (            
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING b             
        where cat_code=@CatCode and emp_no is null and menu_code not in            
            --(select menu_code from vw_exclude_cat_mapping b           
             (select menu_code from VW_EXCLUDE_CAT_MAPPING  b            
            where cat_code=@CatCode and emp_no=@UserId)             
        union             
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING  b             
        where cat_code=@CatCode and emp_no=@UserId             
    ) b             
    on a.menu_code=b.menu_code            
    order by head,sub_head,seq_no             
set nocount off            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetExtraMapping_test_anjana
-- --------------------------------------------------
CREATE Proc usp_GetExtraMapping_test_anjana            
(              
    @CatCode int,            
    @UserId varchar(50)            
)            
as            
begin            
set nocount on            
    set transaction isolation level read uncommitted             
    select dense_rank() over(partition by sub_head order by head,menu_name asc) as id,      
    a.*,map=case when b.cat_code is null then '' else 'checked' end,     
 show=case when b.cat_code is null or b.cat_code=0 then '' else 'disabled' end,      
  color=case when b.cat_code is null then 'red' else 'green' end      
  from menu_item a left outer join      
 (select menu_code,cat_code from cat_mapping where cat_code=@CatCode    
 union     
 select MENU_CODE,cat_code=0 from extra_cat_mapping where emp_no=''+@UserId+''     
 ) b     
  on a.menu_code=b.menu_code          
  order by head,sub_head,seq_no            
set nocount off            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetExtraMapping1
-- --------------------------------------------------
--usp_GetExtraMapping 76,'DELHIRAIG'      
CREATE Proc [dbo].[usp_GetExtraMapping1]      
(        
    @CatCode int,      
    @UserId varchar(50)      
)      
as      
begin      
set nocount on      
    set transaction isolation level read uncommitted       
    select a.*,map=case when b.cat_code is null or b.cat_code=0 then ''    
    when b.cat_code is null or emp_no is not null then 'checked'  else '' end ,      
    show=case when --b.cat_code is null or   
 b.cat_code=0 then 'disabled' else '' end,       
    color=case when b.cat_code is null then 'red' else 'green' end,      
    emp_no from menu_item a left outer join       
    (      
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING b       
        where cat_code=@CatCode and emp_no is null and menu_code not in      
            --(select menu_code from vw_exclude_cat_mapping b     
             (select menu_code from VW_EXCLUDE_CAT_MAPPING b      
            where cat_code=@CatCode and emp_no=@UserId)       
        union       
        select menu_code,cat_code,emp_no from VW_EXCLUDE_CAT_MAPPING b       
        where cat_code=@CatCode and emp_no=@UserId       
    ) b       
    on a.menu_code=b.menu_code      
    order by head,sub_head,seq_no       
set nocount off      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getINhouseLogs
-- --------------------------------------------------
CREATE proc usp_getINhouseLogs    
(    
@LogType varchar(20),    
@fromdate varchar(20),    
@Todate varchar(20)    
)    
As    
BEGIN    
 set @fromdate =Convert(datetime,@fromdate,103)    
 set @Todate =Convert(datetime,@Todate,103)    
    
if(@LogType='Deactivated')    
 Begin    
 select  UserName,person_name,Access_to,Access_code,Cat_Code,[Status],Convert(varchar,Last_login,103) Last_login,NoOfTry,convert(varchar,Convert(datetime,CreatedOn),103)CreatedOn,Convert(varchar,Login_inactive_date,103)Login_inactive_date,  
 Active,Email,IP,IP_active,Session_id,CreatedBy   
 from userlogin with (nolock) where Login_inactive_date between @fromdate and @Todate    
 order by Login_inactive_date  
 return    
 End    
if(@LogType='Activated')    
 Begin    
 select  UserName,person_name,Access_to,Access_code,Cat_Code,[Status],Convert(varchar,Last_login,103) Last_login,NoOfTry,convert(varchar,Convert(datetime,CreatedOn),103)CreatedOn,Active,Email,IP,IP_active,    
 Session_id,CreatedBy  
 from userlogin with (nolock) where status='1' and Login_inactive_date >getdate() and active='y'    
 and Convert(datetime,CreatedOn) between @fromdate and @Todate      
 order by Convert(datetime,CreatedOn)  
 End    
 if(@LogType='Active')    
 Begin    
 select  UserName,person_name,Access_to,Access_code,Cat_Code,[Status],Convert(varchar,Last_login,103) Last_login,NoOfTry,convert(varchar,Convert(datetime,CreatedOn),103)CreatedOn,Active,Email,IP,IP_active,    
 Session_id,CreatedBy   
 from userlogin with (nolock) where status='1' and Login_inactive_date >getdate() and active='y'    
 order by  Convert(varchar,CreatedOn,103)       
 End
 if(@LogType='AccessRights')    
 Begin    
	select distinct Emp_no,A.Menu_code,Head,Sub_Head,Menu_name,Convert(varchar,Mapped_on,103) ModifiedOn from extra_cat_mapping a
	inner join Menu_item b on a.menu_code=b.menu_code
	inner join User_login c on a.EMP_NO=c.username
	where MAPPED_ON between @fromdate and @Todate  and convert(date,a.Mapped_on) >Convert(Date, c.LastModifiedOn)
	order by Convert(varchar,Mapped_on,103)
 End  
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMenuDetails
-- --------------------------------------------------
--usp_GetMenuDetails 1506,'E31542'  
CREATE proc usp_GetMenuDetails    
(    
	@SrcMenuCode varchar(20),
	@DesMenuCode varchar(20),
	@UserCode varchar(20)   
)    
as    
begin    
	set nocount on;
	declare @Cnt as int
	----Check Both Menu have same access level
	Select @Cnt=Count(*) from
	(
		(Select * from menu_item where menu_code=@SrcMenuCode and [Active]='Y') a inner join
		(Select * from menu_item where menu_code=@DesMenuCode and [Active]='y') b
		on a.applicable_to=b.applicable_to
	)
	if @Cnt<>0
	begin
	select 'Y'
		select a.menu_code,a.head,a.sub_head,a.menu_name,a.menu_url,a.active,a.menu_desc,
		owner_name=isnull(a.owner_name,''),developer_name=isnull(a.developer_name,''),
		a.applicable_to,username=@usercode
		from menu_item a where a.menu_code = @DesMenuCode
		order by head,a.sub_head,a.menu_name
	end
	else
	begin
		select 'N'
	end
	set nocount off;
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_getsearchdata
-- --------------------------------------------------
CREATE PROCEDURE USP_getsearchdata         
(          
@menu_name varchar(30),          
 --@CATCODE INT,        
 @USERNAME as varchar(12)          
)          
              
AS              
SET NOCOUNT ON              
      
    SELECT  menu_code ,  Head ,  Sub_Head ,  menu_name ,  menu_url ,  active ,  menu_desc ,  owner_name ,   
 developer_name ,  applicable_to ,username=@USERNAME FROM  menu_item   
 WHERE ( menu_name  LIKE '%' + @menu_name + '%' or Head  LIKE '%' + @menu_name + '%' or Sub_Head  LIKE '%' + @menu_name + '%') order by head,sub_head,menu_name  
      
      
      
   
              
--declare @catstr as varchar(20),@NOR as INT         
--set  @NOR=0        
--select @catstr=applicable_to from menu_cat(nolock) where cat_code=@CATCODE        
--select @NOR=charindex(@catstr,applicable_to)         
--from menu_item(nolock) where menu_code=@MENUCODE and active='Y'        
--PRINT @NOR              
              
--IF @NOR=0               
--BEGIN              
-- select msg='Option is not allowed to be mapped at this level or Option is Inactive '              
--END               
--ELSE              
--BEGIN              
-- select msg=''              
--END              
          
--SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getServlet_UserLogin
-- --------------------------------------------------
----132   ROLEMGM
CREATE proc [dbo].[usp_getServlet_UserLogin]
(
	@username as varchar(100),
	@password as varchar(100)
	--@IpAddress as varchar(100)
)
as
begin 

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@username AND USERPASSWORD=@password AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE() and access_to<>'SB')>0  
 BEGIN  

		 select distinct * INTO #User_login from
		(
			select access_code username,access_to,LOGIN_INACTIVE_DATE,
			case when usertype='USER' and LOGIN_INACTIVE_DATE>GETDATE() and STATUS=1 then 'Yes' 
			when usertype='Admin' and LOGIN_INACTIVE_DATE>GETDATE() and STATUS=1   then 'Yes'  END Status
		 from user_login b
			where b.access_to='SB'
			--AND b.STATUS=1 
			--AND b.LOGIN_INACTIVE_DATE>GETDATE() 
			--and access_code='SUM'
		) T where T.Status='Yes'

--Branch
--access_code
--username
--IP_active
--IP

	select 	username	,IP_active	,IP
	 from user_login where username=@username 
	and userpassword =@password
	and  STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE() 
	
	select branch,b.username access_code from risk.dbo.Fn_MixedUserSB(@username,'%','%') a join #User_login b
	on a.sb=b.username 
	where b.access_to='SB'
	--AND b.STATUS=1 
	--AND b.LOGIN_INACTIVE_DATE>GETDATE() 
	
 END
 else
 BEGIN 
	select 'Not Found' as Error
	select 'Not Found' as Error
 END

END


--select distinct IP ,* from user_login

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getServlet_UserLogin_Bkp15June2020
-- --------------------------------------------------

--select * from user_login where username ='E02229'
--select * from user_login where username ='E02006'
--exec usp_getServlet_UserLogin 'E02229','mateen2229'

CREATE proc [dbo].[usp_getServlet_UserLogin_Bkp15June2020]
(
	@username as varchar(100),
	@password as varchar(100)
	--@IpAddress as varchar(100)
)
as
begin 

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@username AND USERPASSWORD=@password AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE() and access_to<>'SB')>0  
 BEGIN  

	select * from user_login where username=@username 
	and userpassword =@password
	and  STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE() 
	
	select * from risk.dbo.Fn_MixedUserSB(@username,'%','%') a join user_login b
	on a.sb=b.username 
	where b.access_to='SB'
	AND b.STATUS=1 
	AND b.LOGIN_INACTIVE_DATE>GETDATE() 
	
	
	--and IP like  @IpAddress
 END
 else
 BEGIN 
	select 'Not Found' as Error
	select 'Not Found' as Error
 END

END


--select distinct IP ,* from user_login

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getServlet_UserLogin_New
-- --------------------------------------------------
CREATE proc [dbo].[usp_getServlet_UserLogin_New]
(
	@username as varchar(100),
	@password as varchar(100)
	--@IpAddress as varchar(100)
)
as
begin 

IF(SELECT COUNT(1) FROM USER_LOGIN WITH(NOLOCK) WHERE USERNAME=@username AND USERPASSWORD=@password AND STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE() and access_to<>'SB')>0  
 BEGIN  

		 select distinct * INTO #User_login from
		(
			select access_code username,access_to,LOGIN_INACTIVE_DATE,
			case when usertype='USER' and LOGIN_INACTIVE_DATE>GETDATE() and STATUS=1 then 'Yes' 
			when usertype='Admin' and LOGIN_INACTIVE_DATE>GETDATE() and STATUS=1   then 'Yes'  END Status
		 from user_login b
			where b.access_to='SB'
			--AND b.STATUS=1 
			--AND b.LOGIN_INACTIVE_DATE>GETDATE() 
			--and access_code='SUM'
		) T where T.Status='Yes'

--Branch
--access_code
--username
--IP_active
--IP

	select 	username	,IP_active	,IP
	 from user_login where username=@username 
	and userpassword =@password
	and  STATUS=1 AND LOGIN_INACTIVE_DATE>GETDATE() 
	
	select branch,b.username access_code from risk.dbo.Fn_MixedUserSB(@username,'%','%') a join #User_login b
	on a.sb=b.username 
	where b.access_to='SB'
	--AND b.STATUS=1 
	--AND b.LOGIN_INACTIVE_DATE>GETDATE() 
	
 END
 else
 BEGIN 
	select 'Not Found' as Error
	select 'Not Found' as Error
 END

END


--select distinct IP ,* from user_login

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_IH_KYCValidUser
-- --------------------------------------------------
create proc [dbo].[usp_IH_KYCValidUser](@username as varchar(20),@password as varchar(20))
as
declare @cnt as int
select @cnt=count(1) from user_login where username=@username and userpassword=@password
if @cnt>0
begin
select 'TRUE'
end
else
begin
select 'FALSE'
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_INSP_Setting
-- --------------------------------------------------
Create procedure USP_INSP_Setting
as

set nocount on

delete from user_login where username in (select username from Insp_setting)
insert into user_login (person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedOn,LastModifiedBy,LastModifiedOn)
select person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedOn,LastModifiedBy,LastModifiedOn from Insp_setting

update emp_info set status='A' where emp_no in  (select username from Insp_setting)

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_lastLogin
-- --------------------------------------------------
CREATE proc [dbo].[usp_lastLogin](@name as varchar(50),@cat as varchar(50))  
as  
select last_login=convert(varchar(26),last_login,100)  
from user_login a,menu_cat b  
where   a.cat_code=b.cat_code and a.person_name like @name  
and a.access_code like @cat

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_lastLogina
-- --------------------------------------------------

CREATE proc [dbo].[usp_lastLogina](@username as varchar(50),@cat as varchar(50))      
as     
select last_login=convert(varchar(26),last_login,100)      
from user_login a with (nolock) 
	INNER JOIN menu_cat b with (nolock) 
	ON  a.cat_code=b.cat_code    
	where  a.username=@username and a.access_code like @cat

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_LoginDataInsertion
-- --------------------------------------------------
CREATE proc usp_LoginDataInsertion
as
begin
truncate table cat_mapping
truncate table menu_heading
--truncate table user_login_Hist
--truncate table cat_mapping_1
--truncate table cat_mapping05Feb2011
--truncate table cat_mapping_Feb52011
--truncate table menu_cat2
--truncate table menu_item_log
--truncate table cat_mapping_temp
truncate table menu_item
truncate table menu_cat
truncate table cat_mapping_pd
truncate table extra_cat_mapping_hist
truncate table EXTRA_CAT_MAPPING
--truncate table extra_cat_mapping_log
--truncate table login_logs
--truncate table cat_mapping_sep25
truncate table cat_mapping_log
--truncate table user_login_log
truncate table tbl_rtgs_clients
--truncate table temp_rtgs_clients
truncate table error_log
truncate table user_login
--truncate table cat_mapping_HIST
--truncate table cat_mapping_dec102010
truncate table Emp_info
--truncate table session_log
truncate table exclude_cat_mapping
truncate table access_level
truncate table Vw_RMS_Client_Vertical 
truncate table user_franchisee
 

insert into cat_mapping
select * from [196.1.115.132].risk.dbo.cat_mapping
insert into menu_heading
select * from [196.1.115.132].risk.dbo.menu_heading
--insert into user_login_Hist
--select * from [196.1.115.132].risk.dbo.user_login_Hist
--insert into cat_mapping_1
--select * from [196.1.115.132].risk.dbo.cat_mapping_1
--insert into cat_mapping05Feb2011
--select * from [196.1.115.132].risk.dbo.cat_mapping05Feb2011
--insert into cat_mapping_Feb52011
--select * from [196.1.115.132].risk.dbo.cat_mapping_Feb52011
insert into menu_cat2 (cat_name,active,CreatedOn,CreatedBy,ModifiedOn,ModifiedBy)
select cat_name,active,CreatedOn,CreatedBy,ModifiedOn,ModifiedBy from [196.1.115.132].risk.dbo.menu_cat2
--insert into menu_item_log
--select * from [196.1.115.132].risk.dbo.menu_item_log
--insert into cat_mapping_temp
--select * from [196.1.115.132].risk.dbo.cat_mapping_temp
set identity_insert menu_item on 
insert into menu_item (menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc,Owner_name,developer_name,applicable_to,update_by,update_on)
select menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc,Owner_name,developer_name,applicable_to,update_by,update_on  from [196.1.115.132].risk.dbo.menu_item
set identity_insert menu_item off 
set identity_insert menu_cat on 
insert into menu_cat (cat_code,cat_name,active,applicable_to,CreatedOn,CreatedBy,ModifiedOn,ModifiedBy)
select cat_code,cat_name,active,applicable_to,CreatedOn,CreatedBy,ModifiedOn,ModifiedBy from [196.1.115.132].risk.dbo.menu_cat
set identity_insert menu_cat off 
insert into cat_mapping_pd
select * from [196.1.115.132].risk.dbo.cat_mapping_pd
--insert into extra_cat_mapping_hist
--select * from [196.1.115.132].risk.dbo.extra_cat_mapping_hist
insert into EXTRA_CAT_MAPPING
select * from [196.1.115.132].risk.dbo.EXTRA_CAT_MAPPING
--insert into extra_cat_mapping_log
--select * from [196.1.115.132].risk.dbo.extra_cat_mapping_log
--insert into login_logs
--select * from [196.1.115.132].risk.dbo.login_logs
--insert into cat_mapping_sep25
--select * from [196.1.115.132].risk.dbo.cat_mapping_sep25
--insert into cat_mapping_log
--select * from [196.1.115.132].risk.dbo.cat_mapping_log
--insert into user_login_log
--select * from [196.1.115.132].risk.dbo.user_login_log
set identity_insert tbl_rtgs_clients on 
insert into tbl_rtgs_clients (Fld_Sr_No,Fld_Party_Code,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,Fld_Active_By,Fld_Active_Date,Fld_Active_Ip)
select Fld_Sr_No,Fld_Party_Code,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,Fld_Active_By,Fld_Active_Date,Fld_Active_Ip from [196.1.115.132].risk.dbo.tbl_rtgs_clients
set identity_insert tbl_rtgs_clients off 
insert into temp_rtgs_clients (Fld_Party_Code,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,Fld_Active_By,Fld_Active_Date,Fld_Active_Ip,fld_approve_date)
select Fld_Party_Code,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,Fld_Active_By,Fld_Active_Date,Fld_Active_Ip,fld_approve_date from [196.1.115.132].risk.dbo.temp_rtgs_clients
--insert into error_log (Errdate,Errpage,ErrFromIP,ErrLine,ErrNum,ErrDesc,ServSett,rectfydate,chkdatedate,email_flag,username,auto_email_reply)
--select Errdate,Errpage,ErrFromIP,ErrLine,ErrNum,ErrDesc,ServSett,rectfydate,chkdatedate,email_flag,username,auto_email_reply from [196.1.115.132].misc.dbo.error_log
set identity_insert user_login on 
insert into user_login (userid,person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedOn,LastModifiedBy,LastModifiedOn)
select userid,person_name,username,userpassword,usertype,access_to,access_code,cat_code,status,last_login,NoOfTry,NoOfLogin,login_Activated,login_inactive_date,active,email,IP,IP_active,Gateway,Gateway_active,session_id,CreatedBy,CreatedOn,LastModifiedBy,LastModifiedOn from [196.1.115.132].risk.dbo.user_login
set identity_insert user_login off 
--insert into cat_mapping_HIST
--select * from [196.1.115.132].risk.dbo.cat_mapping_HIST
--insert into cat_mapping_dec102010
--select * from [196.1.115.132].risk.dbo.cat_mapping_dec102010
insert into Emp_info
select * from [196.1.115.132].risk.dbo.Emp_info
insert into exclude_cat_mapping
select * from [196.1.115.132].risk.dbo.exclude_cat_mapping
insert into access_level
select * from [196.1.115.132].risk.dbo.access_level
insert into Vw_RMS_Client_Vertical 
select * from [196.1.115.132].risk.dbo.Vw_RMS_Client_Vertical 
insert into user_franchisee
select * from  [196.1.115.132].risk.dbo.user_franchisee
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_menu_mapped_user
-- --------------------------------------------------
CREATE proc usp_menu_mapped_user(@menucode as int,@access_to as varchar(20),@access_code as varchar(20)) as  
set nocount on
select a.Username,[Person Name]=a.Person_name,[Senior Name]=c.sr_name,[Access To]=a.access_to,[Access Code]=a.access_code,[Cat. Code]=a.cat_code,
[Menu Code]=a.MENU_CODE,[Mapped By]=a.MAPPED_BY,[Mapped On]=a.MAPPED_ON,[Report Type]=a.RType from   
(  
select Username=isnull(emp_no,b.username),Person_name,access_to,access_code,b.cat_code,MENU_CODE,MAPPED_BY,MAPPED_ON,RType='Extra Right'    
from extra_cat_mapping a  
left outer join  
user_login b   
on a.emp_no=b.username  
where a.menu_code=@menucode and b.status=1   
union all  
select b.username,Person_name,access_to,access_code,a.*,RType='Cat. Right'   
from  cat_mapping a   
left outer join  
user_login b  
on a.cat_code=b.cat_code  
where a.menu_code=@menucode and b.status=1  
)  
 a  
full outer join  
exclude_cat_mapping b  
on b.emp_no=a.Username and b.menu_code=a.menu_code  
left outer join  
emp_info c  
on a.username=c.emp_no  
where b.emp_no is null and b.menu_code is null and c.status='A'  
order by Username  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MenuMapped
-- --------------------------------------------------
CREATE proc usp_MenuMapped  
(  
     @SrcMenuCode  int,  
     @DestMenuCode  int,  
     @UserCode varchar(20)  
)  
as  
begin  
    set nocount on;  
        declare @Cnt as int  
        ----Check Both menu_code have same level of applicable_to  
        Select @Cnt=Count(*) from   
        (  
            (Select * from menu_item where menu_code=@SrcMenuCode and active='Y') a  inner join  
            (Select * from menu_item where menu_code=@DestMenuCode and active='Y') b  
            on a.applicable_to=b.applicable_to         
        )  
        if @Cnt<>0  
        begin  
            select 'Y'  
        end  
        else  
        begin  
            select 'N'  
        end  
    set nocount off;  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USp_MFNXTForgetLogin
-- --------------------------------------------------
--EXEC [USp_MFNXTForgetLogin] 'EMT','ANIPS0362G',''     
--EXEC [USp_MFNXTForgetLogin] 'ACMEMT','ANIPS0362G','' 
CREATE  Procedure [dbo].[USp_MFNXTForgetLogin]        
(        
@UserID varchar(50),      
@PanNo varchar(50),    
@MachineIp varchar(50)=null    
)        
as        
set nocount on        
Begin        
declare @username varchar(50),@mobile varchar(20),@Message varchar(100),@access_code varchar(50),@Valid varchar(10)    
    
    
    
    
if(isnull(@UserID,'')<>'' and isnull(@PanNo,'')<>'')    
Begin    

set @username=@UserID    
set @access_code=(select top 1 access_code from [172.31.16.38].IPartner.dbo.MF_UserLogin with(nolock) where username=@UserID)    
 if(ISNULL(@access_code,'')<>'')  
 Begin  
  if exists(select * from   
     (  
     select panno from [196.1.115.167].sb_comp.dbo.sb_broker with(nolock) where (sbtag=@UserID OR sbtag=@access_code) and panno=@PanNo  
     union   
     select panno from intranet.risk.dbo.emp_info with(nolock) where Emp_no=@UserID and panno=@PanNo  
     )
     x)  
  Begin  
   set @mobile=(select top 1 c.mobno from [196.1.115.167].sb_comp.dbo.sb_contact c with(nolock) inner join  [196.1.115.167].sb_comp.dbo.sb_broker sb    
         on c.RefNo=sb.RefNo  where sb.sbtag=@access_code  and ISNULL(c.mobno,'')<>'')    
           
           
   if(isnull(@mobile,'')='')    
   Begin    
   print 'mob'    
   set @mobile=(select phone from risk.dbo.emp_info with(nolock) where emp_no=@UserID)    
   End    
   print @mobile   
     
    declare @PWD varchar(500),@Email varchar(500)      
    --select @PWD=userpassword,@Email=email from [172.31.16.38].IPartner.dbo.MF_UserLogin with(nolock) where (username=@UserID   or access_code=@UserID) and usertype='Admin'    
    
    select @PWD=userpassword,@Email=email from [172.31.16.38].IPartner.dbo.MF_UserLogin with(nolock) where username=@UserID   
      
    IF(@Email<>'')    
    BEGIN        
    exec USP_PWD_RESET_MAILER_Ipartner   @PWD,@Email     
    print 'Email'   
    PRINT @Email
    END    
        
    --if(isnull(@mobile,'')<>'')    
    --Begin    
    --set @Message='Dear User, below are the NXT Password :- '+@PWD+'';                
        
    --INSERT INTO [196.1.115.207].[GENERAL].[dbo].[tbl_smsQueue] ([SentFrom], [ServiceName], [MobileNo], [Message], [DeliveryAckRequired], [TransmissionTime], [SMSSentStatus], [TokenID], [MessageType], [IsTransactionalSMS], [IsDNDNumber])          
    --VALUES ('AngelInHouse', 'Bond_OTP', @mobile, @Message, 'N', getdate(), 'N', NEWID(), 'NORMAL', 'Y', 'N')          
            
              
    --End    
      
    insert into [MF_NXT_forget_pwd_log]      
    (date_time,pc_ip_name,username,password1,[message])      
    values      
    (getdate(),@MachineIp,@UserID,@PWD,'Your Password has been sent on your email id')      
        
    select @mobile as MobileNo,@Email as EmailID,'Success' as Msg          
    End    
    else    
    Begin    
    select '' as MobileNo,'' as EmailID,'Enter Valid UserID/Panno' as Msg    
    End            
  End  
  else  
  Begin  
   select '' as MobileNo,'' as EmailID,'Invalid PanNo' as MSG   
  End  
 End  
 else  
 Begin  
 select '' as MobileNo,'' as EmailID,'Please Enter Valid UserID/PanNo' as MSG  
 End     
   
End    
   
    
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_NXT_MFPWD_RESET_MAILER_Ipartner
-- --------------------------------------------------
--USP_PWD_RESET_MAILER_Ipartner    '12345','sandeep.rai@angelbroking.com'    
CREATE proc [dbo].[USP_NXT_MFPWD_RESET_MAILER_Ipartner]     
@pwd varchar(40),    
@email varchar(200)    
as        
declare @Mail_body as varchar(8000)        
set @Mail_body='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>&#65279;
<div>
	
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
		<tbody><tr>
			<td align="center" style="vertical-align:top;padding:0px 0px 0px 0px;border-left:1px solid #d1d1d1;border-top:1px solid #d1d1d1;border-right:1px solid #d1d1d1">
				<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
					<tbody>
						<tr>
							<td align="center" bgcolor="#0071BB" style="vertical-align:top;padding:0px 0px 0px 0px;background-color:#0071bb">
								<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620">
									<tbody>
										<tr>
											<td align="left" style="padding:0 0 0 5px" valign="bottom">
												<a href="" target="_blank"><img alt="Angel Broking powered by ARQ" height="53" src="http://web.angelbackoffice.com/angelbroking/econnect/Refer_and_Earn/images/angel-logo_Rev.png" style="display:block" width="250"></a>
											</td>
										</tr>
									</tbody>
								</table>
							</td>
						</tr>
					</tbody>
				</table>
			</td>
		</tr>
	</tbody></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px;background-color:#27a3a1" width="620"></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="border:1px solid #d1d1d1;border-top:none" width="620">
		<tbody>
			<tr>
				<td align="center" valign="middle">
					<a href="#0.1_" style="display:block"><img alt="NXT Password" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/NXT_Passwordt_banner.jpg" style="display:block" width="620"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:40px 30px 20px 30px">
					Dear User,<br>
					<br>
					The password for your NXT Account is: <strong>'+@pwd+'</strong><br>
					<br>
					Login and experience seamless LMS and Digital Marketing. Access your Dashboard and view your Customized ARQ.<br>
					<br>
					<a href="https://nxt.angelbroking.com/"><img alt="Loginbtn" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/loginbtn.png"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:0 30px 20px 30px">
					For any queries, please contact us on the below details:<br>
					<a href="mailto:partners@angelbroking.com" style="text-decoration:underline;color:#0071bb;font-size:14px" target="_blank">partners@angelbroking.com</a><br>
					022-33551111 | 022-42185454
				</td>
			</tr>
		</tbody>
	</table>
	<table align="center" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0" width="620">
		<tbody>
			<tr>
				<td align="left" bgcolor="#FFFFFF" style="background-color:#ffffff;padding:7px 5px" valign="top">
					<table align="left" border="0" cellpadding="0" cellspacing="0" style="width:100%">
						<tbody>
							<tr>
								<td align="left" bgcolor="#FFFFFF" style="vertical-align:middle" valign="center">
									<table align="left" border="0" cellpadding="0" cellspacing="0">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img alt="Facebook" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_01.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img alt="Twitter" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_02.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img alt="Youtube" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_03.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img alt="LinkedIn" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_04.png"></a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
								<td style="vertical-align:middle">
									<table align="right" border="0" cellpadding="0" cellspacing="2" style="vertical-align:middle">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 0">
													<a href="#0.1_" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none"><img alt="Phone" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_05.png" style="vertical-align:middle">022-3355 1111 / 42
18 5454</a> &nbsp; <a href="mailto:partners@angelbroking.com" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none" target="_blank"><img alt="Email" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_06.png"
 style="vertical-align:middle"> partners@angelbroking.com</a> &nbsp; <a href="http://mf.angelmf.com/Wealth/Index2" style="color:#808080;font-family:''Arial'',sans-serif;font-size:8px;text-decoration:none" target="_blank"><img alt=" " src="https://s3.ap-so
uth-1.amazonaws.com/absite-mumbai/CG/icon_08.png" style="vertical-align:middle">*Disclaimer</a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
		</tbody>
	</table>
</div>
</body></html>'    
     
EXEC INTRANET.MSDB.DBO.Sp_send_dbmail    
        @PROFILE_NAME='INTRANET',                   
        @RECIPIENTS= @email,    
        @SUBJECT ='Login Details',         
        @BODY =@Mail_body,                    
        @BODY_FORMAT = 'HTML'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PrepaidLogEntry
-- --------------------------------------------------
CREATE Procedure [dbo].[USP_PrepaidLogEntry](@Clientcode varchar(20),@fromdate varchar(11),@todate varchar(11),@status char(1))                
as                
--declare @Clientcode varchar(20),@fromdate varchar(11),@todate varchar(11),@status char(1)                
--set @Clientcode='G12823'                 
set @fromdate=(select Convert(varchar(11),Convert(datetime,@fromdate,103)))                
set @todate=(select Convert(varchar(11),Convert(datetime,@todate,103)+1))          
--set @status='C'                
declare @str as varchar(8000)                
declare @conditon as varchar(100)                
if(@status='C')                
 begin                
 set @conditon='where Fld_partycode='''+@Clientcode+''''                  
 end                
else                
 begin                 
 set @conditon='where Fld_FromDate>='''+@fromdate+''' and Fld_FromDate<='''+@todate+''' order by Fld_FromDate'                  
 end                
                
                
select Fld_partycode,Long_Name ,Fld_schemename,                
Fld_Schemeamt=Convert(decimal(10,2),Fld_Schemeamt),Fld_ModeofPay=Case when Fld_ModeofPay='L' Then 'Ledger' else 'Cheque' end ,                
Fld_Flag=case when Fld_Flag='A' then 'Pending For Activation'                
when Fld_Flag='P' then 'Pending For Approval'                
when Fld_Flag='R' then 'Rejected'                
when Fld_Flag='U' then 'Upgraded'     
when Fld_Flag='D' then 'Inactive'                
when Fld_Flag='K' then 'KYC Closed'                   
else 'Active' end,segment,                 
FLd_EnteredBy,                
person_name=case when a.FLd_EnteredBy=a.Fld_partycode then a.Long_Name else b.person_name end,                
Fld_FromDate=Convert(datetime,Fld_FromDate,103) ,usertype                
,access_to,access_code into #file1                
from intranet.risk.dbo.V_prepaid_brkclientdetails a,user_login b              
where a.FLd_EnteredBy=b.username               
                
insert into #file1               
select               
Fld_partycode,Long_Name ,Fld_schemename,                
Fld_Schemeamt=Convert(decimal(10,2),Fld_Schemeamt),Fld_ModeofPay=Case when Fld_ModeofPay='L' Then 'Ledger' else 'Cheque' end ,                
Fld_Flag=case when Fld_Flag='A' then 'Pending For Activation'                
when Fld_Flag='P' then 'Pending For Approval'                
when Fld_Flag='R' then 'Rejected'                
when Fld_Flag='U' then 'Upgraded'    
when Fld_Flag='D' then 'Inactive'                
when Fld_Flag='K' then 'KYC Closed'                
else 'Active' end,segment,                 
FLd_EnteredBy,                
person_name=Long_Name,              
Fld_FromDate=Convert(datetime,Fld_FromDate,103) ,usertype='USER'                
,access_to='USER',access_code='USER'              
from intranet.risk.dbo.V_prepaid_brkclientdetails where FLd_EnteredBy=Fld_partycode               
--set @str='select Fld_partycode as [Party Code],Long_Name as [Party Name],                
--Fld_Schemeamt as [Scheme Amt],Case when Fld_ModeofPay=''L'' Then ''Ledger'' else ''Cheque'' end as [Mode Of Payment],                
--FLd_EnteredBy as [Entered By],                
--person_name as [Entered Person Name],                
--Convert(varchar(11),Fld_FromDate) as [Entered On],usertype as [Entered Person Type]                
--,access_to as [Entered From],access_code as [Entry Code] ,name=                
--case when access_to=''BRMAST'' then                
--(select distinct BrMast_name from intranet.risk.dbo.branch_master where brMast_cd=access_code)                
--when access_to=''SBMAST'' then                
--(Select distinct SbMast_name from intranet.risk.dbo.sb_master  where sbMast_cd=access_code)                
--when access_to=''REGION'' then                
--(Select distinct Name from intranet.risk.dbo.region where reg_Code=access_code)                
--else access_code                
--end                
--from #file1 '+@conditon+''                
                
set @str='select *,name=                
case when access_to=''BRMAST'' then                
(select distinct BrMast_name from intranet.risk.dbo.branch_master where brMast_cd=access_code)                
when access_to=''SBMAST'' then                
(Select distinct SbMast_name from intranet.risk.dbo.sb_master  where sbMast_cd=access_code)                
when access_to=''REGION'' then                
(Select distinct Name from intranet.risk.dbo.region where reg_Code=access_code)                
else access_code                
end                
from #file1 '+@conditon+''               
                
--print @str                
exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PWD_RESET_MAILER
-- --------------------------------------------------
--USP_PWD_RESET_MAILER '12345','navin.sapalya@angelbroking.com'
Create proc USP_PWD_RESET_MAILER 
@pwd varchar(40),
@email varchar(200)
as    
declare @Mail_body as varchar(2000)    
set @Mail_body='<html><body><font face="Calibri" color=blue size=5>     
<b> Angel Inhouse Login Details </b></font><br />

Password :&nbsp;&nbsp;'+ @pwd +' <br />
<br />
<br />

<b>From, <br>Software Development, <br> Angel Broking.
<br />    
<br />    
                                       
 </body></html>'
 
EXEC INTRANET.MSDB.DBO.Sp_send_dbmail
        @PROFILE_NAME='INTRANET',               
        @RECIPIENTS= @email,
        @SUBJECT ='RM Login Details',     
        @BODY =@Mail_body,                
        @BODY_FORMAT = 'HTML'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PWD_RESET_MAILER_Ipartner
-- --------------------------------------------------

--USP_PWD_RESET_MAILER_Ipartner    '12345','sandeep.rai@angelbroking.com'    
CREATE proc [dbo].[USP_PWD_RESET_MAILER_Ipartner]     
@pwd varchar(40),    
@email varchar(200)    
as        
declare @Mail_body as varchar(8000)        
set @Mail_body='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>&#65279;
<div>
	
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
		<tbody><tr>
			<td align="center" style="vertical-align:top;padding:0px 0px 0px 0px;border-left:1px solid #d1d1d1;border-top:1px solid #d1d1d1;border-right:1px solid #d1d1d1">
				<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
					<tbody>
						<tr>
							<td align="center" bgcolor="#0071BB" style="vertical-align:top;padding:0px 0px 0px 0px;background-color:#0071bb">
								<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620">
									<tbody>
										<tr>
											<td align="left" style="padding:0 0 0 5px" valign="bottom">
												<a href="" target="_blank"><img alt="Angel Broking powered by ARQ" height="53" src="http://web.angelbackoffice.com/angelbroking/econnect/Refer_and_Earn/images/angel-logo_Rev.png" style="display:block" width="250"></a>
											</td>
										</tr>
									</tbody>
								</table>
							</td>
						</tr>
					</tbody>
				</table>
			</td>
		</tr>
	</tbody></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px;background-color:#27a3a1" width="620"></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="border:1px solid #d1d1d1;border-top:none" width="620">
		<tbody>
			<tr>
				<td align="center" valign="middle">
					<a href="#0.1_" style="display:block"><img alt="NXT Password" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/NXT_Passwordt_banner.jpg" style="display:block" width="620"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:40px 30px 20px 30px">
					Dear User,<br>
					<br>
					The password for your NXT Account is: <strong>'+@pwd+'</strong><br>
					<br>
					Login and experience seamless LMS and Digital Marketing. Access your Dashboard and view your Customized ARQ.<br>
					<br>
					<a href="https://nxt.angelbroking.com/"><img alt="Loginbtn" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/loginbtn.png"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:0 30px 20px 30px">
					For any queries, please contact us on the below details:<br>
					<a href="mailto:partners@angelbroking.com" style="text-decoration:underline;color:#0071bb;font-size:14px" target="_blank">partners@angelbroking.com</a><br>
					022-42185455 | 022-33045455
				</td>
			</tr>
		</tbody>
	</table>
	<table align="center" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0" width="620">
		<tbody>
			<tr>
				<td align="left" bgcolor="#FFFFFF" style="background-color:#ffffff;padding:7px 5px" valign="top">
					<table align="left" border="0" cellpadding="0" cellspacing="0" style="width:100%">
						<tbody>
							<tr>
								<td align="left" bgcolor="#FFFFFF" style="vertical-align:middle" valign="center">
									<table align="left" border="0" cellpadding="0" cellspacing="0">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img alt="Facebook" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_01.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img alt="Twitter" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_02.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img alt="Youtube" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_03.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img alt="LinkedIn" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_04.png"></a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
								<td style="vertical-align:middle">
									<table align="right" border="0" cellpadding="0" cellspacing="2" style="vertical-align:middle">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 0">
													<a href="#0.1_" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none"><img alt="Phone" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_05.png" style="vertical-align:middle">022-42185455 | 022-33045455</a> &nbsp; <a href="mailto:partners@angelbroking.com" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none" target="_blank"><img alt="Email" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_06.png"style="vertical-align:middle"> partners@angelbroking.com</a> &nbsp; <a href="http://mf.angelmf.com/Wealth/Index2" style="color:#808080;font-family:''Arial'',sans-serif;font-size:8px;text-decoration:none" target="_blank"><img alt=" " src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_08.png" style="vertical-align:middle">*Disclaimer</a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
		</tbody>
	</table>
</div>
</body></html>'    
     
EXEC INTRANET.MSDB.DBO.Sp_send_dbmail    
        @PROFILE_NAME='INTRANET',                   
        @RECIPIENTS= @email,    
		@blind_copy_recipients='Yogesh.rewatkar@angelbroking.com',
        @SUBJECT ='Login Details',         
        @BODY =@Mail_body,                    
        @BODY_FORMAT = 'HTML'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PWD_RESET_MAILER_Ipartner_Bkp11Oct2018
-- --------------------------------------------------
--USP_PWD_RESET_MAILER_Ipartner    '12345','sandeep.rai@angelbroking.com'    
CREATE proc [dbo].[USP_PWD_RESET_MAILER_Ipartner_Bkp11Oct2018]     
@pwd varchar(40),    
@email varchar(200)    
as        
declare @Mail_body as varchar(8000)        
set @Mail_body='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>&#65279;
<div>
	
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
		<tbody><tr>
			<td align="center" style="vertical-align:top;padding:0px 0px 0px 0px;border-left:1px solid #d1d1d1;border-top:1px solid #d1d1d1;border-right:1px solid #d1d1d1">
				<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
					<tbody>
						<tr>
							<td align="center" bgcolor="#0071BB" style="vertical-align:top;padding:0px 0px 0px 0px;background-color:#0071bb">
								<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620">
									<tbody>
										<tr>
											<td align="left" style="padding:0 0 0 5px" valign="bottom">
												<a href="" target="_blank"><img alt="Angel Broking powered by ARQ" height="53" src="http://web.angelbackoffice.com/angelbroking/econnect/Refer_and_Earn/images/angel-logo_Rev.png" style="display:block" width="250"></a>
											</td>
										</tr>
									</tbody>
								</table>
							</td>
						</tr>
					</tbody>
				</table>
			</td>
		</tr>
	</tbody></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px;background-color:#27a3a1" width="620"></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="border:1px solid #d1d1d1;border-top:none" width="620">
		<tbody>
			<tr>
				<td align="center" valign="middle">
					<a href="#0.1_" style="display:block"><img alt="NXT Password" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/NXT_Passwordt_banner.jpg" style="display:block" width="620"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:40px 30px 20px 30px">
					Dear User,<br>
					<br>
					The password for your NXT Account is: <strong>'+@pwd+'</strong><br>
					<br>
					Login and experience seamless LMS and Digital Marketing. Access your Dashboard and view your Customized ARQ.<br>
					<br>
					<a href="https://nxt.angelbroking.com/"><img alt="Loginbtn" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/loginbtn.png"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:0 30px 20px 30px">
					For any queries, please contact us on the below details:<br>
					<a href="mailto:partners@angelbroking.com" style="text-decoration:underline;color:#0071bb;font-size:14px" target="_blank">partners@angelbroking.com</a><br>
					022-33551111 | 022-42185454
				</td>
			</tr>
		</tbody>
	</table>
	<table align="center" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0" width="620">
		<tbody>
			<tr>
				<td align="left" bgcolor="#FFFFFF" style="background-color:#ffffff;padding:7px 5px" valign="top">
					<table align="left" border="0" cellpadding="0" cellspacing="0" style="width:100%">
						<tbody>
							<tr>
								<td align="left" bgcolor="#FFFFFF" style="vertical-align:middle" valign="center">
									<table align="left" border="0" cellpadding="0" cellspacing="0">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img alt="Facebook" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_01.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img alt="Twitter" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_02.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img alt="Youtube" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_03.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img alt="LinkedIn" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_04.png"></a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
								<td style="vertical-align:middle">
									<table align="right" border="0" cellpadding="0" cellspacing="2" style="vertical-align:middle">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 0">
													<a href="#0.1_" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none"><img alt="Phone" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_05.png" style="vertical-align:middle">022-3355 1111 / 4218 5454</a> &nbsp; <a href="mailto:partners@angelbroking.com" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none" target="_blank"><img alt="Email" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_06.png"style="vertical-align:middle"> partners@angelbroking.com</a> &nbsp; <a href="http://mf.angelmf.com/Wealth/Index2" style="color:#808080;font-family:''Arial'',sans-serif;font-size:8px;text-decoration:none" target="_blank"><img alt=" " src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_08.png" style="vertical-align:middle">*Disclaimer</a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
		</tbody>
	</table>
</div>
</body></html>'    
     
EXEC INTRANET.MSDB.DBO.Sp_send_dbmail    
        @PROFILE_NAME='INTRANET',                   
        @RECIPIENTS= @email,    
        @SUBJECT ='Login Details',         
        @BODY =@Mail_body,                    
        @BODY_FORMAT = 'HTML'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PWD_RESET_MAILER_Ipartner_Mobile_2
-- --------------------------------------------------

--USP_PWD_RESET_MAILER_Ipartner    '12345','sandeep.rai@angelbroking.com'    
CREATE proc [dbo].[USP_PWD_RESET_MAILER_Ipartner_Mobile_2]     
@pwd varchar(40),    
@email varchar(200)    
as        
declare @Mail_body as varchar(8000)        
set @Mail_body='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>&#65279;
<div>
	
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
		<tbody><tr>
			<td align="center" style="vertical-align:top;padding:0px 0px 0px 0px;border-left:1px solid #d1d1d1;border-top:1px solid #d1d1d1;border-right:1px solid #d1d1d1">
				<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620px">
					<tbody>
						<tr>
							<td align="center" bgcolor="#0071BB" style="vertical-align:top;padding:0px 0px 0px 0px;background-color:#0071bb">
								<table border="0" cellpadding="0" cellspacing="0" style="min-width:620px" width="620">
									<tbody>
										<tr>
											<td align="left" style="padding:0 0 0 5px" valign="bottom">
												<a href="" target="_blank"><img alt="Angel Broking powered by ARQ" height="53" src="http://web.angelbackoffice.com/angelbroking/econnect/Refer_and_Earn/images/angel-logo_Rev.png" style="display:block" width="250"></a>
											</td>
										</tr>
									</tbody>
								</table>
							</td>
						</tr>
					</tbody>
				</table>
			</td>
		</tr>
	</tbody></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:620px;background-color:#27a3a1" width="620"></table>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="border:1px solid #d1d1d1;border-top:none" width="620">
		<tbody>
			<tr>
				<td align="center" valign="middle">
					<a href="#0.1_" style="display:block"><img alt="NXT Password" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/NXT_Passwordt_banner.jpg" style="display:block" width="620"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:40px 30px 20px 30px">
					Dear User,<br>
					<br>
					The password for your NXT Account is: <strong>'+@pwd+'</strong><br>
					<br>
					Login and experience seamless LMS and Digital Marketing. Access your Dashboard and view your Customized ARQ.<br>
					<br>
					<a href="https://nxt.angelbroking.com/"><img alt="Loginbtn" src="http://web.angelbackoffice.com/angelbroking/econnect/NXT_Password_270218/images/loginbtn.png"></a>
				</td>
			</tr>
			<tr>
				<td style="font-size:14px;color:#4e4e4e;font-family:Open Sans,arial,sans-serif;text-align:justify;font-weight:400;line-height:20px;padding:0 30px 20px 30px">
					For any queries, please contact us on the below details:<br>
					<a href="mailto:partners@angelbroking.com" style="text-decoration:underline;color:#0071bb;font-size:14px" target="_blank">partners@angelbroking.com</a><br>
					022-42185455 | 022-33045455
				</td>
			</tr>
		</tbody>
	</table>
	<table align="center" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0" width="620">
		<tbody>
			<tr>
				<td align="left" bgcolor="#FFFFFF" style="background-color:#ffffff;padding:7px 5px" valign="top">
					<table align="left" border="0" cellpadding="0" cellspacing="0" style="width:100%">
						<tbody>
							<tr>
								<td align="left" bgcolor="#FFFFFF" style="vertical-align:middle" valign="center">
									<table align="left" border="0" cellpadding="0" cellspacing="0">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img alt="Facebook" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_01.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img alt="Twitter" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_02.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img alt="Youtube" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_03.png"></a>
												</td>
												<td style="vertical-align:middle;padding:0 3px">
													<a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img alt="LinkedIn" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_04.png"></a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
								<td style="vertical-align:middle">
									<table align="right" border="0" cellpadding="0" cellspacing="2" style="vertical-align:middle">
										<tbody>
											<tr>
												<td style="vertical-align:middle;padding:0 0">
													<a href="#0.1_" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none"><img alt="Phone" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_05.png" style="vertical-align:middle">022-42185455 | 022
-33045455</a> &nbsp; <a href="mailto:partners@angelbroking.com" style="font-family:''Arial'',sans-serif;font-size:8px;color:#808080;text-decoration:none" target="_blank"><img alt="Email" src="https://s3.ap-south-1.amazonaws.com/absite-mumbai/CG/icon_06.pn
g"style="vertical-align:middle"> partners@angelbroking.com</a> &nbsp; <a href="http://mf.angelmf.com/Wealth/Index2" style="color:#808080;font-family:''Arial'',sans-serif;font-size:8px;text-decoration:none" target="_blank"><img alt=" " src="https://s3.ap-s
outh-1.amazonaws.com/absite-mumbai/CG/icon_08.png" style="vertical-align:middle">*Disclaimer</a>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
		</tbody>
	</table>
</div>
</body></html>'    
     

	 --jogendar.dhoble@angelbroking.com;anand.sayan@angel
EXEC INTRANET.MSDB.DBO.Sp_send_dbmail    
        @PROFILE_NAME='INTRANET',                   
        @RECIPIENTS= @email,  
		--@RECIPIENTS='Yogesh.rewatkar@angelbroking.com;jogendar.dhoble@angelbroking.com',
        @blind_copy_recipients='Yogesh.rewatkar@angelbroking.com',
        @SUBJECT ='Login Details',         
        @BODY =@Mail_body,                    
        @BODY_FORMAT = 'HTML'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_sentforgotlink
-- --------------------------------------------------
--exec usp_sentforgotlink 'E664607477474'
CREATE procedure [dbo].[usp_sentforgotlink]
@Ecode varchar(20) 
as
begin
	declare @email varchar(100);
	declare @body varchar(max)='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="x-apple-disable-message-reformatting"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="color-scheme" content="light dark"><meta name="supported-color-schemes" content="light dark"><title></title><style type="text/css" rel="stylesheet" media="all">@import url(https://fonts.googleapis.com/css?family=Nunito+Sans:400,700&display=swap);body{width:100%!important;height:100%;margin:0;-webkit-text-size-adjust:none}a{color:#3869d4}a img{border:none}td{word-break:break-word}.preheader{display:none!important;visibility:hidden;mso-hide:all;font-size:1px;line-height:1px;max-height:0;max-width:0;opacity:0;overflow:hidden}body,td,th{font-family:"Nunito Sans",Helvetica,Arial,sans-serif}h1{margin-top:0;color:#333;font-size:22px;font-weight:700;text-align:left}h2{margin-top:0;color:#333;font-size:16px;font-weight:700;text-align:left}h3{margin-top:0;color:#333;font-size:14px;font-weight:700;text-align:left}td,th{font-size:16px}blockquote,ol,p,ul{margin:.4em 0 1.1875em;font-size:16px;line-height:1.625}p.sub{font-size:13px}.align-right{text-align:right}.align-left{text-align:left}.align-center{text-align:center}.u-margin-bottom-none{margin-bottom:0}.button{background-color:#3869d4;border-top:10px solid #3869d4;border-right:18px solid #3869d4;border-bottom:10px solid #3869d4;border-left:18px solid #3869d4;display:inline-block;color:#fff;text-decoration:none;border-radius:3px;box-shadow:0 2px 3px rgba(0,0,0,.16);-webkit-text-size-adjust:none;box-sizing:border-box}.button--green{background-color:#22bc66;border-top:10px solid #22bc66;border-right:18px solid #22bc66;border-bottom:10px solid #22bc66;border-left:18px solid #22bc66}.button--red{background-color:#ff6136;border-top:10px solid #ff6136;border-right:18px solid #ff6136;border-bottom:10px solid #ff6136;border-left:18px solid #ff6136}@media only screen and (max-width:500px){.button{width:100%!important;text-align:center!important}}.attributes{margin:0 0 21px}.attributes_content{background-color:#f4f4f7;padding:16px}.attributes_item{padding:0}.related{width:100%;margin:0;padding:25px 0 0 0;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0}.related_item{padding:10px 0;color:#cbcccf;font-size:15px;line-height:18px}.related_item-title{display:block;margin:.5em 0 0}.related_item-thumb{display:block;padding-bottom:10px}.related_heading{border-top:1px solid #cbcccf;text-align:center;padding:25px 0 10px}.discount{width:100%;margin:0;padding:24px;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0;background-color:#f4f4f7;border:2px dashed #cbcccf}.discount_heading{text-align:center}.discount_body{text-align:center;font-size:15px}.social{width:auto}.social td{padding:0;width:auto}.social_icon{height:20px;margin:0 8px 10px 8px;padding:0}.purchase{width:100%;margin:0;padding:35px 0;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0}.purchase_content{width:100%;margin:0;padding:25px 0 0 0;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0}.purchase_item{padding:10px 0;color:#51545e;font-size:15px;line-height:18px}.purchase_heading{padding-bottom:8px;border-bottom:1px solid #eaeaec}.purchase_heading p{margin:0;color:#85878e;font-size:12px}.purchase_footer{padding-top:15px;border-top:1px solid #eaeaec}.purchase_total{margin:0;text-align:right;font-weight:700;color:#333}.purchase_total--label{padding:0 15px 0 0}body{background-color:#f2f4f6;color:#51545e}p{color:#51545e}.email-wrapper{width:100%;margin:0;padding:0;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0;background-color:#f2f4f6}.email-content{width:100%;margin:0;padding:0;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0}.email-masthead{padding:25px 0;text-align:center}.email-masthead_logo{width:94px}.email-masthead_name{font-size:16px;font-weight:700;color:#a8aaaf;text-decoration:none;text-shadow:0 1px 0 #fff}.email-body{width:100%;margin:0;padding:0;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0}.email-body_inner{width:570px;margin:0 auto;padding:0;-premailer-width:570px;-premailer-cellpadding:0;-premailer-cellspacing:0;background-color:#fff}.email-footer{width:570px;margin:0 auto;padding:0;-premailer-width:570px;-premailer-cellpadding:0;-premailer-cellspacing:0;text-align:center}.email-footer p{color:#a8aaaf}.body-action{width:100%;margin:30px auto;padding:0;-premailer-width:100%;-premailer-cellpadding:0;-premailer-cellspacing:0;text-align:center}.body-sub{margin-top:25px;padding-top:25px;border-top:1px solid #eaeaec}.content-cell{padding:45px}@media only screen and (max-width:600px){.email-body_inner,.email-footer{width:100%!important}}@media (prefers-color-scheme:dark){.email-body,.email-body_inner,.email-content,.email-footer,.email-masthead,.email-wrapper,body{background-color:#333!important;color:#fff!important}.purchase_item,blockquote,h1,h2,h3,ol,p,span,ul{color:#fff!important}.attributes_content,.discount{background-color:#222!important}.email-masthead_name{text-shadow:none!important}}:root{color-scheme:light dark;supported-color-schemes:light dark}</style><!--[if mso]><style type="text/css">.f-fallback{font-family:Arial,sans-serif}</style><![endif]--></head><body><span class="preheader">Use this link to reset your password. The link is only valid for 24 hours.</span><table class="email-wrapper" width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr><td align="center"><table class="email-content" width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr><td align="right" class="email-masthead"><a rel="noreferrer"><img alt="Angel One" src="https://cdn.angelone.in/sparkweb2-O/images/Angel_One_Logo.png" style="width:150px"></a></td></tr><tr><td class="email-body" width="570" cellpadding="0" cellspacing="0"><table class="email-body_inner" align="center" width="570" cellpadding="0" cellspacing="0" role="presentation"><tr><td class="content-cell"><div class="f-fallback"><h1>Hi @empcode,</h1><p>You recently requested to reset your password for your Angel-Inhouse account. Use the button below to reset it.</p><table class="body-action" align="center" width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr><td align="center"><table width="100%" border="0" cellspacing="0" cellpadding="0" role="presentation"><tr><td align="center"><a href="@url" class="f-fallback button button--green" target="_blank">Reset your password</a></td></tr></table></td></tr></table><p>If you need any help, please reach out to us at ITSupportdesk@angelbroking.com. We are happy to help you.</p><p>Thanks,<br>Angel One Limited</p></div></td></tr></table></td></tr></table></td></tr></table></body></html>'
	declare @password varchar(50);	
	declare @link as varchar(200)='https://rm.angelbroking.com/AngelInHouse_3.5/ResetPassword/ResetPassword.aspx?user='

	set @body =REPLACE(@body, '@empcode', @Ecode)

	select @email= email from user_login where username=@Ecode and status=1 --and login_inactive_date>=getdate()
	

	set @Ecode= risk.dbo.Encrypt_New(@Ecode)

	set @link=@link+@Ecode

	set @body =REPLACE(@body, '@url', @link)

	if @email!=''
	begin
	
		print @password
		EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                            
						 @RECIPIENTS = @email,                            
						 @blind_copy_recipients='',                            
						 @PROFILE_NAME = 'AngelBroking',                            
						 @BODY_FORMAT ='HTML',                            
						 @SUBJECT = 'Password Request' ,                            
						 @BODY =@body


						 select '200' as status,'The link has been sent to the registered email' as message

	end
	else
	begin
		select '401' as status,'Invalid user id' as message
	end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_InhouseBackOfficeTable
-- --------------------------------------------------

CREATE PROC [dbo].[USP_UPDATE_InhouseBackOfficeTable]
@userName varchar(30),@DisBy varchar(50)
AS

--DECLARE @userName varchar(30)
--set @userName ='AABD'

 BEGIN TRY 

 ----==== *** Update In BackOffice Server  ********* ====-----
                   			      
			      --NSX			       
			      
			      UPDATE  AngelFo.NSECURFO.DBO.TBLUSERCONTROLMASTER 
			      SET FLDSTATUS=1,FLDACCESSLVL='L',FLDIPADD='SB Applied for Cancellation'			      
			      WHERE FLDUSERID =(
			      Select FLDauto from 
			      AngelFo.NSECURFO.DBO.tblPradnyausers t  
			      where fldusername = ltrim(rtrim(@userName)) )
			     
			      
			      --NSE			      
			      UPDATE AngelNseCM.MSAJAG.dbo.TBLUSERCONTROLMASTER 
			      SET FLDSTATUS=1,FLDACCESSLVL='L',FLDIPADD='SB Applied for Cancellation'
			      WHERE FLDUSERID =(
			      Select FLDauto from 
			      AngelNseCM.MSAJAG.dbo.tblPradnyausers t  
			      where fldusername = ltrim(rtrim(@userName)) )
			    			    
			    			     			      
			      --NSEFO
			      UPDATE ANGELFO.NSEFO.dbo.TBLUSERCONTROLMASTER 
			      SET FLDSTATUS=1,FLDACCESSLVL='L',FLDIPADD='SB Applied for Cancellation'
			      WHERE FLDUSERID =(
			      Select FLDauto from 
			      ANGELFO.NSEFO.dbo.tblPradnyausers t  
			      where fldusername = ltrim(rtrim(@userName)) )
			      
			      --NCDX
			      UPDATE ANGELCOMMODITY.NCDX.dbo.TBLUSERCONTROLMASTER 
			      SET FLDSTATUS=1,FLDACCESSLVL='L',FLDIPADD='SB Applied for Cancellation'
			      WHERE FLDUSERID =(
			      Select FLDauto from 
			      ANGELCOMMODITY.NCDX.dbo.tblPradnyausers t  
			      where fldusername = ltrim(rtrim(@userName)) )	
			      
			      --MCDX
			      UPDATE ANGELCOMMODITY.MCDX.dbo.TBLUSERCONTROLMASTER 
			      SET FLDSTATUS=1,FLDACCESSLVL='L',FLDIPADD='SB Applied for Cancellation'
			      WHERE FLDUSERID =(
			      Select FLDauto from 
			      ANGELCOMMODITY.MCDX.dbo.tblPradnyausers t  
			      where fldusername = ltrim(rtrim(@userName)) )	
			      
			      --MCD
			      UPDATE ANGELCOMMODITY.MCDXCDS.dbo.TBLUSERCONTROLMASTER 
			      SET FLDSTATUS=1,FLDACCESSLVL='L',FLDIPADD='SB Applied for Cancellation'
			      WHERE FLDUSERID =(
			      Select FLDauto from 
			      ANGELCOMMODITY.MCDXCDS.dbo.tblPradnyausers t  
			      where fldusername =ltrim(rtrim(@userName)))	
			      
			      --BSE
			      UPDATE AngelBSECM.BSEDB_AB.dbo.TBLUSERCONTROLMASTER 
			      SET FLDSTATUS=1,FLDACCESSLVL='L',FLDIPADD='SB Applied for Cancellation'
			      WHERE FLDUSERID =(
			      Select FLDauto from 
			      AngelBSECM.BSEDB_AB.dbo.tblPradnyausers t  
			      where fldusername = ltrim(rtrim(@userName)))
			      
			      
-----==== **** Update Inhouse ***** ---======
			      
			      insert into user_login_Hist 
			      select * from user_login where access_code = ltrim(rtrim(@userName))
			      
			      UPDATE user_login 
			      SET STATUS=0,IP_ACTIVE='Y',IP='SB Applied for Cancellation'
			      where access_code = ltrim(rtrim(@userName))
			      
			      --select * from user_login WHERE ACCESS_CODE ='AHAR'
			      
------===== *** Insert Into  Log Table **** ------===========			      

Insert into tbl_SBCancellation_Log values(@userName,@DisBy,getdate())
			      
 END TRY              
 BEGIN CATCH              
        INSERT INTO tbl_SB_Cancellation_ErrorLog values(ERROR_NUMBER(),ERROR_LINE(),ERROR_MESSAGE(),ERROR_PROCEDURE(),GETDATE())
 END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_InhouseBackOfficeTable_ActivateSB
-- --------------------------------------------------

CREATE PROC [dbo].[USP_UPDATE_InhouseBackOfficeTable_ActivateSB]
@userName varchar(30),@segment varchar(10),@ActBy varchar(50)
AS
--DECLARE @userName varchar(30)
--set @userName ='AABD'

BEGIN TRY 
 ----==== *** Update In BackOffice Server  ********* ====-----
                   			      
			      --NSX			       
			     IF @segment='NSE-SX'
			      BEGIN
					  UPDATE  AngelFo.NSECURFO.DBO.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /*,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	*/
					  WHERE  FLDUSERID =(
					  Select FLDauto from 
					  AngelFo.NSECURFO.DBO.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)))
				  END
			      
			      --NSE	
			      IF @segment='NSE'
			      BEGIN		      
					  UPDATE AngelNseCM.MSAJAG.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /*,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	*/
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  AngelNseCM.MSAJAG.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )
			      END		    
			    			     			      
			      --NSEFO
			      IF @segment='NSEFO'
			      BEGIN
					  UPDATE ANGELFO.NSEFO.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /*,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	*/
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELFO.NSEFO.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )
			      END
			      
			      --NCDX
			      IF @segment='NCDEX'
			      BEGIN
					  UPDATE ANGELCOMMODITY.NCDX.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /*,FLDACCESSLVL='F',FLDIPADD='127.0.0.1' */	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.NCDX.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )	
			      END
			      
			      --MCDX
			      IF @segment='MCX'
			      BEGIN
					  UPDATE ANGELCOMMODITY.MCDX.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /*,FLDACCESSLVL='F',FLDIPADD='127.0.0.1' */	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.MCDX.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )	
				  END	  
			      
			      --MCD
			      IF @segment='MCX-SX'
			      BEGIN
					  UPDATE ANGELCOMMODITY.MCDXCDS.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /* ,FLDACCESSLVL='F',FLDIPADD='127.0.0.1' */	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.MCDXCDS.dbo.tblPradnyausers t  
					  where fldusername =ltrim(rtrim(@userName)))	
				  END	  
			      
			      --BSE
			      IF @segment='BSE'
			      BEGIN
					  UPDATE AngelBSECM.BSEDB_AB.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /*,FLDACCESSLVL='F',FLDIPADD='127.0.0.1' */	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  AngelBSECM.BSEDB_AB.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)))
				  END
				  
				  --BSEFO
				  IF @segment='BSEFO'
			      BEGIN
					  UPDATE ANGELCOMMODITY.BSEFO.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0 /*,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'*/	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.BSEFO.dbo.tblPradnyausers t  
					  where fldusername =ltrim(rtrim(@userName)))
				  END	  
			      
			      
-----==== **** NO NEED TO UPDATE IN INHOUSE ***** ---======
			      /*
			      insert into user_login_Hist 
			      select * from user_login where access_code = ltrim(rtrim(@userName))
			      
			      UPDATE user_login 
			      SET STATUS=0,IP_ACTIVE='Y',IP='SB Applied for Cancellation'
			      where access_code = ltrim(rtrim(@userName))
			      */
			      
			      --select * from user_login WHERE ACCESS_CODE ='AHAR'
			      
------===== *** Insert Into  Log Table **** ------===========			      

Insert into tbl_SBActivation_Log values(@userName,@ActBy,getdate())

--CREATE TABLE tbl_SBActivation_Log (SRNO int identity(1,1),UserName varchar(50), ActivatedBy varchar(50),ActivationDate datetime)
			      
 END TRY              
 BEGIN CATCH              
        INSERT INTO tbl_SB_Cancellation_ErrorLog values(ERROR_NUMBER(),ERROR_LINE(),ERROR_MESSAGE(),ERROR_PROCEDURE(),GETDATE())
 END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_InhouseBackOfficeTable_ActivateSB_BKP_03MAY2016
-- --------------------------------------------------

create PROC [dbo].[USP_UPDATE_InhouseBackOfficeTable_ActivateSB_BKP_03MAY2016]
@userName varchar(30),@segment varchar(10),@ActBy varchar(50)
AS
--DECLARE @userName varchar(30)
--set @userName ='AABD'

BEGIN TRY 
 ----==== *** Update In BackOffice Server  ********* ====-----
                   			      
			      --NSX			       
			     IF @segment='NSE-SX'
			      BEGIN
					  UPDATE  AngelFo.NSECURFO.DBO.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'			      
					  WHERE  FLDUSERID =(
					  Select FLDauto from 
					  AngelFo.NSECURFO.DBO.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)))
				  END
			      
			      --NSE	
			      IF @segment='NSE'
			      BEGIN		      
					  UPDATE ANAND1.MSAJAG.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANAND1.MSAJAG.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )
			      END		    
			    			     			      
			      --NSEFO
			      IF @segment='NSEFO'
			      BEGIN
					  UPDATE ANGELFO.NSEFO.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELFO.NSEFO.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )
			      END
			      
			      --NCDX
			      IF @segment='NCDEX'
			      BEGIN
					  UPDATE ANGELCOMMODITY.NCDX.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.NCDX.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )	
			      END
			      
			      --MCDX
			      IF @segment='MCX'
			      BEGIN
					  UPDATE ANGELCOMMODITY.MCDX.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.MCDX.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)) )	
				  END	  
			      
			      --MCD
			      IF @segment='MCX-SX'
			      BEGIN
					  UPDATE ANGELCOMMODITY.MCDXCDS.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.MCDXCDS.dbo.tblPradnyausers t  
					  where fldusername =ltrim(rtrim(@userName)))	
				  END	  
			      
			      --BSE
			      IF @segment='BSE'
			      BEGIN
					  UPDATE ANAND.BSEDB_AB.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANAND.BSEDB_AB.dbo.tblPradnyausers t  
					  where fldusername = ltrim(rtrim(@userName)))
				  END
				  
				  --BSEFO
				  IF @segment='BSEFO'
			      BEGIN
					  UPDATE ANGELCOMMODITY.BSEFO.dbo.TBLUSERCONTROLMASTER 
					  SET FLDSTATUS=0,FLDACCESSLVL='F',FLDIPADD='127.0.0.1'	
					  WHERE FLDUSERID =(
					  Select FLDauto from 
					  ANGELCOMMODITY.BSEFO.dbo.tblPradnyausers t  
					  where fldusername =ltrim(rtrim(@userName)))
				  END	  
			      
			      
-----==== **** NO NEED TO UPDATE IN INHOUSE ***** ---======
			      /*
			      insert into user_login_Hist 
			      select * from user_login where access_code = ltrim(rtrim(@userName))
			      
			      UPDATE user_login 
			      SET STATUS=0,IP_ACTIVE='Y',IP='SB Applied for Cancellation'
			      where access_code = ltrim(rtrim(@userName))
			      */
			      
			      --select * from user_login WHERE ACCESS_CODE ='AHAR'
			      
------===== *** Insert Into  Log Table **** ------===========			      

Insert into tbl_SBActivation_Log values(@userName,@ActBy,getdate())

--CREATE TABLE tbl_SBActivation_Log (SRNO int identity(1,1),UserName varchar(50), ActivatedBy varchar(50),ActivationDate datetime)
			      
 END TRY              
 BEGIN CATCH              
        INSERT INTO tbl_SB_Cancellation_ErrorLog values(ERROR_NUMBER(),ERROR_LINE(),ERROR_MESSAGE(),ERROR_PROCEDURE(),GETDATE())
 END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_updatepassword
-- --------------------------------------------------









  
--EXEC usp_updatepassword 'u4R4AMLT8+A=','1234',''  
  
CREATE PROCEDURE [dbo].[usp_updatepassword]  
(  
@USERNAME VARCHAR(100),  
@PASSWORD VARCHAR(50),  
@ip varchar(100)=''  
)  
AS  
BEGIN  
  
--select * from tbl_inhouse_pwd_log  
  
BEGIN TRY    
   declare @oldpwd varchar(100)=''  
   declare @cnt int=0  
   set @USERNAME= risk.dbo.Decrypt_New(@USERNAME)  
   set @PASSWORD=risk.dbo.Encrypt_New(@PASSWORD)  
  
   select @oldpwd=userpassword from user_login where username=@USERNAME --and active='Y'   
  
   if(@oldpwd=@PASSWORD)   
   begin  
      select '401' as status,'New password should not be same as old password' as message  
   return  
   end  
     
   else  
   begin  
  
    
  
     select @cnt= count(1) from (select top 8 password  from tbl_inhouse_pwd_log where userid=@USERNAME order by entryon desc) a where password=@PASSWORD  
  
  if(@cnt>0)  
  begin  
       select '401' as status,'New password must not match previous 3 passwords' as message  
       return  
  end  
  else  
  begin  
  
    insert into tbl_inhouse_pwd_log(userid,password,ip)  
       values (@USERNAME,@oldpwd,@ip)  
  
    update user_login   
    set userpassword=@PASSWORD,LastModifiedOn=getdate()  
    where username=@USERNAME --and active='Y'   
  
  
    select '200' as status,'Password has been updated ' as message  
  
  end   
  
  
     
  
   end  
  
  
   
  
  
  
  
  
  
END TRY    
BEGIN CATCH    
  select '401' as status,'Invalid user' as message  
  select ERROR_LINE()  
     
END CATCH   
  
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_updatepassword_30102023
-- --------------------------------------------------









  
--EXEC usp_updatepassword 'u4R4AMLT8+A=','1234',''  
  
CREATE PROCEDURE [dbo].[usp_updatepassword_30102023]  
(  
@USERNAME VARCHAR(100),  
@PASSWORD VARCHAR(50),  
@ip varchar(100)=''  
)  
AS  
BEGIN  
  
--select * from tbl_inhouse_pwd_log  
  
BEGIN TRY    
   declare @oldpwd varchar(100)=''  
   declare @cnt int=0  
   set @USERNAME= risk.dbo.Decrypt_New(@USERNAME)  
   set @PASSWORD=risk.dbo.Encrypt_New(@PASSWORD)  
  
   select @oldpwd=userpassword from user_login where username=@USERNAME and active='Y'   
  
   if(@oldpwd=@PASSWORD)   
   begin  
      select '401' as status,'New password should not be same as old password' as message  
   return  
   end  
     
   else  
   begin  
  
    
  
     select @cnt= count(1) from (select top 3 password  from tbl_inhouse_pwd_log where userid=@USERNAME order by entryon desc) a where password=@PASSWORD  
  
  if(@cnt>0)  
  begin  
       select '401' as status,'New password must not match previous 3 passwords' as message  
       return  
  end  
  else  
  begin  
  
    insert into tbl_inhouse_pwd_log(userid,password,ip)  
       values (@USERNAME,@oldpwd,@ip)  
  
    update user_login   
    set userpassword=@PASSWORD,LastModifiedOn=getdate()  
    where username=@USERNAME and active='Y'   
  
  
    select '200' as status,'Password has been updated ' as message  
  
  end   
  
  
     
  
   end  
  
  
   
  
  
  
  
  
  
END TRY    
BEGIN CATCH    
  select '401' as status,'Invalid user' as message  
  select ERROR_LINE()  
     
END CATCH   
  
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateSB_Cancellation_Main
-- --------------------------------------------------
CREATE proc [dbo].[USP_UpdateSB_Cancellation_Main]
@DisBy varchar(50)
AS

DECLARE @cnt int,@UserName varchar(30)
BEGIN TRY  

select ROW_NUMBER() over(order by UserName)as SRNO,UserName into #temp1 from tbl_SB_CancellationUserName 
 
 set @cnt=(select count(1) from #temp1)
 
 --print @cnt
 
 WHILE(@cnt > 0)
 BEGIN
	set @UserName=(select UserName from #temp1 where SRNO = @cnt)
	
	exec USP_UPDATE_InhouseBackOfficeTable @UserName,@DisBy 
	set @cnt = @cnt - 1	
	print @UserName 
 END
 
 select 'success' as Status 
 
 --************************************************ Mail Logic ***************************************************************
declare @msgbody varchar(max),@cnt_Mail int
declare @srno varchar(10),@UserName_Mail varchar(50),@DeactivatedBy varchar(50),@DDate varchar(50),@i int

  select * into #temp_Mail from
  (
  select  row_number()over(order by A.UserName)SRNO,B.UserName,B.DeactivatedBy,B.DeactivationDate 
  from tbl_SB_CancellationUserName A
  LEFT JOIN
  tbl_SBCancellation_Log B on A.UserName =B.UserName)A

set @msgbody ='<html><head>                                          
    <title> SB Cancellation Report</title> </head><body><form><div> Below are User Deactivation Report.<br/><br/>'          
          
  set @msgbody =@msgbody + '<table border=1 cellspacing=0 >'          
  set @msgbody=@msgbody+'<tr bgcolor="#8DF3FA">'                                          
  set @msgbody=@msgbody+'<td><b> SRNO</b></td>'                     
  set @msgbody=@msgbody+'<td><b>User Name</b></td>'          
  set @msgbody=@msgbody+'<td><b>Deactivated By</b></td>' 
  set @msgbody=@msgbody+'<td><b>Deactivated Date</b></td>' 
  set @msgbody=@msgbody+'</tr>'

set @cnt_Mail=(select count(1) from #temp_Mail)
set @i=1 
 
WHILE (@i <= @cnt_Mail )          
BEGIN 
  	select @srno=@i,@UserName_Mail=UserName,@DeactivatedBy=DeactivatedBy,@DDate=DeactivationDate
  	 from #temp_Mail where SrNo = @i
  	 
  set @msgbody=@msgbody+' <tr>'                                          
  set @msgbody=@msgbody+' <td align="center">'+ @srno+ ' </td>'                     
  set @msgbody=@msgbody+' <td align="center">'+ @UserName_Mail+ ' </td>'                                                                        
  set @msgbody=@msgbody+' <td align="center">'+ @DeactivatedBy+ ' </td>'
  set @msgbody=@msgbody+' <td align="center">'+ @DDate+ ' </td>'    
  set @msgbody=@msgbody+' </tr>'     
   
   set @i =@i + 1 
END

set @msgbody=@msgbody+' </table> </div> </form> </body> </html>' 

DECLARE @TO VARCHAR(MAX),@CC VARCHAR(MAX),@BCC VARCHAR(MAX) ,@MESS varchar(max)                               
    SET @TO = 'Helpdeskloginmgmt@angelbroking.com'                           
    SET @CC = 'renil.pillai@angelbroking.com;rohit.patil@angelbroking.com'   
    --set @TO='rohit.patil@angelbroking.com'                           
    --SET @BCC = 'manesh@angelbroking.com;renil.pillai@angelbroking.com;neha.naiwar@angelbroking.com;Rohit.Patil@angelbroking.com'                            
                                  
    SET @MESS = @msgbody         
            
    print @msgbody                
                          
    EXEC MSDB.DBO.SP_SEND_DBMAIL                              
    @RECIPIENTS = @TO,                              
    @COPY_RECIPIENTS = @CC,                              
    --@BLIND_COPY_RECIPIENTS = @BCC,                
    @PROFILE_NAME = 'Angelbroking',                              
    @BODY_FORMAT ='HTML',                              
    @SUBJECT = 'SB Cancellation: SB Cancellation Details' ,                              
    @BODY =@mess 
 --**************************************************************************************************************               
 END TRY              
 BEGIN CATCH              
        insert into tbl_SB_Cancellation_ErrorLog values(ERROR_NUMBER(),ERROR_LINE(),ERROR_MESSAGE(),ERROR_PROCEDURE(),GETDATE())
        select ERROR_MESSAGE() as Status
 END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_updateSBLoginStatus
-- --------------------------------------------------


CREATE proc usp_updateSBLoginStatus  

AS  

BEGIN  

  

  update user_login  

  set login_inactive_date = getdate()-1,status=0  

  from user_login a  

  inner join [MIS].SB_COMP.dbo.SB_Broker b with(nolock) on a.Access_Code=b.SBtag  

  where (a.Login_inactive_Date  >getdate()  or status=1)

  and b.IsActive ='InActive'  and access_to='SB'

  

  update user_login  

  set login_inactive_date=getdate()+365  ,status=1

  from user_login a  

  inner join [MIS].SB_COMP.dbo.SB_Broker b with(nolock) on a.Access_Code=b.SBtag  

  where b.isactive='Active' and b.isactivedate >= getdate()-10 and a.login_inactive_date <getdate() 

  

 --select distinct access_code from user_login with (nolock) where access_to='SB' and login_inactive_date >getdate()   

  --user_login_10nov2023

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UpdateUserLoginStatus
-- --------------------------------------------------
CREATE PROC usp_UpdateUserLoginStatus  
@userName varchar(30)  
AS  
BEGIN  
Set nocount on           
DECLARE @userID int=0  
  
set @userID =(select userID from user_login where username= @userName)    
BEGIN TRY  
 IF @userID > 0  
 begin   
  UPDATE user_login  
  SET  active='Y'   
  WHERE userid= @userID   
 end  
END TRY  
BEGIN CATCH  
  insert into UserLoginLog values(Error_message(),Error_Line(),getdate())  
END CATCH  
Set nocount off           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_upload_BSEQE
-- --------------------------------------------------
CREATE PROCEDURE dbo.usp_upload_BSEQE                
(                
  @Server AS VARCHAR(20),                
  @FileName AS VARCHAR(50)                
)                
AS                
BEGIN                
  SET NOCOUNT ON;            
 delete from  intranet.misc.dbo.qe where fname=@FileName            
  declare @sql as varchar(1000)            
            
  set @sql='insert into intranet.misc.dbo.qe             
    (SC_CODE,SC_NAME,SC_GROUP,SC_TYPE,QUOT_1,QUOT_2,QUOT_3,QUOT_4,TDCLOINDI,NO_TRADES,            
     NO_OF_SHRS,NET_TURNOV,ROLLING,fname,pddate)             
    SELECT SC_CODE,SC_NAME,SC_GROUP,SC_TYPE,QUOT_1,QUOT_2,QUOT_3,QUOT_4,TDCLOINDI,NO_TRADES,            
       NO_OF_SHRS,NET_TURNOV,ROLLING,fname='''+@FileName+''',date=convert(char(11),getdate(),121) FROM OPENROWSET(            
     ''MSDASQL'',            
     ''Driver={Microsoft dBase Driver (*.dbf)};DBQ=\\'+@Server+'\c$\UPLOAD\SELFTRADE\'',            
     ''Select * from '+@FileName+''')'            
   --PRINT (@SQL)      
 exec(@sql)             
            
   SET NOCOUNT ON;             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_USER_EMAIL_UNUSEDPAGES
-- --------------------------------------------------
/**************************************************************************    
    
CREATED DATE :: 16 MARCH 2011    
PURPOSE :: USED IN AIAAS EMAIL UNUSED LINK JOB    
    
*************************************************************************/        
        
CREATE PROC [dbo].[USP_USER_EMAIL_UNUSEDPAGES]                      
AS                    
                   
SET NOCOUNT ON            
          
          
/* NOT CLICKED ON LINK FOR MORE THEN 90 DAYS */            
SELECT USERID,REPORT_PATH,LAST_ACCESS=MAX(ACCESS_DATETIME )       
INTO #TEMP       
FROM DBO.LOGIN_LOGS       
GROUP BY USERID,REPORT_PATH                    
HAVING MAX(ACCESS_DATETIME ) <= GETDATE()-90            
              
SELECT MENU_CODE,HEAD,SUB_HEAD,MENU_NAME,MENU_URL,MENU_DESC,              
A.USERID,PERSON_NAME,USERNAME,ACCESS_TO,ACCESS_CODE,LAST_ACCESS AS LAST_ACCESS_DATE, EMAIL              
INTO #T3              
FROM USER_LOGIN A  ,              
#TEMP B,DBO.MENU_ITEM C              
WHERE A.USERID=B.USERID AND STATUS=1 AND B.REPORT_PATH=C.MENU_URL AND C.ACTIVE='Y' AND A.ACCESS_TO NOT IN ('SB','SBMAST')              
AND EMAIL<>''              
ORDER BY USERID,HEAD,SUB_HEAD,MENU_NAME              
        
        
UPDATE #T3 SET ACCESS_TO='*'       
FROM DBO.EXCLUDE_CAT_MAPPING B       
WHERE #T3.USERNAME=B.EMP_NO AND #T3.MENU_CODE=B.MENU_CODE        
      
DELETE FROM #T3 WHERE ACCESS_TO='*'         
          
/* NOT AT ALL CLICKED ON THE LINK */          
SELECT * INTO #F1       
FROM DBO.MENU_ITEM       
WHERE ACTIVE='Y' AND CONVERT(DATETIME,UPDATE_ON) <= GETDATE()-90          
          
SELECT * INTO #F2 FROM           
(SELECT A.* FROM           
(SELECT * FROM DBO.MENU_ITEM WHERE ACTIVE='Y' AND CONVERT(DATETIME,UPDATE_ON) <= GETDATE()-90) A LEFT OUTER JOIN           
(SELECT DISTINCT REPORT_PATH FROM LOGIN_LOGS ) B           
ON A.MENU_URL=B.REPORT_PATH WHERE B.REPORT_PATH IS NULL          
) X           
          
          
INSERT INTO #T3          
SELECT           
MENU_CODE,HEAD,SUB_HEAD,MENU_NAME,MENU_URL,MENU_DESC,              
X.USERID,PERSON_NAME,USERNAME,ACCESS_TO,ACCESS_CODE,CONVERT(DATETIME,'JAN  1 1900') AS LAST_ACCESS_DATE, EMAIL              
 FROM DBO.USER_LOGIN X ,           
(SELECT A.*,B.HEAD,B.SUB_HEAD,B.MENU_NAME,B.MENU_URL,B.MENU_DESC FROM DBO.CAT_MAPPING A JOIN #F2 B ON A.MENU_CODE=B.MENU_CODE) Y          
WHERE X.CAT_CODE=Y.CAT_CODE          


/*Remove links which are already disabled suggested by Atul Sir on 16th June 2016*/
UPDATE #T3 SET ACCESS_TO='*'       
FROM DBO.EXCLUDE_CAT_MAPPING B       
WHERE #T3.USERNAME=B.EMP_NO AND #T3.MENU_CODE=B.MENU_CODE        
      
DELETE FROM #T3 WHERE ACCESS_TO='*'    


DECLARE @rc INT                                                                   
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues                                                                   
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                                                                  
EXEC @rc = msdb.dbo.sysmail_start_sp  


          
              
DECLARE @USER_ID AS VARCHAR(15)                  
DECLARE @HEAD AS VARCHAR(50),@SUBHEAD AS VARCHAR(50),@MENUITEM AS VARCHAR(50),@DESC AS VARCHAR(200),@LDT AS VARCHAR(20),                  
@PERSON_NAME AS VARCHAR(50),@MESS AS VARCHAR(MAX),@EMAIL AS VARCHAR(50)                  
                  
DECLARE MAIL_CURSOR CURSOR FOR SELECT DISTINCT USERNAME FROM #T3 where EMAIL <>''            
              
OPEN MAIL_CURSOR                  
                  
FETCH NEXT FROM MAIL_CURSOR                   
INTO @USER_ID                  
                  
WHILE @@FETCH_STATUS = 0                  
BEGIN                  
  DECLARE SEND_CURSOR CURSOR FOR           
  SELECT PERSON_NAME,HEAD,SUB_HEAD,MENU_NAME,MENU_DESC,LAST_ACCESS_DATE,EMAIL FROM #T3 WHERE USERNAME =@USER_ID                  
  ORDER BY USERID,HEAD,SUB_HEAD,MENU_NAME              
               
  OPEN SEND_CURSOR                  
              
  FETCH NEXT FROM SEND_CURSOR                   
  INTO @PERSON_NAME,@HEAD,@SUBHEAD,@MENUITEM,@DESC,@LDT,@EMAIL                  
                    
  DECLARE @CNT AS INTEGER                  
  SET @CNT = 0                     
  WHILE @@FETCH_STATUS = 0                  
  BEGIN                  
   IF(@CNT = 0)                  
   BEGIN                  
    SET @MESS = 'DEAR '+@PERSON_NAME+',<BR><BR>'+CHAR(10) +CHAR(10)                                       
    SET @MESS = @MESS +'BELOW MENTIONED OPTIONS IN ANGEL INHOUSE HAS NOT BEEN ACCESSED FOR MORE THAN 3 MONTH.'              
    SET @MESS = @MESS +'SYSTEM WILL DEACTIVATE THESE OPTIONS THIS WEEKEND. IN CASE YOU WANT TO RETAIN IT KINDLY USE IT TILL THIS WEEKEND.<BR><BR>'                                
    SET @MESS = @MESS +'<TABLE BORDER=1><TR><TD><B>MENU HEADING/SUB-HEADING/OPTIONS</B></TD><TD><B>DESCRIPTION</B></TD><TD><B>LAST ACCESS DATE</B></TD></TR>'                                
    SET @CNT = 1                  
   END                  
   SET @MESS = @MESS +'<TR><TD>'+@HEAD+'/'+@SUBHEAD+'/'+@MENUITEM+'</TD><TD>'+@DESC+'</TD><TD>'+@LDT+'</TD></TR>'                                
  FETCH NEXT FROM SEND_CURSOR INTO @PERSON_NAME,@HEAD,@SUBHEAD,@MENUITEM,@DESC,@LDT,@EMAIL                  
  END                  
                  
  CLOSE SEND_CURSOR                  
  DEALLOCATE SEND_CURSOR                  
  SET @MESS = @MESS +'</TABLE>'                                
  SET @MESS = @MESS +'<BR>FOR ANY INFORMATION KINDLY EMAIL: INHOUSE.SUPPORT@ANGELTRADE.COM'              
  SET @MESS = @MESS +'<BR><BR>ANGEL INHOUSE AUTO AUDIT SYSTEM (AIAAS)'              
                    
  EXEC MSDB.DBO.SP_SEND_DBMAIL                    
  @PROFILE_NAME='INTRANET',                    
  @RECIPIENTS=@EMAIL,                     
  @SUBJECT = 'NON-ACCESSED REPORTS IN ANGEL-INHOUSE' ,                    
  @BODY=@MESS,                    
  @BODY_FORMAT = 'HTML'  
  
  WAITFOR DELAY '00:00:03'                
                  
FETCH NEXT FROM MAIL_CURSOR INTO @USER_ID                  
END                  
                  
CLOSE MAIL_CURSOR                  
DEALLOCATE MAIL_CURSOR                  
            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WelcomeSBBEENXT_Mail
-- --------------------------------------------------
CREATE Procedure [dbo].[WelcomeSBBEENXT_Mail]
(
		@sb_tag varchar(100)='AJYC'
)
as
begin 

/*

EXEC WelcomeSBBEENXT_Mail 'ajyc'

*/


DECLARE @HTMLBODY nvarchar(max)


Declare @recipients varchar(100)='Yogesh.rewatkar@angelbroking.com'

--Declare @sb_tag Varchar(200)

Declare @SBName varchar(50)	,
	@ARNNo varchar(200)	,
	@ARNHolderName varchar(200),
@ValidityFrom Date	,
@ValidityTo	date,
@EUINNo varchar(200)

Declare 
	@AddLine1	nVarchar(10),
	@AddLine2	nVarchar(50),
	@Landmark	Varchar(50),
	@City	Varchar(15),
	@State	Varchar(20),
	@Country	Varchar(50),
	@PinCode Varchar(10), 
	@MobNo Varchar(10),
	@RefNo varchar(200),
	@SalContactPerson Varchar(10),
	@username Varchar(100),
	@userpassword Varchar(100)

--Set @sb_tag='AJYC'





select * into #tblArnEuinMaster from mutualfund.dbo.tblArnEuinMaster with(nolock) where [SB EQUITY TAG]=@sb_tag 


select @username=username,@userpassword=userpassword
 from [10.253.78.155].NXT.dbo.MF_UserLogin WITH (NOLOCK)
where access_code=@sb_tag
and usertype='User'


select @RefNo=RefNo,@SalContactPerson=SalContactPerson from [MIS].SB_Comp.dbo.sb_broker
where sbtag=@sb_tag



select 
	@sb_tag=[SB Equity Tag],
	@SBName=@SalContactPerson+' '+[SB Name]	,
	@ARNNo=[ARN No]	,
	@ARNHolderName=[ARN Holder Name],
		@ValidityFrom=[Validity From]	,
		@ValidityTo=[Validity To]	,
		@EUINNo=[EUIN No]
 from #tblArnEuinMaster


select 
@AddLine1=rtrim(ltrim(AddLine1)) +' '+AddLine2	,@Landmark=Landmark	,@City=City	,@State=State	,@Country=Country	,@PinCode=PinCode, 
@MobNo=MobNo
 from [MIS].SB_Comp.dbo.sb_contact
where RefNo=@RefNo
and AddType='RES'

Select 
	@AddLine1 AddLine1	,
	@AddLine2	 AddLine2,
	@Landmark Landmark	,
	@City City	,
	@State State	,
	@Country Country	,
	@PinCode PinCode , 
	@MobNo MobNo 







set @HTMLBODY='

<!doctype html>
<html><head>
<meta charset="utf-8">
<title>Bee Nxt</title>
</head>

<body>
<table width="800" border="0" cellspacing="0" cellpadding="0" align="center">
  <tbody>
    <tr>
      <td>
      	<a href="#">
      		<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/header.png" alt="" style="display: block">
      	</a>
      </td>
    </tr>
    <tr>
    	<td>
    		<a href="#">
    			<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/banner.png" alt="" style="display: block;">
    		</a>
    	</td>
    </tr>
    <tr>
    	<td style="border-left:solid 1px #ddd; border-right:solid 1px #DDD; border-bottom: solid 1px #DDD;">
    		<table width="730" border="0" cellspacing="0" cellpadding="0" align="center">
			  <tbody>
			  <tr>
			  	<td style="height: 10px;">&nbsp;</td>
			  </tr>
				<tr>
				  <td style="text-align: right;" align="right">
					<p style="margin: 0; font-family: ''Arial'',sans-serif; font-size: 14px;">
						November 5th, 2018
					</p>
				</td>
				</tr>
				<tr>
			  	<td style="height: 10px;">&nbsp;</td>
			  </tr>
			  <tr>
			  	<td colspan="6" style="text-align: left;" align="left">
			  		xxxx

			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">&nbsp;</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em;">Dear Business Partner,</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Welcome to the Angel Family.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6" style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We would like to thank you for your decision to associate with us as an Investment Advisor.  </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td><p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Angel Broking is a reputed brand in Indian financial services, enjoying an unmatched brand recall.  We have an excellent track record o
f consistent market growth in all key business segments alongwith having the biggest partner base in India. </p></td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">At Angel we value our partners &amp; work hard to provide them with best technical and business support to help them grow and full-fill dr
eams by taking their business to the next level. 
</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We are a technology driven brand and we strongly believe that latest technology is one of the key differentiators that will helpyou scale 
up the business. Basis this it is our constant endeavour to improve our technology platform so as to help you to acquire new clients, service existing clients without worrying too much about the  operational aspects of the business.  
</p>
			  	</td>
			  </tr>
			  
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Our cutting-edge technology is meant to empower you to as we understand the importance of your advice in guiding your client through his/h
er financial journey. </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We share your belief regarding the power of long lasting relationships. We work closely with our partners to help them build their advisor
y capabilities and client focused business. We offer an online investment platform BEENXT, a platform that offers the power of technology to help you to manage your clients with maximum efficiency and provide you with research information on regular basis
 so that you can assist your clients with great ease.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Given below are the details to help you access and discover the power of the BEE NXT Portal:</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 25px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<ul>
			  			<li style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Your Registration Details</li>
			  		</ul>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="padding-top:10px;">
			  		<table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em;">
					  <tbody>
						<tr>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Partner Name </td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Partner Code</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">ARN</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">EUIN</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Validity From</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;">Validity To</td>
						</tr>
						<tr>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #
DDD;">'+@SBName+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom :solid 1px #
DDD;">XYZ</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom :solid 1px #
DDD;">'+@ARNNo+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #
DDD;">'+@EUINNo+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #
DDD;">'+convert(varchar(10),@ValidityFrom)+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px; border-bottom: solid 1px #D
DD;">'+convert(varchar(10),@ValidityTo)+'</td>
						</tr>
					  </tbody>
					</table>

			  	</td>
			  </tr>
			  
			  
			   <tr>
			  	<td style="height: 25px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You are requested to affix in the Broker Column ARN â 77404 and the above code - in the Sub-broker column on all Mutual Fund applications 
sourced by you.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<ul>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">
			  				Portal URL : <a href="https://beenxt.angelbroking.com/" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">www.beenxt.angelbroking.com</a>
			  			</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Login id: Yogesh1</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Password: Yogesh1</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Exclusive Mobile Application For Your Clients: Angel Bee</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Website: <a href="https://www.angelbee.in/" target="_blank" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height:
 1.5em; color: #333333; text-decoration: none;">www.angelbee.in</a></li>
			  		</ul>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">In case of any issues or queries, please feel free to reach your dedicated Relationship Manager, 
Mr. PRASHANT V. GUPTA Mobile No: <a href="te;:7045649968" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">7045649968</a> &amp; Email-id : <a href="mailto:prashantv.gupt
a@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">prashantv.gupta@angelbroking.com</a> , who can help you to grow your business by providing you the o
n the ground  support.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">In case of any issues or queries, please feel free to reach your dedicated Relationship Manager, 
Mr. PRASHANT V. GUPTA Mobile No: <a href="te;:7045649968" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">7045649968</a> &amp; Email-id : <a href="mailto:prashantv.gupt
a@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">prashantv.gupta@angelbroking.com</a> , who can help you to grow your business by providing you the o
n the ground  support.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You can also connect with us at our Angel Broking Ltd. Regional Office </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Address: </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">
			  		Or Call us on <a href="tel:+91 22 4000 3600" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">+91 22 4000 3600</a> between 10:00 am to 6:00 pm on all trading days
 &amp; 10:00 am to 4:00 pm on Saturdays or alternatively you can also mail us at <a href="mailto:mfsd@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">
mfsd@angelbroking.com</a></p>
			  	</td>
			  </tr>
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You can also check our website <a href="http://www.angelbroking.com/" style="font-family: ''Arial'',sans-serif; color: #333333; font-size:
 15px; line-height: 1.5em; color: #333333; text-decoration: none;">www.angelbroking.com</a>, for latest updates regarding the industry and various research reports.</p>
			  	</td>
			  </tr>
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			    <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We assure to provide you services to the best of our ability at all times and we look forward to a long and mutually beneficial relationsh
ip.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Have a great day.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; font-weight: 700;">Team Angel Broking</p>
			  	</td>
			  </tr>
			  <tr>
			  	<td style="height: 25px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  
			  
			  </tbody>
			</table>

    	</td>
    
    
    	
    </tr>
    
    <tr>
    	<td style="border-left:solid 1px #DDD; border-right:solid 1px #DDD;">
    		<table width="800" border="0" align="center" cellpadding="0" cellspacing="0">
			  <tbody>
				<tr>
				  <td align="left" valign="top">
					<table align="center" border="0" cellpadding="0" cellspacing="0" style="" width="730">
					  <tbody>
						<tr>
						  <td height="20px">&nbsp;

						  </td>
						</tr>
						<tr>
						  <td align="center">
							<table width="100%">
							  <tbody>
								<tr>
							  <td width="180">
									<table border="0" cellpadding="2" cellspacing="2" width="118%">
									  <tbody>
										<tr>
										  <td width="50">
											<img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/call.png" style="width: 50px;">
										  </td>
										  <td align="left" height="18" style="font-family:''Arial'',sans-serif;font-size:16px;color:#6e6e6e;text-transform:normal;font-weight:normal; line-height: 1.5em;" valign="middle" width="131">
											<a href="tel:022-3355 1111" style="text-decoration: none; color:#333333;">022-3355 1111</a>
											<br>
											<a href="tel:022-4218 5454" style="text-decoration: none; color:#333333;">022-4218 5454</a>
										  </td>
										</tr>
									  </tbody>
									</table>
								  </td>
								  <td style="padding: 5px; text-align: center">
									<img alt="" height="40" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/commodity/b-right.jpg" width="2">
								  </td>
								  <td width="180">
									<table border="0" cellpadding="2" cellspacing="2" width="123%">
									  <tbody>
										<tr>
										  <td width="28%">
											<a href="http://www.angelbroking.com/ppc/openfreedemataccount-2stepnew?ag=em&amp;disid=9755&amp;utm_source=adtz&amp;utm_medium=mailer&amp;utm_campaign=new22" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/
jm/bnxt/web.png"></a>
										  </td>
										  <td width="72%" height="18" align="left" valign="middle" style="font-family:''Arial'',sans-serif;font-size:16px;color:#6e6e6e;text-transform:normal;font-weight:normal;">
											<a href="http://www.angelbroking.com/" target="_blank" style="text-decoration: none; color: #333333;">Visit Website</a>
										  </td>
										</tr>
									  </tbody>
									</table>
								  </td>


								  <td style="padding: 5px; text-align: center">
									<img alt="" height="40" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/commodity/border-right.jpg" width="2">
								  </td>
								  <td width="118">
									<table border="0" cellpadding="2" cellspacing="2" width="99%">
									  <tbody>
										<tr>
										  <td align="center" valign="middle" width="50">
											<a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/fb.png"></a>
										  </td>
										  <!--<td style="padding:5px"></td>-->
										  <td align="center" valign="middle" width="50">
											<a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/tw.png"></a>
										  </td>
										  <!--<td style="padding:5px"></td>-->
										  <td align="center" valign="middle" width="50">
											<a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/youtube.png" style=""></a>
										  </td>
										  <!--<td style="padding:5px"></td>-->
										  <td align="center" valign="middle" width="50">
											<a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/in.png"></a>
										  </td>
										</tr>
									  </tbody>
									</table>
								  </td>
								</tr>
							  </tbody>
							</table>
						  </td>
						</tr>
						<tr>
							<td align="center" style="padding: 5px 0;">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/line.png" alt="" style="display: block;">
							</td>
						</tr>
						<tr>
							<td style="height: 5px;"></td>
						</tr>
						<tr>
						  <td align="center" height="35" valign="middle">
							<table border="0" cellpadding="0" cellspacing="0" width="100%">
							  <tbody>
								<tr>
								  <td align="center" height="20" style="font-family:''Arial'',sans-serif;font-size:15px;color:#666666;text-transform:normal;font-weight:normal;" valign="middle">
									For any feedback or queries please mail us at <a href="mailto:partners@angelbroking.com" style="color:#666666;">partners@angelbroking.com</a>
								  </td>
								</tr>
							  </tbody>
							</table>
						  </td>
						</tr>
						<tr>
							<td style="height: 5px;"></td>
						</tr>
						<tr>
							<td align="center" style="padding: 5px 0;">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/line.png" alt="" style="display: block;">
							</td>
						</tr>
					  </tbody>
					</table>
				  </td>
				</tr>
				<tr>
			  <td align="center" valign="top">
				<table border="0" cellpadding="0" cellspacing="0" width="800">
				  <tbody>
					<tr>
					  <td align="left" style="height:20px;" valign="top">&nbsp;

					  </td>
					</tr>
					<tr>
					  <td align="center" valign="top">
						<table align="center" border="0" cellpadding="0" cellspacing="0" width="730" style="">
						  <tbody>
							<tr>
							  <td align="justify" style="font-family:''Arial'',sans-serif;font-size:13px;color:#999999;text-transform:normal;font-weight:normal;" valign="middle">
							  Disclaimer: âInvestments in securities market are subject to market risk, read all the related documents carefully before investing.âAngel Broking Limited (formerly known as Angel Broking Private Limited), Registered Office: G-1, Ackruti Trade Ce
nter, Road No. 7, MIDC, Andheri (E), Mumbai - 400 093. Telephone: (022) 3083 7700, Fax: (022) 2835 8811, CIN: U67120MH1996PLC101709, SEBI Registration No.: INZ000161534-BSE Cash/F&amp;O/CD (Member ID: 612), NSE Cash/F&amp;O/CD (Member ID: 12798), MSEI Cas
h/F&amp;O/CD (Member ID: 10500), MCX Commodity Derivatives (Member ID: 12685) and NCDEX Commodity Derivatives (Member ID: 220), CDSL Registration No.: IN-DP-384-2018, PMS Registration No.: INP000001546, Research Analyst SEBI Registration No.: INH000000164
, Investment Adviser SEBI Registration No.: INA000008172, AMFI Registration No.: ARNâ77404, PFRDA Registration No.: 19092018. Compliance officer: Ms. Namita Godbole, Tel: (022) 39413940

							  </td>
							</tr>
						  </tbody>
						</table>
					  </td>
					</tr>
					<tr>
					  <td align="center" valign="top">&nbsp;

					  </td>
					</tr>
				  </tbody>
				</table>
			  </td>
			</tr>
			  </tbody>
		</table>
    	</td>
    </tr>
  </tbody>
</table>



</body></html>

'

drop table #tblArnEuinMaster
Print @HTMLBODY


	EXEC msdb.dbo.sp_send_dbmail  
		@profile_name = 'BeeNXT',  
		@recipients=@recipients,
		--@copy_recipients='Yogesh.rewatkar@angelbroking.com;subbulakshmi.sk@angelbroking.com',
		--@blind_copy_recipients='Yogesh.rewatkar@angelbroking.com;Sphere.sharad@angelbroking.com;rewansh.jain@angelbroking.com',
		--@blind_copy_recipients=@BCC,
		@subject = 'Testing--Welcome to BEE NXT - The Next Generation Business platform',  
		@body = @HTMLBODY,
		@body_format = 'HTML'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WelcomeSBBEENXT_Mail_20_Nov_2021
-- --------------------------------------------------
  
CREATE Procedure WelcomeSBBEENXT_Mail_20_Nov_2021  
(  
  @sb_tag varchar(100)='AJYC'  
)  
as  
begin   
  
/*  
  
EXEC WelcomeSBBEENXT_Mail 'ajyc'  
  
*/  
  
  
DECLARE @HTMLBODY nvarchar(max)  
  
  
Declare @recipients varchar(100)='Yogesh.rewatkar@angelbroking.com'  
  
--Declare @sb_tag Varchar(200)  
  
Declare @SBName varchar(50) ,  
 @ARNNo varchar(200) ,  
 @ARNHolderName varchar(200),  
@ValidityFrom Date ,  
@ValidityTo date,  
@EUINNo varchar(200)  
  
Declare   
 @AddLine1 nVarchar(10),  
 @AddLine2 nVarchar(50),  
 @Landmark Varchar(50),  
 @City Varchar(15),  
 @State Varchar(20),  
 @Country Varchar(50),  
 @PinCode Varchar(10),   
 @MobNo Varchar(10),  
 @RefNo varchar(200),  
 @SalContactPerson Varchar(10),  
 @username Varchar(100),  
 @userpassword Varchar(100)  
  
--Set @sb_tag='AJYC'  
  
  
  
  
  
select * into #tblArnEuinMaster from mutualfund.dbo.tblArnEuinMaster with(nolock) where [SB EQUITY TAG]=@sb_tag   
  
  
select @username=username,@userpassword=userpassword  
 from [172.31.16.95].NXT.dbo.MF_UserLogin WITH (NOLOCK)  
where access_code=@sb_tag  
and usertype='User'  
  
  
select @RefNo=RefNo,@SalContactPerson=SalContactPerson from [196.1.115.167].SB_Comp.dbo.sb_broker  
where sbtag=@sb_tag  
  
  
  
select   
 @sb_tag=[SB Equity Tag],  
 @SBName=@SalContactPerson+' '+[SB Name] ,  
 @ARNNo=[ARN No] ,  
 @ARNHolderName=[ARN Holder Name],  
  @ValidityFrom=[Validity From] ,  
  @ValidityTo=[Validity To] ,  
  @EUINNo=[EUIN No]  
 from #tblArnEuinMaster  
  
  
select   
@AddLine1=rtrim(ltrim(AddLine1)) +' '+AddLine2 ,@Landmark=Landmark ,@City=City ,@State=State ,@Country=Country ,@PinCode=PinCode,   
@MobNo=MobNo  
 from [196.1.115.167].SB_Comp.dbo.sb_contact  
where RefNo=@RefNo  
and AddType='RES'  
  
Select   
 @AddLine1 AddLine1 ,  
 @AddLine2  AddLine2,  
 @Landmark Landmark ,  
 @City City ,  
 @State State ,  
 @Country Country ,  
 @PinCode PinCode ,   
 @MobNo MobNo   
  
  
  
  
  
  
  
set @HTMLBODY='  
  
<!doctype html>  
<html><head>  
<meta charset="utf-8">  
<title>Bee Nxt</title>  
</head>  
  
<body>  
<table width="800" border="0" cellspacing="0" cellpadding="0" align="center">  
  <tbody>  
    <tr>  
      <td>  
       <a href="#">  
        <img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/header.png" alt="" style="display: block">  
       </a>  
      </td>  
    </tr>  
    <tr>  
     <td>  
      <a href="#">  
       <img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/banner.png" alt="" style="display: block;">  
      </a>  
     </td>  
    </tr>  
    <tr>  
     <td style="border-left:solid 1px #ddd; border-right:solid 1px #DDD; border-bottom: solid 1px #DDD;">  
      <table width="730" border="0" cellspacing="0" cellpadding="0" align="center">  
     <tbody>  
     <tr>  
      <td style="height: 10px;">&nbsp;</td>  
     </tr>  
    <tr>  
      <td style="text-align: right;" align="right">  
     <p style="margin: 0; font-family: ''Arial'',sans-serif; font-size: 14px;">  
      November 5th, 2018  
     </p>  
    </td>  
    </tr>  
    <tr>  
      <td style="height: 10px;">&nbsp;</td>  
     </tr>  
     <tr>  
      <td colspan="6" style="text-align: left;" align="left">  
       xxxx  
  
      </td>  
     </tr>  
       
     <tr>  
      <td colspan="6">&nbsp;</td>  
     </tr>  
       
     <tr>  
      <td colspan="6">  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em;">Dear Business Partner,</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td colspan="6">  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Welcome to the Angel Family.</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td colspan="6" style="height: 10px;">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td colspan="6">  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We would like to thank you for your decision to associate with us as an Investment Advisor.  </p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 10px;">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td><p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Angel Broking is a reputed brand in Indian financial services, enjoying an unmatched brand recall.  We have an excellent track record o
f consistent market growth in all key business segments alongwith having the biggest partner base in India. </p></td>  
     </tr>  
       
     <tr>  
      <td style="height: 10px;">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">At Angel we value our partners &amp; work hard to provide them with best technical and business support to help them grow and full-fill dr
eams by taking their business to the next level.   
</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 10px;">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We are a technology driven brand and we strongly believe that latest technology is one of the key differentiators that will helpyou scale 
up the business. Basis this it is our constant endeavour to improve our technology platform so as to help you to acquire new clients, service existing clients without worrying too much about the  operational aspects of the business.    
</p>  
      </td>  
     </tr>  
       
       
     <tr>  
      <td style="height: 10px;">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Our cutting-edge technology is meant to empower you to as we understand the importance of your advice in guiding your client through his/h
er financial journey. </p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 10px;">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We share your belief regarding the power of long lasting relationships. We work closely with our partners to help them build their advisor
y capabilities and client focused business. We offer an online investment platform BEENXT, a platform that offers the power of technology to help you to manage your clients with maximum efficiency and provide you with research information on regular basis
 so that you can assist your clients with great ease.</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 10px;">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Given below are the details to help you access and discover the power of the BEE NXT Portal:</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 25px">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <ul>  
        <li style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Your Registration Details</li>  
       </ul>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="padding-top:10px;">  
       <table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em;">  
       <tbody>  
      <tr>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Partner Name </td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Partner Code</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">ARN</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">EUIN</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Validity From</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;">Validity To</td>  
      </tr>  
      <tr>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #
DDD;">'+@SBName+'</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom :solid 1px #
DDD;">XYZ</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom :solid 1px #
DDD;">'+@ARNNo+'</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #
DDD;">'+@EUINNo+'</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #
DDD;">'+convert(varchar(10),@ValidityFrom)+'</td>  
        <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px; border-bottom: solid 1px #D
DD;">'+convert(varchar(10),@ValidityTo)+'</td>  
      </tr>  
       </tbody>  
     </table>  
  
      </td>  
     </tr>  
       
       
      <tr>  
      <td style="height: 25px">&nbsp;  
         
      </td>  
     </tr>  
       
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You are requested to affix in the Broker Column ARN â 77404 and the above code - in the Sub-broker column on all Mutual Fund applications 
sourced by you.</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <ul>  
        <li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">  
         Portal URL : <a href="https://beenxt.angelbroking.com/" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">www.beenxt.angelbroking.com</a>  
        </li>  
        <li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Login id: Yogesh1</li>  
        <li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Password: Yogesh1</li>  
        <li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Exclusive Mobile Application For Your Clients: Angel Bee</li>  
        <li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Website: <a href="https://www.angelbee.in/" target="_blank" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height:
 1.5em; color: #333333; text-decoration: none;">www.angelbee.in</a></li>  
       </ul>  
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">In case of any issues or queries, please feel free to reach your dedicated Relationship Manager,   
Mr. PRASHANT V. GUPTA Mobile No: <a href="te;:7045649968" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">7045649968</a> &amp; Email-id : <a href="mailto:prashantv.gupt
a@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">prashantv.gupta@angelbroking.com</a> , who can help you to grow your business by providing you the o
n the ground  support.</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 15px">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">In case of any issues or queries, please feel free to reach your dedicated Relationship Manager,   
Mr. PRASHANT V. GUPTA Mobile No: <a href="te;:7045649968" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">7045649968</a> &amp; Email-id : <a href="mailto:prashantv.gupt
a@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">prashantv.gupta@angelbroking.com</a> , who can help you to grow your business by providing you the o
n the ground  support.</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 15px">&nbsp;  
         
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You can also connect with us at our Angel Broking Ltd. Regional Office </p>  
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Address: </p>  
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">  
       Or Call us on <a href="tel:+91 22 4000 3600" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">+91 22 4000 3600</a> between 10:00 am to 6:00 pm on all trading days
 &amp; 10:00 am to 4:00 pm on Saturdays or alternatively you can also mail us at <a href="mailto:mfsd@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">
mfsd@angelbroking.com</a></p>  
      </td>  
     </tr>  
     <tr>  
      <td style="height: 15px">&nbsp;  
         
      </td>  
     </tr>  
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You can also check our website <a href="http://www.angelbroking.com/" style="font-family: ''Arial'',sans-serif; color: #333333; font-size:
 15px; line-height: 1.5em; color: #333333; text-decoration: none;">www.angelbroking.com</a>, for latest updates regarding the industry and various research reports.</p>  
      </td>  
     </tr>  
     <tr>  
      <td style="height: 15px">&nbsp;  
         
      </td>  
     </tr>  
       <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We assure to provide you services to the best of our ability at all times and we look forward to a long and mutually beneficial relationsh
ip.</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td style="height: 15px">&nbsp;  
         
      </td>  
     </tr>  
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Have a great day.</p>  
      </td>  
     </tr>  
       
     <tr>  
      <td>  
       <p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; font-weight: 700;">Team Angel Broking</p>  
      </td>  
     </tr>  
     <tr>  
      <td style="height: 25px">&nbsp;  
         
      </td>  
     </tr>  
       
       
       
     </tbody>  
   </table>  
  
     </td>  
      
      
       
    </tr>  
      
    <tr>  
     <td style="border-left:solid 1px #DDD; border-right:solid 1px #DDD;">  
      <table width="800" border="0" align="center" cellpadding="0" cellspacing="0">  
     <tbody>  
    <tr>  
      <td align="left" valign="top">  
     <table align="center" border="0" cellpadding="0" cellspacing="0" style="" width="730">  
       <tbody>  
      <tr>  
        <td height="20px">&nbsp;  
  
        </td>  
      </tr>  
      <tr>  
        <td align="center">  
       <table width="100%">  
         <tbody>  
        <tr>  
         <td width="180">  
         <table border="0" cellpadding="2" cellspacing="2" width="118%">  
           <tbody>  
          <tr>  
            <td width="50">  
           <img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/call.png" style="width: 50px;">  
            </td>  
            <td align="left" height="18" style="font-family:''Arial'',sans-serif;font-size:16px;color:#6e6e6e;text-transform:normal;font-weight:normal; line-height: 1.5em;" valign="middle" width="131">  
           <a href="tel:022-3355 1111" style="text-decoration: none; color:#333333;">022-3355 1111</a>  
           <br>  
           <a href="tel:022-4218 5454" style="text-decoration: none; color:#333333;">022-4218 5454</a>  
            </td>  
          </tr>  
           </tbody>  
         </table>  
          </td>  
          <td style="padding: 5px; text-align: center">  
         <img alt="" height="40" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/commodity/b-right.jpg" width="2">  
          </td>  
          <td width="180">  
         <table border="0" cellpadding="2" cellspacing="2" width="123%">  
           <tbody>  
          <tr>  
            <td width="28%">  
           <a href="http://www.angelbroking.com/ppc/openfreedemataccount-2stepnew?ag=em&amp;disid=9755&amp;utm_source=adtz&amp;utm_medium=mailer&amp;utm_campaign=new22" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/
jm/bnxt/web.png"></a>  
            </td>  
            <td width="72%" height="18" align="left" valign="middle" style="font-family:''Arial'',sans-serif;font-size:16px;color:#6e6e6e;text-transform:normal;font-weight:normal;">  
           <a href="http://www.angelbroking.com/" target="_blank" style="text-decoration: none; color: #333333;">Visit Website</a>  
            </td>  
          </tr>  
           </tbody>  
         </table>  
          </td>  
  
  
          <td style="padding: 5px; text-align: center">  
         <img alt="" height="40" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/commodity/border-right.jpg" width="2">  
          </td>  
          <td width="118">  
         <table border="0" cellpadding="2" cellspacing="2" width="99%">  
           <tbody>  
          <tr>  
            <td align="center" valign="middle" width="50">  
           <a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/fb.png"></a>  
            </td>  
            <!--<td style="padding:5px"></td>-->  
            <td align="center" valign="middle" width="50">  
           <a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/tw.png"></a>  
            </td>  
            <!--<td style="padding:5px"></td>-->  
            <td align="center" valign="middle" width="50">  
           <a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/youtube.png" style=""></a>  
            </td>  
            <!--<td style="padding:5px"></td>-->  
            <td align="center" valign="middle" width="50">  
           <a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/in.png"></a>  
            </td>  
          </tr>  
           </tbody>  
         </table>  
          </td>  
        </tr>  
         </tbody>  
       </table>  
        </td>  
      </tr>  
      <tr>  
       <td align="center" style="padding: 5px 0;">  
        <img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/line.png" alt="" style="display: block;">  
       </td>  
      </tr>  
      <tr>  
       <td style="height: 5px;"></td>  
      </tr>  
      <tr>  
        <td align="center" height="35" valign="middle">  
       <table border="0" cellpadding="0" cellspacing="0" width="100%">  
         <tbody>  
        <tr>  
          <td align="center" height="20" style="font-family:''Arial'',sans-serif;font-size:15px;color:#666666;text-transform:normal;font-weight:normal;" valign="middle">  
         For any feedback or queries please mail us at <a href="mailto:partners@angelbroking.com" style="color:#666666;">partners@angelbroking.com</a>  
          </td>  
        </tr>  
         </tbody>  
       </table>  
        </td>  
      </tr>  
      <tr>  
       <td style="height: 5px;"></td>  
      </tr>  
      <tr>  
       <td align="center" style="padding: 5px 0;">  
        <img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/line.png" alt="" style="display: block;">  
       </td>  
      </tr>  
       </tbody>  
     </table>  
      </td>  
    </tr>  
    <tr>  
     <td align="center" valign="top">  
    <table border="0" cellpadding="0" cellspacing="0" width="800">  
      <tbody>  
     <tr>  
       <td align="left" style="height:20px;" valign="top">&nbsp;  
  
       </td>  
     </tr>  
     <tr>  
       <td align="center" valign="top">  
      <table align="center" border="0" cellpadding="0" cellspacing="0" width="730" style="">  
        <tbody>  
       <tr>  
         <td align="justify" style="font-family:''Arial'',sans-serif;font-size:13px;color:#999999;text-transform:normal;font-weight:normal;" valign="middle">  
         Disclaimer: âInvestments in securities market are subject to market risk, read all the related documents carefully before investing.âAngel Broking Limited (formerly known as Angel Broking Private Limited), Registered Office: G-1, Ackruti Trade Ce
nter, Road No. 7, MIDC, Andheri (E), Mumbai - 400 093. Telephone: (022) 3083 7700, Fax: (022) 2835 8811, CIN: U67120MH1996PLC101709, SEBI Registration No.: INZ000161534-BSE Cash/F&amp;O/CD (Member ID: 612), NSE Cash/F&amp;O/CD (Member ID: 12798), MSEI Cas
h/F&amp;O/CD (Member ID: 10500), MCX Commodity Derivatives (Member ID: 12685) and NCDEX Commodity Derivatives (Member ID: 220), CDSL Registration No.: IN-DP-384-2018, PMS Registration No.: INP000001546, Research Analyst SEBI Registration No.: INH000000164
, Investment Adviser SEBI Registration No.: INA000008172, AMFI Registration No.: ARNâ77404, PFRDA Registration No.: 19092018. Compliance officer: Ms. Namita Godbole, Tel: (022) 39413940  
  
         </td>  
       </tr>  
        </tbody>  
      </table>  
       </td>  
     </tr>  
     <tr>  
       <td align="center" valign="top">&nbsp;  
  
       </td>  
     </tr>  
      </tbody>  
    </table>  
     </td>  
   </tr>  
     </tbody>  
  </table>  
     </td>  
    </tr>  
  </tbody>  
</table>  
  
  
  
</body></html>  
  
'  
  
drop table #tblArnEuinMaster  
Print @HTMLBODY  
  
  
 EXEC msdb.dbo.sp_send_dbmail    
  @profile_name = 'BeeNXT',    
  @recipients=@recipients,  
  --@copy_recipients='Yogesh.rewatkar@angelbroking.com;subbulakshmi.sk@angelbroking.com',  
  --@blind_copy_recipients='Yogesh.rewatkar@angelbroking.com;Sphere.sharad@angelbroking.com;rewansh.jain@angelbroking.com',  
  --@blind_copy_recipients=@BCC,  
  @subject = 'Testing--Welcome to BEE NXT - The Next Generation Business platform',    
  @body = @HTMLBODY,  
  @body_format = 'HTML'  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WelcomeSBBEENXT_Mail_28112018
-- --------------------------------------------------

CREATE Procedure [dbo].[WelcomeSBBEENXT_Mail_28112018]
(
		@sb_tag varchar(100)='AJYC'
)
as
begin 

/*

EXEC WelcomeSBBEENXT_Mail 'ajyc'

*/


DECLARE @HTMLBODY varchar(max)


Declare @recipients varchar(100)='Prashant.patade@angelbroking.com'

--Declare @sb_tag Varchar(200)

Declare @SBName varchar(50)	,
	@ARNNo varchar(200)	,
	@ARNHolderName varchar(200),
@ValidityFrom Date	,
@ValidityTo	date,
@EUINNo varchar(200)

Declare 
	@AddLine1	nVarchar(10),
	@AddLine2	nVarchar(50),
	@Landmark	Varchar(50),
	@City	Varchar(15),
	@State	Varchar(20),
	@Country	Varchar(50),
	@PinCode Varchar(10), 
	@MobNo Varchar(10),
	@RefNo varchar(200),
	@SalContactPerson Varchar(10),
	@username Varchar(100),
	@userpassword Varchar(100)

--Set @sb_tag='AJYC'





select * into #tblArnEuinMaster from mutualfund.dbo.tblArnEuinMaster with(nolock) where [SB EQUITY TAG]=@sb_tag 


select @username=username,@userpassword=userpassword
 from [172.31.16.95].NXT.dbo.MF_UserLogin WITH (NOLOCK)
where access_code=@sb_tag
and usertype='User'


select @RefNo=RefNo,@SalContactPerson=SalContactPerson from [196.1.115.167].SB_Comp.dbo.sb_broker
where sbtag=@sb_tag



select 
	@sb_tag=[SB Equity Tag],
	@SBName=@SalContactPerson+' '+[SB Name]	,
	@ARNNo=[ARN No]	,
	@ARNHolderName=[ARN Holder Name],
		@ValidityFrom=[Validity From]	,
		@ValidityTo=[Validity To]	,
		@EUINNo=[EUIN No]
 from #tblArnEuinMaster


select 
@AddLine1=rtrim(ltrim(AddLine1)) +' '+AddLine2	,@Landmark=Landmark	,@City=City	,@State=State	,@Country=Country	,@PinCode=PinCode, 
@MobNo=MobNo
 from [196.1.115.167].SB_Comp.dbo.sb_contact
where RefNo=@RefNo
and AddType='RES'

Select 
	@AddLine1 AddLine1	,
	@AddLine2	 AddLine2,
	@Landmark Landmark	,
	@City City	,
	@State State	,
	@Country Country	,
	@PinCode PinCode , 
	@MobNo MobNo 







set @HTMLBODY='

<!doctype html>
<html><head>
<meta charset="utf-8">
<title>Bee Nxt</title>
</head>

<body>
<table width="800" border="0" cellspacing="0" cellpadding="0" align="center">
  <tbody>
    <tr>
      <td>
      	<a href="#">
      		<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/header.png" alt="" style="display: block">
      	</a>
      </td>
    </tr>
    <tr>
    	<td>
    		<a href="#">
    			<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/banner.png" alt="" style="display: block;">
    		</a>
    	</td>
    </tr>
    <tr>
    	<td style="border-left:solid 1px #ddd; border-right:solid 1px #DDD; border-bottom: solid 1px #DDD;">
    		<table width="730" border="0" cellspacing="0" cellpadding="0" align="center">
			  <tbody>
			  <tr>
			  	<td style="height: 10px;">&nbsp;</td>
			  </tr>
				<tr>
				  <td style="text-align: right;" align="right">
					<p style="margin: 0; font-family: ''Arial'',sans-serif; font-size: 14px;">
						November 5th, 2018
					</p>
				</td>
				</tr>
				<tr>
			  	<td style="height: 10px;">&nbsp;</td>
			  </tr>
			  <tr>
			  	<td colspan="6" style="text-align: left;" align="left">
			  		xxxx

			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">&nbsp;</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em;">Dear Business Partner,</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Welcome to the Angel Family.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6" style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td colspan="6">
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We would like to thank you for your decision to associate with us as an Investment Advisor.  </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td><p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Angel Broking is a reputed brand in Indian financial services, enjoying an unmatched brand recall.  We have an excellent track record of consistent market growth in all key business segments alongwith having the biggest partner base in India. </p></td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">At Angel we value our partners &amp; work hard to provide them with best technical and business support to help them grow and full-fill dreams by taking their business to the next level. 
</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We are a technology driven brand and we strongly believe that latest technology is one of the key differentiators that will helpyou scale up the business. Basis this it is our constant endeavour to improve our technology platform so as to help you to acquire new clients, service existing clients without worrying too much about the  operational aspects of the business.  
</p>
			  	</td>
			  </tr>
			  
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Our cutting-edge technology is meant to empower you to as we understand the importance of your advice in guiding your client through his/her financial journey. </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We share your belief regarding the power of long lasting relationships. We work closely with our partners to help them build their advisory capabilities and client focused business. We offer an online investment platform BEENXT, a platform that offers the power of technology to help you to manage your clients with maximum efficiency and provide you with research information on regular basis so that you can assist your clients with great ease.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 10px;">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Given below are the details to help you access and discover the power of the BEE NXT Portal:</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 25px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<ul>
			  			<li style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Your Registration Details</li>
			  		</ul>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="padding-top:10px;">
			  		<table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em;">
					  <tbody>
						<tr>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Partner Name </td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Partner Code</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">ARN</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">EUIN</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD; padding: 5px;">Validity From</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;">Validity To</td>
						</tr>
						<tr>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #DDD;">'+@SBName+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom :solid 1px #DDD;">XYZ</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom :solid 1px #DDD;">'+@ARNNo+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #DDD;">'+@EUINNo+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px;  border-bottom: solid 1px #DDD;">'+convert(varchar(10),@ValidityFrom)+'</td>
						  <td style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; text-align: center; border-left:solid 1px #ddd;  border-right:solid 1px #ddd; border-top:solid 1px #DDD;  padding: 5px; border-bottom: solid 1px #DDD;">'+convert(varchar(10),@ValidityTo)+'</td>
						</tr>
					  </tbody>
					</table>

			  	</td>
			  </tr>
			  
			  
			   <tr>
			  	<td style="height: 25px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You are requested to affix in the Broker Column ARN â 77404 and the above code - in the Sub-broker column on all Mutual Fund applications sourced by you.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<ul>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">
			  				Portal URL : <a href="https://beenxt.angelbroking.com/" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">www.beenxt.angelbroking.com</a>
			  			</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Login id: Yogesh1</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Password: Yogesh1</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Exclusive Mobile Application For Your Clients: Angel Bee</li>
			  			<li style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.6em;">Website: <a href="https://www.angelbee.in/" target="_blank" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">www.angelbee.in</a></li>
			  		</ul>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">In case of any issues or queries, please feel free to reach your dedicated Relationship Manager, 
Mr. PRASHANT V. GUPTA Mobile No: <a href="te;:7045649968" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">7045649968</a> &amp; Email-id : <a href="mailto:prashantv.gupta@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">prashantv.gupta@angelbroking.com</a> , who can help you to grow your business by providing you the on the ground  support.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">In case of any issues or queries, please feel free to reach your dedicated Relationship Manager, 
Mr. PRASHANT V. GUPTA Mobile No: <a href="te;:7045649968" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">7045649968</a> &amp; Email-id : <a href="mailto:prashantv.gupta@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">prashantv.gupta@angelbroking.com</a> , who can help you to grow your business by providing you the on the ground  support.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You can also connect with us at our Angel Broking Ltd. Regional Office </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Address: </p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">
			  		Or Call us on <a href="tel:+91 22 4000 3600" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">+91 22 4000 3600</a> between 10:00 am to 6:00 pm on all trading days &amp; 10:00 am to 4:00 pm on Saturdays or alternatively you can also mail us at <a href="mailto:mfsd@angelbroking.com" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">mfsd@angelbroking.com</a></p>
			  	</td>
			  </tr>
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">You can also check our website <a href="http://www.angelbroking.com/" style="font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px; line-height: 1.5em; color: #333333; text-decoration: none;">www.angelbroking.com</a>, for latest updates regarding the industry and various research reports.</p>
			  	</td>
			  </tr>
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			    <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">We assure to provide you services to the best of our ability at all times and we look forward to a long and mutually beneficial relationship.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td style="height: 15px">&nbsp;
			  		
			  	</td>
			  </tr>
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em">Have a great day.</p>
			  	</td>
			  </tr>
			  
			  <tr>
			  	<td>
			  		<p style="margin: 0; font-family: ''Arial'',sans-serif; color: #333333; font-size: 15px;  line-height: 1.5em; font-weight: 700;">Team Angel Broking</p>
			  	</td>
			  </tr>
			  <tr>
			  	<td style="height: 25px">&nbsp;
			  		
			  	</td>
			  </tr>
			  
			  
			  
			  </tbody>
			</table>

    	</td>
    
    
    	
    </tr>
    
    <tr>
    	<td style="border-left:solid 1px #DDD; border-right:solid 1px #DDD;">
    		<table width="800" border="0" align="center" cellpadding="0" cellspacing="0">
			  <tbody>
				<tr>
				  <td align="left" valign="top">
					<table align="center" border="0" cellpadding="0" cellspacing="0" style="" width="730">
					  <tbody>
						<tr>
						  <td height="20px">&nbsp;

						  </td>
						</tr>
						<tr>
						  <td align="center">
							<table width="100%">
							  <tbody>
								<tr>
							  <td width="180">
									<table border="0" cellpadding="2" cellspacing="2" width="118%">
									  <tbody>
										<tr>
										  <td width="50">
											<img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/call.png" style="width: 50px;">
										  </td>
										  <td align="left" height="18" style="font-family:''Arial'',sans-serif;font-size:16px;color:#6e6e6e;text-transform:normal;font-weight:normal; line-height: 1.5em;" valign="middle" width="131">
											<a href="tel:022-3355 1111" style="text-decoration: none; color:#333333;">022-3355 1111</a>
											<br>
											<a href="tel:022-4218 5454" style="text-decoration: none; color:#333333;">022-4218 5454</a>
										  </td>
										</tr>
									  </tbody>
									</table>
								  </td>
								  <td style="padding: 5px; text-align: center">
									<img alt="" height="40" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/commodity/b-right.jpg" width="2">
								  </td>
								  <td width="180">
									<table border="0" cellpadding="2" cellspacing="2" width="123%">
									  <tbody>
										<tr>
										  <td width="28%">
											<a href="http://www.angelbroking.com/ppc/openfreedemataccount-2stepnew?ag=em&amp;disid=9755&amp;utm_source=adtz&amp;utm_medium=mailer&amp;utm_campaign=new22" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/web.png"></a>
										  </td>
										  <td width="72%" height="18" align="left" valign="middle" style="font-family:''Arial'',sans-serif;font-size:16px;color:#6e6e6e;text-transform:normal;font-weight:normal;">
											<a href="http://www.angelbroking.com/" target="_blank" style="text-decoration: none; color: #333333;">Visit Website</a>
										  </td>
										</tr>
									  </tbody>
									</table>
								  </td>


								  <td style="padding: 5px; text-align: center">
									<img alt="" height="40" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/commodity/border-right.jpg" width="2">
								  </td>
								  <td width="118">
									<table border="0" cellpadding="2" cellspacing="2" width="99%">
									  <tbody>
										<tr>
										  <td align="center" valign="middle" width="50">
											<a href="https://www.facebook.com/AngelBrokingLtd" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/fb.png"></a>
										  </td>
										  <!--<td style="padding:5px"></td>-->
										  <td align="center" valign="middle" width="50">
											<a href="https://twitter.com/AngelBrokingLtd" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/tw.png"></a>
										  </td>
										  <!--<td style="padding:5px"></td>-->
										  <td align="center" valign="middle" width="50">
											<a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/youtube.png" style=""></a>
										  </td>
										  <!--<td style="padding:5px"></td>-->
										  <td align="center" valign="middle" width="50">
											<a href="https://www.linkedin.com/company/angel-broking" target="_blank"><img alt="" src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/in.png"></a>
										  </td>
										</tr>
									  </tbody>
									</table>
								  </td>
								</tr>
							  </tbody>
							</table>
						  </td>
						</tr>
						<tr>
							<td align="center" style="padding: 5px 0;">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/line.png" alt="" style="display: block;">
							</td>
						</tr>
						<tr>
							<td style="height: 5px;"></td>
						</tr>
						<tr>
						  <td align="center" height="35" valign="middle">
							<table border="0" cellpadding="0" cellspacing="0" width="100%">
							  <tbody>
								<tr>
								  <td align="center" height="20" style="font-family:''Arial'',sans-serif;font-size:15px;color:#666666;text-transform:normal;font-weight:normal;" valign="middle">
									For any feedback or queries please mail us at <a href="mailto:partners@angelbroking.com" style="color:#666666;">partners@angelbroking.com</a>
								  </td>
								</tr>
							  </tbody>
							</table>
						  </td>
						</tr>
						<tr>
							<td style="height: 5px;"></td>
						</tr>
						<tr>
							<td align="center" style="padding: 5px 0;">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/bnxt/line.png" alt="" style="display: block;">
							</td>
						</tr>
					  </tbody>
					</table>
				  </td>
				</tr>
				<tr>
			  <td align="center" valign="top">
				<table border="0" cellpadding="0" cellspacing="0" width="800">
				  <tbody>
					<tr>
					  <td align="left" style="height:20px;" valign="top">&nbsp;

					  </td>
					</tr>
					<tr>
					  <td align="center" valign="top">
						<table align="center" border="0" cellpadding="0" cellspacing="0" width="730" style="">
						  <tbody>
							<tr>
							  <td align="justify" style="font-family:''Arial'',sans-serif;font-size:13px;color:#999999;text-transform:normal;font-weight:normal;" valign="middle">
							  Disclaimer: âInvestments in securities market are subject to market risk, read all the related documents carefully before investing.âAngel Broking Limited (formerly known as Angel Broking Private Limited), Registered Office: G-1, Ackruti Trade Center, Road No. 7, MIDC, Andheri (E), Mumbai - 400 093. Telephone: (022) 3083 7700, Fax: (022) 2835 8811, CIN: U67120MH1996PLC101709, SEBI Registration No.: INZ000161534-BSE Cash/F&amp;O/CD (Member ID: 612), NSE Cash/F&amp;O/CD (Member ID: 12798), MSEI Cash/F&amp;O/CD (Member ID: 10500), MCX Commodity Derivatives (Member ID: 12685) and NCDEX Commodity Derivatives (Member ID: 220), CDSL Registration No.: IN-DP-384-2018, PMS Registration No.: INP000001546, Research Analyst SEBI Registration No.: INH000000164, Investment Adviser SEBI Registration No.: INA000008172, AMFI Registration No.: ARNâ77404, PFRDA Registration No.: 19092018. Compliance officer: Ms. Namita Godbole, Tel: (022) 39413940

							  </td>
							</tr>
						  </tbody>
						</table>
					  </td>
					</tr>
					<tr>
					  <td align="center" valign="top">&nbsp;

					  </td>
					</tr>
				  </tbody>
				</table>
			  </td>
			</tr>
			  </tbody>
		</table>
    	</td>
    </tr>
  </tbody>
</table>



</body></html>

'

drop table #tblArnEuinMaster
Print @HTMLBODY


	EXEC msdb.dbo.sp_send_dbmail  
		@profile_name = 'BeeNXT',  
		@recipients=@recipients,
		--@copy_recipients='Yogesh.rewatkar@angelbroking.com;subbulakshmi.sk@angelbroking.com',
		--@blind_copy_recipients='Yogesh.rewatkar@angelbroking.com;Sphere.sharad@angelbroking.com;rewansh.jain@angelbroking.com',
		--@blind_copy_recipients=@BCC,
		@subject = 'Testing--Welcome to BEE NXT - The Next Generation Business platform',  
		@body = @HTMLBODY,
		@body_format = 'HTML'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.whats_new
-- --------------------------------------------------
CREATE procedure [dbo].[whats_new](@catcode as varchar(10),@username as varchar(10))    
as    
set nocount on
set transaction isolation level read uncommitted  

SELECT REPORT_PATH,NoOfAccess=COUNT(*),last_access=max(Access_datetime ),userid     
into #f1
FROM login_logs with (nolock) where userid=@username group by report_path,userid 

select a.*,noofaccess=isnull(noofaccess,0),last_access,userid 
into #file1 from
(select * from vw_menu_item_active with (nolock) where cat_Code=@catcode) a left outer join     
#f1 b    
on a.menu_url=b.REPORT_PATH   

select Head,Sub_head,menu_name,menu_desc,menu_url     
from get_menu_option (nolock) where cat_Code=@catcode and userid=@username and menu_code not in    
(select menu_code from #file1 (nolock) where userid=@username)    
order by head,sub_head,menu_name    
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.xtraMapping_inhouseWD
-- --------------------------------------------------

create procedure [dbo].[xtraMapping_inhouseWD]
AS
BEGIN
delete from extra_cat_mapping where mapped_by='System'

insert into extra_cat_mapping
select empcode,'','System',getdate() 
from [196.1.115.215].demotraning.dbo.tbl_EmployeeCodeData
END

GO

-- --------------------------------------------------
-- TABLE dbo.access_level
-- --------------------------------------------------
CREATE TABLE [dbo].[access_level]
(
    [Access_level_value] VARCHAR(25) NULL,
    [Access_level_name] VARCHAR(25) NULL,
    [Access_level_code] INT NULL,
    [Access_level_seq] INT NULL,
    [Access_level_Active] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AdminUsers
-- --------------------------------------------------
CREATE TABLE [dbo].[AdminUsers]
(
    [EmpCode] VARCHAR(10) NULL,
    [AddedOn] DATETIME NULL,
    [AddedBy] VARCHAR(10) NULL,
    [ActiveStatus] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AdminUsers_log
-- --------------------------------------------------
CREATE TABLE [dbo].[AdminUsers_log]
(
    [EmpCode] VARCHAR(10) NULL,
    [AddedOn] DATETIME NULL,
    [AddedBy] VARCHAR(10) NULL,
    [ActiveStatus] INT NULL,
    [ActionDate] DATETIME NULL,
    [Action] VARCHAR(10) NULL,
    [host] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AfterRemoveDuplicate
-- --------------------------------------------------
CREATE TABLE [dbo].[AfterRemoveDuplicate]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(20) NULL,
    [userpassword] VARCHAR(20) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AIAAS_ExEmpActiveLogin_data
-- --------------------------------------------------
CREATE TABLE [dbo].[AIAAS_ExEmpActiveLogin_data]
(
    [segment] VARCHAR(5) NOT NULL,
    [BO_LoginId] VARCHAR(25) NULL,
    [emp_no] VARCHAR(8) NULL,
    [Emp_name] VARCHAR(150) NULL,
    [designation] VARCHAR(255) NULL,
    [CostCode] NVARCHAR(255) NULL,
    [separationdate] DATETIME NULL,
    [CategoryDesc] VARCHAR(50) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sr_Name] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.aiaas_exempactivelogin_data_new
-- --------------------------------------------------
CREATE TABLE [dbo].[aiaas_exempactivelogin_data_new]
(
    [segment] VARCHAR(5) NOT NULL,
    [BO_LoginId] VARCHAR(25) NULL,
    [emp_no] VARCHAR(8) NULL,
    [Emp_name] VARCHAR(150) NULL,
    [designation] VARCHAR(255) NULL,
    [CostCode] NVARCHAR(255) NULL,
    [separationdate] DATETIME NULL,
    [CategoryDesc] VARCHAR(50) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sr_Name] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BlockedDra_List
-- --------------------------------------------------
CREATE TABLE [dbo].[BlockedDra_List]
(
    [DRA Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch
-- --------------------------------------------------
CREATE TABLE [dbo].[branch]
(
    [sbtag] VARCHAR(10) NULL,
    [tradername] VARCHAR(100) NULL,
    [abl_upd] DATETIME NULL,
    [acdl_upd] DATETIME NULL,
    [fo_upd] DATETIME NULL,
    [email] VARCHAR(50) NULL,
    [add1] VARCHAR(50) NULL,
    [add2] VARCHAR(50) NULL,
    [add3] VARCHAR(50) NULL,
    [add4] VARCHAR(50) NULL,
    [add5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BRANCH_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[BRANCH_MASTER]
(
    [Branch_cd] VARCHAR(10) NULL,
    [BrMast_cd] VARCHAR(16) NULL,
    [BrMast_name] VARCHAR(25) NULL,
    [Mapped_By] VARCHAR(50) NULL,
    [Mapped_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_1
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_1]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_20mar2023
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_20mar2023]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_HIST]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL,
    [DeletedOn] VARCHAR(50) NULL,
    [DeletedBy] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_log
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_log]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL,
    [DT] DATETIME NOT NULL,
    [Action] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_pd
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_pd]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_sep25
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_sep25]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_temp]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.codes
-- --------------------------------------------------
CREATE TABLE [dbo].[codes]
(
    [Employee Id] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ConfData
-- --------------------------------------------------
CREATE TABLE [dbo].[ConfData]
(
    [head] VARCHAR(100) NULL,
    [subhead] VARCHAR(100) NULL,
    [menu] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dd
-- --------------------------------------------------
CREATE TABLE [dbo].[dd]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.emp_info
-- --------------------------------------------------
CREATE TABLE [dbo].[emp_info]
(
    [emp_no] VARCHAR(8) NULL,
    [Emp_name] VARCHAR(150) NULL,
    [email] VARCHAR(100) NULL,
    [Status] CHAR(1) NULL,
    [Level] VARCHAR(50) NULL,
    [CategoryDesc] VARCHAR(50) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub_Department] VARCHAR(150) NULL,
    [designation] VARCHAR(255) NULL,
    [CostCode] NVARCHAR(255) NULL,
    [JoinDate] DATETIME NULL,
    [SeparationDate] DATETIME NULL,
    [Sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [Address] VARCHAR(300) NULL,
    [Pin] VARCHAR(1) NOT NULL,
    [City] VARCHAR(50) NULL,
    [emp_region] VARCHAR(50) NULL,
    [acntno] VARCHAR(25) NULL,
    [state] VARCHAR(50) NULL,
    [Phone] VARCHAR(50) NULL,
    [Senior] VARCHAR(6) NULL,
    [Sr_name] VARCHAR(150) NULL,
    [Branch_cd] NVARCHAR(255) NULL,
    [company] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [LOB] VARCHAR(100) NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [LocAddress] VARCHAR(5000) NULL,
    [PANNO] VARCHAR(15) NULL DEFAULT ''
);

GO

-- --------------------------------------------------
-- TABLE dbo.error_log
-- --------------------------------------------------
CREATE TABLE [dbo].[error_log]
(
    [Errdate] DATETIME NULL,
    [Errpage] VARCHAR(500) NULL,
    [ErrFromIP] VARCHAR(50) NULL,
    [ErrLine] VARCHAR(50) NULL,
    [ErrNum] VARCHAR(50) NULL,
    [ErrDesc] VARCHAR(8000) NULL,
    [ServSett] VARCHAR(500) NULL,
    [rectfydate] DATETIME NULL,
    [chkdatedate] DATETIME NULL,
    [idno] NUMERIC(18, 0) NOT NULL,
    [email_flag] INT NULL,
    [username] VARCHAR(25) NULL,
    [auto_email_reply] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_05jul2021
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_05jul2021]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_08Aug2019
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_08Aug2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_11Nov2019
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_11Nov2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_12Dec2019
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_12Dec2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_17mar2023
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_17mar2023]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_20nov2019
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_20nov2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_25jul2019
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_25jul2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_26jul2019
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_26jul2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_29oct2021
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_29oct2021]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXCLUDE_CAT_MAPPING_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[EXCLUDE_CAT_MAPPING_HIST]
(
    [EMP_NO] VARCHAR(50) NULL,
    [MENU_CODE] INT NULL,
    [MAPPED_BY] VARCHAR(50) NULL,
    [MAPPED_ON] DATETIME NULL,
    [DELETED_BY] VARCHAR(50) NULL,
    [DELETED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXCLUDE_CAT_MAPPING_hist_test
-- --------------------------------------------------
CREATE TABLE [dbo].[EXCLUDE_CAT_MAPPING_hist_test]
(
    [EMP_NO] VARCHAR(50) NULL,
    [MENU_CODE] INT NULL,
    [MAPPED_BY] VARCHAR(50) NULL,
    [MAPPED_ON] DATETIME NULL,
    [DELETED_BY] VARCHAR(50) NULL,
    [DELETED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Exclude_CAT_MAPPING_log
-- --------------------------------------------------
CREATE TABLE [dbo].[Exclude_CAT_MAPPING_log]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL,
    [DT] DATETIME NOT NULL,
    [Action] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXCLUDE_CAT_MAPPING_test
-- --------------------------------------------------
CREATE TABLE [dbo].[EXCLUDE_CAT_MAPPING_test]
(
    [EMP_NO] VARCHAR(10) NOT NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping30jun2021
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping30jun2021]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXTRA_CAT_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[EXTRA_CAT_MAPPING]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_05jul2021
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_05jul2021]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_08Aug2019
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_08Aug2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_11Nov2019
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_11Nov2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_20mar2023
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_20mar2023]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_25jul2019
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_25jul2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_27dec2019
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_27dec2019]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_bkp
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_bkp]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_hist]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL,
    [DELETED_BY] VARCHAR(10) NULL,
    [DELETED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_hist_test
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_hist_test]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL,
    [DELETED_BY] VARCHAR(10) NULL,
    [DELETED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_log
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_log]
(
    [EMP_NO] VARCHAR(10) NOT NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL,
    [DT] DATETIME NOT NULL,
    [Action] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_new
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_new]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_test
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_test]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping30jun2021
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping30jun2021]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file3
-- --------------------------------------------------
CREATE TABLE [dbo].[file3]
(
    [username] VARCHAR(20) NULL,
    [person_name] VARCHAR(100) NULL,
    [access_to] VARCHAR(50) NULL,
    [Access_Code] VARCHAR(50) NULL,
    [last_Login] DATETIME NULL,
    [menu_code] INT NOT NULL,
    [head] VARCHAR(100) NULL,
    [sub_head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [menu_desc] VARCHAR(250) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [menuactivatedon] DATETIME NULL,
    [menudeactivatedon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.forget_pwd_log
-- --------------------------------------------------
CREATE TABLE [dbo].[forget_pwd_log]
(
    [date_time] DATETIME NULL,
    [pc_ip_name] VARCHAR(50) NULL,
    [username] VARCHAR(50) NULL,
    [password1] VARCHAR(50) NULL,
    [message] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.forget_pwd_log_Mobile_2
-- --------------------------------------------------
CREATE TABLE [dbo].[forget_pwd_log_Mobile_2]
(
    [date_time] DATETIME NULL,
    [pc_ip_name] VARCHAR(50) NULL,
    [username] VARCHAR(50) NULL,
    [password1] VARCHAR(50) NULL,
    [message] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.get_menu_option_extra_25jul2019
-- --------------------------------------------------
CREATE TABLE [dbo].[get_menu_option_extra_25jul2019]
(
    [menu_code] INT NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [cat_name] VARCHAR(1) NOT NULL,
    [cat_code] INT NOT NULL,
    [access_Code] VARCHAR(50) NULL,
    [userid] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HRInactive$
-- --------------------------------------------------
CREATE TABLE [dbo].[HRInactive$]
(
    [LOGIN] NVARCHAR(255) NULL,
    [USER_NAME] NVARCHAR(255) NULL,
    [FLDSTATUS] FLOAT NULL,
    [Logn_Inactive_dt] DATETIME NULL,
    [SEPARATIONDATE] DATETIME NULL,
    [Count_Days] FLOAT NULL,
    [App date] DATETIME NULL,
    [LWD] DATETIME NULL,
    [remark] VARCHAR(5000) NULL,
    [Diff_perApdate] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Insp_setting
-- --------------------------------------------------
CREATE TABLE [dbo].[Insp_setting]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(20) NULL,
    [userpassword] VARCHAR(20) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(300) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITGC_18codes_accessissue
-- --------------------------------------------------
CREATE TABLE [dbo].[ITGC_18codes_accessissue]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [username] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITGC_missingcodes_recertification
-- --------------------------------------------------
CREATE TABLE [dbo].[ITGC_missingcodes_recertification]
(
    [username] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITGC_separtion18cases
-- --------------------------------------------------
CREATE TABLE [dbo].[ITGC_separtion18cases]
(
    [username] VARCHAR(20) NULL,
    [person_name] VARCHAR(100) NULL,
    [last_login] DATETIME NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [Gateway] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL,
    [status] INT NULL,
    [separationdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.login_logs
-- --------------------------------------------------
CREATE TABLE [dbo].[login_logs]
(
    [report_path] VARCHAR(300) NULL,
    [userid] INT NULL,
    [username] VARCHAR(100) NULL,
    [IP_Add] VARCHAR(25) NULL,
    [Access_datetime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOGIN_LOGS_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[LOGIN_LOGS_TEMP]
(
    [REPORT_PATH] VARCHAR(300) NULL,
    [USERID] INT NULL,
    [USERNAME] VARCHAR(100) NULL,
    [IP_ADD] VARCHAR(25) NULL,
    [ACCESS_DATETIME] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOGIN_LOGS_TEMP_05_06
-- --------------------------------------------------
CREATE TABLE [dbo].[LOGIN_LOGS_TEMP_05_06]
(
    [report_path] VARCHAR(300) NULL,
    [userid] INT NULL,
    [username] VARCHAR(100) NULL,
    [IP_Add] VARCHAR(25) NULL,
    [Access_datetime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOGIN_LOGS1
-- --------------------------------------------------
CREATE TABLE [dbo].[LOGIN_LOGS1]
(
    [report_path] VARCHAR(300) NULL,
    [userid] INT NULL,
    [username] VARCHAR(100) NULL,
    [IP_Add] VARCHAR(25) NULL,
    [Access_datetime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Manesh_user_login
-- --------------------------------------------------
CREATE TABLE [dbo].[Manesh_user_login]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(20) NULL,
    [userpassword] VARCHAR(20) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(300) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_cat
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_cat]
(
    [cat_code] INT IDENTITY(1,1) NOT NULL,
    [cat_name] VARCHAR(40) NULL,
    [active] VARCHAR(1) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [CreatedOn] DATETIME NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [ModifiedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_cat2
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_cat2]
(
    [cat_code] INT IDENTITY(1,1) NOT NULL,
    [cat_name] VARCHAR(40) NULL,
    [active] VARCHAR(1) NULL,
    [CreatedOn] DATETIME NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [ModifiedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_heading
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_heading]
(
    [head] VARCHAR(40) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_01nov2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_01nov2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_03122019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_03122019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_03jan2022
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_03jan2022]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_04042019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_04042019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_04102019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_04102019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_04Aug2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_04Aug2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_04Oct2019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_04Oct2019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_06012020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_06012020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_06April2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_06April2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_06Jan_2022
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_06Jan_2022]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_06jan2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_06jan2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_06oct2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_06oct2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_07062019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_07062019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_07Dec_2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_07Dec_2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_07jan2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_07jan2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_08012020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_08012020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_10June2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_10June2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_10June2020_test
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_10June2020_test]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_11June2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_11June2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_11June2020_test
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_11June2020_test]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_1202019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_1202019_Renamed_By_DBA]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_13jan2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_13jan2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_14may2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_14may2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_15jul2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_15jul2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_15mar2023
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_15mar2023]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_18_nov2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_18_nov2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_18july2019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_18july2019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_18Nov2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_18Nov2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_19sep2022
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_19sep2022]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_1st_Dec_2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_1st_Dec_2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_20052019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_20052019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_2021_11_01
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_2021_11_01]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_23nov2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_23nov2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_25092019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_25092019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_26012024
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_26012024]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_28062019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_28062019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_28jan2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_28jan2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_28jul2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_28jul2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_28oct2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_28oct2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_29Apr2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_29Apr2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_30Dec2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_30Dec2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_31082019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_31082019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_31mar2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_31mar2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_7Dec_2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_7Dec_2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_audit
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_audit]
(
    [Menu_url] VARCHAR(250) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_Backup_20250801
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_Backup_20250801]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_harishketan
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_harishketan]
(
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_log
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_log]
(
    [menu_code] INT NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL,
    [history_date] VARCHAR(25) NULL,
    [ActionPerformed] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_test18july2019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_test18july2019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item02ndNov2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item02ndNov2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item03Nov2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item03Nov2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item11dec2020
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item11dec2020]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item14dec2018
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item14dec2018]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item14jan2021
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item14jan2021]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item20Nov2019
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item20Nov2019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Menu_url_04102019
-- --------------------------------------------------
CREATE TABLE [dbo].[Menu_url_04102019]
(
    [menu_url] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MenuOptionAction
-- --------------------------------------------------
CREATE TABLE [dbo].[MenuOptionAction]
(
    [Cat_Code] INT NULL,
    [menu_Code] INT NULL,
    [remarks] VARCHAR(7) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MF_NXT_forget_pwd_log
-- --------------------------------------------------
CREATE TABLE [dbo].[MF_NXT_forget_pwd_log]
(
    [date_time] DATETIME NULL,
    [pc_ip_name] VARCHAR(50) NULL,
    [username] VARCHAR(50) NULL,
    [password1] VARCHAR(50) NULL,
    [message] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NON_Business_menu_code
-- --------------------------------------------------
CREATE TABLE [dbo].[NON_Business_menu_code]
(
    [MENU_CODE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFRA_Sub_broker
-- --------------------------------------------------
CREATE TABLE [dbo].[OFRA_Sub_broker]
(
    [Sub_broker] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PWC_RightsCompareTbl
-- --------------------------------------------------
CREATE TABLE [dbo].[PWC_RightsCompareTbl]
(
    [ExistUSer] VARCHAR(10) NULL,
    [EU_Menu_code] VARCHAR(10) NULL,
    [EU_Flag] VARCHAR(10) NULL,
    [NewUser] VARCHAR(10) NULL,
    [NU_Menu_code] VARCHAR(10) NULL,
    [NU_flag] VARCHAR(10) NULL,
    [CompDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PWC_userCatChange
-- --------------------------------------------------
CREATE TABLE [dbo].[PWC_userCatChange]
(
    [username] VARCHAR(10) NULL,
    [PrevCat] VARCHAR(10) NULL,
    [ChangedCat] VARCHAR(10) NULL,
    [Changedon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sbtag_Deactivated_in_Process_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Sbtag_Deactivated_in_Process_Log]
(
    [sub_broker] VARCHAR(100) NULL,
    [DeactivatedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.servlet_user_login
-- --------------------------------------------------
CREATE TABLE [dbo].[servlet_user_login]
(
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [active] VARCHAR(10) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.session_log
-- --------------------------------------------------
CREATE TABLE [dbo].[session_log]
(
    [SessionDate] DATETIME NULL,
    [sessionid] INT NULL,
    [sessionVariable] VARCHAR(25) NULL,
    [sessionValue] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1_Prashant
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1_Prashant]
(
    [Head] NVARCHAR(255) NULL,
    [Sub_Head] NVARCHAR(255) NULL,
    [menu_name] NVARCHAR(255) NULL,
    [menu_url] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sqlmapoutput
-- --------------------------------------------------
CREATE TABLE [dbo].[sqlmapoutput]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [data] NVARCHAR(4000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SURV_OFFLINE_SERVER_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[SURV_OFFLINE_SERVER_MAPPING]
(
    [Location] VARCHAR(30) NOT NULL,
    [Access_Code] VARCHAR(30) NOT NULL,
    [Access_Level] VARCHAR(30) NOT NULL,
    [SERVER] VARCHAR(30) NOT NULL,
    [ADDED_DATE] DATETIME NOT NULL,
    [UPDATE_DATE] DATETIME NOT NULL,
    [SRNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t
-- --------------------------------------------------
CREATE TABLE [dbo].[t]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(20) NULL,
    [userpassword] VARCHAR(20) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CHECK_MENU_RIGHTS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CHECK_MENU_RIGHTS_LOG]
(
    [MenuCode] INT NULL,
    [UserName] VARCHAR(20) NULL,
    [AccessFor] VARCHAR(20) NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLIENT_FAMILY
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLIENT_FAMILY]
(
    [SrNo] BIGINT NOT NULL,
    [PartyCode] VARCHAR(25) NULL,
    [FamilyCode] VARCHAR(25) NULL,
    [EnterBy] VARCHAR(25) NULL,
    [EnterOn] DATETIME NULL,
    [FileID] INT NULL,
    [status] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [app_rej_date] DATETIME NULL,
    [app_rej_by] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLIENT_FAMILY_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLIENT_FAMILY_LOG]
(
    [SrNo] BIGINT NULL,
    [PartyCode] VARCHAR(25) NULL,
    [FamilyCode] VARCHAR(25) NULL,
    [EnterBy] VARCHAR(25) NULL,
    [EnterOn] DATETIME NULL,
    [FileID] INT NULL,
    [status] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [app_rej_date] DATETIME NULL,
    [app_rej_by] VARCHAR(15) NULL,
    [LastModifiedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Conn_table
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Conn_table]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Server_IP] VARCHAR(25) NULL,
    [Fld_Server_Name] VARCHAR(25) NULL,
    [Fld_Database_Name] VARCHAR(35) NULL,
    [Fld_UserName] VARCHAR(10) NULL,
    [Fld_Password] VARCHAR(20) NULL,
    [Fld_Upd_Date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(10) NULL,
    [Fld_Status] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DRA_Blocked
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DRA_Blocked]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [DRATag] VARCHAR(20) NULL,
    [CreatedDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_final_SB_deactivted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_final_SB_deactivted]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL,
    [DeactiveUpdateDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Gold
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Gold]
(
    [SBCode] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_inhouse_pwd_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_inhouse_pwd_log]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [userid] VARCHAR(50) NULL,
    [password] VARCHAR(100) NULL,
    [entryon] DATETIME NULL DEFAULT (getdate()),
    [ip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_inhouse_pwd_log_BKP_24_Jan_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_inhouse_pwd_log_BKP_24_Jan_2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [userid] VARCHAR(50) NULL,
    [password] VARCHAR(100) NULL,
    [entryon] DATETIME NULL,
    [ip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_logindeactive21012018
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_logindeactive21012018]
(
    [deactiveUsername] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_new_Sb_deactivted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_new_Sb_deactivted]
(
    [SBCode] NVARCHAR(255) NULL,
    [Zone] NVARCHAR(255) NULL,
    [Region] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NRIBANKMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NRIBANKMASTER]
(
    [Fld_SrNo] INT NOT NULL,
    [Fld_BankName] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(50) NULL,
    [Fld_BankPISAc] VARCHAR(50) NULL,
    [Fld_AngelAcc] VARCHAR(50) NULL,
    [Fld_BranchLocation] VARCHAR(50) NULL,
    [Fld_Bankcode] NUMERIC(18, 0) NULL,
    [Fld_Username] VARCHAR(20) NULL,
    [Fld_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_clients
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_clients]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NULL,
    [Fld_Status] VARCHAR(2) NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SB_Cancellation_ErrorLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SB_Cancellation_ErrorLog]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [Error_Number] NCHAR(10) NULL,
    [ERROR_LINE] NCHAR(10) NULL,
    [ERROR_MESSAGE] VARCHAR(500) NULL,
    [ERROR_PROCEDURE] VARCHAR(50) NULL,
    [ERROR_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SB_CancellationUserName
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SB_CancellationUserName]
(
    [UserName] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SB_deactivted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SB_deactivted]
(
    [SBCode] NVARCHAR(255) NULL,
    [Zone ] NVARCHAR(255) NULL,
    [Region ] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [Category] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SB_EmailUpload_Anniversary
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SB_EmailUpload_Anniversary]
(
    [SBTAG] VARCHAR(50) NULL,
    [EmailList] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SB_EmailUpload_Bday
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SB_EmailUpload_Bday]
(
    [SBTAG] VARCHAR(50) NULL,
    [EmailList] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBActivation_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBActivation_Log]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UserName] VARCHAR(50) NULL,
    [ActivatedBy] VARCHAR(50) NULL,
    [ActivationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBCancellation_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBCancellation_Log]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UserName] VARCHAR(50) NULL,
    [DeactivatedBy] VARCHAR(50) NULL,
    [DeactivationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_TraineeOrTempStaff
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_TraineeOrTempStaff]
(
    [Username] VARCHAR(10) NOT NULL,
    [Department] VARCHAR(30) NOT NULL,
    [EnteredBy] VARCHAR(12) NULL,
    [EnteredOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMIN]
(
    [fldauto_admin] INT NOT NULL,
    [fldname] VARCHAR(30) NOT NULL,
    [fldpassword] VARCHAR(30) NOT NULL,
    [fldcompany] VARCHAR(50) NULL,
    [fldstname] VARCHAR(50) NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [flddesc] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblloginexception
-- --------------------------------------------------
CREATE TABLE [dbo].[tblloginexception]
(
    [Username] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLPRADNYAUSERS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLPRADNYAUSERS]
(
    [fldauto] INT NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTS]
(
    [fldreportcode] INT NOT NULL,
    [fldreportname] VARCHAR(40) NULL,
    [fldpath] VARCHAR(100) NULL,
    [fldtarget] VARCHAR(25) NULL,
    [flddesc] VARCHAR(80) NULL,
    [fldreportgrp] VARCHAR(10) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [fldstatus] VARCHAR(20) NULL,
    [fldorder] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp
-- --------------------------------------------------
CREATE TABLE [dbo].[temp]
(
    [SBCode] NVARCHAR(255) NULL,
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_cat_mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_cat_mapping]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL,
    [status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_file1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_file1]
(
    [menu_code] INT NOT NULL,
    [cat_Code] INT NULL,
    [userid] INT NOT NULL,
    [username] VARCHAR(20) NULL,
    [menuactivatedon] DATETIME NULL,
    [menudeactivatedon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_MENU_ITEM
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_MENU_ITEM]
(
    [menu_code] INT NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [update_by] VARCHAR(10) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_rtgs_clients
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_rtgs_clients]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NULL,
    [Fld_Status] VARCHAR(2) NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL,
    [fld_approve_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp1]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempUserMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[TempUserMaster]
(
    [username] VARCHAR(20) NULL,
    [InsertedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempUserMaster_Bkp21Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[TempUserMaster_Bkp21Jan2019]
(
    [username] VARCHAR(20) NULL,
    [InsertedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_20052019
-- --------------------------------------------------
CREATE TABLE [dbo].[test_20052019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_28062019
-- --------------------------------------------------
CREATE TABLE [dbo].[test_28062019]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_franchisee
-- --------------------------------------------------
CREATE TABLE [dbo].[user_franchisee]
(
    [tag] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL DEFAULT ((0)),
    [NoOfLogin] INT NULL DEFAULT ((0)),
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_13122018
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_13122018]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_13122018_2
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_13122018_2]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_14Mar2019
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_14Mar2019]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_15Mar2019
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_15Mar2019]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_2_13122018
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_2_13122018]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_28jul2021
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_28jul2021]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_bkp_23_jul_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_bkp_23_jul_2025]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USER_LOGIN_BKP_29_OCT_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[USER_LOGIN_BKP_29_OCT_2025]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_exclude
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_exclude]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_Hist]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(50) NULL,
    [username] VARCHAR(18) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(25) NULL,
    [access_to] VARCHAR(10) NULL,
    [access_code] VARCHAR(20) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(5) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(1) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(1) NULL,
    [session_id] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(10) NULL,
    [CreatedOn] VARCHAR(25) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_log
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_log]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL,
    [history_date] DATETIME NULL,
    [action] VARCHAR(6) NULL,
    [Host] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_renil
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_renil]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(20) NULL,
    [userpassword] VARCHAR(20) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login1
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login1]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(20) NULL,
    [userpassword] VARCHAR(20) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(300) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login18dec2018
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login18dec2018]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login2
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login2]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(20) NULL,
    [userpassword] VARCHAR(20) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(300) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserAccessShiftLog
-- --------------------------------------------------
CREATE TABLE [dbo].[UserAccessShiftLog]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [FromUSer] VARCHAR(10) NULL,
    [FromUser_CatCode] INT NULL,
    [FromUSer_Status] INT NULL,
    [FromUSer_Extra_cnt] INT NULL,
    [FromUSer_Exclu_cnt] INT NULL,
    [ToUSer] VARCHAR(10) NULL,
    [ToUser_PrevCatCode] INT NULL,
    [ToUser_NewCatCode] INT NULL,
    [ToUser_PrevExtraCnt] INT NULL,
    [ToUser_PrevExcluCnt] INT NULL,
    [UpdatedDate] DATETIME NULL,
    [Updatedby] VARCHAR(10) NULL,
    [RetainYN] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserLoginLog
-- --------------------------------------------------
CREATE TABLE [dbo].[UserLoginLog]
(
    [Error] VARCHAR(200) NULL,
    [ErrorLine] INT NULL,
    [ErrorDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Vw_RMS_Client_Vertical
-- --------------------------------------------------
CREATE TABLE [dbo].[Vw_RMS_Client_Vertical]
(
    [Zone] VARCHAR(20) NULL,
    [Region] VARCHAR(255) NULL,
    [RegionName] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [BranchName] VARCHAR(100) NULL,
    [SB] VARCHAR(10) NULL,
    [SB_Name] VARCHAR(52) NULL,
    [Client] VARCHAR(10) NULL,
    [Party_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.AdminUser_DELETE
-- --------------------------------------------------
CREATE TRIGGER [AdminUser_DELETE]           
ON [DBO].AdminUsers          
FOR DELETE         
AS           
declare @ipAddress varchar(20)            
 set @ipAddress = (SELECT top 1 client_net_address FROM sys.dm_exec_connections               
 WHERE session_id = @@SPID)            
   
INSERT INTO DBO.AdminUsers_log           
SELECT *,GETDATE(),'DELETE',@ipAddress FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.AdminUser_UPDATE
-- --------------------------------------------------
CREATE TRIGGER [AdminUser_UPDATE]           
ON [DBO].AdminUsers          
FOR UPDATE         
AS         
declare @ipAddress varchar(20)            
 set @ipAddress = (SELECT top 1 client_net_address FROM sys.dm_exec_connections               
 WHERE session_id = @@SPID)            
    
INSERT INTO DBO.AdminUsers_log           
SELECT *,GETDATE(),'UPDATE',@ipAddress  FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.cat_mapping_delete
-- --------------------------------------------------
create trigger [cat_mapping_delete]       
on dbo.cat_mapping      
for delete      
as       
insert into dbo.cat_mapping_log       
select *,getdate(),'delete' from deleted

GO

-- --------------------------------------------------
-- TRIGGER dbo.Exclude_CAT_MAPPING_delete
-- --------------------------------------------------
create trigger Exclude_CAT_MAPPING_delete         
on dbo.Exclude_CAT_MAPPING     
for delete        
as         
insert into dbo.Exclude_CAT_MAPPING_log         
select *,getdate(),'delete' from deleted

GO

-- --------------------------------------------------
-- TRIGGER dbo.extra_cat_mapping_delete
-- --------------------------------------------------
create trigger extra_cat_mapping_delete       
on dbo.extra_cat_mapping      
for delete      
as       
insert into dbo.extra_cat_mapping_log       
select *,getdate(),'delete' from deleted

GO

-- --------------------------------------------------
-- TRIGGER dbo.MENU_ITEM_DELETE
-- --------------------------------------------------
CREATE TRIGGER [MENU_ITEM_DELETE]     
ON DBO.MENU_ITEM    
FOR DELETE    
AS     
INSERT INTO DBO.MENU_ITEM_LOG     
SELECT *,GETDATE(),'DELETE' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.MENU_ITEM_UPDATE
-- --------------------------------------------------
CREATE TRIGGER [MENU_ITEM_UPDATE]     
ON DBO.MENU_ITEM    
FOR UPDATE    
AS     
INSERT INTO DBO.MENU_ITEM_LOG     
SELECT *,GETDATE(),'UPDATE' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.TEMP_MENU_ITEM_DELETE
-- --------------------------------------------------
CREATE TRIGGER [TEMP_MENU_ITEM_DELETE]     
ON [DBO].TEMP_MENU_ITEM    
FOR DELETE    
AS     
INSERT INTO DBO.TEMP_MENU_ITEM_LOG     
SELECT *,GETDATE(),'DELETE' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.TEMP_MENU_ITEM_UPDATE
-- --------------------------------------------------
CREATE TRIGGER [TEMP_MENU_ITEM_UPDATE]     
ON [DBO].TEMP_MENU_ITEM    
FOR UPDATE    
AS     
INSERT INTO DBO.TEMP_MENU_ITEM_LOG     
SELECT *,GETDATE(),'UPDATE' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.TRIGGER_TBL_NRIBANKMASTER
-- --------------------------------------------------
CREATE TRIGGER TRIGGER_TBL_NRIBANKMASTER       
ON DBO.TBL_NRIBANKMASTER      
FOR DELETE      
AS       
INSERT INTO DBO.TBL_NRIBANKMASTER_LOG       
SELECT FLD_BANKNAME,FLD_SEGMENT,FLD_BANKPISAC,FLD_ANGELACC,FLD_BRANCHLOCATION,FLD_BANKCODE,FLD_USERNAME,FLD_DATE  
,GETDATE() FROM DELETED 


--SELECT * INTO TBL_NRIBANKMASTER
--FROM INTRANET.RISK.DBO.TBL_NRIBANKMASTER

GO

-- --------------------------------------------------
-- TRIGGER dbo.UPDATE_CTCL_LOCATION
-- --------------------------------------------------
CREATE TRIGGER [UPDATE_CTCL_LOCATION] ON [DBO].[BRANCH]     
FOR INSERT     
AS    
INSERT INTO INTRANET.CTCL.DBO.LIMIT_ADDODIN SELECT SBTAG,'Z' FROM INTRANET.RISK.DBO.BRANCH WHERE SBTAG NOT IN (SELECT LOCATION FROM INTRANET.CTCL.DBO.LIMIT_ADDODIN WHERE ODINSERVER ='Z')    
INSERT INTO INTRANET.CTCL.DBO.LIMIT_ADDODIN SELECT SBTAG,'ODIN6' FROM INTRANET.RISK.DBO.BRANCH WHERE SBTAG NOT IN (SELECT LOCATION FROM INTRANET.CTCL.DBO.LIMIT_ADDODIN WHERE ODINSERVER ='ODIN6')    
INSERT INTO INTRANET.CTCL.DBO.LIMIT_ADDODIN SELECT SBTAG,'ODIN7' FROM INTRANET.RISK.DBO.BRANCH WHERE SBTAG NOT IN (SELECT LOCATION FROM INTRANET.CTCL.DBO.LIMIT_ADDODIN WHERE ODINSERVER ='ODIN7')

GO

-- --------------------------------------------------
-- TRIGGER dbo.USER_LOGIN_DELETE
-- --------------------------------------------------
CREATE TRIGGER [USER_LOGIN_DELETE]         
ON [DBO].USER_LOGIN        
FOR DELETE       
AS         
declare @ipAddress varchar(20)          
 set @ipAddress = (SELECT top 1 client_net_address FROM sys.dm_exec_connections             
 WHERE session_id = @@SPID)          
 
INSERT INTO DBO.USER_LOGIN_LOG         
SELECT *,GETDATE(),'DELETE',@ipAddress FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.USER_LOGIN_UPDATE
-- --------------------------------------------------
CREATE TRIGGER [USER_LOGIN_UPDATE]         
ON [DBO].USER_LOGIN        
FOR UPDATE       
AS       
declare @ipAddress varchar(20)          
 set @ipAddress = (SELECT top 1 client_net_address FROM sys.dm_exec_connections             
 WHERE session_id = @@SPID)          
  
INSERT INTO DBO.USER_LOGIN_LOG         
SELECT *,GETDATE(),'UPDATE',@ipAddress  FROM DELETED

GO

-- --------------------------------------------------
-- VIEW dbo.AIAAS_BoExEmpActiveLogin
-- --------------------------------------------------
CREATE view AIAAS_BoExEmpActiveLogin
as

/*
select segment='BSECM',* from anand.inhouse.dbo.AIAAS_ExEmpActiveLogin
union all
select segment='NSECM',* from anand1.inhouse.dbo.AIAAS_ExEmpActiveLogin
union all
select segment='NSEFO',* from angelfo.inhouse.dbo.AIAAS_ExEmpActiveLogin
union all
select segment='NSX',* from angelfo.inhouse_curfo.dbo.AIAAS_ExEmpActiveLogin
union all
select segment='MCD',* from angelcommodity.inhouse_mcdcs.dbo.AIAAS_ExEmpActiveLogin
union all
select segment='MCX',* from angelcommodity.inhouse_mcdx.dbo.AIAAS_ExEmpActiveLogin
union all
select segment='NCDEX',* from angelcommodity.inhouse_ncdx.dbo.AIAAS_ExEmpActiveLogin
*/

/* Kindly Execute SP: AIAAS_ExEmpActiveLogin_fetch to update the below mentioned table */

select * from AIAAS_ExEmpActiveLogin_data with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.Error_developer
-- --------------------------------------------------
  
CREATE VIEW ERROR_DEVELOPER  
AS  

SELECT A.*,ISNULL(B.DEVELOPER,'E05205') AS DEVELOPER,
	DEVMAP=(CASE WHEN B.DEVELOPER IS NULL THEN 'N' ELSE 'Y' END),  
	B.EMP_NAME,B.STATUS,B.EMAIL  
FROM  
(SELECT * FROM INTRANET.MISC.DBO.ERROR_LOG WITH (NOLOCK) WHERE ISNULL(EMAIL_FLAG,0)=0) A 
LEFT OUTER JOIN INTRANET.MISC.DBO.DEV_APPLN_MAPPING B ON '/'+B.FOLDER+'/'=  SUBSTRING(ERRPAGE,1,LEN('/'+B.FOLDER+'/'))

GO

-- --------------------------------------------------
-- VIEW dbo.get_menu_option
-- --------------------------------------------------
CREATE view get_menu_option
as                    
                  
select           
m.menu_code,m.Head,m.Sub_Head,m.menu_name,m.menu_url,m.seq_no,m.active,m.menu_desc,          
b.cat_name,a.cat_code,d.access_Code,d.userid,menuactivatedon=login_Activated,  
username,menudeactivatedon=login_inactive_date
from menu_item m, cat_mapping a, menu_cat b, user_login d                    
where a.cat_code=b.cat_Code and a.menu_Code=m.menu_code                     
and a.cat_Code=d.cat_code and m.active='Y'  and b.active='Y'

GO

-- --------------------------------------------------
-- VIEW dbo.get_menu_option_extra
-- --------------------------------------------------
CREATE view get_menu_option_extra                          
as                          
select menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc                
,cat_name,cat_code,access_Code,userid          
from           
(select                 
m.menu_code,m.Head,m.Sub_Head,m.menu_name,m.menu_url,m.seq_no,m.active,m.menu_desc                
,cat_name='',cat_code=0,d.access_Code,d.userid,d.username                            
from menu_item m, extra_cat_mapping a,  user_login d                          
where --a.cat_code=b.cat_Code and               
a.menu_Code=m.menu_code                           
and a.emp_no=d.username and m.active='Y'  --and b.active='Y'           
)x where not exists (select * from exclude_cat_mapping y where x.username=y.emp_no and x.menu_code=y.menu_code         
and MAPPED_BY='AIAAS'          
)

GO

-- --------------------------------------------------
-- VIEW dbo.get_menu_option_extra_12052016
-- --------------------------------------------------
CREATE view get_menu_option_extra_12052016                
as                
              
select       
m.menu_code,m.Head,m.Sub_Head,m.menu_name,m.menu_url,m.seq_no,m.active,m.menu_desc      
,cat_name='',cat_code=0,d.access_Code,d.userid                  
from menu_item m, extra_cat_mapping a,  user_login d                
where --a.cat_code=b.cat_Code and     
a.menu_Code=m.menu_code                 
and a.emp_no=d.username and m.active='Y'  --and b.active='Y'

GO

-- --------------------------------------------------
-- VIEW dbo.get_menu_option_extra_new
-- --------------------------------------------------
CREATE view get_menu_option_extra_new                                
as                                
select menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc                      
,cat_name,cat_code,access_Code,userid,menuactivatedon ,username               
from                 
(select                       
m.menu_code,m.Head,m.Sub_Head,m.menu_name,m.menu_url,m.seq_no,m.active,m.menu_desc                      
,cat_name='',cat_code=0,d.access_Code,d.userid,d.username,menuactivatedon=MAPPED_ON                                
from menu_item m, extra_cat_mapping a,  user_login d                                
where --a.cat_code=b.cat_Code and                     
a.menu_Code=m.menu_code                                 
and a.emp_no=d.username and m.active='Y'  --and b.active='Y'                 
)x

GO

-- --------------------------------------------------
-- VIEW dbo.get_menu_option_extra_new_atulsir
-- --------------------------------------------------
Create view get_menu_option_extra_new_atulsir                
as                
select menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc      
,cat_name,cat_code,access_Code,userid
from 
(select       
m.menu_code,m.Head,m.Sub_Head,m.menu_name,m.menu_url,m.seq_no,m.active,m.menu_desc      
,cat_name='',cat_code=0,d.access_Code,d.userid,d.username                  
from menu_item m, extra_cat_mapping a,  user_login d                
where --a.cat_code=b.cat_Code and     
a.menu_Code=m.menu_code                 
and a.emp_no=d.username and m.active='Y'  --and b.active='Y' 
)x where not exists (select * from exclude_cat_mapping y where x.username=y.emp_no)

GO

-- --------------------------------------------------
-- VIEW dbo.get_menu_option_new
-- --------------------------------------------------
CREATE view get_menu_option_new                  
as                  
                
select         
m.menu_code,m.Head,m.Sub_Head,m.menu_name,m.menu_url,m.seq_no,m.active,m.menu_desc,        
b.cat_name,a.cat_code,d.access_Code,d.userid,menuactivatedon=login_Activated,
username    
from menu_item m, cat_mapping a, menu_cat b, user_login d                  
where a.cat_code=b.cat_Code and a.menu_Code=m.menu_code                   
and a.cat_Code=d.cat_code and m.active='Y'  and b.active='Y'

GO

-- --------------------------------------------------
-- VIEW dbo.Inhouse_user_IP
-- --------------------------------------------------
CREATE View [dbo].[Inhouse_user_IP]    
as    
select username,ip=isnull(ip,''),ip_active=isnull(ip_active,'N')    
from user_login(nolock)    
where  access_to not in ('SB','FAMILY')

GO

-- --------------------------------------------------
-- VIEW dbo.page_users
-- --------------------------------------------------
CREATE view [dbo].[page_users]    
as    

select a.*,noofaccess=isnull(noofaccess,0),last_access,userid from vw_menu_item_active a (nolock) left outer join     
(
SELECT REPORT_PATH,NoOfAccess=COUNT(*),last_access=max(Access_datetime ),userid     
FROM login_logs with (nolock) group by report_path,userid
) b    
on a.menu_url=b.REPORT_PATH

GO

-- --------------------------------------------------
-- VIEW dbo.USER_Help_vw
-- --------------------------------------------------
CREATE VIEW USER_HELP_VW    
AS    
SELECT USERNAME,PERSON_NAME,STATUS='USER' 
FROM USER_LOGIN (NOLOCK)
WHERE CAT_CODE IN    
(    
	SELECT CAT_CODE 
	FROM CAT_MAPPING(NOLOCK)
	WHERE MENU_CODE=932    
) AND STATUS=1 AND USERNAME NOT IN (SELECT USERNAME FROM INTRANET.RISK.DBO.HELPDESK_USER)    

UNION    

SELECT * FROM INTRANET.RISK.DBO.HELPDESK_USER

GO

-- --------------------------------------------------
-- VIEW dbo.user_login_emp
-- --------------------------------------------------
Create View user_login_emp
as
select * from user_login 
where access_to not in ('SB','SBMAST','Client')

GO

-- --------------------------------------------------
-- VIEW dbo.userlogin
-- --------------------------------------------------
 create view userlogin
 as
 select * from user_login where access_to not in ('sb','SBMAST')
 and username not in (select username from tblloginexception)

GO

-- --------------------------------------------------
-- VIEW dbo.userlogin_list
-- --------------------------------------------------
CREATE VIEW [DBO].[USERLOGIN_LIST]  
AS  
SELECT A.*,B.CAT_NAME FROM   
(  
	SELECT X.*,NOOFLOGINS=ISNULL(NOOFLOGINS,0),  
		LAST_ACCESS=(CASE WHEN LAST_ACCESS IS NULL THEN '-' ELSE CONVERT(VARCHAR(25),LAST_ACCESS) END)  
	FROM USER_LOGIN X (NOLOCK)  
	LEFT OUTER JOIN   
	(
		SELECT USERID,NOOFLOGINS=COUNT(*),LAST_ACCESS=MAX(ACCESS_DATETIME) 
		FROM LOGIN_LOGS (NOLOCK) 
		GROUP BY USERID
	) Y   
	ON X.USERID=Y.USERID  
)A ,MENU_CAT B (NOLOCK)   
WHERE A.CAT_CODE=B.CAT_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.UserMenu_Status
-- --------------------------------------------------
Create View UserMenu_Status
as
select x.menu_code,x.cat_Code,x.userid,x.username,x.menuactivatedon, 
menudeactivatedon=case 
when z.status=0 then case
	when y.MAPPED_ON> x.menuactivatedon and y.MAPPED_ON<GETDATE() then y.MAPPED_ON
	when z.login_inactive_date<GETDATE() and z.login_inactive_date>z.login_Activated then z.login_inactive_date
	else null end
else NULL end 
 from 
(select  menu_code,cat_Code,userid,username,menuactivatedon from get_menu_option_new with (nolock)
union 
select   menu_code,cat_Code,userid,username,menuactivatedon from get_menu_option_extra_new with (nolock)
)x left outer join 
(select * from exclude_cat_mapping with (nolock))y on x.username=y.EMP_NO and x.menu_code=y.MENU_CODE
inner join 
(select * from user_login with (nolock ) where isnull(username,'')<>'')z on x.username=z.username

GO

-- --------------------------------------------------
-- VIEW dbo.V_InhouseLoginInfo
-- --------------------------------------------------
CREATE VIEW V_INHOUSELOGININFO    
AS    
	SELECT * FROM     
	(
		SELECT USERID,PERSON_NAME,USERNAME,USERPASSWORD,USERTYPE,ACCESS_TO,ACCESS_CODE,CAT_CODE,    
			LAST_LOGIN,NOOFTRY    
		FROM USER_LOGIN WITH(NOLOCK)
	)X    
	LEFT OUTER JOIN    
	(  
		SELECT EMP_NO,EMP_NAME,EMAIL,DEPARTMENT,DESIGNATION,SR_NAME,PHONE   
		FROM DBO.EMP_INFO WITH(NOLOCK)  
	)Y    
	ON X.USERNAME=Y.EMP_NO

GO

-- --------------------------------------------------
-- VIEW dbo.V_KYC_EMP_ACCESS_MST
-- --------------------------------------------------
CREATE VIEW [DBO].[V_KYC_EMP_ACCESS_MST]  
AS  
	/*********** OLD CODE *********
	
	SELECT DISTINCT USERNAME,MENU_CODE   
	FROM USER_LOGIN,CAT_MAPPING WHERE USER_LOGIN.CAT_CODE IN    
	(    
		SELECT CAT_CODE FROM CAT_MAPPING    
	)      
	UNION ALL    
	SELECT EMP_NO,MENU_CODE FROM EXTRA_CAT_MAPPING      
	
	********************************/
	  
	SELECT DISTINCT USERNAME,MENU_CODE     
	FROM USER_LOGIN A  
		INNER JOIN CAT_MAPPING B  
		ON A.CAT_CODE=B.CAT_CODE  

	UNION ALL    

	SELECT EMP_NO,MENU_CODE 
	FROM EXTRA_CAT_MAPPING

GO

-- --------------------------------------------------
-- VIEW dbo.V_KYC_EMP_ACCESS_MST_TEST
-- --------------------------------------------------
CREATE VIEW [DBO].[V_KYC_EMP_ACCESS_MST_TEST]  
AS  

SELECT DISTINCT USERNAME,MENU_CODE     
FROM USER_LOGIN A  
INNER JOIN CAT_MAPPING B  
ON A.CAT_CODE=B.CAT_CODE  
  
UNION ALL    
  
SELECT EMP_NO,MENU_CODE FROM EXTRA_CAT_MAPPING

GO

-- --------------------------------------------------
-- VIEW dbo.V_KYC_MENU
-- --------------------------------------------------
create view [dbo].[V_KYC_MENU]			
as
select menu_code MenuID,sub_head [Text],head	ParentID,menu_desc	Description,menu_url	URL,seq_no	menu_order,menu_url	URL_Internet,menu_url	URL_Intranet,applicable_to	IsByDefault,update_on	DeletedOnDt,active	status from menu_item where head='KYC'

GO

-- --------------------------------------------------
-- VIEW dbo.V_KYC_User_Ip
-- --------------------------------------------------
create view [dbo].[V_KYC_User_Ip]
as
select username,ip,gateway from user_login

GO

-- --------------------------------------------------
-- VIEW dbo.V_KYC_USER_MST
-- --------------------------------------------------
CREATE VIEW [DBO].[V_KYC_USER_MST]     
  
AS  

SELECT USERNAME,PERSON_NAME USERTYPE,ACCESS_TO,ACCESS_CODE,STATUS  
FROM USER_LOGIN

GO

-- --------------------------------------------------
-- VIEW dbo.V_RTGS_CLIENTS
-- --------------------------------------------------
CREATE VIEW V_RTGS_CLIENTS                                
AS                                
                    
SELECT X.*,Y.BANK_NAME,ISNULL(Y.MICR_CODE,'') AS MICR_CODE,Y.IFSC_CODE,REPLACE(Y.BRANCH_NAME,'Â ','') AS BRANCH_NAME      
,      
ISNULL(Z.ENTEREDBY,X.FLD_ENTERED_BY) AS ENTEREDBY ,ISNULL(S.VERIFIEDBY,'') AS   VERIFIEDBY    
  FROM                     
(                                
SELECT X.*,Y.LONG_NAME,Y.BRANCH_CD,Y.SUB_BROKER FROM                                 
(SELECT FLD_SR_NO,FLD_PARTY_CODE,FLD_RTGS_SR_NO,FLD_BANK_ACNO,FLD_STATUS,FLD_DOCS_RECD,FLD_ENTERED_BY,  
FLD_REMARK,FLD_ENTRY_DATE,FLD_ACCESS_CODE,FLD_IP,FLD_REQ_BY,FLD_CSO_DOCS_RECD,FLD_TYPE,  
FLD_ACTIVE_BY=CASE WHEN FLD_ACTIVE_BY='' THEN '-' ELSE FLD_ACTIVE_BY END,FLD_ACTIVE_DATE,FLD_ACTIVE_IP  FROM INTRANET.RISK.DBO.TBL_RTGS_CLIENTS /*WHERE FLD_TYPE = 'C'*/ ) X                                 
LEFT OUTER JOIN                                
(SELECT * FROM INTRANET.RISK.DBO.CLIENT_DETAILS ) Y                                
 ON X.FLD_PARTY_CODE = Y.CL_CODE                                          
)X                    
LEFT OUTER JOIN                    
(SELECT * FROM INTRANET.RISK.DBO.RTGS_MASTER )Y                    
ON X.FLD_RTGS_SR_NO = Y.SR_NO       
LEFT OUTER JOIN                    
(SELECT PERSON_NAME+'-'+USERNAME AS ENTEREDBY,USERNAME FROM USER_LOGIN (NOLOCK))Z        
ON X.FLD_ENTERED_BY=Z.USERNAME       
LEFT OUTER JOIN                    
(SELECT PERSON_NAME+'-'+USERNAME AS VERIFIEDBY ,USERNAME FROM USER_LOGIN (NOLOCK))S        
ON X.FLD_ACTIVE_BY=S.USERNAME

GO

-- --------------------------------------------------
-- VIEW dbo.V_RTGS_Clients_dummy
-- --------------------------------------------------
CREATE View V_RTGS_Clients_dummy                                  
as                                  
                      
select x.*,y.Bank_Name,isnull(y.micr_code,'') as micr_code,y.Ifsc_Code,replace(y.Branch_Name,'Â ','') as Branch_Name        
,        
isnull(z.EnteredBy,x.fld_entered_by) as EnteredBy  ,s.VerifiedBy        
  from                       
(                                  
select x.*,y.long_name,y.branch_cd,y.sub_broker from                                   
(select * from intranet.risk.dbo.temp_Rtgs_Clients where fld_status in ('A','P') ) x                                   
left outer join                                  
(select * from intranet.risk.dbo.client_details ) y                                  
 on x.Fld_party_COde = y.cl_code                                            
)X                      
left outer join                      
(select * from intranet.risk.dbo.rtgs_master)y                      
on x.Fld_Rtgs_Sr_No = y.Sr_No         
left outer join                      
(select person_name+'-'+username as EnteredBy,username from user_login (nolock))z          
on x.fld_entered_by=z.username         
left outer join                      
(select person_name+'-'+username as VerifiedBy ,username from user_login (nolock))s          
on x.fld_active_by=s.username

GO

-- --------------------------------------------------
-- VIEW dbo.V_User_Category
-- --------------------------------------------------
CREATE view [dbo].[V_User_Category]  
as  
select x.username,x.userpassword,x.usertype,x.access_to,x.access_code,cat_name from user_login x (nolock),  
menu_cat y (nolock) where x.cat_code = y.cat_code

GO

-- --------------------------------------------------
-- VIEW dbo.View_Emp_info1
-- --------------------------------------------------

CREATE view [dbo].[View_Emp_info1]          
as          
select           
[Emp No] as emp_no,          
a.Emp_name,          
EmailAdd as email,          
a.Status,          
Level,          
CategoryDesc,          
Department,          
[Sub Department] as Sub_Department,          
designation,          
CostCode,          
[Join Date] as JoinDate,          
[Separation Date] as SeparationDate,          
Sex,          
BirthDate,          
Address=isnull(address,''),          
Pin='',          
City=isnull(city,''),          
emp_region='',          
acntno=[Account No],          
state,          
Phone,          
[HOD No] as Senior,          
[HOD Name] as Sr_name,          
CostCode as Branch_cd,          
[Company Name] as company,          
SBU,LOB,Zone,Region,Location,          
AttendanceLoc,          
[Location Address] as LocAddress,convert(varchar(15),isnull(b.[Pan No.],'')) as panno          
/* from hrsoft.angelbroking.dbo.vlms */  
from MIDDLEWARE.harmony.dbo.vlmsinhouse  
a left outer join     
(select Emp_no,[Pan No.]=max([Pan No.]) from   
/* hrsoft.angelbroking.dbo.VLMS_PANNO */  
MIDDLEWARE.harmony.dbo.VLMS_PANNO   
group by Emp_no) b      
on a.[Emp No]=b.emp_no

GO

-- --------------------------------------------------
-- VIEW dbo.vw_BRanch
-- --------------------------------------------------
Create view [dbo].[vw_BRanch]
as  
select username,branch_cd=access_code from user_login where access_to='BRANCH' and status=1

GO

-- --------------------------------------------------
-- VIEW dbo.vw_brmast
-- --------------------------------------------------
CREATE view vw_brmast  
as    
select a.username,b.branch_cd from  
(select username,access_code from user_login where access_to='BRMAST' and status=1) a,  
(select brmast_cd,branch_cd from intranet.risk.dbo.branch_master ) b  
where a.access_code=b.brmast_cd

GO

-- --------------------------------------------------
-- VIEW dbo.vw_cat_mapping_user
-- --------------------------------------------------
CREATE view [dbo].[vw_cat_mapping_user] as  
select distinct a.*,b.username from cat_mapping a(nolock),user_login b (nolock)
where a.cat_code=b.cat_code

GO

-- --------------------------------------------------
-- VIEW dbo.vw_DRA_Or_Sb_Identify
-- --------------------------------------------------

CREATE view vw_DRA_Or_Sb_Identify
as
select * from 
(
select distinct CL.sub_broker,CL.party_code,
Case when isnull(DRA.SBTag,'')<>'' then 'DRA' 
when (UL.access_to='SB' and isnull(UL.access_code,'')<>'') then 'SB' ELSe '' end UserType
from risk.dbo.client_details CL with (nolock)
left join risk.dbo.[tbl_DRA_SBTAG] DRA with (nolock)
on CL.sub_broker=DRA.SBTag
left join rolemgm.dbo.[user_login] UL with (nolock)
on CL.sub_broker=UL.access_code
) T where UserType in ('SB','DRA')

GO

-- --------------------------------------------------
-- VIEW dbo.VW_EXCLUDE_CAT_MAPPING
-- --------------------------------------------------
CREATE VIEW VW_EXCLUDE_CAT_MAPPING    --where cat_code='426' and emp_no='E56999'          
AS              
        
SELECT A.MENU_CODE,A.CAT_CODE,b.EMP_NO/*EMP_NO=isnull(B.EMP_NO,a.username)  */  
FROM VW_CAT_MAPPING_USER A (NOLOCK)              
 left outer JOIN              
(        
 SELECT MENU_CODE,EMP_NO,CAT_CODE         
 FROM VW_EXCLUDE_CAT_MAPPING_USER(NOLOCK)         
) B               
        
ON  A.menu_CODE=B.menu_CODE and A.CAT_CODE=B.CAT_CODE 
AND A.USERNAME=B.EMP_NO

GO

-- --------------------------------------------------
-- VIEW dbo.VW_EXCLUDE_CAT_MAPPING_USER
-- --------------------------------------------------
CREATE VIEW VW_EXCLUDE_CAT_MAPPING_USER 
AS  
	SELECT  A.*,B.CAT_CODE 
	FROM EXCLUDE_CAT_MAPPING A (NOLOCK),USER_LOGIN B (NOLOCK) 
	WHERE A.EMP_NO=B.USERNAME

GO

-- --------------------------------------------------
-- VIEW dbo.VW_EXCLUDE_CAT_MAPPING_USER_test
-- --------------------------------------------------
CREATE VIEW VW_EXCLUDE_CAT_MAPPING_USER_test 
AS    
 SELECT  A.*,B.CAT_CODE   
 FROM EXCLUDE_CAT_MAPPING_test A (NOLOCK),USER_LOGIN B (NOLOCK)   
 WHERE A.EMP_NO=B.USERNAME

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_login_logs
-- --------------------------------------------------
CREATE View [dbo].[Vw_login_logs]
as
select distinct username,access_datetime=convert(datetime,convert(varchar(11),access_datetime)) 
from login_logs(nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_menu_item
-- --------------------------------------------------
CREATE View Vw_menu_item
as

select 
menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc,
Owner_name=(case when Owner_name='Rahul C Shah' then Owner_name+' **' else Owner_name end),
developer_name=isnull(y.emp_name,x.Owner_name),applicable_to,update_by,convert(datetime,update_on) as update_on
from
(
select 
menu_code,Head,Sub_Head,menu_name,menu_url,seq_no,active,menu_desc,
Owner_name=isnull(b.emp_name,a.Owner_name),developer_name,applicable_to,update_by,update_on
from menu_item a with (nolock) left outer join emp_info b with (nolock) 
on a.owner_name=b.emp_no
) x
left outer join emp_info y with (nolock) 
on x.developer_name=y.emp_no

GO

-- --------------------------------------------------
-- VIEW dbo.vw_menu_item_active
-- --------------------------------------------------
CREATE view [dbo].[vw_menu_item_active]
as  
select a.*,b.cat_code from
(select * from   menu_item with (nolock) where active='Y') a join
(select * from cat_mapping with (nolock)) b on a.menu_code=b.menu_code

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_RAND
-- --------------------------------------------------

CREATE View Vw_RAND  
as  
select RandNum=RAND()

GO

-- --------------------------------------------------
-- VIEW dbo.vw_region
-- --------------------------------------------------



CREATE view vw_region

as select * from [INTRANET].risk.dbo.region

GO

-- --------------------------------------------------
-- VIEW dbo.vw_region_group_branches
-- --------------------------------------------------
CREATE view vw_region_group_branches      
as      
select branch_code=a.code,Region_code=reg_code,RGMAST_code=rgmast_cd       
from intranet.risk.dbo.region a (nolock) ,intranet.risk.dbo.region_master b (nolock)      
where a.reg_code=b.region_cd

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_regionmaster
-- --------------------------------------------------



CREATE VIEW VW_REGIONMASTER    

AS    

SELECT A.USERNAME,B.BRANCH_CD FROM      

(SELECT USERNAME,ACCESS_CODE FROM USER_LOGIN WHERE ACCESS_TO='RGMAST' AND STATUS=1) A,      

(SELECT RGMAST_CODE,BRANCH_CD=BRANCH_CODE FROM [INTRANET].RISK.DBO.VW_REGION_GROUP_BRANCHES ) B      

WHERE A.ACCESS_CODE=B.RGMAST_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.vw_Rgmast
-- --------------------------------------------------



CREATE VIEW [DBO].[VW_RGMAST]  

AS    

SELECT A.USERNAME,B.BRANCH_CD FROM  

(SELECT USERNAME,ACCESS_CODE FROM USER_LOGIN WHERE ACCESS_TO='REGION' AND STATUS=1) A,  

(SELECT REG_CODE,BRANCH_CD=CODE FROM [INTRANET].RISK.DBO.REGION ) B  

WHERE A.ACCESS_CODE=B.REG_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.VW_SB_Login
-- --------------------------------------------------
create view [dbo].[VW_SB_Login] as
select username,userpassword,status
from user_login where access_to in ('SB' ,'SBMAST')

GO

-- --------------------------------------------------
-- VIEW dbo.VW_SBLogin
-- --------------------------------------------------
Create View VW_SBLogin
As
select u.*,case when ISNULL(sb.SB_Broker_Type,'')='' then 'ALL' else SB_Broker_Type end as SB_Broker_Type from user_login u 
inner join mis.sb_comp.dbo.sb_broker sb
on u.access_code=sb.sbtag
where access_to='sb'

GO

-- --------------------------------------------------
-- VIEW dbo.vw_user_login
-- --------------------------------------------------
create view vw_user_login  
as  
select   
username,  
person_name,  
access_to,  
access_code as branch_code  
FROM user_login   
where status=1 and username like 'E%'   
and access_to in('BRANCH','REGION')

GO

-- --------------------------------------------------
-- VIEW dbo.vw_User_Login_Active
-- --------------------------------------------------


CREATE VIEW vw_User_Login_Active

as

SELECT access_code

  FROM 

  [INTRANET].Rolemgm.dbo.user_login SB with (nolock)

  WHERE 

	  status=1

	  and login_inactive_date>getdate()

	  and access_to='SB'

	  --and usertype='ADMIN'

	  and username is not NULL

GO

-- --------------------------------------------------
-- VIEW dbo.vw_UserAccess
-- --------------------------------------------------

CREATE VIEW VW_USERACCESS      

AS      

	SELECT USERNAME,CODE=ACCESS_CODE FROM USER_LOGIN (NOLOCK)      
	WHERE STATUS=1 AND ACCESS_TO='BRANCH'      
	UNION      
	SELECT USERNAME,CODE=BRANCH_CD FROM USER_LOGIN A (NOLOCK), INTRANET.RISK.DBO.BRANCH_MASTER B(NOLOCK)      
	WHERE STATUS=1 AND ACCESS_TO='BRMAST' AND ACCESS_CODE=BRMAST_CD      
	UNION      
	SELECT USERNAME,CODE FROM USER_LOGIN A (NOLOCK), INTRANET.RISK.DBO.REGION B(NOLOCK)      
	WHERE STATUS=1 AND ACCESS_TO='REGION' AND ACCESS_CODE=REG_CODE      
	UNION      
	SELECT USERNAME,CODE FROM USER_LOGIN A (NOLOCK), INTRANET.RISK.DBO.REGION B(NOLOCK)      
	WHERE STATUS=1 AND ACCESS_TO='BROKER' --AND USERNAME='E05205'

GO

-- --------------------------------------------------
-- VIEW dbo.vw_zone
-- --------------------------------------------------


CREATE view vw_zone

as select * from [INTRANET].risk.dbo.zone

GO

-- --------------------------------------------------
-- VIEW dbo.vw_zone_group_branches
-- --------------------------------------------------
CREATE VIEW VW_ZONE_GROUP_BRANCHES  
AS  
SELECT BRANCH_CODE=A.BRANCH_CD,
	ZONE_CODE=ZONE,
	ZONE_MAST_CODE=MASTERCODE   
FROM INTRANET.RISK.DBO.ZONE A (NOLOCK) ,INTRANET.RISK.DBO.ZONE_REGION_MASTER B (NOLOCK)  
WHERE A.ZONE=B.CODE AND FILTER='ZONE'

GO

-- --------------------------------------------------
-- VIEW dbo.vw_zone_region_master
-- --------------------------------------------------



CREATE view vw_zone_region_master

as select * from [INTRANET].risk.dbo.zone_region_master

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_Zonemaster
-- --------------------------------------------------
create view Vw_Zonemaster  
as  
select a.username,b.branch_cd from    
(select username,access_code from user_login where access_to='ZNMAST' and status=1) a,    
(select zone_mast_code,branch_cd=branch_code from vw_zone_group_branches ) b    
where a.access_code=b.zone_mast_code

GO

