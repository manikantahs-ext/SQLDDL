-- DDL Export
-- Server: 10.253.33.89
-- Database: BSEDB_AB
-- Exported: 2026-02-05T02:38:31.722422

USE BSEDB_AB;
GO

-- --------------------------------------------------
-- FUNCTION dbo.ConcatList
-- --------------------------------------------------
CREATE  function dbo.ConcatList 
(
	@USER  AS VARCHAR(20),
	@DATE AS VARCHAR(11),
	@SELL_BUY AS VARCHAR(5)--@SELL_BUY PARAMETER ADD BY AMIT
)                  
RETURNS VARCHAR(5000)                  
AS                  
BEGIN          
    
DECLARE @OUT VARCHAR(8000)--,@USERID  AS VARCHAR(20) 
   ---BY AMIT 11-NOV-2010   
/*SELECT @OUT=COALESCE(@OUT+',' ,'') +REPLACE(TERMINAL_ID,' ','')  
FROM(SELECT PARTY_CODE,DATE=CONVERT(VARCHAR(11),SAUDA_DATE,103),TERMINAL_ID FROM MIS_TO(NOLOCK) WHERE     
PARTY_CODE=@USER AND CONVERT(VARCHAR(11),SAUDA_DATE,103)=@DATE) A        
RETURN @OUT*/

SELECT @OUT=COALESCE(@OUT+',' ,'') +REPLACE(TERMINAL_ID,' ','')    
FROM(SELECT PARTY_CODE,DATE=CONVERT(VARCHAR(11),SAUDA_DATE,103),TERMINAL_ID FROM NRI_SAUDA_SUMMARY(NOLOCK) WHERE       
PARTY_CODE=@USER AND CONVERT(VARCHAR(11),SAUDA_DATE,103)=@DATE AND SELL_BUY=@SELL_BUY ) A  ORDER BY TERMINAL_ID        
RETURN @OUT  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConcatList_temp11112010
-- --------------------------------------------------
CREATE  function dbo.ConcatList_temp11112010 
(
	@user  as varchar(20),
	@date as varchar(11),
	@Sell_Buy as varchar(5) 
)                  
returns varchar(5000)                  
as                  
begin          
    
declare @Out varchar(8000)--,@userid  as varchar(20)       
               
      
SELECT @Out=COALESCE(@Out+',' ,'') +replace(terminal_id,' ','')  
from(select party_code,date=convert(varchar(11),sauda_Date,103),terminal_id from NRI_SAUDA_SUMMARY(nolock) where     
party_code=@user and convert(varchar(11),sauda_Date,103)=@date AND Sell_Buy=@Sell_Buy ) a  ORDER BY terminal_id      
return @Out                 
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_GetTopOrders
-- --------------------------------------------------
CREATE FUNCTION dbo.fn_GetTopOrders(@branch AS varchar(50), @n AS INT)
  RETURNS TABLE
AS
RETURN
  SELECT TOP(@n) *
  FROM tb where bRANCH_cd=@branch
order by turnover desc

GO

-- --------------------------------------------------
-- FUNCTION dbo.functionGetChqNo
-- --------------------------------------------------
create function 
	functionGetChqNo (
		@vdt varchar(11),
		@vno varchar(12),
		@vtype int
	) returns varchar(1000)

as

begin 

declare @ChqNoGiven varchar(1000) 
declare @temp varchar(1000) 

set @ChqNoGiven = '' 
	select 
		@ChqNoGiven =  ltrim(rtrim(ChqNoGiven)) + ',' + @ChqNoGiven  
	from 
	bsesundryclientmark 
	where 
		vdt like @vdt + '%' and 
		vno = @vno and 
		vtyp = @vtype 
	
	
	if len(ltrim(rtrim(@ChqNoGiven))) > 0 set @ChqNoGiven = left(@ChqNoGiven, len(@ChqNoGiven) - 1)
	return(@ChqNoGiven) 
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetExchangeSegment
-- --------------------------------------------------
CREATE Function GetExchangeSegment (@CompanyName Varchar(25)) Returns Varchar(25)
As
Begin

Set @CompanyName = RTrim(LTrim(Upper(@CompanyName)))

	If @CompanyName = 'ABLCM'
		Return 'BSECM'
	If @CompanyName = 'ACDLCM'
		Return 'NSECM'
	If @CompanyName = 'ACDLFO'
		Return 'NSEFO'
	If @CompanyName = 'ACPLMCX'
		Return 'MCX'
	If @CompanyName = 'ACPLNCDX'
		Return 'NCDEX'

	Return '--'

End

GO

-- --------------------------------------------------
-- FUNCTION dbo.IsHighest
-- --------------------------------------------------
CREATE Function IsHighest(@Today Varchar(35),@Branch_CD Varchar(25)) Returns Varchar(25)

As
Begin
	Declare @total money
	Declare @msg varchar(25)
	select @total=sum(tpb+dpb+tsb+dsb) from level1mis a where sauda_date = @Today And branch_cd = @branch_cd
	
	If @total >= (Select Max(total) from(Select [total]=sum(tpb+dpb+tsb+dsb) from level1mis where sauda_date <= (cast(@Today as datetime)-1) and branch_cd=@branch_cd group by sauda_date)a)
		Set @msg = 'High'
	Else
		Set @Msg = ''
	Return @msg
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ReplaceAlphbate
-- --------------------------------------------------
CREATE FUNCTION dbo.ReplaceAlphbate( @string nvarchar(100))  
 RETURNS varchar(100)  
AS  
BEGIN  
 declare @Return varchar(100) 
/* Created By amit gupta
	Created date 31-08-2010*/ 
 
SET @string = REPLACE(@string,'A','')  
SET @string = REPLACE(@string,'B','') 
SET @string = REPLACE(@string,'C','') 
SET @string = REPLACE(@string,'D','') 

SET @string = REPLACE(@string,'E','')  
SET @string = REPLACE(@string,'F','') 
SET @string = REPLACE(@string,'G','') 
SET @string = REPLACE(@string,'H','') 

SET @string = REPLACE(@string,'I','')  
SET @string = REPLACE(@string,'J','') 
SET @string = REPLACE(@string,'K','') 
SET @string = REPLACE(@string,'L','') 


SET @string = REPLACE(@string,'M','')  
SET @string = REPLACE(@string,'N','') 
SET @string = REPLACE(@string,'O','') 
SET @string = REPLACE(@string,'P','') 

SET @string = REPLACE(@string,'Q','')  
SET @string = REPLACE(@string,'R','') 
SET @string = REPLACE(@string,'S','') 
SET @string = REPLACE(@string,'T','') 

SET @string = REPLACE(@string,'U','')  
SET @string = REPLACE(@string,'V','') 
SET @string = REPLACE(@string,'W','') 
SET @string = REPLACE(@string,'X','') 

SET @string = REPLACE(@string,'Y','')  
SET @string = REPLACE(@string,'Z','') 
SET @Return = @string
RETURN @Return  
--Select  dbo.ReplaceAlphbate('ZR4298') 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.tempfunction
-- --------------------------------------------------
CREATE function 
	tempfunction (
		@vdt varchar(11),
		@vno varchar(12),
		@vtype int
	) returns varchar(1000)

as

begin 

declare @statusname varchar(1000) 

set @statusname = '' 

	select 
		@statusname = case when (isnull(charindex(ltrim(rtrim(statusname)) + ',', @statusname, 0), 0) >= 1) then @statusname else (ltrim(rtrim(statusname)) + ',' + @statusname) end 
	from 
		bsesundryclientmark 
	where 
		vdt like @vdt + '%' and 
		vno = @vno and 
		vtyp = @vtype 

	if len(ltrim(rtrim(@statusname))) > 0 set @statusname = left(@statusname, len(@statusname) - 1) 

	return(@statusname) 
end 

--sp_rpt_sundry_client_reco_list_ 'Nov  5 2005', 'Dec  5 2005', 'HO', 'HO'

GO

-- --------------------------------------------------
-- INDEX dbo._ClientQuestionAnswer
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ADate] ON [dbo].[_ClientQuestionAnswer] ([ADate])

GO

-- --------------------------------------------------
-- INDEX dbo.01082006USERS-ver6
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Col001] ON [dbo].[01082006USERS-ver6] ([Col001])

GO

-- --------------------------------------------------
-- INDEX dbo.4Maping
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Col001] ON [dbo].[4Maping] ([Col001])

GO

-- --------------------------------------------------
-- INDEX dbo.aaa
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_Cd] ON [dbo].[aaa] ([branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.AAAAA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Brokerage] ON [dbo].[AAAAA] ([Brokerage])

GO

-- --------------------------------------------------
-- INDEX dbo.ACM_CL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_EX] ON [dbo].[ACM_CL] ([EX])

GO

-- --------------------------------------------------
-- INDEX dbo.acm_client
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_F10] ON [dbo].[acm_client] ([F10])

GO

-- --------------------------------------------------
-- INDEX dbo.active_cl_12mar
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_party_code] ON [dbo].[active_cl_12mar] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.ANGEL_ROI
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch] ON [dbo].[ANGEL_ROI] ([Branch])

GO

-- --------------------------------------------------
-- INDEX dbo.angel_slab_diff
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_Cd] ON [dbo].[angel_slab_diff] ([branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.AngelClientSummary
-- --------------------------------------------------
CREATE UNIQUE CLUSTERED INDEX [Party_code] ON [dbo].[AngelClientSummary] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.AngelDPC
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BOID] ON [dbo].[AngelDPC] ([BOID])

GO

-- --------------------------------------------------
-- INDEX dbo.angelfotrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActivityTime] ON [dbo].[angelfotrade] ([ActivityTime])

GO

-- --------------------------------------------------
-- INDEX dbo.angelfotradeBefore
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActivityTime] ON [dbo].[angelfotradeBefore] ([ActivityTime])

GO

-- --------------------------------------------------
-- INDEX dbo.angelfotradeInter
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActivityTime] ON [dbo].[angelfotradeInter] ([ActivityTime])

GO

-- --------------------------------------------------
-- INDEX dbo.AngelKycCharges
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[AngelKycCharges] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.AngelTermBrok
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_AlBmCf_TableNo] ON [dbo].[AngelTermBrok] ([AlBmCf_TableNo])

GO

-- --------------------------------------------------
-- INDEX dbo.B2B_July_brok
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_From] ON [dbo].[B2B_July_brok] ([From dt.])

GO

-- --------------------------------------------------
-- INDEX dbo.BackupTempNumb
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Orders] ON [dbo].[BackupTempNumb] ([Orders])

GO

-- --------------------------------------------------
-- INDEX dbo.bak_tradeanywhere_master
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch] ON [dbo].[bak_tradeanywhere_master] ([Branch])

GO

-- --------------------------------------------------
-- INDEX dbo.BankROCRateMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Active] ON [dbo].[BankROCRateMaster] ([Active])

GO

-- --------------------------------------------------
-- INDEX dbo.BankROIRateMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Active] ON [dbo].[BankROIRateMaster] ([Active])

GO

-- --------------------------------------------------
-- INDEX dbo.Baroda
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Bk] ON [dbo].[Baroda] ([Bk# Price Profit/Loss])

GO

-- --------------------------------------------------
-- INDEX dbo.Bhav_mcx
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Close] ON [dbo].[Bhav_mcx] ([Close(Rs)])

GO

-- --------------------------------------------------
-- INDEX dbo.bhav_mcx_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Close] ON [dbo].[bhav_mcx_hist] ([Close(Rs)])

GO

-- --------------------------------------------------
-- INDEX dbo.Bhav_ncdx
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Closing_price] ON [dbo].[Bhav_ncdx] ([Closing_price])

GO

-- --------------------------------------------------
-- INDEX dbo.bhav_ncdx_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ind_tdate] ON [dbo].[bhav_ncdx_hist] ([tdate])

GO

-- --------------------------------------------------
-- INDEX dbo.BOfo_to
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_SaudaDate] ON [dbo].[BOfo_to] ([SaudaDate])

GO

-- --------------------------------------------------
-- INDEX dbo.branch
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Branch] ON [dbo].[branch] ([BRANCH_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BranchList
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BranchCode] ON [dbo].[BranchList] ([BranchCode])

GO

-- --------------------------------------------------
-- INDEX dbo.Brok_FebMar09
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Id] ON [dbo].[Brok_FebMar09] ([Id])

GO

-- --------------------------------------------------
-- INDEX dbo.bsebillvalan
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_billno] ON [dbo].[bsebillvalan] ([billno])

GO

-- --------------------------------------------------
-- INDEX dbo.Bsesundry
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_accat] ON [dbo].[Bsesundry] ([accat])

GO

-- --------------------------------------------------
-- INDEX dbo.BSeSundryclientMark
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[BSeSundryclientMark] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.BseSundryClientReco
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[BseSundryClientReco] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.BseSundryclientreco1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[BseSundryclientreco1] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.c1_temp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_cl_code] ON [dbo].[c1_temp] ([cl_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Cash_GLCode
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[Cash_GLCode] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.client_grade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_br12006] ON [dbo].[client_grade] ([br12006])

GO

-- --------------------------------------------------
-- INDEX dbo.client2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ind_Cl_code] ON [dbo].[client2] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.client2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ind_Party_code] ON [dbo].[client2] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientFundsPayOutDetails
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ClientCode] ON [dbo].[ClientFundsPayOutDetails] ([ClientCode])

GO

-- --------------------------------------------------
-- INDEX dbo.clients_accountopen
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_abl] ON [dbo].[clients_accountopen] ([abl])

GO

-- --------------------------------------------------
-- INDEX dbo.clients_accountopen08072005del
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_abl] ON [dbo].[clients_accountopen08072005del] ([abl])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientSecuritiesPayOutDetails
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ClientCode] ON [dbo].[ClientSecuritiesPayOutDetails] ([ClientCode])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientSummaryAmounts
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_Code] ON [dbo].[ClientSummaryAmounts] ([Branch_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientWelCome
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_CourierDate] ON [dbo].[ClientWelCome] ([CourierDate])

GO

-- --------------------------------------------------
-- INDEX dbo.commo_perf_eval
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ind_tdate] ON [dbo].[commo_perf_eval] ([tdate])

GO

-- --------------------------------------------------
-- INDEX dbo.commo_perf_eval_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_name] ON [dbo].[commo_perf_eval_hist] ([branch_name])

GO

-- --------------------------------------------------
-- INDEX dbo.commo_perf_eval_sb
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ind_tdate] ON [dbo].[commo_perf_eval_sb] ([tdate])

GO

-- --------------------------------------------------
-- INDEX dbo.commo_perf_eval1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_Cd] ON [dbo].[commo_perf_eval1] ([branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.COMPDATE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch] ON [dbo].[COMPDATE] ([branch])

GO

-- --------------------------------------------------
-- INDEX dbo.contr_comm
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[contr_comm] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.CTCL_adminuser
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_abl_upd] ON [dbo].[CTCL_adminuser] ([abl_upd])

GO

-- --------------------------------------------------
-- INDEX dbo.CTCL_TO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch] ON [dbo].[CTCL_TO] ([branch])

GO

-- --------------------------------------------------
-- INDEX dbo.data_new
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_Cd] ON [dbo].[data_new] ([Branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.DuplicateChq
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Acname] ON [dbo].[DuplicateChq] ([Acname])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_client_access
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_bse_stat] ON [dbo].[ebrok_client_access] ([bse_stat])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_log_status
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRANCH_CD] ON [dbo].[ebrok_log_status] ([BRANCH_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_log_status
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sauda_date] ON [dbo].[ebrok_log_status] ([sauda_date], [BRANCH_CD], [SUB_BROKER])

GO

-- --------------------------------------------------
-- INDEX dbo.Ebrok_mis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[Ebrok_mis] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Ebrok_mis1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_sdate] ON [dbo].[Ebrok_mis1] ([sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.Ebrok_mis1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sauda_date] ON [dbo].[Ebrok_mis1] ([sauda_date], [branch_cd], [sub_broker], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Ebrok_mis1_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[Ebrok_mis1_hist] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_tobr_period
-- --------------------------------------------------
CREATE CLUSTERED INDEX [dateBrSb] ON [dbo].[ebrok_tobr_period] ([sauda_date], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_tobr_period
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sauda_date] ON [dbo].[ebrok_tobr_period] ([sauda_date], [branch_cd], [sub_broker])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_description] ON [dbo].[ebroking] ([description])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_Trades
-- --------------------------------------------------
CREATE CLUSTERED INDEX [dtcl] ON [dbo].[ebroking_Trades] ([dCurrentTime], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.email_cbs_data_check
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_email_data_flag] ON [dbo].[email_cbs_data_check] ([email_data_flag])

GO

-- --------------------------------------------------
-- INDEX dbo.FD-BG-Detail
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BGCode] ON [dbo].[FD-BG-Detail] ([BGCode])

GO

-- --------------------------------------------------
-- INDEX dbo.FDDetail
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActualGrossInterest] ON [dbo].[FDDetail] ([ActualGrossInterest])

GO

-- --------------------------------------------------
-- INDEX dbo.FDS_IntraInDelivery_BSE_NSE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_buyrate] ON [dbo].[FDS_IntraInDelivery_BSE_NSE] ([buyrate])

GO

-- --------------------------------------------------
-- INDEX dbo.FDS_INTRAINDELIVERY_NSE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_buyrate] ON [dbo].[FDS_INTRAINDELIVERY_NSE] ([buyrate])

GO

-- --------------------------------------------------
-- INDEX dbo.FDS_IntraInDelivery_NSEFO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_b_sell_amt] ON [dbo].[FDS_IntraInDelivery_NSEFO] ([b_sell_amt])

GO

-- --------------------------------------------------
-- INDEX dbo.FINAL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRANCH_CD] ON [dbo].[FINAL] ([BRANCH_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.first_Etrade_date
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_first_trade_date] ON [dbo].[first_Etrade_date] ([first_trade_date])

GO

-- --------------------------------------------------
-- INDEX dbo.firstfinal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_activefrom] ON [dbo].[firstfinal] ([activefrom])

GO

-- --------------------------------------------------
-- INDEX dbo.Gabriel_Vol
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_bsecm_not] ON [dbo].[Gabriel_Vol] ([bsecm_not])

GO

-- --------------------------------------------------
-- INDEX dbo.GN_total
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_totcg] ON [dbo].[GN_total] ([totcg])

GO

-- --------------------------------------------------
-- INDEX dbo.HighestBrokerage
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[HighestBrokerage] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.HighLowBrokerage
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[HighLowBrokerage] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.hnibroktot
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_br12006] ON [dbo].[hnibroktot] ([br12006])

GO

-- --------------------------------------------------
-- INDEX dbo.hnibroktot1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_br12006] ON [dbo].[hnibroktot1] ([br12006])

GO

-- --------------------------------------------------
-- INDEX dbo.HoldingData
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_accno] ON [dbo].[HoldingData] ([accno])

GO

-- --------------------------------------------------
-- INDEX dbo.hyd2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Party_code] ON [dbo].[hyd2] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.indexdetails
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_cNetChangeIndicator] ON [dbo].[indexdetails] ([cNetChangeIndicator])

GO

-- --------------------------------------------------
-- INDEX dbo.IntranetAngelRemcalc
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActBrok] ON [dbo].[IntranetAngelRemcalc] ([ActBrok])

GO

-- --------------------------------------------------
-- INDEX dbo.IntranetAngelRemcalc
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [sau] ON [dbo].[IntranetAngelRemcalc] ([Sauda_date], [Coname])

GO

-- --------------------------------------------------
-- INDEX dbo.jaganbro
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brokerage] ON [dbo].[jaganbro] ([brokerage])

GO

-- --------------------------------------------------
-- INDEX dbo.jaip_cl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_April] ON [dbo].[jaip_cl] ([April Till date])

GO

-- --------------------------------------------------
-- INDEX dbo.KIRANSHEET2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Active] ON [dbo].[KIRANSHEET2] ([Active From Dt#])

GO

-- --------------------------------------------------
-- INDEX dbo.kyc_documents
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_annualreport] ON [dbo].[kyc_documents] ([annualreport])

GO

-- --------------------------------------------------
-- INDEX dbo.kyc_documents07072005del
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_annualreport] ON [dbo].[kyc_documents07072005del] ([annualreport])

GO

-- --------------------------------------------------
-- INDEX dbo.level1QMis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_Cd] ON [dbo].[level1QMis] ([Branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Level1ScripMis
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ISIN] ON [dbo].[Level1ScripMis] ([IsIN])

GO

-- --------------------------------------------------
-- INDEX dbo.Level1ScripMis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Sauda_Date] ON [dbo].[Level1ScripMis] ([Sauda_date], [IsIN])

GO

-- --------------------------------------------------
-- INDEX dbo.Level2Mis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActBrok] ON [dbo].[Level2Mis] ([ActBrok])

GO

-- --------------------------------------------------
-- INDEX dbo.Level2Mis
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [YearMonth] ON [dbo].[Level2Mis] ([Year], [Month], [Branch_cd], [Sub_Broker], [Family], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.level2mis_test
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[level2mis_test] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Level3Mis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActBrok] ON [dbo].[Level3Mis] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Level4Mis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActBrok] ON [dbo].[Level4Mis] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Level5Mis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActBrok] ON [dbo].[Level5Mis] ([ActBrok])

GO

-- --------------------------------------------------
-- INDEX dbo.Level6FyearMis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActBrok] ON [dbo].[Level6FyearMis] ([ActBrok])

GO

-- --------------------------------------------------
-- INDEX dbo.Level6Mis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActBrok] ON [dbo].[Level6Mis] ([ActBrok])

GO

-- --------------------------------------------------
-- INDEX dbo.LevelRemMis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Actbrok] ON [dbo].[LevelRemMis] ([Actbrok])

GO

-- --------------------------------------------------
-- INDEX dbo.levelscrip
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[levelscrip] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Log_DupChqAmtUp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_LastUpdate] ON [dbo].[Log_DupChqAmtUp] ([LastUpdate])

GO

-- --------------------------------------------------
-- INDEX dbo.LogDelete_bsesundryclientmark
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[LogDelete_bsesundryclientmark] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.LOGINFILE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxfname] ON [dbo].[LOGINFILE] ([FNAME])

GO

-- --------------------------------------------------
-- INDEX dbo.LOGINFILE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxLdate_Pcode] ON [dbo].[LOGINFILE] ([LOGIN_DATE], [PARTY_cODE])

GO

-- --------------------------------------------------
-- INDEX dbo.LOGINFILE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_login_date] ON [dbo].[LOGINFILE] ([LOGIN_DATE], [STATUS], [PARTY_cODE])

GO

-- --------------------------------------------------
-- INDEX dbo.LOGINFILE_TEMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRANCH] ON [dbo].[LOGINFILE_TEMP] ([BRANCH])

GO

-- --------------------------------------------------
-- INDEX dbo.m_mis_to
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[m_mis_to] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.mapping_temp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_executive] ON [dbo].[mapping_temp] ([executive])

GO

-- --------------------------------------------------
-- INDEX dbo.MCX_client
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Column] ON [dbo].[MCX_client] ([Column 0])

GO

-- --------------------------------------------------
-- INDEX dbo.MessageTable
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_message] ON [dbo].[MessageTable] ([message])

GO

-- --------------------------------------------------
-- INDEX dbo.minTbl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BSE_TRD_TO] ON [dbo].[minTbl] ([BSE_TRD_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS$
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Annexure] ON [dbo].[MIS$] ([Annexure])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_br
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[mis_br] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_Client_grade
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_code] ON [dbo].[MIS_Client_grade] ([TmonthNo], [party_code], [grade], [TYear])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_Client_grade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [party_code] ON [dbo].[MIS_Client_grade] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_Client_grade
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [tmonthno] ON [dbo].[MIS_Client_grade] ([TmonthNo], [grade], [grade_no])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_ebroking
-- --------------------------------------------------
CREATE CLUSTERED INDEX [sauda_date] ON [dbo].[MIS_ebroking] ([Sauda_Date], [party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_ebroking_cli_tbl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxonline] ON [dbo].[MIS_ebroking_cli_tbl] ([sauda_date], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_ebroking_cli_tbl
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ind_branch_Cd] ON [dbo].[MIS_ebroking_cli_tbl] ([branch_cd], [sub_Broker], [user_stat])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_ebroking_cli_tbl
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sauda_date] ON [dbo].[MIS_ebroking_cli_tbl] ([sauda_date], [party_code], [nooflogin])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_NoOfTrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_not] ON [dbo].[mis_NoOfTrade] ([sauda_date], [company])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_TO_Branch
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Date_Company_branch] ON [dbo].[Mis_TO_Branch] ([sauda_Date], [company], [Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_to_bsecm
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[Mis_to_bsecm] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_bsedb
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Company] ON [dbo].[mis_to_bsedb] ([Company]) INCLUDE ([sauda_date], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_bsedb
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_NONsauda_date] ON [dbo].[mis_to_bsedb] ([sauda_date], [Sub_broker], [party_code], [brokerage])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_bsedb
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_code] ON [dbo].[mis_to_bsedb] ([party_code], [sauda_date]) INCLUDE ([branch_cd], [Sub_broker], [party_name], [brokerage], [Company])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_bsedb
-- --------------------------------------------------
CREATE CLUSTERED INDEX [sauda_date] ON [dbo].[mis_to_bsedb] ([sauda_date], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_To_Company
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Date_Company] ON [dbo].[Mis_To_Company] ([sauda_Date], [company])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[mis_to_hist] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_history
-- --------------------------------------------------
CREATE CLUSTERED INDEX [br_sb_pty] ON [dbo].[mis_to_history] ([branch_cd], [sub_broker], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_history
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [date_br_sb_pty] ON [dbo].[mis_to_history] ([sauda_Date], [branch_cd], [sub_broker], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_history
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [odin_cmb_rpt] ON [dbo].[mis_to_history] ([Company], [sauda_Date], [branch_cd], [sub_broker], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_history
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [party] ON [dbo].[mis_to_history] ([party_code], [sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_to_Nsecm
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[Mis_to_Nsecm] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_to_nsefo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[Mis_to_nsefo] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_to_nsefo1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[Mis_to_nsefo1] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_TO_Region
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Date_Company_region] ON [dbo].[Mis_TO_Region] ([sauda_Date], [company], [region])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_TO_SB
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Date_Company_sb] ON [dbo].[Mis_TO_SB] ([sauda_Date], [company], [Sub_Broker])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_Shift
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_sdate] ON [dbo].[mis_to_Shift] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_temp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[mis_to_temp] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_temp31July
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[mis_to_temp31July] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to_temp31July_TurnOver
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[mis_to_temp31July_TurnOver] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_TO_Terminal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Date_Company_Terminal] ON [dbo].[Mis_TO_Terminal] ([sauda_Date], [company], [terminal_id])

GO

-- --------------------------------------------------
-- INDEX dbo.Mis_TO_Terminal_Detail
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Date_Co_Terminal] ON [dbo].[Mis_TO_Terminal_Detail] ([sauda_Date], [company], [terminal_id])

GO

-- --------------------------------------------------
-- INDEX dbo.mis_to1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BK_Del_Opt] ON [dbo].[mis_to1] ([BK_Del_Opt])

GO

-- --------------------------------------------------
-- INDEX dbo.MISTotal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Brokerage] ON [dbo].[MISTotal] ([Brokerage])

GO

-- --------------------------------------------------
-- INDEX dbo.mngrwise
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ablcm_brk] ON [dbo].[mngrwise] ([ablcm_brk])

GO

-- --------------------------------------------------
-- INDEX dbo.NRI_SAUDA_SUMMARY
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_PARTY_CODE] ON [dbo].[NRI_SAUDA_SUMMARY] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.Nse
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[Nse] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.nse_position
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_isin] ON [dbo].[nse_position] ([isin])

GO

-- --------------------------------------------------
-- INDEX dbo.nsecm_test
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[nsecm_test] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Nsefo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[Nsefo] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.nsefosundryclientmark
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[nsefosundryclientmark] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.NseFoSundryClientReco
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[NseFoSundryClientReco] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.NseFOSundryclientreco1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[NseFOSundryclientreco1] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.nsesundryclientmark
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[nsesundryclientmark] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.NseSundryClientReco
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[NseSundryClientReco] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.NseSundryclientreco1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_acname] ON [dbo].[NseSundryclientreco1] ([acname])

GO

-- --------------------------------------------------
-- INDEX dbo.Oct_10
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRKRG] ON [dbo].[Oct_10] ([BRKRG])

GO

-- --------------------------------------------------
-- INDEX dbo.oct_cllist06
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ActiveFrom] ON [dbo].[oct_cllist06] ([ActiveFrom])

GO

-- --------------------------------------------------
-- INDEX dbo.Odine_server_ebrok
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_odin_name] ON [dbo].[Odine_server_ebrok] ([odin_name])

GO

-- --------------------------------------------------
-- INDEX dbo.overall_mrg
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BrokerCode] ON [dbo].[overall_mrg] ([BrokerCode])

GO

-- --------------------------------------------------
-- INDEX dbo.pe_data
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_B2B] ON [dbo].[pe_data] ([B2B])

GO

-- --------------------------------------------------
-- INDEX dbo.pe_data_fo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_assignmentvalue] ON [dbo].[pe_data_fo] ([assignmentvalue])

GO

-- --------------------------------------------------
-- INDEX dbo.pe_franch_sharing_perc
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx] ON [dbo].[pe_franch_sharing_perc] ([ftag])

GO

-- --------------------------------------------------
-- INDEX dbo.PE_MF
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_DeliveryTO] ON [dbo].[PE_MF] ([DeliveryTO])

GO

-- --------------------------------------------------
-- INDEX dbo.pe_net_brok
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch] ON [dbo].[pe_net_brok] ([branch])

GO

-- --------------------------------------------------
-- INDEX dbo.pe_nooftrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_company] ON [dbo].[pe_nooftrade] ([company])

GO

-- --------------------------------------------------
-- INDEX dbo.prepaid
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Active] ON [dbo].[prepaid] ([Active From Dt#])

GO

-- --------------------------------------------------
-- INDEX dbo.pune1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Closing] ON [dbo].[pune1] ([Closing])

GO

-- --------------------------------------------------
-- INDEX dbo.QA_CLient_Details
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Heading] ON [dbo].[QA_CLient_Details] ([Heading])

GO

-- --------------------------------------------------
-- INDEX dbo.Rashmi
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_bsecm_to] ON [dbo].[Rashmi] ([bsecm_to])

GO

-- --------------------------------------------------
-- INDEX dbo.Rcs_cl_details
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Ac_num] ON [dbo].[Rcs_cl_details] ([Ac_num])

GO

-- --------------------------------------------------
-- INDEX dbo.Rcs_cl_details1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Ac_num] ON [dbo].[Rcs_cl_details1] ([Ac_num])

GO

-- --------------------------------------------------
-- INDEX dbo.RegionBranchTag
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branchinput] ON [dbo].[RegionBranchTag] ([branchinput])

GO

-- --------------------------------------------------
-- INDEX dbo.report_excel
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_heading] ON [dbo].[report_excel] ([HEADING])

GO

-- --------------------------------------------------
-- INDEX dbo.ReportOffset
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Col_Align] ON [dbo].[ReportOffset] ([Col_Align])

GO

-- --------------------------------------------------
-- INDEX dbo.result
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_status] ON [dbo].[result] ([status])

GO

-- --------------------------------------------------
-- INDEX dbo.rm_temp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[rm_temp] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.rmbillvalan
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[rmbillvalan] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.rmbillvalan1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[rmbillvalan1] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.rmbillvalan2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[rmbillvalan2] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.roz
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_corr_date] ON [dbo].[roz] ([corr_date])

GO

-- --------------------------------------------------
-- INDEX dbo.SB
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_SB] ON [dbo].[SB] ([SB])

GO

-- --------------------------------------------------
-- INDEX dbo.SB_Brok
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_SB] ON [dbo].[SB_Brok] ([SB])

GO

-- --------------------------------------------------
-- INDEX dbo.SB_TO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch] ON [dbo].[SB_TO] ([Branch])

GO

-- --------------------------------------------------
-- INDEX dbo.SB_TRADE_DETAILS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRANCH_CD] ON [dbo].[SB_TRADE_DETAILS] ([BRANCH_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.sblabel
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[sblabel] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.ScripMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ISIN] ON [dbo].[ScripMaster] ([ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.ScripMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ScripName] ON [dbo].[ScripMaster] ([Scrip_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.SEBI_ActiveCL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Cl_code] ON [dbo].[SEBI_ActiveCL] ([Cl_code])

GO

-- --------------------------------------------------
-- INDEX dbo.SEBI_CLmailID
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Cl_code] ON [dbo].[SEBI_CLmailID] ([Cl_code])

GO

-- --------------------------------------------------
-- INDEX dbo.sett_mst
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_End_Date] ON [dbo].[sett_mst] ([End_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Sheet1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Account] ON [dbo].[Sheet1] ([Account's Name])

GO

-- --------------------------------------------------
-- INDEX dbo.Sheet1$
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch#Code] ON [dbo].[Sheet1$] ([Branch#Code])

GO

-- --------------------------------------------------
-- INDEX dbo.SkCodes
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Party_code] ON [dbo].[SkCodes] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.sub_details
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Mcx_Brokerage] ON [dbo].[sub_details] ([Mcx_Brokerage])

GO

-- --------------------------------------------------
-- INDEX dbo.sundry
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_banknamegiven] ON [dbo].[sundry] ([banknamegiven])

GO

-- --------------------------------------------------
-- INDEX dbo.t2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_br] ON [dbo].[t2] ([br])

GO

-- --------------------------------------------------
-- INDEX dbo.tb
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_B2B_clt] ON [dbo].[tb] ([B2B_clt])

GO

-- --------------------------------------------------
-- INDEX dbo.Tb_Pivot
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_AprBrokerage] ON [dbo].[Tb_Pivot] ([AprBrokerage])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Admin_Login
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_First_Name] ON [dbo].[tbl_Admin_Login] ([First_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Admin_Login
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UniqueUserName] ON [dbo].[tbl_Admin_Login] ([Login_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Client_First_Date
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_BSECM_FirstTradeDate] ON [dbo].[tbl_Client_First_Date] ([BSECM_FirstTradeDate], [party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Client_First_Date
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_First_trade_date] ON [dbo].[tbl_Client_First_Date] ([First_trade_date], [party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Client_First_Date
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_NSECM_FirstTradeDate] ON [dbo].[tbl_Client_First_Date] ([NSECM_FirstTradeDate], [party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Client_First_Date
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IXparty_Code] ON [dbo].[tbl_Client_First_Date] ([party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_cmn_usr_rm
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_cmn_usr_name] ON [dbo].[tbl_cmn_usr_rm] ([cmn_usr_name])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_common_login_bo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_bo_usr_admin_id] ON [dbo].[tbl_common_login_bo] ([bo_usr_admin_id])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_common_login_serverinfo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_application] ON [dbo].[tbl_common_login_serverinfo] ([application])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_fifo_temp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[tbl_fifo_temp] ([Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Rpt_UT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[tbl_Rpt_UT] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_Trade_Alert_Nsefo_summary
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_b_rate] ON [dbo].[Tbl_Trade_Alert_Nsefo_summary] ([b_rate])

GO

-- --------------------------------------------------
-- INDEX dbo.tbladmin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_fldauto_admin] ON [dbo].[tbladmin] ([fldauto_admin])

GO

-- --------------------------------------------------
-- INDEX dbo.tblcategory
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_fldadminauto] ON [dbo].[tblcategory] ([fldadminauto])

GO

-- --------------------------------------------------
-- INDEX dbo.tblMarketExecFieldMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Deleted] ON [dbo].[tblMarketExecFieldMaster] ([Deleted])

GO

-- --------------------------------------------------
-- INDEX dbo.tblMarketExecRegionMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Deleted] ON [dbo].[tblMarketExecRegionMaster] ([Deleted])

GO

-- --------------------------------------------------
-- INDEX dbo.tblMarketHeadMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Deleted] ON [dbo].[tblMarketHeadMaster] ([Deleted])

GO

-- --------------------------------------------------
-- INDEX dbo.tblMarketRegionMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Deleted] ON [dbo].[tblMarketRegionMaster] ([Deleted])

GO

-- --------------------------------------------------
-- INDEX dbo.tblMarketWorkDoneMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BranchCode] ON [dbo].[tblMarketWorkDoneMaster] ([BranchCode])

GO

-- --------------------------------------------------
-- INDEX dbo.tblPradnyausers
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_fldaddress1] ON [dbo].[tblPradnyausers] ([fldaddress1])

GO

-- --------------------------------------------------
-- INDEX dbo.tblPradnyausers1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_fldaddress1] ON [dbo].[tblPradnyausers1] ([fldaddress1])

GO

-- --------------------------------------------------
-- INDEX dbo.tblPradnyausers2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_fldaddress1] ON [dbo].[tblPradnyausers2] ([fldaddress1])

GO

-- --------------------------------------------------
-- INDEX dbo.tblTerminals
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Index_TerminalID] ON [dbo].[tblTerminals] ([Terminal_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.tblTrackingVisits
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Browser] ON [dbo].[tblTrackingVisits] ([Browser])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUpdateMISLog
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ExchangeSegment] ON [dbo].[tblUpdateMISLog] ([ExchangeSegment])

GO

-- --------------------------------------------------
-- INDEX dbo.tbluserslog
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_dummy1] ON [dbo].[tbluserslog] ([dummy1])

GO

-- --------------------------------------------------
-- INDEX dbo.tejal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_pcode] ON [dbo].[tejal] ([pcode])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_abc
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brok] ON [dbo].[temp_abc] ([brok])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_BrkData
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_B2BDelGrsRev] ON [dbo].[Temp_BrkData] ([B2BDelGrsRev])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_BrkData1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_B2BDelGrsRev] ON [dbo].[Temp_BrkData1] ([B2BDelGrsRev])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_Brokdata
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch#Code] ON [dbo].[temp_Brokdata] ([Branch#Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_Brokdatafinal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Activation_date] ON [dbo].[Temp_Brokdatafinal] ([Activation_date])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_broke
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_broke] ON [dbo].[temp_broke] ([broke])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_cl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ClientName] ON [dbo].[temp_cl] ([Client Name])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_Cltcode
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_PartyCode] ON [dbo].[Temp_Cltcode] ([PartyCode])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_Commo_date
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Sauda_Date] ON [dbo].[Temp_Commo_date] ([Sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_date2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_first_trade_date] ON [dbo].[temp_date2] ([first_trade_date])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_DEc08
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brok] ON [dbo].[temp_DEc08] ([brok])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_ebrok
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_loca] ON [dbo].[temp_ebrok] ([loca])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_Ebrok_mis1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[temp_Ebrok_mis1] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_f
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch] ON [dbo].[temp_f] ([branch])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_Feb09
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brok] ON [dbo].[temp_Feb09] ([brok])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_HNI
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_Cd] ON [dbo].[temp_HNI] ([Branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_Jan08
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brok] ON [dbo].[temp_Jan08] ([brok])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_log
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRANCH] ON [dbo].[temp_log] ([BRANCH])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_loginfile
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRANCH] ON [dbo].[temp_loginfile] ([BRANCH])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_loginfile1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BRANCH] ON [dbo].[temp_loginfile1] ([BRANCH])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_logs
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ablcm_brk] ON [dbo].[temp_logs] ([ablcm_brk])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_Mar09
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brok] ON [dbo].[temp_Mar09] ([brok])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_mis
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_cd] ON [dbo].[temp_mis] ([branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_mis_client
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_party_code] ON [dbo].[temp_mis_client] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_misBK
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BSECM_DEL_brk] ON [dbo].[temp_misBK] ([BSECM_DEL_brk])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_misto
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BSECM_DEL_TO] ON [dbo].[temp_misto] ([BSECM_DEL_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_Nov08
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brok] ON [dbo].[temp_Nov08] ([brok])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_odin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ALLOWED_DEBIT] ON [dbo].[temp_odin] ([ALLOWED_DEBIT])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_TEMP0_BSE_CF
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_balance] ON [dbo].[temp_TEMP0_BSE_CF] ([balance])

GO

-- --------------------------------------------------
-- INDEX dbo.TEMP_TERMINAL_ID
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_TERMINAL_ID] ON [dbo].[TEMP_TERMINAL_ID] ([TERMINAL_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.TEMP_TERMINAL_ID_new
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_101] ON [dbo].[TEMP_TERMINAL_ID_new] ([101])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_TO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_12] ON [dbo].[temp_TO] ([12-Jul])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_Turnover
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch] ON [dbo].[Temp_Turnover] ([Branch])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_Turnover10
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch] ON [dbo].[Temp_Turnover10] ([Branch])

GO

-- --------------------------------------------------
-- INDEX dbo.temp_ver6
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[temp_ver6] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.Temp_ver7
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[Temp_ver7] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.temp1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_activefrom] ON [dbo].[temp1] ([activefrom])

GO

-- --------------------------------------------------
-- INDEX dbo.tempBranch
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_branch_Cd] ON [dbo].[tempBranch] ([branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.tempDuplicateAmtC
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_vamt] ON [dbo].[tempDuplicateAmtC] ([vamt])

GO

-- --------------------------------------------------
-- INDEX dbo.tempDuplicateAmtD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_vamt] ON [dbo].[tempDuplicateAmtD] ([vamt])

GO

-- --------------------------------------------------
-- INDEX dbo.TempDuplicateC
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Amount] ON [dbo].[TempDuplicateC] ([Amount])

GO

-- --------------------------------------------------
-- INDEX dbo.TempDuplicateD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Amount] ON [dbo].[TempDuplicateD] ([Amount])

GO

-- --------------------------------------------------
-- INDEX dbo.tempfinal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_activefrom] ON [dbo].[tempfinal] ([activefrom])

GO

-- --------------------------------------------------
-- INDEX dbo.tempg
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ExchangeSegment] ON [dbo].[tempg] ([ExchangeSegment])

GO

-- --------------------------------------------------
-- INDEX dbo.tempg1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_ExchangeSegment] ON [dbo].[tempg1] ([ExchangeSegment])

GO

-- --------------------------------------------------
-- INDEX dbo.Templevel
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_Cd] ON [dbo].[Templevel] ([Branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.TempNumb
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Orders] ON [dbo].[TempNumb] ([Orders])

GO

-- --------------------------------------------------
-- INDEX dbo.tempo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_username] ON [dbo].[tempo] ([username])

GO

-- --------------------------------------------------
-- INDEX dbo.tempver6
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[tempver6] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.tempver7
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[tempver7] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.Termid
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Connectivity] ON [dbo].[Termid] ([Connectivity ])

GO

-- --------------------------------------------------
-- INDEX dbo.test
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_seg] ON [dbo].[test] ([seg])

GO

-- --------------------------------------------------
-- INDEX dbo.test_wasim
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Client] ON [dbo].[test_wasim] ([Client])

GO

-- --------------------------------------------------
-- INDEX dbo.Tmp_Brokdata
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Activation_date] ON [dbo].[Tmp_Brokdata] ([Activation_date])

GO

-- --------------------------------------------------
-- INDEX dbo.tmp_overall_mrg
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_BrokerCode] ON [dbo].[tmp_overall_mrg] ([BrokerCode])

GO

-- --------------------------------------------------
-- INDEX dbo.tmp1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_mdate] ON [dbo].[tmp1] ([mdate])

GO

-- --------------------------------------------------
-- INDEX dbo.tmpBrk
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_brokrage] ON [dbo].[tmpBrk] ([brokrage])

GO

-- --------------------------------------------------
-- INDEX dbo.TradeAPC
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Col02] ON [dbo].[TradeAPC] ([Col02])

GO

-- --------------------------------------------------
-- INDEX dbo.TradeAPC
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [OrderNo] ON [dbo].[TradeAPC] ([Order_no])

GO

-- --------------------------------------------------
-- INDEX dbo.TradeAPCBPCInter
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Col02] ON [dbo].[TradeAPCBPCInter] ([Col02])

GO

-- --------------------------------------------------
-- INDEX dbo.TradeBPC
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Col02] ON [dbo].[TradeBPC] ([Col02])

GO

-- --------------------------------------------------
-- INDEX dbo.TradeBPC
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Orderno] ON [dbo].[TradeBPC] ([Order_no])

GO

-- --------------------------------------------------
-- INDEX dbo.tripartitetest1$
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch] ON [dbo].[tripartitetest1$] ([Branch])

GO

-- --------------------------------------------------
-- INDEX dbo.uinfo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_aaa] ON [dbo].[uinfo] ([aaa])

GO

-- --------------------------------------------------
-- INDEX dbo.userlist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_bse_STAT] ON [dbo].[userlist] ([bse_STAT])

GO

-- --------------------------------------------------
-- INDEX dbo.utb_fnomappingstatus
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_party_code] ON [dbo].[utb_fnomappingstatus] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.VBB_dkm
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_CD_AuctionPart] ON [dbo].[VBB_dkm] ([CD_AuctionPart])

GO

-- --------------------------------------------------
-- INDEX dbo.ver6
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[ver6] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.ver6_01082006USERS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Col001] ON [dbo].[ver6_01082006USERS] ([Col001])

GO

-- --------------------------------------------------
-- INDEX dbo.ver6_temp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[ver6_temp] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.ver7
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[ver7] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.ver7_temp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Address1] ON [dbo].[ver7_temp] ([Address1])

GO

-- --------------------------------------------------
-- INDEX dbo.vol1920
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_br] ON [dbo].[vol1920] ([br])

GO

-- --------------------------------------------------
-- INDEX dbo.zuari
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Branch_cd] ON [dbo].[zuari] ([Branch_cd])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.BankBranchMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[BankBranchMaster] ADD CONSTRAINT [PK_BankMaster] PRIMARY KEY ([BankBranchCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.BankMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[BankMaster] ADD CONSTRAINT [PK_BankMaster_1] PRIMARY KEY ([BankCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.BGMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[BGMaster] ADD CONSTRAINT [PK_BGMaster] PRIMARY KEY ([BGCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.DividendDetail
-- --------------------------------------------------
ALTER TABLE [dbo].[DividendDetail] ADD CONSTRAINT [PK_DividendDetail] PRIMARY KEY ([ISIN], [FinancialYearFrom], [FinancialYearTo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.executivecode
-- --------------------------------------------------
ALTER TABLE [dbo].[executivecode] ADD CONSTRAINT [PK_executivecode] PRIMARY KEY ([party_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FDMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[FDMaster] ADD CONSTRAINT [PK_FDMaster] PRIMARY KEY ([FDCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Master] ADD CONSTRAINT [PK_Master] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Admin_Login
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Admin_Login] ADD CONSTRAINT [UniqueUserName] UNIQUE ([Login_Name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_common_login
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_common_login] ADD CONSTRAINT [PK_tbl_common_login] PRIMARY KEY ([cmn_usr_name])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_bse
-- --------------------------------------------------
CREATE procedure [dbo].[accountopen_bse] (@openddate as datetime,@tdate as datetime)              
as              
set nocount on  

            
----------          
----------------End of query completed and not completed.          
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,          
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE           
into #compdate from          
 (select a.*,b.compdate from AngelBSECM.bsedb_ab.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ABLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'    
         
 end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ABLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelBSECM.bsedb_ab.dbo.client1 c1, AngelBSECM.bsedb_ab.dbo.subbrokers sb, AngelBSECM.bsedb_ab.dbo.branch br           
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code           
and party_code IN           
(select distinct party_code=cl_code from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+ ' 23:59:000') order by party_code          
-------------End of query          
          
----------          
          
----------this returns party_code,firsttrading date .ie,all client codes first trading date              
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to (nolock) where company='ABLCM'              
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+' 23:59:000')              
group by party_code              
-----------------------------------              
-------Active from select * from #activefrom select * from  #firsttrading              
select activefrom,party_code=cl_code,introducer into #activefrom from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate + ' 23:59:000'              
              
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code              
-------vv              
              
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate              
select a.*,b.* from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by a.activefrom,a.party_code                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_bse_clmapping
-- --------------------------------------------------
CREATE procedure [dbo].[accountopen_bse_clmapping] (@openddate as datetime,@tdate as datetime)                      
as                      
set nocount on                      
----------                  
----------------End of query completed and not completed.                  
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,                  
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE                   
into #compdate from                  
 (select a.*,b.compdate from AngelBSECM.bsedb_ab.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ABLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'  
    
      
  end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ABLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelBSECM.bsedb_ab.dbo.client1 c1, AngelBSECM.bsedb_ab.dbo.subbrokers sb, AngelBSECM.bsedb_ab.dbo.branch br                   
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code                   
and party_code IN                   
(select distinct party_code=cl_code from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+ ' 23:59:000') order by party_code                  
-------------End of query                  
          
----------                  
                  
----------this returns party_code,firsttrading date .ie,all client codes first trading date                      
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to where company='ABLCM'                      
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+' 23:59:000')                      
group by party_code                      
-----------------------------------                      
-------Active from select * from #activefrom select * from  #firsttrading                      
select activefrom,party_code=cl_code,introducer into #activefrom from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate + ' 23:59:000'                      
                      
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code                      
-------vv                      
                      
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate                      
select a.*,b.branch_cd,b.branch,b.sub_broker,b.sbname,b.Long_name,b.L_address1,b.L_address2,b.L_address3,b.L_City,b.l_zip,b.pan_gir_no,b.COMPDATE         
into #temp from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by branch_cd,sub_broker,a.activefrom,a.party_code                         
--------      
-----now for getting regn no and and other subbrokers related information we       
select  a.*,b.*,status=isnull(c.status,'N'),c.segment from  #temp a      
left outer join AngelBSECM.bsedb_ab.dbo.subbrokers b on a.sub_broker = b.sub_broker      
left outer join intranet.bsedb_ab.dbo.utb_fnomappingstatus c
on  a.party_code collate Latin1_General_CI_AS= c.party_code   
and c.segment='bse'
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_bse_clmapping_csv
-- --------------------------------------------------
CREATE procedure [dbo].[accountopen_bse_clmapping_csv] (@openddate as datetime,@tdate as datetime)                              
as                              
set nocount on                              
----------                          
----------------End of query completed and not completed.                          
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,                          
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE                           
into #compdate from                          
 (select a.*,b.compdate from AngelBSECM.bsedb_ab.dbo.client2 a left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ABLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'  
end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ABLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelBSECM.bsedb_ab.dbo.client1 c1, AngelBSECM.bsedb_ab.dbo.subbrokers sb, AngelBSECM.bsedb_ab.dbo.branch br                          
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code                           
and party_code IN                           
(select distinct party_code=cl_code from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+ ' 23:59:000') order by party_code                          
-------------End of query                          
                          
----------                          
                          
----------this returns party_code,firsttrading date .ie,all client codes first trading date                              
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to where company='ABLCM'                              
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+' 23:59:000')                              
group by party_code                              
-----------------------------------                              
-------Active from select * from #activefrom select * from  #firsttrading                              
select activefrom,party_code=cl_code,introducer into #activefrom from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate + ' 23:59:000'                              
                              
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code                              
-------vv                              
                              
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate                              
select a.*,b.branch_cd,b.branch,b.sub_broker,b.sbname,b.Long_name,b.L_address1,b.L_address2,b.L_address3,b.L_City,b.l_zip,b.pan_gir_no,b.COMPDATE                 
into #temp from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by branch_cd,sub_broker,a.activefrom,a.party_code                                 
--------              
-----now for getting regn no and and other subbrokers related information we               
select a.*,b.reg_no,b.Address1, b.Address2, b.City, b.State, b.Nation, b.Zip, b.Fax, b.Phone1, b.Phone2, b.Registered, b.Main_Sub,b.Email, b.Com_Perc, b.branch_code, b.Contact_Person into #tempfinal from  #temp a              
left outer join AngelBSECM.bsedb_ab.dbo.subbrokers b              
on a.sub_broker = b.sub_broker              
select * from #tempfinal where compdate is not null --and len(reg_no)>1          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_bse_New
-- --------------------------------------------------

-- EXEC accountopen_bse '01/01/2013', '02/01/2013'

CREATE procedure [dbo].[accountopen_bse_New] (@openddate as datetime,@tdate as datetime)              
as              
set nocount on              
----------          
----------------End of query completed and not completed.          
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,          
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE           
into #compdate from          
 (select a.*,b.compdate from AngelBSECM.bsedb_ab.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ABLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'    
         
 end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ABLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelBSECM.bsedb_ab.dbo.client1 c1, AngelBSECM.bsedb_ab.dbo.subbrokers sb, AngelBSECM.bsedb_ab.dbo.branch br           
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code           
and party_code IN           
(select distinct party_code=cl_code from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+ ' 23:59:000') order by party_code          
-------------End of query          
          
----------          
          
----------this returns party_code,firsttrading date .ie,all client codes first trading date              
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to (nolock) where company='ABLCM'              
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+' 23:59:000')              
group by party_code              
-----------------------------------              
-------Active from select * from #activefrom select * from  #firsttrading              
select activefrom,party_code=cl_code,introducer into #activefrom from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate + ' 23:59:000'              
              
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code              
-------vv              
              
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate              
select a.*,b.* from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by a.activefrom,a.party_code                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_bse1
-- --------------------------------------------------

--EXEC accountopen_bse1 '01/01/2013', '02/01/2013'

CREATE procedure [dbo].[accountopen_bse1] (@openddate as varchar(20),@tdate as varchar(20))              
as              
set nocount on              
----------          
----------------End of query completed and not completed.       
  
  
  
SET @openddate= CONVERT(datetime,@openddate,103)  
SET @tdate = CONVERT(datetime , @tdate,103) +' 23:59:000'  
  PRINT  @openddate  
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,          
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE           
into #compdate from          
 (select a.*,b.compdate from AngelBSECM.bsedb_ab.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ABLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'    
         
 end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ABLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelBSECM.bsedb_ab.dbo.client1 c1, AngelBSECM.bsedb_ab.dbo.subbrokers sb, AngelBSECM.bsedb_ab.dbo.branch br           
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code           
and party_code IN           
(select distinct party_code=cl_code from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate and activefrom <= @tdate) order by party_code          
-------------End of query          
          
----------          
          
----------this returns party_code,firsttrading date .ie,all client codes first trading date              
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to (nolock) where company='ABLCM'              
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate and activefrom <= @tdate)              
group by party_code              
-----------------------------------              
-------Active from select * from #activefrom select * from  #firsttrading              
select activefrom,party_code=cl_code,introducer into #activefrom from AngelBSECM.bsedb_Ab.dbo.client5 where activefrom >=@openddate and activefrom <= @tdate              
              
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code              
-------vv              
              
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate              
select a.*,b.* from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by a.activefrom,a.party_code                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_nse
-- --------------------------------------------------
CREATE procedure [dbo].[accountopen_nse] (@openddate as datetime,@tdate as datetime)            
as        
set nocount on            
----------        
----------------End of query completed and not completed.  select * from  #compdate      
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,        
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE         
into #compdate from        
 (select a.*,b.compdate from AngelNseCM.msajag.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ACDLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'
  
 end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ACDLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelNseCM.msajag.dbo.client1 c1,AngelNseCM.msajag.dbo.subbrokers sb,AngelNseCM.msajag.dbo.branch br         
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code         
and party_code IN         
(select distinct party_code=cl_code from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+ ' 23:59:000') order by party_code        
-------------End of query        
        
----------        
        
        
----------this returns party_code,firsttrading date .ie,all client codes first trading date      drop table #firsttrading      
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to where company='ACDLCM'            
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+' 23:59:000')            
group by party_code            
-----------------------------------            
-------Active from select * from #activefrom select * from  #firsttrading      drop table #activefrom drop table #firstfinal      
select activefrom,party_code=cl_code,introducer into #activefrom from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate + ' 23:59:000'            
            
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code            
-------vv            
            
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate            
select a.*,b.* from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by a.activefrom,a.party_code             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_nse_clmapping
-- --------------------------------------------------
CREATE procedure [dbo].[accountopen_nse_clmapping] (@openddate as datetime,@tdate as datetime)                    
as                
set nocount on                    
----------                
----------------End of query completed and not completed.  select * from  #compdate              
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,                
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE                 
into #compdate from                
 (select a.*,b.compdate from AngelNseCM.msajag.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ACDLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'  
    
  end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ACDLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelNseCM.msajag.dbo.client1 c1,AngelNseCM.msajag.dbo.subbrokers sb,AngelNseCM.msajag.dbo.branch br                 
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code                 
and party_code IN                 
(select distinct party_code=cl_code from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+ ' 23:59:000') order by party_code                
-------------End of query                
                
----------                
                
                
----------this returns party_code,firsttrading date .ie,all client codes first trading date      drop table #firsttrading              
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to where company='ACDLCM'                    
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+' 23:59:000')                    
group by party_code                    
-----------------------------------                    
-------Active from select * from #activefrom select * from  #firsttrading      drop table #activefrom drop table #firstfinal              
select activefrom,party_code=cl_code,introducer into #activefrom from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate + ' 23:59:000'                    
                    
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code                    
-------vv                    
                    
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate                    
select a.*,b.branch_cd,b.branch,b.sub_broker,b.sbname,b.Long_name,b.L_address1,b.L_address2,b.L_address3,b.L_City,b.l_zip,b.pan_gir_no,b.COMPDATE         
into #temp from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by branch_cd,sub_broker,a.activefrom,a.party_code                       
-----------------      
-----now for getting regn no and and other subbrokers related information we       
--select * from  #temp a      
--left outer join AngelNseCM.msajag.dbo.subbrokers b      
--on a.sub_broker = b.sub_broker      
--set nocount off                    
select  a.*,b.*,status=isnull(c.status,'N'),c.segment from  #temp a      
left outer join AngelBSECM.bsedb_ab.dbo.subbrokers b on a.sub_broker = b.sub_broker      
left outer join intranet.bsedb_ab.dbo.utb_fnomappingstatus c
on  a.party_code collate Latin1_General_CI_AS= c.party_code   
and c.segment='nse'
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_nse_clmapping_csv
-- --------------------------------------------------
CREATE procedure [dbo].[accountopen_nse_clmapping_csv] (@openddate as datetime,@tdate as datetime)                      
as                  
set nocount on                      
----------                  
----------------End of query completed and not completed.  select * from  #compdate                
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,                  
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE                   
into #compdate from                  
 (select a.*,b.compdate from AngelNseCM.msajag.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ACDLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'  
    
   end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ACDLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelNseCM.msajag.dbo.client1 c1,AngelNseCM.msajag.dbo.subbrokers sb,AngelNseCM.msajag.dbo.branch br                   
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code                   
and party_code IN                   
(select distinct party_code=cl_code from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+ ' 23:59:000') order by party_code                  
-------------End of query                  
                  
----------                  
                  
                  
----------this returns party_code,firsttrading date .ie,all client codes first trading date      drop table #firsttrading                
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to where company='ACDLCM'                      
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate+' 23:59:000')                      
group by party_code                      
-----------------------------------                      
-------Active from select * from #activefrom select * from  #firsttrading      drop table #activefrom drop table #firstfinal                
select activefrom,party_code=cl_code,introducer into #activefrom from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate+' 00:00:000' and activefrom < @tdate + ' 23:59:000'                      
                      
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code                      
-------vv                      
                      
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate                      
select a.*,b.branch_cd,b.branch,b.sub_broker,b.sbname,b.Long_name,b.L_address1,b.L_address2,b.L_address3,b.L_City,b.l_zip,b.pan_gir_no,b.COMPDATE           
into #temp from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by branch_cd,sub_broker,a.activefrom,a.party_code                         
-----------------        
-----now for getting regn no and and other subbrokers related information we         
select a.*,b.reg_no,b.Address1, b.Address2, b.City, b.State, b.Nation, b.Zip, b.Fax, b.Phone1, b.Phone2, b.Registered, b.Main_Sub,b.Email, b.Com_Perc, b.branch_code, b.Contact_Person into #tempfinal from  #temp a        
left outer join     
AngelNseCM.msajag.dbo.subbrokers b on a.sub_broker = b.sub_broker        
select * from #tempfinal    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.accountopen_nse1
-- --------------------------------------------------
--EXEC accountopen_nse1 '08/01/2012','08/01/2012'  
  
  
CREATE   procedure [dbo].[accountopen_nse1]   
(@openddate as varchar(20),  
@tdate as varchar(20))              
as          
set nocount on   
    
  SET @openddate=CONVERT(datetime,@openddate,103)  
  SET @tdate = CONVERT(datetime, @tdate,103)  + ' 23:59:000'        
----------          
----------------End of query completed and not completed.  select * from  #compdate        
select party_code,branch_cd,branch,c1.sub_broker,sbname=name,c1.Long_name,L_address1,L_address2,          
 L_address3,L_City,l_zip,pan_gir_no,COMPDATE           
into #compdate from          
 (select a.*,b.compdate from AngelNseCM.msajag.dbo.client2 a 
 left outer join ( select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode), COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status) 
 from (select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus where cocode='ACDLCM' )x full outer join (select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-'  
    
 end) from ABVSKYCMIS.kyc.dbo.formdetails where cocode='ACDLCM') y on x.pcode=y.pcode and x.cocode=y.cocode ) b on a.party_Code=b.pcode ) c2, AngelNseCM.msajag.dbo.client1 c1,AngelNseCM.msajag.dbo.subbrokers sb,AngelNseCM.msajag.dbo.branch br           
where c2.cl_code=c1.cl_code and c1.sub_broker=sb.sub_broker and c1.branch_cd=br.branch_code           
and party_code IN           
(select distinct party_code=cl_code from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate and activefrom <= @tdate) order by party_code          
-------------End of query          
          
----------          
          
          
----------this returns party_code,firsttrading date .ie,all client codes first trading date      drop table #firsttrading        
select party_code,Firsttrading=min(sauda_date)  into #firsttrading from mis_to where company='ACDLCM'              
and party_code in (select distinct cl_code=cl_code collate Latin1_General_CI_AS from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate and activefrom <= @tdate)              
group by party_code              
-----------------------------------              
-------Active from select * from #activefrom select * from  #firsttrading      drop table #activefrom drop table #firstfinal        
select activefrom,party_code=cl_code,introducer into #activefrom from AngelNseCM.msajag.dbo.client5 where activefrom >=@openddate and activefrom <= @tdate               
              
select a.party_code,a.activefrom,a.introducer,b.firsttrading into #firstfinal from #activefrom a left outer join #firsttrading b on a.party_code collate Latin1_General_CI_AS = b.party_code              
-------vv              
              
----select top 10 * from AngelBSECM.bsedb_ab.dbo.compdate              
select a.*,b.* from #firstfinal a left outer join #compdate b on a.party_code=b.party_code  order by a.activefrom,a.party_code               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AnalysisMis
-- --------------------------------------------------
CREATE Procedure AnalysisMis (@FromDate Varchar(11),@Todate Varchar(11),@Level As Int)
As
If @Level = 1
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Party_code,Party_Name,Family,Family_Name,Terminal_Id,ClientType,TradeType,
Trader,Sub_Broker,Branch_cd,ParticipantCode,/*,Sett_No,Sett_Type,*/Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Party_code,Party_Name,Family,Family_Name,Terminal_Id,ClientType,TradeType,
Trader,Sub_Broker,Branch_cd,ParticipantCode
Order by 
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Party_code,Party_Name,Family,Family_Name,Terminal_Id,ClientType,TradeType,
Trader,Sub_Broker,Branch_cd,ParticipantCode
End
If @Level = 2
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Party_code,Party_Name,Family,Family_Name,
Trader,Sub_Broker,Branch_cd,ParticipantCode,/*,Sett_No,Sett_Type,*/Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Party_code,Party_Name,Family,Family_Name,
Trader,Sub_Broker,Branch_cd,ParticipantCode
Order by 
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Party_code,Party_Name,Family,Family_Name,
Trader,Sub_Broker,Branch_cd,ParticipantCode
End
If @Level = 3
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Family,Family_Name,
Trader,Sub_Broker,Branch_cd,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Family,Family_Name,
Trader,Sub_Broker,Branch_cd
Order by 
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Family,Family_Name,
Trader,Sub_Broker,Branch_cd
End
If @Level = 4
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Trader,Sub_Broker,Branch_cd,ParticipantCode,/*,Sett_No,Sett_Type,*/Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Trader,Sub_Broker,Branch_cd,ParticipantCode
Order by 
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Trader,Sub_Broker,Branch_cd,ParticipantCode
End
If @Level = 5
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sub_Broker,Branch_cd,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sub_Broker,Branch_cd
Order by 
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sub_Broker,Branch_cd
End
If @Level = 6
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Branch_cd,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Branch_cd
Order by 
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Branch_cd
End
If @Level = 7
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date)
Order by 
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date)
End
If @Level = 8
Begin
select ExchangeSegment,Datepart(Year,Sauda_date),TP=Sum(TP),TPA=Sum(TPA),DP=Sum(DP),DPA=Sum(DPA),Sum(TS),TSA=Sum(TSA),Sum(DS),
DSA=Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
ExchangeSegment,Datepart(Year,Sauda_date)
Order by 
ExchangeSegment,Datepart(Year,Sauda_date)
End
If @Level = 9
Begin
select distinct month=datepart(month,sauda_date), year=Datepart(Year,Sauda_date),TP=Sum(TP),TPA=Sum(TPA),DP=Sum(DP),DPA=Sum(DPA),Sum(TS),TSA=Sum(TSA),Sum(DS),
DSA=Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis /* with (index = DateExchangesegment) */
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
Datepart(month,Sauda_date),Datepart(Year,Sauda_date)
Order by 
Datepart(Year,Sauda_date),Datepart(month,Sauda_date)
End

If @Level = 10
Begin
select ExchangeSegment,Sauda_date,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
Exchangesegment,Sauda_date
Order by 
Exchangesegment,Sauda_date
End

If @Level = 11
Begin
select Sauda_date,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)
from level1mis
Where
Sauda_date >= @FromDate
And
Sauda_Date <= @ToDate + ' 23:59:00' 
Group by
Sauda_date
Order by 
Sauda_date
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_mis_bse_rep
-- --------------------------------------------------


CREATE proc [dbo].[angel_mis_bse_rep]  
(  
  
 @fdate as varchar(15),  
 @tdate as varchar(15)  
 )  
as  
/*
Declare @fdate as varchar(15)  
Declare @tdate as varchar(15)  
set @fdate='2007-02-26'  
set @tdate='2007-03-25'  
*/
--EXEC angel_mis_bse_rep '2007-02-26' ,'2007-03-25'  
  
select A.party_code,  
sum(To_trd_Fut) as BSECM_TRD_TO,sum(TO_del_opt) as BSECM_DEL_TO,   
sum(bk_trd_fut) as BSECM_TRD_GROSS, sum(bk_del_opt) as BSECM_DEL_GROSS,
BSECM_NET=(select sum(B.angel_share) from mis.remisior.dbo.BSECM_cli B 
where B.sauda_Date >= @fdate + ' 00:00:00.000' and B.sauda_Date <= @tdate + ' 23:59:59.000'
and A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE)    
into  
#BSECM_SB  
from mis_to A  
where company='ABLCM' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER  
order by PARTY_CODE  


select A.party_code,sum(To_trd_Fut) as NSECM_TRD_TO,  
sum(TO_del_opt) as NSECM_DEL_TO, sum(bk_trd_fut) as NSECM_TRD_GROSS, sum(bk_del_opt) as NSECM_DEL_GROSS,
NSECM_NET=(select sum(B.angel_share) from mis.remisior.dbo.NSECM_cli B 
where B.sauda_Date >= @fdate + ' 00:00:00.000' and B.sauda_Date <= @tdate + ' 23:59:59.000'
and A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE) 
into  
#NSECM_SB  
from mis_to A  
where company='ACDLCM' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER   
order by party_code  
 
-- NSEFO DATA 
select A.party_code,sum(A.turnover) as NSEFO_TO,  
sum(A.brokerage) as NSEFO_GROSS, NSEFO_NET=(select sum(B.angel_share) from mis.remisior.dbo.nsefo_cli B 
where B.sauda_Date >= @fdate + ' 00:00:00.000' and B.sauda_Date <= @tdate + ' 23:59:59.000'
and A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE)
into  
#NSEFO_SB  
from mis_to A  
where company='ACDLFO' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER  
order by party_code  


  
-- MCX DATA 
select party_code,sum(turnover) as MCX_TO,  
sum(brokerage) as MCX_GROSS, MCX_NET=(select sum(B.angel_share) from mis.remisior.dbo.MCDX_cli B 
where B.sauda_Date >= @fdate + ' 00:00:00.000' and B.sauda_Date <= @tdate + ' 23:59:59.000'
and A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS=B.PARTY_CODE )   
into  
#MCX_SB  
from mis_to A   
where company='ACPLMCX' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER  
order by party_code  
  
-- NCDEX DATA
select party_code,sum(turnover) as NCDEX_TO,  
sum(brokerage) as NCDEX_GROSS, NCDEX_NET=(select sum(B.angel_share) from mis.remisior.dbo.NCDX_cli B 
where B.sauda_Date >= @fdate + ' 00:00:00.000' and B.sauda_Date <= @tdate + ' 23:59:59.000'
and A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS =B.PARTY_CODE)      
into  
#NCDEX_SB  
from mis_to A  
where company='ACPLNCDEX' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER    
order by party_code  
  
  /*
drop table #BSEcm_SB  
drop table #NSEcm_SB  
drop table #nseFO_SB  
drop table #MCX_SB  
drop table #NCDEX_SB  

 drop table #TEMP1  
drop table #TEMP2  
drop table #TEMP3  
drop table #TEMP4  

SELECT * FROM #BSECM_SB
SELECT * FROM #NSECM_SB
SELECT * FROM #NSEFO_SB
select * from #NCDEX_SB
select * from #MCX_SB

  
*/  
-- BSE + NSE  
SELECT (CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END) AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS
,B.NSECM_TRD_TO,B.NSECM_DEL_TO,B.NSECM_TRD_GROSS,B.NSECM_DEL_GROSS INTO #TEMP1
FROM #BSECM_SB A FULL OUTER JOIN (SELECT * FROM #NSECM_SB)B ON A.party_code=B.party_code 

-- TEMP1 + FO
SELECT(CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END)AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS,A.NSECM_TRD_TO,A.NSECM_DEL_TO,A.NSECM_TRD_GROSS,A.NSECM_DEL_GROSS
,B.NSEFO_TO,B.NSEFO_GROSS INTO #TEMP2 
FROM #TEMP1 A FULL OUTER JOIN (SELECT * FROM #NSEFO_SB)B ON A.party_code=B.party_code 

-- TEMP2 + MCX
SELECT(CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END)AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS,A.NSECM_TRD_TO,A.NSECM_DEL_TO,A.NSECM_TRD_GROSS,A.NSECM_DEL_GROSS
,A.NSEFO_TO,A.NSEFO_GROSS,
B.MCX_TO,B.MCX_GROSS INTO #TEMP3
 FROM #TEMP2 A
FULL OUTER JOIN (SELECT * FROM #MCX_SB)B ON A.party_code=B.party_code 

-- TEMP3 + NCDEX
SELECT(CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END)AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS,A.NSECM_TRD_TO,A.NSECM_DEL_TO,A.NSECM_TRD_GROSS,A.NSECM_DEL_GROSS
,A.NSEFO_TO,A.NSEFO_GROSS,
A.MCX_TO,A.MCX_GROSS,
B.NCDEX_TO,B.NCDEX_GROSS
 INTO #TEMP4 FROM #TEMP3 A 
FULL OUTER JOIN (SELECT * FROM #NCDEX_SB)B ON A.party_code=B.party_code
ORDER BY A.PARTY_CODE 

SELECT B.BRANCH_CD,B.SUB_BROKER,B.LONG_NAME,A.*,
TOTAL_TO =ISNULL(BSECM_TRD_TO,0.0) + ISNULL(BSECM_DEL_TO,0.0) + ISNULL(NSECM_TRD_TO,0.0)+ ISNULL(NSECM_DEL_TO,0.0) + ISNULL(NSEFO_TO,0.0) + ISNULL(MCX_TO,0.0) + ISNULL(NCDEX_TO,0.0), 
TOTAL_GROSS =ISNULL(BSECM_TRD_GROSS,0.0) + ISNULL(BSECM_DEL_GROSS,0.0) + ISNULL(NSECM_TRD_GROSS,0.0)+ ISNULL(NSECM_DEL_GROSS,0.0) + ISNULL(NSEFO_GROSS,0.0) + ISNULL(MCX_GROSS,0.0) + ISNULL(NCDEX_GROSS,0.0)
FROM #TEMP4 A 
LEFT OUTER JOIN 
RISK.DBO.CLIENT_DETAILS B
ON
A.PARTY_CODE= B.PARTY_CODE
COLLATE SQL_Latin1_General_CP1_CI_AS 
ORDER BY A.PARTY_CODE

/*
--((A.BSECM_TRD_TO + A.BSECM_DEL_TO)+(A.NSECM_TRD_TO +A.NSECM_DEL_TO)+(A.NSEFO_TO+A.MCX_TO+A.NCDEX_TO))
--SELECT TOP 2* FROM MIS_TO

SELECT * FROM RISK.DBO.CLIENT_DETAILS WHERE PARTY_CODE = 'A045'


SELECT A.BRANCH_CD,A.SUB_BROKER,A.PARTY_NAME,B.* FROM #TEMP4 B 
INNER JOIN MIS_TO A
ON A.PARTY_CODE = B.PARTY_CODE
WHERE A.sauda_Date >= @fdate + ' 00:00:00.000' and a.sauda_Date <= @tdate + ' 23:59:59.000'


SELECT DISTINCT PARTY_CODE FROM MIS_TO WHERE 
sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'
ORDER BY PARTY_CODE 


Declare @fdate as varchar(15)  
Declare @tdate as varchar(15)  
set @fdate='2007-02-26'  
set @tdate='2007-03-25'
SELECT A.BRANCH_CD,A.SUB_BROKER,A.PARTY_NAME,B.PARTY_CODE
FROM MIS_TO A 
INNER JOIN 
(SELECT DISTINCT PARTY_CODE FROM MIS_TO WHERE 
sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000') B
ON
A.PARTY_CODE = B.PARTY_CODE
WHERE A.sauda_Date >= @fdate + ' 00:00:00.000' and A.sauda_Date <= @tdate + ' 23:59:59.000'
ORDER BY B.PARTY_CODE




SELECT * FROM MIS_TO WHERE 
sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'
AND
PARTY_CODE='a0005'
ORDER BY PARTY_CODE

Declare @fdate as varchar(15)  
Declare @tdate as varchar(15)  
set @fdate='2007-02-26'  
set @tdate='2007-03-25'



SELECT DISTINCT PARTY_CODE FROM MIS_TO WHERE 
sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000' ORDER BY PARTY_CODE

SELECT DISTINCT PARTY_CODE,BRANCH_CD,SUB_BROKER,PARTY_NAME FROM MIS_TO WHERE 
sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000' ORDER BY PARTY_CODE



 
SELECT BRANCH_CD,SUB_BROKER,PARTY_NAME,PARTY_CODE FROM MIS_TO
WHERE PARTY_CODE = 
(SELECT DISTINCT PARTY_CODE FROM MIS_TO WHERE 
sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000')




*/
RETURN


 /*Declare @fdate as varchar(15)  
Declare @tdate as varchar(15)  
set @fdate='2007-02-26'  
set @tdate='2007-03-25'  

sELECT sum(To_trd_Fut), SUM(to_dEL_OPT) FROM mis_TO where company='ABLCM' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
AND PARTY_CODE = 'm15512'
select * from #BSE_SB WHERE PARTY_CODE LIKE 'M15512%'



  SELECT DISTINCT(pARTY_CODE) FROM mis_TO WHERE
sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000' 

select * from #BSE_SB WHERE PARTY_CODE LIKE 'M15512%'
select * from #ncdex_SB WHERE PARTY_CODE='M15512'
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_mis_Rep
-- --------------------------------------------------


CREATE proc [dbo].[angel_mis_Rep]  
(  
  
 @fdate as varchar(15),  
 @tdate as varchar(15)  
 )  
as  
/*
Declare @fdate as varchar(15)  
Declare @tdate as varchar(15)  
set @fdate='2007-02-26'  
set @tdate='2007-03-25'  
*/
--EXEC angel_mis_rep '2007-02-26' ,'2007-03-25'  
  

--BSECM DATA
select A.party_code,  
sum(To_trd_Fut) as BSECM_TRD_TO,sum(TO_del_opt) as BSECM_DEL_TO,   
sum(bk_trd_fut) as BSECM_TRD_GROSS, sum(bk_del_opt) as BSECM_DEL_GROSS
into  
#BSECM_SB  
from mis_to A (nolock) 
where company='ABLCM' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER  
order by PARTY_CODE  



-- CREATING TEMP BSECM NET TABLE
SELECT PARTY_CODE, BSECM_NET=ISNULL(sum(angel_share),0.0) 
INTO #BSECM_NET
from mis.remisior.dbo.BSECM_cli   
where sauda_Date >= @FDATE and sauda_Date <= @tDATE
GROUP BY PARTY_CODE,SUBBROKCODE

--FINAL BSECM FINAL 
/*
SELECT A.*,B.BSECM_NET  
INTO #BSECM_FINAL FROM
#BSECM_SB A
LEFT OUTER JOIN 
#BSECM_NET B
ON A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE
*/
SELECT A.*,BSECM_TRD_NET = (A.BSECM_TRD_GROSS / (A.BSECM_TRD_GROSS + A.BSECM_DEL_GROSS)) * B.BSECM_NET,
BSECM_DEL_NET = (A.BSECM_DEL_GROSS / (A.BSECM_TRD_GROSS + A.BSECM_DEL_GROSS))* B.BSECM_NET
INTO #BSECM_FINAL FROM
#BSECM_SB A
LEFT OUTER JOIN 
#BSECM_NET B
ON A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE



--NSECM DATA
select A.party_code,sum(To_trd_Fut) as NSECM_TRD_TO,  
sum(TO_del_opt) as NSECM_DEL_TO, sum(bk_trd_fut) as NSECM_TRD_GROSS, sum(bk_del_opt) as NSECM_DEL_GROSS
into  
#NSECM_SB  
from mis_to A (nolock) 
where company='ACDLCM' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER   
order by party_code  


-- CREATING TEMP NSECM NET TABLE
SELECT PARTY_CODE, NSECM_NET=ISNULL(sum(angel_share),0.0) 
INTO #NSECM_NET
from mis.remisior.dbo.NSECM_cli   
where sauda_Date >= @FDATE and sauda_Date <= @tDATE
GROUP BY PARTY_CODE,SUBBROKCODE

--FINAL NSECM DATA 
/*SELECT A.*,B.NSECM_NET  
INTO #NSECM_FINAL FROM
#NSECM_SB A
LEFT OUTER JOIN 
#NSECM_NET B
ON A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE
 */
SELECT A.*,NSECM_TRD_NET = (A.NSECM_TRD_TO / (A.NSECM_TRD_TO + A.NSECM_DEL_TO)) * B.NSECM_NET,
NSECM_DEL_NET = (A.NSECM_DEL_TO / (A.NSECM_TRD_TO + A.NSECM_DEL_TO))* B.NSECM_NET
INTO #NSECM_FINAL FROM
#NSECM_SB A
LEFT OUTER JOIN 
#NSECM_NET B
ON A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE

-- NSEFO DATA 
select A.party_code,sum(A.turnover) as NSEFO_TO,  
sum(A.brokerage) as NSEFO_GROSS
into  
#NSEFO_SB  
from mis_to A  
where company='ACDLFO' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER  
order by party_code  

-- CREATING TEMP NSEFO NET TABLE
SELECT PARTY_CODE, NSEFO_NET=ISNULL(sum(angel_share),0.0) 
INTO #NSEFO_NET
from mis.remisior.dbo.NSEFO_cli   
where sauda_Date >= @FDATE and sauda_Date <= @tDATE
GROUP BY PARTY_CODE,SUBBROKCODE

--FINAL NSEFO DATA 
SELECT A.*,B.NSEFO_NET  
INTO #NSEFO_FINAL FROM
#NSEFO_SB A
LEFT OUTER JOIN 
#NSEFO_NET B
ON A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE

-- CREATING BASIC MCX
select party_code,sum(turnover) as MCX_TO,  
sum(brokerage) as MCX_GROSS
into  
#MCX_SB  
from mis_to A   
where company='ACPLMCX' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER  
order by party_code  

-- CREATING TEMP MCS NET TABLE
SELECT PARTY_CODE, MCX_NET=ISNULL(sum(angel_share),0.0) 
INTO #MCX_NET
from mis.remisior.dbo.MCDX_cli   
where sauda_Date >= @FDATE and sauda_Date <= @tDATE
GROUP BY PARTY_CODE,SUBBROKCODE

--FINAL MCX DATA 
SELECT A.*,B.MCX_NET  
INTO #MCX_FINAL FROM
#MCX_SB A
LEFT OUTER JOIN 
#MCX_NET B
ON A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE


-- CREATING BASIC NCDEX
select party_code,sum(turnover) as NCDEX_TO,  
sum(brokerage) as NCDEX_GROSS      
into  
#NCDEX_SB  
from mis_to A  
where company='ACPLNCDEX' and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'  
group by party_code,SUB_BROKER    
order by party_code  

-- CREATING TEMP NCDEX NET TABLE
SELECT PARTY_CODE, NCDEX_NET=ISNULL(sum(angel_share),0.0) 
INTO #NCDEX_NET
from mis.remisior.dbo.NCDX_cli   
where sauda_Date >= @FDATE and sauda_Date <= @tDATE
GROUP BY PARTY_CODE,SUBBROKCODE

--FINAL NCDEX DATA 
SELECT A.*,B.NCDEX_NET  
INTO #NCDEX_FINAL FROM
#NCDEX_SB A
LEFT OUTER JOIN 
#NCDEX_NET B
ON A.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = B.PARTY_CODE



  /*
DROP TABLE #NSECM_SB
DROP TABLE #NSECM_NET
DROP TABLE #NSECM_FINAL


DROP TABLE #BSECM_SB
DROP TABLE #BSECM_NET
DROP TABLE #BSECM_FINAL

DROP TABLE #NSEFO_SB
DROP TABLE #NSEFO_NET
DROP TABLE #NSEFO_FINAL

DROP TABLE #MCX_NET
DROP TABLE #MCX_SB
DROP TABLE #MCX_FINAL
DROP TABLE #NCDEX_NET
DROP TABLE #NCDEX_SB
DROP TABLE #NCDEX_FINAL

drop table #TEMP1  
drop table #TEMP2  
drop table #TEMP3  
drop table #TEMP4  

SELECT * FROM #BSECM_SB
SELECT * FROM #NSECM_SB
SELECT * FROM #NSEFO_SB
select * from #NCDEX_SB
select * from #MCX_SB

  
*/  
-- BSE + NSE  
SELECT (CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END) AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS, A.BSECM_TRD_NET,A.BSECM_DEL_NET
,B.NSECM_TRD_TO,B.NSECM_DEL_TO,B.NSECM_TRD_GROSS,B.NSECM_DEL_GROSS, B.NSECM_TRD_NET,B.NSECM_DEL_NET INTO #TEMP1
FROM #BSECM_FINAL A FULL OUTER JOIN (SELECT * FROM #NSECM_FINAL)B ON A.party_code=B.party_code 

-- TEMP1 + FO
SELECT(CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END)AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS,A.BSECM_TRD_NET,A.BSECM_DEL_NET,A.NSECM_TRD_TO,A.NSECM_DEL_TO,A.NSECM_TRD_GROSS,A.NSECM_DEL_GROSS,A.NSECM_TRD_NET,A.NSECM_DEL_NET
,B.NSEFO_TO,B.NSEFO_GROSS,B.NSEFO_NET INTO #TEMP2 
FROM #TEMP1 A FULL OUTER JOIN (SELECT * FROM #NSEFO_FINAL)B ON A.party_code=B.party_code 

-- TEMP2 + MCX
SELECT(CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END)AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS,A.BSECM_TRD_NET,A.BSECM_DEL_NET,A.NSECM_TRD_TO,A.NSECM_DEL_TO,A.NSECM_TRD_GROSS,A.NSECM_DEL_GROSS,A.NSECM_TRD_NET,A.NSECM_DEL_NET
,A.NSEFO_TO,A.NSEFO_GROSS,A.NSEFO_NET,
B.MCX_TO,B.MCX_GROSS,B.MCX_NET INTO #TEMP3
 FROM #TEMP2 A
FULL OUTER JOIN (SELECT * FROM #MCX_FINAL)B ON A.party_code=B.party_code 

-- TEMP3 + NCDEX
SELECT(CASE WHEN  A.PARTY_CODE IS NULL THEN B.PARTY_CODE ELSE A.PARTY_CODE END)AS PARTY_CODE,
A.BSECM_TRD_TO,A.BSECM_DEL_TO,A.BSECM_TRD_GROSS,A.BSECM_DEL_GROSS,A.BSECM_TRD_NET,A.BSECM_DEL_NET,A.NSECM_TRD_TO,A.NSECM_DEL_TO,A.NSECM_TRD_GROSS,A.NSECM_DEL_GROSS,A.NSECM_TRD_NET,A.NSECM_DEL_NET
,A.NSEFO_TO,A.NSEFO_GROSS,A.NSEFO_NET,
A.MCX_TO,A.MCX_GROSS,A.MCX_NET,
B.NCDEX_TO,B.NCDEX_GROSS,B.NCDEX_NET
 INTO #TEMP4 FROM #TEMP3 A 
FULL OUTER JOIN (SELECT * FROM #NCDEX_FINAL)B ON A.party_code=B.party_code
ORDER BY A.PARTY_CODE 

SELECT B.BRANCH_CD,B.SUB_BROKER,B.LONG_NAME,A.*,
TOTAL_TO =ISNULL(BSECM_TRD_TO,0.0) + ISNULL(BSECM_DEL_TO,0.0) + ISNULL(NSECM_TRD_TO,0.0)+ ISNULL(NSECM_DEL_TO,0.0) + ISNULL(NSEFO_TO,0.0) + ISNULL(MCX_TO,0.0) + ISNULL(NCDEX_TO,0.0), 
TOTAL_GROSS =ISNULL(BSECM_TRD_GROSS,0.0) + ISNULL(BSECM_DEL_GROSS,0.0) + ISNULL(NSECM_TRD_GROSS,0.0)+ ISNULL(NSECM_DEL_GROSS,0.0) + ISNULL(NSEFO_GROSS,0.0) + ISNULL(MCX_GROSS,0.0) + ISNULL(NCDEX_GROSS,0.0),
TOTAL_NET = ISNULL(BSECM_TRD_NET,0.0)+ISNULL(BSECM_DEL_NET,0.0) + ISNULL(NSECM_TRD_NET,0.0) + ISNULL(NSECM_DEL_NET,0.0)+ ISNULL(NSEFO_NET,0.0) + ISNULL(MCX_NET,0.0) + ISNULL(NCDEX_NET,0.0)
INTO #FINAL
FROM #TEMP4 A 
LEFT OUTER JOIN 
RISK.DBO.CLIENT_DETAILS B
ON
A.PARTY_CODE= B.PARTY_CODE
COLLATE SQL_Latin1_General_CP1_CI_AS 
ORDER BY A.PARTY_CODE

SELECT * FROM #FINAL

/*
declare @str as varchar(8000) 
truncate table report_excel
   
--insert into report_excel   
--select 'branch_Cd'+'|'+'sub_BRoker'+'|'+'long_name'+'|'+'party_Code'+'|'+'BSECM_TRD_TO'+'|'+'BSECM_DEL_TO'+'|'+'BSECM_Trd_Gross'+'|'+'BSECM_DEL_Gross'+'|'+'BSECM_Trd_Net' +'|'+'BSECM_DEL_Net'+'|'+'NSECM_TRD_TO'+'|'+'NSECM_DEL_TO'+'|'+'NSECM_Trd_Gross'+'|'+'NSECM_DEL_Gross'+'|'+'NSECM_Trd_Net' +'|'+'NSECM_DEL_Net' 
--+'|'+'NSEFO_TO'+'|'+'NSEFO_Gross'+'|'+'NSEFO_Net'+'|'+'MCX_TO'+'|'+'MCX_Gross' +'|'+'MCX_Net'+'|'+'NCDEX_TO'+'NCDEX_Gross'+'NCDEX_NET'+'TOTAL_TO'+'TOTAL_GROSS'+'TOTAL_NET'        
--select * from report_excel


set @str = 'insert into report_excel select BRANCH_CD+''|''+SUB_BROKER
+''|''+LONG_NAME+''|''+PARTY_CODE        
 +''|''+isnull(BSECM_TRD_TO,0)        
 +''|''+isnull(BSECM_DEL_TO,0)        
 +''|''+isnull(BSECM_TRD_GROSS,0)        
 +''|''+isnull(BSECM_DEL_GROSS,0)        
 +''|''+isnull(BSECM_TRD_NET,0)        
 +''|''+isnull(BSECM_DEL_NET,0)
 +''|''+isnull(NSECM_TRD_TO,0)        
 +''|''+isnull(NSECM_DEL_TO,0)        
 +''|''+isnull(NSECM_TRD_GROSS,0)        
 +''|''+isnull(NSECM_DEL_GROSS,0)        
 +''|''+isnull(NSECM_TRD_NET,0)        
 +''|''+isnull(NSECM_DEL_NET,0)
 +''|''+isnull(NSEFO_TO,0)        
 +''|''+isnull(NSEFO_GROSS,0)        
 +''|''+isnull(NSEFO_NET,0)        
 +''|''+isnull(MCX_TO,0)        
 +''|''+isnull(MCX_GROSS,0)        
 +''|''+isnull(MCX_NET,0)        
 +''|''+isnull(NCDEX_TO,0)        
 +''|''+isnull(NCDEX_GROSS,0)        
 +''|''+isnull(NCDEX_NET,0)        
 +''|''+isnull(TOTAL_TO,0)        
 +''|''+isnull(TOTAL_GROSS,0)        
 +''|''+isnull(TOTAL_NET,0)        

From #final'-- COLLATE SQL_Latin1_General_CP1_CI_AS '          
    
EXEC (@STR)
*/
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_ROI_REPORT2
-- --------------------------------------------------



CREATE PROC ANGEL_ROI_REPORT2
(
 @fdate as varchar(15),  
 @tdate as varchar(15)  
)
AS

/*
SELECT party_code, 
(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart <> 'EA'  AND auctionpart <> 'CA' 
Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) AS futurestradedvalue, 
(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' Then (((pqty+sqty)*strike_price) + (pqty*prate)+(sqty*srate)) Else 0 End)) AS optionstradedvalue, 
(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') Then (sqty*(strike_price+SRate)) Else 0 End)) AS excercisevalue, 0 AS assignmentvalue, 
(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) AS closeoutvalue, 
(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) + 
(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' ) Then IsNull((prate+strike_Price)*pqty + (srate+strike_price)*sqty,0) Else 0 End))  AS total, 
Sum(pbrokamt + sbrokamt) AS brokerage, Sum(service_tax) AS servicetax, Sum(Ins_chrg) AS Ins_chrg, 
Sum(turn_tax) AS turnovertax, Sum(sebi_tax) AS sebitax, Sum(broker_note) AS stampduty, Sum(Other_Chrg) AS clearingcharges 
into #FOTO1
FROM angelfo.nsefo.dbo.FOBillValan_View_Turnover (nolock)   
WHERE tradetype = 'BT' AND inst_type LIKE '%' 
AND option_type LIKE '%' AND Left(Convert(VarChar,expirydate,109),11) LIKE '%' 
AND symbol LIKE '%' AND  isnull(party_code,'') >= 'A' 
AND  isnull(party_code,'') <= 'ZZZ' AND sauda_date >= @fdate+' 00:00:00' 
AND sauda_date <= @tdate+' 23:59:59' AND 1=1   
GROUP BY party_code

--select * from #foto1
--select * from #file2 order by party_code
--select * from #file1 order by party_code
--select sum(futurestradedvalue),sum(optionstradedvalue) from #FOTO1
--select sum(total) from #FOTO1

update ANGEL_ROI set nsefo_to=b.total from #foto1 b where ANGEL_ROI.party_code=b.party_code collate Latin1_General_CI_AS
*/

select segment,partY_code,brok_earned=sum(brok_Earned),angel_Share=sum(angel_Share)
into #file2
from mis.remisior.dbo.comb_Cli where 
sauda_DAte >=@fdate
and sauda_Date <=@tdate
group by segment,partY_code



update ANGEL_ROI set NSEFO_net=b.angel_share from 
(select * from #file2 where segment='ACDLFO') b 
where ANGEL_ROI.party_code=b.partY_code COLLATE Latin1_General_CI_AS

update ANGEL_ROI set MCX_Net=b.angel_share from 
(select * from #file2 where segment='ACPLMCX') b 
where ANGEL_ROI.party_code=b.partY_code COLLATE Latin1_General_CI_AS

update ANGEL_ROI set ncdex_Net=b.angel_share from 
(select * from #file2 where segment='ACPLNCDX') b 
where ANGEL_ROI.party_code=b.partY_code COLLATE Latin1_General_CI_AS

/*
update #File1 set BSECM_BrkTrdNet=b.angel_share from 
(select * from #file2 where segment='ABLCM') b 
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS

update #File1 set NSECM_BrkTrdNet=b.angel_share from 
(select * from #file2 where segment='ACDLCM') b 
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS
*/

/*
SELECT PARTY_CODE,BROK=(BSECM_BRKDEL+BSECM_BRKTRD),BSECM_BRKDEL, BSECM_BRKTRD,BSECM_BrkTrdNet,
bsedel=(BSECM_BrkTrdNet*((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD)))/100
--,DELPERCENT=((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD))
FROM #FILE1 WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0
*/
/*
UPDATE #FILE1 SET BSECM_BrkDelNet=(BSECM_BrkTrdNet*((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD)))/100
FROM #FILE1 WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0

UPDATE #FILE1 SET BSECM_BrktrdNet=BSECM_BrkTrdNet-BSECM_BrkDelNet WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0


UPDATE #FILE1 SET NSECM_BrkDelNet=(NSECM_BrkTrdNet*((NSECM_BRKDEL*100)/(NSECM_BRKDEL+NSECM_BRKTRD)))/100
FROM #FILE1 WHERE (NSECM_BRKDEL+NSECM_BRKTRD) > 0

UPDATE #FILE1 SET NSECM_BrktrdNet=NSECM_BrkTrdNet-NSECM_BrkDelNet WHERE (NSECM_BRKDEL+NSECM_BRKTRD) > 0

update #file1 
set branch=b.branch_cd,subbrokcode=b.sub_BRoker,client_name=b.long_name 
from risk.dbo.client_details b (nolock)
where #file1.party_code=b.party_code COLLATE Latin1_General_CI_AS


UPDATE #FILE1 SET TOTAL_TO = BSECM_TODel + BSECM_TOTrd + NSECM_TODel + NSECM_TOTrd + NSEFO_TO+MCDX_TO + NCDX_TO,
TOTAL_GROSS = BSECM_BrkDel+BSECM_BrkTrd+NSECM_BrkDel+NSECM_BrkTrd+NSEFO_Brk+MCDX_Brk+NCDX_Brk,
TOTAL_NET = BSECM_BrkDelNet+BSECM_BrkTrdNet+NSECM_BrkDelNet+NSECM_BrkTrdNet+NSEFO_net+MCX_Net


SELECT * FROM #FILE1 ORDER BY PARTY_CODE
select party_code,bsecm_toTrd,bsecm_toDel,bsecm_brkTrd,Bsecm_brkDel,bsecm_brktrdnet,bsecm_brkdelnet from #file1 order by party_code
*/

SELECT * FROM ANGEL_ROI ORDER BY PARTY_CODE
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_rm_cfo
-- --------------------------------------------------




CREATE procedure [dbo].[angel_roi_rm_cfo]
(
@broker as varchar(15),
@fdate as varchar(20),
@tdate as varchar(20)
)
as
/*
Declare @broker as varchar(15)
Declare @fdate as varchar(20)
Declare @tdate as varchar(20)
set @broker='SAG'
set @fdate='2007-02-26'
set @tdate='2007-03-25'
*/
--EXEC angel_roi_rm_cfo 'SAG','2007-02-26','2007-03-25'



select gp='',company='BSE' ,
round(sum(b.Brok_earned),2) as 'Total Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS' ,
avgt='',  avgB=''
from mis.remisior.dbo.bsecm_cli b 
where b.subbrokcode=@broker --and b.segment='ABLCM'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

UNION ALL

select gp='',company='NSE' ,
 round(sum(b.Brok_earned),2) as 'Total Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS' ,
avgt='',  avgB=''
from mis.remisior.dbo.nsecm_cli b 
where b.subbrokcode=@broker --and b.segment='ACDLCM'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

UNION ALL


select gp='',company='F&O' ,
round(sum(b.Brok_earned),2) as 'Total Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS' ,
avgt='',  avgB=''
from mis.remisior.dbo.nsefo_cli b 
where b.subbrokcode=@broker --and b.segment='ACDLFO'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'


return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_rm_cfo1
-- --------------------------------------------------
CREATE procedure [dbo].[angel_roi_rm_cfo1]  
(  
@broker as varchar(15),  
@fdate as varchar(20),  
@tdate as varchar(20)  
)  
as  
  
Declare @totBrokBSE as float  
Declare @RsBrokBSE as float  
Declare @AsBrokBSE as float  
  
Declare @totBrokNSE as float  
Declare @RsBrokNSE as float  
Declare @AsBrokNSE as float  
  
Declare @totBrokFO as float  
Declare @RsBrokFO as float  
Declare @AsBrokFO as float  
  
/*  
set @broker='KLSH'  
set @fdate='2007-02-26'  
set @tdate='2007-03-25'  
*/  
  
select @totBrokBSE = round(sum(b.Brok_earned),2) ,   
    @RsBrokBSE = round(sum(b.remi_share),2) ,  
    @AsBrokBSE = round(sum(b.Angel_share),2)   
from mis.remisior.dbo.bsecm_cli b   
where b.subbrokcode=@broker   
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'  
  
  
select @totBrokNSE = round(sum(b.Brok_earned),2) ,   
    @RsBrokNSE = round(sum(b.remi_share),2) ,  
    @AsBrokNSE = round(sum(b.Angel_share),2)   
from mis.remisior.dbo.nsecm_cli b   
where b.subbrokcode=@broker   
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'  
  
select @totBrokFO = round(sum(b.Brok_earned),2) ,   
    @RsBrokFO = round(sum(b.remi_share),2) ,  
    @AsBrokFO = round(sum(b.Angel_share),2)   
from mis.remisior.dbo.nsefo_cli b   
where b.subbrokcode=@broker   
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'  
  
  
CREATE TABLE #resultset1  
(Grp varchar(3),Segment varchar(5),  
Total__Brokerage numeric,Remi_Share numeric,  
Angel_Share numeric,X_RS numeric,  
X_AS numeric,Avg_Dly_Turnover numeric,Avg_Brokerage numeric)  
  
  
insert into #resultset1 values('','BSE',@totBrokBSE,@RsBrokBSE,@AsBrokBSE,round(((@RsBrokBSE / @totBrokBSE)*100),2),round(((@AsBrokBSE / @totBrokBSE)*100),2),0,0)  
insert into #resultset1 values('','NSE',@totBrokNSE,@RsBrokNSE,@AsBrokNSE,round(((@RsBrokNSE / @totBrokNSE)*100),2),round(((@AsBrokNSE / @totBrokNSE)*100),2),0,0)  
insert into #resultset1 values('','F&O',@totBrokFO,@RsBrokFO,@AsBrokFO,round(((@RsBrokFO / @totBrokFO)*100),2),round(((@AsBrokFO / @totBrokFO)*100),2),0,0)  
  
  
  
select * from #resultset1  
/*  
Drop table temp_bse  
drop table temp_nse  
drop table  temp_fo  
drop table #resultset1  
*/  
  
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_rm_cfo2
-- --------------------------------------------------




CREATE procedure [dbo].[angel_roi_rm_cfo2]
(
@broker as varchar(15),
@fdate as varchar(20),
@tdate as varchar(20)
)
as
/*
Declare @broker as varchar(15)
Declare @fdate as varchar(20)
Declare @tdate as varchar(20)
set @broker='SAG'
set @fdate='2007-02-26'
set @tdate='2007-03-25'
*/
--EXEC angel_roi_rm_cfo2 'SAG','2007-02-26','2007-03-25'



select gp='',company='BSE' ,
round(sum(b.Brok_earned),2) as 'Total__Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS' ,
avgt='',  avgB=''
from mis.remisior.dbo.bsecm_cli b 
where b.subbrokcode=@broker --and b.segment='ABLCM'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

UNION ALL

select gp='',company='NSE' ,
 round(sum(b.Brok_earned),2) as 'Total__Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS' ,
avgt='',  avgB=''
from mis.remisior.dbo.nsecm_cli b 
where b.subbrokcode=@broker --and b.segment='ACDLCM'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

UNION ALL


select gp='',company='F&O' ,
round(sum(b.Brok_earned),2) as 'Total__Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS' ,
avgt='',  avgB=''
from mis.remisior.dbo.nsefo_cli b 
where b.subbrokcode=@broker --and b.segment='ACDLFO'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

UNION ALL 

select Grp='' ,Segment='MCX' ,
round(sum(b.Brok_earned),2) as 'Total__Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS',
avgt='',  avgB='' 
from mis.remisior.dbo.mcdx_cli b 
where b.subbrokcode=@broker and b.segment='ACPLMCX'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

UNION ALL

select Grp='',Segment='NCDEX' ,
round(sum(b.Brok_earned),2) as 'Total__Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS',
avgt='',  avgB=''
from mis.remisior.dbo.ncdx_cli b 
where b.subbrokcode=@broker and b.segment='ACPLNCDX'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'



return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_rm_com
-- --------------------------------------------------

CREATE procedure [dbo].[angel_roi_rm_com]
(
@broker as varchar(15),
@fdate as varchar(20),
@tdate as varchar(20)
)
as
/*
Declare @broker as varchar(15)
Declare @fdate as varchar(20)
Declare @tdate as varchar(20)
set @broker='KLSH'
set @fdate='2007-12-26'
set @tdate='2007-11-25'
*/


select Grp='' ,Segment='MCX' ,
round(sum(b.Brok_earned),2) as 'Total Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS',
avgt='',  avgB='' 
from mis.remisior.dbo.mcdx_cli b 
where b.subbrokcode=@broker and b.segment='ACPLMCX'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

UNION ALL

select Grp='',Segment='NCDEX' ,
round(sum(b.Brok_earned),2) as 'Total Brokerage', 
round(sum(b.remi_share),2) as 'Remi Share',
round(sum(b.Angel_share),2) as 'Angel Share', 
round(((sum(b.remi_share) / sum(b.brok_earned)) * 100),2) as '% RS',
 round(((sum(b.angel_share) / sum(b.brok_earned)) * 100),2) as '% AS',
avgt='',  avgB=''
from mis.remisior.dbo.ncdx_cli b 
where b.subbrokcode=@broker and b.segment='ACPLNCDX'
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_rm_com1
-- --------------------------------------------------

CREATE procedure [dbo].[angel_roi_rm_com1]
(
@broker as varchar(15),
@fdate as varchar(20),
@tdate as varchar(20)
)
as

Declare @totBrokMCX as float
Declare @RsBrokMCX as float
Declare @AsBrokMCX as float

Declare @totBrokNCDEX as float
Declare @RsBrokNCDEX as float
Declare @AsBrokNCDEX as float

/*
set @broker='KLSH'
set @fdate='2007-02-26'
set @tdate='2007-03-25'
exec angel_roi_rm_com1 'sag','2007-02-26','2007-08-25'
*/


select @totBrokMCX = round(sum(b.Brok_earned),2) , 
	   @RsBrokMCX = round(sum(b.remi_share),2) ,
	   @AsBrokMCX = round(sum(b.Angel_share),2) 
from mis.remisior.dbo.mcdx_cli b 
where b.subbrokcode=@broker 
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'


select @totBrokNCDEX = round(sum(b.Brok_earned),2) , 
	   @RsBrokNCDEX = round(sum(b.remi_share),2) ,
	   @AsBrokNCDEX = round(sum(b.Angel_share),2) 
from mis.remisior.dbo.ncdx_cli b 
where b.subbrokcode=@broker 
and b.sauda_Date >= @fdate + ' 00:00:00.000' and b.sauda_Date <= @tdate + ' 23:59:59.000'

CREATE TABLE #resultset1
(Grp varchar(3),Segment varchar(5),
totalBrok numeric,remiShare numeric,
angelShare numeric,pRS numeric,
pAS numeric,avgt numeric,avgb numeric)


insert into #resultset1 values('','MCX',@totBrokMCX,@RsBrokMCX,@AsBrokMCX,round(((@RsBrokMCX / @totBrokMCX)*100),2),round(((@AsBrokMCX / @totBrokMCX)*100),2),0,0)
insert into #resultset1 values('','NCDEX',@totBrokNCDEX,@RsBrokNCDEX,@AsBrokNCDEX,round(((@RsBrokNCDEX / @totBrokNCDEX)*100),2),round(((@AsBrokNCDEX / @totBrokNCDEX)*100),2),0,0)

select * from #resultset1
/*
drop table #resultset1
*/

return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_sb_cfo
-- --------------------------------------------------

     
CREATE procedure [dbo].[angel_roi_sb_cfo]    
(    
@broker as varchar(15),    
@fdate as varchar(20),    
@tdate as varchar(20)    
)    
as    
/*    
Declare @broker as varchar(15)    
Declare @fdate as varchar(20)    
Declare @tdate as varchar(20)    
set @broker='KLSH'    
set @fdate='Feb 26 2006'    
set @tdate='Mar 25 2006'  
--EXEC angel_roi_SB_cfo 'SAG','2007-02-26','2007-03-25'  
*/  
  
select Grp='',Segment='BSE' , round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',    
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',    
round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total Brokerage'    
from mis_to_sb where sub_broker = @broker and company='ABLCM'    
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'    
    
UNION ALL    
    
select Grp='',Segment='NSE',round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',    
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',    
round(sum(BK_Trd_Fut),2)  as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total Brokerage'    
from mis_to_sb where sub_broker = @broker and company='ACDLCM'    
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'    
    
UNION ALL    
    
select Grp='',Segment='F&O',round(sum(TO_Trd_Fut),2) as 'Volume', --round(sum(turnover),2) as 'Volume',   
round(sum(TO_Trd_Fut),2) as 'Trading', Delivery='0', --round(sum(TO_Del_Opt),2) as 'Delivery',    
--round((((sum(TO_Trd_Fut) + sum(TO_Del_Opt)) / sum(turnover)) * 100),2) as '% Trading'  
 '100' as '% Trading', '0' as '% Delivery',         --round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',    
round(sum(Brokerage),2) as 'Brokerage(Trading)',   
--round(sum(BK_Trd_Fut) + sum(BK_Del_Opt) ,2) as 'Brokerage(Trading)',  
'0' as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total Brokerage'    
--round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)',round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total Brokerage'    
from mis_to_sb where sub_broker = @broker and company='ACDLFO'    
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'    
    

--select count(distinct sauda_date) from mis_to_sb where sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'   
/*  
select * from mis_to_sb where sub_broker='KLSH' and company='ACDLFO'   
and sauda_Date >= '2007-02-26 00:00:00.000' and sauda_Date <= '2007-03-25 23:59:59.000'  
*/  
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_sb_cfo1
-- --------------------------------------------------


     
CREATE procedure [dbo].[angel_roi_sb_cfo1]    
(    
@broker as varchar(15),    
@fdate as varchar(20),    
@tdate as varchar(20)    
)    
as    
/*    
Declare @broker as varchar(15)    
Declare @fdate as varchar(20)    
Declare @tdate as varchar(20)    
set @broker='KLSH'    
set @fdate='Feb 26 2006'    
set @tdate='Mar 25 2006'  
--EXEC angel_roi_SB_cfo 'SAG','2007-02-26','2007-03-25'  
*/  
  
select Grp='',Segment='BSE' , round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',    
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',    
round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total_Brokerage'    
from mis_to_sb where sub_broker = @broker and company='ABLCM'    
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'    
    
UNION ALL    
    
select Grp='',Segment='NSE',round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',    
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',    
round(sum(BK_Trd_Fut),2)  as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total_Brokerage'    
from mis_to_sb where sub_broker = @broker and company='ACDLCM'    
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'    
    
UNION ALL    
    
select Grp='',Segment='F&O',round(sum(TO_Trd_Fut),2) as 'Volume', --round(sum(turnover),2) as 'Volume',   
round(sum(TO_Trd_Fut),2) as 'Trading', Delivery='0', --round(sum(TO_Del_Opt),2) as 'Delivery',    
--round((((sum(TO_Trd_Fut) + sum(TO_Del_Opt)) / sum(turnover)) * 100),2) as '% Trading'  
 '100' as '% Trading', '0' as '% Delivery',         --round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',    
round(sum(Brokerage),2) as 'Brokerage(Trading)',   
--round(sum(BK_Trd_Fut) + sum(BK_Del_Opt) ,2) as 'Brokerage(Trading)',  
'0' as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total_Brokerage'    
--round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)',round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total Brokerage'    
from mis_to_sb where sub_broker = @broker and company='ACDLFO'    
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'    
    
UNION ALL

select gp='', company='MCX',round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',
round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total_Brokerage'
from mis_to_sb where sub_broker = @broker and company='ACPLMCX'
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 00:00:00.000'

UNION ALL

select gp='', company='NCDEX',round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',
round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total_Brokerage'
from mis_to_sb where sub_broker = @broker and company='ACPLNCDEX'
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 00:00:00.000'

--select count(distinct sauda_date) from mis_to_sb where sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 23:59:59.000'   
/*  
select * from mis_to_sb where sub_broker='KLSH' and company='ACDLFO'   
and sauda_Date >= '2007-02-26 00:00:00.000' and sauda_Date <= '2007-03-25 23:59:59.000'  
*/  
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_roi_sb_com
-- --------------------------------------------------

CREATE procedure angel_roi_sb_com
(
@broker as varchar(15),
@fdate as varchar(20),
@tdate as varchar(20)
)
as
/*
Declare @broker as varchar(15)
Declare @fdate as varchar(20)
Declare @tdate as varchar(20)
set @broker='SAG'
set @fdate='2007-02-26'
set @tdate='2007-03-25'
*/

select gp='', company='MCX',round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',
round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total Brokerage'
from mis_to_sb where sub_broker = @broker and company='ACPLMCX'
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 00:00:00.000'

UNION ALL

select gp='', company='NCDEX',round(sum(turnover),2) as 'Volume', round(sum(TO_Trd_Fut),2) as 'Trading', round(sum(TO_Del_Opt),2) as 'Delivery',
round(((sum(TO_Trd_Fut) / sum(turnover)) * 100),2) as '% Trading', round(((sum(TO_Del_Opt) / sum(turnover)) * 100),2) as '% Delivery',
round(sum(BK_Trd_Fut),2) as 'Brokerage(Trading)', round(sum(BK_Del_Opt),2) as 'Brokerage(Delivery)', round(sum(Brokerage),2) as 'Total Brokerage'
from mis_to_sb where sub_broker = @broker and company='ACPLNCDEX'
and sauda_Date >= @fdate + ' 00:00:00.000' and sauda_Date <= @tdate + ' 00:00:00.000'

return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AngelMISQuarterlyReports
-- --------------------------------------------------




CREATE     PROCEDURE AngelMISQuarterlyReports	
	@StatusId Varchar(10),
	@StatusName Varchar(15),
	@ReportLevel Varchar(15),
	@SegmentGroup varchar(50),
	@FromBranch varchar(15),
	@ToBranch varchar(15),
	@FromSubbroker varchar(15),
	@ToSubbroker varchar(15),
	@FromTrader varchar(15),
	@ToTrader varchar(15),
	@FromClient varchar(15),
	@ToClient varchar(15),
        @FromDate varchar(15),
	@ToDate varchar(15),
	@Rounding Bigint = 1
AS

/*---------------------------------------------------------------------------------------------------------------------------------------
	EXEC AngelMISQuarterlyReports 'BROKER','','BROKER','''BSECM''','','','','','','','','','Apr  1 2001','Dec 29 2005',1
	EXEC AngelMISQuarterlyReports 'BROKER','','BROKER','''BSECM'',''NSECM''','','','','','','','','','Apr  1 2001','Mar 31 2004',1
	EXEC AngelMISQuarterlyReports 'BROKER','','BROKER','''BSECM'',''NSECM'',''NSEFO'',''NCX'',''MCX''','','','','','','','','','Apr  1 2001','Mar 31 2004',1
-----------------------------------------------------------------------------------------------------------------------------------------*/

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  

--------------------------------- Global Variables Declaration ----------------------------------

	DECLARE
		@@FYearSelect VARCHAR(100),
		@@Q1Select VARCHAR(5000),
		@@Q2Select VARCHAR(5000),
		@@Q3Select VARCHAR(5000),
		@@Q4Select VARCHAR(5000),
		@@ThreeWeekSelect VARCHAR(3000),

		@@OuterFrom VARCHAR(3000),
		@@InnerFrom VARCHAR(4000),

		@@LevelSelect VARCHAR(5000),
		@@From VARCHAR(1000),
		@@Where VARCHAR(1000),
		@@GroupBy VARCHAR(500),
		@@OrderBy VARCHAR(500),

		@@From_Year Int,
		@@To_Year Int,
		@@From_Month int,
		@@To_Month int,
		@@Q1Days Int,
		@@Q2Days Int,
		@@Q3Days Int,
		@@Q4Days Int,
		@@YearDiff Int,
		@@CurrentWeek Int,
		@@ThreeWeekDays Int,
		@@PrevDate DateTime,
		@@ThreeweekTurnover Money,
		@@ThreeweekBrokerage Money,
		@@ThreeweekAvgTurnover Money,
		@@ThreeweekAvgBrokerage Money

---------------------------------- Local Variables Declaration ----------------------------------
	DECLARE 
		@VolumeSelect VARCHAR(1000),
		@TurnOverSelect VARCHAR(1000),
		@BrokerageSelect VARCHAR(1000),
		@BranchWhere VARCHAR(500),
		@SubbrokerWhere VARCHAR(500),
		@TraderWhere VARCHAR(500),
		@ClientWhere VARCHAR(500),
		@DateWhere VARCHAR(500)

----------------------------------Broker Branch Login Constraints--------------------------------

	SET  NOCOUNT ON

	IF @StatusId = 'Broker'
	BEGIN
        	IF @FromBranch = '' SET @FromBranch = 'A'
         	IF @ToBranch = ''  SET @ToBranch = 'ZZZZZZ'

        	IF @FromSubbroker = '' SET @FromSubbroker = 'A'
	        IF @ToSubbroker = '' SET @ToSubbroker = 'ZZZZZZ'

        	IF @FromTrader = '' SET @FromTrader = 'A'
         	IF @ToTrader = '' SET @ToTrader = 'ZZZZZZZ'

        	IF @FromClient = '' SET @FromClient = 'A'
	        IF @ToClient = '' SET @ToClient = 'ZZZZZZ'
	END

	IF @StatusId = 'Branch'
	BEGIN
     		IF @ReportLevel = 'Broker' SET @ReportLevel = 'Branch'

		SET @FromBranch = @StatusName
     		SET @ToBranch = @StatusName

        	IF @FromSubbroker = '' SET @FromSubbroker = 'A'
	        IF @ToSubbroker = '' SET @ToSubbroker = 'ZZZZZZ'

        	IF @FromTrader = '' SET @FromTrader = 'A'
         	IF @ToTrader = '' SET @ToTrader = 'ZZZZZZZ'

        	IF @FromClient = '' SET @FromClient = 'A'
	        IF @ToClient = '' SET @ToClient = 'ZZZZZZ'
	END

	ELSE IF @StatusId = 'Subbroker'
	BEGIN
     		IF @ReportLevel = 'Broker' OR @ReportLevel = 'Branch'
 			SET @ReportLevel = 'Subbroker'
	
		SET @FromSubbroker = @StatusName
		SET @ToSubbroker = @StatusName

        	IF @FromTrader = '' SET @FromTrader = 'A'
         	IF @ToTrader = '' SET @ToTrader = 'ZZZZZZZ'

        	IF @FromClient = '' SET @FromClient = 'A'
	        IF @ToClient = '' SET @ToClient = 'ZZZZZZ'
	END

	ELSE IF @StatusId = 'Trader'
	BEGIN
     		IF @ReportLevel = 'Broker' OR @ReportLevel = 'Branch' OR @ReportLevel = 'Subbroker'
 			SET @ReportLevel = 'Trader'
	
        	SET @FromTrader = @StatusName
         	SET @ToTrader = @StatusName

        	IF @FromClient = '' SET @FromClient = 'A'
	        IF @ToClient = '' SET @ToClient = 'ZZZZZZ'
	END
	ELSE IF @StatusId = 'Client'
	BEGIN
     		IF @ReportLevel = 'Broker' OR @ReportLevel = 'Branch' 
		OR @ReportLevel = 'Subbroker' OR @ReportLevel = 'Trader'
 			SET @ReportLevel = 'Client'

		SET @FromClient = @StatusName
	        SET @ToClient = @StatusName
	END

	IF @Rounding = 0 SET @Rounding = 1
-------------------------------------------------------------------------------------------------
	SET @@FYearSelect = 'DYear = FInyear,'

	SET @@Q1Select = 'Q1Days,
            		 Q1Turnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            		 Q1AvgTurnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q1Days = 0 Then 1 Else Q1Days End) ,
            		 Q1Brokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            		 Q1AvgBrokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q1Days = 0 Then 1 Else Q1Days End),'

	SET @@Q2Select = 'Q2Days,
            		 Q2Turnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA) ) Else 0 End) ,
            		 Q2AvgTurnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q2Days = 0 Then 1 Else Q2Days End) ,
            		 Q2Brokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            		 Q2AvgBrokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q2Days = 0 Then 1 Else Q2Days End),'

	SET @@Q3Select = 'Q3Days,            
            		 Q3Turnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA)) Else 0 End),
            		 Q3AvgTurnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End)/(Case When Q3Days = 0 Then 1 Else Q3Days End) ,
            		 Q3Brokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            		 Q3AvgBrokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q3Days = 0 Then 1 Else Q3Days End),'

	SET @@Q4Select = 'Q4Days,
            		 Q4Turnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            		 Q4AvgTurnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q4Days = 0 Then 1 Else Q4Days End) ,
            		 Q4Brokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            		 Q4AvgBrokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q4Days = 0 Then 1 Else Q4Days End),'

	SET @@OuterFrom = 'Level1Mis TOuter,( Select FinYear1 = Finyear,
	                  Q1Days = Sum(Case When FinMonth between 4 And 6 Then NoDays Else 0 End),
                      	  Q2Days = Sum(Case When FinMonth between 7 And 9 Then NoDays Else 0 End),
                      	  Q3Days = Sum(Case When FinMonth between 10 And 12 Then NoDays Else 0 End),
                      	  Q4Days = Sum(Case When FinMonth between 1 And 3 Then NoDays Else 0 End)'

	SET @@InnerFrom = 'Select 
				Finyear ,FinMonth ,NoDays = Count(Distinct Sauda_date)
                       	   From 
				Level1Mis TInner
                       	   Where
				Sauda_date >=''' + @FromDate + ''' And Sauda_date <=''' + @Todate + '''
                       		And TInner.Branch_cd >=''' + @FromBranch + ''' And TInner.Branch_cd <=''' + @ToBranch + '''
                       		And Sub_broker >=''' + @FromSubBroker + ''' And Sub_broker <=''' + @ToSubBroker + '''
                       		And Party_code >=''' + @FromClient + ''' And Party_code <=''' + @ToClient + '''
                       		And Exchangesegment in(' + @SegmentGroup + ') ' + '
                       	   Group By FinYEar,FinMonth ) CountDays ' + 'Group By FinYear'

	SET @@Where = 'Sauda_date >=''' + @FromDate + ''' And Sauda_date <=''' + @Todate + '''
                      And TOuter.Branch_cd >=''' + @FromBranch + ''' And TOuter.Branch_cd <=''' + @ToBranch + '''
                      And Sub_broker >=''' + @FromSubBroker + ''' And Sub_broker <=''' + @ToSubBroker + '''
                      And Party_code >=''' + @FromClient + ''' And Party_code <=''' + @ToClient + '''
                      And Exchangesegment in(' + @SegmentGroup + ') ' + '
		      And  FinYear = FinYear1 '     

	SET @@GroupBy = 'Finyear,Q1Days,Q2Days,Q3Days,Q4Days '
	SET @@OrderBy = 'Finyear'

-------------------------------------------------------------------------------------------------------------------------
	SET @@From_Year  = DatePart(Year,@Fromdate)
        SET @@To_Year  = DatePart(Year,@Todate)
        SET @@YearDiff = @@To_Year - @@From_Year
        SET @@From_Month  = DatePart(Month,@Fromdate)
        SET @@To_Month  = DatePart(Month,@Todate)
     
        SET @@Prevdate = DateAdd(Day , -21,@Todate)

        Select 
        	@@Threeweekdays = count(Distinct Sauda_date)
     	From 
		Level1Mis 
	Where
     		Sauda_date >= @@Prevdate And Sauda_date <= @Todate
		And Branch_cd >= @FromBranch And Branch_cd <= @ToBranch
     		And Sub_broker >= @FromSubBroker And Sub_broker <= @ToSubBroker
     		And Party_code >= @FromClient And Party_code <= @ToClient
		And Exchangesegment in('NSECM','BSECM','NSEFO','MCX','NCX')  

     	Select
		@@ThreeweekTurnover = Sum (TPA + TSA + DPA + DSA),
		@@ThreeweekAvgTurnover = Sum (TPA + TSA + DPA + DSA) /(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End), 
                @@ThreeweekBrokerage = Sum(TPB + TSB + DPB + DSB)  ,
 		@@ThreeweekAvgBrokerage = Sum(TPB + TSB + DPB + DSB)/(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End)  
	From
		Level1Mis 
     	Where
     		Sauda_date >= @@Prevdate And Sauda_date <= @Todate
     		

	Select
		@@Threeweekdays = count(Distinct Sauda_date)
     	From 
		Level1Mis 
     	Where
     		Sauda_date >= @@Prevdate And Sauda_date <= @Todate
     		And Branch_cd >= @FromBranch And Branch_cd <= @ToBranch
     		And Sub_broker >= @FromSubBroker And Sub_broker <= @ToSubBroker
     		And Party_code >= @FromClient And Party_code <= @ToClient
     		And Exchangesegment In(@SegmentGroup)

	SET @@ThreeWeekSelect = 'ThreeweekTo = ' + CONVERT(VARCHAR,@@ThreeweekTurnover) + ',ThreeweekAvgTo = ' + CONVERT(VARCHAR,@@ThreeweekAvgTurnover) + ',ThreeWeekBrok = ' + CONVERT(VARCHAR,@@Threeweekbrokerage) + ', ThreeWeekAvgBrok = ' + CONVERT(VARCHAR,@@ThreeweekAvgbrokerage) + ' '

------------------------- Final Execution Of Dynamically Generated Query ------------------------
	PRINT 'Query: SELECT ' + @@FYearSelect + @@Q1Select + @@Q2Select + @@Q3Select + @@Q4Select + @@ThreeWeekSelect +
	      'FROM ' + @@OuterFrom + 'FROM (' + @@InnerFrom + ')Qdays ' +
	      'WHERE ' + @@Where +
	      'GROUP BY ' + @@GroupBy +
	      'ORDER BY ' + @@OrderBy	

	EXEC('SELECT ' + @@FYearSelect + @@Q1Select + @@Q2Select + @@Q3Select + @@Q4Select + @@ThreeWeekSelect +
	     'FROM ' + @@OuterFrom + 'FROM (' + @@InnerFrom + ')Qdays ' +
	     'WHERE ' + @@Where +
	     'GROUP BY ' + @@GroupBy +
	     'ORDER BY ' + @@OrderBy)
-------------------------------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AngelMisReports
-- --------------------------------------------------
CREATE PROCEDURE  AngelMisReports
@StatusId Varchar(15),
@StatusName Varchar(25),
@FromBranch Varchar(12),
@ToBranch Varchar(12),
@FromSubbroker Varchar(12),
@ToSubbroker Varchar(12),
@FromParty Varchar(15),
@ToParty Varchar(15),
@FromDate Varchar(11),
@ToDate Varchar(11),
@Market  Varchar(40),
@ReportType Varchar(255), 
@GroupBy Varchar(255),
@OrderBy Varchar(255)

AS

Declare
@@Sql Varchar(4000),
@TurnOverSelect1 Varchar(500),
@BrokerageSelect1 Varchar(500),
@TurnOverSelect2 Varchar(500),
@BrokerageSelect2 Varchar(500),
@@From_Year Int,
@@To_Year Int,
@@From_Month int,
@@To_Month int,
@@Q1Days Int,
@@Q2Days Int,
@@Q3Days Int,
@@Q4Days Int,
@@YearDiff Int,
@@CurrentWeek Int,
@@ThreeWeekDays Int,
@@PrevDate DateTime,
@@ThreeweekTurnover Money,
@@ThreeweekBrokerage Money,
@@ThreeweekAvgTurnover Money,
@@ThreeweekAvgBrokerage Money


Begin
     If @StatusId = 'Broker'  
     Begin
          If @Frombranch = ''
             Set @FromBranch = 'A'
          If @Tobranch = ''
             Set @ToBranch = 'ZZZZZZZZ'
 
         If @FromSubbroker = ''
             Set @FromSubbroker = 'A'
          If @ToSubbroker = ''
             Set @ToSubbroker = 'ZZZZZZZZ'
 
         If @FromParty = ''
             Set @FromParty = 'A'
          If @ToParty = ''
             Set @ToParty = 'ZZZZZZZZ'
     End
     If @StatusId = 'Branch'  
     Begin
          Set @Frombranch = @StatusName
     
          Set @Tobranch = @StatusName
  
          If @FromSubbroker = ''
             Set @FromSubbroker = 'A'

          If @ToSubbroker = ''
             Set @ToSubbroker = 'ZZZZZZZZ'
 
          If @FromParty = ''
             Set @FromParty = 'A'
          If @ToParty = ''
             Set @ToParty = 'ZZZZZZZZ'
     End

        
     SET @@From_Year  = DatePart(Year,@Fromdate)
     SET @@To_Year  = DatePart(Year,@Todate)
     SET @@YearDiff = @@To_Year - @@From_Year
     SET @@From_Month  = DatePart(Month,@Fromdate)
     SET @@To_Month  = DatePart(Month,@Todate)
     
     Select @@Prevdate = DateAdd(Day , -21,@Todate)
     --Select @@PrevDate
     --Select @FromBranch
     --Select @ToBranch
     --Select @FromSuBbroker
     --Select @ToSubbroker
     --Select @FromParty
     --Select @ToPArty

     Select @@Threeweekdays = count(Distinct Sauda_date)
     From Level1Mis 
     Where
     Sauda_date >= @@Prevdate
     And
     Sauda_date <= @Todate
     And
     Branch_cd >= @FromBranch
     And
     Branch_cd <= @ToBranch
     And
     Sub_broker >= @FromSubBroker
     And
     Sub_broker <= @ToSubBroker
     And
     Party_code >= @FromParty
     And
     Party_code <= @ToParty
     And Exchangesegment in('NSECM','BSECM','NSEFO','MCX','NCX')  

     --Select @@Threeweekdays

     --Select @MArket

     Select @@ThreeweekTurnover = Sum (TPA + TSA + DPA + DSA),@@ThreeweekAvgTurnover = Sum (TPA + TSA + DPA + DSA) /(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End), @@ThreeweekBrokerage = Sum((TPB + TSB + DPB + DSB))  , @@ThreeweekAvgBrokerage = Sum((TPB + TSB + DPB + DSB))/(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End)  
     From Level1Mis 
     Where
     Sauda_date >= @@Prevdate
     And
     Sauda_date <= @Todate
     Select @@Threeweekdays = count(Distinct Sauda_date)
     From Level1Mis 
     Where
     Sauda_date >= @@Prevdate
     And
     Sauda_date <= @Todate
     And
     Branch_cd >= @FromBranch
     And
     Branch_cd <= @ToBranch
     And
     Sub_broker >= @FromSubBroker
     And
     Sub_broker <= @ToSubBroker
     And
     Party_code >= @FromParty
     And
     Party_code <= @ToParty
     And Exchangesegment in(@MArket)


     --Select @@ThreeweekTurnover ,@@ThreeweekTurnover, @@ThreeweekBrokerage, @@ThreeweekAvgBrokerage  

     Select DYear = Finyear, Q1Days,
            Q1Turnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q1AvgTurnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q1Days = 0 Then 1 Else Q1Days End) ,
            Q1Brokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q1AvgBrokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q1Days = 0 Then 1 Else Q1Days End),
            Q2Days,
            Q2Turnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q2AvgTurnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q2Days = 0 Then 1 Else Q2Days End) ,
            Q2Brokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q2AvgBrokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q2Days = 0 Then 1 Else Q2Days End),
            Q3Days,            
            Q3Turnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA)) Else 0 End),
            Q3AvgTurnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End)/(Case When Q3Days = 0 Then 1 Else Q3Days End) ,
            Q3Brokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q3AvgBrokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q3Days = 0 Then 1 Else Q3Days End),
            Q4Days,
            Q4Turnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q4AvgTurnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q4Days = 0 Then 1 Else Q4Days End) ,
            Q4Brokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q4AvgBrokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q4Days = 0 Then 1 Else Q4Days End),
            ThreeweekTo = @@ThreeweekTurnover,ThreweekAvgTo = @@ThreeweekAvgTurnover, ThreeweekBrok = @@Threeweekbrokerage, ThreeweekAvgBrok = @@ThreeweekAvgbrokerage
            From Level1Mis With (Index(ExchangeDate)),( Select FinYear1 = Finyear,
                      Q1Days = Sum(Case When FinMonth between 4 And 6 Then NoDays Else 0 End),
                      Q2Days = Sum(Case When FinMonth between 7 And 9 Then NoDays Else 0 End),
                      Q3Days = Sum(Case When FinMonth between 10 And 12 Then NoDays Else 0 End),
                      Q4Days = Sum(Case When FinMonth between 1 And 3 Then NoDays Else 0 End)
                      From  
                     ( Select Finyear ,FinMonth ,NoDays = Count(Distinct Sauda_date)
                       From Level1Mis  
                       Where Sauda_date >= @FromDate
                       And
                       Sauda_date <= @Todate
                       And
                       Branch_cd >= @FromBranch
                       And
                       Branch_cd <= @ToBranch
                       And
                       Sub_broker >= @FromSubBroker
                       And
                       Sub_broker <= @ToSubBroker
                       And
                       Party_code >= @FromParty
                       And
                       Party_code <= @ToParty
                       --And Exchangesegment in(@MArket)
                       And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
                       Group By FinYEar,FinMonth ) CountDays
                       Group By FinYear 
                     )QDays
     Where 
     Sauda_date >= @FromDate
     And
     Sauda_date <= @Todate
     And
     FinYear = FinYear1      
     And
     Branch_cd >= @FromBranch
     And
     Branch_cd <= @ToBranch
     And
     Sub_broker >= @FromSubBroker
     And
     Sub_broker <= @ToSubBroker
     And
     Party_code >= @FromParty
     And
     Party_code <= @ToParty
     And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
     Group By Finyear,Q1Days,Q2Days,Q3Days,Q4Days
     Order By Finyear
--Select * from level6fyearmis
--EXEC AngelMisReports 'BROKER','','','','Apr  1 2001','Dec 31 2005','','',''

--select Top 10 * from level1mis where Finyear = '3009'
--Exec AngelMisReports 'Broker','BBG','','','','','','','APR  1 2001','DEC  8 2005','''NSECM'',''BSECM'',''NSEFO'',''MCX'',''NCX''','','',''
--Table 'Level1Mis'. Scan count 40, logical reads 1591122, physical reads 42134, read-ahead reads 3314.
--Table 'Level1Mis'. Scan count 40, logical reads 1591138, physical reads 12136, read-ahead reads 2418.

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AngelMisReportsBranch
-- --------------------------------------------------
CREATE  PROCEDURE  AngelMisReportsBranch
@StatusId Varchar(15),
@StatusName Varchar(25),
@FromBranch Varchar(12),
@ToBranch Varchar(12),
@FromSubbroker Varchar(12),
@ToSubbroker Varchar(12),
@FromParty Varchar(15),
@ToParty Varchar(15),
@FromDate Varchar(11),
@ToDate Varchar(11),
@Market  Varchar(40),
@ReportType Varchar(255), 
@GroupBy Varchar(255),
@OrderBy Varchar(255)

AS

Declare
@@Sql Varchar(4000),
@TurnOverSelect1 Varchar(500),
@BrokerageSelect1 Varchar(500),
@TurnOverSelect2 Varchar(500),
@BrokerageSelect2 Varchar(500),
@@From_Year Int,
@@To_Year Int,
@@From_Month int,
@@To_Month int,
@@Q1Days Int,
@@Q2Days Int,
@@Q3Days Int,
@@Q4Days Int,
@@YearDiff Int,
@@CurrentWeek Int,
@@ThreeWeekDays Int,
@@PrevDate DateTime,
@@ThreeweekTurnover Money,
@@ThreeweekBrokerage Money,
@@ThreeweekAvgTurnover Money,
@@ThreeweekAvgBrokerage Money


Begin
     If @StatusId = 'Broker'  
     Begin
          If @Frombranch = ''
             Set @FromBranch = 'A'
          If @Tobranch = ''
             Set @ToBranch = 'ZZZZZZZZ'
 
         If @FromSubbroker = ''
             Set @FromSubbroker = 'A'
          If @ToSubbroker = ''
             Set @ToSubbroker = 'ZZZZZZZZ'
 
         If @FromParty = ''
             Set @FromParty = 'A'
          If @ToParty = ''
             Set @ToParty = 'ZZZZZZZZ'
     End
     If @StatusId = 'Branch'  
     Begin
          Set @Frombranch = @StatusName
     
          Set @Tobranch = @StatusName
  
          If @FromSubbroker = ''
             Set @FromSubbroker = 'A'

          If @ToSubbroker = ''
             Set @ToSubbroker = 'ZZZZZZZZ'
 
          If @FromParty = ''
             Set @FromParty = 'A'
          If @ToParty = ''
             Set @ToParty = 'ZZZZZZZZ'
     End

        
     SET @@From_Year  = DatePart(Year,@Fromdate)
     SET @@To_Year  = DatePart(Year,@Todate)
     SET @@YearDiff = @@To_Year - @@From_Year
     SET @@From_Month  = DatePart(Month,@Fromdate)
     SET @@To_Month  = DatePart(Month,@Todate)
     Set @Todate = @Todate +' 23:59'
     Select @@Prevdate = DateAdd(Day , -21,@Todate)
     --Select @@PrevDate
     --Select @FromBranch
     --Select @ToBranch
     --Select @FromSuBbroker
     --Select @ToSubbroker
     --Select @FromParty
     --Select @ToPArty

     Select @@Threeweekdays = count(Distinct Sauda_date)
     From Level1Mis 
     Where
     Sauda_date >= @@Prevdate
     And
     Sauda_date <= @Todate
     And
     Branch_cd >= @FromBranch
     And
     Branch_cd <= @ToBranch
     And
     Sub_broker >= @FromSubBroker
     And
     Sub_broker <= @ToSubBroker
     And
     Party_code >= @FromParty
     And
     Party_code <= @ToParty
     And Exchangesegment in('NSECM','BSECM','NSEFO','MCX','NCX')  

     Select @@Threeweekdays

     --Select @MArket

Select DYear = Finyear, Q1Days,A.Branch_Cd,A.ExchangeSegment,
            Q1Turnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q1AvgTurnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q1Days = 0 Then 1 Else Q1Days End) ,
            Q1Brokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q1AvgBrokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q1Days = 0 Then 1 Else Q1Days End),
            Q2Days,
            Q2Turnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q2AvgTurnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q2Days = 0 Then 1 Else Q2Days End) ,
            Q2Brokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q2AvgBrokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q2Days = 0 Then 1 Else Q2Days End),
            Q3Days,            
            Q3Turnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA)) Else 0 End),
            Q3AvgTurnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End)/(Case When Q3Days = 0 Then 1 Else Q3Days End) ,
            Q3Brokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q3AvgBrokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q3Days = 0 Then 1 Else Q3Days End),
            Q4Days,
            Q4Turnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q4AvgTurnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q4Days = 0 Then 1 Else Q4Days End) ,
            Q4Brokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q4AvgBrokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q4Days = 0 Then 1 Else Q4Days End)
            
            From Level1Mis A With (index(sdate)), ( Select FinYear1 = Finyear,CountDays.Branch_CD,Exchangesegment,
                      Q1Days = Sum(Case When FinMonth between 4 And 6 Then NoDays Else 0 End),
                      Q2Days = Sum(Case When FinMonth between 7 And 9 Then NoDays Else 0 End),
                      Q3Days = Sum(Case When FinMonth between 10 And 12 Then NoDays Else 0 End),
                      Q4Days = Sum(Case When FinMonth between 1 And 3 Then NoDays Else 0 End)
                      From  
                     ( Select B.Branch_CD,Exchangesegment,Finyear ,FinMonth ,NoDays = Count(Distinct Sauda_date)
                       From Level1Mis B  
                       Where Sauda_date >= @FromDate
                       And
                       Sauda_date <= @Todate
                       And
                       B.Branch_cd >= 'A' ----@FromBranch 
                       And
                       B.Branch_cd <= 'ZZZZZZZ'--@ToBranch
                       And
                       Sub_broker >= 'A'    ---@FromSubbroker
                       And
                       Sub_broker <= 'ZZZZZZZZ'   --@ToSubBroker
                       And
                       Party_code >= 'A'    ---@FromParty
                       And
                       Party_code <= 'ZZZZZZZZ'   --@ToParty
                       --And Exchangesegment in(@MArket)
                       And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
                       Group By FinYEar,FinMonth,B.Branch_CD,Exchangesegment ) CountDays
                       Group By FinYear,CountDays.Branch_CD,Exchangesegment 
                     )QDays    Where
                     Qdays.Branch_cd = A.Branch_Cd  
                     And         
                        FinYear = FinYear1  
                     And
                     QDays.Exchangesegment = A.Exchangesegment        
                     And
     A.Branch_cd >= 'a' -------@FromBranch
     And
     A.Branch_cd <= 'ZZZZZZ'   --@Tobranch
     And
     Sub_broker >= 'A'   --@FromSubBroker
     And
     Sub_broker <= 'ZZZZZZ'   --@ToSubBroker
     And
     Party_code >= 'A' ---@FromParty
     And
     Party_code <= 'ZZZZ'  --@ToParty
     And
     Sauda_date >= @FromDate
     And
     Sauda_date <= @ToDate
     And a.Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
     Group By Finyear,A.Branch_CD,Q1Days,Q2Days,Q3Days,Q4Days,a.Exchangesegment
     Order By Finyear,A.Branch_CD


--Exec AngelMisReportsBranch 'Broker','BBG','A','H','','','','','APR  1 2004','MAR 31 2005','''NSECM'',''BSECM'',''NSEFO'',''MCX'',''NCX''','','',''

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AngelMisReportsBranch_2Rs
-- --------------------------------------------------



CREATE  PROCEDURE  AngelMisReportsBranch_2Rs
@StatusId Varchar(15),
@StatusName Varchar(25),
@FromBranch Varchar(12),
@ToBranch Varchar(12),
@FromSubbroker Varchar(12),
@ToSubbroker Varchar(12),
@FromParty Varchar(15),
@ToParty Varchar(15),
@FromDate Varchar(11),
@ToDate Varchar(11),
@Market  Varchar(40),
@ReportType Varchar(255), 
@GroupBy Varchar(255),
@OrderBy Varchar(255)

AS

	Declare
		@@Sql Varchar(4000),
		@TurnOverSelect1 Varchar(500),
		@BrokerageSelect1 Varchar(500),
		@TurnOverSelect2 Varchar(500),
		@BrokerageSelect2 Varchar(500),
		@@From_Year Int,
		@@To_Year Int,
		@@From_Month int,
		@@To_Month int,
		@@Q1Days Int,
		@@Q2Days Int,
		@@Q3Days Int,
		@@Q4Days Int,
		@@YearDiff Int,
		@@CurrentWeek Int,
		@@ThreeWeekDays Int,
		@@PrevDate DateTime,
		@@ThreeweekTurnover Money,
		@@ThreeweekBrokerage Money,
		@@ThreeweekAvgTurnover Money,
		@@ThreeweekAvgBrokerage Money


	If @StatusId = 'Broker'  
     	Begin
        	If @Frombranch = '' Set @FromBranch = 'A'
          	If @Tobranch = '' Set @ToBranch = 'ZZZZZZZZ'
 
         	If @FromSubbroker = '' Set @FromSubbroker = 'A'
          	If @ToSubbroker = '' Set @ToSubbroker = 'ZZZZZZZZ'
 
         	If @FromParty = '' Set @FromParty = 'A'
	     	If @ToParty = '' Set @ToParty = 'ZZZZZZZZ'
     	End
     	
	If @StatusId = 'Branch'  
     	Begin
          	Set @Frombranch = @StatusName
               	Set @Tobranch = @StatusName
  
  		If @FromSubbroker = '' Set @FromSubbroker = 'A'
	        If @ToSubbroker = '' Set @ToSubbroker = 'ZZZZZZZZ'
 
	        If @FromParty = '' Set @FromParty = 'A'
          	If @ToParty = '' Set @ToParty = 'ZZZZZZZZ'
     	End

        
	SET @@From_Year  = DatePart(Year,@Fromdate)
     	SET @@To_Year  = DatePart(Year,@Todate)
     	SET @@YearDiff = @@To_Year - @@From_Year
     	SET @@From_Month  = DatePart(Month,@Fromdate)
     	SET @@To_Month  = DatePart(Month,@Todate)
     	SET @@Prevdate = DateAdd(Day , -21,@Todate)

     	SELECT 
		@@Threeweekdays = count(Distinct Sauda_date)
	From 
		Level1Mis 
     	Where
     		Sauda_date >= @@Prevdate And Sauda_date <= @Todate
     		And Branch_cd >= @FromBranch And Branch_cd <= @ToBranch
     		And Sub_broker >= @FromSubBroker And Sub_broker <= @ToSubBroker
     		And Party_code >= @FromParty And Party_code <= @ToParty
     		And Exchangesegment in('NSECM','BSECM','NSEFO','MCX','NCX')  


    	Select
		DYear = Finyear,
		A.Branch_Cd,
		Q1Days,
            	Q1Turnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            	Q1AvgTurnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q1Days = 0 Then 1 Else Q1Days End) ,
            	Q1Brokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            	Q1AvgBrokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q1Days = 0 Then 1 Else Q1Days End),
            	Q2Days,
            	Q2Turnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA) ) Else 0 End) ,
            	Q2AvgTurnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q2Days = 0 Then 1 Else Q2Days End) ,
            	Q2Brokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            	Q2AvgBrokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q2Days = 0 Then 1 Else Q2Days End),
            	Q3Days,            
            	Q3Turnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA)) Else 0 End),
            	Q3AvgTurnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End)/(Case When Q3Days = 0 Then 1 Else Q3Days End) ,
            	Q3Brokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            	Q3AvgBrokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q3Days = 0 Then 1 Else Q3Days End),
            	Q4Days,
            	Q4Turnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            	Q4AvgTurnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q4Days = 0 Then 1 Else Q4Days End) ,
            	Q4Brokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            	Q4AvgBrokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q4Days = 0 Then 1 Else Q4Days End)

        From
		Level1Mis A,
		(Select 
			FinYear1 = Finyear,
			CountDays.Branch_CD,
                      	Q1Days = Sum(Case When FinMonth between 4 And 6 Then NoDays Else 0 End),
                      	Q2Days = Sum(Case When FinMonth between 7 And 9 Then NoDays Else 0 End),
                      	Q3Days = Sum(Case When FinMonth between 10 And 12 Then NoDays Else 0 End),
                      	Q4Days = Sum(Case When FinMonth between 1 And 3 Then NoDays Else 0 End)
                 From  
                 	(Select
				B.Branch_CD,Finyear ,FinMonth ,NoDays = Count(Distinct Sauda_date)
                       	 From 
				Level1Mis B  
                       	 Where 
				Sauda_date >= @FromDate	And Sauda_date <= @Todate
                       		And B.Branch_cd >= @FromBranch And B.Branch_cd <= @ToBranch
                       		And Sub_broker >= @FromSubBroker And Sub_broker <= @ToSubBroker
                       		And Party_code >= @FromParty And Party_code <= @ToParty
                       		And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
                       	 Group By 
				FinYEar,FinMonth,B.Branch_CD
		 	 )CountDays
         	 Group By 
			FinYear,CountDays.Branch_CD 
                 )QDays                    
        Where 
         	Sauda_date >= @FromDate And Sauda_date <= @Todate
                And Qdays.Branch_cd = A.Branch_Cd And FinYear = FinYear1      
		And A.Branch_cd >= @FromBranch And A.Branch_cd <= @ToBranch
     		And Sub_broker >= @FromSubBroker And Sub_broker <= @ToSubBroker
     		And Party_code >= @FromParty And Party_code <= @ToParty
     		And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
     	Group By
		Finyear,A.Branch_CD,Q1Days,Q2Days,Q3Days,Q4Days
     	Order By 
		Finyear,A.Branch_CD

---------------------------------------------------------------------------------
	Select 
		Branch_cd,
		ThreeweekTurnover = Sum (TPA + TSA + DPA + DSA),
	        ThreeweekAvgTurnover = Sum (TPA + TSA + DPA + DSA) /(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End), 
                ThreeweekBrokerage = Sum((TPB + TSB + DPB + DSB))  , 
                ThreeweekAvgBrokerage = Sum((TPB + TSB + DPB + DSB))/(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End)  
        From 
		Level1Mis
        Where
                Sauda_date >= @@Prevdate And Sauda_date <= @Todate
		And Branch_cd >= @FromBranch And Branch_cd <= @ToBranch
     		And Sub_broker >= @FromSubBroker And Sub_broker <= @ToSubBroker
     		And Party_code >= @FromParty And Party_code <= @ToParty
                And Exchangesegment in('NSECM','BSECM','NSEFO','MCX','NCX')  
        Group By 
		Branch_Cd,FinYear,FinMonth

/*
	Exec AngelMisReportsBranch_2Rs 'Broker','BBG','A','H','','','','','APR  1 2004','MAR 31 2005','''NSECM'',''BSECM'',''NSEFO'',''MCX'',''NCX''','','',''
	Exec AngelMisReportsBranch 'Broker','BBG','A','H','','','','','APR  1 2004','MAR 31 2005','''NSECM'',''BSECM'',''NSEFO'',''MCX'',''NCX''','','',''

	622381199.1000        38898824.9437         328276.2000           20517.2625
	622381199.1000        38898824.9437         328276.2000           20517.2625

	951979.9000           59498.7437            1682.5000             105.1562
	951979.9000           59498.7437            1682.5000             105.1562

	2194087142.1895       137130446.3868        1100533.0725          68783.3170
	2194087142.1895       137130446.3868        1100533.0725          68783.3170

	14990718.6900         936919.9181           25881.1000            1617.5687
	14990718.6900         936919.9181           25881.1000            1617.5687


*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AngelNseClientPayinShortage
-- --------------------------------------------------


CREATE PROCEDURE  AngelNseClientPayinShortage
@StatusId Varchar(15),
@StatusName Varchar(25),
@RorV Varchar(2),
@FromParty Varchar(15),
@ToParty Varchar(15),
@Partycode Varchar(20),
@ProcId Integer
AS

Set Transaction isolation level read uncommitted

Declare 
@@Sett_noD1 Varchar(10),
@@Sett_noD2 Varchar(10),
@@Sett_noC1 Varchar(10),
@@Sett_noC2 Varchar(10),
@@Sett_noD3 Varchar(10),
@@Sett_noC3 Varchar(10),

@@Yesterday varchar(11),
@@CurrentSett_no Integer,
@@MfDate As DateTime
Declare @FromBranch Varchar(25)
Declare @ToBranch Varchar(25)

If @StatusId = 'Broker' 
Begin
         Set @FromBranch = 'A'
         Set @ToBranch = 'ZZZZZZZZZ'
End

If @StatusId = 'BRANCH' 
Begin
         Set @FromBranch = @StatusName
         Set @ToBranch = @StatusName
End

If @FromParty = ''
   Set @FromParty = 'A'

If @ToParty = ''
   Set @ToParty = 'ZZZZZZZZ'

--select @@MfDate= Max(mfdate) from  Angeldemat.msajag.dbo.MdClosing
Select @@MfDate = Left(Convert (Varchar,Max(mfdate),109),11) from  Angeldemat.msajag.dbo.MdClosing
Select @@CurrentSett_no = Sett_no  from sett_mst
Where
Start_date = Left(Convert(Varchar,GetDate(),109),11) + ' 00:00:00'
And 
Sett_type = 'N'

--Select  @@CurrentSett_no

If @@Currentsett_no Is Null
Begin
Select Top 1  @@CurrentSett_no = Sett_no from Angeldemat.msajag.dbo.sett_mst where start_date < Left(Convert(Varchar,GetDate(),109),11) + ' 00:00:00'
And Sett_type = 'N' and sett_no like '2%'
Order by Sett_no Desc
End

--Select @@Currentsett_no

Select @@Sett_noD1 = @@CurrentSett_no -1
Select @@Sett_noD2 = @@CurrentSett_no - 2
--Select @@Sett_noD3 = @@CurrentSett_no - 2



--Select @@Sett_noD1
--Select @@Sett_noD2


Select @@CurrentSett_no = Sett_no  from Angeldemat.msajag.dbo.sett_mst
Where
Start_date = Left(Convert(Varchar,GetDate(),109),11) + ' 00:00:00'
And 
Sett_type = 'W'


Select @@Sett_noC1 = @@CurrentSett_no -1
Select @@Sett_noC2 = @@CurrentSett_no - 2
--Select @@Sett_noC3 = @@CurrentSett_no - 2

Select @@YesterDay = Left(Convert(Varchar,Start_date,109),11)  --+ ' 00:00:00'
From Angeldemat.msajag.dbo.Sett_mst Where Sett_no = @@Sett_noD2
And Sett_type = 'N'

If @RorV = 'R'
Begin
	select d.sett_no,d.sett_type,d.party_code,c1.short_name,d.Scrip_cd,d.Series,d.inout,d.Qty,
	RecQty = (Case When D.Sett_Type ='W' Then 
	(Case When InOut ='I' Then Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)) Else 0 End)
	Else Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)) End),
	GivenQty = (Case When D.Sett_Type ='W' Then 
	(Case When InOut ='O' Then Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)) Else 0 End)
	Else Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)) End),H.Cls
	from Angeldemat.msajag.dbo.client1 c1,Angeldemat.msajag.dbo.client2 c2, Angeldemat.msajag.dbo.MdClosing H ,Angeldemat.msajag.dbo.deliveryclt d Left Outer Join Angeldemat.msajag.dbo.DelTrans De
	On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Scrip_CD = De.Scrip_CD
	And De.Party_Code = D.Party_Code And De.Filler2 = 1 And De.Series = D.Series ) 
	where  d.party_code = c2.party_code and c1.cl_code =c2.cl_code
	and d.sett_no in ( @@Sett_noD1, @@Sett_noD2, @@Sett_noC1, @@Sett_noC2)
              and d.sett_type in ('N','W')
              --and d.party_code = @partycode
              And H.Scrip = D.Scrip_cd 
              And H.Series = D.Series
              And mfdate = @@MfDate 
And C1.Branch_cd >= @FromBranch
               And C1.Branch_cd <= @ToBranch
               And C2.Party_code >= @FromParty
               And C2.Party_code <= @ToParty
 	group by d.sett_no,d.sett_type,d.scrip_cd,d.series,c1.short_name,d.party_code,d.inout,D.Qty,H.Cls
	Union All
	select d.sett_no,d.sett_type,d.party_code,c1.short_name,d.Scrip_cd,d.Series,inout='I',Qty=0,
	RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),
	GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),H.Cls
	from Angeldemat.msajag.dbo.client1 c1,Angeldemat.msajag.dbo.client2 c2,Angeldemat.msajag.dbo.MdClosing H ,Angeldemat.msajag.dbo.DelTrans D
	where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code
	and d.sett_no in( @@Sett_noD1, @@Sett_noD2, @@Sett_noC1, @@Sett_noC2)
              and d.sett_type in ('N','W')
              -- and d.party_code = @partycode 
              And Filler2 = 1
	And d.Party_code Not In ( Select Party_Code From Angeldemat.msajag.dbo.DeliveryClt De Where De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Scrip_CD = De.Scrip_CD
	And De.Party_Code = D.Party_Code And De.Series = D.Series ) 
        And H.Scrip = D.Scrip_cd 
        And H.Series = D.Series
        And mfdate = @@MfDate 
              And C1.Branch_cd >= @FromBranch
               And C1.Branch_cd <= @ToBranch
               And C2.Party_code >= @FromParty
               And C2.Party_code <= @ToParty 
	group by d.sett_no,d.sett_type,d.scrip_cd,d.series,c1.short_name,d.party_code ,H.Cls
	Order By d.sett_no,d.sett_type desc,d.scrip_cd,d.series
End

If @RorV = 'V'
Begin
    Update AngelClientSummary Set NsePayinShortage = PayinShortage , QStatus = '15' --BSePayinShortage Updated
     From 
     ( 
 Select  Party_code,PayinShortage = IsNull (Sum(Rate  * (Qty - RecQty) ),0) From 
     (  Select d.sett_no,d.sett_type,d.party_code,c1.short_name,d.Scrip_cd,d.Series,d.inout,d.Qty,
	RecQty = (Case When D.Sett_Type ='W' Then 
	(Case When InOut ='I' Then Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)) Else 0 End)
	Else Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)) End),
	GivenQty = (Case When D.Sett_Type ='W' Then 
	(Case When InOut ='O' Then Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)) Else 0 End)
	Else Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)) End),Rate = H.Cls
	from Angeldemat.msajag.dbo.client1 c1,Angeldemat.msajag.dbo.client2 c2, Angeldemat.msajag.dbo.MdClosing H ,Angeldemat.msajag.dbo.deliveryclt d Left Outer Join Angeldemat.msajag.dbo.DelTrans De
	On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Scrip_CD = De.Scrip_CD
	And De.Party_Code = D.Party_Code And De.Filler2 = 1 And De.Series = D.Series ) 
	where  d.party_code = c2.party_code and c1.cl_code =c2.cl_code
              and d.sett_no in( @@Sett_noD1, @@Sett_noD2, @@Sett_noC1, @@Sett_noC2)
              and d.sett_type in ('N','W')
               --and d.party_code = @partycode
        And H.Scrip = D.Scrip_cd 
        And H.Series = D.Series
        And mfdate = @@MfDate 
         And C1.Branch_cd >= @FromBranch
               And C1.Branch_cd <= @ToBranch
               And C2.Party_code >= @FromParty
               And C2.Party_code <= @ToParty
	group by d.sett_no,d.sett_type,d.scrip_cd,d.series,c1.short_name,d.party_code,d.inout,D.Qty,H.Cls
	Union All
	select d.sett_no,d.sett_type,d.party_code,c1.short_name,d.Scrip_cd,d.Series,inout='I',Qty=0,
	RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),
	GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),Rate = H.Cls
	from Angeldemat.msajag.dbo.client1 c1,Angeldemat.msajag.dbo.client2 c2,Angeldemat.msajag.dbo.MdClosing H ,Angeldemat.msajag.dbo.DelTrans D
	where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code
	and d.sett_no in( @@Sett_noD1, @@Sett_noD2, @@Sett_noC1, @@Sett_noC2)
              and d.sett_type in ('N','W')
               --and d.party_code = @partycode 
               And Filler2 = 1
	And d.Party_code Not In ( Select Party_Code From Angeldemat.msajag.dbo.DeliveryClt De Where De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Scrip_CD = De.Scrip_CD
	And De.Party_Code = D.Party_Code And De.Series = D.Series ) 
        And H.Scrip = D.Scrip_cd 
        And H.Series = D.Series
        And mfdate = @@MfDate 
    And C1.Branch_cd >= @FromBranch
               And C1.Branch_cd <= @ToBranch
               And C2.Party_code >= @FromParty
               And C2.Party_code <= @ToParty            
	group by d.sett_no,d.sett_type,d.scrip_cd,d.series,c1.short_name,d.party_code ,H.Cls
	) A Where A.Inout = 'I'
        Group By Party_code 
 ) B
       Where AngelClientSummary.Party_code = B.Party_code Collate latin1_general_cs_as
        --And AngelClientSummary.ProcId = @ProcId     
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGprcDrill
-- --------------------------------------------------
CREATE PROCEDURE BBGprcDrill

/* NEW MODIFIED  - 23 Jun 2005 11:56 AM */
-- In this Branchwise, SegmentWise, AllTotals, Branch SubBroker Wise,
-- corrected Dates in from - to, Percentage and TOP are working fine.
-- A parameter is added here for selecting the order for the TOP 
-- One more parameter is added for Exchange Segment

/*
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','HO','','','','','0',' ',0
	prcDrill 'Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	prcDrill 'AllTotals', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'clientwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
*/

(
	@Consol varchar(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker, BSeNseMarketwise */
	@DateFrom varchar(50) = '',
	@DateTo varchar(50) = '',
	@Year varchar(4) = '',
	@Month varchar(15) = '',
	@BranchCode varchar(10) = '',
	@Exchange varchar(10) = '',
	@SubBroker varchar(10) = '',
	@Family varchar(10) = '',
	@Party varchar(10) = '',
	@SelectTop int = 0,
	@SelectOrderBy varchar(200) = '',
	@flgSegment int = 0
)

AS

DECLARE	
	--@dd as varchar(6000),
	@@SELECT AS varchar(6000),
	@@FROM AS varchar(4000),
	@@WHERE AS varchar(6000),
	@@GROUPBY AS varchar(2000),
	@@ORDERBY AS varchar(2000),
	@@SELECT_FINAL AS varchar(6000),
	
	@@TOTVOLUME AS money,
	@@TOTTURNOVER AS money,
	@@TOTBROKERAGE AS money,
	@@TOTSELECT AS varchar(6000),
	@@TOTWHERE AS varchar(6000),
	@@strTotVolume as varchar(80),
	@@strTotTurnOver as varchar(80),
	@@strTotBrokerage as varchar(80),
	@@ErrId int
-----------------------------------------------------------------------------------------------------

--Initialization of variables
set @@SELECT  = '' 
set @@FROM  = '' 
set @@WHERE  = '' 
set @@GROUPBY  = '' 
set @@ORDERBY  = '' 
set @@SELECT_FINAL  = '' 
-----------------------------------------------------------------------------------------------------

-- This is Select part for the totals which are used in the Percentage. 
IF (  @Month <> '' AND @Consol <> 'BranchSubbroker')
	BEGIN
		SET @@TOTSELECT = ' SELECT  SUM ( cast(TP as money) + TS + DP + DS ) as TotalVolume, SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TotalTurnOver, SUM (cast(TPB as money) + TSB + DPB + DSB) as TotalBrokerage '
	END
ELSE
	BEGIN
		SET @@TOTSELECT = ' SELECT SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) as TotalVolume, SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) as TotalTurnOver, SUM (cast(TradingPurBrok as money)+ TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) as TotalBrokerage '
	END

-----------------------------------------------------------------------------------------------------

-- This is where part for the Totals which ate used in the Percentage
--SET @@TOTWHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date  <= CONVERT( DATETIME, ''' + @DateTo + '''  ) '


-----------------------------------------------------------------------------------------------------
-- START OF FROM

Declare @@IsLevel1 varchar(1), @@IsBrokName varchar(1)
Set @@IsBrokName = 'N'
Set @@IsLevel1 = 'N'

		IF (@Month = '' Or @Consol = 'BranchSubbroker')
			Begin
				If @BranchCode = '' And @SubBroker = '' And @Family = '' And @Party = '' And @Exchange = ''
					Begin
						If @Consol = 'BranchSubbroker' Or @Consol = 'Branchwise'
							Begin
								SET @@FROM  = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B '
								Set @@IsBrokName = 'Y'
							End
						Else
							SET @@FROM  = ' FROM Level6Mis A '
					End
				Else
					Begin
						If @Party = '' And @Family = '' And @SubBroker =''
						 Begin
							Set @@FROM = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B  '
							Set @@IsBrokName = 'Y'
						 End
						Else 
							If @Family = '' And @Party = ''
								Set @@FROM = ' FROM Level3Mis A '
							Else
								Set @@FROM = ' FROM Level2Mis A '
					End

				If ( @Consol = 'Clientwise' )
					Begin
						Set @@FROM = ' FROM Level2Mis A '
						Set @@IsBrokName = 'N'
					End
			END
		ELSE
			BEGIN
				SET @@FROM  = ' FROM Level1Mis A '
				Set @@IsLevel1 = 'Y'
			END

--END OF FROM
-----------------------------------------------------------------------------------------------------

If @Month = ''	Or @Consol = 'BranchSubbroker'
	SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
Else
	SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month


If @BranchCode <> ''
	Set @@WHERE = @@WHERE + ' and Branch_cd = ''' + @BranchCode + ''''
If @SubBroker <> ''
	Set @@WHERE = @@WHERE + ' and A.Sub_Broker = ''' + @SubBroker + ''''
If @Family <> ''
	Set @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
If @Party <> ''
	Set @@WHERE = @@WHERE + ' and Party_Code = ''' + @Party + ''''
If @Exchange <> ''
Begin
     IF @Exchange = 'BSENSE'
     Begin
          Set @@WHERE = @@WHERE + ' and ExchangeSegment In (''BSECM'',''NSECM'',''NSEFO'' )'
     End
     Else
     IF @Exchange = 'COMODITY'
     Begin
          Set @@WHERE = @@WHERE + ' and ExchangeSegment In (''MCX'',''NCX'')'
     End
     Else
     Set @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
End
If @Year <> ''
	Begin
		If @@IsLevel1 = 'N'
			Set @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		Else
			Set @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	End

If @@IsBrokName = 'Y'
	Set @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '

--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @BranchCode = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd '				
					end		
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
							end
						else
							begin
								SET @@GROUPBY  = ' GROUP BY [Year] '		
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
									end		
							END
					END
			END
	END

IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
			END
		ELSE
			BEGIN
				IF ( @year = '' )
					BEGIN	
						SET @@GROUPBY =  ' GROUP BY [Year] '
					END	
				ELSE
					BEGIN
						IF (@Month = '' )
							BEGIN
								SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
							END
						ELSE
							BEGIN
								SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
							END
					END
			END
	END


IF ( @Consol = 'BSENSEMarketWise' )
	BEGIN
	     IF ( @year = '' )
	     BEGIN	
		  SET @@GROUPBY =  ' GROUP BY [Year] '
	     END	
	     ELSE
	     BEGIN
	          IF (@Month = '' )
	          BEGIN
		       SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
		  END
		  ELSE
		  BEGIN
		       SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
		  END
	     END
END


IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY [Year], Exchangesegment '								
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY [Year] '		
					end		
			END
		ELSE
			BEGIN	
				IF ( @Month = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
							end		
					END
			END
	END


IF (@Consol = 'Clientwise' )
	SET @@GROUPBY = ' GROUP BY Party_Code '
	If ( @flgSegment = 1 )
		SET @@GROUPBY = @@GROUPBY + ' ,ExchangeSegment '


IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd '									
					end		
			END
		ELSE
			BEGIN
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name, ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name '				
							end		
					END
				ELSE
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Family '				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Party_code '		
									end		
							END
					END
			END
	END
--END OF GROUP BY
-----------------------------------------------------------------------------------------------------
-- START OF ORDER BY
If ( @SelectOrderBy = '' )
	Begin
		IF ( @Consol = 'BranchWise' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY  = ' ORDER BY Branch_cd'
					END
				ELSE
					BEGIN
						IF ( @Year = '' )
							BEGIN
								SET @@ORDERBY  = ' ORDER BY [YEAR]'
							END
						ELSE
							BEGIN
								IF ( @Month = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY [Year], [Month] '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
									END
							END
					END
			END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
				END
			ELSE
				BEGIN	
					IF ( @Year = '' ) 
						BEGIN
							SET @@ORDERBY  = ' ORDER BY [YEAR] '  
						END
					ELSE
						BEGIN
							IF ( @Month = '' ) 
								BEGIN
									SET @@ORDERBY  = ' ORDER BY [Month] '
								END
							ELSE
								BEGIN
									SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
								END
						END
				END
		END

		IF (@Consol = 'AllTotals' )
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Year] '
				END
			ELSE
				BEGIN
					IF ( @Month = '' )
						BEGIN
							SET @@ORDERBY = ' ORDER BY [Month] '		
						END
					ELSE
						BEGIN
							SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
						END
				END
			END

		IF (@Consol = 'Clientwise' ) 
			SET @@ORDERBY = ' ORDER BY Party_Code '
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Branch_cd '	
					END
				ELSE
					BEGIN
						IF ( @SubBroker = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY A.Sub_Broker '
							END
						ELSE
							BEGIN
								IF ( @Family = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY Family '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY Party_code'
									END
							END				
					END
			END
	End
Else
	Begin
		Set @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	End
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

-- Concatenating and Execution of Totals in the Percentage
--EXEC ( @@TOTSELECT + @@FROM + @@WHERE ) 
--print ( @@TOTSELECT + @@FROM + @@WHERE ) 

--print @@TOTSELECT + @@FROM + @@WHERE + '---------------'
Create Table #TotalAll (TotVolume  money, TotTurnOver  money, TotBrokerage  money )
--Insert #TotalAll
Exec ('insert #TotalAll '+@@TOTSELECT + @@FROM + @@WHERE)
select @@TotVolume=convert(money,TotVolume) ,@@TotTurnOver=convert(money,TotTurnOver),@@TotBrokerage=convert(money,TotBrokerage) from  #TotalAll
Drop Table #TotalAll

--print @@TotVolume
--print @@TotTurnOver
--print @@TotBrokerage

select @@strTotVolume = cast(@@TotVolume as varchar)
--print @@strTotVolume
select @@strTotTurnOver = cast(@@TotTurnOver as varchar)
select @@strTotBrokerage = cast(@@TotBrokerage as varchar)

If ( @@strTotVolume = '' Or @@strTotVolume = '0' Or @@strTotVolume Is Null  ) 
begin
	set @@strTotVolume = 1
end

if  ( @@strTotTurnOver = '' Or @@strTotTurnOver = '0' Or @@strTotTurnOver Is Null )
begin	
	set @@strTotTurnOver = 1
end

if ( @@strTotBrokerage = '' Or @@strTotBrokerage = '0' Or @@strTotBrokerage Is Null )
begin
	set @@strTotBrokerage = 1
end

--select @@strTotBrokerage

-----------------------------------------------------------------------------------------------------
/******
	Actual Query
******/


Declare @@Temp varchar(4000)

If @Month = '' Or @Consol = 'BranchSubbroker'
	Set @@Temp = 'SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
Else
	Set @@Temp = 'SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '




-- START OF SELECT
IF ( @Consol = 'BranchWise' )
	BEGIN
		--print 'aaa'
		IF ( @BranchCode = '') 
			BEGIN	
				--print 'bbb'
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(Rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ' + @@Temp
					end
			END
		ELSE
			BEGIN
				IF ( @Year = '')
					BEGIN
						If (@@IsLevel1 = 'Y')
							SET @@SELECT =  ' [Year]= Datepart(Year,Sauda_Date) '
						Else
							SET @@SELECT =  ' [Year] '

						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = @@Select + ' , ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = @@Select + ' , ' + @@Temp
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ExchangeSegment as [Exchange Segment], ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ' + @@Temp
									end		
							END
						ELSE
							BEGIN 
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment  as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
									end		
							END
					END
			END
	END

IF (@Consol = 'Clientwise' )
	Begin
		SET @@SELECT = ' Party_Code, ' + @@Temp
		If ( @flgSegment = 1 )
			SET @@SELECT = ' Party_Code,[Exchange Segment] = ExchangeSegment,  ' + @@Temp
	End



IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = 'COMODITY' )
		BEGIN
		     SET @@SELECT = ' Comodity as ''Exchange Segment'', ' + @@Temp
		END
                ELSE
                    IF (@Exchange = 'BSENSE' )
		    BEGIN
		         SET @@SELECT = ' BSENSE as ''Exchange Segment'', ' + @@Temp
		    END
		    BEGIN
		    IF ( @Year = '' )
		    BEGIN
			 SET @@SELECT = ' [Year], ' + @@Temp
		    END     		    ELSE
		    BEGIN
			 IF ( @Month = '' )
			 BEGIN
			      SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ' + @@Temp
			 END
			 ELSE
			 BEGIN	
			      SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
			 END
		     END
		    END
	END 


IF ( @Consol = 'BSENSEMarketWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@SELECT = ' ''CAPITAL'' as ''ExchangeSegment'', ' + @@Temp
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						SET @@SELECT = ' [Year], ' + @@Temp
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ' + @@Temp
							END
						ELSE
							BEGIN	
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
							END
					END
			END
	END 



IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  [Year], ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
					end
				else
					begin
						SET @@SELECT = '  [Year], SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '														
					end		
			END
		ELSE
			BEGIN
				IF ( @Month = '' )
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
							end
						else
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '																	
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment as ''Exchange Segment'', SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '															
							end
						else
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) /10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '			
							end		
						
					END
			END
	END
	
IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), '  + @@Temp
					end		
			END
		ELSE	
			BEGIN	
--print 'specified the branch'
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name, ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name,  '  + @@Temp
							end		
					END
				ELSE
--print 'specified the sub broker'
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Family, ExchangeSegment as ''Exchange Segment'', '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Family, '  + @@Temp
									end		
							END
						ELSE	
--print 'specified the family'	
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Party_code, ExchangeSegment as ''Exchange Segment'' , '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Party_code, '  + @@Temp
									end		
								
--print @@strTOTTURNOVER
--print @@SELECT
							END
					END
			END	
	END	


--END OF SELECT
-----------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------

--START OF @@SELECT_FINAL
---print 'ccc'
IF ( @SelectTop = 0 )
begin
--	print 'ddd'
	SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
--	print @@SELECT_FINAL
---print 'eee'
end
ELSE
	SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL
-----------------------------------------------------------------------------------------------------
--If ( @@SELECT <> '' )
--	Begin
--	

	Print (@@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY)
	--EXEC ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

--	End
/*
Set @@ErrId = @@ERROR
If @@ErrId <> 0 
	Begin
		RAISERROR ( 'An error occured', 10, 1 )
	End
*/
--print 'reached the print' 
--print @@SELECT_FINAL
--PRINT ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGspBranchBrok
-- --------------------------------------------------
CREATE     
Procedure BBGspBranchBrok
(  
 @Sauda_Date varchar(50)
)  
  
As  

Begin  

Select * into #HighBrok  From
(
Select Branch_Cd,Topsauda_date = Left(Convert(varchar,sauda_date,109),11),Mbrok from Level1Mis , (  
Select Abranch_cd = Branch_cd,Mbrok = Max(TotalBrok),MinBrok = Min(TotalBrok) From (
                 Select  Branch_Cd,Sauda_date, TotalBrok = IsNull(Sum(TPB+DPB+TSB+DSB),0) From level1mis Where
                 Sauda_Date < @Sauda_date + ' 23:59:00'
                 Group by Branch_Cd,Sauda_date) A
                 Group By Branch_Cd )BrokTop
Where 
Branch_Cd = Abranch_Cd
Group By Branch_Cd,Sauda_date,Mbrok
Having
IsNull(Sum(TPB+DPB+TSB+DSB),0) = Mbrok
) A

Print 'Complete Temp Table '
 Select  
  [Branch Code] = IsNull(L1.Branch_cd, '--'),  
  [Branch] = RTrim(IsNull((Select tradername From Risk.dbo.Branch Where sbtag=L1.branch_cd),'--')),  
  [BSE Brok] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NSE Brok] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [FO Brok] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end),0),
  [MCX Brok] = IsNull(Sum(case when ExchangeSegment='MCX' /*And TradeType = 'BT'*/ Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NCDEX Brok] = IsNull(Sum(case when ExchangeSegment='NCX' /*And TradeType = 'BT' */Then TPB+DPB+TSB+DSB else 0 end),0),  
  [Total Brok] = IsNull(Sum(TPB+DPB+TSB+DSB),0),  
  [Daily TO] = 
	IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='MCX' /*And TradeType = 'BT'*/ Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NCX' /*And TradeType = 'BT' */ Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),

	[Net Brok Yield %] =

	(
		isnull(sum(tpb+dpb+tsb+dsb), 0) /
		(
			case
				when
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' /*and tradetype = 'BT'*/ then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' /* and tradetype = 'BT' */ then tpa+dpa+tsa+dsa else 0 end),0)
				)
				> 0
				then
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' /*and tradetype = 'BT'*/ then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' /* and tradetype = 'BT' */ then tpa+dpa+tsa+dsa else 0 end),0)
				)
				else
				 1
				end
		)
	)
	* 100,


  [Alert] = IsNull((Case When (MBrok)<=Sum(TPB+DPB+TSB+DSB) Then 'High           ' Else Null End),IsNull((Case When (Mbrok)>=Sum(TPB+DPB+TSB+DSB) Then Convert(Varchar,Mbrok,8) Else Null End),'...')), 
  [BSE Daily TO] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [BSE Brok %] = (Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [NSE Daily TO] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NSE Brok %] = (Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [FO Daily TO] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),
  [FO Brok %] = (Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [MCX Daily TO] = IsNull(Sum(case when ExchangeSegment='MCX' /*And TradeType = 'BT'*/ Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [MCX Brok %] = (Sum(case when ExchangeSegment='MCX' /*And TradeType = 'BT'*/ Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,  
  [NCDEX Daily TO] = IsNull(Sum(case when ExchangeSegment='NCX' /*And TradeType = 'BT'*/ Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NCDEX Brok %] = (Sum(case when ExchangeSegment='NCX' /*And TradeType = 'BT' */ Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100  
 From  
  Level1mis L1, #HighBrok /* ( Select Abranch_cd = Branch_cd,Mbrok = Max(TotalBrok) From (
                 Select  Branch_Cd,Sauda_date, TotalBrok = IsNull(Sum(TPB+DPB+TSB+DSB),0) From level1mis Where
                 Sauda_Date < @Sauda_Date + ' 23:59:00'
                 Group by Branch_Cd,Sauda_date) A
                 Group By Branch_Cd )BrokTop */

/* (
Select Branch_Cd,Topsauda_date = Left(Convert(varchar,sauda_date,109),11),Mbrok from Level1Mis , (  
Select Abranch_cd = Branch_cd,Mbrok = Max(TotalBrok),MinBrok = Min(TotalBrok) From (
                 Select  Branch_Cd,Sauda_date, TotalBrok = IsNull(Sum(TPB+DPB+TSB+DSB),0) From level1mis Where
                 Sauda_Date < @Sauda_date + ' 23:59:00'
                 Group by Branch_Cd,Sauda_date) A
                 Group By Branch_Cd )BrokTop
Where 
Branch_Cd = Abranch_Cd
Group By Branch_Cd,Sauda_date,Mbrok
Having
IsNull(Sum(TPB+DPB+TSB+DSB),0) = Mbrok
) HighBrok */
 Where  
	Sauda_Date  = @Sauda_Date + ' 23:59:00'
        And L1.Branch_Cd = #HighBrok.branch_Cd
 Group By  
  L1.Branch_cd  ,Mbrok ,TopSauda_date
 Order By  
  Branch



End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGusp_Sel_GenerateMisReportFromLevel1Mis
-- --------------------------------------------------
CREATE Procedure BBGusp_Sel_GenerateMisReportFromLevel1Mis(@RptType as Varchar(20),@FromDate as datetime,@ToDate as datetime,@Branch_code as varchar(20),@Party_code  varchar(20))

as 

DECLARE @File2 TABLE 
( 
    ExchangeSEgment VARCHAR(10), 
    Party_code Varchar(15), 
    Branch_cd Varchar(10),
    Sub_broker Varchar(10),
    sauda_date DateTime ,
    terminal_id Varchar(10),
    turnover Money,
    Brokerage Money
)

Insert into @File2 Select * From ( 
select ExchangeSegment,party_Code,Branch_cd,Sub_broker,sauda_date,a.terminal_id,turnover=sum(TPA+TSA+DPA+DSA),brokerage=sum(TPB+TSB+DPB+DSB)  
from level1mis a, 
(select * from mis.terminalmaster.dbo.tbl_mst_Terminals 
)b 
where a.sauda_Date>=activation_Date and sauda_date<=deactivation_Date 
and a.terminal_id = b.terminal_id --collate SQL_Latin1_General_CP1_CI_AS
and sauda_date>=@FromDate and sauda_date<=@ToDate
group by party_Code,sauda_date,a.terminal_id,ExchangeSegment,party_code,Branch_cd,sub_broker
) Test

If @RptType='Es' 
begin 
select
executive,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage) 
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code  
group by executive order by executive 

end 

else  if @RptType='Ed'
begin 
select a.party_code,executive,sub_broker,branch_cd,ABLCM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),ACDLCM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),ACDLFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),ABLCM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),ACDLCM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by executive,a.party_code,branch_cd,sub_broker order by executive
end 

else  if @RptType='dd'
begin 

select sauda_date=CAST(SAUDA_DATE AS VARCHAR(11)),ABLCM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),ACDLCM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),ACDLFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),ABLCM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),ACDLCM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sauda_date order by sauda_date
end 

else  if @RptType='sd'

begin 
select sauda_date=cast(sauda_date as varchar(11)),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sauda_date order by sauda_date
end 
else  if @RptType='cd'
begin 

select a.party_code,sub_broker,branch_cd,ABLCM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),ACDLCM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),ACDLFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),ABLCM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),ACDLCM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by a.party_code,branch_cd,sub_broker order by a.party_code
end 

else  if @RptType='cs'

begin 
select a.Party_code,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by a.party_code order by a.party_code
end 

else  if @RptType='bd'
begin 

select branch_cd,ABLCM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),ACDLCM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),ACDLFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),ABLCM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),ACDLCM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by branch_cd order by branch_cd
end 

else  if @RptType='Bs'

begin 
select branch_cd,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by branch_cd order by branch_cd 
end 

else  if @RptType='SbS'

begin 
select sub_broker,branch_cd,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by  sub_broker,branch_cd order by  sub_broker,branch_cd
end 

else  if @RptType='Sbd'
begin 

select sub_broker,branch_cd,ABLCM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),ACDLCM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),ACDLFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),ABLCM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),ACDLCM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sub_broker,branch_cd order by sub_broker,branch_cd
end 

else  if @RptType='Exe'
begin 

select a.party_code,ABLCM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),ACDLCM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),ACDLFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),ABLCM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),ACDLCM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from @file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and executive like @Branch_code and a.party_code like @Party_code 
group by a.party_code order by a.party_code
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.branch_mis
-- --------------------------------------------------
CREATE procedure branch_mis(@fdate as varchar(11),@tdate as varchar(11),@brcd as varchar(10),@sbcode as varchar(11))  
as  
set transaction isolation level read uncommitted  
set nocount on  
  
select  
branch_Cd,sub_broker,party_code,party_name,  
BSECM_TO=sum(case when company = 'ABLCM' then turnover else 0 end),  
NSECM_TO=sum(case when company = 'ACDLCM' then turnover else 0 end),  
NSEFO_TO=sum(case when company = 'ACDLFO' then turnover else 0 end),  
MCDX_TO=sum(case when company = 'ACPLMCX' then turnover else 0 end),  
NCDX_TO=sum(case when company = 'ACPLNCDEX' then turnover else 0 end),  
TOTAL_TO=sum(turnover),  
BSECM_BR=sum(case when company = 'ABLCM' then brokerage else 0 end),  
NSECM_BR=sum(case when company = 'ACDLCM' then brokerage else 0 end),  
NSEFO_BR=sum(case when company = 'ACDLFO' then brokerage else 0 end),  
MCDX_BR=sum(case when company = 'ACPLMCX' then brokerage else 0 end),  
NCDX_BR=sum(case when company = 'ACPLNCDEX' then brokerage else 0 end),  
TOTAL_BR=sum(brokerage)  
from mis_to (nolock)  
where sauda_date >=@fdate and sauda_Date <=@tdate  
and branch_cd=@brcd  
and sub_broker like @sbcode  
group by branch_Cd,sub_broker,party_code,party_name  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BseDupAmt
-- --------------------------------------------------
CREATE Procedure BseDupAmt As
Declare
@@FromDate As DateTime


Select @@Fromdate = Left(Convert(Varchar,DateAdd(dd,-10,getdate()),109),11)

Delete DuplicateAmt Where Vdt >= @@FromDate

Insert Into intranet.bsedb_ab.dbo.DuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Anand.Account_ab.dbo.Ledger L  , Anand.Account_ab.dbo.Ledger1 L1  ,Anand.Account_ab.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= @@FromDate  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode ) B


Insert Into intranet.bsedb_ab.dbo.DuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Anand.Account_ab.dbo.Ledger L  , Anand.Account_ab.dbo.Ledger1 L1 ,Anand.Account_ab.dbo.Acmast A
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And  A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset'And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= @@FromDate  and Vdt <= Getdate() 
	  And L.CltCode = '5100000001' ) B


Insert Into log_dupchqamtup values(Getdate(),'BSEDUPLICATEAmount')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BseDupAmtComplete
-- --------------------------------------------------
CREATE Procedure BseDupAmtComplete As
--Declare
--@@FromDate As DateTime


--Select @@Fromdate = Left(Convert(Varchar,DateAdd(dd,-10,getdate()),109),11)

--Delete DuplicateAmt Where Vdt >= @@FromDate
truncate table DuplicateAmt

Insert Into intranet.bsedb_ab.dbo.DuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Anand.Account_ab.dbo.Ledger L  , Anand.Account_ab.dbo.Ledger1 L1  ,Anand.Account_ab.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= 'Apr  1 2001'  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode ) B

Insert Into intranet.bsedb_ab.dbo.DuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Anand.Account_ab.dbo.Ledger L  , Anand.Account_ab.dbo.Ledger1 L1 ,Anand.Account_ab.dbo.Acmast A
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And  A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset'And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= 'Apr  1 2001'  and Vdt <= Getdate() 
	  And L.CltCode = '5100000001' ) B

Insert Into log_dupchqamtup values(Getdate(),'BSEDUPLICATEAmountComplete')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BseDupCheque
-- --------------------------------------------------
CREATE Procedure BseDupCheque
As
Delete AngelDupCheque Where ExchangeSegment = 'BSECM' 
Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'BSECM' 
	 From Anand.Account_Ab.Dbo.Ledger L /* with (nolock)*/ , Anand.Account_Ab.Dbo.Ledger1 L1 /*with (nolock)*/ ,Anand.Account_Ab.Dbo.Acmast A /* with (nolock) */  
	 Where 
	 A.Accat = 4
	 And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode ) A

Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'BSECM' 
	 From Anand.Account_Ab.Dbo.Ledger L /* with (nolock)*/ , Anand.Account_Ab.Dbo.Ledger1 L1 /*with (nolock)*/ ,Anand.Account_Ab.Dbo.Acmast A /* with (nolock) */  
	 Where 
	 --A.Accat = 4
	 --And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode And L.CltCode = '5100000001' ) A

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BseDuplicateCheque
-- --------------------------------------------------
CREATE Procedure [dbo].[BseDuplicateCheque]  (@StatusId Varchar(10),@StatusName Varchar(15),@Fromdate Datetime , @Todate DateTime , @FromParty Varchar(15),@ToParty Varchar(15),@SamedayFlag Varchar (2) )
As

Set Transaction Isolation level read uncommitted  

Declare @FromBranch Varchar(25)
Declare @ToBranch Varchar(25)
Declare @Sql As Varchar(2000)
Declare @ActionDate As DateTime
Declare @ReportDate As DateTime


If @StatusId = 'Broker'
Begin
     Set @FromBranch = 'A'
     Set @ToBranch = 'ZZZZZZZ'
End

If @StatusId = 'Branch'
Begin
     Set @FromBranch = @StatusName
     Set @ToBranch = @StatusName
End

If @Fromdate = '' 
Begin
     Set @FromDate = 'APR 1 '
End

Set @ToDate = Convert(varchar,GetDate(),106) + ' 23:59:59'

If @FromParty = ''
   Set @FromParty = 'A'

If @ToParty = ''
   Set @ToParty = 'ZZZZZZZZZ'


If DatePart(Month,@ToDate)<= 3
	Set @FromDate = @FromDate + Cast((DatePart(Year,GetDate())-1) as varchar)
Else
	Set @FromDate = @FromDate + Cast(DatePart(Year,GetDate()) as varchar)

	Set @FromDate = @FromDate + ' 00:00 '


If @SamedayFlag = 'Y'
Begin
     Select BnkName = bnkname,BrnName= brnname,DD= B.dd,Ddno = B.ddno,DdDt = B.dddt, RelAmt = relamt,DrCr = L1.drcr ,Acname,branch =costname,Cltcode=L2.cltcode 
     From 
     ( 
      Select dd,ddno,dddt from AngelBSECM.Account_ab.Dbo.Ledger1 L1 
      Where  
      Ddno <> '0' And  
      Ddno <>''  
      Group by dd,ddno,dddt 
      Having Count(Ddno) > 1  
     ) B,AngelBSECM.Account_ab.Dbo.Ledger1 L1,AngelBSECM.Account_ab.Dbo.Ledger L, AngelBSECM.Account_ab.Dbo.costmast C , AngelBSECM.Account_ab.Dbo.Ledger2 L2 
    Where  B.dd = L1.dd And 
    B.ddno = L1.ddno And 
    B.dddt = L1.dddt And 
    L.vtyp = L1.vtyp And 
    L.vno = L1.vno And 
    L.drcr = L1.drcr And 
    L.cltcode = L2.cltcode And 
    L.drcr = L2.drcr And 
    L.vno = L2.vno And 
    L.vtyp = L2.vtype And 
    L1.vno = L2.vno And 
    L1.vtyp = L2.vtype And 
    L1.drcr = L2.drcr And 
    L2.costcode = c.costcode And 
    C.costname <= @ToBranch And C.costname >= @FromBranch And 
    B.dddt >= @FromDate and B.dddt < = @ToDate 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BseSundryclientreco_up
-- --------------------------------------------------
CREATE Proc BseSundryclientreco_up
As
Declare @FromDate Varchar(25)
Declare @ToDate Varchar(25)


Set @FromDate = 'APR 1 '

Set @ToDate = Convert(varchar,GetDate(),106) + ' 23:59:59'

If DatePart(Month,@ToDate)<= 3
	Set @FromDate = @FromDate + Cast((DatePart(Year,GetDate())-1) as varchar)
Else
	Set @FromDate = @FromDate + Cast(DatePart(Year,GetDate()) as varchar)

	Set @FromDate = @FromDate + ' 00:00 '


Truncate table BseSundryclientreco1

--Select * Into #Sundry 

Insert Into BseSundryclientreco1
Select * 
From (
Select bnkname = (Select Bnkname from Anand.Account_ab.Dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr), 
BrnName = (Select BRnName from Anand.Account_ab.Dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr), 
DD =(Select DD from Anand.Account_ab.Dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr) ,
Ddno = (Select DDno from Anand.Account_ab.Dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr),
Vtyp = L.Vtyp,
Vno = l.vno, 
AcName = a.LongName,
DrCr = L.DrCr,
Vamt = L.Vamt,
--Booktype = l.booktype, 
vdt=l.vdt,
EnteredBy = L.EnteredBy,
CheckedBy = L.Checkedby, 
--effdt=l.edt, isnull(shortdesc,'') shortdesc, 
--dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),
--cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), 
Narration = replace(replace(l.Narration,'''',''),'"',''),
Branch = (Select COSTNAME From Anand.Account_ab.Dbo.ledger2 L2, Anand.Account_ab.Dbo.Costmast C 
          Where L2.vtype = l.vtyp 
          and L2.vno = l.vno 
          and L2.lno = l.lno And L2.Drcr = L.DrCr And L2.Costcode = C.Costcode)
 
--CltCode = l.cltcode , 
--edt = convert(varchar,l.edt,103), accat  
from Anand.Account_ab.Dbo.ledger l left outer join Anand.Account_ab.Dbo.acmast a on l.cltcode = a.cltcode ,anand.account_ab.Dbo.vmast v  
Where l.vdt >= @FromDate and l.vdt <= @ToDate 
and l.vtyp <> 18 and l.cltcode = '5100000001'  
And vtyp = vtype and a.cltcode = l.cltcode 
and a.accat <> '4'   
--order by l.cltcode, voudt, l.vtyp desc, l.vno
) A

--Select * from #Sundry

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calculate_segment
-- --------------------------------------------------
CREATE procedure [dbo].[calculate_segment] (@party_code as varchar(14))
as
set nocount on
declare @num as numeric
declare @bsenum as numeric
declare @nsenum as numeric
declare @fnonum as numeric
declare @mcxnum as numeric
declare @ncdexnum as numeric
declare @excelvalue as numeric
declare @bse as varchar(7)
declare @nse as varchar(7)
declare @fno as varchar(7)
declare @mcx as varchar(7)
declare @ncdex as varchar(7)
---Set @sh=0
--print @sh

set @nsenum=0
set @bsenum=0
set @fnonum=0
set @mcxnum=0
set @ncdexnum=0
select @num=count(*) from AngelBSECM.bsedb_Ab.dbo.client1 where cl_code=@party_code
   --print @num
if @num=1
   begin
   set @bse ='bse' 
   set @bsenum =  1
   --print @bse
   end 
 

select @num=count(*) from AngelNseCM.msajag.dbo.client1 where cl_code=@party_code
--   print @num
   if @num=1
         begin
         set @nse ='nse' 
         set @nsenum =1
          --print @nse
   end 

--union  @bsenum @nsenum @fnonum @mcxnum @ncdexnum
select @num=count(*) from angelfo.nsefo.dbo.client1 where cl_code=@party_code
--   print @num
   if @num=1
         begin
         set @fno ='fno' 
         set @fnonum = 1
         --print @fno
   end 

--union
select @num=count(*) from angelcommodity.mcdx.dbo.client1 where cl_code=@party_code
--union
-- print @num
   if @num=1
         begin
         set @mcx ='mcx' 
         set @mcxnum =1
         --print @mcx
   end 

select @num=count(*) from angelcommodity.ncdx.dbo.client1 where cl_code=@party_code
 --print @num
   if @num=1
         begin
         set @ncdex ='ncdex' 
         set @ncdexnum =1
         --print @ncdex
   end 

--print @bse 
--print @nse 
--print @fno 
--print @mcx 
--print @ncdex

--print 'Total='
--print @bsenum +@nsenum +@fnonum + @mcxnum + @ncdexnum

if (@bsenum +@nsenum +@fnonum + @mcxnum + @ncdexnum) =1 
        begin
            if @bse ='bse'
                set @num = 8
            if @nse ='nse'
                set @num = 1
            if @fno ='fno'
                set @num = 2
            if @bse ='mcx'
                set @num = 16
            if @ncdex ='ncdex'
                set @num = 64
            
        end

if (@bsenum +@nsenum +@fnonum + @mcxnum + @ncdexnum) =2 
       begin
                       if (@nsenum + @fnonum) = 2
                              set @num = 3
                       if (@bsenum + @nsenum) = 2
                              set @num = 9
                        if (@nsenum + @mcxnum ) = 2
                              set @num = 17
                        if (@bsenum + @fnonum) = 2
                              set @num = 10
                        if (@mcxnum + @fnonum) = 2
                              set @num = 18
                        if  (@bsenum + @fnonum) = 2
                              set @num = 24

        end

if (@bsenum +@nsenum +@fnonum + @mcxnum + @ncdexnum) =3 
  begin
                       if (@nsenum + @fnonum + @bsenum) = 3
                              set @num = 11
                       if (@nsenum + @fnonum + @mcxnum) = 3
                              set @num = 19
                        if (@nsenum + @bsenum + @mcxnum) = 3
                              set @num = 25
                        if (@fnonum + @bsenum +@mcxnum) = 3
                              set @num = 26
                        
   
  end

if (@bsenum +@nsenum +@fnonum + @mcxnum + @ncdexnum) =4 
  begin
                      if (@bsenum +@nsenum +@fnonum + @mcxnum) =4
                              set @num = 27
  end

if (@bsenum +@nsenum +@fnonum + @mcxnum + @ncdexnum) =5 
  begin
      print 'nothing'
  end
--print 'num is '

print @num
select seg=@num
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CFD
-- --------------------------------------------------
CREATE PROCEDURE CFD      

AS      

BEGIN

	SET NOCOUNT ON      
	      
	SELECT TOP 0 * INTO #FILE FROM TBL_CLIENT_FIRST_DATE (NOLOCK)      
	      
	INSERT INTO #FILE (PARTY_CODE,BSECM_FIRSTTRADEDATE)                 
	--SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) FROM MIS_TO_HIST WHERE COMPANY='ABLCM'                
	SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) 
	FROM MIS_TO (NOLOCK) 
	WHERE COMPANY='ABLCM'                
	GROUP BY PARTY_CODE           
	      
	INSERT INTO #FILE (PARTY_CODE,NSECM_FIRSTTRADEDATE)                 
	--SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) FROM MIS_TO_HIST WHERE COMPANY='ACDLCM'                
	SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) 
	FROM MIS_TO (NOLOCK) 
	WHERE COMPANY='ACDLCM'                
	GROUP BY PARTY_CODE           
	      
	INSERT INTO #FILE (PARTY_CODE,NSEFO_FIRSTTRADEDATE)                 
	--SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) FROM MIS_TO_HIST WHERE COMPANY='ACDLFO'                
	SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) 
	FROM MIS_TO (NOLOCK) 
	WHERE COMPANY='ACDLFO'                
	GROUP BY PARTY_CODE           
	      
	INSERT INTO #FILE (PARTY_CODE,MCX_FIRSTTRADEDATE)                 
	--SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) FROM MIS_TO_HIST WHERE COMPANY='ACPLMCX'                
	SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) 
	FROM MIS_TO (NOLOCK) 
	WHERE COMPANY='ACPLMCX'                
	GROUP BY PARTY_CODE           
	      
	      
	INSERT INTO #FILE (PARTY_CODE,NCDEX_FIRSTTRADEDATE)                 
	--SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) FROM MIS_TO_HIST WHERE COMPANY='ACPLNCDEX'                
	SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) 
	FROM MIS_TO (NOLOCK) 
	WHERE COMPANY='ACPLNCDEX'                
	GROUP BY PARTY_CODE           

	/************************** ADDED TO GET FIRST TRADE DATE FOR CURRENCY SEGMENT *******************************/


	INSERT INTO #FILE (PARTY_CODE,MCD_FIRSTTRADEDATE)                 
	SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) 
	FROM MIS_TO (NOLOCK) 
	WHERE COMPANY='ACPLMCD'                
	GROUP BY PARTY_CODE 


	INSERT INTO #FILE (PARTY_CODE,NSX_FIRSTTRADEDATE)                 
	SELECT PARTY_CODE,FIRST_TRADE_DATE=MIN(SAUDA_DATE) 
	FROM MIS_TO (NOLOCK) 
	WHERE COMPANY='ACDLNSX'                
	GROUP BY PARTY_CODE 
	
	/**************************************************************************************************************/


	SELECT PARTY_CODE,FIRST_TRADE_DATE,      
		BSECM_FIRSTTRADEDATE=MAX(ISNULL(BSECM_FIRSTTRADEDATE,CONVERT(DATETIME,'JAN  1 1900'))),      
		NSECM_FIRSTTRADEDATE=MAX(ISNULL(NSECM_FIRSTTRADEDATE,CONVERT(DATETIME,'JAN  1 1900'))),      
		NSEFO_FIRSTTRADEDATE=MAX(ISNULL(NSEFO_FIRSTTRADEDATE,CONVERT(DATETIME,'JAN  1 1900'))),      
		MCX_FIRSTTRADEDATE=MAX(ISNULL(MCX_FIRSTTRADEDATE,CONVERT(DATETIME,'JAN  1 1900'))),      
		NCDEX_FIRSTTRADEDATE=MAX(ISNULL(NCDEX_FIRSTTRADEDATE,CONVERT(DATETIME,'JAN  1 1900'))),
		/************************** ADDED TO GET FIRST TRADE DATE FOR CURRENCY SEGMENT *******************************/
		MCD_FIRSTTRADEDATE=MAX(ISNULL(MCD_FIRSTTRADEDATE,CONVERT(DATETIME,'JAN  1 1900'))),
		NSX_FIRSTTRADEDATE=MAX(ISNULL(NSX_FIRSTTRADEDATE,CONVERT(DATETIME,'JAN  1 1900'))) 
		/**************************************************************************************************************/
	INTO #FILE1      
	FROM #FILE 
	GROUP BY PARTY_CODE,FIRST_TRADE_DATE      
	      
	UPDATE #FILE1 SET BSECM_FIRSTTRADEDATE='DEC 31 2079' WHERE BSECM_FIRSTTRADEDATE='JAN  1 1900'     
	UPDATE #FILE1 SET NSECM_FIRSTTRADEDATE='DEC 31 2079' WHERE NSECM_FIRSTTRADEDATE='JAN  1 1900'     
	UPDATE #FILE1 SET NSEFO_FIRSTTRADEDATE='DEC 31 2079' WHERE NSEFO_FIRSTTRADEDATE='JAN  1 1900'     
	UPDATE #FILE1 SET MCX_FIRSTTRADEDATE='DEC 31 2079' WHERE MCX_FIRSTTRADEDATE='JAN  1 1900'     
	UPDATE #FILE1 SET NCDEX_FIRSTTRADEDATE='DEC 31 2079' WHERE NCDEX_FIRSTTRADEDATE='JAN  1 1900'     
	/************************** ADDED TO GET FIRST TRADE DATE FOR CURRENCY SEGMENT *******************************/
	UPDATE #FILE1 SET MCD_FIRSTTRADEDATE='DEC 31 2079' WHERE MCD_FIRSTTRADEDATE='JAN  1 1900'  
	UPDATE #FILE1 SET NSX_FIRSTTRADEDATE='DEC 31 2079' WHERE NSX_FIRSTTRADEDATE='JAN  1 1900'  
	/**************************************************************************************************************/
	    
	UPDATE #FILE1 
	SET FIRST_TRADE_DATE = CASE WHEN BSECM_FIRSTTRADEDATE > NSECM_FIRSTTRADEDATE  THEN NSECM_FIRSTTRADEDATE      
		ELSE BSECM_FIRSTTRADEDATE END      
	      
	UPDATE #FILE1 
	SET FIRST_TRADE_DATE = CASE WHEN FIRST_TRADE_DATE > NSEFO_FIRSTTRADEDATE THEN NSEFO_FIRSTTRADEDATE       
		ELSE FIRST_TRADE_DATE END      
	      
	UPDATE #FILE1 
		SET FIRST_TRADE_DATE = CASE WHEN FIRST_TRADE_DATE > MCX_FIRSTTRADEDATE  THEN MCX_FIRSTTRADEDATE       
		ELSE FIRST_TRADE_DATE END      
	      
	UPDATE #FILE1 
	SET FIRST_TRADE_DATE = CASE WHEN FIRST_TRADE_DATE > NCDEX_FIRSTTRADEDATE THEN NCDEX_FIRSTTRADEDATE       
		ELSE FIRST_TRADE_DATE END 

	/************************** ADDED TO GET FIRST TRADE DATE FOR CURRENCY SEGMENT *******************************/

	UPDATE #FILE1 
	SET FIRST_TRADE_DATE = CASE WHEN FIRST_TRADE_DATE > MCD_FIRSTTRADEDATE THEN MCD_FIRSTTRADEDATE       
		ELSE FIRST_TRADE_DATE END 

	UPDATE #FILE1 
		SET FIRST_TRADE_DATE = CASE WHEN FIRST_TRADE_DATE > NSX_FIRSTTRADEDATE THEN NSX_FIRSTTRADEDATE       
		ELSE FIRST_TRADE_DATE END 

	/**************************************************************************************************************/     
	      
	UPDATE #FILE1 SET BSECM_FIRSTTRADEDATE='JAN  1 1900' WHERE BSECM_FIRSTTRADEDATE='DEC 31 2079'     
	UPDATE #FILE1 SET NSECM_FIRSTTRADEDATE='JAN  1 1900' WHERE NSECM_FIRSTTRADEDATE='DEC 31 2079'     
	UPDATE #FILE1 SET NSEFO_FIRSTTRADEDATE='JAN  1 1900' WHERE NSEFO_FIRSTTRADEDATE='DEC 31 2079'     
	UPDATE #FILE1 SET MCX_FIRSTTRADEDATE='JAN  1 1900' WHERE MCX_FIRSTTRADEDATE='DEC 31 2079'     
	UPDATE #FILE1 SET NCDEX_FIRSTTRADEDATE='JAN  1 1900' WHERE NCDEX_FIRSTTRADEDATE='DEC 31 2079'
	/************************** ADDED TO GET FIRST TRADE DATE FOR CURRENCY SEGMENT *******************************/
	UPDATE #FILE1 SET MCD_FIRSTTRADEDATE='JAN  1 1900' WHERE MCD_FIRSTTRADEDATE='DEC 31 2079'
	UPDATE #FILE1 SET NSX_FIRSTTRADEDATE='JAN  1 1900' WHERE NSX_FIRSTTRADEDATE='DEC 31 2079'
	/**************************************************************************************************************/     
	    
	      
	--TRUNCATE TABLE CLIENT_FIRST_DATE                 
	INSERT INTO TBL_CLIENT_FIRST_DATE       
	SELECT * FROM #FILE1 
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_CLIENT_FIRST_DATE (NOLOCK) )      
	      
	SET NOCOUNT OFF 
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cli_gross_Brok
-- --------------------------------------------------
CREATE procedure cli_gross_Brok(@coname as varchar(10), @fdate as varchar(11), @tdate as varchar(11), @sbcode as varchar(10))      
as      
      
set nocount on      
      
set transaction isolation level read uncommitted      
declare @str as varchar(5000)      
declare @fname as varchar(100)      
      
if upper(@coname)='ACDLFO'      
BEGIN      
 set @fname='remimast_nsefo'      
END      
if upper(@coname)='ACDLCM'      
BEGIN      
 set @fname='remimast_nsecm'      
END      
if upper(@coname)='ABLCM'      
BEGIN      
 set @fname='remimast_bsecm'      
END      
if upper(@coname)='ACPLMCX'      
BEGIN      
 set @fname='remimast_mcdx'      
END      
if upper(@coname)='ACPLNCDX'      
BEGIN      
  set @coname='ACPLNCDEX'      
  set @fname='remimast_ncdx'      
END      
      
      
Set @str = ''
set @str = @str + ' select party_code into #cli from mis.remisior.dbo.remimast_nsefo b '
set @str = @str + ' where todate >='''+@tdate+''' and subbrokercode='''+@sbcode+''''
      
/*set @str = @str + 'select party_code,party_name,brokerage=sum(brokerage),BK_Trd_Fut=sum(BK_trd_Fut),BK_Del_Opt=sum(BK_del_Opt)'      
set @str = @str + ' from mis_to (nolock) where sauda_date >='''+@fdate+''' and sauda_Date <= '''+@tdate+''''      
set @str = @str + ' and company = '''+@coname+''''    
set @str = @str + ' and exists ( select party_code from mis.remisior.dbo.'+@fname+' b where todate >='''+@tdate+''' and subbrokercode='''+@sbcode+''''      
set @str = @str + ' and b.party_Code=mis_to.party_code collate SQL_Latin1_General_CP1_CI_AS )group by party_code,party_name'      
  */

set @str = @str + ' select party_code,party_name,brokerage=sum(brokerage),BK_Trd_Fut=sum(BK_trd_Fut),BK_Del_Opt=sum(BK_del_Opt)'      
set @str = @str + ' from mis_to (nolock) where sauda_date >='''+@fdate+''' and sauda_Date <= '''+@tdate+''''      
set @str = @str + ' and company = '''+@coname+''''    
set @str = @str + ' and party_code in (select party_code collate SQL_Latin1_General_CP1_CI_AS from #cli ) group by party_code,party_name'      
    
--print @str      
exec(@str)      
      
/*      
if upper(@coname)='ACDLFO'      
BEGIN      
      
 select party_code,party_name,brokerage=sum(brokerage),BK_Trd_Fut=sum(BK_trd_Fut),BK_Del_Opt=sum(BK_del_Opt)      
 from mis_to (nolock)      
 where sauda_date >=@fdate and sauda_Date <=@tdate      
 and exists (       
 select party_code from mis.remisior.dbo.remimast_nsefo b where todate >=@tdate and subbrokercode=@sbcode      
 and b.party_Code=mis_to.party_code collate SQL_Latin1_General_CP1_CI_AS      
 )group by party_code,party_name      
END      
*/      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.clmis_tobrk
-- --------------------------------------------------
CREATE procedure clmis_tobrk(@fdate as varchar(11),@tdate as varchar(11))                                
as                                
                                
set nocount on                                
set transaction isolation level read uncommitted          
if(@fdate='%')        
begin        
select @fdate =max(sauda_date) from mis.remisior.dbo.comb_co where brok_earned is not null            
select @tdate  =max(sauda_date) from mis.remisior.dbo.comb_co where brok_earned is not null     
end        
                              
 /*                              
declare @fdate as varchar(25),@tdate as varchar(25)                  
set @fdate ='Feb 13 2009 00:00:00'                  
set @tdate ='Feb 13 2009 00:00:00'                  
*/                  
select * into #file1 from mis_ebroking (nolock) where sauda_DAte >= @fdate and sauda_date <= @tdate              
--and sub_broker='ACM' --and company='ABLCM'              
        
select * into #file2 from mis_to (nolock) where sauda_DAte >= @fdate and sauda_date <= @tdate           
--and sub_broker='ACM' and company='ABLCM'                 
                  
                  
                  
select  a.party_code, a.sauda_date, a.branch_cd,a.sub_broker,                                             
BSE_TO=sum(case when a.company='ABLCM' and  b.user_stat='' then a.turnover else 0 end),                                            
NSE_TO=sum(case when a.company='ACDLCM' and  b.user_stat='' then a.turnover else 0 end),                                           
FO_TO=sum(case when a.company='ACDLFO' and  b.user_stat='' then a.turnover else 0 end),                                            
MCX_TO=sum(case when a.company='ACPLMCX' and  b.user_stat='' then a.turnover else 0 end),                                           
NCDEX_TO=sum(case when a.company='ACPLNCDEX' and  b.user_stat='' then a.turnover else 0 end),                                           
EBROK_TO=sum(case when b.user_stat='E-BROKING' then a.turnover else 0 end),                                           
BSE_BR=sum(case when a.company='ABLCM' and  b.user_stat='' then a.brokerage else 0 end),                                            
NSE_Br=sum(case when a.company='ACDLCM' and  b.user_stat='' then a.brokerage else 0 end),                                           
FO_Br=sum(case when a.company='ACDLFO' and  b.user_stat='' then a.brokerage else 0 end),                                            
MCX_Br=sum(case when a.company='ACPLMCX' and  b.user_stat='' then a.brokerage else 0 end),                                          
NCDEX_Br=sum(case when a.company='ACPLNCDEX' and  b.user_stat='' then a.brokerage else 0 end),                                      
EBROK_BR=sum(case when user_stat='E-BROKING' then a.brokerage else 0 end),                                      
eBSE_BR=sum(case when a.company='ABLCM' and  b.user_stat='E-BROKING' then a.brokerage else 0 end),                                            
eNSE_Br=sum(case when a.company='ACDLCM' and  b.user_stat='E-BROKING' then a.brokerage else 0 end),                                            
eFO_Br=sum(case when a.company='ACDLFO' and  b.user_stat='E-BROKING' then a.brokerage else 0 end),                                            
eMCX_Br=sum(case when a.company='ACPLMCX' and  b.user_stat='E-BROKING' then a.brokerage else 0 end),                                          
eNCDEX_Br=sum(case when a.company='ACPLNCDEX' and  b.user_stat='E-BROKING' then a.brokerage else 0 end)                                           
into #filed                                                
from #file2 a left outer join #file1 b (nolock)                                
--on a.terminal_id collate Latin1_General_CI_AS = b.terminal_id                                                
on a.terminal_id=b.terminal_id and a.sauda_date=b.sauda_date                                
and a.party_code=b.party_code                                 
--where a.sauda_date>=@fdate+' 00:00:00' and a.sauda_date<=@tdate+' 23:59:59'                 
--where a.sauda_Date >='aug  9 2007 00:00:00' and a.sauda_Date <='aug  9 2007 23:59:59'                                    
--and a.party_code='A8336'                                
group by a.party_code,a.terminal_id,a.sauda_date,a.branch_cd,a.sub_broker            
          
          
                           
                          delete from ebrok_tobr_period where sauda_date>=@fdate and sauda_date<=@tdate                               
                  
                  
                  
insert into ebrok_tobr_period                              
select sauda_date,branch_cd,a.sub_broker,a.party_code,party_name,                                                
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),                                                
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br),                                      
ebse_br=sum(ebse_br),ense_br=sum(ense_br),efo_br=sum(efo_br),emcx_br=sum(emcx_br),encdex_br=sum(encdex_br)                                                
---into #filex                                 
from #filed a left outer join (                        
Select party_code,party_name=short_name from risk.dbo.client_details                        
--Select distinct party_code,party_name,sbtag,subgroup from risk.dbo.finmast (nolock)                       
) b on a.party_code=b.party_Code collate Latin1_General_CI_AS                                 
group by sauda_date,branch_cd,a.sub_broker,a.party_code,party_name                   
                  
                                    
                  
                  
--select * from #filex where party_code='A8336'                          
                                
--select distinct * into #TA from                                      
--(                                      
--select party_code=userid,TA=tradingallowed from mis.dbo.version7 where status='A'                                  
--union                                    
--select party_code=userid,TA=marketsallowed from mis.dbo.version6 where status='A'                                    
--) a                                      
                    
---old tables                      
--select distinct * into #TA from                                      
--(                      
--select party_code=userid,TA=marketsallowed from mis.dbo.ver79_S1 where status='A'                                              
--union                      
--select party_code=userid,TA=marketsallowed from mis.dbo.ver79_S2 where status='A'                                              
--union                      
--select party_code=[user id],TA=[trading allowed] from mis.dbo.ver79_S3 where status='A'                                              
--)                      
--a                      
                      
---new tables                    
select distinct * into #TA from                                      
(                      
select party_code=user_id,TA=Trading_Allowed from mis.dbo.server79_S1 where status='A'                                              
union                      
select party_code=user_id,TA=Trading_Allowed from mis.dbo.server79_S2 where status='A'                                              
union                      
select party_code=user_id,TA=Trading_Allowed from mis.dbo.ver79_S3 where status='A'                                              
)                      
a                      
                    
                    
--select party_code=userid,TA=marketsallowed from mis.dbo.ver79_S1 where userid='A088'                                              
--select party_code=userid,TA=marketsallowed from mis.dbo.ver79_S2 where userid='A088'                         
--select party_code=[user id],TA=[trading allowed] from mis.dbo.ver79_S3 where [user id]='A088'                      
                      
               
--select * from mis.dbo.ver79_S1 where party_code='A8336'                                        
                                
--  drop table #pty_stat1                                      
                 
select party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat                                            
into #pty_stat1                                      
from                                                
(                                     
                                      
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse                                                
from #ta where ta=0                                                
union                                      
select party_code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #nse                                                
from #ta where ta=1                                       
union                                       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #fo                                        
from #ta where  ta=2                                                
union                                       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse                                                
from #ta where  ta=3                                      union                                                 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx                                                
from #ta where  ta=8                                                
union                                  
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx                                                
from #ta where  ta=9                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse                                                
from #ta where  ta=10                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse                                                
from #ta where  ta=11                                                
union                                       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #mcdx                                                
from #ta where  ta=16                                                
union                                       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse                                                
from #ta where  ta=17                                                
union                                       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse                                                
from #ta where  ta=18                                                
union                                       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #ncdx                                                
from #ta where  ta=19                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx                                                
from #ta where  ta=24                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse                                                
from #ta where  ta=25                          
union                                       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx                                                
from #ta where  ta=26                                                
union                      
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse                                                
from #ta where  ta=27                                                
union                                       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse                                                
from #ta where  ta=64                                                
union                                       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #nse                                                
from #ta where  ta=65                               
union                                       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #nse                                                
from #ta where  ta=66                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse                                                
from #ta where  ta=72                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #ncdx                              
from #ta where  ta=73                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #bse             
from #ta where  ta=75                                                
union                                       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse                                            
from #ta where  ta=80                                                
union                                       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #fo                                                
from #ta where  ta=81                                                
union                                       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx                                                
from #ta where  ta=82                                                
union                           
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse                                                
from #ta where  ta=83                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx                                                
from #ta where  ta=88                                                
/* 0.0,27.0,10.0,75.0,89.0,64.0,25.0,9.0,16.0,8.0,73.0,2.0,90.0,1.0,19.0,82.0,26.0,24.0,88.0,91.0,80.0,3.0,11.0,83.0 -- ver6 */                                                
/* 75,83,91,66,82,90,65,19,27,73,81,11,89,3,72,18,80,26,10,88,2,17,25,9,64,1,24,16,8 -- ver7*/                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse                                                
from #ta where  ta=89                                                  
union                                       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx                 
from #ta where  ta=90                                                
union                                       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse                                                
from #ta where  ta=91                                                
) a           
 group by party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat                                            
                                
--select * from #pty_stat where party_code='A8336'                                        
                                      
select partY_code,bse_stat=max(bse_stat),                                  
nse_stat=max(nse_stat),fo_stat=max(fo_stat),mcdx_stat=max(mcdx_stat),ncdx_stat=max(ncdx_stat)                                      
into #pty_stat                                      
from #pty_stat1 group by party_code                                      
                                
truncate table  ebrok_client_access                                
insert into  ebrok_client_access select * from #pty_stat                                  
                  
delete from Ebrok_mis1 where sauda_date>=@fdate and sauda_date<=@tdate+' 23:59:59'                                 
--delete from Ebrok_mis1 where sauda_Date >='aug 25 2006' and sauda_Date <='aug 25 2006'                                    
                                
--select * from #filex where party_code='A8336'                                 
--select * from #pty_stat where party_code='A8336'                                   
                                
--select * from #filex a,#pty_stat b                                
-- where a.party_Code =b.party_Code collate Latin1_General_CI_AS     and a.party_code='A8336'                                 
                                
insert into  Ebrok_mis1                                        
/*                  
select a.*,bse_stat=isnull(bse_stat,' '),nse_stat=isnull(nse_stat,' '),                                            
fo_stat=isnull(fo_stat,' '),mcdx_stat=isnull(mcdx_stat,' '),ncdx_stat=isnull(ncdx_stat,' ')                                       
from ebrok_tobr_period a (nolock) left outer join #pty_stat b                                         
on a.party_Code =b.party_Code collate Latin1_General_CI_AS                                    
where a.party_code in (select party_code collate Latin1_General_CI_AS  from #pty_stat)                                      
*/                  
select a.*,bse_stat=isnull(bse_stat,' '),nse_stat=isnull(nse_stat,' '),                                            
fo_stat=isnull(fo_stat,' '),mcdx_stat=isnull(mcdx_stat,' '),ncdx_stat=isnull(ncdx_stat,' ')                                       
from ebrok_tobr_period a (nolock) , #pty_stat b                                         
where a.sauda_DAte >= @fdate and a.sauda_date <= @tdate    and             
a.party_Code =b.party_Code collate Latin1_General_CI_AS                            
/*Modified by shweta on Apr 16 2008 As ebrok_tobr_period a (nolock) , #pty_stat b                                         
where a.sauda_DAte >= @fdate and a.sauda_date <= @tdate was not mentioned */                 
            
exec ebroking_login_status_pro @fdate,@tdate                
                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.commo_perf_pro
-- --------------------------------------------------
CREATE procedure commo_perf_pro(@tdate as varchar(11))          
as          
          
set transaction  isolation level read uncommitted          
          
set nocount on          

/*declare @tdate as varchar(11)      
set @tdate = 'may 11 2006 23:59:59'      
  */        
select           
branch_Cd,mcdx_to=sum(Case when company='ACPLMCX' then turnover else 0 end),          
ncdx_to=sum(Case when company='ACPLNCDEX' then turnover else 0 end)          
into #to from mis_to where sauda_date =@tdate group by branch_cd          
  
    
select * into #bbb from mis.remisior.dbo.angelremcalc           
where sauda_date = @tdate and (coname='ACPLMCX' or coname='ACPLNCDX')          
      
  
------ working  
--select sum(actbrok) from #bbb a, intranet.risk.dbo.finmast b where a.party_Code=b.party_Code and   
--sbtag='XN' and coname='ACPLNCDX'   
--order by actbrok desc   
------  

select * into #file1 from #bbb where isnull(sr_code,'')= ''  
select * into #file2 from #bbb where isnull(sr_code,'')<> ''  
  
update #file1 set rembrok = 0 from #file2 b   
where b.party_Code=#file1.party_code and b.sauda_date=#file1.sauda_date and #file1.coname=b.coname  
  
select a.* into #temp1 from #file1 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code   
  
insert into #temp1 select a.* from #file2 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code  

select * into #remi_data from #temp1  

/*  
update #bbb set rembrok = b.rembrok from  
(Select * from #bbb where isnull(sr_code,'')<>''  ) b   
where #BBB.PARTY_cODE=B.PARTY_CODE  and isnull(#bbb.sr_code,'')=''    
  
delete from #bbb where isnull(sr_code,'')<>''    
  
*/  
  
/*  
UPDATE #bbb SET ACTBROK = B.ACTBROK FROM       
(select * from #bbb where isnull(sr_code,'')='' ) B WHERE #BBB.PARTY_cODE=B.PARTY_CODE      
AND isnull(#BBB.sr_code,'')<>''       
  
select * into #remi_data from #bbb where isnull(sr_code,'')=''       
      
delete from #remi_data where party_Code in       
(select party_code from #bbb where isnull(sr_code,'')<>'' )      
      
insert into #remi_data  select * from #bbb where isnull(sr_code,'')<>''      
*/      
select branch,          
ncdx_brok=sum(case when coname='ACPLNCDX' then actbrok else 0 end),          
mcdx_brok=sum(case when coname='ACPLMCX' then actbrok else 0 end),          
ncdx_ashare=sum(case when coname='ACPLNCDX' then rembrok else 0 end),          
mcdx_ashare=sum(case when coname='ACPLMCX' then rembrok else 0 end)          
into #brok          
from #remi_data       
group by branch    

delete from commo_perf_eval where tdate = @tdate          

insert into commo_perf_eval  
select tdate=@tdate        
,branch_cd=y.sbtag,branch_name=y.tradername,          
location=(case when y.add5 = 'MUMBAI' then y.add5 else 'REST' end )          
,x.* from           
(select branch=isnull(a.branch_cd,b.branch),          
mcdx_to=isnull(mcdx_to,0),mcdx_brok=isnull(mcdx_brok,0),mcdx_ashare=isnull(mcdx_ashare,0),          
ncdx_to=isnull(ncdx_to,0),ncdx_brok=isnull(ncdx_brok,0),ncdx_ashare=isnull(ncdx_ashare,0)          
from #to a full outer join #brok b on a.branch_Cd=b.branch          
) x, risk.dbo.branch y where x.branch=y.sbtag          
          
---select * from #brok--branch
---select * from risk.dbo.branch--sbtag
---select * from #to--branch_cd

set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.commo_perf_pro_sb
-- --------------------------------------------------
CREATE procedure commo_perf_pro_sb(@tdate as varchar(11))                
as                
                
set transaction  isolation level read uncommitted                
                
set nocount on                
      
/*    
declare @fdate as varchar(11)            
set @fdate = 'may 5 2006'            
declare @tdate as varchar(11)            
set @tdate = 'may 5 2006'            
  */  
    
/*select branch_cd,sub_broker,mcdx_to=sum(Case when company='ACPLMCX' then turnover else 0 end),                
ncdx_to=sum(Case when company='ACPLNCDEX' then turnover else 0 end)                
into #to1     
from mis_to where sauda_date =@tdate      
--sauda_date >=@fdate and sauda_date <=@tdate      
group by branch_cd,sub_broker    
*/    
 
select branch_cd=b.branch,sub_broker=b.subgroup,a.PARTY_CODE,  
mcdx_to=sum(Case when company='ACPLMCX' then turnover else 0 end),  
ncdx_to=sum(Case when company='ACPLNCDEX' then turnover else 0 end)   
into #to_temp   
from mis_to a, RISK.DBO.FINMAST B WHERE     
A.PARTY_CODE  collate Latin1_General_CI_AS=B.PARTY_CODE   
and sauda_date =@tdate  
group by b.branch,b.subgroup,a.PARTY_CODE  
    
select * into #bbb1     
from mis.remisior.dbo.angelremcalc                 
where sauda_date =@tdate  and (coname='ACPLMCX' or coname='ACPLNCDX')                
--sauda_date >=@fdate and sauda_date <=@tdate      
      
select * into #file1 from #bbb1 where isnull(sr_code,'')= ''        
select * into #file2 from #bbb1 where isnull(sr_code,'')<> ''        
      
update #file1 set rembrok = 0 from #file2 b         
where b.party_Code=#file1.party_code and b.sauda_date=#file1.sauda_date and #file1.coname=b.coname        
      
--select sum(rembrok) from #file1 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code and b.sbtag='ho' and coname='ACPLNCDX'      
---select sum(rembrok) from #file2 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code and b.sbtag='ho'  and coname='ACPLNCDX'      
      
/*      
 select company='ACPLNCDX', short_name, long_name, actbrok=sum(actbrok),rembrok=sum(rem_share),BROKERAGEPERCENT=0,BRBROK=0 FROM        
 (        
 select x.*,short_name=sb.sbtag,long_name=sb.tradername from         
 (      
select a.*,rem_share=isnull(b.rembrok,a.rembrok) from        
 #file1 a left outer join #File2  b        
 on a.party_code=b.party_code and a.sauda_date=b.sauda_date      
) x, intranet.risk.dbo.branch sb  where sb.sbtag=x.branch   and sb.sbtag='ho' and       
--sauda_date >=@tdate      
 coname='ACPLNCDX' and      
sauda_date >='feb 4 2006' and sauda_date <='feb 10 2006'      
 ) z  group by short_name,Long_name order by actbrok desc        
*/      
  
select a.*,sbtag into #temp1 from #file1 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code         
      
insert into #temp1 select a.*,sbtag from #file2 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code        
    
select * into #remi_data from #temp1     
    
select branch,subbrokcode,party_code,    
ncdx_brok=sum(case when coname='ACPLNCDX' then actbrok else 0 end),                
mcdx_brok=sum(case when coname='ACPLMCX' then actbrok else 0 end),                
ncdx_ashare=sum(case when coname='ACPLNCDX' then rembrok else 0 end),                
mcdx_ashare=sum(case when coname='ACPLMCX' then rembrok else 0 end)                
into #brok                
from #remi_data       
group by branch,subbrokcode,party_code    
    
/*select tdate=@tdate,    
branch_cd=y.sbtag,branch_name=y.tradername,                
location=(case when y.add5 = 'MUMBAI' then y.add5 else 'REST' end )                
,x.* INTO #BB     
from                             
(select     
branch=isnull(a.branch_cd,b.branch),    
sub_broker=isnull(a.sub_brokER,b.subbrokcode),     
mcdx_to=isnull(mcdx_to,0),mcdx_brok=isnull(mcdx_brok,0),mcdx_ashare=isnull(mcdx_ashare,0),                
ncdx_to=isnull(ncdx_to,0),ncdx_brok=isnull(ncdx_brok,0),ncdx_ashare=isnull(ncdx_ashare,0)                
from #to1 a full outer join #brok b on a.sub_broker=b.subbrokcode    
) x, risk.dbo.branch y where x.branch=y.sbtag          
*/    
  
select tdate=@tdate,    
branch_cd=y.sbtag,branch_name=y.tradername,               
location=(case when y.add5 = 'MUMBAI' then y.add5 else 'REST' end )                
,x.*     
INTO #BB     
from                             
(select a.party_code,     
branch=isnull(a.branch_cd,b.branch),    
sub_broker=isnull(a.SUB_BROKER,b.subbrokcode),     
mcdx_to=isnull(mcdx_to,0),mcdx_brok=isnull(mcdx_brok,0),mcdx_ashare=isnull(mcdx_ashare,0),                
ncdx_to=isnull(ncdx_to,0),ncdx_brok=isnull(ncdx_brok,0),ncdx_ashare=isnull(ncdx_ashare,0)                
from #to_temp a full outer join #brok b on a.party_code collate Latin1_General_CI_AS=b.party_code    
) x, risk.dbo.branch y where x.branch=y.sbtag         
  
    
delete from commo_perf_eval_sb where tdate=@tdate     
    
insert into commo_perf_eval_sb      
SELECT M.*,left(N.SBNAME,25)
FROM #BB M LEFT OUTER JOIN RISK.DBO.SUBGROUP N ON    
M.SUB_BROKER=N.SUB_BROKER    
    
set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.commo_perf_pro_trial
-- --------------------------------------------------
CREATE procedure commo_perf_pro_trial(@tdate as varchar(11))        
as        
        
set transaction  isolation level read uncommitted        
        
set nocount on        
    
--declare @tdate as varchar(11)    
--set @tdate = 'Feb  4 2006'    
        
select         
branch_Cd,mcdx_to=sum(Case when company='ACPLMCX' then turnover else 0 end),        
ncdx_to=sum(Case when company='ACPLNCDEX' then turnover else 0 end)        
into #to from mis_to where sauda_date =@tdate group by branch_cd        

  
select * into #bbb from mis.remisior.dbo.angelremcalc         
where sauda_date = @tdate and (coname='ACPLMCX' or coname='ACPLNCDX')        
    

------ working
--select sum(actbrok) from #bbb a, intranet.risk.dbo.finmast b where a.party_Code=b.party_Code and 
--sbtag='XN' and coname='ACPLNCDX' 
--order by actbrok desc 
------

select * into #file1 from #bbb where isnull(sr_code,'')= ''
select * into #file2 from #bbb where isnull(sr_code,'')<> ''

update #file1 set rembrok = 0 from #file2 b 
where b.party_Code=#file1.party_code and b.sauda_date=#file1.sauda_date and #file1.coname=b.coname

select a.* into #temp1 from #file1 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code 

insert into #temp1 select a.* from #file2 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code

select * into #remi_data from #temp1


/*
update #bbb set rembrok = b.rembrok from
(Select * from #bbb where isnull(sr_code,'')<>''  ) b 
where #BBB.PARTY_cODE=B.PARTY_CODE  and isnull(#bbb.sr_code,'')=''  

delete from #bbb where isnull(sr_code,'')<>''  

*/

/*
UPDATE #bbb SET ACTBROK = B.ACTBROK FROM     
(select * from #bbb where isnull(sr_code,'')='' ) B WHERE #BBB.PARTY_cODE=B.PARTY_CODE    
AND isnull(#BBB.sr_code,'')<>''     

select * into #remi_data from #bbb where isnull(sr_code,'')=''     
    
delete from #remi_data where party_Code in     
(select party_code from #bbb where isnull(sr_code,'')<>'' )    
    
insert into #remi_data  select * from #bbb where isnull(sr_code,'')<>''    
*/    


      
select sbtag,        
ncdx_brok=sum(case when coname='ACPLNCDX' then actbrok else 0 end),        
mcdx_brok=sum(case when coname='ACPLMCX' then actbrok else 0 end),        
ncdx_ashare=sum(case when coname='ACPLNCDX' then rembrok else 0 end),        
mcdx_ashare=sum(case when coname='ACPLMCX' then rembrok else 0 end)        
into #brok        
from #remi_data a,intranet.risk.dbo.finmast b where a.party_Code=b.party_code       
group by sbtag  

--select * from #brok  



    
delete from commo_perf_eval where tdate = @tdate        
     
insert into commo_perf_eval         
select tdate=@tdate      
,branch_cd=y.sbtag,branch_name=y.tradername,        
location=(case when y.add5 = 'MUMBAI' then y.add5 else 'REST' end )        
,x.* from         
(select branch=isnull(a.branch_cd,b.sbtag),        
mcdx_to=isnull(mcdx_to,0),mcdx_brok=isnull(mcdx_brok,0),mcdx_ashare=isnull(mcdx_ashare,0),        
ncdx_to=isnull(ncdx_to,0),ncdx_brok=isnull(ncdx_brok,0),ncdx_ashare=isnull(ncdx_ashare,0)        
from #to a full outer join #brok b on a.branch_Cd=b.sbtag        
) x, risk.dbo.branch y where x.branch=y.sbtag        
        
set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.commo_perf_pro_trial1
-- --------------------------------------------------
CREATE procedure commo_perf_pro_trial1(@tdate as varchar(11))          
as          
          
set transaction  isolation level read uncommitted          
          
set nocount on          

/*declare @fdate as varchar(11)      
set @fdate = 'Feb 4 2006'      
declare @tdate as varchar(11)      
set @tdate = 'Feb 10 2006'      
 */

select           
branch_Cd,mcdx_to=sum(Case when company='ACPLMCX' then turnover else 0 end),          
ncdx_to=sum(Case when company='ACPLNCDEX' then turnover else 0 end)          
into #to from mis_to where sauda_date =@tdate
--sauda_date >=@fdate and sauda_date <=@tdate
group by branch_cd          
  
    
select * into #bbb from mis.remisior.dbo.angelremcalc           
where sauda_date =@tdate  and (coname='ACPLMCX' or coname='ACPLNCDX')          
--sauda_date >=@fdate and sauda_date <=@tdate


select * into #file1 from #bbb where isnull(sr_code,'')= ''  
select * into #file2 from #bbb where isnull(sr_code,'')<> ''  

update #file1 set rembrok = 0 from #file2 b   
where b.party_Code=#file1.party_code and b.sauda_date=#file1.sauda_date and #file1.coname=b.coname  

--select sum(rembrok) from #file1 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code and b.sbtag='ho' and coname='ACPLNCDX'
---select sum(rembrok) from #file2 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code and b.sbtag='ho'  and coname='ACPLNCDX'

/*
 select company='ACPLNCDX', short_name, long_name, actbrok=sum(actbrok),rembrok=sum(rem_share),BROKERAGEPERCENT=0,BRBROK=0 FROM  
 (  
 select x.*,short_name=sb.sbtag,long_name=sb.tradername from   
 (
select a.*,rem_share=isnull(b.rembrok,a.rembrok) from  
 #file1 a left outer join #File2  b  
 on a.party_code=b.party_code and a.sauda_date=b.sauda_date
) x, intranet.risk.dbo.branch sb  where sb.sbtag=x.branch   and sb.sbtag='ho' and 
--sauda_date >=@tdate
 coname='ACPLNCDX' and
sauda_date >='feb 4 2006' and sauda_date <='feb 10 2006'
 ) z  group by short_name,Long_name order by actbrok desc  
*/


select a.*,sbtag into #temp1 from #file1 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code   

insert into #temp1 select a.*,sbtag from #file2 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code  

select * into #remi_data from #temp1  

select branch,          
ncdx_brok=sum(case when coname='ACPLNCDX' then actbrok else 0 end),          
mcdx_brok=sum(case when coname='ACPLMCX' then actbrok else 0 end),          
ncdx_ashare=sum(case when coname='ACPLNCDX' then rembrok else 0 end),          
mcdx_ashare=sum(case when coname='ACPLMCX' then rembrok else 0 end)          
into #brok          
from #remi_data 
group by branch
 
delete from commo_perf_eval where tdate=@tdate
       
insert into commo_perf_eval           
select tdate=@tdate,branch_cd=y.sbtag,branch_name=y.tradername,          
location=(case when y.add5 = 'MUMBAI' then y.add5 else 'REST' end )          
,x.* from           
(select branch=isnull(a.branch_cd,b.branch),          
mcdx_to=isnull(mcdx_to,0),mcdx_brok=isnull(mcdx_brok,0),mcdx_ashare=isnull(mcdx_ashare,0),          
ncdx_to=isnull(ncdx_to,0),ncdx_brok=isnull(ncdx_brok,0),ncdx_ashare=isnull(ncdx_ashare,0)          
from #to a full outer join #brok b on a.branch_Cd=b.branch          
) x, risk.dbo.branch y where x.branch=y.sbtag    

set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.commo_perf_pro1
-- --------------------------------------------------
create procedure commo_perf_pro1(@tdate as varchar(11))          
as          
          
set transaction  isolation level read uncommitted          
          
set nocount on          

/*declare @tdate as varchar(11)      
set @tdate = 'may 11 2006 23:59:59'      
  */        
select           
branch_Cd,mcdx_to=sum(Case when company='ACPLMCX' then turnover else 0 end),          
ncdx_to=sum(Case when company='ACPLNCDEX' then turnover else 0 end)          
into #to from mis_to where sauda_date =@tdate group by branch_cd          
  
    
select * into #bbb from mis.remisior.dbo.angelremcalc           
where sauda_date = @tdate and (coname='ACPLMCX' or coname='ACPLNCDX')          
      
  
------ working  
--select sum(actbrok) from #bbb a, intranet.risk.dbo.finmast b where a.party_Code=b.party_Code and   
--sbtag='XN' and coname='ACPLNCDX'   
--order by actbrok desc   
------  

select * into #file1 from #bbb where isnull(sr_code,'')= ''  
select * into #file2 from #bbb where isnull(sr_code,'')<> ''  
  
update #file1 set rembrok = 0 from #file2 b   
where b.party_Code=#file1.party_code and b.sauda_date=#file1.sauda_date and #file1.coname=b.coname  
  
select a.* into #temp1 from #file1 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code   
  
insert into #temp1 select a.* from #file2 a, intranet.risk.dbo.finmast b where a.party_code=b.party_code  

select * into #remi_data from #temp1  

/*  
update #bbb set rembrok = b.rembrok from  
(Select * from #bbb where isnull(sr_code,'')<>''  ) b   
where #BBB.PARTY_cODE=B.PARTY_CODE  and isnull(#bbb.sr_code,'')=''    
  
delete from #bbb where isnull(sr_code,'')<>''    
  
*/  
  
/*  
UPDATE #bbb SET ACTBROK = B.ACTBROK FROM       
(select * from #bbb where isnull(sr_code,'')='' ) B WHERE #BBB.PARTY_cODE=B.PARTY_CODE      
AND isnull(#BBB.sr_code,'')<>''       
  
select * into #remi_data from #bbb where isnull(sr_code,'')=''       
      
delete from #remi_data where party_Code in       
(select party_code from #bbb where isnull(sr_code,'')<>'' )      
      
insert into #remi_data  select * from #bbb where isnull(sr_code,'')<>''      
*/      
select branch,          
ncdx_brok=sum(case when coname='ACPLNCDX' then actbrok else 0 end),          
mcdx_brok=sum(case when coname='ACPLMCX' then actbrok else 0 end),          
ncdx_ashare=sum(case when coname='ACPLNCDX' then rembrok else 0 end),          
mcdx_ashare=sum(case when coname='ACPLMCX' then rembrok else 0 end)          
--into #brok          
from #remi_data       
group by branch    
      
delete from commo_perf_eval where tdate = @tdate          
       
insert into commo_perf_eval           
select tdate=@tdate        
,branch_cd=y.sbtag,branch_name=y.tradername,          
location=(case when y.add5 = 'MUMBAI' then y.add5 else 'REST' end )          
,x.* from           
(select branch=isnull(a.branch_cd,b.sbtag),          
mcdx_to=isnull(mcdx_to,0),mcdx_brok=isnull(mcdx_brok,0),mcdx_ashare=isnull(mcdx_ashare,0),          
ncdx_to=isnull(ncdx_to,0),ncdx_brok=isnull(ncdx_brok,0),ncdx_ashare=isnull(ncdx_ashare,0)          
from #to a full outer join #brok b on a.branch_Cd=b.sbtag          
) x, risk.dbo.branch y where x.branch=y.sbtag          
          
set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CommodityDupAmtUp
-- --------------------------------------------------
CREATE Procedure CommodityDupAmtUp
As


Truncate table NcdxDuplicateAmt

Insert Into intranet.bsedb_ab.dbo.NcdxDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Angelcommodity.AccountNCDX.dbo.Ledger L  , Angelcommodity.AccountNCDX.dbo.Ledger1 L1  ,Angelcommodity.AccountNCDX.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= 'Apr  1 2001' and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode
 ) B

Insert Into intranet.bsedb_ab.dbo.NcdxDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Angelcommodity.AccountNCDX.dbo.Ledger L  , Angelcommodity.AccountNCDX.dbo.Ledger1 L1  ,Angelcommodity.AccountNCDX.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset'And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= 'Apr  1 2001' and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode
              And L.CltCode = '5100000001'
 ) B



Truncate table McdxDuplicateAmt


Insert Into intranet.bsedb_ab.dbo.McdxDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Angelcommodity.AccountMCDX.dbo.Ledger L  , Angelcommodity.AccountMCDX.dbo.Ledger1 L1  ,Angelcommodity.AccountMCDX.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= 'Apr  1 2001' and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode
 ) B

Insert Into intranet.bsedb_ab.dbo.McdxDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From Angelcommodity.AccountMCDX.dbo.Ledger L  , Angelcommodity.AccountMCDX.dbo.Ledger1 L1  ,Angelcommodity.AccountMCDX.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset'And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= 'Apr  1 2001' and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode
              And L.CltCode = '5100000001'
 ) B

Insert Into log_dupchqamtup values(Getdate(),'CommodityDUPLICATEAmount')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CommodityDupCheque
-- --------------------------------------------------
CREATE Procedure CommodityDupCheque
As

Delete AngelDupCheque Where ExchangeSegment = 'MCDX' 
Delete AngelDupCheque Where ExchangeSegment = 'NCDX' 
Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'MCDX' 
	 From AngelCommodity.AccountMcdx.Dbo.Ledger L /* with (nolock)*/ , AngelCommodity.AccountMcdx.Dbo.Ledger1 L1 /*with (nolock)*/ ,AngelCommodity.AccountMcdx.Dbo.Acmast A /* with (nolock) */  
	 Where 
	 A.Accat = 4
	 And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode ) A 




Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'MCDX' 
	 From AngelCommodity.AccountMcdx.Dbo.Ledger L /* with (nolock)*/ , AngelCommodity.AccountMcdx.Dbo.Ledger1 L1 /*with (nolock)*/ ,AngelCommodity.AccountMcdx.Dbo.Acmast A /* with (nolock) */  
	 Where 
	 --A.Accat = 4
	 --And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode And L.CltCode = '5100000001' ) A 


Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NCDX' 
	 From AngelCommodity.AccountNcdx.Dbo.Ledger L /* with (nolock)*/ , AngelCommodity.AccountNcdx.Dbo.Ledger1 L1 /*with (nolock)*/ ,AngelCommodity.AccountNcdx.Dbo.Acmast A /* with (nolock) */  
	 Where 
	 A.Accat = 4
	 And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode ) A

Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NCDX' 
	 From AngelCommodity.AccountNcdx.Dbo.Ledger L /* with (nolock)*/ , AngelCommodity.AccountNcdx.Dbo.Ledger1 L1 /*with (nolock)*/ ,AngelCommodity.AccountNcdx.Dbo.Acmast A /* with (nolock) */  
	 Where 
	 --A.Accat = 4
	 --And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode And L.CltCode = '5100000001' ) A

GO

-- --------------------------------------------------
-- PROCEDURE dbo.conn_count1
-- --------------------------------------------------
  
  
--CONN_COUNT1 '02/21/2011' '02/22/2011' '%' 'BRMAST' 'NRTH_7' -- ALL  
  
CREATE PROCEDURE DBO.CONN_COUNT1                 
(                
@FDATE AS VARCHAR(25),                
@TDATE AS VARCHAR(25),                
@DDL AS VARCHAR(25),                                
@USER AS VARCHAR(10),                
@CODE AS VARCHAR(10)                
)                
                                  
AS                                  
               
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                   
SET NOCOUNT ON                             
              
/************** COMMENTED BECAUSE LOGINFILE TABLE DOES NOT CONTAIN DATA **********************************               
SELECT DISTINCT PARTY_CODE,CONNECTED=SUM(CASE WHEN STATUS='CONNECTED' THEN 1 ELSE 0 END),                            
DISCONNECTED=SUM(CASE WHEN STATUS='DISCONNECTED' THEN 1 ELSE 0 END),                            
FAILED=SUM(CASE WHEN STATUS='FAILED' THEN 1 ELSE 0 END),                          
NOTLOGGED=''                          
INTO #FILE2                               
FROM LOGINFILE (NOLOCK)                            
WHERE STATUS LIKE @DDL AND LOGIN_DATE>=@FDATE AND LOGIN_DATE<=@TDATE AND PARTY_CODE IS NOT NULL                             
GROUP BY PARTY_CODE                           
--SELECT TOP 5 * FROM #FILE1  DROP TABLE   #FILE1                      
*********************************************************************************************************/              
              
SELECT PARTY_CODE,              
 CONNECTED = SUM(CONNECTED),                            
 DISCONNECTED=SUM(DISCONNECTED),              
 FAILED=SUM(FAILED),              
 NOTLOGGED=SUM(NOTLOGGED)    
INTO #FILE2                               
FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS WITH (NOLOCK)                            
WHERE CONVERT(DATETIME,[DATE])>= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,[DATE]) <= CONVERT(DATETIME,@TDATE)               
GROUP BY PARTY_CODE    
              
SELECT *,B2C='B2B' INTO #FI                       
FROM #FILE2                          
UNION                           
SELECT DISTINCT PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS,CONNECTED=0, DISCONNECTED=0, FAILED=0,NOTLOGGED=1,B2C='B2B' FROM MIS.DBO.EBROK_CLIENT1                          
WHERE PARTY_CODE NOT IN (SELECT DISTINCT PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS FROM #FILE2)                             
GROUP BY PARTY_CODE                       
              
SELECT DISTINCT A.*,SUB_BROKER                 
INTO #FILE1                 
FROM #FI A JOIN RISK.DBO.CLIENT_DETAILS B                 
ON A.PARTY_CODE=B.PARTY_CODE                 
COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS                           
              
UPDATE #FILE1 SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #FILE1.SUB_BROKER=B.B2C_SB                                
              
IF @USER='BROKER'                                          
BEGIN                                 
              
SELECT B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE,B.SHORT_NAME,A.CONNECTED,                            
A.DISCONNECTED,A.FAILED,A.NOTLOGGED ,A.B2C                            
FROM #FILE1 A,RISK.DBO.CLIENT_DETAILS B (NOLOCK)                                 
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                           
ORDER BY  B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE                              
              
END                                 
              
              
IF @USER='REGION'                                          
BEGIN                                    
              
SELECT B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE,B.SHORT_NAME,A.CONNECTED,                            
A.DISCONNECTED,A.FAILED,A.NOTLOGGED ,A.B2C                              
FROM #FILE1 A,RISK.DBO.CLIENT_DETAILS B (NOLOCK)                                
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                
AND B.BRANCH_CD IN                 
(                
SELECT CODE     
FROM RISK.DBO.REGION (NOLOCK)                 
WHERE REG_CODE=@CODE                
)                          
ORDER BY  B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE                                 
              
END                   
               
IF @USER='BRMAST'                                          
BEGIN                                 
              
SELECT B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE,B.SHORT_NAME,A.CONNECTED,        
A.DISCONNECTED,A.FAILED ,A.NOTLOGGED  ,A.B2C                            
FROM #FILE1 A,RISK.DBO.CLIENT_DETAILS B (NOLOCK)                                
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                             
AND B.BRANCH_CD IN (SELECT BRANCH_CD FROM RISK.DBO.BRANCH_MASTER WHERE BRMAST_CD=@CODE)                      
ORDER BY  B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE                                    
              
END                                           
               
IF @USER='BRANCH'                                          
BEGIN             
              
SELECT B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE,B.SHORT_NAME,A.CONNECTED,                            
A.DISCONNECTED,A.FAILED,A.NOTLOGGED ,A.B2C                              
FROM #FILE1 A,RISK.DBO.CLIENT_DETAILS B (NOLOCK)                                
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                
AND B.BRANCH_CD=@CODE                                
ORDER BY  B.BRANCH_CD,B.SUB_BROKER,A.PARTY_CODE                                 
              
END                                        
              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.connection_count
-- --------------------------------------------------
CREATE procedure connection_count (@fdate as varchar(25),@tdate as varchar(25),@ddl as varchar(25),  
@user as varchar(10),@code as varchar(10))            
As           
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
 SET NOCOUNT ON   
select distinct party_code,status=count(status) into #file1  
 from loginfile (nolock)   
where status like @ddl and login_date>=@fdate and login_date<=@tdate  
group by party_code  
  
  
if @user='BROKER'            
begin   
  
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.status  
from #file1 a,risk.dbo.client_details b (nolock)   
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS  
  
  
end   
  
  
if @user='REGION'            
begin      
    
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.status  
from #file1 a,risk.dbo.client_details b (nolock)  
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS  
AND b.branch_cd IN (SELECT code FROM risk.dbo.region (nolock) where reg_code=@code)   
  
end          
            
if @user='BRMAST'            
begin   
  
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.status  
from #file1 a,risk.dbo.client_details b (nolock)  
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS  
  
AND b.branch_cd IN (select branch_cd from risk.dbo.branch_master where brMast_cd=@code)       
end             
            
if @user='BRANCH'            
begin       
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.status  
from #file1 a,risk.dbo.client_details b (nolock)  
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS  
  
AND b.branch_cd=@code       
End          
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.connection_count1
-- --------------------------------------------------
CREATE procedure connection_count1 (@fdate as varchar(25),@tdate as varchar(25),@ddl as varchar(25),    
@user as varchar(10),@code as varchar(10))              
As             
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
 SET NOCOUNT ON     
select distinct party_code,connected=sum(case when status='Connected' then 1 else 0 end),
disconnected=sum(case when status='Disconnected' then 1 else 0 end),
failed=sum(case when status='Failed' then 1 else 0 end) into #file1    
 from loginfile (nolock)     
where status like @ddl and login_date>=@fdate and login_date<=@tdate
group by party_code ,status   
    
    
if @user='BROKER'              
begin     
    
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.connected,
a.disconnected,a.failed    
from #file1 a,risk.dbo.client_details b (nolock)     
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS    
    
    
end     
    
    
if @user='REGION'              
begin        
      
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.connected,
a.disconnected,a.failed   
from #file1 a,risk.dbo.client_details b (nolock)    
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS    
AND b.branch_cd IN (SELECT code FROM risk.dbo.region (nolock) where reg_code=@code)     
    
end            
              
if @user='BRMAST'              
begin     
    
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.connected,
a.disconnected,a.failed   
from #file1 a,risk.dbo.client_details b (nolock)    
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS    
    
AND b.branch_cd IN (select branch_cd from risk.dbo.branch_master where brMast_cd=@code)         
end               
              
if @user='BRANCH'              
begin         
select b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.connected,
a.disconnected,a.failed   
from #file1 a,risk.dbo.client_details b (nolock)    
WHERE A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS    
    
AND b.branch_cd=@code         
End            
            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COPY_TotBrok_NetBrok
-- --------------------------------------------------
CREATE Procedure COPY_TotBrok_NetBrok(@fdate as varchar(25),@tdate as varchar(25),@user as varchar(10),@code as varchar(10),@BrOrSB as varchar(8),@flag as varchar(1))    
as    
if @BrOrSB<>'%' and @flag='B'    
BEGIN    
 select a.*,angel_net_bse,angel_net_nse,angel_net_fo,angel_net_mcx,angel_net_ncx,Net    
  from    
 (select branch_cd,sub_broker,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0),   
br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to
+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
  from ebrok_tobr_period (nolock)    
 where sauda_date>=@fdate and sauda_date<=@tdate and branch_cd=@BrOrSB    
 group by branch_cd,sub_broker --order by branch_cd    
 ) a    
 left outer join    
 (select  branch,subbrokcode,    
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),    
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),    
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),    
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),    
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),  
 Net=sum(angel_share)    
 from mis.remisior.dbo.comb_sb where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch=@BrOrSB    
 group by branch,subbrokcode) b    
 on  a.branch_cd=b.branch and a.sub_broker=b.subbrokcode order by branch_cd,sub_broker    
    
END    
if @BrOrSB<>'%' and @flag='S'    
BEGIN    
 select a.*,angel_net_bse,angel_net_nse,angel_net_fo,angel_net_mcx,angel_net_ncx,Net    
  from    
 (select branch_cd,sub_broker,party_code,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0),
 total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
  from ebrok_tobr_period (nolock)    
 where sauda_date>=@fdate and sauda_date<=@tdate and sub_broker=@BrOrSB    
 group by branch_cd,sub_broker,party_code --order by branch_cd    
 ) a    
 left outer join    
 (select  branch,subbrokcode,party_code,    
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),    
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),    
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),    
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),    
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),  
  Net=sum(angel_share)     
 from mis.remisior.dbo.comb_cli where sauda_date>=@fdate and sauda_date<=@tdate    
 and subbrokcode=@BrOrSB    
 group by branch,subbrokcode,party_code) b    
 on  a.party_code=b.party_code collate Latin1_General_CI_AS order by party_code    
    
END    

if @BrOrSB<>'%' and @flag='O'    
BEGIN    
 select a.*,angel_net_bse,angel_net_nse,angel_net_fo,angel_net_mcx,angel_net_ncx,Net    
  from    
 (select branch_cd,sub_broker,party_code,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0),
 total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
  from ebrok_tobr_period (nolock)    
 where sauda_date>=@fdate and sauda_date<=@tdate and branch_cd=@BrOrSB    
 group by branch_cd,sub_broker,party_code --order by branch_cd    
 ) a    
 left outer join    
 (select  branch,subbrokcode,party_code,    
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),    
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),    
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),    
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),    
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),  
  Net=sum(angel_share)     
 from mis.remisior.dbo.comb_cli where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch=@BrOrSB    
 group by branch,subbrokcode,party_code) b    
 on  a.party_code=b.party_code collate Latin1_General_CI_AS order by party_code    
    
END   
if @user='BROKER' and @BrOrSB='%'    
BEGIN    
    
 select a.*,angel_net_bse,angel_net_nse,angel_net_fo,angel_net_mcx,angel_net_ncx,Net    
  from    
 (select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), total_br=isnull(sum(bse_br+EBse_br+nse_br
+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
  from ebrok_tobr_period (nolock)    
 where sauda_date>=@fdate and sauda_date<=@tdate    
 group by branch_cd --order by branch_cd    
 ) a    
 left outer join    
 (select  branch,    
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),    
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),    
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),    
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),    
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),  
 Net=sum(angel_share)     
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate    
 group by branch) b    
 on  a.branch_cd=b.branch order by branch_cd    
End    
if @user='REGION' and @BrOrSB='%'    
BEGIN    
    
 select a.*,angel_net_bse,angel_net_nse,angel_net_fo,angel_net_mcx,angel_net_ncx,net    
  from    
 (select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), total_br=isnull(sum(bse_br+EBse_br+nse_br+ 
 
ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
  from ebrok_tobr_period (nolock)    
 where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch_cd in (select code from risk.dbo.region where reg_code=@code)     
 group by branch_cd --order by branch_cd    
 ) a    
 left outer join    
 (select  branch,    
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),    
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),    
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),    
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),    
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),  
 Net=sum(angel_share)     
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch in (select code from risk.dbo.region where reg_code=@code)     
 group by branch) b    
 on  a.branch_cd=b.branch order by branch_cd    
End    
    
if @user='BRMAST' and @BrOrSB='%'    
BEGIN    
    
 select a.*,angel_net_bse,angel_net_nse,angel_net_fo,angel_net_mcx,angel_net_ncx,net    
  from    
 (select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), total_br=isnull(sum(bse_br+EBse_br+nse_br+
ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
  from ebrok_tobr_period (nolock)    
 where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch_cd in (select branch_cd from risk.dbo.branch_master where brmast_Cd=@code)     
 group by branch_cd --order by branch_cd    
 ) a    
 left outer join    
 (select  branch,    
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),    
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),    
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),    
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),    
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end) ,  
 Net=sum(angel_share)    
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch in (select branch_cd from risk.dbo.branch_master where brmast_Cd=@code)     
 group by branch) b    
 on  a.branch_cd=b.branch order by branch_cd    
End    
    
if @user='BRANCH' and @BrOrSB='%'    
BEGIN    
    
 select a.*,angel_net_bse,angel_net_nse,angel_net_fo,angel_net_mcx,angel_net_ncx,net    
  from    
 (select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), total_br=isnull(sum(bse_br+EBse_br+nse_br+
ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
  from ebrok_tobr_period (nolock)    
 where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch_cd =@code     
 group by branch_cd --order by branch_cd   
 ) a    
 left outer join    
 (select  branch,    
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),    
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),    
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),    
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),    
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),  
 Net=sum(angel_share)     
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate    
 and branch =@code     
 group by branch) b    
 on  a.branch_cd=b.branch order by branch_cd    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CTCL_TO_BRK
-- --------------------------------------------------
CREATE procedure CTCL_TO_BRK(@fdate as varchar(25),@tdate as varchar(25))
as

set nocount on

select * into #file1 
from mis_To 
where sauda_date >= @fdate and sauda_Date <=@tdate

select top 0 * into #temp_ctcl from CTCL_TO 

insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a, 
(select distinct branch,segment='ABLCM',boltno=bse from testdb.dbo.ctcl_bolt1) b

insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a, 
(select distinct branch,segment='ACDLCM',boltno=nsecm from testdb.dbo.ctcl_bolt1) b

insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a, 
(select distinct branch,segment='ACDLFO',boltno=nsefo from testdb.dbo.ctcl_bolt1) b

insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a, 
(select distinct branch,segment='ACPLMCX',boltno=mcx from testdb.dbo.ctcl_bolt1) b

insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a, 
(select distinct branch,segment='ACPLNCDEX',boltno=ncdex from testdb.dbo.ctcl_bolt1) b


update #temp_Ctcl set bse_to=b.bse_to, bse_br=b.bse_br from
(
select b.branch,sauda_date,terminal_id,company,
BSE_TO=sum(turnover),
BSE_BR=sum(brokerage)
from #file1 a, (select * from testdb.dbo.ctcl_bolt1) b 
where company='ABLCM' and a.terminal_id=b.bse
group by b.branch,sauda_date,terminal_id,company
) b where #temp_Ctcl.branch=b.branch 
and #temp_Ctcl.sauda_Date=b.sauda_date
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id 
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company


update #temp_Ctcl set nse_to=b.nse_to, nse_br=b.nse_br from
(
select b.branch,sauda_date,terminal_id,company,
NSE_TO=sum(turnover),
NSE_BR=sum(brokerage)
from #file1 a, (select distinct branch,nsecm from testdb.dbo.ctcl_bolt1) b 
where company='ACDLCM' and a.terminal_id=b.nsecm
group by b.branch,sauda_date,terminal_id,company
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id 
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company


update #temp_Ctcl set fo_to=b.fo_to, fo_br=b.fo_br from
(
select b.branch,sauda_date,terminal_id,company,
fo_TO=sum(turnover),
fo_BR=sum(brokerage)
from #file1 a, (select distinct branch,nsefo from testdb.dbo.ctcl_bolt1) b 
where company='ACDLFO' and a.terminal_id=b.nsefo
group by b.branch,sauda_date,terminal_id,company
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id 
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company


update #temp_Ctcl set mcx_to=b.mcx_to, mcx_br=b.mcx_br from
(
select b.branch,sauda_date,terminal_id,company,
mcx_TO=sum(turnover),
mcx_BR=sum(brokerage)
from #file1 a, (select distinct branch,mcx from testdb.dbo.ctcl_bolt1) b 
where company='ACPLMCX' and a.terminal_id=b.mcx
group by b.branch,sauda_date,terminal_id,company
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id 
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company

update #temp_Ctcl set ncdex_to=b.ncdex_to, ncdex_br=b.ncdex_br from
(
select b.branch,sauda_date,terminal_id,company,
ncdex_TO=sum(turnover),
ncdex_BR=sum(brokerage)
from #file1 a, (select distinct branch,ncdex from testdb.dbo.ctcl_bolt1) b 
where company='ACPLNCDEX' and a.terminal_id=b.ncdex
group by b.branch,sauda_date,terminal_id,company
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id 
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company

update #temp_Ctcl set bse_to = 0 where bse_to is null
update #temp_Ctcl set bse_br = 0 where bse_br is null
update #temp_Ctcl set nse_to = 0 where nse_to is null
update #temp_Ctcl set nse_br = 0 where nse_br is null
update #temp_Ctcl set fo_to = 0 where fo_to is null
update #temp_Ctcl set fo_br = 0 where fo_br is null
update #temp_Ctcl set mcx_to = 0 where mcx_to is null
update #temp_Ctcl set mcx_br = 0 where mcx_br is null
update #temp_Ctcl set ncdex_to = 0 where ncdex_to is null
update #temp_Ctcl set ncdex_br = 0 where ncdex_br is null

delete from ctcl_to where sauda_date >=@fdate and sauda_date<=@tdate
insert into ctcl_to select * from #temp_Ctcl 

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CTCL_TO_BRK_auto
-- --------------------------------------------------
CREATE procedure CTCL_TO_BRK_auto      
as        
        
set nocount on        
      
declare @fdate as varchar(25), @tdate as varchar(25)      
set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'      
set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'      
 --print @fdate       
select * into #file1         
from mis_To         
where sauda_date >= @fdate and sauda_Date <=@tdate        
        
select top 0 * into #temp_ctcl from CTCL_TO         
        
insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)        
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a,         
(select distinct branch,segment='ABLCM',boltno=bse from testdb.dbo.ctcl_bolt1) b        
        
insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)        
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a,         
(select distinct branch,segment='ACDLCM',boltno=nsecm from testdb.dbo.ctcl_bolt1) b        
        
insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)        
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a,         
(select distinct branch,segment='ACDLFO',boltno=nsefo from testdb.dbo.ctcl_bolt1) b        
        
insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)        
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a,         
(select distinct branch,segment='ACPLMCX',boltno=mcx from testdb.dbo.ctcl_bolt1) b        
        
insert into #temp_ctcl (branch,segment,teminal_no,sauda_Date)        
select b.branch,b.segment,boltno,sauda_date from (select distinct sauda_DAte from #file1) a,         
(select distinct branch,segment='ACPLNCDEX',boltno=ncdex from testdb.dbo.ctcl_bolt1) b        
        
        
update #temp_Ctcl set bse_to=b.bse_to, bse_br=b.bse_br from        
(        
select b.branch,sauda_date,terminal_id,company,        
BSE_TO=sum(turnover),        
BSE_BR=sum(brokerage)        
from #file1 a, (select * from testdb.dbo.ctcl_bolt1) b         
where company='ABLCM' and a.terminal_id=b.bse        
group by b.branch,sauda_date,terminal_id,company        
) b where #temp_Ctcl.branch=b.branch         
and #temp_Ctcl.sauda_Date=b.sauda_date        
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id         
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company        
        
        
update #temp_Ctcl set nse_to=b.nse_to, nse_br=b.nse_br from        
(        
select b.branch,sauda_date,terminal_id,company,        
NSE_TO=sum(turnover),        
NSE_BR=sum(brokerage)        
from #file1 a, (select distinct branch,nsecm from testdb.dbo.ctcl_bolt1) b         
where company='ACDLCM' and a.terminal_id=b.nsecm        
group by b.branch,sauda_date,terminal_id,company        
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date        
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id         
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company        
        
        
update #temp_Ctcl set fo_to=b.fo_to, fo_br=b.fo_br from        
(        
select b.branch,sauda_date,terminal_id,company,        
fo_TO=sum(turnover),        
fo_BR=sum(brokerage)        
from #file1 a, (select distinct branch,nsefo from testdb.dbo.ctcl_bolt1) b         
where company='ACDLFO' and a.terminal_id=b.nsefo        
group by b.branch,sauda_date,terminal_id,company        
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date        
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id         
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company        
        
        
update #temp_Ctcl set mcx_to=b.mcx_to, mcx_br=b.mcx_br from        
(        
select b.branch,sauda_date,terminal_id,company,        
mcx_TO=sum(turnover),        
mcx_BR=sum(brokerage)        
from #file1 a, (select distinct branch,mcx from testdb.dbo.ctcl_bolt1) b      
where company='ACPLMCX' and a.terminal_id=b.mcx        
group by b.branch,sauda_date,terminal_id,company        
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date        
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id         
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company        
        
update #temp_Ctcl set ncdex_to=b.ncdex_to, ncdex_br=b.ncdex_br from        
(        
select b.branch,sauda_date,terminal_id,company,        
ncdex_TO=sum(turnover),        
ncdex_BR=sum(brokerage)        
from #file1 a, (select distinct branch,ncdex from testdb.dbo.ctcl_bolt1) b         
where company='ACPLNCDEX' and a.terminal_id=b.ncdex        
group by b.branch,sauda_date,terminal_id,company        
) b where #temp_Ctcl.branch=b.branch and #temp_Ctcl.sauda_Date=b.sauda_date        
and #temp_Ctcl.teminal_no collate SQL_Latin1_General_CP1_CI_AS =b.terminal_id         
and #temp_Ctcl.segment collate SQL_Latin1_General_CP1_CI_AS  =b.company        
        
update #temp_Ctcl set bse_to = 0 where bse_to is null        
update #temp_Ctcl set bse_br = 0 where bse_br is null        
update #temp_Ctcl set nse_to = 0 where nse_to is null        
update #temp_Ctcl set nse_br = 0 where nse_br is null        
update #temp_Ctcl set fo_to = 0 where fo_to is null        
update #temp_Ctcl set fo_br = 0 where fo_br is null        
update #temp_Ctcl set mcx_to = 0 where mcx_to is null        
update #temp_Ctcl set mcx_br = 0 where mcx_br is null        
update #temp_Ctcl set ncdex_to = 0 where ncdex_to is null        
update #temp_Ctcl set ncdex_br = 0 where ncdex_br is null        
        
delete from ctcl_to where sauda_date >=@fdate and sauda_date<=@tdate        
insert into ctcl_to select * from #temp_Ctcl         
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.daily_Mis_brokerage
-- --------------------------------------------------
CREATE Procedure daily_Mis_brokerage(@fdate as varchar(11),@tdate as varchar(11),@flag as varchar(2)
,@EntityCode as varchar(15),        
@FilterEntity as varchar(15),        
@access_code as varchar(15),@access_to AS varchar(15))                                
as                                                            

---------------datewise ---------------
Set Nocount On                                
  
/*declare @fdate as varchar(11),@tdate as varchar(11), @flag as varchar(15)         
@EntityCode as varchar(15),        
@FilterEntity as varchar(15),        
@access_to as varchar(10),        
@access_code as varchar(10)        
   
Set @flag='d'     
set @fdate ='01 apr 2010'        
set @tdate ='04 apr 2010'        
set @EntityCode ='%'        
set @FilterEntity ='zone'        
set @access_to ='broker'        
set @access_code ='cso'   */

select segment=company,sauda_date,party_code,zone=space(10),region=space(10),branch=space(10),sb=space(10),
to_del_opt=(case when company in ('ABLCM','ACDLCM') then sum(to_del_opt) else 0 end),    
to_trd_fut=(case when company in ('ABLCM','ACDLCM') then sum(to_trd_fut) else 0 end),    
turnover=sum(turnover),    
bk_del_opt=(case when company in ('ABLCM','ACDLCM') then sum(bk_del_opt) else 0 end),    
bk_trd_fut=(case when company in ('ABLCM','ACDLCM') then sum(bk_trd_fut) else 0 end),    
brokerage=sum(brokerage),    
net_del=convert(money,0),    
net_trd=convert(money,0),    
net=convert(money,0) ,  
net_frnch=convert(money,0)  
into #file     
from mis_to    
where sauda_date>=@fdate and sauda_date<=@tdate    
group by sauda_date,company,party_code   

update #file set  zone=i.zone,region=i.region,branch=i.branch,sb=i.sb from risk.dbo.Vw_RMS_Client_Vertical1 i              
where party_code=client COLLATE SQL_Latin1_General_CP1_CI_As

        
declare @condition as varchar(1000)        
if @access_to='SB'                                                                       
begin                      
set @condition = ' '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''               
end                                                                              
if @access_to='BROKER'                                                                                        
begin             
set @condition = ' '+@FilterEntity+' like '''+@EntityCode+''''                                                                         
end                                                        
if(@access_to='BRANCH')                                                        
begin           
set @condition = ' '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''          
end                                                        
if(@access_to='BRMAST')                    
begin                   
set @condition = '  Branch in (select branch_cd collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.branch_master where brmast_cd= '''+@access_code+''')'          
end                                                     
if(@access_to='REGION')                                                        
begin                         
set @condition = ' branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.REGION where REG_CODE= '''+@access_code+''')'          
end                                      
if(@access_to='SBMAST')                    
begin              
set @condition = ' SB in (select sub_broker collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.sb_master where sbmast_cd=  '''+@access_code+''')'                     
end           
       
select top 0 segment,sauda_date,to_del_opt,to_trd_fut,turnover,bk_del_opt,bk_trd_fut,brokerage,net_del,net_trd,net,net_frnch into #file1 from #file 
                  
declare @sql1 as varchar(750)                               
set @sql1='
select segment,sauda_date,    
to_del_opt=sum(to_del_opt) ,    
to_trd_fut=sum(to_trd_fut) ,    
turnover=sum(turnover),    
bk_del_opt=sum(bk_del_opt) ,    
bk_trd_fut=sum(bk_trd_fut) ,    
brokerage=sum(brokerage),    
net_del=convert(money,0),    
net_trd=convert(money,0),    
net=convert(money,0),
net_frnch=convert(money,0)
from #file    
where '+@condition+'
group by sauda_date,segment'  
  
insert into #file1 exec (@sql1)
     
update #file1 set segment='ACPLNCDX' where segment='ACPLNCDEX'    
    
select segment, sauda_date,    
brok_earned=sum(brok_earned),    
angel_share=sum(angel_share),
Fran_Share=sum(Fran_Share)        
into #file2     
from mis.remisior.dbo.comb_co    
where sauda_date>=@fdate and sauda_date<=@tdate    
group by sauda_date,segment    
    
update #file1 set net=b.angel_share     
from (select * from #file2 )b     
where #File1.sauda_date=b.sauda_date and #file1.segment=b.segment and #file1.segment not in ('ABLCM','ACDLCM')    
    
update #file1 set net_trd=b.angel_share     
from (select * from #file2 )b     
where #File1.sauda_date=b.sauda_date and #file1.segment in ('ABLCM','ACDLCM')  and #file1.segment=b.segment  
    
UPDATE #FILE1 SET net_del=(net_trd*((bk_del_opt*100)/(bk_del_opt+bk_trd_fut)))/100                                
FROM #FILE1 WHERE (bk_del_opt+bk_trd_fut) > 0 and segment in ('ABLCM','ACDLCM')                              
    
update #file1 set net_trd=net_trd-net_del   
WHERE (bk_del_opt+bk_trd_fut) > 0  and segment in ('ABLCM','ACDLCM')    
    
update #file1 set net=net_del+ net_trd  where segment in ('ABLCM','ACDLCM')                           
    
update #file1 set net_frnch=net-Fran_Share  
from (select * from #file2 )b 
where #File1.sauda_date=b.sauda_date  and #file1.segment=b.segment  --and #file1.segment in ('ABLCM','ACDLCM')

--drop table #file2    
--drop table #file1    
--select * from #File1     
     
declare @sql as varchar(1500)    
    
if(@flag='d')    
begin    
set @sql='Set Nocount On select Date=''<a href=''''report.aspx?reportno=203&flag=s&fdate=''+convert(varchar(11),convert(datetime,sauda_date,103))+''    
&tdate=''+convert(varchar(11),convert(datetime,sauda_date,103))+''&EntityCode='+@EntityCode+'&FilterEntity='+@FilterEntity+'''''>''+convert(varchar(11),sauda_date,103)+''</a>'',    
[Turnover Delivery]=convert(decimal(15,2),sum(to_del_opt)),  
[Turnover Intraday]=convert(decimal(15,2),sum(to_trd_fut)),  
[Turnover Total]=convert(decimal(15,2),sum(turnover)),    
[GrossBrokerage Delivery]=convert(decimal(15,2),sum(bk_del_opt)),  
[GrossBrokerage Intraday]=convert(decimal(15,2),sum(bk_trd_fut)),  
[GrossBrokerage Total]=convert(decimal(15,2),sum(brokerage)),    
[NetBrokerage Delivery]=convert(decimal(15,2),sum(net_del)),  
[NetBrokerage Intraday]=convert(decimal(15,2),sum(net_trd)),  
[NetBrokerage Total]=convert(decimal(15,2),sum(net)),
[NetBrokerage After Franchisee]=convert(decimal(15,2),sum(net_frnch))     
from #File1    
group by sauda_date order by sauda_date desc Set Nocount Off'     
end    
    
exec (@sql)    
    
Set Nocount Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.daily_Mis_brokerage_overall
-- --------------------------------------------------
CREATE procedure daily_Mis_brokerage_overall(  
@FDATE as varchar(11),                                                                                                                  
@TDATE as varchar(11),                                                                        
@EntityCode as varchar(25),                                                                                
@EntityType as varchar(10),                                                                              
@FltrEntity as varchar(10),                             
@segment as varchar(15)  ,   
@flag as varchar(3),                            
@type as varchar(10),                            
@access_to as varchar(10),                                                                                
@access_code as varchar(25)  
)  
as  
/*declare                                                 
@FDATE as varchar(11),                                                                                                                  
@TDATE as varchar(11),                                                                        
@EntityCode as varchar(25),                                                                                
@EntityType as varchar(10),                                                                              
@FltrEntity as varchar(10),                             
@segment as varchar(15)  ,   
@flag as varchar(3),                            
@type as varchar(10),                            
@access_to as varchar(10),                                                                                
@access_code as varchar(25)                                               
            
set @FDATE ='jun 24 2010'                                                                                                             
set @TDATE='jun 28 2010'                                                                     
set @EntityCode='%'                                                                        
set @EntityType='client'                                                                        
set @FltrEntity='client'                             
set @segment='%'            
set @flag='o'                    
set @type='b2b'                               
set @access_to ='broker'                                                                        
set @access_code ='cso'  */ 
  
Set Nocount On                                   
  
--declare @FDATE as varchar(11),@TDATE as varchar(11)                                                 
--set @FDATE=convert(varchar(11),convert(datetime,@FDATE,103))                                                                                               
--set @TDATE=convert(varchar(11),convert(datetime,@TDATE,103))                                                                                                                                 
  
select segment=company,sauda_date,client=party_code,zone=space(10),region=space(10),branch=space(10),sb=space(10),  
to_del_opt=(case when company in ('ABLCM','ACDLCM') then sum(to_del_opt) else 0 end),      
to_trd_fut=(case when company in ('ABLCM','ACDLCM') then sum(to_trd_fut) else 0 end),      
turnover=sum(turnover),      
bk_del_opt=(case when company in ('ABLCM','ACDLCM') then sum(bk_del_opt) else 0 end),      
bk_trd_fut=(case when company in ('ABLCM','ACDLCM') then sum(bk_trd_fut) else 0 end),      
brokerage=sum(brokerage),      
net_del=convert(money,0),      
net_trd=convert(money,0),      
net=convert(money,0) ,    
net_frnch=convert(money,0)    
into #file       
from mis_to      
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,company,party_code     
  
update #file set  zone=i.zone,region=i.region,branch=i.branch,sb=i.sb from risk.dbo.Vw_RMS_Client_Vertical1 i                
where #file.client=i.client COLLATE SQL_Latin1_General_CP1_CI_As  
  
update #file set segment='ACPLNCDX' where segment='ACPLNCDEX'      
  
--------------BSE --------------------  
select segment,sauda_date,party_code,  
brok_earned=sum(brok_earned),      
angel_share=sum(angel_share),  
Fran_Share=sum(Fran_Share)    
into #fileBSE  
from mis.remisior.dbo.BSECM_cli   
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,segment,party_code      
  
--update #file set net=b.angel_share       
--from (select * from #fileBSE )b       
--where #file.sauda_date=b.sauda_date and #file.segment='ABLCM' and #file.party_code=b.party_code  
      
update #file set net_trd=b.angel_share       
from (select * from #fileBSE )b       
where #file.sauda_date=b.sauda_date and #file.segment='ABLCM' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
      
UPDATE #file SET net_del=(net_trd*((bk_del_opt*100)/(bk_del_opt+bk_trd_fut)))/100                                  
FROM #file WHERE (bk_del_opt+bk_trd_fut) > 0 and #file.segment='ABLCM'                            
      
update #file set net_trd=net_trd-net_del     
WHERE (bk_del_opt+bk_trd_fut) > 0  and #file.segment='ABLCM'   
      
update #file set net=net_del+ net_trd  where #file.segment='ABLCM'                         
      
update #file set net_frnch=net-Fran_Share    
from (select * from #fileBSE )b   
where #file.sauda_date=b.sauda_date  and  #file.segment='ABLCM' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
 --and #file.segment in ('ABLCM','ACDLCM')  
  
-----------NSE -----------------------  
select segment,sauda_date,party_code,  
brok_earned=sum(brok_earned),      
angel_share=sum(angel_share),  
Fran_Share=sum(Fran_Share)    
into #fileNSE  
from mis.remisior.dbo.NSECM_cli   
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,segment,party_code    
  
update #file set net_trd=b.angel_share       
from (select * from #fileNSE )b       
where #file.sauda_date=b.sauda_date and #file.segment='ACDLCM' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As   
      
UPDATE #file SET net_del=(net_trd*((bk_del_opt*100)/(bk_del_opt+bk_trd_fut)))/100                                  
FROM #file WHERE (bk_del_opt+bk_trd_fut) > 0 and #file.segment='ACDLCM'                            
      
update #file set net_trd=net_trd-net_del     
WHERE (bk_del_opt+bk_trd_fut) > 0  and #file.segment='ACDLCM'   
      
update #file set net=net_del+ net_trd  where #file.segment='ACDLCM'                         
      
update #file set net_frnch=net-Fran_Share    
from (select * from #fileNSE )b   
where #file.sauda_date=b.sauda_date  and  #file.segment='ACDLCM' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
  
-----------FO -----------------------  
select segment,sauda_date,party_code,  
brok_earned=sum(brok_earned),      
angel_share=sum(angel_share),  
Fran_Share=sum(Fran_Share)    
into #fileFO  
from mis.remisior.dbo.NSEFO_cli   
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,segment,party_code    
  
update #file set net=b.angel_share       
from (select * from #fileFO )b       
where #file.sauda_date=b.sauda_date and #file.segment='ACDLFO' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As                   
      
update #file set net_frnch=net-Fran_Share    
from (select * from #fileFO )b   
where #file.sauda_date=b.sauda_date  and  #file.segment='ACDLFO' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
  
-----------MCDX -----------------------  
select segment,sauda_date,party_code,  
brok_earned=sum(brok_earned),      
angel_share=sum(angel_share),  
Fran_Share=sum(Fran_Share)    
into #fileMCDX  
from mis.remisior.dbo.MCDX_cli   
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,segment,party_code    
  
update #file set net=b.angel_share       
from (select * from #fileMCDX )b       
where #file.sauda_date=b.sauda_date and #file.segment='ACPLMCX' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As                   
      
update #file set net_frnch=net-Fran_Share    
from (select * from #fileMCDX )b   
where #file.sauda_date=b.sauda_date  and  #file.segment='ACPLMCX' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
  
-----------NCDX -----------------------  
select segment,sauda_date,party_code,  
brok_earned=sum(brok_earned),      
angel_share=sum(angel_share),  
Fran_Share=sum(Fran_Share)    
into #fileNCDX  
from mis.remisior.dbo.NCDX_cli   
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,segment,party_code    
  
update #file set net=b.angel_share       
from (select * from #fileNCDX )b       
where #file.sauda_date=b.sauda_date and #file.segment='ACPLNCDX' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As               
      
update #file set net_frnch=net-Fran_Share    
from (select * from #fileNCDX )b   
where #file.sauda_date=b.sauda_date  and  #file.segment='ACPLNCDX' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
  
-----------MCD -----------------------  
select segment,sauda_date,party_code,  
brok_earned=sum(brok_earned),      
angel_share=sum(angel_share),  
Fran_Share=sum(Fran_Share)    
into #fileMCD  
from mis.remisior.dbo.MCD_cli   
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,segment,party_code    
  
update #file set net=b.angel_share       
from (select * from #fileMCD )b       
where #file.sauda_date=b.sauda_date and #file.segment='ACPLMCD' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As                  
      
update #file set net_frnch=net-Fran_Share    
from (select * from #fileMCD )b   
where #file.sauda_date=b.sauda_date  and  #file.segment='ACPLMCD' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
  
-----------NSX_cli -----------------------  
select segment,sauda_date,party_code,  
brok_earned=sum(brok_earned),      
angel_share=sum(angel_share),  
Fran_Share=sum(Fran_Share)    
into #fileNSX  
from mis.remisior.dbo.NSX_cli   
where sauda_date>=@fdate and sauda_date<=@tdate      
group by sauda_date,segment,party_code    
  
update #file set net=b.angel_share       
from (select * from #fileNSX )b       
where #file.sauda_date=b.sauda_date and #file.segment='ACDLNSX' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As                   
      
update #file set net_frnch=net-Fran_Share    
from (select * from #fileNSX )b   
where #file.sauda_date=b.sauda_date  and  #file.segment='ACDLNSX' and #file.client=b.party_code  COLLATE SQL_Latin1_General_CP1_CI_As  
  
---------------------------------------------------------------------------------  
  
declare @filename as varchar(200)                                                                                                          
set @filename = '#file v'                          
  
------------------------------------------------------------------------- Datasource Filtering                             
declare @Source as varchar(5000),@DataFltr as varchar(500),@DataFltr1 as varchar(500)                    
set @Source =''                              
set @DataFltr = ''                         
set @DataFltr1 = ''                                      
if @flag='O'                                                        
BEGIN                                        
 set @DataFltr = ' sauda_date>= '''+CONVERT(VARCHAR(15),@FDATE)+''' and sauda_date<= '''+CONVERT(VARCHAR(15),@TDATE)+''' and segment like '''+@segment+''''                                                                                    
END                                          
ELSE                                        
BEGIN                                        
 set @DataFltr = ' sauda_date>= '''+CONVERT(VARCHAR(15),@FDATE)+''' and sauda_date<= '''+CONVERT(VARCHAR(15),@TDATE)+''' and segment like '''+@segment+''''                                                                                    
END                                        
                                  
if @type='B2B'                                                        
BEGIN                                        
 set @DataFltr1 = ' Sb not in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1)'                                                                                    
END                                          
ELSE if @type='B2C'                                       
BEGIN                                        
 set @DataFltr1 = ' Sb in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1)'                                                                                    
END                                  
Else                                  
BEGIN                                        
 set @DataFltr1 = ' Sb like ''%'''                                                                                    
END       
  
  
if @access_to='SB'                                            
begin                                            
set @Source = '(select v.* from '+@filename+' where  '+@DataFltr+' and '+@DataFltr1+'  and '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''')'         
end                
if @access_to='BROKER'                                                                                  
begin                                                                      
 set @Source = '(select v.* from '+@filename+' where '+@DataFltr+' and '+@DataFltr1+'  and '+@FltrEntity+' like '''+@EntityCode+''')'                                                                                  
end                
if(@access_to='BRANCH')                                                  
begin                
 select  @Source = '(select v.* from '+@filename+' where '+@DataFltr+' and '+@DataFltr1+'  and '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''')'                                                  
end                                                  
if(@access_to='BRMAST')              
begin                   
select  @Source = '(select v.* from '+@filename+' where '+@DataFltr+' and '+@DataFltr1+'  and '+@FltrEntity+' like '''+@EntityCode+''' and  '+@EntityType+' in (select branch_cd COLLATE SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master   
 where brmast_cd= '''+@access_code+'''))'                                                  
end                                                   
if(@access_to='REGION')                                                  
begin                   
select  @Source = '(select v.* from '+@filename+' where '+@DataFltr+' and '+@DataFltr1+'  and  '+@EntityType+' in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION where REG_CODE= '''+@access_code+'''))'         
end                                             
if(@access_to='SBMAST')              
begin                   
select  @Source = '(select v.* from '+@filename+' where '+@DataFltr+' and '+@DataFltr1+'  and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master where sbmast_cd= '''+@access_code+'''))'                                       
end                                                      
  
--------------------------------------------------------------------------------                                                
declare @QryPreFix varchar(1000),@QryPostFix varchar(500),@FtQryPreFix varchar(500),@FtQryPostFix varchar(500),@lupd varchar(500),@dis varchar(250)                                                                                 
set @QryPreFix =''                                                                                  
set @QryPostFix =''                                                                                  
set @FtQryPreFix =''                                                                                  
set @FtQryPostFix =''                                                              
set @lupd =''                                                   
                          
if @flag='O'                              
begin             
 if @EntityType='ZONE'                                                                                  
 begin                                                            
  set @QryPreFix =' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb Select Zone=''<a href=''''report.aspx?reportno=328'                                                                                
  set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                                                  
  set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                                            
  set @QryPreFix =@QryPreFix+'&EntityCode=''+zone+''&EntityType=REGION'                                                                                
  set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'&flag='+@flag+'&type='+@type+'''''>''+zone+''</a>'','                                                                   
   
                
  set @QryPostFix = ' group by zone '                  
                
  set @dis='select Zone='' '',[Zone Name]=''Total'','                                                                                
 end                                                
                                                 
 if @EntityType='REGION'                                                                                  
 begin                                                                          
  set @QryPreFix = 'select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb Select Zone, '                                                                                  
  set @QryPreFix =@QryPreFix+' REGION=''<a href=''''report.aspx?reportno=328'                                                                                
  set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                       
  set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                                                           
  set @QryPreFix =@QryPreFix+'&EntityCode=''+region+''&EntityType=BRANCH'                                                            
  set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'&flag='+@flag+'&type='+@type+'''''>''+REGION+''</a>'','         
  set @QryPostFix = ' group by Zone,Region '                    
                
  set @dis= 'select Zone='' '',REGION=''Total'','                
 end                                                
                                                 
 if @EntityType='BRANCH'                                                         
 begin                                                                            
  set @QryPreFix = 'select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb Select Region, '                                   
  set @QryPreFix =@QryPreFix+' BRANCH=''<a href=''''report.aspx?reportno=328'                                                                                
  set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                                                  
  set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                                                     
  set @QryPreFix =@QryPreFix+'&EntityCode=''+branch+''&EntityType=SB'                                                                        
  set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'&flag='+@flag+'&type='+@type+'''''>''+BRANCH+''</a>'','                                                  
              
  set @QryPostFix = ' group by Region,BRANCH '                    
                
  set @dis = 'select Region='' '',BRANCH=''Total '','                                                                           
 end                                                
                                                 
 if @EntityType='SB'                                                              
 begin                                                                                  
  set @QryPreFix = 'select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb Select Region,Branch,[Type]=case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end, '                                      
                                        
      
  set @QryPreFix =@QryPreFix+' SB=''<a href=''''report.aspx?reportno=328'                                                                                
  set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                                                  
  set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                                                                  
  set @QryPreFix =@QryPreFix+'&EntityCode=''+SB+''&EntityType=CLIENT'                                                                  
  set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'&flag='+@flag+'&type='+@type+'''''>''+SB+''</a>'','                                                                     
                                                                     
  set @QryPostFix = ' group by Region,Branch,SB '                
                
  set @dis= 'select Region='' '',Branch='' '',Type='' '',SB=''Total'','                                                            
 end                                                
                                                 
 if @EntityType='CLIENT'                                                                                   
 begin                                                                                  
  set @QryPreFix = 'select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb Select Region,Branch,[Type]=case when SB in (select B2C_SB  collate SQL_Latin1_General_CP1_CI_AS  from #file1) then ''B2C'' else ''B2B'' end,client, '                              
                                         
             
                                                                                
  set @QryPostFix = ' group by Region,Branch,sb,client '                  
                
  set @dis='select Region='' '',Branch='' '',Type='' '',client=''Total'','                          
 end                            
end                                              
                          
  
-------------------------------------------------------                                                
DECLARE @grpname as varchar(15),@FinSumm as varchar(5000),@FinSumm1 as varchar(5000),@Seq as int                                                                                    
                                                                                  
set @FinSumm = ' '                    
set @FinSumm =  @FinSumm + '[Turnover<br>Delivery]=convert(decimal(15,2),sum(to_del_opt)),  
[Turnover<br>Intraday]=convert(decimal(15,2),sum(to_trd_fut)),  
[Turnover<br>Total]=convert(decimal(15,2),sum(turnover)),    
[Gross<br>Brokerage<br>Delivery]=convert(decimal(15,2),sum(bk_del_opt)),  
[Gross<br>Brokerage<br>Intraday]=convert(decimal(15,2),sum(bk_trd_fut)),  
[Gross<br>Brokerage<br>Total]=convert(decimal(15,2),sum(brokerage)),    
[Net<br>Brokerage<br>Delivery]=convert(decimal(15,2),sum(net_del)),  
[Net<br>Brokerage<br>Intraday]=convert(decimal(15,2),sum(net_trd)),  
[Net<br>Brokerage<br>Total]=convert(decimal(15,2),sum(net)),  
[NetBrokerage<br>After<br>Franchisee]=convert(decimal(15,2),sum(net_frnch))     
into #OPFile from '+@Source +' a '  
  
set @FinSumm = @QryPreFix+@FinSumm+@QryPostFix+' SELECT * FROM #OPFILE '                              
  
exec(@FinSumm)  
                                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.daily_Mis_brokerage_segment
-- --------------------------------------------------

CREATE Procedure daily_Mis_brokerage_segment(@flag as varchar(2),@fdate as varchar(11),@tdate as varchar(11),
@EntityCode as varchar(15),        
@FilterEntity as varchar(15),        
@access_code as varchar(15),@access_to AS varchar(15))                              
as                              
------------------- segmentwise -----------------------

Set Nocount On                            

--declare @fdate as varchar(11),@tdate as varchar(11), @flag as varchar(15)
--Set @flag='s'                           
--Set @fdate='Oct 15 2009'                            
--Set @tdate='Oct 15 2009'    


/*declare @fdate as varchar(11),@tdate as varchar(11), @flag as varchar(15)    
                               ,
--Set @fdate='Oct 31 2009'                                
--Set @tdate='Oct 31 2009'   
--@fdate as varchar(11),        
--@tdate as varchar(11),        
@EntityCode as varchar(15),        
@FilterEntity as varchar(15),        
@access_to as varchar(10),        
@access_code as varchar(10)        
   
Set @flag='s'     
set @fdate ='01 apr 2010'        
set @tdate ='05 apr 2010'        
set @EntityCode ='%'        
set @FilterEntity ='sb'        
set @access_to ='broker'        
set @access_code ='cso'  */  

select segment=company,sauda_date,party_code,zone=space(10),region=space(10),branch=space(10),sb=space(10),
to_del_opt=(case when company in ('ABLCM','ACDLCM') then sum(to_del_opt) else 0 end),    
to_trd_fut=(case when company in ('ABLCM','ACDLCM') then sum(to_trd_fut) else 0 end),    
turnover=sum(turnover),    
bk_del_opt=(case when company in ('ABLCM','ACDLCM') then sum(bk_del_opt) else 0 end),    
bk_trd_fut=(case when company in ('ABLCM','ACDLCM') then sum(bk_trd_fut) else 0 end),    
brokerage=sum(brokerage),    
net_del=convert(money,0),    
net_trd=convert(money,0),    
net=convert(money,0) ,  
net_frnch=convert(money,0)     
into #file     
from mis_to    
where sauda_date>=@fdate and sauda_date<=@tdate    
group by sauda_date,company,party_code   

update #file set  zone=i.zone,region=i.region,branch=i.branch,sb=i.sb from risk.dbo.Vw_RMS_Client_Vertical1 i              
where party_code=client COLLATE SQL_Latin1_General_CP1_CI_As
        
declare @condition as varchar(1000)        
if @access_to='SB'                                                                       
begin                      
set @condition = ' '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''               
end                                                                              
if @access_to='BROKER'                                                                                        
begin             
set @condition = ' '+@FilterEntity+' like '''+@EntityCode+''''                                                                         
end                                                        
if(@access_to='BRANCH')                                                        
begin           
set @condition = ' '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''          
end                                                        
if(@access_to='BRMAST')                    
begin                   
set @condition = '  Branch in (select branch_cd collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.branch_master where brmast_cd= '''+@access_code+''')'          
end                                                     
if(@access_to='REGION')                                                        
begin                         
set @condition = ' branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.REGION where REG_CODE= '''+@access_code+''')'          
end                                      
if(@access_to='SBMAST')                    
begin              
set @condition = ' SB in (select sub_broker collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.sb_master where sbmast_cd=  '''+@access_code+''')'                     
end           
       
select top 0 segment,sauda_date,to_del_opt,to_trd_fut,turnover,bk_del_opt,bk_trd_fut,brokerage,net_del,net_trd,net,net_frnch into #file1 from #file 
                  
declare @sql1 as varchar(750)                               
set @sql1='
select segment,sauda_date,    
to_del_opt=sum(to_del_opt) ,    
to_trd_fut=sum(to_trd_fut) ,    
turnover=sum(turnover),    
bk_del_opt=sum(bk_del_opt) ,    
bk_trd_fut=sum(bk_trd_fut) ,    
brokerage=sum(brokerage),    
net_del=convert(money,0),    
net_trd=convert(money,0),    
net=convert(money,0),
net_frnch=convert(money,0)
from #file    
where '+@condition+'
group by sauda_date,segment'  
  
insert into #file1 exec (@sql1)                        
                            
update #file1 set segment='ACPLNCDX' where segment='ACPLNCDEX'

select segment, sauda_date,
brok_earned=sum(brok_earned),
angel_share=sum(angel_share),
Fran_Share=sum(Fran_Share)
into #file2 
from mis.remisior.dbo.comb_co
where sauda_date>=@fdate and sauda_date<=@tdate
group by sauda_date,segment

update #file1 set net=b.angel_share 
from (select * from #file2 )b 
where #File1.sauda_date=b.sauda_date and #file1.segment=b.segment and #file1.segment not in ('ABLCM','ACDLCM')

update #file1 set net_trd=b.angel_share 
from (select * from #file2 )b 
where #File1.sauda_date=b.sauda_date  and #file1.segment=b.segment  and #file1.segment in ('ABLCM','ACDLCM')

UPDATE #FILE1 SET net_del=(net_trd*((bk_del_opt*100)/(bk_del_opt+bk_trd_fut)))/100                            
FROM #FILE1 WHERE (bk_del_opt+bk_trd_fut) > 0 and segment in ('ABLCM','ACDLCM')                              

update #file1 set net_trd=net_trd-net_del 
WHERE (bk_del_opt+bk_trd_fut) > 0  and segment in ('ABLCM','ACDLCM')  

update #file1 set net=net_del+ net_trd   where segment in ('ABLCM','ACDLCM')   

update #file1 set net_frnch=net-Fran_Share  
from (select * from #file2 )b 
where #File1.sauda_date=b.sauda_date  and #file1.segment=b.segment  --and #file1.segment in ('ABLCM','ACDLCM')

   

--drop table #file2
--drop table #file1
--select * from #File1 
 
declare @sql as varchar(1500)

if(@flag='s')
begin

set @sql='Set Nocount On select Date=convert(varchar(11),sauda_date,103),Segment=segment,
[Turnover Delivery]=convert(decimal(15,2),to_del_opt),[Turnover Intraday]=convert(decimal(15,2),to_trd_fut),
[Turnover Total]=convert(decimal(15,2),turnover),
[GrossBrokerage Delivery]=convert(decimal(15,2),bk_del_opt),[GrossBrokerage Intraday]=convert(decimal(15,2),bk_trd_fut),
[GrossBrokerage Total]=convert(decimal(15,2),brokerage),
[NetBrokerage Delivery]=convert(decimal(15,2),net_del),[NetBrokerage Intraday]=convert(decimal(15,2),net_trd),
[NetBrokerage Total]=convert(decimal(15,2),net),
[NetBrokerage After Franchisee]=convert(decimal(15,2),net_frnch) 
from #File1
where sauda_date>='''+@fdate+''' and sauda_date<='''+@tdate+'''  order by sauda_date desc Set Nocount Off'
--group by sauda_date,segment'
end

exec (@sql)

Set Nocount Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.daily_turnover_commodities
-- --------------------------------------------------

CREATE procedure daily_turnover_commodities      
AS      
declare @tdate as varchar(11)                                                
select @tdate=max(sauda_date) from mis.remisior.dbo.comb_co            
--------------MCX      
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement                                         
WHERE SAUDA_DATE >= @tdate  AND SAUDA_dATE <= @tdate+' 23:59:59'       
and auctionpart <> 'CA'                            
      
update #mcx set TRADEQTY=TRADEQTY*(booktype/instrument)               
      
      
SELECT SAUDA_DATE=convert(varchar(11),SAUDA_DATE),branch=space(12),sub_broker=space(12),Terminal_Id=CONVERT(VARCHAR,User_id),      
Shift=case when convert(varchar(2),SAUDA_DATE,114)>=17 then 2 else 1 end      
,no_of_trade=count(distinct Trade_no),party_code,Turnover= sum((strike_price+price)* tradeqty),       
brokerage=sum(brokapplied*tradeqty),Segment='ACPLMCX',symbol,expirydate      
into #temp_mcdx_a      
FROM #MCX      
group by convert(varchar(11),SAUDA_DATE),convert(varchar(2),SAUDA_DATE,114),User_id,party_code,symbol,expirydate      
      
      
update #temp_mcdx_a set branch=b.branch_cd,sub_broker=b.sub_broker       
from risk.dbo.client_details b where #temp_mcdx_a.party_code=b.party_code      
      
delete from  mis_to_Shift where SAUDA_DATE >= @tdate  AND SAUDA_dATE <= @tdate+' 23:59:59'    and segment='ACPLMCX'      
insert into mis_to_Shift      
  
select *   from #temp_mcdx_a      
--------------NCDEX      
SELECT * INTO #NCDX FROM  angelcommodity.ncdx.DBO.FOsettlement                                         
WHERE SAUDA_DATE >= @tdate  AND SAUDA_dATE <= @tdate+' 23:59:59'         
and auctionpart <> 'CA'               
      
update #ncdx set TRADEQTY=TRADEQTY*(booktype/instrument)               
      
      
SELECT SAUDA_DATE=convert(varchar(11),SAUDA_DATE),branch=space(12),sub_broker=space(12),      
Terminal_Id=CONVERT(VARCHAR,User_id),      
Shift=case when convert(varchar(2),SAUDA_DATE,114)>=17 then 2 else 1 end      
,no_of_trade=count(distinct Trade_no),party_code,Turnover= sum((strike_price+price)* tradeqty),       
brokerage=sum(brokapplied*tradeqty),Segment='ACDLNCDX',symbol,expirydate      
into #temp_ncdx_a      
FROM #NCDX      
group by convert(varchar(11),SAUDA_DATE),convert(varchar(2),SAUDA_DATE,114),User_id,party_code,symbol,expirydate      
      
      
update #temp_ncdx_a set branch=b.branch_cd,sub_broker=b.sub_broker       
from risk.dbo.client_details b where #temp_ncdx_a.party_code=b.party_code      
      
delete from  mis_to_Shift where SAUDA_DATE >= @tdate  AND SAUDA_dATE <= @tdate+' 23:59:59'  and segment='ACDLNCDX'      
insert into mis_to_Shift       
select *   from #temp_ncdx_a

GO

-- --------------------------------------------------
-- PROCEDURE dbo.date_to
-- --------------------------------------------------
CREATE procedure date_to(@fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10),@sbcode as varchar(10),@rep_type as varchar(10),@dayslogin as int)    
  as    
/*  
 declare @fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10),@sbcode as varchar(10),@rep_type as varchar(10),@dayslogin as int  
 set @fdate ='Jun 23 2006'  
 set @tdate ='Jun 23 2006 23:59:59:000'  
 set @brcode='%'  
 set @sbcode='%'  
 set @rep_type='two'  
 set @dayslogin=1  
*/  
  
 set transaction isolation level read uncommitted    
 set nocount on    
       
 select * into #file1 from MIS.TerminalMaster.dbo.tbl_mst_Terminals     
 where Activation_Date<=@fdate and deActivation_Date>=@tdate    
  
 select party_Code,activefrom=min(activefrom) into #act_from from  
 (  
 select party_Code,activefrom from intranet.risk.dbo.bse_client5 c5, intranet.risk.dbo.bse_client2 c2   
 where c5.cl_code=c2.cl_code  
 union all  
 select party_Code,activefrom from intranet.risk.dbo.nse_client5 c5, intranet.risk.dbo.nse_client2 c2   
 where c5.cl_code=c2.cl_code  
 union all  
 select party_Code,activefrom from intranet.risk.dbo.fo_client5 c5, intranet.risk.dbo.fo_client2 c2   
 where c5.cl_code=c2.cl_code  
 union all  
 select party_Code,activefrom from intranet.risk.dbo.mcdx_client5 c5, intranet.risk.dbo.mcdx_client2 c2   
 where c5.cl_code=c2.cl_code  
 union all  
 select party_Code,activefrom from intranet.risk.dbo.ncdx_client5 c5, intranet.risk.dbo.ncdx_client2 c2   
 where c5.cl_code=c2.cl_code  
 ) a group by party_code  
   
      
 select Sauda_Date,terminal_id,party_Code,branch_cd,sub_Broker,ABLCM_TO=sum(case when company='ABLCM' then Turnover else 0 end),  
 ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),    
 ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),    
 ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),    
 ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),    
 ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),    
 Turnover = Sum(Turnover),Brokerage = Sum(Brokerage) ,    
 Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),    
 Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),    
 ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),    
 ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end)     
 into #file2 from mis_to     
 where sauda_date>=@fdate and sauda_date<=@tdate and branch_cd like @brcode and party_code like @sbcode    
 group by sauda_date,terminal_id,party_Code,branch_cd,sub_Broker    
      
      
  if upper(@rep_type)='ONE'     
  begin    
 select sauda_Date,    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),    
 turnover=sum(turnover),brokerage=sum(Brokerage),    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn)    
 from #file2 a, #file1 b where a.sauda_DAte >= b.activation_date and a.sauda_DAte <=b.deactivation_Date    
 and a.terminal_id=b.terminal_id    
 group by sauda_Date    
 order by sauda_Date    
  end    
      
      
  if upper(@rep_type)='TWO'     
  begin    
 select branch_Cd,sub_Broker,A.party_Code,c.party_name,    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),    
 turnover=sum(turnover),brokerage=sum(Brokerage),    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),  
 nooflogin=0  
 into #file_two  
 from #file2 a, #file1 b, intranet.risk.dbo.finmast C     
 where c.party_code COLLATE Latin1_General_CI_AS=a.party_Code and a.sauda_DAte >= b.activation_date and a.sauda_DAte <=b.deactivation_Date    
 and a.terminal_id=b.terminal_id    
 group by branch_Cd,sub_Broker,A.party_Code,c.party_name    
  
/*  
 select party_Code,nooflogin=count(*) into #login from   
 (select distinct party_Code=a,dt=d from mis.dbo.versionfile  
 where convert(datetime,d)>=@fdate and convert(datetime,d)<=@tdate   
 ) a   
 group by party_Code  
 having count(*) >= @dayslogin  

*/
	select party_Code,nooflogin=count(*) into #login from 
	(select distinct party_Code,dt=login_date from loginfile
	where login_date>=@fdate and login_date<=@tdate 
	) a group by party_Code having count(*) >= @dayslogin

  
 insert into #file_two   
 select branch_Cd=sbtag,sub_Broker=subgroup,A.party_Code   
 ,c.party_name,  
 ablcm_to=convert(money,0),acdlcm_to=convert(money,0),acdlfo_to=convert(money,0),    
 ablcm_brk=convert(money,0),acdlcm_brk=convert(money,0),acdlfo_brk=convert(money,0),    
 turnover=convert(money,0),brokerage=convert(money,0),mcx_turn=convert(money,0),  
 mcx_brok=convert(money,0),ncdx_brok=convert(money,0),ncdx_turn=convert(money,0),nooflogin=0  
 from #login a,  
 intranet.risk.dbo.finmast c where a.party_code collate Latin1_General_CI_AS   
 not in (select party_Code from #file_two)  
   
 update #file_two set nooflogin=isnull(b.nooflogin,0)  from #login b   
 where #file_two.party_Code=b.party_code collate Latin1_General_CI_AS  
  
 select a.*,activefrom=isnull(b.activefrom,'Jan 01 1900')   
 from #file_two a left outer join #act_from b   
 on a.party_Code=b.party_code collate Latin1_General_CI_AS  
 order by A.party_Code    
  
  
  
  end    
     
  
    
 set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Datewiseclient
-- --------------------------------------------------
CREATE procedure Datewiseclient (@fd as varchar(11),@td as varchar(11)) as
 Declare @daydiff int
 set @daydiff=datediff(dd,@fd,@td)

if @daydiff>7 
print 'change ur date range '+ cast(@daydiff as varchar(10))
else
print 'Date range is valid '+  cast(@daydiff as varchar(10))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DB_TblSize
-- --------------------------------------------------
create procedure DB_TblSize
as

set nocount on

-- Table row counts and sizes.
CREATE TABLE #t 
( 
    [name] NVARCHAR(128),
    [rows] CHAR(11),
    reserved VARCHAR(18), 
    data VARCHAR(18), 
    index_size VARCHAR(18),
    unused VARCHAR(18)
) 

INSERT #t EXEC sp_msForEachTable 'EXEC sp_spaceused ''?''' 

SELECT *
FROM   #t

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DupChq_Interseg
-- --------------------------------------------------
CREATE proc [dbo].[DupChq_Interseg]  
(  
 @strFromDate varchar(11),  
 @strToDate varchar(11)  
)  
as  
  
--dump transaction bsedb_Ab with no_log  
--begin tran  
   
 truncate table AngelDupCheque  
  
/*Exec AngelBSECM.Account_ab.Dbo.AngelDupChq_Interseg @strFromDate,@strToDate*/  
Exec AngelNseCM.Account.Dbo.AngelDupChq_Interseg @strFromDate,@strToDate  
Exec Angelfo.Accountfo.Dbo.AngelDupChq_Interseg @strFromDate,@strToDate  
  
/*Insert into AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration,     
  BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt,    
  DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'BSECM'    
  From AngelBSECM.Account_ab.Dbo.Ledger L , AngelBSECM.Account_ab.Dbo.Ledger1 L1 ,AngelBSECM.Account_ab.Dbo.Acmast A     
  Where    
  L.Vtyp = L1.Vtyp    
  And    
  L.Vno = L1.Vno    
  And    
  L.DrCr = L1.DrCr    
  And    
  L.Lno = L1.Lno    
  And     
  Vdt >= @strFromDate + ' 00:00'    
  And Vdt <= @strToDate + ' 23:59'  
  And L.CltCode = A.CltCode ) A   
  
print 'Data For BSECM has been Refreshed.'  
  
Insert into AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration,     
  BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt,    
  DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NSECM'    
  From AngelNseCM.Account.Dbo.Ledger L , AngelNseCM.Account.Dbo.Ledger1 L1 ,AngelNseCM.Account.Dbo.Acmast A     
  Where    
  L.Vtyp = L1.Vtyp    
  And    
  L.Vno = L1.Vno    
  And    
  L.DrCr = L1.DrCr    
  And    
  L.Lno = L1.Lno    
  And     
  Vdt >= @strFromDate + ' 00:00'   
  And Vdt <= @strToDate + ' 23:59'    
  And L.CltCode = A.CltCode ) A   
print 'Data For NSECM has been Refreshed.'  
  
  
Insert into AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration,     
  BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt,    
  DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NSEFO'    
  From AngelFo.AccountFo.Dbo.Ledger L , AngelFo.AccountFo.Dbo.Ledger1 L1 ,AngelFo.AccountFo.Dbo.Acmast A     
  Where    
  L.Vtyp = L1.Vtyp    
  And    
  L.Vno = L1.Vno    
  And    
  L.DrCr = L1.DrCr    
  And    
  L.Lno = L1.Lno    
  And     
  Vdt >= @strFromDate  + ' 00:00'  
  And Vdt <= @strToDate + ' 23:59'    
  And L.CltCode = A.CltCode ) A   
print 'Data For NSEFO has been Refreshed.'  
*/  
  
Insert into AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration,     
  BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt,    
  DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'MCDX'    
  From AngelCommodity.AccountMcdx.Dbo.Ledger L , AngelCommodity.AccountMcdx.Dbo.Ledger1 L1 ,AngelCommodity.AccountMcdx.Dbo.Acmast A     
  Where    
  L.Vtyp = L1.Vtyp    
  And    
  L.Vno = L1.Vno    
  And    
  L.DrCr = L1.DrCr    
  And    
  L.Lno = L1.Lno    
  And     
  Vdt >= @strFromDate + ' 00:00'   
  And Vdt <= @strToDate  + ' 23:59'   
  And L.CltCode = A.CltCode ) A   
  
print 'Data For MCDX has been Refreshed.'  
  
Insert into AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration,     
  BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt,    
  DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NCDX'    
  From AngelCommodity.AccountNcdx.Dbo.Ledger L , AngelCommodity.AccountNcdx.Dbo.Ledger1 L1 ,AngelCommodity.AccountNcdx.Dbo.Acmast A     
  Where    
  L.Vtyp = L1.Vtyp    
  And    
  L.Vno = L1.Vno    
  And    
  L.DrCr = L1.DrCr    
  And    
  L.Lno = L1.Lno    
  And     
  Vdt >= @strFromDate + ' 00:00'   
  And Vdt <= @strToDate + ' 23:59'    
  And L.CltCode = A.CltCode ) A   
print 'Data For NCDX has been Refreshed.'  
  
  
--if @@error = 0   
  --        commit else rollback tran  
  
/* exec DupChq_Interseg 'Dec  1 2005','Dec 10 2005'*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_brok_access
-- --------------------------------------------------
CREATE procedure ebrok_brok_access    
as    
    
set transaction isolation level read uncommitted    
set nocount on    
    
select distinct * into #TA from    
(    
select party_code=[user id],TA=[trading allowed] from ver7    
union    
select party_code=[user id],TA=[markets allowed] from ver6    
) a    
    
    
select party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat          
into #pty_stat1    
from              
(              
    
--select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse              
--from #filex,ver7 where  [trading allowed]=0              
    
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse              
from #ta where ta=0              
union    
select party_code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #nse              
from #ta where ta=1     
union     
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #fo              
from #ta where  ta=2              
union     
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse              
from #ta where  ta=3              
union               
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx              
from #ta where  ta=8              
union     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx              
from #ta where  ta=9              
union     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse              
from #ta where  ta=10              
union     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse              
from #ta where  ta=11              
union     
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #mcdx              
from #ta where  ta=16              
union     
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse              
from #ta where  ta=17              
union     
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse              
from #ta where  ta=18              
union     
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #ncdx              
from #ta where  ta=19              
union     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx              
from #ta where  ta=24              
union     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse              
from #ta where  ta=25              
union     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx              
from #ta where  ta=26              
union     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse              
from #ta where  ta=27              
union     
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse              
from #ta where  ta=64              
union     
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #nse              
from #ta where  ta=65              
union     
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #nse              
from #ta where  ta=66              
union     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse              
from #ta where  ta=72              
union     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #ncdx              
from #ta where  ta=73              
union     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #bse              
from #ta where  ta=75              
union     
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse              
from #ta where  ta=80              
union     
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #fo              
from #ta where  ta=81              
union     
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx              
from #ta where  ta=82              
union     
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse              
from #ta where  ta=83              
union     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx              
from #ta where  ta=88              
/* 0.0,27.0,10.0,75.0,89.0,64.0,25.0,9.0,16.0,8.0,73.0,2.0,90.0,1.0,19.0,82.0,26.0,24.0,88.0,91.0,80.0,3.0,11.0,83.0 -- ver6 */              
/* 75,83,91,66,82,90,65,19,27,73,81,11,89,3,72,18,80,26,10,88,2,17,25,9,64,1,24,16,8 -- ver7*/              
union     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse              
from #ta where  ta=89                
union     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx              
from #ta where  ta=90              
union     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse              
from #ta where  ta=91              
) a              
 group by party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat          
  
truncate table ebrok_client_access  
insert into  ebrok_client_access 
select party_code,bse_stat=max(bse_stat),nse_stat=max(nse_stat),fo_stat=max(fo_stat),
mcdx_stat=max(mcdx_stat),ncdx_stat=max(ncdx_stat) from #pty_stat1    
group by party_code
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ebrok_First_trade
-- --------------------------------------------------
CREATE Procedure Ebrok_First_trade(@fdate as varchar(11),@tdate as varchar(11))        
as        
Set Nocount On        
     
/*declare @fdate as varchar(11),@tdate as varchar(11)       
set @fdate='Jun 01 2008'       
set @tdate='Jun 21 2008'       
*/
      
Set transaction isolation level read uncommitted        
        
select b.branch_cd,b.sub_broker,a.party_code,short_name,convert(varchar(10),a.first_trade_date,103) as first_trade_date       
into #file      
from first_Etrade_date a (nolock) join risk.dbo.client_details b(nolock)         
on a.party_code collate SQL_Latin1_General_CP1_CI_AS=b.party_code         
and a.first_trade_date>=@fdate+' 00:00:00' and a.first_trade_date<=@tdate+' 23:59:59'         
--order by first_trade_date,BRANCH_CD,SUB_BROKER        
and a.party_code collate SQL_Latin1_General_CP1_CI_AS in(select party_code from ctcl.dbo.ebrok_client) order by first_trade_date,BRANCH_CD,SUB_BROKER,PARTY_CODE        
      
select a.*,firstdate=isnull(b.first_trade_date,'') into #file2 from #file a       
left outer join      
client_first_date b (nolock)      
on a.party_code collate SQL_Latin1_General_CP1_CI_AS =b.party_code      
and convert(datetime,a.first_trade_date,103)=b.first_trade_date  
where b.first_trade_date > 'Jan 01 1900'      
order by a.first_trade_date  

select a.*,b.first_active_date from #file2 a
left outer join
(select party_code,first_active_date from risk.dbo.client_details) b
on a.party_code collate SQL_Latin1_General_CP1_CI_AS =b.party_code

Set Nocount Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_login_status
-- --------------------------------------------------
CREATE procedure ebrok_login_status(@fdate as varchar(25),@tdate as varchar(25),@code as varchar(8),@user as varchar(6))
as
Set nocount on
Set transaction isolation level read uncommitted
if @code='BROKER'
begin
	select * from ebrok_log_status where sauda_date>=@fdate and sauda_date<=@tdate	
end
if @code='REGION'
begin
	select * from ebrok_log_status where sauda_date>=@fdate and sauda_date<=@tdate	
    and branch_cd in (select code from intranet.risk.dbo.region where reg_code=@user)	
end
if @code='BRMAST'
begin
	select * from ebrok_log_status where sauda_date>=@fdate and sauda_date<=@tdate	
	and branch_cd in (select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@USER)  
end
if @code='BRANCH'
begin
	select * from ebrok_log_status where sauda_date>=@fdate and sauda_date<=@tdate	
	and branch_cd=@user
end
if @code='SB'
begin
	select * from ebrok_log_status where sauda_date>=@fdate and sauda_date<=@tdate
	and sub_broker=@user
end

Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_terminal
-- --------------------------------------------------
CREATE procedure ebrok_terminal (@from_Date as varchar(25), @access_to as varchar(11), @access_code as varchar(11))      
as      
      
set nocount on      
      
if @access_to='BROKER'      
begin      
 /* declare @from_Date as varchar(25)    
  set @from_Date='22/07/2009'    
*/    
 select segment,terminal_id,servermapped      
 into #terminal      
 from mis.remisior.dbo.ebrok_terminal_master where from_Date<=convert(varchar(11),convert(datetime,@from_Date,103))      
 and to_date>=convert(varchar(11),convert(datetime,@from_Date,103))      
      
 select company,terminal_id,party_code,turnover=sum(turnover),brokerage=sum(brokerage)       
 into #Jun_162009      
 from bsedb_ab.dbo.mis_to      
 where sauda_date>=convert(varchar(11),convert(datetime,@from_Date,103))      
 and sauda_date<=convert(varchar(11),convert(datetime,@from_Date,103))      
 group by company,terminal_id,party_code      
      
 select  a.*,b.servermapped into #ebrok from #Jun_162009 a      
 join       
 #terminal b      
 on a.company=replace(b.segment,'ACPLNCDX','ACPLNCDEX') and a.terminal_id=b.terminal_id      
    
select angelclrating,party_code into #clrating from middleware.Mimansa.dbo.angelclient1    
      
 select a.*,[Client Rating]=angelclrating from #ebrok a, #clrating b    
 where a.party_code=b.party_code collate Latin1_General_CI_AS    
 order by servermapped,company,party_code      
      
end      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_trained_untrained
-- --------------------------------------------------

CREATE  proc ebrok_trained_untrained (@fdate as varchar(25),@tdate as varchar(25),@fdays as int,@tdays as int,@FLAG as varchar(5))                
as                
set nocount on    
IF @flag='a'  
begin              
select distinct name,party_code,trainingdate into #file1                 
from mis.upload.dbo.ebrok_training_temp     
where convert(datetime,trainingdate,103) >=convert(datetime,@fdate,103)      
and convert(datetime,trainingdate,103) <=convert(datetime,@tdate,103)              
                
select party_code,user_stat,brokerage,sauda_date=convert(datetime,sauda_date,103)      
 into #ff2       
from mis_ebroking_cli (nolock)      
where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays       
      
select b.party_code,fbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then brokerage else 0 end,              
fbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then brokerage else 0 end,                
tbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat='e-broking'  then brokerage else 0 end,              
tbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat<>'e-broking'  then brokerage else 0 end,              
cnt=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays  then 1 else 0 end into #file2                
from   #file1 b left outer join #ff2 a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS                
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays               
group by b.party_code,a.sauda_date,b.trainingdate,a.brokerage,a.user_stat                
                
select party_code,fbrokon=sum(fbrokon),fbrokoff=sum(fbrokoff),tbrokon=sum(tbrokon),tbrokoff=sum(tbrokoff),cnt=sum(cnt) into #file3 from #file2 group by party_code                
               
select distinct a.*,b.fbrokon,b.fbrokoff,b.tbrokon,b.tbrokoff,b.cnt into #f from #file3 b join mis.upload.dbo.ebrok_training_temp a              
on b.party_code=a.party_code order by a.party_code         
            
--delete from mis.upload.dbo.ebrok_training_temp        
select * from #f        
 end  
IF @flag='b'  
begin   
select distinct name,party_code,ebrokingdate into #file11                 
from mis.upload.dbo.ebrok_untrained_temp     
where convert(datetime,ebrokingdate,103) >=convert(datetime,@fdate,103)      
and convert(datetime,ebrokingdate,103) <=convert(datetime,@tdate,103)              
                
select party_code,user_stat,brokerage,sauda_date=convert(datetime,sauda_date,103)      
 into #ff21       
from mis_ebroking_cli (nolock)      
where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays       
      
select b.party_code,fbrokon=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103)-@fdays and sauda_date<=convert(datetime,b.ebrokingdate,103) and user_stat='e-broking' then brokerage else 0 end,              
fbrokoff=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103)-@fdays and sauda_date<=convert(datetime,b.ebrokingdate,103) and user_stat<>'e-broking' then brokerage else 0 end,                
tbrokon=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103) and sauda_date<=convert(datetime,b.ebrokingdate,103)+@tdays and user_stat='e-broking'  then brokerage else 0 end,              
tbrokoff=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103) and sauda_date<=convert(datetime,b.ebrokingdate,103)+@tdays and user_stat<>'e-broking'  then brokerage else 0 end,              
cnt=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103)-@fdays and sauda_date<=convert(datetime,b.ebrokingdate,103)+@tdays  then 1 else 0 end into #file21                
from   #file11 b left outer join #ff21 a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS                
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays               
group by b.party_code,a.sauda_date,b.ebrokingdate,a.brokerage,a.user_stat                
                
select party_code,fbrokon=sum(fbrokon),fbrokoff=sum(fbrokoff),tbrokon=sum(tbrokon),tbrokoff=sum(tbrokoff),cnt=sum(cnt) into #file31 from #file21 group by party_code                
               
select distinct a.*,b.fbrokon,b.fbrokoff,b.tbrokon,b.tbrokoff,b.cnt into #f1 from #file31 b join mis.upload.dbo.ebrok_untrained_temp a              
on b.party_code=a.party_code order by a.party_code         
            
--delete from mis.upload.dbo.ebrok_training_temp        
select *,location=mobile,product='',kycactivationdate='' from #f1   
end               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_training
-- --------------------------------------------------
CREATE  proc ebrok_training (@fdate as varchar(25),@tdate as varchar(25),@fdays as int,@tdays as int)            
as            
set nocount on            
select distinct name,party_code,trainingdate into #file1             
from mis.upload.dbo.ebrok_training_temp 
where convert(datetime,trainingdate,103) >=convert(datetime,@fdate,103)  
and convert(datetime,trainingdate,103) <=convert(datetime,@tdate,103)          
            
select party_code,user_stat,brokerage,sauda_date=convert(datetime,sauda_date,103)  
 into #ff2   
from mis_ebroking_cli (nolock)  
where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays   
  
select b.party_code,fbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then brokerage else 0 end,          
fbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then brokerage else 0 end,            
tbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat='e-broking'  then brokerage else 0 end,          
tbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat<>'e-broking'  then brokerage else 0 end,          
cnt=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays  then 1 else 0 end into #file2            
from   #file1 b left outer join #ff2 a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS            
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays           
group by b.party_code,a.sauda_date,b.trainingdate,a.brokerage,a.user_stat            
            
select party_code,fbrokon=sum(fbrokon),fbrokoff=sum(fbrokoff),tbrokon=sum(tbrokon),tbrokoff=sum(tbrokoff),cnt=sum(cnt) into #file3 from #file2 group by party_code            
           
select distinct a.*,b.fbrokon,b.fbrokoff,b.tbrokon,b.tbrokoff,b.cnt into #f from #file3 b join mis.upload.dbo.ebrok_training_temp a          
on b.party_code=a.party_code order by a.party_code     
        
--delete from mis.upload.dbo.ebrok_training_temp    
select * from #f    
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_training_temp
-- --------------------------------------------------
CREATE  proc ebrok_training_temp (@fdate as varchar(25),@tdate as varchar(25),@fdays as int,@tdays as int)          
as          
set nocount on          
select distinct name,party_code,trainingdate into #file1           
from mis.upload.dbo.ebrok_training_temp where trainingdate>=@fdate and trainingdate<=@tdate          
          
select b.party_code,fbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then brokerage else 0 end,        
fbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then brokerage else 0 end,          
tbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat='e-broking'  then brokerage else 0 end,        
tbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat<>'e-broking'  then brokerage else 0 end,        
cnt=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays  then 1 else 0 end into #file2          
from mis_ebroking_cli a (nolock) join #file1 b on a.party_code=b.party_code collate SQL_Latin1_General_CP1_CI_AS          
--where sauda_date>=@fdate-@fdays and sauda_date<=@fdate          
group by b.party_code,a.sauda_date,b.trainingdate,a.brokerage,a.user_stat          
          
select party_code,fbrokon=sum(fbrokon),fbrokoff=sum(fbrokoff),tbrokon=sum(tbrokon),tbrokoff=sum(tbrokoff),cnt=sum(cnt) into #file3 from #file2 group by party_code          
         
select distinct a.*,b.fbrokon,b.fbrokoff,b.tbrokon,b.tbrokoff,b.cnt into #f from #file3 b join mis.upload.dbo.ebrok_training_temp a        
on b.party_code=a.party_code order by a.party_code   
      
--delete from mis.upload.dbo.ebrok_training_temp  
select * from #f  
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_training1
-- --------------------------------------------------
CREATE  proc ebrok_training1 (@fdate as varchar(25),@tdate as varchar(25),@fdays as int,@tdays as int)          
as          
set nocount on          
select distinct name,party_code,trainingdate into #file1           
from mis.upload.dbo.ebrok_training_temp where trainingdate>=@fdate and trainingdate<=@tdate          
          
select party_code,user_stat,brokerage,sauda_date=convert(datetime,sauda_date,103) into #ff2 from mis_ebroking_cli (nolock)
where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays 

select b.party_code,fbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then brokerage else 0 end,        
fbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then brokerage else 0 end,          
tbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat='e-broking'  then brokerage else 0 end,        
tbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat<>'e-broking'  then brokerage else 0 end,        
cnt=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays  then 1 else 0 end into #file2          
from #ff2 a (nolock) join #file1 b on a.party_code=b.party_code collate SQL_Latin1_General_CP1_CI_AS          
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays         
group by b.party_code,a.sauda_date,b.trainingdate,a.brokerage,a.user_stat          
          
select party_code,fbrokon=sum(fbrokon),fbrokoff=sum(fbrokoff),tbrokon=sum(tbrokon),tbrokoff=sum(tbrokoff),cnt=sum(cnt) into #file3 from #file2 group by party_code          
         
select distinct a.*,b.fbrokon,b.fbrokoff,b.tbrokon,b.tbrokoff,b.cnt into #f from #file3 b join mis.upload.dbo.ebrok_training_temp a        
on b.party_code=a.party_code order by a.party_code   
      
--delete from mis.upload.dbo.ebrok_training_temp  
select * from #f  
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_training11
-- --------------------------------------------------
CREATE  proc ebrok_training11 (@fdate as varchar(25),@tdate as varchar(25),@fdays as int,@tdays as int)            
as            
set nocount on            
select distinct name,party_code,trainingdate into #file1             
from mis.upload.dbo.ebrok_training_temp where trainingdate>=@fdate and trainingdate<=@tdate          
            
select party_code,user_stat,brokerage,sauda_date=convert(datetime,sauda_date,103)  
 into #ff2   
from mis_ebroking_cli (nolock)  
where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays   
  
select b.party_code,fbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then brokerage else 0 end,          
fbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then brokerage else 0 end,            
tbrokon=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat='e-broking'  then brokerage else 0 end,          
tbrokoff=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays and user_stat<>'e-broking'  then brokerage else 0 end,          
cnt=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103)+@tdays  then 1 else 0 end into #file2            
from   #file1 b left outer join #ff2 a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS            
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays           
group by b.party_code,a.sauda_date,b.trainingdate,a.brokerage,a.user_stat            
            
select party_code,fbrokon=sum(fbrokon),fbrokoff=sum(fbrokoff),tbrokon=sum(tbrokon),tbrokoff=sum(tbrokoff),cnt=sum(cnt) into #file3 from #file2 group by party_code            
           
select distinct a.*,b.fbrokon,b.fbrokoff,b.tbrokon,b.tbrokoff,b.cnt into #f from #file3 b join mis.upload.dbo.ebrok_training_temp a          
on b.party_code=a.party_code order by a.party_code     
        
--delete from mis.upload.dbo.ebrok_training_temp    
select * from #f    
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_turnover
-- --------------------------------------------------
CREATE proc ebrok_turnover (@fdate as varchar(11),@tdate as varchar(11),@flag as varchar(5))                
as                
set nocount on                
if @flag='A'              
begin              
declare @tot as varchar(50)            
               
 select @tot=sum(turnover) from  bsedb_ab.dbo.mis_to  (nolock)                    
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                  
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                  
--print @tot                
                
                
select mdate,PREDATE=MDATE-1,turnover=isnull(sum(turnover),0),per=((isnull(sum(turnover),0)*100)/@tot)                
into #file from  bsedb_ab.dbo.mis_to a (nolock) right outer join risk.dbo.cal_full b (nolock)                
on a.sauda_date=b.mdate                     
 where mdate>=convert(varchar(11),convert(datetime,@fdate,103)-1)                  
 and mdate<=convert(varchar(11),convert(datetime,@tdate,103))                   
group by mdate                
              
select mdate=convert(varchar(11),a.mdate,103),turnover=round(a.turnover/10000000,2),diff=round((a.turnover-b.turnover)/10000000,2),a.per from #file a join #file b             
on a.predate=b.mdate              
end       
             
if @flag='B'              
begin       
select * into #mis2 from bsedb_ab.dbo.mis_to (nolock)      
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))       
             
 select sauda_date,company,party_code,nooftrade=sum(nooftrade),terminal_id into #trade1       
from mis_NoOfTrade (nolock)      
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))       
group by sauda_date,company,party_code,terminal_id        
      
  --select * from mis_NoOfTrade  order by sauda_date     
             
select server=case when b.odin_server='Anywhere' then '172.31.15.51' else b.odin_server end              
,ABLCM=case when a.company='ABLCM' then round(sum(turnover)/10000000,2) else 0 end,ABLCM_trade=case when a.company='ABLCM' then sum(isnull(nooftrade,0)) else 0 end              
,ACDLCM=case when a.company='ACDLCM' then round(sum(turnover)/10000000,2) else 0 end,ACDLCM_trade=case when a.company='ACDLCM' then sum(isnull(nooftrade,0)) else 0 end             
,ACDLFO=case when a.company='ACDLFO' then round(sum(turnover)/10000000,2) else 0 end,ACDLFO_trade=case when a.company='ACDLFO' then sum(isnull(nooftrade,0)) else 0 end             
,ACPLMCX=case when a.company='ACPLMCX' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCX_trade=case when a.company='ACPLMCX' then sum(isnull(nooftrade,0)) else 0 end             
,ACPLNCDEX=case when a.company='ACPLNCDEX' then round(sum(turnover)/10000000,2) else 0 end ,ACPLNCDEX_trade=case when a.company='ACPLNCDEX' then sum(isnull(nooftrade,0)) else 0 end             
,ACPLMCD=case when a.company='ACPLMCD' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCD_trade=case when a.company='ACPLMCD' then sum(isnull(nooftrade,0)) else 0 end              
,ACDLNSX=case when a.company='ACDLNSX' then round(sum(turnover)/10000000,2) else 0 end,ACDLNSX_trade=case when a.company='ACDLNSX' then sum(isnull(nooftrade,0)) else 0 end              
,total=round(sum(turnover)/10000000,2) into #file12 from #mis2 a (nolock) join ctcl.dbo.ebrok_client  (nolock) b              
on a.party_code=b.party_code collate SQL_Latin1_General_CP1_CI_AS        
LEFT OUTER join #trade1 c  (nolock) on  a.party_code=c.party_code collate Latin1_General_CI_AS         
--and a.sauda_date=c.sauda_date         
and a.company=c.company collate Latin1_General_CI_AS          
and a.terminal_id=c.terminal_id collate Latin1_General_CI_AS       
--where a.sauda_date>=convert(varchar(11),convert(datetime,'11/01/2010',103))                
-- and a.sauda_date<=convert(varchar(11),convert(datetime,'11/01/2010',103))   
group by b.odin_server,a.company       
order by  b.odin_server      
      
      
select server,ABLCM=sum(ABLCM),ABLCM_trade=sum(ABLCM_trade),ACDLCM=sum(ACDLCM),      
ACDLCM_trade=sum(ACDLCM_trade),ACDLFO=sum(ACDLFO),ACDLFO_trade=sum(ACDLFO_trade),      
ACPLMCD=sum(ACPLMCD),ACPLMCD_trade=sum(ACPLMCD_trade),      
ACPLMCX=sum(ACPLMCX),ACPLMCX_trade=sum(ACPLMCX_trade),ACPLNCDEX=sum(ACPLNCDEX),      
ACPLNCDEX_trade=sum(ACPLNCDEX_trade),ACDLNSX=sum(ACDLNSX),ACDLNSX_trade=sum(ACDLNSX_trade),total=sum(total)      
 from #file12   
where  server not in ('172.31.15.81','172.31.15.82')   
    
group by server       
--order by  server      
end     
    
if @flag='C'              
begin     
    
select party_code,sauda_date,turnover=sum(turnover) into #mis_2 from bsedb_ab.dbo.mis_to    
where  sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                  
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))     
group by sauda_date ,party_code    
             
select mdate=convert(varchar(11),convert(datetime,mdate,103),103),[172.31.15.10]=case when  c.odin_server='172.31.15.10' then sum(turnover)/10000000 else 0 end,    
[172.31.15.15]=case when  c.odin_server='172.31.15.15' then sum(turnover)/10000000 else 0 end,    
[172.31.15.16]=case when  c.odin_server='172.31.15.16' then sum(turnover)/10000000 else 0 end,    
[172.31.15.18]=case when  c.odin_server='172.31.15.18' then sum(turnover)/10000000 else 0 end,    
[172.31.15.20]=case when  c.odin_server='172.31.15.20' then sum(turnover)/10000000 else 0 end,    
[172.31.15.24]=case when  c.odin_server='172.31.15.24' then sum(turnover)/10000000 else 0 end,    
[172.31.15.28]=case when  c.odin_server='172.31.15.28' then sum(turnover)/10000000 else 0 end,    
[172.31.15.30]=case when  c.odin_server='172.31.15.30' then sum(turnover)/10000000 else 0 end,    
[172.31.15.32]=case when  c.odin_server='172.31.15.32' then sum(turnover)/10000000 else 0 end,    
[172.31.15.34]=case when  c.odin_server='172.31.15.34' then sum(turnover)/10000000 else 0 end,    
[172.31.15.35]=case when  c.odin_server='172.31.15.35' then sum(turnover)/10000000 else 0 end,    
[172.31.15.38]=case when  c.odin_server='172.31.15.38' then sum(turnover)/10000000 else 0 end,    
[172.31.15.41]=case when  c.odin_server='172.31.15.41' then sum(turnover)/10000000 else 0 end,    
[172.31.15.51]=case when  c.odin_server='Anywhere' then sum(turnover)/10000000 else 0 end,    
[172.31.15.56]=case when  c.odin_server='172.31.15.56' then sum(turnover)/10000000 else 0 end    
into #temp    
from  #mis_2 a (nolock) right outer join risk.dbo.cal_full b (nolock)                
on a.sauda_date=b.mdate join ctcl.dbo.ebrok_client  (nolock) c              
on a.party_code=c.party_code collate SQL_Latin1_General_CP1_CI_AS                
 where mdate>=convert(varchar(11),convert(datetime,@fdate,103)-1)                  
 and mdate<=convert(varchar(11),convert(datetime,@tdate,103))                   
group by mdate,c.odin_server     
order by mdate    
    
select distinct mdate,[172.31.15.10]=round(sum([172.31.15.10]),2),[172.31.15.15]=round(sum([172.31.15.15]),2),    
[172.31.15.18]=round(sum([172.31.15.18]),2),    
[172.31.15.20]=round(sum([172.31.15.20]),2),[172.31.15.24]=round(sum([172.31.15.24]),2),    
[172.31.15.28]=round(sum([172.31.15.28]),2),    
[172.31.15.30]=round(sum([172.31.15.30]),2),[172.31.15.32]=round(sum([172.31.15.32]),2),    
[172.31.15.34]=round(sum([172.31.15.34]),2),[172.31.15.35]=round(sum([172.31.15.35]),2),    
[172.31.15.38]=round(sum([172.31.15.38]),2),[172.31.15.41]=round(sum([172.31.15.41]),2),    
[172.31.15.51]=round(sum([172.31.15.51]),2),[172.31.15.56]=round(sum([172.31.15.56]),2)     
from  #temp group by mdate    
order by mdate          
end            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_turnover_temp
-- --------------------------------------------------
CREATE proc ebrok_turnover_temp (@fdate as varchar(11),@tdate as varchar(11),@flag as varchar(5))                                    
as                                    
set nocount on         
        
select terminal_id,segment=case when segment='BSECM' then 'ABLCM' when segment='NSECM' then 'ACDLCM'         
when segment='FO' then 'ACDLFO' when segment='MCX' then 'ACPLMCX' when segment='NCDEX' then 'ACPLNCDEX'         
else segment END,A.SAUDA_DATE,A.PARTY_CODE,TURNOVER=SUM(ISNULL(A.TURNOVER,0))--,TERMINAL_ID=B.TERMINAL_ID         
INTO #OFFLINE FROM mis.terminalmaster.dbo.ebrokingOfflineTrades_terminal A --LEFT OUTER JOIN bsedb_ab.dbo.mis_to B        
--ON A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS AND A.SAUDA_DATE=B.SAUDA_DATE        
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                      
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))          
GROUP BY SEGMENT,A.SAUDA_DATE,A.PARTY_CODE,terminal_id        
--DROP TABLE #OFFLINE        
        
SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,TURNOVER=SUM(ISNULL(A.TURNOVER,0))        
into #TOT_brok FROM bsedb_ab.dbo.mis_to A        
--WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                      
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))  
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))          
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID        
        
SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,TURNOVER=SUM(ISNULL(A.TURNOVER,0))-SUM(ISNULL(B.TURNOVER,0))        
into #online_brok FROM #TOT_brok (NOLOCK) A        
LEFT OUTER JOIN #OFFLINE B ON A.PARTY_CODE=B.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS         
AND A.SAUDA_DATE=B.SAUDA_DATE AND A.COMPANY=B.SEGMENT  and a.terminal_id=b.terminal_id       
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                      
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))          
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID        
                                   
if @flag='A'                                  
begin                                  
declare @tot as varchar(50)                                
                                   
 select @tot=sum(turnover)/10000000 from  #online_brok  (nolock)                                        
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                      
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                                      
--print @tot                                    
select distinct segment,terminal_id,servermapped,from_date,to_date                   
into #term_id12                   
from mis.genodinlimit.dbo.ebrok_all_terminal_master                   
where from_date<=convert(varchar(11),convert(datetime,@fdate,103)) and                   
to_date>=convert(varchar(11),convert(datetime,@tdate,103))       
    
select a.* into #online from #online_brok a (nolock) join #term_id12 c on a.terminal_id=c.terminal_id     
where c.servermapped not in ('DIRECT','172.31.15.13','172.31.15.81','172.31.15.82','')                                  
                                    
select mdate,PREDATE=MDATE,turnover=isnull(sum(turnover),0),per=((isnull(sum(turnover),0)*100)/@tot)                                    
into #file                     
from  #online a (nolock) right outer join risk.dbo.cal_full b (nolock)                                    
on a.sauda_date=b.mdate                                       
 where mdate>=convert(varchar(11),convert(datetime,@fdate,103))                                      
 and mdate<=convert(varchar(11),convert(datetime,@tdate,103))               
group by mdate                                    
                                  
select mdate=convert(varchar(11),a.mdate,103),turnover=round(a.turnover/10000000,2),diff=round((a.turnover-b.turnover)/10000000,2),PER=round(a.per/10000000,2) from #file a join #file b                                 
on a.predate=b.mdate  order by mdate                                
end                           
                           
if @flag='B'                                  
begin                           
select * into #mis2                     
from #online_brok (nolock)                          
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                 
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                           
                                 
 select sauda_date,company,party_code,nooftrade=sum(nooftrade),terminal_id into #trade1                           
from mis_NoOfTrade (nolock)                          
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                    
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                           
group by sauda_date,company,party_code,terminal_id                            
                          
  --select * from mis_NoOfTrade  order by sauda_date                   
select distinct segment,terminal_id,servermapped,from_date,to_date                   
into #term_id                   
from mis.genodinlimit.dbo.ebrok_all_terminal_master                   
where from_date<=convert(varchar(11),convert(datetime,@fdate,103)) and                   
to_date>=convert(varchar(11),convert(datetime,@tdate,103))                              
                                 
select server=case when b.servermapped='Anywhere' then '172.31.15.51' else b.servermapped end                                  
,ABLCM=case when a.company='ABLCM' then round(sum(turnover)/10000000,2) else 0 end,ABLCM_trade=case when a.company='ABLCM' then sum(isnull(nooftrade,0)) else 0 end                                  
,ACDLCM=case when a.company='ACDLCM' then round(sum(turnover)/10000000,2) else 0 end,ACDLCM_trade=case when a.company='ACDLCM' then sum(isnull(nooftrade,0)) else 0 end                                 
,ACDLFO=case when a.company='ACDLFO' then round(sum(turnover)/10000000,2) else 0 end,ACDLFO_trade=case when a.company='ACDLFO' then sum(isnull(nooftrade,0)) else 0 end                                 
,ACPLMCX=case when a.company='ACPLMCX' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCX_trade=case when a.company='ACPLMCX' then sum(isnull(nooftrade,0)) else 0 end                        
,ACPLNCDEX=case when a.company='ACPLNCDEX' then round(sum(turnover)/10000000,2) else 0 end ,ACPLNCDEX_trade=case when a.company='ACPLNCDEX' then sum(isnull(nooftrade,0)) else 0 end                                 
,ACPLMCD=case when a.company='ACPLMCD' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCD_trade=case when a.company='ACPLMCD' then sum(isnull(nooftrade,0)) else 0 end                                  
,ACDLNSX=case when a.company='ACDLNSX' then round(sum(turnover)/10000000,2) else 0 end,ACDLNSX_trade=case when a.company='ACDLNSX' then sum(isnull(nooftrade,0)) else 0 end                                  
,total=round(sum(turnover)/10000000,2)                   
into #file12 from #mis2 a (nolock) join #term_id b                                  
on a.terminal_id=b.terminal_id                       
LEFT OUTER join #trade1 c  (nolock) on  a.party_code=c.party_code collate Latin1_General_CI_AS                             
--and a.sauda_date=c.sauda_date                             
and a.company=c.company collate Latin1_General_CI_AS                              
and a.terminal_id=c.terminal_id collate Latin1_General_CI_AS                     
WHERE b.servermapped NOT IN ('172.31.15.13','DIRECT')                          
--where a.sauda_date>=convert(varchar(11),convert(datetime,'11/01/2010',103))                                    
-- and a.sauda_date<=convert(varchar(11),convert(datetime,'11/01/2010',103))                           
group by b.servermapped,a.company                           
order by  b.servermapped           
                          
                          
select server,ABLCM=sum(ABLCM),ABLCM_trade=sum(ABLCM_trade),ACDLCM=sum(ACDLCM),                          
ACDLCM_trade=sum(ACDLCM_trade),ACDLFO=sum(ACDLFO),ACDLFO_trade=sum(ACDLFO_trade),        
ACPLMCD=sum(ACPLMCD),ACPLMCD_trade=sum(ACPLMCD_trade),                          
ACPLMCX=sum(ACPLMCX),ACPLMCX_trade=sum(ACPLMCX_trade),ACPLNCDEX=sum(ACPLNCDEX),                          
ACPLNCDEX_trade=sum(ACPLNCDEX_trade),ACDLNSX=sum(ACDLNSX),ACDLNSX_trade=sum(ACDLNSX_trade),total=sum(total)                          
 from #file12 where server NOT IN ('172.31.15.81','172.31.15.82','')                        
group by server                  
--order by  server                          
end                         
                        
if @flag='C'                                  
begin                         
                        
select party_code,sauda_date,turnover=sum(turnover),terminal_id into #mis_2 from #online_brok                   
where  sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                      
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                         
group by sauda_date ,party_code,terminal_id             
            
                      
                  
select distinct segment,terminal_id,servermapped,from_date,to_date into #term_id2                   
from mis.genodinlimit.dbo.ebrok_all_terminal_master                   
where from_date<=convert(varchar(11),convert(datetime,@fdate,103)) and                   
to_date>=convert(varchar(11),convert(datetime,@tdate,103))                    
                                 
select mdate=convert(varchar(11),convert(datetime,mdate,103),103),[172.31.15.10]=case when  c.servermapped='172.31.15.10' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.15]=case when  c.servermapped='172.31.15.15' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.16]=case when  c.servermapped='172.31.15.16' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.18]=case when  c.servermapped='172.31.15.18' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.20]=case when  c.servermapped='172.31.15.20' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.24]=case when  c.servermapped='172.31.15.24' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.28]=case when  c.servermapped='172.31.15.28' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.30]=case when  c.servermapped='172.31.15.30' then sum(turnover)/10000000 else 0 end,                    
[172.31.15.32]=case when  c.servermapped='172.31.15.32' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.34]=case when  c.servermapped='172.31.15.34' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.35]=case when  c.servermapped='172.31.15.35' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.38]=case when  c.servermapped='172.31.15.38' then sum(turnover)/10000000 else 0 end,                  
[172.31.15.41]=case when  c.servermapped='172.31.15.41' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.51]=case when  c.servermapped='Anywhere' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.56]=case when  c.servermapped='172.31.15.56' then sum(turnover)/10000000 else 0 end                        
into #temp                        
from  #mis_2 a (nolock) right outer join risk.dbo.cal_full b (nolock)                                    
on a.sauda_date=b.mdate join #term_id2 c                                  
on a.terminal_id=C.terminal_id                                    
 where mdate>=convert(varchar(11),convert(datetime,@fdate,103))                                      
 and mdate<=convert(varchar(11),convert(datetime,@tdate,103)) AND  c.servermapped NOT IN ('172.31.15.13','DIRECT')                                         
group by mdate,c.servermapped                         
order by mdate                        
                        
select distinct mdate,[172.31.15.10]=round(sum([172.31.15.10]),2),[172.31.15.15]=round(sum([172.31.15.15]),2),                        
[172.31.15.18]=round(sum([172.31.15.18]),2),                        
[172.31.15.20]=round(sum([172.31.15.20]),2),[172.31.15.24]=round(sum([172.31.15.24]),2),                        
[172.31.15.28]=round(sum([172.31.15.28]),2),                        
[172.31.15.30]=round(sum([172.31.15.30]),2),[172.31.15.32]=round(sum([172.31.15.32]),2),                        
[172.31.15.34]=round(sum([172.31.15.34]),2),[172.31.15.35]=round(sum([172.31.15.35]),2),                        
[172.31.15.38]=round(sum([172.31.15.38]),2),[172.31.15.41]=round(sum([172.31.15.41]),2),                        
[172.31.15.51]=round(sum([172.31.15.51]),2),[172.31.15.56]=round(sum([172.31.15.56]),2)                    
from  #temp group by mdate                        
order by mdate                              
end                                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_turnover_temp1
-- --------------------------------------------------
CREATE proc ebrok_turnover_temp1 (@fdate as varchar(11),@tdate as varchar(11),@flag as varchar(5))                                        
as                                        
set nocount on             
            
select segment=case when segment='BSECM' then 'ABLCM' when segment='NSECM' then 'ACDLCM'             
when segment='FO' then 'ACDLFO' when segment='MCX' then 'ACPLMCX' when segment='NCDEX' then 'ACPLNCDEX'             
else segment END,A.SAUDA_DATE,A.PARTY_CODE,TURNOVER=SUM(ISNULL(A.TURNOVER,0))--,TERMINAL_ID=B.TERMINAL_ID             
INTO #OFFLINE FROM mis.terminalmaster.dbo.ebrokingOfflineTrades A --LEFT OUTER JOIN bsedb_ab.dbo.mis_to B            
--ON A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS AND A.SAUDA_DATE=B.SAUDA_DATE            
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                          
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))              
GROUP BY SEGMENT,A.SAUDA_DATE,A.PARTY_CODE            
--DROP TABLE #OFFLINE            
            
SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,TURNOVER=SUM(ISNULL(A.TURNOVER,0))            
into #TOT_brok FROM bsedb_ab.dbo.mis_to A            
--WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                          
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))      
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))              
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID            
            
SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,TURNOVER=SUM(ISNULL(A.TURNOVER,0))-SUM(ISNULL(B.TURNOVER,0))            
into #online_brok FROM #TOT_brok (NOLOCK) A            
LEFT OUTER JOIN #OFFLINE B ON A.PARTY_CODE=B.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS             
AND A.SAUDA_DATE=B.SAUDA_DATE AND A.COMPANY=B.SEGMENT       
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                          
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))              
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID            
                                       
if @flag='A'                                      
begin                                      
declare @tot as varchar(50)                                    
                                       
 select @tot=sum(turnover)/10000000 from  #online_brok  (nolock)                                            
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                          
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                                          
--print @tot                                        
select distinct segment,terminal_id,servermapped,from_date,to_date                       
into #term_id12                       
from mis.genodinlimit.dbo.ebrok_all_terminal_master                       
where from_date<=convert(varchar(11),convert(datetime,@fdate,103)) and                       
to_date>=convert(varchar(11),convert(datetime,@tdate,103))           
        
select a.* into #online from #online_brok a (nolock) join #term_id12 c on a.terminal_id=c.terminal_id         
where c.servermapped not in ('DIRECT','172.31.15.13','172.31.15.81','172.31.15.82','')                                      
                                        
select mdate,PREDATE=MDATE,turnover=isnull(sum(turnover),0),per=((isnull(sum(turnover),0)*100)/@tot)                                        
into #file                         
from  #online a (nolock) right outer join risk.dbo.cal_full b (nolock)                                        
on a.sauda_date=b.mdate                                           
 where mdate>=convert(varchar(11),convert(datetime,@fdate,103))                                          
 and mdate<=convert(varchar(11),convert(datetime,@tdate,103))               
group by mdate                                        
                                
select mdate=convert(varchar(11),a.mdate,103),turnover=round(a.turnover/10000000,2),diff=round((a.turnover-b.turnover)/10000000,2),PER=round(a.per/10000000,2) from #file a join #file b                                     
on a.predate=b.mdate  order by mdate                                    
end                               
                               
if @flag='B'                                      
begin                               
select * into #mis2                         
from #online_brok (nolock)                              
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                     
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                               
                                     
 select sauda_date,company,party_code,nooftrade=sum(nooftrade),terminal_id into #trade1                               
from mis_NoOfTrade (nolock)                              
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                        
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                               
group by sauda_date,company,party_code,terminal_id                                
                              
  --select * from mis_NoOfTrade  order by sauda_date                       
select distinct segment,terminal_id,servermapped,from_date,to_date                       
into #term_id                       
from mis.genodinlimit.dbo.ebrok_all_terminal_master                       
where from_date<=convert(varchar(11),convert(datetime,@fdate,103)) and                       
to_date>=convert(varchar(11),convert(datetime,@tdate,103))                                  
                                     
select server=case when b.servermapped='Anywhere' then '172.31.15.51' else b.servermapped end                                      
,ABLCM=case when a.company='ABLCM' then round(sum(turnover)/10000000,2) else 0 end,ABLCM_trade=case when a.company='ABLCM' then sum(isnull(nooftrade,0)) else 0 end                                      
,ACDLCM=case when a.company='ACDLCM' then round(sum(turnover)/10000000,2) else 0 end,ACDLCM_trade=case when a.company='ACDLCM' then sum(isnull(nooftrade,0)) else 0 end                                     
,ACDLFO=case when a.company='ACDLFO' then round(sum(turnover)/10000000,2) else 0 end,ACDLFO_trade=case when a.company='ACDLFO' then sum(isnull(nooftrade,0)) else 0 end                                     
,ACPLMCX=case when a.company='ACPLMCX' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCX_trade=case when a.company='ACPLMCX' then sum(isnull(nooftrade,0)) else 0 end                            
,ACPLNCDEX=case when a.company='ACPLNCDEX' then round(sum(turnover)/10000000,2) else 0 end ,ACPLNCDEX_trade=case when a.company='ACPLNCDEX' then sum(isnull(nooftrade,0)) else 0 end                                     
,ACPLMCD=case when a.company='ACPLMCD' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCD_trade=case when a.company='ACPLMCD' then sum(isnull(nooftrade,0)) else 0 end                                      
,ACDLNSX=case when a.company='ACDLNSX' then round(sum(turnover)/10000000,2) else 0 end,ACDLNSX_trade=case when a.company='ACDLNSX' then sum(isnull(nooftrade,0)) else 0 end                                      
,total=round(sum(turnover)/10000000,2)                       
into #file12 from #mis2 a (nolock) join #term_id b                                      
on a.terminal_id=b.terminal_id                           
LEFT OUTER join #trade1 c  (nolock) on  a.party_code=c.party_code collate Latin1_General_CI_AS                                 
--and a.sauda_date=c.sauda_date                                 
and a.company=c.company collate Latin1_General_CI_AS                                  
and a.terminal_id=c.terminal_id collate Latin1_General_CI_AS                         
WHERE b.servermapped NOT IN ('172.31.15.13','DIRECT')                              
--where a.sauda_date>=convert(varchar(11),convert(datetime,'11/01/2010',103))                                        
-- and a.sauda_date<=convert(varchar(11),convert(datetime,'11/01/2010',103))                               
group by b.servermapped,a.company                               
order by  b.servermapped               
                              
                              
select server,ABLCM=sum(ABLCM),ABLCM_trade=sum(ABLCM_trade),ACDLCM=sum(ACDLCM),                              
ACDLCM_trade=sum(ACDLCM_trade),ACDLFO=sum(ACDLFO),ACDLFO_trade=sum(ACDLFO_trade),            
ACPLMCD=sum(ACPLMCD),ACPLMCD_trade=sum(ACPLMCD_trade),                              
ACPLMCX=sum(ACPLMCX),ACPLMCX_trade=sum(ACPLMCX_trade),ACPLNCDEX=sum(ACPLNCDEX),                              
ACPLNCDEX_trade=sum(ACPLNCDEX_trade),ACDLNSX=sum(ACDLNSX),ACDLNSX_trade=sum(ACDLNSX_trade),total=sum(total)                              
 from #file12 where server NOT IN ('172.31.15.81','172.31.15.82','')                            
group by server                      
--order by  server                              
end                             
                            
if @flag='C'                                      
begin                             
                            
select party_code,sauda_date,turnover=sum(turnover),terminal_id into #mis_2 from #online_brok                       
where  sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                                          
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))                             
group by sauda_date ,party_code,terminal_id                 
                
                          
                      
select distinct segment,terminal_id,servermapped,from_date,to_date into #term_id2                       
from mis.genodinlimit.dbo.ebrok_all_terminal_master                       
where from_date<=convert(varchar(11),convert(datetime,@fdate,103)) and                       
to_date>=convert(varchar(11),convert(datetime,@tdate,103))                        
                                     
select mdate=convert(varchar(11),convert(datetime,mdate,103),103),[172.31.15.10]=case when  c.servermapped='172.31.15.10' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.15]=case when  c.servermapped='172.31.15.15' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.16]=case when  c.servermapped='172.31.15.16' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.18]=case when  c.servermapped='172.31.15.18' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.20]=case when  c.servermapped='172.31.15.20' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.24]=case when  c.servermapped='172.31.15.24' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.28]=case when  c.servermapped='172.31.15.28' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.30]=case when  c.servermapped='172.31.15.30' then sum(turnover)/10000000 else 0 end,                        
[172.31.15.32]=case when  c.servermapped='172.31.15.32' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.34]=case when  c.servermapped='172.31.15.34' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.35]=case when  c.servermapped='172.31.15.35' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.38]=case when  c.servermapped='172.31.15.38' then sum(turnover)/10000000 else 0 end,                      
[172.31.15.41]=case when  c.servermapped='172.31.15.41' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.51]=case when  c.servermapped='Anywhere' then sum(turnover)/10000000 else 0 end,                            
[172.31.15.56]=case when  c.servermapped='172.31.15.56' then sum(turnover)/10000000 else 0 end                            
into #temp                            
from  #mis_2 a (nolock) right outer join risk.dbo.cal_full b (nolock)                                        
on a.sauda_date=b.mdate join #term_id2 c                                      
on a.terminal_id=C.terminal_id                                        
 where mdate>=convert(varchar(11),convert(datetime,@fdate,103))                                          
 and mdate<=convert(varchar(11),convert(datetime,@tdate,103)) AND  c.servermapped NOT IN ('172.31.15.13','DIRECT')                                             
group by mdate,c.servermapped                             
order by mdate                            
                            
select distinct mdate,[172.31.15.10]=round(sum([172.31.15.10]),2),[172.31.15.15]=round(sum([172.31.15.15]),2),                            
[172.31.15.18]=round(sum([172.31.15.18]),2),                            
[172.31.15.20]=round(sum([172.31.15.20]),2),[172.31.15.24]=round(sum([172.31.15.24]),2),                            
[172.31.15.28]=round(sum([172.31.15.28]),2),                            
[172.31.15.30]=round(sum([172.31.15.30]),2),[172.31.15.32]=round(sum([172.31.15.32]),2),                            
[172.31.15.34]=round(sum([172.31.15.34]),2),[172.31.15.35]=round(sum([172.31.15.35]),2),                            
[172.31.15.38]=round(sum([172.31.15.38]),2),[172.31.15.41]=round(sum([172.31.15.41]),2),                            
[172.31.15.51]=round(sum([172.31.15.51]),2),[172.31.15.56]=round(sum([172.31.15.56]),2)                        
from  #temp group by mdate                            
order by mdate                                  
end                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_turnover1
-- --------------------------------------------------




CREATE PROC Ebrok_turnover1 (@FDATE AS VARCHAR(11),
                             @TDATE AS VARCHAR(11),
                             @FLAG  AS VARCHAR(5))
AS
    SET NOCOUNT ON

    SELECT SEGMENT=CASE
                     WHEN SEGMENT = 'BSECM' THEN 'ABLCM'
                     WHEN SEGMENT = 'NSECM' THEN 'ACDLCM'
                     WHEN SEGMENT = 'FO' THEN 'ACDLFO'
                     WHEN SEGMENT = 'MCX' THEN 'ACPLMCX'
                     WHEN SEGMENT = 'NCDEX' THEN 'ACPLNCDEX'
                     WHEN SEGMENT = 'NSX' THEN 'ACDLNSX'
                     ELSE SEGMENT
                   END,
           A.SAUDA_DATE,
           A.PARTY_CODE,
           TURNOVER=Sum(Isnull(A.TURNOVER, 0))--,TERMINAL_ID=B.TERMINAL_ID             
    INTO   #OFFLINE
    FROM   MIS.TERMINALMASTER.DBO.EBROKINGOFFLINETRADES A --LEFT OUTER JOIN BSEDB_AB.DBO.MIS_TO B            
    --ON A.PARTY_CODE=B.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND A.SAUDA_DATE=B.SAUDA_DATE            
    WHERE
      A.SAUDA_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103) - 1)
      AND A.SAUDA_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))
    GROUP  BY
      SEGMENT,
      A.SAUDA_DATE,
      A.PARTY_CODE

    --DROP TABLE #OFFLINE            
    SELECT A.COMPANY,
           A.SAUDA_DATE,
           A.PARTY_CODE,
           A.TERMINAL_ID,
           TURNOVER=Sum(Isnull(A.TURNOVER, 0))
    INTO   #TOT_BROK
    FROM   BSEDB_AB.DBO.MIS_TO A
    --WHERE A.SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)-1)                                          
    WHERE
      A.SAUDA_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103))
      AND A.SAUDA_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))
    GROUP  BY
      A.COMPANY,
      A.SAUDA_DATE,
      A.PARTY_CODE,
      A.TERMINAL_ID

    SELECT A.COMPANY,
           A.SAUDA_DATE,
           A.PARTY_CODE,
           A.TERMINAL_ID,
           TURNOVER=Sum(Isnull(A.TURNOVER, 0)) - Sum(Isnull(B.TURNOVER, 0))
    INTO   #ONLINE_BROK
    FROM   #TOT_BROK (NOLOCK) A
           LEFT OUTER JOIN #OFFLINE B
             ON A.PARTY_CODE = B.PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS
                AND A.SAUDA_DATE = B.SAUDA_DATE
                AND A.COMPANY = B.SEGMENT
    WHERE
      A.SAUDA_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103) - 1)
      AND A.SAUDA_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))
    GROUP  BY
      A.COMPANY,
      A.SAUDA_DATE,
      A.PARTY_CODE,
      A.TERMINAL_ID

    IF @FLAG = 'A'
      BEGIN
          DECLARE @TOT AS VARCHAR(50)

          SELECT @TOT = Sum(TURNOVER) / 10000000
          FROM   #ONLINE_BROK (NOLOCK)
          WHERE
            SAUDA_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103))
            AND SAUDA_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))

          --PRINT @TOT    
          SELECT DISTINCT SEGMENT,
                          TERMINAL_ID,
                          SERVERMAPPED,
                          FROM_DATE,
                          TO_DATE
          INTO   #TERM_ID12
          FROM   MIS.GENODINLIMIT.DBO.EBROK_ALL_TERMINAL_MASTER
          WHERE
            FROM_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103))
            AND TO_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))

          SELECT A.*
          INTO   #ONLINE
          FROM   #ONLINE_BROK A (NOLOCK)
                 JOIN #TERM_ID12 C
                   ON A.TERMINAL_ID = C.TERMINAL_ID
          WHERE
            C.SERVERMAPPED NOT IN ( 'DIRECT', '172.31.15.13', '172.31.15.81', '172.31.15.82', '' )

          SELECT MDATE,
                 PREDATE=MDATE - 1,
                 TURNOVER=Isnull(Sum(TURNOVER), 0),
                 PER=( ( Isnull(Sum(TURNOVER), 0) * 100 ) / @TOT )
          INTO   #FILE
          FROM   #ONLINE A (NOLOCK)
                 RIGHT OUTER JOIN RISK.DBO.CAL_FULL B (NOLOCK)
                   ON A.SAUDA_DATE = B.MDATE
          WHERE
            MDATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103) - 1)
            AND MDATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))
          GROUP  BY
            MDATE

          SELECT MDATE=CONVERT(VARCHAR(11), A.MDATE, 103),
                 TURNOVER=Round(A.TURNOVER / 10000000, 2),
                 DIFF=Round(( A.TURNOVER - B.TURNOVER ) / 10000000, 2),
                 PER=Round(A.PER / 10000000, 2)
          FROM   #FILE A
                 JOIN #FILE B
                   ON A.PREDATE = B.MDATE
          ORDER  BY MDATE
      END

    IF @FLAG = 'B'
      BEGIN
          SELECT *
          INTO   #MIS2
          FROM   #ONLINE_BROK (NOLOCK)
          WHERE
            SAUDA_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103) - 1)
            AND SAUDA_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))

          SELECT SAUDA_DATE,
                 COMPANY,
                 PARTY_CODE,
                 NOOFTRADE=Sum(NOOFTRADE),
                 TERMINAL_ID
          INTO   #TRADE1
          FROM   MIS_NOOFTRADE (NOLOCK)
          WHERE
            SAUDA_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103))
            AND SAUDA_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))
          GROUP  BY
            SAUDA_DATE,
            COMPANY,
            PARTY_CODE,
            TERMINAL_ID

          --SELECT * FROM MIS_NOOFTRADE  ORDER BY SAUDA_DATE                       
          SELECT DISTINCT SEGMENT,
                          TERMINAL_ID,
                          SERVERMAPPED,
                          FROM_DATE,
                          TO_DATE
          INTO   #TERM_ID
          FROM   MIS.GENODINLIMIT.DBO.EBROK_ALL_TERMINAL_MASTER
          WHERE
            FROM_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103))
            AND TO_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))

          SELECT SERVER=CASE
                          WHEN B.SERVERMAPPED = 'ANYWHERE' THEN '172.31.15.51'
                          ELSE B.SERVERMAPPED
                        END,
                 ABLCM=CASE
                         WHEN A.COMPANY = 'ABLCM' THEN Round(Sum(TURNOVER) / 10000000, 2)
                         ELSE 0
                       END,
                 ABLCM_TRADE=CASE
                               WHEN A.COMPANY = 'ABLCM' THEN Sum(Isnull(NOOFTRADE, 0))
                               ELSE 0
                             END,
                 ACDLCM=CASE
                          WHEN A.COMPANY = 'ACDLCM' THEN Round(Sum(TURNOVER) / 10000000, 2)
                          ELSE 0
                        END,
                 ACDLCM_TRADE=CASE
                                WHEN A.COMPANY = 'ACDLCM' THEN Sum(Isnull(NOOFTRADE, 0))
                                ELSE 0
                              END,
                 ACDLFO=CASE
                          WHEN A.COMPANY = 'ACDLFO' THEN Round(Sum(TURNOVER) / 10000000, 2)
                          ELSE 0
                        END,
                 ACDLFO_TRADE=CASE
                                WHEN A.COMPANY = 'ACDLFO' THEN Sum(Isnull(NOOFTRADE, 0))
                                ELSE 0
                              END,
                 ACPLMCX=CASE
                           WHEN A.COMPANY = 'ACPLMCX' THEN Round(Sum(TURNOVER) / 10000000, 2)
                           ELSE 0
                         END,
                 ACPLMCX_TRADE=CASE
                                 WHEN A.COMPANY = 'ACPLMCX' THEN Sum(Isnull(NOOFTRADE, 0))
                                 ELSE 0
                               END,
                 ACPLNCDEX=CASE
                             WHEN A.COMPANY = 'ACPLNCDEX' THEN Round(Sum(TURNOVER) / 10000000, 2)
                             ELSE 0
                           END,
                 ACPLNCDEX_TRADE=CASE
                                   WHEN A.COMPANY = 'ACPLNCDEX' THEN Sum(Isnull(NOOFTRADE, 0))
                                   ELSE 0
                                 END,
                 ACPLMCD=CASE
                           WHEN A.COMPANY = 'ACPLMCD' THEN Round(Sum(TURNOVER) / 10000000, 2)
                           ELSE 0
                         END,
                 ACPLMCD_TRADE=CASE
                                 WHEN A.COMPANY = 'ACPLMCD' THEN Sum(Isnull(NOOFTRADE, 0))
                                 ELSE 0
                               END,
                 ACDLNSX=CASE
                           WHEN A.COMPANY = 'ACDLNSX' THEN Round(Sum(TURNOVER) / 10000000, 2)
                           ELSE 0
                         END,
                 ACDLNSX_TRADE=CASE
                                 WHEN A.COMPANY = 'ACDLNSX' THEN Sum(Isnull(NOOFTRADE, 0))
                                 ELSE 0
                               END,
                 TOTAL=Round(Sum(TURNOVER) / 10000000, 2)
          INTO   #FILE12
          FROM   #MIS2 A (NOLOCK)
                 JOIN #TERM_ID B
                   ON A.TERMINAL_ID = B.TERMINAL_ID
                 LEFT OUTER JOIN #TRADE1 C (NOLOCK)
                   ON A.PARTY_CODE = C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS
                      --AND A.SAUDA_DATE=C.SAUDA_DATE                                 
                      AND A.COMPANY = C.COMPANY COLLATE LATIN1_GENERAL_CI_AS
                      AND A.TERMINAL_ID = C.TERMINAL_ID COLLATE LATIN1_GENERAL_CI_AS
          WHERE
            B.SERVERMAPPED NOT IN ( '172.31.15.13', 'DIRECT' )
          --WHERE A.SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,'11/01/2010',103))                                        
          -- AND A.SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,'11/01/2010',103))                               
          GROUP  BY
            B.SERVERMAPPED,
            A.COMPANY
          ORDER  BY B.SERVERMAPPED

          SELECT SERVER,
                 ABLCM=Sum(ABLCM),
                 ABLCM_TRADE=Sum(ABLCM_TRADE),
                 ACDLCM=Sum(ACDLCM),
                 ACDLCM_TRADE=Sum(ACDLCM_TRADE),
                 ACDLFO=Sum(ACDLFO),
                 ACDLFO_TRADE=Sum(ACDLFO_TRADE),
                 ACPLMCD=Sum(ACPLMCD),
                 ACPLMCD_TRADE=Sum(ACPLMCD_TRADE),
                 ACPLMCX=Sum(ACPLMCX),
                 ACPLMCX_TRADE=Sum(ACPLMCX_TRADE),
                 ACPLNCDEX=Sum(ACPLNCDEX),
                 ACPLNCDEX_TRADE=Sum(ACPLNCDEX_TRADE),
                 ACDLNSX=Sum(ACDLNSX),
                 ACDLNSX_TRADE=Sum(ACDLNSX_TRADE),
                 TOTAL=Sum(TOTAL)
          FROM   #FILE12
          WHERE
            SERVER NOT IN ( '172.31.15.81', '172.31.15.82', '' )
          GROUP  BY
            SERVER
      --ORDER BY  SERVER                              
      END

    IF @FLAG = 'C'
      BEGIN
          SELECT PARTY_CODE,
                 SAUDA_DATE,
                 TURNOVER=Sum(TURNOVER),
                 TERMINAL_ID
          INTO   #MIS_2
          FROM   #ONLINE_BROK
          WHERE
            SAUDA_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103))
            AND SAUDA_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))
          GROUP  BY
            SAUDA_DATE,
            PARTY_CODE,
            TERMINAL_ID

          SELECT DISTINCT SEGMENT,
                          TERMINAL_ID,
                          SERVERMAPPED,
                          FROM_DATE,
                          TO_DATE
          INTO   #TERM_ID2
          FROM   MIS.GENODINLIMIT.DBO.EBROK_ALL_TERMINAL_MASTER
          WHERE
            FROM_DATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103))
            AND TO_DATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))

          SELECT MDATE=CONVERT(VARCHAR(11), CONVERT(DATETIME, MDATE, 103), 103),
                 [172.31.15.10]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.10' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.15]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.15' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.16]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.16' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.18]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.18' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.20]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.20' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.24]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.24' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.28]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.28' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.30]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.30' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.32]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.32' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.34]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.34' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.35]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.35' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.38]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.38' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.41]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.41' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.51]=CASE
                                  WHEN C.SERVERMAPPED = 'ANYWHERE' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END,
                 [172.31.15.56]=CASE
                                  WHEN C.SERVERMAPPED = '172.31.15.56' THEN Sum(TURNOVER) / 10000000
                                  ELSE 0
                                END
          INTO   #TEMP
          FROM   #MIS_2 A (NOLOCK)
                 RIGHT OUTER JOIN RISK.DBO.CAL_FULL B (NOLOCK)
                   ON A.SAUDA_DATE = B.MDATE
                 JOIN #TERM_ID2 C
                   ON A.TERMINAL_ID = C.TERMINAL_ID
          WHERE
            MDATE >= CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103) - 1)
            AND MDATE <= CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103))
            AND C.SERVERMAPPED NOT IN ( '172.31.15.13', 'DIRECT' )
          GROUP  BY
            MDATE,
            C.SERVERMAPPED
          ORDER  BY MDATE

          SELECT DISTINCT MDATE,
                          [172.31.15.10]=Round(Sum([172.31.15.10]), 2),
                          [172.31.15.15]=Round(Sum([172.31.15.15]), 2),
                          [172.31.15.18]=Round(Sum([172.31.15.18]), 2),
                          [172.31.15.20]=Round(Sum([172.31.15.20]), 2),
                          [172.31.15.24]=Round(Sum([172.31.15.24]), 2),
                          [172.31.15.28]=Round(Sum([172.31.15.28]), 2),
                          [172.31.15.30]=Round(Sum([172.31.15.30]), 2),
                          [172.31.15.32]=Round(Sum([172.31.15.32]), 2),
                          [172.31.15.34]=Round(Sum([172.31.15.34]), 2),
                          [172.31.15.35]=Round(Sum([172.31.15.35]), 2),
                          [172.31.15.38]=Round(Sum([172.31.15.38]), 2),
                          [172.31.15.41]=Round(Sum([172.31.15.41]), 2),
                          [172.31.15.51]=Round(Sum([172.31.15.51]), 2),
                          [172.31.15.56]=Round(Sum([172.31.15.56]), 2)
          FROM   #TEMP
          GROUP  BY
            MDATE
          ORDER  BY MDATE
      END

    SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EBROK_TURNOVER1_bak_08_14_2012
-- --------------------------------------------------
CREATE PROC EBROK_TURNOVER1_bak_08_14_2012 (@FDATE AS VARCHAR(11),@TDATE AS VARCHAR(11),@FLAG AS VARCHAR(5))                                        
AS                                        
SET NOCOUNT ON             
            
SELECT SEGMENT=CASE WHEN SEGMENT='BSECM' THEN 'ABLCM' WHEN SEGMENT='NSECM' THEN 'ACDLCM'             
 WHEN SEGMENT='FO' THEN 'ACDLFO' WHEN SEGMENT='MCX' THEN 'ACPLMCX' WHEN SEGMENT='NCDEX' THEN 'ACPLNCDEX'             
 ELSE SEGMENT END,A.SAUDA_DATE,A.PARTY_CODE,  
 TURNOVER=SUM(ISNULL(A.TURNOVER,0))--,TERMINAL_ID=B.TERMINAL_ID             
INTO #OFFLINE   
FROM MIS.TERMINALMASTER.DBO.EBROKINGOFFLINETRADES A --LEFT OUTER JOIN BSEDB_AB.DBO.MIS_TO B            
--ON A.PARTY_CODE=B.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND A.SAUDA_DATE=B.SAUDA_DATE            
WHERE A.SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)-1)                                          
 AND A.SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))              
GROUP BY SEGMENT,A.SAUDA_DATE,A.PARTY_CODE            
--DROP TABLE #OFFLINE            
            
SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,  
 TURNOVER=SUM(ISNULL(A.TURNOVER,0))            
INTO #TOT_BROK   
FROM BSEDB_AB.DBO.MIS_TO A            
--WHERE A.SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)-1)                                          
WHERE A.SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103))      
 AND A.SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))              
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID            
            
SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,  
 TURNOVER=SUM(ISNULL(A.TURNOVER,0))-SUM(ISNULL(B.TURNOVER,0))            
INTO #ONLINE_BROK FROM #TOT_BROK (NOLOCK) A            
 LEFT OUTER JOIN #OFFLINE B ON A.PARTY_CODE=B.PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS             
 AND A.SAUDA_DATE=B.SAUDA_DATE AND A.COMPANY=B.SEGMENT             
WHERE A.SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)-1)                                          
 AND A.SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))              
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID            
                                       
IF @FLAG='A'                                      
BEGIN                                      
 DECLARE @TOT AS VARCHAR(50)                                    
                            
 SELECT @TOT=SUM(TURNOVER)/10000000 FROM  #ONLINE_BROK  (NOLOCK)                                            
 WHERE SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103))                                          
 AND SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                                          
 --PRINT @TOT    
                                       
 SELECT DISTINCT SEGMENT,TERMINAL_ID,SERVERMAPPED,FROM_DATE,TO_DATE                       
 INTO #TERM_ID12                       
 FROM MIS.GENODINLIMIT.DBO.EBROK_ALL_TERMINAL_MASTER                       
 WHERE FROM_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)) AND                       
 TO_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))           
  
 SELECT A.* INTO #ONLINE FROM #ONLINE_BROK A (NOLOCK) JOIN #TERM_ID12 C ON A.TERMINAL_ID=C.TERMINAL_ID         
 WHERE C.SERVERMAPPED NOT IN ('DIRECT','172.31.15.13','172.31.15.81','172.31.15.82','')                                      
                             
 SELECT MDATE,PREDATE=MDATE-1,TURNOVER=ISNULL(SUM(TURNOVER),0),PER=((ISNULL(SUM(TURNOVER),0)*100)/@TOT)                                        
 INTO #FILE                         
 FROM  #ONLINE A (NOLOCK) RIGHT OUTER JOIN RISK.DBO.CAL_FULL B (NOLOCK)                                        
 ON A.SAUDA_DATE=B.MDATE                                           
 WHERE MDATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)-1)                                          
 AND MDATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                   
 GROUP BY MDATE                                        
                           
 SELECT MDATE=CONVERT(VARCHAR(11),A.MDATE,103),TURNOVER=ROUND(A.TURNOVER/10000000,2),DIFF=ROUND((A.TURNOVER-B.TURNOVER)/10000000,2),PER=ROUND(A.PER/10000000,2) FROM #FILE A JOIN #FILE B                                     
 ON A.PREDATE=B.MDATE  ORDER BY MDATE                                    
END                               
                               
IF @FLAG='B'                                      
BEGIN                               
 SELECT * INTO #MIS2                         
 FROM #ONLINE_BROK (NOLOCK)                              
 WHERE SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)-1)                     
 AND SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                               
                              
 SELECT SAUDA_DATE,COMPANY,PARTY_CODE,NOOFTRADE=SUM(NOOFTRADE),TERMINAL_ID   
 INTO #TRADE1                               
 FROM MIS_NOOFTRADE (NOLOCK)                              
 WHERE SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103))                                        
 AND SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                               
 GROUP BY SAUDA_DATE,COMPANY,PARTY_CODE,TERMINAL_ID                                
                       
 --SELECT * FROM MIS_NOOFTRADE  ORDER BY SAUDA_DATE                       
 SELECT DISTINCT SEGMENT,TERMINAL_ID,SERVERMAPPED,FROM_DATE,TO_DATE                       
 INTO #TERM_ID                       
 FROM MIS.GENODINLIMIT.DBO.EBROK_ALL_TERMINAL_MASTER                       
 WHERE FROM_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)) AND                       
 TO_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                                  
                              
 SELECT SERVER=CASE WHEN B.SERVERMAPPED='ANYWHERE' THEN '172.31.15.51' ELSE B.SERVERMAPPED END                                      
 ,ABLCM=CASE WHEN A.COMPANY='ABLCM' THEN ROUND(SUM(TURNOVER)/10000000,2) ELSE 0 END,ABLCM_TRADE=CASE WHEN A.COMPANY='ABLCM' THEN SUM(ISNULL(NOOFTRADE,0)) ELSE 0 END                                      
 ,ACDLCM=CASE WHEN A.COMPANY='ACDLCM' THEN ROUND(SUM(TURNOVER)/10000000,2) ELSE 0 END,ACDLCM_TRADE=CASE WHEN A.COMPANY='ACDLCM' THEN SUM(ISNULL(NOOFTRADE,0)) ELSE 0 END                                     
 ,ACDLFO=CASE WHEN A.COMPANY='ACDLFO' THEN ROUND(SUM(TURNOVER)/10000000,2) ELSE 0 END,ACDLFO_TRADE=CASE WHEN A.COMPANY='ACDLFO' THEN SUM(ISNULL(NOOFTRADE,0)) ELSE 0 END                                     
 ,ACPLMCX=CASE WHEN A.COMPANY='ACPLMCX' THEN ROUND(SUM(TURNOVER)/10000000,2) ELSE 0 END,ACPLMCX_TRADE=CASE WHEN A.COMPANY='ACPLMCX' THEN SUM(ISNULL(NOOFTRADE,0)) ELSE 0 END                            
 ,ACPLNCDEX=CASE WHEN A.COMPANY='ACPLNCDEX' THEN ROUND(SUM(TURNOVER)/10000000,2) ELSE 0 END ,ACPLNCDEX_TRADE=CASE WHEN A.COMPANY='ACPLNCDEX' THEN SUM(ISNULL(NOOFTRADE,0)) ELSE 0 END                                     
 ,ACPLMCD=CASE WHEN A.COMPANY='ACPLMCD' THEN ROUND(SUM(TURNOVER)/10000000,2) ELSE 0 END,ACPLMCD_TRADE=CASE WHEN A.COMPANY='ACPLMCD' THEN SUM(ISNULL(NOOFTRADE,0)) ELSE 0 END                                      
 ,ACDLNSX=CASE WHEN A.COMPANY='ACDLNSX' THEN ROUND(SUM(TURNOVER)/10000000,2) ELSE 0 END,ACDLNSX_TRADE=CASE WHEN A.COMPANY='ACDLNSX' THEN SUM(ISNULL(NOOFTRADE,0)) ELSE 0 END                                      
 ,TOTAL=ROUND(SUM(TURNOVER)/10000000,2)                       
 INTO #FILE12 FROM #MIS2 A (NOLOCK) JOIN #TERM_ID B                                      
 ON A.TERMINAL_ID=B.TERMINAL_ID                           
 LEFT OUTER JOIN #TRADE1 C  (NOLOCK) ON  A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                 
 --AND A.SAUDA_DATE=C.SAUDA_DATE                                 
 AND A.COMPANY=C.COMPANY COLLATE LATIN1_GENERAL_CI_AS                                  
 AND A.TERMINAL_ID=C.TERMINAL_ID COLLATE LATIN1_GENERAL_CI_AS                         
 WHERE B.SERVERMAPPED NOT IN ('172.31.15.13','DIRECT')                              
 --WHERE A.SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,'11/01/2010',103))                                        
 -- AND A.SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,'11/01/2010',103))                               
 GROUP BY B.SERVERMAPPED,A.COMPANY                               
 ORDER BY  B.SERVERMAPPED               
                       
                       
 SELECT SERVER,ABLCM=SUM(ABLCM),ABLCM_TRADE=SUM(ABLCM_TRADE),ACDLCM=SUM(ACDLCM),                              
 ACDLCM_TRADE=SUM(ACDLCM_TRADE),ACDLFO=SUM(ACDLFO),ACDLFO_TRADE=SUM(ACDLFO_TRADE),            
 ACPLMCD=SUM(ACPLMCD),ACPLMCD_TRADE=SUM(ACPLMCD_TRADE),                              
 ACPLMCX=SUM(ACPLMCX),ACPLMCX_TRADE=SUM(ACPLMCX_TRADE),ACPLNCDEX=SUM(ACPLNCDEX),                              
 ACPLNCDEX_TRADE=SUM(ACPLNCDEX_TRADE),ACDLNSX=SUM(ACDLNSX),ACDLNSX_TRADE=SUM(ACDLNSX_TRADE),TOTAL=SUM(TOTAL)                              
 FROM #FILE12 WHERE SERVER NOT IN ('172.31.15.81','172.31.15.82','')                            
 GROUP BY SERVER                      
--ORDER BY  SERVER                              
END                             
                            
IF @FLAG='C'                                      
BEGIN                             
                     
 SELECT PARTY_CODE,SAUDA_DATE,TURNOVER=SUM(TURNOVER),TERMINAL_ID INTO #MIS_2 FROM #ONLINE_BROK                       
 WHERE  SAUDA_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103))                                          
 AND SAUDA_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                             
 GROUP BY SAUDA_DATE ,PARTY_CODE,TERMINAL_ID                 
         
                   
               
 SELECT DISTINCT SEGMENT,TERMINAL_ID,SERVERMAPPED,FROM_DATE,TO_DATE INTO #TERM_ID2                       
 FROM MIS.GENODINLIMIT.DBO.EBROK_ALL_TERMINAL_MASTER                       
 WHERE FROM_DATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)) AND                       
 TO_DATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                        
                              
 SELECT MDATE=CONVERT(VARCHAR(11),CONVERT(DATETIME,MDATE,103),103),[172.31.15.10]=CASE WHEN  C.SERVERMAPPED='172.31.15.10' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.15]=CASE WHEN  C.SERVERMAPPED='172.31.15.15' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.16]=CASE WHEN  C.SERVERMAPPED='172.31.15.16' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.18]=CASE WHEN  C.SERVERMAPPED='172.31.15.18' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.20]=CASE WHEN  C.SERVERMAPPED='172.31.15.20' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.24]=CASE WHEN  C.SERVERMAPPED='172.31.15.24' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.28]=CASE WHEN  C.SERVERMAPPED='172.31.15.28' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.30]=CASE WHEN  C.SERVERMAPPED='172.31.15.30' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                        
 [172.31.15.32]=CASE WHEN  C.SERVERMAPPED='172.31.15.32' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.34]=CASE WHEN  C.SERVERMAPPED='172.31.15.34' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.35]=CASE WHEN  C.SERVERMAPPED='172.31.15.35' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.38]=CASE WHEN  C.SERVERMAPPED='172.31.15.38' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                      
 [172.31.15.41]=CASE WHEN  C.SERVERMAPPED='172.31.15.41' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.51]=CASE WHEN  C.SERVERMAPPED='ANYWHERE' THEN SUM(TURNOVER)/10000000 ELSE 0 END,                            
 [172.31.15.56]=CASE WHEN  C.SERVERMAPPED='172.31.15.56' THEN SUM(TURNOVER)/10000000 ELSE 0 END                            
 INTO #TEMP                            
 FROM  #MIS_2 A (NOLOCK) RIGHT OUTER JOIN RISK.DBO.CAL_FULL B (NOLOCK)                                        
 ON A.SAUDA_DATE=B.MDATE JOIN #TERM_ID2 C     
 ON A.TERMINAL_ID=C.TERMINAL_ID                                        
 WHERE MDATE>=CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103)-1)                                          
 AND MDATE<=CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103)) AND  C.SERVERMAPPED NOT IN ('172.31.15.13','DIRECT')                                             
 GROUP BY MDATE,C.SERVERMAPPED                             
 ORDER BY MDATE                            
                     
 SELECT DISTINCT MDATE,[172.31.15.10]=ROUND(SUM([172.31.15.10]),2),[172.31.15.15]=ROUND(SUM([172.31.15.15]),2),                            
 [172.31.15.18]=ROUND(SUM([172.31.15.18]),2),                            
 [172.31.15.20]=ROUND(SUM([172.31.15.20]),2),[172.31.15.24]=ROUND(SUM([172.31.15.24]),2),                            
 [172.31.15.28]=ROUND(SUM([172.31.15.28]),2),                            
 [172.31.15.30]=ROUND(SUM([172.31.15.30]),2),[172.31.15.32]=ROUND(SUM([172.31.15.32]),2),                            
 [172.31.15.34]=ROUND(SUM([172.31.15.34]),2),[172.31.15.35]=ROUND(SUM([172.31.15.35]),2),                            
 [172.31.15.38]=ROUND(SUM([172.31.15.38]),2),[172.31.15.41]=ROUND(SUM([172.31.15.41]),2),                            
 [172.31.15.51]=ROUND(SUM([172.31.15.51]),2),[172.31.15.56]=ROUND(SUM([172.31.15.56]),2)                        
 FROM  #TEMP GROUP BY MDATE                            
 ORDER BY MDATE                                  
END                                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_turnover2
-- --------------------------------------------------
CREATE proc ebrok_turnover2 (@fdate as varchar(11),@tdate as varchar(11),@SERVER as varchar(15))                      
as

select segment=case when segment='BSECM' then 'ABLCM' when segment='NSECM' then 'ACDLCM' 
when segment='FO' then 'ACDLFO' when segment='MCX' then 'ACPLMCX' when segment='NCDEX' then 'ACPLNCDEX' 
else segment END,A.SAUDA_DATE,A.PARTY_CODE,TURNOVER=SUM(ISNULL(A.TURNOVER,0))--,TERMINAL_ID=B.TERMINAL_ID 
INTO #OFFLINE FROM mis.terminalmaster.dbo.ebrokingOfflineTrades A --LEFT OUTER JOIN bsedb_ab.dbo.mis_to B
--ON A.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS AND A.SAUDA_DATE=B.SAUDA_DATE
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                              
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))  
GROUP BY SEGMENT,A.SAUDA_DATE,A.PARTY_CODE
--DROP TABLE #OFFLINE

SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,TURNOVER=SUM(ISNULL(A.TURNOVER,0))
into #TOT_brok FROM bsedb_ab.dbo.mis_to A
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                              
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))  
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID

SELECT A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID,TURNOVER=SUM(ISNULL(A.TURNOVER,0))-SUM(ISNULL(B.TURNOVER,0))
into #online_brok FROM #TOT_brok (NOLOCK) A
LEFT OUTER JOIN #OFFLINE B ON A.PARTY_CODE=B.PARTY_CODE COLLATE SQL_Latin1_General_CP1_CI_AS 
AND A.SAUDA_DATE=B.SAUDA_DATE AND A.COMPANY=B.SEGMENT 
WHERE A.sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                              
 and A.sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))  
GROUP BY A.COMPANY,A.SAUDA_DATE,A.PARTY_CODE,A.TERMINAL_ID
         
--select * into #mis2       
--from bsedb_ab.dbo.mis_to (nolock)            
-- where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                      
-- and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))             
                   
 select sauda_date,company,party_code,nooftrade=sum(nooftrade),terminal_id into #trade1             
from mis_NoOfTrade (nolock)            
 where sauda_date>=convert(varchar(11),convert(datetime,@fdate,103))                      
 and sauda_date<=convert(varchar(11),convert(datetime,@tdate,103))             
group by sauda_date,company,party_code,terminal_id    
  
select distinct segment,terminal_id,servermapped,from_date,to_date   
into #term_id   
from mis.genodinlimit.dbo.ebrok_all_terminal_master   
where from_date<=convert(varchar(11),convert(datetime,@fdate,103)) and   
to_date>=convert(varchar(11),convert(datetime,@tdate,103))                   
            
  --select * from mis_NoOfTrade  order by sauda_date           
                   
select TERM_ID=a.terminal_id--,server=case when b.servermapped='Anywhere' then '172.31.15.51' else b.servermapped end                    
,ABLCM=case when a.company='ABLCM' then round(sum(turnover)/10000000,2) else 0 end,ABLCM_trade=case when a.company='ABLCM' then sum(isnull(nooftrade,0)) else 0 end                    
,ACDLCM=case when a.company='ACDLCM' then round(sum(turnover)/10000000,2) else 0 end,ACDLCM_trade=case when a.company='ACDLCM' then sum(isnull(nooftrade,0)) else 0 end                   
,ACDLFO=case when a.company='ACDLFO' then round(sum(turnover)/10000000,2) else 0 end,ACDLFO_trade=case when a.company='ACDLFO' then sum(isnull(nooftrade,0)) else 0 end                   
,ACPLMCX=case when a.company='ACPLMCX' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCX_trade=case when a.company='ACPLMCX' then sum(isnull(nooftrade,0)) else 0 end                   
,ACPLNCDEX=case when a.company='ACPLNCDEX' then round(sum(turnover)/10000000,2) else 0 end ,ACPLNCDEX_trade=case when a.company='ACPLNCDEX' then sum(isnull(nooftrade,0)) else 0 end                   
,ACPLMCD=case when a.company='ACPLMCD' then round(sum(turnover)/10000000,2) else 0 end,ACPLMCD_trade=case when a.company='ACPLMCD' then sum(isnull(nooftrade,0)) else 0 end                    
,ACDLNSX=case when a.company='ACDLNSX' then round(sum(turnover)/10000000,2) else 0 end,ACDLNSX_trade=case when a.company='ACDLNSX' then sum(isnull(nooftrade,0)) else 0 end                    
,total=round(sum(turnover)/10000000,2)     
into #file123 from #online_brok a (nolock) join #term_id b                    
on a.terminal_id=b.terminal_id              
LEFT OUTER join #trade1 c  (nolock) on  a.party_code=c.party_code collate Latin1_General_CI_AS               
--and a.sauda_date=c.sauda_date               
and a.company=c.company collate Latin1_General_CI_AS                
and a.terminal_id=c.terminal_id collate Latin1_General_CI_AS       
WHERE b.servermapped=@SERVER        
--where a.sauda_date>=convert(varchar(11),convert(datetime,'11/01/2010',103))                      
-- and a.sauda_date<=convert(varchar(11),convert(datetime,'11/01/2010',103))             
group by a.terminal_id,a.company             
order by  a.terminal_id            
--SELECT * FROM #file123            
            
select TERM_ID,ABLCM=sum(ABLCM),ABLCM_trade=sum(ABLCM_trade),ACDLCM=sum(ACDLCM),            
ACDLCM_trade=sum(ACDLCM_trade),ACDLFO=sum(ACDLFO),ACDLFO_trade=sum(ACDLFO_trade),            
ACPLMCD=sum(ACPLMCD),ACPLMCD_trade=sum(ACPLMCD_trade),            
ACPLMCX=sum(ACPLMCX),ACPLMCX_trade=sum(ACPLMCX_trade),ACPLNCDEX=sum(ACPLNCDEX),            
ACPLNCDEX_trade=sum(ACPLNCDEX_trade),ACDLNSX=sum(ACDLNSX),ACDLNSX_trade=sum(ACDLNSX_trade),total=sum(total)            
 from #file123 --where server<>''            
group by TERM_ID             
--order by  server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_untrained
-- --------------------------------------------------
CREATE  proc ebrok_untrained (@fdate as varchar(25),@tdate as varchar(25),@fdays as int,@tdays as int)              
as              
set nocount on              
select distinct name,party_code,ebrokingdate into #file1               
from mis.upload.dbo.ebrok_untrained_temp   
where convert(datetime,ebrokingdate,103) >=convert(datetime,@fdate,103)    
and convert(datetime,ebrokingdate,103) <=convert(datetime,@tdate,103)            
              
select party_code,user_stat,brokerage,sauda_date=convert(datetime,sauda_date,103)    
 into #ff2     
from mis_ebroking_cli (nolock)    
where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays     
    
select b.party_code,fbrokon=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103)-@fdays and sauda_date<=convert(datetime,b.ebrokingdate,103) and user_stat='e-broking' then brokerage else 0 end,            
fbrokoff=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103)-@fdays and sauda_date<=convert(datetime,b.ebrokingdate,103) and user_stat<>'e-broking' then brokerage else 0 end,              
tbrokon=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103) and sauda_date<=convert(datetime,b.ebrokingdate,103)+@tdays and user_stat='e-broking'  then brokerage else 0 end,            
tbrokoff=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103) and sauda_date<=convert(datetime,b.ebrokingdate,103)+@tdays and user_stat<>'e-broking'  then brokerage else 0 end,            
cnt=case when a.sauda_date>=convert(datetime,b.ebrokingdate,103)-@fdays and sauda_date<=convert(datetime,b.ebrokingdate,103)+@tdays  then 1 else 0 end into #file2              
from   #file1 b left outer join #ff2 a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS              
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays             
group by b.party_code,a.sauda_date,b.trainingdate,a.brokerage,a.user_stat              
              
select party_code,fbrokon=sum(fbrokon),fbrokoff=sum(fbrokoff),tbrokon=sum(tbrokon),tbrokoff=sum(tbrokoff),cnt=sum(cnt) into #file3 from #file2 group by party_code              
             
select distinct a.*,b.fbrokon,b.fbrokoff,b.tbrokon,b.tbrokoff,b.cnt into #f from #file3 b join mis.upload.dbo.ebrok_untrained_temp a            
on b.party_code=a.party_code order by a.party_code       
          
--delete from mis.upload.dbo.ebrok_training_temp      
select * from #f      
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebroking_login_status_pro
-- --------------------------------------------------
CREATE Procedure ebroking_login_status_pro(@fdate as varchar(25),@tdate as varchar(25))  
as  
 Set nocount on  
 Set transaction isolation level read uncommitted  
 delete from ebrok_log_status where sauda_date>=@fdate and sauda_date<=@tdate  
 Insert into ebrok_log_status  
 SELECT a.BRANCH_CD,a.SUB_BROKER,a.PARTY_CODE,bse_br=sum(bse_br),   
 E_BSE=(CASE WHEN BSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EBSE_BR))>0 THEN sum(EBSE_BR) ELSE 0 END ) ELSE -1 END ),   
 nse_br=sum(nse_br), E_NSE=(CASE WHEN NSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENSE_BR))>0 THEN sum(ENSE_BR) ELSE 0 END ) ELSE -1 END ),   
 fo_br=sum(fo_br), E_FO=(CASE WHEN FO_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EFO_BR))>0 THEN sum(EFO_BR) ELSE 0 END ) ELSE -1 END ),  
 mcx_br=sum(mcx_br), E_MCX=(CASE WHEN MCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EMCX_Br))>0 THEN sum(EMCX_Br) ELSE 0 END ) ELSE -1 END ),  
 ncdex_br=sum(ncdex_br),  
 E_NCDX=(CASE WHEN NCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENCDEX_Br))>0 THEN sum(ENCDEX_Br) ELSE 0 END ) ELSE -1 END ),  
 TOTAL_SEG=sum(BSE_BR+NSE_BR+FO_BR+MCX_BR+NCDEX_BR), ebrok_br=SUM(ebrok_br) ,  
 BSE_STAT,NSE_STAT,FO_STAT,MCDX_STAT,NCDX_STAT,nooflogin=count(nooflogin),a.sauda_date  
 from Ebrok_mis1 a (nolock) left outer join (select * from MIS_ebroking_cli (nolock) where sauda_date>=@fdate and sauda_date<=@tdate )b  
 on a.party_Code =b.party_Code --and a.sauda_date=b.sauda_date  
 where a.sauda_date>=@fdate and a.sauda_date<=@tdate  
 GROUP BY a.BRANCH_CD,a.SUB_BROKER,a.PARTY_CODE,BSE_STAT,NSE_STAT,FO_STAT,MCDX_STAT,NCDX_STAT,a.sauda_date order by a.PARTY_CODE   
 Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.gen_ctcl_limit_file_07022007
-- --------------------------------------------------
create procedure gen_ctcl_limit_file_07022007 (@code as varchar(10))  
as  
  
set nocount on  
  
--- Capture Cash Details : Ledger + Holdings  
set transaction isolation level read uncommitted                
select branch_cd=isnull(b.sbtag,''),sub_broker=isnull(b.subgroup,''),a.party_code,groupID,Cash_bal=isnull(abl,0)+isnull(acdl,0)-isnull(cash_deposit,0),Status=(case when b.party_code is null then 'New' else 'Existing' end),  
holding=isnull(holding,0),cash_appr=isnull(appr,0)  
into #file1  
from   
(select * from mis.dbo.ctcl_client_79 /*where party_code in ('H5555','A12222','H331','V613','D4674','P11000','N8384','H6162','BC35')*/)  
a left outer join collection_client_details b (nolock) on a.party_code=b.party_Code and branch_cd=@code  
  
--- Capture FO Details : Ledger + Cash & Non-cash Colleterals  
update #file1 set cash_bal=cash_bal+b.ledgerbal-cash_coll,cash_appr=cash_appr+non_cash from  
(select clCode,ledgerbal=-ledgeramount,non_cash,cash_coll from fomarh (nolock) where sauda_date=(select max(sauda_Date) from fomarh (nolock))) b  
where #file1.party_code=b.clcode  
  
--select * from fomarh where sauda_date=(select max(sauda_Date) from fomarh)  
/*  
--- Capture MCX Details : Ledger + Cash & Non-cash Colleterals  
update #file1 set cash_bal=cash_bal+b.ledgerbal-cash_coll,cash_appr=cash_appr+non_cash  from  
(select clCode,ledgerbal=-ledgeramount,non_cash,cash_coll from mcdx_marh where sauda_date=(select max(sauda_Date) from mcdx_marh)) b  
where #file1.party_code=b.clcode  
  
--- Capture NCDEX Details : Ledger + Cash & Non-cash Colleterals  
update #file1 set cash_bal=cash_bal+b.ledgerbal-cash_coll,cash_appr=cash_appr+non_cash  from  
(select clCode,ledgerbal=-ledgeramount,non_cash,cash_coll from ncdx_marh where sauda_date=(select max(sauda_Date) from ncdx_marh)) b  
where #file1.party_code=b.clcode  
*/  
  
--- Update Branch Code and Sub-broker Code  
update #file1 set branch_cd=b.branch_cd, sub_Broker=b.sub_Broker   
from client_details b (nolock) where #file1.party_code=b.party_code  
and #file1.branch_cd=''  
  
--- Set Multiplier as defined in Branchwise Limit Master  
set transaction isolation level read uncommitted                
select *,gross_exp=convert(money,0) into #file2 from #file1 a left outer join    
(select code=branch_cd,LmtMulti,MtmLimit,MinLimit,MaxLimit,DrAllowed,MaxCollLimit,CashMulti,NonCashMulti from mis.dbo.BrCTCLLimitMaster ) b on a.branch_cd=b.code  
where code is not null  
  
--- Set Multiplier as defined in Sub-brokerwise Limit Master  
update #file2 set   
LmtMulti=b.LmtMulti,  
MtmLimit=b.MtmLimit,  
MinLimit=b.MinLimit,  
MaxLimit=b.MaxLimit,  
DrAllowed=b.DrAllowed,  
MaxCollLimit=b.MaxCollLimit,  
CashMulti=b.CashMulti,  
NonCashMulti=b. NonCashMulti  
from mis.dbo.SBCTCLLimitMaster b  
where #file2.sub_Broker=b.sub_Broker  
  
--- Set Multiplier as defined in Clientwise Limit Master  
update #file2 set   
LmtMulti=b.LmtMulti,  
MtmLimit=b.MtmLimit,  
MinLimit=b.MinLimit,  
MaxLimit=b.MaxLimit,  
DrAllowed=b.DrAllowed,  
MaxCollLimit=b.MaxCollLimit,  
CashMulti=b.CashMulti,  
NonCashMulti=b. NonCashMulti  
from mis.dbo.cliCTCLLimitMaster b  
where #file2.party_code=b.party_Code  
  
--- Set Max Colleteral Value  
update #file2 set cash_Appr=MaxCollLimit where MaxCollLimit >= 0 and cash_Appr > MaxCollLimit  
update #file2 set groupid=(case when groupid='' then 'HO' else groupid end)  
  
--- Calculate Gross Exposure  
update #file2 set   
gross_exp=  
(case when  cash_bal < 0 then (cash_bal*-1)*cashmulti else 0 end)+  
(case when cash_appr > 0 then cash_appr*NonCashMulti else 0 end)  
  
--- Calculate MAx and Min Gross Exposure  
update #file2 set gross_exp=minlimit where minlimit >= 0 and gross_exp < minlimit  
update #file2 set gross_exp=maxlimit where maxlimit >= 0 and gross_exp > maxlimit  
  
---------------------- Overall Gross Exposure  
select * into #Fin1 from  
(  
select data='1|'+party_code+'|'+groupid+'|'+convert(varchar(15),gross_exp)+'|||||170|||||1|'+convert(varchar(15),gross_exp)+'|-1|-1|-1|-1|-1|-1|-1|-1|0|-1|-1|-1|-1|-1|-1|-1|-1|0|0|1|-1' from #file2   
union all  
--select data='1|'+party_code+'|'+groupid+'|'+convert(varchar(15),gross_exp)+'|||||17|||||1|'+convert(varchar(15),gross_exp)+'|-1|-1|-1|-1|-1|-1|-1|-1|0|-1|1|'+convert(varchar(15),mtmlimit)+'|1|'+convert(varchar(15),mtmlimit)+'|-1|-1|-1|0|0|1|-1'   
select data='1|'+party_code+'|'+groupid+'|'+convert(varchar(15),gross_exp)+'|||||17|||||-1|'+convert(varchar(15),gross_exp)+'|-1|-1|-1|-1|-1|-1|-1|-1|0|-1|2|'+convert(varchar(15),mtmlimit)+'|1|'+convert(varchar(15),mtmlimit)+'|-1|-1|-1|-1|-1|0|1|1|-1'   
from #file2   
union all  
select data='2|'+party_code+'|'+groupid+'|'+convert(varchar(15),gross_exp)+'|||||170|||||1|'+convert(varchar(15),gross_exp)+'|-1|-1|-1|-1|-1|-1|-1|-1|0|-1|-1|-1|-1|-1|-1|-1|-1|0|0|1|-1' from #file2   
union all  
select data='2|'+party_code+'|'+groupid+'|'+convert(varchar(15),gross_exp)+'|||||17|||||1|'+convert(varchar(15),gross_exp)+'|-1|-1|-1|-1|-1|-1|-1|-1|0|-1|1|'+convert(varchar(15),mtmlimit)+'|1|'+convert(varchar(15),mtmlimit)+'|-1|-1|-1|0|0|1|-1'   
from #file2   
) a  
  
----------------------- NSE Derivatives  
select * into #risk_file from mis.remisior.dbo.comp_collection   
  
select * into #Fin2 from  
(  
select data='1|'+a.party_code+'|'+groupid+'|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|||||40|||||1|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1
  
|-1|-1|-1|-1|-1|-1|0|-1|0|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
union all  
select data='1|'+a.party_code+'|'+groupid+'|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|||||4|||||1|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|
  
-1|1|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|-1|-1|-1|0|0|0|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
union all  
select data='2|'+a.party_code+'|'+groupid+'|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|||||40|||||1|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1
  
|-1|-1|-1|-1|-1|-1|0|-1|0|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
union all  
select data='2|'+a.party_code+'|'+groupid+'|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|||||4|||||1|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|
  
-1|1|'+convert(varchar(10),(case when isnull(risk,0) > 0 then 0 else 9999999999 end))+'|-1|-1|-1|0|0|0|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
) a  
  
  
------------------ BSE & NSE Equities - block new purchase if Projected risk > 0 or Dr.Value exceeds 90% of approved holdings  
  
select * into #Fin3 from  
(  
select data='1|'+a.party_code+'|'+groupid+'|9999999999|||||70|||||1|9999999999|-1|'+  
convert(varchar(10),(case when cash_bal > 0 and cash_bal > (cash_appr*90/100) then 0 when isnull(risk,0) > 0 then 0 else 9999999999 end))  
+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|0|0|-1|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
union all  
select data='1|'+a.party_code+'|'+groupid+'|9999999999|||||7|||||1|9999999999|-1|'+  
convert(varchar(10),(case when cash_bal > 0 and cash_bal > (cash_appr*90/100) then 0 when isnull(risk,0) > 0 then 0 else 9999999999 end))  
+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|9999999999|1|9999999999|-1|-1|-1|0|0|-1|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
union all  
select data='2|'+a.party_code+'|'+groupid+'|9999999999|||||70|||||1|9999999999|-1|'+  
convert(varchar(10),(case when cash_bal > 0 and cash_bal > (cash_appr*90/100) then 0 when isnull(risk,0) > 0 then 0 else 9999999999 end))  
+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|-1|0|0|-1|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
union all  
select data='2|'+a.party_code+'|'+groupid+'|9999999999|||||7|||||1|9999999999|-1|'+  
convert(varchar(10),(case when cash_bal > 0 and cash_bal > (cash_appr*90/100) then 0 when isnull(risk,0) > 0 then 0 else 9999999999 end))  
+'|-1|-1|-1|-1|-1|-1|-1|-1|-1|9999999999|1|9999999999|-1|-1|-1|0|0|-1|-1'  
from #file2 a left outer join #risk_file b on a.party_code=b.party_code   
)  a  
  
------------------ NSE Futures : Open Position (Gross Exposure + 10% of the same) + (6 times of Credit available )   
  
select * into #Fin4 from   
(  
select   
data='1|'+party_code+'|'+groupid+'|9999999999|||||20|||||1|999999999|-1|-1|-1|-1|-1|'  
+convert(varchar(15),  
convert(money,gross_exp+(case when gross_exp > 0 then gross_exp*10/100 else 0 end)+(  
case when cash_bal < 0 then (cash_bal*-1)*cashmulti else 0 end ))  
)+'|-1|-1|1|-1|1|-1|-1|-1|-1|999999999|99999999|0|0|-1|-1'  
from #file2   
  
union all   
  
select   
data='1|'+party_code+'|'+groupid+'|9999999999|||||2|||||1|999999999|-1|-1|-1|-1|-1|'  
+convert(varchar(15),  
convert(money,gross_exp+(case when gross_exp > 0 then gross_exp*10/100 else 0 end)+(  
case when cash_bal < 0 then (cash_bal*-1)*cashmulti else 0 end ))  
)+'|-1|-1|1|-1|1|-1|-1|-1|-1|999999999|99999999|0|0|-1|-1'  
from #file2   
  
union all  
  
select   
data='2|'+party_code+'|'+groupid+'|9999999999|||||20|||||1|999999999|-1|-1|-1|-1|-1|'  
+convert(varchar(15),  
convert(money,gross_exp+(case when gross_exp > 0 then gross_exp*10/100 else 0 end)+(  
case when cash_bal < 0 then (cash_bal*-1)*cashmulti else 0 end ))  
)+'|-1|-1|1|-1|1|-1|-1|-1|-1|999999999|99999999|0|0|-1|-1'  
from #file2   
  
union all   
  
select   
data='2|'+party_code+'|'+groupid+'|9999999999|||||2|||||1|999999999|-1|-1|-1|-1|-1|'  
+convert(varchar(15),  
convert(money,gross_exp+(case when gross_exp > 0 then gross_exp*10/100 else 0 end)+(  
case when cash_bal < 0 then (cash_bal*-1)*cashmulti else 0 end ))  
)+'|-1|-1|1|-1|1|-1|-1|-1|-1|999999999|99999999|0|0|-1|-1'  
from #file2   
) a  
  
------------------------ Calculate FO option Open position  
  
declare @tdate as datetime  
select @tdate=max(trade_date) from ANGELFO.NSEFO.DBO.foclosing where trade_Date <= getdate()  
  
set transaction isolation level read uncommitted                
select * into #foclosing from ANGELFO.NSEFO.DBO.foclosing where trade_DAte=@tdate     
    
set transaction isolation level read uncommitted              
select * into #fotrade from ANGELFO.NSEFO.DBO.fobillvalan where sauda_Date=@tdate     
        
set transaction isolation level read uncommitted                
select a.*,cls_rate=isnull(b.cl_rate,0)           
into #fofile          
from #fotrade a left outer join #foclosing b on          
a.expirydate=b.expirydate and a.inst_type=b.inst_Type and a.symbol=b.symbol and a.option_type=b.option_type          
and a.strike_price=b.strike_price          
          
set transaction isolation level read uncommitted                
select a.party_code,inst_type,  
option_sell_value=abs(sum((prate*pqty)-(srate*sqty)))  
into #fofile1  
from #fofile A, (select * from mis.dbo.ctcl_client_79 (nolock) where branch_Cd=@code) B    
WHERE A.PARTY_cODE=B.Party_CODE and inst_type not like 'FUT%'  
group by a.party_code,inst_type  
having sum(pqty-sqty) < 0 and sum((prate*pqty)-(srate*sqty)) < 0  
  
select *,premium_expiry=option_sell_value+(option_sell_value*20/100) into #fofile2 from #fofile1  
  
  
  
update #fofile2 set premium_expiry=premium_expiry+(case when b.ledgeramount > 0 then ledgeramount else 0 end)+cash_coll from  
(select clCode,ledgeramount,non_cash,cash_coll from fomarh where sauda_date=(select max(sauda_Date) from fomarh)) b  
where #fofile2.party_Code=b.clCode  
   
select * into #fin5 from  
(  
select data='1|'+a.party_code+'|'+groupid+'|9999999999|||||30|||||-1|-1|1|'+  
convert(varchar(15),convert(money,(case when premium_expiry is not null and  premium_expiry > 0 then premium_expiry else 0 end)))  
+'|1|9999999999|-1|-1|-1|-1|1|-1|-1|-1|-1|-1|-1|100000000|10000|0|-1|-1|-1'  
 from #file2 a left outer join #fofile2 b on a.party_code=b.party_code  
union all  
select data='1|'+a.party_code+'|'+groupid+'|9999999999|||||3|||||-1|-1|1|'+  
convert(varchar(15),convert(money,(case when premium_expiry is not null and  premium_expiry > 0 then premium_expiry else 0 end)))  
+'|1|9999999999|-1|-1|-1|-1|1|-1|-1|-1|-1|-1|-1|100000000|10000|0|-1|-1|-1'  
 from #file2 a left outer join #fofile2 b on a.party_code=b.party_code  
union all  
select data='2|'+a.party_code+'|'+groupid+'|9999999999|||||30|||||-1|-1|1|'+  
convert(varchar(15),convert(money,(case when premium_expiry is not null and  premium_expiry > 0 then premium_expiry else 0 end)))  
+'|1|9999999999|-1|-1|-1|-1|1|-1|-1|-1|-1|-1|-1|100000000|10000|0|-1|-1|-1'  
 from #file2 a left outer join #fofile2 b on a.party_code=b.party_code  
union all  
select data='2|'+a.party_code+'|'+groupid+'|9999999999|||||3|||||-1|-1|1|'+  
convert(varchar(15),convert(money,(case when premium_expiry is not null and  premium_expiry > 0 then premium_expiry else 0 end)))  
+'|1|9999999999|-1|-1|-1|-1|1|-1|-1|-1|-1|-1|-1|100000000|10000|0|-1|-1|-1'  
 from #file2 a left outer join #fofile2 b on a.party_code=b.party_code  
) a  
  
---- Generate Limit File  
select * from  
(  
select * from #fin1  
union   
select * from #fin2  
union   
select * from #fin3  
union   
select * from #fin4  
union   
select * from #fin5  
) a  
  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GenerateAnalysisMis
-- --------------------------------------------------
CREATE  Procedure GenerateAnalysisMis (@FromDate Varchar(11),@Todate Varchar(11),@Level As Int)  
As  
  
--dump transaction bsedb_ab with no_log  
--dump transaction tempdb with no_log  
  
Declare  
@@From_Year As Char(4),  
@@To_Year As Char(4),  
@@From_Month As int,  
@@To_Month As int,  
@@From_Date As int,  
@@To_date As int  
  
Select @@From_Year  = DatePart(Year,@Fromdate)  
Select @@To_Year  = DatePart(Year,@Todate)  
  
Select @@From_Month  = DatePart(Month,@Fromdate)  
Select @@To_Month  = DatePart(Month,@Todate)  
  
Select @@From_Year,@@To_Year,@@From_Month,@@To_Month  
  
  
If @Level = 1  
Begin  
Delete Level2Mis Where Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Insert Into Level2Mis   
select ExchangeSegment = ExchangeSegment,Year = Datepart(Year,Sauda_date),Month = Datepart(Month,Sauda_date),Party_code = Party_code,Party_name = Party_Name,Family = Family,Family_Name = Family_Name,Terminal_Id = Terminal_Id,Client_Type = ClientType,Trade_type = TradeType,  
Trader = Trader,Sub_Broker = Sub_Broker,Branch_cd = Branch_cd,ParticipantCode = ParticipantCode,TradingPurQty = Sum(TP),TradingPurAmt = Sum(TPA),DeliveryPurQty = Sum(DP),DeliveryPurAmt = Sum(DPA),TradingSaleQty = Sum(TS),TradingSaleAmt = Sum(TSA),DeliverySaleQty = Sum(DS),  
DeliverySaleAmt = Sum(DSA),TradingPurBrok = Sum(TPB),TradingSaleBrok = Sum(TSB),DeliveryPurBrok = Sum(DPB),DeliverySaleBrok = Sum(DSB),Service_tax = Sum(Service_Tax),NotAppSertax = Sum(NSerTax),Turn_tax = Sum(Turn_Tax),Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = 
Sum(Ins_Chrg),Broker_chrg = Sum(Broker_Chrg),Other_chrg = Sum(Other_Chrg),Min(Sauda_date),Max(Sauda_date),Sum(ActBrok),Sum(AngelBrok)  
From level1mis  
Where  
/* Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'  */  
DatePart(Month,Sauda_date) >=  @@From_Month  
And  
DatePart(Month,Sauda_date) <=  @@To_Month  
And  
DatePart(Year,Sauda_date) >=  @@From_Year  
And  
DatePart(Year,Sauda_date) <=  @@To_Year  
  
Group by  
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Party_code,Party_Name,Family,Family_Name,Terminal_Id,ClientType,TradeType,  
Trader,Sub_Broker,Branch_cd,ParticipantCode   
End  
  
Begin  
Delete Level3Mis Where Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Insert Into Level3Mis   
select ExchangeSegment = ExchangeSegment,Year = Year,Month = Month,Family = Family,Family_Name = Family_Name,  
Trader = Trader,Sub_Broker = Sub_Broker,Branch_cd = Branch_cd,TradingPurQty = Sum(TradingPurQty),TradingPurAmt = Sum(TradingPurAmt),DeliveryPurQty = Sum(DeliveryPurQty),DeliveryPurAmt = Sum(DeliveryPurAmt),
TradingSaleQty = Sum(TradingSaleQty),TradingSaleAmt = Sum(TradingSaleAmt),DeliverySaleQty = Sum(DeliverySaleQty),  
DeliverySaleAmt = Sum(DeliverySaleAmt),TradingPurBrok = Sum(TradingPurBrok),TradingSaleBrok = Sum(TradingSaleBrok),DeliveryPurBrok = Sum(DeliveryPurBrok),DeliverySaleBrok = Sum(DeliverySaleBrok),Service_tax = Sum(Service_Tax),NotAppSertax = Sum(NotAppSertax),Turn_tax = Sum(Turn_Tax),Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_chrg = Sum(Broker_Chrg),Other_chrg = Sum(Other_Chrg),Min(From_date),Max(To_date),Sum(ActBrok),Sum(AngelBrok)  
from level2mis  
Where  
/*From_Date >= @FromDate  
And  
To_Date <= @ToDate + ' 23:59:00'   
*/  
 Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Group by  
ExchangeSegment,Year,Month,Family,Family_Name,Trader,Sub_Broker,Branch_cd  
End  
  
Begin  
Delete Level4Mis  Where Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Insert Into Level4Mis   
select ExchangeSegment = ExchangeSegment,Year = Year,Month = Month, Sub_Broker = Sub_Broker,Branch_cd = Branch_cd,TradingPurQty = Sum(TradingPurQty),TradingPurAmt = Sum(TradingPurAmt),DeliveryPurQty = Sum(DeliveryPurQty),DeliveryPurAmt = Sum(DeliveryPurAmt),TradingSaleQty = Sum(TradingSaleQty),TradingSaleAmt = Sum(TradingSaleAmt),DeliverySaleQty = Sum(DeliverySaleQty),  
DeliverySaleAmt = Sum(DeliverySaleAmt),TradingPurBrok = Sum(TradingPurBrok),TradingSaleBrok = Sum(TradingSaleBrok),DeliveryPurBrok = Sum(DeliveryPurBrok),DeliverySaleBrok = Sum(DeliverySaleBrok),Service_tax = Sum(Service_Tax),NotAppSertax = Sum(NotAppSertax),Turn_tax = Sum(Turn_Tax),Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_chrg = Sum(Broker_Chrg),Other_chrg = Sum(Other_Chrg),From_Date = Min(From_date), To_Date = Max(To_date),Sum(ActBrok),Sum(AngelBrok)  
from level3mis  
Where  
/* From_Date >= @FromDate  
And  
To_Date <= @ToDate + ' 23:59:00' */  
Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Group by  
ExchangeSegment,Year,Month,Sub_Broker,Branch_cd  
End  
  
Begin  
Delete Level5Mis Where Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Insert Into Level5Mis   
--Select * into Level5Mis From (  
select ExchangeSegment = ExchangeSegment,Year = Year,Month = Month, Branch_cd = Branch_cd,
TradingPurQty = Sum(TradingPurQty),TradingPurAmt = Sum(TradingPurAmt),DeliveryPurQty = Sum(DeliveryPurQty),
DeliveryPurAmt = Sum(DeliveryPurAmt),TradingSaleQty = Sum(
TradingSaleQty),TradingSaleAmt = Sum(TradingSaleAmt),DeliverySaleQty = Sum(DeliverySaleQty),  
DeliverySaleAmt = Sum(DeliverySaleAmt),TradingPurBrok = Sum(TradingPurBrok),TradingSaleBrok = Sum(TradingSaleBrok),DeliveryPurBrok = Sum(DeliveryPurBrok),DeliverySaleBrok = Sum(DeliverySaleBrok),
Service_tax = Sum(Service_Tax),NotAppSertax = Sum(NotAppSertax),Turn_tax = Sum(Turn_Tax),
Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_chrg = Sum(Broker_Chrg),Other_chrg = Sum(Other_Chrg),
From_Date = Min(From_date), To_Date = Max(To_date),Sum(ActBrok),Sum(AngelBrok)  
from level4mis  
Where  
/*From_Date >= @FromDate  
And  
To_Date <= @ToDate + ' 23:59:00'  */  
Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Group by  
ExchangeSegment,Year,Month,Branch_cd    
End  
  
  
Begin  
Delete Level6Mis  Where Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Insert Into Level6Mis   
--Select * into Level6Mis From (  
Select ExchangeSegment = ExchangeSegment,Year = Year,Month = Month, TradingPurQty = Sum(TradingPurQty),
TradingPurAmt = Sum(TradingPurAmt),DeliveryPurQty = Sum(DeliveryPurQty),DeliveryPurAmt = Sum(DeliveryPurAmt),
TradingSaleQty = Sum(TradingSaleQty),TradingSaleAmt = Sum(TradingSaleAmt),DeliverySaleQty = Sum(DeliverySaleQty),  
DeliverySaleAmt = Sum(DeliverySaleAmt),TradingPurBrok = Sum(TradingPurBrok),TradingSaleBrok = Sum(TradingSaleBrok),DeliveryPurBrok = Sum(DeliveryPurBrok),DeliverySaleBrok = Sum(DeliverySaleBrok),
Service_tax = Sum(Service_Tax),NotAppSertax = Sum(NotAppSertax),Turn_tax = Sum(Turn_Tax),Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_chrg = Sum(Broker_Chrg),Other_chrg = Sum(Other_Chrg),From_Date = Min(From_date), To_Date = Max(To_date),Sum(ActBrok),Sum(AngelBrok)  
from level5mis  
Where  
/*From_Date >= @FromDate  
And  
To_Date <= @ToDate + ' 23:59:00'  */  
Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
Group by  
ExchangeSegment,Year,Month   --) A   
End  
  
  
Delete Level6FYearMis  --Where Year >= @@From_Year and Year <= @@To_Year And Month >= @@From_Month And Month <= @@To_Month  
  
Insert Into Level6FYearMis Select   
       ExchangeSegment, Year,Month,TradingPurQty, TradingPurAmt,DeliveryPurQty, DeliveryPurAmt,TradingSaleQty, TradingSaleAmt,          
       DeliverySaleQty, DeliverySaleAmt,TradingPurBrok,TradingSaleBrok,DeliveryPurBrok,DeliverySaleBrok,Service_tax,NotAppSertax,Turn_tax,  
       Sebi_Tax,Ins_Chrg,Broker_chrg,Other_chrg,From_Date,To_Date,ActBrok,AngelBrok,'' From Level6Mis      
  
  
Update level6FYearMis Set FinYear = (Case When CMonth <= 3 Then Cast((Cyear) As Varchar(11)) + '-' + Cast((Cyear-1) As Varchar(11)) Else Cast((Cyear) As Varchar(11)) + '-' + Cast((Cyear+1) As Varchar(11)) End)   
From  level6FYearMis  
  
If @Level = 3  
Begin  select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Family,Family_Name,  
Trader,Sub_Broker,Branch_cd,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Family,Family_Name,  
Trader,Sub_Broker,Branch_cd  
Order by   
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Family,Family_Name,  
Trader,Sub_Broker,Branch_cd  
End  
If @Level = 4  
Begin  
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Trader,Sub_Broker,Branch_cd,ParticipantCode,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Trader,Sub_Broker,Branch_cd,ParticipantCode  
Order by   
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Trader,Sub_Broker,Branch_cd,ParticipantCode  
End  
If @Level = 5  
Begin  
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sub_Broker,Branch_cd,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sub_Broker,Branch_cd  
Order by   
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sub_Broker,Branch_cd  
End  
If @Level = 6  
Begin  
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Branch_cd,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Branch_cd  
Order by   
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Branch_cd  
End  
If @Level = 7  
Begin  
select ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date),Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date)  
Order by   
ExchangeSegment,Datepart(Year,Sauda_date),Datepart(Month,Sauda_date)  
End  
If @Level = 8  
Begin  
select ExchangeSegment,Datepart(Year,Sauda_date),Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
ExchangeSegment,Datepart(Year,Sauda_date)  
Order by   
ExchangeSegment,Datepart(Year,Sauda_date)  
End  
If @Level = 9  
Begin  
select Datepart(Year,Sauda_date),Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis   
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
Datepart(Year,Sauda_date)  
Order by   
Datepart(Year,Sauda_date)  
End  
  
If @Level = 10  
Begin  
select ExchangeSegment,Sauda_date,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
Exchangesegment,Sauda_date  
Order by   
Exchangesegment,Sauda_date  
End  
  
If @Level = 11  
Begin  
select Sauda_date,Sum(TP),Sum(TPA),Sum(DP),Sum(DPA),Sum(TS),Sum(TSA),Sum(DS),  
Sum(DSA),Sum(TPB),Sum(TSB),Sum(DPB),Sum(DSB),Sum(Service_Tax),Sum(NSerTax),Sum(Turn_Tax),Sum(Sebi_Tax),Sum(Ins_Chrg),Sum(Broker_Chrg),Sum(Other_Chrg)  
from level1mis  
Where  
Sauda_date >= @FromDate  
And  
Sauda_Date <= @ToDate + ' 23:59:00'   
Group by  
Sauda_date  
Order by   
Sauda_date  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GenerateMisReportw
-- --------------------------------------------------
CREATE Procedure GenerateMisReportw(@RptType as Varchar(20),@FromDate as datetime,@ToDate as datetime,@Branch_code as varchar(20),@Party_code  varchar(20))

as 

set transaction isolation level read uncommitted

set nocount on

select company,party_Code,Branch_cd,Sub_broker,sauda_date,a.terminal_id,turnover=sum(turnover),brokerage=sum(brokerage)  into #file1 from mis_to a, 

(select * from mis.terminalmaster.dbo.tbl_mst_Terminals 
)b where a.sauda_Date>=activation_Date and sauda_date<=deactivation_Date 
and a.terminal_id = b.terminal_id
and sauda_date>=@FromDate and sauda_date<=@ToDate
group by party_Code,sauda_date,a.terminal_id,company,party_code,Branch_cd,sub_broker

If @RptType='Es' 
begin 
select
executive,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage) 
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code  
group by executive order by executive 

end 

else  if @RptType='Ed'
begin 

select a.party_code,executive,sub_broker,branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),
ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then 
Brokerage else 0 end)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by executive,a.party_code,branch_cd,sub_broker order by executive
end 

else  if @RptType='dd'
begin 

select sauda_date,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),ABLCM_BRK=sum(case when company='ABL
CM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then 
Brokerage else 0 end)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sauda_date order by sauda_date
end 

else  if @RptType='sd'

begin 
select sauda_date,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sauda_date order by sauda_date
end 
else  if @RptType='cd'
begin 

select a.party_code,sub_broker,branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),ABLCM_BRK=sum
(case when company='ABLCM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then 
Brokerage else 0 end)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by a.party_code,branch_cd,sub_broker order by a.party_code
end 

else  if @RptType='cs'

begin 
select a.Party_code,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by a.party_code order by a.party_code
end 

else  if @RptType='bd'
begin 

select branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),ABLCM_BRK=sum(case when company='ABLC
M' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then 
Brokerage else 0 end)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by branch_cd order by branch_cd
end 

else  if @RptType='Bs'

begin 
select branch_cd,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by branch_cd order by branch_cd
end 

else  if @RptType='SbS'

begin 
select sub_broker,branch_cd,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by  sub_broker,branch_cd order by  sub_broker,branch_cd
end 

else  if @RptType='Sbd'
begin 

select sub_broker,branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),
ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then 
Brokerage else 0 end)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sub_broker,branch_cd order by sub_broker,branch_cd
end 

else  if @RptType='Exe'
begin 

select a.party_code,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),ABLCM_BRK=sum(case when company='A
BLCM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then 
Brokerage else 0 end)
from #file1 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
and executive like @Branch_code and a.party_code like @Party_code 
group by a.party_code order by a.party_code
end

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GenMisReport
-- --------------------------------------------------
CREATE Procedure GenMisReport 
@Report as varchar(10),
@FromDate as datetime, 
@Todate as datetime, 
@Party_code as varchar(20),
@Branch_code as varchar(20)
  
as 
	If @Report='Date Summary' 
begin
	

		select Sauda_Date,sum(Turnover) as Turnover,sum(brokerage) as Brokerage FROM mis_to a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
		a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
		and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
		and branch_cd like '%' and party_code like '%' 
		group by sauda_date order by sauda_date
end 

ELSE  if  @Report='Date Detail'
	begin
		select Sauda_Date,ABLCM_TO=sum(case when company='ABLCM' then Turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
		,Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end) 
		from mis_to  a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
		a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
		and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
		and branch_cd like '%' and party_code like '%' 
		group by sauda_date order by sauda_date
	end 
ELSE if @Report='Client Summary'
	Begin 
		select Party_code, sum(Turnover) as Turn,sum(brokerage) as Brok 
		from mis_to  a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
		a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
		and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
		and branch_cd like '%' and party_code like '%' 
		group by Party_code order by Party_code
	End 


ELSE If @Report='Client Detail'
	Begin	
		select party_code,sub_broker,branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage),
		Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end)
		from mis_to  a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
		a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
		and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
		and branch_cd like '%' and party_code like '%' 
		group by party_code,sub_broker,branch_cd order by Party_code
	end 
	

ELSE If @Report='Branch Detail'

	Begin
		select branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end), ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end),Tot_to=sum(turnover),tot_brok=sum(brokerage) from mis_to a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
		a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
		and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
		and branch_cd like '%' and party_code like '%' 
		group by branch_cd order by branch_cd
	End 

ELSE 	If @Report='Branch Summary' 

	Begin
		select branch_cd,Tot_to=sum(turnover),Tot_brok=sum(brokerage) from mis_to a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
		a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
		and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
		and branch_cd like '%' and party_code like '%' 
		group by branch_cd order by branch_cd
	end 
-- 
ELSE 	if @Report='SubBroker Summary'

 	Begin
		select sub_broker,Branch_cd,Tot_to=sum(turnover),Tot_brok=sum(brokerage) from mis_to a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
		a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
		and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
		and branch_cd like '%' and party_code like '%' 
		group by sub_broker,Branch_cd order by Branch_cd,sub_broker
	end 

ELSE if @Report='SubBroker Detail'

		Begin 
			select sub_broker,branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end), ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end),Tot_to=sum(turnover),tot_brok=sum(brokerage) from mis_to a left join MIS.TerminalMaster.dbo.tbl_mst_Terminals b on 
			a.Terminal_Id=b.Terminal_id where sauda_date>=@FromDate and sauda_date<=@ToDate 
			and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
			and branch_cd like '%' and party_code like '%' 
			group by branch_cd,sub_broker order by branch_cd,sub_broker
		End 

ELSE IF @Report='Exe Detail'

		Begin 
			select a.party_code,executive,sub_broker,branch_cd,ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),ACDLCM_TO=sum(case when company='ACDLCM'  then turnover else 0 end),ACDLFO_TO=sum(case when company='ACDLFO'  then turnover else 0 end),ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),ACDLCM_BRK=sum(case when company='ACDLCM'  then brokerage else 0 end),ACDLFO_BRK=sum(case when company='ACDLFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage),
			Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end)
			from mis_to a  join  mis.terminalmaster.dbo.tbl_mst_Terminals b on a.terminal_id=b.terminal_id join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
			where sauda_date>=@FromDate and sauda_date<=@ToDate 
			and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
			and branch_cd like '%' and a.party_code like '%' 
			group by executive,a.party_code,sub_broker,branch_cd order by executive,a.party_code,sub_broker,branch_cd
		end 

ELSE IF @Report='Exe Summary'

		Begin 
			select Executive,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)			
			from mis_to a  join  mis.terminalmaster.dbo.tbl_mst_Terminals b on a.terminal_id=b.terminal_id join dotnet.dbo.clientexecutive c on a.party_code=c.party_code 
			where sauda_date>=@FromDate and sauda_date<=@ToDate 
			and b.Activation_Date<=@FromDate and b.deActivation_Date>=@ToDate
			and branch_cd like '%' and a.party_code like '%' 
			group by executive,a.party_code,sub_broker,branch_cd order by executive,a.party_code,sub_broker,branch_cd
		End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.gradecount
-- --------------------------------------------------
CREATE procedure gradecount(@regcode varchar(10),@brcode varchar(10),@CNT Numeric,@YEAR Numeric)                   
as                
set transaction isolation level read uncommitted                          
Set nocount on                       
/*DECLARE @CNT INT                      
DECLARE @YEAR INT                       
SET @CNT = datepart(month,getdate())                      
SET @YEAR =  datepart(YEAR,getdate())  
*/  
select * into #file from                      
(                      
  
select party_code,convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
  
 as br12006,                      
  
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-2 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
  
 as br22006,                      
  
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-3 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
  
 as br32006,            
  
convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-4 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
  
 as br42006  
  
                       
  
from mis_to                      
  
where  sauda_date<=getdate() and party_code in (select distinct client_code collate Latin1_General_CI_AS  from mis.ezhni.dbo.mst_hnimapping where regcode=@regcode and brcode=@brcode)                  
  
group by party_code)g                
  
              
  
              
  
/*select * from #file */                   
  
                    
  
select * into #file2 from                         
(                        
select party_code,convert(decimal(10,2),(case when (br12006+br22006+br32006)=0 then 0 else  ((br12006+br22006+br32006)/3) end))AS TOTALBR,convert(decimal(10,2),(case when (br22006+br32006+br42006)=0 then 0 else  ((br22006+br32006+br42006)/3) end)) AS PREVBR,br12006,br22006,br32006,br42006 from #file              
                      
)g  
  
   
                        
  
select * into #file3 from       
  
(             
  
SELECT party_code,                      
  
   (CASE                       
  
      WHEN TOTALBR < 5000 THEN 'C'                      
  
      WHEN  TOTALBR > 5000 and TOTALBR < 15000  THEN 'B'                      
  
      WHEN  TOTALBR > 15000 and TOTALBR < 25000  THEN 'B+'                      
  
     WHEN  TOTALBR > 25000 and TOTALBR < 50000  THEN 'A'                      
  
      WHEN  TOTALBR > 50000 and TOTALBR < 75000  THEN 'A+'                      
  
      ELSE 'A++'                      
  
   END) AS Grade,TOTALBR,PREVBR,br12006,br22006,br32006,br42006 from #file2)g      
  
      
  
select grade,case when count(party_code)=0 then 0 else count(party_code)  end as noofcount from #file3      
group by grade  
order by grade   
  
    
  
          
  
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.gradecount1
-- --------------------------------------------------
CREATE procedure gradecount1(@regcode varchar(10),@brcode varchar(10),@CNT varchar(2),@YR varchar(4))                     
as  

/*-------------------------------------------------------        
| Created By : Rachna Salunke        
| Created On : 03/01/2007
|        
| This procedure updates the BrokerageReport table        
| whis is used to display the brokerage information         
| of the client.        
|        
| This procedure is scheduled @ intranet server        
|        
| Job Name : hni_upd_brokeragedet        
| Server   : Intranet        
---------------------------------------------------------*/                  
set transaction isolation level read uncommitted                            
Set nocount on           
              
/*DECLARE @regcode varchar(10)                        
DECLARE @brcode varchar(10)                         
set @regcode='MAH'
set @brcode='ACM'
DECLARE @CNT varchar(2)                        
DECLARE @YR varchar(4)                         
set @CNT='12'
set @YR='2006'
*/
DECLARE @CNT1 INT                        
DECLARE @CNT2 INT                        
DECLARE @CNT3 INT                        
DECLARE @CNT4 INT                        
DECLARE @YEAR INT                         
DECLARE @YEAR1 INT
DECLARE @YEAR2 INT
DECLARE @YEAR3 INT
set @CNT1= datepart(month,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -1, @cnt+ '/'+'01/'+ @yr)), 101))
set @CNT2= datepart(month,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -2, @cnt+ '/'+'01/'+ @yr)), 101))
set @CNT3= datepart(month,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -3, @cnt+ '/'+'01/'+ @yr)), 101))
set @CNT4= datepart(month,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -4, @cnt+ '/'+'01/'+ @yr)), 101))


set @YEAR=datepart(year,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -1, @cnt+ '/'+'01/' + @yr)), 101))
set @YEAR1=datepart(year,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -2, @cnt+ '/'+'01/' + @yr)), 101))
set @YEAR2=datepart(year,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -3, @cnt+ '/'+'01/' + @yr)), 101))
set @YEAR3=datepart(year,convert(varchar(10), dateadd(day, -day(@cnt+ '/'+'01/' + @yr) + 1, dateadd(month, -4, @cnt+ '/'+'01/' + @yr)), 101))

/*print @year
print @year1
drop table #file*/

select * into #file from                        
(                        
    
select party_code,convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT1 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                        
    
 as br12006,                        
    
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT2 and Year(sauda_date)=@YEAR1 then  brokerage else 0 end))                        
    
 as br22006,                        
    
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT3 and Year(sauda_date)=@YEAR2 then  brokerage else 0 end))                        
    
 as br32006,              
    
convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT4 and Year(sauda_date)=@YEAR3 then  brokerage else 0 end))                        
    
 as br42006    
    
from mis_to                        
    
where  sauda_date<=getdate() and party_code in (select distinct client_code collate Latin1_General_CI_AS  from mis.ezhni.dbo.mst_hnimapping where regcode=@regcode and brcode=@brcode)                    
    
group by party_code)g                  
    
    
/*select * from #file 
 drop table #file2*/                     
    
    
select * into #file2 from                           
(                          
select party_code,convert(decimal(10,2),(case when (br12006+br22006+br32006)=0 then 0 else  ((br12006+br22006+br32006)/3) end))AS TOTALBR,convert(decimal(10,2),(case when (br22006+br32006+br42006)=0 then 0 else  ((br22006+br32006+br42006)/3) end)) AS PREVBR,br12006,br22006,br32006,br42006 from #file                
                        
)g    
    
/*  select * from #file2 
   drop table #file3   */
    
select * into #file3 from         
    
(               
    
SELECT party_code,                        
    
   (CASE                         
    
      WHEN TOTALBR < 5000 THEN 'C'                        
    
      WHEN  TOTALBR > 5000 and TOTALBR < 15000  THEN 'B'                        
    
      WHEN  TOTALBR > 15000 and TOTALBR < 25000  THEN 'B+'                        
    
     WHEN  TOTALBR > 25000 and TOTALBR < 50000  THEN 'A'                        
    
      WHEN  TOTALBR > 50000 and TOTALBR < 75000  THEN 'A+'                        
    
      ELSE 'A++'                        
    
   END) AS Grade,TOTALBR,PREVBR,br12006,br22006,br32006,br42006 from #file2)g        
    
select grade,case when count(party_code)=0 then 0 else count(party_code)  end as noofcount from #file3        
group by grade    
order by grade     
    
      

/* select * from #file3 where grade='a'
 select * from #file3 where grade='a+'
 select * from #file3 where grade='a++'
 select * from #file3 where grade='b'
 select * from #file3 where grade='b+'
  select * from #file3 where grade='c'
  */  
      
truncate table client_grade
insert into client_grade
select * from #file3      
    
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.graph_co
-- --------------------------------------------------
CREATE procedure graph_co
as
set nocount on

select mmonth=datename(mm,sauda_date),myear=datename(yy,sauda_date),nmonth=datepart(mm,sauda_date),
turnover=sum(turnover),
brokerage=sum(Brokerage)
into #file1
from mis_to_company where company='ABLCM' and sauda_Date >='Apr  1 2007 00:00'
group by datename(mm,sauda_date),datepart(mm,sauda_date),datename(yy,sauda_date)


select 
mmonth=datename(mm,sauda_date),myear=datename(yy,sauda_date),nmonth=datepart(mm,sauda_date),
Angel_Share=sum(isnull(angel_share,0)) 
into #file2
from mis.remisior.dbo.comb_co 
where segment='ABLCM' and sauda_Date >='Apr  1 2007 00:00'
group by
datename(mm,sauda_date),datename(yy,sauda_date),datepart(mm,sauda_date)

select a.*,b.angel_share from #file1 a left outer join #file2 b on a.nmonth=b.nmonth and a.myear=b.myear
order by a.nmonth

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.hni_brok
-- --------------------------------------------------
CREATE procedure hni_brok(@clientcode as varchar(20))        
as        
DECLARE @CNT INT        
DECLARE @YEAR INT         
SET @CNT = datepart(month,getdate())        
SET @YEAR =  datepart(YEAR,getdate())        
select * into #file from        
(        
select sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  brokerage else 0 end)        
 as br12006,        
 sum(case when Month(sauda_date)=@CNT-2 and Year(sauda_date)=@YEAR then  brokerage else 0 end)        
 as br22006,        
 sum(case when Month(sauda_date)=@CNT-3 and Year(sauda_date)=@YEAR then  brokerage else 0 end)        
 as br32006,  
sum(case when Month(sauda_date)=@CNT-4 and Year(sauda_date)=@YEAR then  brokerage else 0 end)        
 as br42006        
from mis_to        
where  sauda_date<=getdate() and party_code=@clientcode        
group by party_code)g        
        
select * into #file2 from         
(        
select (case when (br12006+br22006+br32006)=0 then 0 else  ((br12006+br22006+br32006)/3) end)AS TOTALBR,(case when (br22006+br32006+br42006)=0 then 0 else  ((br22006+br32006+br42006)/3) end)AS PREVBR,br12006,br22006,br32006,br42006 from #file        
)g        
        
        
SELECT        
   (CASE         
      WHEN PREVBR < 5000 THEN 'C'        
      WHEN  PREVBR > 5000 and PREVBR < 15000  THEN 'B'        
      WHEN  PREVBR > 15000 and PREVBR < 25000  THEN 'B+'        
     WHEN  PREVBR > 25000 and PREVBR < 50000  THEN 'A'        
      WHEN  PREVBR > 50000 and PREVBR < 75000  THEN 'A+'        
      ELSE 'A++'        
   END) AS GradePrev,  
     
   (CASE         
      WHEN TOTALBR < 5000 THEN 'C'        
      WHEN  TOTALBR > 5000 and TOTALBR < 15000  THEN 'B'        
      WHEN  TOTALBR > 15000 and TOTALBR < 25000  THEN 'B+'        
     WHEN  TOTALBR > 25000 and TOTALBR < 50000  THEN 'A'        
      WHEN  TOTALBR > 50000 and TOTALBR < 75000  THEN 'A+'        
      ELSE 'A++'        
   END) AS Grade,  
TOTALBR,PREVBR,br12006,br22006,br32006,br42006 from #file2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.hni_brokdetails
-- --------------------------------------------------
CREATE procedure hni_brokdetails             
as        
set transaction isolation level read uncommitted                  
 set nocount on           
Set nocount on              
DECLARE @CNT INT              
DECLARE @YEAR INT               
SET @CNT = datepart(month,getdate())              
SET @YEAR =  datepart(YEAR,getdate())              

--Note : Year problem to be solved

select * into #file from              
(              
select convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  brokerage else 0 end))              
 as br12006,              
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-2 and Year(sauda_date)=@YEAR then  brokerage else 0 end))              
 as br22006,              
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-3 and Year(sauda_date)=@YEAR then  brokerage else 0 end))              
 as br32006,      
convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-4 and Year(sauda_date)=@YEAR then  brokerage else 0 end))              
 as br42006              
from mis_to              
where  sauda_date<=getdate() and party_code in (select distinct client_code collate Latin1_General_CI_AS  from mis.ezhni.dbo.mst_hnimapping)          
group by party_code)g              
              
select * into #file2 from               
(              
select convert(decimal(10,2),(case when (br12006+br22006+br32006)=0 then 0 else  ((br12006+br22006+br32006)/3) end))AS TOTALBR,convert(decimal(10,2),(case when (br22006+br32006+br42006)=0 then 0 else  ((br22006+br32006+br42006)/3) end)) AS PREVBR,br12006=
convert(decimal(10,2),br12006),  
br22006=convert(decimal(10,2),br22006),br32006=convert(decimal(10,2),br32006),br42006=convert(decimal(10,2),br42006) from #file              
)g              
              
              
SELECT              
   (CASE               
      WHEN TOTALBR < 5000 THEN 'C'              
      WHEN  TOTALBR > 5000 and TOTALBR < 15000  THEN 'B'              
      WHEN  TOTALBR > 15000 and TOTALBR < 25000  THEN 'B+'              
     WHEN  TOTALBR > 25000 and TOTALBR < 50000  THEN 'A'              
      WHEN  TOTALBR > 50000 and TOTALBR < 75000  THEN 'A+'              
      ELSE 'A++'              
   END) AS Grade,TOTALBR,PREVBR,br12006,br22006,br32006,br42006 from #file2          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.hni_brokdetbr
-- --------------------------------------------------
CREATE procedure hni_brokdetbr(@regcode varchar(10),@brcode varchar(10))                   
as                
set transaction isolation level read uncommitted                          
                    
Set nocount on                       
DECLARE @CNT INT                      
DECLARE @YEAR INT                       
SET @CNT = datepart(month,getdate())                      
SET @YEAR =  datepart(YEAR,getdate())                      
select * into #file from                      
(                      
select party_code,convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
 as br12006,                      
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-2 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
 as br22006,                      
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-3 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
 as br32006,            
convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-4 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                      
 as br42006                       
from mis_to                      
where  sauda_date<=getdate() and party_code in (select distinct client_code collate Latin1_General_CI_AS  from mis.ezhni.dbo.mst_hnimapping where regcode=@regcode and brcode=@brcode)                  
group by party_code)g                
              
              
/*select * from #file */                   
                      
select * into #file2 from                       
(                      
select party_code,convert(decimal(10,2),(case when (br12006+br22006+br32006)=0 then 0 else  ((br12006+br22006+br32006)/3) end))AS TOTALBR,convert(decimal(10,2),(case when (br22006+br32006+br42006)=0 then 0 else  ((br22006+br32006+br42006)/3) end)) AS PREVBR,br12006=convert(decimal(10,2),br12006),br22006=convert(decimal(10,2),br22006),br32006=convert(decimal(10,2),br32006),br42006=convert(decimal(10,2),br42006) from #file            
                    
)g                      
                      
             
SELECT party_code,                      
   (CASE                       
      WHEN TOTALBR < 5000 THEN 'C'                      
      WHEN  TOTALBR > 5000 and TOTALBR < 15000  THEN 'B'                      
      WHEN  TOTALBR > 15000 and TOTALBR < 25000  THEN 'B+'                      
     WHEN  TOTALBR > 25000 and TOTALBR < 50000  THEN 'A'                      
      WHEN  TOTALBR > 50000 and TOTALBR < 75000  THEN 'A+'                      
      ELSE 'A++'                      
   END) AS Grade,TOTALBR,PREVBR,br12006,br22006,br32006,br42006 from #file2   
      
/*select grade,count(party_code) from hnibroktot1      
group by grade*/    
    
/*select * from   hnibroktot*/    
            
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.hni_brokdetreg
-- --------------------------------------------------
CREATE procedure hni_brokdetreg(@regcode varchar(10))         
as      
set transaction isolation level read uncommitted        
set nocount on          
DECLARE @CNT INT            
DECLARE @YEAR INT             
SET @CNT = datepart(month,getdate())            
SET @YEAR =  datepart(YEAR,getdate())            
select * into #file from            
(            
select convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  brokerage else 0 end))            
 as br12006,            
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-2 and Year(sauda_date)=@YEAR then  brokerage else 0 end))            
 as br22006,            
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-3 and Year(sauda_date)=@YEAR then  brokerage else 0 end))            
 as br32006,    
convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-4 and Year(sauda_date)=@YEAR then  brokerage else 0 end))            
 as br42006             
from mis_to            
where  sauda_date<=getdate() and party_code in (select distinct client_code collate Latin1_General_CI_AS  from mis.ezhni.dbo.mst_hnimapping where regcode=@regcode)        
group by party_code)g            
            
select * into #file2 from             
(            
select convert(decimal(10,2),(case when (br12006+br22006+br32006)=0 then 0 else  ((br12006+br22006+br32006)/3) end))AS TOTALBR,convert(decimal(10,2),(case when (br22006+br32006+br42006)=0 then 0 else  ((br22006+br32006+br42006)/3) end)) AS PREVBR,br12006=convert(decimal(10,2),br12006),
br22006=convert(decimal(10,2),br22006),br32006=convert(decimal(10,2),br32006),br42006=convert(decimal(10,2),br42006) from #file            
)g            
            
            
SELECT            
   (CASE             
      WHEN TOTALBR < 5000 THEN 'C'            
      WHEN  TOTALBR > 5000 and TOTALBR < 15000  THEN 'B'            
      WHEN  TOTALBR > 15000 and TOTALBR < 25000  THEN 'B+'            
     WHEN  TOTALBR > 25000 and TOTALBR < 50000  THEN 'A'            
      WHEN  TOTALBR > 50000 and TOTALBR < 75000  THEN 'A+'            
      ELSE 'A++'            
   END) AS Grade,TOTALBR,PREVBR,br12006,br22006,br32006,br42006 from #file2          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.hni_brokdetuser
-- --------------------------------------------------
CREATE procedure hni_brokdetuser(@regcode varchar(10),@brcode varchar(10),@manager varchar(25))       
as          
DECLARE @CNT INT          
DECLARE @YEAR INT           
SET @CNT = datepart(month,getdate())          
SET @YEAR =  datepart(YEAR,getdate())          
select * into #file from          
(          
select convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  brokerage else 0 end))          
 as br12006,          
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-2 and Year(sauda_date)=@YEAR then  brokerage else 0 end))          
 as br22006,          
 convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-3 and Year(sauda_date)=@YEAR then  brokerage else 0 end))          
 as br32006,    
convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-4 and Year(sauda_date)=@YEAR then  brokerage else 0 end))          
 as br42006          
from mis_to          
where  sauda_date<=getdate() and party_code in (select distinct client_code collate Latin1_General_CI_AS  from mis.ezhni.dbo.mst_hnimapping where regcode=@regcode and brcode=@brcode and manager=@manager)      
group by party_code)g          
          
select * into #file2 from           
(          
select convert(decimal(10,2),(case when (br12006+br22006+br32006)=0 then 0 else  ((br12006+br22006+br32006)/3) end))AS TOTALBR,convert(decimal(10,2),(case when (br22006+br32006+br42006)=0 then 0 else  ((br22006+br32006+br42006)/3) end)) AS PREVBR,br12006=convert(decimal(10,2),br12006),
br22006=convert(decimal(10,2),br22006),br32006=convert(decimal(10,2),br32006),br42006=convert(decimal(10,2),br42006) from #file          
)g          
          
          
SELECT          
   (CASE           
      WHEN TOTALBR < 5000 THEN 'C'          
      WHEN  TOTALBR > 5000 and TOTALBR < 15000  THEN 'B'          
      WHEN  TOTALBR > 15000 and TOTALBR < 25000  THEN 'B+'          
     WHEN  TOTALBR > 25000 and TOTALBR < 50000  THEN 'A'          
      WHEN  TOTALBR > 50000 and TOTALBR < 75000  THEN 'A+'          
      ELSE 'A++'          
   END) AS Grade,TOTALBR,PREVBR,br12006,br22006,br32006,br42006 from #file2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.hni_brokturn
-- --------------------------------------------------
CREATE procedure hni_brokturn(@regcode varchar(10),@brcode varchar(10),@CNT Numeric,@YEAR Numeric)                     
as                  
set transaction isolation level read uncommitted                            
Set nocount on                         
/*DECLARE @CNT INT                        
DECLARE @YEAR INT                         
SET @CNT = datepart(month,getdate())                        
SET @YEAR =  datepart(YEAR,getdate())    
*/    
select * into #file from                        
(                        
    
select party_code,bryear=convert(decimal(10,2),sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  brokerage else 0 end))                        
,                        
turnyear=convert(decimal(14,2),sum(case when Month(sauda_date)=@CNT-1 and Year(sauda_date)=@YEAR then  turnover else 0 end))                          
    
 
from mis_to                        
    
where  sauda_date<=getdate() and party_code in (select distinct client_code collate Latin1_General_CI_AS  from mis.ezhni.dbo.mst_hnimapping where regcode=@regcode and brcode=@brcode)                    
    
group by party_code)g                  
 
/*select * from #file */                     

select * into #file2 from                           
(                          
select convert(decimal(10,2),(case when bryear=0 then 0 else  bryear end)) AS TOTALBR,   
convert(decimal(16,2),(case when turnyear=0 then 0 else  turnyear end)) AS TOTALTURN    
from #file                
)g    

select sum(TOTALBR) as TOTALBROK,sum(TOTALTURN) as TOTALTURN  from  #file2     

/*select * from   hnibroktot*/      

Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.kyc_checkpanno
-- --------------------------------------------------
create procedure kyc_checkpanno (@panno as varchar(12))
as
begin        
select Account = 'ABL', [Party Code]=party_code, [Pan No]=pan_gir_no, Name=Long_name, L_address1, L_address2, L_address3, L_city 
	 from anand.bsedb_ab.dbo.client1 c1, anand.bsedb_ab.dbo.client2 c2
	 where 
	 c2.cl_code = c1.cl_code
	 and pan_gir_no = @panno
	 union
	 select Account = 'ACDL', [Party Code]=party_code, [Pan No]=pan_gir_no, Name=Long_name, L_address1, L_address2, L_address3, L_city 
	 from anand1.msajag.dbo.client1 c1, anand1.msajag.dbo.client2 c2
	 where 
	 c2.cl_code = c1.cl_code
	 and pan_gir_no = @panno
	 union
	 select Account = 'FNO', [Party Code]=party_code, [Pan No]=pan_gir_no, Name=Long_name, L_address1, L_address2, L_address3, L_city 
	 from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2
	 where 
	 c2.cl_code = c1.cl_code
	 and pan_gir_no =@panno
	 union
     select Account = 'KYC', [Party Code]=party_code, [Pan No]=pan_gir_no, Name=short_name, L_address1='dummy', L_address2='dummy', L_address3='dummy', L_city='dummy'
	 from esignbse.kyc.dbo.kycregister 
	 where pan_gir_no =@panno
	 order by party_code
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Level1QMisUp
-- --------------------------------------------------
CREATE Proc Level1QMisUp (@Fromdate As DateTime,@Todate As DateTime)
As
Declare @FromMonth Varchar(4)
Declare @Tomonth Varchar(4)
Declare @Fromyear Varchar(4)
Declare @Toyear Varchar(4)

Set @Fromyear = Datepart(year,@FromDate)
Set @Toyear = DatePart(year,@Todate)

--Set @FromMonth = Left(DateName(Month,@FromDate),3)
--Set @ToMonth = Left(DateName(Month ,DateAdd(Month,1,@ToDate) ),3)

Select @FromDate = 'APR  1 ' + @FromYear
Select @Todate = 'MAR 31 ' + @ToYear +' 23:59:00'


Select @FromDate
Select @Todate
/*
Update Level1QMis Set Q1Days = A.Q1Days,
Q1Turnover = A.Q1Turnover,Q1AvgTurnover = A.Q1AvgTurnover,Q1Brokerage = A.Q1Brokerage,Q1AvgBrokerage = A.Q1AvgBrokerage,
Q2Days = A.Q2Days,Q2Turnover = A.Q2Turnover,Q2AvgTurnover =A.Q2AvgTurnover,Q2Brokerage = A.Q2Brokerage,Q2AvgBrokerage = A.Q2AvgBrokerage,
Q3Days = A.Q3Days,Q3Turnover = A.Q3Turnover,Q3AvgTurnover = A.Q3AvgTurnover,Q3Brokerage = A.Q3Brokerage,Q3AvgBrokerage = A.Q3AvgBrokerage,
Q4Days = A.Q4Days,Q4Turnover = A.Q4Turnover,Q4AvgTurnover = A.Q4AvgTurnover,Q4Brokerage = A.Q4Brokerage,
Q4AvgBrokerage= A.Q4AvgBrokerage From  
*/
 
truncate table Level1QMis

Insert into Level1QMis Select * from 

(Select DYear = Finyear, Q1Days,A.Branch_Cd,A.ExchangeSegment,Sub_Broker = Left(A.Sub_broker,10),
            Q1Turnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q1AvgTurnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q1Days = 0 Then 1 Else Q1Days End) ,
            Q1Brokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q1AvgBrokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q1Days = 0 Then 1 Else Q1Days End),
            Q2Days,
            Q2Turnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q2AvgTurnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q2Days = 0 Then 1 Else Q2Days End) ,
            Q2Brokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q2AvgBrokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q2Days = 0 Then 1 Else Q2Days End),
            Q3Days,            
            Q3Turnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA)) Else 0 End),
            Q3AvgTurnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End)/(Case When Q3Days = 0 Then 1 Else Q3Days End) ,
            Q3Brokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q3AvgBrokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q3Days = 0 Then 1 Else Q3Days End),
            Q4Days,
            Q4Turnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q4AvgTurnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q4Days = 0 Then 1 Else Q4Days End) ,
            Q4Brokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q4AvgBrokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q4Days = 0 Then 1 Else Q4Days End)
            
            From Level1Mis A , ( Select FinYear1 = Finyear,CountDays.Branch_CD,Sub_broker,Exchangesegment,
                      Q1Days = Sum(Case When FinMonth between 4 And 6 Then NoDays Else 0 End),
                      Q2Days = Sum(Case When FinMonth between 7 And 9 Then NoDays Else 0 End),
                      Q3Days = Sum(Case When FinMonth between 10 And 12 Then NoDays Else 0 End),
                      Q4Days = Sum(Case When FinMonth between 1 And 3 Then NoDays Else 0 End)
                      From  
                     ( Select B.Branch_CD,Exchangesegment,Finyear ,FinMonth ,Sub_broker,NoDays = Count(Distinct Sauda_date)
                       From Level1Mis B  
                       Where Sauda_date >= 'APR  1 2000'
                       And
                       Sauda_date <= DateAdd(Day , 1 ,Getdate())
                       And
                       B.Branch_cd >= 'A'
                       And
                       B.Branch_cd <= 'ZZZZZZZZZZ'
                       And
                       Sub_broker >= 'A'
                       And
                       Sub_broker <= 'ZZZZZZZZZZZ'
                       And
                       Party_code >= 'A'
                       And
                       Party_code <= 'ZZZZZZZZZ'
                       --And Exchangesegment in(@MArket)
                       And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
                       Group By FinYEar,FinMonth,B.Branch_CD,Exchangesegment,Sub_broker ) CountDays
                       Group By FinYear,CountDays.Branch_CD,Exchangesegment ,Sub_broker
                     )QDays    Where
                     Qdays.Branch_cd = A.Branch_Cd  
                     And         
                        FinYear = FinYear1  
                     And
                     QDays.Exchangesegment = A.Exchangesegment        
                     And
                     Qdays.Sub_broker = A.Sub_broker 
                     And 
     A.Branch_cd >= 'A'
     And
     A.Branch_cd <= 'ZZZZZZZZZ'
     And
     A.Sub_broker >= 'A'
     And
     A.Sub_broker <= 'ZZZZZZZZ'
     And
     Party_code >= 'A'
     And
     Party_code <= 'ZZZZZZZZZ'
     And
     Sauda_date >= 'APR  1 2000'
     And
     Sauda_date <= DateAdd(Day , 1 ,Getdate())
     And a.Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
     Group By Finyear,A.Branch_CD,Q1Days,Q2Days,Q3Days,Q4Days,a.Exchangesegment,A.Sub_Broker ) A
--Where
--A.Branch_Cd = Level1QMis.Branch_Cd
--And A.FinYear = Level1QMis.FinYear

     --Order By Finyear,A.Branch_CD

--Level1QMisUp 'Feb 23 2005','JAN 23 2006'


--select * from level1qmis
--Exec Level1QMisUp '',''

--select Top 1 * from level1mis

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LevelMISReportsForSegmentGroups
-- --------------------------------------------------




CREATE      PROCEDURE LevelMISReportsForSegmentGroups
	@StatusId Varchar(10),
	@StatusName Varchar(15),
	@ReportLevel Varchar(15),
	@SegmentGroup varchar(50),
	@FromBranch varchar(15),
	@ToBranch varchar(15),
	@FromSubbroker varchar(15),
	@ToSubbroker varchar(15),
	@FromTrader varchar(15),
	@ToTrader varchar(15),
	@FromClient varchar(15),
	@ToClient varchar(15),
        @FromDate varchar(15),
	@ToDate varchar(15),
	@Rounding Bigint = 10000000
 AS

------------------------------------- Stored Procedure Testing ----------------------------------
/*
	EXEC LevelMISReportsForSegmentGroups 'Broker','','Broker','''BSECM'',''NSECM'',''NSEFO''','','','','','','','','','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Broker','','Branch','''BSECM'',''NSECM'',''NSEFO''','','','','','','','','','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Broker','','Subbroker','''BSECM'',''NSECM'',''NSEFO''','ACM','ACM','','','','','','','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Broker','','Trader','''BSECM'',''NSECM'',''NSEFO''','ACM','ACM','ACM','ACM','','','','','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Broker','','Client','''BSECM'',''NSECM'',''NSEFO''','ACM','ACM','ACM','ACM','ACM','ACM','A','B','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Broker','','Date','''BSECM'',''NSECM'',''NSEFO''','ACM','ACM','ACM','ACM','ACM','ACM','A','B','Oct 01 2005','Oct 31 2005'

	EXEC LevelMISReportsForSegmentGroups 'Branch','XPU','Broker','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Branch','XPU','Branch','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Branch','XPU','Subbroker','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Branch','XPU','Trader','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Branch','XPU','Client','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Branch','XPU','Date','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'

	EXEC LevelMISReportsForSegmentGroups 'Subbroker','ABI','Broker','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Subbroker','ABI','Branch','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Subbroker','ABI','Subbroker','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Subbroker','ABI','Trader','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Subbroker','ABI','Client','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'
	EXEC LevelMISReportsForSegmentGroups 'Subbroker','ABI','Date','''BSECM'',''NSECM'',''NSEFO''','A','Z','A','Z','A','Z','A','Z','Oct 01 2005','Oct 31 2005'

	EXEC prcDrill 'Segmentwise', 'Oct 01 2005', 'Oct 31 2005','','','','','','','','0',''
*/
-------------------------------------------------------------------------------------------------

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  

--------------------------------- Global Variables Declaration ----------------------------------

	DECLARE
		@@CommonSelect VARCHAR(5000),
		@@LevelSelect VARCHAR(5000),
		@@From VARCHAR(1000),
		@@Where VARCHAR(1000),
		@@Query VARCHAR(8000),
		@@GroupBy VARCHAR(500),
		@@OrderBy VARCHAR(500)

---------------------------------- Local Variables Declaration ----------------------------------
	DECLARE 
		@VolumeSelect VARCHAR(1000),
		@TurnOverSelect VARCHAR(1000),
		@BrokerageSelect VARCHAR(1000),
		@PercentVolumeSelect VARCHAR(500),
		@PercentTurnOverSelect VARCHAR(500),
		@PercentBrokerageSelect VARCHAR(500),
		@BranchWhere VARCHAR(500),
		@SubbrokerWhere VARCHAR(500),
		@TraderWhere VARCHAR(500),
		@ClientWhere VARCHAR(500),
		@DateWhere VARCHAR(500)

----------------------------------Broker Branch Login Constraints--------------------------------

	SET  NOCOUNT ON

	IF @StatusId = 'Broker'
	BEGIN
        	IF @FromBranch = '' AND @ToBranch <> '' SET @FromBranch = 'A'
         	IF @ToBranch = '' AND @FromBranch <> '' SET @ToBranch = 'ZZZZZZ'

        	IF @FromSubbroker = '' AND @ToSubbroker <> ''  SET @FromSubbroker = 'A'
	        IF @ToSubbroker = '' AND @FromSubbroker <> '' SET @ToSubbroker = 'ZZZZZZ'

        	IF @FromTrader = '' AND @ToTrader <> '' SET @FromTrader = 'A'
         	IF @ToTrader = '' AND @FromTrader <> '' SET @ToTrader = 'ZZZZZZZ'

        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
	END

	IF @StatusId = 'Branch'
	BEGIN
     		IF @ReportLevel = 'Broker' SET @ReportLevel = 'Branch'

		SET @FromBranch = @StatusName
     		SET @ToBranch = @StatusName

        	IF @FromSubbroker = '' AND @ToSubbroker <> ''  SET @FromSubbroker = 'A'
	        IF @ToSubbroker = '' AND @FromSubbroker <> '' SET @ToSubbroker = 'ZZZZZZ'

        	IF @FromTrader = '' AND @ToTrader <> '' SET @FromTrader = 'A'
         	IF @ToTrader = '' AND @FromTrader <> '' SET @ToTrader = 'ZZZZZZ'

        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
	END

	ELSE IF @StatusId = 'Subbroker'
	BEGIN
     		IF @ReportLevel = 'Broker' OR @ReportLevel = 'Branch'
 			SET @ReportLevel = 'Subbroker'
	
		SET @FromSubbroker = @StatusName
		SET @ToSubbroker = @StatusName

        	IF @FromTrader = '' AND @ToTrader <> '' SET @FromTrader = 'A'
         	IF @ToTrader = '' AND @FromTrader <> '' SET @ToTrader = 'ZZZZZZ'

        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
	END

	ELSE IF @StatusId = 'Trader'
	BEGIN
     		IF @ReportLevel = 'Broker' OR @ReportLevel = 'Branch' OR @ReportLevel = 'Subbroker'
 			SET @ReportLevel = 'Trader'
	
        	SET @FromTrader = @StatusName
         	SET @ToTrader = @StatusName

        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
	END
	ELSE IF @StatusId = 'Client'
	BEGIN
     		IF @ReportLevel = 'Broker' OR @ReportLevel = 'Branch' 
		OR @ReportLevel = 'Subbroker' OR @ReportLevel = 'Trader'
 			SET @ReportLevel = 'Client'

		SET @FromClient = @StatusName
	        SET @ToClient = @StatusName
	END

	IF @Rounding = 0 SET @Rounding = 10000000
-------------------------------------------------------------------------------------------------
	SET @BranchWhere = 'Branch_Cd>=''' + @FromBranch + ''' AND Branch_Cd<=''' + @ToBranch + ''''
	SET @SubbrokerWhere = 'Sub_broker>=''' + @FromSubbroker + ''' AND Sub_broker<=''' + @ToSubbroker + ''''
	SET @TraderWhere = 'Trader>=''' + @FromTrader + ''' AND Trader<=''' + @ToTrader + ''''
	SET @ClientWhere = 'Party_Code>=''' + @FromClient + ''' AND Party_Code<=''' + @ToClient + ''''

	IF @ReportLevel <> 'Date'
	BEGIN
		SET @VolumeSelect = 'SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty))'
		SET @TurnOverSelect = 'SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt)'
		SET @BrokerageSelect = 'SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)'

		SET @PercentVolumeSelect =  'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty)))/TotalVolume*100'
		SET @PercentTurnOverSelect = 'CONVERT(DECIMAL(30,10),SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt))/TotalTurnOver*100'
		SET @PercentBrokerageSelect = 'CONVERT(DECIMAL(30,10),SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok))/TotalBrokerage*100'

		SET @DateWhere = 'From_Date>=''' + @FromDate + ''' AND To_Date<=''' + @ToDate + ''''
	END
	ELSE
	BEGIN
		SET @VolumeSelect = 'SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS))'
		SET @TurnOverSelect = 'SUM(TPA + TSA + DPA + DSA)'
		SET @BrokerageSelect = 'SUM(TPB + TSB + DPB + DSB)'

		SET @PercentVolumeSelect = 'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS)))/TotalVolume*100'
		SET @PercentTurnOverSelect = 'CONVERT(DECIMAL(30,10),SUM(TPA + TSA + DPA + DSA))/TotalTurnOver*100'
		SET @PercentBrokerageSelect = 'CONVERT(DECIMAL(30,10),SUM(TPB + TSB + DPB + DSB))/TotalBrokerage*100'

		SET @DateWhere = 'Sauda_Date>=''' + @FromDate + ''' AND Sauda_Date<=''' + @ToDate + ''''
	END

	SET @@CommonSelect = @VolumeSelect + ' AS Volume,' + @TurnOverSelect + ' AS TurnOver,' + @BrokerageSelect + ' AS Brokerage '
	SET @@Where = ''

	IF @ReportLevel = 'Broker'
	BEGIN
		SET @@LevelSelect = '''Angel'' AS Broker,'
		SET @@From = 'Level2MIS '

		IF @@Where <> '' SET @@Where = @@Where + ' AND '
		SET @@Where = @@Where + @DateWhere

		IF (@FromBranch <> '' OR @ToBranch <> '')
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @BranchWhere
		END

		IF (@FromSubbroker <> '' OR @ToSubbroker <> '')
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @SubbrokerWhere
		END

		IF (@FromTrader <> '' OR @ToTrader <> '')
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @TraderWhere
		END

		IF @FromClient <> '' OR @ToClient <> ''
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @ClientWhere
		END

		SET @@GroupBy = 'TotalVolume,TotalTurnOver,TotalBrokerage '
		SET @@OrderBy = ''
	END

	ELSE IF @ReportLevel = 'Branch'
	BEGIN
		SET @@LevelSelect = 'Branch_Cd AS Branch,'
		SET @@From = 'Level2MIS '		

		IF @@Where <> '' SET @@Where = @@Where + ' AND '
		SET @@Where = @@Where + @DateWhere

		IF (@FromBranch <> '' OR @ToBranch <> '')
		BEGIN 
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @BranchWhere
		END

		IF (@FromSubbroker <> '' OR @ToSubbroker <> '')
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @SubbrokerWhere
		END

		IF (@FromTrader <> '' OR @ToTrader <> '')
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @TraderWhere
		END

		IF @FromClient <> '' OR @ToClient <> ''
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @ClientWhere
		END

		SET @@GroupBy = 'Branch_Cd,TotalVolume,TotalTurnOver,TotalBrokerage '
		SET @@OrderBy = 'Branch_Cd'
	END

	ELSE IF @ReportLevel = 'Subbroker'
	BEGIN
		SET @@LevelSelect = 'Sub_broker AS Subbroker,Branch_Cd AS Branch,'
		SET @@From = 'Level2MIS '
		IF @@Where <> '' SET @@Where = @@Where + ' AND '
		SET @@Where = @@Where + @DateWhere

		IF (@FromBranch <> '' OR @ToBranch <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @BranchWhere
		END

		IF (@FromSubbroker <> '' OR @ToSubbroker <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @SubbrokerWhere
		END

		IF (@FromTrader <> '' OR @ToTrader <> '')
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @TraderWhere
		END

		IF @FromClient <> '' OR @ToClient <> ''
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @ClientWhere
		END
		SET @@GroupBy = 'Branch_Cd,Sub_Broker,TotalVolume,TotalTurnOver,TotalBrokerage '
		SET @@OrderBy = 'Sub_Broker,Branch_Cd'
	END

	ELSE IF @ReportLevel = 'Trader'
	BEGIN
		SET @@LevelSelect = 'Trader,Sub_broker AS Subbroker,Branch_Cd AS Branch,'
		SET @@From = 'Level2MIS '

		IF @@Where <> '' SET @@Where = @@Where + ' AND '
		SET @@Where = @@Where + @DateWhere

		IF (@FromBranch <> '' OR @ToBranch <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @BranchWhere
		END

		IF (@FromSubbroker <> '' OR @ToSubbroker <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @SubbrokerWhere
		END

		IF (@FromTrader <> '' OR @ToTrader <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @TraderWhere
		END

		IF @FromClient <> '' OR @ToClient <> ''
		BEGIN
			SET @@From = 'Level2MIS '
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @ClientWhere
		END

		SET @@GroupBy = 'Branch_Cd,Sub_Broker,Trader,TotalVolume,TotalTurnOver,TotalBrokerage '
		SET @@OrderBy = 'Trader,Sub_Broker,Branch_Cd'
	END	

	ELSE IF @ReportLevel = 'Client'
	BEGIN
		SET @@LevelSelect = 'Party_code AS Client,Trader,Sub_broker AS Subbroker,Branch_Cd AS Branch,'
		SET @@From = 'Level2MIS '

		IF @@Where <> '' SET @@Where = @@Where + ' AND '
		SET @@Where = @@Where + @DateWhere

		IF (@FromBranch <> '' OR @ToBranch <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @BranchWhere
		END

		IF (@FromSubbroker <> '' OR @ToSubbroker <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @SubbrokerWhere
		END

		IF (@FromTrader <> '' OR @ToTrader <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @TraderWhere
		END

		IF @FromClient <> '' OR @ToClient <> ''
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @ClientWhere
		END

		SET @@GroupBy = 'Branch_Cd,Sub_Broker,Trader,Party_Code,TotalVolume,TotalTurnOver,TotalBrokerage '
		SET @@OrderBy = 'Party_Code,Trader,Sub_Broker,Branch_Cd'
	END	

	ELSE IF @ReportLevel = 'Date'
	BEGIN
		SET @@LevelSelect = 'Sauda_Date AS Date,Party_code AS Client,Trader,Sub_broker AS Subbroker,Branch_Cd AS Branch,'
		SET @@From = 'Level1MIS '

		IF @@Where <> '' SET @@Where = @@Where + ' AND '
		SET @@Where = @@Where + @DateWhere

		IF (@FromBranch <> '' OR @ToBranch <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @BranchWhere
		END

		IF (@FromSubbroker <> '' OR @ToSubbroker <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @SubbrokerWhere
		END

		IF (@FromTrader <> '' OR @ToTrader <> '')
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @TraderWhere
		END

		IF @FromClient <> '' OR @ToClient <> ''
		BEGIN
			IF @@Where <> '' SET @@Where = @@Where + ' AND '
			SET @@Where = @@Where + @ClientWhere
		END

		SET @@GroupBy = 'Branch_Cd,Sub_Broker,Trader,Party_Code,Sauda_Date,TotalVolume,TotalTurnOver,TotalBrokerage '
		SET @@OrderBy = 'Sauda_Date,Party_Code,Trader,Sub_Broker,Branch_Cd'
	END
	

------------------------- Building Query Dynamically For Final Report ---------------------------

	DECLARE @@InnerSelect VARCHAR(1000)
	SET @@InnerSelect = @VolumeSelect + ' AS TotalVolume,' + @TurnOverSelect + ' AS TotalTurnOver,' + @BrokerageSelect + ' AS TotalBrokerage '

	SET @VolumeSelect = 'CONVERT(DECIMAL(30,10),' + @VolumeSelect + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @TurnOverSelect = 'CONVERT(DECIMAL(30,10),' + @TurnOverSelect + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @BrokerageSelect = 'CONVERT(DECIMAL(30,10),' + @BrokerageSelect + ')/' + CONVERT(VARCHAR,@Rounding)

	SET @@CommonSelect = @VolumeSelect + ' AS Volume,' + @PercentVolumeSelect + ' AS ''Volume %'',' + @TurnOverSelect + ' AS TurnOver,' + @PercentTurnOverSelect + ' AS ''TurnOver %'',' + @BrokerageSelect + ' AS Brokerage,' + @PercentBrokerageSelect + ' AS ''Brokerage %'' '

-------------------------------------  Start Of SELECT  ----------------------------------

	SET @@Query = 'SELECT '
	IF @@LevelSelect <> '' SET @@Query = @@Query + @@LevelSelect
	SET @@Query = @@Query + @@CommonSelect

-------------------------------------  Start Of FROM  ------------------------------------

	SET @@Query = @@Query + 'FROM ' + @@From 
	SET @@Query = @@Query + ',(SELECT ' + @@InnerSelect +  'FROM ' + @@From +  'WHERE ' + @@Where  
	IF @SegmentGroup <> '' SET @@Query = @@Query + 'AND ExchangeSegment In (' + @SegmentGroup + ') '
	IF @@GroupBy <> '' SET @@Query = @@Query + ') Totals '

-------------------------------------  Start Of WHERE  -----------------------------------

	SET @@Query = @@Query + 'WHERE ' + @@Where
	IF @SegmentGroup <> '' SET @@Query = @@Query + 'AND ExchangeSegment In (' + @SegmentGroup + ') '

-----------------------------------  Start Of GROUP BY  ----------------------------------

	IF @@GroupBy <> '' SET @@Query = @@Query + 'GROUP BY ' + @@GroupBy 

-----------------------------------  Start Of ORDER BY  ----------------------------------

	IF @@OrderBy <> '' SET @@Query = @@Query + 'ORDER BY ' + @@OrderBy

------------------------------------------------------------------------------------------


------------------------- Final Execution Of Dynamically Generated Query ------------------------
	PRINT @@Query
	--SELECT @@Query AS Query 
	EXEC(@@Query)

-------------------------------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Login_status_Rpt
-- --------------------------------------------------

--LOGIN_STATUS_RPT '02/21/2011','02/22/2011','BRMAST','NRTH_7' 

CREATE PROCEDURE LOGIN_STATUS_RPT        
(        
 @FDATE AS VARCHAR(25),        
 @TDATE AS VARCHAR(25),        
 @USER AS VARCHAR(10),        
 @CODE AS VARCHAR(10)        
)                    
AS                    
      
SET NOCOUNT ON        
  
IF @USER = 'BROKER'    
BEGIN    
    
 /*************************************************************************************    
  USE TO GET BROKERAGE DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
    
 SELECT BD.SAUDA_DATE,    
 BRANCH_CD = BD.BRANCH,    
 BD.SUB_BROKER,    
 BD.PARTY_CODE,    
 [BSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [FO_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN EBROK_BROK_EARNED END),0.00),    
 [NCDX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN EBROK_BROK_EARNED END),0.00),    
 [BSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [FO_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NCDEX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00)   
 INTO #BROKER_BROK_TABLE    
 FROM MIS.REMISIOR.DBO.TBL_EBROK_DETAIL_CLI BD    
  LEFT JOIN INTRANET.RISK.DBO.CLIENT_DETAILS CD ON BD.PARTY_CODE = CD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS    
 WHERE BD.SAUDA_DATE >= CONVERT(DATETIME,@FDATE) AND BD.SAUDA_DATE <= CONVERT(DATETIME,@TDATE)    
 AND CD.EBROKING = 'Y'    
    
 /*************************************************************************************    
  USE TO GET LOGIN DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
     
 SELECT PARTY_CODE,CONNECTED,DATE    
 INTO #BROKER_LOGIN_TABLE    
 FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS BD    
 WHERE CONNECTED > 0    
  AND CONVERT(DATETIME,DATE) >= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,DATE) <= CONVERT(DATETIME,@TDATE)    
      
 /*************************************************************************************    
  USE TO GET FINAL REPORT DATA    
 **************************************************************************************/    
     
 SELECT T.*,[NOL] =  ISNULL(LD.CONNECTED,0)    
 FROM #BROKER_BROK_TABLE T LEFT JOIN #BROKER_LOGIN_TABLE LD     
 ON T.PARTY_CODE = LD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND T.SAUDA_DATE = CONVERT(DATETIME,LD.DATE)    
     
 DROP TABLE #BROKER_LOGIN_TABLE    
 DROP TABLE #BROKER_BROK_TABLE    
    
END    
    
    
IF @USER = 'BRMAST'    
BEGIN    
    
 SELECT ID=BRANCH_CD     
 INTO #BRMAST    
 FROM INTRANET.RISK.DBO.BRANCH_MASTER WHERE BRMAST_CD = @CODE    
     
 /*************************************************************************************    
  USE TO GET BROKERAGE DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
    
 SELECT BD.SAUDA_DATE,    
 BRANCH_CD = BD.BRANCH,    
 BD.SUB_BROKER,    
 BD.PARTY_CODE,    
 [BSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [FO_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN EBROK_BROK_EARNED END),0.00),    
 [NCDX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN EBROK_BROK_EARNED END),0.00),    
 [BSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [FO_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NCDEX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00)   
 INTO #BRMAST_BROK_TABLE    
 FROM #BRMAST TBL LEFT JOIN MIS.REMISIOR.DBO.TBL_EBROK_DETAIL_CLI BD ON TBL.ID = BD.BRANCH    
  LEFT JOIN INTRANET.RISK.DBO.CLIENT_DETAILS CD ON CD.PARTY_CODE = BD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS    
 WHERE BD.SAUDA_DATE >= CONVERT(DATETIME,@FDATE) AND BD.SAUDA_DATE <= CONVERT(DATETIME,@TDATE)    
 AND CD.EBROKING = 'Y'    
    
 DROP TABLE #BRMAST    
    
 /*************************************************************************************    
  USE TO GET LOGIN DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
     
 SELECT PARTY_CODE,CONNECTED,DATE    
 INTO #BRMAST_LOGIN_TABLE    
 FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS BD    
 WHERE CONNECTED > 0    
  AND CONVERT(DATETIME,DATE) >= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,DATE) <= CONVERT(DATETIME,@TDATE)    
      
 /*************************************************************************************    
  USE TO GET FINAL REPORT DATA    
 **************************************************************************************/    
     
 SELECT T.*,[NOL] =  ISNULL(LD.CONNECTED,0)    
 FROM #BRMAST_BROK_TABLE T LEFT JOIN #BRMAST_LOGIN_TABLE LD     
 ON T.PARTY_CODE = LD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND T.SAUDA_DATE = CONVERT(DATETIME,LD.DATE)    
     
 DROP TABLE #BRMAST_LOGIN_TABLE    
 DROP TABLE #BRMAST_BROK_TABLE    
    
END    
    
IF @USER = 'REGION'    
BEGIN    
    
 SELECT ID=CODE     
 INTO #REGION    
 FROM INTRANET.RISK.DBO.REGION WHERE REG_CODE = @CODE    
     
 /*************************************************************************************    
  USE TO GET BROKERAGE DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
    
 SELECT BD.SAUDA_DATE,    
 BRANCH_CD = BD.BRANCH,    
 BD.SUB_BROKER,    
 BD.PARTY_CODE,    
 [BSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [FO_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN EBROK_BROK_EARNED END),0.00),    
 [NCDX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN EBROK_BROK_EARNED END),0.00),    
 [BSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [FO_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NCDEX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00)   
 INTO #REGION_BROK_TABLE    
 FROM #REGION TBL LEFT JOIN MIS.REMISIOR.DBO.TBL_EBROK_DETAIL_CLI BD ON TBL.ID = BD.BRANCH    
  LEFT JOIN INTRANET.RISK.DBO.CLIENT_DETAILS CD ON CD.PARTY_CODE = BD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS    
 WHERE BD.SAUDA_DATE >= CONVERT(DATETIME,@FDATE) AND BD.SAUDA_DATE <= CONVERT(DATETIME,@TDATE)    
  AND CD.EBROKING = 'Y'    
     
 DROP TABLE #REGION    
    
 /*************************************************************************************    
  USE TO GET LOGIN DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
     
 SELECT PARTY_CODE,CONNECTED,DATE    
 INTO #REGION_LOGIN_TABLE    
 FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS BD    
 WHERE CONNECTED > 0    
  AND CONVERT(DATETIME,DATE) >= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,DATE) <= CONVERT(DATETIME,@TDATE)    
      
 /*************************************************************************************    
  USE TO GET FINAL REPORT DATA    
 **************************************************************************************/    
     
 SELECT T.*,[NOL] =  ISNULL(LD.CONNECTED,0)    
 FROM #REGION_BROK_TABLE T LEFT JOIN #REGION_LOGIN_TABLE LD     
 ON T.PARTY_CODE = LD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND T.SAUDA_DATE = CONVERT(DATETIME,LD.DATE)     
     
 DROP TABLE #REGION_LOGIN_TABLE    
 DROP TABLE #REGION_BROK_TABLE    
    
END    
    
    
IF @USER = 'RGMAST'    
BEGIN    
    
 SELECT ID=BRANCH_CODE     
 INTO #RGMAST    
 FROM INTRANET.RISK.DBO.VW_REGION_GROUP_BRANCHES WHERE RGMAST_CODE = @CODE    
     
 /*************************************************************************************    
  USE TO GET BROKERAGE DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
    
 SELECT BD.SAUDA_DATE,    
 BRANCH_CD = BD.BRANCH,    
 BD.SUB_BROKER,    
 BD.PARTY_CODE,    
 [BSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [FO_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN EBROK_BROK_EARNED END),0.00),    
 [NCDX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN EBROK_BROK_EARNED END),0.00),    
 [BSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [FO_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NCDEX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00)   
 INTO #RGMAST_BROK_TABLE    
 FROM #RGMAST TBL LEFT JOIN MIS.REMISIOR.DBO.TBL_EBROK_DETAIL_CLI BD ON TBL.ID = BD.BRANCH    
  LEFT JOIN INTRANET.RISK.DBO.CLIENT_DETAILS CD ON CD.PARTY_CODE = BD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS    
 WHERE BD.SAUDA_DATE >= CONVERT(DATETIME,@FDATE) AND BD.SAUDA_DATE <= CONVERT(DATETIME,@TDATE)    
  AND CD.EBROKING = 'Y'    
     
 DROP TABLE #RGMAST    
    
 /*************************************************************************************    
  USE TO GET LOGIN DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
     
 SELECT PARTY_CODE,CONNECTED,DATE    
 INTO #RGMAST_LOGIN_TABLE    
 FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS BD    
 WHERE CONNECTED > 0    
  AND CONVERT(DATETIME,DATE) >= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,DATE) <= CONVERT(DATETIME,@TDATE)    
      
 /*************************************************************************************    
  USE TO GET FINAL REPORT DATA    
 **************************************************************************************/    
     
 SELECT T.*,[NOL] =  ISNULL(LD.CONNECTED,0)    
 FROM #RGMAST_BROK_TABLE T LEFT JOIN #RGMAST_LOGIN_TABLE LD     
 ON T.PARTY_CODE = LD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND T.SAUDA_DATE = CONVERT(DATETIME,LD.DATE)     
     
 DROP TABLE #RGMAST_LOGIN_TABLE    
 DROP TABLE #RGMAST_BROK_TABLE    
    
END    
    
IF @USER = 'ZONE'    
BEGIN    
    
 SELECT ID=BRANCH_CODE     
 INTO #ZONE    
 FROM INTRANET.RISK.DBO.VW_ZONE_GROUP_BRANCHES WHERE ZONE_CODE = @CODE    
     
 /*************************************************************************************    
  USE TO GET BROKERAGE DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
    
 SELECT BD.SAUDA_DATE,    
 BRANCH_CD = BD.BRANCH,    
 BD.SUB_BROKER,    
 BD.PARTY_CODE,    
 [BSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [FO_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN EBROK_BROK_EARNED END),0.00),    
 [NCDX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN EBROK_BROK_EARNED END),0.00),    
 [BSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [FO_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NCDEX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00)    
 INTO #ZONE_BROK_TABLE    
 FROM #ZONE TBL LEFT JOIN MIS.REMISIOR.DBO.TBL_EBROK_DETAIL_CLI BD ON TBL.ID = BD.BRANCH    
  LEFT JOIN INTRANET.RISK.DBO.CLIENT_DETAILS CD ON CD.PARTY_CODE = BD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS    
 WHERE BD.SAUDA_DATE >= CONVERT(DATETIME,@FDATE) AND BD.SAUDA_DATE <= CONVERT(DATETIME,@TDATE)    
  AND CD.EBROKING = 'Y'    
     
 DROP TABLE #ZONE    
    
 /*************************************************************************************    
  USE TO GET LOGIN DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
     
 SELECT PARTY_CODE,CONNECTED,DATE    
 INTO #ZONE_LOGIN_TABLE    
 FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS BD    
 WHERE CONNECTED > 0    
  AND CONVERT(DATETIME,DATE) >= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,DATE) <= CONVERT(DATETIME,@TDATE)    
      
 /*************************************************************************************    
  USE TO GET FINAL REPORT DATA    
 **************************************************************************************/    
     
 SELECT T.*,[NOL] =  ISNULL(LD.CONNECTED,0)    
 FROM #ZONE_BROK_TABLE T LEFT JOIN #ZONE_LOGIN_TABLE LD     
 ON T.PARTY_CODE = LD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND T.SAUDA_DATE = CONVERT(DATETIME,LD.DATE)     
     
 DROP TABLE #ZONE_LOGIN_TABLE    
 DROP TABLE #ZONE_BROK_TABLE    
    
END    
    
IF @USER = 'ZNMAST'    
BEGIN    
    
 SELECT ID=BRANCH_CODE     
 INTO #ZNMAST    
 FROM INTRANET.RISK.DBO.VW_ZONE_GROUP_BRANCHES WHERE ZONE_MAST_CODE = @CODE    
     
 /*************************************************************************************    
  USE TO GET BROKERAGE DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
    
 SELECT BD.SAUDA_DATE,    
 BRANCH_CD = BD.BRANCH,    
 BD.SUB_BROKER,    
 BD.PARTY_CODE,    
 [BSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [FO_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN EBROK_BROK_EARNED END),0.00),    
 [NCDX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN EBROK_BROK_EARNED END),0.00),    
 [BSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [FO_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NCDEX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00)   
 INTO #ZNMAST_BROK_TABLE    
 FROM #ZNMAST TBL LEFT JOIN MIS.REMISIOR.DBO.TBL_EBROK_DETAIL_CLI BD ON TBL.ID = BD.BRANCH    
  LEFT JOIN INTRANET.RISK.DBO.CLIENT_DETAILS CD ON CD.PARTY_CODE = BD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS    
 WHERE BD.SAUDA_DATE >= CONVERT(DATETIME,@FDATE) AND BD.SAUDA_DATE <= CONVERT(DATETIME,@TDATE)    
  AND CD.EBROKING = 'Y'    
     
 DROP TABLE #ZNMAST    
    
 /*************************************************************************************    
  USE TO GET LOGIN DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
     
 SELECT PARTY_CODE,CONNECTED,DATE    
 INTO #ZNMAST_LOGIN_TABLE    
 FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS BD    
 WHERE CONNECTED > 0    
  AND CONVERT(DATETIME,DATE) >= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,DATE) <= CONVERT(DATETIME,@TDATE)    
      
 /*************************************************************************************    
  USE TO GET FINAL REPORT DATA    
 **************************************************************************************/    
     
 SELECT T.*,[NOL] =  ISNULL(LD.CONNECTED,0)    
 FROM #ZNMAST_BROK_TABLE T LEFT JOIN #ZNMAST_LOGIN_TABLE LD     
 ON T.PARTY_CODE = LD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND T.SAUDA_DATE = CONVERT(DATETIME,LD.DATE)     
     
 DROP TABLE #ZNMAST_LOGIN_TABLE    
 DROP TABLE #ZNMAST_BROK_TABLE    
    
END    
    
    
    
IF @USER = 'BRANCH'    
BEGIN    
    
 /*************************************************************************************    
  USE TO GET BROKERAGE DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
    
 SELECT BD.SAUDA_DATE,    
 BRANCH_CD = BD.BRANCH,    
 BD.SUB_BROKER,    
 BD.PARTY_CODE,    
 [BSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN EBROK_BROK_EARNED END),0.00),    
 [FO_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN EBROK_BROK_EARNED END),0.00),    
 [NCDX_BR_ON] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN EBROK_BROK_EARNED END),0.00),    
 [BSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ABLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NSE_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLCM' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [FO_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACDLFO' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [MCX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLMCX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00),    
 [NCDEX_BR_OFF] = ISNULL((CASE BD.SEGMENT WHEN 'ACPLNCDEX' THEN OVERALL_BROK_EARNED - EBROK_BROK_EARNED END),0.00)    
 INTO #BRANCH_BROK_TABLE    
 FROM MIS.REMISIOR.DBO.TBL_EBROK_DETAIL_CLI BD    
  LEFT JOIN INTRANET.RISK.DBO.CLIENT_DETAILS CD ON BD.PARTY_CODE = CD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS    
 WHERE BD.SAUDA_DATE >= CONVERT(DATETIME,@FDATE) AND BD.SAUDA_DATE <= CONVERT(DATETIME,@TDATE)    
 AND CD.EBROKING = 'Y' AND BD.BRANCH = @CODE        
    
 /*************************************************************************************    
  USE TO GET LOGIN DETAILS FOR GIVEN PERIOD    
 **************************************************************************************/    
     
 SELECT PARTY_CODE,CONNECTED,DATE    
 INTO #BRANCH_LOGIN_TABLE    
 FROM [196.1.115.211].BIDB.DBO.VW_CLIENT_LOGIN_DETAILS BD    
 WHERE CONNECTED > 0    
  AND CONVERT(DATETIME,DATE) >= CONVERT(DATETIME,@FDATE) AND CONVERT(DATETIME,DATE) <= CONVERT(DATETIME,@TDATE)    
      
 /*************************************************************************************    
  USE TO GET FINAL REPORT DATA    
 **************************************************************************************/    
     
 SELECT T.*,[NOL] =  ISNULL(LD.CONNECTED,0)    
 FROM #BRANCH_BROK_TABLE T LEFT JOIN #BRANCH_LOGIN_TABLE LD     
 ON T.PARTY_CODE = LD.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS AND T.SAUDA_DATE = CONVERT(DATETIME,LD.DATE)    
     
 DROP TABLE #BRANCH_LOGIN_TABLE    
 DROP TABLE #BRANCH_BROK_TABLE    
   
END    
  
 SET NOCOUNT OFF  
    
    
/********************************************************************************************************************             
    
SET NOCOUNT ON                  
                  
IF @USER='BROKER'                    
BEGIN                               
 SELECT SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_BR_ON=SUM(ABLCM_BRK),NSE_BR_ON=SUM(ACDLCM_BRK),                    
 FO_BR_ON=SUM(ACDLFO_BRK),MCX_BR_ON=SUM(MCX_BROK),NCDX_BR_ON=SUM(NCDX_BROK),                    
 NOL=SUM(CASE WHEN USER_STAT='E-BROKING' THEN 1 ELSE 0 END),B2C='B2B'                    
 INTO #MIS                    
 FROM MIS_EBROKING_CLI (NOLOCK)                    
 WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
 AND USER_STAT='E-BROKING'                     
 GROUP BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE                                                                         
            
  UPDATE #MIS SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #MIS.SUB_BROKER=B.B2C_SB            
                 
  SELECT A.*,                    
  BSE_BR_OFF=ISNULL(BSE_BR_OFF,0),                    
  NSE_BR_OFF=ISNULL(NSE_BR_OFF,0),                    
  FO_BR_OFF=ISNULL(FO_BR_OFF,0) ,                    
  MCX_BR_OFF=ISNULL(MCX_BR_OFF,0),                    
  NCDEX_BR_OFF=ISNULL(NCDEX_BR_OFF,0)                    
   INTO #FILEB                     
  FROM #MIS A                                                                
  LEFT OUTER JOIN                                                                 
  (                                                                
  SELECT SAUDA_DATE,PARTY_CODE,BSE_BR_OFF=SUM(BSE_BR),NSE_BR_OFF=SUM(NSE_BR),                    
  FO_BR_OFF=SUM(FO_BR),MCX_BR_OFF=SUM(MCX_BR),NCDEX_BR_OFF=SUM(NCDEX_BR)                                                            
  FROM EBROK_TOBR_PERIOD (NOLOCK)                                                                 
  WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
   GROUP BY SAUDA_DATE,PARTY_CODE                                                                
  ) C                                                                   
  ON A.SAUDA_DATE=C.SAUDA_DATE                     
  AND A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                                                 
                      
 SELECT DISTINCT PARTY_CODE,NOOFLOGIN=COUNT(*),LOGIN_DATE INTO #LOG FROM                                 
 (                              
 SELECT  PARTY_CODE,DT=LOGIN_DATE,LOGIN_DATE FROM LOGINFILE                               
 WHERE LOGIN_DATE >=@FDATE AND LOGIN_DATE <=@TDATE                         
 ) A GROUP BY LOGIN_DATE,PARTY_CODE                      
                    
 UPDATE #FILEB SET NOL=ISNULL(B.NOOFLOGIN,0) FROM #LOG B                    
 WHERE  #FILEB.SAUDA_DATE=B.LOGIN_DATE AND  #FILEB.PARTY_CODE=B.PARTY_CODE                    
                    
 SELECT * FROM #FILEB WHERE  EXISTS              
 (SELECT DISTINCT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT) END                     
                    
IF @USER='BRMAST'                    
BEGIN                       
 SELECT BRANCH_CD INTO #BR FROM RISK.DBO.BRANCH_MASTER WHERE BRMAST_CD=@CODE                            
 SELECT SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_BR_ON=SUM(ABLCM_BRK),NSE_BR_ON=SUM(ACDLCM_BRK),                    
 FO_BR_ON=SUM(ACDLFO_BRK),MCX_BR_ON=SUM(MCX_BROK),NCDX_BR_ON=SUM(NCDX_BROK),                    
 NOL=SUM(CASE WHEN USER_STAT='E-BROKING' THEN 1 ELSE 0 END) ,B2C='B2B'                   
 INTO #MIS1                    
 FROM MIS_EBROKING_CLI (NOLOCK)                    
 WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
 AND USER_STAT='E-BROKING' AND BRANCH_CD IN (SELECT BRANCH_CD FROM #BR)                    
 GROUP BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE                                                                         
            
  UPDATE #MIS1 SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #MIS1.SUB_BROKER=B.B2C_SB            
                    
  SELECT A.*,                    
  BSE_BR_OFF=ISNULL(BSE_BR_OFF,0),                    
  NSE_BR_OFF=ISNULL(NSE_BR_OFF,0),                    
  FO_BR_OFF=ISNULL(FO_BR_OFF,0) ,                    
  MCX_BR_OFF=ISNULL(MCX_BR_OFF,0),                    
  NCDEX_BR_OFF=ISNULL(NCDEX_BR_OFF,0)                    
  INTO #FILEB1                     
  FROM #MIS1 A                                                         
  LEFT OUTER JOIN                          
  (                                                                
  SELECT SAUDA_DATE,PARTY_CODE,BSE_BR_OFF=SUM(BSE_BR),NSE_BR_OFF=SUM(NSE_BR),                    
  FO_BR_OFF=SUM(FO_BR),MCX_BR_OFF=SUM(MCX_BR),NCDEX_BR_OFF=SUM(NCDEX_BR)                                                            
  FROM EBROK_TOBR_PERIOD (NOLOCK)                                                                 
  WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE AND BRANCH_CD IN (SELECT BRANCH_CD FROM #BR)                    
   GROUP BY SAUDA_DATE,PARTY_CODE                                                                
  ) C                              
  ON A.SAUDA_DATE=C.SAUDA_DATE                     
  AND A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                     
                    
 SELECT DISTINCT PARTY_CODE,NOOFLOGIN=COUNT(*),LOGIN_DATE INTO #LOG1 FROM                                 
 (                              
 SELECT  PARTY_CODE,DT=LOGIN_DATE,LOGIN_DATE FROM LOGINFILE                               
 WHERE LOGIN_DATE >=@FDATE AND LOGIN_DATE <=@TDATE                      
 ) A GROUP BY LOGIN_DATE,PARTY_CODE                      
                    
 UPDATE #FILEB1 SET NOL=ISNULL(B.NOOFLOGIN,0) FROM #LOG1 B                    
 WHERE  #FILEB1.SAUDA_DATE=B.LOGIN_DATE AND  #FILEB1.PARTY_CODE=B.PARTY_CODE                    
                    
 SELECT * FROM #FILEB1 WHERE PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS IN (SELECT DISTINCT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT)                    
                    
END                    
                    
                
IF @USER='REGION'                    
BEGIN          
--SELECT TOP 5 * FROM RISK.DBO.REGION                        
 SELECT CODE INTO #BR1 FROM RISK.DBO.REGION WHERE REG_CODE=@CODE                           
 SELECT SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_BR_ON=SUM(ABLCM_BRK),NSE_BR_ON=SUM(ACDLCM_BRK),                    
 FO_BR_ON=SUM(ACDLFO_BRK),MCX_BR_ON=SUM(MCX_BROK),NCDX_BR_ON=SUM(NCDX_BROK),                    
 NOL=SUM(CASE WHEN USER_STAT='E-BROKING' THEN 1 ELSE 0 END) ,B2C='B2B'                   
 INTO #MIS3                    
 FROM MIS_EBROKING_CLI (NOLOCK)                    
 WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
 AND USER_STAT='E-BROKING' AND BRANCH_CD IN (SELECT CODE FROM #BR1)                    
 GROUP BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE                                                                         
            
  UPDATE #MIS3 SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #MIS3.SUB_BROKER=B.B2C_SB            
                    
  SELECT A.*,                    
  BSE_BR_OFF=ISNULL(BSE_BR_OFF,0),                    
  NSE_BR_OFF=ISNULL(NSE_BR_OFF,0),                    
  FO_BR_OFF=ISNULL(FO_BR_OFF,0) ,                    
  MCX_BR_OFF=ISNULL(MCX_BR_OFF,0),                    
  NCDEX_BR_OFF=ISNULL(NCDEX_BR_OFF,0)                    
   INTO #FILEB3                     
  FROM #MIS3 A                                                          
  LEFT OUTER JOIN                                                                 
  (                                                                
  SELECT SAUDA_DATE,PARTY_CODE,BSE_BR_OFF=SUM(BSE_BR),NSE_BR_OFF=SUM(NSE_BR),                    
  FO_BR_OFF=SUM(FO_BR),MCX_BR_OFF=SUM(MCX_BR),NCDEX_BR_OFF=SUM(NCDEX_BR)                                                            
  FROM EBROK_TOBR_PERIOD (NOLOCK)                                                                 
  WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE AND BRANCH_CD IN (SELECT CODE FROM #BR1)                    
   GROUP BY SAUDA_DATE,PARTY_CODE                                                                
  ) C                                                                   
  ON A.SAUDA_DATE=C.SAUDA_DATE                     
  AND A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                
                    
 SELECT DISTINCT PARTY_CODE,NOOFLOGIN=COUNT(*),LOGIN_DATE INTO #LOG3 FROM                               
 (                              
 SELECT  PARTY_CODE,DT=LOGIN_DATE,LOGIN_DATE FROM LOGINFILE                               
 WHERE LOGIN_DATE >=@FDATE AND LOGIN_DATE <=@TDATE                      
 ) A GROUP BY LOGIN_DATE,PARTY_CODE                      
                    
 UPDATE #FILEB3 SET NOL=ISNULL(B.NOOFLOGIN,0) FROM #LOG3 B                    
 WHERE  #FILEB3.SAUDA_DATE=B.LOGIN_DATE AND  #FILEB3.PARTY_CODE=B.PARTY_CODE               
                    
 SELECT * FROM #FILEB3 WHERE PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS IN (SELECT DISTINCT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT)                    
                    
END                   
                
                
IF @USER='BRANCH'                    
BEGIN                       
                     
 SELECT SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_BR_ON=SUM(ABLCM_BRK),NSE_BR_ON=SUM(ACDLCM_BRK),                    
 FO_BR_ON=SUM(ACDLFO_BRK),MCX_BR_ON=SUM(MCX_BROK),NCDX_BR_ON=SUM(NCDX_BROK),                    
 NOL=SUM(CASE WHEN USER_STAT='E-BROKING' THEN 1 ELSE 0 END) ,B2C='B2B'                   
 INTO #MIS2                    
 FROM MIS_EBROKING_CLI (NOLOCK)                    
 WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
 AND USER_STAT='E-BROKING' AND BRANCH_CD=@CODE                    
 GROUP BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE                                                                         
            
  UPDATE #MIS2 SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #MIS2.SUB_BROKER=B.B2C_SB            
                    
  SELECT A.*,                    
  BSE_BR_OFF=ISNULL(BSE_BR_OFF,0),                    
  NSE_BR_OFF=ISNULL(NSE_BR_OFF,0),                    
  FO_BR_OFF=ISNULL(FO_BR_OFF,0) ,                    
  MCX_BR_OFF=ISNULL(MCX_BR_OFF,0),                    
  NCDEX_BR_OFF=ISNULL(NCDEX_BR_OFF,0)                    
   INTO #FILEB2                     
  FROM #MIS2 A                                                                
  LEFT OUTER JOIN                                                
  (                                                                
  SELECT SAUDA_DATE,PARTY_CODE,BSE_BR_OFF=SUM(BSE_BR),NSE_BR_OFF=SUM(NSE_BR),                    
  FO_BR_OFF=SUM(FO_BR),MCX_BR_OFF=SUM(MCX_BR),NCDEX_BR_OFF=SUM(NCDEX_BR)                                                            
  FROM EBROK_TOBR_PERIOD (NOLOCK)                                                                 
  WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE AND BRANCH_CD=@CODE                    
   GROUP BY SAUDA_DATE,PARTY_CODE                                                                
  ) C                                                                   
  ON A.SAUDA_DATE=C.SAUDA_DATE                     
  AND A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                                                 
                    
 SELECT DISTINCT PARTY_CODE,NOOFLOGIN=COUNT(*),LOGIN_DATE INTO #LOG2 FROM                                 
 (                              
 SELECT  PARTY_CODE,DT=LOGIN_DATE,LOGIN_DATE FROM LOGINFILE                               
 WHERE LOGIN_DATE >=@FDATE AND LOGIN_DATE <=@TDATE                      
 ) A GROUP BY LOGIN_DATE,PARTY_CODE                      
                    
 UPDATE #FILEB2 SET NOL=ISNULL(B.NOOFLOGIN,0) FROM #LOG2 B                    
 WHERE  #FILEB2.SAUDA_DATE=B.LOGIN_DATE AND  #FILEB2.PARTY_CODE=B.PARTY_CODE                    
                    
 SELECT * FROM #FILEB2 WHERE PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS IN (SELECT DISTINCT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT)                    
                    
END            
IF @USER='RGMAST'                    
BEGIN          
--SELECT BRANCH_CODE,* FROM RISK.DBO.VW_REGION_GROUP_BRANCHES WHERE RGMAST_CODE                       
 SELECT CODE=BRANCH_CODE INTO #RGM1 FROM RISK.DBO.VW_REGION_GROUP_BRANCHES WHERE RGMAST_CODE=@CODE                           
 SELECT SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_BR_ON=SUM(ABLCM_BRK),NSE_BR_ON=SUM(ACDLCM_BRK),                    
 FO_BR_ON=SUM(ACDLFO_BRK),MCX_BR_ON=SUM(MCX_BROK),NCDX_BR_ON=SUM(NCDX_BROK),                    
 NOL=SUM(CASE WHEN USER_STAT='E-BROKING' THEN 1 ELSE 0 END) ,B2C='B2B'                   
 INTO #MIS4                    
 FROM MIS_EBROKING_CLI (NOLOCK)                    
 WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
 AND USER_STAT='E-BROKING' AND BRANCH_CD IN (SELECT CODE FROM #RGM1)                    
 GROUP BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE                                              
            
  UPDATE #MIS4 SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #MIS4.SUB_BROKER=B.B2C_SB            
                    
  SELECT A.*,                    
  BSE_BR_OFF=ISNULL(BSE_BR_OFF,0),                    
  NSE_BR_OFF=ISNULL(NSE_BR_OFF,0),                    
  FO_BR_OFF=ISNULL(FO_BR_OFF,0) ,                    
  MCX_BR_OFF=ISNULL(MCX_BR_OFF,0),                    
  NCDEX_BR_OFF=ISNULL(NCDEX_BR_OFF,0)                    
   INTO #FILEB4                     
  FROM #MIS4 A                                                                
  LEFT OUTER JOIN                                                                 
  (                                                                
  SELECT SAUDA_DATE,PARTY_CODE,BSE_BR_OFF=SUM(BSE_BR),NSE_BR_OFF=SUM(NSE_BR),                    
  FO_BR_OFF=SUM(FO_BR),MCX_BR_OFF=SUM(MCX_BR),NCDEX_BR_OFF=SUM(NCDEX_BR)                                                            
  FROM EBROK_TOBR_PERIOD (NOLOCK)                                                                 
  WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE AND BRANCH_CD IN (SELECT CODE FROM #RGM1)                    
   GROUP BY SAUDA_DATE,PARTY_CODE                                                                
  ) C                                                                   
  ON A.SAUDA_DATE=C.SAUDA_DATE                     
  AND A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                     
                    
 SELECT DISTINCT PARTY_CODE,NOOFLOGIN=COUNT(*),LOGIN_DATE INTO #LOG4 FROM                                 
 (                              
 SELECT  PARTY_CODE,DT=LOGIN_DATE,LOGIN_DATE FROM LOGINFILE                               
 WHERE LOGIN_DATE >=@FDATE AND LOGIN_DATE <=@TDATE                      
 ) A GROUP BY LOGIN_DATE,PARTY_CODE                      
                    
 UPDATE #FILEB4 SET NOL=ISNULL(B.NOOFLOGIN,0) FROM #LOG4 B                    
 WHERE  #FILEB4.SAUDA_DATE=B.LOGIN_DATE AND  #FILEB4.PARTY_CODE=B.PARTY_CODE                    
                    
 SELECT * FROM #FILEB4 WHERE PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS IN (SELECT DISTINCT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT)                    
                    
END            
          
IF @USER='ZONE'                    
BEGIN          
--SELECT * FROM VW_ZONE_GROUP_BRANCHES                   
 SELECT CODE=BRANCH_CODE INTO #ZN1 FROM RISK.DBO.VW_ZONE_GROUP_BRANCHES WHERE ZONE_CODE=@CODE                           
 SELECT SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_BR_ON=SUM(ABLCM_BRK),NSE_BR_ON=SUM(ACDLCM_BRK),                    
 FO_BR_ON=SUM(ACDLFO_BRK),MCX_BR_ON=SUM(MCX_BROK),NCDX_BR_ON=SUM(NCDX_BROK),                    
 NOL=SUM(CASE WHEN USER_STAT='E-BROKING' THEN 1 ELSE 0 END) ,B2C='B2B'                   
 INTO #MIS5                    
 FROM MIS_EBROKING_CLI (NOLOCK)                    
 WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
 AND USER_STAT='E-BROKING' AND BRANCH_CD IN (SELECT CODE FROM #ZN1)                    
 GROUP BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE                                                                         
            
  UPDATE #MIS5 SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #MIS5.SUB_BROKER=B.B2C_SB            
                    
  SELECT A.*,                    
  BSE_BR_OFF=ISNULL(BSE_BR_OFF,0),                    
  NSE_BR_OFF=ISNULL(NSE_BR_OFF,0),                    
  FO_BR_OFF=ISNULL(FO_BR_OFF,0) ,                    
  MCX_BR_OFF=ISNULL(MCX_BR_OFF,0),                    
  NCDEX_BR_OFF=ISNULL(NCDEX_BR_OFF,0)                    
   INTO #FILEB5                     
  FROM #MIS5 A                                                    
  LEFT OUTER JOIN                                                                 
  (                                        
  SELECT SAUDA_DATE,PARTY_CODE,BSE_BR_OFF=SUM(BSE_BR),NSE_BR_OFF=SUM(NSE_BR),                    
  FO_BR_OFF=SUM(FO_BR),MCX_BR_OFF=SUM(MCX_BR),NCDEX_BR_OFF=SUM(NCDEX_BR)                                                            
  FROM EBROK_TOBR_PERIOD (NOLOCK)                                                                 
  WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE AND BRANCH_CD IN (SELECT CODE FROM #ZN1)                    
   GROUP BY SAUDA_DATE,PARTY_CODE                                         
  ) C                                                                   
  ON A.SAUDA_DATE=C.SAUDA_DATE                     
  AND A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                     
                    
 SELECT DISTINCT PARTY_CODE,NOOFLOGIN=COUNT(*),LOGIN_DATE INTO #LOG5 FROM                                 
 (                              
 SELECT  PARTY_CODE,DT=LOGIN_DATE,LOGIN_DATE FROM LOGINFILE                               
 WHERE LOGIN_DATE >=@FDATE AND LOGIN_DATE <=@TDATE               
 ) A GROUP BY LOGIN_DATE,PARTY_CODE                      
                    
 UPDATE #FILEB5 SET NOL=ISNULL(B.NOOFLOGIN,0) FROM #LOG5 B                    
 WHERE  #FILEB5.SAUDA_DATE=B.LOGIN_DATE AND  #FILEB5.PARTY_CODE=B.PARTY_CODE                    
                    
 SELECT * FROM #FILEB5 WHERE PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS IN (SELECT DISTINCT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT)                    
                    
END               
IF @USER='ZNMAST'                    
BEGIN          
--SELECT * FROM VW_ZONE_GROUP_BRANCHES                   
 SELECT CODE=BRANCH_CODE INTO #ZNM1 FROM RISK.DBO.VW_ZONE_GROUP_BRANCHES WHERE ZONE_MAST_CODE=@CODE                           
 SELECT SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_BR_ON=SUM(ABLCM_BRK),NSE_BR_ON=SUM(ACDLCM_BRK),                    
 FO_BR_ON=SUM(ACDLFO_BRK),MCX_BR_ON=SUM(MCX_BROK),NCDX_BR_ON=SUM(NCDX_BROK),                    
 NOL=SUM(CASE WHEN USER_STAT='E-BROKING' THEN 1 ELSE 0 END) ,B2C='B2B'                   
 INTO #MIS6                    
 FROM MIS_EBROKING_CLI (NOLOCK)                    
 WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE                    
 AND USER_STAT='E-BROKING' AND BRANCH_CD IN (SELECT CODE FROM #ZNM1)                    
 GROUP BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE                                                                         
            
  UPDATE #MIS6 SET B2C='B2C' FROM MIS.REMISIOR.DBO.B2C_SB B WHERE #MIS6.SUB_BROKER=B.B2C_SB            
    
  SELECT A.*,                    
  BSE_BR_OFF=ISNULL(BSE_BR_OFF,0),                    
  NSE_BR_OFF=ISNULL(NSE_BR_OFF,0),                    
  FO_BR_OFF=ISNULL(FO_BR_OFF,0) ,                    
  MCX_BR_OFF=ISNULL(MCX_BR_OFF,0),                    
  NCDEX_BR_OFF=ISNULL(NCDEX_BR_OFF,0)                    
   INTO #FILEB6                     
  FROM #MIS6 A                                                                
  LEFT OUTER JOIN                                                                 
  (                                                                
  SELECT SAUDA_DATE,PARTY_CODE,BSE_BR_OFF=SUM(BSE_BR),NSE_BR_OFF=SUM(NSE_BR),                    
  FO_BR_OFF=SUM(FO_BR),MCX_BR_OFF=SUM(MCX_BR),NCDEX_BR_OFF=SUM(NCDEX_BR)                                                            
  FROM EBROK_TOBR_PERIOD (NOLOCK)                                                                 
  WHERE SAUDA_DATE>=@FDATE AND SAUDA_DATE <=@TDATE AND BRANCH_CD IN (SELECT CODE FROM #ZNM1)                    
   GROUP BY SAUDA_DATE,PARTY_CODE                                                                
  ) C                                                                   
  ON A.SAUDA_DATE=C.SAUDA_DATE                     
  AND A.PARTY_CODE=C.PARTY_CODE COLLATE LATIN1_GENERAL_CI_AS                                     
                    
 SELECT DISTINCT PARTY_CODE,NOOFLOGIN=COUNT(*),LOGIN_DATE INTO #LOG6 FROM                                 
 (                              
 SELECT  PARTY_CODE,DT=LOGIN_DATE,LOGIN_DATE FROM LOGINFILE                               
 WHERE LOGIN_DATE >=@FDATE AND LOGIN_DATE <=@TDATE                      
 ) A GROUP BY LOGIN_DATE,PARTY_CODE                      
                    
 UPDATE #FILEB6 SET NOL=ISNULL(B.NOOFLOGIN,0) FROM #LOG6 B                    
 WHERE  #FILEB6.SAUDA_DATE=B.LOGIN_DATE AND  #FILEB6.PARTY_CODE=B.PARTY_CODE                    
                    
 SELECT * FROM #FILEB6 WHERE PARTY_CODE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS IN (SELECT DISTINCT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT)                    
                    
END                            
SET NOCOUNT OFF     
    
**********************************************************************************************************************************************/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.low_brok_cli
-- --------------------------------------------------
CREATE procedure low_brok_cli    
(@FDATE as varchar(11),     
@TDATE as varchar(11),     
@EntityCode as varchar(25), 
@EntityType as varchar(25),  
@FltrEntity as varchar(10),    
@segment as varchar(15) ,      
@type as varchar(10),
@yield as varchar(10) ,        
@access_to as varchar(10),    
@access_code as varchar(25)    
)                                    
AS  
/*declare 
@FDATE as varchar(11),
@TDATE as varchar(11),
@EntityCode as varchar(25),
@EntityType as varchar(25),
@FltrEntity as varchar(10), 
@segment as varchar(15)  ,
@type as varchar(10),
@yield as varchar(10),
@access_to as varchar(10),
@access_code as varchar(25)

set @FDATE ='01 dec 2008'
set @TDATE='03 dec 2008'
set @EntityCode='sk'
set @EntityType='region'
set @FltrEntity='region'
set @segment='ABLCM'
set @type='B2B'
set @yield='0.0009'
set @access_to ='broker'
set @access_code ='cso'*/
       

select Zone=space(10),Region,Branch=branch_cd,SB=Sub_broker,[Type]=space(5),client=party_code,
NoOfTrade=count(distinct sauda_date),
TurnOver=sum(turnover),
AvgTurnover=sum(turnover)/count(distinct sauda_date),
NetBrokerage=convert(money,0),
AvgNetBrokerage=convert(money,0), 
Yield=convert(money,0)
into #file1
from mis_to (nolock)
where sauda_date>=@FDATE and sauda_date<=@TDATE 
and company like @segment
group by Region,branch_cd,Sub_broker,party_code

select party_code, 
angel_share=sum(angel_share)  
into #file2   
from mis.remisior.dbo.comb_cli  
where sauda_date>=@FDATE and sauda_date<=@TDATE 
and segment like @segment
group by party_code

update #file1 set NetBrokerage=b.angel_share  
from (select * from #file2 )b   
where client=b.party_code collate SQL_Latin1_General_CP1_CI_AS

update #file1 set AvgNetBrokerage=NetBrokerage/NoOfTrade ,Yield=(NetBrokerage/NoOfTrade)/AvgTurnover

update #file1 set #file1.zone=b.zone ,#file1.region = b.region from risk.dbo.Vw_BRANCH_Vertical b where #file1.branch=b.branch

update #file1 set [Type]=case when SB in (select B2C_SB from mis.remisior.dbo.b2c_sb) then 'B2C' else 'B2B' end 

declare @sql as varchar(1000),@condition as varchar(1000),@finqry as varchar(1500)
set @sql='select Region,Branch,[Subbroker]=SB,[Type],Client,
[Average Net Turnover]=AvgTurnover , [Average Net Brokerage]=AvgNetBrokerage, Yield
from #file1 where yield<='+@yield+ ' and type like '''+ @type+''' '   

if @access_to='SB'                                                             
begin            
set @condition = ' and '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''     
end                                                                    
if @access_to='BROKER'                                                                              
begin   
set @condition = ' and  '+@FltrEntity+' like '''+@EntityCode+''''                                                               
end                                              
if(@access_to='BRANCH')                                              
begin 
set @condition = ' and  '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''
end                                              
if(@access_to='BRMAST')          
begin         
set @condition = ' and   Branch in (select branch_cd collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.branch_master where brmast_cd= '''+@access_code+''')'
end                                           
if(@access_to='REGION')                                              
begin               
set @condition = ' and  branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.REGION where REG_CODE= '''+@access_code+''')'
end                            
if(@access_to='SBMAST')          
begin    
set @condition = ' and  SB in (select sub_broker collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.sb_master where sbmast_cd=  '''+@access_code+''')'           
end 

set @finqry=@sql +@condition

exec (@finqry)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mappintsegment
-- --------------------------------------------------
CREATE PROCEDURE mappintsegment
AS  
            --BEGIN TRAN 
            declare @@get_tno as cursor  
            declare @@ClientCode as varchar(8)  
            declare @@DPID as varchar(8)  
            --declare @@DPClientId as varchar(16)  
           -- set @@get_tno = cursor for select  ClientCode,DPID,DPClientId from tblPOAUpdate_Temp where Exchange='BSE' and MkrDate='mkrdt' order by ClientCode  
            set @@get_tno = cursor for select ClientCode=party_code  from tempfinal where compdate is not null and len(reg_no)>1order by party_code
            open @@get_tno  
            fetch next from @@get_tno into @@ClientCode--,@@DPID,@@DPClientId  
            
            while @@fetch_status=0   
                        BEGIN   
                                 ----print   'Level in - '+convert(varchar(25),getdate(),109)
                                 ----print  @@ClientCode 
                                  exec calculate_segment @@ClientCode                                      
                                  --print  @@dpid
                                 fetch next from @@get_tno into @@ClientCode--,@@DPID,@@DPClientId  
                         END  
            
            
            

            --Print 'Level 7 OK - '+convert(varchar(25),getdate(),109)
            close @@get_tno  
            deallocate @@get_tno  
            --commit tran

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_2
-- --------------------------------------------------
create procedure MIS_2(@fdate as varchar(11),@tdate as varchar(11))
as
set transaction isolation level read uncommitted
set nocount on

select party_code,branch_cd,Sub_broker,
BSE_Tot_Brk=sum(ABLCM_BRK),
BSE_ebk_Brk=sum(case when user_stat='e-broking' then ABLCM_BRK else 0 end),
NSE_Tot_Brk=sum(ACDLCM_BRK),
NSE_ebk_Brk=sum(case when user_stat='e-broking' then ACDLCM_BRK else 0 end),
FO_Tot_Brk=sum(ACDLFO_BRK),
FO_ebk_Brk=sum(case when user_stat='e-broking' then ACDLFO_BRK else 0 end),
MCX_Tot_Brk=sum(mcx_BRoK),
MCX_ebk_Brk=sum(case when user_stat='e-broking' then mcx_BRoK else 0 end),
NCDEX_Tot_Brk=sum(ncdx_BRoK),
NCDEX_ebk_Brk=sum(case when user_stat='e-broking' then ncdx_BRoK else 0 end),
NCDEX_Tot_Brk=sum(brokerage),
NCDEX_ebk_Brk=sum(case when user_stat='e-broking' then brokerage else 0 end)
from MIS_ebroking
where sauda_DAte >=@fdate and sauda_DAte <=@tdate
group by party_code,branch_cd,Sub_broker

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_Brwise
-- --------------------------------------------------
CREATE procedure MIS_Brwise(@fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10))
as

set nocount on
set transaction isolation level read uncommitted

select 
branch_cd,
BSE_TO=sum(case when company='ABLCM' then turnover else 0 end),
NSE_TO=sum(case when company='ACDLCM' then turnover else 0 end),
FO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
MCX_TO=sum(case when company='ACPLMCX' then turnover else 0 end),
NCDEX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),
EBROK_TO=sum(case when userid is not null then turnover else 0 end),
BSE_BR=sum(case when company='ABLCM' then brokerage else 0 end),
NSE_Br=sum(case when company='ACDLCM' then brokerage else 0 end),
FO_Br=sum(case when company='ACDLFO' then brokerage else 0 end),
MCX_Br=sum(case when company='ACPLMCX' then brokerage else 0 end),
NCDEX_Br=sum(case when company='ACPLNCDEX' then brokerage else 0 end),
EBROK_BR=sum(case when userid is not null then brokerage else 0 end)
into #fileb
from mis_to a left outer join ebroking b on a.terminal_id collate Latin1_General_CI_AS = b.userid
where sauda_date>=@fdate and sauda_date<=@tdate
and branch_cd like @brcode 
group by branch_cd,terminal_id,userid


select branch_Cd,tradername,
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br)
from #fileb a left outer join risk.dbo.branch b on a.branch_Cd=b.sbtag
group by branch_Cd,tradername order by branch_Cd

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_Client_grade_batch
-- --------------------------------------------------

CREATE proc MIS_Client_grade_batch        
        
as         
        
set nocount on        
     DECLARE  @RecCount AS INT,@BatchCount AS INT           
    
 SELECT @RecCount=COUNT(1) FROM dbo.MIS_Client_grade   WHERE  TmonthNo = datepart(mm,GETDATE()) and TYear=datepart(yyyy,GETDATE())        
 SET @BatchCount=50000        
      
WHILE @RecCount >0        
      
BEGIN        
BEGIN TRAN       
       
 DELETE TOP (@BatchCount) FROM dbo.MIS_Client_grade   WHERE  TmonthNo = datepart(mm,GETDATE()) and TYear=datepart(yyyy,GETDATE())             
       
   COMMIT TRAN        
         
   SET @RecCount=@RecCount - @BatchCount         
         
set nocount off        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_Clientwise
-- --------------------------------------------------
CREATE procedure MIS_Clientwise(@fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10),@sbcode as varchar(10))
as

set nocount on
set transaction isolation level read uncommitted

select 
party_code,
BSE_TO=sum(case when company='ABLCM' then turnover else 0 end),
NSE_TO=sum(case when company='ACDLCM' then turnover else 0 end),
FO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
MCX_TO=sum(case when company='ACPLMCX' then turnover else 0 end),
NCDEX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),
EBROK_TO=sum(case when userid is not null then turnover else 0 end),
BSE_BR=sum(case when company='ABLCM' then brokerage else 0 end),
NSE_Br=sum(case when company='ACDLCM' then brokerage else 0 end),
FO_Br=sum(case when company='ACDLFO' then brokerage else 0 end),
MCX_Br=sum(case when company='ACPLMCX' then brokerage else 0 end),
NCDEX_Br=sum(case when company='ACPLNCDEX' then brokerage else 0 end),
EBROK_BR=sum(case when userid is not null then brokerage else 0 end)
into #filed
from mis_to a left outer join ebroking b on a.terminal_id collate Latin1_General_CI_AS = b.userid
where sauda_date>=@fdate and sauda_date<=@tdate
and branch_cd like @brcode and sub_Broker like @sbcode
group by party_code,terminal_id,userid



select branch_cd=sbtag,sub_broker=subgroup,a.party_code,party_name,
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br)
into #filex
from #filed a left outer join risk.dbo.finmast b on a.party_code=b.party_Code collate Latin1_General_CI_AS
group by sbtag,subgroup,a.party_code,party_name order by sbtag,subgroup,a.party_code


select party_Code,bse_stat=max(bse_stat),nse_stat=max(nse_stat),fo_stat=max(fo_stat),mcdx_stat=max(mcdx_stat),ncdx_stat=max(ncdx_stat) 
into #pty_stat
from
(

select party_Code,bse_stat='Y',nse_stat=' ',fo_stat=' ',mcdx_stat=' ',ncdx_stat=' ' --into #bse
from risk.dbo.bse_client5 c5, risk.dbo.bse_client2 c2 where c2.cl_code=c5.cl_code
and inactivefrom >= getdate()

union

select party_Code,bse_stat=' ',nse_stat='Y',fo_stat=' ',mcdx_stat=' ',ncdx_stat=' ' --into #nse
from risk.dbo.nse_client5 c5, risk.dbo.nse_client2 c2 where c2.cl_code=c5.cl_code
and inactivefrom >= getdate()

union

select party_Code,bse_stat=' ',nse_stat=' ',fo_stat='Y',mcdx_stat=' ',ncdx_stat=' ' --into #fo
from risk.dbo.fo_client5 c5, risk.dbo.fo_client2 c2 where c2.cl_code=c5.cl_code
and inactivefrom >= getdate()

union

select party_Code,bse_stat=' ',nse_stat=' ',fo_stat=' ',mcdx_stat='Y',ncdx_stat=' ' --into #mcdx
from risk.dbo.mcdx_client5 c5, risk.dbo.mcdx_client2 c2 where c2.cl_code=c5.cl_code
and inactivefrom >= getdate()

union

select party_Code,bse_stat=' ',nse_stat=' ',fo_stat=' ',mcdx_stat=' ',ncdx_stat='Y' --into #ncdx
from risk.dbo.ncdx_client5 c5, risk.dbo.ncdx_client2 c2 where c2.cl_code=c5.cl_code
and inactivefrom >= getdate()

) a
 group by party_Code


select a.*,bse_stat=isnull(bse_stat,' '),nse_stat=isnull(nse_stat,' '),
fo_stat=isnull(fo_stat,' '),mcdx_stat=isnull(mcdx_stat,' '),ncdx_stat=isnull(ncdx_stat,' ')
from #filex a left outer join #pty_stat b on a.party_Code=b.party_Code collate Latin1_General_CI_AS

set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_Clientwisetemp
-- --------------------------------------------------
CREATE procedure MIS_Clientwisetemp(@fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10),@sbcode as varchar(10))          
as          
          
set nocount on          
set transaction isolation level read uncommitted          
          
/* declare @fdate varchar(10)          
declare @tdate varchar(10)          
declare @brcode varchar(3)          
declare @sbcode varchar(3)          
set @fdate='05/01/2006'          
set @tdate='05/31/2006'          
set @brcode='%'          
set @sbcode='%'       
*/

select           
party_code, sauda_date  ,       
BSE_TO=sum(case when company='ABLCM' then turnover else 0 end),          
NSE_TO=sum(case when company='ACDLCM' then turnover else 0 end),          
FO_TO=sum(case when company='ACDLFO' then turnover else 0 end),          
MCX_TO=sum(case when company='ACPLMCX' then turnover else 0 end),          
NCDEX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),          
EBROK_TO=sum(case when userid is not null then turnover else 0 end),          
BSE_BR=sum(case when company='ABLCM' then brokerage else 0 end),          
NSE_Br=sum(case when company='ACDLCM' then brokerage else 0 end),          
FO_Br=sum(case when company='ACDLFO' then brokerage else 0 end),          
MCX_Br=sum(case when company='ACPLMCX' then brokerage else 0 end),          
NCDEX_Br=sum(case when company='ACPLNCDEX' then brokerage else 0 end),          
EBROK_BR=sum(case when userid is not null then brokerage else 0 end),       
eBSE_BR=sum(case when company='ABLCM' and  userid is not null then brokerage else 0 end),          
eNSE_Br=sum(case when company='ACDLCM' and  userid is not null then brokerage else 0 end),          
eFO_Br=sum(case when company='ACDLFO' and  userid is not null then brokerage else 0 end),          
eMCX_Br=sum(case when company='ACPLMCX' and  userid is not null then brokerage else 0 end),          
eNCDEX_Br=sum(case when company='ACPLNCDEX' and  userid is not null then brokerage else 0 end)          
into #filed          
from mis_to a left outer join ebroking b on a.terminal_id collate Latin1_General_CI_AS = b.userid          
where sauda_date>=@fdate and sauda_date<=@tdate          
and branch_cd like @brcode and sub_Broker like @sbcode          
group by party_code,terminal_id,userid,sauda_date      
          
      
          
select sauda_date,branch_cd=sbtag,sub_broker=subgroup,a.party_code,party_name,          
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),          
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br),
ebse_br=sum(ebse_br),ense_br=sum(ense_br),efo_br=sum(efo_br),emcx_br=sum(emcx_br),encdex_br=sum(encdex_br)          
into #filex          
from #filed a left outer join risk.dbo.finmast b on a.party_code=b.party_Code collate Latin1_General_CI_AS          
group by sauda_date,sbtag,subgroup,a.party_code,party_name order by sbtag,subgroup,a.party_code          
      
     
select party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat      
into #pty_stat          
from          
(          
          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=0          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=0          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #nse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=1          
union all      
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #nse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=1          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #fo          
from #filex,ver7 where party_code=[user id] and [trading allowed]=2          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #fo          
from #filex,ver6 where party_code=[user id] and [markets allowed]=2          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=3          
union all        
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse      
from #filex,ver6 where party_code=[user id] and [markets allowed]=3          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=8          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=8          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=9          
union all     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=9          
union all        
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=10          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=10          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=11          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=11          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #mcdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=16          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #mcdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=16          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=17          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=17          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=18          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=18          
union all    
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=19          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=19          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=24          
union all    
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=24          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=25          
union all    
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=25          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=26          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=26          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=27          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=27          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=64          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=64          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #nse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=65          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #nse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=65          
union all        
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #nse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=66          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #nse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=66          
union all     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=72          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=72          
union all       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=73          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=73          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=75          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=75          
union all      
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=80          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=80          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #fo          
from #filex,ver7 where party_code=[user id] and [trading allowed]=81          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #fo          
from #filex,ver6 where party_code=[user id] and [markets allowed]=81          
union all    
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=82          
union all          
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=82          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=83          
union all          
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=83          
union all    
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=88          
/* 0.0,27.0,10.0,75.0,89.0,64.0,25.0,9.0,16.0,8.0,73.0,2.0,90.0,1.0,19.0,82.0,26.0,24.0,88.0,91.0,80.0,3.0,11.0,83.0 -- ver6 */          
/* 75,83,91,66,82,90,65,19,27,73,81,11,89,3,72,18,80,26,10,88,2,17,25,9,64,1,24,16,8 -- ver7*/          
union all          
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=88          
/* 0.0,27.0,10.0,75.0,89.0,64.0,25.0,9.0,16.0,8.0,73.0,2.0,90.0,1.0,19.0,82.0,26.0,24.0,88.0,91.0,80.0,3.0,11.0,83.0 */          
/* 75,83,91,66,82,90,65,19,27,73,81,11,89,3,72,18,80,26,10,88,2,17,25,9,64,1,24,16,8*/          
union all    
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=89            
union all     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat=' ',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=89            
union all    
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #filex,ver7 where party_code=[user id] and [trading allowed]=90          
union all     
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #filex,ver6 where party_code=[user id] and [markets allowed]=90          
union all     
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver7 where party_code=[user id] and [trading allowed]=91          
union all          
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #filex,ver6 where party_code=[user id] and [markets allowed]=91          
) a          
 group by party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat      

--truncate table Ebrok_mis1_hist
--insert into Ebrok_mis1_hist select *  from Ebrok_mis1

delete from Ebrok_mis1 where sauda_date>=@fdate and sauda_date<=@tdate          

insert into  Ebrok_mis1  
select a.*,bse_stat=isnull(bse_stat,' '),nse_stat=isnull(nse_stat,' '),          
fo_stat=isnull(fo_stat,' '),mcdx_stat=isnull(mcdx_stat,' '),ncdx_stat=isnull(ncdx_stat,' ')          
--into Ebrok_mis1  
from #filex a left outer join #pty_stat b   
on a.party_Code=b.party_Code collate Latin1_General_CI_AS       



SELECT BRANCH_CD,SUB_BROKER,PARTY_CODE,bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),
ncdex_br=sum(ncdex_br),TOTAL_SEG=sum(BSE_BR+NSE_BR+FO_BR+MCX_BR+NCDEX_BR),  
E_BSE=(CASE WHEN BSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EBSE_BR))>0 THEN sum(EBSE_BR) ELSE 0 END ) ELSE -1 END ),
E_NSE=(CASE WHEN NSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENSE_BR))>0 THEN sum(ENSE_BR) ELSE 0 END ) ELSE -1 END ),  
E_FO=(CASE WHEN FO_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EFO_BR))>0 THEN sum(EFO_BR) ELSE 0 END ) ELSE -1 END ),  
E_MCX=(CASE WHEN MCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EMCX_Br))>0 THEN sum(EMCX_Br) ELSE 0 END ) ELSE -1 END ),  
E_NCDX=(CASE WHEN NCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENCDEX_Br))>0 THEN sum(ENCDEX_Br) ELSE 0 END ) ELSE -1 END ),
ebrok_br=SUM(ebrok_br)  
from ebrok_mis1   
where sauda_date>=@fdate and sauda_date<=@tdate 
--AND PARTY_CODE='A7394'
GROUP BY BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_STAT
,NSE_STAT,FO_STAT,MCDX_STAT,NCDX_STAT
order by SUB_BROKER

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_Clientwisetemp1
-- --------------------------------------------------
CREATE procedure MIS_Clientwisetemp1(@fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10),@sbcode as varchar(10))          
as          
          
set nocount on          
set transaction isolation level read uncommitted          
          

select           
party_code, sauda_date  ,       
BSE_TO=sum(case when company='ABLCM' then turnover else 0 end),          
NSE_TO=sum(case when company='ACDLCM' then turnover else 0 end),          
FO_TO=sum(case when company='ACDLFO' then turnover else 0 end),          
MCX_TO=sum(case when company='ACPLMCX' then turnover else 0 end),          
NCDEX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),          
EBROK_TO=sum(case when userid is not null then turnover else 0 end),          
BSE_BR=sum(case when company='ABLCM' then brokerage else 0 end),          
NSE_Br=sum(case when company='ACDLCM' then brokerage else 0 end),          
FO_Br=sum(case when company='ACDLFO' then brokerage else 0 end),          
MCX_Br=sum(case when company='ACPLMCX' then brokerage else 0 end),          
NCDEX_Br=sum(case when company='ACPLNCDEX' then brokerage else 0 end),          
EBROK_BR=sum(case when userid is not null then brokerage else 0 end),       
eBSE_BR=sum(case when company='ABLCM' and  userid is not null then brokerage else 0 end),          
eNSE_Br=sum(case when company='ACDLCM' and  userid is not null then brokerage else 0 end),          
eFO_Br=sum(case when company='ACDLFO' and  userid is not null then brokerage else 0 end),          
eMCX_Br=sum(case when company='ACPLMCX' and  userid is not null then brokerage else 0 end),          
eNCDEX_Br=sum(case when company='ACPLNCDEX' and  userid is not null then brokerage else 0 end)          
into #filed          
from mis_to a left outer join ebroking b on a.terminal_id collate Latin1_General_CI_AS = b.userid          
where sauda_date>=@fdate and sauda_date<=@tdate          
and branch_cd like @brcode and sub_Broker like @sbcode          
group by party_code,terminal_id,userid,sauda_date      


select sauda_date,branch_cd=sbtag,sub_broker=subgroup,a.party_code,party_name,          
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),          
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br),
ebse_br=sum(ebse_br),ense_br=sum(ense_br),efo_br=sum(efo_br),emcx_br=sum(emcx_br),encdex_br=sum(encdex_br)          
into #filex          
from #filed a left outer join risk.dbo.finmast b on a.party_code=b.party_Code collate Latin1_General_CI_AS          
group by sauda_date,sbtag,subgroup,a.party_code,party_name order by sbtag,subgroup,a.party_code          
     
select distinct * into #TA from
(
select party_code=[user id],TA=[trading allowed] from ver7
union
select party_code=[user id],TA=[markets allowed] from ver6
) a


select party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat      
into #pty_stat1
from          
(          

--select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse          
--from #filex,ver7 where  [trading allowed]=0          

select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #ta where ta=0          
union
select party_code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #nse          
from #ta where ta=1 
union 
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #fo          
from #ta where  ta=2          
union 
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #ta where  ta=3          
union           
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx          
from #ta where  ta=8          
union 
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx          
from #ta where  ta=9          
union 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #ta where  ta=10          
union 
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse          
from #ta where  ta=11          
union 
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #mcdx          
from #ta where  ta=16          
union 
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #ta where  ta=17          
union 
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #ta where  ta=18          
union 
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #ta where  ta=19          
union 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #ta where  ta=24          
union 
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #ta where  ta=25          
union 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx          
from #ta where  ta=26          
union 
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse          
from #ta where  ta=27          
union 
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #ta where  ta=64          
union 
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #nse          
from #ta where  ta=65          
union 
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #nse          
from #ta where  ta=66          
union 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #ta where  ta=72          
union 
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #ncdx          
from #ta where  ta=73          
union 
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #bse          
from #ta where  ta=75          
union 
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #ta where  ta=80          
union 
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #fo          
from #ta where  ta=81          
union 
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #ta where  ta=82          
union 
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #ta where  ta=83          
union 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #ta where  ta=88          
/* 0.0,27.0,10.0,75.0,89.0,64.0,25.0,9.0,16.0,8.0,73.0,2.0,90.0,1.0,19.0,82.0,26.0,24.0,88.0,91.0,80.0,3.0,11.0,83.0 -- ver6 */          
/* 75,83,91,66,82,90,65,19,27,73,81,11,89,3,72,18,80,26,10,88,2,17,25,9,64,1,24,16,8 -- ver7*/          
union 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #ta where  ta=89            
union 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx          
from #ta where  ta=90          
union 
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse          
from #ta where  ta=91          
) a          
 group by party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat      


select partY_code,bse_stat=max(bse_stat),
nse_stat=max(nse_stat),fo_stat=max(fo_stat),mcdx_stat=max(mcdx_stat),ncdx_stat=max(ncdx_stat)
into #pty_stat
from #pty_stat1 group by party_code

delete from Ebrok_mis1 where sauda_date>=@fdate and sauda_date<=@tdate          

insert into  Ebrok_mis1  
select a.*,bse_stat=isnull(bse_stat,' '),nse_stat=isnull(nse_stat,' '),          
fo_stat=isnull(fo_stat,' '),mcdx_stat=isnull(mcdx_stat,' '),ncdx_stat=isnull(ncdx_stat,' ')          
--into Ebrok_mis1  
from #filex a left outer join #pty_stat b   
on a.party_Code=b.party_Code collate Latin1_General_CI_AS       
where a.party_code in (select party_code from #pty_stat)

select distinct * from #pty_stat
select * from #pty_stat where party_code not in (select party_code collate Latin1_General_CI_AS  from risk.dbo.finmast)


select b.sbtag,b.subgroup,b.party_name,a.* 
from #pty_stat a, risk.dbo.finmast b where a.party_code=b.party_Code collate Latin1_General_CI_AS 
and a.party_code not in
(select distinct party_code from Ebrok_mis1 where sauda_Date >='Apr  1 2006' and sauda_Date <='Apr 30 2006')


--select distinct * from Ebrok_mis1  
--where sauda_date>='apr  1 2006' and sauda_date<='apr 30 2006' and party_code='A2401'


SELECT BRANCH_CD,SUB_BROKER,PARTY_CODE,bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),
ncdex_br=sum(ncdex_br),TOTAL_SEG=sum(BSE_BR+NSE_BR+FO_BR+MCX_BR+NCDEX_BR),  
E_BSE=(CASE WHEN BSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EBSE_BR))>0 THEN sum(EBSE_BR) ELSE 0 END ) ELSE -1 END ),
E_NSE=(CASE WHEN NSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENSE_BR))>0 THEN sum(ENSE_BR) ELSE 0 END ) ELSE -1 END ),  
E_FO=(CASE WHEN FO_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EFO_BR))>0 THEN sum(EFO_BR) ELSE 0 END ) ELSE -1 END ),  
E_MCX=(CASE WHEN MCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EMCX_Br))>0 THEN sum(EMCX_Br) ELSE 0 END ) ELSE -1 END ),  
E_NCDX=(CASE WHEN NCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENCDEX_Br))>0 THEN sum(ENCDEX_Br) ELSE 0 END ) ELSE -1 END ),
ebrok_br=SUM(ebrok_br)  
from ebrok_mis1   
--where sauda_date>='apr  1 2006' and sauda_date<='apr 30 2006'
where sauda_date>=@fdate and sauda_date<=@tdate 
and party_code in (select distinct party_code from Ebrok_mis1 )
--AND PARTY_CODE='A7394'
GROUP BY BRANCH_CD,SUB_BROKER,PARTY_CODE,BSE_STAT
,NSE_STAT,FO_STAT,MCDX_STAT,NCDX_STAT
order by SUB_BROKER

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_clstatus
-- --------------------------------------------------
CREATE procedure mis_clstatus(@fdate as varchar(25),@tdate as varchar(25))                
as                
                
set nocount on                
set transaction isolation level read uncommitted                
              
--  drop table #filed    
select                 
party_code, sauda_date  ,             
BSE_TO=sum(case when company='ABLCM' then turnover else 0 end),                
NSE_TO=sum(case when company='ACDLCM' then turnover else 0 end),                
FO_TO=sum(case when company='ACDLFO' then turnover else 0 end),                
MCX_TO=sum(case when company='ACPLMCX' then turnover else 0 end),                
NCDEX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),                
EBROK_TO=sum(case when userid is not null then turnover else 0 end),                
BSE_BR=sum(case when company='ABLCM' then brokerage else 0 end),                
NSE_Br=sum(case when company='ACDLCM' then brokerage else 0 end),                
FO_Br=sum(case when company='ACDLFO' then brokerage else 0 end),                
MCX_Br=sum(case when company='ACPLMCX' then brokerage else 0 end),                
NCDEX_Br=sum(case when company='ACPLNCDEX' then brokerage else 0 end),                
EBROK_BR=sum(case when userid is not null then brokerage else 0 end),             
eBSE_BR=sum(case when company='ABLCM' and  userid is not null then brokerage else 0 end),                
eNSE_Br=sum(case when company='ACDLCM' and  userid is not null then brokerage else 0 end),                
eFO_Br=sum(case when company='ACDLFO' and  userid is not null then brokerage else 0 end),                
eMCX_Br=sum(case when company='ACPLMCX' and  userid is not null then brokerage else 0 end),                
eNCDEX_Br=sum(case when company='ACPLNCDEX' and  userid is not null then brokerage else 0 end)                
into #filed                
from mis_to a left outer join ebroking b on a.terminal_id collate Latin1_General_CI_AS = b.userid                
where sauda_date>=@fdate+' 00:00:00' and sauda_date<=@tdate+' 23:59:59'              
--where sauda_Date >='jul 1 2006' and sauda_Date <='jul 31 2006'    
--where sauda_Date >='jun 1 2006' and sauda_Date <='jun 30 2006'    
--and branch_cd like @brcode and sub_Broker like @sbcode              
--and branch_cd like '%' and sub_Broker like '%'               
group by party_code,terminal_id,userid,sauda_date            
    
    
    
--  drop table #filex    
select sauda_date,branch_cd=sbtag,sub_broker=subgroup,a.party_code,party_name,                
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),                
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br),      
ebse_br=sum(ebse_br),ense_br=sum(ense_br),efo_br=sum(efo_br),emcx_br=sum(emcx_br),encdex_br=sum(encdex_br)                
into #filex                
from #filed a left outer join risk.dbo.finmast b on a.party_code=b.party_Code collate Latin1_General_CI_AS                
group by sauda_date,sbtag,subgroup,a.party_code,party_name order by sbtag,subgroup,a.party_code                
    
--  drop table #ta           
--select party_code=userid,TA=marketsallowed from mis.dbo.version6 where status='A'     
--select * from mis.dbo.version7 where status='A'     
    
select distinct * into #TA from      
(      
--select party_code=[user id],TA=[trading allowed] from ver7_01082006 where status='A'     
select party_code=userid,TA=tradingallowed from mis.dbo.version7 where status='A'     
union      
---select party_code=[user id],TA=[markets allowed] from ver6_01082006 where status='A'     
select party_code=userid,TA=marketsallowed from mis.dbo.version6 where status='A'     
) a      
      
--  drop table #pty_stat1      
    
select party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat            
into #pty_stat1      
from                
(                
      
--select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse                
--from #filex,ver7 where  [trading allowed]=0                
      
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #bse                
from #ta where ta=0                
union      
select party_code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #nse                
from #ta where ta=1       
union       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #fo                
from #ta where  ta=2                
union       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse                
from #ta where  ta=3                
union                 
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx                
from #ta where  ta=8                
union       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='-' --into #ncdx                
from #ta where  ta=9                
union       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse                
from #ta where  ta=10                
union       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='-' --into #bse                
from #ta where  ta=11                
union       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #mcdx                
from #ta where  ta=16                
union       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse                
from #ta where  ta=17                
union       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse                
from #ta where  ta=18                
union       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #ncdx                
from #ta where  ta=19                
union       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx                
from #ta where  ta=24                
union       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #bse                
from #ta where  ta=25                
union       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='-' --into #ncdx                
from #ta where  ta=26                
union       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='-' --into #bse                
from #ta where  ta=27                
union       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse                
from #ta where  ta=64                
union       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #nse                
from #ta where  ta=65                
union       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #nse                
from #ta where  ta=66                
union       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #bse                
from #ta where  ta=72                
union       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='-',mcdx_stat='-',ncdx_stat='Y' --into #ncdx                
from #ta where  ta=73                
union       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='-',ncdx_stat='Y' --into #bse                
from #ta where  ta=75                
union       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse                
from #ta where  ta=80                
union       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #fo                
from #ta where  ta=81                
union       
select party_Code,bse_stat='-',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx                
from #ta where  ta=82                
union       
select party_Code,bse_stat='-',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse                
from #ta where  ta=83                
union       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx                
from #ta where  ta=88                
/* 0.0,27.0,10.0,75.0,89.0,64.0,25.0,9.0,16.0,8.0,73.0,2.0,90.0,1.0,19.0,82.0,26.0,24.0,88.0,91.0,80.0,3.0,11.0,83.0 -- ver6 */                
/* 75,83,91,66,82,90,65,19,27,73,81,11,89,3,72,18,80,26,10,88,2,17,25,9,64,1,24,16,8 -- ver7*/                
union       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='-',mcdx_stat='Y',ncdx_stat='Y' --into #bse                
from #ta where  ta=89                  
union       
select party_Code,bse_stat='Y',nse_stat='-',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #ncdx                
from #ta where  ta=90                
union       
select party_Code,bse_stat='Y',nse_stat='Y',fo_stat='Y',mcdx_stat='Y',ncdx_stat='Y' --into #bse                
from #ta where  ta=91                
) a                
 group by party_Code,bse_stat,nse_stat,fo_stat,mcdx_stat,ncdx_stat            
      
select partY_code,bse_stat=max(bse_stat),      
nse_stat=max(nse_stat),fo_stat=max(fo_stat),mcdx_stat=max(mcdx_stat),ncdx_stat=max(ncdx_stat)      
into #pty_stat      
from #pty_stat1 group by party_code      
  
truncate table  ebrok_client_access
insert into  ebrok_client_access select * from #pty_stat
    
delete from Ebrok_mis1 where sauda_date>=@fdate and sauda_date<=@tdate                
--delete from Ebrok_mis1 where sauda_Date >='jul 1 2006' and sauda_Date <='jul 31 2006'    
    
insert into  Ebrok_mis1        
select a.*,bse_stat=isnull(bse_stat,' '),nse_stat=isnull(nse_stat,' '),                
fo_stat=isnull(fo_stat,' '),mcdx_stat=isnull(mcdx_stat,' '),ncdx_stat=isnull(ncdx_stat,' ')                
from #filex a left outer join #pty_stat b         
on a.party_Code =b.party_Code collate Latin1_General_CI_AS             
where a.party_code in (select party_code collate Latin1_General_CI_AS  from #pty_stat)      
  
SELECT a.BRANCH_CD,a.SUB_BROKER,a.PARTY_CODE,bse_br=sum(bse_br),    
E_BSE=(CASE WHEN BSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EBSE_BR))>0 THEN sum(EBSE_BR) ELSE 0 END ) ELSE -1 END ),    
nse_br=sum(nse_br),    
E_NSE=(CASE WHEN NSE_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENSE_BR))>0 THEN sum(ENSE_BR) ELSE 0 END ) ELSE -1 END ),      
fo_br=sum(fo_br),    
E_FO=(CASE WHEN FO_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EFO_BR))>0 THEN sum(EFO_BR) ELSE 0 END ) ELSE -1 END ),      
mcx_br=sum(mcx_br),    
E_MCX=(CASE WHEN MCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(EMCX_Br))>0 THEN sum(EMCX_Br) ELSE 0 END ) ELSE -1 END ),      
ncdex_br=sum(ncdex_br),    
E_NCDX=(CASE WHEN NCDX_STAT='Y' THEN (CASE WHEN CONVERT(MONEY,sum(ENCDEX_Br))>0 THEN sum(ENCDEX_Br) ELSE 0 END ) ELSE -1 END ),    
TOTAL_SEG=sum(BSE_BR+NSE_BR+FO_BR+MCX_BR+NCDEX_BR),      
ebrok_br=SUM(ebrok_br)  ,    
BSE_STAT,NSE_STAT,FO_STAT,MCDX_STAT,NCDX_STAT,nooflogin=count(nooflogin)    
from Ebrok_mis1 a left outer join MIS_ebroking_cli b   
on a.party_code=b.party_code  
--where a.sauda_Date >='jul 1 2006 00:00:00' and a.sauda_Date <='jul 31 2006 23:59:59'    
where a.sauda_date>=@fdate+' 00:00:00' and a.sauda_date<=@tdate+' 23:59:59'              
--AND PARTY_CODE='A7394'    
GROUP BY a.BRANCH_CD,a.SUB_BROKER,a.PARTY_CODE,BSE_STAT,NSE_STAT,FO_STAT,MCDX_STAT,NCDX_STAT    
order by a.SUB_BROKER      
    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_ebrok_cli
-- --------------------------------------------------
CREATE procedure mis_ebrok_cli (@fdate as varchar(11),@tdate as varchar(11),@brcode as varchar(10),@sbcode as varchar(10),@cli_stat as varchar(25))              
as              
set nocount on              
          
                 
/*select branch_cd,sub_Broker,party_code,              
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                    
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                    
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),              
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),          
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)               
into #file1              
from MIS_ebroking_cli               
where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat               
and branch_Cd like @brcode and sub_Broker like @sbcode              
group by party_Code,branch_cd,sub_Broker,party_code              
*/        
set transaction isolation level read uncommitted              
select distinct party_Code,odin_server into #server from ctcl.dbo.client_mast79 (nolock)  
  
select * into #mis_cli from MIS_ebroking_cli (nolock)
where sauda_DAte>=@fdate and sauda_DAte <=@tdate 
and user_Stat like @cli_stat               
and branch_Cd like @brcode and sub_Broker like @sbcode              

set transaction isolation level read uncommitted              
select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server,        
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                  
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                  
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),            
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),        
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)           
into #file1            
from #mis_cli a left outer join #server b           
on a.party_code=b.party_code collate Latin1_General_CI_AS          
where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat               
and branch_Cd like @brcode and sub_Broker like @sbcode              
group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server    
  
set transaction isolation level read uncommitted              
select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),            
mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-')            
into #file1a            
from #file1 a left outer join ebrok_client_access b (nolock) on a.party_code=b.party_Code            
            
set transaction isolation level read uncommitted              
select a.*,party_name from #file1a a left outer join intranet.risk.dbo.finmast b               
on a.party_Code=b.party_code collate Latin1_General_CI_AS                  
order by a.party_code  
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_ebrok_cli1
-- --------------------------------------------------
CREATE procedure mis_ebrok_cli1(@fdate as varchar(11),@tdate as varchar(11),@brcode as varchar(10),@sbcode as varchar(10),@cli_stat as varchar(25),@flag as varchar(8))                            
as                            
set transaction isolation level read uncommitted                            
set nocount on                            
                        
                               
/*select branch_cd,sub_Broker,party_code,                            
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                  
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                  
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                            
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                        
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                             
into #file1                            
from MIS_ebroking_cli                             
where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
and branch_Cd like @brcode and sub_Broker like @sbcode                            
group by party_Code,branch_cd,sub_Broker,party_code                            
*/                      
                      
/*select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server,                      
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
into #file1                          
from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
on a.party_code=b.party_code collate Latin1_General_CI_AS                        
where sauda_DAte>=@fdate and sauda_DAte <=@tdate and a.user_Stat like @cli_stat                             
and branch_Cd like @brcode and sub_Broker like @sbcode                            
group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                  
*/                
                
/**              
select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server,                      
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
into #file1                          
from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
on a.party_code=b.party_code collate Latin1_General_CI_AS                
where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
and branch_Cd like @brcode and sub_Broker like @sbcode                
                        
--where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
--and branch_Cd like @brcode and sub_Broker like @sbcode                    
--where sauda_date>='nov 1 2006 00:00:00' and sauda_date<='dec 31 006 23:59:59' and                 
--user_Stat like 'e-broking'                                   
--and branch_cd='xpu' and sub_broker='xpu'                 
group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                 
**/        
              
          
select distinct brcode=space(10),sbcode=space(10),party_Code,odin_server,flag           
into #cli79           
from ctcl.dbo.client_mast79           
          
update #cli79 set brcode=b.branch_Cd,sbcode=b.sub_Broker from risk.dbo.client_details b          
where #cli79.party_code=b.party_Code           
  
if @flag='%'  
begin          
 select * into #file1              
 from               
 (        
 /*          
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin7.8',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 --from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
 from   ctcl.dbo.client_mast79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='odin7'                       
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin7'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 */    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S1',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 --from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
 from   ctcl.dbo.client_mast79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S1'                       
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin7'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server       
 union all        
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S2',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 --from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
 from   ctcl.dbo.client_mast79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                       
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin7'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server       
 union all                    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s1',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  #cli79 b left outer join MIS_ebroking_cli a (nolock)             
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='odin79'              
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin79'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 union all              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s2',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  #cli79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode and odin_server='odin79s2'                
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin79s2'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 union all              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s3',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  #cli79 b left outer join MIS_ebroking_cli a (nolock)                      
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode and odin_server='odin79s3'                
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin79s2'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 union all              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='Anywhere',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  mis.testdb.dbo.tradeanywhere_master b left outer join  MIS_ebroking_cli a (nolock)               
 on a.party_code=b.client_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode                
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'                
 --and odin_server='tradeanywhere'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker              
 )a                            
 select a.*,c.offline_brok into #file2 from #file1 a                
 left outer join                 
 (                
 select party_code,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok'                
 from ebrok_tobr_period (nolock)                 
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate                 
 --and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode                            
 group by party_code                
 ) c                   
 on a.party_code=c.party_code collate Latin1_General_CI_AS                
                             
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                          
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-')                          
 into #file1a                          
 from #file2 a left outer join ebrok_client_access b (nolock) on a.party_code=b.party_Code                          
                           
 select a.*,party_name from #file1a a left outer join intranet.risk.dbo.finmast b                             
 on a.party_Code=b.party_code collate Latin1_General_CI_AS  
end  
if @flag<>'%'  
begin                                
  select * into #filea1              
 from               
 (        
 /*          
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin7.8',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 --from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
 from   ctcl.dbo.client_mast79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='odin7'                       
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin7'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 */    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S1',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 --from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
 from   ctcl.dbo.client_mast79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S1'                       
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin7'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server       
 union all        
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S2',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 --from MIS_ebroking_cli a left outer join ctcl.dbo.client_mast b                         
 from   ctcl.dbo.client_mast79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S2'                       
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin7'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server       
 union all                    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s1',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  #cli79 b left outer join MIS_ebroking_cli a (nolock)             
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='odin79'              
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin79'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 union all              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s2',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  #cli79 b left outer join MIS_ebroking_cli a (nolock)                       
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='odin79s2'                
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin79s2'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 union all              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s3',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  #cli79 b left outer join MIS_ebroking_cli a (nolock)                      
 on a.party_code=b.party_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='odin79s3'                
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'  and odin_server='odin79s2'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
 union all              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='Anywhere',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                          
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                      
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                         
 from  mis.testdb.dbo.tradeanywhere_master b left outer join  MIS_ebroking_cli a (nolock)               
 on a.party_code=b.client_code collate Latin1_General_CI_AS                
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                             
 and branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG)                 
 --where sauda_date>='jan 1 2007 00:00:00' and sauda_date<='feb 15 2007 23:59:59' and                 
 --user_Stat like 'e-broking'                
 --and odin_server='tradeanywhere'                            
 --and branch_cd like '%' and sub_broker like '%'              
 group by a.party_Code,a.branch_cd,a.sub_Broker              
 )a                            
 select a.*,c.offline_brok into #filea2 from #filea1 a                
 left outer join                 
 (                
 select party_code,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok'                
 from ebrok_tobr_period (nolock)                 
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate                 
 --and user_Stat like @cli_stat                             
 and branch_Cd like @brcode and sub_Broker like @sbcode                            
 group by party_code                
 ) c                   
 on a.party_code=c.party_code collate Latin1_General_CI_AS                
                             
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                          
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-')                          
 into #filea1a                          
 from #filea2 a left outer join ebrok_client_access b (nolock) on a.party_code=b.party_Code                          
                           
 select a.*,party_name from #filea1a a left outer join intranet.risk.dbo.finmast b                             
 on a.party_Code=b.party_code collate Latin1_General_CI_AS  
end                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_ebrok_cli2
-- --------------------------------------------------
CREATE procedure mis_ebrok_cli2(@fdate as varchar(11),@tdate as varchar(11),@brcode as varchar(10),@sbcode as varchar(10),@cli_stat as varchar(25),@flag as varchar(8))                                                              
as                                                              
set transaction isolation level read uncommitted                                                              
set nocount on                                   
select distinct brcode=space(10),sbcode=space(10),party_Code,odin_server,flag                                             
into #cli79                                             
--from ctcl.dbo.client_mast79                                             
from ctcl.dbo.client_mast79   
                                            
update #cli79 set brcode=b.branch_Cd,sbcode=b.sub_Broker from risk.dbo.client_details b                                            
where #cli79.party_code=b.party_Code                                 
                            
select * into #mis from MIS_ebroking_cli  where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
and branch_Cd like @brcode                                 
                                                           
if @flag='%'                                 
 begin                         
                        
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='Anywhere',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                             
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                 
 into #odinanywhere                                                          
 from  mis.testdb.dbo.tradeanywhere_master b left outer join  #mis a                                   
 on a.party_code=b.client_code collate Latin1_General_CI_AS                                                  
 --where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                                
 group by a.party_Code,a.branch_cd,a.sub_Broker               
        
  select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S8',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s8                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                            
 odin_server='ODIN710S8'                                                         
 and a.party_code not in (select party_Code from #odinanywhere where isnull(party_code,'')<>'')                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server           
         
 select * into #odin10s8_any                                 
 from                                
 (                               
 select party_Code from #odin10s8 union select party_Code from #odinanywhere                                       
 ) a               
         
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S7',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s7                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                            
 odin_server='ODIN710S7'                                                         
 and a.party_code not in (select party_Code from #odinanywhere where isnull(party_code,'')<>'')                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server              
              
 select * into #odin10s7_any                                 
 from                                
 (                               
 select party_Code from #odin10s7 union select party_Code from #odin10s8_any                                       
 ) a              
              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S6',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s6                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                            
 odin_server='ODIN710S6'                                                         
 and a.party_code not in (select party_Code from #odin10s7_any where isnull(party_code,'')<>'')                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server         
              
 select * into #odin10s6_any                                 
 from                                
 (                                
 select party_Code from #odin10s6 union select party_Code from #odin10s7_any                                       
 ) a                 
                 
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S5',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s5                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                            
 odin_server='ODIN710S5'                                                         
 and a.party_code not in (select party_Code from #odin10s6_any where isnull(party_code,'')<>'')                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                
                
 select * into #odin10s5_any                                 
 from                                
 (                                
 select party_Code from #odin10s5 union select party_Code from #odin10s6_any                                       
 ) a                 
                    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S4',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s4                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                            
 odin_server='ODIN710S4'                                                         
 and a.party_code not in (select party_Code from #odin10s5_any where isnull(party_code,'')<>'')                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                 
                    
 select * into #odin10s4_any              
 from                                
 (                                
 select party_Code from #odin10s4 union select party_Code from #odin10s5_any                                       
 ) a                      
                           
                    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S3',                      
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                        mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                      
  
    
      
                      
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s3                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                            
 odin_server='ODIN710S3'                                                         
 and a.party_code not in (select party_Code from #odin10s4_any where isnull(party_code,'')<>'')                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                              
                        
 select * into #odin10s3_any                                 
 from                                
 (                                
 select party_Code from #odin10s3 union select party_Code from #odin10s4_any                                       
 ) a                      
                             
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S2',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                   
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s2                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                  
 --and branch_Cd like @brcode and sub_Broker like @sbcode                            
 odin_server='ODIN710S2'                                                         
 and a.party_code not in (select party_Code from #odin10s3_any where isnull(party_code,'')<>'')                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                         
                          
 select * into #odin10s2_any                                 
 from                                
 (                                
 select party_Code from #odin10s2 union select party_Code from #odin10s3_any                         
 ) a                            
                               
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S1',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                            into #odin10s1                                                  
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and                            
 odin_server='ODIN710S1'                                                         
 and a.party_code not in (select party_Code from #odin10s2_any where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                         
                                 
 select * into #10s1_10s2                                 
 from                                
 (                                
 select party_Code from #odin10s2 union select party_Code from #odin10s2_any                                       
 ) a                                
                                
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s3',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                
 into #odin79s3                                                   
 from  #cli79 b left outer join #mis a                                    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                      
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode and                            
 odin_server='odin79s3'                                
 and a.party_code not in (select party_Code from #10s1_10s2 where isnull(party_code,'')<>'')                                                 
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                 
                                
 select * into #10s1_10s2_79s3                                 
 from                     
 (                                
 select party_Code from #10s1_10s2 union select party_Code from #odin79s3                         
 )b                                
                                
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s2',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                 
 into #odin79s2                                                         
 from  #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
--- and branch_Cd like @brcode and sub_Broker like @sbcode and                            
 odin_server='odin79s2'                                 
 and a.party_code not in (select party_Code from #10s1_10s2_79s3 where isnull(party_code,'')<>'')                             
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                   
                                
 select * into #10s1_10s2_79s3_s2                                 
 from                                
 (                                
 select party_Code from #10s1_10s2_79s3 union select party_Code from #odin79s2                                       
 )c                                                    
                                              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s1',                       
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                
 into #odin79s1                                                            
 from  #cli79 b left outer join #mis a                                               
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and                            
 odin_server='odin79'                                                            
 and a.party_code not in (select party_Code from #10s1_10s2_79s3_s2 where isnull(party_code,'')<>'')                                
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                                
                                 
                                      
                                
                                 
 select * into #file1                                
 from                                 
 (          
 select * from #odin10s8                  
 union all                
 select * from #odin10s7                  
 union all                  
 select * from #odin10s6                  
 union all               
 select * from #odin10s5                  
 union all                  
 select * from #odin10s4                  
 union all                     
 select * from #odin10s3        
 union all                                              
 select * from #odin10s2                                
 union all                                
 select * from #odin10s1                                
 union all                                
 select * from #odin79s3                                 
 union all                                
 select * from #odin79s2                                 
 union all                                
 select * from #odin79s1                                 
 union all                                
 select * from #odinanywhere                               
 )a                                
                                
insert into #file1    
select distinct branch_cd,sub_Broker,party_code, odin_server='UnKnown',                       
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)        
 from #mis where isnull(party_code,'') not in    
(    
select distinct isnull(party_code,'') from #file1                                
)    
group by party_Code,branch_cd,sub_Broker    
                                                            
 select a.*,c.offline_brok into #file2 from #file1 a                                                  
 left outer join                                                   
 (                                                  
 select party_code,sub_broker,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok'                                                  
 from ebrok_tobr_period (nolock)                                                   
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate                                  
 --and user_Stat like @cli_stat                                                               
 and branch_Cd like @brcode and sub_Broker like @sbcode                                                              
 group by party_code,sub_broker                                                  
 ) c                                                     
 on a.party_code=c.party_code collate Latin1_General_CI_AS  and a.sub_broker=c.sub_broker                                                  
                                                               
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                                                            
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-')                                                            
 into #file1a                                                            
 from #file2 a left outer join ebrok_client_access b (nolock) on a.party_code=b.party_Code                                                            
                                                             
 select a.*,party_name from #file1a a left outer join intranet.risk.dbo.finmast b                                                               
 on a.party_Code=b.party_code collate Latin1_General_CI_AS where isnull(a.party_code,'')<>''
order by a.branch_cd,a.sub_broker,a.party_code                                  
                                  
end                                
                                    
if @flag<>'%'                                    
begin                                
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='Anywhere',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                   
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                 
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                 
 into #odinanywherea                                                          
 from  mis.testdb.dbo.tradeanywhere_master b left outer join  #mis a                                   
 on a.party_code=b.client_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                                
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG)                                                   
 group by a.party_Code,a.branch_cd,a.sub_Broker          
        
               
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S8',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                         
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s8a                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                 
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                                                                  
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S8'                                                         
 and a.party_code not in (select party_Code from #odinanywherea where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                 
               
               
 select * into #odin10s8a_any                                 
 from                                
 (                                
 select party_Code from #odin10s8a union select party_Code from #odinanywherea                                       
 ) a                
              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S7',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                         
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s7a                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                                                                  
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S7'                                                         
 and a.party_code not in (select party_Code from #odinanywherea where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                 
               
               
 select * into #odin10s7a_any                                 
 from                                
 (                                
 select party_Code from #odin10s7a union select party_Code from #odin10s8a_any                                       
 ) a               
              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S6',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                         
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s6a                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                                                                  
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S6'                                                         
 and a.party_code not in (select party_Code from #odinanywherea where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                 
                
 select * into #odin10s6a_any                                 
 from                                
 (                                
 select party_Code from #odin10s6a union select party_Code from #odin10s7a_any                                       
 ) a                  
                 
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S5',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                         
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),               
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s5a                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                                                                  
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S5'                                                         
 and a.party_code not in (select party_Code from #odin10s6a_any where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                 
                
 select * into #odin10s5a_any                                 
 from                                
 (                                
 select party_Code from #odin10s5a union select party_Code from #odin10s6a_any                                       
 ) a                         
                     
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S4',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                   
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s4a                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                                                                  
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S4'                                                         
 and a.party_code not in (select party_Code from #odin10s5a_any where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                     
                 
 select * into #odin10s4a_any                                 
 from    
 (                                
 select party_Code from #odin10s4a union select party_Code from #odin10s5a_any                                       
 ) a                      
                        
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S3',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                      
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s3a                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                                                                  
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S3'                                           
 and a.party_code not in (select party_Code from #odin10s4a_any where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                       
                         
 select * into #odin10s3a_any                                 
 from                                
 (                                
 select party_Code from #odin10s3a union select party_Code from #odin10s3a                                       
 ) a                       
                                                         
  select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S2',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                         
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                             
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s2a                                                           
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
--and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S2'                                                                  
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S2'                                                         
 and a.party_code not in (select party_Code from #odin10s3a_any where isnull(party_code,'')<>'')                       
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                         
                         
select * into #odin10s2a_any                                 
 from                                
 (                                
 select party_Code from #odin10s2a union select party_Code from #odin10s3a_any                                       
 ) a                        
                                
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S1',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                           
 into #odin10s1a                                                  
 from   #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where --sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                               
-- and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='ODIN710S1'                                                         
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='ODIN710S1'                                                    
 and a.party_code not in (select party_Code from #odin10s2a_any where isnull(party_code,'')<>'')                                         
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                         
                                 
 select * into #10s1_10s2a                                 
 from                                
 (                                
 select party_Code from #odin10s2a_any union select party_Code from #odin10s1a                                       
 ) a                            
                                
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s3',                                   
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                
 into #odin79s3a                                                           
 from  #cli79 b left outer join #mis a                                    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode and odin_server='odin79s3'                                
branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='odin79s3'                                        
 and a.party_code not in (select party_Code from #10s1_10s2a where isnull(party_code,'')<>'')                                                        
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                 
                                
 select * into #10s1_10s2_79s3a                                 
 from                                
 (                                
 select party_Code from #10s1_10s2a union select party_Code from #odin79s3a                                       
 )b                                
                                
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s2',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                            
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                 
 into #odin79s2a                                   
 from  #cli79 b left outer join #mis a                                                         
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode and odin_server='odin79s2'                                 
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='odin79s2'                                                  
 and a.party_code not in (select party_Code from #10s1_10s2_79s3a where isnull(party_code,'')<>'')                      
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                   
                                
 select * into #10s1_10s2_79s3_s2a                                 
 from                                
 (                                
 select party_Code from #10s1_10s2_79s3a union select party_Code from #odin79s2a                                       
 )c                                                    
                                              
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s1',                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                  
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                               
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                
 into #odin79s1a                                                            
 from  #cli79 b left outer join #mis a                                               
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and odin_server='odin79'                                                     
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG) and odin_server='odin79'                                                
 and a.party_code not in (select party_Code from #10s1_10s2_79s3_s2a where isnull(party_code,'')<>'')                                    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                                
                                              
                                             
                                
                                 
 select * into #filea1                                
 from                                 
 (        
 select * from #odin10s8a                  
 union all         
 select * from #odin10s7a                  
 union all         
 select * from #odin10s6a                  
 union all                  
 select * from #odin10s5a                  
 union all                 
 select * from #odin10s4a                  
 union all                     
 select * from #odin10s3a                  
 union all                                              
 select * from #odin10s2a                                
 union all                                
 select * from #odin10s1a                                
 union all                                
 select * from #odin79s3a                                 
 union all                                
 select * from #odin79s2a                                 
 union all                                
 select * from #odin79s1a                                 
 union all                                
 select * from #odinanywherea                                
 )a                                
                                
                              
                              
 select a.*,c.offline_brok into #filea2 from #filea1 a                                                  
 left outer join                                                   
 (                                                  
 select party_code,sub_broker,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok'                              
 from ebrok_tobr_period (nolock)                                                   
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate                                                   
 --and user_Stat like @cli_stat                                                               
 and branch_Cd like @brcode and sub_Broker like @sbcode                                                              
 group by party_code,sub_broker                                                  
 ) c                                                     
 on a.party_code=c.party_code collate Latin1_General_CI_AS  and a.sub_broker=c.sub_broker                                                
                                                      
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                          
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-')                                                            
 into #filea1a                                                            
 from #filea2 a left outer join ebrok_client_access b (nolock) on a.party_code=b.party_Code                               
                                                             
 select a.*,party_name from #filea1a a left outer join intranet.risk.dbo.finmast b                                                               
 on a.party_Code=b.party_code collate Latin1_General_CI_AS where isnull(a.party_code,'')<>'' 
order by a.branch_cd,a.sub_broker,a.party_code                          
end                                                              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_Min_Brok
-- --------------------------------------------------
      
CREATE procedure MIS_Min_Brok(@segment as varchar(10),@noofdays as int,@startDate as varchar(11),@belowBrok as money)      
as      
      
/*      
EXEC MIS_Min_Brok 'ABLCM',90,'May  1 2012',100      
      
Segment Code      
------------      
ABLCM      
ACDLCM      
ACDLFO      
ACDLNSX      
ACPLMCD      
ACPLMCX      
ACPLNCDEX      
      
*/      

Insert into TBL_MIN_ARPC_TEMP      
select a.*,sum(b.brokerage)/COUNT(1) as ARPC
 from       
(      
SELECT party_code,sauda_date,company,sum(turnover) as turnover,sum(brokerage) as brokerage      
FROM MIS_TO WITH (NOLOCK) WHERE Company=@segment      
AND sauda_date >=@startDate and party_code not like '9%'      
/* and party_code in ('A031','A086')*/      
group by party_code,sauda_date,company having sum(brokerage) < @belowBrok  
) a,      
(select SAUDA_DATE,PARTY_CODE,BROKERAGE=SUM(BROKERAGE) from MIS_TO WITH (NOLOCK)      
where SAUDA_DATE >= convert(datetime,@startDate)-@noofdays and brokerage <> 0       
/*and party_code in ('A031','A086') */      
group by SAUDA_DATE,PARTY_CODE                 
) b where       
a.party_Code=b.party_Code and      
b.sauda_Date>=a.sauda_date-@noofdays and b.sauda_Date<=a.sauda_date      
group by a.party_code,a.sauda_date,a.company,a.turnover,a.brokerage

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_Monthwise
-- --------------------------------------------------
CREATE procedure MIS_Monthwise(@fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10),@sbcode as varchar(10))
as

set nocount on
set transaction isolation level read uncommitted



select 
mmonth=datepart(mm,sauda_date),myear=datepart(yyyy,sauda_date),
BSE_TO=sum(case when company='ABLCM' then turnover else 0 end),
NSE_TO=sum(case when company='ACDLCM' then turnover else 0 end),
FO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
MCX_TO=sum(case when company='ACPLMCX' then turnover else 0 end),
NCDEX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),
EBROK_TO=sum(case when userid is not null then turnover else 0 end),
BSE_BR=sum(case when company='ABLCM' then brokerage else 0 end),
NSE_Br=sum(case when company='ACDLCM' then brokerage else 0 end),
FO_Br=sum(case when company='ACDLFO' then brokerage else 0 end),
MCX_Br=sum(case when company='ACPLMCX' then brokerage else 0 end),
NCDEX_Br=sum(case when company='ACPLNCDEX' then brokerage else 0 end),
EBROK_BR=sum(case when userid is not null then brokerage else 0 end)
into #filea
from mis_to a left outer join ebroking b on a.terminal_id collate Latin1_General_CI_AS = b.userid
where  sauda_date>=@fdate and sauda_date<=@tdate
and branch_cd like @brcode and sub_Broker like @sbcode
group by datepart(mm,sauda_date),datepart(yyyy,sauda_date),terminal_id,userid


select mmonth,myear,
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br),
Total_TO=(sum(bse_to)+sum(nse_to)+sum(fo_to)+sum(mcx_to)+sum(ncdex_to)),
Total_BR=(sum(bse_br)+sum(nse_br)+sum(fo_br)+sum(mcx_br)+sum(ncdex_br))
from #filea 
group by mmonth,myear
order by mmonth,myear

set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_SBwise
-- --------------------------------------------------
create procedure MIS_SBwise(@fdate as varchar(25),@tdate as varchar(25),@brcode as varchar(10),@sbcode as varchar(10))
as

set nocount on
set transaction isolation level read uncommitted


select 
branch_cd,sub_broker,
BSE_TO=sum(case when company='ABLCM' then turnover else 0 end),
NSE_TO=sum(case when company='ACDLCM' then turnover else 0 end),
FO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
MCX_TO=sum(case when company='ACPLMCX' then turnover else 0 end),
NCDEX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),
EBROK_TO=sum(case when userid is not null then turnover else 0 end),
BSE_BR=sum(case when company='ABLCM' then brokerage else 0 end),
NSE_Br=sum(case when company='ACDLCM' then brokerage else 0 end),
FO_Br=sum(case when company='ACDLFO' then brokerage else 0 end),
MCX_Br=sum(case when company='ACPLMCX' then brokerage else 0 end),
NCDEX_Br=sum(case when company='ACPLNCDEX' then brokerage else 0 end),
EBROK_BR=sum(case when userid is not null then brokerage else 0 end)
into #filec
from mis_to a left outer join ebroking b on a.terminal_id collate Latin1_General_CI_AS = b.userid
where sauda_date>=@fdate and sauda_date<=@tdate
and branch_cd like @brcode and sub_Broker like @sbcode
group by branch_cd,sub_broker,terminal_id,userid



select branch_Cd,b.sub_broker,sbname,
bse_to=sum(bse_to),nse_to=sum(nse_to),fo_to=sum(fo_to),mcx_to=sum(mcx_to),ncdex_to=sum(ncdex_to),ebrok_to=sum(ebrok_to),
bse_br=sum(bse_br),nse_br=sum(nse_br),fo_br=sum(fo_br),mcx_br=sum(mcx_br),ncdex_br=sum(ncdex_br),ebrok_br=sum(ebrok_br)
from #filec a left outer join risk.dbo.subgroup b on a.sub_broker=b.sub_Broker
group by branch_Cd,b.sub_broker,sbname order by b.sub_broker

set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_TO_CLI
-- --------------------------------------------------
CREATE procedure mis_TO_CLI(@fromdate as varchar(11),@todate as varchar(11),@Sbcode as varchar(10))  
as  
  
set nocount on  

/*
declare @fromdate as varchar(11),@todate as varchar(11)  ,@sbcode as varchar(10)
set @fromdate ='10/18/2006'  
set @todate ='10/18/2006'  
set @sbcode ='RVCM'
*/


select  branch=branch_cd,subbrokcode=Sub_broker,segment=company,party_code,client_name=party_name,
turnover=sum(Turnover),TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt)
into #file1 from
(
select * from mis_to WITH (NOLOCK) where sauda_date >=@fromdate and sauda_date <=@todate and Sub_broker like @sbcode
) a
group by branch_cd,Sub_broker,company,party_code,party_name


set transaction isolation level read uncommitted  
select branch,subbrokcode,party_code,client_name,  
BSECM_Del=sum(case when segment='ABLCM' then TO_Del_Opt else 0 end),  
BSECM_Trd=sum(case when segment='ABLCM' then TO_Trd_Fut else 0 end),  
NSECM_Del=sum(case when segment='ACDLCM' then TO_Del_Opt else 0 end),  
NSECM_Trd=sum(case when segment='ACDLCM' then TO_Trd_Fut else 0 end),  
NSEFO_Fut=sum(case when segment='ACDLFO' then TO_Trd_Fut else 0 end),  
NSEFO_Opt=sum(case when segment='ACDLFO' then TO_Del_Opt else 0 end),  
MCDX_Fut=sum(case when segment='ACPLMCX' then TO_Trd_Fut else 0 end),  
--MCDX_Idx=sum(case when segment='ACPLMCX' then remi_share+sub_remi_share else 0 end),  
NCDX_Fut=sum(case when segment='ACPLNCDX' then TO_Trd_Fut else 0 end)  
--NCDX_Idx=sum(case when segment='ACPLNCDX' then remi_share+sub_remi_share else 0 end),  
--Total=sum(brok_earned),  
--Remi=sum(remi_share+sub_remi_share),  
--Angel=sum(brok_earned-(remi_share+sub_remi_share))  
into #file2
from #file1 (nolock) 
--sauda_Date >=@fromdate and sauda_date <=@todate  and 
--where brok_earned <> 0
group by branch,subbrokcode,segment,party_code,client_name


set transaction isolation level read uncommitted    
select branch,subbrokcode,party_code,client_name,BSECM_Del=sum(BSECM_Del),BSECM_Trd=sum(BSECM_Trd),  
NSECM_Del=sum(NSECM_Del),NSECM_Trd=sum(NSECM_Trd),  
NSEFO_Fut=sum(NSEFO_Fut),NSEFO_Opt=sum(NSEFO_Opt),  
MCDX_Fut=sum(MCDX_Fut),NCDX_Fut=sum(NCDX_Fut)
--ncdx_total=sum(ncdx_total),ncdx_remi=sum(ncdx_remi),  
--total=sum(total),remi=sum(remi),angel=sum(angel),  
--remi_percent=case when sum(remi) <> 0 then (sum(remi)*100)/sum(total) else 0 end  
from #file2 a (nolock) --left outer join intranet.risk.dbo.subgroup b  
--on a.subbrokcode=b.sub_broker
group by branch,subbrokcode,PARTY_CODE,CLIENT_NAME
order by PARTY_CODE
/*
set transaction isolation level read uncommitted    
select party_code='Total',BSECM_Del=sum(BSECM_Del),BSECM_Trd=sum(BSECM_Trd),  
NSECM_Del=sum(NSECM_Del),NSECM_Trd=sum(NSECM_Trd),  
NSEFO_Fut=sum(NSEFO_Fut),NSEFO_Opt=sum(NSEFO_Opt),  
MCDX_Fut=sum(MCDX_Fut),NCDX_Fut=sum(NCDX_Fut)
--ncdx_total=sum(ncdx_total),ncdx_remi=sum(ncdx_remi),  
--total=sum(total),remi=sum(remi),angel=sum(angel),  
--remi_percent=case when sum(remi) <> 0 then (sum(remi)*100)/sum(total) else 0 end  
from #file2 a (nolock) --left outer join intranet.risk.dbo.subgroup b  
*/

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_TO_CLI_backup
-- --------------------------------------------------

--EXEC mis_TO_CLI '20/09/2012','25/09/2012','%'


CREATE  procedure mis_TO_CLI_backup
(@fromdate as varchar(20),@todate as varchar(20),@Sbcode as varchar(10))  
as  
  
set nocount on  

/*
declare @fromdate as varchar(11),@todate as varchar(11)  ,@sbcode as varchar(10)
set @fromdate ='10/18/2006'  
set @todate ='10/18/2006'  
set @sbcode ='RVCM'
*/

SET @fromdate =CONVERT(datetime,@fromdate,103)
SET @todate = CONVERT(datetime,@todate,103)
select  branch=branch_cd,subbrokcode=Sub_broker,segment=company,party_code,client_name=party_name,
turnover=sum(Turnover),TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt)
into #file1 from
(
select * from mis_to WITH (NOLOCK) WHERE   sauda_date  >=@fromdate  AND sauda_date <=@todate and Sub_broker like @sbcode
) a
group by branch_cd,Sub_broker,company,party_code,party_name


set transaction isolation level read uncommitted  
select branch,subbrokcode,party_code,client_name,  
BSECM_Del=sum(case when segment='ABLCM' then TO_Del_Opt else 0 end),  
BSECM_Trd=sum(case when segment='ABLCM' then TO_Trd_Fut else 0 end),  
NSECM_Del=sum(case when segment='ACDLCM' then TO_Del_Opt else 0 end),  
NSECM_Trd=sum(case when segment='ACDLCM' then TO_Trd_Fut else 0 end),  
NSEFO_Fut=sum(case when segment='ACDLFO' then TO_Trd_Fut else 0 end),  
NSEFO_Opt=sum(case when segment='ACDLFO' then TO_Del_Opt else 0 end),  
MCDX_Fut=sum(case when segment='ACPLMCX' then TO_Trd_Fut else 0 end),  
--MCDX_Idx=sum(case when segment='ACPLMCX' then remi_share+sub_remi_share else 0 end),  
NCDX_Fut=sum(case when segment='ACPLNCDX' then TO_Trd_Fut else 0 end)  
--NCDX_Idx=sum(case when segment='ACPLNCDX' then remi_share+sub_remi_share else 0 end),  
--Total=sum(brok_earned),  
--Remi=sum(remi_share+sub_remi_share),  
--Angel=sum(brok_earned-(remi_share+sub_remi_share))  
into #file2
from #file1 (nolock) 
--sauda_Date >=@fromdate and sauda_date <=@todate  and 
--where brok_earned <> 0
group by branch,subbrokcode,segment,party_code,client_name


set transaction isolation level read uncommitted    
select branch,subbrokcode,party_code,client_name,BSECM_Del=sum(BSECM_Del),BSECM_Trd=sum(BSECM_Trd),  
NSECM_Del=sum(NSECM_Del),NSECM_Trd=sum(NSECM_Trd),  
NSEFO_Fut=sum(NSEFO_Fut),NSEFO_Opt=sum(NSEFO_Opt),  
MCDX_Fut=sum(MCDX_Fut),NCDX_Fut=sum(NCDX_Fut)
--ncdx_total=sum(ncdx_total),ncdx_remi=sum(ncdx_remi),  
--total=sum(total),remi=sum(remi),angel=sum(angel),  
--remi_percent=case when sum(remi) <> 0 then (sum(remi)*100)/sum(total) else 0 end  
from #file2 a (nolock) --left outer join intranet.risk.dbo.subgroup b  
--on a.subbrokcode=b.sub_broker
group by branch,subbrokcode,PARTY_CODE,CLIENT_NAME
order by PARTY_CODE
/*
set transaction isolation level read uncommitted    
select party_code='Total',BSECM_Del=sum(BSECM_Del),BSECM_Trd=sum(BSECM_Trd),  
NSECM_Del=sum(NSECM_Del),NSECM_Trd=sum(NSECM_Trd),  
NSEFO_Fut=sum(NSEFO_Fut),NSEFO_Opt=sum(NSEFO_Opt),  
MCDX_Fut=sum(MCDX_Fut),NCDX_Fut=sum(NCDX_Fut)
--ncdx_total=sum(ncdx_total),ncdx_remi=sum(ncdx_remi),  
--total=sum(total),remi=sum(remi),angel=sum(angel),  
--remi_percent=case when sum(remi) <> 0 then (sum(remi)*100)/sum(total) else 0 end  
from #file2 a (nolock) --left outer join intranet.risk.dbo.subgroup b  
*/

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MIS_TO_Summary
-- --------------------------------------------------
CREATE Procedure MIS_TO_Summary(@fdate as varchar(11),@tdate as varchar(11))
as

---------------------- Branch

delete from Mis_To_Company where sauda_date >=@fdate and sauda_DAte <=@tdate
insert into Mis_To_Company 
select company,sauda_Date,
turnover=sum(turnover),Brokerage=sum(brokerage),
TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt),
BK_Trd_Fut=sum(BK_Trd_Fut),BK_Del_Opt=sum(BK_Del_Opt)
from mis_to (nolock)
where sauda_date >=@fdate and sauda_DAte <=@tdate
group by company,sauda_date


---------------------- REgion
delete from Mis_TO_Region where sauda_date >=@fdate and sauda_DAte <=@tdate

insert into Mis_TO_Region
select company,region,sauda_Date,
turnover=sum(turnover),Brokerage=sum(brokerage),
TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt),
BK_Trd_Fut=sum(BK_Trd_Fut),BK_Del_Opt=sum(BK_Del_Opt)
from mis_to (nolock)
where sauda_date >=@fdate and sauda_DAte <=@tdate
group by company,region,sauda_date

---------------------- Branch
delete from Mis_TO_Branch where sauda_date >=@fdate and sauda_DAte <=@tdate

insert into Mis_TO_Branch
select company,region,Branch_cd,sauda_Date,
turnover=sum(turnover),Brokerage=sum(brokerage),
TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt),
BK_Trd_Fut=sum(BK_Trd_Fut),BK_Del_Opt=sum(BK_Del_Opt)
from mis_to (nolock)
where sauda_date >=@fdate and sauda_DAte <=@tdate
group by company,region,branch_Cd,sauda_date


---------------------- Sub_Broker
delete from Mis_TO_SB where sauda_date >=@fdate and sauda_DAte <=@tdate

insert into Mis_TO_SB
select company,region,Branch_cd,Sub_Broker,sauda_Date,
turnover=sum(turnover),Brokerage=sum(brokerage),
TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt),
BK_Trd_Fut=sum(BK_Trd_Fut),BK_Del_Opt=sum(BK_Del_Opt)
from mis_to (nolock)
where sauda_date >=@fdate and sauda_DAte <=@tdate
group by company,region,branch_Cd,Sub_Broker,sauda_date

---------------------- Terminal_detail
delete from Mis_TO_Terminal_detail where sauda_date >=@fdate and sauda_DAte <=@tdate

insert into Mis_TO_Terminal_detail
select company,region,Branch_cd,Sub_Broker,terminal_id,sauda_Date,
turnover=sum(turnover),Brokerage=sum(brokerage),
TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt),
BK_Trd_Fut=sum(BK_Trd_Fut),BK_Del_Opt=sum(BK_Del_Opt)
from mis_to (nolock)
where sauda_date >=@fdate and sauda_DAte <=@tdate
group by company,region,branch_Cd,Sub_Broker,terminal_id,sauda_date


---------------------- Terminal
delete from Mis_TO_Terminal where sauda_date >=@fdate and sauda_DAte <=@tdate

insert into Mis_TO_Terminal
select company,terminal_id,sauda_Date,
turnover=sum(turnover),Brokerage=sum(brokerage),
TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt),
BK_Trd_Fut=sum(BK_Trd_Fut),BK_Del_Opt=sum(BK_Del_Opt)
from mis_to (nolock)
where sauda_date >=@fdate and sauda_DAte <=@tdate
group by company,terminal_id,sauda_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_TOBRK_CLI
-- --------------------------------------------------
CREATE procedure mis_TOBRK_CLI(@fromdate as varchar(11),@todate as varchar(11),@Sbcode as varchar(10))    
as    
    
set nocount on    
  
/*
declare @fromdate as varchar(11),@todate as varchar(11)  ,@sbcode as varchar(10)  
set @fromdate ='09/13/2007'    
set @todate ='09/13/2007'    
set @sbcode ='ACM'  
*/
/*
drop table  #file1 
drop table  #file2 
drop table  #file3
*/  
select  branch=branch_cd,subbrokcode=Sub_broker,segment=company,party_code,client_name=party_name,  
turnover=sum(Turnover),TO_Trd_Fut=sum(TO_Trd_Fut),TO_Del_Opt=sum(TO_Del_Opt),
brokerage=sum(brokerage),brk_Trd_Fut=sum(bk_Trd_Fut),brk_Del_Opt=sum(bk_Del_Opt)
into #file1 from  
(  
select * from mis_to WITH (NOLOCK) where sauda_date >=@fromdate and sauda_date <=@todate 
and Sub_broker like @sbcode  
) a  
group by branch_cd,Sub_broker,company,party_code,party_name  
  

  
set transaction isolation level read uncommitted    
select branch=space(10),subbrokcode=space(10),party_code,client_name=space(100),    
BSECM_TODel=sum(case when segment='ABLCM' then TO_Del_Opt else 0 end),    
BSECM_TOTrd=sum(case when segment='ABLCM' then TO_Trd_Fut else 0 end),    
NSECM_TODel=sum(case when segment='ACDLCM' then TO_Del_Opt else 0 end),    
NSECM_TOTrd=sum(case when segment='ACDLCM' then TO_Trd_Fut else 0 end),    
NSEFO_TO=sum(case when segment='ACDLFO' then TO_Trd_Fut+TO_Del_Opt else 0 end),    
MCDX_TO=sum(case when segment='ACPLMCX' then TO_Trd_Fut+TO_Del_Opt else 0 end),    
NCDX_TO=sum(case when segment='ACPLNCDEX' then TO_Trd_Fut+TO_Del_Opt else 0 end),
BSECM_BrkDel=sum(case when segment='ABLCM' then Brk_Del_Opt else 0 end),    
BSECM_BrkTrd=sum(case when segment='ABLCM' then Brk_Trd_Fut else 0 end),    
NSECM_BrkDel=sum(case when segment='ACDLCM' then Brk_Del_Opt else 0 end),    
NSECM_BrkTrd=sum(case when segment='ACDLCM' then Brk_Trd_Fut else 0 end),    
NSEFO_Brk=sum(case when segment='ACDLFO' then Brk_Trd_Fut+Brk_Del_Opt else 0 end),    
MCDX_Brk=sum(case when segment='ACPLMCX' then Brk_Trd_Fut+Brk_Del_Opt else 0 end),    
NCDX_Brk=sum(case when segment='ACPLNCDEX' then Brk_Trd_Fut+Brk_Del_Opt else 0 end)
into #file2  
from #file1 (nolock)   
group by segment,party_code


  
  
set transaction isolation level read uncommitted      
select branch,subbrokcode,party_code,client_name,
BSECM_TODel=sum(BSECM_TODel),BSECM_TOTrd=sum(BSECM_TOTrd),    
NSECM_TODel=sum(NSECM_TODel),NSECM_TOTrd=sum(NSECM_TOTrd),    
NSEFO_TO=sum(NSEFO_TO),MCDX_TO=sum(MCDX_TO),NCDX_TO=sum(NCDX_TO),
BSECM_BrkDel=sum(BSECM_BrkDel),BSECM_BrkTrd=sum(BSECM_BrkTrd),    
NSECM_BrkDel=sum(NSECM_BrkDel),NSECM_BrkTrd=sum(NSECM_BrkTrd),    
NSEFO_Brk=sum(NSEFO_Brk),MCDX_Brk=sum(MCDX_Brk),NCDX_Brk=sum(NCDX_Brk)
into #file3
from #file2 a (nolock) --left outer join intranet.risk.dbo.subgroup b    
group by branch,subbrokcode,PARTY_CODE,CLIENT_NAME  
--order by PARTY_CODE  

select *,
BseDelPercent=(case when BSECM_brkDel > 0 then BSECM_brkDel*100/(BSECM_BrkDel+BSECM_BrkTrd) else 0 end),
NseDelPercent=(case when NSECM_brkDel > 0 then NSECM_brkDel*100/(NSECM_BrkDel+NSECM_BrkTrd) else 0 end)
into #file6
from #file3


select Party_Code,
BSECM_Net=(case when segment='ABLCM' then angel_share else 0 end),
NSECM_Net=(case when segment='ACDLCM' then angel_share else 0 end),
NSEFO_Net=(case when segment='ACDLFO' then angel_share else 0 end),
MCX_Net=(case when segment='ACPLMCX' then angel_share else 0 end),
NCDEX_Net=(case when segment='ACPLNCDX' then angel_share else 0 end)
into #file4
from mis.remisior.dbo.comb_cli 
where sauda_date >=@fromdate and sauda_date <=@todate and subbrokcode like @sbcode


select party_code,bsecm_net=sum(bsecm_net),nsecm_net=sum(nsecm_net),nsefo_net=sum(nsefo_net),mcx_net=sum(mcx_net),
ncdex_net=sum(ncdex_net) 
into #file5
from #file4 group by party_code



update #file6 set branch=b.branch_cd,subbrokcode=b.Sub_broker,client_name=b.long_name from
risk.dbo.client_details b (nolock) 
where #file6.party_code collate SQL_Latin1_General_CP1_CI_AS =b.party_Code


select a.*,
BSECM_BrkDelNet=(Case when bsecm_net > 0 then (bsecm_net*bsedelpercent)/100 else 0 end),
BSECM_BrkTrdNet=bsecm_net-(Case when bsecm_net > 0 then (bsecm_net*bsedelpercent)/100 else 0 end),
NSECM_BrkDelNet=(Case when nsecm_net > 0 then (nsecm_net*nsedelpercent)/100 else 0 end),
NSECM_BrkTrdNet=nsecm_net-(Case when nsecm_net > 0 then (nsecm_net*nsedelpercent)/100 else 0 end),
NSEFO_net,MCX_Net,NCDEX_net
from #file6 a, #file5 b 
where a.party_code collate SQL_Latin1_General_CP1_CI_AS =b.party_code
order by a.party_Code

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis1
-- --------------------------------------------------

CREATE procedure [dbo].[mis1] (@fdate as varchar(25), @tdate as varchar(25))           
as        
        
  
--declare @fdate as varchar(25)        
--declare @tdate as varchar(25)        
--set @fdate='Aug 11 2006 00:00:00'        
--set @tdate='Aug 11 2006 23:59:59'        
        
        
set nocount on        
  
    
--declare @fdate as varchar(25), @tdate as varchar(25)    
if @fdate='%'   
begin  
 set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'    
 set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'    
end  


set transaction isolation level read uncommitted      
select Company='ABLCM',sauda_DatE,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamttrd+pamtdel+samttrd+samtdel),        
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel)        
into #bsecm      
from AngelBSECM.bsedb_ab.dbo.cmbillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id        


set transaction isolation level read uncommitted      
select Company='ACDLCM',sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamttrd+pamtdel+samttrd+samtdel),        
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel)        
into #nsecm      
from AngelNseCM.msajag.dbo.cmbillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id        


set transaction isolation level read uncommitted      
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
 ,Turnover= sum((strike_price+ price)* tradeqty),        
brokerage=sum(brokapplied*tradeqty)        
into #nsefo      
from angelfo.nsefo.dbo.fosettlement fo,        
(  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl         
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      

  
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),   
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id)   
COLLATE SQL_Latin1_General_CP1_CI_AS      
 ,Turnover= sum((strike_price+ price)* tradeqty),        
brokerage=sum(cd_tot_brok)   
into #nsefo_opt  
from   
angelfo.nsefo.dbo.fosettlement a,   
angelfo.nsefo.dbo.charges_detail b  
where a.trade_no=b.cd_trade_no  
and a.order_no=b.cd_order_no  
and a.party_Code=b.cd_party_code  
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate        
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,  
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
  

update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage from #nsefo_opt b where #nsefo.party_Code=b.party_Code   
and. #nsefo.Terminal_Id=b.terminal_id  
  

-------------------------------------------------------------------------
                     
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement           
WHERE SAUDA_DATE >= @fdate AND SAUDA_dATE <= @tdate
          
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR 
from angelcommodity.mcdx.DBO.FOscrip2 b where 
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and
#mcx.option_type=b.option_type


set transaction isolation level read uncommitted      
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,Turnover= sum((strike_price+price)* tradeqty),        
brokerage=sum(brokapplied*tradeqty)        
into #mcdx
from #mcx fo,        
(
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      


      
set transaction isolation level read uncommitted      
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,      
Turnover= sum(trade_Amount),      
brokerage=sum(brokapplied*((TRADEQTY*NUMERATOR)/DENOMINATOR))        
into #ncdx      
from angelcommodity.ncdx.dbo.fosettlement fo,  angelcommodity.ncdx.dbo.foscrip2 scp,       
(  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.ncdx.dbo.client1 c1, angelcommodity.ncdx.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl         
where fo.symbol=scp.symbol and fo.inst_type=scp.inst_type and fo.expirydate=scp.expirydate and      
cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
      

delete from mis_to where sauda_DATE >=@fdate and sauda_Date <= @tdate        
      
set transaction isolation level read uncommitted      
insert into mis_to        
select * from        
(        
select * from #bsecm (nolock)      
union        
select * from #nsecm (nolock)      
union        
select * from #nsefo (nolock)      
/*        
select Company='ACDLFO',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelfo.nsefo.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
union        
select * from #mcdx (nolock)      
/*        
select Company='ACPLMCX',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelcommodity.mcdx.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
union        
select * from #ncdx (nolock)      
/*        
select Company='ACPLNCDEX',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelcommodity.ncdx.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/    
) aa        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis1_auto
-- --------------------------------------------------

CREATE procedure [dbo].[mis1_auto]  (@fdate as varchar(25), @tdate as varchar(25))           
as        
        
  
--declare @fdate as varchar(25)        
--declare @tdate as varchar(25)        
--set @fdate='Aug 11 2006 00:00:00'        
--set @tdate='Aug 11 2006 23:59:59'        
        
        
set nocount on        
  
    
--declare @fdate as varchar(25), @tdate as varchar(25)    
if @fdate='%'   
begin  
 set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'    
 set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'    
end  
      
set transaction isolation level read uncommitted      
select Company='ABLCM',sauda_DatE,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamttrd+pamtdel+samttrd+samtdel),        
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel)        
into #bsecm      
from AngelBSECM.bsedb_ab.dbo.cmbillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id        
      
set transaction isolation level read uncommitted      
select Company='ACDLCM',sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamttrd+pamtdel+samttrd+samtdel),        
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel)        
into #nsecm      
from AngelNseCM.msajag.dbo.cmbillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id        
       
set transaction isolation level read uncommitted      
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
 ,Turnover= sum((strike_price+ price)* tradeqty),        
brokerage=sum(brokapplied*tradeqty)        
into #nsefo      
from angelfo.nsefo.dbo.fosettlement fo,        
(  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl         
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
      
  
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),   
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id)   
COLLATE SQL_Latin1_General_CP1_CI_AS      
 ,Turnover= sum((strike_price+ price)* tradeqty),        
brokerage=sum(cd_tot_brok)   
into #nsefo_opt  
from   
angelfo.nsefo.dbo.fosettlement a,   
angelfo.nsefo.dbo.charges_detail b  
where a.trade_no=b.cd_trade_no  
and a.order_no=b.cd_order_no  
and a.party_Code=b.cd_party_code  
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate        
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,  
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
  

update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage from #nsefo_opt b where #nsefo.party_Code=b.party_Code   
and. #nsefo.Terminal_Id=b.terminal_id  
  
  


                     
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement           
WHERE SAUDA_DATE >= @fdate AND SAUDA_dATE <= @tdate
          
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR 
from angelcommodity.mcdx.DBO.FOscrip2 b where 
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and
#mcx.option_type=b.option_type


set transaction isolation level read uncommitted      
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,Turnover= sum((strike_price+price)* tradeqty),        
brokerage=sum(brokapplied*tradeqty)        
into #mcdx
from #mcx fo,        
(
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      



      
set transaction isolation level read uncommitted      
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,      
Turnover= sum(trade_Amount),      
brokerage=sum(brokapplied*((TRADEQTY*NUMERATOR)/DENOMINATOR))        
into #ncdx      
from angelcommodity.ncdx.dbo.fosettlement fo,  angelcommodity.ncdx.dbo.foscrip2 scp,       
(  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.ncdx.dbo.client1 c1, angelcommodity.ncdx.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl         
where fo.symbol=scp.symbol and fo.inst_type=scp.inst_type and fo.expirydate=scp.expirydate and      
cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
      
      
delete from mis_to where sauda_DATE >=@fdate and sauda_Date <= @tdate        
      
set transaction isolation level read uncommitted      
insert into mis_to        
select * from        
(        
select * from #bsecm (nolock)      
union        
select * from #nsecm (nolock)      
union        
select * from #nsefo (nolock)      
/*        
select Company='ACDLFO',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelfo.nsefo.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
union        
select * from #mcdx (nolock)      
/*        
select Company='ACPLMCX',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelcommodity.mcdx.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
union        
select * from #ncdx (nolock)      
/*        
select Company='ACPLNCDEX',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelcommodity.ncdx.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
) aa        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis1_mar2007
-- --------------------------------------------------

CREATE procedure [dbo].[mis1_mar2007] (@fdate as varchar(25), @tdate as varchar(25))           
as        
        
  
--declare @fdate as varchar(25)        
--declare @tdate as varchar(25)        
--set @fdate='Aug 11 2006 00:00:00'        
--set @tdate='Aug 11 2006 23:59:59'        
        
        
set nocount on        
  
    
--declare @fdate as varchar(25), @tdate as varchar(25)    
if @fdate='%'   
begin  
 set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'    
 set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'    
end  


set transaction isolation level read uncommitted      
select Company='ABLCM',sauda_DatE,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamttrd+pamtdel+samttrd+samtdel),        
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel)        
into #bsecm      
from AngelBSECM.bsedb_ab.dbo.cmbillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id        


set transaction isolation level read uncommitted      
select Company='ACDLCM',sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamttrd+pamtdel+samttrd+samtdel),        
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel)        
into #nsecm      
from AngelNseCM.msajag.dbo.cmbillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_cd,sub_broker,party_code,party_name,Terminal_Id        


set transaction isolation level read uncommitted      
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
 ,Turnover= sum((strike_price+ price)* tradeqty),        
brokerage=sum(brokapplied*tradeqty)        
into #nsefo      
from angelfo.nsefo.dbo.fosettlement fo,        
(  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl         
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      

  
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),   
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id)   
COLLATE SQL_Latin1_General_CP1_CI_AS      
 ,Turnover= sum((strike_price+ price)* tradeqty),        
brokerage=sum(cd_tot_brok)   
into #nsefo_opt  
from   
angelfo.nsefo.dbo.fosettlement a,   
angelfo.nsefo.dbo.charges_detail b  
where a.trade_no=b.cd_trade_no  
and a.order_no=b.cd_order_no  
and a.party_Code=b.cd_party_code  
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate        
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,  
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
  

update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage from #nsefo_opt b where #nsefo.party_Code=b.party_Code   
and. #nsefo.Terminal_Id=b.terminal_id  
  

-------------------------------------------------------------------------
                     
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement           
WHERE SAUDA_DATE >= @fdate AND SAUDA_dATE <= @tdate
          
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR 
from angelcommodity.mcdx.DBO.FOscrip2 b where 
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and
#mcx.option_type=b.option_type


set transaction isolation level read uncommitted      
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,Turnover= sum((strike_price+price)* tradeqty),        
brokerage=sum(brokapplied*tradeqty)        
into #mcdx
from #mcx fo,        
(
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      


      
set transaction isolation level read uncommitted      
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),        
branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,      
Turnover= sum(trade_Amount),      
brokerage=sum(brokapplied*((TRADEQTY*NUMERATOR)/DENOMINATOR))        
into #ncdx      
from angelcommodity.ncdx.dbo.fosettlement fo,  angelcommodity.ncdx.dbo.foscrip2 scp,       
(  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.ncdx.dbo.client1 c1, angelcommodity.ncdx.dbo.client2 c2 where c1.cl_code=c2.cl_code  
select party_Code,party_name=long_name,branch_cd,sub_Broker from risk.dbo.client_details  
) cl         
where fo.symbol=scp.symbol and fo.inst_type=scp.inst_type and fo.expirydate=scp.expirydate and      
cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),branch_cd,sub_broker,fo.party_code,party_name,      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS      
      

delete from mis_to_march2007 where sauda_DATE >=@fdate and sauda_Date <= @tdate        
      
set transaction isolation level read uncommitted      
insert into mis_to_march2007        
select * from        
(        
select * from #bsecm (nolock)      
union        
select * from #nsecm (nolock)      
union        
select * from #nsefo (nolock)      
/*        
select Company='ACDLFO',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelfo.nsefo.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
union        
select * from #mcdx (nolock)      
/*        
select Company='ACPLMCX',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelcommodity.mcdx.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
union        
select * from #ncdx (nolock)      
/*        
select Company='ACPLNCDEX',sauda_Date=convert(datetime,(convert(varchar(11),sauda_date,103)),103),branch_code,sub_broker,party_code,party_name,Terminal_Id,Turnover=sum(pamt+samt),        
brokerage=sum(pBrokAmt+SbrokAmt)        
from angelcommodity.ncdx.dbo.fobillvalan        
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
group by sauda_Date,branch_code,sub_broker,party_code,party_name,Terminal_Id        
*/        
) aa        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis2
-- --------------------------------------------------

CREATE procedure [dbo].[mis2] (@fdate as varchar(25), @tdate as varchar(25))                                                   
as                                                
                                                
set nocount on                                                
                                          
-- declare @fdate as varchar(25), @tdate as varchar(25)        
--set @fdate='%'                                          
if @fdate='%'                                           
begin                                          
-- set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'                                            
-- set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'                                            
select @fdate=convert(varchar(11),max(sauda_date))+' 00:00:00' from   mis.remisior.dbo.comb_co where isnull(brok_earned,0)>0                                         
select  @tdate=convert(varchar(11),max(sauda_date))+' 23:59:59' from mis.remisior.dbo.comb_co  where isnull(brok_earned,0)>0                                         
--print @fdate                
--print @tdate                
                
end                                          


/*                                      
-----------------------------  ABLCM                                      
                                          
                                      
set transaction isolation level read uncommitted                                              
select Company='ABLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,product=space(8),                                      
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                                                
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                                
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                                
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                                
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                                                
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                      
into #bsecm                                              
from AngelBSECM.bsedb_ab.dbo.cmbillvalan                                                
where sauda_DATE >=@fdate and sauda_Date <= @tdate                                                
and Terminal_Id<>'0' and scrip_cd<>'BRKSCR'          
And  Tradetype not in ( 'SCF','ICF','IR' )                                      
--and tradetype not like '__F'                                      
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                                                
      
      
select Company='ABLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,      
Terminal_Id,product='Add Brok',                                      
Turnover=0,                                                
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                                
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                                
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                                
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                                                
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                      
into #bsecm_1                                              
from AngelBSECM.bsedb_ab.dbo.cmbillvalan                                                
where sauda_DATE >=@fdate and sauda_Date <= @tdate                                                
and Terminal_Id='0' and scrip_cd='BRKSCR'          
And  Tradetype not in ( 'SCF','ICF','IR' )                                      
--and tradetype not like '__F'                                      
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id          
      
               
select party_code,nooftrade=count(trade_no),terminal_id=[user_id]              
into #bse              
from AngelBSECM.bsedb_ab.dbo.settlement where sauda_date>=@fdate                                 
and sauda_date<=@tdate and sett_type in ('C','D')              
group by party_code,[user_id]                                  
              
-----------------------------  ACDLCM                                      
      
                                      
set transaction isolation level read uncommitted                                              
select Company='ACDLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,product=space(8),                                     
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                                                
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                                
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                                
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                                
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                         
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                      
into #nsecm                                              
from AngelNseCM.msajag.dbo.cmbillvalan                                      
where sauda_DATE >=@fdate and sauda_Date <= @tdate            
and Terminal_Id<>'0' and scrip_cd<>'BROKERAGE'          
and tradeType not like '__F'                                                
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                                                
         
select Company='ACDLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name      
,Terminal_Id,product='Add Brok',                                     
Turnover=0,                                                
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                                
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                                
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                                
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                         
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                      
into #nsecm_1                                              
from AngelNseCM.msajag.dbo.cmbillvalan                                      
where sauda_DATE >=@fdate and sauda_Date <= @tdate            
and Terminal_Id='0' and scrip_cd='BROKERAGE'          
and tradeType not like '__F'                                                
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id         
      
                                  
select party_code,nooftrade=count(trade_no),terminal_id=[user_id]              
into #nse              
from AngelNseCM.msajag.dbo.settlement where sauda_date>=@fdate                               
and sauda_date<=@tdate and sett_type in ('N','W')              
group by party_code,[user_id]                 
                                      
-----------------------------  ACDLFO                                      
                 
set transaction isolation level read uncommitted                                              
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS ,product=space(8),                                             
Turnover= sum((strike_price+ price)* tradeqty),                                      
brokerage=sum(brokapplied*tradeqty),                                
TO_Trd_Fut=sum(case when left(inst_type,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                                
TO_Del_Opt=sum(case when left(inst_type,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                                
BK_Trd_Fut=sum(case when left(inst_type,3)='FUT' then brokapplied*tradeqty else 0 end),                                                
BK_Del_Opt=convert(money,0)                
,nooftrade=count(trade_no)                                    
into #nsefo                                              
from angelfo.nsefo.dbo.fosettlement fo,                                                
(                                          
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code                                          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                        
) cl                                                 
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate --and fo.o_c_flag not in('O','C')                                               
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                              
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                              
      
      
insert into #nsefo(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,      
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)      
select 'ACDLFO',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0',product='Add Brok',0,sum(pbrokAmt+SbrokAmt),      
0,0,0,0,0      
from      
angelfo.nsefo.dbo.fobillvalan b with (nolock)      
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate              
and symbol='BROKERAGE'         
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name      
                                        
                                     
                                          
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),                                           
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                                              
Turnover= sum((strike_price+ price)* tradeqty),                                                
brokerage=sum(cd_tot_brok)                                           
into #nsefo_opt                                          
from                                           
angelfo.nsefo.dbo.fosettlement a,                                           
angelfo.nsefo.dbo.charges_detail b                                          
where                                 
a.trade_no=b.cd_auctionPart+b.CD_trade_no                          
--a.trade_no=b.cd_trade_no                                          
and a.order_no=b.cd_order_no                                          
and a.party_Code=b.cd_party_code                 
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate                                                
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate                                                
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,                                          
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                              
        
      
                                       
                                        
update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage, BK_Del_Opt=#nsefo.BK_Del_Opt+b.brokerage                                  
from #nsefo_opt b where #nsefo.party_Code=b.party_Code                                           
and. #nsefo.Terminal_Id=b.terminal_id                                          
and isnull(#nsefo.product,'')<>'Add Brok'                                        
                                     
------------------------------------ MCX                                      
                                                             
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement                                                   
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                         
and auctionpart <> 'CA'                                      
                                      
                       
update #mcx set TRADEQTY=TRADEQTY*(booktype/instrument)                                      
/*                                                  
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                         
from angelcommodity.mcdx.DBO.FOscrip2 b where                                         
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                        
#mcx.option_type=b.option_type                                        
*/                              
                                        
set transaction isolation level read uncommitted                                              
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS, product=space(8),                                     
Turnover= sum((strike_price+price)* tradeqty),                                      
brokerage=sum(brokapplied*tradeqty),                                                
/*                                      
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                                
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                                
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                                
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                      
*/                                      
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                      
TO_Del_Opt=convert(money,0),                                      
BK_Trd_Fut=sum(brokapplied*tradeqty),                                      
BK_Del_Opt=convert(money,0)               
,nooftrade=count(trade_no)                                            
into #mcdx                                        
from #mcx fo,                                                
(                                     
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                          
) cl                                     
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate  and sauda_Date <= @tdate                                                 
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                        
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                              
                                        
insert into #mcdx(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,      
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)      
select 'ACPLMCX',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),      
0,0,0,0,0      
from      
ANGELCOMMODITY.mcdx.dbo.fobillvalan b with (nolock)      
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate              
and symbol='BROKERAGE'         
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name      
         
      
      
      
                                     
-------------------------------------------------- NCDEX                                      
                                                           
SELECT * INTO #temp_NCDX FROM  angelcommodity.ncdx.DBO.FOsettlement                                
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                         
and auctionpart <> 'CA'                                      
                                      
                                      
update #temp_ncdx set TRADEQTY=TRADEQTY*(booktype/instrument)                                      
/*                                                  
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                         
from angelcommodity.mcdx.DBO.FOscrip2 b where                                         
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                        
#mcx.option_type=b.option_type                                        
*/                                        
                                        
set transaction isolation level read uncommitted                                              
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                                      
Turnover= sum((strike_price+price)* tradeqty),                                      
brokerage=sum(brokapplied*tradeqty),                                                
/*                                      
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                                
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                                
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                                
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                      
*/                                      
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                      
TO_Del_Opt=convert(money,0),                                      
BK_Trd_Fut=sum(brokapplied*tradeqty),                                      
BK_Del_Opt=convert(money,0)               
,nooftrade=count(trade_no)                                            
into #ncdx                                        
from #temp_ncdx fo,                                                
(                                        
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                          
) cl                                        
where cl.party_Code=fo.party_code                                       
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                              
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                              
        
      
      
insert into #ncdx(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,      
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)      
select 'ACPLNCDEX',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),      
0,0,0,0,0      
from      
ANGELCOMMODITY.NCDX.dbo.fobillvalan b with (nolock)      
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate              
and symbol='BROKERAGE'         
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name      
                                      
                      
-------------------------------------------------- MCD                                      
                          SELECT * INTO #temp_mcd FROM  angelcommodity.mcdxcds.DBO.FOsettlement                                                   
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                         
and auctionpart <> 'CA'                                      
                                      
                                      
update #temp_mcd set TRADEQTY=TRADEQTY*(booktype/instrument)                                      
/*                                                  
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                         
from angelcommodity.mcdx.DBO.FOscrip2 b where                                         
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                        
#mcx.option_type=b.option_type                                        
*/                                        
                                        
set transaction isolation level read uncommitted                                              
select Company='ACPLMCD',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                    
Turnover= sum((strike_price+price)* tradeqty),                                      
brokerage=sum(brokapplied*tradeqty),                                                
/*                                      
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                                
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                                
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                                
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                      
*/                                      
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                      
TO_Del_Opt=convert(money,0),                                      
BK_Trd_Fut=sum(brokapplied*tradeqty),                                      
BK_Del_Opt=convert(money,0)              
,nooftrade=count(trade_no)                                             
into #mcd                                        
from #temp_mcd fo,                                                
(                                        
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                          
) cl                                        
where cl.party_Code=fo.party_code                                       
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                              
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                              
        
      
insert into #mcd(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,      
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)      
select 'ACPLMCD',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),      
0,0,0,0,0      
from      
ANGELCOMMODITY.mcdxcds.dbo.fobillvalan b with (nolock)      
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate              
and symbol='BROKERAGE'         
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name      
      
-------------------------------------------------- NSX                                      
SELECT * INTO #temp_nsx FROM  angelfo.nsecurfo.DBO.FOsettlement                                                   
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                         
and auctionpart <> 'CA'                                      
                                      
--select instrument from #temp_nsx                                      
update #temp_nsx set TRADEQTY=TRADEQTY*(booktype/case when instrument=0 then 1 else instrument end)                                      
/*                                                  
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                         
from angelcommodity.mcdx.DBO.FOscrip2 b where                                         
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                        
#mcx.option_type=b.option_type                                        
*/                                  
                                        
set transaction isolation level read uncommitted                                  
select Company='ACDLNSX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                                      
Turnover= sum((strike_price+price)* tradeqty),                                      
brokerage=sum(brokapplied*tradeqty),                                                
TO_Trd_Fut=sum(case when left(inst_type,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                                
TO_Del_Opt=sum(case when left(inst_type,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                                
BK_Trd_Fut=sum(case when left(inst_type,3)='FUT' then brokapplied*tradeqty else 0 end),                                                
BK_Del_Opt=sum(case when left(inst_type,3)='OPT' then brokapplied*tradeqty else 0 end)                                      
/*                                      
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                
TO_Del_Opt=convert(money,0),                                      
BK_Trd_Fut=sum(brokapplied*tradeqty),                                      
BK_Del_Opt=convert(money,0)                  
*/  
,nooftrade=count(trade_no)                                         
into #nsx                                        
from #temp_nsx fo,                                                
(                                        
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                          
) cl                                        
where cl.party_Code=fo.party_code                                       
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                              
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                         
        
            
      
insert into #nsx(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,      
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)      
select 'ACDLNSX',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),      
0,0,0,0,0      
from      
angelfo.nsecurfo.dbo.fobillvalan b with (nolock)      
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate              
and symbol='BROKERAGE'         
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name      
                                
      
      
            
select * into #terminal from mis.remisior.dbo.ebrok_terminal_master where from_date<=@fdate and to_date>=@tdate              
              
select * into #notd from                                                
(                                                
select dt=@fdate,company='ABLCM',*,ebrok='N' from #bse              
union                     
select dt=@fdate,company='ACDLCM',*,ebrok='N' from #nse              
union                     
select dt=@fdate,company='ACDLFO',party_code,nooftrade,terminal_id,ebrok='N' from #nsefo              
union                     
select dt=@fdate,company='ACPLMCX',party_code,nooftrade,terminal_id,ebrok='N' from #mcdx              
union                     
select dt=@fdate,company='ACPLNCDEX',party_code,nooftrade,terminal_id,ebrok='N' from #ncdx              
union                     
select dt=@fdate,company='ACPLMCD',party_code,nooftrade,terminal_id,ebrok='N' from #mcd              
union                     
select dt=@fdate,company='ACDLNSX',party_code,nooftrade,terminal_id,ebrok='N' from #nsx              
) aa              
              
update #notd set ebrok='Y' from #terminal b where #notd.terminal_id=b.terminal_id and #notd.company collate SQL_Latin1_General_CP1_CI_AS=replace(b.segment,'ACPLNCDX','ACPLNCDEX')              
      
/*      
select sum(turnover),sum(brokerage) from #fin where product='Add Brok'      
select sum(turnover),sum(brokerage) from mis_to(nolock) where sauda_date='Jul 01 2010'       
product<>'Add Brok'      
      
select * from      
(select company,party_code,to1=sum(turnover),brok=sum(brokerage) from #fin where product='Add Brok'      
group by company,party_code ) a      
full outer join      
(select segment,party_code,brok=sum(addt_brok) from mis.remisior.dbo.AddBrkTrnx where Trandate='Jul 01 2010'       
group by segment,party_code ) b      
on a.company=replace(b.segment,'ACPLNCDX','ACPLNCDEX') collate Latin1_General_CI_AS       
and a.party_code=b.party_code collate Latin1_General_CI_AS      
where isnull(a.brok,0)<>isnull(b.brok,0)      
      
select brok=sum(addt_brok) from mis.remisior.dbo.AddBrkTrnx where Trandate='Jul 01 2010'      
*/      
      
select * into #fin from                                                
(                       
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #bsecm (nolock)        
union      
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #bsecm_1           
union                        
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #nsecm_1      
union      
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #nsecm (nolock)         
union                                                
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #nsefo (nolock)                                              
union       
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #mcdx (nolock)                                              
union                                         
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #ncdx (nolock)                      
union                                        
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #mcd (nolock)                        
union                                                
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #nsx (nolock)                                                
) aa                
      
      
      
update #notd set ebrok='Y' from #terminal b where #notd.terminal_id=b.terminal_id and #notd.company collate SQL_Latin1_General_CP1_CI_AS=replace(b.segment,'ACPLNCDX','ACPLNCDEX')              
              
delete from mis_NoOfTrade where sauda_DATE >=@fdate and sauda_Date <= @tdate                  
insert into mis_NoOfTrade(sauda_DAte,company,party_code,nooftrade,Terminal_id,ebrok)                               
select * from #notd              
                            
delete from mis_to where sauda_DATE >=@fdate and sauda_Date <= @tdate                              
                                              
set transaction isolation level read uncommitted                                              
insert into mis_to  (company,sauda_DAte,region,branch_cd,sub_Broker,party_code,party_name,Terminal_id,product,Turnover,brokerage,TO_trd_Fut,TO_Del_opt,BK_Trd_Fut,BK_del_Opt)                               
      
select *  from                                                
(                       
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #bsecm (nolock)        
union      
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #bsecm_1                                            
union                                                
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #nsecm (nolock)         
union      
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt      
 from #nsecm_1 (nolock)                                              
union                                                
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #nsefo (nolock)                   
union                                               
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #mcdx (nolock)                                              
union                                         
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #ncdx (nolock)                      
union                                        
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #mcd (nolock)               
union                                                
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt              
from #nsx (nolock)                                                
) aa                                                
*/
                                    
exec mis_to_summary @fdate, @tdate                         
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis2_22072010
-- --------------------------------------------------

CREATE procedure mis2_22072010 (@fdate as varchar(25), @tdate as varchar(25))                                             
as                                          
                                          
set nocount on                                          
                                    
/*declare @fdate as varchar(25)                                          
declare @tdate as varchar(25)                                          
set @fdate='Jan 11 2010 00:00:00'                                          
set @tdate='Jan 11 2010 23:59:59'      */        
                                      
--declare @fdate as varchar(25), @tdate as varchar(25)                                      
if @fdate='%'                                     
begin                                    
-- set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'                                      
-- set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'                                      
select @fdate=convert(varchar(11),max(sauda_date))+' 00:00:00' from   mis.remisior.dbo.comb_co where isnull(brok_earned,0)>0                                   
select  @tdate=convert(varchar(11),max(sauda_date))+' 23:59:59' from mis.remisior.dbo.comb_co  where isnull(brok_earned,0)>0                                   
--print @fdate          
--print @tdate          
          
end                                    
                                
-----------------------------  ABLCM                                
                                    
                                    
        
                                
set transaction isolation level read uncommitted                                        
select Company='ABLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,                                
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                                          
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                          
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                          
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                          
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                                          
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                
into #bsecm                                        
from anand.bsedb_ab.dbo.cmbillvalan                                          
where sauda_DATE >=@fdate and sauda_Date <= @tdate                                          
and Terminal_Id<>'0' and scrip_cd<>'BRKSCR'    
And  Tradetype not in ( 'SCF','ICF','IR' )                                
--and tradetype not like '__F'                                
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                                          
                                  
select party_code,nooftrade=count(trade_no),terminal_id=[user_id]        
into #bse        
from anand.bsedb_ab.dbo.settlement where sauda_date>=@fdate                           
and sauda_date<=@tdate and sett_type in ('C','D')        
group by party_code,[user_id]                            
        
-----------------------------  ACDLCM                                
                                
                                
set transaction isolation level read uncommitted                                        
select Company='ACDLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,                                
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                                          
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                          
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                          
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                          
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                   
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                
into #nsecm                                        
from anand1.msajag.dbo.cmbillvalan                                
where sauda_DATE >=@fdate and sauda_Date <= @tdate      
and Terminal_Id<>'0' and scrip_cd<>'BROKERAGE'    
                             
and tradeType not like '__F'                                          
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                                          
                                
select party_code,nooftrade=count(trade_no),terminal_id=[user_id]        
into #nse        
from anand1.msajag.dbo.settlement where sauda_date>=@fdate                         
and sauda_date<=@tdate and sett_type in ('N','W')        
group by party_code,[user_id]           
                                
-----------------------------  ACDLFO                                
           
set transaction isolation level read uncommitted                                        
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                        
,Turnover= sum(price* tradeqty),                                
brokerage=sum(brokapplied*tradeqty),                                          
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then price*tradeqty else 0 end),                                          
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then price*tradeqty else 0 end),                                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)          
,nooftrade=count(trade_no)                              
into #nsefo                                        
from angelfo.nsefo.dbo.fosettlement fo,                                          
(                                    
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code                                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                  
) cl                                           
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate --and fo.o_c_flag not in('O','C')                                         
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                        
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                        
                                  
                               
                                    
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),                                     
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id)                                     
COLLATE SQL_Latin1_General_CP1_CI_AS                                        
,Turnover= sum((strike_price+ price)* tradeqty),                                          
brokerage=sum(cd_tot_brok)                                     
into #nsefo_opt                                    
from                                     
angelfo.nsefo.dbo.fosettlement a,                                     
angelfo.nsefo.dbo.charges_detail b                                    
where                           
a.trade_no=b.cd_auctionPart+b.CD_trade_no                    
--a.trade_no=b.cd_trade_no                                    
and a.order_no=b.cd_order_no                                    
and a.party_Code=b.cd_party_code           
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate                                          
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate                                          
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,                                    
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                        
                                    
                                  
update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage, BK_Del_Opt=#nsefo.BK_Del_Opt+b.brokerage                                
from #nsefo_opt b where #nsefo.party_Code=b.party_Code                                     
and. #nsefo.Terminal_Id=b.terminal_id                                    
                                    
                                  
------------------------------------ MCX                                
                                                       
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement                                             
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                   
and auctionpart <> 'CA'                                
                                
                 
update #mcx set TRADEQTY=TRADEQTY*(booktype/instrument)                                
/*                                            
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                   
from angelcommodity.mcdx.DBO.FOscrip2 b where                                   
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                  
#mcx.option_type=b.option_type                                  
*/                        
                                  
set transaction isolation level read uncommitted                                        
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,                                
Turnover= sum((strike_price+price)* tradeqty),                                
brokerage=sum(brokapplied*tradeqty),                                          
/*                                
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                          
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                
*/                                
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                
TO_Del_Opt=convert(money,0),                                
BK_Trd_Fut=sum(brokapplied*tradeqty),                                
BK_Del_Opt=convert(money,0)         
,nooftrade=count(trade_no)                                      
into #mcdx                                  
from #mcx fo,                                          
(                               
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                    
) cl                               
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate  and sauda_Date <= @tdate                                           
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                  
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                        
                                  
                                  
-------------------------------------------------- NCDEX                                
                                                     
SELECT * INTO #temp_NCDX FROM  angelcommodity.ncdx.DBO.FOsettlement                          
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                   
and auctionpart <> 'CA'                                
                                
                                
update #temp_ncdx set TRADEQTY=TRADEQTY*(booktype/instrument)                                
/*                                            
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                   
from angelcommodity.mcdx.DBO.FOscrip2 b where                                   
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                  
#mcx.option_type=b.option_type                                  
*/                                  
                                  
set transaction isolation level read uncommitted                                        
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,                                
Turnover= sum((strike_price+price)* tradeqty),                                
brokerage=sum(brokapplied*tradeqty),                                          
/*                                
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                          
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                
*/                                
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                
TO_Del_Opt=convert(money,0),                                
BK_Trd_Fut=sum(brokapplied*tradeqty),                                
BK_Del_Opt=convert(money,0)         
,nooftrade=count(trade_no)                                      
into #ncdx                                  
from #temp_ncdx fo,                                          
(                                  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                    
) cl                                  
where cl.party_Code=fo.party_code                                 
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                        
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                        
                                  
                
-------------------------------------------------- MCD                                
                        
SELECT * INTO #temp_mcd FROM  angelcommodity.mcdxcds.DBO.FOsettlement                                             
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                   
and auctionpart <> 'CA'                                
                                
                                
update #temp_mcd set TRADEQTY=TRADEQTY*(booktype/instrument)                                
/*                                            
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                   
from angelcommodity.mcdx.DBO.FOscrip2 b where                                   
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                  
#mcx.option_type=b.option_type                                  
*/                                  
                                  
set transaction isolation level read uncommitted                                        
select Company='ACPLMCD',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,              
Turnover= sum((strike_price+price)* tradeqty),                                
brokerage=sum(brokapplied*tradeqty),                                          
/*                                
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                          
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                
*/                                
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                
TO_Del_Opt=convert(money,0),                                
BK_Trd_Fut=sum(brokapplied*tradeqty),                                
BK_Del_Opt=convert(money,0)        
,nooftrade=count(trade_no)                                       
into #mcd                                  
from #temp_mcd fo,                                          
(                                  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                    
) cl                                  
where cl.party_Code=fo.party_code                                 
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                        
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                        
                                  
-------------------------------------------------- NSX                                
                                                     
SELECT * INTO #temp_nsx FROM  angelfo.nsecurfo.DBO.FOsettlement                                             
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                   
and auctionpart <> 'CA'                                
                                
--select instrument from #temp_nsx                                
update #temp_nsx set TRADEQTY=TRADEQTY*(booktype/case when instrument=0 then 1 else instrument end)                                
/*                                            
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                   
from angelcommodity.mcdx.DBO.FOscrip2 b where                                   
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                  
#mcx.option_type=b.option_type                                  
*/                            
                                  
set transaction isolation level read uncommitted                            
select Company='ACDLNSX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,                                
Turnover= sum((strike_price+price)* tradeqty),                                
brokerage=sum(brokapplied*tradeqty),                                          
/*                                
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                          
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                
*/                                
TO_Trd_Fut= sum((strike_price+price)* tradeqty),          
TO_Del_Opt=convert(money,0),                                
BK_Trd_Fut=sum(brokapplied*tradeqty),                                
BK_Del_Opt=convert(money,0)            
,nooftrade=count(trade_no)                                   
into #nsx                                  
from #temp_nsx fo,                                          
(                                  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                    
) cl                                  
where cl.party_Code=fo.party_code                                 
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                        
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                   
        
select * into #terminal from mis.remisior.dbo.ebrok_terminal_master where from_date<=@fdate and to_date>=@tdate        
        
select * into #notd from                                          
(                                          
select dt=@fdate,company='ABLCM',*,ebrok='N' from #bse        
union               
select dt=@fdate,company='ACDLCM',*,ebrok='N' from #nse        
union               
select dt=@fdate,company='ACDLFO',party_code,nooftrade,terminal_id,ebrok='N' from #nsefo        
union               
select dt=@fdate,company='ACPLMCX',party_code,nooftrade,terminal_id,ebrok='N' from #mcdx        
union               
select dt=@fdate,company='ACPLNCDEX',party_code,nooftrade,terminal_id,ebrok='N' from #ncdx        
union               
select dt=@fdate,company='ACPLMCD',party_code,nooftrade,terminal_id,ebrok='N' from #mcd        
union               
select dt=@fdate,company='ACDLNSX',party_code,nooftrade,terminal_id,ebrok='N' from #nsx        
) aa        
        
update #notd set ebrok='Y' from #terminal b where #notd.terminal_id=b.terminal_id and #notd.company collate SQL_Latin1_General_CP1_CI_AS=replace(b.segment,'ACPLNCDX','ACPLNCDEX')        
        
delete from mis_NoOfTrade where sauda_DATE >=@fdate and sauda_Date <= @tdate            
insert into mis_NoOfTrade(sauda_DAte,company,party_code,nooftrade,Terminal_id,ebrok)                         
select * from #notd        
                      
delete from mis_to where sauda_DATE >=@fdate and sauda_Date <= @tdate                        
                                        
set transaction isolation level read uncommitted                                        
insert into mis_to  (company,sauda_DAte,region,branch_cd,sub_Broker,party_code,party_name,Terminal_id,Turnover,brokerage,TO_trd_Fut,TO_Del_opt,BK_Trd_Fut,BK_del_Opt)                         
select * from                                          
(                 
select * from #bsecm (nolock)                                        
union                                          
select * from #nsecm (nolock)                                        
union                                          
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt        
from #nsefo (nolock)                                        
union                                          
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt        
from #mcdx (nolock)                                        
union                                   
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt        
from #ncdx (nolock)                
union                                  
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt        
from #mcd (nolock)                  
union                                          
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt        
from #nsx (nolock)                                          
) aa                                          
                              
exec mis_to_summary @fdate, @tdate                   
                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis2_acdlfo
-- --------------------------------------------------
CREATE procedure mis2_acdlfo (@fdate as varchar(25), @tdate as varchar(25))                     
as

set transaction isolation level read uncommitted                
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                  
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) 
COLLATE SQL_Latin1_General_CP1_CI_AS                
,Turnover= sum(price*tradeqty),        
brokerage=sum(brokapplied*tradeqty),                  
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                  
--TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                  
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then price* tradeqty else 0 end),                  
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                  
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)        
into #nsefo                
from angelfo.nsefo.dbo.fosettlement fo,                  
(            
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code            
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details          
) cl                   
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                
          
           
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),             
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id)             
COLLATE SQL_Latin1_General_CP1_CI_AS                
,Turnover= sum((strike_price+ price)* tradeqty),                  
brokerage=sum(cd_tot_brok)             
into #nsefo_opt            
from             
angelfo.nsefo.dbo.fosettlement a,             
angelfo.nsefo.dbo.charges_detail b            
where   
a.trade_no=b.cd_auctionPart+b.CD_trade_no   
--a.trade_no=b.cd_trade_no            
and a.order_no=b.cd_order_no            
and a.party_Code=b.cd_party_code            
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,            
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                
            
          
update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage, BK_Del_Opt=#nsefo.BK_Del_Opt+b.brokerage        
from #nsefo_opt b where #nsefo.party_Code=b.party_Code             
and. #nsefo.Terminal_Id=b.terminal_id            

insert into temp_misto_nsefo select * from #nsefo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis2_NSEFO
-- --------------------------------------------------

CREATE procedure [dbo].[mis2_NSEFO] (@fdate as varchar(25), @tdate as varchar(25))                   
as                
                
/*          
declare @fdate as varchar(25)                
declare @tdate as varchar(25)                
set @fdate='Mar  1 2007 00:00:00'                
set @tdate='Mar  1 2007 23:59:59'                
*/                
                
set nocount on                
          
            
--declare @fdate as varchar(25), @tdate as varchar(25)            
if @fdate='%'           
begin          
 set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'            
 set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'            
end          
      
-----------------------------  ABLCM      
          
/*      
set transaction isolation level read uncommitted              
select Company='ABLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,      
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                
BK_Del_Opt=sum(pBrokdel+Sbrokdel)      
into #bsecm              
from AngelBSECM.bsedb_ab.dbo.cmbillvalan                
where sauda_DATE >=@fdate and sauda_Date <= @tdate                
And  Tradetype not in ( 'SCF','ICF','IR' )      
--and tradetype not like '__F'      
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                
        
      
-----------------------------  ACDLCM      
      
      
set transaction isolation level read uncommitted              
select Company='ACDLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,      
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                
BK_Del_Opt=sum(pBrokdel+Sbrokdel)      
into #nsecm              
from AngelNseCM.msajag.dbo.cmbillvalan      
where sauda_DATE >=@fdate and sauda_Date <= @tdate      
and tradeType not like '__F'                
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                
      
      
*/      
-----------------------------  ACDLFO      
      
set transaction isolation level read uncommitted              
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS              
,Turnover= sum((strike_price+ price)* tradeqty),      
brokerage=sum(brokapplied*tradeqty),                
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)      
into #nsefo              
from angelfo.nsefo.dbo.fosettlement fo,                
(          
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details        
) cl                 
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate                
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,              
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS              
        
      
          
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),           
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id)           
COLLATE SQL_Latin1_General_CP1_CI_AS              
,Turnover= sum((strike_price+ price)* tradeqty),                
brokerage=sum(cd_tot_brok)           
into #nsefo_opt          
from           
angelfo.nsefo.dbo.fosettlement a,           
angelfo.nsefo.dbo.charges_detail b          
where 
a.trade_no=b.cd_auctionPart+b.CD_trade_no 
--a.trade_no=b.cd_trade_no          
and a.order_no=b.cd_order_no          
and a.party_Code=b.cd_party_code          
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate                
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate                
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,          
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS              
          
        
update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage, BK_Del_Opt=#nsefo.BK_Del_Opt+b.brokerage      
from #nsefo_opt b where #nsefo.party_Code=b.party_Code           
and. #nsefo.Terminal_Id=b.terminal_id          
/*          
        
------------------------------------ MCX      
                             
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement                   
WHERE SAUDA_DATE >= @fdate AND SAUDA_dATE <= @tdate        
and auctionpart <> 'CA'      
      
      
update #mcx set TRADEQTY=TRADEQTY*(booktype/instrument)      
/*                  
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR         
from angelcommodity.mcdx.DBO.FOscrip2 b where         
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and        
#mcx.option_type=b.option_type        
*/        
        
set transaction isolation level read uncommitted              
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,      
Turnover= sum((strike_price+price)* tradeqty),      
brokerage=sum(brokapplied*tradeqty),                
/*      
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)      
*/      
TO_Trd_Fut= sum((strike_price+price)* tradeqty),      
TO_Del_Opt=convert(money,0),      
BK_Trd_Fut=sum(brokapplied*tradeqty),      
BK_Del_Opt=convert(money,0)      
into #mcdx        
from #mcx fo,                
(        
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details          
) cl        
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate                
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,             
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS              
        
        
-------------------------------------------------- NCDEX      
                           
SELECT * INTO #temp_NCDX FROM  angelcommodity.ncdx.DBO.FOsettlement                   
WHERE SAUDA_DATE >= @fdate AND SAUDA_dATE <= @tdate        
and auctionpart <> 'CA'      
      
      
update #temp_ncdx set TRADEQTY=TRADEQTY*(booktype/instrument)      
/*                  
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR         
from angelcommodity.mcdx.DBO.FOscrip2 b where         
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and        
#mcx.option_type=b.option_type        
*/        
        
set transaction isolation level read uncommitted              
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,      
Turnover= sum((strike_price+price)* tradeqty),      
brokerage=sum(brokapplied*tradeqty),                
/*      
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)      
*/      
TO_Trd_Fut= sum((strike_price+price)* tradeqty),      
TO_Del_Opt=convert(money,0),      
BK_Trd_Fut=sum(brokapplied*tradeqty),      
BK_Del_Opt=convert(money,0)      
into #ncdx        
from #temp_ncdx fo,                
(        
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code          
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details          
) cl        
where cl.party_Code=fo.party_code       
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,              
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS              
*/        
        
delete from mis_to where sauda_DATE >=@fdate and sauda_Date <= @tdate AND COMPANY='ACDLFO'               
              
set transaction isolation level read uncommitted              
insert into mis_to  (company,sauda_DAte,region,branch_cd,sub_Broker,party_code,party_name,Terminal_id,Turnover,brokerage,TO_trd_Fut,TO_Del_opt,BK_Trd_Fut,BK_del_Opt)              
select * from                
(                
/*
select * from #bsecm (nolock)              
union                
select * from #nsecm (nolock)              
union                
*/
select * from #nsefo (nolock)              
/*
union                
select * from #mcdx (nolock)              
union                
select * from #ncdx (nolock)              
*/
) aa                
    
--exec mis_to_summary @fdate, @tdate                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis2_temp31july10
-- --------------------------------------------------

CREATE procedure mis2_temp31july10 (@fdate as varchar(25), @tdate as varchar(25))                                               
as                                            
                                            
set nocount on                                            
                                      
-- declare @fdate as varchar(25), @tdate as varchar(25)    
--set @fdate='%'                                      
if @fdate='%'                                       
begin                                      
-- set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'                                        
-- set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'                                        
select @fdate=convert(varchar(11),max(sauda_date))+' 00:00:00' from   mis.remisior.dbo.comb_co where isnull(brok_earned,0)>0                                     
select  @tdate=convert(varchar(11),max(sauda_date))+' 23:59:59' from mis.remisior.dbo.comb_co  where isnull(brok_earned,0)>0                                     
--print @fdate            
--print @tdate            
            
end                                      
                                  
-----------------------------  ABLCM                                  
                                      
                                  
set transaction isolation level read uncommitted                                          
select Company='ABLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,product=space(8),                                  
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                                            
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                            
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                            
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                            
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                                            
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                  
into #bsecm                                          
from anand.bsedb_ab.dbo.cmbillvalan                                            
where sauda_DATE >=@fdate and sauda_Date <= @tdate                                            
and Terminal_Id<>'0' and scrip_cd<>'BRKSCR'      
And  Tradetype not in ( 'SCF','ICF','IR' )                                  
--and tradetype not like '__F'                                  
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                                            
  
  
select Company='ABLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,  
Terminal_Id,product='Add Brok',                                  
Turnover=0,                                            
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                            
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                            
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                            
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                                            
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                  
into #bsecm_1                                          
from anand.bsedb_ab.dbo.cmbillvalan                                            
where sauda_DATE >=@fdate and sauda_Date <= @tdate                                            
and Terminal_Id='0' and scrip_cd='BRKSCR'      
And  Tradetype not in ( 'SCF','ICF','IR' )                                  
--and tradetype not like '__F'                                  
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id      
  
                        
select party_code,nooftrade=count(trade_no),terminal_id=[user_id]          
into #bse          
from anand.bsedb_ab.dbo.settlement where sauda_date>=@fdate                             
and sauda_date<=@tdate and sett_type in ('C','D')          
group by party_code,[user_id]                              
          
-----------------------------  ACDLCM                                  
  
                                  
set transaction isolation level read uncommitted                                          
select Company='ACDLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,product=space(8),                                 
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                                            
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                            
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                            
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                            
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                     
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                  
into #nsecm                                          
from anand1.msajag.dbo.cmbillvalan                                  
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
and Terminal_Id<>'0' and scrip_cd<>'BROKERAGE'      
and tradeType not like '__F'                                            
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                                            
     
select Company='ACDLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name  
,Terminal_Id,product='Add Brok',                                 
Turnover=0,                                            
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                                            
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                                            
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                                            
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                     
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                                  
into #nsecm_1                                          
from anand1.msajag.dbo.cmbillvalan                                  
where sauda_DATE >=@fdate and sauda_Date <= @tdate        
and Terminal_Id='0' and scrip_cd='BROKERAGE'      
and tradeType not like '__F'                                            
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id     
  
                              
select party_code,nooftrade=count(trade_no),terminal_id=[user_id]          
into #nse          
from anand1.msajag.dbo.settlement where sauda_date>=@fdate                           
and sauda_date<=@tdate and sett_type in ('N','W')          
group by party_code,[user_id]             
                                  
-----------------------------  ACDLFO                                  
             
set transaction isolation level read uncommitted                                          
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                            
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS ,product=space(8),                                         
Turnover= sum(price* tradeqty),                                  
brokerage=sum(brokapplied*tradeqty),                                            
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then price*tradeqty else 0 end),                                            
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then price*tradeqty else 0 end),                                            
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                            
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)            
,nooftrade=count(trade_no)                                
into #nsefo                                          
from angelfo.nsefo.dbo.fosettlement fo,                                            
(                                      
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code                                      
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                    
) cl                                             
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate --and fo.o_c_flag not in('O','C')                                           
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                          
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                          
  
  
insert into #nsefo(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,  
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)  
select 'ACDLFO',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0',product='Add Brok',0,sum(pbrokAmt+SbrokAmt),  
0,0,0,0,0  
from  
angelfo.nsefo.dbo.fobillvalan b with (nolock)  
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate          
and symbol='BROKERAGE'     
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name  
                                    
                                 
                                      
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),                                       
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                                          
Turnover= sum((strike_price+ price)* tradeqty),                                            
brokerage=sum(cd_tot_brok)                                       
into #nsefo_opt                                      
from                                       
angelfo.nsefo.dbo.fosettlement a,                                       
angelfo.nsefo.dbo.charges_detail b                                      
where                             
a.trade_no=b.cd_auctionPart+b.CD_trade_no                      
--a.trade_no=b.cd_trade_no                                      
and a.order_no=b.cd_order_no                                      
and a.party_Code=b.cd_party_code             
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate                                            
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate                                            
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,                                      
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                          
    
  
                                   
                                    
update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage,Turnover = #nsefo.Turnover+b.Turnover, BK_Del_Opt=#nsefo.BK_Del_Opt+b.brokerage                                  
from #nsefo_opt b where #nsefo.party_Code=b.party_Code                                       
and. #nsefo.Terminal_Id=b.terminal_id                                      
and isnull(#nsefo.product,'')<>'Add Brok'                                    
                                    
------------------------------------ MCX                                  
                                                         
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement                                               
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                     
and auctionpart <> 'CA'                                  
                                  
                   
update #mcx set TRADEQTY=TRADEQTY*(booktype/instrument)                                  
/*                                              
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                     
from angelcommodity.mcdx.DBO.FOscrip2 b where                                     
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                    
#mcx.option_type=b.option_type                                    
*/                          
                                    
set transaction isolation level read uncommitted                                          
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                            
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS, product=space(8),                                 
Turnover= sum((strike_price+price)* tradeqty),                                  
brokerage=sum(brokapplied*tradeqty),                                            
/*                                  
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                            
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                            
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                            
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                  
*/                                  
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                  
TO_Del_Opt=convert(money,0),                                  
BK_Trd_Fut=sum(brokapplied*tradeqty),                                  
BK_Del_Opt=convert(money,0)           
,nooftrade=count(trade_no)                                        
into #mcdx                                    
from #mcx fo,                                            
(                                 
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                      
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                      
) cl                                 
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate  and sauda_Date <= @tdate                                             
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                    
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                          
                                    
insert into #mcdx(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,  
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)  
select 'ACPLMCX',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),  
0,0,0,0,0 
from  
ANGELCOMMODITY.mcdx.dbo.fobillvalan b with (nolock)  
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate          
and symbol='BROKERAGE'     
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name  
     
  
  
  
                                 
-------------------------------------------------- NCDEX                                  
                                                       
SELECT * INTO #temp_NCDX FROM  angelcommodity.ncdx.DBO.FOsettlement                            
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                     
and auctionpart <> 'CA'                                  
                                  
                                  
update #temp_ncdx set TRADEQTY=TRADEQTY*(booktype/instrument)                                  
/*                                              
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                     
from angelcommodity.mcdx.DBO.FOscrip2 b where                                     
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                    
#mcx.option_type=b.option_type                                    
*/                                    
                                    
set transaction isolation level read uncommitted                                          
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                            
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                                  
Turnover= sum((strike_price+price)* tradeqty),                                  
brokerage=sum(brokapplied*tradeqty),                                            
/*                                  
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                            
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                            
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                            
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                  
*/                                  
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                  
TO_Del_Opt=convert(money,0),                                  
BK_Trd_Fut=sum(brokapplied*tradeqty),                                  
BK_Del_Opt=convert(money,0)           
,nooftrade=count(trade_no)                                        
into #ncdx                                    
from #temp_ncdx fo,                                            
(                                    
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                      
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                      
) cl                                    
where cl.party_Code=fo.party_code                                   
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                          
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                          
    
  
  
insert into #ncdx(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,  
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)  
select 'ACPLNCDEX',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),  
0,0,0,0,0  
from  
ANGELCOMMODITY.NCDX.dbo.fobillvalan b with (nolock)  
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate          
and symbol='BROKERAGE'     
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name  
                                  
                  
-------------------------------------------------- MCD                                  
                          SELECT * INTO #temp_mcd FROM  angelcommodity.mcdxcds.DBO.FOsettlement                                               
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                     
and auctionpart <> 'CA'                                  
                                  
                                  
update #temp_mcd set TRADEQTY=TRADEQTY*(booktype/instrument)                                  
/*                                              
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                     
from angelcommodity.mcdx.DBO.FOscrip2 b where                                     
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                    
#mcx.option_type=b.option_type                                    
*/                                    
                                    
set transaction isolation level read uncommitted                                          
select Company='ACPLMCD',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                            
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                
Turnover= sum((strike_price+price)* tradeqty),                                  
brokerage=sum(brokapplied*tradeqty),                                            
/*                                  
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                            
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                            
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                            
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                  
*/                                  
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                                  
TO_Del_Opt=convert(money,0),                                  
BK_Trd_Fut=sum(brokapplied*tradeqty),                                  
BK_Del_Opt=convert(money,0)          
,nooftrade=count(trade_no)                                         
into #mcd                                    
from #temp_mcd fo,                                            
(                                    
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                      
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                      
) cl                                    
where cl.party_Code=fo.party_code                                   
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                                          
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                                          
    
  
insert into #mcd(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,  
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)  
select 'ACPLMCD',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),  
0,0,0,0,0  
from  
ANGELCOMMODITY.mcdxcds.dbo.fobillvalan b with (nolock)  
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate          
and symbol='BROKERAGE'     
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name  
  
-------------------------------------------------- NSX                                  
                
SELECT * INTO #temp_nsx FROM  angelfo.nsecurfo.DBO.FOsettlement                                               
WHERE SAUDA_DATE >= @fdate  AND SAUDA_dATE <= @tdate                                     
and auctionpart <> 'CA'                                  
                                  
--select instrument from #temp_nsx                                  
update #temp_nsx set TRADEQTY=TRADEQTY*(booktype/case when instrument=0 then 1 else instrument end)                                  
/*                                              
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                                     
from angelcommodity.mcdx.DBO.FOscrip2 b where                                     
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                                    
#mcx.option_type=b.option_type                                    
*/                              
                                    
set transaction isolation level read uncommitted                              
select Company='ACDLNSX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                                            
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,product=space(8),                                  
Turnover= sum((strike_price+price)* tradeqty),                                  
brokerage=sum(brokapplied*tradeqty),                                            
/*                                  
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                                            
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                                            
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                                            
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                                  
*/                                  
TO_Trd_Fut= sum((strike_price+price)* tradeqty),            
TO_Del_Opt=convert(money,0),                                  
BK_Trd_Fut=sum(brokapplied*tradeqty),                                  
BK_Del_Opt=convert(money,0)              
,nooftrade=count(trade_no)                                     
into #nsx                                    
from #temp_nsx fo,                                            
(                                    
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                                      
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                                      
) cl                                    
where cl.party_Code=fo.party_code                                   
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name, 
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                     
    
        
  
insert into #nsx(Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,  
brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,nooftrade)  
select 'ACDLNSX',sauda_date,Region,branch_code,sub_broker,party_code,party_name,'0','Add Brok',0,sum(pbrokAmt+SbrokAmt),  
0,0,0,0,0  
from  
angelfo.nsecurfo.dbo.fobillvalan b with (nolock)  
where b.sauda_date>=@fdate and b.sauda_Date <= @tdate          
and symbol='BROKERAGE'     
group by b.party_code,sauda_date,Region,branch_code,sub_broker,party_code,party_name  
                            
  
  
        
select * into #terminal from mis.remisior.dbo.ebrok_terminal_master where from_date<=@fdate and to_date>=@tdate          
          
select * into #notd from                                            
(                                            
select dt=@fdate,company='ABLCM',*,ebrok='N' from #bse          
union                 
select dt=@fdate,company='ACDLCM',*,ebrok='N' from #nse          
union                 
select dt=@fdate,company='ACDLFO',party_code,nooftrade,terminal_id,ebrok='N' from #nsefo          
union                 
select dt=@fdate,company='ACPLMCX',party_code,nooftrade,terminal_id,ebrok='N' from #mcdx          
union                 
select dt=@fdate,company='ACPLNCDEX',party_code,nooftrade,terminal_id,ebrok='N' from #ncdx          
union                 
select dt=@fdate,company='ACPLMCD',party_code,nooftrade,terminal_id,ebrok='N' from #mcd          
union                 
select dt=@fdate,company='ACDLNSX',party_code,nooftrade,terminal_id,ebrok='N' from #nsx          
) aa          
          
update #notd set ebrok='Y' from #terminal b where #notd.terminal_id=b.terminal_id and #notd.company collate SQL_Latin1_General_CP1_CI_AS=replace(b.segment,'ACPLNCDX','ACPLNCDEX')          
  

  
select * into #fin from                                            
(                   
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #bsecm (nolock)    
union  
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #bsecm_1                                        
union                                            
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #nsecm_1  
union  
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #nsecm (nolock)     
union                                            
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #nsefo (nolock)                                          
union                                           
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #mcdx (nolock)                                          
union                                     
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #ncdx (nolock)                  
union                                    
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #mcd (nolock)                    
union                                      
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #nsx (nolock)                                            
) aa            
  
  
  
update #notd set ebrok='Y' from #terminal b where #notd.terminal_id=b.terminal_id and #notd.company collate SQL_Latin1_General_CP1_CI_AS=replace(b.segment,'ACPLNCDX','ACPLNCDEX')          
          
--delete from mis_NoOfTrade where sauda_DATE >=@fdate and sauda_Date <= @tdate              
--insert into mis_NoOfTrade(sauda_DAte,company,party_code,nooftrade,Terminal_id,ebrok)                           
--select * from #notd          
                        
delete from mis_to_temp31July_TurnOver where sauda_DATE >=@fdate and sauda_Date <= @tdate                          
                                          
set transaction isolation level read uncommitted                                          
insert into mis_to_temp31July_TurnOver  (company,sauda_DAte,region,branch_cd,sub_Broker,party_code,party_name,Terminal_id,product,Turnover,brokerage,TO_trd_Fut,TO_Del_opt,BK_Trd_Fut,BK_del_Opt)                           
  
select *  from                                            
(                   
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #bsecm (nolock)    
union  
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #bsecm_1                                        
union                                            
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #nsecm (nolock)     
union  
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt  
 from #nsecm_1 (nolock)                                          
union                                            
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #nsefo (nolock)                                          
union                                           
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #mcdx (nolock)                                          
union                                     
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #ncdx (nolock)                  
union                                    
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #mcd (nolock)                    
union                                            
select Company,sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id,product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt          
from #nsx (nolock)                                            
) aa                                            
                                
---exec mis_to_summary @fdate, @tdate                     
                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis3
-- --------------------------------------------------

CREATE procedure [dbo].[mis3] (@fdate as varchar(25), @tdate as varchar(25),@pcode as varchar(11))                             
as                          
                          
/*                    
declare @fdate as varchar(25)                          
declare @tdate as varchar(25)                          
set @fdate='Mar  1 2007 00:00:00'                          
set @tdate='Mar  1 2007 23:59:59'                          
*/                          
                          
set nocount on                          
                    
                      
--declare @fdate as varchar(25), @tdate as varchar(25)                      
if @fdate='%'                     
begin                    
 set @fdate=convert(varchar(11),getdate()-1)+' 00:00:00'                      
 set @tdate=convert(varchar(11),getdate()-1)+' 23:59:59'                      
end                    
                
-----------------------------  ABLCM                
                    
                
set transaction isolation level read uncommitted                        
select Company='ABLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,                
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                          
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                          
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                          
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                          
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                          
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                
into #bsecm                        
from AngelBSECM.bsedb_ab.dbo.cmbillvalan                          
where sauda_DATE >=@fdate and sauda_Date <= @tdate                          
and party_Code=@pcode
And  Tradetype not in ( 'SCF','ICF','IR' )                
--and tradetype not like '__F'                
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                          
                  
                
-----------------------------  ACDLCM                
                
                
set transaction isolation level read uncommitted                        
select Company='ACDLCM',sauda_Date,region=substring(region,1,10),branch_cd,sub_broker,party_code,party_name,Terminal_Id,                
Turnover=sum((pamttrd+pamtdel)-(pBrokTrd+Pbrokdel)+(samttrd+samtdel)+(sBrokTrd+sbrokdel)),                          
brokerage=sum(pBrokTrd+SbrokTrd+Sbrokdel+Pbrokdel),                          
TO_Trd_Fut=sum((pamttrd)-(Pbroktrd)+(samttrd)+(sbroktrd)),                          
TO_Del_Opt=sum((pamtdel)-(Pbrokdel)+(samtdel)+(sbrokdel)),                          
BK_Trd_Fut=sum(pBrokTrd+SbrokTrd),                          
BK_Del_Opt=sum(pBrokdel+Sbrokdel)                
into #nsecm                        
from AngelNseCM.msajag.dbo.cmbillvalan                
where sauda_DATE >=@fdate and sauda_Date <= @tdate                
and party_Code=@pcode
and tradeType not like '__F'                          
group by sauda_Date,region,branch_cd,sub_broker,party_code,party_name,Terminal_Id                          
                
                
                
-----------------------------  ACDLFO                
                
set transaction isolation level read uncommitted                        
select  Company='ACDLFO',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                        
,Turnover= sum(price* tradeqty),                
brokerage=sum(brokapplied*tradeqty),                          
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then price*tradeqty else 0 end),                 
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then price*tradeqty else 0 end),                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                
into #nsefo                        
from angelfo.nsefo.dbo.fosettlement fo,                          
(                    
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelfo.nsefo.dbo.client1 c1, angelfo.nsefo.dbo.client2 c2 where c1.cl_code=c2.cl_code                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                  
where party_Code=@pcode
) cl                           
where cl.party_Code=fo.party_code and fo.party_Code=@pcode and sauda_DATE >=@fdate and sauda_Date <= @tdate --and fo.o_c_flag not in('O','C')                         
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                        
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                        
                  
                
                    
select company='ACDLFO',sauda_date=CONVERT(DATETIME,CONVERT(VARCHAR(11),b.CD_SAUDA_dATE,109)),                     
branch_Cd=space(10),sub_Broker=space(10),party_Code=cd_party_code,party_name=space(50),Terminal_Id=CONVERT(VARCHAR,a.User_id)                     
COLLATE SQL_Latin1_General_CP1_CI_AS                        
,Turnover= sum((strike_price+ price)* tradeqty),                          
brokerage=sum(cd_tot_brok)                     
into #nsefo_opt                    
from                     
angelfo.nsefo.dbo.fosettlement a,                     
angelfo.nsefo.dbo.charges_detail b                    
where           
a.trade_no=b.cd_auctionPart+b.CD_trade_no           
--a.trade_no=b.cd_trade_no                    
and cd_party_Code=@pcode
and a.order_no=b.cd_order_no                    
and a.party_Code=b.cd_party_code                    
and a.sauda_DATE >=@fdate and a.sauda_Date <= @tdate                          
and b.cd_sauda_DATE >=@fdate and b.cd_sauda_Date <= @tdate                          
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),cd_SAUDA_dATE,109)),cd_party_code,                    
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                        
                    
                  
update #nsefo  set brokerage = #nsefo.brokerage+b.brokerage, BK_Del_Opt=#nsefo.BK_Del_Opt+b.brokerage                
from #nsefo_opt b where #nsefo.party_Code=b.party_Code                     
and. #nsefo.Terminal_Id=b.terminal_id                    
                    
                  
------------------------------------ MCX                
                                       
SELECT * INTO #MCX FROM  angelcommodity.mcdx.DBO.FOsettlement                             
WHERE party_Code=@pcode and SAUDA_DATE >= @fdate AND SAUDA_dATE <= @tdate                  
and auctionpart <> 'CA'                
                
                
update #mcx set TRADEQTY=TRADEQTY*(booktype/instrument)                
/*                            
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                   
from angelcommodity.mcdx.DBO.FOscrip2 b where                   
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                  
#mcx.option_type=b.option_type                  
*/                  
                  
set transaction isolation level read uncommitted                        
select Company='ACPLMCX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,                
Turnover= sum((strike_price+price)* tradeqty),                
brokerage=sum(brokapplied*tradeqty),                          
/*                
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                          
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                
*/                
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                
TO_Del_Opt=convert(money,0),                
BK_Trd_Fut=sum(brokapplied*tradeqty),                
BK_Del_Opt=convert(money,0)                
into #mcdx                  
from #mcx fo,                          
(               
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                    
) cl                  
where cl.party_Code=fo.party_code and sauda_DATE >=@fdate and sauda_Date <= @tdate                          
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                       
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                        
                  
                  
-------------------------------------------------- NCDEX                
                                     
SELECT * INTO #temp_NCDX FROM  angelcommodity.ncdx.DBO.FOsettlement                             
WHERE party_Code=@pcode and SAUDA_DATE >= @fdate AND SAUDA_dATE <= @tdate                  
and auctionpart <> 'CA'                
                
                
update #temp_ncdx set TRADEQTY=TRADEQTY*(booktype/instrument)                
/*                            
update #mcx set TRADEQTY=(TRADEQTY*b.GeneralNUMERATOR)/b.GeneralDENOMINATOR                   
from angelcommodity.mcdx.DBO.FOscrip2 b where                   
#mcx.Inst_type=b.Inst_type and #mcx.symbol=b.symbol and #mcx.expirydate=b.Expirydate and #mcx.strike_price=b.strike_price and                  
#mcx.option_type=b.option_type                  
*/                  
                  
set transaction isolation level read uncommitted                        
select Company='ACPLNCDEX',sauda_Date=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),                          
region=substring(region,1,10),branch_cd,sub_broker,fo.party_code,party_name,Terminal_Id=CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS,                
Turnover= sum((strike_price+price)* tradeqty),                
brokerage=sum(brokapplied*tradeqty),                          
/*                
TO_Trd_Fut=sum(case when left(sec_name,3)='FUT' then (strike_price+ price)* tradeqty else 0 end),                          
TO_Del_Opt=sum(case when left(sec_name,3)='OPT' then (strike_price+ price)* tradeqty else 0 end),                          
BK_Trd_Fut=sum(case when left(sec_name,3)='FUT' then brokapplied*tradeqty else 0 end),                          
BK_Del_Opt=sum(case when left(sec_name,3)='OPT' then brokapplied*tradeqty else 0 end)                
*/                
TO_Trd_Fut= sum((strike_price+price)* tradeqty),                
TO_Del_Opt=convert(money,0),                
BK_Trd_Fut=sum(brokapplied*tradeqty),                
BK_Del_Opt=convert(money,0)                
into #ncdx                  
from #temp_ncdx fo,                          
(                  
--select c2.party_code, party_name=long_name, branch_cd,sub_broker from angelcommodity.mcdx.dbo.client1 c1, angelcommodity.mcdx.dbo.client2 c2 where c1.cl_code=c2.cl_code                    
select party_Code,party_name=long_name,region,branch_cd,sub_Broker from risk.dbo.client_details                    
) cl                  
where cl.party_Code=fo.party_code                 
group by CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_dATE,109)),region,branch_cd,sub_broker,fo.party_code,party_name,                        
CONVERT(VARCHAR,User_id) COLLATE SQL_Latin1_General_CP1_CI_AS                        
                  

delete from m_mis_to where sauda_DATE >=@fdate and sauda_Date <= @tdate  and party_Code=@pcode                        
                        
set transaction isolation level read uncommitted                        
insert into m_mis_to (company,sauda_DAte,region,branch_cd,sub_Broker,party_code,party_name,Terminal_id,Turnover,brokerage,TO_trd_Fut,TO_Del_opt,BK_Trd_Fut,BK_del_Opt)         
select * from                          
(                          
select * from #bsecm (nolock)                        
union                          
select * from #nsecm (nolock)                        
union                          
select * from #nsefo (nolock)                        
union                          
select * from #mcdx (nolock)                        
union                          
select * from #ncdx (nolock)                        
) aa                          
              
--exec mis_to_summary @fdate, @tdate                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Monthend_mis
-- --------------------------------------------------

CREATE Procedure Monthend_mis(@fdate as varchar(25),@tdate as varchar(25))                        
as                        
                        
Set transaction isolation level read uncommitted                        
                        
Set Nocount On                        
/*declare @fdate as varchar(25),@tdate as varchar(25)                        
Set @fdate='Dec 01 2007'                        
Set @tdate='Dec 10 2007'                        
*/                        
                        
select                         
branch=space(10),                        
subbrokcode=space(15),                        
party_code,                        
client_name=space(125),                        
BSECM_TODel=sum(case when company='ABLCM' then TO_del_opt else 0 end),                        
BSECM_TOTrd=sum(case when company='ABLCM' then TO_Trd_fut else 0 end),                        
NSECM_TODel=sum(case when company='ACDLCM' then TO_del_opt else 0 end),                        
NSECM_TOTrd=sum(case when company='ACDLCM' then TO_trd_fut else 0 end),                        
NSEFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),                         
MCDX_TO =sum(case when company='ACPLMCX' then turnover else 0 end),                         
NCDX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),                         
MCD_TO =sum(case when company='ACPLMCD' then turnover else 0 end),                         
NSX_TO=sum(case when company='ACDLNSX' then turnover else 0 end),     
BSECM_BrkDel=sum(case when company='ABLCM' then BK_del_opt else 0 end),                         
BSECM_BrkTrd=sum(case when company='ABLCM' then BK_trd_fut else 0 end),                          
NSECM_BrkDel=sum(case when company='ACDLCM' then BK_del_opt else 0 end),                         
NSECM_BrkTrd=sum(case when company='ACDLCM' then BK_trd_fut else 0 end),                          
NSEFO_Brk=sum(case when company='ACDLFO' then brokerage else 0 end),                          
MCDX_Brk=sum(case when company='ACPLMCX' then brokerage else 0 end),                           
NCDX_Brk=sum(case when company='ACPLNCDEX' then brokerage else 0 end),                        
MCD_brk=sum(case when company='ACPLMCD' then brokerage else 0 end),                        
NSX_brk=sum(case when company='ACDLNSX' then brokerage else 0 end),                
BSECM_BrkDelNet=convert(money,0),                         
BSECM_BrkTrdNet=convert(money,0),                         
NSECM_BrkDelNet =convert(money,0),                        
NSECM_BrkTrdNet =convert(money,0),                        
NSEFO_net=convert(money,0),                         
MCX_Net=convert(money,0),                         
NCDEX_net=convert(money,0),     
MCD_net =convert(money,0),                         
NSX_net=convert(money,0)                        
into #File1                        
from mis_to (nolock)                        
where                         
sauda_DAte >=@fdate                        
and sauda_Date <=@tdate                        
group by party_code                        
                        
                        
                        
SELECT party_code,                         
(Sum(Case When inst_type LIKE'FUT%' AND auctionpart <>'EA'  AND auctionpart <>'CA'                         
Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) AS futurestradedvalue,                         
(Sum(Case When inst_type LIKE'OPT%' AND auctionpart <>'CA' AND auctionpart <>'EA' Then (((pqty+sqty)*strike_price) + (pqty*prate)+(sqty*srate)) Else 0 End)) AS optionstradedvalue,                         
(Sum(Case When (inst_type LIKE'OPT%' AND auctionpart <>'CA' AND auctionpart ='EA') Then (sqty*(strike_price+SRate)) Else 0 End)) AS excercisevalue, 0 AS assignmentvalue,                         
(Sum(Case When inst_type LIKE'FUT%' AND auctionpart ='EA' AND auctionpart <>'CA' Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) AS closeoutvalue,                         
(Sum(Case When (inst_type like'FUT%' AND auctionpart <>'CA' ) Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) +                         
(Sum(Case When (inst_type like'OPT%' AND auctionpart <>'CA' ) Then IsNull((prate+strike_Price)*pqty + (srate+strike_price)*sqty,0) Else 0 End))  AS total,                         
Sum(pbrokamt + sbrokamt) AS brokerage, Sum(service_tax) AS servicetax, Sum(Ins_chrg) AS Ins_chrg,                         
Sum(turn_tax) AS turnovertax, Sum(sebi_tax) AS sebitax, Sum(broker_note) AS stampduty, Sum(Other_Chrg) AS clearingcharges                         
into #FOTO1                        
FROM angelfo.nsefo.dbo.FOBillValan_View_Turnover                
WHERE tradetype ='BT' AND inst_type LIKE'%'                         
AND option_type LIKE'%' AND Left(Convert(VarChar,expirydate,109),11) LIKE'%'                         
AND symbol LIKE'%' AND  isnull(party_code,'') >='A'                 AND  isnull(party_code,'') <='ZZZ' AND sauda_date >= @fdate                         
AND sauda_date <= @tdate AND 1=1             
GROUP BY party_code                     
                        
                        
--select sum(futurestradedvalue),sum(optionstradedvalue) from #FOTO1                        
--select sum(total) from #FOTO1                        
------------------                        
update #file1 set nsefo_to=b.total from #foto1 b where #file1.party_code=b.party_code collate Latin1_General_CI_AS                        
 ----------------------------------Commented by shweta on 02/05/2008--------------------------------------------------                       
                        
select segment,partY_code,brok_earned=sum(brok_Earned),angel_Share=sum(angel_Share)                        
into #file2                        
from mis.remisior.dbo.comb_Cli where                         
sauda_DAte >=@fdate                        
and sauda_Date <=@tdate                        
group by segment,partY_code                        
                        
                        
update #File1 set NSEFO_Brk=b.brok_earned,NSEFO_net=b.angel_share from                         
(select * from #file2 where segment='ACDLFO') b                         
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                        
                        
update #File1 set MCDX_Brk=b.brok_earned,MCX_Net=b.angel_share from                         
(select * from #file2 where segment='ACPLMCX') b                         
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                        
                        
update #File1 set NCDX_Brk=b.brok_earned,ncdex_Net=b.angel_share from                         
(select * from #file2 where segment='ACPLNCDX') b                         
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                        
                        
update #File1 set BSECM_BrkTrdNet=b.angel_share from                         
(select * from #file2 where segment='ABLCM') b                         
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                        
                        
update #File1 set NSECM_BrkTrdNet=b.angel_share from                         
(select * from #file2 where segment='ACDLCM') b                         
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                        
                        
update #File1 set MCD_net=b.angel_share from                         
(select * from #file2 where segment='ACPLMCD') b                         
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                        
    
update #File1 set NSX_net=b.angel_share from                         
(select * from #file2 where segment='ACDLNSX') b                         
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                        
                        
/*SELECT PARTY_CODE,BROK=(BSECM_BRKDEL+BSECM_BRKTRD),BSECM_BRKDEL, BSECM_BRKTRD,BSECM_BrkTrdNet,                        
bsedel=(BSECM_BrkTrdNet*((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD)))/100                        
--,DELPERCENT=((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD))                        
FROM #FILE1 WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0*/                        
              
UPDATE #FILE1 SET BSECM_BrkDelNet=(BSECM_BrkTrdNet*((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD)))/100                        
FROM #FILE1 WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0                        
                        
UPDATE #FILE1 SET BSECM_BrktrdNet=BSECM_BrkTrdNet-BSECM_BrkDelNet WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0                        
                        
                        
UPDATE #FILE1 SET NSECM_BrkDelNet=(NSECM_BrkTrdNet*((NSECM_BRKDEL*100)/(NSECM_BRKDEL+NSECM_BRKTRD)))/100                        
FROM #FILE1 WHERE (NSECM_BRKDEL+NSECM_BRKTRD) > 0                        
                        
UPDATE #FILE1 SET NSECM_BrktrdNet=NSECM_BrkTrdNet-NSECM_BrkDelNet WHERE (NSECM_BRKDEL+NSECM_BRKTRD) > 0                        
                        
update #file1                         
set branch=b.branch_cd,subbrokcode=b.sub_BRoker,client_name=b.long_name                         
from risk.dbo.client_details b (nolock)                        
where #file1.party_code=b.party_code COLLATE Latin1_General_CI_AS                        
                        

select * from #file1 order by party_code          



        
--select Purvi_party_code=a.party_code,b.* from temp_f a left outer join #file1 b on a.party_Code=b.party_Code           
--order by a.party_code          
            
Set Nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Monthend_mis1
-- --------------------------------------------------

CREATE Procedure Monthend_mis1(@fdate as varchar(25),@tdate as varchar(25),@USER as varchar(25),@CODE AS varchar(25))                              
as                              
                              
Set transaction isolation level read uncommitted                              
                              
Set Nocount On        
/*                      
 declare @fdate as varchar(25),@tdate as varchar(25)                              
Set @fdate='Dec 01 2009'                              
Set @tdate='Dec 10 2009'                              
 */                              
                           
select                               
branch=space(10),                              
subbrokcode=space(15),                              
party_code,                              
client_name=space(125),                              
BSECM_TODel=sum(case when company='ABLCM' then TO_del_opt else 0 end),                              
BSECM_TOTrd=sum(case when company='ABLCM' then TO_Trd_fut else 0 end),                              
NSECM_TODel=sum(case when company='ACDLCM' then TO_del_opt else 0 end),                              
NSECM_TOTrd=sum(case when company='ACDLCM' then TO_trd_fut else 0 end),                              
NSEFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),                               
MCDX_TO =sum(case when company='ACPLMCX' then turnover else 0 end),                               
NCDX_TO=sum(case when company='ACPLNCDEX' then turnover else 0 end),                               
MCD_TO =sum(case when company='ACPLMCD' then turnover else 0 end),                               
NSX_TO=sum(case when company='ACDLNSX' then turnover else 0 end),           
BSECM_BrkDel=sum(case when company='ABLCM' then BK_del_opt else 0 end),                               
BSECM_BrkTrd=sum(case when company='ABLCM' then BK_trd_fut else 0 end),                                
NSECM_BrkDel=sum(case when company='ACDLCM' then BK_del_opt else 0 end),                               
NSECM_BrkTrd=sum(case when company='ACDLCM' then BK_trd_fut else 0 end),                                
NSEFO_Brk=sum(case when company='ACDLFO' then brokerage else 0 end),                                
MCDX_Brk=sum(case when company='ACPLMCX' then brokerage else 0 end),                                 
NCDX_Brk=sum(case when company='ACPLNCDEX' then brokerage else 0 end),                              
MCD_brk=sum(case when company='ACPLMCD' then brokerage else 0 end),                              
NSX_brk=sum(case when company='ACDLNSX' then brokerage else 0 end),                      
BSECM_BrkDelNet=convert(money,0),                               
BSECM_BrkTrdNet=convert(money,0),                               
NSECM_BrkDelNet =convert(money,0),                              
NSECM_BrkTrdNet =convert(money,0),                              
NSEFO_net=convert(money,0),                               
MCX_Net=convert(money,0),                               
NCDEX_net=convert(money,0),           
MCD_net =convert(money,0),                               
NSX_net=convert(money,0)                              
into #File1                              
from mis_to (nolock)                              
where                               
sauda_DAte >=@fdate                              
and sauda_Date <=@tdate                              
group by party_code                              
                              
                              
                              
SELECT party_code,                               
(Sum(Case When inst_type LIKE'FUT%' AND auctionpart <>'EA'  AND auctionpart <>'CA'                               
Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) AS futurestradedvalue,                               
(Sum(Case When inst_type LIKE'OPT%' AND auctionpart <>'CA' AND auctionpart <>'EA' Then (((pqty+sqty)*strike_price) + (pqty*prate)+(sqty*srate)) Else 0 End)) AS optionstradedvalue,                               
(Sum(Case When (inst_type LIKE'OPT%' AND auctionpart <>'CA' AND auctionpart ='EA') Then (sqty*(strike_price+SRate)) Else 0 End)) AS excercisevalue, 0 AS assignmentvalue,                               
(Sum(Case When inst_type LIKE'FUT%' AND auctionpart ='EA' AND auctionpart <>'CA' Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) AS closeoutvalue,                               
(Sum(Case When (inst_type like'FUT%' AND auctionpart <>'CA' ) Then IsNull(prate*pqty + srate*sqty,0) Else 0 End)) +                               
(Sum(Case When (inst_type like'OPT%' AND auctionpart <>'CA' ) Then IsNull((prate+strike_Price)*pqty + (srate+strike_price)*sqty,0) Else 0 End))  AS total,                               
Sum(pbrokamt + sbrokamt) AS brokerage, Sum(service_tax) AS servicetax, Sum(Ins_chrg) AS Ins_chrg,                               
Sum(turn_tax) AS turnovertax, Sum(sebi_tax) AS sebitax, Sum(broker_note) AS stampduty, Sum(Other_Chrg) AS clearingcharges                               
into #FOTO1                              
FROM angelfo.nsefo.dbo.FOBillValan_View_Turnover                      
WHERE tradetype ='BT' AND inst_type LIKE'%'                               
AND option_type LIKE'%' AND Left(Convert(VarChar,expirydate,109),11) LIKE'%'                               
AND symbol LIKE'%' AND  isnull(party_code,'') >='A'                 AND  isnull(party_code,'') <='ZZZ' AND sauda_date >= @fdate                               
AND sauda_date <= @tdate AND 1=1                   
GROUP BY party_code                           
                              
                              
--select sum(futurestradedvalue),sum(optionstradedvalue) from #FOTO1                              
--select sum(total) from #FOTO1                              
------------------                              
update #file1 set nsefo_to=b.total from #foto1 b where #file1.party_code=b.party_code collate Latin1_General_CI_AS                              
 ----------------------------------Commented by shweta on 02/05/2008--------------------------------------------------                             
                              
select segment,partY_code,brok_earned=sum(brok_Earned),angel_Share=sum(angel_Share)                              
into #file2                              
from mis.remisior.dbo.comb_Cli where                               
sauda_DAte >=@fdate                              
and sauda_Date <=@tdate                              
group by segment,partY_code                              
                              
                              
update #File1 set NSEFO_Brk=b.brok_earned,NSEFO_net=b.angel_share from                               
(select * from #file2 where segment='ACDLFO') b                               
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                              
                              
update #File1 set MCDX_Brk=b.brok_earned,MCX_Net=b.angel_share from                               
(select * from #file2 where segment='ACPLMCX') b                               
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                              
                              
update #File1 set NCDX_Brk=b.brok_earned,ncdex_Net=b.angel_share from                               
(select * from #file2 where segment='ACPLNCDX') b                               
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                              
                              
update #File1 set BSECM_BrkTrdNet=b.angel_share from                               
(select * from #file2 where segment='ABLCM') b                               
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                              
                              
update #File1 set NSECM_BrkTrdNet=b.angel_share from                          
(select * from #file2 where segment='ACDLCM') b                               
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                              
                         
update #File1 set MCD_net=b.angel_share from                               
(select * from #file2 where segment='ACPLMCD') b                               
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                              
          
update #File1 set NSX_net=b.angel_share from                               
(select * from #file2 where segment='ACDLNSX') b                               
where #File1.party_code=b.partY_code COLLATE Latin1_General_CI_AS                              
                              
/*SELECT PARTY_CODE,BROK=(BSECM_BRKDEL+BSECM_BRKTRD),BSECM_BRKDEL, BSECM_BRKTRD,BSECM_BrkTrdNet,                              
bsedel=(BSECM_BrkTrdNet*((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD)))/100                              
--,DELPERCENT=((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD))                              
FROM #FILE1 WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0*/                              
                    
UPDATE #FILE1 SET BSECM_BrkDelNet=(BSECM_BrkTrdNet*((BSECM_BRKDEL*100)/(BSECM_BRKDEL+BSECM_BRKTRD)))/100                              
FROM #FILE1 WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0                              
                              
UPDATE #FILE1 SET BSECM_BrktrdNet=BSECM_BrkTrdNet-BSECM_BrkDelNet WHERE (BSECM_BRKDEL+BSECM_BRKTRD) > 0                              
                              
                              
UPDATE #FILE1 SET NSECM_BrkDelNet=(NSECM_BrkTrdNet*((NSECM_BRKDEL*100)/(NSECM_BRKDEL+NSECM_BRKTRD)))/100                              
FROM #FILE1 WHERE (NSECM_BRKDEL+NSECM_BRKTRD) > 0                              
                              
UPDATE #FILE1 SET NSECM_BrktrdNet=NSECM_BrkTrdNet-NSECM_BrkDelNet WHERE (NSECM_BRKDEL+NSECM_BRKTRD) > 0                              
                              
update #file1                               
set branch=b.branch_cd,subbrokcode=b.sub_BRoker,client_name=b.long_name                               
from risk.dbo.client_details b (nolock)                              
where #file1.party_code=b.party_code COLLATE Latin1_General_CI_AS                              
                              
if @user='BROKER'                      
BEGIN      
select a.*,client_type= case when b.b2c_sb is null then 'B2B' else 'B2C' end from    
(select * from #File1) a    
left outer join mis.remisior.dbo.b2c_sb b    
on a.subbrokcode collate SQL_Latin1_General_CP1_CI_AS=b.b2c_sb      
order by party_code                 
END      
      
      
if @user='BRMAST'                      
BEGIN    
   
select a.*,client_type= case when b.b2c_sb is null then 'B2B' else 'B2C' end from    
(select * from #file1       
WHERE branch collate SQL_Latin1_General_CP1_CI_AS in (SELECT BRANCH_CD FROM RISK.DBO.BRANCH_MASTER WHERE BRMAST_CD=@CODE) ) a    
left outer join mis.remisior.dbo.b2c_sb b    
on a.subbrokcode collate SQL_Latin1_General_CP1_CI_AS=b.b2c_sb      
order by party_code                 
END               
--select Purvi_party_code=a.party_code,b.* from temp_f a left outer join #file1 b on a.party_Code=b.party_Code                 
--order by a.party_code                
                   
Set Nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mrk_netbrok
-- --------------------------------------------------
CREATE procedure mrk_netbrok(@fdate as varchar(11),@tdate as varchar(11))  
as  
  
set nocount on  
Set Transaction isolation level read uncommitted   
/*declare @fdate as varchar(11),@tdate as varchar(11)  
set @fdate='Feb 18 2006'  
set @tdate='Feb 24 2006'  
  */
select a.branch_Cd, mctot=isnull(convert(money,sum(ncdx_ashare)/5.5),0)+isnull(convert(money,sum(mcdx_ashare)/5.5),0) ,   
mltot=isnull(convert(money,b.Nnet_aperday),0)+isnull(convert(money,b.Mnet_aperday),0)   
into #aa  
from commo_perf_eval a left outer join   
(select branch_cd, Ngross_perday= sum(ncdx_brok)/5.5,Nnet_aperday=sum(ncdx_ashare)/5.5,   
Mgross_perday= sum(mcdx_brok)/5.5,Mnet_aperday=sum(mcdx_ashare)/5.5  from commo_perf_eval where  
tdate>=(convert(datetime,@fdate)-7) and tdate<=(convert(datetime,@fdate)-1)  
and location='mumbai' group by branch_cd ) b on a.branch_cd=b.branch_cd   
where tdate>=@fdate and tdate<=@tdate and location='mumbai'  
group by a.branch_cd,branch_name,Ngross_perday,Mgross_perday,Nnet_aperday,Mnet_aperday  
  
select a.branch_Cd,   
rctot=isnull(convert(money,sum(ncdx_ashare)/5.5),0)+isnull(convert(money,sum(mcdx_ashare)/5.5),0) ,   
rltot=isnull(convert(money,b.Nnet_aperday),0)+isnull(convert(money,b.Mnet_aperday),0)  
into #bb from commo_perf_eval a left outer join   
(select branch_cd, Nnet_aperday=sum(ncdx_ashare)/5.5,   
Mnet_aperday=sum(mcdx_ashare)/5.5   
 from commo_perf_eval where  
tdate>=(convert(datetime,'Feb 18 2006')-7) and tdate<=(convert(datetime,'Feb 18 2006')-1)  
and location<>'mumbai'  
group by branch_cd ) b on a.branch_cd=b.branch_cd where tdate>='Feb 18 2006' and tdate<='Feb 24 2006'   
and location<>'mumbai'  
group by a.branch_cd,branch_name,Nnet_aperday,Mnet_aperday  

select branch_cd,mctot=convert(varchar,mctot),mltot=convert(varchar,mltot),rctot='',rltot=''   
into #cc
from #aa 
union all  
select branch_cd,mctot='',mltot='',rctot=convert(varchar,rctot),rltot=convert(varchar,rltot) from #bb  
  
select branch_cd,mctot=convert(money,mctot),mltot=convert(money,mltot)  
,rctot=convert(money,rctot),rltot=convert(money,rltot) from #cc
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mrk_netbrok_1
-- --------------------------------------------------
CREATE procedure mrk_netbrok_1(@fdate as varchar(11),@tdate as varchar(11),@fdate1 as varchar(11),@tdate1 as varchar(11))        
as        
        
set nocount on        
Set Transaction isolation level read uncommitted         
declare @nodays1 as int  
declare @nodays2 as int  

----Devide by 6
---select @nodays1=count(*) from  
---(select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')  
---and sauda_Date >=@fdate and sauda_Date <=@tdate) a  

---Devide by 5
select @nodays1=count(*)-1 from  
(select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')  
and sauda_Date >=@fdate and sauda_Date <=@tdate) a  

---Devide by 6  
--select @nodays2=count(*) from (select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')   
--and sauda_Date >=(convert(datetime,@fdate)-datediff(dw,@fdate,@tdate))-1   
--and sauda_Date <=(convert(datetime,@tdate)-datediff(dw,@fdate,@tdate))-1) b  
  
---Devide by 5  
select @nodays2=count(*)-1 from (select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')   
and sauda_Date >=(convert(datetime,@fdate)-datediff(dw,@fdate,@tdate))-1   
and sauda_Date <=(convert(datetime,@tdate)-datediff(dw,@fdate,@tdate))-1) b  

/*declare @fdate as varchar(11),@tdate as varchar(11)        
set @fdate='Feb 18 2006'        
set @tdate='Feb 24 2006'        
  */      
select a.branch_Cd, mctot=isnull(convert(money,sum(ncdx_ashare)/@nodays1),0)+isnull(convert(money,sum(mcdx_ashare)/@nodays1),0) ,         
mltot=isnull(convert(money,b.Nnet_aperday),0)+isnull(convert(money,b.Mnet_aperday),0)         
into #aa        
from commo_perf_eval a left outer join         
(select branch_cd, Ngross_perday= sum(ncdx_brok)/@nodays2,Nnet_aperday=sum(ncdx_ashare)/@nodays2,         
Mgross_perday= sum(mcdx_brok)/@nodays2,Mnet_aperday=sum(mcdx_ashare)/@nodays2  from commo_perf_eval      
where tdate>=@fdate1 and tdate<=@tdate1    
and location='mumbai' group by branch_cd ) b on a.branch_cd=b.branch_cd         
where tdate>=@fdate and tdate<=@tdate and location='mumbai'        
group by a.branch_cd,branch_name,Ngross_perday,Mgross_perday,Nnet_aperday,Mnet_aperday        
        
select a.branch_Cd,         
rctot=isnull(convert(money,sum(ncdx_ashare)/@nodays1),0)+isnull(convert(money,sum(mcdx_ashare)/@nodays1),0) ,         
rltot=isnull(convert(money,b.Nnet_aperday),0)+isnull(convert(money,b.Mnet_aperday),0)        
into #bb from commo_perf_eval a left outer join         
(select branch_cd, Nnet_aperday=sum(ncdx_ashare)/@nodays2,         
Mnet_aperday=sum(mcdx_ashare)/@nodays2      
 from commo_perf_eval       
where tdate>=@fdate1 and tdate<=@tdate1    
and location<>'mumbai'        
group by branch_cd ) b on a.branch_cd=b.branch_cd where tdate>=@fdate and tdate<=@tdate    
and location<>'mumbai'        
group by a.branch_cd,branch_name,Nnet_aperday,Mnet_aperday        
      
select branch_cd,mctot=convert(varchar,mctot),mltot=convert(varchar,mltot),rctot='',rltot=''         
into #cc      
from #aa       
union all        
select branch_cd,mctot='',mltot='',rctot=convert(varchar,rctot),rltot=convert(varchar,rltot) from #bb        
        
select branch_cd,mctot=convert(money,mctot),mltot=convert(money,mltot)        
,rctot=convert(money,rctot),rltot=convert(money,rltot) from #cc      
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mrk_netbrok1
-- --------------------------------------------------
CREATE procedure mrk_netbrok1(@fdate as varchar(11),@tdate as varchar(11),@fdate1 as varchar(11),@tdate1 as varchar(11))    
as    
    
set nocount on    
Set Transaction isolation level read uncommitted     
/*declare @fdate as varchar(11),@tdate as varchar(11)    
set @fdate='Feb 18 2006'    
set @tdate='Feb 24 2006'    
  */  
select a.branch_Cd, mctot=isnull(convert(money,sum(ncdx_ashare)/5.5),0)+isnull(convert(money,sum(mcdx_ashare)/5.5),0) ,     
mltot=isnull(convert(money,b.Nnet_aperday),0)+isnull(convert(money,b.Mnet_aperday),0)     
into #aa    
from commo_perf_eval a left outer join     
(select branch_cd, Ngross_perday= sum(ncdx_brok)/5.5,Nnet_aperday=sum(ncdx_ashare)/5.5,     
Mgross_perday= sum(mcdx_brok)/5.5,Mnet_aperday=sum(mcdx_ashare)/5.5  from commo_perf_eval  
where tdate>=@fdate1 and tdate<=@tdate1
and location='mumbai' group by branch_cd ) b on a.branch_cd=b.branch_cd     
where tdate>=@fdate and tdate<=@tdate and location='mumbai'    
group by a.branch_cd,branch_name,Ngross_perday,Mgross_perday,Nnet_aperday,Mnet_aperday    
    
select a.branch_Cd,     
rctot=isnull(convert(money,sum(ncdx_ashare)/5.5),0)+isnull(convert(money,sum(mcdx_ashare)/5.5),0) ,     
rltot=isnull(convert(money,b.Nnet_aperday),0)+isnull(convert(money,b.Mnet_aperday),0)    
into #bb from commo_perf_eval a left outer join     
(select branch_cd, Nnet_aperday=sum(ncdx_ashare)/5.5,     
Mnet_aperday=sum(mcdx_ashare)/5.5     
 from commo_perf_eval   
where tdate>=@fdate1 and tdate<=@tdate1
and location<>'mumbai'    
group by branch_cd ) b on a.branch_cd=b.branch_cd where tdate>=@fdate and tdate<=@tdate
and location<>'mumbai'    
group by a.branch_cd,branch_name,Nnet_aperday,Mnet_aperday    
  
select branch_cd,mctot=convert(varchar,mctot),mltot=convert(varchar,mltot),rctot='',rltot=''     
into #cc  
from #aa   
union all    
select branch_cd,mctot='',mltot='',rctot=convert(varchar,rctot),rltot=convert(varchar,rltot) from #bb    
    
select branch_cd,mctot=convert(money,mctot),mltot=convert(money,mltot)    
,rctot=convert(money,rctot),rltot=convert(money,rltot) from #cc  
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mrk_share
-- --------------------------------------------------
CREATE procedure mrk_share(@fdate as varchar(11),@tdate as varchar(11))  
as  
set nocount on  
select mcdx_to=sum(mcdx_to)/10000000,ncdx_to=sum(ncdx_to)/10000000,  
to1=(sum(mcdx_to)+ sum(ncdx_to))/10000000  
into #aa  
from commo_perf_eval where tdate >= @fdate   
and tdate<= @tdate  
SELECT VALMCX=SUM(CONVERT(MONEY,VALUE))/100   
into #bb  
FROM BHAV_MCX_hist where convert(varchar(11),tdate)>= @fdate   
and convert(varchar(11),tdate)<= @tdate  
SELECT VALNCDX=SUM(CONVERT(MONEY,trade_val))/100   
into #cc  
FROM BHAV_ncdx_hist   
where tdate >=  @fdate and tdate<= @tdate  and trade_val<>'NA'  
select mrkshar=(to1/(valmcx+VALNCDX))*100 from #aa ,#bb, #cc  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mrk_share1
-- --------------------------------------------------
create procedure mrk_share1(@fdate as varchar(11),@tdate as varchar(11))  
as  
set nocount on  
select mcdx_to=sum(mcdx_to)/10000000,ncdx_to=sum(ncdx_to)/10000000,  
to1=(sum(mcdx_to)+ sum(ncdx_to))/10000000  
into #a  
from commo_perf_eval where tdate >= @fdate   
and tdate<= @tdate  
SELECT VALMCX=SUM(CONVERT(MONEY,VALUE))/100   
into #b  
FROM BHAV_MCX_hist where convert(varchar(11),tdate)>= @fdate   
and convert(varchar(11),tdate)<= @tdate  
SELECT VALNCDX=SUM(CONVERT(MONEY,trade_val))/100   
into #c  
FROM BHAV_ncdx_hist   
where tdate >=  @fdate and tdate<= @tdate  and trade_val<>'NA'  
select mrkshar=(to1/(valmcx+VALNCDX))*100 from #a ,#b, #c  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MRpt_ShortagePayinScrip
-- --------------------------------------------------
CREATE Proc MRpt_ShortagePayinScrip (@StatusId Varchar(15), @StatusName Varchar(25),@FromSett_no Varchar(7),@ToSett_no Varchar(7), @sett_Type Varchar(2)) As 
Set Transaction isolation level read uncommitted
select d.sett_no,d.sett_type,d.Party_Code,d.Scrip_cd,d.Series,
BuyTradeQty = BuyQty, BuyRecQty=Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End) ,
SellTradeQty = SellQty , SellRecQty=Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End) ,
BuyShortage = (Case When BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End) > 0 
		        Then BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End)
		        Else 0 End )	
	+ (Case When (SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) < 0 Then 
		Abs(SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) Else 0 End),
SellShortage = (Case When (SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) > 0 Then 
		Abs(SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) Else 0 End) +
		(Case When BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End) < 0 
	 	        Then Abs(BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End))
		        Else 0 End )
from angeldemat.msajag.dbo.DelCltView d Left Outer Join angeldemat.msajag.dbo.DelTrans de 
On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.scrip_cd = d.scrip_cd
and de.series = d.series and de.party_code = d.party_code and filler2 = 1 And ShareType <> 'AUCTION')
Where D.Sett_no >= @FromSett_No And D.Sett_no <= @ToSett_No And D.Sett_type = @Sett_Type
And D.Party_Code Like @StatusName + '%'
group by d.sett_no,d.sett_type,d.scrip_cd,d.series,d.Party_Code,d.BuyQty,SellQty
Having (Case When BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End) > 0 
		        Then BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End)
		        Else 0 End )	
	+ (Case When (SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) < 0 Then 
		Abs(SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) Else 0 End)
	- 
	(Case When (SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) > 0 Then 
		Abs(SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) Else 0 End) +
		(Case When BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End) < 0 
	 	        Then Abs(BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End))
		        Else 0 End ) < 0 
Or ( (Case When BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End) > 0 
		        Then BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End)
		        Else 0 End )	
	+ (Case When (SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) < 0 Then 
		Abs(SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) Else 0 End) = 0 
And  (Case When (SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) > 0 Then 
		Abs(SellQty - Sum(Case When DrCr = 'C' Then isnull(De.qty,0) Else 0 End)) Else 0 End) +
		(Case When BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End) < 0 
	 	        Then Abs(BuyQty - Sum(Case When DrCr = 'D' Then isnull(De.qty,0) Else 0 End))
		        Else 0 End )  > 0 )  	

Union All

select d.sett_no,d.sett_type,d.Party_Code,d.Scrip_cd,d.Series,
BuyTradeQty = 0, BuyRecQty=Sum(Case When DrCr = 'D' Then isnull(d.qty,0) Else 0 End) ,
SellTradeQty = 0, SellRecQty=Sum(Case When DrCr = 'C' Then isnull(D.qty,0) Else 0 End) ,
BuyShortage = (Case When Sum(Case When DrCr = 'C' Then isnull(D.qty,0) Else 0 End) - Sum(Case When DrCr = 'D' Then isnull(D.qty,0) Else 0 End) > 0 Then
		Sum(Case When DrCr = 'C' Then isnull(D.qty,0) Else 0 End) - Sum(Case When DrCr = 'D' Then isnull(D.qty,0) Else 0 End) Else 0 End),
SellShortage = (Case When Sum(Case When DrCr = 'D' Then isnull(D.qty,0) Else 0 End) - Sum(Case When DrCr = 'C' Then isnull(D.qty,0) Else 0 End) > 0 Then
		Sum(Case When DrCr = 'D' Then isnull(D.qty,0) Else 0 End) - Sum(Case When DrCr = 'C' Then isnull(D.qty,0) Else 0 End) Else 0 End)
from angeldemat.msajag.dbo.DelTrans d 
Where D.Sett_no >= @FromSett_No And 
D.Sett_no <= @ToSett_No And D.Sett_type = @Sett_Type
And Filler2 = 1 And TrType <> 906 And D.Party_Code Not in ( Select Party_Code From angeldemat.msajag.dbo.DeliveryClt DE 
Where de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.scrip_cd = d.scrip_cd
and de.series = d.series and de.party_code = d.party_code )
And ShareType <> 'AUCTION'
And D.Party_Code Like @StatusName + '%' 
group by d.sett_no,d.sett_type,d.Party_Code,d.scrip_cd,d.series
having Sum(Case When DrCr = 'D' Then isnull(d.qty,0) Else 0 End) > Sum(Case When DrCr = 'C' Then isnull(D.qty,0) Else 0 End) 
Order BY d.sett_no,d.sett_type,d.scrip_cd,d.series,d.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NewBBGSPostest
-- --------------------------------------------------

CREATE    Procedure NewBBGSPostest ( 
@Sett_no Varchar(10), 		 ---1  Settlement No(from)
@Tosett_No Varchar(10),		 ---2  Settlement no (to)
@Sett_type Varchar(3),		 ---3  Settlement type 
@Sauda_date Varchar(11),	 ---4 Sauda_date (from)
@ToDate Varchar(11),		 ---5 Sauda_date (to)
@FromScrip Varchar(10),		 ---6 From scrip_cd (from)
@ToScrip Varchar(10),		 ---7 To Scrip_cd (to)
@From Varchar(20), 		 ---8  From Consol
@To Varchar (20), 		 ---9  To Consol
@Consol Varchar(10),		 ---10  Consol indicates that whether is "Party_code","Trader","Sub Broker","Branch"
@Detail Varchar(3),		 ---11  This is other details in Query "B" = "Bill","C" = "Confirmation","P" = "Position","Br" = "Brokerage","S" = "Sauda summary"
@Level  SmallInt,                                  --- 12 Will be used to Select  Level of Consolidation Default 0
@GroupF Varchar(500),		 ---13 (any necessary Grouping) This can be defined on the fly by developer
@OrderF Varchar(500),		 ---14 (any necessary Order by) This can de defined on the fly by developer 
@Use1 Varchar(10),                    --- 15 To be used later  for other purposes
@statusid varchar(15),
@statusname varchar(25) )

As
Declare
@@Getstyle as Cursor,
@@Sett_no As Varchar(10),
@@Fromparty_code as varchar(10),
@@Toparty_code  As Varchar(10),
@@FromSett_type As Varchar(3),
@@ToSett_type As Varchar(3),
@@Myquery As Varchar(4000),
@@MyReport As Varchar(50),
@@MyOrder As Varchar(1500),
@@Mygroup As Varchar(1500),
@@Part As varchar(8000),
@@Part1 As varchar(8000),
@@Part2 As Varchar(8000),
@@Part3 As Varchar(8000),
@@Part4 As Varchar(8000),
@@Part5 As Varchar(8000),
@@Part6 As Varchar(8000),
@@WiseReport As Varchar(10),
@@Dummy1 As Varchar(1000),
@@Dummy2 As Varchar(1000),
@@FromFamily As varchar(10),
@@ToFamily  As Varchar(10),
@@FromBranch_cd As varchar(15),
@@ToBranch_cd  As Varchar(15),
@@FromSub_Broker As varchar(15),
@@ToSub_Broker  As Varchar(15),
@@FromTrader As varchar(15),
@@ToTrader  As Varchar(15),
@@FromRegion Varchar(15),
@@ToRegion Varchar(15),
@@Dummy3 As Varchar(1000),
@@FromTable As Varchar(1000),    --------------------   This string will enable us to code conditions Like From settlement
@@SelectFlex As Varchar (2000),   ---------------------  This String will enable us to code Flexible Select Conditions 
@@SelectFlex1 As Varchar (2000),   ---------------------  This String will enable us to code Flexible Select Conditions 
@@SelectBody As Varchar(8000),  ---------------------   This is regular Select Body
@@SelectBody1 As Varchar(8000),  ---------------------   This is regular Select Body
@@WhereText As Varchar(8000),  ---------------------  This will be used for Coding Where condition  
@@FromTable1 As Varchar(1000), ---------------------   This is Another String that can be used for  
@@Wherecond1 As Varchar(2000)

/* To reduce the number of queries we have joined maximum number of parameters with ranges*/
/* Hence we are extracting ranges if the partmeter passed is %  or ""   */
/* If the parameter is passed then we make that same parameter as from <-----> To  */

/* Here I will define rules for various  */
-----------------------------------------------------------------------------------------
If ((@Consol = "PARTY_CODE" Or @Consol = "BROKER")) And  ((@From <> "") And (@To = "" ) ) 
Begin
          Select @@FromParty_code = @From
          Select @@ToParty_code = @From 
End

If ((@Consol = "PARTY_CODE" Or @Consol = "BROKER")) And  ((@From <> "") And (@To <> "" ) ) 
Begin
          Select @@FromParty_code = @From
          Select @@ToParty_code = @To 
End

If (@Consol = "FAMILY") And  ((@From <> "") And (@To <> "" ) ) 
Begin
          Select @@FromFamily = @From
          Select @@ToFamily = @To 
          Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code) From Client2, Client1  Where  Client2.Cl_code = Client1.Cl_code and Client1.Family between @@FromFamily  And @@ToFamily
End
else If (@Consol = "FAMILY") And  ((@From = "") And (@To = "" ) ) 
Begin          
          Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code), @@FromFamily = Min(Family) , @@ToFamily = Max(Family) From Client2, Client1  Where  Client2.Cl_code = Client1.Cl_code 
End

If (@Consol = "Branch_cd") And  ((@From <> "") And (@To <> "" ) ) 
Begin
          Select @@FromBranch_cd = @From
          Select @@ToBranch_cd = @To 
          Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code) From Client2, Client1 Where Client2.Cl_code = Client1.Cl_code and Client1.Branch_cd  Between @@FromBranch_cd  And @@ToBranch_cd
End
Else If (@Consol = "Branch_cd") And  ((@From = "") And (@To = "" ) ) 
Begin
          Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code),@@FromBranch_Cd = Min(Branch_Cd), @@ToBranch_Cd = Max(Branch_Cd) From Client2, Client1 Where Client2.Cl_code = Client1.Cl_code 
End

If (@Consol = "Trader") And  ((@From <> "") And (@To <> "" ) ) 
Begin
          Select @@FromTrader = @From
          Select @@ToTrader = @To 
          Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code) From Client2, Client1 Where Client2.Cl_code = Client1.Cl_code and Client1.Trader Between @@FromTrader  And @@ToTrader
End
else If (@Consol = "Trader")  And ( ( @From = "" ) And ( @To = "" ) )  
begin
	Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code), @@FromTrader=Min(Trader),@@ToTrader=Max(Trader) From Client2, Client1 Where Client2.Cl_code = Client1.Cl_code 
End


If (@Consol = "Sub_Broker") And  ((@From <> "") And (@To <> "" ) ) 
Begin
          Select @@FromSub_Broker = @From
          Select @@ToSub_broker = @To 
          Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code) From Client2, Client1 Where Client2.Cl_code = Client1.Cl_code and Client1.Sub_Broker Between @@FromSub_Broker  And @@ToSub_Broker      	
end
else If (@Consol = "Sub_Broker")  And ( ( @From = "" ) And ( @To = "" ) )  
begin
	Select @@FromParty_code = Min(Party_code) , @@ToParty_code = Max(Party_code), @@FromSub_broker=Min(Sub_Broker),@@ToSub_Broker=Max(Sub_Broker) From Client2, Client1 Where Client2.Cl_code = Client1.Cl_code 
End
else If (@Consol = "REGION")  And  ((@From <> "") And (@To <> "" ) ) 
begin
     Select @@ToParty_code =  Max(Party_code) ,@@FromParty_code = Min(Party_code) From Details 
     Select @@FromRegion = @From 
     Select @@ToRegion = @To 	
End

else If (@Consol = "REGION")  And  ((@From = "") And (@To = "" ) ) 
begin
     Select @@ToParty_code =  Max(Party_code) ,@@FromParty_code = Min(Party_code) From Details 
     Select @@FromRegion = Min(Region), @@ToRegion=Max(Region) From CmBillValan
End

If ( (@Consol = "PARTY_CODE" Or @Consol = "BROKER")) And ( ( @From = "" ) And ( @To = "" ) ) 
Begin
     Select @@ToParty_code =  Max(Party_code) ,@@FromParty_code = Min(Party_code) From Details 
End
-----------------------------------------------------------------------------------------

If @Sett_type  <>  "%" And @Sett_Type <> ''
Begin
     Select @@FromSett_type = @Sett_type
     Select @@ToSett_type = @Sett_type
End

If (@Sett_type  =  "%" Or @Sett_Type = '' )
Begin
      Select @@FromSett_type = Min(Sett_type), @@ToSett_type = Max(Sett_type) From Details
		Print 'Sett Type Min = ' + @@FromSett_type
		Print 'Sett Type Max = ' + @@ToSett_type
End

----------------------------------------------------------------------------------------

If  ( (@FromScrip = "") And  (@ToScrip = "") )
   Select @FromScrip = Min(bsecode) ,@ToScrip = Max(bsecode) From Scrip2

If (@FromScrip = "")
   Select @FromScrip = Min(bsecode) From Scrip2

If (@ToScrip = "")
   Select @ToScrip = Max(bsecode) From Scrip2

-----------------------------------------------------------------------------------------
If @Tosett_no = "" 
   Set @Tosett_no = @Sett_no

----------------------------------------------------Find Settno From To From Sauda_date  Range -------------------------------------------------------------------------------------------------------
If ( (@Sett_no = "" ) And ( Len(@Sauda_date) > 1)) 
Begin
         Select @sett_no = Min(Sett_no) from sett_mst where Sett_type Between  @@FromSett_type And @@Tosett_type  and Start_Date >= @Sauda_date + " 00:00"  and End_date <= @Todate + " 23:59:59"   
         If @Todate = "" 
        Set @Tosett_no = @Sett_no
End

If ( (@ToSett_no = "" ) And ( Len(@Todate) > 1)) 
Begin
        Select @Tosett_no = Max(Sett_no) from sett_mst where Sett_type Between  @@FromSett_type  and @@ToSett_type and Start_Date >= @Sauda_date + " 00:00" and End_date <= @Todate  + " 23:59:59" 
End
-----------------------------------------------------------------------------------------

Select @Sauda_date = Ltrim(Rtrim(@Sauda_date))
If Len(@Sauda_date) = 10 
Begin
          Set @Sauda_date = STUFF(@Sauda_date, 4, 1,"  ")
End

Select @Todate = Ltrim(Rtrim(@Todate))

If Len(@Todate) = 10 
Begin
          Set @Todate = STUFF(@Todate, 4, 1,"  ")
End
--------------------------------------------------- Find SaudaDate From To From Settlement Range  -------------------------------------------------------------------------------------------------------
If ( @Todate  = "" ) 
Begin
	--Select @Todate = End_date from sett_mst where Sett_type = @Sett_type and Sett_no = @ToSett_no 
	Select @Todate = Max(End_date) from sett_mst where Sett_type Between  @@FromSett_type And @@Tosett_type and Sett_no between @Sett_no And @ToSett_no
	Print 'Set No : ' + @Sett_no
	Print 'Set Type : ' + @Sett_type
	Print 'To Sauda Date : ' + @Todate
End

If ( @Sauda_date  = "" ) 
Begin
	--Select @Sauda_date = Start_date from sett_mst where Sett_type = @Sett_type and Sett_no = @Sett_no 
	Select @Sauda_date = Min(Start_date) from sett_mst where Sett_type Between  @@FromSett_type And @@Tosett_type and Sett_no between @Sett_no And @ToSett_no
	Print 'Set No : ' + @Sett_no
	Print 'Set Type : ' + @Sett_type
	Print 'From Sauda Date : ' + @Sauda_date
End
-----------------------------------------------------------------------------------------

If @Detail = "B" 
   Set @@MyReport = "Bill"
 
If @Detail = "C" 
   Set @@MyReport = "Confirmation"

If @Detail = "P" 
   Set @@MyReport = "Position"

If @Detail = "BR" 
   Set @@MyReport = "Brokerage"

If @Detail = "S" 
   Set @@MyReport = "SaudaSummary"

------------------------------------- We Will Select From  Various Order By Options -------------------------------------- 


If @OrderF = "0"       ------------------------------ To be used For Contract / Bill Printing  ------------------------
Begin
          If @Consol = "Party_code"
             Set @@MyOrder = " Order by S.party_code, S.Sett_No, S.Sett_Type,  S.Scrip_Cd Asc, S.Series, TradeTyp , BillNo, ContractNo, S.Sauda_date Option (Fast 10 )  "
End
	
If @OrderF = "1"  ------------------------ To be used for Gross position Across Range ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order   by Region  Option (Fast 1 ) "
          If @Consol = "Party_code"
             Set  @@MyOrder = " Order   by party_code  Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order  by Branch_cd  Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  by Family Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by Trader Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order  by Sub_Broker Option (Fast 1 ) "
End

If @OrderF = "1.1"  ------------------------ To be used for Gross position Across Range ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by s.scrip_cd, s.series, Region  Option (Fast 1 ) "
          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by s.scrip_cd, s.series, party_code  Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order by s.scrip_cd, s.series, Branch_cd  Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order by s.scrip_cd, s.series, Family Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order by s.scrip_cd, s.series, Trader Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order by s.scrip_cd, s.series, Sub_Broker Option (Fast 1 ) "
End

If @OrderF = "2"   ------------------------ To be used for Net position Across Settlement  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order  by  S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Party_code"
             Set  @@MyOrder = " Order  by  S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder  = " Order  by S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder  = " Order  by S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder  = " Order  by S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Sub_broker"
     Set  @@MyOrder = " Order by S.Sett_no,S.Sett_type Option (Fast 1 )"
End


If @OrderF = "3"   ------------------------ To be used for Net position Across Settlement,Scrip,Series  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order  by S.Scrip_cd ,S.Series Option (Fast 1 ) "

          If @Consol = "Party_code"
             Set  @@MyOrder = " Order  by S.Scrip_cd ,S.Series Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder  = " Order  by S.Scrip_cd ,S.Series  Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder  = " Order  by S.Scrip_cd ,S.Series  Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder  = " Order  by S.Scrip_cd ,S.Series  Option (Fast 1 ) "
          If @Consol = "Sub_broker"
     Set  @@MyOrder = " Order by S.Scrip_cd ,S.Series  Option (Fast 1 )"
End

If @OrderF = "3.1"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Tmark  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by Region , S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by S.party_code , S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order by Branch_cd  ,S.Sett_no,S.Sett_type ,S.Scrip_cd , S.Series Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  by Family , S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by Trader  , S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order  by Sub_Broker  , S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 )"
End

If @OrderF = "3.11"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Tmark  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by Region,S.party_code  Option (Fast 1 ) "
          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by S.party_code  Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order by Branch_cd  ,S.Party_code Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  by Family , S.Party_code Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by Trader  , S.Party_code Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order  by Sub_Broker  , S.Party_code Option (Fast 1 )"
End

If @OrderF = "3.2"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Tmark  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by Region , S.Sauda_date ,S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "

          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by S.party_code , S.Sauda_date ,S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order by Branch_cd  ,S.Sauda_date ,S.Sett_no,S.Sett_type ,S.Scrip_cd , S.Series Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  by Family , S.Sauda_date ,S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by Trader  , S.Sauda_date ,S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order  by Sub_Broker  , S.Sauda_date ,S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 )"
End

If @OrderF = "3.3"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Tmark  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by Region  ,S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by S.party_code  ,S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order by Branch_cd, S.party_code, S.Scrip_cd , S.Series Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  by Family , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by Trader  , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order  by Sub_Broker  , S.Scrip_cd, S.Series Option (Fast 1 )"
End

If @OrderF = "3.4"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Tmark  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by S.Sett_no,S.Sett_type ,S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by S.Sett_no,S.Sett_type ,S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order by S.Sett_no,S.Sett_type  ,S.Scrip_cd , S.Series Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  byS.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by S.Sett_no,S.Sett_type , S.Scrip_cd, S.Series Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order  by S.Sett_no,S.Sett_type  , S.Scrip_cd, S.Series Option (Fast 1 )"
End

If @OrderF = "4"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Sauda_date,Tmark  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by S.Sauda_date , S.Sett_no,S.Sett_type  Option (Fast 1 ) "          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by S.Sauda_date , S.Sett_no,S.Sett_type  Option (Fast 1 ) "          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order  by S.Sauda_date  , S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  by S.Sauda_date  , S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by S.Sauda_date  , S.Sett_no,S.Sett_type Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order by S.Sauda_date  , S.Sett_no,S.Sett_type Option (Fast 1 ) "
End

If @OrderF = "4.1"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Sauda_date,Tmark  ----------------------
Begin
          If @Consol = "Region"
             Set  @@MyOrder = " Order by Region  , S.Sett_no,S.Sett_type , S.Scrip_cd,S.Series , S.Sauda_date Option (Fast 1 ) "

          If @Consol = "Party_code"
             Set  @@MyOrder = " Order by S.party_code  , S.Sett_no,S.Sett_type , S.Scrip_cd,S.Series , S.Sauda_date Option (Fast 1 ) "
          If @Consol = "Branch_Cd"
             Set  @@MyOrder = " Order  by Branch_cd  ,S.Sett_no,S.Sett_type , S.Scrip_cd,S.Series,S.Sauda_date Option (Fast 1 ) "
          If @Consol = "Family"
             Set  @@MyOrder = " Order  by Family  ,S.Sett_no,S.Sett_type , S.Scrip_cd,S.Series , S.Sauda_date Option (Fast 1 ) "
          If @Consol = "Trader"
             Set  @@MyOrder = " Order  by Trader  , S.Sett_no,S.Sett_type , S.Scrip_cd,S.Series, S.Sauda_date Option (Fast 1 ) "
          If @Consol = "Sub_broker"
             Set  @@MyOrder = " Order by Sub_Broker , S.Sett_no,S.Sett_type , S.Scrip_cd,S.Series ,S.Sauda_date Option (Fast 1 ) "
End


-------------------------------------  End Of Select  Order By Options  ----------------------------------------------------


Set @@FromTable = " From CmBillValan S"

Print 'CONSOL : ' + @Consol
Print 'GROUPF : ' + @GroupF


------------------------------------- We Will Decide Various Group By Options -------------------------------------- 

If @GroupF = "0"    ----------------------  To be Used for Contract or Bills ----------------------
Begin
     If @Consol = "Party_code" 
     Set  @@MyGroup =  " Group by Party_Code , Party_Name, Branch_Cd, Sub_Broker, Trader, Family, Sett_no , Sett_type  , Scrip_cd  , Series , Scrip_Name, Sauda_date  , left(convert(varchar,sauda_date,109),11), ContractNo , Billno , TradeType , Start_Date
, End_Date"
     Set  @@SelectFlex =  " Select Party_Code , Long_Name=Party_Name, Branch_Cd, Sub_Broker, Trader, Family, Sett_no , Sett_type  , Scrip_cd  , Series , Scrip_Name, Sauda_date = left(convert(varchar,sauda_date,109),11), ContractNo , Billno, PTradedqty = S
um(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokD
el) , BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) 
Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  T
rdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg),  Tr
ade_Date = S.Sauda_date , TradeTyp = (Case when TradeType like  '%BF' then 1 else case when TradeType like  '%CF' then 3 else case when TradeType like  '%R' then 4 else 2 end end end), TrdType = TradeType, Start_Date, End_Date "
End

If @GroupF = "1"  ------------------------ To be used for Gross position Across Range ----------------------
Begin
     If @Consol = "Region"
     Begin
          Set @@MyGroup = " Group by Region, MemberType, CompanyName"
          Set @@SelectFlex =  " Select Region, long_name=Region,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel), BuyBrokerage = Sum(PBrokTrd) , SelBrokerage
= Sum(SBrokTrd) , BuyDeliveryChrg = Sum(PBrokDel), SellDeliveryChrg = Sum(SBrokDel), ClientType = 1, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , 
SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+S
AmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(
Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End

     If @Consol = "Party_code"
     Begin
          Set @@MyGroup = " Group by S.Party_code, Party_name,ClientType ,MemberType, CompanyName"
          Set @@SelectFlex =  " Select Party_Code, long_name=Party_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel), BuyBrokerage = Sum(PBrokTrd) , SelB
rokerage= Sum(SBrokTrd) , BuyDeliveryChrg = Sum(PBrokDel), SellDeliveryChrg = Sum(SBrokDel), ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End
) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtT
rd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=
Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Branch_Cd"
     Begin 
          Set  @@MyGroup = " Group by Branch_cd, ClientType, MemberType, CompanyName"
          Set @@SelectFlex =  " Select long_name=branch_cd,Branch_cd,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBroke
rage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , 
SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+
SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Su
m(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName ,pnl = sum(samttrd-pamttrd)" 
     End
     If @Consol = "Family"
     Begin 
          Set  @@MyGroup = " Group by Family, Family_Name,ClientType , MemberType, CompanyName"
          Set @@SelectFlex =  " Select Family, long_name=Family_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBroke
rage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , 
SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),    PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd
+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Su
m(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End 
     If @Consol = "Trader"
     Begin 
          Set  @@MyGroup = " Group by Trader ,MemberType,ClientType, CompanyName "
          Set @@SelectFlex =  " Select trader,long_name=Trader,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= 
Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarke
trate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDe
l) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Seb
i_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName ,pnl = sum(samttrd-pamttrd)" 
     End       
     If @Consol = "Sub_broker"
     Begin 
          Set  @@MyGroup = " Group by Sub_broker ,MemberType ,ClientType, CompanyName "                    
          Set @@SelectFlex =  " Select Sub_broker,long_name=Sub_broker,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBro
kerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) 
, SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTr
d+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=
Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
End

If @GroupF = "1.1"  ------------------------ To be used for Gross position Across Range ----------------------
Begin
     If @Consol = "Region"
     Begin
          Set @@MyGroup = " Group by Scrip_Cd, Series, Scrip_Name, Region,MemberType, CompanyName"
          Set @@SelectFlex =  " Select Scrip_Cd, Series, Scrip_Name, Region, long_name = Region,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage
 = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTr
d + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) 
, SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_ta
x=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End

     If @Consol = "Party_code"
     Begin
          Set @@MyGroup = " Group by Scrip_Cd, Series, Scrip_Name, S.Party_code, Party_name,ClientType ,MemberType, CompanyName"
          Set @@SelectFlex =  " Select Scrip_Cd, Series, Scrip_Name, Party_Code, long_name=Party_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBro
kerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(
PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1
 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),T
urn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Branch_Cd"
     Begin 
          Set  @@MyGroup = " Group by Scrip_Cd, Series, Scrip_Name, Branch_cd, ClientType, MemberType, CompanyName"
          Set @@SelectFlex =  " Select Scrip_Cd, Series, Scrip_Name, long_name=branch_cd,Branch_cd,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBroker
age = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQt
yTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 En
d) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn
_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName ,pnl = sum(samttrd-pamttrd)" 
     End
     If @Consol = "Family"
     Begin 
          Set  @@MyGroup = " Group by Scrip_Cd, Series, Scrip_Name, Family, Family_Name,ClientType , MemberType, CompanyName"
          Set @@SelectFlex =  " Select Scrip_Cd, Series, Scrip_Name, Family, long_name=Family_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBroker
age = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQt
yTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 En
d) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn
_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End 
     If @Consol = "Trader"
     Begin 
          Set  @@MyGroup = " Group by Scrip_Cd, Series, Scrip_Name, Trader ,MemberType,ClientType, CompanyName "
          Set @@SelectFlex =  " Select Scrip_Cd, Series, Scrip_Name, trader,long_name=Trader,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = 
Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd +
 PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , S
Netrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=S
um(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName ,pnl = sum(samttrd-pamttrd)" 
     End       
     If @Consol = "Sub_broker"
     Begin 
          Set  @@MyGroup = " Group by Scrip_Cd, Series, Scrip_Name, Sub_broker ,MemberType ,ClientType, CompanyName "                    
          Set @@SelectFlex =  " Select Scrip_Cd, Series, Scrip_Name, Sub_broker,long_name=Sub_broker,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrok
erage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(P
QtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 
End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Tu
rn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
End

If @GroupF = "2"   ------------------------ To be used for Net position Across Settlement  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set @@MyGroup = " Group by Sett_No, Sett_Type,Start_Date,End_Date,MemberType, CompanyName "
          Set @@SelectFlex = " Select Sett_No, Sett_Type,Start_Date,End_Date,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , 
SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMa
rketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAm
tDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(S
ebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Region"
     Begin 
          Set @@MyGroup = " Group By Sett_No, Sett_Type,Start_Date,End_Date,MemberType, CompanyName "
          Set @@SelectFlex = " Select Sett_No, Sett_Type,Start_Date,End_Date,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , 
SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMa
rketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAm
tDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Se
bi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  

     If @Consol = "Branch_Cd"
     Begin 
          Set @@MyGroup = " Group By Sett_No, Sett_Type,Start_Date,End_Date,MemberType, CompanyName "
          Set @@SelectFlex = " Select Sett_No, Sett_Type,Start_Date,End_Date,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , 
SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMa
rketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAm
tDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Se
bi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Family"
     Begin 
          Set @@MyGroup =  " Group By Sett_No, Sett_Type,Start_Date,End_Date,MemberType, CompanyName "
          Set @@SelectFlex =  " Select Sett_No, Sett_Type,Start_Date,End_Date,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) ,
 SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SM
arketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SA
mtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(
Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End                   
     If @Consol = "Trader"
     Begin 
          Set @@MyGroup =  " Group By Sett_No, Sett_Type,Start_Date,End_Date,MemberType, CompanyName "
          Set @@SelectFlex =  " Select Sett_No, Sett_Type,Start_Date,End_Date,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) ,
 SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SM
arketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SA
mtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(
Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End 
     If @Consol = "Sub_broker"
     Begin 
          Set @@MyGroup =  " Group By Sett_No, Sett_Type,Start_Date,End_Date,MemberType, CompanyName "
          Set @@SelectFlex =  " Select Sett_No, Sett_Type,Start_Date,End_Date,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) ,
 SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SM
arketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SA
mtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(
Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
End


If @GroupF = "3"   ------------------------ To be used for Net position Across Settlement,Scrip,Series  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set @@MyGroup = " Group by Scrip_Cd,Series,Scrip_Name,MemberType, CompanyName "
          Set @@SelectFlex = " Select Scrip_Cd, Series, Scrip_Name, PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBroker
age= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate 
= ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (
Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),
Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Region"
     Begin 
          Set @@MyGroup = " Group by Scrip_Cd,Series,Scrip_Name,MemberType, CompanyName "
          Set @@SelectFlex = " Select Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage
= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = (
 Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Cas
e When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins
_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  

     If @Consol = "Branch_Cd"
     Begin 
          Set @@MyGroup = " Group by Scrip_Cd,Series,Scrip_Name,MemberType, CompanyName "
          Set @@SelectFlex = " Select Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage
= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = (
 Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Cas
e When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins
_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Family"
     Begin 
          Set @@MyGroup = " Group by Scrip_Cd,Series,Scrip_Name,MemberType, CompanyName "
          Set @@SelectFlex = " Select Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage
= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = (
 Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Cas
e When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins
_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End                   
     If @Consol = "Trader"
     Begin 
          Set @@MyGroup = " Group by Scrip_Cd,Series,Scrip_Name,MemberType, CompanyName "
          Set @@SelectFlex = " Select  Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerag
e= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = 
( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Ca
se When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),In
s_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End 
     If @Consol = "Sub_broker"
     Begin 
          Set @@MyGroup = " Group by Scrip_Cd,Series,Scrip_Name,MemberType, CompanyName "
          Set @@SelectFlex = " Select Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage
= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = (
 Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Cas
e When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins
_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
End

If @GroupF = "2.11"
Begin
     If @Consol = "Region"
     Begin
          Set  @@MyGroup = " Group By Region,Branch_cd,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select  Region,Branch_cd,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(S
BrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(S
Rate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When 
Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Su
m(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) "  
     End
End


If @GroupF = "3.11"   ------------------------ To be used for Net position Across Settlement ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set  @@MyGroup = " Group By Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select Party_Code, Party_Name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , Sel
Brokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarke
trate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDe
l) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi
_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 

     End 
     If @Consol = "Region"
     Begin
          Set  @@MyGroup = " Group By Region,Branch_cd,Party_Code, Party_Name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select  Region,Branch_cd,Party_Code, Party_Name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = S
um(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) E
lse 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( 
Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),
Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) "  
     End

     If @Consol = "Branch_Cd"
     Begin
          Set  @@MyGroup = " Group By Branch_cd,Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select  Branch_cd,Party_code,Party_name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrok
Trd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 En
d) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmt
Trd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax
=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) "  
     End
     If @Consol = "Family"
     Begin
/*          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Family,Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Family,Party_code,Party_name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBroker
age = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQt
yDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetra
te = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Tur
n_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) "  */
          Set  @@MyGroup = " Group By Family,Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select Family,Party_code,Party_name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd)
 , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) ,
 SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+
SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum
(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 


     End
     If @Consol = "Trader"
     Begin
/*          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Trader,Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trader,Party_code,Party_name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBroker
age = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQt
yDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetr
ate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Tur
n_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
*/
          Set  @@MyGroup = " Group By Trader,Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select Trader,Party_code,Party_name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd)
 , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) ,
 SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd
+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum
(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 

     End
     If @Consol = "Sub_broker"
     Begin
/*          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sub_broker,Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Sub_broker,Party_code,Party_name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBr
okerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd +
 PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , S
Netrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum
(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
*/
          Set  @@MyGroup = " Group By Sub_broker,Party_code,Party_name,ClientType,MemberType, CompanyName "
          Set  @@SelectFlex =  " Select Sub_broker,Party_code,Party_name,ClientType,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrok
Trd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 En
d) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAm
tTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax
=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 

     End
End

If @GroupF = "3.1"   ------------------------ To be used for Net position Across Settlement,Scrip,Series  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Party_Code, Party_Name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel)
,BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQty
Trd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End
) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_
tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Region"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Region,Branch_cd,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Region,Region,Branch_cd,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt =
 Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQ
tyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTr
d + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Su
m(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End 
     If @Consol = "Branch_Cd"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Branch_cd,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Branch_cd,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd +
 SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 The
n Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) E
lse 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Ta
x),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Family"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Family,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Family,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SA
mtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then S
um(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else
 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),
Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Trader"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Trader,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trader,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SA
mtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then S
um(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Els
e 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),
Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Sub_broker"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sub_broker,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Sub_broker,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd 
+ SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Th
en Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel)
 Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_T
ax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
End


If @GroupF = "3.2"   ------------------------ To be used for Net position Across Settlement,Scrip,Series  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Party_Code, Party_Name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PA
mtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) ,
 PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDe
l) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum
(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 


     End 

     If @Consol = "Branch_Cd"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Region,Branch_cd,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Region,Branch_cd,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = 
Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillS
Amt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(
PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAm
t), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samtt
rd-pamttrd) " 
     End

     If @Consol = "Branch_Cd"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Branch_cd,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Branch_cd,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAm
tTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = S
um(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd
 + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), Ser
InEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamt
trd) " 
     End
     If @Consol = "Family"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Family,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Family,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTr
d + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(
Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd +
 PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInE
x=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd
) " 
     End
     If @Consol = "Trader"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Trader,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Trader,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTr
d + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(
Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + 
PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInE
x=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd
) " 
     End
     If @Consol = "Sub_broker"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Sauda_Date,left(convert(varchar,sauda_date,109),11),Sub_broker,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Sub_broker,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PA
mtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = 
Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTr
d + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), Se
rInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pam
ttrd) " 
     End
End

If @GroupF = "3.3"   ------------------------ To be used for Net position Across Settlement,Scrip,Series  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set  @@MyGroup = " Group By Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Party_Code, Party_Name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum
(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else
 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),    PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( S
um(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),S
ebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End 
     If @Consol = "Region"
     Begin
          Set  @@MyGroup = " Group By Region,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Region,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage
 = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDe
l) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate
 = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_T
ax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End

     If @Consol = "Branch_Cd"
     Begin
          Set  @@MyGroup = " Group By Branch_cd,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Branch_cd,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBroker
age = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQt
yDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetr
ate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Tur
n_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Family"
     Begin
          Set  @@MyGroup = " Group By Family,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Family,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage
 = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDe
l) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate
 = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_T
ax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Trader"
     Begin
          Set  @@MyGroup = " Group By Trader,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Trader,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage
 = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDe
l) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate
 = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_T
ax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Sub_broker"
     Begin
          Set  @@MyGroup = " Group By Sub_broker,Party_code,Party_name,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sub_broker,Party_code,Party_name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBroke
rage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQ
tyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNet
rate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Tu
rn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
End

If @GroupF = "3.4"   ------------------------ To be used for Net position Across Settlement,Scrip,Series  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBr
okTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 E
nd) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),    PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(S
AmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_
tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End 
     If @Consol = "Region"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBr
okTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 
End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(S
AmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_t
ax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Branch_Cd"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBr
okTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 
End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(S
AmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_t
ax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Family"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBr
okTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 
End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(S
AmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_t
ax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Trader"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBr
okTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 
End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(S
AmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_t
ax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
     If @Consol = "Sub_broker"
     Begin
          Set  @@MyGroup = " Group By Sett_No, Sett_Type,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBr
okTrd) , SelBrokerage= Sum(SBrokTrd)  ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 
End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SA
mtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt=Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_t
ax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End
End

If @GroupF = "4"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Tmark  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),MemberType, CompanyName "          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,s
auda_date,109),11),PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDe
l) ,SellDeliveryChrg = Sum(SBrokDel) , BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel)
 > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQty
Trd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg
),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Region"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),MemberType, CompanyName "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STrade
dAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd 
+ PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),    PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(
PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_T
ax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  

     If @Consol = "Branch_Cd"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),MemberType, CompanyName "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STrade
dAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd 
+ PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),    PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(
PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_T
ax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Family"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),MemberType, CompanyName "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STrade
dAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd 
+ PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),    PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(
PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_T
ax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Trader"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),MemberType, CompanyName "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STrade
dAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd
 + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(
PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_
Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Sub_broker"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),MemberType, CompanyName "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STrade
dAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) ,  BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd
 + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),    PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum
(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ), TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_
Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName ,pnl = sum(samttrd-pamttrd)" 
     End  
End

If @GroupF = "4.1"  ------------------------ To be used for Net position Across Settlement,Scrip,Series,Tmark  ----------------------
Begin
     If @Consol = "Party_code"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Party_code,Party_name,ClientType,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "          Set  @@SelectFlex =  " Select Sett_No, Sett_Type,T
rade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Party_Code, Party_Name,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Su
m(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyT
rd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Su
m(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExServic
e_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Region"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Region,Branch_cd,ClientType,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Region,Branch_cd,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) 
,STradedQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Sam
t) , PMarketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + Pa
mtDel) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx
=Sum(SerInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd)
 " 
     End  

     If @Consol = "Branch_Cd"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Branch_cd,ClientType,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Branch_cd,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STrade
dQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PM
arketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) 
/ Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(Se
rInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Family"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Family,ClientType,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Family,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQt
y = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMark
etrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / C
ase When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerIn
Ex),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Trader"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Trader,ClientType,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Trader,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STradedQt
y = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , PMark
etrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel) / C
ase When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(SerIn
Ex),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName,pnl = sum(samttrd-pamttrd) " 
     End  
     If @Consol = "Sub_broker"
     Begin 
          Set  @@MyGroup = " Group by Sett_No, Sett_Type,Sauda_Date,left(convert(varchar,sauda_date,109),11),Sub_broker,ClientType,MemberType, CompanyName,Scrip_Cd,Series,Scrip_Name "
          Set  @@SelectFlex =  "Select Sett_No, Sett_Type,Trade_Date = S.Sauda_date,Sauda_date = left(convert(varchar,sauda_date,109),11),Sub_broker,Scrip_Cd,Series,Scrip_Name,PTradedqty = Sum(PQtyTrd + PQtyDel) ,PtradedAmt = Sum(PAmtTrd + PAmtDel) ,STrad
edQty = Sum(SQtyTrd + SQtyDel), STradedAmt = Sum(SAmtTrd + SAmtDel),BuyBrokerage = Sum(PBrokTrd) , SelBrokerage= Sum(SBrokTrd) ,BuyDeliveryChrg = Sum(PBrokDel) ,SellDeliveryChrg = Sum(SBrokDel) , ClientType, BillPamt = Sum(Pamt) , BillSAmt = Sum(Samt) , P
Marketrate = ( Sum(PRate) / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SMarketrate = ( Sum(SRate) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),   PNetrate = ( Sum(PAmtTrd + PamtDel)
 / Case When Sum(PQtyTrd + PQtyDel) > 0 Then Sum(PQtyTrd + PQtyDel) Else 1 End) , SNetrate = ( Sum(SAmtTrd+SAmtDel) / (Case When Sum(SQtyTrd + SQtyDel) > 0 Then Sum(SQtyTrd + SQtyDel) Else 1 End ) ),  TrdAmt= Sum(TrdAmt) ,DelAmt=Sum(DelAmt), SerInEx=Sum(S
erInEx),Service_Tax= Sum(Service_Tax) ,ExService_Tax= Sum(ExService_Tax),Turn_tax=Sum(Turn_Tax),Sebi_tax=Sum(Sebi_Tax),Ins_chrg=Sum(Ins_Chrg),Broker_Chrg=Sum(Broker_Chrg),Other_Chrg=Sum(Other_Chrg), MemberType, CompanyName ,pnl = sum(samttrd-pamttrd)" 
     End  
End

-------------------------------------  End Of Decide Group By Options  ----------------------------------------------------

Set @@WhereText =  " Where S.Sauda_date   Between '" + @Sauda_date  + " 00:00:00'  And '"   + @Todate  + " 00:00:00' And S.Scrip_cd Between '"  + @Fromscrip + "' And  '"+  @Toscrip +"' And S.Sett_no Between '" + @Sett_no + "' And '" + @Tosett_no +"' And "
  
---------------------------  Now We Will Decide about Join  We will always provide from Party and ToParty -------------------------------------------
Print "Sett No : " + @Sett_no

Set @@WhereText =  @@WhereText + "  S.Party_code Between '" + @@FromParty_code  + "' And '" + @@ToParty_code   +"'  "  

If @Consol = "FAMILY" 
Set @@WhereText =  @@WhereText +   "  And Family Between '" + @@FromFamily  + "' And '" + @@ToFamily   +"'  " 

If @Consol = "Trader"
Set @@WhereText =  @@WhereText + " And  Trader Between '" + @@FromTrader  + "' And '" + @@ToTrader   +"' " 

If @Consol = "Branch_cd" 
Set @@WhereText =  @@WhereText + " And Branch_cd Between '" + @@FromBranch_cd  + "' And '" + @@ToBranch_cd   +"' " 

If @Consol = "Sub_Broker" 
Set @@WhereText =  @@WhereText + " And Sub_Broker Between '" + @@FromSub_Broker  + "' And '" + @@ToSub_Broker   +"' " 

If @Consol = "REGION" 
Set @@WhereText =  @@WhereText + " And Region Between '" + @@FromRegion  + "' And '" + @@ToRegion  +"' " 

------------------------- Added For Access Control as per User Login Status ---------------------------------------------------------------------------------------------
If @StatusId = "FAMILY" 
	Begin
		Set @@WhereText =  @@WhereText +   "  And Family Between '" + @StatusName  + "' And '" + @StatusName   +"'  " 
	End

If @StatusId = "TRADER"
Begin
	Set @@WhereText =  @@WhereText + " And  Trader Between '" + @StatusName  + "' And '" + @StatusName   +"'  " 
End

If @StatusId = "BRANCH" 
Begin
	Set @@WhereText =  @@WhereText + " And Branch_cd Between '" + @StatusName  + "' And '" + @StatusName   +"'  " 
End

If @StatusId = "SUBBROKER" 
Begin
	Set @@WhereText =  @@WhereText + " And Sub_Broker Between '" + @StatusName  + "' And '" + @StatusName   +"'  " 
End

If @StatusId = "PARTY" 
Begin
	Set @@WhereText =  @@WhereText + " And Party_Code Between '" + @StatusName  + "' And '" + @StatusName   +"'  " 
End

---------------------------   Decided about join  -------------------------------------------
Set @@WhereText = @@WhereText + " And  S.Sett_type Between '" + @@Fromsett_type + "'  And '" +  @@Tosett_type  + "'"  

If @Detail = "BR"
   Set @@WhereText = @@WhereText + " And  Tradetype not in ( 'SCF','ICF','IR' )  "  

If @Detail = "S"
Begin
   If @GroupF <> "0"
   Begin
	   Set @@WhereText = @@WhereText + " And  Tradetype not in ( 'IR' )  "  
   End
End

If @Detail = "PO"
   Set @@WhereText = @@WhereText + " And  Tradetype not in ( 'SBF','SCF','IR' )"  

If @Detail = "TU"
   Set @@WhereText = @@WhereText + " And  Tradetype not in ( 'SBF','SCF','IBF','ICF','IR' )"  

Print '********************************************'

/*NULL CHK FOR WHERE*/
If @@WhereText is NULL OR Len(LTrim(rTrim(@@WhereText))) = 0
Begin
	Set @@WhereText = " WHERE 1=0"
End

Print  @Sett_no
Print  @Tosett_No
Print  @Sett_type
Print  @Sauda_date
Print  @ToDate
Print  @FromScrip
Print  @ToScrip
Print  @From
Print  @To
Print  @Consol
Print  @Detail
Print  @Level
Print  @GroupF
Print  @OrderF
Print  @Use1
Print  @statusid
Print  @statusname

Print '********************************************'


Print @@SelectFlex 
Print @@SelectBody 
Print @@FromTable 
Print @@WhereText 
Print @@MyGroup



If @Detail = "BR"
Exec (@@SelectFlex + @@SelectBody+ @@FromTable + @@WhereText + @@MyGroup +  @@MyOrder  )  
If @Detail = "S"
Exec (@@SelectFlex + @@SelectBody+ @@FromTable + @@WhereText + @@MyGroup + @@MyOrder)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.no_docu
-- --------------------------------------------------

CREATE procedure [dbo].[no_docu](@company as varchar(10), @fromdate as varchar(11), @to_value as money)  
as  
  
set nocount on  
  
select party_code,turnover=sum(turnover) into #to from mis_to   
where company =@company and sauda_Date>=@fromdate+' 00:00:00'  
group by party_Code  
having sum(turnover) >= @to_value  
  
  
  
if @company='ABLCM'  
 BEGIN  
  select c5.cl_code, party_code into #cl5 from AngelBSECM.bsedb_Ab.dbo.client5 c5, AngelBSECM.bsedb_Ab.dbo.client2 c2 where c2.cl_code=c5.cl_code and   
  passport=0 and Drivelicen=0 and rationcard=0 and votersid=0  
  and party_Code in (select party_code collate SQL_Latin1_General_CP1_CI_AS from #to)  
    
  select * into #sb from AngelBSECM.bsedb_Ab.dbo.subbrokers   
    
  select * into #cl2 from AngelBSECM.bsedb_Ab.dbo.client2 where cl_code in (select cl_code from #cl5)  
    
  select c1.branch_cd,c1.sub_broker,sb_name=name,sb_phone=phone1+' '+phone2, c2.party_Code,c1.long_name  
  from AngelBSECM.bsedb_Ab.dbo.client1 c1, #cl2 c2, #sb sb  
  where c1.cl_code=c2.cl_code and c1.sub_Broker = sb.sub_Broker and pan_gir_no ='' and c1.cl_code in (select cl_code from #cl5)  
  order by c1.branch_cd,c1.sub_broker,c2.party_code 
 END  
  
if @company='ACDLCM'  
 BEGIN  
  select c5.cl_code, party_code into #cl5a from AngelNseCM.msajag.dbo.client5 c5, AngelNseCM.msajag.dbo.client2 c2 where c2.cl_code=c5.cl_code and   
  passport=0 and Drivelicen=0 and rationcard=0 and votersid=0  
  and party_Code in (select party_code collate SQL_Latin1_General_CP1_CI_AS from #to)  
    
  select * into #sba from AngelNseCM.msajag.dbo.subbrokers   
    
  select * into #cl2a from AngelNseCM.msajag.dbo.client2 where cl_code in (select cl_code from #cl5a)  
    
  select c1.branch_cd,c1.sub_broker,sb_name=name,sb_phone=phone1+' '+phone2, c2.party_Code,c1.long_name  
  from AngelNseCM.msajag.dbo.client1 c1, #cl2a c2, #sba sb  
  where c1.cl_code=c2.cl_code and c1.sub_Broker = sb.sub_Broker and pan_gir_no ='' and c1.cl_code in (select cl_code from #cl5a)  
  order by c1.branch_cd,c1.sub_broker,c2.party_code  
 END  
  
if @company='ACDLFO'  
 BEGIN  
  select c5.cl_code, party_code into #cl5b from angelfo.nsefo.dbo.client5 c5, angelfo.nsefo.dbo.client2 c2 where c2.cl_code=c5.cl_code and   
  passport=0 and Drivelicen=0 and rationcard=0 and votersid=0  
  and party_Code in (select party_code collate SQL_Latin1_General_CP1_CI_AS from #to)  
    
  select * into #sbb from angelfo.nsefo.dbo.subbrokers   
    
  select * into #cl2b from angelfo.nsefo.dbo.client2 where cl_code in (select cl_code from #cl5b)  
    
  select c1.branch_cd,c1.sub_broker,sb_name=name,sb_phone=phone1+' '+phone2, c2.party_Code,c1.long_name  
  from angelfo.nsefo.dbo.client1 c1, #cl2b c2, #sbb sb  
  where c1.cl_code=c2.cl_code and c1.sub_Broker = sb.sub_Broker and pan_gir_no ='' and c1.cl_code in (select cl_code from #cl5b)  
  order by c1.branch_cd,c1.sub_broker,c2.party_code 
 END  
  
  
if @company='MCX'  
 BEGIN  
  select c5.cl_code, party_code into #cl5c from angelcommodity.mcdx.dbo.client5 c5, angelcommodity.mcdx.dbo.client2 c2   
  where c2.cl_code=c5.cl_code and   
  passport=0 and Drivelicen=0 and rationcard=0 and votersid=0  
  and party_Code in (select party_code collate SQL_Latin1_General_CP1_CI_AS from #to)  
    
  select * into #sbc from angelcommodity.mcdx.dbo.subbrokers   
    
  select * into #cl2c from angelcommodity.mcdx.dbo.client2 where cl_code in (select cl_code from #cl5c)  
    
  select c1.branch_cd,c1.sub_broker,sb_name=name,sb_phone=phone1+' '+phone2, c2.party_Code,c1.long_name  
  from angelcommodity.mcdx.dbo.client1 c1, #cl2c c2, #sbc sb  
  where c1.cl_code=c2.cl_code and c1.sub_Broker = sb.sub_Broker and pan_gir_no ='' and c1.cl_code in (select cl_code from #cl5c)  
  order by c1.branch_cd,c1.sub_broker,c2.party_code  
END  
  
  
  
if @company='NCDEX'  
 BEGIN  
  select c5.cl_code, party_code into #cl5d from angelcommodity.ncdx.dbo.client5 c5, angelcommodity.ncdx.dbo.client2 c2   
  where c2.cl_code=c5.cl_code and   
  passport=0 and Drivelicen=0 and rationcard=0 and votersid=0  
  and party_Code in (select party_code collate SQL_Latin1_General_CP1_CI_AS from #to)  
    
  select * into #sbd from angelcommodity.ncdx.dbo.subbrokers   
    
  select * into #cl2d from angelcommodity.ncdx.dbo.client2 where cl_code in (select cl_code from #cl5d)  
    
  select c1.branch_cd,c1.sub_broker,sb_name=name,sb_phone=phone1+' '+phone2, c2.party_Code,c1.long_name  
  from angelcommodity.ncdx.dbo.client1 c1, #cl2d c2, #sbd sb  
  where c1.cl_code=c2.cl_code and c1.sub_Broker = sb.sub_Broker and pan_gir_no ='' and c1.cl_code in (select cl_code from #cl5d)  
  order by c1.branch_cd,c1.sub_broker,c2.party_code 
 END  
  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.non_Active
-- --------------------------------------------------
CREATE procedure [dbo].[non_Active](@coname as varchar(10),@abovers as money)
as

if @coname ='ABLCM'
BEGIN
	select distinct cltcode into #ABL_CLI from AngelBSECM.account_ab.dbo.ledger where vdt  >= getdate()-180 and vtyp=15
	
	select party_Code into #deac_Code from AngelBSECM.bsedb_Ab.dbo.client2 where party_Code not in (select cltcode from #abl_cli)
	
	select branch_cd,sub_Broker,party_code,party_name,
	turnover=sum(turnover)/125,brokerage=sum(brokerage)/125
	from mis_to 
	where company='aBLCM' 
	and party_Code collate Latin1_General_CI_AS  in (select party_code from #deac_Code) 
	and sauda_DAte >= (getdate()-360) and sauda_DAte <= (getdate()-180)
	group by branch_cd,sub_Broker,party_code,party_code,party_name
	having sum(brokerage)/125 >= @abovers
	order by brokerage desc
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.not_loggedin
-- --------------------------------------------------
CREATE procedure not_loggedin (@fdate as varchar(25),@tdate as varchar(25),@user as varchar(10),@code as varchar(10))            
As           
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
    
--drop table #file1       
SET NOCOUNT ON        
  select party_code into #file1 
from loginfile (nolock) 
where login_date>=@fdate and login_date<@tdate and party_code is not null         
     
if @user='BROKER'            
begin                    
        
select distinct  c.branch_cd,c.sub_broker,a.party_code,c.short_name         
from mis.dbo.ebrok_client1 a,risk.dbo.client_details c (nolock)         
where a.party_code collate Latin1_General_CI_AS not in         
(select distinct party_code from #file1 )         
and a.party_code=c.party_code       
end       
    
if @user='REGION'            
begin      
    
select distinct  c.branch_cd,c.sub_broker,a.party_code,c.short_name         
from mis.dbo.ebrok_client1 a (nolock),risk.dbo.client_details c (nolock)         
where a.party_code collate Latin1_General_CI_AS not in         
(select distinct party_code from #file1)         
and a.party_code=c.party_code and c.branch_cd in (SELECT code FROM risk.dbo.region (nolock) where reg_code=@code)       
    
end          
            
if @user='BRMAST'            
begin               
select distinct  c.branch_cd,c.sub_broker,a.party_code,c.short_name         
from mis.dbo.ebrok_client1 a (nolock),risk.dbo.client_details c (nolock)         
where a.party_code collate Latin1_General_CI_AS not in         
(select distinct party_code from #file1)         
and a.party_code=c.party_code and c.branch_cd in (select branch_cd from risk.dbo.branch_master where brMast_cd=@code)       
        
end             
            
if @user='BRANCH'            
begin       
select distinct  c.branch_cd,c.sub_broker,a.party_code,c.short_name         
from mis.dbo.ebrok_client1 a (nolock),risk.dbo.client_details c (nolock)         
where a.party_code collate Latin1_General_CI_AS not in         
(select distinct party_code from #file1)         
and a.party_code=c.party_code and c.branch_cd=@code        
End          
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseCmTurnoverCalc
-- --------------------------------------------------
CREATE Procedure [dbo].[NseCmTurnoverCalc](@Level As Int, @FromDate Varchar(11), @ToDate Varchar(11))
As
Declare
@@StartSett_no As Varchar(15),
@@EndSett_no As Varchar(15)

--Select Min(Sett_no),Max(Sett_no) From AngelNseCM.Msajag.Dbo.Sett_mst
--Where Start_date >= @FromDate
--And StartDate

If @Level = 1
Begin
select Party_code ,Scrip_cd,S.Sett_no,S.Sett_type,Turnover = sum(tradeqty * marketrate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty ),'NSE CM EBROKING'
from intranet.ctcl.dbo.nsecashtrade N, AngelNseCM.msajag.dbo.settlement s
where 
S.Party_code = N.clCode
and
N.Flag like '004%'
--And N.TrdNo Like '%' + S.Trade_no 
And N.ORDNO = S.Order_no
And S.Sett_no = N.Settno
And S.Sett_type = 'N'
And S.Sauda_date >= @FromDate
And S.Sauda_date <= @Todate +' 23:59:00'
group by party_code,Scrip_cd,S.Sett_no,S.Sett_type
Order by Party_code,Scrip_cd,S.Sett_no,S.Sett_type
End
If @level = 2
Begin
select Party_code ,S.Sett_no,S.Sett_type,Turnover = sum(tradeqty * marketrate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty ),'NSE CM EBROKING'
from intranet.ctcl.dbo.nsecashtrade N, AngelNseCM.msajag.dbo.settlement s
where 
S.Party_code = N.clCode
and
N.Flag like '004%'
--And N.TrdNo Like '%' + S.Trade_no 
And N.ORDNO = S.Order_no
And S.Sett_no = N.Settno
And S.Sett_type = 'N'
And S.Sauda_date >= @FromDate
And S.Sauda_date <= @Todate +' 23:59:00'
group by party_code,S.Sett_no,S.Sett_type
Order by Party_code,S.Sett_no,S.Sett_type
End
If @Level = 3
Begin
select Party_code, Turnover = sum(tradeqty * marketrate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty ),'NSE CM EBROKING'
from intranet.ctcl.dbo.nsecashtrade N, AngelNseCM.msajag.dbo.settlement s
where 
S.Party_code = N.clCode
and
N.Flag like '004%'
--And N.TrdNo Like '%' + S.Trade_no 
And N.ORDNO = S.Order_no
And S.Sett_no = N.Settno
And S.Sett_type = 'N'
And S.Sauda_date >= @FromDate
And S.Sauda_date <= @Todate +' 23:59:00'
group by party_code
Order by Party_code
End
If @Level = 4
Begin
select Turnover = sum(tradeqty * marketrate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty ),'NSE CM EBROKING'
from intranet.ctcl.dbo.nsecashtrade N, AngelNseCM.msajag.dbo.settlement s
where 
S.Party_code = N.clCode
and
N.Flag like '004%'
--And N.TrdNo Like '%' + S.Trade_no 
And N.ORDNO = S.Order_no
And S.Sett_no = N.Settno
And S.Sett_type = 'N'
And S.Sauda_date >= @FromDate
And S.Sauda_date <= @Todate +' 23:59:00'
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseDupAmt
-- --------------------------------------------------

CREATE Procedure NseDupAmt As
Declare
@@FromDate As DateTime


Select @@Fromdate = Left(Convert(Varchar,DateAdd(dd,-10,getdate()),109),11)

Delete NseDuplicateAmt Where Vdt >= @@FromDate

Insert Into intranet.bsedb_ab.dbo.NSeDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From anand1.inhouse.dbo.Ledger L  , anand1.inhouse.dbo.Ledger1 L1  ,anand1.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= @@FromDate  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode ) B


Insert Into intranet.bsedb_ab.dbo.NSeDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From anand1.inhouse.dbo.Ledger L  , anand1.inhouse.dbo.Ledger1 L1  ,anand1.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset'And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= @@FromDate  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode And L.CltCode = '5100000002' ) B



Insert Into log_dupchqamtup values(Getdate(),'NSEDUPLICATEAmount')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseDupAmtComplete
-- --------------------------------------------------

CREATE Procedure NseDupAmtComplete As
--Declare
--@@FromDate As DateTime


--Select @@Fromdate = Left(Convert(Varchar,DateAdd(dd,-10,getdate()),109),11)

--Delete NseDuplicateAmt Where Vdt >= @@FromDate

truncate table NseDuplicateAmt

Insert Into intranet.bsedb_ab.dbo.NSeDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From anand1.inhouse.dbo.Ledger L  , anand1.inhouse.dbo.Ledger1 L1  ,anand1.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= 'Apr  1 2001'  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode ) B

Insert Into intranet.bsedb_ab.dbo.NSeDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From anand1.inhouse.dbo.Ledger L  , anand1.inhouse.dbo.Ledger1 L1  ,anand1.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset'And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= 'Apr  1 2001'  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode And L.CltCode = '5100000002' ) B

Insert Into log_dupchqamtup values(Getdate(),'NSEDUPLICATEAmountComplete')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseDupCheque
-- --------------------------------------------------

CREATE Procedure NseDupCheque
As

Delete AngelDupCheque Where ExchangeSegment = 'NSECM' 
Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NSECM' 
	 From anand1.inhouse.dbo.Ledger L /* with (nolock)*/ , anand1.inhouse.dbo.Ledger1 L1 /*with (nolock)*/ ,anand1.inhouse.dbo.Acmast A /* with (nolock) */  
	 Where 
	 A.Accat = 4
	 And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode ) A


Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NSECM' 
	 From anand1.inhouse.dbo.Ledger L /* with (nolock)*/ , anand1.inhouse.dbo.Ledger1 L1 /*with (nolock)*/ ,anand1.inhouse.dbo.Acmast A /* with (nolock) */  
	 Where 
	 --A.Accat = 4
	 --And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode And L.CltCode = '5100000002' ) A

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseFoDupAmt
-- --------------------------------------------------

CREATE Procedure NseFoDupAmt As
Declare
@@FromDate As DateTime


Select @@Fromdate = Left(Convert(Varchar,DateAdd(dd,-10,getdate()),109),11)

Delete foDuplicateAmt Where Vdt >= @@FromDate

Insert Into intranet.bsedb_ab.dbo.foDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From angelfo.inhouse.dbo.Ledger L  , angelfo.inhouse.dbo.Ledger1 L1  ,angelfo.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= @@FromDate  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode ) B

Insert Into intranet.bsedb_ab.dbo.foDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From angelfo.inhouse.dbo.Ledger L  , angelfo.inhouse.dbo.Ledger1 L1  ,angelfo.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset' And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= @@FromDate  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode
              And L.CltCode = '5100000001' ) B

Insert Into log_dupchqamtup values(Getdate(),'NSEFODUPLICATEAmount')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseFoDupAmtComplete
-- --------------------------------------------------

CREATE Procedure NseFoDupAmtComplete As
--Declare
--@@FromDate As DateTime


--Select @@Fromdate = Left(Convert(Varchar,DateAdd(dd,-10,getdate()),109),11)

--Delete foDuplicateAmt Where Vdt >= @@FromDate

truncate table foDuplicateAmt

Insert Into intranet.bsedb_ab.dbo.foDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From angelfo.inhouse.dbo.Ledger L  , angelfo.inhouse.dbo.Ledger1 L1  ,angelfo.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode And A.AcTyp = 'Asset'And AcCat = 4 And Vamt > 0 
	 And Vdt >= 'Apr  1 2001'  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode ) B


Insert Into intranet.bsedb_ab.dbo.foDuplicateAmt Select * From(
select 
	bnkname,brnname,dd,ddno ,L.vtyp,L.vno,L.lno,L.acname,L.drcr,vamt,vdt,L.cltcode,L.BookType,EnteredBy,
	pdt,CheckedBy,actnodays,narration,Branch = BranchCode
	 From angelfo.inhouse.dbo.Ledger L  , angelfo.inhouse.dbo.Ledger1 L1  ,angelfo.inhouse.dbo.Acmast A   
	 Where 
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 A.CltCode = L.CltCode 
              --And A.AcTyp = 'Asset' And AcCat = 4 
              And Vamt > 0 
	 And Vdt >= 'Apr  1 2001'  and Vdt <= Getdate() 
	 And L.CltCode = A.CltCode
              And L.CltCode = '5100000001' ) B



Insert Into log_dupchqamtup values(Getdate(),'NSEFODUPLICATEAmountComplete')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseFoDupCheque
-- --------------------------------------------------

CREATE Procedure NseFoDupCheque
As
Delete AngelDupCheque Where ExchangeSegment = 'NSEFO' 
Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NSEFO' 
	 From angelfo.inhouse.dbo.Ledger L /* with (nolock)*/ , angelfo.inhouse.dbo.Ledger1 L1 /*with (nolock)*/ ,angelfo.inhouse.dbo.Acmast A /* with (nolock) */  
	 Where 
	 A.Accat = 4
	 And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode ) A


Insert into Intranet.Bsedb_ab.dbo.AngelDupCheque Select * From ( Select Vdt = L.vdt ,Vtyp = L.Vtyp ,Vno = L.Vno ,LNo = L.Lno , Enteredby,Checkedby,Narration, 
	 BnkName = bnkname,BrnName= brnname,DD= dd,Ddno = ddno, RelAmt = Relamt, 
	 DrCr = L1.drcr ,L.Acname,branch = BranchCode,Cltcode= L.cltcode  ,Accat,ExchangeSegment = 'NSEFO' 
	 From angelfo.inhouse.dbo.Ledger L /* with (nolock)*/ , angelfo.inhouse.dbo.Ledger1 L1 /*with (nolock)*/ ,angelfo.inhouse.dbo.Acmast A /* with (nolock) */  
	 Where 
	 --A.Accat = 4
	 --And
	 L.Vtyp = L1.Vtyp 
	 And 
	 L.Vno = L1.Vno 
	 And 
	 L.DrCr = L1.DrCr 
	 And 
	 L.Lno = L1.Lno 
	 And 
	 L.vtyp <> 15 
	 And  
	 L.vtyp <> 5 
	 And 
	 Vdt >= 'APR  1 2001' 
	 And Vdt <= GetDate()  
	 And L.CltCode = A.CltCode And L.CltCode = '5100000001' ) A

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseFOSundryclientreco_up
-- --------------------------------------------------


CREATE Proc NseFOSundryclientreco_up
As
Declare @FromDate Varchar(25)
Declare @ToDate Varchar(25)


Set @FromDate = 'APR 1 '

Set @ToDate = Convert(varchar,GetDate(),106) + ' 23:59:59'

If DatePart(Month,@ToDate)<= 3
	Set @FromDate = @FromDate + Cast((DatePart(Year,GetDate())-1) as varchar)
Else
	Set @FromDate = @FromDate + Cast(DatePart(Year,GetDate()) as varchar)

	Set @FromDate = @FromDate + ' 00:00 '


Truncate table NseFOSundryclientreco1

--Select * Into #Sundry 

Insert Into NseFOSundryclientreco1
Select * 
From (
Select bnkname = (Select Bnkname from angelfo.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr), 
BrnName = (Select BRnName from angelfo.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr), 
DD =(Select DD from angelfo.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr) ,
Ddno = (Select DDno from angelfo.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr),
Vtyp = L.Vtyp,
Vno = l.vno, 
AcName = a.LongName,
DrCr = L.DrCr,
Vamt = L.Vamt,
--Booktype = l.booktype, 
vdt=l.vdt,
EnteredBy = L.EnteredBy,
CheckedBy = L.Checkedby, 
--effdt=l.edt, isnull(shortdesc,'') shortdesc, 
--dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),
--cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), 
Narration = replace(replace(l.Narration,'''',''),'"',''),
Branch = (Select COSTNAME From angelfo.inhouse.dbo.ledger2 L2, angelfo.inhouse.dbo.Costmast C 
          Where L2.vtype = l.vtyp 
          and L2.vno = l.vno 
          and L2.lno = l.lno And L2.Drcr = L.DrCr And L2.Costcode = C.Costcode)
 
--CltCode = l.cltcode , 
--edt = convert(varchar,l.edt,103), accat  
from angelfo.inhouse.dbo.ledger l left outer join angelfo.inhouse.dbo.acmast a on l.cltcode = a.cltcode ,angelfo.inhouse.dbo.vmast v  
Where l.vdt >= @FromDate and l.vdt <= @ToDate 
and l.vtyp <> 18 and l.cltcode = '5100000001'  
And vtyp = vtype and a.cltcode = l.cltcode 
and a.accat <> '4'   
--order by l.cltcode, voudt, l.vtyp desc, l.vno
) A

--Select * from #Sundry


--select * from nsesundryclientreco1

--exec nsesundryclientreco_up

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseFoTurnoverCalc
-- --------------------------------------------------
CREATE Procedure NseFoTurnoverCalc(@Level As Int, @FromDate Varchar(11), @ToDate Varchar(11))
As
Declare
@@StartSett_no As Varchar(15),
@@EndSett_no As Varchar(15)

If @Level = 1
Begin
select Convert(Varchar(11),sauda_date,109),Clcode ,N.symbol,OpType,ExpDate,StkPrice,N.Series,Turnover = sum(Tradeqty * Price),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty )
from Intranet.Ctcl.Dbo.nseFotrade N, AngelFo.nsefo.dbo.Fosettlement s
where 
S.Party_code = N.clCode
And N.ORDNO = S.Order_no
And S.Inst_type = OpType
And N.Symbol = S.Symbol
And N.stkprice = S.Strike_Price
And Convert(Varchar(11),Cast(Tdate As DateTime),109) = Convert(Varchar(11),Expirydate,109)
And Convert(Varchar(11),sauda_date,109) = Convert(Varchar(11),Cast(Tdate As DateTime),109) 
And Convert(Varchar(11),sauda_date,109) >= @FromDate
And Convert(Varchar(11),sauda_date,109) >= @ToDate + ' 23:59:00'
group by Convert(Varchar(11),sauda_date,109),N.ClCode,N.symbol,OpType,ExpDate,StkPrice,N.Series
Order by N.Clcode,Convert(Varchar(11),sauda_date,109),N.symbol,OpType,ExpDate,StkPrice,N.Series
End

If @Level = 2
Begin
select Clcode ,N.symbol,OpType,ExpDate,StkPrice,N.Series,Turnover = sum(qty * rate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty )
from Intranet.Ctcl.Dbo.nseFotrade N, AngelFo.nsefo.dbo.Fosettlement s
where 
S.Party_code = N.clCode
And N.ORDNO = S.Order_no
And S.Inst_type = OpType
And N.Symbol = S.Symbol
And N.stkprice = S.Strike_Price
And Convert(Varchar(11),Cast(Tdate As DateTime),109) = Convert(Varchar(11),Expirydate,109)
And Convert(Varchar(11),sauda_date,109) = Convert(Varchar(11),Cast(Tdate As DateTime),109) 
And Convert(Varchar(11),sauda_date,109) >= @FromDate
And Convert(Varchar(11),sauda_date,109) >= @ToDate + ' 23:59:00'
group by N.ClCode,N.symbol,OpType,ExpDate,StkPrice,N.Series
Order by N.Clcode,N.symbol,OpType,ExpDate,StkPrice,N.Series
End

If @Level = 3
Begin
select Clcode ,Turnover = sum(qty * rate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty )
from Intranet.Ctcl.Dbo.nseFotrade N, AngelFo.nsefo.dbo.Fosettlement s
where 
S.Party_code = N.clCode
And N.ORDNO = S.Order_no
And S.Inst_type = OpType
And N.Symbol = S.Symbol
And N.stkprice = S.Strike_Price
And Convert(Varchar(11),Cast(Tdate As DateTime),109) = Convert(Varchar(11),Expirydate,109)
And Convert(Varchar(11),sauda_date,109) = Convert(Varchar(11),Cast(Tdate As DateTime),109) 
And Convert(Varchar(11),sauda_date,109) >= @FromDate
And Convert(Varchar(11),sauda_date,109) >= @ToDate + ' 23:59:00'
group by N.ClCode
Order by N.Clcode
End

If @Level = 4
Begin
select Turnover = sum(qty * rate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty )
from Intranet.Ctcl.Dbo.nseFotrade N, AngelFo.nsefo.dbo.Fosettlement s
where 
S.Party_code = N.clCode
And N.ORDNO = S.Order_no
And S.Inst_type = OpType
And N.Symbol = S.Symbol
And N.stkprice = S.Strike_Price
And Convert(Varchar(11),Cast(Tdate As DateTime),109) = Convert(Varchar(11),Expirydate,109)
--And S.Series = N.Series
And Convert(Varchar(11),sauda_date,109) = Convert(Varchar(11),Cast(Tdate As DateTime),109) 
And Convert(Varchar(11),sauda_date,109) >= @FromDate
And Convert(Varchar(11),sauda_date,109) >= @ToDate + ' 23:59:00'
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NseSundryclientreco_up
-- --------------------------------------------------


CREATE Proc [dbo].[NseSundryclientreco_up]
As
Declare @FromDate Varchar(25)
Declare @ToDate Varchar(25)


Set @FromDate = 'APR 1 '

Set @ToDate = Convert(varchar,GetDate(),106) + ' 23:59:59'

If DatePart(Month,@ToDate)<= 3
	Set @FromDate = @FromDate + Cast((DatePart(Year,GetDate())-1) as varchar)
Else
	Set @FromDate = @FromDate + Cast(DatePart(Year,GetDate()) as varchar)

	Set @FromDate = @FromDate + ' 00:00 '


Truncate table NseSundryclientreco1

--Select * Into #Sundry 

Insert Into NseSundryclientreco1
Select * 
From (
Select bnkname = (Select Bnkname from AngelNseCM.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr), 
BrnName = (Select BRnName from AngelNseCM.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr), 
DD =(Select DD from AngelNseCM.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr) ,
Ddno = (Select DDno from AngelNseCM.inhouse.dbo.ledger1 where vtyp = l.vtyp 
and vno = l.vno and booktype = l.booktype and lno = l.lno and drcr = L.Drcr),
Vtyp = L.Vtyp,
Vno = l.vno, 
AcName = a.LongName,
DrCr = L.DrCr,
Vamt = L.Vamt,
--Booktype = l.booktype, 
vdt=l.vdt,
EnteredBy = L.EnteredBy,
CheckedBy = L.Checkedby, 
--effdt=l.edt, isnull(shortdesc,'') shortdesc, 
--dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),
--cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), 
Narration = replace(replace(l.Narration,'''',''),'"',''),
Branch = (Select COSTNAME From AngelNseCM.inhouse.dbo.ledger2 L2, AngelNseCM.inhouse.dbo.Costmast C 
          Where L2.vtype = l.vtyp 
          and L2.vno = l.vno 
          and L2.lno = l.lno And L2.Drcr = L.DrCr And L2.Costcode = C.Costcode)
 
--CltCode = l.cltcode , 
--edt = convert(varchar,l.edt,103), accat  
from AngelNseCM.inhouse.dbo.ledger l left outer join AngelNseCM.inhouse.dbo.acmast a on l.cltcode = a.cltcode ,AngelNseCM.inhouse.dbo.vmast v  
Where l.vdt >= @FromDate and l.vdt <= @ToDate 
and l.vtyp <> 18 and l.cltcode = '5100000002'  
And vtyp = vtype and a.cltcode = l.cltcode 
and a.accat <> '4'   
--order by l.cltcode, voudt, l.vtyp desc, l.vno
) A

--Select * from #Sundry

GO

-- --------------------------------------------------
-- PROCEDURE dbo.online_brokerage_rev
-- --------------------------------------------------
CREATE procedure dbo.online_brokerage_rev(@fdate as varchar(11),@tdate as varchar(11),@access as varchar(10),@code as varchar(10))                                                                               
    
     
as                                                                                  
set transaction isolation level read uncommitted                                                                                  
set nocount on                                                       
select distinct zone=space(15),region=space(15),brcode=space(10),sbcode=space(10),party_Code,odin_server                                                                
into #cli79                                                                 
--from ctcl.dbo.client_mast79                                                                 
from vw_ebrok_client1                    
--select * from vw_ebrok_client1                    
                                                                
update #cli79 set brcode=b.branch_Cd,sbcode=b.sub_Broker from risk.dbo.client_details b                                                                
where #cli79.party_code=b.party_Code             
          
update #cli79 set region=b.reg_code from risk.dbo.region b                                                                
where #cli79.brcode=b.code collate SQL_Latin1_General_CP1_CI_AS            
          
update #cli79 set zone=b.zone from risk.dbo.Vw_RMS_Client_Vertical b                                                                
where #cli79.brcode=b.branch collate SQL_Latin1_General_CP1_CI_AS  
  
                                                     
                                                
select * into #mis from MIS_ebroking_cli  where sauda_DAte>=convert(datetime,@fdate,103)     
and sauda_DAte <=convert(datetime,@tdate,103) and user_Stat like 'e-broking'                                                                                   
                                                
-- ------------------------------------------------------------------------------------------------
--select a.party_code,a.sauda_date,ablcm_to=isnull(b.ablcm_to,0),ablcm_brok=isnull(b.ablcm_brok,0),acdlcm_to=isnull(c.acdlcm_to,0),
--acdlcm_brok=isnull(c.acdlcm_brok,0),
--acdlfo_to=isnull(d.acdlfo_to,0),acdlfo_brok=isnull(d.acdlfo_brok,0),mcx_to=isnull(e.mcx_to,0),mcx_brok=isnull(e.mcx_brok,0),
--ncdx_to=isnull(f.ncdx_to,0),ncdx_brok=isnull(f.ncdx_brok,0),turnover=isnull(a.total_to,0),brokerage=isnull(a.Total_brok,0),nooflogin=a.cnt into #mis 
--from
--(select  party_code,sauda_date=convert(varchar(11),sauda_date,103),Total_to=sum(overall_turnover),Total_brok=sum(overall_brok_earned),cnt=count(party_code) from mis.remisior.dbo.tbl_ebrok_detail_cli  
--where  sauda_DAte>=convert(datetime,@fdate,103)     
--and sauda_DAte <=convert(datetime,@tdate,103) and segment in('ABLCM','ACDLCM','ACDLFO','ACPLMCX','ACPLNCDX')
--group by party_code,convert(varchar(11),sauda_date,103))a 
--left outer join
--(select  party_code,sauda_date=convert(varchar(11),sauda_date,103),ablcm_to=sum(overall_turnover),ablcm_brok=sum(overall_brok_earned) from mis.remisior.dbo.tbl_ebrok_detail_cli 
--where  sauda_DAte>=convert(datetime,@fdate,103)     
--and sauda_DAte <=convert(datetime,@tdate,103) and segment='ABLCM' 
--group by party_code,convert(varchar(11),sauda_date,103))b on a.party_code=b.party_code and a.sauda_Date=b.sauda_Date 
--left outer join
--(select  party_code,sauda_date=convert(varchar(11),sauda_date,103),acdlcm_to=sum(overall_turnover),acdlcm_brok=sum(overall_brok_earned) from mis.remisior.dbo.tbl_ebrok_detail_cli  
--where sauda_DAte>=convert(datetime,@fdate,103)     
--and sauda_DAte <=convert(datetime,@tdate,103) and segment='ACDLCM' 
--group by party_code,convert(varchar(11),sauda_date,103))c on a.party_code=c.party_code and a.sauda_Date=c.sauda_Date 
-- left outer join
--(select  party_code,sauda_date=convert(varchar(11),sauda_date,103),acdlfo_to=sum(overall_turnover),acdlfo_brok=sum(overall_brok_earned) from mis.remisior.dbo.tbl_ebrok_detail_cli  
--where  sauda_DAte>=convert(datetime,@fdate,103)     
--and sauda_DAte <=convert(datetime,@tdate,103) and segment='ACDLFO' 
--group by party_code,convert(varchar(11),sauda_date,103))d on a.party_code=d.party_code and a.sauda_Date=d.sauda_Date 
-- left outer join
--(select  party_code,sauda_date=convert(varchar(11),sauda_date,103),mcx_to=sum(overall_turnover),mcx_brok=sum(overall_brok_earned) from mis.remisior.dbo.tbl_ebrok_detail_cli 
--where sauda_DAte>=convert(datetime,@fdate,103)     
--and sauda_DAte <=convert(datetime,@tdate,103) and segment='ACPLMCX' 
--group by party_code,convert(varchar(11),sauda_date,103))e on a.party_code=e.party_code and a.sauda_Date=e.sauda_Date  
--left outer join
--(select  party_code,sauda_date=convert(varchar(11),sauda_date,103),ncdx_to=sum(overall_turnover),ncdx_brok=sum(overall_brok_earned) from mis.remisior.dbo.tbl_ebrok_detail_cli 
--where  sauda_DAte>=convert(datetime,@fdate,103)     
--and sauda_DAte <=convert(datetime,@tdate,103) and segment='ACPLNCDX' 
--group by party_code,convert(varchar(11),sauda_date,103))f 
--on a.party_code=f.party_code and a.sauda_Date=f.sauda_Date 
----group by a.party_code,a.sauda_date
--
----------------------------------------------------------------------------------------------------------                                                                  
                                           
                                            
 select distinct b.zone,b.region,a.branch_cd,a.sub_Broker,a.party_code,b.odin_server,                                                                   
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                 
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                                      
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                                                
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                                            
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     
 into #odinanywhere                                                                              
 from #mis a left outer join #cli79 b                                                    
 on a.party_code=b.party_Code collate Latin1_General_CI_AS                                                                      
 --where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                                                   
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                                                    
 group by a.party_Code,b.zone,b.region,a.branch_cd,a.sub_Broker,b.odin_server       
                                 
  select clientcode,nooflogin=count(clientcode) into #nod       
from [196.1.115.211].bidb.dbo.ebrokingfds_oct_09      
where date>=convert(datetime,@fdate,103)       
and  date<=convert(datetime,@tdate,103)             
group by clientcode          
                                                 
update  #odinanywhere set nooflogin=a.nooflogin               
FROM #nod A WHERE party_code=A.clientcode collate Latin1_General_CI_AS          
                                                                               
 select a.*,offline_brok=isnull(c.offline_brok,0),notd=isnull(notd,0) into #file2                     
from #odinanywhere a                                                                      
 left outer join                                                                       
 (                                                                      
 select party_code,sub_broker,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok',notd=count(distinct sauda_DAte)                                                                      
 from ebrok_tobr_period (nolock)                                                                       
 where sauda_DAte>=convert(datetime,@fdate,103)  and sauda_DAte <=convert(datetime,@tdate,103)                                                      
 --and user_Stat like @cli_stat                                                                              
                                                                 
 group by party_code,sub_broker                                                                      
 ) c                           
 on a.party_code=c.party_code collate Latin1_General_CI_AS  and a.sub_broker=c.sub_broker                                                                      
                                                                                   
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                                                                                
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-'),b2c=convert(varchar(3),'NO')                                                                                
into #file1a                                                                                
 from #file2  a  left outer join ebrok_client_access  b  (nolock)  on a.party_code =b.party_Code  collate Latin1_General_CI_AS                                                                               
  --sp_help ebrok_client_access                 
update #file1a set b2c='Yes' where sub_broker in (select b2c_sb from mis.remisior.dbo.b2c_sb)              
                                                                             
 select a.*,party_name into #fina from #file1a a left outer join intranet.risk.dbo.finmast b                                                                                   
 on a.party_Code=b.party_code collate Latin1_General_CI_AS where isnull(a.party_code,'')<>''                    
order by a.branch_cd,a.sub_broker,a.party_code      
  
 if @access='CLIENT'              
BEGIN              
select * from #fina where party_code=@code              
END              
IF @access='BRANCH'               
begin              
select * from #fina  where branch_cd=@code            
end              
IF @access='BRMAST'               
begin              
select * from #fina a            
join risk.dbo.branch_master b (nolock) on a.branch_cd=b.branch_cd               
where b.brmast_cd=@code   
end           
IF @access='REGION'               
begin              
select * from #fina       
where region=@code           
end      
IF @access='REGMAST'               
begin              
select * from #fina a         
join  risk.dbo.region_master b ON a.region=b.region_cd       
where b.rgmast_cd=@code   
end             
IF @access='SBMAST'               
begin              
select * from #fina  a       
join risk.dbo.sb_master b (nolock) on a.sub_broker=b.sub_broker               
where b.sbmast_cd=@code      
end              
IF @access='SB'               
begin              
select * from #fina  where sub_broker=@code     
end                                                    
                                                                                                                                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.open_position
-- --------------------------------------------------

CREATE procedure [dbo].[open_position] (@fdate as varchar(11),@tdate as varchar(11))  
as  
  
set nocount on  
--------------------------- BSE   
set transaction isolation level read uncommitted  
  
select sett_no,sett_type,sauda_date,party_Code,scrip_cd,series,pqty=sum(pqtytrd+pqtydel),pamt=sum(pamttrd+pamtdel),sqty=sum(sqtytrd+sqtydel),sdel=sum(samttrd+samtdel)  
into #bse  
from AngelBSECM.bsedb_Ab.dbo.cmbillvalan where sauda_date >=@fdate+' 00:00:00' and sauda_Date <=@tdate+' 23:59:59'  
group by sett_no,sett_type,sauda_date,party_Code,scrip_cd,series  
  
set transaction isolation level read uncommitted  
  
select sauda_Date,a.party_code,scripname=isnull(b.scripname,'Unknown'),isin=isnull(b.isin,'Unknown'),pqty=sum(pqty),pamt=sum(pamt),  
sqty=sum(sqty),samt=sum(sdel)  
into #bse1  
from #bse a left outer join middleware.mimansa.dbo.angelscrip b on a.scrip_Cd=b.scrip_Cd  
group by sauda_Date,a.party_code,isnull(b.scripname,'Unknown'),isnull(b.isin,'Unknown')  
  
delete from bse_position where sauda_date >=@fdate+' 00:00:00' and sauda_Date <=@tdate+' 23:59:59'  
insert into bse_position select * from #bse1  
  
--------------------------- NSE   
set transaction isolation level read uncommitted  
  
select sett_no,sett_type,sauda_date,party_Code,scrip_cd,series,pqty=sum(pqtytrd+pqtydel),pamt=sum(pamttrd+pamtdel),sqty=sum(sqtytrd+sqtydel),sdel=sum(samttrd+samtdel)  
into #nse  
from AngelNseCM.msajag.dbo.cmbillvalan where sauda_date >=@fdate+' 00:00:00' and sauda_Date <=@tdate+' 23:59:59'  
group by sett_no,sett_type,sauda_date,party_Code,scrip_cd,series  
  
set transaction isolation level read uncommitted  
  
select sauda_Date,a.party_code,scripname=isnull(b.scripname,'Unknown'),isin=isnull(b.isin,'Unknown'),pqty=sum(pqty),pamt=sum(pamt),  
sqty=sum(sqty),samt=sum(sdel)  
into #nse1  
from #nse a left outer join middleware.mimansa.dbo.angelscrip b on a.scrip_Cd=b.Nsescrip_Cd  
group by sauda_Date,a.party_code,isnull(b.scripname,'Unknown'),isnull(b.isin,'Unknown')  
  
delete from nse_position where sauda_date >=@fdate+' 00:00:00' and sauda_Date <=@tdate+' 23:59:59'  
insert into nse_position select * from #nse1  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PARTY_DETAILS_SB
-- --------------------------------------------------
CREATE PROC PARTY_DETAILS_SB
@SB AS VARCHAR(50),
@FSDATE AS DATETIME,
@TSDATE AS DATETIME

AS
DECLARE @BRANCH AS VARCHAR(100)
DECLARE @BSECM_TO AS VARCHAR(100)
DECLARE @BSECM_DEL AS VARCHAR(100)
DECLARE @NSECM_TO AS VARCHAR(100)
DECLARE @NSECM_DEL AS VARCHAR(100)
DECLARE @NSEFO_TO AS VARCHAR(100)
DECLARE @NSEFO_DEL AS VARCHAR(100)
DECLARE @NCDEX_TO AS VARCHAR(100)
DECLARE @NCDEX_DEL AS VARCHAR(100)
DECLARE @MCX_TO AS VARCHAR(100)
DECLARE @MCX_DEL AS VARCHAR(100)


SELECT BRANCH_CD,SUB_BROKER ,SUM(TO_TRD_FUT)AS BSECM_TO_TRD_FUT ,SUM(TO_DEL_OPT) AS BSECM_TO_DEL_OPT INTO #TEMPSBBSECM
 FROM MIS_TO_SB  WHERE SUB_BROKER=@SB AND SAUDA_DATE>=@FSDATE+'00:00:00.000' AND 
SAUDA_DATE<= @TSDATE+'00:00:00.000'
 AND COMPANY='ABLCM' GROUP BY SUB_BROKER,BRANCH_CD 

SELECT BRANCH_CD,SUB_BROKER ,SUM(TO_TRD_FUT)AS NSECM_TO_TRD_FUT ,SUM(TO_DEL_OPT) AS NSECM_TO_DEL_OPT INTO #TEMPSBNSECM
 FROM MIS_TO_SB  WHERE SUB_BROKER=@SB AND SAUDA_DATE>=@FSDATE+'00:00:00.000' AND 
SAUDA_DATE<=@TSDATE+' 00:00:00.000'
 AND COMPANY='ACDLCM' GROUP BY SUB_BROKER,BRANCH_CD 

SELECT BRANCH_CD,SUB_BROKER ,SUM(TO_TRD_FUT)AS NSEFO_TO_TRD_FUT ,SUM(TO_DEL_OPT) AS NSEFO_TO_DEL_OPT INTO #TEMPSBNSEFO
 FROM MIS_TO_SB  WHERE SUB_BROKER=@SB AND SAUDA_DATE>=@FSDATE+' 00:00:00.000' AND 
SAUDA_DATE<=@TSDATE+'00:00:00.000'
 AND COMPANY='ACDLFO' GROUP BY SUB_BROKER,BRANCH_CD  

SELECT BRANCH_CD,SUB_BROKER=@SB ,SUM(TO_TRD_FUT)AS NCDEX_TO_TRD_FUT ,SUM(TO_DEL_OPT) AS NCDEX_TO_DEL_OPT INTO #TEMPSBNCDEX
 FROM MIS_TO_SB  WHERE SUB_BROKER=@SB AND SAUDA_DATE>=@FSDATE+'00:00:00.000' AND 
SAUDA_DATE<=@TSDATE+'00:00:00.000'
 AND COMPANY='ACPLNCDX' GROUP BY SUB_BROKER,BRANCH_CD 

SELECT BRANCH_CD,SUB_BROKER ,SUM(TO_TRD_FUT)AS MCX_TO_TRD_FUT ,SUM(TO_DEL_OPT) AS MCX_TO_DEL_OPT INTO #TEMPSBMCX
 FROM MIS_TO_SB  WHERE SUB_BROKER=@SB AND SAUDA_DATE>=@FSDATE+'00:00:00.000' AND 
SAUDA_DATE<=@TSDATE+'00:00:00.000'
 AND COMPANY='ACPLMCX' GROUP BY SUB_BROKER,BRANCH_CD 









SELECT @BRANCH=BRANCH_CD FROM MIS_TO_SB WHERE SUB_BROKER=@SB
SELECT @BSECM_TO=BSECM_TO_TRD_FUT FROM #TEMPSBBSECM
SELECT @BSECM_DEL=BSECM_TO_DEL_OPT FROM #TEMPSBBSECM
SELECT @NSECM_TO=NSECM_TO_TRD_FUT FROM #TEMPSBNSECM
SELECT @NSECM_DEL=NSECM_TO_DEL_OPT FROM #TEMPSBNSECM
SELECT @NSEFO_TO=NSEFO_TO_TRD_FUT FROM #TEMPSBNSEFO
SELECT @NSEFO_DEL=NSEFO_TO_DEL_OPT FROM #TEMPSBNSEFO
SELECT @NCDEX_TO=NCDEX_TO_TRD_FUT FROM #TEMPSBNCDEX
SELECT @NCDEX_DEL=NCDEX_TO_DEL_OPT FROM #TEMPSBNCDEX
SELECT @MCX_TO=MCX_TO_TRD_FUT FROM #TEMPSBMCX
SELECT @MCX_DEL=MCX_TO_DEL_OPT FROM #TEMPSBMCX

TRUNCATE TABLE SB_TRADE_DETAILS
INSERT INTO SB_TRADE_DETAILS VALUES(@BRANCH,@SB,@BSECM_TO,@BSECM_DEL,@NSECM_TO,@NSECM_DEL,
@NSEFO_TO,@NSEFO_DEL,@NCDEX_TO,@NCDEX_DEL,@MCX_TO,@MCX_DEL)

SELECT * FROM SB_TRADE_DETAILS

RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.party_mis
-- --------------------------------------------------
create procedure party_mis(@fdate as varchar(11),@tdate as varchar(11),@pcode as varchar(10))
as
set transaction isolation level read uncommitted
set nocount on

select
branch_Cd,sub_broker,party_code,party_name,sauda_Date,
BSECM_TO=sum(case when company = 'ABLCM' then turnover else 0 end),
NSECM_TO=sum(case when company = 'ACDLCM' then turnover else 0 end),
NSEFO_TO=sum(case when company = 'ACDLFO' then turnover else 0 end),
MCDX_TO=sum(case when company = 'ACPLMCX' then turnover else 0 end),
NCDX_TO=sum(case when company = 'ACPLNCDEX' then turnover else 0 end),
TOTAL_TO=sum(turnover),
BSECM_BR=sum(case when company = 'ABLCM' then brokerage else 0 end),
NSECM_BR=sum(case when company = 'ACDLCM' then brokerage else 0 end),
NSEFO_BR=sum(case when company = 'ACDLFO' then brokerage else 0 end),
MCDX_BR=sum(case when company = 'ACPLMCX' then brokerage else 0 end),
NCDX_BR=sum(case when company = 'ACPLNCDEX' then brokerage else 0 end),
TOTAL_BR=sum(brokerage)
from mis_to 
where sauda_date >=@fdate and sauda_Date <=@tdate
and party_code = @pcode
group by branch_Cd,sub_broker,party_code,party_name,sauda_date

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.period
-- --------------------------------------------------
create procedure period(@fdate as varchar(11),@tdate as varchar(11))
as
set nocount on

select mcdx_to=sum(mcdx_to)/10000000,ncdx_to=sum(ncdx_to)/10000000,
to1=(sum(mcdx_to)+ sum(ncdx_to))/10000000
into #aa
from commo_perf_eval where tdate >= @fdate
and tdate<=@tdate

---drop table #aa
SELECT VALMCX=SUM(CONVERT(MONEY,VALUE))/100 
into #bb
FROM BHAV_MCX_hist where convert(varchar(11),tdate)>=@tdate
and convert(varchar(11),tdate)<=@fdate


SELECT VALNCDX=SUM(CONVERT(MONEY,trade_val))/100 
into #cc
FROM BHAV_ncdx_hist 
where tdate >= @fdate and tdate<=@tdate  and trade_val<>'NA'


--select temp1=((mcdx_to/valmcx)*100)+((ncdx_to/VALNCDX)*100) from #aa ,#bb, #cc

select mrkshar=(to1/(valmcx+VALNCDX))*100 from #aa ,#bb, #cc

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.period_12
-- --------------------------------------------------
CREATE procedure period_12(@fdate as varchar(11), @tdate as varchar(11),@fdate1 as varchar(11), @tdate1 as varchar(11))              
as            
set nocount on            
declare @nodays1 as int    
declare @nodays2 as int  

----devide by 6 
--select @nodays1=count(*) from    
--(select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')    
--and sauda_Date >=@fdate and sauda_Date <=@tdate) a    


----devide by 5 
select @nodays1=count(*)-1 from    
(select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')    
and sauda_Date >=@fdate and sauda_Date <=@tdate) a    
    
----devide by 6 
--select @nodays2=count(*) from (select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')     
--and sauda_Date >=(convert(datetime,@fdate)-datediff(dw,@fdate,@tdate))-1     
--and sauda_Date <=(convert(datetime,@tdate)-datediff(dw,@fdate,@tdate))-1) b    

----devide by 5 
select @nodays2=count(*)-1 from (select distinct sauda_Date from mis_to where company in ('ACPLMCX','ACPLNCDEX')     
and sauda_Date >=(convert(datetime,@fdate)-datediff(dw,@fdate,@tdate))-1     
and sauda_Date <=(convert(datetime,@tdate)-datediff(dw,@fdate,@tdate))-1) b    
             
/*      
declare @fdate as varchar(25)              
declare @tdate as varchar(25)              
set @fdate ='Feb 25 2006'          
set @tdate ='mar 03 2006'              
declare @fdate1 as varchar(25)              
declare @tdate1 as varchar(25)              
set @fdate1 ='mar 11 2006'          
set @tdate1 ='mar 17 2006'              
  */        
DECLARE  @branch_cd varchar,          
@ncurrgross_perday money,          
--@mcurrgross_prday money,          
@mcurrgross_perday money,          
@nlastgross_perday money,@mlastgross_perday money,          
@nlastnet_aperday money,@mlastnet_aperday money,          
@ncurrnet_perday money,@mcurrnet_perday money,          
@totcg money,@totcn money,@totln money,@totlg money,          
@NGcurrRT money,@MGcurrRT money,          
@nlastrt money,@mlastrt money,          
@NNlast money,@MNlast money,          
@NNcurr money,@MNcurr money          
SET @NGcurrRT = 0          
set @MGcurrRT=0          
set @NlastRT=0          
set @MlastRT=0          
set @NNlast=0          
set @MNlast=0          
set @NNcurr=0          
set @MNcurr=0          
          
set @totcg=0          
set @totcn=0          
set @totln=0          
set @totlg=0          
      
      
          
DECLARE rt_cursor CURSOR          
FOR          
          
select a.branch_Cd,           
ncurrgross_perday= isnull(convert(money,sum(ncdx_brok)/@nodays1),0),mcurrgross_perday= isnull(convert(money,sum(mcdx_brok)/@nodays1),0) ,          
ncurrnet_perday= isnull(convert(money,sum(ncdx_ashare)/@nodays1),0),mcurrnet_perday= isnull(convert(money,sum(mcdx_ashare)/@nodays1),0) ,          
Nlastgross_perday=isnull(b.Ngross_perday,0),Mlastgross_perday=isnull(b.Mgross_perday,0),          
Nlastnet_aperday=isnull(b.Nnet_aperday,0),Mlastnet_aperday=isnull(b.Mnet_aperday,0)          
          
from commo_perf_eval a left outer join           
(select branch_cd,           
Ngross_perday= sum(ncdx_brok)/@nodays2,Mgross_perday= sum(mcdx_brok)/@nodays2,          
Nnet_aperday=sum(ncdx_ashare)/@nodays2,Mnet_aperday=sum(mcdx_ashare)/@nodays2           
from commo_perf_eval where          
tdate>=(convert(datetime,@fdate1)) and tdate<=(convert(datetime,@tdate1))          
group by branch_cd ) b on a.branch_cd=b.branch_cd where tdate>=@fdate and tdate<=@tdate          
group by a.branch_cd,branch_name,Ngross_perday,Mgross_perday,Nnet_aperday,Mnet_aperday          
          
          
OPEN rt_cursor          
          
FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday          
,@Nlastgross_perday,@Mlastgross_perday          
,@Nlastnet_aperday,@Mlastnet_aperday          
          
WHILE @@FETCH_STATUS = 0          
          
BEGIN          
 SET @NGcurrRT = @NGcurrRT + @ncurrgross_perday          
 SET @MGcurrRT = @MGcurrRT +@mcurrgross_perday          
 set @totcg=@NGcurrRT+@MGcurrRT          
          
set @NNcurr=@NNcurr+@ncurrnet_perday          
set @MNcurr=@MNcurr+@mcurrnet_perday          
set @totcn=@NNcurr+@MNcurr          
          
set @NlastRT=@NlastRT+@nlastgross_perday          
set @MlastRT=@MlastRT+@mlastgross_perday          
set @totlg=@NlastRT+@MlastRT          
          
set @NNlast=@NNlast+@nlastnet_aperday          
set @MNlast=@MNlast+@mlastnet_aperday          
set @totln=@NNlast+@MNlast          
          
          
---drop table GN_total            --INSERT GN_total VALUES (@totcg,@totcn,@totlg,@totln)          
          
FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday,          
@Nlastgross_perday,@Mlastgross_perday,@Nlastnet_aperday,@Mlastnet_aperday          
END          
select totcg=@totcg,totcn=@totcn,totlg=@totlg,totln=@totln          
CLOSE rt_cursor          
          
DEALLOCATE rt_cursor          
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.period1
-- --------------------------------------------------
CREATE procedure period1(@fdate as varchar(11),@tdate as varchar(11))  
as  
set nocount on  
select mcdx_to=sum(mcdx_to)/10000000,ncdx_to=sum(ncdx_to)/10000000,  
to1=(sum(mcdx_to)+ sum(ncdx_to))/10000000  
into #aa  
from commo_perf_eval where tdate >= @fdate  
and tdate<=@tdate  
SELECT VALMCX=SUM(CONVERT(MONEY,VALUE))/100   
into #bb  
FROM BHAV_MCX_hist where convert(varchar(11),tdate)>=@tdate  
and convert(varchar(11),tdate)<=@fdate  
SELECT VALNCDX=SUM(CONVERT(MONEY,trade_val))/100   
into #cc  
FROM BHAV_ncdx_hist   
where tdate >= @fdate and tdate<=@tdate  and trade_val<>'NA'  
select mrkshar=(to1/(valmcx+VALNCDX))*100 from #aa ,#bb, #cc  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.period12
-- --------------------------------------------------
CREATE procedure period12(@fdate as varchar(11), @tdate as varchar(11),@fdate1 as varchar(11), @tdate1 as varchar(11))        
as      
set nocount on      
       
/*
declare @fdate as varchar(25)        
declare @tdate as varchar(25)        
set @fdate ='Feb 25 2006'    
set @tdate ='mar 03 2006'        
declare @fdate1 as varchar(25)        
declare @tdate1 as varchar(25)        
set @fdate1 ='mar 11 2006'    
set @tdate1 ='mar 17 2006'        
  */  
DECLARE  @branch_cd varchar,    
@ncurrgross_perday money,    
--@mcurrgross_prday money,    
@mcurrgross_perday money,    
@nlastgross_perday money,@mlastgross_perday money,    
@nlastnet_aperday money,@mlastnet_aperday money,    
@ncurrnet_perday money,@mcurrnet_perday money,    
@totcg money,@totcn money,@totln money,@totlg money,    
@NGcurrRT money,@MGcurrRT money,    
@nlastrt money,@mlastrt money,    
@NNlast money,@MNlast money,    
@NNcurr money,@MNcurr money    
SET @NGcurrRT = 0    
set @MGcurrRT=0    
set @NlastRT=0    
set @MlastRT=0    
set @NNlast=0    
set @MNlast=0    
set @NNcurr=0    
set @MNcurr=0    
    
set @totcg=0    
set @totcn=0    
set @totln=0    
set @totlg=0    


    
DECLARE rt_cursor CURSOR    
FOR    
    
select a.branch_Cd,     
ncurrgross_perday= isnull(convert(money,sum(ncdx_brok)/5.5),0),mcurrgross_perday= isnull(convert(money,sum(mcdx_brok)/5.5),0) ,    
ncurrnet_perday= isnull(convert(money,sum(ncdx_ashare)/5.5),0),mcurrnet_perday= isnull(convert(money,sum(mcdx_ashare)/5.5),0) ,    
Nlastgross_perday=isnull(b.Ngross_perday,0),Mlastgross_perday=isnull(b.Mgross_perday,0),    
Nlastnet_aperday=isnull(b.Nnet_aperday,0),Mlastnet_aperday=isnull(b.Mnet_aperday,0)    
    
from commo_perf_eval a left outer join     
(select branch_cd,     
Ngross_perday= sum(ncdx_brok)/5.5,Mgross_perday= sum(mcdx_brok)/5.5,    
Nnet_aperday=sum(ncdx_ashare)/5.5,Mnet_aperday=sum(mcdx_ashare)/5.5     
from commo_perf_eval where    
tdate>=(convert(datetime,@fdate1)) and tdate<=(convert(datetime,@tdate1))    
group by branch_cd ) b on a.branch_cd=b.branch_cd where tdate>=@fdate and tdate<=@tdate    
group by a.branch_cd,branch_name,Ngross_perday,Mgross_perday,Nnet_aperday,Mnet_aperday    
    
    
OPEN rt_cursor    
    
FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday    
,@Nlastgross_perday,@Mlastgross_perday    
,@Nlastnet_aperday,@Mlastnet_aperday    
    
WHILE @@FETCH_STATUS = 0    
    
BEGIN    
 SET @NGcurrRT = @NGcurrRT + @ncurrgross_perday    
 SET @MGcurrRT = @MGcurrRT +@mcurrgross_perday    
 set @totcg=@NGcurrRT+@MGcurrRT    
    
set @NNcurr=@NNcurr+@ncurrnet_perday    
set @MNcurr=@MNcurr+@mcurrnet_perday    
set @totcn=@NNcurr+@MNcurr    
    
set @NlastRT=@NlastRT+@nlastgross_perday    
set @MlastRT=@MlastRT+@mlastgross_perday    
set @totlg=@NlastRT+@MlastRT    
    
set @NNlast=@NNlast+@nlastnet_aperday    
set @MNlast=@MNlast+@mlastnet_aperday    
set @totln=@NNlast+@MNlast    
    
    
---drop table GN_total      
--INSERT GN_total VALUES (@totcg,@totcn,@totlg,@totln)    
    
FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday,    
@Nlastgross_perday,@Mlastgross_perday,@Nlastnet_aperday,@Mlastnet_aperday    
END    
select totcg=@totcg,totcn=@totcn,totlg=@totlg,totln=@totln    
CLOSE rt_cursor    
    
DEALLOCATE rt_cursor    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PG_data
-- --------------------------------------------------
CREATE Proc PG_data(@fdate as varchar(25),@tdate as varchar(25),@br as varchar(7))
as
select sauda_date,branch_cd,sub_broker,party_code,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0),          
 total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)   
into #file1             
  from ebrok_tobr_period (nolock)              
 where sauda_date>=@fdate and sauda_date<=@tdate and branch_cd=@br  
 group by sauda_date,branch_cd,sub_broker,party_code  
             
select  sauda_date,branch,subbrokcode,party_code,            
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),              
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),              
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),              
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),              
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),            
  Net=sum(angel_share)    
  into #file2             
 from mis.remisior.dbo.comb_cli where sauda_date>=@fdate and sauda_date<=@tdate and branch=@br
 group by sauda_date,branch,subbrokcode,party_code  
 select branch_cd,sub_broker,a.party_code,
 To1=sum(isnull(total_turn,0)),Net=sum(isnull(Net,0)),nod=count(distinct a.sauda_date)         
  from              
  #file1         
  a              
 left outer join              
 #file2 b              
 on  a.party_code=b.party_code collate Latin1_General_CI_AS and a.sauda_date=b.sauda_date  
where a.sub_broker='NVASHI'
 group by branch_cd,sub_broker,a.party_code
 order by party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PmsFifo
-- --------------------------------------------------
Create procedure PmsFifo As 

Print 'hello'

Select count(*) From 
(Select Sauda_date = Sauda_date, /* Sett_no,Sett_type, */ Scrip_cd = Scrip_cd,CfPQty = Sum(PqtyDel),CfPamt = Sum(PAmtDel) from Cmbillvalan where party_code = 'BH14' 
Group by Sauda_date, Sett_no,Sett_type, Scrip_cd 
Having Sum(PqtyDel ) > 0
) A 

Select * from 
(Select Sauda_date = Sauda_date, /* Sett_no,Sett_type, */ Scrip_cd = Scrip_cd,CfPQty = Sum(PqtyDel),CfPamt = Sum(PAmtDel) from Cmbillvalan where party_code = 'BH14' 
Group by Sauda_date, Sett_no,Sett_type, Scrip_cd 
Having Sum(PqtyDel ) > 0
/* Order By Sauda_date,Scrip_cd */
) A ,

(
Select Sauda_date = Sauda_date,/* Sett_no,Sett_type, */Scrip_cd = Scrip_cd,CfSQty = Sum(SqtyDel),CfSamt = Sum(SAmtDel) from Cmbillvalan where party_code = 'BH14' 
Group by Sauda_date, Sett_no,Sett_type, Scrip_cd 
Having Sum(SqtyDel ) > 0
/* Order By Sauda_Date,Scrip_cd */
) B
 
/* ( select Sauda_date, Sett_no,Sett_type, Scrip_cd,Purqty = Sum(PQtyTrd + PQtyDel), PurAmt = Sum(PAmtTrd + PAmtDel) from cmbillvalan where party_code = 'BH14' 
Group by Sauda_date, Sett_no,Sett_type, Scrip_cd ) B ,
(
select Sauda_date, Sett_no,Sett_type, Scrip_cd,SaleQty =Sum(SQtyTrd + SQtyDel), SaleAmt = Sum(SAmtTrd + SAmtDel )from cmbillvalan where party_code = 'BH14' 
Group by Sauda_date, Sett_no,Sett_type, Scrip_cd ) S
Where b.Scrip_cd = s.Scrip_cd
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcClientList
-- --------------------------------------------------
CREATE Procedure [dbo].[prcClientList](@StatusID Varchar(25), @StatusName Varchar(25))
As

-- Run As :--
-- EXEC prcClientList 'branch','xpu'
-- EXEC prcClientList 'subbroker','bbv'
-- EXEC prcClientList 'client','BH14'

Begin

select distinct cl_code, [Name]=short_name, [Phone]=Res_phone1 from (
select distinct cl_code, short_name,Res_phone1 from AngelBSECM.bsedb_ab.dbo.client1
where
	branch_cd LIKE (Case When @StatusID = 'BRANCH' THEN @StatusName Else '%' End) And
	sub_broker LIKE (Case When @StatusID = 'SUBBROKER' THEN @StatusName Else '%' End) And
	family LIKE (Case When @StatusID = 'FAMILY' THEN @StatusName Else '%' End) And
	cl_code LIKE (Case When @StatusID = 'CLIENT' THEN @StatusName Else '%' End)
Union All
select distinct cl_code, short_name,Res_phone1 from AngelNseCM.msajag.dbo.client1
where
	branch_cd LIKE (Case When @StatusID = 'BRANCH' THEN @StatusName Else '%' End) And
	sub_broker LIKE (Case When @StatusID = 'SUBBROKER' THEN @StatusName Else '%' End) And
	family LIKE (Case When @StatusID = 'FAMILY' THEN @StatusName Else '%' End) And
	cl_code LIKE (Case When @StatusID = 'CLIENT' THEN @StatusName Else '%' End)
Union All
select distinct cl_code, short_name,Res_phone1 from angelfo.nsefo.dbo.client1
where
	branch_cd LIKE (Case When @StatusID = 'BRANCH' THEN @StatusName Else '%' End) And
	sub_broker LIKE (Case When @StatusID = 'SUBBROKER' THEN @StatusName Else '%' End) And
	family LIKE (Case When @StatusID = 'FAMILY' THEN @StatusName Else '%' End) And
	cl_code LIKE (Case When @StatusID = 'CLIENT' THEN @StatusName Else '%' End)
) TMP

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcDrill
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.prcDrill    Script Date: 12/07/2005 3:53:42 PM ******/



/****** Object:  Stored Procedure dbo.prcDrill    Script Date: 10/26/2005 7:40:35 PM ******/
CREATE     PROCEDURE prcDrill

/* NEW MODIFIED  - 23 Jun 2005 11:56 AM */
-- In this Branchwise, SegmentWise, AllTotals, Branch SubBroker Wise,
-- corrected Dates in from - to, Percentage and TOP are working fine.
-- A parameter is added here for selecting the order for the TOP 
-- One more parameter is added for Exchange Segment

/*
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','HO','','','','','0',' ',0
	prcDrill 'Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	prcDrill 'AllTotals', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'clientwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
*/

(
	@Consol varchar(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker */
	@DateFrom varchar(50) = '',
	@DateTo varchar(50) = '',
	@Year varchar(4) = '',
	@Month varchar(15) = '',
	@BranchCode varchar(10) = '',
	@Exchange varchar(10) = '',
	@SubBroker varchar(10) = '',
	@Family varchar(10) = '',
	@Party varchar(10) = '',
	@SelectTop int = 0,
	@SelectOrderBy varchar(200) = '',
	@flgSegment int = 0
)

AS

DECLARE	
	--@dd as varchar(6000),
	@@SELECT AS varchar(6000),
	@@FROM AS varchar(4000),
	@@WHERE AS varchar(6000),
	@@GROUPBY AS varchar(2000),
	@@ORDERBY AS varchar(2000),
	@@SELECT_FINAL AS varchar(6000),
	
	@@TOTVOLUME AS money,
	@@TOTTURNOVER AS money,
	@@TOTBROKERAGE AS money,
	@@TOTSELECT AS varchar(6000),
	@@TOTWHERE AS varchar(6000),
	@@strTotVolume as varchar(80),
	@@strTotTurnOver as varchar(80),
	@@strTotBrokerage as varchar(80),
	@@ErrId int
-----------------------------------------------------------------------------------------------------

--Initialization of variables
set @@SELECT  = '' 
set @@FROM  = '' 
set @@WHERE  = '' 
set @@GROUPBY  = '' 
set @@ORDERBY  = '' 
set @@SELECT_FINAL  = '' 
-----------------------------------------------------------------------------------------------------

-- This is Select part for the totals which are used in the Percentage. 
IF (  @Month <> '' AND @Consol <> 'BranchSubbroker')
	BEGIN
		SET @@TOTSELECT = ' SELECT  SUM ( cast(TP as money) + TS + DP + DS ) as TotalVolume, SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TotalTurnOver, SUM (cast(TPB as money) + TSB + DPB + DSB) as TotalBrokerage '
	END
ELSE
	BEGIN
		SET @@TOTSELECT = ' SELECT SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) as TotalVolume, SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) as TotalTurnOver, SUM (cast(TradingPurBrok as money)+ TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) as TotalBrokerage '
	END

-----------------------------------------------------------------------------------------------------

-- This is where part for the Totals which ate used in the Percentage
--SET @@TOTWHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date  <= CONVERT( DATETIME, ''' + @DateTo + '''  ) '


-----------------------------------------------------------------------------------------------------
-- START OF FROM

Declare @@IsLevel1 varchar(1), @@IsBrokName varchar(1)
Set @@IsBrokName = 'N'
Set @@IsLevel1 = 'N'

		IF (@Month = '' Or @Consol = 'BranchSubbroker')
			Begin
				If @BranchCode = '' And @SubBroker = '' And @Family = '' And @Party = '' And @Exchange = ''
					Begin
						If @Consol = 'BranchSubbroker' Or @Consol = 'Branchwise'
							Begin
								SET @@FROM  = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B '
								Set @@IsBrokName = 'Y'
							End
						Else
							SET @@FROM  = ' FROM Level6Mis A '
					End
				Else
					Begin
						If @Party = '' And @Family = '' And @SubBroker =''
						 Begin
							Set @@FROM = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B  '
							Set @@IsBrokName = 'Y'
						 End
						Else 
							If @Family = '' And @Party = ''
								Set @@FROM = ' FROM Level3Mis A '
							Else
								Set @@FROM = ' FROM Level2Mis A '
					End

				If ( @Consol = 'Clientwise' )
					Begin
						Set @@FROM = ' FROM Level2Mis A '
						Set @@IsBrokName = 'N'
					End
			END
		ELSE
			BEGIN
				SET @@FROM  = ' FROM Level1Mis A '
				Set @@IsLevel1 = 'Y'
			END

--END OF FROM
-----------------------------------------------------------------------------------------------------

If @Month = ''	Or @Consol = 'BranchSubbroker'
	SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
Else
	SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month


If @BranchCode <> ''
	Set @@WHERE = @@WHERE + ' and Branch_cd = ''' + @BranchCode + ''''
If @SubBroker <> ''
	Set @@WHERE = @@WHERE + ' and A.Sub_Broker = ''' + @SubBroker + ''''
If @Family <> ''
	Set @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
If @Party <> ''
	Set @@WHERE = @@WHERE + ' and Party_Code = ''' + @Party + ''''
If @Exchange <> ''
	Set @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
If @Year <> ''
	Begin
		If @@IsLevel1 = 'N'
			Set @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		Else
			Set @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	End

If @@IsBrokName = 'Y'
	Set @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '

--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @BranchCode = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd '				
					end		
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
							end
						else
							begin
								SET @@GROUPBY  = ' GROUP BY [Year] '		
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
									end		
							END
					END
			END
	END

IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
			END
		ELSE
			BEGIN
				IF ( @year = '' )
					BEGIN	
						SET @@GROUPBY =  ' GROUP BY [Year] '
					END	
				ELSE
					BEGIN
						IF (@Month = '' )
							BEGIN
								SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
							END
						ELSE
							BEGIN
								SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
							END
					END
			END
	END

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY [Year], Exchangesegment '								
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY [Year] '		
					end		
			END
		ELSE
			BEGIN	
				IF ( @Month = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
							end		
					END
			END
	END


IF (@Consol = 'Clientwise' )
	SET @@GROUPBY = ' GROUP BY Party_Code '
	If ( @flgSegment = 1 )
		SET @@GROUPBY = @@GROUPBY + ' ,ExchangeSegment '


IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd '									
					end		
			END
		ELSE
			BEGIN
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name, ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name '				
							end		
					END
				ELSE
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Family '				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Party_code '		
									end		
							END
					END
			END
	END
--END OF GROUP BY
-----------------------------------------------------------------------------------------------------
-- START OF ORDER BY
If ( @SelectOrderBy = '' )
	Begin
		IF ( @Consol = 'BranchWise' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY  = ' ORDER BY Branch_cd'
					END
				ELSE
					BEGIN
						IF ( @Year = '' )
							BEGIN
								SET @@ORDERBY  = ' ORDER BY [YEAR]'
							END
						ELSE
							BEGIN
								IF ( @Month = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY [Year], [Month] '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
									END
							END
					END
			END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
				END
			ELSE
				BEGIN	
					IF ( @Year = '' ) 
						BEGIN
							SET @@ORDERBY  = ' ORDER BY [YEAR] '  
						END
					ELSE
						BEGIN
							IF ( @Month = '' ) 
								BEGIN
									SET @@ORDERBY  = ' ORDER BY [Month] '
								END
							ELSE
								BEGIN
									SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
								END
						END
				END
		END

		IF (@Consol = 'AllTotals' )
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Year] '
				END
			ELSE
				BEGIN
					IF ( @Month = '' )
						BEGIN
							SET @@ORDERBY = ' ORDER BY [Month] '		
						END
					ELSE
						BEGIN
							SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
						END
				END
			END

		IF (@Consol = 'Clientwise' ) 
			SET @@ORDERBY = ' ORDER BY Party_Code '
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Branch_cd '	
					END
				ELSE
					BEGIN
						IF ( @SubBroker = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY A.Sub_Broker '
							END
						ELSE
							BEGIN
								IF ( @Family = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY Family '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY Party_code'
									END
							END				
					END
			END
	End
Else
	Begin
		Set @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	End
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

-- Concatenating and Execution of Totals in the Percentage
--EXEC ( @@TOTSELECT + @@FROM + @@WHERE ) 
--print ( @@TOTSELECT + @@FROM + @@WHERE ) 

--print @@TOTSELECT + @@FROM + @@WHERE + '---------------'
Create Table #TotalAll (TotVolume  money, TotTurnOver  money, TotBrokerage  money )
--Insert #TotalAll
Exec ('insert #TotalAll '+@@TOTSELECT + @@FROM + @@WHERE)
select @@TotVolume=convert(money,TotVolume) ,@@TotTurnOver=convert(money,TotTurnOver),@@TotBrokerage=convert(money,TotBrokerage) from  #TotalAll
Drop Table #TotalAll

--print @@TotVolume
--print @@TotTurnOver
--print @@TotBrokerage

select @@strTotVolume = cast(@@TotVolume as varchar)
--print @@strTotVolume
select @@strTotTurnOver = cast(@@TotTurnOver as varchar)
select @@strTotBrokerage = cast(@@TotBrokerage as varchar)

If ( @@strTotVolume = '' Or @@strTotVolume = '0' Or @@strTotVolume Is Null ) 
begin
	set @@strTotVolume = 1
end

if  ( @@strTotTurnOver = '' Or @@strTotTurnOver = '0' Or @@strTotTurnOver Is Null )
begin	
	set @@strTotTurnOver = 1
end

if ( @@strTotBrokerage = '' Or @@strTotBrokerage = '0' Or @@strTotBrokerage Is Null )
begin
	set @@strTotBrokerage = 1
end

--select @@strTotBrokerage

-----------------------------------------------------------------------------------------------------
/******
	Actual Query
******/


Declare @@Temp varchar(4000)

If @Month = '' Or @Consol = 'BranchSubbroker'
	Set @@Temp = 'SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
Else
	Set @@Temp = 'SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '




-- START OF SELECT
IF ( @Consol = 'BranchWise' )
	BEGIN
		--print 'aaa'
		IF ( @BranchCode = '') 
			BEGIN	
				--print 'bbb'
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(Rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ' + @@Temp
					end
			END
		ELSE
			BEGIN
				IF ( @Year = '')
					BEGIN
						If (@@IsLevel1 = 'Y')
							SET @@SELECT =  ' [Year]= Datepart(Year,Sauda_Date) '
						Else
							SET @@SELECT =  ' [Year] '

						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = @@Select + ' , ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = @@Select + ' , ' + @@Temp
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ExchangeSegment as [Exchange Segment], ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ' + @@Temp
									end		
							END
						ELSE
							BEGIN 
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment  as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
									end		
							END
					END
			END
	END

IF (@Consol = 'Clientwise' )
	Begin
		SET @@SELECT = ' Party_Code, ' + @@Temp
		If ( @flgSegment = 1 )
			SET @@SELECT = ' Party_Code,[Exchange Segment] = ExchangeSegment,  ' + @@Temp
	End



IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@SELECT = ' ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						SET @@SELECT = ' [Year], ' + @@Temp
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ' + @@Temp
							END
						ELSE
							BEGIN	
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
							END
					END
			END
	END 

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  [Year], ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
					end
				else
					begin
						SET @@SELECT = '  [Year], SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '														
					end		
			END
		ELSE
			BEGIN
				IF ( @Month = '' )
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
							end
						else
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '																	
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment as ''Exchange Segment'', SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '															
							end
						else
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) /10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '			
							end		
						
					END
			END
	END
	
IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), '  + @@Temp
					end		
			END
		ELSE	
			BEGIN	
--print 'specified the branch'
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name, ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name,  '  + @@Temp
							end		
					END
				ELSE
--print 'specified the sub broker'
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Family, ExchangeSegment as ''Exchange Segment'', '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Family, '  + @@Temp
									end		
							END
						ELSE	
--print 'specified the family'	
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Party_code, ExchangeSegment as ''Exchange Segment'' , '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Party_code, '  + @@Temp
									end		
								
--print @@strTOTTURNOVER
--print @@SELECT
							END
					END
			END	
	END	


--END OF SELECT
-----------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------

--START OF @@SELECT_FINAL
---print 'ccc'
IF ( @SelectTop = 0 )
begin
--	print 'ddd'
	SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
--	print @@SELECT_FINAL
---print 'eee'
end
ELSE
	SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL
-----------------------------------------------------------------------------------------------------
--If ( @@SELECT <> '' )
--	Begin
--	

	EXEC ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )
	Print (@@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY)

--	End
/*
Set @@ErrId = @@ERROR
If @@ErrId <> 0 
	Begin
		RAISERROR ( 'An error occured', 10, 1 )
	End
*/
--print 'reached the print' 
--print @@SELECT_FINAL
--PRINT ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcDrill_Executive
-- --------------------------------------------------

CREATE  PROCEDURE prcDrill_Executive

-- This prcDrill is Developed for Executive wise Reports.
-- Also it has same parameter as prcDrill other than Executewise parameters.

/*
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '', '', 'DELHI', '', '', '', '', '0', '', 0, 'NITA RAJAN', 'VIJAYA KULKARNI', 'SUHAS SHINDE' 
	prcDrill_Executive 'RegionExecutive', '1 Jun 2005', '15 Nov 2005', '', '', 'AHD', '', '', '', '', '0', '', 0, '', 'SURESH NENE', 'NIRAJ SHAHA' 
	prcDrill_Executive 'FieldExecutive', '1 Jun 2005', '15 Nov 2005', '', '', 'BNG', '', '', '', '', '0', '', 0, '', '', 'RAJAN PATIL'
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '', '', 'XPU', '', '', '', '', '0', '', 0, ''
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '', '', '', '', '', '', '', '0', '', 0, 'RAJ SHARMA'
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '', '', 'BAN', '', '', '', '', '0', '', 0, 'RAJ SHARMA'
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '', '', 'XPU', '', 'PGS', '', '', '0', '', 0, 'RAJ SHARMA'
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '', '', '', '', '', '', '', '0', '', 0, 'KETAN PATIL'
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '', '', 'XPU', '', '', '', '', '0', '', 1, 'KETAN PATIL'
	prcDrill_Executive 'MarketHead', '1 Jun 2005', '15 Nov 2005', '2005', '', '', '', '', '', '', '0', '', 1, ''
*/

(
	@Consol varchar(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker, Executivewise - MarketHead, RegionExecutive, FieldExecutive */
	@DateFrom varchar(50) = '',
	@DateTo varchar(50) = '',
	@Year varchar(4) = '',
	@Month varchar(15) = '',
	@BranchCode varchar(10) = '',
	@Exchange varchar(10) = '',
	@SubBroker varchar(10) = '',
	@Family varchar(10) = '',
	@Party varchar(10) = '',
	@SelectTop int = 0,
	@SelectOrderBy varchar(200) = '',
	@flgSegment int = 0,
	@MarketHead varchar(100) = '',
	@RegionExecutive varchar(100) = '',
	@FieldExecutive varchar(100) = ''
)

AS

DECLARE	
	--@dd as varchar(6000),
	@@SELECT AS varchar(6000),
	@@FROM AS varchar(4000),
	@@WHERE AS varchar(6000),
	@@GROUPBY AS varchar(2000),
	@@ORDERBY AS varchar(2000),
	@@SELECT_FINAL AS varchar(6000),
	
	--@@TOTVOLUME AS money,
	--@@TOTTURNOVER AS money,
	--@@TOTBROKERAGE AS money,
	@@TOTSELECT AS varchar(6000),
	@@TOTWHERE AS varchar(6000),
	@@strTotVolume as varchar(80),
	@@strTotTurnOver as varchar(80),
	@@strTotBrokerage as varchar(80),
	@@ErrId int

-----------------------------------------------------------------------------------------------------

--Initialization of variables
set @@SELECT  = '' 
set @@FROM  = '' 
set @@WHERE  = '' 
set @@GROUPBY  = '' 
set @@ORDERBY  = '' 
set @@SELECT_FINAL  = '' 
-----------------------------------------------------------------------------------------------------

-- This is Select part for the totals which are used in the Percentage. 
SET @@TOTSELECT = ' '
SET @@TOTSELECT = @@TOTSELECT + ' SELECT TotVolume = SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ), ' 
SET @@TOTSELECT = @@TOTSELECT + ' TotTurnover = SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ), '
SET @@TOTSELECT = @@TOTSELECT + ' TotBrokerage = SUM (cast(TradingPurBrok as money)+ TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) '

-----------------------------------------------------------------------------------------------------

-- START OF FROM

/*

Declare @@IsLevel1 varchar(1), @@IsBrokName varchar(1)
Set @@IsBrokName = 'N'
Set @@IsLevel1 = 'N'

*/

If ( @Consol = 'MarketHead' )
	
	Begin 
		If ( @MarketHead = '' )
			Begin
				Set @@FROM = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketHeadMaster H '
			End
		Else
			If ( @RegionExecutive = '' )
				Begin
					Set @@FROM = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketHeadMaster H, intranet.AngelCS.dbo.tblMarketExecRegionMaster R '
				End
			Else
				--If ( @FieldExecutive = '' )
				--	Begin
						Set @@FROM  = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketHeadMaster H, intranet.AngelCS.dbo.tblMarketExecRegionMaster R, intranet.AngelCS.dbo.tblMarketExecFieldMaster F ' 
				--	End
				--Else
				--	If ( @SubBroker = '' )
				--		Begin
				--			Set @@FROM  = ' FROM Level2Mis A, /* Anand.Bsedb_ab.dbo.subbrokers B, */ intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketHeadMaster H, intranet.AngelCS.dbo.tblMarketExecRegionMaster R, intranet.AngelCS.dbo.tblMarketExecFieldMaster F ' 
				--		End
				--	Else
				--		Begin
				--			--Set @@FROM  = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W /* , intranet.AngelCS.dbo.tblMarketExecFieldMaster F */ ' 
				--			Set @@FROM  = ' FROM Level2Mis A, /* Anand.Bsedb_ab.dbo.subbrokers B, */ intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketHeadMaster H, intranet.AngelCS.dbo.tblMarketExecRegionMaster R, intranet.AngelCS.dbo.tblMarketExecFieldMaster F '
				--		End
	End

If ( @Consol = 'RegionExecutive' )
	
	Begin 
		If ( @RegionExecutive = '' )
			Begin
				Set @@FROM = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecRegionMaster R '
			End
		Else
			If ( @FieldExecutive = '' )
				Begin
					Set @@FROM  = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecRegionMaster R, intranet.AngelCS.dbo.tblMarketExecFieldMaster F ' 
				End
			Else
				--If ( @SubBroker = '' )
				--	Begin
						Set @@FROM  = ' FROM Level2Mis A, /* Anand.Bsedb_ab.dbo.subbrokers B, */ intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecRegionMaster R, intranet.AngelCS.dbo.tblMarketExecFieldMaster F ' 
				--	End
				--Else
				--	Begin
				--		--Set @@FROM  = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W /* , intranet.AngelCS.dbo.tblMarketExecFieldMaster F */ ' 
				--		Set @@FROM  = ' FROM Level2Mis A, /* Anand.Bsedb_ab.dbo.subbrokers B, */ intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecRegionMaster R, intranet.AngelCS.dbo.tblMarketExecFieldMaster F '
				--	End
	End

If ( @Consol = 'FieldExecutive' )
	
	Begin 
		If ( @FieldExecutive = '' )
			Begin
				Set @@FROM  = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecFieldMaster F ' 
			End
		Else
			--If ( @SubBroker = '' )
			--	Begin
					Set @@FROM  = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecFieldMaster F ' 
			--	End
			--Else
			--	Begin
			--		--Set @@FROM  = ' FROM Level2Mis A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W /* , intranet.AngelCS.dbo.tblMarketExecFieldMaster F */ ' 
			--		Set @@FROM  = ' FROM Level2Mis A, /* Anand.Bsedb_ab.dbo.subbrokers B, */ intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecRegionMaster R, intranet.AngelCS.dbo.tblMarketExecFieldMaster F '
			--	End
	End


--END OF FROM
-----------------------------------------------------------------------------------------------------
--START OF WHERE

If @Consol = 'MarketHead'
	BEGIN
		SET @@WHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT( DATETIME, ''' + @DateTo + ''' ) '
		
		SET @@WHERE = @@WHERE + ' AND BranchCode = A.Branch_cd '
		SET @@WHERE = @@WHERE + ' AND SubbrokerOrRemisierCode = A.Sub_Broker '
		SET @@WHERE = @@WHERE + ' AND W.Deleted = ''N'' '
		/* SET @@WHERE = @@WHERE + ' AND W.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */

		BEGIN
			If ( @MarketHead = '' )
				Begin
					SET @@WHERE = @@WHERE + ' AND H.Deleted = ''N'' '
					/* SET @@WHERE = @@WHERE + ' AND H.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
					SET @@WHERE = @@WHERE + ' AND W.MarketHeadId = H.MarketHeadId '
				End
			Else
				Begin
					If ( @RegionExecutive = '' )
						Begin
							SET @@WHERE = @@WHERE + ' AND R.Deleted = ''N'' '
							/* SET @@WHERE = @@WHERE + ' AND R.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
							SET @@WHERE = @@WHERE + ' AND W.MarketHeadId = H.MarketHeadId '
							SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId '
						End
					Else
						If ( @FieldExecutive = '' )
							Begin
								SET @@WHERE = @@WHERE + ' AND F.Deleted = ''N'' '
								/* SET @@WHERE = @@WHERE + ' AND F.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
								SET @@WHERE = @@WHERE + ' AND W.MarketHeadId = H.MarketHeadId '
								SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId '
								SET @@WHERE = @@WHERE + ' AND W.MarketExecFieldId = F.MarketExecFieldId '	
							End
						Else
							--
							--If ( @Subbroker = '' )
							Begin
								SET @@WHERE = @@WHERE + ' AND W.Deleted = ''N'' '
								/* SET @@WHERE = @@WHERE + ' AND W.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
								SET @@WHERE = @@WHERE + ' AND W.MarketHeadId = H.MarketHeadId '
								SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId '
								SET @@WHERE = @@WHERE + ' AND W.MarketExecFieldId = F.MarketExecFieldId '
							End
		
		
			
				End
		END

		If @MarketHead <> ''
			SET @@WHERE = @@WHERE + ' and MarketHeadName = ''' + @MarketHead + ''''
		If @RegionExecutive <> ''
			SET @@WHERE = @@WHERE + ' and ExecName = ''' + @RegionExecutive + ''''
		If @FieldExecutive <> ''
			Set @@WHERE = @@WHERE + ' and FieldExecName = ''' + @FieldExecutive + ''''
		If @BranchCode <> ''
			Set @@WHERE = @@WHERE + ' and BranchCode = ''' + @BranchCode + ''''
		If @SubBroker <> ''
			Set @@WHERE = @@WHERE + ' and SubbrokerOrRemisierCode = ''' + @SubBroker + ''''
		If @Exchange <> ''
			Set @@WHERE = @@WHERE + ' and W.ExchSeg = ''' + @Exchange + ''''

	END

If @Consol = 'RegionExecutive'
	BEGIN
		SET @@WHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT( DATETIME, ''' + @DateTo + ''' ) '
		
		SET @@WHERE = @@WHERE + ' AND BranchCode = A.Branch_cd '
		SET @@WHERE = @@WHERE + ' AND SubbrokerOrRemisierCode = A.Sub_Broker '
		SET @@WHERE = @@WHERE + ' AND W.Deleted = ''N'' '
		/* SET @@WHERE = @@WHERE + ' AND W.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */

		BEGIN
			If ( @RegionExecutive = '' )
				Begin
					SET @@WHERE = @@WHERE + ' AND R.Deleted = ''N'' '
					/* SET @@WHERE = @@WHERE + ' AND R.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
					SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId '
				End
			Else
				Begin
					If ( @FieldExecutive = '' )
						Begin
							SET @@WHERE = @@WHERE + ' AND F.Deleted = ''N'' '
							/* SET @@WHERE = @@WHERE + ' AND F.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
							SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId '
							SET @@WHERE = @@WHERE + ' AND W.MarketExecFieldId = F.MarketExecFieldId '	
						End
					Else
						--
						--If ( @Subbroker = '' )
						Begin
							SET @@WHERE = @@WHERE + ' AND W.Deleted = ''N'' '
							/* SET @@WHERE = @@WHERE + ' AND W.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
							SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId '
							SET @@WHERE = @@WHERE + ' AND W.MarketExecFieldId = F.MarketExecFieldId '
						End
				End
		END

		If @RegionExecutive <> ''
			SET @@WHERE = @@WHERE + ' and ExecName = ''' + @RegionExecutive + ''''
		If @FieldExecutive <> ''
			Set @@WHERE = @@WHERE + ' and FieldExecName = ''' + @FieldExecutive + ''''
		If @BranchCode <> ''
			Set @@WHERE = @@WHERE + ' and BranchCode = ''' + @BranchCode + ''''
		If @SubBroker <> ''
			Set @@WHERE = @@WHERE + ' and SubbrokerOrRemisierCode = ''' + @SubBroker + ''''
		If @Exchange <> ''
			Set @@WHERE = @@WHERE + ' and W.ExchSeg = ''' + @Exchange + ''''

	END


If @Consol = 'FieldExecutive'
	BEGIN
		SET @@WHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT( DATETIME, ''' + @DateTo + ''' ) '
		
		SET @@WHERE = @@WHERE + ' AND BranchCode = A.Branch_cd '
		SET @@WHERE = @@WHERE + ' AND SubbrokerOrRemisierCode = A.Sub_Broker '
		SET @@WHERE = @@WHERE + ' AND W.Deleted = ''N'' '
		/* SET @@WHERE = @@WHERE + ' AND W.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */

		BEGIN
			If ( @FieldExecutive = '' )
				Begin
					SET @@WHERE = @@WHERE + ' AND F.Deleted = ''N'' '
					/* SET @@WHERE = @@WHERE + ' AND F.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
					/* SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId ' */
					SET @@WHERE = @@WHERE + ' AND W.MarketExecFieldId = F.MarketExecFieldId '
				End
			Else
				--
				--If ( @Subbroker = '' )
				Begin
					SET @@WHERE = @@WHERE + ' AND W.Deleted = ''N'' '
					/* SET @@WHERE = @@WHERE + ' AND W.Eff_ToDate = ''Dec 31 2999 23:59:00'' ' */
					/* SET @@WHERE = @@WHERE + ' AND W.MarketExecRegionId = R.MarketExecRegionId ' */
					SET @@WHERE = @@WHERE + ' AND W.MarketExecFieldId = F.MarketExecFieldId '
				End
		END

		If @FieldExecutive <> ''
			Set @@WHERE = @@WHERE + ' and FieldExecName = ''' + @FieldExecutive + ''''
		If @BranchCode <> ''
			Set @@WHERE = @@WHERE + ' and BranchCode = ''' + @BranchCode + ''''
		If @SubBroker <> ''
			Set @@WHERE = @@WHERE + ' and SubbrokerOrRemisierCode = ''' + @SubBroker + ''''
		If @Exchange <> ''
			Set @@WHERE = @@WHERE + ' and W.ExchSeg = ''' + @Exchange + ''''

	END



--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY

IF ( @Consol = 'MarketHead' )

	BEGIN
		IF ( @MarketHead = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketHeadId, MarketHeadName, W.ExchSeg '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketHeadId, MarketHeadName '
					end		
			END
		ELSE
			IF ( @RegionExecutive = '')
				BEGIN
					If ( @flgSegment = 1 )
						begin
							SET @@GROUPBY  = ' GROUP BY W.MarketExecRegionId, ExecName, W.ExchSeg '							
						end
					else
						begin
							SET @@GROUPBY  = ' GROUP BY W.MarketExecRegionId, ExecName '
						end
				END
			ELSE
				BEGIN
					IF ( @FieldExecutive = '')
						BEGIN
							If ( @flgSegment = 1 )
								begin
									SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName, W.ExchSeg '							
								end
							else
								begin			
									SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName '
								end		
						END
					ELSE
						BEGIN	 
							IF ( @BranchCode = '')
								BEGIN
									If ( @flgSegment = 1 )
										begin
											SET @@GROUPBY  = ' GROUP BY BranchCode, W.ExchSeg '
										end
									else
										begin				
											SET @@GROUPBY  = ' GROUP BY BranchCode '
										end		
								END
							ELSE
								BEGIN
									IF ( @SubBroker = '' )
										BEGIN
											If ( @flgSegment = 1 )
												begin
													SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode, /* B.Name, */ W.ExchSeg '
												end
											else
												begin
													SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode /* , B.Name */ '				
												end
										END
									
									ELSE
										BEGIN
											If ( @flgSegment = 1)
												begin
													SET @@GROUPBY = ' GROUP BY Party_code, W.ExchSeg '
												end
											else
												begin
													SET @@GROUPBY = ' GROUP BY Party_code'
												end
										END
								END
						END
				END
	END



IF ( @Consol = 'RegionExecutive' )

	BEGIN
		IF ( @RegionExecutive = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketExecRegionId, ExecName, W.ExchSeg '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketExecRegionId, ExecName '
					end
			END
		ELSE
			BEGIN
				IF ( @FieldExecutive = '')
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName, W.ExchSeg '							
							end
						else
							begin		
								SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName '
							end		
					END
				ELSE
					BEGIN	 
						IF ( @BranchCode = '')
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY BranchCode, W.ExchSeg '
									end
								else
									begin			
										SET @@GROUPBY  = ' GROUP BY BranchCode '
									end		
							END
						ELSE
							BEGIN
								IF ( @SubBroker = '' )
									BEGIN
										If ( @flgSegment = 1 )
											begin
												SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode, /* B.Name, */ W.ExchSeg '
											end
										else
											begin
												SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode /* , B.Name */ '				
											end
									END
								
								ELSE
									BEGIN
										If ( @flgSegment = 1)
											begin
												SET @@GROUPBY = ' GROUP BY Party_code, W.ExchSeg '
											end
										else
											begin
												SET @@GROUPBY = ' GROUP BY Party_code'
											end
									END
							END
					END
			END
	END


IF ( @Consol = 'FieldExecutive' )

	BEGIN
		IF ( @FieldExecutive = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName, W.ExchSeg '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName '
					end		
			END
		ELSE
			BEGIN	 
				IF ( @BranchCode = '')
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY BranchCode, W.ExchSeg '
							end
						else
							begin	
								SET @@GROUPBY  = ' GROUP BY BranchCode '
							end		
					END
				ELSE
					BEGIN
						IF ( @SubBroker = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode, /* B.Name, */ W.ExchSeg '
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode /* , B.Name */ '				
									end
							END
						
						ELSE
							BEGIN
								If ( @flgSegment = 1)
									begin
										SET @@GROUPBY = ' GROUP BY Party_code, W.ExchSeg '
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Party_code'
									end
							END
					END
			END
	END


--END OF GROUP BY
-----------------------------------------------------------------------------------------------------
-- START OF ORDER BY

IF ( @SelectOrderBy = '' AND @Consol = 'MarketHead' )
	Begin
		IF ( @MarketHead = '' )
			BEGIN
				SET @@ORDERBY = ' ORDER BY MarketHeadName '	
			END
		ELSE
			BEGIN
				IF ( @RegionExecutive = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY ExecName '
					END
				ELSE
					BEGIN
						IF ( @FieldExecutive = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY FieldExecName '
							END
						ELSE
							BEGIN
								IF ( @BranchCode = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY BranchCode '
									END
								ELSE
									IF ( @SubBroker = '' )
										BEGIN
											SET @@ORDERBY = ' ORDER BY SubbrokerOrRemisierCode '	
										END
									ELSE
										BEGIN
											SET @@ORDERBY = ' ORDER BY Party_code '
										END


							END
					END
			END
	END
ELSE
	--Begin
	--	Set @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	--End



	IF ( @SelectOrderBy = '' AND @Consol = 'RegionExecutive' )
		Begin
			IF ( @RegionExecutive = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY ExecName '
				END
			ELSE
				BEGIN
					IF ( @FieldExecutive = '' )
						BEGIN
							SET @@ORDERBY = ' ORDER BY FieldExecName '
						END
					ELSE
						BEGIN
							IF ( @BranchCode = '' )
								BEGIN
									SET @@ORDERBY = ' ORDER BY BranchCode '
								END
							ELSE
								IF ( @SubBroker = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY SubbrokerOrRemisierCode '	
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY Party_code '
									END
	
	
						END
				END
		End
	ELSE

		IF ( @SelectOrderBy = '' AND @Consol = 'FieldExecutive' )
			Begin
				IF ( @FieldExecutive = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY FieldExecName '
					END
				ELSE
					BEGIN
						IF ( @BranchCode = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY BranchCode '
							END
						ELSE
							IF ( @SubBroker = '' )
								BEGIN
									SET @@ORDERBY = ' ORDER BY SubbrokerOrRemisierCode '	
								END
							ELSE
								BEGIN
									SET @@ORDERBY = ' ORDER BY Party_code '
								END


					END
			End
		ELSE
		
			Begin
				Set @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
			End

--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

-- Concatenating and Execution of Totals in the Percentage
--EXEC ( @@TOTSELECT + @@FROM + @@WHERE ) 
--print ( @@TOTSELECT + @@FROM + @@WHERE ) 

print @@TOTSELECT + @@FROM + @@WHERE + '---------------'
/* THIS WAS THE OLD LOGIC IN WHICH TOTALS SUM IS STORED THE THE TEMPORARY TABLE. */
/*
Create Table #TotalAll (TotVolume  money, TotTurnOver  money, TotBrokerage  money )
--Insert #TotalAll
Exec ('insert #TotalAll '+@@TOTSELECT + @@FROM + @@WHERE)
select @@TotVolume=convert(money,TotVolume) ,@@TotTurnOver=convert(money,TotTurnOver),@@TotBrokerage=convert(money,TotBrokerage) from  #TotalAll
Drop Table #TotalAll
*/
--Exec (@@TOTSELECT + @@FROM + @@WHERE)
Declare @SumQuery varchar(7000)

SET @SumQuery = (@@TOTSELECT + @@FROM + @@WHERE)

--Print (@SumQuery)

--SELECT @@TotVolume
--SELECT @@TotTurnOver
--SELECT @@TotBrokerage

/*
select @@strTotVolume = cast(@@TotVolume as varchar)
select @@strTotTurnOver = cast(@@TotTurnOver as varchar)
select @@strTotBrokerage = cast(@@TotBrokerage as varchar)


If ( @@strTotVolume = '' Or @@strTotVolume = '0' Or @@strTotVolume Is Null  ) 
begin
	set @@strTotVolume = 1
end

if  ( @@strTotTurnOver = '' Or @@strTotTurnOver = '0' Or @@strTotTurnOver Is Null )
begin	
	set @@strTotTurnOver = 1
end

if ( @@strTotBrokerage = '' Or @@strTotBrokerage = '0' Or @@strTotBrokerage Is Null )
begin
	set @@strTotBrokerage = 1
end
*/
--select @@strTotBrokerage

-----------------------------------------------------------------------------------------------------
/******
	Actual Query
******/


Declare @@Temp varchar(4000)

-- FOR EXECUTIVE SHOW FIGURES IN LACS i.e. DIVIDE BY 100000
/*
If @Consol = 'MarketHead' OR @Consol = 'RegionExecutive' OR @Consol = 'FieldExecutive'
	Begin
		Set @@Temp = 'SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/100000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS
 '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/100000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100
 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/100000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERA
GE + ' ) * 100 ) AS '' % Brokerage '' '
	End
*/

If @Consol = 'MarketHead' OR @Consol = 'RegionExecutive' OR @Consol = 'FieldExecutive'
	Begin
		Set @@Temp = ' SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/100000 AS Volume, ' 
		Set @@Temp = @@Temp + ' ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + ' (Case when TotVolume = 0 or TotVolume = null then 1 else TotVolume end) ' + ' ) * 100 ) AS '' % Volume '' , '
		Set @@Temp = @@Temp + ' SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/100000 AS TurnOver, '
		Set @@Temp = @@Temp + ' ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' +  ' (Case when TotTurnover = 0 or TotTurnover = null then 1 else TotTurnover end) ' + ' ) * 100 ) AS '' % Turn Over '', '
		Set @@Temp = @@Temp + ' SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/100000 AS Brokerage, '
		Set @@Temp = @@Temp + ' ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' +   ' (Case when TotBrokerage = 0 or TotBrokerage = null then 1 else TotBrokerage end) ' + ' ) * 100 ) AS '' % Brokerage '' '
	End




-- START OF SELECT

IF ( @Consol = 'MarketHead' )
	BEGIN
		IF ( @MarketHead = '') 
			BEGIN	
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' /* MarketHeadId = W.MarketHeadId, */ MarketHeadName = isnull(H.MarketHeadName, ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' /* MarketHeadId = W.MarketHeadId, */ MarketHeadName = isnull(H.MarketHeadName, ''--''), ' + @@Temp
					end
			END
		ELSE
			BEGIN
				IF ( @RegionExecutive = '') 
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' /* MarketExecRegionId = W.MarketExecRegionId, */ ExecName = isnull(R.ExecName, ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' /* MarketExecRegionId = W.MarketExecRegionId, */ ExecName = isnull(R.ExecName, ''--''), ' + @@Temp
							end
					END
				ELSE
					IF ( @FieldExecutive = '') 
						BEGIN	
							If ( @flgSegment = 1 )
								begin
									SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
								end
							else
								begin
									SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), ' + @@Temp
								end
						END
					ELSE
						BEGIN
							IF ( @BranchCode = '') 
								BEGIN	
									If ( @flgSegment = 1 )
										begin
											SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
										end
									else
										begin
											SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), ' + @@Temp
										end
								END
							ELSE
								IF ( @SubBroker = '') 
									BEGIN	
									If ( @flgSegment = 1 )
										begin
											SET @@SELECT = ' Subbroker = SubbrokerOrRemisierCode, /* B.Name, */ Name = (Select isnull(name, ''--'') from Anand.Bsedb_ab.dbo.subbrokers where sub_broker = SubbrokerOrRemisierCode), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
										end
									else
										begin
											SET @@SELECT = ' Subbroker = SubbrokerOrRemisierCode, /* B.Name, */ Name = (Select isnull(name, ''--'') from Anand.Bsedb_ab.dbo.subbrokers where sub_broker = SubbrokerOrRemisierCode), ' + @@Temp
										end
								END
							ELSE
								BEGIN
									If ( @flgSegment = 1 )
										begin
											SET @@SELECT = ' Party_Code, Party_Name = max(Party_name), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
										end
									else
										begin
											SET @@SELECT = ' Party_Code, Party_Name = max(Party_name), ' + @@Temp
										end
								END
						END
			
			END

	END

IF ( @Consol = 'RegionExecutive' )
	BEGIN
		IF ( @RegionExecutive = '') 
			BEGIN	
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' /* MarketExecRegionId = W.MarketExecRegionId, */ ExecName = isnull(R.ExecName, ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' /* MarketExecRegionId = W.MarketExecRegionId, */ ExecName = isnull(R.ExecName, ''--''), ' + @@Temp
					end
			END
		ELSE
			BEGIN
				IF ( @FieldExecutive = '') 
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), ' + @@Temp
							end
					END
				ELSE
					BEGIN
						IF ( @BranchCode = '') 
							BEGIN	
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), ' + @@Temp
									end
							END
						ELSE
							IF ( @SubBroker = '') 
								BEGIN	
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' Subbroker = SubbrokerOrRemisierCode, /* B.Name, */ Name = (Select isnull(name, ''--'') from Anand.Bsedb_ab.dbo.subbrokers where sub_broker = SubbrokerOrRemisierCode), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' Subbroker = SubbrokerOrRemisierCode, /* B.Name, */ Name = (Select isnull(name, ''--'') from Anand.Bsedb_ab.dbo.subbrokers where sub_broker = SubbrokerOrRemisierCode), ' + @@Temp
									end
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' Party_Code, Party_Name = max(Party_name), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' Party_Code, Party_Name = max(Party_name), ' + @@Temp
									end
							END
					END
			END
	END


IF ( @Consol = 'FieldExecutive' )
	BEGIN
		IF ( @FieldExecutive = '') 
			BEGIN	
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), ' + @@Temp
					end
			END
		ELSE
			BEGIN
				IF ( @BranchCode = '') 
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), ' + @@Temp
							end
					END
				ELSE
					IF ( @SubBroker = '') 
						BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' Subbroker = SubbrokerOrRemisierCode, /* B.Name, */ Name = (Select isnull(name, ''--'') from Anand.Bsedb_ab.dbo.subbrokers where sub_broker = SubbrokerOrRemisierCode), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' Subbroker = SubbrokerOrRemisierCode, /* B.Name, */ Name = (Select isnull(name, ''--'') from Anand.Bsedb_ab.dbo.subbrokers where sub_broker = SubbrokerOrRemisierCode), ' + @@Temp
							end
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' Party_Code, Party_Name = max(Party_name), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' Party_Code, Party_Name = max(Party_name), ' + @@Temp
							end
					END
			END
	END

--END OF SELECT
-----------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------

--START OF @@SELECT_FINAL
---print 'ccc'
IF ( @SelectTop = 0 )
begin
--	print 'ddd'
	SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
--	print @@SELECT_FINAL
---print 'eee'
end
ELSE
	SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL
-----------------------------------------------------------------------------------------------------
-- Specifying Query for sum as a table in main query

--@@SELECT_FINAL + @@FROM + ', ' + ' ( ' + @SumQuery  + ') Tot ' + @@WHERE + @@GROUPBY + @@ORDERBY

-----------------------------------------------------------------------------------------------------

--If ( @@SELECT <> '' )
--	Begin
--	
	/* Original Logic */
	--Print (@@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY)
	--EXEC ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )
	
	/* NEWLY IMPLEMENTED LOGIC GIVEN BY GHANEKAR SIR. */
	/* IN NEW LOGIC, QUERY OF TOTALS SUM IS TAKEN AS TABLE NAMED AS Tot IN FROM CLAUSE.  */
	Print (@@SELECT_FINAL + @@FROM + ', ' + ' ( ' + @SumQuery  + ') Tot ' + @@WHERE + @@GROUPBY + ', TotVolume, TotTurnover, TotBrokerage ' + @@ORDERBY)
	Exec (@@SELECT_FINAL + @@FROM + ', ' + ' ( ' + @SumQuery  + ') Tot ' + @@WHERE + @@GROUPBY + ', TotVolume, TotTurnover, TotBrokerage ' + @@ORDERBY)
--	End
--PRINT ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcDrill_LevelMIS
-- --------------------------------------------------

CREATE PROCEDURE prcDrill_LevelMIS

/* CREATE DATE : Dec 15 2005 */

/*
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','HO','','','','','0',' ',0
	prcDrill 'AllTotals', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'clientwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0

	EXEC prcDrill 'Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'statusid','statusname','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Broker','','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Branch','ACM','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Subbroker','ACM','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Client','A1024','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0

	EXEC prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','XS','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Broker','','BranchSubBroker', '1 May 2001', '1 May 2005 ','','','XS','','','','','0',' ',0

	EXEC prcDrill_LevelMIS 'BROKER', '', 'Alltotals', '', '1 May 2001', '1 May 2005','','','XPU','XPU','','','','', '', '', '','0',' ',0
	EXEC prcDrill_LevelMIS 'BRANCH', 'HO', 'Alltotals', '', '1 May 2001', '1 May 2005','','','XPU','XPU','','','','', '', '', '','0',' ',0
	EXEC prcDrill_LevelMIS 'BRANCH', 'HO', 'Alltotals', '', '1 May 2001', '1 May 2005','','','XPU','XPU','','','','', '', '', '','0',' ',0
	EXEC prcDrill_LevelMIS '', '', 'Alltotals', '', '1 May 2001', '1 May 2005','','','XPU','XPU','','','','', '', '', '','0',' ',0
		
	EXEC prcDrill_LevelMIS 'BROKER', '', 'Branchwise', '', '1 May 2001', '31 Dec 2005', '','','','','','','','','', '', '', '', 0, '' 
	EXEC prcDrill_LevelMIS 'BRANCH', 'XPU', 'Branchwise', '', '1 May 2001', '31 Dec 2005', '','','','','','','','','', '', '', '', 0, ''
	EXEC prcDrill_LevelMIS 'BROKER', '', 'Branchwise', 'SEGMENTGROUP', '1 May 2001', '31 Dec 2005 ', '', '', 'XPU', 'XPU', '', '', '', '', '', '', '', '', 0, '', 0
	EXEC prcDrill_LevelMIS 'BRANCH', 'XPU', 'Branchwise', 'SEGMENTGROUP', '1 May 2001', '31 Dec 2005 ', '', '', '', '', '', '', '', '', '', '', '', '', 0, ' Volume ', 0
	Exec prcDrillWithStatusID 'statusid', 'statusname', 'Branchwise', '1 May 2001', '31 Dec 2005 ','','','','','','','','0',' Volume ',0
	prcDrillWithStatusID 'statusid', 'statusname', 'Branchwise', '1 May 2001', '31 Dec 2005 ','','','','','','','','0',' Volume ',0 

	EXEC prcDrill_LevelMIS_Try 'BROKER', '', 'AllTotals', 'SEGMENTGROUP', '1 May 2001', '31 Dec 2005', '', '', '', '', '', '', '', '', '', '', '', '', 0, '', 0 
	EXEC prcDrill_LevelMIS_Try 'BRANCH', 'XPU', 'AllTotals', 'SEGMENTGROUP', '1 May 2001', '31 Dec 2005', '', '', '', '', '', '', '', '', '', '', '', '', 0, '', 0 
	EXEC prcDrill_LevelMIS_Try 'BROKER', '', 'Branchwise', '', '1 May 2001', '31 Dec 2005', '','','','','','','','','', '', '', '', 0, '' 
	EXEC prcDrill_LevelMIS_Try 'BRANCH', 'XPU', 'Branchwise', '', '1 May 2001', '31 Dec 2005', '','','','','','','','','', '', '', '', 0, ''

	EXEC prcDrill_LevelMIS_Try 'BROKER', '', 'BranchSubBroker', 'SEGMENTGROUP', '1 May 2001', '31 Dec 2005', '', '', 'XPU', 'XPU', '', '', '', '', '', '', '', '', 0, '', 0

*/

(
	@StatusId VARCHAR(10),
	@StatusName VARCHAR(15),
	@Consol VARCHAR(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker */
	@SegmentGroup varchar(50) = '',	--NEW	/* Cash - BSE, NSE, FO and Commodity - MCX, NCX */ 
	@DateFrom VARCHAR(50) = '',
	@DateTo VARCHAR(50) = '',
	@Year VARCHAR(4) = '',
	@Month VARCHAR(15) = '',
	@FromBranch varchar(10) = '',
	@ToBranch varchar(10) = '',
	@FromSubBroker varchar(10) = '',
	@ToSubBroker varchar(10) = '',
	@FromTrader varchar(10) = '',
	@ToTrader varchar(10) = '',
	@FromParty VARCHAR(10) = '',
	@ToParty VARCHAR(10) = '',
	@Exchange VARCHAR(10) = '',
	@Family VARCHAR(10) = '',
	@SelectTop INT = 0,
	@SelectOrderBy VARCHAR(200) = '',
	@flgSegment INT = 0,
	@Rounding INT = 10000000
)

AS

	DECLARE	
		@@SELECT AS VARCHAR(6000),
		@@FROM AS VARCHAR(4000),
		@@WHERE AS VARCHAR(6000),
		@@GROUPBY AS VARCHAR(2000),
		@@ORDERBY AS VARCHAR(2000),
		@@SELECT_FINAL AS VARCHAR(6000),

		@@InnerTableQuery AS VARCHAR(6000),
	
		@@TOTVOLUME AS MONEY,
		@@TOTTURNOVER AS MONEY,
		@@TOTBROKERAGE AS MONEY,
		@@TOTSELECT AS VARCHAR(6000),
		@@TOTWHERE AS VARCHAR(6000),
		@@ErrId INT

	Declare	
		@Branch VARCHAR(10),
		@SubBroker VARCHAR(10),
		@Trader VARCHAR(10),
		@Party VARCHAR(10)


	DECLARE @WhereClauseExt VARCHAR(500) 

	SET @StatusId = upper(ltrim(rtrim(@StatusId)))
	SET @StatusName = upper(ltrim(rtrim(@StatusName)))
	SET @SegmentGroup = upper(ltrim(rtrim(@SegmentGroup)))


	IF @SegmentGroup = 'CASH'
		SET @SegmentGroup = '''BSECM'', ''NSECM'', ''NSEFO'''
	ELSE 
	BEGIN
		IF @SegmentGroup = 'COMMODITY'
			SET @SegmentGroup = '''MCX'', ''NCX'''
		ELSE
			SET @SegmentGroup = '''BSECM'', ''NSECM'', ''NSEFO'', ''MCX'', ''NCX'''
	END

	/* For Setting BranchCode, Subbroker And Party For Conditions. */
	IF @FromBranch = '' AND @ToBranch = ''
	Begin			
		SET @Branch = ''
	End
	ELSE
	Begin
		SET @Branch = @FromBranch
	End

       	IF @FromSubBroker = '' AND @ToSubBroker = ''  
	Begin
		SET @SubBroker = ''
	End
	ELSE
	Begin
		SET @SubBroker = @FromSubBroker
	End

       	IF @FromTrader = '' AND @ToTrader = '' 
	Begin
		SET @Trader = ''
	End
	ELSE
	Begin
		SET @Trader = @FromTrader
	End


       	IF @FromParty = '' AND @ToParty = '' 
	Begin
		SET @Party = ''
	End
	ELSE
	Begin
		SET @Party = @FromParty
	End

	/* FINDING STATUS */
	IF @StatusId = 'BROKER'
	BEGIN
		IF @FromBranch = '' AND @ToBranch = ''
		BEGIN			
			SET @FromBranch = 'A'
			SET @ToBranch = 'ZZZZZZ'
		END

        	IF @FromSubBroker = '' AND @ToSubBroker = ''  
		BEGIN
			SET @FromSubbroker = 'A'
	        	SET @ToSubbroker = 'ZZZZZZ'
		END

        	IF @FromTrader = '' AND @ToTrader = '' 
		BEGIN
			SET @FromTrader = 'A'
			SET @ToTrader = 'ZZZZZZZ'
		END

        	IF @FromParty = '' AND @ToParty = '' 
		BEGIN
			SET @FromParty = 'A'
	        	SET @ToParty = 'ZZZZZZ'
		END
	END

	IF @StatusId = 'BRANCH'
	BEGIN

		SET @FromBranch = @StatusName
     		SET @ToBranch = @StatusName

		/*
		IF @FromSubBroker = '' AND @ToSubBroker <> ''  
		BEGIN
			SET @FromSubbroker = 'A'
	        	SET @ToSubbroker = 'ZZZZZZ'
		END

        	IF @FromTrader = '' AND @ToTrader <> '' 
		BEGIN
			SET @FromTrader = 'A'
			SET @ToTrader = 'ZZZZZZZ'
		END

        	IF @FromParty = '' AND @ToParty <> '' 
		BEGIN
			SET @FromClient = 'A'
	        	SET @ToClient = 'ZZZZZZ'
		END
		*/
	END

	IF @StatusId = 'SUBBROKER'
	BEGIN
     		SET @FromSubbroker = @StatusName
		SET @ToSubbroker = @StatusName

		/*
        	IF @FromTrader = '' AND @ToTrader <> '' SET @FromTrader = 'A'
         	IF @ToTrader = '' AND @FromTrader <> '' SET @ToTrader = 'ZZZZZZ'

        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
		*/
	END

	IF @StatusId = 'TRADER'
	BEGIN
     		SET @FromTrader = @StatusName
         	SET @ToTrader = @StatusName

		/*
        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
		*/
	END
	
	IF @StatusId = 'CLIENT'
	BEGIN
     		SET @FromParty = @StatusName
	        SET @ToParty = @StatusName
	END

----------------------------------------------------------------------------------------------------

	DECLARE
		@VolumeSelect1 VARCHAR(1000),
		@TurnOverSelect1 VARCHAR(1000),
		@BrokerageSelect1 VARCHAR(1000),
		@PercentVolumeSelect1 VARCHAR(1000),
		@PercentTurnOverSelect1 VARCHAR(1000),
		@PercentBrokerageSelect1 VARCHAR(1000),

		@VolumeSelect2 VARCHAR(1000),
		@TurnOverSelect2 VARCHAR(1000),
		@BrokerageSelect2 VARCHAR(1000),
		@PercentVolumeSelect2 VARCHAR(1000),
		@PercentTurnOverSelect2 VARCHAR(1000),
		@PercentBrokerageSelect2 VARCHAR(1000)


		SET @VolumeSelect1 = 'SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty))'
		SET @TurnOverSelect1 = 'SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt)'
		SET @BrokerageSelect1 = 'SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)'

		SET @PercentVolumeSelect1 =  'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty)))/TotalVolume*100'
		SET @PercentTurnOverSelect1 = 'CONVERT(DECIMAL(30,10),SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt))/TotalTurnOver*100'
		SET @PercentBrokerageSelect1 = 'CONVERT(DECIMAL(30,10),SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok))/TotalBrokerage*100'


		SET @VolumeSelect2 = 'SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS))'
		SET @TurnOverSelect2 = 'SUM(TPA + TSA + DPA + DSA)'
		SET @BrokerageSelect2 = 'SUM(TPB + TSB + DPB + DSB)'

		SET @PercentVolumeSelect2 = 'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS)))/TotalVolume*100'
		SET @PercentTurnOverSelect2 = 'CONVERT(DECIMAL(30,10),SUM(TPA + TSA + DPA + DSA))/TotalTurnOver*100'
		SET @PercentBrokerageSelect2 = 'CONVERT(DECIMAL(30,10),SUM(TPB + TSB + DPB + DSB))/TotalBrokerage*100'

-----------------------------------------------------------------------------------------------------

--Initialization of variables
	SET @@SELECT  = '' 
	SET @@FROM  = '' 
	SET @@WHERE  = '' 
	SET @@GROUPBY  = '' 
	SET @@ORDERBY  = '' 
	SET @@SELECT_FINAL  = '' 
-----------------------------------------------------------------------------------------------------

-- START OF FROM

	DECLARE @@IsLevel1 VARCHAR(1), @@IsBrokName VARCHAR(1)
	SET @@IsBrokName = 'N'
	SET @@IsLevel1 = 'N'

	IF (@Month = '' Or @Consol = 'BranchSubbroker')
	BEGIN
		IF @Branch = '' And @SubBroker = '' And @Family = '' And @Party = '' And @Exchange = ''
		BEGIN
			IF @Consol = 'BranchSubbroker' Or @Consol = 'Branchwise'
			BEGIN
				SET @@FROM  = ' FROM Level4Mis A ' 
				SET @@IsBrokName = 'Y'
			END
			/* THIS LINE IS COMMENTED AND ADDED NEXT LINE 
			SINCE FOR BRANCH LOGIN, WE CANT CHECK FOR Branch_cd in Level6Mis */ 
			/* ELSE	SET @@FROM  = ' FROM Level6Mis A ' */
			IF @StatusId = 'BRANCH' OR @Consol = 'Branchwise' 
				SET @@FROM  = ' FROM Level5Mis A '
			ELSE IF @StatusId = 'SUBBROKER' OR @Consol = 'BranchSubbroker'
				SET @@FROM  = ' FROM Level4Mis A '
			ELSE IF @StatusId = 'TRADER' OR @Consol = 'Traderwise'
				SET @@FROM  = ' FROM Level3Mis A '
			ELSE IF @StatusId = 'CLIENT' OR @Consol = 'Clientwise'
				SET @@FROM  = ' FROM Level2Mis A '
			ELSE 
				SET @@FROM  = ' FROM Level6Mis A /* Coming... */'
			
		END
		ELSE
		BEGIN
			IF @Party = '' And @Family = '' And @SubBroker =''
		 	BEGIN
				SET @@FROM = ' FROM Level4Mis A ' 
				SET @@IsBrokName = 'Y'
			END
			ELSE 
				IF @Family = '' And @Party = ''
					SET @@FROM = ' FROM Level3Mis A '
				ELSE
					SET @@FROM = ' FROM Level2Mis A '
		END

		IF ( @Consol = 'Clientwise' )
		BEGIN
			SET @@FROM = ' FROM Level2Mis A '
			SET @@IsBrokName = 'N'
		END
	END
	ELSE
	BEGIN
		SET @@FROM  = ' FROM Level1Mis A '
		SET @@IsLevel1 = 'Y'
	END

--END OF FROM
-----------------------------------------------------------------------------------------------------

	IF @Month = ''	Or @Consol = 'BranchSubbroker'
		SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
	ELSE
		SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month

	IF @Branch <> ''
	BEGIN
		SET @@WHERE = @@WHERE + ' and Branch_cd >= ''' + @FromBranch + ''' ' + ' and Branch_cd <= ''' + @ToBranch + ''''
		--SET @@WHERE  = @@WHERE + 'and Branch_cd like case when ' + @StatusId + ' = ''BRANCH'' then ' + @StatusName + ' else ''%'' end '
	END
	IF @SubBroker <> ''
	BEGIN
		SET @@WHERE = @@WHERE + ' and A.Sub_Broker >= ''' + @FromSubBroker + ''' ' + ' and A.Sub_Broker <= ''' + @ToSubBroker + ''''
		--SET @@WHERE  = @@WHERE + 'and A.Sub_Broker like case when ' + @StatusId + ' = ''SUBBROKER'' then ' + @StatusName + ' else ''%'' end '
	END
	IF @Party <> ''
	BEGIN
		SET @@WHERE = @@WHERE + ' and Party_Code >= ''' + @FromParty + ''' ' + ' and Party_Code <= ''' + @ToParty + ''''

	END

	IF @Family <> ''
		SET @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
	
	IF @Exchange <> ''
		SET @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
	ELSE
		SET @@WHERE = @@WHERE + ' and ExchangeSegment IN (' + @SegmentGroup + ') '
	
	IF @Year <> ''
	BEGIN
		IF @@IsLevel1 = 'N'
			SET @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		ELSE
			SET @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	END

	/* REMOVED SINCE SUBBROKER NAME IS TAKEN DIRECTLY IN SELECT QUERY. */
	/*
	IF @@IsBrokName = 'Y'
		SET @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '
	*/

	IF @StatusId = 'BRANCH'
		SET @@WHERE  = @@WHERE + 'and Branch_cd like case when ''' + @StatusId + ''' = ''BRANCH'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'SUBBROKER'
		SET @@WHERE  = @@WHERE + 'and A.Sub_Broker like case when ''' + @StatusId + ''' = ''SUBBROKER'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'TRADER'
		SET @@WHERE  = @@WHERE + 'and Trader like case when ''' + @StatusId + ''' = ''TRADER'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'FAMILY'
		SET @@WHERE  = @@WHERE + 'and Family like case when ''' + @StatusId + ''' = ''FAMILY'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'CLIENT'
		SET @@WHERE  = @@WHERE + 'and Party_Code like case when ''' + @StatusId + ''' = ''CLIENT'' then ''' + @StatusName + ''' else ''%'' end '

--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
	IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @Branch = '')
		BEGIN
			IF ( @flgSegment = 1 )
				SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
			ELSE
				SET @@GROUPBY  = ' GROUP BY Branch_cd '				
		END
		ELSE
		BEGIN
			IF ( @Year = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
				END
				ELSE
				BEGIN
					SET @@GROUPBY  = ' GROUP BY [Year] '		
				END		
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
					END
					ELSE
					BEGIN
						SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
					END		
				END
				ELSE
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
					END
					ELSE
					BEGIN
						SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
					END		
				END
			END
		END
	END

	IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
		BEGIN
			SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
		END
		ELSE
		BEGIN
			IF ( @year = '' )
			BEGIN	
				SET @@GROUPBY =  ' GROUP BY [Year] '
			END	
			ELSE
			BEGIN
				IF (@Month = '' )
				BEGIN
					SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
				END
				ELSE
				BEGIN
					SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
				END
			END
		END
	END

	IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@GROUPBY = ' GROUP BY [Year], Exchangesegment '								
			END
			ELSE
			BEGIN
				SET @@GROUPBY = ' GROUP BY [Year] '		
			END		
		END
		ELSE
		BEGIN	
			IF ( @Month = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
				END
				ELSE
				BEGIN
					SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
				END		
			END
			ELSE
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
				END
				ELSE
				BEGIN
					SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
				END		
			END
		END
	END


	IF (@Consol = 'Clientwise' )
		SET @@GROUPBY = ' GROUP BY Party_Code '
	IF ( @flgSegment = 1 )
		SET @@GROUPBY = @@GROUPBY + ' ,ExchangeSegment '


	IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @Branch = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
			END
			ELSE
			BEGIN
				SET @@GROUPBY = ' GROUP BY Branch_cd '									
			END		
		END
		ELSE
		BEGIN
			IF ( @SubBroker = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY A.Sub_Broker, /* B.Name, */ ExchangeSegment ' 
				END
				ELSE
				BEGIN
					SET @@GROUPBY = ' GROUP BY A.Sub_Broker /*, B.Name */ ' 
				END		
			END
			ELSE
			BEGIN
				IF ( @Family = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '								
					END
					ELSE
					BEGIN
						SET @@GROUPBY = ' GROUP BY Family '				
					END		
				END
				ELSE
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
					END
					ELSE
					BEGIN
						SET @@GROUPBY = ' GROUP BY Party_code '		
					END		
				END
			END
		END
	END

--END OF GROUP BY
-----------------------------------------------------------------------------------------------------
-- START OF ORDER BY
	IF ( @SelectOrderBy = '' )
	BEGIN
		IF ( @Consol = 'BranchWise' )
		BEGIN
			IF ( @Branch = '' )
			BEGIN
				SET @@ORDERBY  = ' ORDER BY Branch_cd'
			END
			ELSE
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY [YEAR]'
				END
				ELSE
				BEGIN
					IF ( @Month = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY [Year], [Month] '
					END
					ELSE
					BEGIN
						SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
					END
				END
			END
		END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
			BEGIN
				SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
			END
			ELSE
			BEGIN	
				IF ( @Year = '' ) 
				BEGIN
					SET @@ORDERBY  = ' ORDER BY [YEAR] '  
				END
				ELSE
				BEGIN
					IF ( @Month = '' ) 
					BEGIN
						SET @@ORDERBY  = ' ORDER BY [Month] '
					END
					ELSE
					BEGIN
						SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
					END
				END
			END
		END

		IF (@Consol = 'AllTotals' )
		BEGIN
			IF ( @Year = '' )
			BEGIN
				SET @@ORDERBY = ' ORDER BY [Year] '
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Month] '		
				END
				ELSE
				BEGIN
					SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
				END
			END
		END

		IF (@Consol = 'Clientwise' ) 
			SET @@ORDERBY = ' ORDER BY Party_Code '
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
			IF ( @Branch = '' )
			BEGIN
				SET @@ORDERBY = ' ORDER BY Branch_cd '	
			END
			ELSE
			BEGIN
				IF ( @SubBroker = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY A.Sub_Broker '
				END
				ELSE
				BEGIN
					IF ( @Family = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Family '
					END
					ELSE
					BEGIN
						SET @@ORDERBY = ' ORDER BY Party_code'
					END
				END				
			END
		END
	END
	ELSE
	BEGIN
		SET @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	END
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

	DECLARE @@Temp VARCHAR(4000)

	IF @Month = '' Or @Consol = 'BranchSubbroker'
		SET @@TotSelect = @VolumeSelect1 + ' AS TotalVolume,' + @TurnOverSelect1 + ' AS TotalTurnOver,' + @BrokerageSelect1 + ' AS TotalBrokerage '
	ELSE
		SET @@TotSelect = @VolumeSelect2 + ' AS TotalVolume,' + @TurnOverSelect2 + ' AS TotalTurnOver,' + @BrokerageSelect2 + ' AS TotalBrokerage '

	SET @VolumeSelect1 = 'CONVERT(DECIMAL(30,10),' + @VolumeSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @TurnOverSelect1 = 'CONVERT(DECIMAL(30,10),' + @TurnOverSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @BrokerageSelect1 = 'CONVERT(DECIMAL(30,10),' + @BrokerageSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)

	SET @VolumeSelect2 = 'CONVERT(DECIMAL(30,10),' + @VolumeSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @TurnOverSelect2 = 'CONVERT(DECIMAL(30,10),' + @TurnOverSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @BrokerageSelect2 = 'CONVERT(DECIMAL(30,10),' + @BrokerageSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)

	IF @Month = '' Or @Consol = 'BranchSubbroker'
	BEGIN
		SET @@Temp =  @VolumeSelect1 + ' AS Volume,' + @PercentVolumeSelect1 + ' AS ''% Volume'', '
		SET @@Temp = @@Temp + @TurnOverSelect1 + ' AS TurnOver,' + @PercentTurnOverSelect1 + ' AS ''% TurnOver'', '
		SET @@Temp = @@Temp + @BrokerageSelect1 + ' AS Brokerage,' + @PercentBrokerageSelect1 + ' AS ''% Brokerage'' '
	END
	ELSE
	BEGIN
		SET @@Temp =  @VolumeSelect2 + ' AS Volume,' + @PercentVolumeSelect2 + ' AS ''% Volume'', ' 
		SET @@Temp = @@Temp + @TurnOverSelect2 + ' AS TurnOver,' + @PercentTurnOverSelect2 + ' AS ''% TurnOver'', ' 
		SET @@Temp = @@Temp + @BrokerageSelect2 + ' AS Brokerage,' + @PercentBrokerageSelect2 + ' AS ''% Brokerage'' '
	END


-- START OF SELECT
	IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @Branch = '') 
		BEGIN	
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = ' Branch_cd, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
			ELSE
			BEGIN
				SET @@SELECT = ' Branch_cd, Branch = IsNull(Rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ' + @@Temp
			END
		END
		ELSE
		BEGIN
			IF ( @Year = '')
			BEGIN
				IF (@@IsLevel1 = 'Y')
					SET @@SELECT =  ' [Year]= Datepart(Year,Sauda_Date) '
				ELSE
					SET @@SELECT =  ' [Year] '

				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = @@Select + ' , ExchangeSegment as ''Exchange Segment'', ' + @@Temp
				END
				ELSE
				BEGIN
					SET @@SELECT = @@Select + ' , ' + @@Temp
				END		
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) as ''Month Name'', ExchangeSegment as [Exchange Segment], ' + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) as ''Month Name'', ' + @@Temp
					END		
				END
				ELSE
				BEGIN 
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment  as ''Exchange Segment'', ' + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
					END		
				END
			END
		END
	END

	IF (@Consol = 'Clientwise' )
	BEGIN
		SET @@SELECT = ' Party_Code, ' + @@Temp
		IF ( @flgSegment = 1 )
			SET @@SELECT = ' Party_Code,[Exchange Segment] = ExchangeSegment,  ' + @@Temp
	END



	IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
		BEGIN
			SET @@SELECT = ' ExchangeSegment as ''Exchange Segment'', ' + @@Temp
		END
		ELSE
		BEGIN
			IF ( @Year = '' )
			BEGIN
				SET @@SELECT = ' [Year], ' + @@Temp
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'', ' + @@Temp
				END
				ELSE
				BEGIN	
					SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
				END
			END
		END
	END 

	IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = '  [Year], ExchangeSegment as ''Exchange Segment'',' + @@Temp 															
			END
			ELSE
			BEGIN
				SET @@SELECT = '  [Year],' + @@Temp														
			END		
		END
		ELSE
		BEGIN
			IF ( @Month = '' )
			BEGIN	
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'', ExchangeSegment as ''Exchange Segment'',' + @@Temp
				END
				ELSE
				BEGIN
					SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'',' + @@Temp																	
				END		
			END
			ELSE
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = ' DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment as ''Exchange Segment'',' + @@Temp 
				END
				ELSE
				BEGIN
					SET @@SELECT = ' DATEPART (DD, Sauda_Date) AS Day,' + @@Temp
				END		
						
			END
		END
	END
	
	IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @Branch = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = '  Branch_cd, Branch = IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
			ELSE
			BEGIN				SET @@SELECT = '  Branch_cd, Branch = IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), '  + @@Temp
			END		
		END
		ELSE	
		BEGIN	
			IF ( @SubBroker = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = '  A.Sub_Broker, Name = IsNull((Select Name from Anand.Bsedb_ab.dbo.subbrokers where Sub_Broker = A.Sub_Broker),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp 
				END
				ELSE
				BEGIN
					SET @@SELECT = '  A.Sub_Broker, Name = IsNull((Select Name from Anand.Bsedb_ab.dbo.subbrokers where Sub_Broker = A.Sub_Broker),''--''),  '  + @@Temp 
				END		
			END
			ELSE
			BEGIN
				IF ( @Family = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = '  Family, ExchangeSegment as ''Exchange Segment'', '  + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = '  Family, '  + @@Temp
					END		
				END
				ELSE	
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = '  Party_code, ExchangeSegment as ''Exchange Segment'' , '  + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = '  Party_code, '  + @@Temp
					END		
				END
			END
		END
	END

--END OF SELECT
-----------------------------------------------------------------------------------------------------

--START OF @@SELECT_FINAL
	IF ( @SelectTop = 0 )
	BEGIN
		SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
	END
	ELSE
		SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL


	SET @@InnerTableQuery = ',( SELECT ' + @@TotSelect + @@FROM + @@WHERE + ') Totals '

	IF @@GROUPBY <> ''
		SET @@GROUPBY = @@GROUPBY + ',TotalVolume,TotalTurnOver,TotalBrokerage '
	ELSE
		SET @@GROUPBY = 'GROUP BY TotalVolume,TotalTurnOver,TotalBrokerage '


	PRINT (@@SELECT_FINAL + @@FROM + @@InnerTableQuery + @@WHERE + @@GROUPBY + @@ORDERBY)
	EXEC ( @@SELECT_FINAL + @@FROM + @@InnerTableQuery + @@WHERE + @@GROUPBY + @@ORDERBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcDrill_LevelMIS_Segments
-- --------------------------------------------------
CREATE   PROCEDURE prcDrill_LevelMIS_Segments

/* WRITTEN BY SANTOSH FOR SEGMENTS */
/*
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','HO','','','','','0',' ',0
	prcDrill 'AllTotals', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'clientwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0

	EXEC prcDrill 'Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'statusid','statusname','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Broker','','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Branch','ACM','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Subbroker','ACM','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Client','A1024','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0


	EXEC prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','XS','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Broker','','BranchSubBroker', '1 May 2001', '1 May 2005 ','','','XS','','','','','0',' ',0

	EXEC prcDrill_LevelMIS 'BROKER', '', 'Alltotals', '', '1 May 2001', '1 May 2005','','','XPU','XPU','','','','', '', '', '','0',' ',0
	EXEC prcDrill_LevelMIS 'BRANCH', 'HO', 'Alltotals', '', '1 May 2001', '1 May 2005','','','XPU','XPU','','','','', '', '', '','0',' ',0
	EXEC prcDrill_LevelMIS 'BRANCH', 'HO', 'Alltotals', '', '1 May 2001', '1 May 2005','','','XPU','XPU','','','','', '', '', '','0',' ',0

	EXEC prcDrill_LevelMIS_Segments 'Broker', '', 'AllTotals', 'SEGMENTGROUP', '1 May 2001', '1 Dec 2005', '', '', '', '', '', '', '', '', '', '', '', '', 0, '', 1
	EXEC prcDrill_LevelMIS_Segments 'Client', 'BH14', 'AllTotals', 'SEGMENTGROUP', '1 May 2001', '1 Dec 2005', '', '', '', '', '', '', '', '', '', '', '', '', 0, '', 1
*/

(
	@StatusId VARCHAR(10),
	@StatusName VARCHAR(15),
	@Consol VARCHAR(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker */
	@SegmentGroup varchar(50) = '',	--NEW	/* Cash - BSE, NSE, FO and Commodity - MCX, NCX */ 
	@DateFrom VARCHAR(50) = '',
	@DateTo VARCHAR(50) = '',
	@Year VARCHAR(4) = '',
	@Month VARCHAR(15) = '',
	@FromBranch varchar(10) = '',	--NEW
	@ToBranch varchar(10) = '',	--NEW
	@FromSubBroker varchar(10) = '',--NEW
	@ToSubBroker varchar(10) = '',	--NEW
	@FromTrader varchar(10) = '',	--NEW
	@ToTrader varchar(10) = '',	--NEW
	@FromParty VARCHAR(10) = '',	--NEW 
	@ToParty VARCHAR(10) = '',	--NEW 
	@Exchange VARCHAR(10) = '',
	@Family VARCHAR(10) = '',
	@SelectTop INT = 0,
	@SelectOrderBy VARCHAR(200) = '',
	@flgSegment INT = 0,
	@Rounding INT = 10000000
)

AS

	DECLARE	
		@@SELECT AS VARCHAR(6000),
		@@FROM AS VARCHAR(4000),
		@@WHERE AS VARCHAR(6000),
		@@GROUPBY AS VARCHAR(2000),
		@@ORDERBY AS VARCHAR(2000),
		@@SELECT_FINAL AS VARCHAR(6000),

		@@InnerTableQuery AS VARCHAR(6000),
	
		@@TOTVOLUME AS MONEY,
		@@TOTTURNOVER AS MONEY,
		@@TOTBROKERAGE AS MONEY,
		@@TOTSELECT AS VARCHAR(6000),
		@@TOTWHERE AS VARCHAR(6000),
		@@ErrId INT

	DECLARE @WhereClauseExt VARCHAR(500) 

	SET @StatusId = upper(ltrim(rtrim(@StatusId)))
	SET @StatusName = upper(ltrim(rtrim(@StatusName)))
	SET @SegmentGroup = upper(ltrim(rtrim(@SegmentGroup)))


	IF @SegmentGroup = 'CASH'
		SET @SegmentGroup = '''BSECM'', ''NSECM'', ''NSEFO'''
	ELSE 
	BEGIN
		IF @SegmentGroup = 'COMMODITY'
			SET @SegmentGroup = '''MCX'', ''NCX'''
		ELSE
			SET @SegmentGroup = '''BSECM'', ''NSECM'', ''NSEFO'', ''MCX'', ''NCX'''
	END


	IF @StatusId = 'BROKER'
	BEGIN
		IF @FromBranch = '' AND @ToBranch <> ''
		BEGIN
			SET @FromBranch = 'A'
			SET @ToBranch = 'ZZZZZZ'
		END

        	IF @FromSubBroker = '' AND @ToSubBroker <> ''  
		BEGIN
			SET @FromSubbroker = 'A'
	        	SET @ToSubbroker = 'ZZZZZZ'
		END

        	IF @FromTrader = '' AND @ToTrader <> '' 
		BEGIN
			SET @FromTrader = 'A'
			SET @ToTrader = 'ZZZZZZZ'
		END

        	IF @FromParty = '' AND @ToParty <> '' 
		BEGIN
			SET @FromParty = 'A'
	        	SET @ToParty = 'ZZZZZZ'
		END
	END

	IF @StatusId = 'BRANCH'
	BEGIN

		SET @FromBranch = @StatusName
     		SET @ToBranch = @StatusName

		/*
		IF @FromSubBroker = '' AND @ToSubBroker <> ''  
		BEGIN
			SET @FromSubbroker = 'A'
	        	SET @ToSubbroker = 'ZZZZZZ'
		END

        	IF @FromTrader = '' AND @ToTrader <> '' 
		BEGIN
			SET @FromTrader = 'A'
			SET @ToTrader = 'ZZZZZZZ'
		END

        	IF @FromParty = '' AND @ToParty <> '' 
		BEGIN
			SET @FromClient = 'A'
	        	SET @ToClient = 'ZZZZZZ'
		END
		*/
	END

	IF @StatusId = 'SUBBROKER'
	BEGIN
     		SET @FromSubbroker = @StatusName
		SET @ToSubbroker = @StatusName

		/*
        	IF @FromTrader = '' AND @ToTrader <> '' SET @FromTrader = 'A'
         	IF @ToTrader = '' AND @FromTrader <> '' SET @ToTrader = 'ZZZZZZ'

        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
		*/
	END

	IF @StatusId = 'TRADER'
	BEGIN
     		SET @FromTrader = @StatusName
         	SET @ToTrader = @StatusName

		/*
        	IF @FromClient = '' AND @ToClient <> '' SET @FromClient = 'A'
	        IF @ToClient = '' AND @FromClient <> '' SET @ToClient = 'ZZZZZZ'
		*/
	END
	
	IF @StatusId = 'CLIENT'
	BEGIN
     		SET @FromParty = @StatusName
	        SET @ToParty = @StatusName
	END


	/*
	IF @StatusId = 'Branch'
	BEGIN
     		SET @BranchCode = @StatusName
		SET @WhereClauseExt = 'Branch_Cd = ' + @StatusName

	END

	IF @StatusId = 'Subbroker'
	BEGIN
		SET @SubBroker = @StatusName
		SET @WhereClauseExt = 'Sub_Broker = ' + @StatusName

	END

	IF @StatusId = 'Client'
	BEGIN
		SET @Party = @StatusName
		SET @WhereClauseExt = 'Party_Code = ' + @StatusName
	END
	*/
	

----------------------------------------------------------------------------------------------------
--Block added By Abhijeet On 25th November 2005 For
--	Removing INTermediate Table Insert
--	Rounding All % Values in DECIMAL(30,10) 

	DECLARE
		@VolumeSelect1 VARCHAR(1000),
		@TurnOverSelect1 VARCHAR(1000),
		@BrokerageSelect1 VARCHAR(1000),
		@PercentVolumeSelect1 VARCHAR(1000),
		@PercentTurnOverSelect1 VARCHAR(1000),
		@PercentBrokerageSelect1 VARCHAR(1000),

		@VolumeSelect2 VARCHAR(1000),
		@TurnOverSelect2 VARCHAR(1000),
		@BrokerageSelect2 VARCHAR(1000),
		@PercentVolumeSelect2 VARCHAR(1000),
		@PercentTurnOverSelect2 VARCHAR(1000),
		@PercentBrokerageSelect2 VARCHAR(1000),

		/* TURNOVER */
		@BSECMTOSelect VARCHAR(2000),
		@NSECMTOSelect VARCHAR(2000),
		@NSEFOTOSelect VARCHAR(2000),
		@MCXTOSelect VARCHAR(2000),
		@NCXTOSelect VARCHAR(2000),

		/* BROKERAGE */
		@BSECMBrokSelect VARCHAR(2000),
		@NSECMBrokSelect VARCHAR(2000),
		@NSEFOBrokSelect VARCHAR(2000),
		@MCXBrokSelect VARCHAR(2000),
		@NCXBrokSelect VARCHAR(2000),

		/* TURNOVER PERCENTAGE */
		@BSECMTOPercentSelect VARCHAR(2000),
		@NSECMTOPercentSelect VARCHAR(2000),
		@NSEFOTOPercentSelect VARCHAR(2000),
		@MCXTOPercentSelect VARCHAR(2000),
		@NCXTOPercentSelect VARCHAR(2000),

		/* BROKERAGE PERCENTAGE */
		@BSECMBrokPercentSelect VARCHAR(2000),
		@NSECMBrokPercentSelect VARCHAR(2000),
		@NSEFOBrokPercentSelect VARCHAR(2000),
		@MCXBrokPercentSelect VARCHAR(2000),
		@NCXBrokPercentSelect VARCHAR(2000),

		/* TURNOVER AND BROKERAGE TOTAL */
		@TotalTOSelect VARCHAR(2000),
		@TotalBrokSelect VARCHAR(2000)



		--SET @VolumeSelect1 = 'SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty))'

		/* TURNOVER */

		SET @BSECMTOSelect =	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''BSECM'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' +
					'	)) '

		SET @NSECMTOSelect =	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSECM'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' +
					'	)) '

		SET @NSEFOTOSelect =	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSEFO'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' +
					'	)) '

		SET @MCXTOSelect =	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''MCX'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' +
					'	)) '

		SET @NCXTOSelect =	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NCX'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' +
					'	)) '


		/* BROKERAGE */

		SET @BSECMBrokSelect = 	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''BSECM'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' +
					'	END ' + 
					'		) ' + 
					'	)) '

		SET @NSECMBrokSelect = 	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSECM'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' +
					'	END ' + 
					'		) ' + 
					'	)) '

		SET @NSEFOBrokSelect = 	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSEFO'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' +
					'	END ' + 
					'		) ' + 
					'	)) '

		SET @MCXBrokSelect = 	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''MCX'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' +
					'	END ' + 
					'		) ' + 
					'	)) '

		SET @NCXBrokSelect = 	'	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NCX'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' +
					'	END ' + 
					'		) ' + 
					'	)) '

		/* TURNOVER PERCENTAGE */

		SET @BSECMTOPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''BSECM'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' +
					'		) ' + 
					'	) /  (CASE WHEN TotalBSECMTurnover = 0 THEN 1 ELSE TotalBSECMTurnover END) * 100 ) '

		SET @NSECMTOPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSECM'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' +
					'		) ' + 
					'	) /  (CASE WHEN TotalNSECMTurnover = 0 THEN 1 ELSE TotalNSECMTurnover END) * 100 ) '

		SET @NSEFOTOPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSEFO'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' +
					'		) ' + 
					'	) /  (CASE WHEN TotalNSEFOTurnover = 0 THEN 1 ELSE TotalNSEFOTurnover END) * 100 ) '

		SET @MCXTOPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''MCX'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' +
					'		) ' + 
					'	) /  (CASE WHEN TotalMCXTurnover = 0 THEN 1 ELSE TotalMCXTurnover END) * 100 ) '

		SET @NCXTOPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NCX'' THEN ' + 
					'		TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' +
					'		) ' + 
					'	) /  (CASE WHEN TotalNCXTurnover = 0 THEN 1 ELSE TotalNCXTurnover END) * 100 ) '

		/* BROKERAGE PERCENTAGE */

		SET @BSECMBrokPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''BSECM'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' + 
					'	) / (CASE WHEN TotalBSECMBrok = 0 THEN 1 ELSE TotalBSECMBrok END) * 100 ) '

		SET @NSECMBrokPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSECM'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' + 
					'	) / (CASE WHEN TotalNSECMBrok = 0 THEN 1 ELSE TotalNSECMBrok END) * 100 ) '

		SET @NSEFOBrokPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NSEFO'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' + 
					'	) / (CASE WHEN TotalNSEFOBrok = 0 THEN 1 ELSE TotalNSEFOBrok END) * 100 ) '

		SET @MCXBrokPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''MCX'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' + 
					'	) / (CASE WHEN TotalMCXBrok = 0 THEN 1 ELSE TotalMCXBrok END) * 100 ) '

		SET @NCXBrokPercentSelect = '	( CONVERT(DECIMAL(30,10), SUM(CASE WHEN ExchangeSegment = ''NCX'' THEN ' +
					'		TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok ' + 
					'	ELSE ' + 
					'		0 ' + 
					'	END ' + 
					'		) ' + 
					'	) / (CASE WHEN TotalNCXBrok = 0 THEN 1 ELSE TotalNCXBrok END) * 100 ) '


		/* TURNOVER TOTAL */

		SET @TotalTOSelect = '	( CONVERT(DECIMAL(30,10), ' + 
					' 	SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt) ' + 
					'	))  '

		/* BROKERAGE TOTAL */
		SET @TotalBrokSelect = ' ( CONVERT(DECIMAL(30,10), ' + 
					'	SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) ' + 
					'	))  '



		SET @TurnOverSelect1 = 'SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt)'
		SET @BrokerageSelect1 = 'SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)'

		SET @PercentVolumeSelect1 =  'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty)))/TotalVolume*100'
		SET @PercentTurnOverSelect1 = 'CONVERT(DECIMAL(30,10),SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt))/TotalTurnOver*100'
		SET @PercentBrokerageSelect1 = 'CONVERT(DECIMAL(30,10),SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok))/TotalBrokerage*100'


		SET @VolumeSelect2 = 'SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS))'
		SET @TurnOverSelect2 = 'SUM(TPA + TSA + DPA + DSA)'
		SET @BrokerageSelect2 = 'SUM(TPB + TSB + DPB + DSB)'

		SET @PercentVolumeSelect2 = 'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS)))/TotalVolume*100'
		SET @PercentTurnOverSelect2 = 'CONVERT(DECIMAL(30,10),SUM(TPA + TSA + DPA + DSA))/TotalTurnOver*100'
		SET @PercentBrokerageSelect2 = 'CONVERT(DECIMAL(30,10),SUM(TPB + TSB + DPB + DSB))/TotalBrokerage*100'

-----------------------------------------------------------------------------------------------------

--Initialization of variables
	SET @@SELECT  = '' 
	SET @@FROM  = '' 
	SET @@WHERE  = '' 
	SET @@GROUPBY  = '' 
	SET @@ORDERBY  = '' 
	SET @@SELECT_FINAL  = '' 
-----------------------------------------------------------------------------------------------------

-- START OF FROM

	DECLARE @@IsLevel1 VARCHAR(1), @@IsBrokName VARCHAR(1)
	SET @@IsBrokName = 'N'
	SET @@IsLevel1 = 'N'

	IF (@Month = '' Or @Consol = 'BranchSubbroker')
	BEGIN
		IF @FromBranch = '' And @FromSubBroker = '' And @Family = '' And @FromParty = '' And @Exchange = ''
		BEGIN
			IF @Consol = 'BranchSubbroker' Or @Consol = 'Branchwise'
			BEGIN
				SET @@FROM  = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B '
				SET @@IsBrokName = 'Y'
			END
			ELSE	SET @@FROM  = ' FROM Level6Mis A '
		END
		ELSE
		BEGIN
			IF @FromParty = '' And @Family = '' And @FromSubBroker =''
		 	BEGIN
				SET @@FROM = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B  '
				SET @@IsBrokName = 'Y'
			END
			ELSE 
				IF @Family = '' And @FromParty = ''
					SET @@FROM = ' FROM Level3Mis A '
				ELSE
					SET @@FROM = ' FROM Level2Mis A '
		END

		IF ( @Consol = 'Clientwise' )
		BEGIN
			SET @@FROM = ' FROM Level2Mis A '
			SET @@IsBrokName = 'N'
		END
	END
	ELSE
	BEGIN
		SET @@FROM  = ' FROM Level1Mis A '
		SET @@IsLevel1 = 'Y'
	END

--END OF FROM
-----------------------------------------------------------------------------------------------------

	IF @Month = ''	Or @Consol = 'BranchSubbroker'
		SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
	ELSE
		SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month


	/* OLD
	IF @BranchCode <> ''
		SET @@WHERE = @@WHERE + ' and Branch_cd = ''' + @BranchCode + ''''
	IF @SubBroker <> ''
		SET @@WHERE = @@WHERE + ' and A.Sub_Broker = ''' + @SubBroker + ''''
	IF @Family <> ''
		SET @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
	IF @Party <> ''
		SET @@WHERE = @@WHERE + ' and Party_Code = ''' + @Party + ''''
	IF @Exchange <> ''
		SET @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
	IF @Year <> ''
	BEGIN
		IF @@IsLevel1 = 'N'
			SET @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		ELSE
			SET @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	END

	IF @@IsBrokName = 'Y'
		SET @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '
	*/

	/* NEW */
	IF @FromBranch <> ''
	BEGIN
		SET @@WHERE = @@WHERE + ' and Branch_cd >= ''' + @FromBranch + ''' ' + ' and Branch_cd <= ''' + @ToBranch + ''''
		--SET @@WHERE  = @@WHERE + 'and Branch_cd like case when ' + @StatusId + ' = ''BRANCH'' then ' + @StatusName + ' else ''%'' end '
	END
	IF @FromSubBroker <> ''
	BEGIN
		SET @@WHERE = @@WHERE + ' and A.Sub_Broker >= ''' + @FromSubBroker + ''' ' + ' and A.Sub_Broker <= ''' + @ToSubBroker + ''''
		--SET @@WHERE  = @@WHERE + 'and A.Sub_Broker like case when ' + @StatusId + ' = ''SUBBROKER'' then ' + @StatusName + ' else ''%'' end '
	END
	IF @FromParty <> ''
	BEGIN
		SET @@WHERE = @@WHERE + ' and Party_Code >= ''' + @FromParty + ''' ' + ' and Party_Code <= ''' + @ToParty + ''''

	END
	/*
	BEGIN
		SET @@WHERE = @@WHERE + ' and Branch_cd >= ''' + @FromBranch + ''', ' + ' and Branch_cd <= ''' + @ToBranch + ''''
		SET @@WHERE = @@WHERE + ' and A.Sub_Broker >= ''' + @FromSubBroker + ''', ' + ' and A.Sub_Broker <= ''' + @ToSubBroker + ''''
		SET @@WHERE = @@WHERE + ' and Party_Code >= ''' + @FromParty + ''', ' + ' and Party_Code <= ''' + @ToParty + ''''
	END
	*/

	IF @Family <> ''
		SET @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
	
	IF @Exchange <> ''
		SET @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
	ELSE
		SET @@WHERE = @@WHERE + ' and ExchangeSegment IN (' + @SegmentGroup + ') '
	
	IF @Year <> ''
	BEGIN
		IF @@IsLevel1 = 'N'
			SET @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		ELSE
			SET @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	END

	IF @@IsBrokName = 'Y'
		SET @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '

	IF @StatusId = 'BRANCH'
		SET @@WHERE  = @@WHERE + 'and Branch_cd like case when ''' + @StatusId + ''' = ''BRANCH'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'SUBBROKER'
		SET @@WHERE  = @@WHERE + 'and A.Sub_Broker like case when ''' + @StatusId + ''' = ''SUBBROKER'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'TRADER'
		SET @@WHERE  = @@WHERE + 'and Trader like case when ''' + @StatusId + ''' = ''TRADER'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'FAMILY'
		SET @@WHERE  = @@WHERE + 'and Family like case when ''' + @StatusId + ''' = ''FAMILY'' then ''' + @StatusName + ''' else ''%'' end '
	ELSE IF @StatusId = 'CLIENT'
		SET @@WHERE  = @@WHERE + 'and Party_Code like case when ''' + @StatusId + ''' = ''CLIENT'' then ''' + @StatusName + ''' else ''%'' end '

	/*
	SET @@WHERE  = @@WHERE + 'and Branch_cd like case when ''' + @StatusId + ''' = ''BRANCH'' then ''' + @StatusName + ''' else ''%'' end '
	SET @@WHERE  = @@WHERE + 'and A.Sub_Broker like case when ''' + @StatusId + ''' = ''SUBBROKER'' then ''' + @StatusName + ''' else ''%'' end '
	SET @@WHERE  = @@WHERE + 'and Trader like case when ''' + @StatusId + ''' = ''TRADER'' then ''' + @StatusName + ''' else ''%'' end '
	SET @@WHERE  = @@WHERE + 'and Family like case when ''' + @StatusId + ''' = ''FAMILY'' then ''' + @StatusName + ''' else ''%'' end '
	SET @@WHERE  = @@WHERE + 'and Party_Code like case when ''' + @StatusId + ''' = ''CLIENT'' then ''' + @StatusName + ''' else ''%'' end '
	*/

--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
	IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @FromBranch = '')
		BEGIN
			/*
			IF ( @flgSegment = 1 )
				SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
			ELSE */
				SET @@GROUPBY  = ' GROUP BY Branch_cd '				
		END
		ELSE
		BEGIN
			IF ( @Year = '' )
			BEGIN
				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
				END
				ELSE */
				BEGIN
					SET @@GROUPBY  = ' GROUP BY [Year] '		
				END	
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
					END
					ELSE */
					BEGIN
						SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
					END		
				END
				ELSE
				BEGIN
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
					END
					ELSE */
					BEGIN
						SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
					END		
				END
			END
		END
	END

	IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
		BEGIN
			SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
		END
		ELSE
		BEGIN
			IF ( @year = '' )
			BEGIN	
				SET @@GROUPBY =  ' GROUP BY [Year] '
			END	
			ELSE
			BEGIN
				IF (@Month = '' )
				BEGIN
					SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
				END
				ELSE
				BEGIN
					SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
				END
			END
		END
	END

	IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
		BEGIN
			/* IF ( @flgSegment = 1 )
			BEGIN
				SET @@GROUPBY = ' GROUP BY [Year], ExchangeSegment '								
			END
			ELSE */
			BEGIN
				SET @@GROUPBY = ' GROUP BY [Year] '		
			END		
		END
		ELSE
		BEGIN	
			IF ( @Month = '' )
			BEGIN
				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
				END
				ELSE */
				BEGIN
					SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
				END		
			END
			ELSE
			BEGIN
				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
				END
				ELSE */
				BEGIN
					SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
				END		
			END
		END
	END


	IF (@Consol = 'Clientwise' )
		SET @@GROUPBY = ' GROUP BY Party_Code '
	/* IF ( @flgSegment = 1 )
		SET @@GROUPBY = @@GROUPBY + ' ,ExchangeSegment ' */


	IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @FromBranch = '' )
		BEGIN
			/* IF ( @flgSegment = 1 )
			BEGIN
				SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
			END
			ELSE */
			BEGIN
				SET @@GROUPBY = ' GROUP BY Branch_cd '									
			END		
		END
		ELSE
		BEGIN
			IF ( @FromSubBroker = '' )
			BEGIN
				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name, ExchangeSegment '									
				END
				ELSE */
				BEGIN
					SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name '				
				END		
			END
			ELSE
			BEGIN
				IF ( @Family = '' )
				BEGIN
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '								
					END
					ELSE */
					BEGIN
						SET @@GROUPBY = ' GROUP BY Family '				
					END		
				END
				ELSE
				BEGIN
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
					END
					ELSE */
					BEGIN
						SET @@GROUPBY = ' GROUP BY Party_code '		
					END		
				END
			END
		END
	END

--END OF GROUP BY
-----------------------------------------------------------------------------------------------------
-- START OF ORDER BY
	IF ( @SelectOrderBy = '' )
	BEGIN
		IF ( @Consol = 'BranchWise' )
		BEGIN
			IF ( @FromBranch = '' )
			BEGIN
				SET @@ORDERBY  = ' ORDER BY Branch_cd'
			END
			ELSE
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY [YEAR]'
				END
				ELSE
				BEGIN
					IF ( @Month = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY [Year], [Month] '
					END
					ELSE
					BEGIN
						SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
					END
				END
			END
		END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
			BEGIN
				SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
			END
			ELSE
			BEGIN	
				IF ( @Year = '' ) 
				BEGIN
					SET @@ORDERBY  = ' ORDER BY [YEAR] '  
				END
				ELSE
				BEGIN
					IF ( @Month = '' ) 
					BEGIN
						SET @@ORDERBY  = ' ORDER BY [Month] '
					END
					ELSE
					BEGIN
						SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
					END
				END
			END
		END

		IF (@Consol = 'AllTotals' )
		BEGIN
			IF ( @Year = '' )
			BEGIN
				SET @@ORDERBY = ' ORDER BY [Year] '
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Month] '		
				END
				ELSE
				BEGIN
					SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
				END
			END
		END

		IF (@Consol = 'Clientwise' ) 
			SET @@ORDERBY = ' ORDER BY Party_Code '
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
			IF ( @FromBranch = '' )
			BEGIN
				SET @@ORDERBY = ' ORDER BY Branch_cd '	
			END
			ELSE
			BEGIN
				IF ( @FromSubBroker = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY A.Sub_Broker '
				END
				ELSE
				BEGIN
					IF ( @Family = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Family '
					END
					ELSE
					BEGIN
						SET @@ORDERBY = ' ORDER BY Party_code'
					END
				END				
			END
		END
	END
	ELSE
	BEGIN
		SET @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	END
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

	DECLARE @@Temp VARCHAR(7000)

	/*
	IF @Month = '' Or @Consol = 'BranchSubbroker'
		SET @@TotSelect = @VolumeSelect1 + ' AS TotalVolume,' + @TurnOverSelect1 + ' AS TotalTurnOver,' + @BrokerageSelect1 + ' AS TotalBrokerage '
	ELSE
		SET @@TotSelect = @VolumeSelect2 + ' AS TotalVolume,' + @TurnOverSelect2 + ' AS TotalTurnOver,' + @BrokerageSelect2 + ' AS TotalBrokerage '

	SET @VolumeSelect1 = 'CONVERT(DECIMAL(30,10),' + @VolumeSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @TurnOverSelect1 = 'CONVERT(DECIMAL(30,10),' + @TurnOverSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @BrokerageSelect1 = 'CONVERT(DECIMAL(30,10),' + @BrokerageSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)

	SET @VolumeSelect2 = 'CONVERT(DECIMAL(30,10),' + @VolumeSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @TurnOverSelect2 = 'CONVERT(DECIMAL(30,10),' + @TurnOverSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @BrokerageSelect2 = 'CONVERT(DECIMAL(30,10),' + @BrokerageSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)

	IF @Month = '' Or @Consol = 'BranchSubbroker'
	BEGIN
		SET @@Temp =  @VolumeSelect1 + ' AS Volume,' + @PercentVolumeSelect1 + ' AS ''% Volume'', '
		SET @@Temp = @@Temp + @TurnOverSelect1 + ' AS TurnOver,' + @PercentTurnOverSelect1 + ' AS ''% TurnOver'', '
		SET @@Temp = @@Temp + @BrokerageSelect1 + ' AS Brokerage,' + @PercentBrokerageSelect1 + ' AS ''% Brokerage'' '
	END
	ELSE
	BEGIN
		SET @@Temp =  @VolumeSelect2 + ' AS Volume,' + @PercentVolumeSelect2 + ' AS ''% Volume'', ' 
		SET @@Temp = @@Temp + @TurnOverSelect2 + ' AS TurnOver,' + @PercentTurnOverSelect2 + ' AS ''% TurnOver'', ' 
		SET @@Temp = @@Temp + @BrokerageSelect2 + ' AS Brokerage,' + @PercentBrokerageSelect2 + ' AS ''% Brokerage'' '
	END

	*/	
	SET @@TotSelect = @BSECMTOSelect + ' AS TotalBSECMTurnover, ' + @BSECMBrokSelect + ' AS TotalBSECMBrok, ' + 
			@NSECMTOSelect + ' AS TotalNSECMTurnover, ' + @NSECMBrokSelect + ' AS TotalNSECMBrok, ' + 
			@NSEFOTOSelect + ' AS TotalNSEFOTurnover, ' + @NSEFOBrokSelect + ' AS TotalNSEFOBrok, ' + 
			@MCXTOSelect + ' AS TotalMCXTurnover, ' + @MCXBrokSelect + ' AS TotalMCXBrok, ' + 
			@NCXTOSelect + ' AS TotalNCXTurnover, ' + @NCXBrokSelect + ' AS TotalNCXBrok ' 


	SET @@Temp = @BSECMTOSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [BSECM TO], ' + 
		@NSECMTOSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [NSECM TO], ' + 
		@NSEFOTOSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [NSEFO TO], ' + 
		@MCXTOSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [MCX TO], ' + 
		@NCXTOSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [NCX TO], ' + 

		@BSECMBrokSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [BSECM BROK], ' + 
		@NSECMBrokSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [NSECM BROK], ' + 
		@NSEFOBrokSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [NSEFO BROK], ' + 
		@MCXBrokSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [MCX BROK], ' + 
		@NCXBrokSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [NCX BROK], ' + 

		@BSECMTOPercentSelect + ' AS [BSECM TO %], ' + 
		@NSECMTOPercentSelect + ' AS [NSECM TO %], ' + 
		@NSEFOTOPercentSelect + ' AS [NSEFO TO %], ' + 
		@MCXTOPercentSelect + ' AS [MCX TO %], ' + 
		@NCXTOPercentSelect + ' AS [NCX TO %], ' + 

		@BSECMBrokPercentSelect + ' AS [BSECM BROK %], ' + 
		@NSECMBrokPercentSelect + ' AS [NSECM BROK %], ' + 
		@NSEFOBrokPercentSelect + ' AS [NSEFO BROK %], ' + 
		@MCXBrokPercentSelect + ' AS [MCX BROK %], ' + 
		@NCXBrokPercentSelect + ' AS [NCX BROK %], ' + 

		@TotalTOSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [TOTAL TO], ' + 
		@TotalBrokSelect + ' / ' + CONVERT(VARCHAR, @Rounding) + ' AS [TOTAL Brok] '


-- START OF SELECT
	IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @FromBranch = '') 
		BEGIN	
			/* IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = ' Branch_cd,Branch=IsNull(rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
			ELSE */
			BEGIN
				SET @@SELECT = ' Branch_cd,Branch=IsNull(Rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ' + @@Temp
			END
		END
		ELSE
		BEGIN
			IF ( @Year = '')
			BEGIN
				IF (@@IsLevel1 = 'Y')
					SET @@SELECT =  ' [Year]= Datepart(Year,Sauda_Date) '
				ELSE
					SET @@SELECT =  ' [Year] '

				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = @@Select + ' , ExchangeSegment as ''Exchange Segment'', ' + @@Temp
				END
				ELSE */
				BEGIN
					SET @@SELECT = @@Select + ' , ' + @@Temp
				END	
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) as ''Month Name'', ExchangeSegment as [Exchange Segment], ' + @@Temp
					END
					ELSE */
					BEGIN
						SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) as ''Month Name'', ' + @@Temp
					END		
				END
				ELSE
				BEGIN 
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment  as ''Exchange Segment'', ' + @@Temp
					END
					ELSE */
					BEGIN
						SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
					END	
				END
			END
		END
	END

	IF (@Consol = 'Clientwise' )
	BEGIN
		SET @@SELECT = ' Party_Code, ' + @@Temp
		/* IF ( @flgSegment = 1 )
			SET @@SELECT = ' Party_Code,[Exchange Segment] = ExchangeSegment,  ' + @@Temp */
	END



	IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
		BEGIN
			SET @@SELECT = ' ExchangeSegment as ''Exchange Segment'', ' + @@Temp
		END
		ELSE
		BEGIN
			IF ( @Year = '' )
			BEGIN
				SET @@SELECT = ' [Year], ' + @@Temp
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'', ' + @@Temp
				END
				ELSE
				BEGIN	
					SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
				END
			END
		END
	END 

	IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
		BEGIN
			/* IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = '  [Year], ExchangeSegment as ''Exchange Segment'',' + @@Temp 															
			END
			ELSE */
			BEGIN
				SET @@SELECT = '  [Year],' + @@Temp														
			END		
		END
		ELSE
		BEGIN
			IF ( @Month = '' )
			BEGIN	
				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'', ExchangeSegment as ''Exchange Segment'',' + @@Temp
				END
				ELSE */
				BEGIN
					SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'',' + @@Temp																	
				END		
			END
			ELSE
			BEGIN
				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = ' DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment as ''Exchange Segment'',' + @@Temp 
				END
				ELSE */
				BEGIN
					SET @@SELECT = ' DATEPART (DD, Sauda_Date) AS Day,' + @@Temp
				END	
				
			END
		END
	END
	
	IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @FromBranch = '' )
		BEGIN
			/* IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
			ELSE */
			BEGIN				SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), '  + @@Temp
			END		
		END
		ELSE	
		BEGIN	
			IF ( @FromSubBroker = '' )
			BEGIN
				/* IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = '  A.Sub_Broker, B.Name, ExchangeSegment as ''Exchange Segment'', ' + @@Temp
				END
				ELSE */
				BEGIN
					SET @@SELECT = '  A.Sub_Broker, B.Name,  '  + @@Temp
				END		
			END
			ELSE
			BEGIN
				IF ( @Family = '' )
				BEGIN
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = '  Family, ExchangeSegment as ''Exchange Segment'', '  + @@Temp
					END
					ELSE */
					BEGIN
						SET @@SELECT = '  Family, '  + @@Temp
					END
				END
				ELSE	
				BEGIN
					/* IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = '  Party_code, ExchangeSegment as ''Exchange Segment'' , '  + @@Temp
					END
					ELSE */
					BEGIN
						SET @@SELECT = '  Party_code, '  + @@Temp
					END
				END
			END
		END
	END

--END OF SELECT
-----------------------------------------------------------------------------------------------------


--START OF @@SELECT_FINAL
	IF ( @SelectTop = 0 )
	BEGIN
		SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
	--	prINT @@SELECT_FINAL

	END
	ELSE
		SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL


	/* SET @@InnerTableQuery = ',( SELECT ' + @@TotSelect + @@FROM + @@WHERE + ') Totals ' */

	/*
	IF @@GROUPBY <> ''
		SET @@GROUPBY = @@GROUPBY + ',TotalVolume,TotalTurnOver,TotalBrokerage '
	ELSE
		SET @@GROUPBY = 'GROUP BY TotalVolume,TotalTurnOver,TotalBrokerage '
	*/
	--IF @@GROUPBY <> ''
	--	SET @@GROUPBY = @@GROUPBY + ', TotalBSECMTurnover, TotalBSECMBrok '
	--ELSE
	--	SET @@GROUPBY = 'GROUP BY TotalBSECMTurnover, TotalBSECMBrok '



	IF @@GROUPBY <> ''
		SET @@GROUPBY = @@GROUPBY + ', TotalBSECMTurnover, TotalNSECMTurnover, ' + 
			' TotalNSEFOTurnover, TotalMCXTurnover, TotalNCXTurnover, ' + 
			' TotalBSECMBrok, TotalNSECMBrok, TotalNSEFOBrok, TotalMCXBrok, TotalNCXBrok '
	ELSE
		SET @@GROUPBY = 'GROUP BY TotalBSECMTurnover, TotalNSECMTurnover, ' + 
			' TotalNSEFOTurnover, TotalMCXTurnover, TotalNCXTurnover, ' + 
			' TotalBSECMBrok, TotalNSECMBrok, TotalNSEFOBrok, TotalMCXBrok, TotalNCXBrok '


	SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
	SET @@InnerTableQuery = ',( SELECT ' + @@TotSelect + @@FROM + @@WHERE + ') Totals '
	--SET @@GROUPBY = @@GROUPBY + ', TotalBSECMTurnover, TotalBSECMBrok '

	PRINT (@@SELECT_FINAL + @@FROM + @@InnerTableQuery + @@WHERE + @@GROUPBY + @@ORDERBY)
	EXEC ( @@SELECT_FINAL + @@FROM + @@InnerTableQuery + @@WHERE + @@GROUPBY + @@ORDERBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcDrill1
-- --------------------------------------------------
CREATE PROCEDURE prcDrill1

/* MODIFIED  - 30 May 2:31 PM  */
-- In this Branchwise, SegmentWise, AllTotals, Branch SubBroker Wise,
-- corrected Dates in from - to, Percentage and TOP are working fine.
-- A parameter is added here for selecting the order for the TOP 
-- One more parameter is added for Exchange Segment

/*
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','HO','','','','','0',' ',0
	prcDrill1 'Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	prcDrill 'AllTotals', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'clientwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
*/

(
	@Consol varchar(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker */
	@DateFrom varchar(50) = '',
	@DateTo varchar(50) = '',
	@Year varchar(4) = '',
	@Month varchar(15) = '',
	@BranchCode varchar(10) = '',
	@Exchange varchar(10) = '',
	@SubBroker varchar(10) = '',
	@Family varchar(10) = '',
	@Party varchar(10) = '',
	@SelectTop int = 0,
	@SelectOrderBy varchar(200) = '',
	@flgSegment int = 0
)

AS

DECLARE	
	--@dd as varchar(6000),
	@@SELECT AS varchar(6000),
	@@FROM AS varchar(4000),
	@@WHERE AS varchar(6000),
	@@GROUPBY AS varchar(2000),
	@@ORDERBY AS varchar(2000),
	@@SELECT_FINAL AS varchar(6000),
	
	@@TOTVOLUME AS bigint,
	@@TOTTURNOVER AS bigint,
	@@TOTBROKERAGE AS bigint,
	@@TOTSELECT AS varchar(6000),
	@@TOTWHERE AS varchar(6000),
	@@strTotVolume as varchar(80),
	@@strTotTurnOver as varchar(80),
	@@strTotBrokerage as varchar(80),
	@@ErrId int
-----------------------------------------------------------------------------------------------------

--Initialization of variables
set @@SELECT  = 'This is Initialization of @@select' 
set @@FROM  = 'This is Initialization of @@from' 
set @@WHERE  = 'This is Initialization of @@where' 
set @@GROUPBY  = 'This is Initialization of @@groupby' 
set @@ORDERBY  = 'This is Initialization of @@orderby' 
set @@SELECT_FINAL  = 'This is Initialization of @@select_final' 
-----------------------------------------------------------------------------------------------------

-- This is Select part for the totals which are used in the Percentage. 
IF (  @Month <> '' AND @Consol <> 'BranchSubbroker')
	BEGIN
		SET @@TOTSELECT = ' SELECT  SUM ( cast(TP as money) + TS + DP + DS ) as TotalVolume, SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TotalTurnOver, SUM (cast(TPB as money) + TSB + DPB + DSB) as TotalBrokerage '
	END
ELSE
	BEGIN
		SET @@TOTSELECT = ' SELECT SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) as TotalVolume, SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) as TotalTurnOver, SUM (cast(TradingPurBrok as money)+ TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) as TotalBrokerage '
	END

-----------------------------------------------------------------------------------------------------

-- This is where part for the Totals which ate used in the Percentage
--SET @@TOTWHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date  <= CONVERT( DATETIME, ''' + @DateTo + '''  ) '


-----------------------------------------------------------------------------------------------------
-- START OF FROM

Declare @@IsLevel1 varchar(1), @@IsBrokName varchar(1)
Set @@IsBrokName = 'N'
Set @@IsLevel1 = 'N'

		IF (@Month = '' Or @Consol = 'BranchSubbroker')
			Begin
				If @BranchCode = '' And @SubBroker = '' And @Family = '' And @Party = '' And @Exchange = ''
					Begin
						If @Consol = 'BranchSubbroker' Or @Consol = 'Branchwise'
							Begin
								SET @@FROM  = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B '
								Set @@IsBrokName = 'Y'
							End
						Else
							SET @@FROM  = ' FROM Level6Mis A '
					End
				Else
					Begin
						If @Party = '' And @Family = '' And @SubBroker =''
						 Begin
							Set @@FROM = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B  '
							Set @@IsBrokName = 'Y'
						 End
						Else 
							If @Family = '' And @Party = ''
								Set @@FROM = ' FROM Level3Mis A '
							Else
								Set @@FROM = ' FROM Level2Mis A '
					End

				If ( @Consol = 'Clientwise' )
					Begin
						Set @@FROM = ' FROM Level2Mis A '
						Set @@IsBrokName = 'N'
					End
			END
		ELSE
			BEGIN
				SET @@FROM  = ' FROM Level1Mis A '
				Set @@IsLevel1 = 'Y'
			END

--END OF FROM
--------------------------------------------------------------------------------------------------------------

If @Month = ''	Or @Consol = 'BranchSubbroker'
	SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
Else
	SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month


If @BranchCode <> ''
	Set @@WHERE = @@WHERE + ' and Branch_cd = ''' + @BranchCode + ''''
If @SubBroker <> ''
	Set @@WHERE = @@WHERE + ' and A.Sub_Broker = ''' + @SubBroker + ''''
If @Family <> ''
	Set @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
If @Party <> ''
	Set @@WHERE = @@WHERE + ' and Party_Code = ''' + @Party + ''''
If @Exchange <> ''
	Set @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
If @Year <> ''
	Begin
		If @@IsLevel1 = 'N'
			Set @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		Else
			Set @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	End

If @@IsBrokName = 'Y'
	Set @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '

--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @BranchCode = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd '				
					end		
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
							end
						else
							begin
								SET @@GROUPBY  = ' GROUP BY [Year] '		
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
									end		
							END
					END
			END
	END

IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
			END
		ELSE
			BEGIN
				IF ( @year = '' )
					BEGIN	
						SET @@GROUPBY =  ' GROUP BY [Year] '
					END	
				ELSE
					BEGIN
						IF (@Month = '' )
							BEGIN
								SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
							END
						ELSE
							BEGIN
								SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
							END
					END
			END
	END

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY [Year], Exchangesegment '								
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY [Year] '		
					end		
			END
		ELSE
			BEGIN	
				IF ( @Month = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
							end		
					END
			END
	END


IF (@Consol = 'Clientwise' )
	SET @@GROUPBY = ' GROUP BY Party_Code '
	If ( @flgSegment = 1 )
		SET @@GROUPBY = @@GROUPBY + ' ,ExchangeSegment '


IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd '									
					end		
			END
		ELSE
			BEGIN
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name, ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name '				
							end		
					END
				ELSE
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Family '				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Party_code '		
									end		
							END
					END
			END
	END
--END OF GROUP BY
-----------------------------------------------------------------------------------------------------

-- START OF ORDER BY
If ( @SelectOrderBy = '' )
	Begin
		IF ( @Consol = 'BranchWise' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY  = ' ORDER BY Branch_cd'
					END
				ELSE
					BEGIN
						IF ( @Year = '' )
							BEGIN
								SET @@ORDERBY  = ' ORDER BY [YEAR]'
							END
						ELSE
							BEGIN
								IF ( @Month = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY [Year], [Month] '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
									END
							END
					END
			END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
				END
			ELSE
				BEGIN	
					IF ( @Year = '' ) 
						BEGIN
							SET @@ORDERBY  = ' ORDER BY [YEAR] '  
						END
					ELSE
						BEGIN
							IF ( @Month = '' ) 
								BEGIN
									SET @@ORDERBY  = ' ORDER BY [Month] '
								END
							ELSE
								BEGIN
									SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
								END
						END
				END
		END

		IF (@Consol = 'AllTotals' )
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Year] '
				END
			ELSE
				BEGIN
					IF ( @Month = '' )
						BEGIN
							SET @@ORDERBY = ' ORDER BY [Month] '		
						END
					ELSE
						BEGIN
							SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
						END
				END
			END

		IF (@Consol = 'Clientwise' ) 
			SET @@ORDERBY = ' ORDER BY Party_Code '
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Branch_cd '	
					END
				ELSE
					BEGIN
						IF ( @SubBroker = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY A.Sub_Broker '
							END
						ELSE
							BEGIN
								IF ( @Family = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY Family '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY Party_code'
									END
							END				
					END
			END
	End
Else
	Begin
		Set @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	End
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

-- Concatenating and Execution of Totals in the Percentage
--EXEC ( @@TOTSELECT + @@FROM + @@WHERE ) 
print ( @@TOTSELECT + @@FROM + @@WHERE ) 

Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )
Insert #TotalAll
Exec ( @@TOTSELECT + @@FROM + @@WHERE ) 
select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll
Drop Table #TotalAll

--print @@TotVolume
--print @@TotTurnOver
--print @@TotBrokerage
If ( @@TotVolume = '' Or @@TotVolume = 0 Or @@TotVolume Is Null  ) 
begin
	set @@TotVolume = 1
end

if  ( @@TotTurnOver = '' Or @@TotTurnOver = 0 Or @@TotTurnOver Is Null )
begin	
	set @@TotTurnOver = 1
end

if ( @@TotBrokerage = '' Or @@TotBrokerage = 0 Or @@TotBrokerage Is Null )
begin
	set @@TotBrokerage = 1
end

select @@strTotVolume = @@TotVolume
--print @@strTotVolume
select @@strTotTurnOver = @@TotTurnOver
select @@strTotBrokerage = @@TotBrokerage
--select @@strTotBrokerage

-----------------------------------------------------------------------------------------------------
/******
	Actual Query
******/


Declare @@Temp varchar(4000)

If @Month = '' Or @Consol = 'BranchSubbroker'
	Set @@Temp = 'SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
Else
	Set @@Temp = 'SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '




-- START OF SELECT
IF ( @Consol = 'BranchWise' )
	BEGIN
		--print 'aaa'
		IF ( @BranchCode = '') 
			BEGIN	
				--print 'bbb'
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(Rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ' + @@Temp
					end
			END
		ELSE
			BEGIN
				IF ( @Year = '')
					BEGIN
						If (@@IsLevel1 = 'Y')
							SET @@SELECT =  ' [Year]= Datepart(Year,Sauda_Date) '
						Else
							SET @@SELECT =  ' [Year] '

						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = @@Select + ' , ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = @@Select + ' , ' + @@Temp
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ExchangeSegment as [Exchange Segment], ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ' + @@Temp
									end		
							END
						ELSE
							BEGIN 
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment  as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
									end		
							END
					END
			END
	END

IF (@Consol = 'Clientwise' )
	Begin
		SET @@SELECT = ' Party_Code, ' + @@Temp
		If ( @flgSegment = 1 )
			SET @@SELECT = ' Party_Code,[Exchange Segment] = ExchangeSegment,  ' + @@Temp
	End



IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@SELECT = ' ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						SET @@SELECT = ' [Year], ' + @@Temp
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ' + @@Temp
							END
						ELSE
							BEGIN	
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
							END
					END
			END
	END 

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  [Year], ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
					end
				else
					begin
						SET @@SELECT = '  [Year], SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
					end		
			END
		ELSE
			BEGIN
				IF ( @Month = '' )
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
							end
						else
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment as ''Exchange Segment'', SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '
							end
						else
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '
							end		
						
					END
			END
	END
	
IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), '  + @@Temp
					end		
			END
		ELSE	
			BEGIN	
--print 'specified the branch'
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name, ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name,  '  + @@Temp
							end		
					END
				ELSE
--print 'specified the sub broker'
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Family, ExchangeSegment as ''Exchange Segment'', '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Family, '  + @@Temp
									end		
							END
						ELSE	
--print 'specified the family'	
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Party_code, ExchangeSegment as ''Exchange Segment'' , '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Party_code, '  + @@Temp
									end		
								
--print @@strTOTTURNOVER
--print @@SELECT
							END
					END
			END	
	END	


--END OF SELECT
-----------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------

--START OF @@SELECT_FINAL
---print 'ccc'
IF ( @SelectTop = 0 )
begin
--	print 'ddd'
	SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
--	print @@SELECT_FINAL
---print 'eee'
end
ELSE
	SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL
-----------------------------------------------------------------------------------------------------
--If ( @@SELECT <> '' )
--	Begin
		Print ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )
		EXEC ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )
--	End
/*
Set @@ErrId = @@ERROR
If @@ErrId <> 0 
	Begin
		RAISERROR ( 'An error occured', 10, 1 )
	End
*/
--print 'reached the print' 
--print @@SELECT_FINAL
--PRINT ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcDrillTry
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.prcDrill    Script Date: 10/26/2005 7:40:35 PM ******/
CREATE  PROCEDURE prcDrillTry

/* NEW MODIFIED  - 23 Jun 2005 11:56 AM */
-- In this Branchwise, SegmentWise, AllTotals, Branch SubBroker Wise,
-- corrected Dates in from - to, Percentage and TOP are working fine.
-- A parameter is added here for selecting the order for the TOP 
-- One more parameter is added for Exchange Segment

/*
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','HO','','','','','0',' ',0
	prcDrill 'Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	prcDrill 'AllTotals', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'clientwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '', '', '', '', '', '', '', '0', '', 0, ''
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '', '', 'XPU', '', '', '', '', '0', '', 0, ''
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '', '', '', '', '', '', '', '0', '', 0, 'RAJ SHARMA'
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '', '', 'BAN', '', '', '', '', '0', '', 0, 'RAJ SHARMA'
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '', '', 'XPU', '', 'PGS', '', '', '0', '', 0, 'RAJ SHARMA'
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '', '', '', '', '', '', '', '0', '', 0, 'KETAN PATIL'
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '', '', 'XPU', '', '', '', '', '0', '', 1, 'KETAN PATIL'
	prcDrillTry 'Executivewise', '1 Jun 2005', '15 Nov 2005', '2005', '', '', '', '', '', '', '0', '', 1, ''

	prcDrillTry 'Executivewise', 'Jun 1 2005', 'Nov 15 2005', '', '', 'HO', '', '', '', '', '0', '', 0, 'DEEPA RANJAN'           
*/

(
	@Consol varchar(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker, Executivewise */
	@DateFrom varchar(50) = '',
	@DateTo varchar(50) = '',
	@Year varchar(4) = '',
	@Month varchar(15) = '',
	@BranchCode varchar(10) = '',
	@Exchange varchar(10) = '',
	@SubBroker varchar(10) = '',
	@Family varchar(10) = '',
	@Party varchar(10) = '',
	@SelectTop int = 0,
	@SelectOrderBy varchar(200) = '',
	@flgSegment int = 0,
	@Executive varchar(100) = ''
)

AS

DECLARE	
	--@dd as varchar(6000),
	@@SELECT AS varchar(6000),
	@@FROM AS varchar(4000),
	@@WHERE AS varchar(6000),
	@@GROUPBY AS varchar(2000),
	@@ORDERBY AS varchar(2000),
	@@SELECT_FINAL AS varchar(6000),
	
	@@TOTVOLUME AS money,
	@@TOTTURNOVER AS money,
	@@TOTBROKERAGE AS money,
	@@TOTSELECT AS varchar(6000),
	@@TOTWHERE AS varchar(6000),
	@@strTotVolume as varchar(80),
	@@strTotTurnOver as varchar(80),
	@@strTotBrokerage as varchar(80),
	@@ErrId int
-----------------------------------------------------------------------------------------------------

--Initialization of variables
set @@SELECT  = '' 
set @@FROM  = '' 
set @@WHERE  = '' 
set @@GROUPBY  = '' 
set @@ORDERBY  = '' 
set @@SELECT_FINAL  = '' 
-----------------------------------------------------------------------------------------------------

-- This is Select part for the totals which are used in the Percentage. 
IF (  @Month <> '' AND @Consol <> 'BranchSubbroker')
	BEGIN
		SET @@TOTSELECT = ' SELECT  SUM ( cast(TP as money) + TS + DP + DS ) as TotalVolume, SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TotalTurnOver, SUM (cast(TPB as money) + TSB + DPB + DSB) as TotalBrokerage '
	END
ELSE
	BEGIN
		SET @@TOTSELECT = ' SELECT SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) as TotalVolume, SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) as TotalTurnOver, SUM (cast(TradingPurBrok as money)+ TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) as TotalBrokerage '
	END

-----------------------------------------------------------------------------------------------------

-- This is where part for the Totals which ate used in the Percentage
--SET @@TOTWHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date  <= CONVERT( DATETIME, ''' + @DateTo + '''  ) '


-----------------------------------------------------------------------------------------------------
-- START OF FROM

Declare @@IsLevel1 varchar(1), @@IsBrokName varchar(1)
Set @@IsBrokName = 'N'
Set @@IsLevel1 = 'N'

		IF (@Month = '' Or @Consol = 'BranchSubbroker')
			Begin
				If @BranchCode = '' And @SubBroker = '' And @Family = '' And @Party = '' And @Exchange = ''
					Begin
						If @Consol = 'BranchSubbroker' Or @Consol = 'Branchwise'
							Begin
								SET @@FROM  = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B '
								Set @@IsBrokName = 'Y'
							End
						Else
							SET @@FROM  = ' FROM Level6Mis A '
					End
				Else
					Begin
						If @Party = '' And @Family = '' And @SubBroker =''
						 Begin
							Set @@FROM = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B  '
							Set @@IsBrokName = 'Y'
						 End
						Else 
							If @Family = '' And @Party = ''
								Set @@FROM = ' FROM Level3Mis A '
							Else
								Set @@FROM = ' FROM level2MIS A '
					End

				If ( @Consol = 'Clientwise' )
					Begin
						Set @@FROM = ' FROM level2MIS A '
						Set @@IsBrokName = 'N'
					End
				
				/* Newly Added For Executive */
				If ( @Consol = 'Executivewise' )
					Begin
						If ( @Executive = '' or @BranchCode = '' )
							Begin
								Set @@FROM = ' FROM level2MIS A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecFieldMaster F  '
								Set @@IsBrokName = 'N'
							End
						Else
							If ( @SubBroker = '' )
								Begin
									Set @@FROM = ' FROM level2MIS A, Anand.Bsedb_ab.dbo.subbrokers B, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecFieldMaster F  '
									Set @@IsBrokName = 'Y'
								End
							Else
								Begin 
									Set @@FROM = ' FROM level2MIS A, intranet.AngelCS.dbo.tblMarketWorkDoneMaster W, intranet.AngelCS.dbo.tblMarketExecFieldMaster F  '
									--Set @@FROM = ' FROM Level4Mis A, , intranet.AngelCS.dbo.tblMarketWorkDoneMaster W '
									Set @@IsBrokName = 'N'
								End
					End
				
			END
		
		
		ELSE
			BEGIN
				SET @@FROM  = ' FROM Level1Mis A '
				Set @@IsLevel1 = 'Y'
			END

--END OF FROM
-----------------------------------------------------------------------------------------------------

If @Month = ''	Or @Consol = 'BranchSubbroker'
	SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
Else
	SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month


If @BranchCode <> ''
	Set @@WHERE = @@WHERE + ' and Branch_cd = ''' + @BranchCode + ''''
If @SubBroker <> ''
	Set @@WHERE = @@WHERE + ' and A.Sub_Broker = ''' + @SubBroker + ''''
If @Family <> ''
	Set @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
If @Party <> ''
	Set @@WHERE = @@WHERE + ' and Party_Code = ''' + @Party + ''''
If @Exchange <> ''
	Set @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
If @Year <> ''
	Begin
		If @@IsLevel1 = 'N'
			Set @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		Else
			Set @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	End

If @@IsBrokName = 'Y'
	Set @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '


/* Newly Added For Executive */
If @Consol = 'Executivewise'
	BEGIN
		SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
		--SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month
		
		Set @@WHERE = @@WHERE + ' AND W.MarketExecFieldId = F.MarketExecFieldId '
		Set @@WHERE = @@WHERE + ' AND BranchCode = A.Branch_cd '
		Set @@WHERE = @@WHERE + ' AND SubbrokerOrRemisierCode = A.Sub_Broker '
		Set @@WHERE = @@WHERE + ' AND W.Deleted = ''N'' '
--		Set @@WHERE = @@WHERE + ' AND W.Eff_ToDate = ''Dec 31 2999 23:59:00'' '

		Set @@WHERE = @@WHERE + ' AND F.Deleted = ''N'' '
--		Set @@WHERE = @@WHERE + ' AND F.Eff_ToDate = ''Dec 31 2999 23:59:00'' '
		
		If @Executive <> ''
			Set @@WHERE = @@WHERE + ' and FieldExecName = ''' + @Executive + ''''
		If @BranchCode <> ''
			--Begin
				Set @@WHERE = @@WHERE + ' and BranchCode = ''' + @BranchCode + ''''
				--Set @@WHERE = @@WHERE + ' and SubbrokerOrRemisierCode = B.Sub_Broker '
			--End

		--If @Executive <> '' and @BranchCode <> '' and @SubBroker = ''
		--	Set @@WHERE = @@WHERE + ' and SubbrokerOrRemisierCode = B.Sub_Broker '

		If @SubBroker <> ''
			Set @@WHERE = @@WHERE + ' and SubbrokerOrRemisierCode = ''' + @SubBroker + ''''
		If @Family <> ''
			Set @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
		If @Party <> ''
			Set @@WHERE = @@WHERE + ' and Party_Code = ''' + @Party + ''''
		If @Exchange <> ''
			Set @@WHERE = @@WHERE + ' and W.ExchSeg = ''' + @Exchange + ''''
		If @Year <> ''
			Begin
				If @@IsLevel1 = 'N'
					Set @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
				Else
					Set @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
			End
		
		If @@IsBrokName = 'Y'
		--If @@IsBrokName = 'N'
			BEGIN
				Set @@Where = @@Where + ' And A.Sub_Broker = B.Sub_Broker '
				--Set @@WHERE = @@WHERE + ' AND SubbrokerOrRemisierCode = A.Sub_Broker '
				--Set @@Where = @@Where + ' And SubbrokerOrRemisierCode = B.Sub_Broker '
			END

		--Conditions For All
		--Set @@WHERE = @@WHERE + ' AND SubbrokerOrRemisierCode = A.Sub_Broker '

END
--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @BranchCode = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd '				
					end		
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
							end
						else
							begin
								SET @@GROUPBY  = ' GROUP BY [Year] '		
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
									end		
							END
					END
			END
	END

IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
			END
		ELSE
			BEGIN
				IF ( @year = '' )
					BEGIN	
						SET @@GROUPBY =  ' GROUP BY [Year] '
					END	
				ELSE
					BEGIN
						IF (@Month = '' )
							BEGIN
								SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
							END
						ELSE
							BEGIN
								SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
							END
					END
			END
	END

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY [Year], Exchangesegment '								
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY [Year] '		
					end		
			END
		ELSE
			BEGIN	
				IF ( @Month = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
							end		
					END
			END
	END


IF (@Consol = 'Clientwise' )
	SET @@GROUPBY = ' GROUP BY Party_Code '
	If ( @flgSegment = 1 )
		SET @@GROUPBY = @@GROUPBY + ' ,ExchangeSegment '


IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd '									
					end		
			END
		ELSE
			BEGIN
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name, ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name '				
							end		
					END
				ELSE
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Family '				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Party_code '		
									end		
							END
					END
			END
	END

/* Newly Added for Executivewise */
IF ( @Consol = 'Executivewise' )

	BEGIN
		IF ( @Executive = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName, W.ExchSeg '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY W.MarketExecFieldId, FieldExecName '
					end		
			END
		ELSE 
			IF ( @BranchCode = '')
				BEGIN
					If ( @flgSegment = 1 )
						begin
							SET @@GROUPBY  = ' GROUP BY BranchCode, W.ExchSeg '
						end
					else
						begin
							SET @@GROUPBY  = ' GROUP BY BranchCode '
						end		
				END
		ELSE
			IF ( @SubBroker = '' )
				BEGIN
					If ( @flgSegment = 1 )
						begin
							SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode, B.Name, W.ExchSeg '
						end
					else
						begin
							SET @@GROUPBY = ' GROUP BY SubbrokerOrRemisierCode, B.Name '				
						end
				END
			
		ELSE
			BEGIN
				If ( @flgSegment = 1)
					begin
						SET @@GROUPBY = ' GROUP BY Party_code, W.ExchSeg '
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY Party_code'
					end
			END

		/*
			BEGIN
				IF ( @Year = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY [Year], W.ExchSeg '
							end
						else
							begin
								SET @@GROUPBY  = ' GROUP BY [Year] '		
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month], W.ExchSeg '
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, W.ExchSeg '
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '
									end
							END
					END
			END
		*/
	END


--END OF GROUP BY
-----------------------------------------------------------------------------------------------------
-- START OF ORDER BY
If ( @SelectOrderBy = '' )
	Begin
		IF ( @Consol = 'BranchWise' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY  = ' ORDER BY Branch_cd'
					END
				ELSE
					BEGIN
						IF ( @Year = '' )
							BEGIN
								SET @@ORDERBY  = ' ORDER BY [YEAR]'
							END
						ELSE
							BEGIN
								IF ( @Month = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY [Year], [Month] '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
									END
							END
					END
			END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
				END
			ELSE
				BEGIN	
					IF ( @Year = '' ) 
						BEGIN
							SET @@ORDERBY  = ' ORDER BY [YEAR] '  
						END
					ELSE
						BEGIN
							IF ( @Month = '' ) 
								BEGIN
									SET @@ORDERBY  = ' ORDER BY [Month] '
								END
							ELSE
								BEGIN
									SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
								END
						END
				END
		END

		IF (@Consol = 'AllTotals' )
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Year] '
				END
			ELSE
				BEGIN
					IF ( @Month = '' )
						BEGIN
							SET @@ORDERBY = ' ORDER BY [Month] '		
						END
					ELSE
						BEGIN
							SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
						END
				END
			END

		IF (@Consol = 'Clientwise' ) 
			SET @@ORDERBY = ' ORDER BY Party_Code '
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Branch_cd '	
					END
				ELSE
					BEGIN
						IF ( @SubBroker = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY A.Sub_Broker '
							END
						ELSE
							BEGIN
								IF ( @Family = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY Family '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY Party_code'
									END
							END				
					END
			END

		/* Newly Added for Executive */
		IF ( @Consol = 'Executivewise' )
			BEGIN
				IF ( @Executive = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY FieldExecName '	
					END
				ELSE
					BEGIN
						IF ( @BranchCode = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY BranchCode '	
							END
						ELSE
							IF ( @SubBroker = '' )
								BEGIN
									SET @@ORDERBY = ' ORDER BY SubbrokerOrRemisierCode '	
								END
							ELSE
								BEGIN
									SET @@ORDERBY = ' ORDER BY Party_code '
								END
					END
			END
	End
Else
	Begin
		Set @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	End
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

-- Concatenating and Execution of Totals in the Percentage
--EXEC ( @@TOTSELECT + @@FROM + @@WHERE ) 
--print ( @@TOTSELECT + @@FROM + @@WHERE ) 

print @@TOTSELECT + @@FROM + @@WHERE + '---------------'
Create Table #TotalAll (TotVolume  money, TotTurnOver  money, TotBrokerage  money )
--Insert #TotalAll
Exec ('insert #TotalAll '+@@TOTSELECT + @@FROM + @@WHERE)
select @@TotVolume=convert(money,TotVolume) ,@@TotTurnOver=convert(money,TotTurnOver),@@TotBrokerage=convert(money,TotBrokerage) from  #TotalAll
Drop Table #TotalAll

--print @@TotVolume
--print @@TotTurnOver
--print @@TotBrokerage

select @@strTotVolume = cast(@@TotVolume as varchar)
--print @@strTotVolume
select @@strTotTurnOver = cast(@@TotTurnOver as varchar)
select @@strTotBrokerage = cast(@@TotBrokerage as varchar)

If ( @@strTotVolume = '' Or @@strTotVolume = '0' Or @@strTotVolume Is Null  ) 
begin
	set @@strTotVolume = 1
end

if  ( @@strTotTurnOver = '' Or @@strTotTurnOver = '0' Or @@strTotTurnOver Is Null )
begin	
	set @@strTotTurnOver = 1
end

if ( @@strTotBrokerage = '' Or @@strTotBrokerage = '0' Or @@strTotBrokerage Is Null )
begin
	set @@strTotBrokerage = 1
end

--select @@strTotBrokerage

-----------------------------------------------------------------------------------------------------
/******
	Actual Query
******/


Declare @@Temp varchar(4000)

If @Month = '' Or @Consol = 'BranchSubbroker'
	Begin
		/* FOR EXECUTIVE SHOW FIGURES IN LACS i.e. DIVIDE BY 100000 */
		If @Consol = 'Executivewise'
			Begin
				Set @@Temp = 'SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/100000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/100000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/100000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
			End
		Else
			Begin
				Set @@Temp = 'SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
			End
	End
Else
	Set @@Temp = 'SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '




-- START OF SELECT
IF ( @Consol = 'BranchWise' )
	BEGIN
		--print 'aaa'
		IF ( @BranchCode = '') 
			BEGIN	
				--print 'bbb'
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' Branch_cd,Branch=IsNull(Rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ' + @@Temp
					end
			END
		ELSE
			BEGIN
				IF ( @Year = '')
					BEGIN
						If (@@IsLevel1 = 'Y')
							SET @@SELECT =  ' [Year]= Datepart(Year,Sauda_Date) '
						Else
							SET @@SELECT =  ' [Year] '

						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = @@Select + ' , ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = @@Select + ' , ' + @@Temp
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ExchangeSegment as [Exchange Segment], ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ' + @@Temp
									end		
							END
						ELSE
							BEGIN 
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment  as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
									end		
							END
					END
			END
	END

IF (@Consol = 'Clientwise' )
	Begin
		SET @@SELECT = ' Party_Code, ' + @@Temp
		If ( @flgSegment = 1 )
			SET @@SELECT = ' Party_Code,[Exchange Segment] = ExchangeSegment,  ' + @@Temp
	End



IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@SELECT = ' ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						SET @@SELECT = ' [Year], ' + @@Temp
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ' + @@Temp
							END
						ELSE
							BEGIN	
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
							END
					END
			END
	END 

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  [Year], ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '	
					end
				else
					begin
						SET @@SELECT = '  [Year], SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
					end		
			END
		ELSE
			BEGIN
				IF ( @Month = '' )
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ExchangeSegment as ''Exchange Segment'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
							end
						else
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )/10000000 AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt )/10000000 AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)/10000000 AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment as ''Exchange Segment'', SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB)/10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '
							end
						else
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, SUM ( cast(TP as money) + TS + DP + DS )/10000000 as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA )/10000000 as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) /10000000 as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '
							end		
						
					END
			END
	END
	
IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), '  + @@Temp
					end		
			END
		ELSE	
			BEGIN	
--print 'specified the branch'
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name, ExchangeSegment as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = '  A.Sub_Broker, B.Name,  '  + @@Temp
							end		
					END
				ELSE
--print 'specified the sub broker'
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Family, ExchangeSegment as ''Exchange Segment'', '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Family, '  + @@Temp
									end		
							END
						ELSE	
--print 'specified the family'	
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Party_code, ExchangeSegment as ''Exchange Segment'' , '  + @@Temp
									end
								else
									begin
										SET @@SELECT = '  Party_code, '  + @@Temp
									end		
								
--print @@strTOTTURNOVER
--print @@SELECT
							END
					END
			END	
	END	

/* Newly Added for Executive */
IF ( @Consol = 'Executivewise' )
	BEGIN
		--print 'aaa'
		IF ( @Executive = '') 
			BEGIN	
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
					end
				else
					begin
						SET @@SELECT = ' /* MarketExecFieldId = W.MarketExecFieldId, */ FieldExecName = isnull(F.FieldExecName, ''--''), ' + @@Temp
					end
			END

		ELSE
			BEGIN
				IF ( @BranchCode = '') 
					BEGIN	
						--print 'bbb'
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' BranchCode, Branch = IsNull(rtrim((Select Branch from Branch where Branch_code = BranchCode)), ''--''), ' + @@Temp
							end
					END
				ELSE
					IF ( @SubBroker = '') 
						BEGIN	
						--print 'bbb'
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' SubbrokerOrRemisierCode, B.Name, W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' SubbrokerOrRemisierCode, B.Name, ' + @@Temp
							end
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' Party_Code, Party_Name = min(Party_name), W.ExchSeg as ''Exchange Segment'', ' + @@Temp
							end
						else
							begin
								SET @@SELECT = ' Party_Code, Party_Name = min(Party_name), ' + @@Temp
							end
					END
					/*
					BEGIN
						IF ( @Year = '')
							BEGIN
								If (@@IsLevel1 = 'Y')
									SET @@SELECT =  ' [Year] = Datepart(Year,Sauda_Date) '
								Else
									SET @@SELECT =  ' [Year] '
		
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = @@Select + ' , W.ExchSeg as ''Exchange Segment'', ' + @@Temp
									end
								else
									begin
										SET @@SELECT = @@Select + ' , ' + @@Temp
									end		
							END
						ELSE
							BEGIN
								IF ( @Month = '' )
									BEGIN
										If ( @flgSegment = 1 )
											begin
												SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', W.ExchSeg as [Exchange Segment], ' + @@Temp
											end
										else
											begin
												SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ' + @@Temp
											end		
									END
								ELSE
									BEGIN 
										If ( @flgSegment = 1 )
											begin
												SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, W.ExchSeg  as ''Exchange Segment'', ' + @@Temp
											end
										else
											begin
												SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
											end		
									END
							END
					END

					*/
			END
	END



--END OF SELECT
-----------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------

--START OF @@SELECT_FINAL
---print 'ccc'
IF ( @SelectTop = 0 )
begin
--	print 'ddd'
	SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
--	print @@SELECT_FINAL
---print 'eee'
end
ELSE
	SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL
-----------------------------------------------------------------------------------------------------
--If ( @@SELECT <> '' )
--	Begin
--	

	Print (@@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY)
	EXEC ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

--	End
/*
Set @@ErrId = @@ERROR
If @@ErrId <> 0 
	Begin
		RAISERROR ( 'An error occured', 10, 1 )
	End
*/
--print 'reached the print' 
--print @@SELECT_FINAL
--PRINT ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcDrillWithStatusId
-- --------------------------------------------------

--WITH VOLUME
CREATE   PROCEDURE prcDrillWithStatusId

/* NEW MODIFIED  - 23 Jun 2005 11:56 AM */
-- In this Branchwise, SegmentWise, AllTotals, Branch SubBroker Wise,
-- corrected Dates in from - to, Percentage and TOP are working fine.
-- A parameter is added here for selecting the order for the TOP 
-- One more parameter is added for Exchange Segment

/*
	prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','HO','','','','','0',' ',0
	prcDrill 'AllTotals', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	prcDrill 'branchwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	prcDrill 'clientwise', '1 May 2001', '1 May 2005 ','2005','3','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','XS','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','2005','','','','','','','0',' ',0
	exec prcDrill 'Segmentwise', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0


	EXEC prcDrill 'Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'statusid','statusname','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Broker','','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Branch','ACM','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Subbroker','ACM','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Client','A1024','Alltotals', '1 May 2001', '1 May 2005 ','','','','','','','','0',' ',0


	EXEC prcDrill 'BranchSubBroker', '1 May 2001', '1 May 2005 ','','','XS','','','','','0',' ',0
	EXEC prcDrillWithStatusID 'Broker','','BranchSubBroker', '1 May 2001', '1 May 2005 ','','','XS','','','','','0',' ',0

*/

(
	@StatusID VARCHAR(10),
	@StatusName VARCHAR(15),
	@Consol VARCHAR(25) = '', /* Branchwise, Segmentwise, AllTotals,Clientwise, BranchSubBroker */
	@DateFrom VARCHAR(50) = '',
	@DateTo VARCHAR(50) = '',
	@Year VARCHAR(4) = '',
	@Month VARCHAR(15) = '',
	@BranchCode VARCHAR(10) = '',
	@Exchange VARCHAR(10) = '',
	@SubBroker VARCHAR(10) = '',
	@Family VARCHAR(10) = '',
	@Party VARCHAR(10) = '',
	@SelectTop INT = 0,
	@SelectOrderBy VARCHAR(200) = '',
	@flgSegment INT = 0,
	@Rounding INT = 10000000
)

AS

	DECLARE @WhereClauseExt VARCHAR(500) 

	IF @StatusId = 'Branch'
	BEGIN
     		SET @BranchCode = @StatusName
		SET @WhereClauseExt = 'Branch_Cd = ' + @StatusName

	END

	IF @StatusId = 'Subbroker'
	BEGIN
		SET @SubBroker = @StatusName
		SET @WhereClauseExt = 'Sub_Broker = ' + @StatusName

	END

	IF @StatusId = 'Client'
	BEGIN
		SET @Party = @StatusName
		SET @WhereClauseExt = 'Party_Code = ' + @StatusName
	END

	DECLARE	
		@@SELECT AS VARCHAR(6000),
		@@FROM AS VARCHAR(4000),
		@@WHERE AS VARCHAR(6000),
		@@GROUPBY AS VARCHAR(2000),
		@@ORDERBY AS VARCHAR(2000),
		@@SELECT_FINAL AS VARCHAR(6000),

		@@InnerTableQuery AS VARCHAR(6000),
	
		@@TOTVOLUME AS MONEY,
		@@TOTTURNOVER AS MONEY,
		@@TOTBROKERAGE AS MONEY,
		@@TOTSELECT AS VARCHAR(6000),
		@@TOTWHERE AS VARCHAR(6000),
		@@ErrId INT

----------------------------------------------------------------------------------------------------
--Block added By Abhijeet On 25th November 2005 For
--	Removing INTermediate Table Insert
--	Rounding All % Values in DECIMAL(30,10) 

	DECLARE
		@VolumeSelect1 VARCHAR(1000),
		@TurnOverSelect1 VARCHAR(1000),
		@BrokerageSelect1 VARCHAR(1000),
		@PercentVolumeSelect1 VARCHAR(1000),
		@PercentTurnOverSelect1 VARCHAR(1000),
		@PercentBrokerageSelect1 VARCHAR(1000),

		@VolumeSelect2 VARCHAR(1000),
		@TurnOverSelect2 VARCHAR(1000),
		@BrokerageSelect2 VARCHAR(1000),
		@PercentVolumeSelect2 VARCHAR(1000),
		@PercentTurnOverSelect2 VARCHAR(1000),
		@PercentBrokerageSelect2 VARCHAR(1000)


		SET @VolumeSelect1 = 'SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty))'
		SET @TurnOverSelect1 = 'SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt)'
		SET @BrokerageSelect1 = 'SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok)'

		SET @PercentVolumeSelect1 =  'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TradingPurQty) + CONVERT(BIGINT,TradingSaleQty) + CONVERT(BIGINT,DeliveryPurQty) + CONVERT(BIGINT,DeliverySaleQty)))/TotalVolume*100'
		SET @PercentTurnOverSelect1 = 'CONVERT(DECIMAL(30,10),SUM(TradingPurAmt + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt))/TotalTurnOver*100'
		SET @PercentBrokerageSelect1 = 'CONVERT(DECIMAL(30,10),SUM(TradingPurBrok + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok))/TotalBrokerage*100'


		SET @VolumeSelect2 = 'SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS))'
		SET @TurnOverSelect2 = 'SUM(TPA + TSA + DPA + DSA)'
		SET @BrokerageSelect2 = 'SUM(TPB + TSB + DPB + DSB)'

		SET @PercentVolumeSelect2 = 'CONVERT(DECIMAL(30,10),SUM(CONVERT(BIGINT,TP) + CONVERT(BIGINT,TS) + CONVERT(BIGINT,DP) + CONVERT(BIGINT,DS)))/TotalVolume*100'
		SET @PercentTurnOverSelect2 = 'CONVERT(DECIMAL(30,10),SUM(TPA + TSA + DPA + DSA))/TotalTurnOver*100'
		SET @PercentBrokerageSelect2 = 'CONVERT(DECIMAL(30,10),SUM(TPB + TSB + DPB + DSB))/TotalBrokerage*100'

-----------------------------------------------------------------------------------------------------

--Initialization of variables
	SET @@SELECT  = '' 
	SET @@FROM  = '' 
	SET @@WHERE  = '' 
	SET @@GROUPBY  = '' 
	SET @@ORDERBY  = '' 
	SET @@SELECT_FINAL  = '' 
-----------------------------------------------------------------------------------------------------

-- START OF FROM

	DECLARE @@IsLevel1 VARCHAR(1), @@IsBrokName VARCHAR(1)
	SET @@IsBrokName = 'N'
	SET @@IsLevel1 = 'N'

	IF (@Month = '' Or @Consol = 'BranchSubbroker')
	BEGIN
		IF @BranchCode = '' And @SubBroker = '' And @Family = '' And @Party = '' And @Exchange = ''
		BEGIN
			IF @Consol = 'BranchSubbroker' Or @Consol = 'Branchwise'
			BEGIN
				SET @@FROM  = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B '
				SET @@IsBrokName = 'Y'
			END
			ELSE	SET @@FROM  = ' FROM Level6Mis A '
		END
		ELSE
		BEGIN
			IF @Party = '' And @Family = '' And @SubBroker =''
		 	BEGIN
				SET @@FROM = ' FROM Level4Mis A, Anand.Bsedb_ab.dbo.subbrokers B  '
				SET @@IsBrokName = 'Y'
			END
			ELSE 
				IF @Family = '' And @Party = ''
					SET @@FROM = ' FROM Level3Mis A '
				ELSE
					SET @@FROM = ' FROM Level2Mis A '
		END

		IF ( @Consol = 'Clientwise' )
		BEGIN
			SET @@FROM = ' FROM Level2Mis A '
			SET @@IsBrokName = 'N'
		END
	END
	ELSE
	BEGIN
		SET @@FROM  = ' FROM Level1Mis A '
		SET @@IsLevel1 = 'Y'
	END

--END OF FROM
-----------------------------------------------------------------------------------------------------

	IF @Month = ''	Or @Consol = 'BranchSubbroker'
		SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
	ELSE
		SET @@WHERE = ' WHERE Sauda_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND Sauda_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) and DatePart(Month,sauda_date)= ' + @Month


	IF @BranchCode <> ''
		SET @@WHERE = @@WHERE + ' and Branch_cd = ''' + @BranchCode + ''''
	IF @SubBroker <> ''
		SET @@WHERE = @@WHERE + ' and A.Sub_Broker = ''' + @SubBroker + ''''
	IF @Family <> ''
		SET @@WHERE = @@WHERE + ' and Family = ''' + @Family + ''''
	IF @Party <> ''
		SET @@WHERE = @@WHERE + ' and Party_Code = ''' + @Party + ''''
	IF @Exchange <> ''
		SET @@WHERE = @@WHERE + ' and ExchangeSegment = ''' + @Exchange + ''''
	IF @Year <> ''
	BEGIN
		IF @@IsLevel1 = 'N'
			SET @@WHERE = @@WHERE + ' and Year = ''' + @Year + ''''
		ELSE
			SET @@WHERE = @@WHERE + ' and DatePart(Year,Sauda_Date) = ''' + @Year + ''''
	END

	IF @@IsBrokName = 'Y'
		SET @@Where = @@Where + ' And A.Sub_Broker=B.Sub_Broker '

--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
	IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @BranchCode = '')
		BEGIN
			IF ( @flgSegment = 1 )
				SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
			ELSE
				SET @@GROUPBY  = ' GROUP BY Branch_cd '				
		END
		ELSE
		BEGIN
			IF ( @Year = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
				END
				ELSE
				BEGIN
					SET @@GROUPBY  = ' GROUP BY [Year] '		
				END		
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
					END
					ELSE
					BEGIN
						SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
					END		
				END
				ELSE
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
					END
					ELSE
					BEGIN
						SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
					END		
				END
			END
		END
	END

	IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
		BEGIN
			SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
		END
		ELSE
		BEGIN
			IF ( @year = '' )
			BEGIN	
				SET @@GROUPBY =  ' GROUP BY [Year] '
			END	
			ELSE
			BEGIN
				IF (@Month = '' )
				BEGIN
					SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
				END
				ELSE
				BEGIN
					SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
				END
			END
		END
	END

	IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@GROUPBY = ' GROUP BY [Year], Exchangesegment '								
			END
			ELSE
			BEGIN
				SET @@GROUPBY = ' GROUP BY [Year] '		
			END		
		END
		ELSE
		BEGIN	
			IF ( @Month = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
				END
				ELSE
				BEGIN
					SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
				END		
			END
			ELSE
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
				END
				ELSE
				BEGIN
					SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
				END		
			END
		END
	END


	IF (@Consol = 'Clientwise' )
		SET @@GROUPBY = ' GROUP BY Party_Code '
	IF ( @flgSegment = 1 )
		SET @@GROUPBY = @@GROUPBY + ' ,ExchangeSegment '


	IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
			END
			ELSE
			BEGIN
				SET @@GROUPBY = ' GROUP BY Branch_cd '									
			END		
		END
		ELSE
		BEGIN
			IF ( @SubBroker = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name, ExchangeSegment '									
				END
				ELSE
				BEGIN
					SET @@GROUPBY = ' GROUP BY A.Sub_Broker, B.Name '				
				END		
			END
			ELSE
			BEGIN
				IF ( @Family = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '								
					END
					ELSE
					BEGIN
						SET @@GROUPBY = ' GROUP BY Family '				
					END		
				END
				ELSE
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
					END
					ELSE
					BEGIN
						SET @@GROUPBY = ' GROUP BY Party_code '		
					END		
				END
			END
		END
	END

--END OF GROUP BY
-----------------------------------------------------------------------------------------------------
-- START OF ORDER BY
	IF ( @SelectOrderBy = '' )
	BEGIN
		IF ( @Consol = 'BranchWise' )
		BEGIN
			IF ( @BranchCode = '' )
			BEGIN
				SET @@ORDERBY  = ' ORDER BY Branch_cd'
			END
			ELSE
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY [YEAR]'
				END
				ELSE
				BEGIN
					IF ( @Month = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY [Year], [Month] '
					END
					ELSE
					BEGIN
						SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
					END
				END
			END
		END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
			BEGIN
				SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
			END
			ELSE
			BEGIN	
				IF ( @Year = '' ) 
				BEGIN
					SET @@ORDERBY  = ' ORDER BY [YEAR] '  
				END
				ELSE
				BEGIN
					IF ( @Month = '' ) 
					BEGIN
						SET @@ORDERBY  = ' ORDER BY [Month] '
					END
					ELSE
					BEGIN
						SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
					END
				END
			END
		END

		IF (@Consol = 'AllTotals' )
		BEGIN
			IF ( @Year = '' )
			BEGIN
				SET @@ORDERBY = ' ORDER BY [Year] '
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Month] '		
				END
				ELSE
				BEGIN
					SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
				END
			END
		END

		IF (@Consol = 'Clientwise' ) 
			SET @@ORDERBY = ' ORDER BY Party_Code '
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
			IF ( @BranchCode = '' )
			BEGIN
				SET @@ORDERBY = ' ORDER BY Branch_cd '	
			END
			ELSE
			BEGIN
				IF ( @SubBroker = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY A.Sub_Broker '
				END
				ELSE
				BEGIN
					IF ( @Family = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Family '
					END
					ELSE
					BEGIN
						SET @@ORDERBY = ' ORDER BY Party_code'
					END
				END				
			END
		END
	END
	ELSE
	BEGIN
		SET @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	END
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

	DECLARE @@Temp VARCHAR(4000)

	IF @Month = '' Or @Consol = 'BranchSubbroker'
		SET @@TotSelect = @VolumeSelect1 + ' AS TotalVolume,' + @TurnOverSelect1 + ' AS TotalTurnOver,' + @BrokerageSelect1 + ' AS TotalBrokerage '
	ELSE
		SET @@TotSelect = @VolumeSelect2 + ' AS TotalVolume,' + @TurnOverSelect2 + ' AS TotalTurnOver,' + @BrokerageSelect2 + ' AS TotalBrokerage '

	SET @VolumeSelect1 = 'CONVERT(DECIMAL(30,10),' + @VolumeSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @TurnOverSelect1 = 'CONVERT(DECIMAL(30,10),' + @TurnOverSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @BrokerageSelect1 = 'CONVERT(DECIMAL(30,10),' + @BrokerageSelect1 + ')/' + CONVERT(VARCHAR,@Rounding)

	SET @VolumeSelect2 = 'CONVERT(DECIMAL(30,10),' + @VolumeSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @TurnOverSelect2 = 'CONVERT(DECIMAL(30,10),' + @TurnOverSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)
	SET @BrokerageSelect2 = 'CONVERT(DECIMAL(30,10),' + @BrokerageSelect2 + ')/' + CONVERT(VARCHAR,@Rounding)

	IF @Month = '' Or @Consol = 'BranchSubbroker'
		SET @@Temp =  @VolumeSelect1 + ' AS Volume,' + @PercentVolumeSelect1 + ' AS ''% Volume'',' + @TurnOverSelect1 + ' AS TurnOver,' + @PercentTurnOverSelect1 + ' AS ''% TurnOver'',' + @BrokerageSelect1 + ' AS Brokerage,' + @PercentBrokerageSelect1 + ' AS ''% Brokerage'' '
	ELSE
		SET @@Temp =  @VolumeSelect2 + ' AS Volume,' + @PercentVolumeSelect2 + ' AS ''% Volume'',' + @TurnOverSelect2 + ' AS TurnOver,' + @PercentTurnOverSelect2 + ' AS ''% TurnOver'',' + @BrokerageSelect2 + ' AS Brokerage,' + @PercentBrokerageSelect2 + ' AS ''% Brokerage'' '



-- START OF SELECT
	IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @BranchCode = '') 
		BEGIN	
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = ' Branch_cd,Branch=IsNull(rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
			ELSE
			BEGIN
				SET @@SELECT = ' Branch_cd,Branch=IsNull(Rtrim((Select Branch from Branch where Branch_code=Branch_cd)),''--''), ' + @@Temp
			END
		END
		ELSE
		BEGIN
			IF ( @Year = '')
			BEGIN
				IF (@@IsLevel1 = 'Y')
					SET @@SELECT =  ' [Year]= Datepart(Year,Sauda_Date) '
				ELSE
					SET @@SELECT =  ' [Year] '

				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = @@Select + ' , ExchangeSegment as ''Exchange Segment'', ' + @@Temp
				END
				ELSE
				BEGIN
					SET @@SELECT = @@Select + ' , ' + @@Temp
				END		
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) as ''Month Name'', ExchangeSegment as [Exchange Segment], ' + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) as ''Month Name'', ' + @@Temp
					END		
				END
				ELSE
				BEGIN 
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment  as ''Exchange Segment'', ' + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ' + @@Temp
					END		
				END
			END
		END
	END

	IF (@Consol = 'Clientwise' )
	BEGIN
		SET @@SELECT = ' Party_Code, ' + @@Temp
		IF ( @flgSegment = 1 )
			SET @@SELECT = ' Party_Code,[Exchange Segment] = ExchangeSegment,  ' + @@Temp
	END



	IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
		BEGIN
			SET @@SELECT = ' ExchangeSegment as ''Exchange Segment'', ' + @@Temp
		END
		ELSE
		BEGIN
			IF ( @Year = '' )
			BEGIN
				SET @@SELECT = ' [Year], ' + @@Temp
			END
			ELSE
			BEGIN
				IF ( @Month = '' )
				BEGIN
					SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'', ' + @@Temp
				END
				ELSE
				BEGIN	
					SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ' + @@Temp
				END
			END
		END
	END 

	IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = '  [Year], ExchangeSegment as ''Exchange Segment'',' + @@Temp 															
			END
			ELSE
			BEGIN
				SET @@SELECT = '  [Year],' + @@Temp														
			END		
		END
		ELSE
		BEGIN
			IF ( @Month = '' )
			BEGIN	
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'', ExchangeSegment as ''Exchange Segment'',' + @@Temp
				END
				ELSE
				BEGIN
					SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as VARCHAR) + ''/01/'' + cast([Year] as VARCHAR))) AS ''Month Name'',' + @@Temp																	
				END		
			END
			ELSE
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = ' DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment as ''Exchange Segment'',' + @@Temp 
				END
				ELSE
				BEGIN
					SET @@SELECT = ' DATEPART (DD, Sauda_Date) AS Day,' + @@Temp
				END		
						
			END
		END
	END
	
	IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
		BEGIN
			IF ( @flgSegment = 1 )
			BEGIN
				SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), ExchangeSegment as ''Exchange Segment'', ' + @@Temp
			END
			ELSE
			BEGIN				SET @@SELECT = '  Branch_cd,Branch=IsNull((Select Branch from Branch where Branch_code=Branch_cd),''--''), '  + @@Temp
			END		
		END
		ELSE	
		BEGIN	
			IF ( @SubBroker = '' )
			BEGIN
				IF ( @flgSegment = 1 )
				BEGIN
					SET @@SELECT = '  A.Sub_Broker, B.Name, ExchangeSegment as ''Exchange Segment'', ' + @@Temp
				END
				ELSE
				BEGIN
					SET @@SELECT = '  A.Sub_Broker, B.Name,  '  + @@Temp
				END		
			END
			ELSE
			BEGIN
				IF ( @Family = '' )
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = '  Family, ExchangeSegment as ''Exchange Segment'', '  + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = '  Family, '  + @@Temp
					END		
				END
				ELSE	
				BEGIN
					IF ( @flgSegment = 1 )
					BEGIN
						SET @@SELECT = '  Party_code, ExchangeSegment as ''Exchange Segment'' , '  + @@Temp
					END
					ELSE
					BEGIN
						SET @@SELECT = '  Party_code, '  + @@Temp
					END		
				END
			END
		END	
	END	

--END OF SELECT
-----------------------------------------------------------------------------------------------------


--START OF @@SELECT_FINAL
	IF ( @SelectTop = 0 )
	BEGIN
		SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
	--	prINT @@SELECT_FINAL

	END
	ELSE
		SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL


	SET @@InnerTableQuery = ',( SELECT ' + @@TotSelect + @@FROM + @@WHERE + ') Totals '

	IF @@GROUPBY <> ''
		SET @@GROUPBY = @@GROUPBY + ',TotalVolume,TotalTurnOver,TotalBrokerage '
	ELSE
		SET @@GROUPBY = 'GROUP BY TotalVolume,TotalTurnOver,TotalBrokerage '



	PrINT (@@SELECT_FINAL + @@FROM + @@InnerTableQuery + @@WHERE + @@GROUPBY + @@ORDERBY)
	EXEC ( @@SELECT_FINAL + @@FROM + @@InnerTableQuery + @@WHERE + @@GROUPBY + @@ORDERBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcEBroking
-- --------------------------------------------------
CREATE Procedure prcEBroking  
(  
 @Console Varchar(15)='', /* Branchwise, Clientwise, Datewise, Terminalwise */  
 @FromDate Varchar(40)='',  
 @ToDate Varchar(40)='',  
 @Year Varchar(4)='',  
 @Month_NO Varchar(2)='',  
 @Segment Varchar(15)='',  
 @Branch_cd Varchar(15)='',  
 @Sub_Broker Varchar(15)='',  
 @Family Varchar(20)='',  
 @Party_Code Varchar(15)='',  
 @Top Varchar(4)='0',  
 @Order Varchar(25)='',  
 @IsSegmentWise Varchar(1)='',  
 @Terminal_ID Varchar(20)=''  
)  
  
As  
  
/*  
 Created On 16 Apr 2005
 Modified On 23 Jun 2005
 By Hemant
  
 Run As :  
  For Branchwise  
  prcEBroking 'Branchwise','Apr 11 2005','Apr 12 2005'
  prcEBroking 'Branchwise','Apr 11 2005','Apr 12 2005','','','','HO'

  For Clientwise  
  prcEBroking 'Clientwise','Apr 11 2004','Apr 12 2004','','','','','SI50','SI50'  
  prcEBroking 'Clientwise','Apr 11 2005','Apr 12 2005','','','','','1'  
  
  For Datewise  
  prcEBroking 'Datewise','Apr 11 2005','Apr 25 2005'  
  prcEBroking 'Datewise','Apr 11 2005','Apr 25 2005','','','','','','','','','','1'  
  
  For Terminalwise  
  prcEBroking 'Terminalwise', 'Apr 01 2003','Apr 30 2004','2004','4','','HO','HO'  
*/  
  
Begin  
  
/*  
 Set @FromDate = ' Apr 11 2005 00:00:00'  
 Set @ToDate = ' Apr 12 2005 00:00:00'  
 Set @IsSegmentWise = '0'  
 Set @Top = '5'  
 Set @Branch_cd = ''  
 Set @Sub_Broker = ''  
 Set @Party_Code = ''  
*/  
  
Declare @Select Varchar(2000)  
Declare @From Varchar(500)  
Declare @Where Varchar(3000)  
Declare @GroupBy Varchar(600)  
Declare @OrderBy Varchar(600)  
  
  
If @Console = 'Branchwise'  
  
Begin  
  If @Branch_cd = ''  
   Begin  
    Set @Select = ' [Branch Code]=Branch_CD, [Branch]=IsNull((Select tradername From Risk.dbo.Branch Where sbtag = Branch_cd),''--''), '  
    Set @GroupBy = ' branch_cd '  
    Set @OrderBy = ' branch_cd '  
   End  
  Else  
   If @Sub_Broker = ''  
    Begin  
     Set @Select = ' [Sub Broker]=Sub_broker, '  
     Set @GroupBy = ' Sub_broker '  
     Set @OrderBy = ' Sub_broker '  
    End  
   Else  
    Begin  
     Set @Select = ' [Party Code]=Party_Code, '  
     Set @GroupBy = ' Party_Code '  
     Set @OrderBy = ' Party_Code '  
    End  
    
End  
  
Else If @Console = 'Clientwise'  
Begin  
 If @IsSegmentWise <> '1'  
  Begin  
   Set @Select = ' [Party Code]=Party_Code,[Party Name]=RTrim(Party_name), '  
   Set @GroupBy = ' Party_Code, Party_name '  
   Set @OrderBy = ' Party_name '  
  End  
 Else  
  Begin  
   Set @Select = '  [Party Code]=Party_Code,[Party Name]=RTrim(Party_name),[Sub Broker]=Sub_broker, [Branch Code]=branch_cd, '  
   Set @GroupBy = ' Party_Code, Party_name, Sub_broker, branch_cd '  
   Set @OrderBy = ' Party_name '  
  End  
End  
Else If @Console ='Datewise'  
Begin  
 Begin  
  Set @Select = ' [Sauda Date]=Convert(Varchar,Sauda_Date,103), '  
   Set @GroupBy = ' Sauda_Date '  
   Set @OrderBy = ' Sauda_Date '  
 End  
End  
Else If @Console ='Terminalwise'  
Begin  
  Set @Select = ' [Terminal ID]=Terminal_ID, '  
  Set @GroupBy = ' Terminal_ID '  
  Set @OrderBy = ' Terminal_ID '  
End  
  
  
If @IsSegmentWise = '1'  
 Begin  
  Set @Select = @Select + ' [Exchange Segment] = ExchangeSegment, '  
  Set @GroupBy =  @GroupBy + ' , ExchangeSegment '  
 End  
  
Set @From =' Level1Mis '  
  
Set @Where = ' sauda_date >= ''' + @FromDate + ''' and sauda_date < ''' + @ToDate + ''''  
  
If @Branch_cd <> ''  
 Set @Where = @Where + ' And Branch_cd = ''' + @Branch_cd + ''''  
If @Sub_Broker <> ''  
 Set @Where = @Where + ' And Sub_Broker = ''' + @Sub_Broker + ''''  
If @Party_Code <> ''  
 Set @Where = @Where + ' And Party_Code = ''' + @Party_Code + ''''  
If @Family <> ''  
 Set @Where = @Where + ' And Family = ''' + @Family + ''''  
If @Year <> ''  
 Set @Where = @Where + ' And Datepart(Year,Sauda_Date) = ' + @Year  
If @Month_NO <> ''  
 Set @Where = @Where + ' And Datepart(Month,Sauda_Date) = ' + @Month_NO  
If @Terminal_ID <> ''  
 Set @Where = @Where + ' And Terminal_ID = ' + @Terminal_ID  

Declare @Sel1 Varchar(500)  
Declare @Wh1 Varchar(500)  

Set @Sel1 = ' Volume=Sum(TP+DP+TS+DS), TurnOver=Sum(TPA+DPA+TSA+DSA), Brokerage=Sum(TPB+DSB+TSB+DPB) '  
Set @Wh1 = ' and Terminal_ID in (Select a.terminal_id collate SQL_Latin1_General_CP1_CI_AS from tblterminals a) '  

Set @From = ' From ' + @From  
Set @Where = ' Where ' + @Where  
Set @GroupBy = ' Group By ' + @GroupBy  

Declare @SelTot varchar(1000)
If @Top = '0' Or @Top=''
	Set @SelTot = ' Select ' + @Sel1
Else
	Set @SelTot = ' Select TOP ' + @Top + @Sel1

/*
	CALCULATE TOTAL
*/
--------------------- FROM HERE -------------------------------
Declare @TOTVOLUME AS money, @TOTTURNOVER AS money, @TOTBROKERAGE AS money

Create Table #TotalAll (TotVolume  money, TotTurnOver  money, TotBrokerage  money )
Insert #TotalAll
Exec (  @SelTot + @From + @Where + @Wh1 ) 
select @TotVolume=convert(money,TotVolume) ,@TotTurnOver=convert(money,TotTurnOver),@TotBrokerage=convert(money,TotBrokerage) from  #TotalAll
Drop Table #TotalAll

/*Print(@SelTot + @From + @Where + @Wh1)
Select @TotVolume
Select @TotTurnOver
Select @TotBrokerage*/

Declare @strTotVolume Varchar(25), @strTotTurnOver Varchar(25), @strTotBrokerage varchar(25)

select @strTotVolume = cast(@TotVolume as varchar)
select @strTotTurnOver = cast(@TotTurnOver as varchar)
select @strTotBrokerage = cast(@TotBrokerage as varchar)


If ( @strTotVolume = '' Or @strTotVolume = '0' Or @strTotVolume Is Null  ) 
begin
	set @strTotVolume = 1
end

if  ( @strTotTurnOver = '' Or @strTotTurnOver = '0' Or @strTotTurnOver Is Null )
begin	
	set @strTotTurnOver = 1
end

if ( @strTotBrokerage = '' Or @strTotBrokerage = '0' Or @strTotBrokerage Is Null )
begin
	set @strTotBrokerage = 1
end

---------------------------- TO HERE ------------------------------


Set @Sel1 = ' Volume=Sum(TP+DP+TS+DS), [Volume %]=(Sum(TP+DP+TS+DS)/ ' + @strTotVolume + ')*100, TurnOver=Sum(TPA+DPA+TSA+DSA), [TurnOver %]=(Sum(TPA+DPA+TSA+DSA)/' + @strTotTurnOver + ')*100,  Brokerage=Sum(TPB+DSB+TSB+DPB), [Brokerage %]=(Sum(TPB+DSB+TSB+DPB)/' + @strTotBrokerage + ')*100 '

If @Top = '0' Or @Top=''  
 Set @Select = ' Select ' + @Select  
Else  
 Set @Select = ' Select Top ' + @Top + @Select

If @Order <> ''  
 Set @OrderBy = ' Order By ' + @Order  
Else  
 Set @OrderBy = ' Order By ' + @OrderBy  

Print ( @Select + @Sel1 + @From + @Where + @Wh1 + @GroupBy + @OrderBy )  
Exec ( @Select + @Sel1 + @From + @Where + @Wh1 + @GroupBy + @OrderBy )

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcRemisier
-- --------------------------------------------------
CREATE Procedure prcRemisier
(

	@fromdate varchar(40)='',
	@todate varchar(40)='',
	@year varchar(4)='',
	@month varchar(2)='',
	@ExhangeSegment varchar(50)= '',
	@branch_code varchar(20)='',
	@subbroker varchar(20)='',
	@partycode varchar(20)='',
	@IsSegmentWise varchar(1)='0',
	@top varchar(3)='0',
	@order varchar(50)=''
)

As

/*
	Created By : Hemant Chandurkar
	Date		 : 20 Jun 2005

	Run As :
	EXEC prcRemisier '1 Jan 2005', '31 Mar 2005'
	EXEC prcRemisier '1 Jan 2005', '31 Mar 2005','','','','HO'
	EXEC prcRemisier '1 Jan 2005', '31 Mar 2005','','','','XPU','XPU'
	EXEC prcRemisier '1 Jan 2005', '31 Mar 2005','','','','XPU','XPU','','1'
	EXEC prcRemisier '1 Jan 2005', '31 Mar 2005','','','','XPU','XPU','','1','1'
*/

Begin

Declare @select varchar(8000)
Declare @from varchar(2000)
Declare @where varchar(2000)
Declare @groupby varchar(1000)
Declare @orderby varchar(1000)

Set @Select = ' Select '
If @Top <> '0'
	Set @Select = @Select + ' Top ' + @Top + ' '

If @branch_code = '' And @subbroker = '' /*First O/P  - Branchwise*/
	Set @Select = @Select + ' [Branch Code] = Branch, [Branch] = br.tradername, '
Else If  @subbroker = '' /* Branch code Supplied - Subbrokerwise */
	Set @Select = @Select + ' [Subbroker Code]=rem.subbrokcode, [Subbroker Name] = sb.SBName, '
Else /* Subbroker code Supplied - Partywise */
	Set @Select = @Select + ' [Party Code]=rem.Party_Code, '


If @IsSegmentWise = '1'
	Set @Select = @Select + ' [Exchange Segment]=Bsedb_ab.dbo.GetExchangeSegment(Coname), '

Set @Select = @Select + ' [Total Brokerage]=IsNull(Sum(ActBrok),0), [Remisier] = IsNull(Sum(Rembrok),0), '
Set @Select = @Select + ' [Remisier % To Brokerage]=(Sum(Rembrok)/(Case When Sum(ActBrok)=0 Then 1 Else Sum(ActBrok) End))*100 '

Set @from = ' From Mis.Remisior.Dbo.Angelremcalc rem, Intranet.Risk.DBO.Branch br, Intranet.Risk.Dbo.Subgroup	sb '

Set @where = ' Where /*exceptclient = ''No'' And*/ sauda_date>= Cast (''' + @fromdate + ''' As DateTime) ' +
		   ' And sauda_date < Cast(''' + @todate + ''' As DateTime) ' +
		   ' And branch = br.sbtag And sb.sub_broker = rem.subbrokcode '

If @branch_code <> ''
	Set @where = @where + ' And rem.branch = ''' + @branch_code + ''' '

If @subbroker <> ''
	Set @where = @where + ' And rem.subbrokcode = ''' + @subbroker + ''' '

If @partycode <> ''
	Set @where = @where + ' And rem.Party_Code = ''' + @partycode + ''' '

If @year <> ''
	Set @where = @where + ' And Year(rem.Sauda_date) = ' + @year + ' '

If @year <> '' And @month <> ''
	Set @where = @where + ' And Month(rem.Sauda_date) = ' + @month + ' '

Set @groupby = ' Group By '

If @branch_code = '' And @subbroker = ''
	Set @groupby =  @groupby + ' Branch, [Branch], br.tradername '
Else If @subbroker = ''
	Set @groupby =  @groupby + ' rem.subbrokcode, sb.SBName '
Else
	Set @groupby =  @groupby + ' rem.Party_Code '

If @IsSegmentWise = '1'
	Set @groupby = @groupby + ' ,Coname'

If @order = ''
	Set @order = ' 1 '
Set @orderby = ' Order by ' + @order

Exec (@select + @from + @where + @groupby + @orderby)
Print (@select + @from + @where + @groupby + @orderby)

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryAuctionAlert
-- --------------------------------------------------

CREATE Procedure [dbo].[prcSummaryAuctionAlert](@StatusID Varchar(20), @StatusName Varchar(20), @ReportDate Varchar(20))

As

-- Run As :
/*

	EXEC prcAuctionAlert 'Branch', 'XPU', 'JUN  2 2005'
	EXEC prcAuctionAlert 'Client', 'BH14', 'MAY  31 2005'
	EXEC prcAuctionAlert 'Subbroker', 'BBV', 'JUN  2 2005'
*/

Begin

	Set @StatusID = RTrim(LTrim(Upper(@StatusID)))
	Set @StatusName = RTrim(LTrim(Upper(@StatusName)))

	/* NSE */
	Select party_code
	From AngelNseCM.msajag.dbo.accbill, AngelNseCM.msajag.dbo.client1
	Where party_code=cl_code and sett_type Like 'A%' And Amount > 0
	and branch_cd like (Case When @StatusID='BRANCH' THEN @StatusName Else '%' End)
	and sub_broker like (Case When @StatusID='SUBBROKER' THEN @StatusName Else '%' End)
	and family like (Case When @StatusID='FAMILY' THEN @StatusName Else '%' End)
	and party_Code like (Case When @StatusID='CLIENT' THEN @StatusName Else '%' End)
	And Start_Date = Cast(@ReportDate as DateTime)
	Group by party_code

	UNION ALL

	/* BSE */
	SELECT  party_code
	From AngelBSECM.bsedb_ab.dbo.accbill, AngelBSECM.bsedb_ab.dbo.client1
	Where party_code=cl_code And sett_type Like 'A%' And Amount > 0 
	and branch_cd like (Case When @StatusID='BRANCH' THEN @StatusName Else '%' End)
	and sub_broker like (Case When @StatusID='SUBBROKER' THEN @StatusName Else '%' End)
	and family like (Case When @StatusID='FAMILY' THEN @StatusName Else '%' End)
	and party_Code like (Case When @StatusID='CLIENT' THEN @StatusName Else '%' End)
	And Start_Date = Cast(@ReportDate as DateTime)
	Group By party_Code

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryBillAmount
-- --------------------------------------------------

CREATE Procedure [dbo].[prcSummaryBillAmount](@StatusID varchar(20), @Statusname varchar(20))
As
Begin
	
/*
	Created By : Hemant Chandurkar
	Date		 : 13 Jun 2005
	
	Run As :
		Exec prcSummaryBillAmount 'Client', 'bh14'
		Exec prcSummaryBillAmount 'branch', 'xpu'
*/

	Select * Into #tmpBSECM_D From
	( 
		Select ExchangeSegment='BSECM', Sett_Type='D', Party_Code, [Amount]= Sum(Case Sell_Buy When 1 Then Amount Else Amount*-1 End),
			Bill_Date = Max(Start_Date), Sett_No = Max(sett_no)
		From AngelBSECM.bsedb_ab.dbo.accbill bill, AngelBSECM.bsedb_ab.dbo.client1
		Where
			party_code = cl_code And
			sett_type = 'D' And
			sett_no = (Select Max(sett_no) from AngelBSECM.bsedb_ab.dbo.accbill a Where sett_type = 'D' And a.party_code = bill.party_code) And
			party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) AND
			branch_cd LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND 
			sub_broker LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND 
			trader LIKE (Case When @StatusID = 'TRADER' Then @StatusName Else '%' End) AND 
			family LIKE (Case When @StatusID = 'FAMILY' Then @StatusName Else '%' End)
		Group By Party_Code
	)BSECM_D


	Select ExchangeSegment='NSECM', Sett_Type='', Party_Code, [Amount]= Sum(Case Sell_Buy When 1 Then Amount Else Amount*-1 End),
			Bill_Date = Max(Start_Date), Sett_No = Max(sett_no)
	From AngelNseCM.msajag.dbo.accbill fo, AngelNseCM.msajag.dbo.client1
	Where
		party_code = cl_code And
		sett_type = 'N' And
		sett_no = (Select Max(sett_no) from AngelNseCM.msajag.dbo.accbill a Where sett_type = 'N' And a.party_code = fo.party_code) And
		party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) AND
		branch_cd LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND 
		sub_broker LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND 
		trader LIKE (Case When @StatusID = 'TRADER' Then @StatusName Else '%' End) AND 
		family LIKE (Case When @StatusID = 'FAMILY' Then @StatusName Else '%' End)
	Group By Party_Code
	
	UNION ALL
	
	 -- NSE-FO 
	Select ExchangeSegment='NSEFO', Sett_Type='', Party_Code, [Amount]=Sum((Case Sell_Buy When 1 Then Amount*-1 Else Amount End)),
			Bill_Date = Max(Start_Date), Sett_No = Max(sett_no)
	From angelfo.nsefo.dbo.foaccbill bill, angelfo.nsefo.dbo.client1
	Where
		Start_date = (Select MAX(Start_date) From angelfo.nsefo.dbo.foaccbill a where a.party_code=bill.Party_Code) And 
		party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) AND
		branch_cd LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND 
		sub_broker LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND 
		trader LIKE (Case When @StatusID = 'TRADER' Then @StatusName Else '%' End) AND 
		family LIKE (Case When @StatusID = 'FAMILY' Then @StatusName Else '%' End) AND
		Cl_code = Party_Code
	Group by Party_Code
	Union All
	Select * from #tmpBSECM_D
	Union All
	Select * from 
	(
		Select ExchangeSegment='BSECM', Sett_Type='C', Party_Code, [Amount]= Sum(Case Sell_Buy When 1 Then Amount Else Amount*-1 End),
				Bill_Date = Max(Start_Date), Sett_No = Max(sett_no)
		From AngelBSECM.bsedb_ab.dbo.accbill bill, AngelBSECM.bsedb_ab.dbo.client1
		Where
			party_code = cl_code And
			sett_type = 'C' And
			sett_no = (Select Max(sett_no) from AngelBSECM.bsedb_ab.dbo.accbill a Where sett_type = 'C' And a.party_code = bill.party_code) And
			party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) AND
			branch_cd LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND 
			sub_broker LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND 
			trader LIKE (Case When @StatusID = 'TRADER' Then @StatusName Else '%' End) AND 
			family LIKE (Case When @StatusID = 'FAMILY' Then @StatusName Else '%' End)
		Group By Party_Code
	)C
	Where C.Party_Code Not In (Select Party_Code from #tmpBSECM_D)

	Drop Table #tmpBSECM_D
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryBrokerage
-- --------------------------------------------------
CREATE Procedure prcSummaryBrokerage(@StatusID varchar(20),@StatusName varchar(20), @ReportDate Varchar(50))
As
Begin
	
/*
	EXEC prcSummaryBrokerage 'Client', 'BH14','1 Jun 2005 '
	EXEC prcSummaryBrokerage 'Branch', 'HO','1 Jun 2005 '
	EXEC prcSummaryBrokerage 'subbroker', 'BBV','7 Jun 2005 '
*/
	
	Select Party_Code,
		[ABLCM]=Sum(Case When coname = 'ABLCM' Then actBrok Else 0 End),
		[ACDLCM]=Sum(Case When coname = 'ACDLCM' Then actBrok Else 0 End),
		[ACDLFO]=Sum(Case When coname = 'ACDLFO' Then actBrok Else 0 End),
		[ACPLMCX]=Sum(Case When coname = 'ACPLMCX' Then actBrok Else 0 End),
		[ACPLNCDX]=Sum(Case When coname = 'ACPLNCDX' Then actBrok Else 0 End),
		[TotalBrok]=IsNull(Sum(actBrok),0)
	From mis.remisior.dbo.angelremcalc
	Where
		party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) AND
		branch LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND
		subbrokcode LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND
		Sauda_date = Cast(@ReportDate as DateTime)
	Group By Party_Code
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryCheque
-- --------------------------------------------------

CREATE Procedure [dbo].[prcSummaryCheque](@StatusID varchar(25),@StatusName varchar(25))
As

Begin

	Select [ExchangeSegment] = 'BSECM', cltcode,[ChqDate]=Max(vdt), [Amount]=Sum(Case When Upper(DrCr)='C' Then vamt Else vamt*-1 End)
	From AngelBSECM.account_ab.dbo.ledger led, AngelBSECM.bsedb_ab.dbo.client1
	where
	vdt = (select Max(Vdt) from AngelBSECM.account_ab.dbo.ledger a where a.cltcode = led.cltcode and vtyp in(2,3))
	and cltcode=cl_code
	And cltcode LIKE (Case When @StatusID='CLIENT' Then @StatusName Else '%' End)
	And branch_cd LIKE (Case When @StatusID='BRANCH' Then @StatusName Else '%' End)
	And Family Like (Case When @StatusID='FAMILY' Then @StatusName Else '%' End)
	And Sub_Broker Like (Case When @StatusID='SUBBROKER' Then @StatusName Else '%' End)
	Group By cltcode

	UNION ALL

	Select [ExchangeSegment] = 'NSECM', cltcode,[ChqDate]=Max(vdt), [Amount]=Sum(Case When Upper(DrCr)='C' Then vamt Else vamt*-1 End)
	From AngelNseCM.inhouse.dbo.ledger led, AngelNseCM.msajag.dbo.client1
	where
	vdt = (select Max(Vdt) from AngelNseCM.inhouse.dbo.ledger a where a.cltcode = led.cltcode and vtyp in(2,3))
	and cltcode=cl_code
	And cltcode LIKE (Case When @StatusID='CLIENT' Then @StatusName Else '%' End)
	And branch_cd LIKE (Case When @StatusID='BRANCH' Then @StatusName Else '%' End)
	And Family Like (Case When @StatusID='FAMILY' Then @StatusName Else '%' End)
	And Sub_Broker Like (Case When @StatusID='SUBBROKER' Then @StatusName Else '%' End)
	Group By cltcode

	UNION ALL

	Select [ExchangeSegment] = 'NSEFO', cltcode,[ChqDate]=Max(vdt), [Amount]=Sum(Case When Upper(DrCr)='C' Then vamt Else vamt*-1 End)
	From angelfo.inhouse.dbo.ledger led, angelfo.nsefo.dbo.client1
	where
	vdt = (select Max(Vdt) from angelfo.inhouse.dbo.ledger a where a.cltcode = led.cltcode and vtyp in(2,3))
	and cltcode=cl_code
	And cltcode LIKE (Case When @StatusID='CLIENT' Then @StatusName Else '%' End)
	And branch_cd LIKE (Case When @StatusID='BRANCH' Then @StatusName Else '%' End)
	And Family Like (Case When @StatusID='FAMILY' Then @StatusName Else '%' End)
	And Sub_Broker Like (Case When @StatusID='SUBBROKER' Then @StatusName Else '%' End)
	Group By cltcode

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryLedgerCash
-- --------------------------------------------------

CREATE Procedure [dbo].[prcSummaryLedgerCash](@StatusID Varchar(20),@StatusName Varchar(20), @ReportName Varchar(15)='Ledger')
As
Begin

/*
	Run As :
		EXEC prcSummaryLedgerCash 'BRANCH','xpu'
		EXEC prcSummaryLedgerCash 'BRANCH','xpu','CASH'

		EXEC prcSummaryLedgerCash 'FAMILY','S2541'
		EXEC prcSummaryLedgerCash 'FAMILY','S2541', 'CASH'
*/

Set @StatusID = Upper(RTrim(LTrim(@StatusID)))
Set @StatusName = Upper(RTrim(LTrim(@StatusName)))
Set @ReportName = Upper(RTrim(LTrim(@ReportName)))

Declare @tmp varchar(3)

	If @ReportName = 'CASH'
		Begin
			Set @tmp = '30'
		End
	Else
		Set @tmp = ''
	
	Declare @FromDate Varchar(50)
	Declare @ToDate DateTime
	
	Set @FromDate = 'APR 1 '
	Set @ToDate = GetDate()
	
	If DatePart(Month,@ToDate)<= 3
		Set @FromDate = @FromDate + Cast((DatePart(Year,GetDate())-1) as varchar)
	Else
		Set @FromDate = @FromDate + Cast(DatePart(Year,GetDate()) as varchar)
	
		Set @FromDate = @FromDate + ' 00:00 '
	
	/* BSECM Ledger Amount */
	Select ExchangeSegment='BSECM',cltcode,[Amount]=IsNull(sum(case when drcr = 'd' then vamt else vamt*-1 end),0)		from AngelBSECM.account_ab.dbo.ledger led, AngelBSECM.bsedb_ab.dbo.client1
		where vdt >= @FromDate  and vdt <=  @ToDate
	And vamt <> 0
	And cltcode=cl_code
	And cltcode LIKE @tmp + (Case When @StatusID='CLIENT' Then @StatusName Else '%' End)
	And branch_cd LIKE (Case When @StatusID='BRANCH' Then @StatusName Else '%' End)
	And Family Like (Case When @StatusID='FAMILY' Then @StatusName Else '%' End)
	And Sub_Broker Like (Case When @StatusID='SUBBROKER' Then @StatusName Else '%' End)
		Group By cltcode
	Union All
	/* NSECM Ledger Amount */
	Select ExchangeSegment='NSECM',cltcode, [Amount]=IsNull(sum(case when drcr = 'd' then vamt else vamt*-1 end),0)
	from AngelNseCM.inhouse.dbo.ledger led, AngelNseCM.msajag.dbo.client1 
	where vdt >= @FromDate  and vdt <=  @ToDate
		And vamt <> 0
	And cltcode=cl_code
	And cltcode LIKE @tmp + (Case When @StatusID='CLIENT' Then @StatusName Else '%' End)
	And branch_cd LIKE (Case When @StatusID='BRANCH' Then @StatusName Else '%' End)
	And Family Like (Case When @StatusID='FAMILY' Then @StatusName Else '%' End)
	And Sub_Broker Like (Case When @StatusID='SUBBROKER' Then @StatusName Else '%' End)
		Group By cltcode
	Union All
	/* NSEFO Ledger Amount */
	select ExchangeSegment='NSEFO',cltcode, [Amount]=IsNull(sum(case when drcr = 'd' then vamt else vamt*-1 end),0)
	from angelfo.inhouse.dbo.ledger led, angelfo.nsefo.dbo.client1
	where vdt >= @FromDate  and vdt <=  @ToDate
	And vamt <> 0
	And cltcode=cl_code
	And cltcode LIKE @tmp + (Case When @StatusID='CLIENT' Then @StatusName Else '%' End)
	And branch_cd LIKE (Case When @StatusID='BRANCH' Then @StatusName Else '%' End)
	And Family Like (Case When @StatusID='FAMILY' Then @StatusName Else '%' End)
	And Sub_Broker Like (Case When @StatusID='SUBBROKER' Then @StatusName Else '%' End)
		Group By cltcode

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryMargin
-- --------------------------------------------------
CREATE Procedure prcSummaryMargin(@StatusID varchar(20),@StatusName varchar(20))
As

/*
	Run As :--
		prcSummaryMargin 'Client', 'BH14'
		prcSummaryMargin 'branch', 'ho'
*/

Begin

	select party_code, [ExchangeSegment]='NSEFO', Sum(IsNull((initialmargin + MTMMargin),0) ) as 'Margin'
		from angelfo.nsefo.dbo.tbl_clientmargin
		where
		branch_cd LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND 
		sub_broker LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND 
		trader LIKE (Case When @StatusID = 'TRADER' Then @StatusName Else '%' End) AND 
		family LIKE (Case When @StatusID = 'FAMILY' Then @StatusName Else '%' End) AND 
		party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) 
		and lst_update_dt = (Select max(lst_update_dt) from angelfo.nsefo.dbo.tbl_clientmargin a where a.party_code=Party_code)
	Group By Party_Code
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryNonCashColl
-- --------------------------------------------------
CREATE Procedure prcSummaryNonCashColl
(
	@StatusId varchar(20), 
	@Statusname Varchar(20), 
	@ReportDate varchar(50)
)
-- Security After Haircut FO
-- Run As :

-- EXEC prcSummaryNonCashColl 'Client', 'BH14', 'Jun  09 2005'
-- EXEC prcSummaryNonCashColl 'Branch', 'Xpu', 'Jun  10 2005'
-- EXEC prcSummaryNonCashColl 'subbroker', 'bbv', 'Jun  7 2005'
As
Begin

Set 	@StatusId = RTrim(LTrim(Upper(@StatusId)))
Set	@Statusname = RTrim(LTrim(Upper(@StatusName)))
Set	@ReportDate = RTrim(LTrim(Upper(@ReportDate)))


	Select ExchangeSegment='NSEFO', [Client_Code]=fo.party_code,
	[NonCashCollFO]=Isnull(noncash_coll,0)
	from 
	Angelfo.nsefo.dbo.tbl_clientmargin fo,
	Angelfo.nsefo.dbo.client1 c1 
	where
	margindate = Cast(@ReportDate as Datetime)
	and fo.Party_Code = c1.cl_code
	and ltrim(rtrim(c1.branch_cd)) Like (Case When @StatusId='BRANCH' THEN @StatusName ELSE '%' END)
	and ltrim(rtrim(fo.party_code)) Like (Case When @StatusId='CLIENT' THEN @StatusName ELSE '%' END)
	and ltrim(rtrim(c1.sub_broker)) Like (Case When @StatusId='SUBBROKER' THEN @StatusName ELSE '%' END)
	and ltrim(rtrim(c1.trader)) Like (Case When @StatusId='TRADER' THEN @StatusName ELSE '%' END)
	Order by fo.party_code


	Select [Client_Code]=e.pcode, [NonCashCollBSECM]=Sum(e.abl_holdc), [NonCashCollNSECM]=Sum(e.acdl_holdc)
	from risk.dbo.tbfin_Rep e, risk.dbo.finmast c left join ( select b.pcode,ageing=srno-1 from risk.dbo.calender a, 
		( select pcode, sdate=max(a.sauda_date) from risk.dbo.ageing a where pcode in 
		(select pcode from risk.dbo.ageing where abl_shortage > 0 and 
			sauda_date =(select max(sauda_date) from risk.dbo.calender)) and (abl_shortage <= 0 )
			group by a.pcode ) b where 
		a.sauda_Date=b.sDate ) d on d.pcode= c.party_Code where e.pcode=c.party_code  and e.sauda_Date=(select max(sauda_date) from risk.dbo.calender) 
		and abl_shortage > 0 
	and
		c.BRANCH LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND
		c.Party_Code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) AND
		c.Subgroup LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND
		c.family LIKE (Case When @StatusID = 'FAMILY' Then @StatusName Else '%' End) AND
		c.TRADERNAME LIKE (Case When @StatusID = 'TRADER' Then @StatusName Else '%' End)
	group by e.pcode

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryPLAmount
-- --------------------------------------------------

CREATE Procedure prcSummaryPLAmount
(
	@StatusID varchar(15),
	@StatusName varchar(15),
	@ReportDate varchar(50)
)

As
Begin

/*
	CREATED BY : HEMANT CHANDURKAR
	CONTACT : hemant@angelbroking.com
	DATE	: 07 JUNE 2005
	
	RUN AS :--
		prcSummaryPLAmount 'branch','xpu', 'Jun 2 2005 '
		prcSummaryPLAmount 'client','bh14', 'Jun 2 2005 '
*/

Set @StatusID = Upper(RTrim(LTrim(@StatusID)))
Set @StatusName = Upper(RTrim(LTrim(@StatusName)))
Set @ReportDate = Upper(RTrim(LTrim(@ReportDate)))

SELECT party_code,[P&L Amount]=Sum(SBillAmt - PBillAmt + PBrokAmt + SBrokAmt)
FROM angelfo.nsefo.dbo.FoBillValan 
WHERE
inst_type LIKE '%%' AND option_type LIKE '%' AND Left(Convert(VarChar,expirydate,109),11) LIKE '%' AND 
symbol LIKE '%' AND AuctionPart Like '%' AND 
sauda_date >= @ReportDate AND sauda_date <= @ReportDate + ' 23:59' And

region LIKE (Case When @StatusID = 'REGION' Then @StatusName Else '%' End) AND 
branch_code LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND 
sub_broker LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND 
trader LIKE (Case When @StatusID = 'TRADER' Then @StatusName Else '%' End) AND 
family LIKE (Case When @StatusID = 'FAMILY' Then @StatusName Else '%' End) AND 
party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) 
GROUP BY 
party_code 
ORDER BY 
party_code

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryRemisier
-- --------------------------------------------------
CREATE Procedure prcSummaryRemisier(@StatusID varchar(20),@StatusName varchar(20), @ReportDate Varchar(50))
As
Begin
	
/*
	EXEC prcSummaryRemisier 'Client', 'BH14','1 Jun 2005 '
	EXEC prcSummaryRemisier 'Branch', 'HO','1 Jun 2005 '
	EXEC prcSummaryRemisier 'Subbroker', 'BBV','8 Jun 2005 '
*/
	
	Select Party_Code,
		[ABLCM]=Sum(Case When coname = 'ABLCM' Then remBrok Else 0 End),
		[ACDLCM]=Sum(Case When coname = 'ACDLCM' Then remBrok Else 0 End),
		[ACDLFO]=Sum(Case When coname = 'ACDLFO' Then remBrok Else 0 End),
		[ACPLMCX]=Sum(Case When coname = 'ACPLMCX' Then remBrok Else 0 End),
		[ACPLNCDX]=Sum(Case When coname = 'ACPLNCDX' Then remBrok Else 0 End),
		[TotalRemisier]=IsNull(Sum(remBrok),0)
	From mis.remisior.dbo.angelremcalc
	Where
		party_code LIKE (Case When @StatusID = 'CLIENT' Then @StatusName Else '%' End) AND
		branch LIKE (Case When @StatusID = 'BRANCH' Then @StatusName Else '%' End) AND
		subbrokcode LIKE (Case When @StatusID = 'SUBBROKER' Then @StatusName Else '%' End) AND
		Sauda_date = Cast(@ReportDate as DateTime)
	Group By Party_Code
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prcSummaryRiskHoldings
-- --------------------------------------------------
CREATE Procedure prcSummaryRiskHoldings(@StatusID varchar(20), @StatusName varchar(20))
AS

/*
	Created By : Hemant
	Date : 20 Jun 2005

	Run As : 
	EXEC prcSummaryRiskHoldings 'BRANCH', 'XPU'
	EXEC prcSummaryRiskHoldings 'SUBBROKER', 'BBV'
	EXEC prcSummaryRiskHoldings 'CLIENT', 'BH14'
*/

BEGIN
	SET @StatusID = RTrim(LTrim(Upper(@StatusID)))
	SET @StatusName = RTrim(LTrim(Upper(@StatusName)))
	
	Select [Party_Code] = a.Party_code, /*[LedgerDrCr]=sum(a.Ledger_DrCr),*/ [Hold_Value] = sum(a.Hold_Value),
	(sum(a.A_Pool) + sum(a.A_Ben)) as Approved, (sum(a.NA_Pool) + sum(a.NA_Ben)) as Non_Approved
	from risk.dbo.finrep a, risk.dbo.finmast c
	where a.party_code=c.party_Code
	
	AND C.BRANCH LIKE (CASE WHEN @StatusID='BRANCH' THEN @StatusName ELSE '%' END)
	AND C.SUBGROUP LIKE (CASE WHEN @StatusID='SUBBROKER' Then @StatusName ELSE '%' END)
	AND C.PARTY_CODE LIKE (CASE WHEN @StatusID='CLIENT' Then @StatusName ELSE '%' END)
	AND C.TRADERNAME LIKE (CASE WHEN @StatusID='TRADER' Then @StatusName ELSE '%' END)
	AND C.FAMILY LIKE (CASE WHEN @StatusID='FAMILY' Then @StatusName ELSE '%' END)
	Group By a.party_code 
	Order By a.PARTY_CODE
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_ARPCCLIENT
-- --------------------------------------------------
CREATE PROC PROC_ARPCCLIENT 

@SAUDA_DATE DATETIME 
AS
--IF EXISTS(SELECT SAUDADATE FROM ARPCCLIENT WHERE SAUDADATE=@SAUDA_DATE)
---EXEC PROC_ARPCCLIENT 'MAY 10 2012'

BEGIN

DELETE FROM ARPCCLIENT WHERE SAUDADATE=@SAUDA_DATE


SELECT DISTINCT PARTY_CODE
      INTO #PARTY_LIST
FROM MIS_TO WITH(NOLOCK)
WHERE SAUDA_DATE= @SAUDA_DATE
 
--DROP TABLE #SAUDA_DATE_LIST
 
SELECT SAUDA_DATE,party_code,SUM(brokerage) AS brokerage
      INTO #SAUDA_DATE_LIST
FROM MIS_TO WITH(NOLOCK)
WHERE SAUDA_DATE>=@SAUDA_DATE-90 AND SAUDA_DATE<@SAUDA_DATE
GROUP BY SAUDA_DATE,party_code
 

INSERT INTO ARPCCLIENT 
SELECT PARTY_CODE,@SAUDA_DATE AS SAUDADATE, 
       SUM(BROKERAGE)                  AS BROKERAGE,
       COUNT(SAUDA_DATE)                  AS NO_OF_TRADED_DAYS,
       SUM(BROKERAGE) / COUNT(SAUDA_DATE) AS ARPC
FROM   #SAUDA_DATE_LIST
GROUP  BY PARTY_CODE 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ProcessPmsdata
-- --------------------------------------------------
CREATE procedure ProcessPmsdata As
Declare
@@Cont Cursor,
@@CNo Cursor,
@@Party_code As varchar(15),
@@Scrip_cd As Varchar(10),
@@Series As Varchar(3),
@@Sauda_date As Datetime,
@@Pqty As Int,
@@Sqty As Int,
@@PavgRate As Money,
@@SAvgRate As Money,
@@Samt As Money,
@@SaleSauda_date As DateTime

Begin
	Set @@Cont = Cursor For
	Select Distinct Party_code,Sauda_date,Scrip_cd,Series,Pqty = (PqtyTrd + PqtyDel),PavgRate   = ( (PAmtTrd + PamtDel)/(PqtyTrd + PqtyDel) ) from Rmbillvalan
	Where CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0  and party_code = 'AN77'  
	Order By Sauda_date Asc,Scrip_Cd Asc,Series Asc
	Open @@Cont
	Fetch Next from @@Cont into @@Party_code,@@Sauda_date,@@Scrip_Cd,@@Series,@@Pqty,@@PavgRate
	While @@Fetch_Status = 0 
	Begin
  	        --Print @@Party_code +'  ' + Cast(@@Sauda_date As Varchar(11)) + '   ' + @@Scrip_Cd + '   ' + @@Series +'  Pqty = ' + Str(@@Pqty)  

		Set @@CNo = Cursor For
                Select Sauda_date,Sqty = (SqtyTrd + SqtyDel),SAmt = (SAmtTrd + SamtDel) ,SavgRate   = ( (SAmtTrd + SAmtDel)/(SQtyTrd + SQtyDel) ) from Rmbillvalan
		Where CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	        And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                     And Sauda_date >= @@Sauda_Date
                     /* Above condition forces the cursor to access records after the first buy transaction */
    	        Order By Sauda_date Asc,Scrip_Cd Asc,Series Asc
   	        Open @@CNo
	        Fetch Next from @@CNo into @@SaleSauda_date,@@Sqty,@@Samt,@@SavgRate
 
                Print 'Going Into Cursor '
                While @@Fetch_Status = 0 
	        Begin
	             Print @@Party_code + '  ' + @@Scrip_Cd + '  ' + @@Series + '  ' + Cast(@@Sauda_date As Varchar(11))+ '  ' +Str(@@PQty) + '  ' + Cast(@@SaleSauda_date As Varchar(11))+ '  ' +Str(@@Sqty)
                         If @@Pqty = @@Sqty
                         Begin
                                  Print 'Pqty = Sqty'
                                  Update Rmbillvalan Set SAmtDel = @@Samt , SQtyDel = @@Sqty ,SqOffDate = @@SaleSauda_date , Cf = 'N'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@Sauda_date

                                  Update Rmbillvalan Set  Cf = 'N' ,Valid = 'N'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@SaleSauda_date
                         
                         End
                         
                         If @@Pqty > @@Sqty
                         Begin
                                  Print 'Pqty > Sqty'

                                  /* Here We need to add a Purchase record = Pqty - Sqty */

                                  Update Rmbillvalan Set PQtyTrd = 0 , PqtyDel =  @@Sqty , PamtTrd = 0 , PamtDel = @@Sqty * @@PavgRate , SAmtDel = @@Samt , SQtyDel = @@Sqty ,SqOffDate = @@SaleSauda_date , Cf = 'N'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@Sauda_date

                                  Update Rmbillvalan Set  SqtyDel = @@Sqty - @@Pqty , SamtDel = ((@@Sqty -@@Pqty) * @@SavgRate),  Cf = 'Y' ,Valid = 'Y'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@SaleSauda_date

                         End
   
                         If @@Pqty < @@Sqty
                         Begin
                                  Print 'Pqty < Sqty'

                                  Update Rmbillvalan Set  SAmtDel = (@@PQty) * @@SavgRate, SQtyDel = @@PQty ,SqOffDate = @@SaleSauda_date , Cf = 'N'
                                  Where
                                        CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                        And Sauda_Date = @@Sauda_date

                                  Update Rmbillvalan Set  SAmtDel = (@@Sqty - @@PQty) * @@SavgRate, SQtyDel = (@@Sqty - @@PQty) , Cf = 'Y' ,Valid = 'Y'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@SaleSauda_date
                         End

                         Fetch Next from @@CNo into @@Sauda_date,@@Sqty,@@Samt,@@SavgRate            
                End 
                Close @@Cno
                Deallocate @@Cno               
  	        Fetch Next from @@Cont into @@Party_code,@@Sauda_date,@@Scrip_Cd,@@Series,@@Pqty,@@PavgRate
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ProcessPmsdata1
-- --------------------------------------------------
CREATE procedure ProcessPmsdata1 As
Declare
@@Cont Cursor,
@@CNo Cursor,
@@Party_code As varchar(15),
@@Scrip_cd As Varchar(10),
@@Series As Varchar(3),
@@Sauda_date As Datetime,
@@Pqty As Int,
@@Sqty As Int,
@@PavgRate As Money,
@@SAvgRate As Money,
@@sbrok as money,
@@pbrok as money,
@@Samt As Money,
@@SaleSauda_date As DateTime

Begin
	Set @@Cont = Cursor For
	Select Distinct Party_code,Sauda_date,Scrip_cd,Series,Pqty = (PqtyTrd + PqtyDel),PavgRate   = ( (PAmtTrd + PamtDel)/(PqtyTrd + PqtyDel) ), pbrok = Pbrokdel from Rmbillvalan
	Where CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0  
             --and party_code = 'AN77'  
	Order By Sauda_date Asc,Scrip_Cd Asc,Series Asc
	Open @@Cont
	Fetch Next from @@Cont into @@Party_code,@@Sauda_date,@@Scrip_Cd,@@Series,@@Pqty,@@PavgRate,@@pbrok
	While @@Fetch_Status = 0 
	Begin
  	        --Print @@Party_code +'  ' + Cast(@@Sauda_date As Varchar(11)) + '   ' + @@Scrip_Cd + '   ' + @@Series +'  Pqty = ' + Str(@@Pqty)  

		Set @@CNo = Cursor For
                Select Sauda_date,Sqty = (SqtyTrd + SqtyDel),SAmt = (SAmtTrd + SamtDel) ,SavgRate   = ( (SAmtTrd + SAmtDel)/(SQtyTrd + SQtyDel) ), sbrok= sbrokdel from Rmbillvalan
		Where CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	        And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                     And Sauda_date >= @@Sauda_Date
                     /* Above condition forces the cursor to access records after the first buy transaction */
    	        Order By Sauda_date Asc,Scrip_Cd Asc,Series Asc
   	        Open @@CNo
	        Fetch Next from @@CNo into @@SaleSauda_date,@@Sqty,@@Samt,@@SavgRate,@@sbrok
 
                Print 'Going Into Cursor '
                While @@Fetch_Status = 0 
	        Begin
	             Print @@Party_code + '  ' + @@Scrip_Cd + '  ' + @@Series + '  ' + Cast(@@Sauda_date As Varchar(11))+ '  ' +Str(@@PQty) + '  ' + Cast(@@SaleSauda_date As Varchar(11))+ '  ' +Str(@@Sqty)
                         If @@Pqty = @@Sqty
                         Begin
                                  Print 'Pqty = Sqty'


                                  Update Rmbillvalan Set SAmtDel = @@Samt , SQtyDel = @@Sqty ,SqOffDate = @@SaleSauda_date , Cf = 'N'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@Sauda_date


                                  Update Rmbillvalan Set  Cf = 'N' ,Valid = 'N'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@SaleSauda_date
                         
                         End
                         
                         If @@Pqty > @@Sqty
                         Begin
                                  Print 'Pqty > Sqty'

                                  /* Here We need to add a Purchase record = Pqty - Sqty */

				---- Change in Buy Side

                                  select * into #Btemp from rmbillvalan Where
                                     CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0
                                     And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                     And Sauda_Date = @@Sauda_date


                                  Update Rmbillvalan Set PQtyTrd = 0 , PqtyDel =  @@Sqty , PamtTrd = 0 , PamtDel = @@Sqty * @@PavgRate , SAmtDel = @@Samt , SQtyDel = @@Sqty ,SqOffDate = @@SaleSauda_date , Cf = 'N',sbrokdel=@@sbrok
                                     Where CF = 'Y' and Valid = 'Y' and (PqtyTrd + PqtyDel) > 0
	                             And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                     And Sauda_Date = @@Sauda_date

				
				  update #btemp set pamtdel=(pamtdel/pqtydel)*( @@pqty-@@sqty), pqtydel = @@pqty-@@sqty,pbrokdel=0
				  insert into rmbillvalan select * from #btemp
				  drop table #btemp


				----- Changes in Sell Side

                                  --Update Rmbillvalan Set  SqtyDel = @@Sqty - @@Pqty , SamtDel = ((@@Sqty -@@Pqty) * @@SavgRate),  Cf = 'Y' ,Valid = 'Y'
                                  Update Rmbillvalan Set  Cf = 'N' ,Valid = 'N'
                                     Where CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	                             And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                     And Sauda_Date = @@SaleSauda_date

                         End
   
                         If @@Pqty < @@Sqty
                         Begin
                                  Print 'Pqty < Sqty'
				  print @@sqty
				  print @@pqty
				  print 'Entered Sell side ie greater then Buy side'


                                  select * into #Stemp from rmbillvalan Where
                                        CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                        And Sauda_Date = @@Sauda_date


                                  Update Rmbillvalan Set  SAmtDel = (@@PQty) * @@SavgRate, SQtyDel = @@PQty ,SqOffDate = @@SaleSauda_date , Cf = 'N'
                                  Where
                                        CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                        And Sauda_Date = @@Sauda_date

				  update #stemp set samtdel=(samtdel/sqtydel)*( @@sqty-@@pqty), sqtydel = @@sqty-@@pqty,sbrokdel=0
				  insert into rmbillvalan select * from #stemp
				  drop table #stemp


--                                  Update Rmbillvalan Set  SAmtDel = (@@Sqty - @@PQty) * @@SavgRate, SQtyDel = (@@Sqty - @@PQty) , Cf = 'Y' ,Valid = 'Y'
                                  Update Rmbillvalan Set  Cf = 'N' ,Valid = 'N'
                                  Where
                                             CF = 'Y' and Valid = 'Y' and (SqtyTrd + SqtyDel) > 0
	                                And Party_Code = @@Party_code And Scrip_cd = @@Scrip_Cd And Series = @@Series
                                             And Sauda_Date = @@SaleSauda_date

                         End

                         Fetch Next from @@CNo into @@Sauda_date,@@Sqty,@@Samt,@@SavgRate,@@sbrok
                End 
                Close @@Cno
                Deallocate @@Cno               
  	        Fetch Next from @@Cont into @@Party_code,@@Sauda_date,@@Scrip_Cd,@@Series,@@Pqty,@@PavgRate,@@pbrok
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ProcessTermId
-- --------------------------------------------------



CREATE PROCEDURE ProcessTermId (@Sett_no Varchar(10),@Sett_Type varchar(2),@TDate Varchar(11))
AS 
Declare 
 @@Flag cursor,
 @@loop cursor,
 @@ScripCursor Cursor,
 @@Party_code varchar(15), 
 @@Scrip_cd Varchar(20),
 @@Series Varchar(3),
 @@Participantcode Varchar(30),
 @@Turnover Money,
 @@Pqty Bigint,
 @@Sqty Bigint,
 @@Brokerage Money,
 @@ATurnover Money,
 @@APqty Bigint,
 @@ASqty Bigint,
 @@ABrokerage Money,
 @@Details Varchar(300),
 @@ADetails Varchar(300),
 @@ResultStr Varchar(1024)


drop table result 
 
Begin Transaction
set nocount on


Select @@Turnover = Sum(Tradeqty * Marketrate),
@@Pqty = Sum(Case When Sell_buy = 1 Then Tradeqty Else 0 End),
@@Sqty = Sum(Case When Sell_buy = 2 Then Tradeqty Else 0 End),
@@Brokerage = Sum(Brokapplied +Nbrokapp)
From Settlement where
Sett_no = @Sett_no
and
Sett_type = @Sett_type
and
Sauda_date like @Tdate +'%'


Set @@Flag = Cursor for
Select distinct A.party_code,Scrip_cd,Series,Participantcode from settlement S, Angeltermbrok A
Where
Sett_no = @Sett_no
and
Sett_type = @Sett_type
and
Sauda_date like @Tdate +'%'
and
A.Fromdate <= @Tdate
And
A.Todate >= @Tdate
and
s.party_code = A.party_code
Order by A.Party_code,Scrip_cd,Series,Participantcode

Open @@Flag
Fetch next from @@Flag into @@Party_code,@@Scrip_cd,@@Series,@@Participantcode

While ( (@@fetch_status = 0)  )
Begin
/*     Print @@Party_code
     Print @@Scrip_cd
     Print @@Series
     Print @@Participantcode
*/
     Select getdate() 
     Exec TBseRearrangeAfterContflag @Sett_Type,@@Party_code,@@Scrip_cd,@@Series,@TDate,'%',@@Participantcode 
     Exec TBBGSettBrokUpdatenew @@Party_code,@@Scrip_cd,@TDate,@Sett_type,@@Participantcode,'%'
     Exec TBseRearrangeAfterBillflag @Sett_no,@Sett_type,@@Party_code,@@Scrip_cd,'BSE','%',@@Participantcode
     Exec Tnewupdbilltaxafterbill @sett_no,@Sett_type,@@Party_code,@@Scrip_cd
     Exec BseRearrangeAfterContflag @Sett_Type,@@Party_code,@@Scrip_cd,@@Series,@TDate,'%',@@Participantcode 
     Exec BseRearrangeAfterBillflag @Sett_no,@Sett_type,@@Party_code,@@Scrip_cd,'BSE','%',@@Participantcode 
     Fetch next from @@Flag into @@Party_code,@@Scrip_cd,@@Series,@@Participantcode    
End

Close @@Flag
Deallocate @@Flag

Update settlement set status = 'E' from settlement S , AngelTermbrok A 
Where
Sett_no = @Sett_no
and
Sett_type = @Sett_type
and
Sauda_date like @Tdate +'%'
and
A.Fromdate <= @Tdate
And
A.Todate >= @Tdate
and s.Party_code = A.Party_code

Select @@ATurnover = Sum(Tradeqty * Marketrate),
@@APqty = Sum(Case When Sell_buy = 1 Then Tradeqty Else 0 End),
@@ASqty = Sum(Case When Sell_buy = 2 Then Tradeqty Else 0 End),
@@ABrokerage = Sum(Brokapplied +Nbrokapp)
From Settlement where
Sett_no = @Sett_no
and
Sett_type = @Sett_type
and
Sauda_date like @Tdate +'%'

If (@@Turnover = @@ATurnover) And (@@Pqty = @@APqty) And (@@Sqty = @@ASqty)
Begin
    Commit Transaction
    Select @@Details = ' Turnover =    ' + CAST ( @@Turnover AS VARCHAR(30) ) + '    PQty =    ' + CAST ( @@Pqty AS VARCHAR(15) ) + '    Sqty =     ' + CAST ( @@Sqty AS VARCHAR(15) ) + '    Brokerage =    ' +CAST ( @@Brokerage AS VARCHAR(15) )    
    Select @@ADetails = ' Turnover =    ' + CAST ( @@ATurnover AS VARCHAR(30) ) + '    PQty =    ' + CAST ( @@APqty AS VARCHAR(15) ) + '    Sqty =     ' + CAST ( @@ASqty AS VARCHAR(15) ) + '    Brokerage =    ' +CAST ( @@ABrokerage AS VARCHAR(15) )
    Select status = 'Transaction Completed figuers are '
    Select status = @@Details
    Select status = 'Transaction Completed figuers are <br>'+@@Adetails into result
End
Else
Begin
       RollBack Transaction
       Select status='Transaction Failed ' into result 
End


set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proCrossTabMulti
-- --------------------------------------------------
CREATE PROCEDURE proCrossTabMulti
	(
		@strSELECT NVARCHAR(750), -- 'SELECT A,B'
		@strFROM NVARCHAR(750), -- 'FROM atabletest INNERJOIN atbl1 ON atbl1.int1 = atabletest.int1'
		@strWHERE NVARCHAR(750), -- 'WHERE (((A <> ''A'') AND (A <>''B'')) OR (B = ''C''))'
		@strConvertField NVARCHAR(50),  -- Field name to put at top strGroupI  
		@strTotals NVARCHAR(6) = 'NONE',  -- Totals BOTTOM, RIGHT, BOTH, NONE, ALL
		@strFields NVARCHAR(250), --Fields to Calc int1,int1,int2
		@strFieldsAggregate NVARCHAR(250)  -- sum,avg,count  Aggregates for above @strFields number of arguments must match 
   	)
AS
	/************************************************************************************************
	*** Developed by Chad Bowen 8/15/01
	*** Executes a crosstab query that is similiar to Access PIVOT command
	*** Converts on multiple fields
	************************************************************************************************/

	DECLARE @strReturn NVARCHAR(75)
	DECLARE @strSQL NVARCHAR(4000)
	DECLARE @intPosition1 INTEGER
	DECLARE @intPosition2 INTEGER
	DECLARE @strValu1 NVARCHAR(75)
	DECLARE @strValu3 NVARCHAR(75)
	DECLARE @intPosition3 INTEGER
	DECLARE @intPosition4 INTEGER

	SELECT name from sysobjects where name = 'TopTable'
	IF @@ROWCOUNT > 0
	 BEGIN
		DROP TABLE TopTable
	 END
	CREATE TABLE TopTable
	    ( strTop NVARCHAR(75))

	SET @strSQL = 'INSERT INTO TopTable '
	SET @strSQL = @strSQL + 'SELECT DISTINCT ' + @strConvertField --  CAST(' + @strConvertField + ' as NVARCHAR)'
	SET @strSQL = @strSQL + ' ' +  @strFROM 
	SET @strSQL = @strSQL + ' ' +  @strWHERE
	PRINT @strSQL

	--INSERT INTO @TopTable 
	EXEC sp_executesql @strSQL
	
	SET @strSQL = ''
	SET @strSQL = @strSelect

	DECLARE intCursor CURSOR FOR
	SELECT * FROM topTable
	OPEN intCursor
	FETCH NEXT FROM intCursor INTO @strReturn
	WHILE @@FETCH_STATUS = 0
	 BEGIN
		SET @intPosition1 = 1
		SET @intPosition3 = 1
		SET @intPosition2 = LEN(@strFields)
		SET @intPosition4 = LEN(@strFieldsAggregate)
		WHILE @intPosition2 <> 0
		 BEGIN
  			SET @intPosition2 = CHARINDEX(',',@strFields,@intPosition1)
			SET @intPosition4 = CHARINDEX(',',@strFieldsAggregate,@intPosition3)
			IF @intPosition2 = 0
			 BEGIN
				SET @strValu1 = SUBSTRING(@strFields,@intPosition1,LEN(@strFields))
			 END
			ELSE
			 BEGIN
				SET @strValu1 = SUBSTRING(@strFields,@intPosition1,@intPosition2 - @intPosition1)
				IF @intPosition2 = LEN(@strFields)
				 BEGIN
					SET @intPosition2 = 0
				 END
			 END
			IF @intPosition4 = 0
			 BEGIN
				SET @strValu3 = SUBSTRING(@strFieldsAggregate,@intPosition3,LEN(@strFieldsAggregate))
			 END
			ELSE
			 BEGIN
				SET @strValu3 = SUBSTRING(@strFieldsAggregate,@intPosition3,@intPosition4 - @intPosition3)
				IF @intPosition3 = LEN(@strFieldsAggregate)
			 	 BEGIN
					SET @intPosition4 = 0
		 		 END
		 	END
			SET @intPosition3 = @intPosition4 + 1
			SET @intPosition1 = @intPosition2 + 1
			IF ((@intPosition2 = 0) AND (@intPosition4 <> 0)) OR ((@intPosition4 = 0) AND (@intPosition2<>0))
		 	 BEGIN
				PRINT 'CONFLICTING # of Arguments'
				RETURN
		 	 END
			SET @strReturn = LTRIM(RTRIM(@strReturn))
  			SET @strSQL = @strSQL + ',' + @strValu3 + '(CASE '
  			SET @strSQL = @strSQL + @strConvertField  + ' WHEN ' + CHAR(39) + @strReturn + CHAR(39)
		  	SET @strSQL = @strSQL + ' THEN ' + @strValu1 + ' ELSE NULL END) AS ['
			SET @strSQL = @strSQL + @strReturn + '-' + @strValu3 + '-' + @strValu1 + ']'
			IF LEN(@strSQL) >=3999
			 BEGIN
				PRINT 'SQL Was to long limited to 4000 Characters'
			 	PRINT @strSQL
				RETURN
			 END
		 END
		FETCH NEXT FROM intCursor into @strReturn
	 END
	CLOSE intCursor
	DEALLOCATE intCursor
	IF @strTotals = 'RIGHT' OR @strTotals = 'BOTH' OR @strTotals = 'ALL'
	 BEGIN
		SET @intPosition1 = 1
		SET @intPosition3 = 1
		SET @intPosition2 = LEN(@strFields)
		SET @intPosition4 = LEN(@strFieldsAggregate)
		WHILE @intPosition2 <> 0

		 BEGIN
  			SET @intPosition2 = CHARINDEX(',',@strFields,@intPosition1)
			SET @intPosition4 = CHARINDEX(',',@strFieldsAggregate,@intPosition3)
			IF @intPosition2 = 0
			 BEGIN
				SET @strValu1 = SUBSTRING(@strFields,@intPosition1,LEN(@strFields))
			 END
			ELSE
			 BEGIN
				SET @strValu1 = SUBSTRING(@strFields,@intPosition1,@intPosition2 - @intPosition1)
				IF @intPosition2 = LEN(@strFields)
				 BEGIN
					SET @intPosition2 = 0
				 END
			 END
			IF @intPosition4 = 0
			 BEGIN
				SET @strValu3 = SUBSTRING(@strFieldsAggregate,@intPosition3,LEN(@strFieldsAggregate))
			 END
			ELSE
			 BEGIN
				SET @strValu3 = SUBSTRING(@strFieldsAggregate,@intPosition3,@intPosition4 - @intPosition3)
				IF @intPosition3 = LEN(@strFieldsAggregate)
			 	 BEGIN
					SET @intPosition4 = 0
		 		 END
		 	END
			SET @intPosition3 = @intPosition4 + 1
			SET @intPosition1 = @intPosition2 + 1
			IF ((@intPosition2 = 0) AND (@intPosition4 <> 0)) OR ((@intPosition4 = 0) AND (@intPosition2<>0))
		 	 BEGIN
				PRINT 'CONFLICTING # of Arguments'
				RETURN
		 	 END
			SET @strSQL = @strSQL + ',' + @strValu3 + '(' + @strValu1 + ') AS ['
			SET @strSQL = @strSQL + @strValu3 + '-' + @strValu1 + ']'
			IF LEN(@strSQL) >=3999
			 BEGIN
				PRINT 'SQL Was to long limited to 4000 Characters'
			 	PRINT @strSQL
				RETURN
			 END
		 END
	 END
	IF @strTotals = 'BOTTOM' OR @strTotals = 'BOTH'  OR @strTotals = 'ALL'
	 BEGIN
		SET @strSQL = @strSQL + ',' + 'GROUPING('
		IF CHARINDEX ( ',', @strSELECT,0) > 0
		 BEGIN
			SET @strSQL = @strSQL + SUBSTRING(@strSELECT,8,CHARINDEX ( ',', @strSELECT,0)-8) + ') ''grp'''
		 END
		ELSE
		 BEGIN
			SET @strSQL = @strSQL + SUBSTRING(@strSELECT,8,LEN(@strSELECT)) + ') ''grp'''
		 END
	 END
	SET @strSQL = @strSQL + ' ' + @strFROM
	SET @strSQL = @strSQL + ' ' + @strWHERE
	SET @strSQL = @strSQL + ' GROUP BY ' + SUBSTRING(@strSELECT,8, LEN(@strSelect) - 7)
	IF @strTotals = 'BOTTOM' OR @strTotals = 'BOTH'
	 BEGIN
		SET @strSQL = @strSQL + ' WITH ROLLUP'
	 END
	IF @strTotals = 'ALL'
	 BEGIN
		SET @strSQL = @strSQL + ' WITH CUBE'
	 END
	IF LEN(@strSQL) >=3999
	 BEGIN
		PRINT 'SQL Was to long limited to 4000 Characters'
	 	PRINT @strSQL
		RETURN
	 END

	PRINT @strSQL 

	SELECT * FROM TopTable
	PRINT LEN(@strSQL)
	EXEC sp_executesql @strSQL

RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Remi_Mis_Rpt
-- --------------------------------------------------
CREATE Procedure Remi_Mis_Rpt(@ACCESSTO as varchar(8),@top as varchar(10),@BrokTO as varchar(12),@Order as varchar(6),@fdate as varchar(11),@tdate as varchar(11),@code as varchar(6),@SB as varchar(8))  
As  
  
/*  
Declare @top as varchar(10)  
Set @top='Top 10'  
Declare @BrokTO as varchar(12)  
Set @BrokTO='Turnover'  
Declare @Order as varchar(6)  
Set @Order='desc'  
Declare @fdate as varchar(11)  
Set @fdate='Feb 02 2008'  
Declare @tdate as varchar(11)  
Set @tdate='Feb 02 2008'  
Declare @code as varchar(6)  
Set @Code='SAG'  
  
*/  
Declare @str as varchar(2000)  
  
Set Nocount ON  
  
  
If @ACCESSTO='BROKER'  
BEGIN  
  
  
--Set @top='Top 10'  
  
set @str='Set transaction isolation level read uncommitted'  
set @str=@str+' select '+@top+' code=branch_cd,sb=max(sub_Broker),party_code,party_name=party_name,'  
set @str=@str+' ABL_CM=sum(case when Company =''ABLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_CM=sum(case when Company =''ACDLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_FO=sum(case when Company =''ACDLFO'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_MCX=sum(case when Company =''ACPLMCX'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_NCDEX=sum(case when Company =''ACPLNCDEX'' and 1=1 then '+@BrokTO+' else 0 end)/1000'  
set @str=@str+' into #file from mis_to (nolock)'  
set @str=@str+' where sauda_Date >='''+@fdate+''' and sauda_date <='''+@tdate+''' '  
set @str=@str+' group by branch_cd,party_code,party_name'  
set @str=@str+' select *,total=abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex  from #file Order by abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex '+@Order  
--print @str  
exec(@str)  
  
  
  
END   
  
If @ACCESSTO='REGION'  
BEGIN  
  
  
set @str='Set transaction isolation level read uncommitted'  
set @str=@str+' select '+@top+' code=branch_cd,sb=max(sub_Broker),party_code,party_name=party_name,'  
set @str=@str+' ABL_CM=sum(case when Company =''ABLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_CM=sum(case when Company =''ACDLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_FO=sum(case when Company =''ACDLFO'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_MCX=sum(case when Company =''ACPLMCX'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_NCDEX=sum(case when Company =''ACPLNCDEX'' and 1=1 then '+@BrokTO+' else 0 end)/1000'  
set @str=@str+' into #file1 from mis_to (nolock)'  
set @str=@str+' where sauda_Date >='''+@fdate+''' and sauda_date <='''+@tdate+''' and branch_cd in(select code from risk.dbo.region(nolock) where reg_code='''+@code+''')'  
set @str=@str+' group by branch_cd,party_code,party_name'  
set @str=@str+' select *,total=abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex  from #file1 Order by abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex '+@Order  
--print @str  
exec(@str)  
END   
If @ACCESSTO='BRMAST'  
BEGIN  
  
set @str='Set transaction isolation level read uncommitted'  
set @str=@str+' select '+@top+' code=branch_cd,sb=max(sub_Broker),party_code,party_name=party_name,'  
set @str=@str+' ABL_CM=sum(case when Company =''ABLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_CM=sum(case when Company =''ACDLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_FO=sum(case when Company =''ACDLFO'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_MCX=sum(case when Company =''ACPLMCX'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_NCDEX=sum(case when Company =''ACPLNCDEX'' and 1=1 then '+@BrokTO+' else 0 end)/1000'  
set @str=@str+' into #file2 from mis_to (nolock)'  
set @str=@str+' where sauda_Date >='''+@fdate+''' and sauda_date <='''+@tdate+''' and branch_cd in(select branch_cd from risk.dbo.branch_master(nolock) where BrMast_cd='''+@code+''')'  
set @str=@str+' group by branch_cd,party_code,party_name'  
set @str=@str+' select *,total=abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex  from #file2 Order by abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex '+@Order  
--print @str  
exec(@str)  
END   
If @ACCESSTO='BRANCH'  
BEGIN  
set @str='Set transaction isolation level read uncommitted'  
set @str=@str+' select '+@top+' code=branch_cd,sb=max(sub_Broker),party_code,party_name=party_name,'  
set @str=@str+' ABL_CM=sum(case when Company =''ABLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_CM=sum(case when Company =''ACDLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_FO=sum(case when Company =''ACDLFO'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_MCX=sum(case when Company =''ACPLMCX'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_NCDEX=sum(case when Company =''ACPLNCDEX'' and 1=1 then '+@BrokTO+' else 0 end)/1000'  
set @str=@str+' into #file4 from mis_to (nolock)'  
set @str=@str+' where sauda_Date >='''+@fdate+''' and sauda_date <='''+@tdate+''' and branch_cd='''+@code+'''' 
set @str=@str+' and sub_broker like '''+@SB+'''' 
set @str=@str+' group by branch_cd,party_code,party_name'  
set @str=@str+' select *,total=abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex  from #file4 Order by abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex '+@Order  
--print @str  
exec(@str)  
  
END   
If @ACCESSTO='SBMAST'  
BEGIN  
  
set @str='Set transaction isolation level read uncommitted'  
set @str=@str+' select '+@top+' code=branch_cd,sb=max(sub_Broker),party_code,party_name=party_name,'  
set @str=@str+' ABL_CM=sum(case when Company =''ABLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_CM=sum(case when Company =''ACDLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_FO=sum(case when Company =''ACDLFO'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_MCX=sum(case when Company =''ACPLMCX'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_NCDEX=sum(case when Company =''ACPLNCDEX'' and 1=1 then '+@BrokTO+' else 0 end)/1000'  
set @str=@str+' into #file5 from mis_to (nolock)'  
set @str=@str+' where sauda_Date >='''+@fdate+''' and sauda_date <='''+@tdate+''' and sub_Broker in(select sub_broker from risk.dbo.sb_master(nolock) where sbMast_cd='''+@code+''')'  
set @str=@str+' group by branch_cd,party_code,party_name'  
set @str=@str+' select *,total=abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex  from #file5 Order by abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex '+@Order  
--print @str  
exec(@str)  
END   
If @ACCESSTO='SB'  
BEGIN  
set @str='Set transaction isolation level read uncommitted'  
set @str=@str+' select '+@top+' code=branch_cd,sb=max(sub_Broker),party_code,party_name=party_name,'  
set @str=@str+' ABL_CM=sum(case when Company =''ABLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_CM=sum(case when Company =''ACDLCM'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACDL_FO=sum(case when Company =''ACDLFO'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_MCX=sum(case when Company =''ACPLMCX'' and 1=1 then '+@BrokTO+' else 0 end)/1000,'  
set @str=@str+' ACPL_NCDEX=sum(case when Company =''ACPLNCDEX'' and 1=1 then '+@BrokTO+' else 0 end)/1000'  
set @str=@str+' into #file6 from mis_to (nolock)'  
set @str=@str+' where sauda_Date >='''+@fdate+''' and sauda_date <='''+@tdate+''' and sub_Broker='''+@code+''''  
set @str=@str+' group by branch_cd,party_code,party_name'  
set @str=@str+' select *,total=abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex  from #file6 Order by abl_cm+acdl_cm+acdl_fo+acpl_mcx+acpl_ncdex '+@Order  
--print @str  
exec(@str)  
END   
  
Set Nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_turnover_commodities
-- --------------------------------------------------
CREATE procedure rpt_turnover_commodities                   
(@FDATE as varchar(11),                                                                                    
@TDATE as varchar(11),                                                                                   
@EntityCode as varchar(25),                                                                                    
@EntityType as varchar(10),                                                                                  
@FltrEntity as varchar(10),               
@segment as varchar(15) ,                 
@access_to as varchar(10),                                                                                    
@access_code as varchar(25)              
)                  
AS                  
  declare @source as varchar(400)                                                 
 /*            
 drop table #before               
drop table #after              
drop table #single              
             
declare                   
@FDATE as varchar(11),                                                                                    
@TDATE as varchar(11),                                          
@EntityCode as varchar(25),                                                  
@EntityType as varchar(10),                                                
@FltrEntity as varchar(10),                                                
@access_to as varchar(10),                                                  
@access_code as varchar(25) ,                  
@source as varchar(400),                  
@segment as varchar(15)                                                 
                   
set @FDATE ='jul 01 2009'                                                                               
set @TDATE='jul 07 2009'                                       
set @EntityCode='N15101'                                          
set @EntityType='CLIENT'                                          
set @FltrEntity='CLIENT'                                          
set @access_to ='BROKER'                                          
set @access_code ='CSO'                   
set @segment='ACPLNCDX'                                         
        
  */             
declare @filename as varchar(50)                  
 set nocount on                                                          
                  
select party_code,brokerage,Segment,symbol,expirydate,Zone,Region,                  
RegionName,Branch,BranchName,SB,SB_Name,Client,Party_name,                                                                                                                  
before_5=sum(case when shift=1 then turnover else 0 end),          
after_5=sum(case when shift=2 then turnover else 0 end)          
into #single          
from vw_turnover          
where  sauda_date>=@fdate and sauda_date<=@tdate and segment=@segment          
group by          
party_code,brokerage,Segment,symbol,expirydate,Zone,Region,                  
RegionName,Branch,BranchName,SB,SB_Name,Client,Party_name           
          
set nocount off             
          
               
set @filename = '#single'                
                   
 if @access_to='SB'              
begin              
 set @Source = '(select * from '+@filename+' where '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''')'                                   
               
                        
end              
                 
if @access_to='BROKER'                                                    
begin                                        
 set @Source = '(select * from '+@filename+' where  '+@FltrEntity+' like '''+@EntityCode+''')'                                                    
end                    
if(@access_to='BRANCH')                    
begin                    
select  @Source = '(select * from '+@filename+' where  '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''')'                    
end                    
if(@access_to='BRMAST')                    
begin                    
--select distinct sub_broker from subbrokers where branch_code in (select branch_cd from branch_master where brmast_cd=@access_code) and sub_broker=@sb                    
select  @Source = '(select * from '+@filename+' where  '+@EntityType+' in (select branch_cd from risk.dbo.branch_master where brmast_cd= '''+@access_code+'''))'             
            
              
end                    
if(@access_to='REGION')                    
begin                    
--select distinct sub_broker from subbrokers where sub_broker=@sb and branch_code in (select code from region where reg_code=@access_code)                    
select  @Source = '(select * from '+@filename+' where  '+@EntityType+' in (select CODE from risk.dbo.REGION where REG_CODE= '''+@access_code+'''))'                    
end                 
if(@access_to='SBMAST')                    
begin                    
--select distinct sub_broker from subbrokers where sub_broker=@sb and branch_code in (select code from region where reg_code=@access_code)                    
select  @Source = '(select * from '+@filename+' where  '+@EntityType+' in (select sub_broker from risk.dbo.sb_master where sbmast_cd= '''+@access_code+'''))'                
            
              
end                 
              
                 
--print @source                             
                  
--------------------------------------------------------------------------------                  
declare @QryPreFix varchar(500),@QryPostFix varchar(500),@FtQryPreFix varchar(500),@FtQryPostFix varchar(500),@lupd varchar(500)                                                   
set @QryPreFix =''                                                    
set @QryPostFix =''                                                    
set @FtQryPreFix =''                                                    
set @FtQryPostFix =''                                
set @lupd =''                     
                           
if @EntityType='ZONE'                                                    
begin                                                    
 --set @QryPreFix = ' Select ZONE, '                                                    
 set @QryPreFix ='set nocount on Select Zone,[Zone Name]=''<a href=''''report.aspx?reportno=104'                                                  
 set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                    
 set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                                    
 set @QryPreFix =@QryPreFix+'&EntityCode=''+zone+''&EntityType=REGION'                                                  
 set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'''''>''+zone+''</a>'','                                      
                                                  
 set @QryPostFix = ' group by zone '                                                    
end                  
                  
if @EntityType='REGION'                                                    
begin                                            
 set @QryPreFix = 'set nocount on Select Zone,REGION, '                                                    
 set @QryPreFix =@QryPreFix+' Regionname=''<a href=''''report.aspx?reportno=104'                                                  
 set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                    
 set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                                    
 set @QryPreFix =@QryPreFix+'&EntityCode=''+region+''&EntityType=BRANCH'                              
 set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'''''>''+Regionname+''</a>'','                                                  
                                                  
 set @QryPostFix = ' group by Zone,Region,Regionname '                     
end                  
                  
if @EntityType='BRANCH'                                                    
begin                                              
-- set @QryPreFix = ' Select Region,BRANCH,BR_Name, '                                                    
 set @QryPreFix = 'set nocount on Select Region,BRANCH, '     
 set @QryPreFix =@QryPreFix+' BranchName=''<a href=''''report.aspx?reportno=104'                                                  
 set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                    
 set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                       
 set @QryPreFix =@QryPreFix+'&EntityCode=''+branch+''&EntityType=SB'                                                  
 set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'''''>''+BranchName+''</a>'','                    
                                                  
 set @QryPostFix = ' group by Region,BRANCH,BranchName '                                                 
end                  
                  
if @EntityType='SB'                                                     
begin                                                    
-- set @QryPreFix = ' Select Region,Branch,SB,SB_name, '                                                    
                                                  
 set @QryPreFix = 'set nocount on Select Region,Branch,SB, '                                                    
 set @QryPreFix =@QryPreFix+' SB_name=''<a href=''''report.aspx?reportno=104'                                                  
 set @QryPreFix =@QryPreFix+'&fdate='+@FDATE                                    
 set @QryPreFix =@QryPreFix+'&tdate='+@TDATE                                    
 set @QryPreFix =@QryPreFix+'&EntityCode=''+SB+''&EntityType=CLIENT'                                    
 set @QryPreFix =@QryPreFix+'&FltrEntity='+@EntityType+'&segment='+@segment+'''''>''+SB_name+''</a>'','                                                  
                                                  
 set @QryPostFix = ' group by Region,Branch,SB,SB_name  '                              
  end                  
                  
if @EntityType='CLIENT'                                                     
begin                                                    
 --set @QryPreFix = ' Select Region,Branch,sb,CLIENT,Party_Name, '                                                    
 set @QryPreFix = 'set nocount on Select Region,Branch,sb,Client,symbol,expirydate=convert(varchar(11),expirydate,103),'                                                    
 --set @QryPreFix =@QryPreFix+' Party_Name=''<a href=''''report.aspx?reportno=35&client='+@EntityCode+''                                                
-- set @QryPreFix =@QryPreFix+' Party_Name='                       
--set @QryPreFix =@QryPreFix+'''''>'+Party_Name+','                                                  
                                                 
 set @QryPostFix = ' group by Region,Branch,sb,CLIENT,Party_Name,party_code,symbol,expirydate '                                                    
end                  
-------------------------------------------------------                  
                                         
--print @QryPreFix                                      
--print @QryPostFix                                           
                                       
             
DECLARE @grpname as varchar(15),@FinSumm as varchar(5000),@Seq as int                                                      
                                                    
set @FinSumm = ' '                                                 
set @FinSumm =  @FinSumm + '[Before 5 Oclock]=sum(before_5),[After 5 Oclok]=sum(after_5)                                                                                                                                        
 into #OPFile from '+@Source +' a '                                        
                                       
                                
set @FinSumm = @QryPreFix+@FinSumm+@QryPostFix+' SELECT * FROM #OPFILE   Select expirydate=''Total'',   
[Before 5 Oclock]=isnull(sum([Before 5 Oclock]),0),[After 5 Oclok]=isnull(sum([After 5 Oclok]),0)                                                                                                                                        
 from #OPFile    
set nocount off'                           
                                  
--print @FinSumm                                 
                              
exec(@FinSumm)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RptEbrok_Revanue
-- --------------------------------------------------

CREATE Procedure RptEbrok_Revanue(@fdate as varchar(11),@tdate as varchar(11),@pcode as varchar(10))    
as    
/*select BRANCH_CD,SUB_BROKER,PARTY_CODE,bse_br=sum(bse_br),E_BSE=sum(E_BSE),nse_br=sum(nse_br)    
,E_NSE=sum(E_NSE),fo_br=sum(fo_br),E_FO=sum(E_FO),mcx_br=sum(mcx_br),E_MCX=sum(E_MCX),ncdex_br=sum(ncdex_br),    
E_NCDX=sum(E_NCDX),    
TOTAL_SEG=sum(TOTAL_SEG),ebrok_br=sum(ebrok_br),nooflogin=sum(nooflogin),sauda_date     
into #file     
from ebrok_log_status where sauda_date>='Mar 01 2008' and sauda_date<='Mar 30 2008'    
and party_code='D12256'    
group by BRANCH_CD,SUB_BROKER,PARTY_CODE,sauda_date    
*/    
Set Nocount On    
    
Set Transaction isolation level read uncommitted    
select branch_cd,sub_broker,party_code,  
AblOn=(case when user_stat='e-broking' then    
sum(ablcm_brk) else 0 end),  
AblOFF=(case when user_stat<>'e-broking' then    
sum(ablcm_brk) else 0 end),  
  
AcdlOn=(case when user_stat='e-broking' then    
sum(acdlcm_brk) else 0 end),  
AcdlOFF=(case when user_stat<>'e-broking' then    
sum(acdlcm_brk) else 0 end),  
  
FoOn=(case when user_stat='e-broking' then    
sum(acdlfo_brk) else 0 end),  
FoOFF=(case when user_stat<>'e-broking' then    
sum(acdlfo_brk) else 0 end),  
  
mcxOn=(case when user_stat='e-broking' then    
sum(MCX_brok) else 0 end),  
McxOFF=(case when user_stat<>'e-broking' then    
sum(MCX_brok) else 0 end),  
  
NcdxOn=(case when user_stat='e-broking' then    
sum(ncdx_brok) else 0 end),  
NcdxOFF=(case when user_stat<>'e-broking' then    
sum(ncdx_brok) else 0 end),  
  
Offbrokerage=case when user_stat<>'e-broking' then    
sum(brokerage) else 0 end,    
Onbrokerage=case when user_stat='e-broking' then    
sum(brokerage) else 0 end,    
nol=sum(case when user_stat='e-broking' then 1 else 0 end)    
into #ff    
from mis_ebroking_cli where sauda_date>=@fdate and sauda_date<=@tdate    
and party_code=@pcode    
group by branch_cd,sub_broker,party_code,user_stat    
---------------------------------------------------    
    
select a.*,b2c=(case when b.b2c_Sb is null then 'B2B' else 'B2C'end)       
into #ff1                                 
from #ff a left outer join mis.remisior.dbo.B2C_SB b on a.sub_Broker=b.b2c_Sb     
    
 select a.*,b.long_name,b.active_date into #tbl from #ff1 a    
 join    
 ( select PArty_code,long_name,active_date           
 --into #file1                      
 from risk.dbo.client_details a (nolock),                      
 (select cl_Code,active_date=min(active_date)                       
 from risk.dbo.client_brok_Details (nolock)    
 where cl_Code=@pcode                   
 group by cl_code                      
 ) b                      
 where a.cl_code=b.cl_code  ) b    
 on a.party_code=b.party_code collate Latin1_General_CI_AS    
    
--------------------------------------------------------------------------    
select distinct * from #tbl a    
join     
(select party_code,product from risk.dbo.ebrok_client_product where party_code=@pcode) b    
on a.party_code=b.party_code collate Latin1_General_CI_AS    
    
              
Set Nocount Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RptEbrok_revenue
-- --------------------------------------------------
CREATE procedure RptEbrok_revenue(@fdate as varchar(11),@tdate as varchar(11),@pcode as varchar(10))    
as    
set transaction isolation level read UNCOMMITTED    
set nocount on    
    
select sauda_date,Branch_cd,Sub_Broker,PArty_name,Terminal_id,Brokerage into #file1    
from mis_to (nolock) where sauda_Date>=@fdate and sauda_Date<=@tdate and party_code=@pcode    
    
select Branch_cd,Sub_Broker,PArty_name,Client_type,    
NOL=0,Activedate=convert(datetime,'Jan  1 1900'),    
product=isnull(fld_product_name,'Offline'),brokerage=sum(brokerage)    
--OnBRokerage=sum(case when b.Terminal_id is not null and a.sauda_date >= from_date and a.sauda_DAte <= b.to_date then brokerage else 0 end),    
--OffBRokerage=sum(brokerage-(case when b.Terminal_id is not null and a.sauda_date >= from_date and a.sauda_DAte <= b.to_date then brokerage else 0 end))    
into #file2    
from     
(Select c.*,client_type=(Case when d.b2c_sb is null then 'B2B' else 'B2C' end) from #file1 c     
left outer join mis.remisior.dbo.b2c_sb d on c.sub_Broker=d.b2c_sb )a left outer join  ebrkTeminalProduct  b    
on a.terminal_id=b.terminal_id     
group by Branch_cd,Sub_Broker,PArty_name,fld_product_name,Servermapped,Client_type    
    
    
update #file2 set NOL=(    
select nol=count(*) from mis_ebroking_cli (nolock) where     
sauda_Date >=@fdate and sauda_Date <=@tdate    
and party_code=@pcode    
and user_stat='e-broking'     
) where product <> 'Offline'    
    
    
update #file2 set Activedate=    
(select First_Active_Date from risk.dbo.client_Details where party_code=@pcode)    
    
select * from #file2    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_Business_mis
-- --------------------------------------------------
CREATE procedure SB_Business_mis 
(
@FDATE as varchar(11),       
@TDATE as varchar(11),       
@EntityCode as varchar(25),   
@EntityType as varchar(25),    
@FltrEntity as varchar(10),      
@segment as varchar(15) ,        
@type as varchar(10),           
@access_to as varchar(10),      
@access_code as varchar(25)   
)
as
/*declare   
@FDATE as varchar(11),  
@TDATE as varchar(11),  
@EntityCode as varchar(25),  
@EntityType as varchar(25),  
@FltrEntity as varchar(10),   
@segment as varchar(15)  ,  
@type as varchar(10),   
@access_to as varchar(10),  
@access_code as varchar(25)  
  
set @FDATE ='22 jan 2010'  
set @TDATE='22 jan 2010'  
set @EntityCode='bvi'  
set @EntityType='branch'  
set @FltrEntity='branch'  
set @segment='ABLCM'  
set @type='%'   
set @access_to ='broker'  
set @access_code ='cso'  */

select sauda_date,company,party_code,terminal_id,nooftrade=sum(nooftrade)  
into #t from mis_NoOfTrade (nolock) 
where sauda_date>=convert(datetime,@fdate,103) and sauda_date<=convert(datetime,@tdate,103) and company like ''+@segment+'%'
group by sauda_date,company,terminal_id,party_code

select sauda_date,company,Region,branch_cd,sub_broker,party_code,terminal_id,turnover 
into #m from  mis_to (nolock) 
where sauda_date>=convert(datetime,@fdate,103) and sauda_date<=convert(datetime,@tdate,103) and company like ''+@segment+'%'

select Zone=space(10),Region,Branch=m.branch_cd,SB=m.sub_broker,Segment=m.company,[Type]=space(5),
[Trade Date]=convert(varchar(11),m.sauda_date,103),
[No of Traded Client]=count(distinct m.party_code),
[No of Trades per day]=sum(nooftrade),
[Turnover per day]=convert(decimal(15,2),sum(turnover))
into #file1
from #m m left outer join #t t
on m.sauda_date=t.sauda_date and m.party_code=t.party_code collate SQL_Latin1_General_CP1_CI_AS
and m.terminal_id=t.terminal_id collate SQL_Latin1_General_CP1_CI_AS 
	  --and m.sauda_date>='01/15/2010' and m.sauda_date<='01/15/2010 23:00:00'
group by m.region,m.branch_cd,m.sub_broker,m.company,m.sauda_date

update #file1 set #file1.zone=b.zone ,#file1.region = b.region from risk.dbo.Vw_BRANCH_Vertical b where #file1.branch=b.branch  
  
update #file1 set [Type]=case when SB in (select B2C_SB from mis.remisior.dbo.b2c_sb) then 'B2C' else 'B2B' end   
  
declare @sql as varchar(1000),@condition as varchar(1000),@finqry as varchar(1500)  
set @sql='select Branch,[Subbroker]=SB,Segment,  
[Trade Date] , [No of Traded Client],[No of Trades per day]=isnull([No of Trades per day],''-''),  [Turnover per day]
from #file1 where type like '''+ @type+''' '     
  
if @access_to='SB'                                                               
begin              
set @condition = ' and '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''       
end                                                                      
if @access_to='BROKER'                                                                                
begin     
set @condition = ' and  '+@FltrEntity+' like '''+@EntityCode+''''                                                                 
end                                                
if(@access_to='BRANCH')                                                
begin   
set @condition = ' and  '+@FltrEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''  
end                                                
if(@access_to='BRMAST')            
begin           
set @condition = ' and  Branch in (select branch_cd collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.branch_master where brmast_cd= '''+@access_code+''')'  
end                                             
if(@access_to='REGION')                                                
begin                 
set @condition = ' and  branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.REGION where REG_CODE= '''+@access_code+''')'  
end                              
if(@access_to='SBMAST')            
begin      
set @condition = ' and  SB in (select sub_broker collate SQL_Latin1_General_CP1_CI_AS from risk.dbo.sb_master where sbmast_cd=  '''+@access_code+''')'             
end   
  
set @finqry=@sql +@condition  
  
exec (@finqry)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_PerformanceIndicator
-- --------------------------------------------------
CREATE Procedure SB_PerformanceIndicator
as
set nocount on
Declare @Syear int,@Smonth int
set @Syear=Year(GETDATE())
set @Smonth=month(GETDATE())

---Revenue Potential
/****************************************************************/
delete from Sbwise_TOBrok where Syear=@Syear and Smonth=@Smonth

insert into Sbwise_TOBrok
select SYear=Year(sauda_date),Smonth=month(sauda_date),Sub_broker,Turnover=SUM(Turnover),brokerage=SUM(brokerage),
tradingdays=COUNT(distinct sauda_date),Tradedclients=COUNT(party_code) 
from mis_to with (nolock) where Year(sauda_date)=@Syear and month(sauda_date)=@Smonth
group by Year(sauda_date),month(sauda_date),Sub_broker

update a set tradingdays=b.sauda_date from Sbwise_TOBrok a inner join
(select SYear=Year(sauda_date),Smonth=month(sauda_date),
sauda_date=count(distinct sauda_date) from mis_to with (nolock) where Year(sauda_date)=@Syear and month(sauda_date)=@Smonth
group by Year(sauda_date),month(sauda_date))b on a.SYear=b.SYear and a.Smonth=b.Smonth


/*****************************************************************/
delete from  Sbwise_ClientPotential where Fyear=@Syear and Fmonth=@Smonth

insert into Sbwise_ClientPotential
select Fyear=Year(First_Active_date),Fmonth=month(First_Active_date),sub_broker,cntparty=count(party_code) 
from intranet.risk.dbo.client_details with (nolock)
where Last_inactive_date>GETDATE() and Year(First_Active_date)=@Syear and month(First_Active_date)=@Smonth
group by sub_broker,Year(First_Active_date),month(First_Active_date) order by Year(First_Active_date),month(First_Active_date)


set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.showMISReport
-- --------------------------------------------------







CREATE        PROCEDURE showMISReport
	--@TerminalType VARCHAR(25),
	--@FromTerminal VARCHAR(25),
	--@ToTerminal VARCHAR(25),
	@FromDate VARCHAR(25),
	@ToDate VARCHAR(25),
	
	@FromBranch VARCHAR(25),
	--@ToBranch VARCHAR(25),
	@FromClient VARCHAR(25),
	--@ToClient VARCHAR(25),
	@FromSubBroker VARCHAR(25),
	--@ToSubBroker VARCHAR(25),
	@OrderBy VARCHAR(25)
AS
	/* IF @FromTerminal = '' 
		SET @FromTerminal = 'A'
	IF @ToTerminal = '' 
		SET @ToTerminal = 'Z' */

	IF @FromBranch = '' 
		SET @FromBranch = '%'
	--IF @ToBranch = '' 
		--SET @ToBranch = 'Z'
	IF @FromClient = '' 
		SET @FromClient = '%'
--	IF @ToClient = '' 
		--SET @ToClient = 'Z'
	IF @FromSubBroker = '' 
		SET @FromSubBroker = '%'
	--IF @ToSubBroker = '' 
		--SET @ToSubBroker = 'Z'

	IF @FromBranch = 'All'
		SET @FromBranch = '%'
	--IF @ToBranch = 'All'
		--SET @ToBranch = '%'


	SET @FromDate = LEFT(CONVERT(VARCHAR,@FromDate,109),11)
	SET @ToDate = LEFT(CONVERT(VARCHAR,@ToDate,109),11)

	
	IF @OrderBy='Br-Report'
	BEGIN
		SELECT
			branch_cd,
			ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),
			ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),
			ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
			ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),
			ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),
			ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),
			Tot_to=sum(turnover),
			tot_brok=sum(brokerage),
			Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),
			Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),
			ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),
			ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end) 
		FROM 
			mis_to As a JOIN mis.TerminalMaster.dbo.tbl_mst_Terminals As b
			ON a.terminal_id=b.terminal_Id
		WHERE 
			sauda_date >=@FromDate AND sauda_date <=@ToDate
			AND branch_cd LIKE @FromBranch  --AND branch_cd LIKE @ToBranch
			AND party_code like @FromClient -- AND party_code<=@ToClient
			AND sub_broker like @FromSubBroker --AND sub_broker<=@ToSubBroker
			and Activation_Date <=@FromDate AND DeActivation_Date >=@ToDate
		GROUP BY branch_cd
		ORDER BY Branch_cd
	END
	ELSE IF @OrderBy='Clt-Report'
	BEGIN
		SELECT
			branch_cd,sub_broker,party_code,
			ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),
			ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),
			ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
			ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),
			ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),
			ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),
			Tot_to=sum(turnover),
			tot_brok=sum(brokerage),
			Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),
			Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),
			ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),
			ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end) 
		FROM 
			mis_to As a JOIN mis.TerminalMaster.dbo.tbl_mst_Terminals As b
			ON a.terminal_id=b.terminal_Id
		WHERE 
			sauda_date >=@FromDate AND sauda_date <=@ToDate
			AND branch_cd LIKE @FromBranch  --AND branch_cd LIKE @ToBranch
			AND party_code Like @FromClient -- AND party_code<=@ToClient
			AND sub_broker Like @FromSubBroker-- AND sub_broker<=@ToSubBroker
			and Activation_Date <=@FromDate AND DeActivation_Date >=@ToDate
		GROUP BY branch_cd,sub_broker,party_code
		ORDER BY party_code
	END
	ELSE IF @OrderBy='Dt-Report'
	BEGIN
		SELECT
			Sauda_Date=CONVERT(VARCHAR,sauda_date,103),
			ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),
			ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),
			ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
			ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),
			ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),
			ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),
			Tot_to=sum(turnover),
			tot_brok=sum(brokerage),
			Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),
			Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),
			ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),
			ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end) 
		FROM 
			mis_to As a JOIN mis.TerminalMaster.dbo.tbl_mst_Terminals As b
			ON a.terminal_id=b.terminal_Id
		WHERE 
			sauda_date >=@FromDate AND sauda_date <=@ToDate
			AND branch_cd LIKE @FromBranch --AND branch_cd LIKE @ToBranch
			AND party_code Like @FromClient --AND party_code<=@ToClient
			AND sub_broker Like @FromSubBroker-- AND sub_broker<=@ToSubBroker
			and Activation_Date <=@FromDate AND DeActivation_Date >=@ToDate
		GROUP BY sauda_date
		ORDER BY Sauda_Date
	END
	ELSE IF @OrderBy='Sbr-Report'
	BEGIN
		SELECT
			branch_cd,sub_broker,
			ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),
			ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),
			ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
			ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),
			ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),
			ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),
			Tot_to=sum(turnover),
			tot_brok=sum(brokerage),
			Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),
			Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),
			ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),
			ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end) 
		FROM 
			mis_to As a JOIN mis.TerminalMaster.dbo.tbl_mst_Terminals As b
			ON a.terminal_id=b.terminal_Id
		WHERE 
			sauda_date >=@FromDate AND sauda_date <=@ToDate
			AND branch_cd LIKE @FromBranch
			 --AND branch_cd LIKE @ToBranch
			AND party_code Like @FromClient --AND party_code<=@ToClient
			AND sub_broker Like @FromSubBroker --AND sub_broker<=@ToSubBroker
			and Activation_Date <=@FromDate AND DeActivation_Date >=@ToDate
		GROUP BY branch_cd,sub_broker
		ORDER BY sub_broker
	END

ELSE IF @OrderBy='Exe-Report'
	BEGIN
		SELECT
			executive,
			ABLCM_TO=sum(case when company='ABLCM' then turnover else 0 end),
			ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),
			ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),
			ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),
			ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),
			ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),
			Tot_to=sum(turnover),
			tot_brok=sum(brokerage),
			Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),
			Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),
			ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),
			ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end) 
		FROM 
			mis_to As a JOIN mis.TerminalMaster.dbo.tbl_mst_Terminals As b 
			ON a.terminal_id=b.terminal_Id Join dotnet.dbo.clientexecutive c on
			c.party_code =a.party_code
		WHERE 
			sauda_date >=@FromDate AND sauda_date <=@ToDate
			AND branch_cd LIKE @FromBranch --AND branch_cd LIKE @ToBranch
			AND a. party_code Like @FromClient --AND party_code<=@ToClient
			AND sub_broker Like @FromSubBroker-- AND sub_broker<=@ToSubBroker
			and Activation_Date <=@FromDate and DeActivation_Date >=@ToDate
		GROUP BY executive
		ORDER BY executive
	END
--EXEC showMISReport 'Br-Report','','','Sep 01 2005','Sep 30 2005','ALL','ALL','A','H','A','H','Dt-Report'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddBankRecord
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_AddBankRecord    Script Date: 09/11/2005 6:47:27 PM ******/
CREATE proc
	sp_AddBankRecord
	(
                @intBankCode bigint, 
		@strBankName varchar(50)
	)
AS
Begin

	declare @Cnt bigint
      
	set @strBankName = ltrim(rtrim(@strBankName))

        --Check for Duplicate Entry

	select @Cnt=Count(BankName) from BankMaster where BankName = @strBankName
        if @Cnt = 0
        Begin 
                    begin tran
			insert into
				BankMaster
				(
					BankCode,
                                        BankName     
				)
				values
				(
                                        @intBankCode,
					@strBankName
				)   
         if @@error = 0 
          commit else rollback tran
       End

	select flgCount = @Cnt   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddBankROC
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_AddBankROC    Script Date: 09/11/2005 6:47:27 PM ******/

create
proc
	sp_AddBankROC
	(
		@BankCode bigint,
		@ROC Money
	)

as
	insert into
		BankROCRateMaster
		(
			BankCode,
			ROC,
			effFromDt,
			effToDt,
			Active
		)
		values
		(
			@BankCode,
			@ROC,
			left(convert(varchar, getdate(), 109), 11) + ' 00:00:00',
			'Dec 31 2999 23:59:00',
			'Y'	/*Active*/
		)

--GO

SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddBankROI
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_AddBankROI    Script Date: 09/11/2005 6:47:27 PM ******/

CREATE
proc
	sp_AddBankROI
	(
		@BankCode bigint,
		@ROI Money
	)

as
	insert into
		BankROIRateMaster
		(
			BankCode,
			ROI,
			effFromDt,
			effToDt,
			Active
		)
		values
		(
			@BankCode,
			@ROI,
			left(convert(varchar, getdate(), 109), 11) + ' 00:00:00',
			'Dec 31 2999 23:59:00',
			'Y'	/*Active*/
		)

--GO

SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddBranchRecord
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_AddBranchRecord    Script Date: 09/11/2005 6:47:27 PM ******/
--sp_helptext sp_AddBranchRecord
CREATE proc
	sp_AddBranchRecord
	(
		@intBankBranchCode bigint,
		@intBankCode bigint,
		@strBranchName varchar(50),
		@strAdd1 varchar(250),
                @strAdd2 varchar(250),
		@strCity varchar(25),
		@strState varchar(25),
                @strNation varchar(25),
		@strZip varchar(10),
		@strPhone1 varchar(25),
                @strPhone2 varchar(25),
		@strFax varchar(25),
		@strEmail varchar(50)
	)
AS
Begin   set @strBranchName = ltrim(rtrim(@strBranchName))
        set @strAdd1 = ltrim(rtrim(@strAdd1))
        set @strAdd2 = ltrim(rtrim(@strAdd2))
	set @strCity = ltrim(rtrim(@strCity))
        set @strState = ltrim(rtrim(@strState))
	set @strNation = ltrim(rtrim(@strNation))
        set @strZip = ltrim(rtrim(@strZip))
	set @strPhone1 = ltrim(rtrim(@strPhone1))
        set @strPhone2 = ltrim(rtrim(@strPhone2))
	set @strFax = ltrim(rtrim(@strFax))
        set @strEmail = ltrim(rtrim(@strEmail))
	
        begin tran

		insert into
			BankBranchMaster
			(
				BankBranchCode,
				BankCode,
				BranchName,
				Address1,
                                Address2,
                                City,
                                State,
                                Nation,
                                Zip,
                                Phone1,
                                Phone2,
                                Fax,
                                Email     
			)
			values
			(
				@intBankBranchCode,
				@intBankCode,
				@strBranchName,
                                @strAdd1,
                                @strAdd2,
                                @strCity,
                                @strState,
                                @strNation,
                                @strZip,
                                @strPhone1,
                                @strPhone2,
                                @strFax,
                                @strEmail
			)	
	if @@error = 0 
          commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddFDRecord
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.sp_AddFDRecord    Script Date: 09/11/2005 6:47:27 PM ******/
--sp_helptext sp_AddFDRecord
CREATE   proc
	sp_AddFDRecord
	(
		@intFDCode bigint,
		@intBankBranchCode bigint,
		@strFDNo varchar(20),
		@strCompName varchar(20),
                @strSegment varchar(10),
		@strNew varchar(5),
		@MoneyDepositAmt Money,
                @ActualExpDate datetime,
		@EffFrom datetime,
		@EffTo datetime,
                @moneyROI Money,
		@strCustID varchar(20),
		@TDS Money,
		@Commission money,
		@strReinvest varchar(15)
	)
AS
Begin
	set @strFDNo = ltrim(rtrim(@strFDNo))
	set @strCompName = ltrim(rtrim(@strCompName))
        set @strSegment = ltrim(rtrim(@strSegment))
        set @strNew = ltrim(rtrim(@strNew))
        set @strCustID = ltrim(rtrim(@strCustID))
        set @strReinvest=ltrim(rtrim(@strReinvest))
	
        begin tran

		insert into
			FDMaster
			(
				FDCode,
				BankBranchCode,
				FDNo,
				CompName,
                                Segment,
                                New,
                                DepositAmount,
                                ActualExpDate,
                                effFrom,
                                effTo,
				ROI,
				CustomerID,
				TDS,
				Commission,
				Reinvest,
				ModificationDate     
			)
			values
			(
				@intFDCode,
				@intBankBranchCode,
				@strFDNo,
                                @strCompName,
                                @strSegment,
                                @strNew,
                                @MoneyDepositAmt,
                                @ActualExpDate,
                                @EffFrom,
                                @EffTo,
				@moneyROI,
				@strCustID,
				@TDS,
				@Commission,
				@strReinvest,
				getdate()
			)	
	if @@error = 0 
          commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_addnew_MarketExecField
-- --------------------------------------------------


CREATE PROC
	sp_addnew_MarketExecField
	(
		@intMarketExecFieldId bigint,
		@strFieldExecName varchar(100),
		@intMarketExecRegionId bigint,
		@strRegion varchar(100),
		@strExchSeg varchar(15),
		@strField varchar(100)
	)
AS
Begin
	/* If adding from Add mode, sending MarketExecFieldId as 0 And for Edit mode, MarketExecFieldId from particular record */
	if @intMarketExecFieldId = 0
	begin
		/* Increatimenting the MarketExecField */
		select @intMarketExecFieldId = (Case when isnull(max(MarketExecFieldId), 0) > 0 then max(MarketExecFieldId) + 1 else 1 end) 
		from tblMarketExecFieldMaster
	end
	
	set @strFieldExecName = upper(ltrim(rtrim(@strFieldExecName)))
	set @strRegion = upper(ltrim(rtrim(@strRegion)))
	set @strExchSeg = upper(ltrim(rtrim(@strExchSeg)))
	set @strField = upper(ltrim(rtrim(@strField)))

	begin tran	

	insert into
		tblMarketExecFieldMaster
		(
			MarketExecFieldId,
			FieldExecName,
			MarketExecRegionId,
			Region,
			ExchSeg,
			Field,
			Deleted,
			Eff_FromDate,
			Eff_ToDate,
			dummy01,
			dummy02
		)
		values
		(
			@intMarketExecFieldId,
			@strFieldExecName,
			@intMarketExecRegionId,
			@strRegion,
			@strExchSeg,
			@strField,
			'N',
			left(convert(datetime, getdate(), 109), 11) + ' 00:00:00',
			'Dec 31 2999 23:59:00',
			'',
			''
		)

	if @@error = 0 commit else rollback tran

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_addnew_MarketExecRegion
-- --------------------------------------------------


CREATE PROC
	sp_addnew_MarketExecRegion
	(
		@intMarketExecRegionId bigint,
		@strExecName varchar(100),
		@intMarketHeadId bigint,
		@strExchSeg varchar(15),
		@strRegion varchar(100)
	)
AS
Begin
	/* If adding from Add mode, sending MarketExecRegionId as 0 And for Edit mode, MarketExecRegionId from particular record */
	if @intMarketExecRegionId = 0
	begin
		/* Increatimenting the MarketHead */
		select @intMarketExecRegionId = (Case when isnull(max(MarketExecRegionId), 0) > 0 then max(MarketExecRegionId) + 1 else 1 end) 
		from tblMarketExecRegionMaster
	end
	
	set @strExecName = upper(ltrim(rtrim(@strExecName)))
	set @strExchSeg = upper(ltrim(rtrim(@strExchSeg)))
	set @strRegion = upper(ltrim(rtrim(@strRegion)))

	begin tran	

	insert into
		tblMarketExecRegionMaster
		(
			MarketExecRegionId,
			ExecName,
			MarketHeadId,
			ExchSeg,
			Region,
			Deleted,
			Eff_FromDate,
			Eff_ToDate,
			dummy01,
			dummy02
		)
		values
		(
			@intMarketExecRegionId,
			@strExecName,
			@intMarketHeadId,
			@strExchSeg,
			@strRegion,
			'N',
			left(convert(datetime, getdate(), 109), 11) + ' 00:00:00',
			'Dec 31 2999 23:59:00',
			'',
			''
		)

	if @@error = 0 commit else rollback tran

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_addnew_MarketHead
-- --------------------------------------------------


CREATE PROC
	sp_addnew_MarketHead
	(
		@intMarketHeadId bigint,
		@strMarketHeadName varchar(100)
	)
AS
Begin
	/* If adding from Add mode, sending MarketHeadId as 0 And for Edit mode, MarketHeadId from particular record */
	if @intMarketHeadId = 0
	begin
		/* Increatimenting the MarketHead */
		select @intMarketHeadId = (Case when isnull(max(MarketHeadId), 0) > 0 then max(MarketHeadId) + 1 else 1 end) 
		from tblMarketHeadMaster
	end
	
	set @strMarketHeadName = upper(ltrim(rtrim(@strMarketHeadName)))

	begin tran	

	insert into
		tblMarketHeadMaster
		(
			MarketHeadId,
			MarketHeadName,
			Deleted,
			Eff_FromDate,
			Eff_ToDate,
			dummy01,
			dummy02
		)
		values
		(
			@intMarketHeadId,
			@strMarketHeadName,
			'N',
			left(convert(datetime, getdate(), 109), 11) + ' 00:00:00',
			'Dec 31 2999 23:59:00',
			'',
			''
		)

	if @@error = 0 commit else rollback tran

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_addnew_MarketWorkDone
-- --------------------------------------------------


CREATE PROC
	sp_addnew_MarketWorkDone
	(
		@intMarketWorkDoneId bigint,
		@intMarketHeadId bigint,
		@intMarketExecRegionId bigint,
		@intMarketExecFieldId bigint,
		@strExchSeg varchar(15),
		@strBranchCode varchar(10),
		@strSubbrokerOrRemisierCode varchar(10)
	)
AS
Begin
	/* If adding from Add mode, sending MarketWorkDoneId as 0 And for Edit mode, MarketWorkDone from particular record */
	if @intMarketWorkDoneId = 0
	begin
		/* Increatimenting the MarketWorkDoneId */
		select @intMarketWorkDoneId = (Case when isnull(max(MarketWorkDoneId), 0) > 0 then max(MarketWorkDoneId) + 1 else 1 end) 
		from tblMarketWorkDoneMaster
		
		/* Taking MarketExecRegionId and MarketHeadId for MarketExecField on Add mode */
		select 
			@intMarketExecRegionId = isnull(F.MarketExecRegionId, 0),
			@intMarketHeadId = isnull(MarketHeadId, 0) 
		from 
			tblMarketExecFieldMaster F, tblMarketExecRegionMaster R
		where
			F.MarketExecFieldId = @intMarketExecFieldId
			and F.MarketExecRegionId = R.MarketExecRegionId
			and F.Deleted = 'N'
			and F.Eff_ToDate = 'Dec 31 2999 23:59:00'
			and R.Deleted = 'N'
			and R.Eff_ToDate = 'Dec 31 2999 23:59:00'
	end
	
	set @strExchSeg = upper(ltrim(rtrim(@strExchSeg)))
	set @strBranchCode = upper(ltrim(rtrim(@strBranchCode)))
	set @strSubbrokerOrRemisierCode = upper(ltrim(rtrim(@strSubbrokerOrRemisierCode)))

	begin tran	

	insert into
		tblMarketWorkDoneMaster
		(
			MarketWorkDoneId,
			MarketHeadId,
			MarketExecRegionId,
			MarketExecFieldId,
			ExchSeg,
			BranchCode,
			SubbrokerOrRemisierCode,
			Deleted,
			Eff_FromDate,
			Eff_ToDate,
			dummy01,
			dummy02
		)
		values
		(
			@intMarketWorkDoneId,
			@intMarketHeadId,
			@intMarketExecRegionId,
			@intMarketExecFieldId,
			@strExchSeg,
			@strBranchCode,
			@strSubbrokerOrRemisierCode,
			'N',
			left(convert(datetime, getdate(), 109), 11) + ' 00:00:00',
			'Dec 31 2999 23:59:00',
			'',
			''
		)

	if @@error = 0 commit else rollback tran

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_allpartyopensettlement
-- --------------------------------------------------

CREATE   proc
	[dbo].[sp_allpartyopensettlement]
	(
		@strFromPartyCode varchar(10),
		@strToPartyCode varchar(10),
		@strClientType varchar(10),
		@strExchSeg varchar(10)
	)

as

set @strFromPartyCode = upper(ltrim(rtrim(@strFromPartyCode)))
set @strToPartyCode = upper(ltrim(rtrim(@strToPartyCode)))
set @strClientType = upper(ltrim(rtrim(@strClientType)))
set @strExchSeg = upper(ltrim(rtrim(@strExchSeg)))

if len(@strFromPartyCode) = 0 set @strFromPartyCode = 'a000000000'
if len(@strToPartyCode) = 0 set @strToPartyCode = 'z999999999'
if len(@strClientType) = 0 set @strClientType = '%'
if len(@strExchSeg) = 0 set @strExchSeg = NULL

declare
	@strSQL varchar(8000),
	@strSettNo varchar(20),
	@strSettType varchar(10),
	@strPartyCode varchar(10)

if @strExchSeg = 'NSECM'
begin
	declare party_cursor cursor for
		select
			c2.party_code
		from 
			AngelNseCM.msajag.dbo.client1 c1,
			AngelNseCM.msajag.dbo.client2 c2
		where
			c1.cl_code = c2.cl_code and
			c1.cl_type = @strClientType
		order by
			c2.party_code

		open party_cursor

		fetch next from party_cursor into @strPartyCode
		while @@fetch_status = 0
		begin
			set @strPartyCode = upper(ltrim(rtrim(@strPartyCode)))

			declare sett_cursor cursor for
				select distinct top 6
					s.sett_no,
					s.sett_type
				from
					AngelNseCM.msajag.dbo.sett_mst s,
					AngelNseCM.msajag.dbo.details d
				where
					d.sett_no = s.sett_no and
					d.sett_type = s.sett_type and
			
					s.sec_payout >= getdate() /*dateadd(dd, 0, getdate()) */ and
					s.start_date <= getdate() /*dateadd(dd, 0, getdate()) */ and
					s.sett_type not like 'A%' and
			
					d.party_code = @strPartyCode

				open sett_cursor
	
				fetch next from sett_cursor into @strSettNo, @strSettType
				while @@fetch_status = 0
				begin
			/*
					print @strSettNo
					print @strSettType
					print @strPartyCode
					print '*********************************************************'
			*/

					set @strSQL = ''
					set @strSQL = @strSQL + 'AngelNseCM.msajag.dbo.rpt_nsedelclientscrips '
					set @strSQL = @strSQL + '''CLIENT'', '
					set @strSQL = @strSQL + '''' + @strPartyCode + ''', '
					set @strSQL = @strSQL + '''' + '1' + ''', '
					set @strSQL = @strSQL + '''' + @strSettNo + ''', '
					set @strSQL = @strSQL + '''' + @strSettType + ''', '
					set @strSQL = @strSQL + '''' + @strPartyCode + ''' '
			
					print (@strSQL)
					exec (@strSQL)
			
		/*			print '*********************************************************'*/
			
					fetch next from sett_cursor into @strSettNo, @strSettType
				
				end		/*while @@fetch_status = 0 OF fetch next from sett_cursor into @strSettNo, @strSettType*/

				close sett_cursor
				deallocate sett_cursor

				fetch next from party_cursor into @strPartyCode

		end		/*while @@fetch_status = 0 OF fetch next from party_cursor into @strPartyCode*/

	close party_cursor
	deallocate party_cursor

end		/*if @strExchSeg = 'NSECM'*/

if @strExchSeg = 'BSECM'
begin
	declare party_cursor cursor for
		select
			c2.party_code
		from 
			AngelBSECM.bsedb_ab.dbo.client1 c1,
			AngelBSECM.bsedb_ab.dbo.client2 c2
		where
			c1.cl_code = c2.cl_code and
			c1.cl_type = @strClientType
		order by
			c2.party_code

		open party_cursor

		fetch next from party_cursor into @strPartyCode
		while @@fetch_status = 0
		begin
			set @strPartyCode = upper(ltrim(rtrim(@strPartyCode)))

			declare sett_cursor cursor for
				select distinct top 6
					s.sett_no,
					s.sett_type
				from
					AngelBSECM.bsedb_ab.dbo.sett_mst s,
					AngelBSECM.bsedb_ab.dbo.details d
				where
					d.sett_no = s.sett_no and
					d.sett_type = s.sett_type and
			
					s.sec_payout >= getdate() /*dateadd(dd, 0, getdate()) */ and
					s.start_date <= getdate() /*dateadd(dd, 0, getdate()) */ and
					s.sett_type not like 'A%' and
			
					d.party_code = @strPartyCode

				open sett_cursor
	
				fetch next from sett_cursor into @strSettNo, @strSettType
				while @@fetch_status = 0
				begin
			/*
					print @strSettNo
					print @strSettType
					print @strPartyCode
					print '*********************************************************'
			*/

					set @strSQL = ''
					set @strSQL = @strSQL + 'angeldemat.bsedb.dbo.rpt_nsedelclientscrips '
					set @strSQL = @strSQL + '''CLIENT'', '
					set @strSQL = @strSQL + '''' + @strPartyCode + ''', '
					set @strSQL = @strSQL + '''' + '1' + ''', '
					set @strSQL = @strSQL + '''' + @strSettNo + ''', '
					set @strSQL = @strSQL + '''' + @strSettType + ''', '
					set @strSQL = @strSQL + '''' + @strPartyCode + ''' '
			
					print (@strSQL)
					exec (@strSQL)
			
		/*			print '*********************************************************'*/
			
					fetch next from sett_cursor into @strSettNo, @strSettType
				
				end		/*while @@fetch_status = 0 OF fetch next from sett_cursor into @strSettNo, @strSettType*/

				close sett_cursor
				deallocate sett_cursor

				fetch next from party_cursor into @strPartyCode

		end		/*while @@fetch_status = 0 OF fetch next from party_cursor into @strPartyCode*/

	close party_cursor
	deallocate party_cursor

end		/*if @strExchSeg = 'BSECM'*/

/* exec sp_allpartyopensettlement 'DE18', 'DE18', 'NBF', 'NSECM' */
/* exec sp_allpartyopensettlement 'DE18', 'DE18', 'NBF', 'BSECM' */

/* exec sp_allpartyopensettlement 'BH14', 'BH14', 'NBF', 'NSECM' */
/* exec sp_allpartyopensettlement 'BH14', 'BH14', 'NBF', 'BSECM' */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AllPartyOpenSettlement_orig
-- --------------------------------------------------

/*
Displays open position settlement for all clients for specific cl_type
sp_AllPartyOpenSettlement 'client', 'BH14', '1', '2005074', 'C', 'BH14', 'BH14', 'NBF', 'BSECM'
*/
/*
exec sp_AllPartyOpenSettlement 'client', 'DE18', '1', '', '', '', '', '', 'NSECM'
*/

CREATE    PROCEDURE
	[dbo].[sp_AllPartyOpenSettlement_orig]
	(
		@StatusId Varchar(15),
		@StatusName Varchar(25),
		@dematid varchar(2),
		@settno varchar(7),
		@settype varchar(3),
		@frompartycode varchar(20),
		@topartycode varchar(20),
		@cl_type varchar(3) = 'NBF',
		@ExchSegment varchar(20)
	)
AS

If @ExchSegment = 'NSECM'
Begin	
	
	select 
		d.sett_no,
		d.sett_type,
		d.party_code,
		c1.short_name,
		d.Scrip_cd,
		d.Series,
		s1.short_name as scrip_name,
		d.inout,
		d.Qty,
		RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),
		GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),
		c1.cl_type
	from 
		angeldemat.msajag.dbo.client1 c1,
		angeldemat.msajag.dbo.client2 c2,

		angeldemat.msajag.dbo.scrip1 s1,
		angeldemat.msajag.dbo.scrip2 s2,


		(
			select top 6
				s.sett_no,
				s.sett_type
			from
				AngelNseCM.msajag.dbo.sett_mst s,
				AngelNseCM.msajag.dbo.details d
			where
				s.sett_no = d.sett_no and
				s.sett_type = d.sett_type and
				s.sec_payout >= getdate() /*dateadd(dd, 0, getdate()) */ and
				s.start_date <= getdate() /*dateadd(dd, 0, getdate()) */ and
				s.sett_type not like 'A%'
			order by 
				s.sett_no desc,
				s.sett_type
		) s,

		angeldemat.msajag.dbo.deliveryclt d
			Left Outer Join 
		angeldemat.msajag.dbo.DelTrans De
			On 
			( 
				De.Sett_no = D.Sett_No And 
				D.sett_Type = De.SetT_Type and 
				D.Scrip_CD = De.Scrip_CD And 
				De.Party_Code = D.Party_Code And 
				De.Filler2 = 1 
				And De.Series = D.Series 
			) 
	where  
		d.party_code = c2.party_code and 
		c1.cl_code =c2.cl_code and 

		s1.co_code = s2.co_code and

		d.scrip_cd = s2.scrip_cd and
		d.series = s2.series and

		c1.cl_type = @cl_type and
		d.sett_no = s.sett_no and
		d.sett_type = s.sett_type

	group by 
		d.sett_no,
		d.sett_type,
		d.scrip_cd,
		d.series,
		s1.short_name,
		c1.short_name,
		d.party_code,
		d.inout,
		D.Qty,
		c1.cl_type
	Order By 
		d.sett_no,
		d.sett_type,
		d.scrip_cd,
		d.series
end

If @ExchSegment = 'BSECM'
Begin	

	select 
		d.sett_no,
		d.sett_type,
		d.party_code,
		c1.short_name,
		d.Scrip_cd,
		d.Series,
		s1.short_name as scrip_name,
		d.inout,
		d.Qty,
		RecQty = Case When d.Sett_Type = 'C' And InOut = 'O' Then 0 Else Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)) End,
		GivenQty = Case When d.Sett_Type = 'C' And InOut = 'I' Then Sum((Case When DrCr = 'D' And Reason Like 'EXC%' Then IsNull(De.Qty,0) Else 0 End)) Else Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)) end
	from 
		angeldemat.bsedb.dbo.client1 c1,
		angeldemat.bsedb.dbo.client2 c2, 
	
		angeldemat.bsedb.dbo.scrip1 s1,
		angeldemat.bsedb.dbo.scrip2 s2,
	
		(
			select top 6
				s.sett_no,
				s.sett_type
			from
				AngelBSECM.bsedb_ab.dbo.sett_mst s,
				AngelBSECM.bsedb_ab.dbo.details d
			where
				s.sett_no = d.sett_no and
				s.sett_type = d.sett_type and
				s.sec_payout >= getdate() /*dateadd(dd, -5, getdate()) */ and
				s.start_date <= getdate() /*dateadd(dd, -5, getdate()) */ and
				s.sett_type not like 'A%'
			order by 
				s.sett_no desc,
				s.sett_type
		) s,
	
		angeldemat.bsedb.dbo.deliveryclt d
		  Left Outer Join 
		angeldemat.bsedb.dbo.DelTrans De
			On 
			( 
				De.Sett_no = D.Sett_No And 
				D.sett_Type = De.SetT_Type and 
				D.Scrip_CD = De.Scrip_CD And 
				De.Party_Code = D.Party_Code And 
				De.Filler2 = 1 And 
				De.Series = D.Series 
			) 
	 where 
		d.party_code = c2.party_code and 
		c1.cl_code =c2.cl_code and
	
		s1.co_code = s2.co_code and
	
		d.scrip_cd = s2.bsecode and
		d.series = s2.series and
	
		c1.cl_type = @cl_type and
		d.sett_no = s.sett_no and
		d.sett_type = s.sett_type
	
	group by 
		d.sett_no,
		d.sett_type,
		d.scrip_cd,
		d.series,
		s1.short_name,
		c1.short_name,
		d.party_code,
		d.inout,
		s2.scrip_cd,
		D.Qty
	
	UNION ALL
	
	select 
		d.sett_no,
		d.sett_type,
		d.party_code,
		c1.short_name,
		d.Scrip_cd,
		d.Series,
		s1.short_name as scrip_name,
		inout='I',
		Qty=0,
		RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),
		GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End))
	from 
		angeldemat.bsedb.dbo.client1 c1,
		angeldemat.bsedb.dbo.client2 c2,
	
		angeldemat.bsedb.dbo.scrip1 s1,
		angeldemat.bsedb.dbo.scrip2 s2,
	
		(
			select distinct top 6
				s.sett_no,
				s.sett_type
			from
				AngelBSECM.bsedb_ab.dbo.sett_mst s,
				AngelBSECM.bsedb_ab.dbo.details d
			where
				s.sett_no = d.sett_no and
				s.sett_type = d.sett_type and
				s.sec_payout >= getdate() /*dateadd(dd, -5, getdate())*/ and
				s.start_date <= getdate() /*dateadd(dd, -5, getdate()) */ and
				s.sett_type not like 'A%'
			order by 
				s.sett_no desc,
				s.sett_type
		) s,
	
		angeldemat.bsedb.dbo.DelTrans D
	where 
		d.party_code = c2.party_code and 
		c1.cl_code =c2.cl_code and
	
		s1.co_code = s2.co_code and
	
		d.scrip_cd = s2.bsecode and
		d.series = s2.series and
	
		c1.cl_type = @cl_type and
		d.sett_no = s.sett_no and
		d.sett_type = s.sett_type and
	
		Filler2 = 1 And 
		d.Party_code Not In 
		( 
			Select 
				Party_Code 
			From 
				angeldemat.bsedb.dbo.deliveryclt De 
			Where 
				De.Sett_no = D.Sett_No And 
				D.sett_Type = De.SetT_Type and 
				D.Scrip_CD = De.Scrip_CD And 
				De.Party_Code = D.Party_Code And 
				De.Series = D.Series 
		)
	
	group by 
		d.sett_no,
		d.sett_type,
		d.scrip_cd,
		d.series,
		s1.short_name,
		c1.short_name,
		d.party_code,
		S2.Scrip_cd
	
	Order By 

		d.sett_no,
		d.sett_type,
		d.Scrip_cd,
		d.Series/*,
		s1.short_name,
		d.party_code,
		c1.short_name*/

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AngelClientsYield
-- --------------------------------------------------
/*
exec sp_AngelClientsYield '4 May 2005'
*/

CREATE PROC
	sp_AngelClientsYield
	(
		@dtDate varchar(35)
	)
AS
BEGIN
	SELECT 
		[Avg Daily Vol] = SUM(TP+DP+TS+DS),
		[Net Brok Yield %] = SUM(TPB+DPB+TSB+DSB)/ SUM(CASE WHEN TP+DP+TS+DS=0 THEN 1 ELSE TP+DP+TS+DS END)
	FROM
		Level1mis L1
	WHERE
		Sauda_Date = Cast( @dtDate + ' 23:59:00' As datetime)
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_CFD
-- --------------------------------------------------
CREATE procedure sp_CFD            
as            
  
/*            
truncate table Client_First_Date             
insert into Client_First_Date             
--select party_Code,First_trade_date=FirstTrade from mimansa.angelcs.dbo.angelclient1          
select party_Code,First_trade_date=min(sauda_date) from mis_to            
group by party_code       
*/  
exec CFD  
declare @dt as varchar(11)
select @dt=max(sauda_date) from mis.remisior.dbo.comb_co with (nolock) where brok_earned<>0

select party_code,first_trade_date=min(sauda_date)         into #ff
from ebroking.dbo.Vw_mis_to_ebroking
where sauda_date>=@dt group by party_code

insert into first_Etrade_date
select * from #ff a where not exists
(
select party_Code from first_Etrade_date b (nolock) where a.party_code=b.party_code collate SQL_Latin1_General_CP1_CI_AS
)

/*
from mis_ebroking_cli        
where user_stat='e-broking' and turnover>0        
delete from first_Etrade_date where first_trade_date>='Jan 01 2011'
*/
           
           
/*      
select party_Code,First_trade_date=FirstTrade from mimansa.angelcs.dbo.angelclient1          
where party_code='A30453'      
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ChangeDetails
-- --------------------------------------------------
CREATE Procedure sp_ChangeDetails
	(
		@UserName Varchar(25),
		@NewPWD Varchar(25),
		@FirstName Varchar(25),
		@MiddleName Varchar(25),
		@LastName Varchar(25)
	)
As
	/*
		Created By : Hemant Chandurkar
		On : 04 May 2005
		hemant@angelbroking.com
	*/
Begin

	Declare @err bigint
		Set @err=0

		Begin Transaction

		-- Update tbl_common_login table
		Update tbl_common_login Set cmn_usr_pwd = RTrim(LTrim(@NewPWD)), first_name = RTrim(LTrim(@FirstName)),
			middle_name = RTrim(LTrim(@MiddleName)), last_name = RTrim(LTrim(@LastName))
		Where cmn_usr_name = Rtrim(LTrim(@UserName))

		Set @err = @err + Abs(@@Error)
		
		-- Now update tbl_common_login_bo table (for Password)
		Update tbl_common_login_bo Set bo_usr_pwd = RTrim(LTrim(@NewPWD))
			Where cmn_usr_name = Rtrim(LTrim(@UserName)) 
			And bo_usr_name = Rtrim(LTrim(@UserName))

		Set @err = @err + Abs(@@Error)

		if @err = 0
		begin
			Commit Transaction
		end
		else 
		begin
			rollback tran
		end
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_chk_exists_ExecName
-- --------------------------------------------------


CREATE PROC
	sp_chk_exists_ExecName
	(
		@strExecName varchar(100)
	)
AS
Begin
	set @strExecName = upper(ltrim(rtrim(@strExecName)))

	select 
		count(ExecName)
	from
		tblMarketExecRegionMaster
	where
		ExecName = @strExecName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_chk_exists_FieldExecName
-- --------------------------------------------------


CREATE PROC
	sp_chk_exists_FieldExecName
	(
		@strFieldExecName varchar(100)
	)
AS
Begin
	set @strFieldExecName = upper(ltrim(rtrim(@strFieldExecName)))

	select 
		count(FieldExecName)
	from
		tblMarketExecFieldMaster
	where
		FieldExecName = @strFieldExecName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_chk_exists_MarketHead
-- --------------------------------------------------


CREATE PROC
	sp_chk_exists_MarketHead
	(
		@strMarketHeadName varchar(100)
	)
AS
Begin
	set @strMarketHeadName = upper(ltrim(rtrim(@strMarketHeadName)))

	select 
		count(MarketHeadName)
	from
		tblMarketHeadMaster
	where
		MarketHeadName = @strMarketHeadName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_chkbouser
-- --------------------------------------------------
CREATE
proc
sp_chkbouser
	(
		@strServerName varchar(20),
		@strDBName varchar(20),
		@strUserName varchar(50)
	)
as
	declare
		@strSQL varchar(1000)

	set @strServerName = upper(ltrim(rtrim(@strServerName)))
	set @strDBName = upper(ltrim(rtrim(@strDBName)))
	set @strUserName = upper(ltrim(rtrim(@strUserName)))

	set @strSQL = ''
	set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
	set @strSQL = @strSQL + 'select '
	set @strSQL = @strSQL + '	top 1 fldusername '
	set @strSQL = @strSQL + 'from '
	set @strSQL = @strSQL + @strServerName + '.' + @strDBName + '.dbo.tblpradnyausers '
	set @strSQL = @strSQL + 'where '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(fldusername))) = ''' + @strUserName + ''' '

/*print (@strSQL)*/
exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_chkcommonuser
-- --------------------------------------------------
CREATE
proc
sp_chkcommonuser
	(
		@strServerName varchar(20),
		@strDBName varchar(20),
		@strUserName varchar(50),
		@strUserPwd varchar(50),
		@WhatToChk varchar(1)
	)
as
	declare
		@strSQL varchar(1000)

	set @strServerName = upper(ltrim(rtrim(@strServerName)))
	set @strDBName = upper(ltrim(rtrim(@strDBName)))
	set @strUserName = upper(ltrim(rtrim(@strUserName)))
	set @strUserPwd = upper(ltrim(rtrim(@strUserPwd)))
	set @WhatToChk = upper(ltrim(rtrim(@WhatToChk)))

	set @strSQL = ''
	set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
	set @strSQL = @strSQL + 'select '

	set @strSQL = @strSQL + '	top 1 cmn_usr_name '

	if @WhatToChk = 'P'
	begin
		set @strSQL = @strSQL + '	, cmn_usr_pwd '
	end

	set @strSQL = @strSQL + 'from '
	set @strSQL = @strSQL + @strServerName + '.' + @strDBName + '.dbo.tbl_common_login '
	set @strSQL = @strSQL + 'where '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(cmn_usr_name))) = ''' + @strUserName + ''' '

	if @WhatToChk = 'P'
	begin
		set @strSQL = @strSQL + '	and upper(ltrim(rtrim(cmn_usr_pwd))) = ''' + @strUserPwd + ''' '
	end

/*print (@strSQL)*/
exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_chkcommonuser_bo
-- --------------------------------------------------
CREATE
proc
sp_chkcommonuser_bo
	(
		@strServerName varchar(20),
		@strDBName varchar(20),
		@strUserName varchar(50), 
		@strUserPwd varchar(50),
		@WhatToChk varchar(1)
	)
as
	declare
		@strSQL varchar(1000)

	set @strServerName = upper(ltrim(rtrim(@strServerName)))
	set @strDBName = upper(ltrim(rtrim(@strDBName)))
	set @strUserName = upper(ltrim(rtrim(@strUserName)))
	set @strUserPwd = upper(ltrim(rtrim(@strUserPwd)))
	set @WhatToChk = upper(ltrim(rtrim(@WhatToChk)))

	set @strSQL = ''
	set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
	set @strSQL = @strSQL + 'select '

	set @strSQL = @strSQL + '	bo_usr_name '

	if @WhatToChk = 'P'
	begin
		set @strSQL = @strSQL + '	, bo_usr_pwd, exchseg '
	end

	set @strSQL = @strSQL + 'from '
	set @strSQL = @strSQL + @strServerName + '.' + @strDBName + '.dbo.tbl_common_login_bo '
	set @strSQL = @strSQL + 'where '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(bo_usr_name))) = ''' + @strUserName + ''' '

	if @WhatToChk = 'P'
	begin
		set @strSQL = @strSQL + '	and upper(ltrim(rtrim(bo_usr_pwd))) = ''' + @strUserPwd + ''' '
	end

/*print (@strSQL)*/
exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_chkRmCmnUsr
-- --------------------------------------------------
CREATE Procedure sp_chkRmCmnUsr(@UserName Varchar(25))
as
Begin
	Select * from risk.dbo.loginuser Where fldpartycode = Rtrim(Ltrim(@UserName))
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Client_grade
-- --------------------------------------------------



CREATE Procedure [dbo].[sp_Client_grade]    
as    
-- NOTE : The Client Grading is based on the Concept of HNI module    
/*    
> 75,000 - A++    
50,000 to 75,000 - A+    
25,000 to 50,000 - A    
15,000 to 25,000 - B+    
5,000 to 15,000 - B    
< 5,000 - C    
*/    
set nocount on    
declare @curDate as datetime    
--set @curdate = 'Nov 30 2006'    
set @curdate = getdate()    
--select convert(datetime,convert(varchar(2),datepart(mm,@curdate))+'/01/'+convert(varchar(4),datepart(year,@curdate)))    
    insert into QueryTimeTest values('hit 1')
set transaction isolation level read uncommitted    
select TmonthNo=datepart(mm,sauda_Date),TMonth=datename(mm,sauda_DAte),TYear=datename(yyyy,sauda_DAte),    
Party_code,Party_name=SPACE(100),Turnover=sum(turnover),Brokerage=Sum(Brokerage)    
into #file1    
from mis_to (nolock)    
where    
datepart(mm,sauda_DAte) >= datepart(month,convert(varchar(10), dateadd(day, -day(@curdate) + 1, dateadd(month, -3, @curdate)), 101))    
and    
datepart(yy,sauda_DAte) >= datepart(year,convert(varchar(10), dateadd(day, -day(@curdate) + 1, dateadd(month, -3, @curdate)), 101))    
and    
datepart(mm,sauda_DAte) < convert(datetime,convert(varchar(2),datepart(mm,@curdate))+'/01/'+convert(varchar(4),datepart(year,@curdate)))    
group by datepart(mm,sauda_Date),    
datename(mm,sauda_DAte),    
datename(yyyy,sauda_DAte),    
party_Code    
    insert into QueryTimeTest values('hit 2')
    
set transaction isolation level read uncommitted    
select party_code,party_name,Avg_brok=sum(brokerage)/3,grade=space(5)     
into #file2 from #file1     
group by Party_Code,party_name    
    insert into QueryTimeTest values('hit 3')
update #file2 set grade=    
case    
when Avg_brok >= 75000 then 'A++'    
when Avg_brok >= 50000 and Avg_brok < 75000 then 'A+'    
when Avg_brok >= 25000 and Avg_brok < 50000 then 'A'    
when Avg_brok >= 15000 and Avg_brok < 25000 then 'B+'    
when Avg_brok >= 5000 and Avg_brok < 15000 then 'B'    
when Avg_brok >= 0.01 and Avg_brok < 5000 then 'C'    
else 'D'    
end    
    insert into QueryTimeTest values('hit 4')
set transaction isolation level read uncommitted    
select TmonthNo=datepart(mm,sauda_Date),TMonth=datename(mm,sauda_DAte),TYear=datename(yyyy,sauda_DAte),    
Party_code,Party_name=SPACE(100),Turnover=sum(turnover),Brokerage=Sum(Brokerage)    
into #file3    
from mis_to (nolock)    
where datepart(mm,sauda_DAte) = datepart(mm,@curdate)    
and datepart(yyyy,sauda_DAte) = datepart(yyyy,@curdate)    
group by datepart(mm,sauda_Date),    
datename(mm,sauda_DAte),datename(yyyy,sauda_DAte),    
party_Code    
    insert into QueryTimeTest values('hit 5')
select    
party_code=isnull(a.party_code,b.party_code),    
party_name=SPACE(100),    
TmonthNo=isnull(TmonthNo,datepart(mm,@curdate)),    
Tmonth=isnull(Tmonth,datename(mm,@curdate)),    
TYear=isnull(TYear,datepart(yyyy,@curdate)),    
Turnover=isnull(Turnover,0),    
Brokerage=isnull(Brokerage,0),    
grade=isnull(grade,'C'),    
Status=(case when grade is null then 'New' else '' end)    
into #temp_file    
from #file2 a     
full outer join #file3 b    
on a.party_code=b.party_code    
    insert into QueryTimeTest values('hit 6')
SELECT CL_CODE, INACTIVE_FROM=MAX(INACTIVE_FROM)    
INTO #TEMP_CL    
FROM risk.dbo.client_brok_details a (NOLOCK)    
GROUP BY CL_CODE    
    insert into QueryTimeTest values('hit 7')



	create index party on #temp_file (party_code)

create index party on #TEMP_CL (CL_CODE,INACTIVE_FROM)



insert into #temp_file    
select PARTY_cODE=a.party_code collate Latin1_General_CI_AS,party_name=SPACE(100),    
TmonthNo=datepart(mm,@curdate),    
Tmonth=datename(mm,@curdate),    
TYear=datepart(yyyy,@curdate),    
Turnover=0,brokerage=0,grade='D',''    
from risk.dbo.client_details a (NOLOCK), #TEMP_CL b     
where a.cl_code=b.cl_code and b.inactive_from > @curdate    
and party_code collate Latin1_General_CI_AS not in (select party_code from #temp_file)    
AND A.PARTY_cODE <> ''    
    insert into QueryTimeTest values('hit 8')
UPDATE #temp_file SET PARTY_NAME = B.LONG_NAME FROM RISK.DBO.CLIENT_DETAILS B (NOLOCK)    
WHERE #temp_file.PARTY_CODE=B.PARTY_CODE COLLATE Latin1_General_CI_AS    
    
  insert into QueryTimeTest values('hit 9')
--delete from MIS_Client_grade where TmonthNo = datepart(mm,@curdate) and TYear=datepart(yyyy,@curdate)  --comment on 07122018,vinod  
exec MIS_Client_grade_batch ---alternative delete for above,07122018  
    
---insert into MIS_Client_grade select *,grade_no=0 from #temp_file    
    insert into QueryTimeTest values('hit 10')
insert into MIS_Client_grade select *,grade_no=case    
when grade='A++' then 7    
when grade='A+' then 6    
when grade='A' then 5    
when grade='B+' then 4    
when grade='B' then 3    
when grade='C' then 2    
when grade='D' then 1    
else 0 end from #temp_file    
insert into QueryTimeTest values('complete')
--update MIS_Client_grade set grade_no=7 where grade='A++'    
--update MIS_Client_grade set grade_no=6 where grade='A+'    
--update MIS_Client_grade set grade_no=5 where grade='A'    
--update MIS_Client_grade set grade_no=4 where grade='B+'    
--update MIS_Client_grade set grade_no=3 where grade='B'    
--update MIS_Client_grade set grade_no=2 where grade='C'    
--update MIS_Client_grade set grade_no=1 where grade='D'    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ClientBrokScheme
-- --------------------------------------------------
CREATE PROCEDURE
	[dbo].[sp_ClientBrokScheme]
	(
		@branch_code varchar(10)
	)
AS

set @branch_code = ltrim(rtrim(upper(@branch_code)))

BEGIN
	/* FOR NSE */
	
	select 
		ExchSeg = 'NSECM',
		branch_code = br.branch_code,
		branch = br.Branch,
		party_code = cbs.party_code,
		party_name = cl1.short_name,
		scheme_id,
		scheme_type,
		table_no,
		scrip_cd,
		trade_type,
		brokscheme,
		from_date = Convert(varchar(11), from_date, 109),
		to_date	= Convert(varchar(11), to_date, 109)
	from 
		AngelNseCM.msajag.dbo.clientbrok_scheme cbs,
		AngelNseCM.msajag.dbo.client1 cl1,
		AngelNseCM.msajag.dbo.branch br
	where 
		cbs.party_code = cl1.cl_code and
		cl1.branch_cd = br.branch_code and
		from_date like convert(varchar(11), getdate(), 109) + '%' and
		branch_code = @branch_code
	/* order by
		branch_code, party_code, scheme_id */

	UNION ALL

	/* BSE */
	select 
		ExchSeg = 'BSECM',
		branch_code = br.branch_code,
		branch = br.Branch,
		party_code = cbs.party_code,
		party_name = cl1.short_name,
		scheme_id,
		scheme_type,
		table_no,
		scrip_cd,
		trade_type,
		brokscheme,
		from_date = Convert(varchar(11), from_date, 109),
		to_date	= Convert(varchar(11), to_date, 109)
	from 
		AngelBSECM.bsedb_ab.dbo.clientbrok_scheme cbs,
		AngelBSECM.bsedb_ab.dbo.client1 cl1,
		AngelBSECM.bsedb_ab.dbo.branch br
	where 
		cbs.party_code = cl1.cl_code and
		cl1.branch_cd = br.branch_code and
		from_date like convert(varchar(11), getdate(), 109) + '%' and
		branch_code = @branch_code
	order by
		ExchSeg, party_code, scheme_id
END

--exec sp_ClientBrokScheme 'ya'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ClientBrokScheme1
-- --------------------------------------------------
CREATE PROCEDURE
	[dbo].[sp_ClientBrokScheme1]
	(
		@branch_code varchar(10)
	)
AS

set @branch_code = ltrim(rtrim(upper(@branch_code)))

BEGIN
	/* FOR NSE */
	-- For New Entry
	select 
		NewOrEdited = 'N',
		ExchSeg = 'NSECM',
		branch_code = br.branch_code,
		branch = br.Branch,
		party_code = cbs.party_code,
		party_name = cl1.short_name,
		scheme_id,
		scheme_type,
		table_no,
		scrip_cd,
		trade_type,
		brokscheme,
		from_date = Convert(varchar(11), from_date, 109),
		to_date	= Convert(varchar(11), to_date, 109)
	from 
		AngelNseCM.msajag.dbo.clientbrok_scheme cbs,
		AngelNseCM.msajag.dbo.client1 cl1,
		AngelNseCM.msajag.dbo.branch br
	where 
		cbs.party_code = cl1.cl_code and
		cl1.branch_cd = br.branch_code and
		branch_code = @branch_code and
		left(from_date, 11) = left(convert(datetime, getdate()), 11) and
		left(to_date, 11) = 'Dec 31 2049'

	UNION ALL

	-- For Edited Entry
	select 
		NewOrEdited = 'E',
		ExchSeg = 'NSECM',
		branch_code = br.branch_code,
		branch = br.Branch,
		party_code = cbs.party_code,
		party_name = cl1.short_name,
		scheme_id,
		scheme_type,
		table_no,
		scrip_cd,
		trade_type,
		brokscheme,
		from_date = Convert(varchar(11), from_date, 109),
		to_date	= Convert(varchar(11), to_date, 109)
	from 
		AngelNseCM.msajag.dbo.clientbrok_scheme cbs,
		AngelNseCM.msajag.dbo.client1 cl1,
		AngelNseCM.msajag.dbo.branch br
	where 
		cbs.party_code = cl1.cl_code and
		cl1.branch_cd = br.branch_code and
		branch_code = @branch_code and
		/*from_date like convert(varchar(11), getdate(), 109) + '%' and*/
		left(to_date, 11) = left(convert(datetime, getdate()-1), 11)


	UNION ALL

	/* BSE */
	-- For New Entry
	select 
		NewOrEdited = 'N',
		ExchSeg = 'BSECM',
		branch_code = br.branch_code,
		branch = br.Branch,
		party_code = cbs.party_code,
		party_name = cl1.short_name,
		scheme_id,
		scheme_type,
		table_no,
		scrip_cd,
		trade_type,
		brokscheme,
		from_date = Convert(varchar(11), from_date, 109),
		to_date	= Convert(varchar(11), to_date, 109)
	from 
		AngelBSECM.bsedb_ab.dbo.clientbrok_scheme cbs,
		AngelBSECM.bsedb_ab.dbo.client1 cl1,
		AngelBSECM.bsedb_ab.dbo.branch br
	where 
		cbs.party_code = cl1.cl_code and
		cl1.branch_cd = br.branch_code and
		branch_code = @branch_code and
		left(from_date, 11) = left(convert(datetime, getdate()), 11) and
		left(to_date, 11) = 'Dec 31 2049'
	--order by
		--ExchSeg, party_code, scheme_id

	UNION ALL

	-- For Edited Entry
	select 
		NewOrEdited = 'E',
		ExchSeg = 'BSECM',
		branch_code = br.branch_code,
		branch = br.Branch,
		party_code = cbs.party_code,
		party_name = cl1.short_name,
		scheme_id,
		scheme_type,
		table_no,
		scrip_cd,
		trade_type,
		brokscheme,
		from_date = Convert(varchar(11), from_date, 109),
		to_date	= Convert(varchar(11), to_date, 109)
	from 
		AngelBSECM.bsedb_ab.dbo.clientbrok_scheme cbs,
		AngelBSECM.bsedb_ab.dbo.client1 cl1,
		AngelBSECM.bsedb_ab.dbo.branch br
	where 
		cbs.party_code = cl1.cl_code and
		cl1.branch_cd = br.branch_code and
		branch_code = @branch_code and
		/*from_date like convert(varchar(11), getdate(), 109) + '%' and*/
		left(to_date, 11) = left(convert(datetime, getdate()-1), 11)
	order by
		ExchSeg, party_code, scheme_id
END

--exec sp_ClientBrokScheme1 'acm'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_CrossTab
-- --------------------------------------------------
CREATE PROC Sp_CrossTab
  @TableName AS sysname,
  @DistinctRow AS nvarchar(300),
  @PivotColumn AS nvarchar(128),
  @PivotData AS nvarchar(128) 
AS
/* This Procedure works with SQL2000 and SQL Server 7.0 */

-- sp_crosstab 'CMBILLVALAN','Branch_code','YEAR(Sauda_date) + month(sauda_date)','Brokerage'

DECLARE  @SQLStr varchar(8000), @COL VARCHAR(255)
CREATE TABLE #SCTTable (PIV_COLS VARCHAR(255))
INSERT INTO #SCTTable
 EXEC ('SELECT DISTINCT ' + @PivotColumn + ' FROM ' + @TableName)

SELECT @SQLStr = 'SELECT DISTINCT ' + @DistinctRow
SELECT @COL = MIN(PIV_COLS) FROM #SCTTable

  WHILE @COL <= (SELECT MAX(PIV_COLS) FROM #SCTTable)
   BEGIN
           SET @SQLStr = @SQLStr + ' , CASE WHEN (SELECT ' +  @PivotData +
                           ' FROM ' +  @TableName  + ' t2
                           WHERE  t2.' +  @DistinctRow  + ' =  t1.' +  @DistinctRow  + '
                          AND  CAST(' + @PivotColumn + ' as VARCHAR) =  ''' + cast(@COL AS
                            VARCHAR(255)) + ''' ) IS NULL THEN CHAR(32) ELSE ' + @PivotData + ' END AS '
                             + @PivotColumn + '_' + REPLACE(REPLACE(REPLACE(cast(@COL AS
                             NVARCHAR),'.','_'),CHAR(32),'_'),':','') + '_' + @PivotData
                            SELECT @COL = MIN(PIV_COLS) FROM #SCTTable WHERE PIV_COLS > @COL
   END 
SET @SQLStr = @SQLStr +  ' FROM ' + @tablename + ' t1'
PRINT @SQLStr --for DEBUGGING
--EXEC (@SQLStr)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_daily_updatestats
-- --------------------------------------------------
CREATE
proc
	[dbo].[sp_daily_updatestats]
as
	exec AngelBSECM.bsedb_ab.dbo.sp_updatestats

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_deleteexisting_MarketExecField
-- --------------------------------------------------


CREATE PROC
	sp_deleteexisting_MarketExecField
	(
		@intMarketExecFieldId bigint
	)
AS
Begin
	begin tran
	
	update
		tblMarketExecFieldMaster
	set
		Deleted = 'Y'
	where
		MarketExecFieldId = @intMarketExecFieldId

	if @@error = 0 commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_deleteexisting_MarketExecRegion
-- --------------------------------------------------


CREATE PROC
	sp_deleteexisting_MarketExecRegion
	(
		@intMarketExecRegionId bigint
	)
AS
Begin
	begin tran
	
	update
		tblMarketExecRegionMaster
	set
		Deleted = 'Y'
	where
		MarketExecRegionId = @intMarketExecRegionId

	if @@error = 0 commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_deleteexisting_MarketHead
-- --------------------------------------------------


CREATE PROC
	sp_deleteexisting_MarketHead
	(
		@intMarketHeadId bigint
	)
AS
Begin
	begin tran
	
	update
		tblMarketHeadMaster
	set
		Deleted = 'Y'
	where
		MarketHeadId = @intMarketHeadId

	if @@error = 0 commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_deleteexisting_MarketWorkDone
-- --------------------------------------------------


CREATE PROC
	sp_deleteexisting_MarketWorkDone
	(
		@intMarketWorkDoneId bigint
	)
AS
Begin
	begin tran
	
	update
		tblMarketWorkDoneMaster
	set
		Deleted = 'Y'
	where
		MarketWorkDoneId = @intMarketWorkDoneId

	if @@error = 0 commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_DeleteUser
-- --------------------------------------------------
CREATE Procedure sp_DeleteUser(@LoginName Varchar(25))
As
Begin
	Delete From 
		tbl_common_login_bo
	Where
		cmn_usr_name = @LoginName

	Delete From 
		tbl_common_login
	Where
		cmn_usr_name = @LoginName

	Delete From
		tbl_cmn_usr_rm
	Where
		cmn_usr_name = @LoginName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_dmat
-- --------------------------------------------------
create PROCEDURE SP_dmat (@CONAME AS VARCHAR(25), @BRCODE AS VARCHAR(25), @SBCODE AS VARCHAR(25))
AS

select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,
CL_NAME=SHORT_NAME COLLATE Latin1_General_CI_AS,
demat=(CASE WHEN UPPER(demat COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END) 
from kyc_documents where cl_code in (select distinct party_code from mis_to where branch_cd=@BRCODE and sub_broker=@SBCODE and company=@CONAME)
UNION
select distinct cl_code=party_code,CL_NAME=party_name,demat='NO'
from mis_to where sub_broker=@SBCODE and branch_cd=@BRCODE and company=@CONAME
and sauda_Date >=getdate()-365 AND 
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )
ORDER BY CL_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_dmat_ablcm
-- --------------------------------------------------
CREATE procedure [dbo].[SP_dmat_ablcm] (@fdate as datetime)
as
select cl_code=cl_code COLLATE Latin1_General_CI_AS,short_name=short_name COLLATE Latin1_General_CI_AS,demat=(CASE WHEN UPPER(demat COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)   from kyc_documents 
where cl_code COLLATE Latin1_General_CI_AS in
(
select distinct party_code from AngelBSECM.bsedb_ab.dbo.cmbillvalan where pqtydel>0 and sauda_date >= @fdate 
-- select distinct party_code from mis_to where branch_cd like @BRCODE and sub_broker like @SBCODE and company=@CONAME 
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_dmat_acdlcm
-- --------------------------------------------------

CREATE procedure [dbo].[SP_dmat_acdlcm] (@fdate as datetime)
as
select cl_code=cl_code COLLATE Latin1_General_CI_AS,short_name=short_name COLLATE Latin1_General_CI_AS,demat=(CASE WHEN UPPER(demat COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)   from kyc_documents 
where cl_code COLLATE Latin1_General_CI_AS in
(
select distinct party_code from AngelNseCM.msajag.dbo.cmbillvalan where pqtydel>0 and sauda_date >= @fdate
-- select distinct party_code from mis_to where branch_cd like @BRCODE and sub_broker like @SBCODE and company=@CONAME 
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ebrok_mngrwise
-- --------------------------------------------------
CREATE procedure sp_ebrok_mngrwise(@fdate as varchar(25),@tdate as varchar(25),@flag as varchar(5),@ODIN_SERVER AS VARCHAR(30),@BRANCH_CD AS VARCHAR(30))                
as                
                
set nocount on    
    
--drop table #cli79    
--drop table #mis    
    
select distinct brcode=space(10),sbcode=space(10),party_Code,odin_server,flag                                           
into #cli79                                           
from ctcl.dbo.client_mast79                                           
    
update #cli79 set brcode=b.branch_Cd,sbcode=b.sub_Broker from risk.dbo.client_details b                                          
where #cli79.party_code=b.party_Code     
                      
select * into #mis from MIS_ebroking_cli  where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like 'e-broking'         
    
--drop table #odinanywhere                    
    
select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='Anywhere',                                                      
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                           
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                               
into #odinanywhere                                                        
from  mis.testdb.dbo.tradeanywhere_master b left outer join  #mis a                                 
on a.party_code=b.client_code collate Latin1_General_CI_AS                                                
    
 --where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                              
group by a.party_Code,a.branch_cd,a.sub_Broker     
------------------------------------------------------    
    
    
    
--drop table #odin10s8    
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S8',                                                      
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                           
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                         
into #odin10s8                                                         
from   #cli79 b left outer join #mis a                                                       
on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode                          
odin_server='ODIN710S8'                                                       
and a.party_code not in (select party_Code from #odinanywhere where isnull(party_code,'')<>'')                               
group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server       
    
----------------------------------------------------------------    
--drop table #odin10s8_any    
--drop table #odin10s7    
    
 select * into #odin10s8_any                              
    
 from                              
    
 (                             
    
 select party_Code from #odin10s8 union select party_Code from #odinanywhere                                     
    
 ) a             
    
    
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S7',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                           
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                         
    
 into #odin10s7                                                         
    
 from   #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode                          
    
 odin_server='ODIN710S7'                                                       
    
 and a.party_code not in (select party_Code from #odinanywhere where isnull(party_code,'')<>'')                               
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server        
    
---------------------------------------------------------------------------------------------      
    
--drop table #odin10s6    
--drop table #odin10s7_any     
    
select * into #odin10s7_any                               
    
 from                              
    
 (                             
    
 select party_Code from #odin10s7 union select party_Code from #odin10s8_any                                     
    
 ) a            
    
            
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S6',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                           
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                         
    
 into #odin10s6                                                         
    
 from   #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode                          
    
 odin_server='ODIN710S6'                                                       
    
 and a.party_code not in (select party_Code from #odin10s7_any where isnull(party_code,'')<>'')                               
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server          
    
----------------------------------------------------------------------      
--drop table #odin10s5    
--drop table #odin10s6_any    
    
    
select * into #odin10s6_any                               
    
 from                              
    
 (                              
    
 select party_Code from #odin10s6 union select party_Code from #odin10s7_any                                     
    
 ) a               
    
               
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S5',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                           
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                         
    
 into #odin10s5                                                         
    
 from   #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode                          
    
 odin_server='ODIN710S5'                                                       
    
 and a.party_code not in (select party_Code from #odin10s6_any where isnull(party_code,'')<>'')                               
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server       
---------------------------------------------------------------------    
    
--drop table #odin10s4    
--drop table #odin10s5_any    
    
select * into #odin10s5_any                               
    
 from                              
    
 (                              
    
 select party_Code from #odin10s5 union select party_Code from #odin10s6_any                                     
    
 ) a               
    
                  
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S4',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                           
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                  
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                         
    
 into #odin10s4                                                         
    
 from   #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode           
    
 odin_server='ODIN710S4'                                                       
    
 and a.party_code not in (select party_Code from #odin10s5_any where isnull(party_code,'')<>'')                               
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server      
    
---------------------------------------------------------------    
            
--drop table #odin10s3    
--drop table #odin10s4_any           
    
    
select * into #odin10s4_any                               
   from                              
    
 (                              
    
 select party_Code from #odin10s4 union select party_Code from #odin10s5_any                                     
    
 ) a                    
    
                         
    
                  
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S3',                    
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                        mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                      
  
    
    
                    
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                         
    
 into #odin10s3                                                         
    
 from   #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode                          
    
 odin_server='ODIN710S3'                                                       
    
 and a.party_code not in (select party_Code from #odin10s4_any where isnull(party_code,'')<>'')                               
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server        
------------------------------------------------------------------    
    
--drop table #odin10s2    
--drop table #odin10s3_any        
    
select * into #odin10s3_any                               
    
 from                              
    
 (                              
    
 select party_Code from #odin10s3 union select party_Code from #odin10s4_any                                     
    
 ) a                    
    
                           
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S2',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                 
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                           
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                         
    
 into #odin10s2                                                         
    
 from   #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode                          
    
 odin_server='ODIN710S2'                                                       
    
 and a.party_code not in (select party_Code from #odin10s3_any where isnull(party_code,'')<>'')                               
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server            
-------------------------------------    
    
    
select * into #odin10s2_any                               
    
 from                              
    
 (                              
    
 select party_Code from #odin10s2 union select party_Code from #odin10s3_any                                     
    
 ) a                          
    
                             
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S1',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)      
    
into #odin10s1                                                
    
 from   #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and                          
    
 odin_server='ODIN710S1'                                                       
    
 and a.party_code not in (select party_Code from #odin10s2_any where isnull(party_code,'')<>'')                                       
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server          
---------------------------------------    
          
    
select * into #10s1_10s2                               
    
 from                              
    
 (                              
    
 select party_Code from #odin10s2 union select party_Code from #odin10s2_any                                     
    
 ) a                              
    
                              
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s3',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                              
    
 into #odin79s3                                                 
    
 from  #cli79 b left outer join #mis a                                  
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                    
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
--and branch_Cd like @brcode and sub_Broker like @sbcode and                          
    
 odin_server='odin79s3'                              
    
 and a.party_code not in (select party_Code from #10s1_10s2 where isnull(party_code,'')<>'')                                               
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                 
    
---------------------------    
    
select * into #10s1_10s2_79s3                               
    
 from                              
    
 (                              
    
 select party_Code from #10s1_10s2 union select party_Code from #odin79s3                       
    
 )b                              
    
                              
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s2',                                                      
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                               
    
 into #odin79s2                                                       
    
 from  #cli79 b left outer join #mis a                                                       
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                             
    
--- and branch_Cd like @brcode and sub_Broker like @sbcode and                          
    
 odin_server='odin79s2'                               
    
 and a.party_code not in (select party_Code from #10s1_10s2_79s3 where isnull(party_code,'')<>'')                           
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                                 
----------------------------------------------------------    
    
 select * into #10s1_10s2_79s3_s2                         
    
 from                              
    
 (                              
    
 select party_Code from #10s1_10s2_79s3 union select party_Code from #odin79s2                                     
    
 )c                                                  
    
                                            
    
 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s1',                     
    
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                                
    
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                
    
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                          
    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                      
    
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                              
    
 into #odin79s1                                                          
    
 from  #cli79 b left outer join #mis a                                             
    
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                
    
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                
    
 --and branch_Cd like @brcode and sub_Broker like @sbcode  and                          
    
 odin_server='odin79'                                                          
    
 and a.party_code not in (select party_Code from #10s1_10s2_79s3_s2 where isnull(party_code,'')<>'')                              
    
 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server          
---------------------------------    
    
      
    
select * into #file1                              
    
 from                               
    
 (        
    
 select * from #odin10s8                
    
 union all              
    
 select * from #odin10s7                
    
 union all                
    
 select * from #odin10s6                
    
 union all             
    
 select * from #odin10s5                
    
 union all                
    
 select * from #odin10s4                
    
 union all                   
    
 select * from #odin10s3                
    
 union all                                            
    
 select * from #odin10s2          
    
 union all                              
    
 select * from #odin10s1                              
    
 union all                              
    
 select * from #odin79s3                               
    
 union all                              
    
 select * from #odin79s2                               
    
 union all                              
    
 select * from #odin79s1                               
    
 union all                              
    
 select * from #odinanywhere                              
    
 )a            
DROP TABLE mngrwise    
select * into mngrwise from #file1    
    
DROP TABLE #FILE1    
drop table #cli79    
drop table #mis    
drop table #odinanywhere       
drop table #odin10s8    
drop table #odin10s8_any    
drop table #odin10s7    
    
drop table #odin10s6    
drop table #odin10s7_any     
drop table #odin10s5    
drop table #odin10s6_any    
drop table #odin10s4    
drop table #odin10s5_any    
drop table #odin10s3    
drop table #odin10s4_any    
    
drop table #odin10s2    
drop table #odin10s3_any    
drop table #odin10s1    
drop table #odin10s2_any     
drop table #10s1_10s2    
drop table #odin79s3       
drop table #10s1_10s2_79s3     
drop table #odin79s1    
drop table #10s1_10s2_79s3_s2     
drop table #odin79s2      
    
    
if @flag='SR'                
begin       
    
select distinct ODIN_SERVER=isnull(ODIN_SERVER,'** missing **'), ablcm_brk=sum(ablcm_brk), ablcm_to=sum(ablcm_to),    
acdlcm_brk=sum(acdlcm_brk),acdlcm_to=sum(acdlcm_to),acdlfo_brk=sum(acdlfo_brk),acdlfo_to=sum(acdlfo_to),    
mcx_brok=sum(mcx_brok),mcx_turn=sum(mcx_turn),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),    
brokerage=sum(brokerage),turnover=sum(turnover) from mngrwise    
group by odin_server 
order by odin_server    
    
end    
    
    
if @flag='BR'                
begin       
    
select distinct branch_cd,ablcm_brk=sum(ablcm_brk), ablcm_to=sum(ablcm_to),    
acdlcm_brk=sum(acdlcm_brk),acdlcm_to=sum(acdlcm_to),acdlfo_brk=sum(acdlfo_brk),acdlfo_to=sum(acdlfo_to),    
mcx_brok=sum(mcx_brok),mcx_turn=sum(mcx_turn),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),    
brokerage=sum(brokerage),turnover=sum(turnover) from mngrwise    
where odin_server=@odin_server  and branch_cd<>'NULL'   
group by branch_cd    
    
end    
  
if @flag='SB'                
begin       
    
  
select distinct SUB_BROKER,ablcm_brk=sum(ablcm_brk), ablcm_to=sum(ablcm_to),    
acdlcm_brk=sum(acdlcm_brk),acdlcm_to=sum(acdlcm_to),acdlfo_brk=sum(acdlfo_brk),acdlfo_to=sum(acdlfo_to),    
mcx_brok=sum(mcx_brok),mcx_turn=sum(mcx_turn),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),    
brokerage=sum(brokerage),turnover=sum(turnover) from mngrwise    
where odin_server=@odin_server  and branch_cd=@BRANCH_CD   
group by SUB_BROKER    
  
END  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ebrok_region
-- --------------------------------------------------
CREATE procedure sp_ebrok_region(@fdate as varchar(25),@tdate as varchar(25),@flag as varchar(5))            
as            
            
set nocount on

drop table #cli79
drop table #mis

select distinct brcode=space(10),sbcode=space(10),party_Code,odin_server,flag                                       
into #cli79                                       
from ctcl.dbo.client_mast79                                       

update #cli79 set brcode=b.branch_Cd,sbcode=b.sub_Broker from risk.dbo.client_details b                                      
where #cli79.party_code=b.party_Code 
                  
select * into #mis from MIS_ebroking_cli  where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like 'e-broking'     

drop table #odinanywhere                

select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='Anywhere',                                                  
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                       
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                            
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                           
into #odinanywhere                                                    
from  mis.testdb.dbo.tradeanywhere_master b left outer join  #mis a                             
on a.party_code=b.client_code collate Latin1_General_CI_AS                                            

 --where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                          
group by a.party_Code,a.branch_cd,a.sub_Broker 
------------------------------------------------------



drop table #odin10s8

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S8',                                                  
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                       
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  
active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     
into #odin10s8                                                     
from   #cli79 b left outer join #mis a                                                   
on a.party_code=b.party_code collate Latin1_General_CI_AS                                            
where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode                      
odin_server='ODIN710S8'                                                   
and a.party_code not in (select party_Code from #odinanywhere where isnull(party_code,'')<>'')                           
group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server   

----------------------------------------------------------------
drop table #odin10s8_any
drop table #odin10s7

 select * into #odin10s8_any                           

 from                          

 (                         

 select party_Code from #odin10s8 union select party_Code from #odinanywhere                                 

 ) a         



 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S7',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                       

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     

 into #odin10s7                                                     

 from   #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode                      

 odin_server='ODIN710S7'                                                   

 and a.party_code not in (select party_Code from #odinanywhere where isnull(party_code,'')<>'')                           

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server    

---------------------------------------------------------------------------------------------  

drop table #odin10s6
drop table #odin10s7_any 

select * into #odin10s7_any                           

 from                          

 (                         

 select party_Code from #odin10s7 union select party_Code from #odin10s8_any                                 

 ) a        

        

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S6',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                       

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     

 into #odin10s6                                                     

 from   #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode                      

 odin_server='ODIN710S6'                                                   

 and a.party_code not in (select party_Code from #odin10s7_any where isnull(party_code,'')<>'')                           

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server      

----------------------------------------------------------------------  
drop table #odin10s5
drop table #odin10s6_any


select * into #odin10s6_any                           

 from                          

 (                          

 select party_Code from #odin10s6 union select party_Code from #odin10s7_any                                 

 ) a           

           

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S5',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                       

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     

 into #odin10s5                                                     

 from   #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode                      

 odin_server='ODIN710S5'                                                   

 and a.party_code not in (select party_Code from #odin10s6_any where isnull(party_code,'')<>'')                           

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server   
---------------------------------------------------------------------

drop table #odin10s4
drop table #odin10s5_any

select * into #odin10s5_any                           

 from                          

 (                          

 select party_Code from #odin10s5 union select party_Code from #odin10s6_any                                 

 ) a           

              

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S4',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                       

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),              

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     

 into #odin10s4                                                     

 from   #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode                      

 odin_server='ODIN710S4'                                                   

 and a.party_code not in (select party_Code from #odin10s5_any where isnull(party_code,'')<>'')                           

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server  

---------------------------------------------------------------
        
drop table #odin10s3
drop table #odin10s4_any       


select * into #odin10s4_any                           

 from                          

 (                          

 select party_Code from #odin10s4 union select party_Code from #odin10s5_any                                 

 ) a                

                     

              

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S3',                

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                        mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                      

                

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     

 into #odin10s3                                                     

 from   #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode                      

 odin_server='ODIN710S3'                                                   

 and a.party_code not in (select party_Code from #odin10s4_any where isnull(party_code,'')<>'')                           

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server    
------------------------------------------------------------------

drop table #odin10s2
drop table #odin10s3_any    

select * into #odin10s3_any                           

 from                          

 (                          

 select party_Code from #odin10s3 union select party_Code from #odin10s4_any                                 

 ) a                

                       

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S2',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                             

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                       

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                     

 into #odin10s2                                                     

 from   #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                            

 --and branch_Cd like @brcode and sub_Broker like @sbcode                      

 odin_server='ODIN710S2'                                                   

 and a.party_code not in (select party_Code from #odin10s3_any where isnull(party_code,'')<>'')                           

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server        
-------------------------------------
drop table #odin10s1
drop table #odin10s2_any   

select * into #odin10s2_any                           

 from                          

 (                          

 select party_Code from #odin10s2 union select party_Code from #odin10s3_any                                 

 ) a                      

                         

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='ODIN7.10-S1',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                            

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)  

into #odin10s1                                            

 from   #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode  and                      

 odin_server='ODIN710S1'                                                   

 and a.party_code not in (select party_Code from #odin10s2_any where isnull(party_code,'')<>'')                                   

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server      
---------------------------------------
drop table #10s1_10s2
drop table #odin79s3       

select * into #10s1_10s2                           

 from                          

 (                          

 select party_Code from #odin10s2 union select party_Code from #odin10s2_any                                 

 ) a                          

                          

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s3',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                          

 into #odin79s3                                             

 from  #cli79 b left outer join #mis a                              

 on a.party_code=b.party_code collate Latin1_General_CI_AS                

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode and                      

 odin_server='odin79s3'                          

 and a.party_code not in (select party_Code from #10s1_10s2 where isnull(party_code,'')<>'')                                           

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server             

---------------------------

drop table #10s1_10s2_79s3 
drop table #odin79s2

select * into #10s1_10s2_79s3                           

 from                          

 (                          

 select party_Code from #10s1_10s2 union select party_Code from #odin79s3                   

 )b                          

                          

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s2',                                                  

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                            

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                           

 into #odin79s2                                                   

 from  #cli79 b left outer join #mis a                                                   

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

--- and branch_Cd like @brcode and sub_Broker like @sbcode and                      

 odin_server='odin79s2'                           

 and a.party_code not in (select party_Code from #10s1_10s2_79s3 where isnull(party_code,'')<>'')                       

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server                             
----------------------------------------------------------
    
drop table #10s1_10s2_79s3_s2 
drop table #odin79s1

 select * into #10s1_10s2_79s3_s2                     

 from                          

 (                          

 select party_Code from #10s1_10s2_79s3 union select party_Code from #odin79s2                                 

 )c                                              

                                        

 select distinct a.branch_cd,a.sub_Broker,a.party_code, odin_server='odin79-s1',                 

 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                            

 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                            

 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                      

 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                  

 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                          

 into #odin79s1                                                      

 from  #cli79 b left outer join #mis a                                         

 on a.party_code=b.party_code collate Latin1_General_CI_AS                                            

 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                         

 --and branch_Cd like @brcode and sub_Broker like @sbcode  and                      

 odin_server='odin79'                                                      

 and a.party_code not in (select party_Code from #10s1_10s2_79s3_s2 where isnull(party_code,'')<>'')                          

 group by a.party_Code,a.branch_cd,a.sub_Broker,odin_server      
---------------------------------

drop table #file1       

select * into #file1                          

 from                           

 (    

 select * from #odin10s8            

 union all          

 select * from #odin10s7            

 union all            

 select * from #odin10s6            

 union all         

 select * from #odin10s5            

 union all            

 select * from #odin10s4            

 union all               

 select * from #odin10s3            

 union all                                        

 select * from #odin10s2                          

 union all                          

 select * from #odin10s1                          

 union all                          

 select * from #odin79s3                           

 union all                          

 select * from #odin79s2                           

 union all                          

 select * from #odin79s1                           

 union all                          

 select * from #odinanywhere                          

 )a        

select * from #file1
if @flag='SR'            
begin   

select distinct odin_server, ablcm_brk=sum(ablcm_brk), ablcm_to=sum(ablcm_to),
acdlcm_brk=sum(acdlcm_brk),acdlcm_to=sum(acdlcm_to),acdlfo_brk=sum(acdlfo_brk),acdlfo_to=sum(acdlfo_to),
mcx_brok=sum(mcx_brok),mcx_turn=sum(mcx_turn),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),
brokerage=sum(brokerage),turnover=sum(turnover) from #file1
group by odin_server 

end
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ebrok_serverwise
-- --------------------------------------------------
CREATE procedure sp_ebrok_serverwise(@fdate as varchar(25),@tdate as varchar(25),@flag as varchar(5),@servermapped as varchar(40))
as                  
                  
set nocount on      
      
Select servermapped,terminal_id,segment 
into #term 
from mis.remisior.dbo.ebrok_terminal_master 
where to_date>=@fdate and from_date<=@tdate

if @flag='SM'                  
begin 

Set transaction isolation level read uncommitted 

select a.servermapped

,ABL_CM=ISNULL(sum(ABL_CM),0),ACDL_CM=sum(ACDL_CM),ACDL_FO=sum(ACDL_FO),ACPL_MCX=sum(ACPL_MCX),ACPL_NCDEX=sum(ACPL_NCDEX),

ABL_CM_to=sum(ABL_CM_to),ACDL_CM_to=sum(ACDL_CM_to),ACDL_FO_to=sum(ACDL_FO_to),ACPL_MCX_to=sum(ACPL_MCX_to),

ACPL_NCDEX_to=sum(ACPL_NCDEX_to) from #term a

left outer join

(select terminal_id,ABL_CM=sum(case when Company ='ABLCM' and 1=1 then Brokerage else 0 end)/1000, 

ACDL_CM=sum(case when Company ='ACDLCM' and 1=1 then Brokerage else 0 end)/1000, 

ACDL_FO=sum(case when Company ='ACDLFO' and 1=1 then Brokerage else 0 end)/1000, 

ACPL_MCX=sum(case when Company ='ACPLMCX' and 1=1 then Brokerage else 0 end)/1000, 

ACPL_NCDEX=sum(case when Company ='ACPLNCDEX' and 1=1 then Brokerage else 0 end)/1000,

ABL_CM_to=sum(case when Company ='ABLCM' and 1=1 then Turnover else 0 end)/1000, 

ACDL_CM_to=sum(case when Company ='ACDLCM' and 1=1 then Turnover else 0 end)/1000, 

ACDL_FO_to=sum(case when Company ='ACDLFO' and 1=1 then Turnover else 0 end)/1000, 

ACPL_MCX_to=sum(case when Company ='ACPLMCX' and 1=1 then Turnover else 0 end)/1000, 

ACPL_NCDEX_to=sum(case when Company ='ACPLNCDEX' and 1=1 then Turnover else 0 end)/1000  

from Mis_TO_Terminal_Detail (nolock) 

where sauda_Date >=@fdate and sauda_date <=@tdate group by terminal_id) b

on a.terminal_id=b.terminal_id

group by servermapped

 


END


if @flag='TI'                  
begin 

Set transaction isolation level read uncommitted 

select a.terminal_id

,ABL_CM=ISNULL(sum(ABL_CM),0),ACDL_CM=ISNULL(sum(ACDL_CM),0),ACDL_FO=ISNULL(sum(ACDL_FO),0),ACPL_MCX=ISNULL(sum(ACPL_MCX),0),ACPL_NCDEX=ISNULL(sum(ACPL_NCDEX),0),

ABL_CM_to=ISNULL(sum(ABL_CM_to),0),ACDL_CM_to=ISNULL(sum(ACDL_CM_to),0),ACDL_FO_to=ISNULL(sum(ACDL_FO_to),0),ACPL_MCX_to=ISNULL(sum(ACPL_MCX_to),0),

ACPL_NCDEX_to=ISNULL(sum(ACPL_NCDEX_to),0) from #term a

left outer join

(select terminal_id,ABL_CM=sum(case when Company ='ABLCM' and 1=1 then Brokerage else 0 end)/1000, 

ACDL_CM=sum(case when Company ='ACDLCM' and 1=1 then Brokerage else 0 end)/1000, 

ACDL_FO=sum(case when Company ='ACDLFO' and 1=1 then Brokerage else 0 end)/1000, 

ACPL_MCX=sum(case when Company ='ACPLMCX' and 1=1 then Brokerage else 0 end)/1000, 

ACPL_NCDEX=sum(case when Company ='ACPLNCDEX' and 1=1 then Brokerage else 0 end)/1000,

ABL_CM_to=sum(case when Company ='ABLCM' and 1=1 then Turnover else 0 end)/1000, 

ACDL_CM_to=sum(case when Company ='ACDLCM' and 1=1 then Turnover else 0 end)/1000, 

ACDL_FO_to=sum(case when Company ='ACDLFO' and 1=1 then Turnover else 0 end)/1000, 

ACPL_MCX_to=sum(case when Company ='ACPLMCX' and 1=1 then Turnover else 0 end)/1000, 

ACPL_NCDEX_to=sum(case when Company ='ACPLNCDEX' and 1=1 then Turnover else 0 end)/1000  

from Mis_TO_Terminal_Detail (nolock) 

where sauda_Date >=@fdate and sauda_date <=@tdate group by terminal_id) b

on a.terminal_id=b.terminal_id where a.servermapped=@servermapped

group by a.terminal_id

    
END    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_editexisting_MarketExecField
-- --------------------------------------------------


CREATE PROC
	sp_editexisting_MarketExecField
	(
		@intMarketExecFieldId bigint,

		@strNewFieldExecName varchar(100),
		@intNewMarketExecRegionId bigint,
		@strNewRegion varchar(100),
		@strNewExchSeg varchar(15),
		@strNewField varchar(100)
	)
AS
Begin
	set @strNewFieldExecName = upper(ltrim(rtrim(@strNewFieldExecName)))
	set @strNewRegion = upper(ltrim(rtrim(@strNewRegion)))
	set @strNewExchSeg = upper(ltrim(rtrim(@strNewExchSeg)))
	set @strNewField = upper(ltrim(rtrim(@strNewField)))

	begin tran

	select top 1
		MarketExecFieldId
	from
		tblMarketExecFieldMaster
	where
		MarketExecFieldId = @intMarketExecFieldId
		and Eff_ToDate = left(convert(datetime, getdate(), 109), 11) + ' 00:00:00'

	if @@RowCount = 0
	/* Record Edited On The Same Day Not Found */
	/* Update The Existing Record */
	/* And Insert A New Record */
	begin
		update
			tblMarketExecFieldMaster
		set
			Eff_ToDate = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'
		where
			MarketExecFieldId = @intMarketExecFieldId
			and Deleted = 'N' 
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
			

			if @@error = 0 
			begin
				exec ('sp_addnew_MarketExecField ' + @intMarketExecFieldId + ', ''' +
					@strNewFieldExecName + ''', ' + @intNewMarketExecRegionId + ', ''' +
					@strNewRegion + ''', ''' + @strNewExchSeg + ''', ''' + 
					@strNewField + '''')

				if @@error = 0 commit tran else rollback tran
			end
			else rollback tran
	end
	else
	/* Record Edited On The Same Day Found */
	/* Update This Record */
	begin
		update
			tblMarketExecFieldMaster
		set
			FieldExecName = @strNewFieldExecName,
			MarketExecRegionId = @intNewMarketExecRegionId,
			Region = @strNewRegion,
			ExchSeg = @strNewExchSeg,
			Field = @strNewField						
		where
			MarketExecFieldId = @intMarketExecFieldId
			and Deleted = 'N'
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
		
		if @@error = 0 commit else rollback tran
	end

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_editexisting_MarketExecRegion
-- --------------------------------------------------


CREATE PROC
	sp_editexisting_MarketExecRegion
	(
		@intMarketExecRegionId bigint,

		@strNewExecName varchar(100),
		@intNewMarketHeadId bigint,
		@strNewExchSeg varchar(15),
		@strNewRegion varchar(100)
	)
AS
Begin
	set @strNewExecName = upper(ltrim(rtrim(@strNewExecName)))
	set @strNewExchSeg = upper(ltrim(rtrim(@strNewExchSeg)))
	set @strNewRegion = upper(ltrim(rtrim(@strNewRegion)))

	begin tran

	select top 1
		MarketExecRegionId
	from
		tblMarketExecRegionMaster
	where
		MarketExecRegionId = @intMarketExecRegionId
		and Eff_ToDate = left(convert(datetime, getdate(), 109), 11) + ' 00:00:00'

	if @@RowCount = 0
	/* Record Edited On The Same Day Not Found */
	/* Update The Existing Record */
	/* And Insert A New Record */
	begin
		update
			tblMarketExecRegionMaster
		set
			Eff_ToDate = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'
		where
			MarketExecRegionId = @intMarketExecRegionId
			and Deleted = 'N' 
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
			

			if @@error = 0 
			begin
				exec ('sp_addnew_MarketExecRegion ' + @intMarketExecRegionId + ', ''' +
					@strNewExecName + ''', ' + @intNewMarketHeadId + ', ''' +
					@strNewExchSeg + ''', ''' + @strNewRegion + '''')

				if @@error = 0 commit tran else rollback tran
			end
			else rollback tran
	end
	else
	/* Record Edited On The Same Day Found */
	/* Update This Record */
	begin
		update
			tblMarketExecRegionMaster
		set
			ExecName = @strNewExecName,
			MarketHeadId = @intNewMarketHeadId,
			ExchSeg = @strNewExchSeg,
			Region = @strNewRegion						
		where
			MarketExecRegionId = @intMarketExecRegionId
			and Deleted = 'N'
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
		
		if @@error = 0 commit else rollback tran
	end

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_editexisting_MarketHead
-- --------------------------------------------------


CREATE PROC
	sp_editexisting_MarketHead
	(
		@intMarketHeadId bigint,

		@strNewMarketHeadName varchar(100)
	)
AS
Begin
	set @strNewMarketHeadName = upper(ltrim(rtrim(@strNewMarketHeadName)))

	begin tran

	select top 1
		MarketHeadId
	from
		tblMarketHeadMaster
	where
		MarketHeadId = @intMarketHeadId
		and Eff_ToDate = left(convert(datetime, getdate(), 109), 11) + ' 00:00:00'

	if @@RowCount = 0
	/* Record Edited On The Same Day Not Found */
	/* Update The Existing Record */
	/* And Insert A New Record */
	begin
		update
			tblMarketHeadMaster
		set
			Eff_ToDate = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'
		where
			MarketHeadId = @intMarketHeadId
			and Deleted = 'N' 
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
			

			if @@error = 0 
			begin
				exec ('sp_addnew_MarketHead ' + @intMarketHeadId + ', ''' +
					@strNewMarketHeadName + '''')

				if @@error = 0 commit tran else rollback tran
			end
			else rollback tran
	end
	else
	/* Record Edited On The Same Day Found */
	/* Update This Record */
	begin
		update
			tblMarketHeadMaster
		set
			MarketHeadName = @strNewMarketHeadName			
		where
			MarketHeadId = @intMarketHeadId
			and Deleted = 'N'
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
		
		if @@error = 0 commit else rollback tran
	end

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_editexisting_MarketWorkDone
-- --------------------------------------------------


CREATE PROC
	sp_editexisting_MarketWorkDone
	(
		@intMarketWorkDoneId bigint,
		
		@intNewMarketHeadId bigint,
		@intNewMarketExecRegionId bigint,
		@intNewMarketExecFieldId bigint,
		@strNewExchSeg varchar(15),
		@strNewBranchCode varchar(10),
		@strNewSubbrokerOrRemisierCode varchar(10)
	)
AS
Begin

	set @strNewExchSeg = upper(ltrim(rtrim(@strNewExchSeg)))
	set @strNewBranchCode = upper(ltrim(rtrim(@strNewBranchCode)))
	set @strNewSubbrokerOrRemisierCode = upper(ltrim(rtrim(@strNewSubbrokerOrRemisierCode)))
		
	begin tran

	select top 1
		MarketWorkDoneId
	from
		tblMarketWorkDoneMaster
	where
		MarketWorkDoneId = @intMarketWorkDoneId
		and Eff_ToDate = left(convert(datetime, getdate(), 109), 11) + ' 00:00:00'

	if @@RowCount = 0
	/* Record Edited On The Same Day Not Found */
	/* Update The Existing Record */
	/* And Insert A New Record */
	begin
		update
			tblMarketWorkDoneMaster
		set
			Eff_ToDate = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'
		where
			MarketWorkDoneId = @intMarketWorkDoneId
			and Deleted = 'N' 
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
			

			if @@error = 0 
			begin
				exec ('sp_addnew_MarketWorkDone ' + @intMarketWorkDoneId + ', ' +
					@intNewMarketHeadId + ', ' + 
					@intNewMarketExecRegionId + ', ' +
					@intNewMarketExecFieldId + ', ''' + 
					@strNewExchSeg + ''', ''' +
					@strNewBranchCode + ''', ''' + 
					@strNewSubbrokerOrRemisierCode + '''')

				if @@error = 0 commit tran else rollback tran
			end
			else rollback tran
	end
	else
	/* Record Edited On The Same Day Found */
	/* Update This Record */
	begin
		update
			tblMarketWorkDoneMaster
		set
			MarketHeadId = @intNewMarketHeadId,
			MarketExecRegionId = @intNewMarketExecRegionId,
			MarketExecFieldId = @intNewMarketExecFieldId,
			ExchSeg = @strNewExchSeg,
			BranchCode = @strNewBranchCode,
			SubbrokerOrRemisierCode = @strNewSubbrokerOrRemisierCode
		where
			MarketWorkDoneId = @intMarketWorkDoneId
			and Deleted = 'N'
			and Eff_ToDate = 'Dec 31 2999 23:59:00'
		
		if @@error = 0 commit else rollback tran
	end

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_fifo_process
-- --------------------------------------------------

CREATE
proc

	[dbo].[sp_fifo_process] (
		@dtForTheDate varchar(11)
	)

as

declare

	@cont cursor,
	@cno cursor,
	@party_code as varchar ( 15 ),
	@scrip_code as varchar ( 10 ),
	@series as varchar ( 3 ),
	@sauda_date as datetime,
	@buy_qty as int,
	@sell_qty as int,
	@buy_avg_rate as money,
	@sell_avg_rate as money,
	@sell_brok as money,
	@buy_brok as money,
	@sell_amt as money,
	@sell_sauda_date as datetime,
	@err bigint

set @err = 0	/*FALSE - No Error*/

/*begin*/
/*	set nocount on*/

	set @cont = cursor for
		select distinct /*top 1*/
			party_code,
			sauda_date,
			scrip_cd,
			series,
			pqty = ( pqtytrd + pqtydel ),
			pavgrate = (  ( pamttrd + pamtdel ) / case when ( pqtytrd + pqtydel ) > 0 then ( pqtytrd + pqtydel ) else 1 end ),
			pbrok = pbrokdel
		from
			/*tbl_fifo_temp*/
			/*AngelBSECM.bsedb_ab.dbo.cmbillvalan*/

			AngelBSECM.bsedb_ab.dbo.cmbillvalan a,
			(
				select
					*
				from
					mis.pms1.dbo.clientmast
	
				where
					eff_from <= @dtForTheDate + ' 00:00:00' and
					eff_to >= @dtForTheDate + ' 23:59:59'

			) b
		
		where
			a.party_code = b.clientid and
			a.party_code >= 'F059' and
			a.party_code <= 'F059' and

/*
			cf = 'Y' and
			valid = 'Y' and
*/
			 ( pqtytrd + pqtydel ) > 0
	order by
		sauda_date asc,
		scrip_cd asc,
		series asc

	open @cont

		fetch next from @cont into @party_code, @sauda_date, @scrip_code, @series, @buy_qty, @buy_avg_rate, @buy_brok

		Select @party_code, @sauda_date, @scrip_code, @series, @buy_qty, @buy_avg_rate, @buy_brok

		while @@fetch_status = 0
		begin

			print '------------------'
			print 'IN OUTER CURSOR FOR: '
			print '	@party_code ' + convert(varchar, @party_code)
			print '	@sauda_date ' + convert(varchar, @sauda_date)
			print '	@scrip_code ' + convert(varchar, @scrip_code)
			print '	@series ' + convert(varchar, @series)
			print '	@buy_qty: ' + convert(varchar, @buy_qty)
			print '	@buy_avg_rate: ' + convert(varchar, @buy_avg_rate)
			print '	@buy_brok: ' + convert(varchar, @buy_brok)
			print '------------------'

			/*print @party_code +'  ' + cast ( @sauda_date as varchar ( 11 )  ) + '   ' + @scrip_code + '   ' + @series +'  pqty = ' + str ( @buy_qty )*/
			set @cno = cursor for
				select
					sauda_date,
					sqty = ( sqtytrd + sqtydel ),
					samt = ( samttrd + samtdel ),
					savgrate   = (  ( samttrd + samtdel ) / case when ( sqtytrd + sqtydel ) > 0 then ( sqtytrd + sqtydel ) else 1 end ),
					sbrok = sbrokdel
				from
					/*tbl_fifo_temp*/
					AngelBSECM.bsedb_ab.dbo.cmbillvalan
				where
/*
					cf = 'Y' and
					valid = 'Y' and
*/
					 ( sqtytrd + sqtydel ) > 0 and
					party_code = @party_code and
					scrip_cd = @scrip_code and
					series = @series and
					sauda_date > = @sauda_date
					/* ABOVE CONDITION FORCES THE CURSOR TO ACCESS RECORDS AFTER THE FIRST BUY TRANSACTION */
				order by
					sauda_date asc,
					scrip_cd asc,
					series asc

			open @cno

				fetch next from @cno into @sell_sauda_date, @sell_qty, @sell_amt, @sell_avg_rate, @sell_brok

				Select @sell_sauda_date, @sell_qty, @sell_amt, @sell_avg_rate, @sell_brok

				while @@fetch_status = 0
				begin

					print '------------------'
					print 'IN INNER CURSOR FOR: '
					print '	@sell_sauda_date: ' + convert(varchar, @sell_sauda_date)
					print '	@sell_qty: ' + convert(varchar, @sell_qty)
					print '	@sell_amt: ' + convert(varchar, @sell_amt)
					print '	@sell_avg_rate: ' + convert(varchar, @sell_avg_rate)
					print '	@sell_brok: ' + convert(varchar, @sell_brok)
					print '------------------'

/*					print @party_code + '  ' + @scrip_code + '  ' + @series + '  ' + cast ( @sauda_date as varchar ( 11 )  ) + '  ' +str ( @buy_qty ) + '  ' + cast ( @sell_sauda_date as varchar ( 11 )  ) + '  ' +str ( @sell_qty ) */

					if @buy_qty = @sell_qty
					begin

						/*print 'PQTY = SQTY'*/

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update
								tbl_fifo_temp
							set
								samtdel = @sell_amt,
								sqtydel = @sell_qty,
								sqoffdate = @sell_sauda_date,
								cf = 'N'
							where
								cf = 'Y' and
								valid = 'Y' and
								 ( pqtytrd + pqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sauda_date
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update
								tbl_fifo_temp
							set
								cf = 'N',
								valid = 'N'
							where
								cf = 'Y' and
								valid = 'Y' and
								 ( sqtytrd + sqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sell_sauda_date
						end
set @err = @err + abs(@@error)
					end		/* if @buy_qty = @sell_qty */

					if @buy_qty > @sell_qty
					begin

						/*print 'PQTY > SQTY'*/
						/* HERE WE NEED TO ADD A PURCHASE RECORD = PQTY - SQTY */
						/* CHANGE IN BUY SIDE */
print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							select
								sett_no,
								sett_type,
								billno,
								contractno,
								party_code,
								party_name,
								scrip_cd,
								series,
								scrip_name,
								isin,
								sauda_date,
								pqtytrd,
								pamttrd,
								pqtydel,
								pamtdel,
								sqtytrd,
								samttrd,
								sqtydel,
								samtdel,
								pbroktrd,
								sbroktrd,
								pbrokdel,
								sbrokdel,
								family,
								family_name,
								terminal_id,
								clienttype,
								tradetype,
								trader,
								sub_broker,
								branch_cd,
								participantcode,
								pamt,
								samt,
								prate,
								srate,
								trdamt,
								delamt,
								serinex,
								service_tax,
								exservice_tax,
								turn_tax,
								sebi_tax,
								ins_chrg,
								broker_chrg,
								other_chrg,
								region,
								start_date,
								end_date,
								update_date,
								status_name,
								exchange,
								segment,
								membertype,
								companyname,
								dummy1,
								dummy2,
								dummy3,
								dummy4,
								dummy5,
								sqoffdate = null,
								cf = null,
								valid = null

							into
								#buy_temp
							from
								/*tbl_fifo_temp*/
								AngelBSECM.bsedb_ab.dbo.cmbillvalan
							where
/*
								cf = 'Y' and
								valid = 'Y' and
*/
								 ( pqtytrd + pqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sauda_date
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update
								tbl_fifo_temp
							set
								pqtytrd = 0,
								pqtydel =  @sell_qty,
								pamttrd = 0,
								pamtdel = @sell_qty * @buy_avg_rate,
								samtdel = @sell_amt,
								sqtydel = @sell_qty,
								sqoffdate = @sell_sauda_date,
								cf = 'N',
								sbrokdel = @sell_brok
							where
								cf = 'Y' and
								valid = 'Y' and
								 ( pqtytrd + pqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sauda_date
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update
								#buy_temp
							set
								pamtdel = ( pamtdel / case when pqtydel > 0 then pqtydel else 1 end ) * ( @buy_qty - @sell_qty ),
								pqtydel = @buy_qty - @sell_qty, pbrokdel = 0
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							insert into
								tbl_fifo_temp
							select
								sett_no,
								sett_type,
								party_code,
								party_name,
								scrip_cd,
								series,
								scrip_name,
								sauda_date,
								pqtytrd,
								pamttrd,
								pqtydel,
								pamtdel,
								sqtytrd,
								samttrd,
								sqtydel,
								samtdel,
								pbroktrd,
								sbroktrd,
								pbrokdel,
								sbrokdel,
								sub_broker,
								branch_cd,
								start_date,
								end_date,
								sqoffdate,
								cf,
								valid
							from
								#buy_temp
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							drop table
								#buy_temp
						end
set @err = @err + abs(@@error)

						/* CHANGES IN SELL SIDE */
						--update tbl_fifo_temp set  sqtydel = @sell_qty - @buy_qty, samtdel = (  ( @sell_qty -@buy_qty ) * @sell_avg_rate ),  cf = 'Y', valid = 'Y'

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update
								tbl_fifo_temp
							set
								cf = 'N',
								valid = 'N'
							where
								cf = 'Y' and
								valid = 'Y' and
								 ( sqtytrd + sqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sell_sauda_date
						end
set @err = @err + abs(@@error)
					end		/* if @buy_qty > @sell_qty */

					if @buy_qty < @sell_qty
					begin

						/*print 'PQTY < SQTY'*/
/*
						print @sell_qty
						print @buy_qty
						print 'ENTERED SELL SIDE IS GREATER THEN BUY SIDE'
*/

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							select
								sett_no,
								sett_type,
								billno,
								contractno,
								party_code,
								party_name,
								scrip_cd,
								series,
								scrip_name,
								isin,
								sauda_date,
								pqtytrd,
								pamttrd,
								pqtydel,
								pamtdel,
								sqtytrd,
								samttrd,
								sqtydel,
								samtdel,
								pbroktrd,
								sbroktrd,
								pbrokdel,
								sbrokdel,
								family,
								family_name,
								terminal_id,
								clienttype,
								tradetype,
								trader,
								sub_broker,
								branch_cd,
								participantcode,
								pamt,
								samt,
								prate,
								srate,
								trdamt,
								delamt,
								serinex,
								service_tax,
								exservice_tax,
								turn_tax,
								sebi_tax,
								ins_chrg,
								broker_chrg,
								other_chrg,
								region,
								start_date,
								end_date,
								update_date,
								status_name,
								exchange,
								segment,
								membertype,
								companyname,
								dummy1,
								dummy2,
								dummy3,
								dummy4,
								dummy5,
								sqoffdate = null,
								cf = null,
								valid = null
							into
								#sell_temp
							from
								/*tbl_fifo_temp*/
								AngelBSECM.bsedb_ab.dbo.cmbillvalan
							where
/*
								cf = 'Y' and
								valid = 'Y' and
*/
								( sqtytrd + sqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sauda_date
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update								tbl_fifo_temp
							set
								samtdel = ( @buy_qty ) * @sell_avg_rate,
								sqtydel = @buy_qty,
								sqoffdate = @sell_sauda_date,
								cf = 'N'
							where
								cf = 'Y' and
								valid = 'Y' and
								( sqtytrd + sqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sauda_date
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update
								#sell_temp
							set
								samtdel = ( samtdel / case when sqtydel > 0 then sqtydel else 1 end ) * ( @sell_qty - @buy_qty ),
								sqtydel = @sell_qty - @buy_qty,
								sbrokdel = 0
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							insert into
								tbl_fifo_temp
							select
								sett_no,
								sett_type,
								party_code,
								party_name,
								scrip_cd,
								series,
								scrip_name,
								sauda_date,
								pqtytrd,
								pamttrd,
								pqtydel,
								pamtdel,
								sqtytrd,
								samttrd,
								sqtydel,
								samtdel,
								pbroktrd,
								sbroktrd,
								pbrokdel,
								sbrokdel,
								sub_broker,
								branch_cd,
								start_date,
								end_date,
								sqoffdate,
								cf,
								valid
							from
								#sell_temp
						end
set @err = @err + abs(@@error)

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							drop table
								#sell_temp
						end
set @err = @err + abs(@@error)

						--update tbl_fifo_temp set  samtdel = ( @sell_qty - @buy_qty ) * @sell_avg_rate, sqtydel = ( @sell_qty - @buy_qty ), cf = 'Y', valid = 'Y'

print '@err:' + convert(varchar, @err)
						if @err = 0
						begin
							update
								tbl_fifo_temp
							set
								cf = 'N',
								valid = 'N'
							where
								cf = 'Y' and
								valid = 'Y' and
								( sqtytrd + sqtydel ) > 0 and
								party_code = @party_code and
								scrip_cd = @scrip_code and
								series = @series and
								sauda_date = @sell_sauda_date
						end
set @err = @err + abs(@@error)

					end		/*if @buy_qty < @sell_qty*/

					fetch next from @cno into @sauda_date, @sell_qty, @sell_amt, @sell_avg_rate, @sell_brok

				end		/*while @fetch_status = 0 - FOR CURSOR cno*/

			close @cno
			deallocate @cno

		fetch next from @cont into @party_code, @sauda_date, @scrip_code, @series, @buy_qty, @buy_avg_rate, @buy_brok

		end		/*while @fetch_status = 0 - FOR CURSOR @cont*/
set @err = @err + abs(@@error)

/*
		if @err = 0
		begin
			insert into 
				tbl_fifo_details
				select 
					*
				from
					tbl_fifo_temp
		end
*/

print '@err:' + convert(varchar, @err)
/*		if @err = 0 commit transaction else begin print 'Transaction Rolled Back' rollback transaction end*/

/*end*/	 /*FOR MAIN 'begin'*/

/*set nocount off*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_first
-- --------------------------------------------------
CREATE PROCEDURE sp_first  AS

select * from odinlog order by sauda_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_funds_open_pos
-- --------------------------------------------------

/*FUNDS OPEN POSITION SQL*/
CREATE
proc
	[dbo].[sp_funds_open_pos]
	(
		@strPartyCode varchar(10)
	)

as 

select 
	'NSECM' as exchseg,
	ltrim(rtrim(cltcode)) as cltcode, 
	ltrim(rtrim(acname)) as acname, 
	drcr, 
	vamt = (case when drcr = 'c' then vamt * -1 else vamt end), 
	edt, 
	edt109 = left(convert(varchar,edt,109),11), 
	edt103 = left(convert(varchar,edt,103),11) 
from 
	AngelNseCM.inhouse.dbo.ledger 
where
	edt >= left(convert(varchar, getdate(),109),11) + ' 00:00:00' and 
	vdt <= left(convert(varchar, getdate(),109),11) + ' 23:59:59'  and
	ltrim(rtrim(cltcode)) = @strPartyCode

union

select 
	'BSECM' as exchseg,
	ltrim(rtrim(cltcode)) as cltcode, 
	ltrim(rtrim(acname)) as acname, 
	drcr, 
	vamt = (case when drcr = 'c' then vamt * -1 else vamt end), 
	edt, 
	edt109 = left(convert(varchar,edt,109),11), 
	edt103 = left(convert(varchar,edt,103),11)
from 
	AngelBSECM.account_ab.dbo.ledger 
where
	edt >= left(convert(varchar, getdate(),109),11) + ' 00:00:00' and 
	vdt <= left(convert(varchar, getdate(),109),11) + ' 23:59:59'  and
	ltrim(rtrim(cltcode)) = @strPartyCode

union

select 
	'NSEFO' as exchseg,
	ltrim(rtrim(cltcode)) as cltcode, 
	ltrim(rtrim(acname)) as acname, 
	drcr, 
	vamt = (case when drcr = 'c' then vamt * -1 else vamt end), 
	edt, 
	edt109 = left(convert(varchar,edt,109),11), 
	edt103 = left(convert(varchar,edt,103),11)
from 
	angelfo.inhouse.dbo.ledger 
where
	edt >= left(convert(varchar, getdate(),109),11) + ' 00:00:00' and 
	vdt <= left(convert(varchar, getdate(),109),11) + ' 23:59:59'  and
	ltrim(rtrim(cltcode)) = @strPartyCode

order by
	exchseg, 
	edt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_cm_bill_status
-- --------------------------------------------------

CREATE
proc
	sp_get_cm_bill_status
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 
		@strTradeSettNo varchar(10), 
		@strTradeSettType varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @strTradeSettNo = upper(ltrim(rtrim(@strTradeSettNo)))
set @strTradeSettType = upper(ltrim(rtrim(@strTradeSettType)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select top 1 '
set @strSQL = @strSQL + '	sett_no, '
set @strSQL = @strSQL + '	sett_type '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.settlement s, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client1 c1, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client2 c2 '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	c1.cl_code = c2.cl_code and '
set @strSQL = @strSQL + '	s.party_code = c2.party_code and '
set @strSQL = @strSQL + '	s.party_code = ''' + @strStatusName + ''' and '
set @strSQL = @strSQL + '	sett_no = ''' + @strTradeSettNo + ''' and '
set @strSQL = @strSQL + '	sett_type = ''' + @strTradeSettType + ''' and '
set @strSQL = @strSQL + '	billno > 0 and '
set @strSQL = @strSQL + '	c1.branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c2.party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_cm_last_bill
-- --------------------------------------------------


CREATE
proc
	sp_get_cm_last_bill
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 
		@strTradeSettNo varchar(10), 
		@strTradeSettType varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @strTradeSettNo = upper(ltrim(rtrim(@strTradeSettNo)))
set @strTradeSettType = upper(ltrim(rtrim(@strTradeSettType)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select '
set @strSQL = @strSQL + '	left(convert(varchar, max(sauda_date), 109), 11) as last_bill_date '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.settlement s, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client1 c1, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client2 c2 '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	c1.cl_code = c2.cl_code and '
set @strSQL = @strSQL + '	s.party_code = c2.party_code and '
set @strSQL = @strSQL + '	s.party_code = ''' + @strStatusName + ''' and '
set @strSQL = @strSQL + '	billno > 0 and '
set @strSQL = @strSQL + '	c1.branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c2.party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_cm_last_trade
-- --------------------------------------------------

CREATE
proc
	sp_get_cm_last_trade
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@dtSaudaDate varchar(11), 
		@strSettType varchar(3), 
		@strPartyCode varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

if len(ltrim(rtrim(@dtSaudaDate))) = 0 
begin
	set @dtSaudaDate = left(convert(varchar,getdate(),109),11)
end

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))
set @strSettType = upper(ltrim(rtrim(@strSettType)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select '
set @strSQL = @strSQL + '	left(convert(varchar, max(convert(datetime, sauda_date)), 109), 11) as last_trade_date '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.details '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strPartyCode + ''' '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_cm_last_valan
-- --------------------------------------------------


CREATE
proc
	sp_get_cm_last_valan
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 	
		@strBillSettNo varchar(10), 
		@strBillSettType varchar(10) 
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @strBillSettNo = upper(ltrim(rtrim(@strBillSettNo)))
set @strBillSettType = upper(ltrim(rtrim(@strBillSettType)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select '
set @strSQL = @strSQL + '	left(convert(varchar, max(sauda_date), 109), 11) as last_valan_date '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.cmbillvalan '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strStatusName + ''' and '
set @strSQL = @strSQL + '	billno > 0 and '
set @strSQL = @strSQL + '	branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_cm_trade_status
-- --------------------------------------------------
CREATE
proc
	sp_get_cm_trade_status
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@dtSaudaDate varchar(11), 
		@strSettType varchar(3), 
		@strPartyCode varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

if len(ltrim(rtrim(@dtSaudaDate))) = 0 
begin
	set @dtSaudaDate = left(convert(varchar,getdate(),109),11)
end

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))
set @strSettType = upper(ltrim(rtrim(@strSettType)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select top 1 '
set @strSQL = @strSQL + '	sett_no, '
set @strSQL = @strSQL + '	sett_type '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.details '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strPartyCode + ''' and '
set @strSQL = @strSQL + '	sauda_date like ''' + @dtSaudaDate + '%' + ''' and '
set @strSQL = @strSQL + '	sett_type = ''' + @strSettType + ''''

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_cm_valan_status
-- --------------------------------------------------

CREATE
proc
	sp_get_cm_valan_status
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 	
		@strBillSettNo varchar(10), 
		@strBillSettType varchar(10) 
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @strBillSettNo = upper(ltrim(rtrim(@strBillSettNo)))
set @strBillSettType = upper(ltrim(rtrim(@strBillSettType)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select top 1 '
set @strSQL = @strSQL + 'sett_no, '
set @strSQL = @strSQL + 'sett_type '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.cmbillvalan '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strStatusName + ''' and '
set @strSQL = @strSQL + '	sett_no = ''' + @strBillSettNo + ''' and '
set @strSQL = @strSQL + '	sett_type = ''' + @strBillSettType + ''' and '
set @strSQL = @strSQL + '	billno > 0 and '
set @strSQL = @strSQL + '	branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_fo_bill_status
-- --------------------------------------------------
CREATE
proc
	sp_get_fo_bill_status
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 
		@dtSaudaDate varchar(11), 
		@strPartyCode varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))
set @strPartyCode = upper(ltrim(rtrim(@strPartyCode)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
set @strSQL = @strSQL + 'select top 1 '
set @strSQL = @strSQL + '	left(convert(varchar, s.billdate, 109), 11) as sauda_date, '
set @strSQL = @strSQL + '	s.party_code '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.foaccbill s, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client1 c1, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client2 c2 '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	c1.cl_code = c2.cl_code and '
set @strSQL = @strSQL + '	s.party_code = c2.party_code and '
set @strSQL = @strSQL + '	s.party_code = ''' + @strPartyCode + ''' and '
set @strSQL = @strSQL + '	s.billdate like ''' + @dtSaudaDate + '%'' and '
set @strSQL = @strSQL + '	s.bill_no > 0 and '
set @strSQL = @strSQL + '	c1.branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c2.party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_fo_last_bill
-- --------------------------------------------------

CREATE
proc
	sp_get_fo_last_bill
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 
		@dtSaudaDate varchar(11), 
		@strPartyCode varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))
set @strPartyCode = upper(ltrim(rtrim(@strPartyCode)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
set @strSQL = @strSQL + 'select '
set @strSQL = @strSQL + '	left(convert(varchar, max(s.billdate), 109), 11) as last_bill_date '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.foaccbill s, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client1 c1, '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.client2 c2 '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	c1.cl_code = c2.cl_code and '
set @strSQL = @strSQL + '	s.party_code = c2.party_code and '
set @strSQL = @strSQL + '	s.party_code = ''' + @strPartyCode + ''' and '
set @strSQL = @strSQL + '	s.bill_no > 0 and '
set @strSQL = @strSQL + '	c1.branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c1.family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	c2.party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_fo_last_margin
-- --------------------------------------------------

CREATE
proc
	sp_get_fo_last_margin
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 
		@dtSaudaDate varchar(11), 
		@strPartyCode varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))
set @strPartyCode = upper(ltrim(rtrim(@strPartyCode)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
set @strSQL = @strSQL + 'select '
set @strSQL = @strSQL + '	left(convert(varchar, max(margindate), 109), 11) as last_margin_date '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.tbl_clientmargin '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strPartyCode + ''' and '
set @strSQL = @strSQL + '	branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_fo_last_trade
-- --------------------------------------------------

CREATE
proc
	sp_get_fo_last_trade
	(
		@strServerName varchar(20),
		@strDBName varchar(20),
		@dtSaudaDate varchar(11),
		@strPartyCode varchar(10)
	)

as

declare
	@strSQL varchar(2000)

if len(ltrim(rtrim(@dtSaudaDate))) = 0
begin
	set @dtSaudaDate = left(convert(varchar,getdate(),109),11)
end

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select '
set @strSQL = @strSQL + '	left(convert(varchar, max(sauda_date), 109), 11) as last_trade_date '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.fosettlement '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strPartyCode + ''' '


exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_fo_margin_status
-- --------------------------------------------------
CREATE
proc
	sp_get_fo_margin_status
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strStatusID varchar(25), 
		@strStatusName varchar(25), 
		@dtSaudaDate varchar(11), 
		@strPartyCode varchar(10)
	)

as

declare 
	@strSQL varchar(2000) 

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @strStatusID = upper(ltrim(rtrim(@strStatusID)))
set @strStatusName = upper(ltrim(rtrim(@strStatusName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))
set @strPartyCode = upper(ltrim(rtrim(@strPartyCode)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
set @strSQL = @strSQL + 'select top 1 '
set @strSQL = @strSQL + '	left(convert(varchar, margindate, 109), 11) as sauda_date, '
set @strSQL = @strSQL + '	party_code '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.tbl_clientmargin '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strPartyCode + ''' and '
set @strSQL = @strSQL + '	margindate like ''' + @dtSaudaDate + '%'' and '
set @strSQL = @strSQL + '	branch_cd like (case when ''' + @strStatusID + '''= ''BRANCH'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	sub_broker like (case when ''' + @strStatusID + '''= ''SUBBROKER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	trader like (case when ''' + @strStatusID + '''= ''TRADER'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	family like (case when ''' + @strStatusID + '''= ''FAMILY'' then ''' + @strStatusName + ''' else ''%'' end) and '
set @strSQL = @strSQL + '	party_code like (case when ''' + @strStatusID + '''= ''CLIENT'' then ''' + @strStatusName + ''' else ''%'' end) '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_fo_trade_status
-- --------------------------------------------------
CREATE
proc
	sp_get_fo_trade_status
	(
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@dtSaudaDate varchar(11), 
		@strPartyCode varchar(10) 
	)

as

declare 
	@strSQL varchar(2000) 

if len(ltrim(rtrim(@dtSaudaDate))) = 0 
begin
	set @dtSaudaDate = left(convert(varchar,getdate(),109),11)
end

set @strServerName = upper(ltrim(rtrim(@strServerName)))
set @strDBName = upper(ltrim(rtrim(@strDBName)))
set @dtSaudaDate = upper(ltrim(rtrim(@dtSaudaDate)))

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '

set @strSQL = @strSQL + 'select top 1 '
set @strSQL = @strSQL + '	left(convert(varchar,getdate(),109),11) as sauda_date, '
set @strSQL = @strSQL + '	party_code '
set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	' + @strServerName + '.' + @strDBName + '.dbo.fosettlement '
set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strPartyCode + ''' and '
set @strSQL = @strSQL + '	sauda_date like ''' + @dtSaudaDate + '%' + ''' '

exec (@strSQL)
print(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Get_Scrip_ISIN_Diff
-- --------------------------------------------------
CREATE Procedure [dbo].[sp_Get_Scrip_ISIN_Diff](@ServerName varchar(25), @ColumnName Varchar(25))  
As  
  
/*
  
 sp_Get_Scrip_ISIN_Diff 'Anand','SCRIP'
 sp_Get_Scrip_ISIN_Diff 'Anand1','SCRIP'
 sp_Get_Scrip_ISIN_Diff 'Anand','ISIN'
 sp_Get_Scrip_ISIN_Diff 'Anand1','ISIN'
  
*/  
  
BegIn  
   
 Set @ServerName = Rtrim(ltrim(Upper(@ServerName)))  
 Set @ColumnName = Rtrim(ltrim(Upper(@ColumnName)))  
  
 if(@ServerName='Anand' And @ColumnName='SCRIP')  
 BegIn  
  -- Check with AngelBSECM  - SCRIP
	Select  s2.bsecode, s2.scrip_cd, s1.short_name From AngelBSECM.bsedb_ab.dbo.scrip1 s1, AngelBSECM.bsedb_ab.dbo.scrip2 s2
	Where s1.co_code = s2.co_code	And s1.series = s2.series 
	And RTrim(LTrim(s2.bsecode)) Not In( Select RTrim(LTrim(s2.bsecode)) From angeldemat.bsedb.dbo.scrip2 s2)
 End  
   
 if(@ServerName='Anand1' And @ColumnName='SCRIP')  
 BegIn  
  -- Check with AngelNseCM  - SCRIP
	Select s2.series, s2.scrip_cd, s1.short_name From AngelNseCM.msajag.dbo.scrip1 s1, AngelNseCM.msajag.dbo.scrip2 s2
	Where s1.co_code = s2.co_code And s1.series = s2.series
	And RTrim(LTrim(s2.series)) Not In (Select RTrim(LTrim(series)) From angeldemat.msajag.dbo.scrip2)
	And RTrim(LTrim(s2.scrip_cd)) Not In (Select RTrim(LTrim(scrip_cd)) From angeldemat.msajag.dbo.scrip2)
 End  
  
 if(@ServerName='Anand' And @ColumnName='ISIN')  
 BegIn   
  -- Check with AngelBSECM - MultiISIN
	-- BSE Scrips Not available in ISIN table
		Select Scrip_cd, Series, ISIN From AngelBSECM.bsedb_ab.dbo.MultiISIN Where scrip_cd Not In 
		(Select scrip_cd From angeldemat.bsedb.dbo.MultiISIN Where valid=1)
		And valid=1
		
		-- BSE ISIN Not available in ISIN table
		Select Scrip_cd, Series, ISIN From AngelBSECM.bsedb_ab.dbo.MultiISIN Where ISIN Not In 
		(Select ISIN From angeldemat.bsedb.dbo.MultiISIN Where valid=1)
		And valid=1
 End  
   
  
 if(@ServerName='Anand1' And @ColumnName='ISIN')  
 BegIn  
  -- Check with AngelNseCM - MultiISIN  
		-- NSE scrips Not available in ISIN table
		Select Scrip_cd, Series, ISIN From AngelNseCM.msajag.dbo.MultiISIN Where scrip_cd Not In 
		(Select scrip_cd From angeldemat.msajag.dbo.MultiISIN Where valid=1)
		And valid=1
		
		-- NSE ISIN Not available in ISIN table
		Select Scrip_cd, Series, ISIN From AngelNseCM.msajag.dbo.MultiISIN Where ISIN Not In 
		(Select ISIN From angeldemat.msajag.dbo.MultiISIN  Where valid=1)
		And valid=1
 End  

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetBankCode
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_GetBankCode    Script Date: 09/11/2005 6:47:27 PM ******/
create proc
	sp_GetBankCode
AS
Begin
	
	begin tran

	select BankCode = (case when max(BankCode) > 0 then max(BankCode) + 1 else 1 end) from BankMaster

	if @@error = 0 commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getboadmins
-- --------------------------------------------------
CREATE Procedure sp_getboadmins
	(
		@strServerName varchar(20),
		@strDBName varchar(20)
	)
as


	declare	@strSQL varchar(1000)

	set @strServerName = upper(ltrim(rtrim(@strServerName)))
	set @strDBName = upper(ltrim(rtrim(@strDBName)))

	set @strSQL = ''
	set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
	set @strSQL = @strSQL + 'select '
	set @strSQL = @strSQL + '	distinct '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(fldstatus))) as fldstatus '
/*	set @strSQL = @strSQL + '	fldauto_admin '*/
	set @strSQL = @strSQL + 'from '
	set @strSQL = @strSQL + @strServerName + '.' + @strDBName + '.dbo.tbladmin '
	set @strSQL = @strSQL + 'where '
	set @strSQL = @strSQL + '	len(ltrim(rtrim(isnull(fldstatus, '''')))) > 0 and '
	set @strSQL = @strSQL + '	len(ltrim(rtrim(fldstatus))) > 0 and '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(fldstatus))) <> ''ADMINISTRATOR'' '
	set @strSQL = @strSQL + 'order by '
	set @strSQL = @strSQL + '	fldstatus '

exec (@strSQL)
PRINT @strSQL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getbocategories
-- --------------------------------------------------
CREATE procedure
sp_getbocategories
	(
		@strServerName varchar(20),
		@strDBName varchar(20),
		@strAdminName varchar(50)
	)
as
	declare
		@strSQL varchar(1000)

	set @strServerName = upper(ltrim(rtrim(@strServerName)))
	set @strDBName = upper(ltrim(rtrim(@strDBName)))
	set @strAdminName = upper(ltrim(rtrim(@strAdminName)))

	set @strSQL = ''
	set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
	set @strSQL = @strSQL + 'select '
	set @strSQL = @strSQL + '	distinct '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(fldcategoryname))) as fldcategoryname, '
	set @strSQL = @strSQL + '	fldcategorycode '
	set @strSQL = @strSQL + 'from '
	set @strSQL = @strSQL + @strServerName + '.' + @strDBName + '.dbo.tblcategory '
	set @strSQL = @strSQL + 'where '
	set @strSQL = @strSQL + '	fldadminauto in '
	set @strSQL = @strSQL + '		(select '
	set @strSQL = @strSQL + '			distinct fldauto_admin '
	set @strSQL = @strSQL + '		from ' + @strServerName + '.' + @strDBName + '.dbo.tbladmin '
	set @strSQL = @strSQL + '		where '
	set @strSQL = @strSQL + '			upper(ltrim(rtrim(fldstatus))) = ''' + @strAdminName + ''' '
	set @strSQL = @strSQL + '		) and '
	set @strSQL = @strSQL + '	len(ltrim(rtrim(isnull(fldcategoryname, '''')))) > 0 and '
	set @strSQL = @strSQL + '	len(ltrim(rtrim(fldcategoryname))) > 0 '
	set @strSQL = @strSQL + 'order by '
	set @strSQL = @strSQL + '	fldcategoryname '

exec (@strSQL)
print (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getbousers
-- --------------------------------------------------
CREATE
proc
sp_getbousers
	(
		@strServerName varchar(20),
		@strDBName varchar(20),
		@strCategoryName varchar(50)
	)
as
	declare
		@strSQL varchar(1000)

	set @strServerName = upper(ltrim(rtrim(@strServerName)))
	set @strDBName = upper(ltrim(rtrim(@strDBName)))
	set @strCategoryName = upper(ltrim(rtrim(@strCategoryName)))

	set @strSQL = ''
	set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
	set @strSQL = @strSQL + 'select '
	set @strSQL = @strSQL + '	distinct '
/*	set @strSQL = @strSQL + '	fldauto, '	*/
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(fldusername))) as fldusername '
	set @strSQL = @strSQL + 'from '
	set @strSQL = @strSQL + @strServerName + '.' + @strDBName + '.dbo.tblpradnyausers '
	set @strSQL = @strSQL + 'where '
	set @strSQL = @strSQL + '	fldcategory in '
	set @strSQL = @strSQL + '		(select '
	set @strSQL = @strSQL + '			distinct fldcategorycode '
	set @strSQL = @strSQL + '		from ' + @strServerName + '.' + @strDBName + '.dbo.tblcategory '
	set @strSQL = @strSQL + '		where '
	set @strSQL = @strSQL + '			upper(ltrim(rtrim(fldcategoryname))) = ''' + @strCategoryName + ''' '
	set @strSQL = @strSQL + '		) and '
	set @strSQL = @strSQL + '	len(ltrim(rtrim(isnull(fldusername, '''')))) > 0 and '
	set @strSQL = @strSQL + '	len(ltrim(rtrim(fldusername))) > 0 '
	set @strSQL = @strSQL + 'order by '
	set @strSQL = @strSQL + '	fldusername '

/*print (@strSQL)*/
exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetBranchCode
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_GetBranchCode    Script Date: 09/11/2005 6:47:27 PM ******/
CREATE proc
	sp_GetBranchCode
AS
Begin
	
	begin tran

	select BranchCode = (case when max(BankBranchCode) > 0 then max(BankBranchCode) + 1 else 1 end) from BankBranchMaster

	if @@error = 0 commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getcommon_bo_servers
-- --------------------------------------------------
CREATE
proc
	sp_getcommon_bo_servers
as
	select 
		upper(ltrim(rtrim(exchange))) as exchange, 
		upper(ltrim(rtrim(segment))) as segment, 
		upper(ltrim(rtrim(servername))) as servername, 
		upper(ltrim(rtrim(dbname))) as dbname
	from
		tbl_common_login_serverinfo
	where
		upper(ltrim(rtrim(application))) = 'BO'
	order by
		exchange, 
		segment

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getCommonUsers
-- --------------------------------------------------
CREATE Procedure getCommonUsers(@LoginName Varchar(25)='')
As
Begin
	If @LoginName = ''
		Select
			[LoginName]=Common.cmn_usr_name, [FirstName]=Common.first_name, [MiddleName]=Common.middle_name, [LastName]=Common.last_name
		from
			tbl_common_login Common
	Else

		Begin
		
			Select
				[LoginName]=Common.cmn_usr_name, [FirstName]=Common.first_name, [MiddleName]=Common.middle_name, [LastName]=Common.last_name,
				[BOUserName]=CommonBO.bo_usr_name, [ExchangeSegment]=CommonBO.exchseg
			from
				tbl_common_login Common, tbl_common_login_bo CommonBO
			Where
				Common.cmn_usr_name = @LoginName
				And Common.cmn_usr_name = CommonBO.cmn_usr_name
		End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetCompanies
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_GetCompanies    Script Date: 2/7/2005 1:32:23 PM ******/

/****** Object:  Stored Procedure dbo.sp_GetCompanies    Script Date: 2/4/2005 3:01:00 PM ******/
CREATE
proc
	sp_GetCompanies
	(
		@WhatToGet varchar(15)
	)
as 
	set @WhatToGet = upper(ltrim(rtrim(@WhatToGet)))

	if (@WhatToGet = 'ALL')
		begin
			select 
				distinct
				upper(co_exchange) as exchange,
				upper(co_segment) as segment,
				upper(coshrtname) as company_short_name,
				upper(co_name) as company_name
			from 
				maneshm.remisior.dbo.company
			where 
				co_segment <> 'NCDEX'
			order by
				1, 2
		end

	if (@WhatToGet = 'NAMES')
		begin
			select 
				distinct
				upper(coshrtname) as company_short_name,
				upper(co_name) as company_name
			from 
				maneshm.remisior.dbo.company
			where 
				co_segment <> 'NCDEX'
			order by
				1, 2
		end

	if (@WhatToGet = 'LONGNAME')
		begin
			select 
				distinct
				upper(co_name) as company_name
			from 
				maneshm.remisior.dbo.company
			where 
				co_segment <> 'NCDEX'
			order by
				1
		end

	if (@WhatToGet = 'SHORTNAME')
		begin
			select 
				distinct
				upper(coshrtname) as company_short_name
			from 
				maneshm.remisior.dbo.company
			where 
				co_segment <> 'NCDEX'
			order by
				1
		end

	if (@WhatToGet = 'SEGMENT')
		begin
			select 
				distinct
				upper(co_segment) as segment
			from 
				maneshm.remisior.dbo.company
			where 
				co_segment <> 'NCDEX'
			order by
				1
		end

	if (@WhatToGet = 'NAME_SEG')
		begin
			select 
				distinct
				upper(coshrtname) as company_short_name,
				upper(co_name) + ' [' + upper(co_exchange) + '-' + upper(co_segment) + ']' as company_name_exch_seg
			from 
				maneshm.remisior.dbo.company
			where 
				co_segment <> 'NCDEX'
			order by
				1, 2
		end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetFDCode
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_GetFDCode    Script Date: 09/11/2005 6:47:27 PM ******/
create proc
	sp_GetFDCode
AS
Begin
	
	begin tran

	select FDCode = (case when max(FDCode) > 0 then max(FDCode) + 1 else 1 end) from FDMaster

	if @@error = 0 commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetUserInfo
-- --------------------------------------------------
CREATE Procedure sp_GetUserInfo(@LoginName varchar(20))
as
Begin
	SELECT 	[ExchangeSegment]=exchseg, [AdminID]=bo_usr_admin_id, [CategoryID]=bo_usr_category
	FROM tbl_common_login_bo
	WHERE cmn_usr_name = Rtrim(Ltrim(@LoginName))
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_identy
-- --------------------------------------------------

CREATE PROCEDURE SP_identy (@CONAME AS VARCHAR(25), @BRCODE AS VARCHAR(25), @SBCODE AS VARCHAR(25))  
AS  
  
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,  
CL_NAME=SHORT_NAME COLLATE Latin1_General_CI_AS,  
identitycard=(CASE WHEN UPPER(identitycard COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)   
from kyc_documents where cl_code in (select distinct party_code from mis_to where branch_cd=@BRCODE and sub_broker like replace(@SBCODE,'All','%') and company=@CONAME)  
UNION  
select distinct cl_code=party_code,CL_NAME=party_name,identitycard='NO'  
from mis_to where sub_broker like replace(@SBCODE,'All','%') and branch_cd=@BRCODE and company=@CONAME  
and sauda_Date >=getdate()-365 AND   
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )  
ORDER BY CL_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_IncExp
-- --------------------------------------------------

CREATE Procedure [dbo].[sp_IncExp] (
@From_Date varchar(50),
@To_Date varchar(50),
@CostName varchar(50)='',
@AcName varchar(50)='',
@Year varchar(4)='',
@IsSegmentwise varchar(1)='0',
@OrderBy varchar(50)=''
)

As

/*
	Modified On 7 Apr 2005, 11:43 AM
*/


Begin

Declare
@FromBSE varchar(8000),
@FromNSE varchar(8000),
@FromNSEFO varchar(8000),
@Select varchar(8000),
@GroupBy varchar(8000),
@Where varchar(8000)




/* Change */
/*
Set @From_Date = 'Jan 1 2001'
Set @To_Date = 'Jan 1 2005'
Set @Year = '2004'
Set @IsSegmentwise = '1'
set @CostName = 'HO' -- HO
set @AcName = 'COMMISION TO AUTHORISED PERSON' -- COMMISION TO AUTHORISED PERSON
Set @OrderBy = ''
*/

-- sp_IncExp 'Jan 1 2001', 'Jan 1 2005','','','','0'
-- sp_IncExp 'Jan 1 2001', 'Jan 1 2005','','','','1'
-- sp_IncExp 'Jan 1 2001', 'Jan 1 2005','ACM','','','0'
-- sp_IncExp 'Jan 1 2001', 'Jan 1 2005','ACM','','2004','0'
-- sp_IncExp 'Jan 1 2001', 'Jan 1 2005','ACM','COMMISION TO AUTHORISED PERSON','','0'
-- sp_IncExp 'Jan 1 2001', 'Jan 1 2005','ACM','COMMISION TO AUTHORISED PERSON','2004','0', ' VExpense Desc '


/* BSE */
-- main select
Set @Select = ' Set Transaction Isolation Level Read Uncommitted Select '

If @Costname = ''
	Set @Select = @Select + ' Costname, [Branch]=IsNull(( select Branch from Branch where branch_code = Costname),''--''), '
else
	if @Acname= ''
		Set @select = @select + ' [Account Name]=AcName, '
	Else
		If @Year <> ''
			Set @select = @select + ' [Month] = DateName(Month, Cast([Month] as varchar)  +  ''/20/1900'') , '
		Else
			set @select = @select + ' Year, '

If @IsSegmentwise = '1'
		set @select = @select + ' Segment, '

Set @Select = @Select +  ' sum(Vincome) as VIncome, sum(Vexpense) as VExpense ' +
  ' From ' +
  ' (  ' 

Set @FromBSE = '  Select  AcName, Costname,  Segment=''BSE'',  [Year]=Y, [Month]=M, Vexpense = Sum(Vexpense),  Vincome = Sum(Vincome) ' +
		' From ' +
		' ( ' +
		'    Select L.AcName, CostName,  Y = datepart(yyyy,edt), M = datepart(month,edt), ' +
			' VIncome = Sum(Case When actyp in(''INCOME'') Then vamt Else 0 End), ' +
		        ' Vexpense = Sum(Case When actyp in(''Expences'',''EXPENSES'') Then vamt Else 0 End), ' +
			' C.costcode,  Actyp  ' +
	         ' From  ' +
		 	' AngelBSECM.account_ab.dbo.ledger L,  ' +
			' AngelBSECM.account_ab.dbo.Ledger2 L2,  ' +
			' AngelBSECM.account_ab.dbo.Acmast A,  ' +
			' AngelBSECM.account_ab.dbo.CostMast C  ' +
	
	          ' Where  L.CltCode = L2.CltCode and  L.Vtyp = L2.Vtype and  L.Vno = L2.Vno ' +
        		  ' and   L.Edt >= '' ' + @From_Date + ' '' and  L.Edt <= '' ' + @To_Date + ' ''' +
		          ' and   A.CltCode = L.Cltcode and  actyp in(''Expences'',''EXPENSES'',''INCOME'') ' +
		          ' and   L2.Costcode = C.costcode   Group By   L.cltcode, CostName, datepart(yyyy,edt), C.costcode,Actyp, L.AcName, datepart(month,edt) ' +
		' ) A ' +
	        ' Group by Costname, Y, AcName,M '

	-- Union All


/* NSE */

Set @FromNSE = '   Select  AcName, Costname,  Segment=''NSE'',  [Year]=Y, [Month]=M,  Vexpense = Sum(Vexpense),  Vincome = Sum(Vincome) ' +
		' From ' +
		' ( ' +
		'    Select L.AcName, CostName,  Y = datepart(yyyy,edt),M = datepart(month,edt), ' +
			' VIncome = Sum(Case When actyp in(''INCOME'') Then vamt Else 0 End), ' +
		        ' Vexpense = Sum(Case When actyp in(''Expences'',''EXPENSES'') Then vamt Else 0 End), ' +
			' C.costcode,  Actyp  ' +
	         ' From  ' +
		 	' AngelNseCM.inhouse.dbo.ledger L,  ' +
			' AngelNseCM.inhouse.dbo.Ledger2 L2,  ' +
			' AngelNseCM.inhouse.dbo.Acmast A,  ' +
			' AngelNseCM.inhouse.dbo.CostMast C  ' +
	
	          ' Where  L.CltCode = L2.CltCode and  L.Vtyp = L2.Vtype and  L.Vno = L2.Vno ' +
        		  ' and   L.Edt >= '' ' + @From_Date + ' '' and  L.Edt <= '' ' + @To_Date + ' ''' +
		          ' and   A.CltCode = L.Cltcode and  actyp in(''Expences'',''EXPENSES'',''INCOME'') ' +
		          ' and   L2.Costcode = C.costcode   Group By   L.cltcode, CostName, datepart(yyyy,edt), C.costcode,Actyp, L.AcName, datepart(month,edt) ' +
		' ) A ' +
	        ' Group by Costname, Y, AcName, M '

	-- Union All


/* NSEFO */

Set @FromNSEFO = '   Select  AcName, Costname,  Segment=''NSEFO'',  [Year]=Y, [Month]=M,   Vexpense = Sum(Vexpense),  Vincome = Sum(Vincome) ' +
		' From ' +
		' ( ' +
		'    Select L.AcName, CostName,  Y = datepart(yyyy,edt), M = datepart(month,edt),' +
			' VIncome = Sum(Case When actyp in(''INCOME'') Then vamt Else 0 End), ' +
		        ' Vexpense = Sum(Case When actyp in(''Expences'',''EXPENSES'') Then vamt Else 0 End), ' +
			' C.costcode,  Actyp  ' +
	         ' From  ' +
		 	' angelfo.inhouse.dbo.ledger L,  ' +
			' angelfo.inhouse.dbo.Ledger2 L2,  ' +
			' angelfo.inhouse.dbo.Acmast A,  ' +
			' angelfo.inhouse.dbo.CostMast C  ' +
	
	          ' Where  L.CltCode = L2.CltCode and  L.Vtyp = L2.Vtype and  L.Vno = L2.Vno ' +
        		  ' and   L.Edt >= '' ' + @From_Date + ' '' and  L.Edt <= '' ' + @To_Date + ' ''' +
		          ' and   A.CltCode = L.Cltcode and  actyp in(''Expences'',''EXPENSES'',''INCOME'') ' +
		          ' and   L2.Costcode = C.costcode   Group By   L.cltcode, CostName, datepart(yyyy,edt), C.costcode,Actyp, L.AcName, datepart(month,edt) ' +
		' ) A ' +
	        ' Group by Costname, Y, AcName, M '

Set @where = ') D Where 1=1 '


If @Costname = ''
	Set @where = @where + ' '
Else
	if @Acname= ''
		Set @where = @where + ' And costname = ''' + @costname + ''''
	else
		Set @where = @where + ' And Acname = ''' + @Acname + ''''

If @Year<>''
	Set @where = @where + ' And Year=' + @year

Set @GroupBy = ' Group By ' 

If @Costname = ''
	Set @GroupBy = @GroupBy  + ' CostName '
Else
 	if @Acname= ''
		Set @GroupBy = @GroupBy  + ' AcName '
	else
		If @year= ''
			Set @GroupBy = @GroupBy  + ' Year '
		else
			Set @GroupBy = @GroupBy + ' Month '



If @OrderBy = ''
	Begin
		Set @OrderBy = ' Order By '
		If @Costname = ''
			Set @OrderBy = @OrderBy  + ' CostName '
		Else
		 	if @Acname= ''
				Set @OrderBy = @OrderBy  + ' AcName '
			else
				If @year <> ''
					Set @OrderBy = @OrderBy + ' Month '
				Else
					Set @OrderBy = @OrderBy  + ' Year '
	End
Else
	Set @OrderBy = ' Order By ' + @OrderBy



If @IsSegmentwise = '1'
	Begin
		Set @GroupBy = @GroupBy  + ' , Segment '
		Set @OrderBy = @OrderBy  + ' , Segment '
	End


Print ( @select + @fromBSe + ' Union All ' + @fromnse + ' Union All ' + @fromnsefo + ' ' + @where + ' ' + @groupby + ' ' + @OrderBy )

Exec ( @select + @fromBSe + ' Union All ' + @fromnse + ' Union All ' + @fromnsefo + ' ' + @where + @groupby + ' ' + @OrderBy )
--Exec ( @select + @fromBSe + ' ' + @where + @groupby + ' ' + @OrderBy )


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_insert_bo_user
-- --------------------------------------------------
CREATE
proc
	sp_insert_bo_user
	(
		@strExchSeg varchar(20), 
		@strServerName varchar(20), 
		@strDBName varchar(20), 
		@strCommonUserName varchar(25), 
		@strCommonUserPwd varchar(15), 
		@strBOAdminName varchar(25), 
		@strBOCategoryName varchar(25) 
	)

as

	declare
		@strSQL varchar(1000)

/*
	@strCommonUserName AND @strBOUserName, WHEN THIS sp IS CALLED, WILL BE THE SAME
*/
set @strSQL = ''

set @strSQL = @strSQL + 'insert into '
set @strSQL = @strSQL + '	tbl_common_login_bo '
set @strSQL = @strSQL + '	( '
set @strSQL = @strSQL + '		exchseg, '
set @strSQL = @strSQL + '		cmn_usr_name, '
set @strSQL = @strSQL + '		bo_usr_name, '
set @strSQL = @strSQL + '		bo_usr_pwd, '
set @strSQL = @strSQL + '		bo_usr_admin_id, '
set @strSQL = @strSQL + '		bo_usr_category, '
set @strSQL = @strSQL + '		bo_usr_status_id, '
set @strSQL = @strSQL + '		bo_usr_status_name '
set @strSQL = @strSQL + '	) '
set @strSQL = @strSQL + '	select '
set @strSQL = @strSQL + '		''' + @strExchSeg + ''' as exchseg, '
set @strSQL = @strSQL + '		''' + @strCommonUserName + ''' as common_user_name, '
set @strSQL = @strSQL + '		''' + @strCommonUserName + '''  as bo_user_name, '
set @strSQL = @strSQL + '		''' + @strCommonUserPwd + '''  as bo_user_pwd, '
set @strSQL = @strSQL + '		cast(a.fldauto_admin as bigint)  as fldauto_admin, '
set @strSQL = @strSQL + '		cast(c.fldcategorycode as bigint)  as fldcategorycode, '
set @strSQL = @strSQL + '		upper(ltrim(rtrim(a.fldstatus)))  as fldstatus, '
set @strSQL = @strSQL + '		upper(ltrim(rtrim(a.fldstname)))  as fldstname '
set @strSQL = @strSQL + '	from '
set @strSQL = @strSQL + '		' + @strServerName + '.' + @strDBName + '.dbo.tbladmin a, '
set @strSQL = @strSQL + '		' + @strServerName + '.' + @strDBName + '.dbo.tblcategory c '
set @strSQL = @strSQL + '	where '
set @strSQL = @strSQL + '		a.fldauto_admin = c.fldadminauto and '
set @strSQL = @strSQL + '		a.fldstatus = ''' + @strBOAdminName + ''' and '
set @strSQL = @strSQL + '		c.fldcategoryname = ''' + @strBOCategoryName + ''''

/*print (@strSQL)*/
exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_insert_common_user
-- --------------------------------------------------
CREATE
proc
	sp_insert_common_user
	(
		@strCommonUserName varchar(25), 
		@strCommonUserPwd varchar(15), 
		@strFirstName varchar(25), 
		@strMiddleName varchar(25), 
		@strLastName varchar(25) 
	)

as

	insert into 
		tbl_common_login
		(
			cmn_usr_name, 
			cmn_usr_pwd, 
			first_name, 
			middle_name, 
			last_name 
		)
	values
		(
			@strCommonUserName, 
			@strCommonUserPwd, 
			@strFirstName, 
			@strMiddleName,
			@strLastName 
		)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_insert_common_user_rm
-- --------------------------------------------------
CREATE Procedure sp_insert_common_user_rm
(
	@UserName Varchar(50)
)
As
Begin
	Begin Tran
		Insert Into tbl_cmn_usr_rm(cmn_usr_name,RM_Party_Code) Values(@UserName,@UserName)
	Commit
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_KYC
-- --------------------------------------------------

CREATE PROCEDURE SP_KYC (@CONAME AS VARCHAR(25), @BRCODE AS VARCHAR(25), @SBCODE AS VARCHAR(25))  
AS  
  
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,  
CL_NAME=CL_NAME COLLATE Latin1_General_CI_AS,  
ABL=UPPER(ABL) COLLATE Latin1_General_CI_AS,  
ACDL=UPPER(ACDL) COLLATE Latin1_General_CI_AS,  
FNO=UPPER(FNO) COLLATE Latin1_General_CI_AS,  
NCDEX=UPPER(NCDEX) COLLATE Latin1_General_CI_AS,  
MCX=UPPER(MCX) COLLATE Latin1_General_CI_AS,  
ASL=UPPER(ASL) COLLATE Latin1_General_CI_AS   
from clients_accountopen where cl_code in (select distinct party_code from mis_to where branch_cd=@BRCODE and sub_broker like replace(@SBCODE,'All','%') and company=@CONAME)  
UNION  
select distinct cl_code=party_code,CL_NAME=party_name,ABL='NO',ACDL='NO',FNO='NO',NCDEX='NO',MCX='NO',ASL='NO'  
from mis_to where sub_broker like replace(@SBCODE,'All','%') and branch_cd=@BRCODE and company=@CONAME  
and sauda_Date >=getdate()-365 AND   
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_KYCopenacc
-- --------------------------------------------------
create PROCEDURE SP_KYCopenacc (@fdate as datetime,@tdate as datetime,@BRCODE AS VARCHAR(25), @SBCODE AS VARCHAR(25))
AS

select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,
CL_NAME=CL_NAME COLLATE Latin1_General_CI_AS,
ABL=UPPER(ABL) COLLATE Latin1_General_CI_AS,
ACDL=UPPER(ACDL) COLLATE Latin1_General_CI_AS,
FNO=UPPER(FNO) COLLATE Latin1_General_CI_AS,
NCDEX=UPPER(NCDEX) COLLATE Latin1_General_CI_AS,
MCX=UPPER(MCX) COLLATE Latin1_General_CI_AS,
ASL=UPPER(ASL) COLLATE Latin1_General_CI_AS 
from clients_accountopen where cl_code in (select distinct party_code from mis_to where branch_cd=@BRCODE and sub_broker=@SBCODE and sauda_Date >=@fdate AND sauda_date<=@tdate )
UNION
select distinct cl_code=party_code,CL_NAME=party_name,ABL='NO',ACDL='NO',FNO='NO',NCDEX='NO',MCX='NO',ASL='NO'
from mis_to where sub_broker=@SBCODE and branch_cd=@BRCODE 
and sauda_Date >=@fdate AND sauda_date<=@tdate and 
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketExecField
-- --------------------------------------------------


CREATE PROC
	sp_list_MarketExecField
AS
Begin
	set transaction isolation level read uncommitted

	select
		MarketExecFieldId = MarketExecFieldId,
		FieldExecName = upper(ltrim(rtrim(FieldExecName))),
		MarketExecRegionId = F.MarketExecRegionId,
		ExecName = upper(ltrim(rtrim(R.ExecName))),
		Region = upper(ltrim(rtrim(F.Region))),
		ExchSeg = upper(ltrim(rtrim(F.ExchSeg))),
		Field = upper(ltrim(rtrim(Field)))
	from
		tblMarketExecFieldMaster F, tblMarketExecRegionMaster R
	where
		F.MarketExecRegionId = R.MarketExecRegionId
		and F.Deleted = 'N'
		and F.Eff_ToDate = 'Dec 31 2999 23:59:00'
		and R.Deleted = 'N'
		and R.Eff_ToDate = 'Dec 31 2999 23:59:00'
	order by
		FieldExecName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketExecRegion
-- --------------------------------------------------


CREATE PROC
	sp_list_MarketExecRegion
AS
Begin
	set transaction isolation level read uncommitted

	select
		MarketExecRegionId = MarketExecRegionId,
		ExecName = upper(ltrim(rtrim(ExecName))),
		MarketHeadId = E.MarketHeadId,
		MarketHeadName = upper(ltrim(rtrim(H.MarketHeadName))),
		ExchSeg = upper(ltrim(rtrim(ExchSeg))),
		Region = upper(ltrim(rtrim(Region)))
	from
		tblMarketExecRegionMaster E, tblMarketHeadMaster H
	where
		E.MarketHeadId = H.MarketHeadId
		and E.Deleted = 'N'
		and E.Eff_ToDate = 'Dec 31 2999 23:59:00'
		and H.Deleted = 'N'
		and H.Eff_ToDate = 'Dec 31 2999 23:59:00'
	order by
		ExecName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketExecRegionNames
-- --------------------------------------------------


CREATE PROC
	sp_list_MarketExecRegionNames
AS
Begin
	set transaction isolation level read uncommitted

	select
		MarketExecRegionId = MarketExecRegionId,
		Region = upper(ltrim(rtrim(Region)))
	from
		tblMarketExecRegionMaster
	where
		Deleted = 'N'
		and Eff_ToDate = 'Dec 31 2999 23:59:00'
	order by
		Region
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketFieldExecNames
-- --------------------------------------------------


CREATE PROC
	sp_list_MarketFieldExecNames
AS
Begin
	set transaction isolation level read uncommitted

	select
		MarketExecFieldId = MarketExecFieldId,
		FieldExecName = upper(ltrim(rtrim(FieldExecName)))
	from
		tblMarketExecFieldMaster
	where
		Deleted = 'N'
		and Eff_ToDate = 'Dec 31 2999 23:59:00'		
	order by
		FieldExecName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketHead
-- --------------------------------------------------


CREATE PROC
	sp_list_MarketHead
AS
Begin
	set transaction isolation level read uncommitted

	select
		MarketHeadId = MarketHeadId,
		MarketHeadName = upper(ltrim(rtrim(MarketHeadName)))
	from
		tblMarketHeadMaster
	where
		Deleted = 'N'
		and Eff_ToDate = 'Dec 31 2999 23:59:00'
	order by
		MarketHeadName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketRegionExecNames
-- --------------------------------------------------


CREATE PROC
	sp_list_MarketRegionExecNames
AS
Begin
	set transaction isolation level read uncommitted

	select
		MarketExecRegionId = MarketExecRegionId,
		ExecName = upper(ltrim(rtrim(ExecName)))
	from
		tblMarketExecRegionMaster
	where
		Deleted = 'N'
		and Eff_ToDate = 'Dec 31 2999 23:59:00'		
	order by
		ExecName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketRegionNames
-- --------------------------------------------------


CREATE PROC
	sp_list_MarketRegionNames
AS
Begin
	set transaction isolation level read uncommitted

	select
		RegionId = RegionId,
		Region = upper(ltrim(rtrim(Region)))
	from
		tblMarketRegionMaster
	where
		Deleted = 'N'
		and Eff_ToDate = 'Dec 31 2999 23:59:00'		
	order by
		Region
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_list_MarketWorkDone
-- --------------------------------------------------

CREATE PROC
	sp_list_MarketWorkDone
AS
Begin
	set transaction isolation level read uncommitted

	select
		MarketWorkDoneId = MarketWorkDoneId,
		MarketHeadId = W.MarketHeadId,
		MarketExecRegionId = W.MarketExecRegionId,
		ExecName = upper(ltrim(rtrim(R.ExecName))),
		MarketExecFieldId = W.MarketExecFieldId,
		FieldExecName = upper(ltrim(rtrim(F.FieldExecName))),
		ExchSeg = upper(ltrim(rtrim(W.ExchSeg))),
		BranchCode = upper(ltrim(rtrim(BranchCode))),
		SubbrokerOrRemisierCode = upper(ltrim(rtrim(SubbrokerOrRemisierCode)))
		
	from
		tblMarketWorkDoneMaster W,
		tblMarketExecFieldMaster F,
		tblMarketExecRegionMaster R
	where
		W.MarketExecFieldId = F.MarketExecFieldId
		and F.MarketExecRegionId = R.MarketExecRegionId
		and W.Deleted = 'N'
		and W.Eff_ToDate = 'Dec 31 2999 23:59:00'
		and F.Deleted = 'N'
		and F.Eff_ToDate = 'Dec 31 2999 23:59:00'
		and R.Deleted = 'N'
		and R.Eff_ToDate = 'Dec 31 2999 23:59:00'
	order by
		FieldExecName
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_mis_l1_getfromdates
-- --------------------------------------------------
CREATE
proc
	sp_mis_l1_getfromdates
	(
		@strExchange varchar(20),
		@strSegment varchar(20)
	)

as

Set @strExchange = Upper(LTrim(RTrim(@strExchange)))
Set @strSegment = Upper(LTrim(RTrim(@strSegment)))

If @strExchange = 'NSE' AND @strSegment = 'CAPITAL'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as min_date
	from
		intranet.bsedb_ab.dbo.level1mis
	where
		ltrim(rtrim(exchangesegment)) = 'NSECM'
end

If @strExchange = 'BSE' AND @strSegment = 'CAPITAL'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as min_date
	from
		intranet.bsedb_ab.dbo.level1mis
	where
		ltrim(rtrim(exchangesegment)) = 'BSECM'
end

If @strExchange = 'NSE' AND @strSegment = 'FUTURES'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as min_date
	from
		intranet.bsedb_ab.dbo.level1mis
	where
		ltrim(rtrim(exchangesegment)) = 'NSEFO'
end


If @strExchange = 'MCX' AND @strSegment = 'FUTURES'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as min_date
	from
		intranet.bsedb_ab.dbo.level1mis
	where
		ltrim(rtrim(exchangesegment)) = 'MCX'
end

If @strExchange = 'NCDEX' AND @strSegment = 'FUTURES'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as min_date
	from
		intranet.bsedb_ab.dbo.level1mis
	where
		ltrim(rtrim(exchangesegment)) = 'NCX'
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_mis_l1_gettodates
-- --------------------------------------------------

CREATE
proc
	[dbo].[sp_mis_l1_gettodates]
	(
		@strExchange varchar(20),
		@strSegment varchar(20)
	)

as

Set @strExchange = Upper(LTrim(RTrim(@strExchange)))
Set @strSegment = Upper(LTrim(RTrim(@strSegment)))

If @strExchange = 'NSE' AND @strSegment = 'CAPITAL'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(cast (sauda_date as datetime)), 103) as max_date
	from
		AngelNseCM.msajag.dbo.details
end

If @strExchange = 'BSE' AND @strSegment = 'CAPITAL'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(cast (sauda_date as datetime)), 103) as max_date
	from
		AngelBSECM.bsedb_ab.dbo.details
end

If @strExchange = 'NSE' AND @strSegment = 'FUTURES'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as max_date
	from
		angelfo.nsefo.dbo.fobillvalan
end

If @strExchange = 'MCX' AND @strSegment = 'FUTURES'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as max_date
	from
		angelcommodity.mcdx.dbo.fobillvalan
end

If @strExchange = 'NCDEX' AND @strSegment = 'FUTURES'
begin
	set transaction isolation level read uncommitted

	select 
		convert(varchar, max(sauda_date), 103) as max_date
	from
		angelcommodity.ncdx.dbo.fobillvalan
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_mis_l1_search
-- --------------------------------------------------

CREATE
proc
	[dbo].[sp_mis_l1_search]
	(
		@strExchange varchar(20),
		@strSegment varchar(20),
		@intYear smallint,
		@intMonth smallint,
		@strWhatToDo varchar(10),
		@strWhatToShow varchar(10)
	)

as

Set @strExchange = Upper(LTrim(RTrim(@strExchange)))
Set @strSegment = Upper(LTrim(RTrim(@strSegment)))
Set @strWhatToDo = Upper(LTrim(RTrim(@strWhatToDo)))

Declare 
	@strSelect varchar(1000),
	@strOrder varchar(50),
	@Where varchar(500),
	@TableName varchar(50)

Set @strSelect = ' set transaction isolation level read uncommitted '
Set @Where = ' where  1 = 1 '
Set @strOrder = ' order by 1 '

If @strWhatToShow='YEAR'
begin
	Set @strSelect = @strSelect + ' select distinct year(cast (sauda_date as datetime)) as year from '
end

If @strWhatToShow='DAYS'
begin
	Set @strSelect = @strSelect + ' select distinct cast (left(convert(varchar, cast (sauda_date as datetime), 109), 11) as datetime) as dummydays1, '
	Set @strSelect = @strSelect + ' convert(varchar, cast (sauda_date as datetime), 103) as dummydays, '
	Set @strSelect = @strSelect + ' left(convert(varchar, cast (sauda_date as datetime), 109), 11) as days from '

	Set @Where = @Where + ' and year(cast (sauda_date as datetime)) = ' + cast(@intYear as varchar)  + ' '
	Set @Where = @Where + ' and month(cast (sauda_date as datetime)) = ' + cast(@intMonth as varchar) + ' '
end

If @strExchange = 'NSE' AND @strSegment = 'CAPITAL' 
begin
	If @strWhatToDo = 'FROMDATE'
	begin
		Set @TableName =  'intranet.bsedb_ab.dbo.level1mis '
		Set @Where = @Where + ' and exchangesegment = ''NSECM'' '
	end
	If @strWhatToDo = 'TODATE'
	begin
		Set @TableName = ' AngelNseCM.msajag.dbo.details '
		Set @strOrder = @strOrder + ' desc '
	end
end

If @strExchange = 'BSE' AND @strSegment = 'CAPITAL' 
begin
	If @strWhatToDo = 'FROMDATE' 
	begin
		Set @TableName = ' intranet.bsedb_ab.dbo.level1mis '
		Set @Where = @Where + ' and exchangesegment = ''BSECM'' '
	end
	If @strWhatToDo = 'TODATE' 
	begin
		Set @TableName = ' AngelBSECM.bsedb_ab.dbo.details '
		Set @strOrder = @strOrder + ' desc '
	end
end

If @strExchange = 'NSE' AND @strSegment = 'FUTURES' 
begin
	If @strWhatToDo = 'FROMDATE' 
	begin
		Set @TableName = ' intranet.bsedb_ab.dbo.level1mis '
		Set @Where = @Where + ' and exchangesegment = ''NSEFO'' '
	end
	If @strWhatToDo = 'TODATE' 
	begin
		Set @TableName = ' angelfo.nsefo.dbo.fobillvalan '
		Set @strOrder = @strOrder + ' desc '
	end
end


If @strExchange = 'MCX' AND @strSegment = 'FUTURES' 
begin
	If @strWhatToDo = 'FROMDATE' 
	begin
		Set @TableName = ' intranet.bsedb_ab.dbo.level1mis '
		Set @Where = @Where + ' and exchangesegment = ''MCX'' '
	end
	If @strWhatToDo = 'TODATE' 
	begin
		Set @TableName = ' angelcommodity.mcdx.dbo.fobillvalan '
		Set @strOrder = @strOrder + ' desc '
	end
end

If @strExchange = 'NCDEX' AND @strSegment = 'FUTURES' 
begin
	If @strWhatToDo = 'FROMDATE' 
	begin
		Set @TableName = ' intranet.bsedb_ab.dbo.level1mis '
		Set @Where = @Where + ' and exchangesegment = ''NCX'' '
	end
	If @strWhatToDo = 'TODATE' 
	begin
		Set @TableName = ' angelcommodity.ncdx.dbo.fobillvalan '
		Set @strOrder = @strOrder + ' desc '
	end
end

print (@strSelect + @TableName + @Where + @strOrder)
exec (@strSelect + @TableName + @Where + @strOrder)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_MisTrial_9
-- --------------------------------------------------
-- In this Branchwise, SegmentWise, AllTotals, Branch SubBroker Wise,
-- corrected Dates in from - to, Percentage and TOP are working fine.
-- A parameter is added here for selecting the order for the TOP 
-- One more parameter is added for Exchange Segment

CREATE PROCEDURE sp_MisTrial_9
(
	@Consol varchar(25) = '',
	@DateFrom varchar(50) = '',
	@DateTo varchar(50) = '',
	@Year varchar(4) = '',
	@Month varchar(15) = '',
	@BranchCode varchar(10) = '',
	@Exchange varchar(10) = '',
	@SubBroker varchar(10) = '',
	@Family varchar(10) = '',
	@Party varchar(10) = '',
	@SelectTop int = 0,
	@SelectOrderBy varchar(200) = '',
	@flgSegment int = 0
)

AS

DECLARE	
	--@dd as varchar(6000),
	@@SELECT AS varchar(6000),
	@@FROM AS varchar(4000),
	@@WHERE AS varchar(6000),
	@@GROUPBY AS varchar(2000),
	@@ORDERBY AS varchar(2000),
	@@SELECT_FINAL AS varchar(6000),
	
	@@TOTVOLUME AS bigint,
	@@TOTTURNOVER AS bigint,
	@@TOTBROKERAGE AS bigint,
	@@TOTSELECT AS varchar(6000),
	@@TOTWHERE AS varchar(6000),
	@@strTotVolume as varchar(80),
	@@strTotTurnOver as varchar(80),
	@@strTotBrokerage as varchar(80),
	@@ErrId int
-----------------------------------------------------------------------------------------------------

--Initialization of variables
set @@SELECT  = 'This is Initialization of @@select' 
set @@FROM  = 'This is Initialization of @@from' 
set @@WHERE  = 'This is Initialization of @@where' 
set @@GROUPBY  = 'This is Initialization of @@groupby' 
set @@ORDERBY  = 'This is Initialization of @@orderby' 
set @@SELECT_FINAL  = 'This is Initialization of @@select_final' 
-----------------------------------------------------------------------------------------------------

-- This is Select part for the totals which are used in the Percentage. 
IF ( ( @Consol = 'BranchWise' AND @Month <> '' ) OR ( @Consol = 'SegmentWise' AND @Month <> '' ) OR ( @Consol = 'AllTotals' AND @Month <> '' ) )
	BEGIN
		
		SET @@TOTSELECT = ' SELECT  SUM ( cast(TP as bigint) + TS + DP + DS ) as TotalVolume, SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TotalTurnOver, SUM (cast(TPB as money) + TSB + DPB + DSB) as TotalBrokerage '
	END
ELSE
	BEGIN
		SET @@TOTSELECT = ' SELECT SUM ( cast(TradingPurQty as bigint) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) as TotalVolume, SUM ( cast(TradingPurAmt as bigint) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) as TotalTurnOver, SUM (cast(TradingPurBrok as bigint)+ TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) as TotalBrokerage '
	END

-----------------------------------------------------------------------------------------------------

-- This is where part for the Totals which ate used in the Percentage
--SET @@TOTWHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date  <= CONVERT( DATETIME, ''' + @DateTo + '''  ) '


-----------------------------------------------------------------------------------------------------
-- START OF FROM
IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @Month = '' )
			BEGIN
				SET @@FROM  = ' FROM Level4Mis '
			END
		ELSE
			BEGIN
				SET @@FROM  = ' FROM Level1Mis '
			END
	END

IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Month = '' )
			BEGIN
				SET @@FROM  = ' FROM Level6Mis '
			END
		ELSE
			BEGIN
				SET @@FROM  = ' FROM Level1Mis '
			END
	END


IF (@Consol = 'AllTotals' )
	BEGIN
		IF (@Month = '' )
			BEGIN
				SET @@FROM  = ' FROM Level6Mis '
			END
		ELSE
			BEGIN
				SET @@FROM  = ' FROM Level1Mis '
			END
	END

IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				SET @@FROM  = ' FROM Level5Mis '	
			END
		ELSE
			BEGIN
				IF ( @SubBroker = '' )
					BEGIN
						SET @@FROM  = ' FROM Level4Mis '
					END
				ELSE
					BEGIN
						IF ( @Family = '' )
							BEGIN
								SET @@FROM  = ' FROM Level3Mis '
							END
						ELSE
							BEGIN
								SET @@FROM  = ' FROM Level2Mis '
							END
					END
			END
	END

--END OF FROM
-----------------------------------------------------------------------------------------------------

-- START OF WHERE
IF ( @Consol = 'BranchWise' ) 
	BEGIN
		IF ( @BranchCode = '' ) 
			BEGIN
				SET @@WHERE = ' WHERE From_Date >= CONVERT( DATETIME, ''' + @DateFrom + ''' ) AND To_Date  <= CONVERT( DATETIME, ''' + @DateTo + '''  ) '
			END	
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) AND Branch_cd = ''' + @BranchCode + ''''
					END
				ELSE
					BEGIN
						IF (@Month = '' )
							BEGIN
								SET @@WHERE = 'WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) AND Branch_cd = ''' + @BranchCode + ''' AND [Year] = ' + @Year
							END
						ELSE
							BEGIN
								SET @@WHERE = 'WHERE Branch_cd = ''' + @BranchCode + ''' AND DATEPART (YYYY, Sauda_Date) = ' + @Year + ' AND DATEPART (MM, Sauda_Date) = ' + @Month
							END
					END
			END
	END

IF ( @Consol = 'SegmentWise' ) 
	BEGIN
		IF ( @Exchange = '' ) 
			BEGIN
				SET @@WHERE = 'WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
			END	
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						SET @@WHERE = 'WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo +  ''' ) AND ExchangeSegment = ''' + @Exchange + ''''
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								SET @@WHERE = 'WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) AND ExchangeSegment = ''' + @Exchange + ''' AND [Year] = ''' + @Year + ''''
							END
						ELSE
							BEGIN
								SET @@WHERE = 'WHERE ExchangeSegment = ''' + @Exchange + ''' AND DATEPART (YYYY, Sauda_Date) = ' + @Year + ' AND DATEPART (MM, Sauda_Date) = ' + @Month
							END
					END
			END
	END

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				SET @@WHERE = 'WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo +  ''' ) '
			END
		ELSE
			BEGIN
				IF ( @Month = '' )
					BEGIN
						SET @@WHERE = 'WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) AND [Year] = ''' + @Year + ''''	
					END
				ELSE
					BEGIN
						SET @@WHERE = 'WHERE DATEPART (YYYY, Sauda_Date) = ''' + @Year + ''' AND DATEPART (MM, Sauda_Date) = ''' + @Month + ''''
					END
			END
	END

IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) '
			END
		ELSE
			BEGIN
				IF ( @SubBroker = '' )
					BEGIN
						SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) AND Branch_cd = ''' + @BranchCode + '''' 
					END
				ELSE
					BEGIN
						IF ( @Family = '' )
							BEGIN
								SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) AND Branch_cd = ''' + @BranchCode + ''' AND Sub_Broker = ''' + @SubBroker + ''''
							END
						ELSE
							BEGIN
								SET @@WHERE = ' WHERE From_Date >= CONVERT ( DATETIME, ''' + @DateFrom + ''' ) AND To_Date <= CONVERT ( DATETIME, ''' + @DateTo + ''' ) AND Branch_cd = ''' + @BranchCode + ''' AND Sub_Broker = ''' + @SubBroker + ''' AND Family = ''' + @Family + ''''
							END
					END	
			END
	END

--END OF WHERE
-----------------------------------------------------------------------------------------------------

-- START OF GROUP BY
IF ( @Consol = 'BranchWise' )
	BEGIN
		IF ( @BranchCode = '')
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd, ExchangeSegment '							
					end
				else
					begin
						SET @@GROUPBY  = ' GROUP BY Branch_cd '				
					end		
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY  = ' GROUP BY [Year], ExchangeSegment '								
							end
						else
							begin
								SET @@GROUPBY  = ' GROUP BY [Year] '		
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month], ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY [Year], [Month]'				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date, ExchangeSegment '									
									end
								else
									begin
										SET @@GROUPBY  = ' GROUP BY DATEPART (YYYY, Sauda_Date), DATEPART (MM, Sauda_Date), Sauda_Date '				
									end		
							END
					END
			END
	END

IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@GROUPBY  = ' GROUP BY ExchangeSegment '
			END
		ELSE
			BEGIN
				IF ( @year = '' )
					BEGIN	
						SET @@GROUPBY =  ' GROUP BY [Year] '
					END	
				ELSE
					BEGIN
						IF (@Month = '' )
							BEGIN
								SET @@GROUPBY =  ' GROUP BY [Year], [Month] '
							END
						ELSE
							BEGIN
								SET @@GROUPBY =  ' GROUP BY DATEPART (DD, Sauda_Date) '
							END
					END
			END
	END

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY [Year], Exchangesegment '								
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY [Year] '		
					end		
			END
		ELSE
			BEGIN	
				IF ( @Month = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month], ExchangeSegment '										
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY [Year], [Month] '												
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date), ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY DATEPART (DD, Sauda_Date) '		
							end		
					END
			END
	END

IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd, ExchangeSegment '										
					end
				else
					begin
						SET @@GROUPBY = ' GROUP BY Branch_cd '									
					end		
			END
		ELSE
			BEGIN
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@GROUPBY = ' GROUP BY Sub_Broker, ExchangeSegment '									
							end
						else
							begin
								SET @@GROUPBY = ' GROUP BY Sub_Broker '				
							end		
					END
				ELSE
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Family, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Family '				
									end		
							END
						ELSE
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@GROUPBY = ' GROUP BY Party_code, ExchangeSegment '								
									end
								else
									begin
										SET @@GROUPBY = ' GROUP BY Party_code '		
									end		
							END
					END
			END
	END
--END OF GROUP BY
-----------------------------------------------------------------------------------------------------

-- START OF ORDER BY
If ( @SelectOrderBy = '' )
	Begin
		IF ( @Consol = 'BranchWise' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY  = ' ORDER BY Branch_cd'
					END
				ELSE
					BEGIN
						IF ( @Year = '' )
							BEGIN
								SET @@ORDERBY  = ' ORDER BY [YEAR]'
							END
						ELSE
							BEGIN
								IF ( @Month = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY [Year], [Month] '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY DATEPART ( DD, Sauda_Date ) '
									END
							END
					END
			END

		IF ( @Consol = 'SegmentWise' )
		BEGIN
			IF (@Exchange = '' )
				BEGIN
					SET @@ORDERBY  = ' ORDER BY ExchangeSegment'
				END
			ELSE
				BEGIN	
					IF ( @Year = '' ) 
						BEGIN
							SET @@ORDERBY  = ' ORDER BY [YEAR] '  
						END
					ELSE
						BEGIN
							IF ( @Month = '' ) 
								BEGIN
									SET @@ORDERBY  = ' ORDER BY [Month] '
								END
							ELSE
								BEGIN
									SET @@ORDERBY  = ' ORDER BY DATEPART (DD, Sauda_Date) '
								END
						END
				END
		END

		IF (@Consol = 'AllTotals' )
			BEGIN
				IF ( @Year = '' )
				BEGIN
					SET @@ORDERBY = ' ORDER BY [Year] '
				END
			ELSE
				BEGIN
					IF ( @Month = '' )
						BEGIN
							SET @@ORDERBY = ' ORDER BY [Month] '		
						END
					ELSE
						BEGIN
							SET @@ORDERBY = ' ORDER BY DATEPART (DD, Sauda_Date) '
						END
				END
			END
	
		IF ( @Consol = 'BranchSubBroker' )
			BEGIN
				IF ( @BranchCode = '' )
					BEGIN
						SET @@ORDERBY = ' ORDER BY Branch_cd '	
					END
				ELSE
					BEGIN
						IF ( @SubBroker = '' )
							BEGIN
								SET @@ORDERBY = ' ORDER BY Sub_Broker '
							END
						ELSE
							BEGIN
								IF ( @Family = '' )
									BEGIN
										SET @@ORDERBY = ' ORDER BY Family '
									END
								ELSE
									BEGIN
										SET @@ORDERBY = ' ORDER BY Party_code'
									END
							END				
					END
			END
	End
Else
	Begin
		Set @@ORDERBY = ' ORDER BY ' + @SelectOrderBy + ' DESC '
	End
--END OF ORDER BY
-----------------------------------------------------------------------------------------------------

-- Concatenating and Execution of Totals in the Percentage
--EXEC ( @@TOTSELECT + @@FROM + @@WHERE ) 
--print ( @@TOTSELECT + @@FROM + @@WHERE ) 

Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )
Insert #TotalAll
Exec ( @@TOTSELECT + @@FROM + @@WHERE ) 
select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll
Drop Table #TotalAll

--print @@TotVolume
--print @@TotTurnOver
--print @@TotBrokerage
If ( @@TotVolume = '' ) 
begin
	set @@TotVolume = 1
end

if  ( @@TotTurnOver = '' )
begin	
	set @@TotTurnOver = 1
end

if ( @@TotBrokerage = '' )
begin
	set @@TotBrokerage = 1
end

select @@strTotVolume = @@TotVolume
--print @@strTotVolume
select @@strTotTurnOver = @@TotTurnOver
select @@strTotBrokerage = @@TotBrokerage
--select @@strTotBrokerage

-----------------------------------------------------------------------------------------------------

-- START OF SELECT
IF ( @Consol = 'BranchWise' )
	BEGIN
		--print 'aaa'
		IF ( @BranchCode = '') 
			BEGIN	
				--print 'bbb'
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = ' Branch_cd, ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, (  ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '				
					end
				else
					begin
						SET @@SELECT = ' Branch_cd, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, (  ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
					end
			END
		ELSE
			BEGIN
				IF ( @Year = '')
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = ' [Year], ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
							end
						else
							begin
								SET @@SELECT = ' [Year], SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '		
							end		
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '													
									end
								else
									begin
										SET @@SELECT = ' datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) as ''Month Name'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '								
									end		
							END
						ELSE
							BEGIN 
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, ExchangeSegment, SUM ( cast(TP as money) + TS + DP + DS ) as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '															
									end
								else
									begin
										SET @@SELECT = ' DATEPART ( DD, Sauda_Date ) as Day, SUM ( cast(TP as money) + TS + DP + DS ) as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '								
									end		
							END
					END
			END
	END

IF ( @Consol = 'SegmentWise' )
	BEGIN
		IF (@Exchange = '' )
			BEGIN
				SET @@SELECT = ' ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
			END
		ELSE
			BEGIN
				IF ( @Year = '' )
					BEGIN
						SET @@SELECT = ' [Year], SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
					END
				ELSE
					BEGIN
						IF ( @Month = '' )
							BEGIN
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '
							END
						ELSE
							BEGIN	
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, SUM ( cast(TP as money) + TS + DP + DS ) as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '
							END
					END
			END
	END 

IF (@Consol = 'AllTotals' )
	BEGIN
		IF ( @Year = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  [Year], ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
					end
				else
					begin
						SET @@SELECT = '  [Year], SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '														
					end		
			END
		ELSE
			BEGIN
				IF ( @Month = '' )
					BEGIN	
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
							end
						else
							begin
								SET @@SELECT = '  datename(month,convert(datetime ,cast([Month] as varchar) + ''/01/'' + cast([Year] as varchar))) AS ''Month Name'', SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume+ ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '																	
							end		
					END
				ELSE
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, ExchangeSegment, SUM ( cast(TP as money) + TS + DP + DS ) as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '															
							end
						else
							begin
								SET @@SELECT = '  DATEPART (DD, Sauda_Date) AS Day, SUM ( cast(TP as money) + TS + DP + DS ) as Volume, ( ( SUM ( cast(TP as money ) + TS + DP + DS )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TPA as money) + TSA + DPA + DSA ) as TurnOver, ( ( SUM ( cast(TPA as money) + TSA + DPA + DSA ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TPB as money) + TSB + DPB + DSB) as Brokerage , ( ( SUM (cast(TPB as money ) + TSB + DPB + DSB) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage ''  '			
							end		
						
					END
			END
	END
	
IF ( @Consol = 'BranchSubBroker' )
	BEGIN
		IF ( @BranchCode = '' )
			BEGIN
				If ( @flgSegment = 1 )
					begin
						SET @@SELECT = '  Branch_cd, ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
					end
				else
					begin
						SET @@SELECT = '  Branch_cd, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '									
					end		
			END
		ELSE	
			BEGIN	
--print 'specidied the branch'
				IF ( @SubBroker = '' )
					BEGIN
						If ( @flgSegment = 1 )
							begin
								SET @@SELECT = '  Sub_Broker, ExchangeSegment,SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '															
							end
						else
							begin
								SET @@SELECT = '  Sub_Broker, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '									
							end		
					END
				ELSE
--print 'specified the sub broker'
					BEGIN
						IF ( @Family = '' )
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Family, ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '									
									end
								else
									begin
										SET @@SELECT = '  Family, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '				
									end		
							END
						ELSE	
--print 'specified the family'	
							BEGIN
								If ( @flgSegment = 1 )
									begin
										SET @@SELECT = '  Party_code, ExchangeSegment, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '									
									end
								else
									begin
										SET @@SELECT = '  Party_code, SUM ( cast(TradingPurQty as money) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty ) AS Volume, ( ( SUM ( cast(TradingPurQty as money ) + TradingSaleQty + DeliveryPurQty + DeliverySaleQty )  / ' + @@strTotVolume + ' ) * 100 ) AS '' % Volume ''  , SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) AS TurnOver, ( ( SUM ( cast(TradingPurAmt as money) + TradingSaleAmt + DeliveryPurAmt + DeliverySaleAmt ) / ' + @@strTOTTURNOVER + ' ) * 100 ) AS '' % Turn Over '', SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) AS Brokerage, ( ( SUM (cast(TradingPurBrok as money ) + TradingSaleBrok + DeliveryPurBrok + DeliverySaleBrok) / ' + @@strTOTBROKERAGE + ' ) * 100 ) AS '' % Brokerage '' '				
									end		
								
--print @@strTOTTURNOVER
--print @@SELECT
							END
					END
			END	
	END	


--END OF SELECT
-----------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------

--START OF @@SELECT_FINAL
---print 'ccc'
IF ( @SelectTop = 0 )
begin
--	print 'ddd'
	SET @@SELECT_FINAL = ' SELECT ' + @@SELECT
--	print @@SELECT_FINAL
---print 'eee'
end
ELSE
	SET @@SELECT_FINAL = ' SELECT TOP ' + CONVERT ( VARCHAR , @SelectTop ) + @@SELECT


--END OF @@SELECT_FINAL
-----------------------------------------------------------------------------------------------------
--If ( @@SELECT <> '' )
--	Begin
		EXEC ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )
--	End
/*
Set @@ErrId = @@ERROR
If @@ErrId <> 0 
	Begin
		RAISERROR ( 'An error occured', 10, 1 )
	End
*/
--print 'reached the print' 
--print @@SELECT_FINAL
--PRINT ( @@SELECT_FINAL + @@FROM + @@WHERE + @@GROUPBY + @@ORDERBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ModifyBankRecord
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_ModifyBankRecord    Script Date: 09/11/2005 6:47:27 PM ******/
create proc
	sp_ModifyBankRecord
	(
		@intBankCode bigint,
		@strBankName varchar(50)
	)
AS
Begin
	set @strBankName = ltrim(rtrim(@strBankName))
	
        begin tran

		  Update 
			BankMaster
			    set 
                                BankName =@strBankName     
		  where BankCode = @intBankCode 
	if @@error = 0 
          commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ModifyBranchRecord
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_ModifyBranchRecord    Script Date: 09/11/2005 6:47:27 PM ******/
--sp_helptext sp_ModifyBranchRecord
CREATE proc
	sp_ModifyBranchRecord
	(
		@intBankBranchCode bigint,
		@intBankCode bigint,
		@strBranchName varchar(50),
		@strAdd1 varchar(250),
                @strAdd2 varchar(250),
		@strCity varchar(25),
		@strState varchar(25),
                @strNation varchar(25),
		@strZip varchar(10),
		@strPhone1 varchar(25),
                @strPhone2 varchar(25),
		@strFax varchar(25),
		@strEmail varchar(50)
	)
AS
Begin
	set @strBranchName = ltrim(rtrim(@strBranchName))
        set @strAdd1 = ltrim(rtrim(@strAdd1))
        set @strAdd2 = ltrim(rtrim(@strAdd2))
	set @strCity = ltrim(rtrim(@strCity))
        set @strState = ltrim(rtrim(@strState))
	set @strNation = ltrim(rtrim(@strNation))
        set @strZip = ltrim(rtrim(@strZip))
	set @strPhone1 = ltrim(rtrim(@strPhone1))
        set @strPhone2 = ltrim(rtrim(@strPhone2))
	set @strFax = ltrim(rtrim(@strFax))
        set @strEmail = ltrim(rtrim(@strEmail))
	
        begin tran

		  Update 
			BankBranchMaster
			    set 
                                BankCode =@intBankCode,
				BranchName =@strBranchName,
				Address1 = @strAdd1,
                                Address2 =@strAdd2,
                                City = @strCity,
                                State =@strState,
                                Nation =@strNation,
                                Zip=@strZip,
                                Phone1=@strPhone1,
                                Phone2=@strPhone2,
                                Fax=@strFax,
                                Email=@strEmail     
		  where BankBranchCode = @intBankBranchCode 
	if @@error = 0 
          commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ModifyFDRecord
-- --------------------------------------------------




/****** Object:  Stored Procedure dbo.sp_ModifyFDRecord    Script Date: 09/11/2005 6:47:27 PM ******/
--sp_helptext sp_ModifyFDRecord

CREATE    proc
	sp_ModifyFDRecord
	(
		@intFDCode bigint,
		@intBankBranchCode bigint,
		@strFDNo varchar(20),
		@strCompName varchar(20),
                @strSegment varchar(10),
		@strNew varchar(5),
		@MoneyDepositAmt Money,
                @ActualExpDate datetime,
		@effFrom datetime,
		@effTo datetime,
                @moneyROI Money,
		@strCustID varchar(20),
		@TDS money,
		@Commission money,
		@strReinvest varchar(15)
	)
AS
Begin
	set @strFDNo = ltrim(rtrim(@strFDNo))
	set @strCompName = ltrim(rtrim(@strCompName))
        set @strSegment = ltrim(rtrim(@strSegment))
        set @strNew = ltrim(rtrim(@strNew))
        set @strCustID = ltrim(rtrim(@strCustID))
        set @strReinvest = ltrim(rtrim(@strReinvest))
        begin tran

		  Update 
			FDMaster
			    set 
                                BankBranchCode =@intBankBranchCode,
				FDNo =@strFDNo,
				CompName = @strCompName,
                                Segment =@strSegment,
                                New = @strNew,
                                DepositAmount =@MoneyDepositAmt,
                                ActualExpDate =@ActualExpDate,
                                effFrom=@effFrom,
                                effTo=@effTo,
				ROI=@moneyROI, 
				CustomerID = @strCustID,
				TDS = @TDS,
				Commission = @Commission,
				Reinvest = @strReinvest,
				ModificationDate = getdate()    
		  where FDCode = @intFDCode 
	if @@error = 0 
          commit else rollback tran
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ModifyROCRecord
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_ModifyROCRecord    Script Date: 09/11/2005 6:47:27 PM ******/

CREATE
proc
	sp_ModifyROCRecord
	(
		@BankCode bigint,
		@ROC Money
	)

as

	select top 1
		BankCode
	from
		BankROCRateMaster
	where
		BankCode = @BankCode and
		effFromDt = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'

	if @@RowCount = 0
	/*Rec Edited On The Same Day Not Found*/
	/*Update The Existing Active Rec*/
	/*Insert A New Active Rec*/
	begin
		update
			BankROCRateMaster
		set
			active = 'N',
			effToDt = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'
		where
			BankCode = @BankCode and
			active = 'Y' /*and
			eff_to = 'Dec 31 2999 23:59:00'*/

			declare @strROC varchar(10)
			set @strROC = convert(varchar, @ROC)

			--if @@error = 0
			--begin
				exec ('sp_AddBankROC ' +  @BankCode + ', ' + @strROC)
			--end
	end
	else
	/*Rec Edited On The Same Day Found*/
	/*Update This Rec, And The Active Rec*/
	begin

		update
			BankROCRateMaster
		set
			ROC = @ROC
		where
			BankCode = convert(varchar,@BankCode) and
			active = 'Y' /*and
			eff_to = 'Dec 31 2999 23:59:00'*/
	end
  

SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ModifyROIRecord
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_ModifyROIRecord    Script Date: 09/11/2005 6:47:27 PM ******/

CREATE
proc
	sp_ModifyROIRecord
	(
		@BankCode bigint,
		@ROI Money
	)

as

	declare
		@ROI_Active money


	select top 1
		BankCode
	from
		BankROIRateMaster
	where
		BankCode = @BankCode and
		effFromDt = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'

	if @@RowCount = 0
	/*Rec Edited On The Same Day Not Found*/
	/*Update The Existing Active Rec*/
	/*Insert A New Active Rec*/
	begin
		update
			BankROIRateMaster
		set
			active = 'N',
			effToDt = left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'
		where
			BankCode = @BankCode and
			active = 'Y' /*and
			eff_to = 'Dec 31 2999 23:59:00'*/

			declare @strROI varchar(10)
			set @strROI = convert(varchar, @ROI)

			--if @@error = 0
			--begin
				exec ('sp_AddBankROI ' +  @BankCode + ', ' + @strROI)
			--end
	end
	else
	/*Rec Edited On The Same Day Found*/
	/*Update This Rec, And The Active Rec*/
	begin

		update
			BankROIRateMaster
		set
			ROI = @ROI
		where
			BankCode = convert(varchar,@BankCode) and
			active = 'Y' /*and
			eff_to = 'Dec 31 2999 23:59:00'*/
	end
  

SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_pagingquery
-- --------------------------------------------------

/*
exec sp_pagingquery
	@strTableName = 'client1',
	@pk = 'short_name',
	@intCurrentPageNumber = 5,
	@intPageSize = 40,
	@strFieldList='*',
	@strMainWhere = '',
	@strMainGroupBy = '',
	@strMainOrderBy = ''
*/

CREATE proc
	sp_pagingquery
	(
		@strTableName varchar(100),
		@pk varchar(100),
/*		@intCurrentPageNumber int = 1,*/
		@intCurrentPageNumber int,
/*		@intPageSize int = 5,*/
		@intPageSize int,
/*		@strFieldList varchar(1000) = '*',*/
		@strFieldList varchar(1000),
		@strMainWhere varchar(1000),
		@strMainGroupBy varchar(1000),
		@strMainOrderBy varchar(1000)
	)

as

begin
	declare
		@strInnerWhere varchar(1000),
		@strOuterWhere varchar(1000),
		@strGroupBy varchar(1000),
		@strOrderBy varchar(1000),
		@strSkippedRows varchar(50)

	/* default page number */
	if (@intCurrentPageNumber < 1) or (len(ltrim(rtrim(@intCurrentPageNumber))) = 0) set @intCurrentPageNumber = 1

	/* set paging variable */
	set @strSkippedRows = @intPageSize * (@intCurrentPageNumber - 1)

	/* set filter and group variables */
	if @strMainWhere is not null and @strMainWhere != ''
		begin
			set @strInnerWhere = ' where ' + @strMainWhere + ' '
			set @strOuterWhere = ' and ' + @strMainWhere
		end
	else
		begin
			set @strInnerWhere = ''
			set @strOuterWhere = ''
		end

	if @strMainGroupBy is not null and @strMainGroupBy != ''
		set @strGroupBy = ' group by ' + @strMainGroupBy + ' '
	else
		set @strGroupBy = ''

	/* sorting order */
	if @strMainOrderBy is not null and @strMainOrderBy != ''
		set @strOrderBy = ' order by ' + @strMainOrderBy + ' '
	else
		set @strOrderBy = ''

	if @intCurrentPageNumber = 1
		begin
			exec (	'select top ' + @intPageSize + ' ' + @strFieldList + 
				' from ' + @strTableName + @strInnerWhere + @strGroupBy + @strOrderBy )

			print (	'select top ' + cast(@intPageSize as varchar) + ' ' + @strFieldList + 
				' from ' + @strTableName + @strInnerWhere + @strGroupBy + @strOrderBy )

		end
	else
		begin
			exec ( 'select top ' + @intPageSize + ' ' + @strFieldList + ' from ' + @strTableName + ' where ' + @pk + ' in ' + 
				' (select top ' + @intPageSize + ' ' + @pk + ' from ' + @strTableName + 
				'  where ' + @pk + ' not in 
					(select top ' + @strSkippedRows + ' ' + @pk + ' from ' + @strTableName +
						@strInnerWhere + @strGroupBy + @strOrderBy + ') ' + 
				   @strOuterWhere + @strGroupBy + @strOrderBy + ') ' +
				@strGroupBy + @strOrderBy
			      )

			print ( 'select ' + @strFieldList + ' from ' + @strTableName + ' where ' + @pk + ' in ' + 
				' (select top ' + cast(@intPageSize as varchar) + ' ' + @pk + ' from ' + @strTableName + 
				'  where ' + @pk + ' not in 
					(select top ' + @strSkippedRows + ' ' + @pk + ' from ' + @strTableName +
						@strInnerWhere + @strGroupBy + @strOrderBy + ') ' + 
				   @strOuterWhere + @strGroupBy + @strOrderBy + ') ' +
				@strGroupBy + @strOrderBy
			      )

		end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_PAN
-- --------------------------------------------------

CREATE PROCEDURE SP_PAN (@CONAME AS VARCHAR(25), @BRCODE AS VARCHAR(25), @SBCODE AS VARCHAR(25))  
AS  
  
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,  
CL_NAME=SHORT_NAME COLLATE Latin1_General_CI_AS,  
PAN_GIR_NO=(CASE WHEN UPPER(PAN_GIR_NO COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)   
from kyc_documents where cl_code in (select distinct party_code from mis_to where branch_cd=@BRCODE and sub_broker like replace(@SBCODE,'All','%') and company=@CONAME)  
UNION  
select distinct cl_code=party_code,CL_NAME=party_name,PAN_GIR_NO='NO'  
from mis_to where sub_broker like replace(@SBCODE,'All','%') and branch_cd=@BRCODE and company=@CONAME  
and sauda_Date >=getdate()-365 AND   
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )  
ORDER BY CL_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Pivot
-- --------------------------------------------------
CREATE procedure SP_Pivot(@Period as varchar(255))

as

BEGIN

-- with (nolock,Index = bdpid)

Select  *   Into Tb_Pivot  From (
Select Party_code,Family,Sub_Broker,branch_cd,OYear = DatePart(Year,sauda_date),
       JanTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 1 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       JanDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 1 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       JanBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 1 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       JanDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 1 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       JanSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 1 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            JanOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 1 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
     FebTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 2 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       FebDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 2 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       FebBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 2 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       FebDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 2 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       FebSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 2 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            FebOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 2 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
------
             MArTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 3 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       MarDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 3 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       MarBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 3 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       MarDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 3 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       MarSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 3 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            MarOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 3 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
----
    AprTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 4 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       AprDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 4 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       AprBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 4 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       AprDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 4 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       AprSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 4 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            AprOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 4 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
---
MayTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 5 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       MayDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 5 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       MayBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 5 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       MayDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 5 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       MaySertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 5 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            MayOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 5 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),
----
JunTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 6 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       JunDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 6 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       JunBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 6 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       JunDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 6 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       JunSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 6 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            JunOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 6 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),
---
JulTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 7 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       JulDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 7 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       JulBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 7 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       JulDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 7 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       JulSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 7 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            JulOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 7 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
--     
AugTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 8 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       AugDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 8 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       AugBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 8 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       AugDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 8 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       AugSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 8 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            AugOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 8 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
---                                 
SepTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 9 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       SepDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 9 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       SepBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 9 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       SepDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 9 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       SepSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 9 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            SepOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 9 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
---
OctTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 10 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       OctDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 10 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       OctBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 10 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       OctDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 10 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       OctSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 10 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            OctOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 10 
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
--
NovTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 11 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       NovDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 11 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       NovBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 11 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       NovDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 11 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       NovSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 11 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            NovOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 11
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End),     
DecTradingTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 12 
                               Then
                                   TrdAmt
                               Else
                                   0
                               End),
       DecDelTurnover = Sum(Case When 
                                   Datepart(Month,sauda_date) = 12 
                               Then
                                   DelAmt
                               Else
                                   0
                               End),     

       DecBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 12 
                               Then
                                   PBrokTrd + SBrokTrd
                               Else
                                   0
                               End),
       DecDelBrokerage = Sum(Case When 
                                   Datepart(Month,sauda_date) = 12 
                               Then
                                   PBrokDel + SBrokDel
                               Else
                                   0
                               End),     
       DecSertax     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 12 
                               Then
                                   Service_Tax
                               Else
                                   0
                               End),
            DecOtherlevies     = Sum(Case When 
                                   Datepart(Month,sauda_date) = 12
                               Then
                                   Turn_Tax+Sebi_Tax + Ins_Chrg + Broker_Chrg + Other_Chrg
                               Else
                                   0
                               End)  
from anand.bsedb_ab.dbo.Cmbillvalan B
Group by DatePart(Year,Sauda_Date),Branch_cd,Party_code,Family,Sub_Broker
/* Order by Branch_cd,DatePart(Year,Sauda_Date) ) */)  A



--Party_code Family     Sub_Broker branch_cd  OYear       JanTradingTurnover    JanDelTurnover        JanBrokerage          JanDelBrokerage       JanSertax             JanOtherlevies        FebTradingTurnover    FebDelTurnover        FebBrokerage          FebDelBrokerage       FebSertax             FebOtherlevies        MArTradingTurnover    MarDelTurnover        MarBrokerage          MarDelBrokerage       MarSertax             MarOtherlevies        AprTradingTurnover    AprDelTurnover        AprBrokerage          AprDelBrokerage       AprSertax             AprOtherlevies        MayTradingTurnover    MayDelTurnover        MayBrokerage          MayDelBrokerage       MaySertax             MayOtherlevies        JunTradingTurnover    JunDelTurnover        JunBrokerage          JunDelBrokerage       JunSertax             JunOtherlevies        JulTradingTurnover    JulDelTurnover        JulBrokerage          JulDelBrokerage       JulSertax             JulOtherlevies        AugTradingTurnover    AugDelTurnover        AugBrokerage          AugDelBrokerage       AugSertax             AugOtherlevies        SepTradingTurnover    SepDelTurnover        SepBrokerage          SepDelBrokerage       SepSertax             SepOtherlevies        OctTradingTurnover    OctDelTurnover        OctBrokerage          OctDelBrokerage       OctSertax             OctOtherlevies        NovTradingTurnover    NovDelTurnover        NovBrokerage          NovDelBrokerage       NovSertax             NovOtherlevies        DecTradingTurnover    DecDelTurnover        DecBrokerage          DecDelBrokerage       DecSertax             DecOtherlevies        



END 

--Select * from anand.bsedb_ab.dbo.sett_mst
---party_code Scrip_cd     sell_buy    pamt                  samt                  PRate                 SRate                 Brokerage             DelBrokerage          Service_Tax           ExService_Tax         Turn_Tax              Sebi_Tax              Ins_Chrg              Broker_Chrg           Other_Chrg            TrdAmt                DelAmt                sett_no sett_type billno     Branch_cd  Client_Type TrdType PQty        SQty        
---------- ------------ ----------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- --------------------- ------- --------- ---------- ---------- ----------- ------- ----------- ----------- 
---A023       517556       2           .0000                 10293.9820            .0000                 10300.0000            5.0000                .0000                 .4000                 .0000                 .4120                 .0000                 .0000                 .2060                 .0000                 10300.0000            .0000                 2003108 D         2          XF         CLI         N       0           100

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Remisior
-- --------------------------------------------------
CREATE Procedure [dbo].[SP_Remisior]

/*
	Modified On : 08 APR 2005, 11:23 AM
*/

(
	@FromDate as Varchar(25)='', 
	@ToDate as Varchar(25)='',
	@Year as varchar(5)='',
	@Month as varchar(15)='',
	@ExchangeSegmet As Varchar(10)='',
	@Branch_Code as Varchar(15)='',
	@Subbroker As Varchar(10)='',
	@Party_Code As Varchar(15)='',
	@IsSegmentWise as varchar(1)='0',
	@Top as varchar(3)='0',
	@Order as Varchar(35)='',
	@YearWise as Varchar(1)=''
)
As

Begin

-- Use Remisior Database


-- Run As :


-- EXEC SP_Remisior1 'Feb 1 2004','1 Mar 2005','','','','','','','0','5','','1'
-- EXEC SP_Remisior1 'Feb 1 2004','1 Mar 2005','','','','HO','','','1','5','','0'
-- EXEC SP_Remisior1 'Feb 1 2004','1 Mar 2005','2004','','','HO','','','1','5','','1'
-- EXEC SP_Remisior1 'Feb 1 2004','1 Mar 2005','','','','HO','NW','','','50','','0'


-- EXEC SP_Remisior 'Feb 1 2005','1 Mar 2005'
-- EXEC SP_Remisior 'Feb 1 2005','1 Mar 2005','','','','HO'
-- EXEC SP_Remisior 'Feb 1 2005','1 Mar 2005','','','','HO','NW'
-- EXEC SP_Remisior 'Feb 1 2005','1 Mar 2005','2005','','','HO','NW'
-- EXEC SP_Remisior 'Feb 1 2005','1 Mar 2005','2005','','','HO','NW','','','5'
-- EXEC SP_Remisior1 'Feb 1 2004','1 Mar 2005','2004','','','HO','NW','','1','5'
-- EXEC SP_Remisior1 'Feb 1 2004','1 Mar 2005','2004','','','HO','','','1','5'
-- EXEC SP_Remisior 'Feb 1 2004','1 Mar 2005','','','','','','S1296','','5'
-- EXEC SP_Remisior 'Feb 1 2004','1 Mar 2005','2004','','','','','S1296','','5'

Declare @Select Varchar(5000)
Declare @From Varchar(1000)
Declare @Where varchar(3000)
Declare @GroupBy varchar(2000)
Declare @OrderBy varchar(500)


If @Order = ''
	Begin
		Set @Order = '[Brokerage Realised] DESC'
	End


Set @Select = ' Select '
If @Top <> '0'
	Set @Select = @Select + ' Top ' + @Top + ' '

If @Subbroker = ''
	Begin
		Set @Select = @Select + ' SubBrokcode, [Sub Broker] = sbkr.Name ' 
		If @Branch_Code = ''
			Set @Select = @Select + ', [Branch] = RTrim(brnch.Branch) + ''('' + rem.Branch + '')'' '
		If @YearWise = '1'
			Set @Select = @Select + ' ,[Year]=DatePart(Year,Sauda_Date) '
	End

Else If @Party_Code = ''
	Begin
		Set @Select = @Select + ' Party_Code '
	End

Else If @Year = ''
	Set @Select = @select + ' [Year]=DatePart(Year,rem.Sauda_Date) '

Else
	Set @Select = @select + ' [Month] = DateName(Month,Cast(Month(Sauda_date) as varchar) + ''/01/1900'') '


If @Party_Code <> '' And @Year = ''
	Set @Select =  'Select [Year]=DatePart(Year,rem.Sauda_Date) '
If @Party_Code <> '' And @Year <> ''
	Set @Select = ' Select [Month] = DateName(Month,Cast(Month(Sauda_date) as varchar) + ''/01/1900'') '
If @IsSegmentWise = '1'
	Set @Select = @Select + ', [Exchange Segment]= IsNull( Case (RTrim(Coname) + ''-'' + RTrim(Segment)) When ''ACDLCM-CASH'' Then ''NSECM'' When ''ABLCM-CASH'' Then ''BSECM'' When ''ACDLFO-FO'' Then ''NSEFO'' End,	''--'') '

Set @Select = @Select + ' , [Brokerage Realised]=IsNull(Sum(ActBrok),0), [Brokerage Given]=IsNull(Sum(Rembrok),0) '
	
Set @From = '	from Mis.Remisior.Dbo.Angelremcalc rem '

If @Subbroker = ''
  Set @From = @From +  ', AngelBSECM.bsedb_ab.dbo.subbrokers sbkr, Intranet.Bsedb_ab.dbo.Branch brnch '

Set @Where = ' where exceptclient = ''No'' And sauda_date>= ''' + @FromDate + ''' And sauda_date < ''' + @ToDate + ''' And Coname Not Like ''%ACPLNCDX%'' '

If @Subbroker = ''
	Begin
		Set @Where = @Where + ' And rem.subbrokcode = sbkr.Sub_Broker '
		Set @Where = @Where + ' And rem.Branch = brnch.branch_code '
	End


If @Branch_Code <> ''
	Set @Where = @Where + ' And rem.Branch = ''' + @Branch_Code + ''''

If @Subbroker <> ''
	Set @Where = @Where + ' And rem.Subbrokcode = ''' + @Subbroker + ''''

If @Party_code <> ''
	Set @Where = @Where + ' And rem.Party_code = ''' + @Party_code + ''''

If @Year <> ''
	Set @Where = @Where + ' And DatePart(Year,Sauda_Date) = ' + @Year + ' '

If @Month <> ''
	Set @Where = @Where + ' And DatePart(Month,Sauda_Date) = ' + @Month + ' '

If @ExchangeSegmet <> ''
	Begin
		If @ExchangeSegmet Like 'BSE%'
			Set @Where = @Where + ' And RTrim(Coname) Like ''ABLCM%'' And RTrim(Segment) Like ''CASH%'' '
		If  @ExchangeSegmet Like 'NSECM%'
			Set @Where = @Where + ' And RTrim(Coname) Like ''ACDLCM%'' And RTrim(Segment) Like ''CASH%'' '
		If  @ExchangeSegmet Like 'NSEFO%'
			Set @Where = @Where + ' And RTrim(Coname) Like ''ACDLFO%'' And RTrim(Segment) Like ''FO%'' '
	End



Set @GroupBy = ' Group By '
If @SubBroker = ''
	Set @GroupBy = @GroupBy + ' subbrokcode, sbkr.Name, brnch.Branch, rem.Branch '
Else If @Party_Code = ''
	Set @GroupBy = @GroupBy + ' Party_Code '
Else If @year = ''
	Set @GroupBy = @GroupBy + ' DatePart(Year,Sauda_Date) '
Else
	Set @GroupBy = @GroupBy + ' DateName(Month,Cast(Month(Sauda_date) as varchar) + ''/01/1900'') '

If @Party_Code <> '' And @Year = ''
	Set @GroupBy = ' Group By DatePart(Year,Sauda_Date) '
If @Party_Code <> '' And @Year <> ''
	Set @GroupBy = ' Group By DateName(Month,Cast(Month(Sauda_date) as varchar) + ''/01/1900'') '


If @IsSegmentWise = '1' 
	Set @GroupBy = @GroupBy + ', coname, segment '

If @YearWise = '1'
	Set @GroupBy = @GroupBy + ', coname, segment, DatePart(Year,Sauda_Date) '


Set @OrderBy = ' order by ' + @Order


Print (@Select + @From + @Where + @GroupBy + @OrderBy)
Exec (@Select + @From + @Where + @GroupBy + @OrderBy)

/*
	Select MIN(sauda_date) from Angelremcalc
	Select MAX(sauda_date) from Angelremcalc
*/

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_report
-- --------------------------------------------------
CREATE Procedure Sp_report (@FromYear as varchar(5),@Toyear As Varchar(5),@GroupBy As Varchar(10),@OrderBy As Varchar(100))
As

Declare
@@WhereClause As Varchar(1000),
@@SelectClause As Varchar(1000)


Select  Oyear, branch_cd, TradingTurnover = Sum(JanTradingTurnover + FebTradingTurnover +MarTradingTurnover+AprTradingTurnover+MayTradingTurnover+JunTradingTurnover+JulTradingTurnover+AugTradingTurnover+SepTradingTurnover+OctTradingTurnover+NovTradingTurnover+DecTradingTurnover),
DelTurnover = Sum(JanDelTurnover + FebDelTurnover+MarDelTurnover + AprDelTurnover + MayDelTurnover +JunDelTurnover+JulDelTurnover+AugDelTurnover+SepDelTurnover+OctDelTurnover+NovDelTurnover+DecDelTurnover),
TrdBrokergae = Sum(JanBrokerage +FebBrokerage+MarBrokerage+AprBrokerage+MayBrokerage+JunBrokerage+JulBrokerage+AugBrokerage+SepBrokerage+OctBrokerage+NovBrokerage+DecBrokerage),
DelBrokerage = Sum(JanDelBrokerage+FebDelBrokerage+MarDelBrokerage+AprDelBrokerage+MayDelBrokerage+JunDelBrokerage+JulDelBrokerage+AugDelBrokerage+SepDelBrokerage+OctDelBrokerage+NovDelBrokerage+DecDelBrokerage),
SerTax = Sum(JanSertax + FebSertax + MarSertax + AprSertax+MaySertax+JunSertax+JulSertax+AugSertax+NovSertax+DecSertax),
OtherLevies = Sum(JanOtherlevies +FebOtherlevies+MarOtherlevies+AprOtherlevies+MayOtherlevies+JunOtherlevies+JulOtherlevies+AugOtherlevies+SepOtherlevies+OctOtherlevies+NovOtherlevies+DecOtherlevies)
from tb_pivot
Where Oyear <= @Toyear
And Oyear >= @FromYear
Group by Branch_cd,Oyear
Order by Branch_cd,Oyear

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_RESI
-- --------------------------------------------------

CREATE PROCEDURE SP_RESI (@CONAME AS VARCHAR(25), @BRCODE AS VARCHAR(25), @SBCODE AS VARCHAR(25))  
AS  
  
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,  
CL_NAME=SHORT_NAME COLLATE Latin1_General_CI_AS,  
resident_proof=(CASE WHEN UPPER(resident_proof COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)   
from kyc_documents where cl_code in (select distinct party_code from mis_to where branch_cd=@BRCODE and sub_broker like replace(@SBCODE,'All','%') and company=@CONAME)  
UNION  
select distinct cl_code=party_code,CL_NAME=party_name,resident_proof='NO'  
from mis_to where sub_broker like replace(@SBCODE,'All','%') and branch_cd=@BRCODE and company=@CONAME  
and sauda_Date >=getdate()-365 AND   
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )  
ORDER BY CL_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_rpt_branchwise_daily_brok
-- --------------------------------------------------
CREATE proc
	sp_rpt_branchwise_daily_brok
	(
		@dtSauda_Date varchar(11)
	)

as

select
	upper(ltrim(rtrim(min(isnull(branch, '---')))) + '[' + ltrim(rtrim(branch_cd)) + ']') as branch_detail,

	[bse brok] = (select isnull(sum(tpb+tsb+dpb+dsb), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd  and exchangesegment = 'bsecm'),
	[nse brok] = (select isnull(sum(tpb+tsb+dpb+dsb), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd  and exchangesegment = 'nsecm'),
	[f&o brok] = (select isnull(sum(tpb+tsb+dpb+dsb), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd  and exchangesegment = 'nsefo'),

	[total brok] = (select isnull(sum(tpb+tsb+dpb+dsb), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd),

	[avg daily vol] = (select isnull(sum(tp+dp+ts+ds), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd),
	[net brok yield %] = 
	(
		select
			case when sum(tp+dp+ts+ds) > 0 then 
				sum(tpb+tsb+dpb+dsb) / sum(tp+dp+ts+ds)
			else
				0
			end
		from
			level1mis
		where
			sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and
			branch_cd = l1.branch_cd
	),

	/*IsNull((Select 'High' from level1mis 
		where sauda_date <= (cast(@dtSauda_Date+' 23:59:00' as datetime)) and branch_cd=L1.branch_cd group by sauda_date
		having sum(tpb+dpb+tsb+dsb)=(select sum(tpb+dpb+tsb+dsb) from level1mis a where sauda_date = cast(@dtSauda_Date+' 23:59:00' as datetime) And branch_cd = L1.branch_cd)),''),*/

	[bse daily vol] = (select isnull(sum(tp+dp+ts+ds), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd  and exchangesegment = 'bsecm' ),
	[bse brok %] = 
	(
		select
			case when sum(tp+dp+ts+ds) > 0 then 
				sum(tpb+tsb+dpb+dsb) / sum(tp+dp+ts+ds)
			else
				0
			end
		from
			level1mis
		where
			sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and
			branch_cd = l1.branch_cd and 
			exchangesegment = 'bsecm'
	),

	[nse daily vol] = (select isnull(sum(tp+dp+ts+ds), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd  and exchangesegment = 'nsecm' ),
	[nse brok %] = 
	(
		select
			case when sum(tp+dp+ts+ds) > 0 then 
				sum(tpb+tsb+dpb+dsb) / sum(tp+dp+ts+ds)
			else
				0
			end
		from
			level1mis
		where
			sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and
			branch_cd = l1.branch_cd and 
			exchangesegment = 'nsecm'
	),

	[fo daily vol] = (select isnull(sum(tp+dp+ts+ds), 0) from level1mis where sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and branch_cd = l1.branch_cd  and exchangesegment = 'nsefo' ),
	[fo brok %] = 
	(
		select
			case when sum(tp+dp+ts+ds) > 0 then 
				sum(tpb+tsb+dpb+dsb) / sum(tp+dp+ts+ds)
			else
				0
			end
		from
			level1mis
		where
			sauda_date = cast((@dtSauda_Date+' 23:59:00') as datetime) and
			branch_cd = l1.branch_cd and 
			exchangesegment = 'nsefo'
	)

from
	level1mis l1, branch where l1.branch_cd = branch_code
group by
	branch_cd
order by
	branch_cd

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_rpt_GetNSECM_Totals
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_rpt_GetNSECM_Totals    Script Date: 2/7/2005 1:37:01 PM ******/

CREATE
proc

	sp_rpt_GetNSECM_Totals
	(
		@SaudaDateFrom varchar(11),
		@SaudaDateTo varchar(11),
		@UserID varchar(10),
		@CompanyName varchar(50),
		@Branch_Code varchar(10),
		@Sub_Broker varchar(10),
		@Level varchar(30)
	)

as

declare 
	@strSelect varchar(5000), 
	@strFrom varchar(500), 
	@strWhere varchar(5000), 
	@strGroup varchar(500), 
	@strOrder varchar(500), 
	@strHaving varchar(500),
	@strNewLine varchar(2)


set @strSelect = ''
set @strFrom = ''
set @strWhere = ''
set @strGroup = ''
set @strOrder = ''
set @strHaving = ''
set @strNewLine = char(13)


if (upper(ltrim(rtrim(@UserID))) = 'ALL' OR len(ltrim(rtrim(@UserID))) = 0)
begin
	set @UserID = '%'
end

if (upper(ltrim(rtrim(@CompanyName))) = 'ALL' OR len(ltrim(rtrim(@CompanyName))) = 0)
begin
	set @CompanyName = '%'
end

if (upper(ltrim(rtrim(@Branch_Code))) = 'ALL' OR len(ltrim(rtrim(@Branch_Code))) = 0)
begin
	set @Branch_Code = '%'
end

if (upper(ltrim(rtrim(@Sub_Broker))) = 'ALL' OR len(ltrim(rtrim(@Sub_Broker))) = 0)
begin
	set @Sub_Broker = '%'
end

set @strSelect = @strSelect + 'select ' + @strNewLine
set @strGroup = @strGroup + 'group by ' + @strNewLine
set @strOrder = @strOrder + 'order by ' + @strNewLine

if (@Level = 'COMPANY')	/*SINGLE ROW FOR EACH COMPANY*/
begin
	set @strSelect = @strSelect + '	Company=isnull(Company, ''TOTAL''), ' + @strNewLine
	set @strGroup = @strGroup + '	Company with rollup ' + @strNewLine
	set @strOrder = @strOrder + 'isnull(Company, ''zzzzzzzzzz'') ' + @strNewLine
end			/*if (@Level = 'COMPANY')	/*SINGLE ROW FOR EACH COMPANY*/*/

if (@Level = 'BRANCH')	/*SINGLE ROW FOR EACH BRANCH FOR A COMPANY*/
begin
	set @strSelect = @strSelect + '	branch_cd=isnull(branch_cd, ''TOTAL''), ' + @strNewLine
	set @strGroup = @strGroup + '	branch_cd with rollup ' + @strNewLine
	set @strOrder = @strOrder + '		isnull(branch_cd, ''zzzzzzzzzz'') ' + @strNewLine
end			/*if (@Level = 'BRANCH')	/*SINGLE ROW FOR EACH BRANCH FOR A COMPANY*/*/

if (@Level = 'SUB_BROKER')	/*SINGLE ROW FOR EACH SUB BROKER FOR A COMPANY*/
begin
	set @strSelect = @strSelect + '	sub_broker=isnull(sub_broker, ''TOTAL''), ' + @strNewLine
	set @strGroup = @strGroup + '	sub_broker with rollup ' + @strNewLine
	set @strOrder = @strOrder + '		isnull(sub_broker, ''zzzzzzzzzz'') ' + @strNewLine
end			/*if (@Level = 'SUB_BROKER')	/*SINGLE ROW FOR EACH SUB BROKER FOR A COMPANY*/*/

if (@Level = 'COMPANY_DATE')	/*SINGLE ROW FOR EACH DATE FOR A COMPANY*/
begin
--	set @strGroup = @strGroup + '	Company, ' + @strNewLine
	set @strSelect = @strSelect + '	sauda_date = isnull(left(convert(varchar, sauda_Date, 109), 11), ''TOTAL''), ' + @strNewLine
	set @strGroup = @strGroup + '	sauda_date with rollup ' + @strNewLine
--	set @strOrder = @strOrder + '		Company, '
	set @strOrder = @strOrder + '		isnull(convert(varchar, sauda_date), ''zzzzzzzzzz'') ' + @strNewLine
end			/*if (@Level = 'COMPANY_DATE')	/*SINGLE ROW FOR EACH DATE FOR A COMPANY*/*/

if (@Level = 'BRANCH_DATE')	/*SINGLE ROW FOR EACH DATE FOR A BRANCH FOR A COMPANY*/
begin
--	set @strSelect = @strSelect + '	branch_cd, ' + @strNewLine
	set @strSelect = @strSelect + '	sauda_date = isnull(left(convert(varchar, sauda_Date, 109), 11), ''TOTAL''), ' + @strNewLine
--	set @strGroup = @strGroup + '	branch_cd, ' + @strNewLine
	set @strGroup = @strGroup + '	sauda_date with rollup ' + @strNewLine
--	set @strOrder = @strOrder + '		branch_cd, '
	set @strOrder = @strOrder + '		isnull(convert(varchar, sauda_date), ''zzzzzzzzzz'') ' + @strNewLine
end			/*if (@Level = 'BRANCH_DATE')	/*SINGLE ROW FOR EACH DATE FOR A BRANCH FOR A COMPANY*/*/

if (@Level = 'SUB_BROKER_DATE')	/*SINGLE ROW FOR EACH DATE FOR A SUB BROKER FOR A COMPANY*/
begin
--	set @strSelect = @strSelect + '	sub_broker, ' + @strNewLine
	set @strSelect = @strSelect + '	sauda_date = isnull(left(convert(varchar, sauda_Date, 109), 11), ''TOTAL''), ' + @strNewLine
--	set @strGroup = @strGroup + '	sub_broker, ' + @strNewLine
	set @strGroup = @strGroup + '	sauda_date with rollup ' + @strNewLine
--	set @strOrder = @strOrder + '		sub_broker, '
	set @strOrder = @strOrder + '		isnull(convert(varchar, sauda_date), ''zzzzzzzzzz'') ' + @strNewLine
end			/*if (@Level = 'SUB_BROKER_DATE')	/*SINGLE ROW FOR EACH DATE FOR A SUB BROKER FOR A COMPANY*/*/

set @strSelect = @strSelect + '	turnover_in_lacs=(sum(Turnover)/100000), ' + @strNewLine
set @strSelect = @strSelect + '	brokerage_in_lacs=(sum(brokerage)/100000) ' + @strNewLine

set @strFrom = @strFrom + 'from ' + @strNewLine
set @strFrom = @strFrom + '	bsedb_ab.dbo.mis_to ' + @strNewLine

set @strWhere = @strWhere + 'where ' + @strNewLine
set @strWhere = @strWhere + '	Company like ''' + @CompanyName + ''' and ' + @strNewLine
set @strWhere = @strWhere + '	sauda_Date >= ''' + @SaudaDateFrom + ' 00:00:00.000'' and ' + @strNewLine
set @strWhere = @strWhere + '	sauda_Date <= ''' + @SaudaDateTo + ' 23:59:59.000'' and ' + @strNewLine
set @strWhere = @strWhere + '	branch_cd like ''' + @Branch_Code + ''' and ' + @strNewLine
set @strWhere = @strWhere + '	sub_broker like ''' + @Sub_Broker + ''' and ' + @strNewLine
set @strWhere = @strWhere + '	party_code like ''%'' and ' + @strNewLine

set @strWhere = @strWhere + '	Terminal_Id= ' + @strNewLine
set @strWhere = @strWhere + '		case when ' + @strNewLine
set @strWhere = @strWhere + '				Company=''ABLCM'' ' + @strNewLine
set @strWhere = @strWhere + '			then ' + @strNewLine
set @strWhere = @strWhere + '				''204'' ' + @strNewLine
set @strWhere = @strWhere + '			else ' + @strNewLine
set @strWhere = @strWhere + '				case when ' + @strNewLine
set @strWhere = @strWhere + '						Company=''ACDLCM'' ' + @strNewLine
set @strWhere = @strWhere + '					then ' + @strNewLine
set @strWhere = @strWhere + '						''8895'' ' + @strNewLine
set @strWhere = @strWhere + '					else ' + @strNewLine
set @strWhere = @strWhere + '						case when ' + @strNewLine
set @strWhere = @strWhere + '								Company=''ACDLFO'' ' + @strNewLine
set @strWhere = @strWhere + '							then ' + @strNewLine
set @strWhere = @strWhere + '								''2120'' ' + @strNewLine
set @strWhere = @strWhere + '							else ' + @strNewLine
set @strWhere = @strWhere + '								case when ' + @strNewLine
set @strWhere = @strWhere + '										Company=''ACPLMCX'' ' + @strNewLine
set @strWhere = @strWhere + '									then ' + @strNewLine
set @strWhere = @strWhere + '										''25807'' ' + @strNewLine
set @strWhere = @strWhere + '									else ' + @strNewLine
set @strWhere = @strWhere + '										''0'' ' + @strNewLine
set @strWhere = @strWhere + '									end ' + @strNewLine
set @strWhere = @strWhere + '							end ' + @strNewLine
set @strWhere = @strWhere + '					end ' + @strNewLine
set @strWhere = @strWhere + '			end ' + @strNewLine
				
--set @strWhere = @strWhere + '	convert(varchar, Terminal_Id) like ''' + @UserID + ''' ' + @strNewLine

--set @strHaving = @strHaving + 'having '
--set @strHaving = @strHaving + '	sum(Tradeqty*MarketRate) > 0 '

print (@strSelect + @strFrom + @strWhere + @strGroup + @strOrder + @strHaving )
exec (@strSelect + @strFrom + @strWhere + @strGroup + @strOrder + @strHaving )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_rpt_reco_entry
-- --------------------------------------------------
CREATE proc 
	sp_rpt_reco_entry
	(
		@strFromDate varchar(11),
		@strToDate varchar(11),
		@strFromBranch varchar(10),
		@strToBranch varchar(10)
	)
as

/*
	sp_rpt_reco_entry 'Feb  1 2006', 'feb 20 2006', 'a', 'zzzzzzzzzz' 
	sp_rpt_reco_entry 'Dec  2 2005', 'DEC  6 2005', 'a', 'zzzzzzzzzz'
*/


select recs.*,bals.bal_amt,bals.Recodate,
	status = 
		case 
			when isnull(bals.bal_amt, -1) = 0
			then 
				'RECO''D'
			when isnull(bals.bal_amt, recs.vamt) < recs.vamt
			then 
				'PARTIAL RECO''D'
			else
				'NOT RECO''D'
			end
from
(select bm.*
		
	from 
		bsesundryclientreco1 br left outer join 
		bsesundryclientmark bm on
		(
			br.vtyp = bm.vtyp and left(convert(varchar, br.vdt, 109), 11) = left(convert(varchar, bm.vdt, 109), 11) and 
			br.drcr = bm.drcr and br.vno = bm.vno 
		) 
		left outer join regionbranchtag tag on
		(
			br.vtyp = tag.vtyp and left(convert(varchar, br.vdt, 109), 11) = left(convert(varchar, tag.vdt, 109), 11) and 
			br.drcr = tag.drcr and br.vno = tag.vno 
		)
	where 
		bm.UpdateDate >= @strFromDate + ' 00:00:00' and bm.UpdateDate <= @strToDate + ' 23:59:59' and 
		bm.branch >= @strFromBranch and 
		bm.branch <= @strToBranch
)recs
left outer join

(select 
		vno,
		vtyp,
		drcr,
		bal_amt = min(vamt) - sum(bsecm + nsecm + nsefo + mcdx + ncdx),
		Recodate =
				case
				when (min(vamt) - sum(bsecm + nsecm + nsefo + mcdx + ncdx)) = 0 
				then
					convert(varchar,max(updatedate),109)
				else
					''
				end
	from
		bsesundryclientmark
	group by
		vno,
		vtyp,
		drcr
)bals
on
	recs.vno = bals.vno and
	recs.vtyp = bals.vtyp and
	recs.drcr = bals.drcr
--order by
--recs.vno,recs.vtyp,recs.drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_rpt_sundry_client_reco_list
-- --------------------------------------------------
CREATE proc
	sp_rpt_sundry_client_reco_list (
		@strFromDate varchar(11),
		@strToDate varchar(11),
		@strFromBranch varchar(10),
		@strToBranch varchar(10)
	)

as

/* sp_rpt_sundry_client_reco_list 'Nov 11 2005', 'Nov 25 2005', 'a', 'zzzzzzzzzz' 
   sp_rpt_sundry_client_reco_list 'Dec  2 2005', 'DEC  6 2005', 'a', 'zzzzzzzzzz'

*/

select 
	recs.*,Bal_Amt = isnull(bals.bal_amt,-1),isnull(bals.recodate,'') as recodate,
	status = 
		case 
			when isnull(bals.bal_amt, -1) = 0
			then 
				'RECO''D'
			when isnull(bals.bal_amt, recs.vamt) < recs.vamt
			then 
				'PARTIAL RECO''D'
			else
				'NOT RECO''D'
			end
from
(
	select distinct 
		isnull(ltrim(rtrim(br.acname)),'') as acname, isnull(ltrim(rtrim(br.bnkname)),'') as bnkname, 
		isnull(ltrim(rtrim(br.brnname)),'') as brnname, isnull(ltrim(rtrim(br.dd)),'') as dd, 
		isnull(ltrim(rtrim(br.ddno)),'') as ddno, br.vdt, br.vtyp, br.vno, br.drcr, br.vamt, br.exchseg, 
		isnull(ltrim(rtrim(br.enteredby)),'') as enteredby, isnull(ltrim(rtrim(br.checkedby)),'') as checkedby, 
		isnull(ltrim(rtrim(br.branch)),'') as branch , isnull(ltrim(rtrim(bm.statusname)),'') as statusname , 
		isnull(ltrim(rtrim(br.narration)),'') as narration /*, 

		status = case when bm.vno is null then 'NOT RECO''D' else 'RECO''D' end */
		
	from 
		bsesundryclientreco1 br left outer join 
		bsesundryclientmark bm on 
		(
			br.vtyp = bm.vtyp and left(convert(varchar, br.vdt, 109), 11) = left(convert(varchar, bm.vdt, 109), 11) and 
			br.drcr = bm.drcr and br.vno = bm.vno 
		) 
	where 
		br.vdt >= @strFromDate + ' 00:00:00' and br.vdt <= @strToDate + ' 23:59:59' and 
		br.branch >= @strFromBranch and 
		br.branch <= @strToBranch
) recs
left outer join
(
	select 
		vno,
		vtyp,
		drcr,
		bal_amt = min(vamt) - sum(bsecm + nsecm + nsefo + mcdx + ncdx),
		Recodate =
				case
				when (min(vamt) - sum(bsecm + nsecm + nsefo + mcdx + ncdx)) = 0 
				then
					convert(varchar,max(updatedate),109)
				else
					''
				end
	from
		bsesundryclientmark
	group by
		vno,
		vtyp,
		drcr

) bals
on
	recs.vno = bals.vno and
	recs.vtyp = bals.vtyp and
	recs.drcr = bals.drcr
/*
order by 

	recs.branch, 
	status,
	recs.vamt desc,
	recs.enteredby 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_rpt_sundry_client_reco_list_
-- --------------------------------------------------
CREATE proc
	sp_rpt_sundry_client_reco_list_ (
		@strFromDate varchar(11),
		@strToDate varchar(11),
		@strFromBranch varchar(10),
		@strToBranch varchar(10)
	)

as

/*
	sp_rpt_sundry_client_reco_list_ 'Jan 25 2006', 'Jan 25 2006', 'a', 'zzzzzzzzzz' 
	sp_rpt_sundry_client_reco_list 'Dec  2 2005', 'DEC  6 2005', 'a', 'zzzzzzzzzz'
*/

select 
	recs.*,Bal_Amt = isnull(bals.bal_amt,-1),isnull(bals.recodate,'') as recodate,
	bsedb_ab.dbo.tempfunction
	(
		left(convert(varchar, recs.vdt, 109), 11),
		recs.vno, 
		recs.vtyp
	) as statusname,
	bsedb_ab.dbo.functionGetChqNo
	(
		left(convert(varchar, recs.vdt, 109), 11),
		recs.vno, 
		recs.vtyp
	) as ChqNoGiven,
	status = 
		case 
			when (isnull(bals.bal_amt, -1)) = 0
			then 
				'RECO''D'
			when isnull(bals.bal_amt, recs.vamt) < recs.vamt
			then 
				'PARTIAL RECO''D'
			else
				'NOT RECO''D'
			end
from
(
	select distinct 
		isnull(ltrim(rtrim(br.acname)),'') as acname, isnull(ltrim(rtrim(br.bnkname)),'') as bnkname, 
		isnull(ltrim(rtrim(br.brnname)),'') as brnname, isnull(ltrim(rtrim(br.dd)),'') as dd, 
		isnull(ltrim(rtrim(br.ddno)),'') as ddno, br.vdt, br.vtyp, br.vno, br.drcr, br.vamt, br.exchseg, 
		isnull(ltrim(rtrim(br.enteredby)),'') as enteredby, isnull(ltrim(rtrim(br.checkedby)),'') as checkedby, 
		isnull(ltrim(rtrim(br.branch)),'') as branch /*, isnull(ltrim(rtrim(bm.statusname)),'') as statusname*/ ,
		isnull(ltrim(rtrim(br.narration)),'') as narration , 
		isnull(ltrim(rtrim(tag.regioninput)),'') as regioninput,
		isnull(ltrim(rtrim(tag.branchinput)),'') as branchinput,
		isnull(ltrim(rtrim(FORemarks)),'') as FORemarks
		/*isnull(ltrim(rtrim(bm.chqnogiven)),'') as chqnogiven
		isnull(ltrim(rtrim(bm.proofby)),'') as ProofBy,
		isnull(ltrim(rtrim(bm.proofdate)),'') as ProofDate*/
/*		status = case when bm.vno is null then 'NOT RECO''D' else 'RECO''D' end */
	from 
		bsesundryclientreco1 br left outer join 
		bsesundryclientmark bm on 
		(
			br.vtyp = bm.vtyp and left(convert(varchar, br.vdt, 109), 11) = left(convert(varchar, bm.vdt, 109), 11) and 
			br.drcr = bm.drcr and br.vno = bm.vno 
		) 
		left outer join regionbranchtag tag on
		(
			br.vtyp = tag.vtyp and left(convert(varchar, br.vdt, 109), 11) = left(convert(varchar, tag.vdt, 109), 11) and 
			br.drcr = tag.drcr and br.vno = tag.vno 
		)
	where 
		br.vdt >= @strFromDate + ' 00:00:00' and br.vdt <= @strToDate + ' 23:59:59' and 
		br.branch >= @strFromBranch and 
		br.branch <= @strToBranch
) recs
left outer join
(
	select 
		vno,
		vtyp,
		drcr,
		bal_amt = min(vamt) - sum(bsecm + nsecm + nsefo + mcdx + ncdx),
		Recodate =
				case
				when (min(vamt) - sum(bsecm + nsecm + nsefo + mcdx + ncdx)) = 0 
				then
					convert(varchar,max(updatedate),109)
				else
					''
				end
	from
		bsesundryclientmark
	group by
		vno,
		vtyp,
		drcr

) bals
on
	recs.vno = bals.vno and
	recs.vtyp = bals.vtyp and
	recs.drcr = bals.drcr
/*
order by 

	recs.branch, 
	status,
	recs.vamt desc,
	recs.enteredby 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_SaveBank
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_SaveBank    Script Date: 09/11/2005 6:47:27 PM ******/
CREATE proc
	sp_SaveBank
	(
                @intBankCode bigint, 
		@strBankName varchar(50),
                @Cnt bigint Output
	)
AS
Begin

	set @strBankName = ltrim(rtrim(@strBankName))

        --Check for Duplicate Entry

	select @Cnt=Count(BankName) from BankMaster where BankName = @strBankName
        if @Cnt = 0
        Begin 
                    begin tran
			insert into
				BankMaster
				(
					BankCode,
                                        BankName     
				)
				values
				(
                                        @intBankCode,
					@strBankName
				)   
       if @@error = 0 
          commit else rollback tran
       end
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_SBClient_Info
-- --------------------------------------------------

-- sp_SBClient_Info 'ACME4', 'ACME4', 'C', 'NSECM', '03/06/2006','21/10/2007' 

CREATE Procedure sp_SBClient_Info
(@sbcode as varchar(10),
@brcode as varchar(10),
@flag as varchar(1),
@coname as varchar(10),
@fdate as varchar(25),
@tdate as varchar(25)
)              
as                    
                    
set nocount on         

  --SET @fdate=CONVERT(datetime,@fdate,103)                                    
  --SET @tdate=CONVERT(datetime,@tdate,103) + '23:59:59:999'          
          
/*declare @sbcode as varchar(10),@brcode as varchar(10),@flag as varchar(1),@coname as varchar(10),@fdate as varchar(25),@tdate as varchar(25)            
set @sbcode ='%'            
set @brcode ='BNG'            
set @flag  = 'C'            
set @coname ='%'            
set @fdate='Apr 1 2007'            
set @tdate ='Jul 2 2007'            
*/           
              
set transaction isolation level read uncommitted              
select distinct sauda_DAte into #date               
from mis_to_company (nolock)               
where sauda_date>=@fdate and sauda_date<=@tdate              
order by sauda_date               
               
if @flag='C'              
begin              
        
           
 set transaction isolation level read uncommitted              
            
  select a.*,b.active_date into #cli_detx from risk.dbo.client_Details a (nolock),            
 (select cl_code,active_date=min(isnull(active_date,'Jan  1 1900')) from risk.dbo.client_brok_Details (nolock)   
  group by cl_Code) b            
 where a.cl_Code=b.cl_code and a.sub_broker like @sbcode and a.Branch_Cd like @brcode            
  
 select a.*,SB_status=(case when b2c_Sb is null then 'B2B' else 'B2C' end) into #cli_det   
 from  #cli_detx a left outer join mis.remisior.dbo.b2c_Sb b on a.sub_Broker=b.b2c_sb  
  
  
 /*            
 select partY_Code,brokerage=sum(brokerage),sauda_Date            
 into #file1_x from mis_to (nolock)             
 where             
 company like @coname               
 and branch_cd = @brcode              
 and sub_broker LIKE @sbcode             
 and sauda_DAte >= @fdate            
 and sauda_DAte <= @tdate            
 group by partY_Code,sauda_date              
*/  
 select party_Code,sauda_Date,  
 brokerage=sum(brok_Earned),  
 Net_Brokerage=sum(angel_share)  
 into #file1_x   
 from mis.remisior.dbo.comb_cli   
 where   
 sauda_DAte >= @fdate            
 and sauda_DAte <= @tdate            
 and segment like replace(@coname,'ACPLNCDEX','ACPLNCDX')  
 and party_Code in (select party_Code from #cli_det)  
 group by sauda_Date,partY_Code  
           
 select partY_Code,brokerage=sum(brokerage),Net_Brokerage=sum(Net_Brokerage),last_trd_date=max(sauda_date),  
 NoOfDays=count(*)              
 into #file1         
 from #file1_x             
 group by partY_Code --order by avg_brok_perday desc           
         
 set transaction isolation level read uncommitted              
 select a.*,b.branch_Cd,b.sub_broker,b.sb_status,b.long_name, Address=LTRIM(RTRIM(l_Address1))+'; '+LTRIM(RTRIM(l_Address2))+'; '++LTRIM(RTRIM(l_Address3))+'; '+LTRIM(RTRIM(l_City))+'; '+LTRIM(RTRIM(l_State))+'; '+LTRIM(RTRIM(l_Zip)),              
 Res_phone=res_phone1+' '+res_phone2,              
 Off_phone=off_phone1+' '+off_phone2,mobile=mobile_pager,email,Active_date              
 from #file1 a, #cli_det b               
 where a.party_code collate SQL_Latin1_General_CP1_CI_AS =b.party_code           
 --order by a.avg_brok_perday desc        
              
  
end              
              
---------------------- Top Sub_brokers              
if @flag='S'              
              
begin              
              
 set transaction isolation level read uncommitted              
 select sub_Broker,brokerage=sum(brokerage),last_trd_date=max(sauda_date)              
 into #filesb1 from mis_to_sb (nolock) where BRANCH_cD=@brcode              
 and company LIKE @coname              
 and sauda_DAte >= (select min(sauda_DAte) from #date )             
 and sauda_DAte <= (select max(sauda_DAte) from #date )             
 group by SUB_BROKER              
            
            
 --SELECT * FROM #filesb1              
 select sub_Broker,name,branch_code,Address=LTRIM(RTRIM(isnull(Address1,'')))            
 +'; '+LTRIM(RTRIM(isnull(Address2,'')))+'; '+LTRIM(RTRIM(isnull(City,'')))+'; '+LTRIM(RTRIM(isnull(State,'')))+'; '            
 +LTRIM(RTRIM(isnull(Zip,''))),              
 Res_phone=Phone1,Off_phone=Phone2,mobile=' ',email              
 into #tmp_file1              
 from risk.dbo.SUBbROKERS               
 where coname LIKE replace(@coname,'ACPLNCDEX','ACPLNCDX')              
             
 select sub_Broker,address=max(isnull(address,'')) into #tmp_sbfile from #tmp_file1              
 group by sub_Broker              
               
 update #tmp_file1               
 set #tmp_file1.name = b.name               
 from (select sub_Broker,name=max(name) from #tmp_file1 group by sub_Broker) b               
 where #tmp_file1.sub_Broker=b.sub_Broker              
               
 select distinct              
 --a.Sub_Broker,a.Name,a.Address1,a.Address2,a.City,State,Nation,a.Zip,a.Fax,a.Phone1,a.Phone2,a.Reg_No,a.Registered,a.Main_Sub,a.Email,a.Com_Perc,a.branch_code,a.Contact_Person              
 a.sub_Broker,a.name,a.branch_code,a.Address,a.Res_phone,a.Off_phone,a.mobile,a.email              
 into #sbfile              
 from (select distinct * from #tmp_file1) a, #tmp_sbfile b where a.sub_Broker=b.sub_Broker              
 and a.address=b.address              
               
               
 select distinct a.*,b.branch_CODE,b.Name,address,Res_phone,Off_phone,mobile,email              
 --Address=Address1+' '+Address2+' '+City+' '+State+' '+Zip,Res_phone=Phone1,Off_phone=Phone2,mobile=' ',email              
 from #filesb1 a LEFT OUTER JOIN #sbfile b               
 ON a.Sub_Broker=b.Sub_Broker              
              
end              
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_SBClient_Info_backup
-- --------------------------------------------------

-- sp_SBClient_Info 'ACME4', 'ACME4', 'S', 'NSECM', 'Jan 01 2006','Feb 10 2007' 

CREATE  Procedure sp_SBClient_Info_backup
(@sbcode as varchar(10),
@brcode as varchar(10),
@flag as varchar(1),
@coname as varchar(10),
@fdate as varchar(25),
@tdate as varchar(25)
)              
as                    
                    
set nocount on         

  --SET @fdate=CONVERT(datetime,@fdate,103)                                    
  --SET @tdate=CONVERT(datetime,@tdate,103) + '23:59:59:999'          
          
/*declare @sbcode as varchar(10),@brcode as varchar(10),@flag as varchar(1),@coname as varchar(10),@fdate as varchar(25),@tdate as varchar(25)            
set @sbcode ='%'            
set @brcode ='BNG'            
set @flag  = 'C'            
set @coname ='%'            
set @fdate='Apr 1 2007'            
set @tdate ='Jul 2 2007'            
*/           
              
set transaction isolation level read uncommitted              
select distinct sauda_DAte into #date               
from mis_to_company (nolock)               
where sauda_date  >=@fdate  and sauda_date  <=@tdate             
order by sauda_date               
               
if @flag='C'              
begin              
        
           
 set transaction isolation level read uncommitted              
            
  select a.*,b.active_date into #cli_detx from risk.dbo.client_Details a (nolock),            
 (select cl_code,active_date=min(isnull(active_date,'Jan  1 1900')) from risk.dbo.client_brok_Details (nolock)   
  group by cl_Code) b            
 where a.cl_Code=b.cl_code and a.sub_broker like @sbcode and a.Branch_Cd like @brcode            
  
 select a.*,SB_status=(case when b2c_Sb is null then 'B2B' else 'B2C' end) into #cli_det   
 from  #cli_detx a left outer join mis.remisior.dbo.b2c_Sb b on a.sub_Broker COLLATE DATABASE_DEFAULT =b.b2c_sb COLLATE DATABASE_DEFAULT 
  
  
 /*            
 select partY_Code,brokerage=sum(brokerage),sauda_Date            
 into #file1_x from mis_to (nolock)             
 where             
 company like @coname               
 and branch_cd = @brcode              
 and sub_broker LIKE @sbcode             
 and sauda_DAte >= @fdate            
 and sauda_DAte <= @tdate            
 group by partY_Code,sauda_date              
*/  
 select party_Code,sauda_Date,  
 brokerage=sum(brok_Earned),  
 Net_Brokerage=sum(angel_share)  
 into #file1_x   
 from mis.remisior.dbo.comb_cli   
 where   
 sauda_DAte>= @fdate        
 and sauda_DAte  <= @tdate       
 and segment like replace(@coname,'ACPLNCDEX','ACPLNCDX')  
 and party_Code in (select party_Code from #cli_det)  
 group by sauda_Date,partY_Code  
           
 select partY_Code,brokerage=sum(brokerage),Net_Brokerage=sum(Net_Brokerage),last_trd_date=max(sauda_date),  
 NoOfDays=count(*)              
 into #file1         
 from #file1_x             
 group by partY_Code --order by avg_brok_perday desc           
         
 set transaction isolation level read uncommitted              
 select a.*,b.branch_Cd,b.sub_broker,b.sb_status,b.long_name, Address=LTRIM(RTRIM(l_Address1))+'; '+LTRIM(RTRIM(l_Address2))+'; '++LTRIM(RTRIM(l_Address3))+'; '+LTRIM(RTRIM(l_City))+'; '+LTRIM(RTRIM(l_State))+'; '+LTRIM(RTRIM(l_Zip)),              
 Res_phone=res_phone1+' '+res_phone2,              
 Off_phone=off_phone1+' '+off_phone2,mobile=mobile_pager,email,Active_date              
 from #file1 a, #cli_det b               
 where a.party_code COLLATE DATABASE_DEFAULT =b.party_code   COLLATE DATABASE_DEFAULT        
 --order by a.avg_brok_perday desc        
              
  
end              
              
---------------------- Top Sub_brokers              
if @flag='S'              
              
begin              
              
 set transaction isolation level read uncommitted              
 select sub_Broker,brokerage=sum(brokerage),last_trd_date=max(sauda_date)              
 into #filesb1 from mis_to_sb (nolock) where BRANCH_cD=@brcode              
 and company LIKE @coname              
 and sauda_DAte >= (select min(sauda_DAte) from #date )             
 and sauda_DAte <= (select max(sauda_DAte) from #date )             
 group by SUB_BROKER              
            
            
 --SELECT * FROM #filesb1              
 select sub_Broker,name,branch_code,Address=LTRIM(RTRIM(isnull(Address1,'')))            
 +'; '+LTRIM(RTRIM(isnull(Address2,'')))+'; '+LTRIM(RTRIM(isnull(City,'')))+'; '+LTRIM(RTRIM(isnull(State,'')))+'; '            
 +LTRIM(RTRIM(isnull(Zip,''))),              
 Res_phone=Phone1,Off_phone=Phone2,mobile=' ',email              
 into #tmp_file1              
 from risk.dbo.SUBbROKERS               
 where coname LIKE replace(@coname,'ACPLNCDEX','ACPLNCDX')              
             
 select sub_Broker,address=max(isnull(address,'')) into #tmp_sbfile from #tmp_file1              
 group by sub_Broker              
               
 update #tmp_file1               
 set #tmp_file1.name = b.name               
 from (select sub_Broker,name=max(name) from #tmp_file1 group by sub_Broker) b               
 where #tmp_file1.sub_Broker=b.sub_Broker              
               
 select distinct              
 --a.Sub_Broker,a.Name,a.Address1,a.Address2,a.City,State,Nation,a.Zip,a.Fax,a.Phone1,a.Phone2,a.Reg_No,a.Registered,a.Main_Sub,a.Email,a.Com_Perc,a.branch_code,a.Contact_Person              
 a.sub_Broker,a.name,a.branch_code,a.[Address],a.Res_phone,a.Off_phone,a.mobile,a.email              
 into #sbfile              
 from (select distinct * from #tmp_file1) a, #tmp_sbfile b where a.sub_Broker=b.sub_Broker              
 and a.[address] COLLATE DATABASE_DEFAULT =b.[address] COLLATE DATABASE_DEFAULT             
               
               
 select distinct a.*,b.branch_CODE,b.Name,[address],Res_phone,Off_phone,mobile,email              
 from #filesb1 a LEFT OUTER JOIN #sbfile b               
 ON a.Sub_Broker COLLATE DATABASE_DEFAULT =b.Sub_Broker COLLATE DATABASE_DEFAULT         
              
end              
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_SBClient_Info_New
-- --------------------------------------------------
      
    --sp_helptext  SbActive_Client_Info 
-- sp_SBClient_Info_New 'BHOL', 'AHNGR', 'S', 'NSEFO', '01/22/2001','10/25/2003'   
-- sp_SBClient_Info_New 'ALL', 'ALL', 'S', 'ALL', '25/03/2006','30/03/2007'
    
      
CREATE  Procedure sp_SBClient_Info_New      
(@sbcode as varchar(10),      
@brcode as varchar(10),      
@flag as varchar(1),      
@coname as varchar(10),      
@fdate as varchar(25),      
@tdate as varchar(25)      
)                    
as                          
                          
set nocount on               
      
  SET @fdate=CONVERT(datetime,@fdate,103)                                          
  SET @tdate=CONVERT(datetime,@tdate,103) + '23:59:59:999'                
                
/*declare @sbcode as varchar(10),@brcode as varchar(10),@flag as varchar(1),@coname as varchar(10),@fdate as varchar(25),@tdate as varchar(25)                  
set @sbcode ='%'                  
set @brcode ='BNG'                  
set @flag  = 'C'                  
set @coname ='%'                  
set @fdate='Apr 1 2007'                  
set @tdate ='Jul 2 2007'                  
*/                 
                    
set transaction isolation level read uncommitted                    
select distinct sauda_DAte into #date                     
from mis_to_company (nolock)                     
where sauda_date>=@fdate and sauda_date<=@tdate                    
order by sauda_date                     
 
 IF upper(@sbcode)='ALL'                                                            
 BEGIN                                                            
   SET @sbcode='%'                                                            
 END
 IF upper(@brcode)='ALL'                                                            
 BEGIN                                                            
   SET @brcode='%'                                                            
 END
  IF upper(@coname)='ALL'                                                            
 BEGIN                                                            
   SET @coname='%'                                                            
 END
 
                     
if @flag='C'                    
begin                    
              
                 
 set transaction isolation level read uncommitted                    
             
  select a.*,b.active_date into #cli_detx from risk.dbo.client_Details a (nolock),                  
 (select cl_code,active_date=min(isnull(active_date,'Jan  1 1900')) from risk.dbo.client_brok_Details (nolock)         
  group by cl_Code) b                  
 where a.cl_Code=b.cl_code and a.sub_broker LIKE -- '%' AND a.Branch_Cd LIKE '%'
    @sbcode and a.Branch_Cd like @brcode                  
        SELECT * FROM #cli_detx
 select a.*,SB_status=(case when b2c_Sb is null then 'B2B' else 'B2C' end) into #cli_det         
 from  #cli_detx a left outer join mis.remisior.dbo.b2c_Sb b on a.sub_Broker=b.b2c_sb        
        
        
 /*                  
 select partY_Code,brokerage=sum(brokerage),sauda_Date                  
 into #file1_x from mis_to (nolock)                   
 where                   
 company like @coname                     
 and branch_cd = @brcode                    
 and sub_broker LIKE @sbcode                   
 and sauda_DAte >= @fdate                  
 and sauda_DAte <= @tdate                  
 group by partY_Code,sauda_date                    
*/        
 select party_Code,sauda_Date,        
 brokerage=sum(brok_Earned),        
 Net_Brokerage=sum(angel_share)        
 into #file1_x         
 from mis.remisior.dbo.comb_cli         
 where         
 sauda_DAte >= @fdate                  
 and sauda_DAte <= @tdate                  
 and segment like replace(@coname,'ACPLNCDEX','ACPLNCDX')        
 and party_Code in (select party_Code from #cli_det)        
 group by sauda_Date,partY_Code        
                 
 select partY_Code,brokerage=sum(brokerage),Net_Brokerage=sum(Net_Brokerage),last_trd_date=max(sauda_date),        
 NoOfDays=count(*)                    
 into #file1               
 from #file1_x                   
 group by partY_Code --order by avg_brok_perday desc                 
               
 set transaction isolation level read uncommitted                    
 select a.*,b.branch_Cd,b.sub_broker,b.sb_status,b.long_name, Address=LTRIM(RTRIM(l_Address1))+'; '+LTRIM(RTRIM(l_Address2))+'; '++LTRIM(RTRIM(l_Address3))+'; '+LTRIM(RTRIM(l_City))+'; '+LTRIM(RTRIM(l_State))+'; '+LTRIM(RTRIM(l_Zip)),                    
 Res_phone=res_phone1+' '+res_phone2,                    
 Off_phone=off_phone1+' '+off_phone2,mobile=mobile_pager,email,Active_date                    
 from #file1 a, #cli_det b                     
 where a.party_code collate SQL_Latin1_General_CP1_CI_AS =b.party_code                 
 --order by a.avg_brok_perday desc              
                    
        
end                    
       
---------------------- Top Sub_brokers                    
if @flag='S'                    
                    
begin                    
                    
 set transaction isolation level read uncommitted                    
 select sub_Broker,brokerage=sum(brokerage),last_trd_date=max(sauda_date)                    
 into #filesb1 from mis_to_sb (nolock) where BRANCH_cD LIKE @brcode                    
 and company LIKE @coname                    
 and sauda_DAte >= (select min(sauda_DAte) from #date )                   
 and sauda_DAte <= (select max(sauda_DAte) from #date )                   
 group by SUB_BROKER                    
                  
                  
 --SELECT * FROM #filesb1                    
 select sub_Broker,name,branch_code,Address=LTRIM(RTRIM(isnull(Address1,'')))                  
 +'; '+LTRIM(RTRIM(isnull(Address2,'')))+'; '+LTRIM(RTRIM(isnull(City,'')))+'; '+LTRIM(RTRIM(isnull(State,'')))+'; '                  
 +LTRIM(RTRIM(isnull(Zip,''))),                    
 Res_phone=Phone1,Off_phone=Phone2,mobile=' ',email                    
 into #tmp_file1                    
 from risk.dbo.SUBbROKERS                     
 where coname LIKE replace(@coname,'ACPLNCDEX','ACPLNCDX')                    
                   
 select sub_Broker,address=max(isnull(address,'')) into #tmp_sbfile from #tmp_file1                    
 group by sub_Broker                    
                     
 update #tmp_file1                     
 set #tmp_file1.name = b.name                     
 from (select sub_Broker,name=max(name) from #tmp_file1 group by sub_Broker) b                     
 where #tmp_file1.sub_Broker=b.sub_Broker                
                  
         
 select distinct                    
 --a.Sub_Broker,a.Name,a.Address1,a.Address2,a.City,State,Nation,a.Zip,a.Fax,a.Phone1,a.Phone2,a.Reg_No,a.Registered,a.Main_Sub,a.Email,a.Com_Perc,a.branch_code,a.Contact_Person                    
 a.sub_Broker,a.name,a.branch_code,a.Address,a.Res_phone,a.Off_phone,a.mobile,a.email                    
 into #sbfile                    
 from (select distinct * from #tmp_file1) a, #tmp_sbfile b       
 where a.sub_Broker COLLATE DATABASE_DEFAULT=b.sub_Broker  COLLATE DATABASE_DEFAULT                  
 and a.address COLLATE DATABASE_DEFAULT=b.address COLLATE DATABASE_DEFAULT                   
        
         
 select distinct a.*,b.branch_CODE,b.Name,address,Res_phone,Off_phone,mobile,email                    
 --Address=Address1+' '+Address2+' '+City+' '+State+' '+Zip,Res_phone=Phone1,Off_phone=Phone2,mobile=' ',email                    
 from #filesb1 a  LEFT OUTER Join #sbfile b                     
 ON a.Sub_Broker  COLLATE DATABASE_DEFAULT= b.sub_Broker COLLATE DATABASE_DEFAULT        
       
                    
end                    
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_SBClient_Info_New11
-- --------------------------------------------------


-- sp_SBClient_Info 'ACME4', 'ACME4', 'S', 'NSECM', '01/22/2001','10/25/2003' 

Create Procedure sp_SBClient_Info_New11
(@sbcode as varchar(10),
@brcode as varchar(10),
@flag as varchar(1),
@coname as varchar(10),
@fdate as varchar(25),
@tdate as varchar(25)
)              
as                    
                    
set nocount on         

  --SET @fdate=CONVERT(datetime,@fdate,103)                                    
  --SET @tdate=CONVERT(datetime,@tdate,103) + '23:59:59:999'          
          
/*declare @sbcode as varchar(10),@brcode as varchar(10),@flag as varchar(1),@coname as varchar(10),@fdate as varchar(25),@tdate as varchar(25)            
set @sbcode ='%'            
set @brcode ='BNG'            
set @flag  = 'C'            
set @coname ='%'            
set @fdate='Apr 1 2007'            
set @tdate ='Jul 2 2007'            
*/           
              
set transaction isolation level read uncommitted              
select distinct sauda_DAte into #date               
from mis_to_company (nolock)               
where sauda_date>=@fdate and sauda_date<=@tdate              
order by sauda_date               
               
if @flag='C'              
begin              
        
           
 set transaction isolation level read uncommitted              
            
  select a.*,b.active_date into #cli_detx from risk.dbo.client_Details a (nolock),            
 (select cl_code,active_date=min(isnull(active_date,'Jan  1 1900')) from risk.dbo.client_brok_Details (nolock)   
  group by cl_Code) b            
 where a.cl_Code=b.cl_code and a.sub_broker like @sbcode and a.Branch_Cd like @brcode            
  
 select a.*,SB_status=(case when b2c_Sb is null then 'B2B' else 'B2C' end) into #cli_det   
 from  #cli_detx a left outer join mis.remisior.dbo.b2c_Sb b on a.sub_Broker=b.b2c_sb  
  
  
 /*            
 select partY_Code,brokerage=sum(brokerage),sauda_Date            
 into #file1_x from mis_to (nolock)             
 where             
 company like @coname               
 and branch_cd = @brcode              
 and sub_broker LIKE @sbcode             
 and sauda_DAte >= @fdate            
 and sauda_DAte <= @tdate            
 group by partY_Code,sauda_date              
*/  
 select party_Code,sauda_Date,  
 brokerage=sum(brok_Earned),  
 Net_Brokerage=sum(angel_share)  
 into #file1_x   
 from mis.remisior.dbo.comb_cli   
 where   
 sauda_DAte >= @fdate            
 and sauda_DAte <= @tdate            
 and segment like replace(@coname,'ACPLNCDEX','ACPLNCDX')  
 and party_Code in (select party_Code from #cli_det)  
 group by sauda_Date,partY_Code  
           
 select partY_Code,brokerage=sum(brokerage),Net_Brokerage=sum(Net_Brokerage),last_trd_date=max(sauda_date),  
 NoOfDays=count(*)              
 into #file1         
 from #file1_x             
 group by partY_Code --order by avg_brok_perday desc           
         
 set transaction isolation level read uncommitted              
 select a.*,b.branch_Cd,b.sub_broker,b.sb_status,b.long_name, Address=LTRIM(RTRIM(l_Address1))+'; '+LTRIM(RTRIM(l_Address2))+'; '++LTRIM(RTRIM(l_Address3))+'; '+LTRIM(RTRIM(l_City))+'; '+LTRIM(RTRIM(l_State))+'; '+LTRIM(RTRIM(l_Zip)),              
 Res_phone=res_phone1+' '+res_phone2,              
 Off_phone=off_phone1+' '+off_phone2,mobile=mobile_pager,email,Active_date              
 from #file1 a, #cli_det b               
 where a.party_code collate SQL_Latin1_General_CP1_CI_AS =b.party_code           
 --order by a.avg_brok_perday desc        
              
  
end              
              
---------------------- Top Sub_brokers              
if @flag='S'              
              
begin              
              
 set transaction isolation level read uncommitted              
 select sub_Broker,brokerage=sum(brokerage),last_trd_date=max(sauda_date)              
 into #filesb1 from mis_to_sb (nolock) where BRANCH_cD=@brcode              
 and company LIKE @coname              
 and sauda_DAte >= (select min(sauda_DAte) from #date )             
 and sauda_DAte <= (select max(sauda_DAte) from #date )             
 group by SUB_BROKER              
            
            
 --SELECT * FROM #filesb1              
 select sub_Broker,name,branch_code,Address=LTRIM(RTRIM(isnull(Address1,'')))            
 +'; '+LTRIM(RTRIM(isnull(Address2,'')))+'; '+LTRIM(RTRIM(isnull(City,'')))+'; '+LTRIM(RTRIM(isnull(State,'')))+'; '            
 +LTRIM(RTRIM(isnull(Zip,''))),              
 Res_phone=Phone1,Off_phone=Phone2,mobile=' ',email              
 into #tmp_file1              
 from risk.dbo.SUBbROKERS               
 where coname LIKE replace(@coname,'ACPLNCDEX','ACPLNCDX')              
             
 select sub_Broker,address=max(isnull(address,'')) into #tmp_sbfile from #tmp_file1              
 group by sub_Broker              
               
 update #tmp_file1               
 set #tmp_file1.name = b.name               
 from (select sub_Broker,name=max(name) from #tmp_file1 group by sub_Broker) b               
 where #tmp_file1.sub_Broker=b.sub_Broker          
            
   
 select distinct              
 --a.Sub_Broker,a.Name,a.Address1,a.Address2,a.City,State,Nation,a.Zip,a.Fax,a.Phone1,a.Phone2,a.Reg_No,a.Registered,a.Main_Sub,a.Email,a.Com_Perc,a.branch_code,a.Contact_Person              
 a.sub_Broker,a.name,a.branch_code,a.Address,a.Res_phone,a.Off_phone,a.mobile,a.email              
 into #sbfile              
 from (select distinct * from #tmp_file1) a, #tmp_sbfile b 
 where a.sub_Broker =b.sub_Broker              
 and a.address=b.address              
  
   
 select distinct a.*,b.branch_CODE,b.Name,address,Res_phone,Off_phone,mobile,email              
 --Address=Address1+' '+Address2+' '+City+' '+State+' '+Zip,Res_phone=Phone1,Off_phone=Phone2,mobile=' ',email              
 from #filesb1 a  LEFT OUTER Join #sbfile b               
 ON a.Sub_Broker  = b.sub_Broker   
 
              
end              
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Scripwise
-- --------------------------------------------------
  
 /****** Object:  Stored Procedure dbo.sp_Scripwise    Script Date: 11/08/2005 15:18:38 ******/      
CREATE  Procedure [dbo].[sp_Scripwise]      
(      
 @Console varchar(200)='', /* Scrip_Name, Branch_CD, Sub_Broker, Family_Name */      
 @DateFrom varchar(100) ='',      
 @DateTo varchar(100)='',      
 @ScripNameFrom varchar(500)='',      
 @ScripNameTo varchar(500)='',      
 @Segmentwise varchar(1)='0',      
 @Top varchar(3)='0',      
 @ScripName varchar(200)='',      
 @BranchName varchar(200)='',      
 @Sub_Broker varchar(200)='',      
 @Family varchar(25)='',      
 @Order varchar(25)='',      
 @Year varchar(5)='',      
 @ExchangeSegment varchar(8)=''      
)      
      
As      
      
Declare      
 @@Select Varchar(5000),      
 @@From varchar(100),      
 @@Where varchar(1000),      
 @@GroupBy varchar(1000),      
 @@OrderBy varchar(800),      
      
@TotVol money      
      
Begin      
      
      
-- Select       
If @Console = 'Branch_cd'      
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'      
 Else      
 Begin      
  If @Console = 'Scrip_name'      
   Set @@Select = ' [Scrip_name]= sc_isinname, '      
  Else      
   Set @@Select = @Console + ' , '      
 End      
      
 If @Segmentwise <> '0' /* Show Segments too */      
  Begin      
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '      
  End      
       
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS),/* Sum(cast(TP as money)+DP+TS+DS)/' + '@@TotVolume' + ' as [Volume %], */' +      
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), ' +      
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB)  '      
      
 Set @@From = ' From level1scripmis a /*change*/, [ABCSOORACLEMDLW].synergy.dbo.security b '      
      
      
      
-- Where Condition      
      
 Set @@Where = ' Where '+      
  /* Compare ISIN */      
   'a.ISIN = b.sc_ISINcode collate SQL_Latin1_General_CP1_CI_AS '       
        
  If (@ScripName='')      
   Begin      
    /* Scrip Range */      
    Set @@Where = @@Where + ' And sc_isinname>=''' + @ScripNameFrom + ''' And sc_isinname<=''' + @ScripNameTo + ''' '       
   End      
  Else      
   Begin      
    /* Selected Scrip */      
    Set @@Where = @@Where +  ' And b.sc_isinname  Like ''' + @ScripName + '%'' '      
    If @Console = 'Sub_Broker'      
     Begin      
      Set @@Where = @@Where +  ' And Branch_cd=(Select Branch_Code from Branch where Branch=''' + @BranchName + ''') '      
      If @Console='Family_Name'      
       Begin      
        Set @@Where = @@Where +  ' And Sub_Broker=''' + @Sub_Broker + ''' '       
       End      
     End      
   End      
    If @BranchName <> ''      
     Set @@Where = @@Where + ' And Branch_cd = (Select Branch_Code From Branch Where Branch= ''' + @BranchName + ''')'      
    If @Family <> ''      
     Set @@Where = @@Where + ' And Family = ''' + @Family + ''''      
    If @Sub_Broker <> ''      
     Set @@Where = @@Where + ' And Sub_Broker = ''' + @Sub_Broker + ''''      
    If @Year <> ''      
     Set @@Where = @@Where + ' And DatePart(Year,Sauda_Date) = ''' + @Year + ''''      
    If @ExchangeSegment <> ''      
     Set @@Where = @@Where + ' And a.ExchangeSegment = ''' ++ @ExchangeSegment + ''''      
      
      
  /* Date Range */      
  Set @@Where = @@Where +  ' And a.sauda_date >= Cast('' ' + @DateFrom + ' '' as DateTime) And a.sauda_date <= Cast('' ' + @DateTo + ' '' as DateTime) '      
      
-- Group By      
 If @Console = 'Scrip_name'      
  Set @@GroupBy = ' Group By sc_isinname '      
 Else      
  Set @@GroupBy = ' Group By ' + @Console      
       
 If @Segmentwise <> '0' /* Segmentwise Grouping */      
  Begin      
   Set @@GroupBy = @@GroupBy + ' , a.ExchangeSegment '      
  End      
      
      
-- Order By      
      
 If LTrim(RTrim(@Order)) = ''      
  Begin      
   If @Console = 'Branch_cd'      
    Set @@OrderBy = ' Order By [Branch Name] '      
   Else      
    Set @@OrderBy = ' Order By ' + @Console      
  End      
 Else      
  Set @@OrderBy = ' Order By ' + @Order      
      
-- Add Top to Select      
      
 /* Add top to select */      
 If (@Top='0')      
  Begin      
   Set @@Select = ' Select ' + @@Select      
  End      
 Else /* Get all records */      
  Begin      
Set @@Select = ' Select Top ' + @Top + ' ' + @@Select      
  End      
      
      
 /* Print the final query */      
 --Print (@@Select + @@From + @@Where + @@GroupBy + @@OrderBy)      
      
 -- Compute Total      
      
 Declare @@TotVolume varchar(25),      
  @@TotTurnOver varchar(25),      
  @@TotBrokerage varchar(25)      
      
 Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )      
 --Print ('Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')      
 Exec  ('Insert #TotalAll Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')       
 select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll      
 Drop Table #TotalAll      
      
 --print @@TotVolume      
 --print @@TotTurnOver      
 --print @@TotBrokerage      
      
 If (@@TotVolume Is Null Or @@TotVolume='0')      
  Set @@TotVolume = '1'      
      
 If (@@TotTurnOver Is Null Or @@TotTurnOver = '0')      
  Set @@TotTurnOver = '1'      
      
 If (@@TotBrokerage Is Null Or @@TotBrokerage = '0')      
  Set @@TotBrokerage = '1'      
      
-- Rebuild Select       
      
-- Select       
 If @Console = 'Branch_cd'      
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'      
 Else      
 Begin      
  If @Console = 'Scrip_name'      
   Set @@Select = ' [Scrip_name]= sc_isinname, '      
  Else      
   Set @@Select = @Console + ' , '      
 End      
      
 If @Segmentwise <> '0' /* Show Segments too */      
  Begin      
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '      
  End      
       
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS), (Sum(cast(TP as money)+DP+TS+DS)/' + @@TotVolume + ')*100 as [% Volume],' +      
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), (Sum(cast(TPA as money)+DPA+TSA+DSA)/ ' + @@TotTurnOver + ')*100 as [% Turnover],' +      
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB), (Sum(cast(TPB as money)+DPB+TSB+DSB)/ ' + @@TotBrokerage + ')*100 as [% Brokerage]'      
      
 Set @@From = ' From level1scripmis a /*change*/, [ABCSOORACLEMDLW].synergy.dbo.security b '      
      
      
-- Add Top to Select      
      
 /* Add top to select */      
 If (@Top='0')      
  Begin      
   Set @@Select = ' Select ' + @@Select      
  End      
 Else /* Get all records */      
  Begin      
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select      
  End      
      
 Print  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP ' + @@OrderBy )      
 --Exec  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP '+ @@OrderBy)      
      
/*      
 -- Scrip Name wise      
 Exec sp_Scripwise_acer 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','G', '0', '10'      
      
 -- Branch wise for selected Scrip      
 Exec sp_Scripwise 'Branch_cd','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','ADLABS FILMS LTD'      
      
 -- Subbroker wise for selected Scrip, Branch      
 sp_Scripwise 'Sub_Broker', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD'       
       
 -- Family wise for selected Scrip, Branch, Subbroker      
 sp_Scripwise 'Family_Name', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD','CC'      
      
 -- Scrip Name wise, order by Turnover / Volume / Brokerage      
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','','','','Turnover'      
      
 -- Scrip Name wise, Segmentwise      
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '1', '10'      
*/      
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Scripwise_23dec2019
-- --------------------------------------------------
  
 /****** Object:  Stored Procedure dbo.sp_Scripwise    Script Date: 11/08/2005 15:18:38 ******/      
CREATE  Procedure sp_Scripwise_23dec2019      
(      
 @Console varchar(200)='', /* Scrip_Name, Branch_CD, Sub_Broker, Family_Name */      
 @DateFrom varchar(100) ='',      
 @DateTo varchar(100)='',      
 @ScripNameFrom varchar(500)='',      
 @ScripNameTo varchar(500)='',      
 @Segmentwise varchar(1)='0',      
 @Top varchar(3)='0',      
 @ScripName varchar(200)='',      
 @BranchName varchar(200)='',      
 @Sub_Broker varchar(200)='',      
 @Family varchar(25)='',      
 @Order varchar(25)='',      
 @Year varchar(5)='',      
 @ExchangeSegment varchar(8)=''      
)      
      
As      
      
Declare      
 @@Select Varchar(5000),      
 @@From varchar(100),      
 @@Where varchar(1000),      
 @@GroupBy varchar(1000),      
 @@OrderBy varchar(800),      
      
@TotVol money      
      
Begin      
      
      
-- Select       
If @Console = 'Branch_cd'      
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'      
 Else      
 Begin      
  If @Console = 'Scrip_name'      
   Set @@Select = ' [Scrip_name]= sc_isinname, '      
  Else      
   Set @@Select = @Console + ' , '      
 End      
      
 If @Segmentwise <> '0' /* Show Segments too */      
  Begin      
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '      
  End      
       
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS),/* Sum(cast(TP as money)+DP+TS+DS)/' + '@@TotVolume' + ' as [Volume %], */' +      
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), ' +      
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB)  '      
      
 Set @@From = ' From level1scripmis a /*change*/, [196.1.115.199].synergy.dbo.security b '      
      
      
      
-- Where Condition      
      
 Set @@Where = ' Where '+      
  /* Compare ISIN */      
   'a.ISIN = b.sc_ISINcode collate SQL_Latin1_General_CP1_CI_AS '       
        
  If (@ScripName='')      
   Begin      
    /* Scrip Range */      
    Set @@Where = @@Where + ' And sc_isinname>=''' + @ScripNameFrom + ''' And sc_isinname<=''' + @ScripNameTo + ''' '       
   End      
  Else      
   Begin      
    /* Selected Scrip */      
    Set @@Where = @@Where +  ' And b.sc_isinname  Like ''' + @ScripName + '%'' '      
    If @Console = 'Sub_Broker'      
     Begin      
      Set @@Where = @@Where +  ' And Branch_cd=(Select Branch_Code from Branch where Branch=''' + @BranchName + ''') '      
      If @Console='Family_Name'      
       Begin      
        Set @@Where = @@Where +  ' And Sub_Broker=''' + @Sub_Broker + ''' '       
       End      
     End      
   End      
    If @BranchName <> ''      
     Set @@Where = @@Where + ' And Branch_cd = (Select Branch_Code From Branch Where Branch= ''' + @BranchName + ''')'      
    If @Family <> ''      
     Set @@Where = @@Where + ' And Family = ''' + @Family + ''''      
    If @Sub_Broker <> ''      
     Set @@Where = @@Where + ' And Sub_Broker = ''' + @Sub_Broker + ''''      
    If @Year <> ''      
     Set @@Where = @@Where + ' And DatePart(Year,Sauda_Date) = ''' + @Year + ''''      
    If @ExchangeSegment <> ''      
     Set @@Where = @@Where + ' And a.ExchangeSegment = ''' ++ @ExchangeSegment + ''''      
      
      
  /* Date Range */      
  Set @@Where = @@Where +  ' And a.sauda_date >= Cast('' ' + @DateFrom + ' '' as DateTime) And a.sauda_date <= Cast('' ' + @DateTo + ' '' as DateTime) '      
      
-- Group By      
 If @Console = 'Scrip_name'      
  Set @@GroupBy = ' Group By sc_isinname '      
 Else      
  Set @@GroupBy = ' Group By ' + @Console      
       
 If @Segmentwise <> '0' /* Segmentwise Grouping */      
  Begin      
   Set @@GroupBy = @@GroupBy + ' , a.ExchangeSegment '      
  End      
      
      
-- Order By     
      
 If LTrim(RTrim(@Order)) = ''      
  Begin      
   If @Console = 'Branch_cd'      
    Set @@OrderBy = ' Order By [Branch Name] '      
   Else      
    Set @@OrderBy = ' Order By ' + @Console      
  End      
 Else      
  Set @@OrderBy = ' Order By ' + @Order      
      
-- Add Top to Select      
      
 /* Add top to select */      
 If (@Top='0')      
  Begin      
   Set @@Select = ' Select ' + @@Select      
  End      
 Else /* Get all records */      
  Begin      
Set @@Select = ' Select Top ' + @Top + ' ' + @@Select      
  End      
      
      
 /* Print the final query */      
 --Print (@@Select + @@From + @@Where + @@GroupBy + @@OrderBy)      
      
 -- Compute Total      
      
 Declare @@TotVolume varchar(25),      
  @@TotTurnOver varchar(25),      
  @@TotBrokerage varchar(25)      
      
 Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )      
 --Print ('Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')      
 Exec  ('Insert #TotalAll Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')       
 select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll      
 Drop Table #TotalAll      
      
 --print @@TotVolume      
 --print @@TotTurnOver      
 --print @@TotBrokerage      
      
 If (@@TotVolume Is Null Or @@TotVolume='0')      
  Set @@TotVolume = '1'      
      
 If (@@TotTurnOver Is Null Or @@TotTurnOver = '0')      
  Set @@TotTurnOver = '1'      
      
 If (@@TotBrokerage Is Null Or @@TotBrokerage = '0')      
  Set @@TotBrokerage = '1'      
      
-- Rebuild Select       
      
-- Select       
 If @Console = 'Branch_cd'      
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'      
 Else      
 Begin      
  If @Console = 'Scrip_name'      
   Set @@Select = ' [Scrip_name]= sc_isinname, '      
  Else      
   Set @@Select = @Console + ' , '      
 End      
      
 If @Segmentwise <> '0' /* Show Segments too */      
  Begin      
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '      
  End      
       
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS), (Sum(cast(TP as money)+DP+TS+DS)/' + @@TotVolume + ')*100 as [% Volume],' +      
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), (Sum(cast(TPA as money)+DPA+TSA+DSA)/ ' + @@TotTurnOver + ')*100 as [% Turnover],' +      
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB), (Sum(cast(TPB as money)+DPB+TSB+DSB)/ ' + @@TotBrokerage + ')*100 as [% Brokerage]'      
      
 Set @@From = ' From level1scripmis a /*change*/, [196.1.115.199].synergy.dbo.security b '      
      
      
-- Add Top to Select      
      
 /* Add top to select */      
 If (@Top='0')      
  Begin      
   Set @@Select = ' Select ' + @@Select      
  End      
 Else /* Get all records */      
  Begin      
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select      
  End      
      
 Print  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP ' + @@OrderBy )      
 --Exec  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP '+ @@OrderBy)      
      
/*      
 -- Scrip Name wise      
 Exec sp_Scripwise_acer 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','G', '0', '10'      
      
 -- Branch wise for selected Scrip      
 Exec sp_Scripwise 'Branch_cd','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','ADLABS FILMS LTD'      
      
 -- Subbroker wise for selected Scrip, Branch      
 sp_Scripwise 'Sub_Broker', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD'       
       
 -- Family wise for selected Scrip, Branch, Subbroker      
 sp_Scripwise 'Family_Name', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD','CC'      
      
 -- Scrip Name wise, order by Turnover / Volume / Brokerage      
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','','','','Turnover'      
      
 -- Scrip Name wise, Segmentwise      
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '1', '10'      
*/      
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Scripwise_31122012
-- --------------------------------------------------
 /****** Object:  Stored Procedure dbo.sp_Scripwise    Script Date: 11/08/2005 15:18:38 ******/  
CREATE   Procedure sp_Scripwise_31122012  
(  
 @Console varchar(200)='', /* Scrip_Name, Branch_CD, Sub_Broker, Family_Name */  
 @DateFrom varchar(100) ='',  
 @DateTo varchar(100)='',  
 @ScripNameFrom varchar(500)='',  
 @ScripNameTo varchar(500)='',  
 @Segmentwise varchar(1)='0',  
 @Top varchar(3)='0',  
 @ScripName varchar(200)='',  
 @BranchName varchar(200)='',  
 @Sub_Broker varchar(200)='',  
 @Family varchar(25)='',  
 @Order varchar(25)='',  
 @Year varchar(5)='',  
 @ExchangeSegment varchar(8)=''  
)  
  
As  
  
Declare  
 @@Select Varchar(5000),  
 @@From varchar(100),  
 @@Where varchar(1000),  
 @@GroupBy varchar(1000),  
 @@OrderBy varchar(800),  
  
@TotVol money  
  
Begin  
  
  
-- Select   
If @Console = 'Branch_cd'  
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'  
 Else  
 Begin  
  If @Console = 'Scrip_name'  
   Set @@Select = ' [Scrip_name]= sc_isinname, '  
  Else  
   Set @@Select = @Console + ' , '  
 End  
  
 If @Segmentwise <> '0' /* Show Segments too */  
  Begin  
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '  
  End  
   
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS),/* Sum(cast(TP as money)+DP+TS+DS)/' + '@@TotVolume' + ' as [Volume %], */' +  
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), ' +  
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB)  '  
  
 Set @@From = ' From level1scripmis a /*change*/, DPBackOffice.acercross.dbo.security b '  
  
  
  
-- Where Condition  
  
 Set @@Where = ' Where '+  
  /* Compare ISIN */  
   'a.ISIN = b.sc_ISINcode collate SQL_Latin1_General_CP1_CI_AS '   
    
  If (@ScripName='')  
   Begin  
    /* Scrip Range */  
    Set @@Where = @@Where + ' And sc_isinname>=''' + @ScripNameFrom + ''' And sc_isinname<=''' + @ScripNameTo + ''' '   
   End  
  Else  
   Begin  
    /* Selected Scrip */  
    Set @@Where = @@Where +  ' And b.sc_isinname  Like ''' + @ScripName + '%'' '  
    If @Console = 'Sub_Broker'  
     Begin  
      Set @@Where = @@Where +  ' And Branch_cd=(Select Branch_Code from Branch where Branch=''' + @BranchName + ''') '  
      If @Console='Family_Name'  
       Begin  
        Set @@Where = @@Where +  ' And Sub_Broker=''' + @Sub_Broker + ''' '   
       End  
     End  
   End  
    If @BranchName <> ''  
     Set @@Where = @@Where + ' And Branch_cd = (Select Branch_Code From Branch Where Branch= ''' + @BranchName + ''')'  
    If @Family <> ''  
     Set @@Where = @@Where + ' And Family = ''' + @Family + ''''  
    If @Sub_Broker <> ''  
     Set @@Where = @@Where + ' And Sub_Broker = ''' + @Sub_Broker + ''''  
    If @Year <> ''  
     Set @@Where = @@Where + ' And DatePart(Year,Sauda_Date) = ''' + @Year + ''''  
    If @ExchangeSegment <> ''  
     Set @@Where = @@Where + ' And a.ExchangeSegment = ''' ++ @ExchangeSegment + ''''  
  
  
  /* Date Range */  
  Set @@Where = @@Where +  ' And a.sauda_date >= Cast('' ' + @DateFrom + ' '' as DateTime) And a.sauda_date <= Cast('' ' + @DateTo + ' '' as DateTime) '  
  
-- Group By  
 If @Console = 'Scrip_name'  
  Set @@GroupBy = ' Group By sc_isinname '  
 Else  
  Set @@GroupBy = ' Group By ' + @Console  
   
 If @Segmentwise <> '0' /* Segmentwise Grouping */  
  Begin  
   Set @@GroupBy = @@GroupBy + ' , a.ExchangeSegment '  
  End  
  
  
-- Order By  
  
 If LTrim(RTrim(@Order)) = ''  
  Begin  
   If @Console = 'Branch_cd'  
    Set @@OrderBy = ' Order By [Branch Name] '  
   Else  
    Set @@OrderBy = ' Order By ' + @Console  
  End  
 Else  
  Set @@OrderBy = ' Order By ' + @Order  
  
-- Add Top to Select  
  
 /* Add top to select */  
 If (@Top='0')  
  Begin  
   Set @@Select = ' Select ' + @@Select  
  End  
 Else /* Get all records */  
  Begin  
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select  
  End  
  
  
 /* Print the final query */  
 --Print (@@Select + @@From + @@Where + @@GroupBy + @@OrderBy)  
  
 -- Compute Total  
  
 Declare @@TotVolume varchar(25),  
  @@TotTurnOver varchar(25),  
  @@TotBrokerage varchar(25)  
  
 Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )  
 --Print ('Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')  
 Exec  ('Insert #TotalAll Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')   
 select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll  
 Drop Table #TotalAll  
  
 --print @@TotVolume  
 --print @@TotTurnOver  
 --print @@TotBrokerage  
  
 If (@@TotVolume Is Null Or @@TotVolume='0')  
  Set @@TotVolume = '1'  
  
 If (@@TotTurnOver Is Null Or @@TotTurnOver = '0')  
  Set @@TotTurnOver = '1'  
  
 If (@@TotBrokerage Is Null Or @@TotBrokerage = '0')  
  Set @@TotBrokerage = '1'  
  
-- Rebuild Select   
  
-- Select   
 If @Console = 'Branch_cd'  
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'  
 Else  
 Begin  
  If @Console = 'Scrip_name'  
   Set @@Select = ' [Scrip_name]= sc_isinname, '  
  Else  
   Set @@Select = @Console + ' , '  
 End  
  
 If @Segmentwise <> '0' /* Show Segments too */  
  Begin  
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '  
  End  
   
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS), (Sum(cast(TP as money)+DP+TS+DS)/' + @@TotVolume + ')*100 as [% Volume],' +  
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), (Sum(cast(TPA as money)+DPA+TSA+DSA)/ ' + @@TotTurnOver + ')*100 as [% Turnover],' +  
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB), (Sum(cast(TPB as money)+DPB+TSB+DSB)/ ' + @@TotBrokerage + ')*100 as [% Brokerage]'  
  
 Set @@From = ' From level1scripmis a /*change*/, dpbackoffice.acercross.dbo.security b '  
  
  
-- Add Top to Select  
  
 /* Add top to select */  
 If (@Top='0')  
  Begin  
   Set @@Select = ' Select ' + @@Select  
  End  
 Else /* Get all records */  
  Begin  
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select  
  End  
  
 --Print  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP ' + @@OrderBy )  
 Exec  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP '+ @@OrderBy)  
  
/*  
 -- Scrip Name wise  
 Exec sp_Scripwise_acer 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','G', '0', '10'  
  
 -- Branch wise for selected Scrip  
 Exec sp_Scripwise 'Branch_cd','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','ADLABS FILMS LTD'  
  
 -- Subbroker wise for selected Scrip, Branch  
 sp_Scripwise 'Sub_Broker', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD'   
   
 -- Family wise for selected Scrip, Branch, Subbroker  
 sp_Scripwise 'Family_Name', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD','CC'  
  
 -- Scrip Name wise, order by Turnover / Volume / Brokerage  
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','','','','Turnover'  
  
 -- Scrip Name wise, Segmentwise  
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '1', '10'  
*/  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Scripwise_orig
-- --------------------------------------------------
CREATE Procedure sp_Scripwise_orig
(
	@Console varchar(200)='', /* Scrip_Name, Branch_CD, Sub_Broker, Family_Name */
	@DateFrom varchar(100) ='',
	@DateTo varchar(100)='',
	@ScripNameFrom varchar(500)='',
	@ScripNameTo varchar(500)='',
	@Segmentwise varchar(1)='0',
	@Top varchar(3)='0',
	@ScripName varchar(200)='',
	@BranchName varchar(200)='',
	@Sub_Broker varchar(200)='',
	@Family varchar(25)='',
	@Order varchar(25)='',
	@Year varchar(5)='',
	@ExchangeSegment varchar(8)=''
)
As

Declare
	@@Select Varchar(5000),
	@@From varchar(100),
	@@Where varchar(1000),
	@@GroupBy varchar(1000),
	@@OrderBy varchar(800),

@TotVol money

Begin


-- Select 
	If @Console = 'Branch_cd'
		Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'
	Else
		Set @@Select =	@Console + ' , '

	If @Segmentwise <> '0' /* Show Segments too */
		Begin
			Set @@Select = @@Select + ' b.ExchangeSegment as [Exchange Segment], '
		End
	
	Set @@Select =	 @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS),/* Sum(cast(TP as money)+DP+TS+DS)/' + '@@TotVolume' + ' as [Volume %], */' +
			' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), ' +
			' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB)  '

	Set @@From = ' From level1scripmis a /*change*/, scripmaster b '



-- Where Condition

	Set @@Where = '	Where '+
		/* Compare ISIN */
		 'a.ISIN = b.ISIN collate SQL_Latin1_General_CP1_CI_AS ' 
		
		If (@ScripName='')
			Begin
				/* Scrip Range */
				Set @@Where = @@Where + ' And scrip_name>=''' + @ScripNameFrom + ''' And scrip_name<=''' + @ScripNameTo + ''' ' 
			End
		Else
			Begin
				/* Selected Scrip */
				Set @@Where = @@Where +  ' And b.scrip_name=''' + @ScripName + ''' '
				If @Console = 'Sub_Broker'
					Begin
						Set @@Where = @@Where +  ' And Branch_cd=(Select Branch_Code from Branch where Branch=''' + @BranchName + ''') '
						If @Console='Family_Name'
							Begin
								Set @@Where = @@Where +  ' And Sub_Broker=''' + @Sub_Broker + ''' '	
							End
					End
			End
				If @BranchName <> ''
					Set @@Where = @@Where + ' And Branch_cd = (Select Branch_Code From Branch Where Branch= ''' + @BranchName + ''')'
				If @Family <> ''
					Set @@Where = @@Where + ' And Family = ''' + @Family + ''''
				If @Sub_Broker <> ''
					Set @@Where = @@Where + ' And Sub_Broker = ''' + @Sub_Broker + ''''
				If @Year <> ''
					Set @@Where = @@Where + ' And DatePart(Year,Sauda_Date) = ''' + @Year + ''''
				If @ExchangeSegment <> ''
					Set @@Where = @@Where + ' And a.ExchangeSegment = ''' ++ @ExchangeSegment + ''''


		/* Date Range */
		Set @@Where = @@Where +  ' And a.sauda_date >= Cast('' ' + @DateFrom + ' '' as DateTime) And a.sauda_date <= Cast('' ' + @DateTo + ' '' as DateTime) '

-- Group By
	Set @@GroupBy =	' Group By ' + @Console
	
	If @Segmentwise <> '0' /* Segmentwise Grouping */
		Begin
			Set @@GroupBy = @@GroupBy + ' , b.ExchangeSegment '
		End


-- Order By

	If LTrim(RTrim(@Order)) = ''
		Begin
			If @Console = 'Branch_cd'
				Set @@OrderBy = ' Order By [Branch Name] '
			Else
				Set @@OrderBy =	' Order By ' + @Console
		End
	Else
		Set @@OrderBy = ' Order By ' + @Order

-- Add Top to Select

	/* Add top to select */
	If (@Top='0')
		Begin
			Set @@Select = ' Select ' + @@Select
		End
	Else /* Get all records */
		Begin
			Set @@Select = ' Select Top ' + @Top + ' ' + @@Select
		End


	/* Print the final query */
	--Print (@@Select + @@From + @@Where + @@GroupBy + @@OrderBy)
	


-- Compute Total
	
	Declare @@TotVolume varchar(25),
		@@TotTurnOver varchar(25),
		@@TotBrokerage varchar(25)
	
	Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )
	Print ('Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')
	Insert #TotalAll
	Exec  ('Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T') 
	select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll
	Drop Table #TotalAll
	
	print @@TotVolume
	print @@TotTurnOver
	print @@TotBrokerage

	If (@@TotVolume Is Null Or @@TotVolume='0')
		Set @@TotVolume = '1'

	If (@@TotTurnOver Is Null Or @@TotTurnOver = '0')
		Set @@TotTurnOver = '1'

	If (@@TotBrokerage Is Null Or @@TotBrokerage = '0')
		Set @@TotBrokerage = '1'


-- Rebuild Select 

-- Select 
	If @Console = 'Branch_cd'
		Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'
	Else
		Set @@Select =	@Console + ' , '

	If @Segmentwise <> '0' /* Show Segments too */
		Begin
			Set @@Select = @@Select + ' b.ExchangeSegment as [Exchange Segment], '
		End
	
	Set @@Select =	 @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS), (Sum(cast(TP as money)+DP+TS+DS)/' + @@TotVolume + ')*100 as [% Volume],' +
			' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), (Sum(cast(TPA as money)+DPA+TSA+DSA)/ ' + @@TotTurnOver + ')*100 as [% Turnover],' +
			' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB), (Sum(cast(TPB as money)+DPB+TSB+DSB)/ ' + @@TotBrokerage + ')*100 as [% Brokerage]'

	Set @@From = ' From level1scripmis a /*change*/, scripmaster b '


-- Add Top to Select

	/* Add top to select */
	If (@Top='0')
		Begin
			Set @@Select = ' Select ' + @@Select
		End
	Else /* Get all records */
		Begin
			Set @@Select = ' Select Top ' + @Top + ' ' + @@Select
		End

	Print  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP ' + @@OrderBy )
	Exec  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP '+ @@OrderBy)

/*
	-- Scrip Name wise
	Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10'

	-- Branch wise for selected Scrip
	Exec sp_Scripwise 'Branch_cd','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','ADLABS FILMS LTD'

	-- Subbroker wise for selected Scrip, Branch
	sp_Scripwise 'Sub_Broker', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD' 
	
	-- Family wise for selected Scrip, Branch, Subbroker
	sp_Scripwise 'Family_Name', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD','CC'

	-- Scrip Name wise, order by Turnover / Volume / Brokerage
	Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','','','','Turnover'

	-- Scrip Name wise, Segmentwise
	Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '1', '10'
*/

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Scripwise_test
-- --------------------------------------------------
    
    
/****** Object:  Stored Procedure dbo.sp_Scripwise    Script Date: 11/08/2005 15:18:38 ******/      
CREATE   Procedure sp_Scripwise_test  
(      
 @Console varchar(200)='', /* Scrip_Name, Branch_CD, Sub_Broker, Family_Name */      
 @DateFrom varchar(100) ='',      
 @DateTo varchar(100)='',      
 @ScripNameFrom varchar(500)='',      
 @ScripNameTo varchar(500)='',      
 @Segmentwise varchar(1)='0',      
 @Top varchar(3)='0',      
 @ScripName varchar(200)='',      
 @BranchName varchar(200)='',      
 @Sub_Broker varchar(200)='',      
 @Family varchar(25)='',      
 @Order varchar(25)='',      
 @Year varchar(5)='',      
 @ExchangeSegment varchar(8)=''      
)      
      
As      
      
Declare      
 @@Select Varchar(5000),      
 @@From varchar(100),      
 @@Where varchar(1000),      
 @@GroupBy varchar(1000),      
 @@OrderBy varchar(800),      
      
@TotVol money      
      
Begin      
      
      
-- Select       
If @Console = 'Branch_cd'      
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'      
 Else      
 Begin      
  If @Console = 'Scrip_name'      
   Set @@Select = ' [Scrip_name]= sc_isinname, '      
  Else      
   Set @@Select = @Console + ' , '      
 End      
      
 If @Segmentwise <> '0' /* Show Segments too */      
  Begin      
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '      
  End      
       
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS),/* Sum(cast(TP as money)+DP+TS+DS)/' + '@@TotVolume' + ' as [Volume %], */' +      
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), ' +      
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB)  '      
      
 Set @@From = ' From level1scripmis a /*change*/, [196.1.115.199].synergy.dbo.security b '      
      
      
      
-- Where Condition      
      
 Set @@Where = ' Where '+      
  /* Compare ISIN */      
   'a.ISIN = b.sc_ISINcode collate SQL_Latin1_General_CP1_CI_AS '       
        
  If (@ScripName='')      
   Begin      
    /* Scrip Range */      
    Set @@Where = @@Where + ' And sc_isinname>=''' + @ScripNameFrom + ''' And sc_isinname<=''' + @ScripNameTo + ''' '       
   End      
  Else      
   Begin      
    /* Selected Scrip */      
    Set @@Where = @@Where +  ' And b.sc_isinname  Like ''' + @ScripName + '%'' '      
    If @Console = 'Sub_Broker'      
     Begin      
      Set @@Where = @@Where +  ' And Branch_cd=(Select Branch_Code from Branch where Branch=''' + @BranchName + ''') '      
      If @Console='Family_Name'      
       Begin      
        Set @@Where = @@Where +  ' And Sub_Broker=''' + @Sub_Broker + ''' '       
       End      
     End      
   End      
    If @BranchName <> ''      
     Set @@Where = @@Where + ' And Branch_cd = (Select Branch_Code From Branch Where Branch= ''' + @BranchName + ''')'      
    If @Family <> ''      
     Set @@Where = @@Where + ' And Family = ''' + @Family + ''''      
    If @Sub_Broker <> ''      
     Set @@Where = @@Where + ' And Sub_Broker = ''' + @Sub_Broker + ''''      
    If @Year <> ''      
     Set @@Where = @@Where + ' And DatePart(Year,Sauda_Date) = ''' + @Year + ''''      
    If @ExchangeSegment <> ''      
     Set @@Where = @@Where + ' And a.ExchangeSegment = ''' ++ @ExchangeSegment + ''''      
      
      
  /* Date Range */      
  Set @@Where = @@Where +  ' And a.sauda_date >= Cast('' ' + @DateFrom + ' '' as DateTime) And a.sauda_date <= Cast('' ' + @DateTo + ' '' as DateTime) '      
      
-- Group By      
 If @Console = 'Scrip_name'      
  Set @@GroupBy = ' Group By sc_isinname '      
 Else      
  Set @@GroupBy = ' Group By ' + @Console      
       
 If @Segmentwise <> '0' /* Segmentwise Grouping */      
  Begin      
   Set @@GroupBy = @@GroupBy + ' , a.ExchangeSegment '      
  End      
      
      
-- Order By      
      
 If LTrim(RTrim(@Order)) = ''      
  Begin      
   If @Console = 'Branch_cd'      
    Set @@OrderBy = ' Order By [Branch Name] '      
   Else      
    Set @@OrderBy = ' Order By ' + @Console      
  End      
 Else      
  Set @@OrderBy = ' Order By ' + @Order      
      
-- Add Top to Select      
      
 /* Add top to select */      
 If (@Top='0')      
  Begin      
   Set @@Select = ' Select ' + @@Select      
  End      
 Else /* Get all records */      
  Begin      
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select      
  End      
      
      
 /* Print the final query */      
 --Print (@@Select + @@From + @@Where + @@GroupBy + @@OrderBy)      
      
 -- Compute Total      
      
 Declare @@TotVolume varchar(25),      
  @@TotTurnOver varchar(25),      
  @@TotBrokerage varchar(25)      
      
 Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )      
       
 --UNCOMMENTED      
 Print ('Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')      
       
      
 Exec  ('Insert #TotalAll Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')       
 select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll      
 Drop Table #TotalAll      
      
 --print @@TotVolume      
 --print @@TotTurnOver      
 --print @@TotBrokerage      
      
 If (@@TotVolume Is Null Or @@TotVolume='0')      
  Set @@TotVolume = '1'      
      
 If (@@TotTurnOver Is Null Or @@TotTurnOver = '0')      
  Set @@TotTurnOver = '1'      
      
 If (@@TotBrokerage Is Null Or @@TotBrokerage = '0')      
  Set @@TotBrokerage = '1'      
      
-- Rebuild Select       
      
-- Select       
 If @Console = 'Branch_cd'      
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'      
 Else      
 Begin      
  If @Console = 'Scrip_name'      
   Set @@Select = ' [Scrip_name]= sc_isinname, '      
  Else      
   Set @@Select = @Console + ' , '      
 End      
      
 If @Segmentwise <> '0' /* Show Segments too */      
  Begin      
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '      
  End      
       
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS), (Sum(cast(TP as money)+DP+TS+DS)/' + @@TotVolume + ')*100 as [% Volume],' +      
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), (Sum(cast(TPA as money)+DPA+TSA+DSA)/ ' + @@TotTurnOver + ')*100 as [% Turnover],' +      
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB), (Sum(cast(TPB as money)+DPB+TSB+DSB)/ ' + @@TotBrokerage + ')*100 as [% Brokerage]'      
      
 Set @@From = ' From level1scripmis a /*change*/, [196.1.115.199].synergy.dbo.security b '      
      
      
-- Add Top to Select      
      
 /* Add top to select */      
 If (@Top='0')      
  Begin      
   Set @@Select = ' Select ' + @@Select      
  End      
 Else /* Get all records */      
  Begin      
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select      
  End      
      
 --UNCOMMENTED      
 Print  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP ' + @@OrderBy )      
       
 Exec  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP '+ @@OrderBy)      
      
/*      
 -- Scrip Name wise      
 Exec sp_Scripwise_acer 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','G', '0', '10'      
      
 -- Branch wise for selected Scrip      
 Exec sp_Scripwise 'Branch_cd','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','ADLABS FILMS LTD'      
      
 -- Subbroker wise for selected Scrip, Branch      
 sp_Scripwise 'Sub_Broker', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD'       
       
 -- Family wise for selected Scrip, Branch, Subbroker      
 sp_Scripwise 'Family_Name', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD','CC'      
      
 -- Scrip Name wise, order by Turnover / Volume / Brokerage      
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','','','','Turnover'      
      
 -- Scrip Name wise, Segmentwise      
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '1', '10'      
*/      
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Scripwise_test31_12_2012
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.sp_Scripwise    Script Date: 11/08/2005 15:18:38 ******/  
CREATE   Procedure sp_Scripwise_test31_12_2012  
(  
 @Console varchar(200)='', /* Scrip_Name, Branch_CD, Sub_Broker, Family_Name */  
 @DateFrom varchar(100) ='',  
 @DateTo varchar(100)='',  
 @ScripNameFrom varchar(500)='',  
 @ScripNameTo varchar(500)='',  
 @Segmentwise varchar(1)='0',  
 @Top varchar(3)='0',  
 @ScripName varchar(200)='',  
 @BranchName varchar(200)='',  
 @Sub_Broker varchar(200)='',  
 @Family varchar(25)='',  
 @Order varchar(25)='',  
 @Year varchar(5)='',  
 @ExchangeSegment varchar(8)=''  
)  
  
As  
  
Declare  
 @@Select Varchar(5000),  
 @@From varchar(100),  
 @@Where varchar(1000),  
 @@GroupBy varchar(1000),  
 @@OrderBy varchar(800),  
  
@TotVol money  
  
Begin  
  
  
-- Select   
If @Console = 'Branch_cd'  
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'  
 Else  
 Begin  
  If @Console = 'Scrip_name'  
   Set @@Select = ' [Scrip_name]= sc_isinname, '  
  Else  
   Set @@Select = @Console + ' , '  
 End  
  
 If @Segmentwise <> '0' /* Show Segments too */  
  Begin  
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '  
  End  
   
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS),/* Sum(cast(TP as money)+DP+TS+DS)/' + '@@TotVolume' + ' as [Volume %], */' +  
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), ' +  
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB)  '  
  
 Set @@From = ' From level1scripmis a /*change*/, DPBackOffice.acercross.dbo.security b '  
  
  
  
-- Where Condition  
  
 Set @@Where = ' Where '+  
  /* Compare ISIN */  
   'a.ISIN = b.sc_ISINcode collate SQL_Latin1_General_CP1_CI_AS '   
    
  If (@ScripName='')  
   Begin  
    /* Scrip Range */  
    Set @@Where = @@Where + ' And sc_isinname>=''' + @ScripNameFrom + ''' And sc_isinname<=''' + @ScripNameTo + ''' '   
   End  
  Else  
   Begin  
    /* Selected Scrip */  
    Set @@Where = @@Where +  ' And b.sc_isinname  Like ''' + @ScripName + '%'' '  
    If @Console = 'Sub_Broker'  
     Begin  
      Set @@Where = @@Where +  ' And Branch_cd=(Select Branch_Code from Branch where Branch=''' + @BranchName + ''') '  
      If @Console='Family_Name'  
       Begin  
        Set @@Where = @@Where +  ' And Sub_Broker=''' + @Sub_Broker + ''' '   
       End  
     End  
   End  
    If @BranchName <> ''  
     Set @@Where = @@Where + ' And Branch_cd = (Select Branch_Code From Branch Where Branch= ''' + @BranchName + ''')'  
    If @Family <> ''  
     Set @@Where = @@Where + ' And Family = ''' + @Family + ''''  
    If @Sub_Broker <> ''  
     Set @@Where = @@Where + ' And Sub_Broker = ''' + @Sub_Broker + ''''  
    If @Year <> ''  
     Set @@Where = @@Where + ' And DatePart(Year,Sauda_Date) = ''' + @Year + ''''  
    If @ExchangeSegment <> ''  
     Set @@Where = @@Where + ' And a.ExchangeSegment = ''' ++ @ExchangeSegment + ''''  
  
  
  /* Date Range */  
  Set @@Where = @@Where +  ' And a.sauda_date >= Cast('' ' + @DateFrom + ' '' as DateTime) And a.sauda_date <= Cast('' ' + @DateTo + ' '' as DateTime) '  
  
-- Group By  
 If @Console = 'Scrip_name'  
  Set @@GroupBy = ' Group By sc_isinname '  
 Else  
  Set @@GroupBy = ' Group By ' + @Console  
   
 If @Segmentwise <> '0' /* Segmentwise Grouping */  
  Begin  
   Set @@GroupBy = @@GroupBy + ' , a.ExchangeSegment '  
  End  
  
  
-- Order By  
  
 If LTrim(RTrim(@Order)) = ''  
  Begin  
   If @Console = 'Branch_cd'  
    Set @@OrderBy = ' Order By [Branch Name] '  
   Else  
    Set @@OrderBy = ' Order By ' + @Console  
  End  
 Else  
  Set @@OrderBy = ' Order By ' + @Order  
  
-- Add Top to Select  
  
 /* Add top to select */  
 If (@Top='0')  
  Begin  
   Set @@Select = ' Select ' + @@Select  
  End  
 Else /* Get all records */  
  Begin  
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select  
  End  
  
  
 /* Print the final query */  
 --Print (@@Select + @@From + @@Where + @@GroupBy + @@OrderBy)  
  
 -- Compute Total  
  
 Declare @@TotVolume varchar(25),  
  @@TotTurnOver varchar(25),  
  @@TotBrokerage varchar(25)  
  
 Create Table #TotalAll (TotVolume  bigint, TotTurnOver  bigint, TotBrokerage  bigint )  
   
 --UNCOMMENTED  
 Print ('Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')  
   
  
 Exec  ('Insert #TotalAll Select Sum(Volume),Sum (Turnover),SUM(Brokerage) from (' + @@Select + @@From + @@Where + @@GroupBy + ')T')   
 select @@TotVolume=TotVolume,@@TotTurnOver=TotTurnOver,@@TotBrokerage=TotBrokerage from  #TotalAll  
 Drop Table #TotalAll  
  
 --print @@TotVolume  
 --print @@TotTurnOver  
 --print @@TotBrokerage  
  
 If (@@TotVolume Is Null Or @@TotVolume='0')  
  Set @@TotVolume = '1'  
  
 If (@@TotTurnOver Is Null Or @@TotTurnOver = '0')  
  Set @@TotTurnOver = '1'  
  
 If (@@TotBrokerage Is Null Or @@TotBrokerage = '0')  
  Set @@TotBrokerage = '1'  
  
-- Rebuild Select   
  
-- Select   
 If @Console = 'Branch_cd'  
  Set @@Select = ' [Branch Name]= (Select Branch from Branch where Branch_code = ' + @Console + '),'  
 Else  
 Begin  
  If @Console = 'Scrip_name'  
   Set @@Select = ' [Scrip_name]= sc_isinname, '  
  Else  
   Set @@Select = @Console + ' , '  
 End  
  
 If @Segmentwise <> '0' /* Show Segments too */  
  Begin  
   Set @@Select = @@Select + ' a.ExchangeSegment as [Exchange Segment], '  
  End  
   
 Set @@Select =  @@Select + ' Volume = Sum(cast(TP as money)+DP+TS+DS), (Sum(cast(TP as money)+DP+TS+DS)/' + @@TotVolume + ')*100 as [% Volume],' +  
   ' Turnover = Sum(cast(TPA as money)+DPA+TSA+DSA), (Sum(cast(TPA as money)+DPA+TSA+DSA)/ ' + @@TotTurnOver + ')*100 as [% Turnover],' +  
   ' Brokerage = Sum(cast(TPB as money)+DPB+TSB+DSB), (Sum(cast(TPB as money)+DPB+TSB+DSB)/ ' + @@TotBrokerage + ')*100 as [% Brokerage]'  
  
 Set @@From = ' From level1scripmis a /*change*/, dpbackoffice.acercross.dbo.security b '  
  
  
-- Add Top to Select  
  
 /* Add top to select */  
 If (@Top='0')  
  Begin  
   Set @@Select = ' Select ' + @@Select  
  End  
 Else /* Get all records */  
  Begin  
   Set @@Select = ' Select Top ' + @Top + ' ' + @@Select  
  End  
  
 --UNCOMMENTED  
 Print  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP ' + @@OrderBy )  
   
 Exec  ('Select * From (' + @@Select + @@From + @@Where + @@GroupBy + ' )TMP '+ @@OrderBy)  
  
/*  
 -- Scrip Name wise  
 Exec sp_Scripwise_acer 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','G', '0', '10'  
  
 -- Branch wise for selected Scrip  
 Exec sp_Scripwise 'Branch_cd','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','ADLABS FILMS LTD'  
  
 -- Subbroker wise for selected Scrip, Branch  
 sp_Scripwise 'Sub_Broker', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD'   
   
 -- Family wise for selected Scrip, Branch, Subbroker  
 sp_Scripwise 'Family_Name', '1 May 2001', '1 Mar 2005 23:59','A','C','0', '0','ASSOCIATED CEMENT CO. LTD','AHMEDABAD','CC'  
  
 -- Scrip Name wise, order by Turnover / Volume / Brokerage  
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '0', '10','','','','Turnover'  
  
 -- Scrip Name wise, Segmentwise  
 Exec sp_Scripwise 'Scrip_Name','Jan 1 2001 00:00', 'Jan 1 2005 23:59', 'A','C', '1', '10'  
*/  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_search_BranchAndSubbroker
-- --------------------------------------------------


CREATE PROC
	[dbo].[sp_search_BranchAndSubbroker]
	(
		@strWhatToSearch varchar(50),
		@strExchSeg varchar(15),
		@strBranchCode varchar(10),
		@strSubbrokerOrRemisierCode varchar(10)
	)
As

set @strWhatToSearch = upper(ltrim(rtrim(@strWhatToSearch)))
set @strExchSeg = upper(ltrim(rtrim(@strExchSeg)))

set @strBranchCode = upper(ltrim(rtrim(@strBranchCode)))
set @strSubbrokerOrRemisierCode = upper(ltrim(rtrim(@strSubbrokerOrRemisierCode)))

declare
	@strSQL varchar(3000),
	@strFirstSearchColumn varchar(50),
	@strServerName varchar(100)

if @strExchSeg = 'BSECM' set @strServerName = 'AngelBSECM.bsedb_ab.dbo.'
if @strExchSeg = 'NSECM' set @strServerName = 'AngelNseCM.msajag.dbo.'
if @strExchSeg = 'NSEFO' set @strServerName = 'angelfo.nsefo.dbo.'

set @strSQL = ''

set @strSQL = @strSQL + 'set transaction isolation level read uncommitted '
set @strSQL = @strSQL + 'select distinct '

begin
	if @strWhatToSearch = 'BRANCHCODE' set @strFirstSearchColumn = 'upper(ltrim(rtrim(br.branch_code)))'
	if @strWhatToSearch = 'SUBBROKERORREMISIERCODE' set @strFirstSearchColumn = 'upper(ltrim(rtrim(sb.sub_broker)))'

	set @strSQL = @strSQL + '	' + @strFirstSearchColumn + ' as searchcolm, '

	set @strSQL = @strSQL + '	upper(ltrim(rtrim(br.branch_code))) as branch_code, '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(br.branch))) as branch_name, '

	set @strSQL = @strSQL + '	upper(ltrim(rtrim(sb.sub_broker))) as SubbrokerOrRemisierCode, '
	set @strSQL = @strSQL + '	upper(ltrim(rtrim(sb.name))) as remisier_name '

	set @strSQL = @strSQL + 'from  '

	set @strSQL = @strSQL + '	' + @strServerName + 'branch br, '
	set @strSQL = @strSQL + '	' + @strServerName + 'subbrokers sb '

	set @strSQL = @strSQL + 'where '

	set @strSQL = @strSQL + '	br.branch_code = sb.branch_code and '

	set @strSQL = @strSQL + '	br.branch_code like ''' + @strBranchCode + '%'' and '
	set @strSQL = @strSQL + '	sb.sub_broker like ''' + @strSubbrokerOrRemisierCode + '%'' '

end

set @strSQL = @strSQL + 'order by '
set @strSQL = @strSQL + '	' + @strFirstSearchColumn + ' '

exec (@strSQL)
print (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_sundryclient
-- --------------------------------------------------

CREATE proc [dbo].[sp_sundryclient]
as
--begin tran
	truncate table bsesundryclientreco1
	
	Insert Into BseSundryClientReco1 Select * From ( 
	Select BnkName=Isnull(bnkname,''),BrnName=IsNull(brnname,''),Dd=Isnull(dd,''),DdNo=IsNull(ddno,''),L.vtyp,L.vno,acname,L.drcr,vamt,vdt,EnteredBy,CheckedBy,narration,Branch = COSTNAME ,exchseg='BSECM'
	From AngelBSECM.Account_ab.Dbo.Ledger L Left Outer Join AngelBSECM.Account_ab.Dbo.Ledger1 L1 
	On
	(L.Vtyp = L1.Vtyp 
	And L1.Vno = L.Vno
	And L1.DrCr = L.DrCr ),
	AngelBSECM.Account_ab.Dbo.Ledger2 L2, 
	AngelBSECM.Account_ab.Dbo.CostMast C
	Where  Vdt >= 'APR  1 2001' 
	And Vdt <= Getdate()
	and L.CltCode = '5100000001'
	And L.DrCr = L2.DrCr 
	And L.CltCode = L2.CltCode
	And L.Vno = L2.Vno
	And L.Vtyp = L2.Vtype
	And L2.CostCode = C.CostCode ) A
	
	 
	
	Insert Into BseSundryClientReco1 Select * From ( 
	Select bnkname=Isnull(bnkname,''),brnname=IsNull(brnname,''),dd=Isnull(dd,''),ddno=IsNull(ddno,''),L.vtyp,L.vno,acname,L.drcr,vamt,vdt,EnteredBy,CheckedBy,narration,Branch = COSTNAME ,exchseg='NSECM'
	From AngelNseCM.inhouse.dbo.Ledger L Left Outer Join AngelNseCM.inhouse.dbo.Ledger1 L1 
	On
	(L.Vtyp = L1.Vtyp 
	And L1.Vno = L.Vno
	And L1.DrCr = L.DrCr ),
	AngelNseCM.inhouse.dbo.Ledger2 L2, 
	AngelNseCM.inhouse.dbo.CostMast C
	Where  Vdt >= 'APR  1 2001' 
	And Vdt <= Getdate()
	and L.CltCode = '5100000002'
	And L.DrCr = L2.DrCr 
	And L.CltCode = L2.CltCode
	And L.Vno = L2.Vno
	And L.Vtyp = L2.Vtype
	And L2.CostCode = C.CostCode ) A
	
	
	
	Insert Into BseSundryClientReco1 Select * From ( 
	Select bnkname=Isnull(bnkname,''),brnname=IsNull(brnname,''),dd=Isnull(dd,''),ddno=IsNull(ddno,''),L.vtyp,L.vno,acname,L.drcr,vamt,vdt,EnteredBy,CheckedBy,narration,Branch = COSTNAME ,exchseg='NSEFO'
	From angelfo.inhouse.dbo.Ledger L Left Outer Join angelfo.inhouse.dbo.Ledger1 L1 
	On
	(L.Vtyp = L1.Vtyp 
	And L1.Vno = L.Vno
	And L1.DrCr = L.DrCr ),
	angelfo.inhouse.dbo.Ledger2 L2, 
	angelfo.inhouse.dbo.CostMast C
	Where  Vdt >= 'APR  1 2001' 
	And Vdt <= Getdate()
	and L.CltCode = '5100000001'
	And L.DrCr = L2.DrCr 
	And L.CltCode = L2.CltCode
	And L.Vno = L2.Vno
	And L.Vtyp = L2.Vtype
	And L2.CostCode = C.CostCode ) A
	
	 
	Insert Into BseSundryClientReco1 
	Select * From ( 
	Select bnkname=Isnull(bnkname,''),brnname=IsNull(brnname,''),dd=Isnull(dd,''),ddno=IsNull(ddno,''),L.vtyp,L.vno,acname,L.drcr,vamt,vdt,EnteredBy,CheckedBy,narration,Branch = COSTNAME ,exchseg='MCDX'
	From angelcommodity.AccountMcdx.Dbo.Ledger L Left Outer Join angelcommodity.AccountMcdx.Dbo.Ledger1 L1 
	On
	(L.Vtyp = L1.Vtyp 
	And L1.Vno = L.Vno
	And L1.DrCr = L.DrCr ),
	angelcommodity.AccountMcdx.Dbo.Ledger2 L2, 
	angelcommodity.AccountMcdx.Dbo.CostMast C
	Where  Vdt >= 'APR  1 2001' 
	And Vdt <= Getdate()
	and L.CltCode = '5100000001'
	And L.DrCr = L2.DrCr 
	And L.CltCode = L2.CltCode
	And L.Vno = L2.Vno
	And L.Vtyp = L2.Vtype
	And L2.CostCode = C.CostCode ) A
	
	
	Insert Into BseSundryClientReco1 
	Select * From ( 
	Select bnkname=Isnull(bnkname,''),brnname=IsNull(brnname,''),dd=Isnull(dd,''),ddno=IsNull(ddno,''),L.vtyp,L.vno,acname,L.drcr,vamt,vdt,EnteredBy,CheckedBy,narration,Branch = COSTNAME ,exchseg='NCDX'
	From Angelcommodity.AccountNcdx.Dbo.Ledger L Left Outer Join Angelcommodity.AccountNcdx.Dbo.Ledger1 L1 
	On
	(L.Vtyp = L1.Vtyp 
	And L1.Vno = L.Vno
	And L1.DrCr = L.DrCr ),
	Angelcommodity.AccountNcdx.Dbo.Ledger2 L2, 
	Angelcommodity.AccountNcdx.Dbo.CostMast C
	Where  Vdt >= 'APR  1 2001' 
	And Vdt <= Getdate()
	and L.CltCode = '5100000001'
	And L.DrCr = L2.DrCr 
	And L.CltCode = L2.CltCode
	And L.Vno = L2.Vno
	And L.Vtyp = L2.Vtype
	And L2.CostCode = C.CostCode ) A
	
--if @@error = 0 
  --        commit else rollback tran

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_SysObj
-- --------------------------------------------------
/*  
Author :- Prashant  
Date :- 28/01/2011  
*/  
CREATE Procedure Sp_SysObj  
(  
 @objName as varchar(20),  
 @objType as varchar(3)=''  
)  
as  
Begin  
 select * from sysobjects where name like '%'+@objName+'%' and type like '%'+@objType+'%'--'%batch%'  
 order by name,type  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_TRIPARTITE
-- --------------------------------------------------
  
 
CREATE PROCEDURE SP_TRIPARTITE  
  
(  
@CONAME AS VARCHAR(25),   
@BRCODE AS VARCHAR(25),   
@SBCODE AS VARCHAR(25)  
)      
AS      
      
select  CLCODE=cl_code COLLATE Latin1_General_CI_AS,short_name=short_name COLLATE Latin1_General_CI_AS      
,tabl=tabl COLLATE Latin1_General_CI_AS,tacdl=tacdl COLLATE Latin1_General_CI_AS      
from kyc_documents where cl_code in (select party_code from mis_to where branch_cd=@BRCODE and   
sub_broker like replace(@SBCODE,'All','%') and company=@CONAME)      
UNION      
select distinct cl_code=party_code,short_name=party_name,tabl='NO',TACDL='NO'       
from mis_to where sub_broker=@SBCODE and branch_cd=@BRCODE and company=@CONAME      
and sauda_Date >=getdate()-365 AND       
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_TRIPARTITE_New
-- --------------------------------------------------

--SP_TRIPARTITE 'ABLCM', 'ACM', 'ACm'

CREATE PROCEDURE SP_TRIPARTITE_New

(
@CONAME AS VARCHAR(25), 
@BRCODE AS VARCHAR(25), 
@SBCODE AS VARCHAR(25)
)    
AS    
    
select CLCODE=cl_code COLLATE Latin1_General_CI_AS,short_name=short_name COLLATE Latin1_General_CI_AS    
,tabl=tabl COLLATE Latin1_General_CI_AS,tacdl=tacdl COLLATE Latin1_General_CI_AS    
from kyc_documents where cl_code in (select party_code from mis_to where branch_cd=@BRCODE and 
sub_broker like replace(@SBCODE,'All','%') and company=@CONAME)    
UNION    
select distinct cl_code=party_code,short_name=party_name,tabl='NO',TACDL='NO'     
from mis_to where sub_broker=@SBCODE and branch_cd=@BRCODE and company=@CONAME    
and sauda_Date >=getdate()-365 AND     
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_XTAB
-- --------------------------------------------------
-- XTAB code is not intended for modification and all sql manipulation should be done through the interfacing parameters.
-- XTAB is designed for easy creation of ad-hoc pivoted views/outputs.
-- XTAB is designed for end-user querying through other procedures and/or application interfaces.
-- XTAB can generate up to 63000 characters of dynamic sql which should be more than sufficient for most user-generated crosstab queries.
-- Allowing end-users to select their own field combinations and filters means you don't have to spend hours writing single-purpose queries.
-- Ian Smith 27 Jan 2004
--sp_Xtab 'BSEDB_AB','MYPIVOT','CMBILLVALAN','branch_code','month(sauda_date)','','brokerage','SUM',0,'',''
CREATE PROCEDURE dbo.sp_XTAB

@MYDBO varchar(255),  -- database name
@MYQRY varchar(255),  -- view (name) to create/replace
@MYTBL varchar(4000),  -- table name or join statement
@MYOUT varchar(255), -- column/s to group
@MYPIV varchar(255),  -- column/s to pivot
@MYWHR1 varchar(4000), -- WHERE clause limits fields to be pivoted (---OPTIONAL---)
@MYFLD varchar(255),  -- field/s to calculate and populate pivoted columns I.e. field + field
@MYSUM varchar(255), -- calculation method I.e. COUNT SUM AVG  etc.
@MYALT varchar(255), -- NULL or 0 (zero) I.e. NULL goes with COUNT/Character fields
@MYWHR2 varchar(4000), -- WHERE clause filters calculated field/s (---OPTIONAL---)
@MYSTP varchar(8000) -- Output or other statement (---OPTIONAL---)

 AS

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

DECLARE @MYSTR varchar(8000), @MYTBLB varchar(4000), @MYPIVB varchar(4000)

-- Replace apostrophes with " | "  to avoid scoping errors which would be created by sql-parser when @MYSTR is submitted for execution.
SELECT @MYTBLB = REPLACE(@MYTBL,CHAR(39),CHAR(124))
SELECT @MYOUT = REPLACE(@MYOUT,CHAR(39),CHAR(124))
SELECT @MYPIVB = REPLACE(@MYPIV,CHAR(39),CHAR(124))
SELECT @MYWHR2 = REPLACE(@MYWHR2,CHAR(39),CHAR(124))
SELECT @MYALT = REPLACE(@MYALT,CHAR(39),CHAR(124))
SELECT @MYSTP = REPLACE(@MYSTP,CHAR(39),CHAR(124))
--  " | " symbols are put back to apostrophes before sub-strings are submitted for execution.

-- Build @MYSTR with secondary execution code.
SELECT @MYSTR = 'DECLARE @MYSUBSTR varchar(8000), @MYSUBSTR1 varchar(8000), @MYSUBSTR2 varchar(8000), @MYSUBSTR3 

varchar(8000), @MYSUBSTR4 varchar(8000), @MYSUBSTR5 varchar(8000), @MYSUBSTR6 varchar(8000), @MYSUBSTR7 varchar(8000), 

@MYSUBSTR8 varchar(8000), @MYSUBSTR9 varchar(8000), @MYSUBEND varchar(8000), @MYSUBQRY varchar(255), @MYSUBTBL 

varchar(4000), @MYSUBOUT varchar(255), @MYSUBPIV varchar(255), @MYSUBFLD varchar(255), @MYSUBSUM varchar(255), @MYSUBALT 

varchar(255), @MYXCOL varchar(255) , @MYSUBWHR2 varchar(4000), @MYSUBSTP varchar(8000), @MYSUBINT As int, @MYSUBMAX int
Use '+ @MYDBO + '
IF EXISTS (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.VIEWS
WHERE TABLE_NAME = ''' + @MYQRY + ''')
DROP VIEW ' + @MYQRY



-- The second execution must declare its own set of variables and these are set for initialisation here.
SELECT @MYSTR = @MYSTR + '
SELECT @MYSUBQRY = ''' + @MYQRY + '''
SELECT @MYSUBTBL = ''' + @MYTBLB + '''
SELECT @MYSUBOUT = ''' + @MYOUT + '''
SELECT @MYSUBPIV = ''' + @MYPIVB + '''
SELECT @MYSUBFLD = ''' + @MYFLD + '''
SELECT @MYSUBSUM = ''' + @MYSUM + '''
SELECT @MYSUBALT = ''' + @MYALT + '''
SELECT @MYSUBSTR1 = '''+CHAR(59)+'''
SELECT @MYSUBSTR2 = '''+CHAR(59)+'''
SELECT @MYSUBSTR3 = '''+CHAR(59)+'''
SELECT @MYSUBSTR4 = '''+CHAR(59)+'''
SELECT @MYSUBSTR5 = '''+CHAR(59)+'''
SELECT @MYSUBSTR6 = '''+CHAR(59)+'''
SELECT @MYSUBSTR7 = '''+CHAR(59)+'''
SELECT @MYSUBSTR8 = '''+CHAR(59)+'''
SELECT @MYSUBSTR9 = '''+CHAR(59)+'''
SELECT @MYSUBWHR2 = ''' + @MYWHR2 + '''
SELECT @MYSUBSTP = ''' + @MYSTP + '''
SELECT @MYSUBINT = 0
SELECT @MYSUBMAX = 17544'

-- Replace " | " with double apostrophes here.
SELECT @MYSTR = @MYSTR + '
SELECT @MYSUBTBL = REPLACE(@MYSUBTBL,'''+CHAR(124)+''','''+CHAR(39)+CHAR(39)+''')
SELECT @MYSUBOUT = REPLACE(@MYSUBOUT,'''+CHAR(124)+''','''+CHAR(39)+CHAR(39)+''')
SELECT @MYSUBPIV = REPLACE(@MYSUBPIV,'''+CHAR(124)+''','''+CHAR(39)+CHAR(39)+''')
SELECT @MYSUBWHR2 = REPLACE(@MYSUBWHR2,'''+CHAR(124)+''','''+CHAR(39)+CHAR(39)+''')
SELECT @MYSUBALT = REPLACE(@MYSUBALT,'''+CHAR(124)+''','''+CHAR(39)+CHAR(39)+''') '


-- Initialise secondary execution code.
SELECT @MYSTR = @MYSTR + '
SELECT @MYSUBSTR = ''CREATE VIEW '' + @MYSUBQRY + '' AS SELECT TOP 100 PERCENT '' + @MYSUBOUT'

-- Add secondary execution iteration to identify and create the pivoted columns.
SELECT @MYSTR = @MYSTR + '
DECLARE curXTAB CURSOR FAST_FORWARD FOR
SELECT DISTINCT '+@MYPIV+' 
FROM '+@MYTBL+' 
'+@MYWHR1+' 
ORDER BY '+@MYPIV+'

OPEN curXTAB
FETCH NEXT FROM curXTAB
INTO @MYXCOL
WHILE @@FETCH_STATUS = 0
BEGIN

If @MYSUBINT <=  @MYSUBMAX
BEGIN
SELECT @MYSUBINT = @MYSUBINT + 1

SELECT @MYXCOL = IsNull(@MYXCOL,''NULL'')'

-- Build a series of secondary execution strings accomodating up to 63000 characters of dynamic sql.
SELECT @MYSTR = @MYSTR + '
If (Len(@MYSUBSTR) < 7001)
BEGIN
SELECT @MYSUBSTR = @MYSUBSTR  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR1) < 7001)
BEGIN
SELECT @MYSUBSTR1 = @MYSUBSTR1  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR2) < 7001)
BEGIN
SELECT @MYSUBSTR2 = @MYSUBSTR2  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR3) < 7001)
BEGIN
SELECT @MYSUBSTR3 = @MYSUBSTR3  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR4) < 7001)
BEGIN
SELECT @MYSUBSTR4 = @MYSUBSTR4  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR5) < 7001)
BEGIN
SELECT @MYSUBSTR5 = @MYSUBSTR5  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR6) < 7001)
BEGIN
SELECT @MYSUBSTR6 = @MYSUBSTR6  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR7) < 7001)
BEGIN
SELECT @MYSUBSTR7 = @MYSUBSTR7  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR8) < 7001)
BEGIN
SELECT @MYSUBSTR8 = @MYSUBSTR8  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR9) < 7001)
BEGIN
SELECT @MYSUBSTR9 = @MYSUBSTR9  + '',
''+@MYSUBSUM+''(CASE '' + @MYSUBPIV + '' WHEN ''+CHAR(39)+@MYXCOL+CHAR(39)+'' THEN ''+@MYSUBFLD+'' ELSE ''+ @MYSUBALT+'' END) AS '' + IsNull(''_'' + REPLACE(@MYXCOL,'' '',''''),''_NULL'')
END
ELSE
If (Len(@MYSUBSTR9) >= 7000)
BEGIN
SELECT @MYSUBSTR9 = ''SELECT XTAB_ERROR__QUERY_TOO_LARGE_FOR_THIS_VERSION_OF_XTAB''
END

END
ELSE'
-- Clear all dynamic strings if more than 17544 distinct rows to pivot.



SELECT @MYSTR = @MYSTR + '
BEGIN
SELECT @MYSUBSTR1 = ''''
SELECT @MYSUBSTR2 = ''''
SELECT @MYSUBSTR3 = ''''
SELECT @MYSUBSTR4 = ''''
SELECT @MYSUBSTR5 = ''''
SELECT @MYSUBSTR6 = ''''
SELECT @MYSUBSTR7 = ''''
SELECT @MYSUBSTR8 = ''''
SELECT @MYSUBSTR9 = ''''
SELECT @MYSUBWHR2 = ''''
SELECT @MYSUBSTP = ''EXEC(| XTAB_ERROR__MORE_THAN_17544_DISTINCT_ROWS_TO_PIVOT|''
END

FETCH NEXT FROM curXTAB
INTO @MYXCOL
END

CLOSE curXTAB
DEALLOCATE curXTAB'

-- Initialise secondary FROM WHERE GROUP and ORDER BY statements.


SELECT @MYSTR = @MYSTR + '
SELECT @MYSUBEND = '' 
FROM '' + @MYSUBTBL

If Len(@MYSUBWHR2) > 0 
BEGIN 
SELECT @MYSUBEND =  @MYSUBEND + '' 
'' + @MYSUBWHR2 + '' ''
END

If Len(@MYSUBSUM) > 0 
BEGIN 
SELECT @MYSUBEND = @MYSUBEND + ''
GROUP BY '' + @MYSUBOUT
END

SELECT @MYSUBEND = @MYSUBEND + ''
ORDER BY '' + @MYSUBOUT'

-- Remove the CHAR(59) padding from second execution strings.
SELECT @MYSTR = @MYSTR + '
SELECT @MYSUBSTR1 = SUBSTRING(@MYSUBSTR1,2,8000)
SELECT @MYSUBSTR2 = SUBSTRING(@MYSUBSTR2,2,8000)
SELECT @MYSUBSTR3 = SUBSTRING(@MYSUBSTR3,2,8000)
SELECT @MYSUBSTR4 = SUBSTRING(@MYSUBSTR4,2,8000)
SELECT @MYSUBSTR5 = SUBSTRING(@MYSUBSTR5,2,8000)
SELECT @MYSUBSTR6 = SUBSTRING(@MYSUBSTR6,2,8000)
SELECT @MYSUBSTR7 = SUBSTRING(@MYSUBSTR7,2,8000)
SELECT @MYSUBSTR8 = SUBSTRING(@MYSUBSTR8,2,8000)
SELECT @MYSUBSTR9 = SUBSTRING(@MYSUBSTR9,2,8000)'

-- Secondary execution code with zero to 63000+ character tolerance.
SELECT @MYSTR = @MYSTR + '
If Len(@MYSUBSTR1) < 1
BEGIN 
EXEC(@MYSUBSTR + @MYSUBEND)
END
ELSE
If Len(@MYSUBSTR2) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBEND)
END
ELSE
If Len(@MYSUBSTR3) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBEND)
END
ELSE
If Len(@MYSUBSTR4) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBSTR3 + @MYSUBEND)
END
ELSE
If Len(@MYSUBSTR5) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBSTR3 + @MYSUBSTR4 + @MYSUBEND)
END
ELSE
If Len(@MYSUBSTR6) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBSTR3 + @MYSUBSTR4 + @MYSUBSTR5 + @MYSUBEND)
END
ELSE
If Len(@MYSUBSTR7) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBSTR3 + @MYSUBSTR4 + @MYSUBSTR5 + @MYSUBSTR6 + 

@MYSUBEND)
END
ELSE
If Len(@MYSUBSTR8) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBSTR3 + @MYSUBSTR4 + @MYSUBSTR5 + @MYSUBSTR6 + 

@MYSUBSTR7 + @MYSUBEND)
END
ELSE
If Len(@MYSUBSTR9) < 1
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBSTR3 + @MYSUBSTR4 + @MYSUBSTR5 + @MYSUBSTR6 + 

@MYSUBSTR7 + @MYSUBSTR8 + @MYSUBEND)
END
ELSE
BEGIN
EXEC(@MYSUBSTR + @MYSUBSTR1 + @MYSUBSTR2 + @MYSUBSTR3 + @MYSUBSTR4 + @MYSUBSTR5 + @MYSUBSTR6 + 

@MYSUBSTR7 + @MYSUBSTR8 + @MYSUBSTR9 + @MYSUBEND)
END'



-- Initialise secondary (optional) output statement.
SELECT @MYSTR = @MYSTR + '
If Len(@MYSUBSTP) > 2 
BEGIN 
SELECT @MYSUBSTP = REPLACE(@MYSUBSTP,'''+CHAR(124)+''','''+CHAR(39)+CHAR(39)+''')
EXEC(@MYSUBSTP) 
END'

Print @Mystr

EXEC(@MYSTR)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ZeroBrokerageClients
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_ZeroBrokerageClients    Script Date: Aug 16 2005 13:31:46 ******/

/*  
 exec sp_ZeroBrokerageClients '4 May 2005'  
 exec sp_ZeroBrokerageClients '9 Jun 2005', '100'  
*/  
  
CREATE     Procedure sp_ZeroBrokerageClients  
(  
  @dtDate varchar(35),  
  @top varchar(3)='50'  
)  
AS  
BEGIN  
  
Declare @Query Varchar(7000)
  
Set @Query = ' SELECT TOP ' + @top + ' ' +
  '[Party Code] = Party_code, ' +
  '[Party Name] = IsNull(Party_Name,''--''), ' +
  '[Branch] = IsNull((Select tradername from risk.dbo.Branch Where sbtag = branch_cd),''--''), ' +  
  '[BSE Brok] = IsNull(SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END),0), ' +  
  '[NSE Brok] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END),0), ' +  
  '[FO Brok] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPB+DPB+TSB+DSB ELSE 0 END),0), ' +  
  '[Total Brok] = IsNull(SUM(TPB+DPB+TSB+DSB),0), ' +  
  '[Avg Daily TO] = IsNull(SUM(TPA+DPA+TSA+DSA)/10000000,0), ' +  
  '[Net Brok Yield %] = IsNull(SUM(TPB+DPB+TSB+DSB)/ SUM(CASE WHEN TPA+DPA+TSA+DSA=0 THEN 1 ELSE TPA+DPA+TSA+DSA END)*100,0), ' +  
  '[BSE Daily TO] = IsNull(SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPA+DPA+TSA+DSA ELSE 0 END)/10000000,0), ' +  
  '[BSE Brok %] = IsNull((SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END)/(SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPA+DPA+TSA+DSA ELSE 1 END)))*100,0), ' +  
  '[NSE Daily TO] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPA+DPA+TSA+DSA ELSE 0 END)/10000000,0), ' +  
  '[NSE Brok %] = IsNull((SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END)/(SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPA+DPA+TSA+DSA ELSE 1 END)))*100,0), ' +  
  '[FO Daily TO] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPA+DPA+TSA+DSA ELSE 0 END)/10000000,0), ' +  
  '[FO Brok %] = IsNull((SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPB+DPB+TSB+DSB ELSE 0 END)/(SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPA+DPA+TSA+DSA ELSE 1 END)))*100,0) ' +  
 'FROM ' +  
  'Level1mis L1 ' +  
 'WHERE ' +  
/*  'Sauda_Date = Cast( ''' + @dtDate + ' 23:59:00 '' As datetime) ' +*/

		'sauda_date = ''' + @dtDate + ' 23:59:00'' ' + 

 'GROUP BY ' +  
  'Party_code, Party_Name, Branch_cd ' +  
 'HAVING ' +  
  'SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN (TPB+DPB+TSB+DSB) ELSE 0 END) = 0 OR  ' +  
  'SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN (TPB+DPB+TSB+DSB) ELSE 0 END) = 0 OR ' +  
  'SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN (TPB+DPB+TSB+DSB) ELSE 0 END) = 0 ' +  
 'ORDER BY ' +  
  'SUM(DPB+TPB+DSB+TSB) '  
  
 EXEC(@Query)  
 print(@Query)  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ZeroBrokerageClients_Range
-- --------------------------------------------------

CREATE  Procedure sp_ZeroBrokerageClients_Range
(  
  @dtDate varchar(35),  
  @dtToDate varchar(35),  
  @top varchar(3)='50'  
)  
AS  
BEGIN  
  
Declare @Query Varchar(7000)
  
Set @Query = ' SELECT TOP ' + @top + ' ' +
  '[Party Code] = Party_code, ' +
  '[Party Name] = IsNull(Party_Name,''--''), ' +
  '[Branch] = IsNull((Select tradername from risk.dbo.Branch Where sbtag = branch_cd),''--''), ' +  
  '[BSE Brok] = IsNull(SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END),0), ' +  
  '[NSE Brok] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END),0), ' +  
  '[FO Brok] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPB+DPB+TSB+DSB ELSE 0 END),0), ' +  
  '[Total Brok] = IsNull(SUM(TPB+DPB+TSB+DSB),0), ' +  
  '[Avg Daily TO] = IsNull(SUM(TPA+DPA+TSA+DSA)/10000000,0), ' +  
  '[Net Brok Yield %] = IsNull(SUM(TPB+DPB+TSB+DSB)/ SUM(CASE WHEN TPA+DPA+TSA+DSA=0 THEN 1 ELSE TPA+DPA+TSA+DSA END)*100,0), ' +  
  '[BSE Daily TO] = IsNull(SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPA+DPA+TSA+DSA ELSE 0 END)/10000000,0), ' +  
  '[BSE Brok %] = IsNull((SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END)/(SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN TPA+DPA+TSA+DSA ELSE 1 END)))*100,0), ' +  
  '[NSE Daily TO] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPA+DPA+TSA+DSA ELSE 0 END)/10000000,0), ' +  
  '[NSE Brok %] = IsNull((SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPB+DPB+TSB+DSB ELSE 0 END)/(SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN TPA+DPA+TSA+DSA ELSE 1 END)))*100,0), ' +  
  '[FO Daily TO] = IsNull(SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPA+DPA+TSA+DSA ELSE 0 END)/10000000,0), ' +  
  '[FO Brok %] = IsNull((SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPB+DPB+TSB+DSB ELSE 0 END)/(SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN TPA+DPA+TSA+DSA ELSE 1 END)))*100,0) ' +  
 'FROM ' +  
  'Level1mis L1 ' +  
 'WHERE ' +  
/*  'Sauda_Date = Cast( ''' + @dtDate + ' 23:59:00 '' As datetime) ' +*/

		'sauda_date >= ''' + @dtDate + ' 00:00:00'' and ' + 
		'sauda_date <= ''' + @dtToDate + ' 23:59:59'' ' + 

 'GROUP BY ' +  
  'Party_code, Party_Name, Branch_cd ' +  
 'HAVING ' +  
  'SUM(CASE WHEN ExchangeSegment=''BSECM'' THEN (TPB+DPB+TSB+DSB) ELSE 0 END) = 0 OR  ' +  
  'SUM(CASE WHEN ExchangeSegment=''NSECM'' THEN (TPB+DPB+TSB+DSB) ELSE 0 END) = 0 OR ' +  
  'SUM(CASE WHEN ExchangeSegment=''NSEFO'' THEN (TPB+DPB+TSB+DSB) ELSE 0 END) = 0 ' +  
 'ORDER BY ' +  
  'SUM(DPB+TPB+DSB+TSB) '  
  
 EXEC(@Query)  
 print(@Query)  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ZeroBrokerageClients_Range_Dates
-- --------------------------------------------------
CREATE 
proc

	sp_ZeroBrokerageClients_Range_Dates (
		@dtFromDate varchar(11),
		@dtToDate varchar(11),
		@strPartyCode varchar(10),
		@strExchSeg varchar(10)
	)

as 

declare
	@strSQL varchar(5000)

set @dtFromDate = upper(ltrim(rtrim(@dtFromDate)))
set @dtToDate = upper(ltrim(rtrim(@dtToDate)))
set @strPartyCode = upper(ltrim(rtrim(@strPartyCode)))
set @strExchSeg = upper(ltrim(rtrim(@strExchSeg)))

set @strSQL = ''

set @strSQL = @strSQL + 'select '
set @strSQL = @strSQL + '	[Sauda Date] = left(convert(varchar, sauda_date, 109), 11) '

if @strExchSeg = 'BSECM'
begin
	set @strSQL = @strSQL + ', '
	set @strSQL = @strSQL + '	[BSE Brok] = isnull(sum(case when exchangesegment=''BSECM'' then tpb+dpb+tsb+dsb else 0 end),0) '
end

if @strExchSeg = 'NSECM'
begin
	set @strSQL = @strSQL + ', '
	set @strSQL = @strSQL + '	[NSE Brok] = isnull(sum(case when exchangesegment=''NSECM'' then tpb+dpb+tsb+dsb else 0 end),0) '
end

if @strExchSeg = 'NSEFO'
begin
	set @strSQL = @strSQL + ', '
	set @strSQL = @strSQL + '	[FO Brok] = isnull(sum(case when exchangesegment=''NSEFO'' then tpb+dpb+tsb+dsb else 0 end),0) '
end

/*
set @strSQL = @strSQL + ', '
set @strSQL = @strSQL + '	[Total Brok] = isnull(sum(tpb+dpb+tsb+dsb),0), [avg daily to] = isnull(sum(tpa+dpa+tsa+dsa)/10000000,0), '
set @strSQL = @strSQL + '	[Net Brok Yield %] = isnull(sum(tpb+dpb+tsb+dsb)/ sum(case when tpa+dpa+tsa+dsa=0 then 1 else tpa+dpa+tsa+dsa end)*100,0) '
*/

if @strExchSeg = 'BSECM'
begin
	set @strSQL = @strSQL + ', '
	set @strSQL = @strSQL + '	[BSE Daily TO] = isnull(sum(case when exchangesegment=''BSECM'' then tpa+dpa+tsa+dsa else 0 end)/10000000,0), '
	set @strSQL = @strSQL + '	[BSE Brok %] = isnull((sum(case when exchangesegment=''BSECM'' then tpb+dpb+tsb+dsb else 0 end)/(sum(case when exchangesegment=''BSECM'' then tpa+dpa+tsa+dsa else 1 end)))*100,0) '
end

if @strExchSeg = 'NSECM'
begin
	set @strSQL = @strSQL + ', '
	set @strSQL = @strSQL + '	[NSE Daily TO] = isnull(sum(case when exchangesegment=''NSECM'' then tpa+dpa+tsa+dsa else 0 end)/10000000,0), '
	set @strSQL = @strSQL + '	[NSE Brok %] = isnull((sum(case when exchangesegment=''NSECM'' then tpb+dpb+tsb+dsb else 0 end)/(sum(case when exchangesegment=''NSECM'' then tpa+dpa+tsa+dsa else 1 end)))*100,0) '
end

if @strExchSeg = 'NSEFO'
begin
	set @strSQL = @strSQL + ', '
	set @strSQL = @strSQL + '	[FO Daily TO] = isnull(sum(case when exchangesegment=''NSEFO'' then tpa+dpa+tsa+dsa else 0 end)/10000000,0), '
	set @strSQL = @strSQL + '	[FO Brok %] = isnull((sum(case when exchangesegment=''NSEFO'' then tpb+dpb+tsb+dsb else 0 end)/(sum(case when exchangesegment=''NSEFO'' then tpa+dpa+tsa+dsa else 1 end)))*100,0) '
end

set @strSQL = @strSQL + 'from '
set @strSQL = @strSQL + '	level1mis l1 '

set @strSQL = @strSQL + 'where '
set @strSQL = @strSQL + '	party_code = ''' + @strPartyCode + '''and '
set @strSQL = @strSQL + '	sauda_date >= ''' + @dtFromDate + ' 00:00:00'' and '
set @strSQL = @strSQL + '	sauda_date <= ''' + @dtToDate + ' 23:59:59'' '

set @strSQL = @strSQL + 'group by '
/*
set @strSQL = @strSQL + '	party_code, '
set @strSQL = @strSQL + '	party_name, '
*/
set @strSQL = @strSQL + '	left(convert(varchar, sauda_date, 109), 11) '

set @strSQL = @strSQL + 'having '

if @strExchSeg = 'NSECM'
begin
	set @strSQL = @strSQL + '	sum(case when exchangesegment=''NSECM'' then (tpb+dpb+tsb+dsb) else 0 end) = 0 '
end

if @strExchSeg = 'BSECM'
begin
	set @strSQL = @strSQL + '	sum(case when exchangesegment=''BSECM'' then (tpb+dpb+tsb+dsb) else 0 end) = 0 '
end

if @strExchSeg = 'NSEFO'
begin
	set @strSQL = @strSQL + '	sum(case when exchangesegment=''NSEFO'' then (tpb+dpb+tsb+dsb) else 0 end) = 0 '
end

set @strSQL = @strSQL + 'order by'
set @strSQL = @strSQL + '	sum(dpb+tpb+dsb+tsb) '

exec (@strSQL)
print (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spAvgDelivery
-- --------------------------------------------------

CREATE      PROC spAvgDelivery
	(
		@dtDate varchar(35)
	)
AS

BEGIN

	/* Query For Left Bottom Table */
	Select
		'Brokerage',
		BSECM_Brok=IsNull(Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),0),
		NSECM_Brok=IsNull(Sum(case when ExchangeSegment='NSECM'  Then TPB+DPB+TSB+DSB else 0 end),0),
		NSEFO_Brok=IsNull(Sum(case when ExchangeSegment='NSEFO'  Then TPB+DPB+TSB+DSB else 0 end),0),
		Total_Brok = IsNull(Sum(TPB+DPB+TSB+DSB),0)
	From Level1mis L1
/*	Where Sauda_Date = Cast( @dtDate + ' 23:59:00' As DateTime)*/
	where
		sauda_date  = @dtDate + ' 23:59:00'

	Select
		'Percentage',
		[BSECM_Brok %]=IsNull((Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/Sum(Case When TPB+DPB+TSB+DSB=0 Then 1 Else TPB+DPB+TSB+DSB End))*100,0),
		[NSECM_Brok %]=IsNull((Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/Sum(Case When TPB+DPB+TSB+DSB=0 Then 1 Else TPB+DPB+TSB+DSB End))*100,0),
		[NSEFO_Brok %]=IsNull((Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/Sum(Case When TPB+DPB+TSB+DSB=0 Then 1 Else TPB+DPB+TSB+DSB End))*100,0),
		Total_Brok = IsNull((Sum(TPB+DPB+TSB+DSB)/Sum(TPB+DPB+TSB+DSB))*100,0)
	From Level1mis L1
/*	Where Sauda_Date = Cast( @dtDate + ' 23:59:00' As DateTime)*/
	where
		sauda_date  = @dtDate + ' 23:59:00'
	
	Select
		'Volume',
		[BSE Daily Vol] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TP+DP+TS+DS else 0 end),0),
		[NSE Daily Vol] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TP+DP+TS+DS else 0 end),0),
		[FO Daily Vol] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TP+DP+TS+DS else 0 end),0),
		[Total Daily Vol] = IsNull(Sum(TP+DP+TS+DS),0)
	From Level1mis L1
/*	Where Sauda_Date = Cast( @dtDate + ' 23:59:00' As DateTime)*/
	where
		sauda_date  = @dtDate + ' 23:59:00'
	
	
	
	/* Query For Avg Deli Brok */

	Select ExchangeSegment,
		Brok=IsNull(Sum(DPB+DSB),0)
	From Level1mis
	--sauda_date >= 'May 01 2005 00:00:00' And Sauda_date <= 'May 4 2005 23:59:00' And
/*	sauda_date = Cast( @dtDate + ' 23:59:00' As datetime) And*/
	where
		sauda_date  = @dtDate + ' 23:59:00' and
		ExchangeSegment in ('BSECM', 'NSECM')
	group by ExchangeSegment
	
	
	/* Avg Delivery Brokerage Split Up Into ExchangeSegment*/

	Select
		ExchangeSegment,
		BUY_Brok = IsNull(Sum(DPB),0),
		SELL_Brok = IsNull(Sum(DSB),0)
	From Level1mis
	--sauda_date >= 'May 01 2005 00:00:00' And Sauda_date <= 'May 4 2005 23:59:00' And
/*	sauda_date = Cast( @dtDate + ' 23:59:00' As datetime) And*/
	where
		sauda_date  = @dtDate + ' 23:59:00' and
		ExchangeSegment in ('BSECM', 'NSECM')
	Group By ExchangeSegment
	
	
	/* Query For Avg Deli Volume */

	Select ExchangeSegment,
		Volume=IsNull(Sum(DP+DS),0)
	From Level1mis
	--sauda_date >= 'May 01 2005 00:00:00' And Sauda_date <= 'May 15 2005 23:59:00' And
/*	sauda_date = Cast( @dtDate + ' 23:59:00' As datetime) And*/
	where
		sauda_date  = @dtDate + ' 23:59:00' and
		ExchangeSegment in ('BSECM', 'NSECM')
	group by ExchangeSegment

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spAvgDelivery_Range
-- --------------------------------------------------

--spAvgDelivery '12 jun 2005'

create   PROC spAvgDelivery_Range
	(
		@dtDate varchar(35),
		@dtToDate varchar(35)
	)
AS

BEGIN

	/* Query For Left Bottom Table */
	Select
		'Brokerage',
		BSECM_Brok=IsNull(Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),0),
		NSECM_Brok=IsNull(Sum(case when ExchangeSegment='NSECM'  Then TPB+DPB+TSB+DSB else 0 end),0),
		NSEFO_Brok=IsNull(Sum(case when ExchangeSegment='NSEFO'  Then TPB+DPB+TSB+DSB else 0 end),0),
		Total_Brok = IsNull(Sum(TPB+DPB+TSB+DSB),0)
	From Level1mis L1
/*	Where Sauda_Date = Cast( @dtDate + ' 23:59:00' As DateTime)*/
	where
		sauda_date >= @dtDate + ' 00:00:00' and
		sauda_date <= @dtToDate + ' 23:59:59'

	Select
		'Percentage',
		[BSECM_Brok %]=IsNull((Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/Sum(Case When TPB+DPB+TSB+DSB=0 Then 1 Else TPB+DPB+TSB+DSB End))*100,0),
		[NSECM_Brok %]=IsNull((Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/Sum(Case When TPB+DPB+TSB+DSB=0 Then 1 Else TPB+DPB+TSB+DSB End))*100,0),
		[NSEFO_Brok %]=IsNull((Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/Sum(Case When TPB+DPB+TSB+DSB=0 Then 1 Else TPB+DPB+TSB+DSB End))*100,0),
		Total_Brok = IsNull((Sum(TPB+DPB+TSB+DSB)/Sum(TPB+DPB+TSB+DSB))*100,0)
	From Level1mis L1
/*	Where Sauda_Date = Cast( @dtDate + ' 23:59:00' As DateTime)*/
	where
		sauda_date >= @dtDate + ' 00:00:00' and
		sauda_date <= @dtToDate + ' 23:59:59'
	
	Select
		'Volume',
		[BSE Daily Vol] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TP+DP+TS+DS else 0 end),0),
		[NSE Daily Vol] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TP+DP+TS+DS else 0 end),0),
		[FO Daily Vol] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TP+DP+TS+DS else 0 end),0),
		[Total Daily Vol] = IsNull(Sum(TP+DP+TS+DS),0)
	From Level1mis L1
/*	Where Sauda_Date = Cast( @dtDate + ' 23:59:00' As DateTime)*/
	where
		sauda_date >= @dtDate + ' 00:00:00' and
		sauda_date <= @dtToDate + ' 23:59:59'
	
	
	
	/* Query For Avg Deli Brok */

	Select ExchangeSegment,
		Brok=IsNull(Sum(DPB+DSB),0)
	From Level1mis
	--sauda_date >= 'May 01 2005 00:00:00' And Sauda_date <= 'May 4 2005 23:59:00' And
/*	sauda_date = Cast( @dtDate + ' 23:59:00' As datetime) And*/
	where
		sauda_date >= @dtDate + ' 00:00:00' and
		sauda_date <= @dtToDate + ' 23:59:59' and
	ExchangeSegment in ('BSECM', 'NSECM')
	group by ExchangeSegment
	
	
	/* Avg Delivery Brokerage Split Up Into ExchangeSegment*/

	Select
		ExchangeSegment,
		BUY_Brok = IsNull(Sum(DPB),0),
		SELL_Brok = IsNull(Sum(DSB),0)
	From Level1mis
	--sauda_date >= 'May 01 2005 00:00:00' And Sauda_date <= 'May 4 2005 23:59:00' And
/*	sauda_date = Cast( @dtDate + ' 23:59:00' As datetime) And*/
	where
		sauda_date >= @dtDate + ' 00:00:00' and
		sauda_date <= @dtToDate + ' 23:59:59' and
	ExchangeSegment in ('BSECM', 'NSECM')
	Group By ExchangeSegment
	
	
	/* Query For Avg Deli Volume */

	Select ExchangeSegment,
		Volume=IsNull(Sum(DP+DS),0)
	From Level1mis
	--sauda_date >= 'May 01 2005 00:00:00' And Sauda_date <= 'May 15 2005 23:59:00' And
/*	sauda_date = Cast( @dtDate + ' 23:59:00' As datetime) And*/
	where
		sauda_date >= @dtDate + ' 00:00:00' and
		sauda_date <= @dtToDate + ' 23:59:59' and
	ExchangeSegment in ('BSECM', 'NSECM')
	group by ExchangeSegment

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spBranch_Daily_Brokerage
-- --------------------------------------------------
CREATE Procedure spBranch_Daily_Brokerage(@Sauda_Date as Varchar(35))
As
Begin
Select
	Branch=upper(ltrim(rtrim(min(isnull(branch, '---')))) + '[' + ltrim(rtrim(branch_cd)) + ']'),
	BSECM_Brok=Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),
	NSECM_Brok=Sum(case when ExchangeSegment='NSECM'  Then TPB+DPB+TSB+DSB else 0 end),
	NSEFO_Brok=Sum(case when ExchangeSegment='NSEFO'  Then TPB+DPB+TSB+DSB else 0 end),
	Total_Brok = Sum(TPB+DPB+TSB+DSB),
	AVG_Daily_Vol = Sum(TP+DP+TS+DS),
	Total_Yield = Sum(TPB+DPB+TSB+DSB)/ Sum(Case When TP+DP+TS+DS=0 Then 1 Else TP+DP+TS+DS End),
	BSECM_Vol=Sum(case when ExchangeSegment='BSECM' Then TP+DP+TS+DS else 0 end),
	BSE_Yield = (Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TP+DP+TS+DS else 1 end))),
	NSECM_Vol=Sum(case when ExchangeSegment='NSECM' Then TP+DP+TS+DS else 0 end),
	NSE_Yield = (Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSECM' Then TP+DP+TS+DS else 1 end))),
	NSEFO_Vol=Sum(case when ExchangeSegment='NSEFO' Then TP+DP+TS+DS else 0 end),
	FO_Yield = (Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSEFO' Then TP+DP+TS+DS else 1 end)))
From Level1mis, Branch
Where Sauda_Date = Cast( @Sauda_Date + ' 23:59:00' As DateTime)
And branch_cd=Branch_Code
Group By Branch_cd Order By Branch_cd

End

/*
	spBranch_Daily_Brokerage '9 Jan 2004'
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spBranchBrok
-- --------------------------------------------------
CREATE     
Procedure spBranchBrok
(  
 @Sauda_Date varchar(50)
)  
  
As  

Begin  
  
/*
 Select  
  [Branch Code] = IsNull(Branch_cd, '--'),  
  [Branch] = RTrim(IsNull((Select tradername From Risk.dbo.Branch Where sbtag=branch_cd),'--')),  
  [BSE Brok] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NSE Brok] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [FO Brok] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end),0),
  [MCX Brok] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NCDEX Brok] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [Total Brok] = IsNull(Sum(TPB+DPB+TSB+DSB),0),  

  [Daily TO] = 

	IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),

	[Net Brok Yield %] =

	(
		isnull(sum(tpb+dpb+tsb+dsb), 0) /
		(
			case
				when
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				> 0
				then
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				else
				 1
				end
		)
	)
	* 100,


  [Alert] = IsNull((Case When (Select Sum([Max_Brok]) From HighLowBrokerage HB Where HB.branch_cd=L1.branch_cd)<=Sum(TPB+DPB+TSB+DSB) Then 'High' Else Null End),IsNull((Case When (Select Sum([Min_Brok]) From HighLowBrokerage HB Where HB.branch_cd=L1.branch_cd)>=Sum(TPB+DPB+TSB+DSB) Then 'Low' Else Null End),'...')), 

  [BSE Daily TO] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [BSE Brok %] = (Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [NSE Daily TO] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NSE Brok %] = (Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [FO Daily TO] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),
  [FO Brok %] = (Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [MCX Daily TO] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [MCX Brok %] = (Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,  
  [NCDEX Daily TO] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NCDEX Brok %] = (Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100  
 From  
  Level1mis L1
 Where  
	Sauda_Date  = @Sauda_Date + ' 23:59:00'

 Group By  
  Branch_cd   
 Order By  
  Branch  */


/*

 Select  
  [Branch Code] = IsNull(Branch_cd, '--'),  
  [Branch] = RTrim(IsNull((Select tradername From Risk.dbo.Branch Where sbtag=branch_cd),'--')),  
  [BSE Brok] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NSE Brok] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [FO Brok] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end),0),
  [MCX Brok] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NCDEX Brok] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [Total Brok] = IsNull(Sum(TPB+DPB+TSB+DSB),0),  

  [Daily TO] = 

	IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),

	[Net Brok Yield %] =

	(
		isnull(sum(tpb+dpb+tsb+dsb), 0) /
		(
			case
				when
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				> 0
				then
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				else
				 1
				end
		)
	)
	* 100,


  [Alert] = IsNull((Case When (MBrok)<=Sum(TPB+DPB+TSB+DSB) Then 'High' Else Null End),IsNull((Case When (Mbrok)>=Sum(TPB+DPB+TSB+DSB) Then '-----' Else Null End),'...')), 
  [BSE Daily TO] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [BSE Brok %] = (Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [NSE Daily TO] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NSE Brok %] = (Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [FO Daily TO] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),
  [FO Brok %] = (Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [MCX Daily TO] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [MCX Brok %] = (Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,  
  [NCDEX Daily TO] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NCDEX Brok %] = (Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100  
 From  
  Level1mis L1,( Select Abranch_cd = Branch_cd,Mbrok = Max(TotalBrok) From (
                 Select  Branch_Cd,Sauda_date, TotalBrok = IsNull(Sum(TPB+DPB+TSB+DSB),0) From level1mis Where
                 Sauda_Date < @Sauda_Date + ' 23:59:00'
                 Group by Branch_Cd,Sauda_date) A
                 Group By Branch_Cd )BrokTop
 Where  
	Sauda_Date  = @Sauda_Date + ' 23:59:00'
        And L1.Branch_Cd = BrokTop.Abranch_Cd
 Group By  
  Branch_cd  ,Mbrok 
 Order By  
  Branch

*/

Exec BBGSpBranchBrok @Sauda_Date

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spBranchBrok_Range
-- --------------------------------------------------
CREATE
Procedure spBranchBrok_Range
(  
 @Sauda_Date varchar(50),
 @To_Date varchar(50)
)  

-- Modified On : 23 Jun 2005  
/*  
 EXEC spBranchBrok 'May 27 2005' -- ANK,VD High Brok
 EXEC spBranchBrok 'Dec 07 2004' -- BVI Low Brok  
*/  
  
As  

Begin  
  

 Select  
  [Branch Code] = IsNull(Branch_cd, '--'),  
  [Branch] = RTrim(IsNull((Select tradername From Risk.dbo.Branch Where sbtag=branch_cd),'--')),  
  [BSE Brok] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NSE Brok] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
/*  [FO Brok] = IsNull(Sum(case when ExchangeSegment='NSEFO' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0), */
  [FO Brok] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end),0), 
  [MCX Brok] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NCDEX Brok] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [Total Brok] = IsNull(Sum(TPB+DPB+TSB+DSB),0),  
/*  [Daily TO] = IsNull(Sum(TPA+DPA+TSA+DSA)/10000000,0),*/

  [Daily TO] = 

	IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	/* IsNull(Sum(case when ExchangeSegment='NSEFO' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) +  */
	IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) +
	IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),

/*  [Net Brok Yield %] = IsNull(Sum(TPB+DPB+TSB+DSB),0)/ Sum(Case When TPA+DPA+TSA+DSA=0 Then 1 Else TPA+DPA+TSA+DSA End)*100,*/
	[Net Brok Yield %] =

	(
		isnull(sum(tpb+dpb+tsb+dsb), 0) /
		(
			case
				when
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					/* isnull(sum(case when exchangesegment='NSEFO' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) + */
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				> 0
				then
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					/* isnull(sum(case when exchangesegment='NSEFO' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) + */
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				else
				 1
				end
		)
	)
	* 100,


/*  [Alert] = IsNull((Case When (Select Sum([Max_Brok]) From HighLowBrokerage HB Where HB.branch_cd=L1.branch_cd)<=Sum(TPB+DPB+TSB+DSB) Then 'High' Else Null End),IsNull((Case When (Select Sum([Min_Brok]) From HighLowBrokerage HB Where HB.branch_cd=L1.bra

nch_cd)>=Sum(TPB+DPB+TSB+DSB) Then 'Low' Else Null End),'...')),*/

  [BSE Daily TO] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [BSE Brok %] = (Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [NSE Daily TO] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NSE Brok %] = (Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
/*  [FO Daily TO] = IsNull(Sum(case when ExchangeSegment='NSEFO' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0), */
  [FO Daily TO] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0), 
/*  [FO Brok %] = (Sum(case when ExchangeSegment='NSEFO' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 1 end)))*100,  */
  [FO Brok %] = (Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 1 end)))*100, 
  [MCX Daily TO] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [MCX Brok %] = (Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,  
  [NCDEX Daily TO] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NCDEX Brok %] = (Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100  
 From  
  Level1mis L1
 Where  
/*
  Sauda_Date = Cast( @Sauda_Date + ' 23:59:00' As datetime)  
*/
	Sauda_Date >= @Sauda_Date + ' 00:00:00' and
	Sauda_Date <= @To_Date + ' 23:59:59'
 Group By  
  Branch_cd   
 Order By  
  Branch
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spHoldingRecoSecurityRegisterVsExNext
-- --------------------------------------------------

CREATE proc spHoldingRecoSecurityRegisterVsExNext (@Exchange as Varchar(3),@PartyCode as Varchar(8))    
as    
set nocount on    
    
/* Exec spHoldingRecoSecurityRegisterVsExNext 'NSE','G277' */    
     
if @Exchange = 'BSE'    
begin    
    
 Select Scrip_Cd,Balance into #BSEHoldingSecRegister    
 from BSESecurityRegister N where Party_Code = @PartyCode    
 and Id1 in (Select max(id1) from BSESecurityRegister     
 where Party_Code = @PartyCode and Scrip_cd=N.Scrip_cd) and Balance > 0    
 order by Scrip_cd    
    
 Select Scrip_Cd,Sum(Qty) as Qty into #BSEHoldingBackOff from Deltrans_Report     
  where DrCr = 'D' and Delivered = '0' and Filler2 = '1' and Party_Code = @PartyCode    
  and CertNo <> 'Auction' group by Scrip_Cd    
    
 Select Scrip_cd into #BSEALLScrip from #BSEHoldingSecRegister    
 union     
 Select Scrip_cd from #BSEHoldingBackOff    
    
 Select @PartyCode as 'PartyCode',A.Scrip_Cd as 'ScripCode',IsNull(Balance,0) as 'HoldingSecRegister',    
 IsNull(Qty,0)  as 'HoldingBackOffice'    
 ,IsNull(Balance,0)-IsNull(Qty,0) as 'Difference' from #BSEALLScrip A    
 left outer join #BSEHoldingBackOff HBO on A.Scrip_Cd= HBO.Scrip_cd    
 left outer join #BSEHoldingSecRegister HSR on A.Scrip_Cd= HSR.Scrip_cd    
    
end    
if @Exchange = 'NSE'    
begin    
 Select Scrip_Cd,Balance into #NSEHoldingSecRegister     
 from NSESecurityRegister N where Party_Code = @PartyCode    
 and Id1 in (Select max(id1) from NSESecurityRegister     
 where Party_Code = @PartyCode and Scrip_cd=N.Scrip_cd) and Balance > 0    
 order by Scrip_cd    
    
 Select Scrip_Cd,Sum(Qty) as Qty into #NSEHoldingBackOff     
 from MSAJAG.dbo.Deltrans_Report     
  where DrCr = 'D' and Delivered = '0' and Filler2 = '1' and Party_Code = @PartyCode    
  and CertNo <> 'Auction' group by Scrip_Cd    
    
 Select Scrip_cd into #NSEALLScrip from #NSEHoldingSecRegister    
 union     
 Select Scrip_cd from #NSEHoldingBackOff    
    
 Select A.Scrip_Cd as 'ScripCode',IsNull(Balance,0) as 'HoldingSecRegister',    
 IsNull(Qty,0)  as 'HoldingBackOffice'    
 ,IsNull(Balance,0)-IsNull(Qty,0) as 'Difference' from #NSEALLScrip A    
 left outer join #NSEHoldingBackOff HBO on A.Scrip_Cd= HBO.Scrip_cd    
 left outer join #NSEHoldingSecRegister HSR on A.Scrip_Cd= HSR.Scrip_cd    
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spPivot
-- --------------------------------------------------
--DROP PROCEDURE SPPIVOT
/********************************************************************************/
/* spPivot                                                                      */
/********************************************************************************/
/*                                                                              */
/* Version: Version 1.2 - operates under SQL Server 6.5 and later.              */
/*                        Operates under Microsoft Data Engine 7.0 and later    */
/*                                                                              */
/* Author: Benjamin S Taylor                                                    */
/*         Premier Solutions, Inc.                                              */
/*         (317) 630-3140, Ext. 256                                             */
/*                                                                              */
/* Date:   7/25/2000                                                            */
/*                                                                              */
/* Desc:   Procedure that will take a table and produce a pivot based upon user */
/*         provided parameters. Procedure will return a recordset or create a   */
/*         pivot table and view that will produce a recordset.                  */
/*                                                                              */
/* Disclaimer: No warranty or implied obligation is made as to the accuracy or  */
/*             appropriateness of this procedure for any application. In short  */
/*             feel free to use it at your own risk...                          */
/*                                                                              */
/********************************************************************************/

CREATE PROCEDURE spPivot(
	@TableName 		VarChar(50)  = '',
	@RowColList 		VarChar(255) = '',
	@HeadCol 		VarChar(50)  = '',
	@HeadColList		VarChar(2000) = '',
	@ValueCol 		VarChar(50)  = '',
	@AggFun			VarChar(20)  = '',
	@Where			VarChar(255) = '',
	@MakeViewName		VarChar(128) = '',
	@Debug 			CHAR(1)      = 'N')
AS

	DECLARE @SQL 		VARCHAR(8000),
		@SetColSQL	VARCHAR(2000),
		@ColumnHead	VarChar(50),
		@ValColType	Int,
		@SPID		Int,
		@ViewPivot	VarChar(128),
		@KeyText VarChar(50)

	SET NOCOUNT ON

	IF 
		@TableName = '' OR 
		@RowColList = '' OR
		@HeadCol = '' OR
		@ValueCol = '' OR
		@AggFun = ''
	BEGIN
		PRINT '********************************************************************************'
		PRINT '* Procedure spPivot                                                            *'
		PRINT '********************************************************************************'
		PRINT ''
		PRINT 'Parameters:'
		PRINT ''
		PRINT '@TableName   = Name Of Table Which Provides Data For The Pivot'
		PRINT ''
		PRINT '@RowColList  = List of Column Names To Be Displayed On Each Row, Ang Grouped By'
		PRINT '               (Comma Separated Values ex."Table_ID, Table_Desc")'
		PRINT ''
		PRINT '@HeadCol     = Name Of Column To Use To Determine Virtual Column Headings'
		PRINT ''
		PRINT '@HeadColList = List Of Column Headings To Include (Do Not Search Table For Values)'
		PRINT '               (Comma Separated Values ex."Pending,Open,Closed")'
		PRINT ''
		PRINT '@ValueCol    = Name Of Column To Use To Display The Data Value For Each Virtual Column'
		PRINT ''
		PRINT '@AggFun      = Aggregate Function To Apply To Value Column For Summarization'
		PRINT ''
		PRINT '@Where       = VALID SQL Where Clause To Restrict Rows To Be Processed'
		PRINT ''
		PRINT '@MakeViewName  Name To Save Pivot Table Query To As A New View'
		PRINT '' 
		PRINT '@Debug       = Show Command or Run Query ("N" = Run Query (Default), "Y" = Show Command)'
		RETURN
	END

	SET ANSI_WARNINGS OFF

	-- Determine the data type of the column for the values list
	SELECT @ValColType = sc.xType 
	FROM 	SYSColumns sc
	JOIN	SYSObjects so	ON 	sc.ID = so.ID
	WHERE	so.Name = @TableName
	AND	sc.Name = @ValueCol

	-- If the data type is a BLOB (text, image, etc) or timestamp then can't work
	IF @ValColType IN (34, 35, 36, 104, 99, 189) 
	BEGIN
		RaisError ('This column can not be used for an aggregate value...wrong data type',9,9)
		RETURN
	END
	
	-- Can't sum or Average on Text or Date Data Types
	IF @ValColType IN (175, 61, 239, 231, 58, 165, 167) AND @AggFun IN ('SUM', 'AVG') 
	BEGIN
		RaisError ('Your Aggregate Function Is Only Allowed With A Numeric Data Type',9,9)
		RETURN
	END

	
	-- Create And Run SQL Command(s) That Will Add The Appropriate Pivot Values To PivotTable
	CREATE TABLE #PivotTable (KeyText Varchar(255) NOT NULL)

	CREATE TABLE #RowCount (KeyText Varchar(255) NOT NULL)

	IF @HeadColList	= '' -- User Did Not Pass Required Column Headings List
	BEGIN
		-- Determine Column Headings By A Distinct List Of Values In The Desired Table/Column


		SET @SQL = 'SET NOCOUNT ON' + CHAR(13)
		SELECT  @SQL = @SQL + 'INSERT INTO ' + Name  +
			' (KeyText) SELECT DISTINCT ' + 
			@HeadCol + ' FROM ' + @TableName + 
			CASE WHEN ISNULL(@Where, '') <> '' THEN ' WHERE ' + @Where ELSE '' END + 
			' ORDER BY ' + @HeadCol
			FROM tempdb..sysObjects
			WHERE ID = OBJECT_ID('tempdb..#RowCount')
		EXEC(@SQL)

		DECLARE ctemp CURSOR FOR 
			SELECT KeyText
			FROM #RowCount

		OPEN cTemp

		FETCH Next from cTemp INTO @KeyText

		WHILE @@Fetch_Status = 0
		BEGIN
			SELECT @SQL = 'ALTER TABLE ' + NAME + ' ADD [' + @KeyText + '] Int Null DEFAULT 0'
				FROM tempdb..sysObjects
				WHERE ID = OBJECT_ID('tempdb..#PivotTable')
			EXEC (@SQL)
			FETCH Next from cTemp INTO @KeyText
		END

		CLOSE cTemp
		DEALLOCATE cTemp


	END
	ELSE	-- User Assigned Required Column Headings (will filter out unwanted columns that would 
		-- be in a distinct list as well as add columns not found in the distinct list)
	BEGIN
		WHILE CHARINDEX(',', @HeadColList) > 0

		BEGIN
			SET @KeyText = SUBSTRING(@HeadColList, 1, CHARINDEX(',', @HeadColList) - 1)
			SET @HeadColList = SUBSTRING(@HeadColList, CHARINDEX(',', @HeadColList) + 1, 2000)

			SELECT @SQL = 'ALTER TABLE ' + Name + ' ADD [' + @KeyText + '] Int Null DEFAULT 0'
				FROM tempdb..sysObjects
				WHERE ID = OBJECT_ID('tempdb..#PivotTable')
			EXEC (@SQL)

			INSERT INTO #RowCount VALUES (@KeyText)
			IF CHARINDEX(',', @HeadColList) = 0
			BEGIN
				SELECT @SQL = 'ALTER TABLE ' + Name + ' ADD [' + @HeadColList + '] Int Null DEFAULT 0'
					FROM tempdb..sysObjects
					WHERE ID = OBJECT_ID('tempdb..#PivotTable')
				EXEC (@SQL)
				
				INSERT INTO #RowCount VALUES (@HeadColList)

			END
		END


	END

	INSERT INTO #PivotTable (KeyText) SELECT KeyText FROM #RowCount

	DROP TABLE #RowCount

	IF @Debug = 'P' 
		SELECT * FROM #PivotTable

	-- Build Select Query Based Upon The Values Of PivotTable

	-- Start with the row heading values (values that will appear on each line 
	-- and be used to group each line with the aggregate results)
	SET @SQL =    'SELECT ' + @RowColList + ', ' 

	-- Create a Cursor to Create Each New Column For Every Distinct Value Found 
	-- that now becomes a column heading

	DECLARE cl CURSOR FOR SELECT KeyText FROM #PivotTable
	-- a virtual column for each possible result

	OPEN cl

	FETCH NEXT FROM cl INTO @KeyText -- Get the First Record

	WHILE @@Fetch_Status = 0	-- We have a row to process
	BEGIN

		-- Update the column Value From 0 To 1
		SELECT @SetColSQL = 'UPDATE ' + NAME + ' SET [' + @KeyText + 
			'] = 1 WHERE KeyText = "' + @KeyText + '"'
			FROM tempdb..sysObjects
			WHERE ID = OBJECT_ID('tempdb..#PivotTable')

		EXEC (@SetColSQL)

		-- Build Virtual Column Syntax for This Column
		SET @SQL = -- Add to the current string the next virtual column syntax
			@SQL + CHAR(13) + '"' + @KeyText + '" = ' + 
			CASE WHEN @AggFun = 'Count' THEN						-- If the Aggregate Function is Count Then 
				'SUM(pt.[' + @KeyText + ']),'						-- Just Sum Column Counts Where PivotTable Joins @TableName
			ELSE 
				@AggFun + '(' +
				CASE WHEN @ValColType IN (175, 161, 61, 239, 231, 58, 165, 167) THEN 	-- If Date or String Data Type 
					'SUBSTRING(' + 							-- Add Substring Function
					CASE WHEN @ValColType IN (61, 58) THEN 				-- If Date Data Type
						'CONVERT(VarChar(10),' + @ValueCol + ',101)' 		-- Convert Date To String
					ELSE
						@ValueCol						-- Accept String Data Type As Is
					END +
					',1, 255 * pt.[' + @KeyText  + '])),'				-- Use Substring To Include Or Exclude Based Upon 0 or 1 * Column Length
				ELSE
					@ValueCol + ' * pt.[' + @KeyText + ']),' END 			-- Otherwise is Numeric...no formatting or substring required
		END

		FETCH NEXT FROM cl INTO @KeyText -- Get The Next Virtual Column Definition
	END

	CLOSE cl -- Done Building the SQL Command so close the cursor to PivotTable

	DEALLOCATE cl -- Reclaim memory from the cursor


	-- Create Permanant Table If @MakeViewName
	IF @MakeViewName <> ''

	BEGIN

		SET @ViewPivot = 'PIVOT_' + @MakeViewName

		--IF THE View Already Exists For This View Then Prompt User 
		IF ISNULL(OBJECT_ID(@ViewPivot),0) <> 0
		BEGIN
			PRINT 'PIVOT TABLE ALREADY EXISTS...MAKING QUERY VIEW WITH EXISTING VALUES'
			PRINT ''

		END
		ELSE
		BEGIN

			SELECT @SetColSQL = 	'SELECT * INTO PIVOT_' + @MakeViewName + ' FROM ' + name 
					FROM tempdb..sysObjects
					WHERE ID =  OBJECT_ID('tempdb..#PivotTable') 
	
			IF @Debug <> 'N'
				PRINT @SetColSQL
			ELSE
				EXEC(@SetColSQL)
		END

		-- Now that I have the string built Add Create View Text, remove the final comma, and add the group by clause

		IF ISNULL(OBJECT_ID(@MakeViewName),0) = 0
		BEGIN
			SET @SQL = 'CREATE VIEW ' + @MakeViewName + ' AS ' + 
				CHAR(13) + SUBSTRING(@SQL, 1, DATALENGTH(@SQL) - 1) + CHAR(13)+
				'FROM ' + @TableName + ' t ' + CHAR(13) + 'JOIN PIVOT_' + @MakeViewName + ' pt ON t.' + @HeadCol + 		
				' = pt.KeyText ' + CHAR(13) +
				CASE WHEN ISNULL(@WHERE, '') <> '' THEN ' WHERE ' + @WHERE + CHAR(13) ELSE '' END +
				'GROUP BY ' + @RowColList
		END
		ELSE
		BEGIN
			SET @SQL = 'ALTER VIEW ' + @MakeViewName + ' AS ' + 
				CHAR(13) + SUBSTRING(@SQL, 1, DATALENGTH(@SQL) - 1) + CHAR(13)+
				'FROM ' + @TableName + ' t ' + CHAR(13) + 'JOIN PIVOT_' + @MakeViewName + ' pt ON t.' + @HeadCol + 		
				' = pt.KeyText ' + CHAR(13) +
				CASE WHEN ISNULL(@WHERE, '') <> '' THEN ' WHERE ' + @WHERE + CHAR(13) ELSE '' END +
				'GROUP BY ' + @RowColList
		END
		IF @DEBUG <> 'N'
		BEGIN
			PRINT @SQL
		END
		ELSE
		BEGIN
			EXEC(@SQL)
			PRINT 'View ' + @MakeViewName + ' Created Successfully...'
		END
	END
	ELSE
	BEGIN
		SET @SQL = SUBSTRING(@SQL, 1, DATALENGTH(@SQL) - 1) + CHAR(13)+
		      'FROM ' + @TableName + ' t ' + CHAR(13) + 'JOIN #PivotTable pt ON t.' + @HeadCol + 
		      ' = pt.KeyText ' + CHAR(13) +
		      CASE WHEN ISNULL(@WHERE, '') <> '' THEN ' WHERE ' + @WHERE + CHAR(13) ELSE '' END +
		      'GROUP BY ' + @RowColList
	
		IF @Debug <> 'N'	-- If @Debug parameter is anything other than 'N' then print the SQL created
			PRINT @SQL
		ELSE			-- Otherwise, execute the SQL created
			EXEC(@SQL)
	END

	SET ANSI_WARNINGS ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spPivot_Table
-- --------------------------------------------------
CREATE PROCEDURE spPivot_Table
@cTable varchar(80),
@cDown varchar(80),
@cAcross varchar(80),
@cFunc varchar(80),
@cAggFld varchar(80),
@cWhere varchar(200)
As

Declare @cColTtl varchar(80),
@cSQLStr varchar(200),
@cSQL varchar(8000),
@nRows Int,
@nCntr Int

-- Generate Pivot Key Table
Set @cSQL = 'Select Distinct '+@cAcross+' as Pivot_Value Into TempUniq From '+@cTable+' Where '+@cWHere+' Order By 1 '

--Print (@CSQL)
Exec(@cSQL)

Select IDENTITY(int, 1,1) as Pivot_Row,@cFunc as Pivot_Func, @cAggFld as Pivot_AggFld,@cAcross as Pivot_Fld,@cColTtl as Pivot_Col,Pivot_Value,@cSQLStr as Pivot_SQL Into TempPivot From TempUniq Order By Pivot_Value


Update TempPivot Set Pivot_Col = Replace(RTrim(LTrim(Convert(varchar(80),Pivot_Value))),' ','_')

-- Build and Execute Pivot SQL
Update TempPivot Set Pivot_SQL=LTrim(RTrim(Pivot_Col))+'='+Pivot_Func+'(case when '+Pivot_Fld+'=Pivot_Value and Pivot_Col='''+Pivot_Col+''' Then '+Pivot_AggFld+' else Null end)'

Select @nRows=Max(Pivot_Row),@nCntr=Min(Pivot_Row) From TempPivot
Set @cSQL=''
While @nCntr <= @nRows
Begin
   Select @cSQL=@cSQL+','+Pivot_SQL From TempPivot Where Pivot_Row=@nCntr
   Set @nCntr=@nCntr+1
End

Set @cSQL='Select '+@cDown+','+Substring(@cSQL,2,8000)+' From '+@cTable+' Join TempPivot on('+@cAcross+'=Pivot_Value) Where '+@cWhere+' Group By '+@cDown+' Order By '+@cDown
--Print (@cSQL)
Exec(@cSQL)

Drop Table TempUniq
Drop Table TempPivot
 

--EXAMPLES OF HOW TO USE -----   Just execuate the SP within SQL Query Analyzer  These samples use the the Northwind DB  -  

-- Capabilities
-- Any Combination to "Down" or By Field -- s
-- Functions Available: Sum, Avg, Min, M -- ax, Count, STD, ...
-- Across may be an expression Substring -- (ShipCountry,1,1) = Across A,B,C,D,...-- r> 
/*

	Exec spPivot_Table 'level5mis', 'branch_cd','ExchangeSegment','Sum','tradingpurqty','year=2005'

*/
/*

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spSR
-- --------------------------------------------------

CREATE Proc spSR          
as          
set nocount on          
/* Exec spSR         
Select distinct Party_Code into #PartyCodes from BSEDB.dbo.DELTRANS_REPORT            
union          
Select distinct party_code from BSEDB.dbo.DeliveryClt_REPORT          
*/          
--Select * from #PartyCodes order by Party_Code          
Select party into #PartyCodes from SR_PartyCodes where Party not in ('Broker','EXE','BSE','V008','SSSS','EEEE')        
and Party > (Select max(Party_Code) from BSESecurityRegister nolock)    

        
DECLARE @Party varchar(10)          
DECLARE Party_Cursor CURSOR FOR           
Select * from #PartyCodes order by Party      
OPEN Party_Cursor          
          
FETCH NEXT FROM Party_Cursor          
INTO @Party          
          
WHILE @@FETCH_STATUS = 0          
BEGIN          
   Exec spDeepak_SecurityRegisterBSE @Party          
          
   FETCH NEXT FROM Party_Cursor           
   INTO @Party          
END          
          
CLOSE Party_Cursor          
DEALLOCATE Party_Cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spUpdateDeltrans
-- --------------------------------------------------

Create proc spUpdateDeltrans
as
set nocount on

set transaction isolation level read uncommitted

--Truncate table Deltrans

SET IDENTITY_INSERT Deltrans ON;

Insert into Deltrans (Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,scrip_cd,series,Qty,FromNo,ToNo,CertNo,FolioNo,HolderName,Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,TransDate,Filler1,Filler2,Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5)
Select Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,scrip_cd,series,Qty,FromNo,ToNo,CertNo,FolioNo,HolderName,Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,TransDate,Filler1,Filler2,Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5 from AngelDemat.BSEDB.dbo.Deltrans

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spUpdateOpening_n_Ignore
-- --------------------------------------------------

Create proc spUpdateOpening_n_Ignore
as
set nocount on 

-- *Truncate Table BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference_IgnoredParties

Insert into BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference_IgnoredParties
Select distinct party_code 
from BSE_HoldingReco_SecurityRegisterVsExNext
where Difference <> 0

--Truncate Table BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference

Insert into BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference
Select *  from BSESecurityRegister 

Delete From BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference
where Date_RecDel < '20061001' 

Delete From BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference
where Date_RecDel > '20061231' 

--*Drop Table #OpeningBal

Select Party_Code,Scrip_Cd,Sum(BuyQty)-Sum(QtyDelivered) as OpeningBalance 
into #OpeningBal
from BSESecurityRegister 
where Date_RecDel <= '20060930'
group by Party_Code,Scrip_Cd
having Sum(BuyQty)-Sum(QtyDelivered) <> 0
order by Party_Code

--Truncate Table BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference_WithDifference

Insert into BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference_WithDifference
Select * 
from BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference
where party_code in
(
Select distinct party_code 
from BSE_HoldingReco_SecurityRegisterVsExNext
where Difference <> 0
)


Delete from BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference
where party_code in
(
Select distinct party_code 
from BSE_HoldingReco_SecurityRegisterVsExNext
where Difference <> 0
)

Delete from BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference where Sett_No = 'OpenBal'

Insert into BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference
--Select Top 10 * from BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference
Select 0,Party_Code,Scrip_Cd,'20061001','OpenBal','','Opening Balance',OpeningBalance,0,OpeningBalance,'' from #OpeningBal


Select * from BSESecurityRegisterWithOpeningTillDec31ExecClientwithDifference order by party_code,Scrip_Cd,id1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_ClientMapping_new
-- --------------------------------------------------

--spx_ClientMapping_new '10/04/2012','10/04/2012'

--EXEC accountopen_bse_clmapping '10/04/2012','10/04/2012'

CREATE   PROC spx_ClientMapping_new
(
@fromdate varchar(30) ,
@todate varchar(30) 
)
AS

CREATE TABLE #temp
(
rowId bigint IDENTITY(1,1),
party_code varchar(20),
activefrom	datetime,
introducer varchar(200),
firsttrading datetime,
branch_cd	varchar(100),
branch varchar(500),
sub_broker varchar(100),
sbname varchar(500),
Long_name	varchar(500),
L_address1	 varchar(1000),
L_address2	varchar(1000),
L_address3	varchar(1000),
L_City	varchar(1000),
l_zip	 varchar(200),
pan_gir_no varchar(50),
COMPDATE varchar(100),
Sub_Brker varchar(100),
Name varchar(500),
Address1 varchar(1000),
Address2	varchar(1000),
City varchar(1000),
State varchar(1000),
Nation	varchar(100),
Zip varchar(100),
Fax varchar(100),
Phone1	varchar(50),
Phone2	varchar(50),
Reg_No varchar(1000)	,
Registered varchar(50),
Main_Sub varchar(50),
Email varchar(200),
Com_Perc float,
branch_code varchar(500),
Contact_Person	varchar(500),
REMPARTYCODE varchar(200),
[status] varchar(1000),
segment varchar(100)
			
)
 
 SET @fromdate = CONVERT(datetime ,@fromdate,103 )
 SET @todate = CONVERT(datetime ,@todate,103  ) 
 PRINT @fromdate
 PRINT @todate
INSERT INTO #temp
(
party_code,
activefrom,
introducer,
firsttrading,
branch_cd,
branch,
sub_broker,
sbname,
Long_name,
L_address1,
L_address2,
L_address3,
L_City,
l_zip,
pan_gir_no,
COMPDATE,
Sub_Brker,
Name,
Address1,
Address2,
City,
State,
Nation,
Zip,
Fax,
Phone1,
Phone2,
Reg_No,
Registered,
Main_Sub,
Email,
Com_Perc,
branch_code,
Contact_Person,
REMPARTYCODE,
status,
segment
	

)
EXEC accountopen_bse_clmapping @fromdate, @todate                  --'10/04/2012','10/04/2012'
DECLARE @count int 
DECLARE @i int 
SET @i =1


SELECT @count =count(rowId)FROM #temp
CREATE table #temp1 (detail varchar(max))
WHILE @i<=@count 
BEGIN
	
	INSERT INTO #temp1
	SELECT '<table width="70%" align=center border="1"  class="TableHead5">
           <tr style="font-size:10px;"  >
			<td  align="right"><b>Subbroker Name </b>:-</td>
			<td  align="left">'+isnull(t.sbname,'')+'</td>
		    <td  align="center"><b>Contact Person </b>:-</td>
			<td  align="left">'+isnull(t.contact_person,'')+'&nbsp;</td></tr>
			
			
			<tr  style="font-size:10px;" >
			<td  align="right"><b>Address :-</b></td>
			<td  colspan="3" align="left">'+isnull(t.address1,'')+'&nbsp'+ isnull(t.address2,'') +'&nbsp'+ isnull(t.city,'')+'&nbsp'+ isnull(t.state,'') + '&nbsp'+isnull(t.zip,'')+isnull(t.fax,'')+'</td>
			</tr>
			
			
			<tr  style="font-size:10px;" >
			<td  align="right"><b>Phone no:-</b></td>
			<td  colspan="3" align="left">'+isnull(t.phone1,'')+'&nbsp'+isnull(t.phone2,'')+'&nbsp;</td></tr>

			<tr style="font-size:10px;" >
			<td  align="right"><b>E-mail:-</b></td>			
			<td  colspan="3" align="left">'+isnull(t.email,'')+'&nbsp;</td></tr>
			</tr>
			</table>
			
			<table width="70%" align="center" border="1" >

			<tr  style="font-family:tahoma;font-size:11px;font-weight:bold;" >
			<td>Party Code</td>
			<td title="Party Name">Party Name</td>
			<td>Branch</td>
			<td>Subbroker</td>
			<td>Active</td>
			<td>Completed</td>
			<td>First Trading</td>
			<td>Terminal no</td>
			<td>Introducer</td>
			</tr> 
			<tr style="font-size:11px;">
		<td align="center" style="font-family:tahoma;font-size:12px;">'+isnull(t.party_code,'')+'</a></td>		
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.long_name,'')+'</td>
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.branch_cd,'')+'</td>
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.sub_broker,'')+'</td>
	<td   style="font-family:tahoma;font-size:12px;">&nbsp;'+CONVERT(char(30),isnull(t.activefrom,'') ,103) +'</td>
	<td align="center"  style="font-family:tahoma;font-size:12px;">&nbsp;'+CONVERT(char(30),isnull(t.compdate,''),103)+'</td>
	<td align="center" style="font-family:tahoma;font-size:12px;">&nbsp;'+CONVERT(char(30),isnull(t.firsttrading,''),103) +'</td>
	<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.reg_no,'')+'</td>
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.introducer,'')+'</td></tr>
		</table><br><br>'
			
	FROM #temp t WHERE t.rowId=@i
	SET @i=@i+1
END

SELECT * FROM #temp1 t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_ClientMapping_nse_new
-- --------------------------------------------------
--spx_ClientMapping_nse_new '10/04/2012','10/04/2012'

--EXEC accountopen_bse_clmapping '10/04/2012','10/04/2012'

CREATE   PROC spx_ClientMapping_nse_new
(
@fromdate varchar(30) ,
@todate varchar(30) 
)
AS

CREATE TABLE #temp
(
rowId bigint IDENTITY(1,1),
party_code varchar(20),
activefrom	datetime,
introducer varchar(200),
firsttrading datetime,
branch_cd	varchar(100),
branch varchar(500),
sub_broker varchar(100),
sbname varchar(500),
Long_name	varchar(500),
L_address1	 varchar(1000),
L_address2	varchar(1000),
L_address3	varchar(1000),
L_City	varchar(1000),
l_zip	 varchar(200),
pan_gir_no varchar(50),
COMPDATE varchar(100),
Sub_Brker varchar(100),
Name varchar(500),
Address1 varchar(1000),
Address2	varchar(1000),
City varchar(1000),
State varchar(1000),
Nation	varchar(100),
Zip varchar(100),
Fax varchar(100),
Phone1	varchar(50),
Phone2	varchar(50),
Reg_No varchar(1000)	,
Registered varchar(50),
Main_Sub varchar(50),
Email varchar(200),
Com_Perc float,
branch_code varchar(500),
Contact_Person	varchar(500),
REMPARTYCODE varchar(200),
[status] varchar(1000),
segment varchar(100)
			
)
 
 SET @fromdate = CONVERT(datetime ,@fromdate,103 )
 SET @todate = CONVERT(datetime ,@todate,103  ) 
 PRINT @fromdate
 PRINT @todate
INSERT INTO #temp
(
party_code,
activefrom,
introducer,
firsttrading,
branch_cd,
branch,
sub_broker,
sbname,
Long_name,
L_address1,
L_address2,
L_address3,
L_City,
l_zip,
pan_gir_no,
COMPDATE,
Sub_Brker,
Name,
Address1,
Address2,
City,
State,
Nation,
Zip,
Fax,
Phone1,
Phone2,
Reg_No,
Registered,
Main_Sub,
Email,
Com_Perc,
branch_code,
Contact_Person,
REMPARTYCODE,
status,
segment
	

)
EXEC accountopen_nse_clmapping @fromdate, @todate                  --'10/04/2012','10/04/2012'
DECLARE @count int 
DECLARE @i int 
SET @i =1


SELECT @count =count(rowId)FROM #temp
CREATE table #temp1 (detail varchar(max))
WHILE @i<=@count 
BEGIN
	
	INSERT INTO #temp1
	SELECT '<table width="70%" align=center border="1"  class="TableHead5">
           <tr style="font-size:10px;"  >
			<td  align="right"><b>Subbroker Name </b>:-</td>
			<td  align="left">'+isnull(t.sbname,'')+'</td>
		    <td  align="center"><b>Contact Person </b>:-</td>
			<td  align="left">'+isnull(t.contact_person,'')+'&nbsp;</td></tr>
			
			
			<tr  style="font-size:10px;" >
			<td  align="right"><b>Address :-</b></td>
			<td  colspan="3" align="left">'+isnull(t.address1,'')+'&nbsp'+ isnull(t.address2,'') +'&nbsp'+ isnull(t.city,'')+'&nbsp'+ isnull(t.state,'') + '&nbsp'+isnull(t.zip,'')+isnull(t.fax,'')+'</td>
			</tr>
			
			
			<tr  style="font-size:10px;" >
			<td  align="right"><b>Phone no:-</b></td>
			<td  colspan="3" align="left">'+isnull(t.phone1,'')+'&nbsp'+isnull(t.phone2,'')+'&nbsp;</td></tr>

			<tr style="font-size:10px;" >
			<td  align="right"><b>E-mail:-</b></td>			
			<td  colspan="3" align="left">'+isnull(t.email,'')+'&nbsp;</td></tr>
			</tr>
			</table>
			
			<table width="70%" align="center" border="1" >

			<tr  style="font-family:tahoma;font-size:11px;font-weight:bold;" >
			<td>Party Code</td>
			<td title="Party Name">Party Name</td>
			<td>Branch</td>
			<td>Subbroker</td>
			<td>Active</td>
			<td>Completed</td>
			<td>First Trading</td>
			<td>Terminal no</td>
			<td>Introducer</td>
			</tr> 
			<tr style="font-size:11px;">
		<td align="center" style="font-family:tahoma;font-size:12px;">'+isnull(t.party_code,'')+'</a></td>		
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.long_name,'')+'</td>
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.branch_cd,'')+'</td>
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.sub_broker,'')+'</td>
	<td  style="font-family:tahoma;font-size:12px;">&nbsp;'+CONVERT(char(30),isnull(t.activefrom,'') ,103) +'</td>
	<td align="center"  style="font-family:tahoma;font-size:12px;">&nbsp;'+CONVERT(char(30),isnull(t.compdate,''),103)+'</td>
	<td align="center" style="font-family:tahoma;font-size:12px;">&nbsp;'+CONVERT(char(30),isnull(t.firsttrading,''),103) +'</td>
	<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.reg_no,'')+'</td>
		<td style="font-family:tahoma;font-size:12px;">&nbsp;'+isnull(t.introducer,'')+'</td></tr>
		</table><br><br>'
			
	FROM #temp t WHERE t.rowId=@i
	SET @i=@i+1
END

SELECT * FROM #temp1 t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPX_dmat_ablcm_new
-- --------------------------------------------------


CREATE procedure [dbo].[SPX_dmat_ablcm_new] 
(
@fdate varchar(20)
)  
as  

SET @fdate=CONVERT(datetime, @fdate,  103)

select cl_code=cl_code COLLATE Latin1_General_CI_AS,short_name=short_name COLLATE Latin1_General_CI_AS,
demat=(CASE WHEN UPPER(demat COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)   
from kyc_documents   
where cl_code COLLATE Latin1_General_CI_AS in  
(  
select distinct party_code from AngelBSECM.bsedb_ab.dbo.cmbillvalan where pqtydel>0 and sauda_date >= @fdate   
-- select distinct party_code from mis_to where branch_cd like @BRCODE and sub_broker like @SBCODE and company=@CONAME   
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPX_dmat_acdlcm_new
-- --------------------------------------------------
  
CREATE procedure [dbo].[SPX_dmat_acdlcm_new] 

(
@fdate varchar(20)
)  
as 

SET @fdate=CONVERT(datetime, @fdate, 103)
 
select cl_code=cl_code COLLATE Latin1_General_CI_AS,short_name=short_name COLLATE Latin1_General_CI_AS,
demat=(CASE WHEN UPPER(demat COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)   
from kyc_documents   
where cl_code COLLATE Latin1_General_CI_AS in  
(  
select distinct party_code from AngelNseCM.msajag.dbo.cmbillvalan where pqtydel>0 and sauda_date >= @fdate  
-- select distinct party_code from mis_to where branch_cd like @BRCODE and sub_broker like @SBCODE and company=@CONAME   
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_Edit_SubBrokerList
-- --------------------------------------------------


CREATE procedure Spx_Edit_SubBrokerList
(
@Subbroker varchar(50),
@Branch varchar(100),
@regno varchar(100),
@Regis_Date varchar(25),
@Constitution varchar(200),
@ContactPerson varchar(150),
@Email varchar(100),
@segment varchar(100)
)

AS

Declare @Count as int

select @Count=COUNT (*) from Test_tripartite_details1 where regnno=@regno and segment=@segment 

if (@Count>0)

Begin

update Test_tripartite_details1 set subbroker=@Subbroker, Branch=@Branch, regnno=@regno,
regis_date=@Regis_Date, CONSTITUTION=@Constitution, contact_person=@ContactPerson, email=@Email
where regnno=@regno and segment=@segment 

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_EditBrokerageReport
-- --------------------------------------------------
CREATE proc [dbo].[spx_EditBrokerageReport]
@partycode varchar(50)
as
select * from clientbrok_scheme where party_code=@partycode
 union  
select * from AngelNseCM.msajag.dbo.clientbrok_scheme where party_code=@partycode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_FollowUp_Branch_To_SubBroker
-- --------------------------------------------------
--spx_FollowUp_Branch_To_SubBroker '10/01/2001','25/09/2003','Borivali','S'  
CREATE procedure spx_FollowUp_Branch_To_SubBroker  
  
(  
@From_Date varchar(20),  
@To_Date varchar(20),  
@Branch varchar(50),   
@Flag varchar(2)  
)  
  
  As  
  
  SET @From_Date=CONVERT(datetime,@From_Date,103)                                    
  SET @To_Date=CONVERT(datetime,@To_Date,103) + '23:59:59:999'    
   
  if @Flag='B'  
  begin  
   
  select ROW_NUMBER()OVER(ORDER BY  BRANCH_CODE) As SrNo, BRANCH_CODE, BRANCH, Address1 from branch with(nolock)  
    
  End   
    
 if @Flag='S'  
    
  Begin  
    
  select  sub_broker,turnover=sum(turnover) from mis_to With(NoLock) where   
  branch_cd=@Branch and sauda_date>=@From_Date  
  and sauda_date <=@To_Date  
  group by sub_broker order by turnover desc  
    
  End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPX_identy_NEW
-- --------------------------------------------------

--SP_identy 'ABLCM', 'ACM', 'ACM'

 CREATE PROCEDURE SPX_identy_NEW
 (
 @Segment AS VARCHAR(25), 
 @Branch AS VARCHAR(25), 
 @SubBroker  AS VARCHAR(25)
 )    
AS    
    
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,    
CL_NAME=SHORT_NAME COLLATE Latin1_General_CI_AS,    
identitycard=(CASE WHEN UPPER(identitycard COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)     
from kyc_documents where cl_code in (select distinct party_code from mis_to where branch_cd=@Branch and sub_broker like replace(@SubBroker ,'All','%') and company=@Segment)    
UNION    
select distinct cl_code=party_code,CL_NAME=party_name,identitycard='NO'    
from mis_to where sub_broker like replace(@SubBroker ,'All','%') and branch_cd=@Branch and company=@Segment    
and sauda_Date >=getdate()-365 AND     
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )    
ORDER BY CL_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPX_KYC_NEW
-- --------------------------------------------------
 
 --SPX_KYC_NEW 'ABLCM', 'ACM', 'ACM'
 
 CREATE PROCEDURE SPX_KYC_NEW 
 (
 @Segment AS VARCHAR(25), 
 @Branch AS VARCHAR(25), 
 @SubBroker  AS VARCHAR(25)
 )    
AS    
    
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,    
CL_NAME=CL_NAME COLLATE Latin1_General_CI_AS,    
ABL=UPPER(ABL) COLLATE Latin1_General_CI_AS,    
ACDL=UPPER(ACDL) COLLATE Latin1_General_CI_AS,    
FNO=UPPER(FNO) COLLATE Latin1_General_CI_AS,    
NCDEX=UPPER(NCDEX) COLLATE Latin1_General_CI_AS,    
MCX=UPPER(MCX) COLLATE Latin1_General_CI_AS,    
ASL=UPPER(ASL) COLLATE Latin1_General_CI_AS     
from clients_accountopen where cl_code in (select distinct party_code from mis_to where branch_cd=@Branch and sub_broker like replace(@SubBroker ,'All','%') and company=@Segment)    
UNION    
select distinct cl_code=party_code,CL_NAME=party_name,ABL='NO',ACDL='NO',FNO='NO',NCDEX='NO',MCX='NO',ASL='NO'    
from mis_to where sub_broker like replace(@SubBroker ,'All','%') and branch_cd=@Branch and company=@Segment    
and sauda_Date >=getdate()-365 AND     
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPX_PAN_NEW
-- --------------------------------------------------
 
 --SPX_PAN_NEW 'ABLCM', 'ACM', 'ACM'
 
 CREATE PROCEDURE SPX_PAN_NEW 
 (
 @Segment AS VARCHAR(25), 
 @Branch AS VARCHAR(25), 
 @SubBroker  AS VARCHAR(25)
 )    
AS    
    
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,    
CL_NAME=SHORT_NAME COLLATE Latin1_General_CI_AS,    
PAN_GIR_NO=(CASE WHEN UPPER(PAN_GIR_NO COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)     
from kyc_documents where cl_code in (select distinct party_code from mis_to where branch_cd=@Branch 
and sub_broker like replace(@SubBroker ,'All','%') and company=@Segment)    
UNION    
select distinct cl_code=party_code,CL_NAME=party_name,PAN_GIR_NO='NO'    
from mis_to where sub_broker like replace(@SubBroker ,'All','%') and branch_cd=@Branch and company=@Segment    
and sauda_Date >=getdate()-365 AND     
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )    
ORDER BY CL_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPX_RESI_NEW
-- --------------------------------------------------
 
 --SPX_RESI_NEW 'ABLCM', 'ACM', 'ACM'
 
 CREATE PROCEDURE SPX_RESI_NEW 
 (
 @Segment AS VARCHAR(25), 
 @Branch AS VARCHAR(25), 
 @SubBroker  AS VARCHAR(25)
 )    
AS    
    
select CL_CODE=CL_CODE COLLATE Latin1_General_CI_AS,    
CL_NAME=SHORT_NAME COLLATE Latin1_General_CI_AS,    
resident_proof=(CASE WHEN UPPER(resident_proof COLLATE Latin1_General_CI_AS)='ON' THEN 'YES' ELSE 'NO' END)     
from kyc_documents where cl_code in (select distinct party_code from mis_to where branch_cd=@Branch and sub_broker like replace(@SubBroker ,'All','%') and company=@Segment)    
UNION    
select distinct cl_code=party_code,CL_NAME=party_name,resident_proof='NO'    
from mis_to where sub_broker like replace(@SubBroker ,'All','%') and branch_cd=@Branch and company=@Segment    
and sauda_Date >=getdate()-365 AND     
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )    
ORDER BY CL_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_SubBrokerList
-- --------------------------------------------------
  
CREATE Procedure Spx_SubBrokerList  
  
AS   
  
select ROW_NUMBER()  over (order by segment, subbroker desc ) as SrNo ,subbroker , branch , regnno , 
regis_date , CONSTITUTION, contact_person , email, segment   
 from tripartite_details order by segment, subbroker  desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPx_TRIPARTITE_New
-- --------------------------------------------------

--SPx_TRIPARTITE_New 'ABLCM', 'ACM', 'ACm'

CREATE PROCEDURE SPx_TRIPARTITE_New

(
@Segment AS VARCHAR(25), 
@Branch AS VARCHAR(25), 
@SubBroker  AS VARCHAR(25)
)    
AS    
    
select  CLCODE=cl_code COLLATE Latin1_General_CI_AS,short_name=short_name COLLATE Latin1_General_CI_AS    
,tabl=tabl COLLATE Latin1_General_CI_AS,tacdl=tacdl COLLATE Latin1_General_CI_AS    
from kyc_documents where cl_code in (select party_code from mis_to where branch_cd=@Branch and 
sub_broker like replace(@SubBroker ,'All','%') and company=@Segment)    
UNION    
select distinct cl_code=party_code,short_name=party_name,tabl='NO',TACDL='NO'     
from mis_to where sub_broker=@SubBroker  and branch_cd=@Branch and company=@Segment    
and sauda_Date >=getdate()-365 AND     
PARTY_CODE COLLATE Latin1_General_CI_AS  NOT IN (SELECT CL_CODE FROM kyc_documents )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TBBGSettBrokUpdatenew
-- --------------------------------------------------

CREATE Procedure TBBGSettBrokUpdatenew (@tparty varchar(10), @tscrip_cd varchar(12),@tdate varchar(11),@sett_type varchar(2),@Memcode varchar(15),@tmark varchar(2)) as 
Declare
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@PArticipantcode Varchar(25),
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@PartyUserid Cursor,
@@TerminalNo Varchar(20),
@@Table_no Smallint,
@@Sub_tableNo SmallInt,
@@P_To_P SmallInt,
@@Sb_TableNo SmallInt,
@@AlBmCf_Tableno Smallint,
@@Brok_Scheme Smallint,
@@GetPos AS Cursor


-- Easiest thing is to apply the brokerage from client2 to the terminal number  in Angeltermbrok table
-- This will require no change in existing masters but will require to add the 
-- Reduced slabs in Angeltermbrok  table



Set NoCount ON
-- Now Update brokerage for remaining trades
-- And Settlement.User_id <> @@TerminalNo

Select Distinct @@TerminalNo = Terminalnumber,@@Brok_Scheme=BrokScheme,@@Table_no=Table_no,@@Sub_TableNo = Sub_TableNo,@@P_To_P = P_To_P,@@Sb_TableNo = Sb_TableNo,@@AlBmCf_TableNo = AlBmCf_TableNo 
from AngelTermBrok where
Party_code = @TParty
and FromDate <= @Tdate
and ToDate >= @Tdate

Select @@sett_no = Sett_no from sett_mst where Sett_type = @Sett_type and Start_Date < @Tdate + ' 00:01:01' and End_date > @Tdate + ' 00:01:01' 

Set @@GetPos = Cursor For
select Sell_buy, 
pqty = (Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),
prate = (Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),
Sqty = (Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),
srate = (Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),
Participantcode,Tmark
from Settlement t1
Where
T1.Party_code = @Tparty
And
T1.Sett_no = @@Sett_no
And
T1.Scrip_cd = @TScrip_cd
And
T1.Tmark Like @Tmark +'%'
And
Left(Convert(varchar,T1.sauda_date,109),11) = @Tdate 
And T1.Sett_type = @Sett_type
And T1.Participantcode = @Memcode
And T1.User_id <> @@TerminalNo
Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,Left(Convert(varchar,sauda_date,109),11),Participantcode,tmark /* ,SettFlag */

Open @@GetPos
Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate,@@Participantcode,@@Tmark
    Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@Participantcode,@@Tmark 


While @@Fetch_status = 0 
Begin
/*     Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@Participantcode,@@Tmark */
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate,@@Participantcode,@@Tmark
End        
/*
Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'

If @@TPqty > @@TSqty 
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty 
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y' 
     If @@TSRate > @@TPRate 
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate 
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq
*/

Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10 
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End

Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))

/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/

Update Settlement set 
/* Select Trade_no,Tradeqty,Participantcode, */
 Tmark = Tmark,    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when settlement.status = 'N' then 0
	       else
               (  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                          ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
   Else  0 
                        End) 
                       END  ),
       NetRate = (Case
		when settlement.status = 'N' then settlement.MARKETRATE
	       else
(  case  
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( settlement.marketrate + broktable.Normal),broktable.round_to) */
                                                                 settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((settlement.marketrate - broktable.Normal ),broktable.round_to )    */
                                                                  settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (settlement.marketrate + round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)) */
                                                                   settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (settlement.marketrate - round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to))           */
                                                                   settlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* settlement.marketrate))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                                                    Then /* round((broktable.day_puc + settlement.marketrate ),broktable.round_to)*/
                                                                 settlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                                                    Then /* (settlement.marketrate + round((broktable.day_puc/100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate + ((floor(( (((broktable.day_puc/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((settlement.marketrate - broktable.day_sales),broktable.round_to)*/
                                                               settlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (settlement.marketrate - round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + settlement.marketrate ),broktable.round_to )*/
                                                                 settlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (settlement.marketrate + round(( broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to))*/
                                                                 settlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                        when ( settlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( settlement.marketrate - broktable.sett_sales ),broktable.round_to) */
                                                                   settlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (settlement.marketrate - round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)) */
                                                                 settlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End)
                    END     ),
       Amount = (Case
		when settlement.status = 'N' then settlement.MARKETRATE * settlement. TRADEQTY
	       else
(  case  
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( settlement.marketrate + broktable.Normal),broktable.round_to) */
                                                             settlement.Tradeqty  *  (  settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))

                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((settlement.marketrate - broktable.Normal ),broktable.round_to )    */
                                                                settlement.Tradeqty * (   settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (settlement.marketrate + round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)) */
                                                               settlement.Tradeqty  * (   settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (settlement.marketrate - round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to))           */
                                                                settlement.Tradeqty * (   settlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* settlement.marketrate))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                          when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                                                    Then /* round((broktable.day_puc + settlement.marketrate ),broktable.round_to)*/
                                                             settlement.Tradeqty * (    settlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                         when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                                                    Then /* (settlement.marketrate + round((broktable.day_puc/100) * settlement.marketrate ,broktable.round_to))*/
                                                               settlement.Tradeqty * ( settlement.marketrate + ((floor(( (((broktable.day_puc/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                          when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((settlement.marketrate - broktable.day_sales),broktable.round_to)*/
                                                              settlement.Tradeqty * ( settlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                         when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (settlement.marketrate - round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to))*/
                                                              settlement.Tradeqty * (  settlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + settlement.marketrate ),broktable.round_to )*/
                                                               settlement.Tradeqty * (  settlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))


                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (settlement.marketrate + round(( broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to))*/
                                                               settlement.Tradeqty * (  settlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                        when ( settlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( settlement.marketrate - broktable.sett_sales ),broktable.round_to) */
                                                     settlement.Tradeqty * ( settlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )
                                         when ( settlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (settlement.marketrate - round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)) */
                                                       settlement.Tradeqty  * (  settlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
   Else  0 
                        End )
                      END   ),
Ins_chrg  =(Case
		when settlement.status = 'N' then 0
			else ((taxes.insurance_chrg * settlement.marketrate * settlement.Tradeqty)/100) End), 
turn_tax  = (Case
		when settlement.status = 'N' then 0
			else ((taxes.turnover_tax * settlement.marketrate * settlement.Tradeqty)/100 ) end),              
other_chrg =(Case
		when settlement.status = 'N' then 0
			else ((taxes.other_chrg * settlement.marketrate * settlement.Tradeqty)/100 ) end), 
sebi_tax = (Case
		when settlement.status = 'N' then 0
			else ((taxes.sebiturn_tax * settlement.marketrate * settlement.Tradeqty)/100) end),              
Broker_chrg =(Case
		when settlement.status = 'N' then 0
else ((taxes.broker_note * settlement.marketrate * settlement.Tradeqty)/100) end),
Service_tax = (Case
		when settlement.status = 'N' then 0
	       else
 (  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  
		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                      ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((  ((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		(( ((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))   ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END ) 
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		( (  ((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( Settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
              
                 when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))  ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((  ((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        
 when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((  ((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0 
                        End 
                         )
                       end  ),
      Trade_amount = settlement.Tradeqty * settlement.MarketRate,
      NBrokApp = (Case
		when settlement.status = 'N' then 0
	       else 
(  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                          ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
   Else  0 
                        End )
                        end ),
        NSertax =(Case
		when settlement.status = 'N' then 0
	       else
 (  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  
		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                      ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((  ((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		(( ((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))   ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END ) 
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		( (  ((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( Settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
              
                 when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))  ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((  ((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        
 when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((  ((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0 
                        End 
                         )
                       end  ),
       
N_NetRate =(Case
		when settlement.status = 'N' then settlement.MARKETRATE
	       else (  case  
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( settlement.marketrate + broktable.Normal),broktable.round_to) */
                                                                 settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((settlement.marketrate - broktable.Normal ),broktable.round_to )    */
                                                                  settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (settlement.marketrate + round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)) */
                                                                   settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (settlement.marketrate - round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to))           */
                                                                   settlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* settlement.marketrate))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                                                    Then /* round((broktable.day_puc + settlement.marketrate ),broktable.round_to)*/
                                                                 settlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                                                    Then /* (settlement.marketrate + round((broktable.day_puc/100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate + ((floor(( (((broktable.day_puc/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((settlement.marketrate - broktable.day_sales),broktable.round_to)*/
                                                               settlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (settlement.marketrate - round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + settlement.marketrate ),broktable.round_to )*/
                                                                 settlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (settlement.marketrate + round(( broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to))*/
                                                                 settlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                        when ( settlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( settlement.marketrate - broktable.sett_sales ),broktable.round_to) */
                                                                   settlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (settlement.marketrate - round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)) */
                                                                 settlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End )
                        end )
                                              
      FROM BrokTable BrokTable,Client2 client2,settlement, taxes,globals, client1 client1  
      WHERE 
            settlement.Party_Code = Client2.Party_code
  and
 client1.cl_code=client2.cl_code 
 And Broktable.Table_no = ( Case when settlement.TMARK ='V' 
					        	 Then Client2.P_To_P
							 Else ( Case When settlement.tmark = 'S' 
					    			     Then Client2.Sb_TableNo	
					    			     Else ( Case When settlement.tmark = 'C'  	
						           			 Then Client2.AlbmCF_tableno
										 Else CLIENT2.TABLE_NO 
									    End )
					    		        End )
				       		   End )		
	And 
	Broktable.Line_no = ( ( case when (client2.Tran_cat = 'DEL')   then 
					             (Select min(Broktable.line_no) from broktable where
		                               	      Broktable.table_no =   (case when settlement.tmark = 'V' then client2.p_to_p 
										else
										 client2.table_no 
									     End ) 	
						      and Trd_Del = 'D'  
                                                      and settlement.Party_Code =  Client2.Party_code   	
		                                      and settlement.marketrate <= Broktable.upper_lim )	
				  ELSE ( case when ( settlement.TMark = 'V' or settlement.TMark = 'S' or settlement.Tmark = 'C' ) Then
					     (Select min(Broktable.line_no) from broktable where
	                                      Broktable.table_no = ( Case When ( settlement.SELL_BUY = 2 AND settlement.TMARK = 'V' )
								     Then client2.P_To_P
								     Else ( Case When ( settlement.SELL_BUY = 1 AND settlement.TMARK = 'S' )
									     	 Then client2.sb_tableno
								     		 Else AlbmCF_tableno
									    End )
								     End )		
                                              and settlement.Party_Code =  Client2.Party_code and Trd_Del = 'T'  	
		                              and settlement.marketrate <= Broktable.upper_lim )
				  		else ( case when client2.brok_scheme = 2 then	
							    (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = Client2.table_no                                            						
				                	    and Trd_Del =							
							    ( Case When @@Eq = 'Y' then	
								  ( Case When @@PRatemore = 'Y' 
									 then ( Case When ( settlement.Sell_Buy = 1 ) 
							    		             Then 'F'  
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( settlement.Sell_Buy = 2 ) 
							    		             Then 'F'  
							    			     Else 'S'
									        End )					
									 End )
								   Else
									( Case When @@PMore = 'Y' 
									       then ( Case When ( settlement.Sell_Buy = 1 ) 
							    			           Then 'F'  
							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( settlement.Sell_Buy = 2 ) 
							    		                  Then
                                                                                              'F'  
                                                                                          Else 
                                                                                              'S'
									             End )					
									  End )
								   End )
							    and settlement.Party_Code =  Client2.Party_code   	
                                               		    and settlement.marketrate <= Broktable.upper_lim)	
						else ( case when client2.brok_scheme = 1 then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = Client2.table_no                                            						
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( settlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( settlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                                	    and settlement.Party_Code =  Client2.Party_code   	
                                               		    and settlement.marketrate <= Broktable.upper_lim)
							else ( case when client2.brok_scheme = 3 then					
					       		   	   (Select min(Broktable.line_no) from broktable where
                                               		            Broktable.table_no = Client2.table_no                                            						
				                	            and Trd_Del = ( Case When @@SMore ='Y' 
									        	 then ( Case When ( settlement.Sell_Buy = 2 ) 
							    			           	     Then 'F'  
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( settlement.Sell_Buy = 1 ) 
							    			 	        Then 'F'  
							    			 	        Else 'S'
										           End )					
									            End )
        	                                        	    and settlement.Party_Code =  Client2.Party_code   	
	                                               		    and settlement.marketrate <= Broktable.upper_lim)								    
								else 
							    	   (Select min(Broktable.line_no) from broktable 
							    	    where Broktable.table_no = client2.table_no   
							     	    And Trd_Del = 'T'
   		                   				    and settlement.Party_Code =  Client2.Party_code        
				           			    and settlement.marketrate <= Broktable.upper_lim )	
								end )
							end )
						end )
              				end ) 
			      end )
		/* end  */ ) 	
           And
       Taxes.Trans_cat  = (Case When Cl_Type = 'PRO' Then 'PRO' Else Client2.Tran_cat End )
           And
             (taxes.exchange = 'BSE')
  and settlement.party_code = @tparty  
  and left(convert(varchar,settlement.sauda_date,109),11)= @tdate
  and settlement.scrip_cd = @tscrip_cd
  and settlement.tmark like @tmark + '%'
  and settlement.tradeqty > 0
  And settlement.Sett_type = @Sett_type
  And settlement.Sett_no = @@Sett_no
  And settlement.Participantcode = @Memcode
  And Trade_no not like 'C%'   
  And  Status <> 'E'
  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
  And Settlement.User_id <>  @@TerminalNo

Set @@TPqty = 0
Set @@TPrate = 0
Set @@TSqty = 0
Set @@TSrate = 0

Set @@Pqty = 0
Set @@Prate = 0
Set @@Sqty = 0
Set @@Srate = 0


Set @@GetPos = Cursor For
select Sell_buy, 
pqty = (Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),
prate = (Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),
Sqty = (Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),
srate = (Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),
Participantcode,Tmark
from Settlement t1
Where
T1.Party_code = @Tparty
And
T1.Sett_no = @@Sett_no
And
T1.Scrip_cd = @TScrip_cd
And
T1.Tmark Like @Tmark +'%'
And
Left(Convert(varchar,T1.sauda_date,109),11) = @Tdate 
And T1.Sett_type = @Sett_type
And T1.Participantcode = @Memcode
and T1.user_id = @@TerminalNo 

Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,Left(Convert(varchar,sauda_date,109),11),Participantcode,tmark /* ,SettFlag */

Open @@GetPos
Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate,@@Participantcode,@@Tmark
    Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@Participantcode,@@Tmark 


While @@Fetch_status = 0 
Begin
/*     Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@Participantcode,@@Tmark */
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate,@@Participantcode,@@Tmark
End        


/*
Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
*/


Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'

If @@TPqty > @@TSqty 
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty 
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y' 
     If @@TSRate > @@TPRate 
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate 
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq
*/

Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10 
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End

Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))

/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/
/* We can change the brokerage here */

Update Settlement set 
/* Select Trade_no,Tradeqty,Participantcode, */
 Tmark = Tmark,    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when settlement.status = 'N' then 0
	       else
               (  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                          ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
   Else  0 
                        End) 
                       END  ),
       NetRate = (Case
		when settlement.status = 'N' then settlement.MARKETRATE
	       else
(  case  
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( settlement.marketrate + broktable.Normal),broktable.round_to) */
                                                                 settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((settlement.marketrate - broktable.Normal ),broktable.round_to )    */
                                                                  settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (settlement.marketrate + round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)) */
                                                                   settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (settlement.marketrate - round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to))           */
                                                                   settlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* settlement.marketrate))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                                                    Then /* round((broktable.day_puc + settlement.marketrate ),broktable.round_to)*/
                                                                 settlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                                                    Then /* (settlement.marketrate + round((broktable.day_puc/100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate + ((floor(( (((broktable.day_puc/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((settlement.marketrate - broktable.day_sales),broktable.round_to)*/
                                                               settlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (settlement.marketrate - round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + settlement.marketrate ),broktable.round_to )*/
                                                                 settlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (settlement.marketrate + round(( broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to))*/
                                                                 settlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                        when ( settlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( settlement.marketrate - broktable.sett_sales ),broktable.round_to) */
                                                                   settlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (settlement.marketrate - round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)) */
                                                                 settlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End)
                    END     ),
       Amount = (Case
		when settlement.status = 'N' then settlement.MARKETRATE * settlement. TRADEQTY
	       else
(  case  
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( settlement.marketrate + broktable.Normal),broktable.round_to) */
                                                             settlement.Tradeqty  *  (  settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))

                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((settlement.marketrate - broktable.Normal ),broktable.round_to )    */
                                                                settlement.Tradeqty * (   settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (settlement.marketrate + round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)) */
                                                               settlement.Tradeqty  * (   settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (settlement.marketrate - round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to))           */
                                                                settlement.Tradeqty * (   settlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* settlement.marketrate))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                          when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                                                    Then /* round((broktable.day_puc + settlement.marketrate ),broktable.round_to)*/
                                                             settlement.Tradeqty * (    settlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                         when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                                                    Then /* (settlement.marketrate + round((broktable.day_puc/100) * settlement.marketrate ,broktable.round_to))*/
                                                               settlement.Tradeqty * ( settlement.marketrate + ((floor(( (((broktable.day_puc/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                          when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((settlement.marketrate - broktable.day_sales),broktable.round_to)*/
                                                              settlement.Tradeqty * ( settlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                         when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (settlement.marketrate - round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to))*/
                                                              settlement.Tradeqty * (  settlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + settlement.marketrate ),broktable.round_to )*/
                                                               settlement.Tradeqty * (  settlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))


                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (settlement.marketrate + round(( broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to))*/
                                                               settlement.Tradeqty * (  settlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                        when ( settlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( settlement.marketrate - broktable.sett_sales ),broktable.round_to) */
                                                     settlement.Tradeqty * ( settlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )
                                         when ( settlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (settlement.marketrate - round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)) */
                                                       settlement.Tradeqty  * (  settlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
   Else  0 
                        End )
                      END   ),
Ins_chrg  =(Case
		when settlement.status = 'N' then 0
			else ((taxes.insurance_chrg * settlement.marketrate * settlement.Tradeqty)/100) End), 
turn_tax  = (Case
		when settlement.status = 'N' then 0
			else ((taxes.turnover_tax * settlement.marketrate * settlement.Tradeqty)/100 ) end),              
other_chrg =(Case
		when settlement.status = 'N' then 0
			else ((taxes.other_chrg * settlement.marketrate * settlement.Tradeqty)/100 ) end), 
sebi_tax = (Case
		when settlement.status = 'N' then 0
			else ((taxes.sebiturn_tax * settlement.marketrate * settlement.Tradeqty)/100) end),              
Broker_chrg =(Case
		when settlement.status = 'N' then 0
else ((taxes.broker_note * settlement.marketrate * settlement.Tradeqty)/100) end),
Service_tax = (Case
		when settlement.status = 'N' then 0
	       else
 (  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  
		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                      ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((  ((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		(( ((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))   ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END ) 
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		( (  ((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( Settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
              
                 when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))  ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((  ((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        
 when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((  ((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0 
                        End 
                         )
                       end  ),
      Trade_amount = settlement.Tradeqty * settlement.MarketRate,
      NBrokApp = (Case
		when settlement.status = 'N' then 0
	       else 
(  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                          ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
   Else  0 
                        End )
                        end ),
        NSertax =(Case
		when settlement.status = 'N' then 0
	       else
 (  case  
                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  
		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then  
                                      ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)         */
		((  ((floor(( ((broktable.Normal /100 )* settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then /* round((broktable.day_puc/100) * settlement.marketrate,broktable.round_to)  */
		(( ((floor(( ((broktable.day_puc/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))   ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END ) 
                  when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to) */
		( (  ((floor(( ((broktable.day_sales/ 100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( Settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
              
                 when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to))  ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to) */
		((  ((floor(( ((broktable.sett_purch/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( settlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        
 when ( settlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)*/
		((  ((floor(( ((broktable.sett_sales/100) * settlement.marketrate) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  

		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 

		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0 
                        End 
                         )
                       end  ),
       
N_NetRate =(Case
		when settlement.status = 'N' then settlement.MARKETRATE
	       else (  case  
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( settlement.marketrate + broktable.Normal),broktable.round_to) */
                                                                 settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((settlement.marketrate - broktable.Normal ),broktable.round_to )    */
                                                                  settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                                           when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (settlement.marketrate + round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to)) */
                                                                   settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when ( settlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (settlement.marketrate - round((broktable.Normal /100 )* settlement.marketrate,broktable.round_to))           */
                                                                   settlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* settlement.marketrate))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 2  and broktable.val_perc ='V' ) 
                                                    Then /* round((broktable.day_puc + settlement.marketrate ),broktable.round_to)*/
                                                                 settlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 2  and broktable.val_perc ='P' ) 
                                                    Then /* (settlement.marketrate + round((broktable.day_puc/100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate + ((floor(( (((broktable.day_puc/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (settlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((settlement.marketrate - broktable.day_sales),broktable.round_to)*/
                                                               settlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (settlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (settlement.marketrate - round((broktable.day_sales/ 100) * settlement.marketrate ,broktable.round_to))*/
                                                                settlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + settlement.marketrate ),broktable.round_to )*/
                                                                 settlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (settlement.marketrate + round(( broktable.sett_purch/100) * settlement.marketrate ,broktable.round_to))*/
                                                                 settlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                        when ( settlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( settlement.marketrate - broktable.sett_sales ),broktable.round_to) */
                                                                   settlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( settlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (settlement.marketrate - round((broktable.sett_sales/100) * settlement.marketrate ,broktable.round_to)) */
                                                                 settlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End )
                        end )
                                              
      FROM BrokTable BrokTable,Client2 client2,settlement, taxes,globals, client1 client1  
      WHERE 
            settlement.Party_Code = Client2.Party_code
  and
 client1.cl_code=client2.cl_code 
 And Broktable.Table_no = ( Case when settlement.TMARK ='V' 
					        	 Then @@P_To_P
							 Else ( Case When settlement.tmark = 'S' 
					    			     Then @@Sb_TableNo	
					    			     Else ( Case When settlement.tmark = 'C'  	
						           			 Then @@AlbmCF_tableno
										 Else @@TABLE_NO 
									    End )
					    		        End )
				       		   End )		
	And 
	Broktable.Line_no = ( ( case when (client2.Tran_cat = 'DEL')   then 
					             (Select min(Broktable.line_no) from broktable where
		                               	      Broktable.table_no =   (case when settlement.tmark = 'V' then @@p_to_p 
										else
										 @@table_no 
									     End ) 	
						      and Trd_Del = 'D'  
                              and settlement.Party_Code =  Client2.Party_code   	
                              and settlement.marketrate <= Broktable.upper_lim )	
				  ELSE ( case when ( settlement.TMark = 'V' or settlement.TMark = 'S' or settlement.Tmark = 'C' ) Then
					     (Select min(Broktable.line_no) from broktable where
	                                      Broktable.table_no = ( Case When ( settlement.SELL_BUY = 2 AND settlement.TMARK = 'V' )
								     Then @@P_To_P
								     Else ( Case When ( settlement.SELL_BUY = 1 AND settlement.TMARK = 'S' )
									     	 Then @@sb_tableno
								     		 Else @@AlbmCF_tableno
									    End )
								     End )		
                                              and settlement.Party_Code =  Client2.Party_code and Trd_Del = 'T'  	
		                              and settlement.marketrate <= Broktable.upper_lim )
				  		else ( case when @@brok_scheme = 2 then	
							    (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = @@table_no                                            						
				                	    and Trd_Del =							
							    ( Case When @@Eq = 'Y' then	
								  ( Case When @@PRatemore = 'Y' 
									 then ( Case When ( settlement.Sell_Buy = 1 ) 
							    		             Then 'F'  
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( settlement.Sell_Buy = 2 ) 
							    		             Then 'F'  
							    			     Else 'S'
									        End )					
									 End )
								   Else
									( Case When @@PMore = 'Y' 
									       then ( Case When ( settlement.Sell_Buy = 1 ) 
							    			           Then 'F'  
							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( settlement.Sell_Buy = 2 ) 
							    		                  Then
                                                                                              'F'  
                                                                                          Else 
                                                                                              'S'
									             End )					
									  End )
								   End )
							    and settlement.Party_Code =  Client2.Party_code   	
                                and settlement.marketrate <= Broktable.upper_lim)	
						else ( case when @@brok_scheme = 1 then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = @@table_no                                            						
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( settlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( settlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                                	    and settlement.Party_Code =  Client2.Party_code   	
                                               		    and settlement.marketrate <= Broktable.upper_lim)
							else ( case when @@brok_scheme = 3 then					
					       		   	   (Select min(Broktable.line_no) from broktable where
                                               		            Broktable.table_no = @@table_no                                            						
				                	            and Trd_Del = ( Case When @@SMore ='Y' 
									        	 then ( Case When ( settlement.Sell_Buy = 2 ) 
							    			           	     Then 'F'  
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( settlement.Sell_Buy = 1 ) 
							    			 	        Then 'F'  
							    			 	        Else 'S'
										           End )					
									            End )
        	                                        	    and settlement.Party_Code =  Client2.Party_code   	
	                                               		    and settlement.marketrate <= Broktable.upper_lim)								    
								else 
							    	   (Select min(Broktable.line_no) from broktable 
							    	    where Broktable.table_no = @@table_no   
							     	    And Trd_Del = 'T'
   		                   				    and settlement.Party_Code =  Client2.Party_code        
				           			    and settlement.marketrate <= Broktable.upper_lim )	
								end )
							end )
						end )
              				end ) 
			      end )
		/* end  */ ) 	
           And
       Taxes.Trans_cat  = (Case When Cl_Type = 'PRO' Then 'PRO' Else Client2.Tran_cat End )
           And
             (taxes.exchange = 'BSE')
  and settlement.party_code = @tparty  
  and left(convert(varchar,settlement.sauda_date,109),11)= @tdate
  and settlement.scrip_cd = @tscrip_cd
  and settlement.tmark like @tmark + '%'
  and settlement.tradeqty > 0
  And settlement.Sett_type = @Sett_type
  And settlement.Sett_no = @@Sett_no
  And settlement.Participantcode = @Memcode
  And Trade_no not like 'C%'   
  And  Status <> 'E'
  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
  And Settlement.User_id =  @@TerminalNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TBseRearrangeAfterBillflag
-- --------------------------------------------------

CREATE  Procedure TBseRearrangeAfterBillflag (@Sett_No varchar(7),@Sett_Type varchar(2),@Party_code Varchar(10),@Scrip_cd varchar(12),@Series varchar(3),@tmark varchar(2),@Participantcode varchar(15)) AS             
Declare 
 @@trade_no varchar(14),
 @@Pqty numeric(9), 
 @@Sqty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),
 @@Flag cursor,
 @@loop cursor,
 @@Sdate Varchar(11),
 @@Edate Varchar(11),
 @@TerminalNo Varchar(20),
 @@StartDate DateTime,
 @@BillNo Int

Select @@StartDate = Start_date from sett_mst where 
Sett_type = @Sett_type
and
Sett_no = @Sett_no

Select Distinct @@TerminalNo = Terminalnumber from AngelTermBrok where
Party_code = @Party_code  
and FromDate <= @@Startdate
and ToDate >= @@Startdate

/*  Insert into errorlog Values (Getdate(), 'In BseRearrangeAfterbillflag  ', + @Party_code + '  ' +@Scrip_cd +'      ' + @Sett_type +'   '+@Sett_no ,' ','  ')  */
       
Select @@Sqty = 0
Select @@PQty = 0


Select @@Billno = Max(Convert(Int,Billno)) from Settlement where sett_no = @Sett_no and sett_type = @Sett_type  and party_code = @Party_code

If ( ( @@Billno = 0 ))
Begin
     Select @@BillNo  = Max(Convert(Int,BillNo)) from Settlement where  Sett_no = @Sett_no and Sett_type = @Sett_type 
     Set @@BillNo = Convert(Int,@@BillNo) + 1
End


Select  @@Sdate = left(Convert(Varchar,Start_date,109),11),  @@Edate = left(Convert(Varchar,End_date,109),11) from
Sett_mst where Sett_no = @Sett_no and sett_type = @Sett_type

-- Used to create split for terminal number 

If @@Sdate = @@Edate 
Begin
      Update settlement Set Billflag = SettFlag , Tmark = (Case when Settflag > 3 Then 'D' Else 'N' End),Billno = @@Billno
      Where Party_code = @Party_code
      And  Sett_no = @Sett_no
      And Sett_type = @Sett_type
      And Scrip_cd = @Scrip_cd
      And Series = @Series
      And ParticipantCode = @ParticipantCode         
      And User_id = @@Terminalno
 End
 Else If ( (@@Sdate <> @@Edate) )
 Begin
      Update Settlement Set Billflag = (Case When Sell_Buy = 1 then 2 else 3 end ) ,Tmark = 'N',Billno = @@Billno
      Where Party_code = @Party_code 
      and Scrip_cd = @Scrip_Cd 
 and Series = @Series
 and Sett_no = @Sett_no 
 and Sett_Type = @Sett_type 
 and participantcode = @Participantcode
 And User_id = @@Terminalno


 Select @@Sqty  = Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 2 
 and Party_code = @Party_code and Participantcode = @Participantcode
 and Scrip_cd = @Scrip_cd and Series = @Series 
 and Sett_no = @Sett_no and Sett_type = @Sett_type
 And User_id = @@Terminalno

      

 Select  @@Pqty  = Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 1 
 and Party_code = @Party_code and Participantcode = @Participantcode
 and Scrip_cd = @Scrip_cd and Series = @Series 
 and Sett_no = @Sett_no and Sett_type = @Sett_type
 And User_id = @@Terminalno

 If  @@Sqty = 0
 Begin
      Update Settlement Set BillFlag = 4 ,Tmark = 'D'
      Where Party_code = @Party_code 
      and Scrip_cd = @Scrip_cd 
      and Series = @Series 
      and Sell_buy = 1 
      and Sett_Type = @Sett_type 
      and Sett_no = @Sett_no
      and Participantcode = @Participantcode
      And User_id = @@Terminalno
  End
  If  @@Pqty = 0
  Begin
       Update Settlement Set BillFlag = 5 ,Tmark = 'D'
       Where party_code = @Party_code 
       and Scrip_cd = @Scrip_cd 
       and Series = @Series 
       and Sell_buy = 2
       and Sett_Type = @Sett_type 
       and Sett_no = @Sett_no
       and Participantcode = @Participantcode
       And User_id = @@Terminalno
  End
  If  ( (@@Pqty > @@Sqty) and (@@Sqty > 0 )) 
  Begin 
       Select @@Pdiff = @@Pqty - @@Sqty 
       Set @@Loop  = Cursor For 
       Select Trade_no,Tradeqty From Settlement 
       Where Party_code = @Party_code 
       and Scrip_cd = @Scrip_cd 
       and Series = @Series 
       and Sell_buy = 1 
       and Sett_no = @Sett_no 
       and Sett_Type = @Sett_type 
       and Participantcode = @Participantcode
       And User_id = @@Terminalno
--       Order by Marketrate Desc  
       Order by sauda_date
       Open @@Loop
       Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      
       While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
       Begin
            If @@Pdiff >= @@Lqty 
            Begin
                 Update Settlement Set Billflag = 4   
                 Where Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_buy = 1 
                 and Trade_no = @@ltrade_no 
                 and Tradeqty = @@lqty
                 and Sett_no = @Sett_no  
                 and Sett_Type = @Sett_type  
                 and participantcode = @Participantcode
                 And User_id = @@Terminalno
                 Select @@Pdiff = @@Pdiff - @@Lqty
            End    
            Else If @@Pdiff < @@Lqty 
            Begin                                                                                                                                                                                                                                                                                               
                 Insert into Settlement                                                        
                 Select ContractNo,BillNo,'R'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,4,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2,'D',scheme      
                 From Settlement Where 
                 Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_buy = 1 
                 and Trade_no = @@ltrade_no 
                 and tradeqty = @@lqty  
                 and Sett_no = @Sett_no
                 and Sett_Type = @Sett_type  
                 and participantcode = @Participantcode
                 And User_id = @@Terminalno
                 Update Settlement Set Billflag = 2,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                 Where Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_Buy = 1 
                 and Trade_no = @@LTrade_no 
                 and Tradeqty = @@LQty
                 and Sett_no = @Sett_no
                 and Sett_Type = @Sett_type  
                 and participantcode = @Participantcode          
                 And User_id = @@Terminalno
                 Select @@Pdiff = 0  
             End
        Fetch next from @@Loop into @@Ltrade_no,@@Lqty
     End
 End
End

 If ((@@Pqty < @@Sqty) And (@@PQty > 0 ))  
 Begin 
      Select @@Pdiff = @@Sqty - @@Pqty 

      Set @@Loop  = Cursor For 
      Select Trade_no,Tradeqty From Settlement 
      Where Party_code = @Party_code 
      and Scrip_cd = @Scrip_cd 
      and Series = @Series 
      and Sell_buy = 2 
      and Sett_no = @Sett_no  
      and Sett_Type = @Sett_type 
      and Participantcode = @Participantcode
      And User_id = @@Terminalno
--      Order by Marketrate Desc  
       Order by sauda_date
      Open @@Loop
      Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
      Begin
           If @@Pdiff >= @@Lqty 
           Begin
                Update Settlement Set Billflag = 5,Tmark = 'D'
                Where Party_code = @Party_code
                and Scrip_cd = @Scrip_cd
                and Series = @Series 
                and Sell_buy = 2 
                and Trade_no = @@ltrade_no 
                and Tradeqty = @@lqty
                and Sett_no = @Sett_no  
                and Sett_Type = @Sett_type  
                and participantcode = @Participantcode
                And User_id = @@Terminalno                           
                Select @@Pdiff = @@Pdiff - @@Lqty
           End    
           Else If @@Pdiff < @@Lqty 
           Begin                                                                                                                                                                                                                                                                                               
                Insert into Settlement                                                        
                Select ContractNo,BillNo,'R'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,5,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2, 'D',scheme      
                From Settlement Where 
                Party_code = @Party_code 
                and Scrip_cd = @Scrip_cd 
                and Series = @Series 
                and Sell_buy = 2 
                and Trade_no = @@ltrade_no 
                and Tradeqty = @@lqty 
                and Sett_no = @Sett_no 
                and Sett_Type = @Sett_type  
                and Participantcode = @Participantcode
                And User_id = @@Terminalno
                Update Settlement Set Billflag = 3,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                Where Party_code = @Party_code 
                and Scrip_cd = @Scrip_cd 
                and Series = @Series 
                and Sell_Buy = 2
                and Trade_no = @@LTrade_no 
                and Tradeqty = @@LQty
                and Sett_no = @Sett_no
                and Sett_Type = @Sett_type  
                and Participantcode = @Participantcode          
                And User_id = @@Terminalno
                Select @@Pdiff = 0  
            End
            Fetch next from @@Loop into @@Ltrade_no,@@Lqty
        End
 End



------------
--Now the Rearrnage for all where Termid <>

If @@Sdate = @@Edate 
Begin
/*       Print 'In Sdate = Edate'   */
      Update settlement Set Billflag = SettFlag , Tmark = (Case when Settflag > 3 Then 'D' Else 'N' End),Billno = @@Billno
      Where Party_code = @Party_code
      And  Sett_no = @Sett_no
      And Sett_type = @Sett_type
      And Scrip_cd = @Scrip_cd
      And Series = @Series
      And ParticipantCode = @ParticipantCode         
      And User_id <> @@Terminalno
 End
 Else If ( (@@Sdate <> @@Edate) )
 Begin
      Update Settlement Set Billflag = (Case When Sell_Buy = 1 then 2 else 3 end ) ,Tmark = 'N',Billno = @@Billno
      Where Party_code = @Party_code 
      and Scrip_cd = @Scrip_Cd 
 and Series = @Series
 and Sett_no = @Sett_no 
 and Sett_Type = @Sett_type 
 and participantcode = @Participantcode
 And User_id <> @@Terminalno


 Select @@Sqty  = Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 2 
 and Party_code = @Party_code and Participantcode = @Participantcode
 and Scrip_cd = @Scrip_cd and Series = @Series 
 and Sett_no = @Sett_no and Sett_type = @Sett_type
 And User_id <> @@Terminalno
      

 Select  @@Pqty  = Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 1 
 and Party_code = @Party_code and Participantcode = @Participantcode
 and Scrip_cd = @Scrip_cd and Series = @Series 
 and Sett_no = @Sett_no and Sett_type = @Sett_type
 And User_id <> @@Terminalno


 If  @@Sqty = 0
 Begin
      Update Settlement Set BillFlag = 4 ,Tmark = 'D'
      Where Party_code = @Party_code 
      and Scrip_cd = @Scrip_cd 
      and Series = @Series 
      and Sell_buy = 1 
      and Sett_Type = @Sett_type 
      and Sett_no = @Sett_no
      and Participantcode = @Participantcode
      And User_id <> @@Terminalno
  End
  If  @@Pqty = 0
  Begin
       Update Settlement Set BillFlag = 5 ,Tmark = 'D'
       Where party_code = @Party_code 
       and Scrip_cd = @Scrip_cd 
       and Series = @Series 
       and Sell_buy = 2
       and Sett_Type = @Sett_type 
       and Sett_no = @Sett_no
       and Participantcode = @Participantcode
       And User_id <> @@Terminalno
  End
  If  ( (@@Pqty > @@Sqty) and (@@Sqty > 0 )) 
  Begin 
       Select @@Pdiff = @@Pqty - @@Sqty 
       Set @@Loop  = Cursor For 
       Select Trade_no,Tradeqty From Settlement 
       Where Party_code = @Party_code 
       and Scrip_cd = @Scrip_cd 
       and Series = @Series 
       and Sell_buy = 1 
       and Sett_no = @Sett_no 
       and Sett_Type = @Sett_type 
       and Participantcode = @Participantcode
       And User_id <> @@Terminalno
--       Order by Marketrate Desc  
       Order by sauda_date
       Open @@Loop
       Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      
       While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
       Begin
            If @@Pdiff >= @@Lqty 
            Begin
                 Update Settlement Set Billflag = 4   
                 Where Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_buy = 1 
                 and Trade_no = @@ltrade_no 
                 and Tradeqty = @@lqty
                 and Sett_no = @Sett_no  
                 and Sett_Type = @Sett_type  
                 and participantcode = @Participantcode
                 And User_id <> @@Terminalno
                 Select @@Pdiff = @@Pdiff - @@Lqty
            End    
            Else If @@Pdiff < @@Lqty 
            Begin                                                                                                                                                                                                                                                                                               
                 Insert into Settlement                                                        
                 Select ContractNo,BillNo,'R'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,4,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2,'D',scheme      
                 From Settlement Where 
                 Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_buy = 1 
                 and Trade_no = @@ltrade_no 
                 and tradeqty = @@lqty  
                 and Sett_no = @Sett_no
                 and Sett_Type = @Sett_type  
                 and participantcode = @Participantcode
                 And User_id <> @@Terminalno
                 Update Settlement Set Billflag = 2,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                 Where Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_Buy = 1 
                 and Trade_no = @@LTrade_no 
                 and Tradeqty = @@LQty
                 and Sett_no = @Sett_no
                 and Sett_Type = @Sett_type  
                 and participantcode = @Participantcode          
                 And User_id <> @@Terminalno
                 Select @@Pdiff = 0  
             End
        Fetch next from @@Loop into @@Ltrade_no,@@Lqty
     End
 End
End

 If ((@@Pqty < @@Sqty) And (@@PQty > 0 ))  
 Begin 
      Select @@Pdiff = @@Sqty - @@Pqty 
/*      Print ' in Pqty > Sqty '
      Select @@Pdiff */
      Set @@Loop  = Cursor For 
      Select Trade_no,Tradeqty From Settlement 
      Where Party_code = @Party_code 
      and Scrip_cd = @Scrip_cd 
      and Series = @Series 
      and Sell_buy = 2 
      and Sett_no = @Sett_no  
      and Sett_Type = @Sett_type 
      and Participantcode = @Participantcode
      And User_id <> @@Terminalno
--      Order by Marketrate Desc  
       Order by sauda_date
      Open @@Loop
      Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
      Begin
           If @@Pdiff >= @@Lqty 
           Begin
                Update Settlement Set Billflag = 5,Tmark = 'D'
                Where Party_code = @Party_code
                and Scrip_cd = @Scrip_cd
                and Series = @Series 
                and Sell_buy = 2 
                and Trade_no = @@ltrade_no 
                and Tradeqty = @@lqty
                and Sett_no = @Sett_no  
                and Sett_Type = @Sett_type  
                and participantcode = @Participantcode
                And User_id <> @@Terminalno
                Select @@Pdiff = @@Pdiff - @@Lqty
           End    
           Else If @@Pdiff < @@Lqty 
           Begin                                                                                                                                                                                                                                                                                               
                Insert into Settlement                                                        
                Select ContractNo,BillNo,'R'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,5,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2, 'D',scheme      
                From Settlement Where 
                Party_code = @Party_code 
                and Scrip_cd = @Scrip_cd 
                and Series = @Series 
                and Sell_buy = 2 
                and Trade_no = @@ltrade_no 
                and Tradeqty = @@lqty 
                and Sett_no = @Sett_no 
                and Sett_Type = @Sett_type  
                and Participantcode = @Participantcode
                And User_id <> @@Terminalno

                Update Settlement Set Billflag = 3,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                Where Party_code = @Party_code 
                and Scrip_cd = @Scrip_cd 
                and Series = @Series 
                and Sell_Buy = 2
                and Trade_no = @@LTrade_no 
                and Tradeqty = @@LQty
                and Sett_no = @Sett_no
                and Sett_Type = @Sett_type  
                and Participantcode = @Participantcode          
                And User_id <> @@Terminalno
                Select @@Pdiff = 0  
            End
            Fetch next from @@Loop into @@Ltrade_no,@@Lqty
        End
 End


update settlement set tmark = 'D' where party_code = @Party_code and scrip_cd = @scrip_cd and series = @series    
and Sett_no = @Sett_No and Sett_Type = @Sett_type 
and tmark <> 'D'  and billflag > 3  

/* We Need to get this into here after removing it from ASP pages  */
/*  BBG  28 June 2002  */
/*   EXEC NEWUPDBILLTAXafterbill  @Sett_No,@Sett_Type,@Party_code,@Scrip_cd  */

/*  Insert into errorlog Values (Getdate(), 'Out BseRearrangeAfterbillflag  ', + @Party_code + '  ' +@Scrip_cd +'      ' + @Sett_type +'   '+@Sett_no ,' ','  ')  */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TBseRearrangeAfterContflag
-- --------------------------------------------------


CREATE  PROCEDURE TBseRearrangeAfterContflag (@Sett_Type varchar(2),@Party_code Varchar(10),@Scrip_cd varchar(12),@Series varchar(3),@TDate Varchar(11),@TMark varchar(2),@Participantcode varchar(15))
AS 
Declare 
 @@trade_no varchar(14),
 @@Pqty numeric(9), 
 @@Sqty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),
 @@Flag cursor,
 @@loop cursor,
 @@ScripCursor Cursor,
 @@TPqty numeric(9), 
 @@TSqty numeric(9),
 @@PartyUserid Cursor,
 @@TerminalNo Varchar(20),
 @@TSell_Buy int 


 /*  apply sett_flag = 1 to all trades where client2. tran_cat   = 'DEL' */

Set Nocount On

Print ' Termwise After contract  '

Select @@TerminalNo =  Terminalnumber from AngelTermBrok where
Party_code = @Party_code  
and FromDate <= @Tdate
and ToDate >= @Tdate

Print @@Terminalno

-- We Will Split Trades for the Above Terminalnumber and Party -----


/*Set @@ScripCursor = Cursor for       
Select Distinct Scrip_cd,Series,Participantcode from Settlement where 
Sett_Type = @Sett_type
And 
Party_code = @Party_code
And
Sauda_date like @Tdate +'%'

Open @@ScripCursor
Fetch Next from @@ScripCursor into @Scrip_cd,@Series,@Participantcode
While ( @@Fetch_Status = 0 )
Begin
*/
  
 Update Settlement Set Settflag = 1  FROM Settlement t , CLIENT2 
 Where  CLIENT2.PARTY_CODE = T.party_code
 and (CLIENT2.tran_cat = 'DEL' OR TMARK = 'D')  
 and  t. party_code = @Party_code 
 and t.scrip_cd = @scrip_cd 
 and t.series = @series    
 and t.sauda_date Like  @Tdate  +'%'
 and t.Sett_Type = @Sett_type  
 and t.Participantcode = @Participantcode
 and t.Tmark like @Tmark
 and t.tradeqty > 0  
 and t.user_id = @@TerminalNo 

 Update settlement Set Settflag = (Case When Sell_Buy = 1 then 2 else 3 end ), TMark ='N' from settlement T,Client2 
 Where T.Party_code = @Party_code 
 and T.Scrip_cd = @Scrip_Cd 
 and T.Series = @Series 
 and T.sauda_date Like @Tdate +'%'
 and T.Sett_Type = @Sett_type 
 and T.tmark like @TMark  
 and T.participantcode = @Participantcode
 and tradeqty > 0  
 And CLIENT2.PARTY_CODE = T.party_code
 And CLIENT2.tran_cat = 'Trd' 
 and T.user_id = @@TerminalNo 



/*Select @Sett_Type ,@Party_code ,@Scrip_cd ,@Series ,@TDate ,@TMark ,@Participantcode ,@@TerminalNo 

Insert into errorlog Values (Getdate(), '  In Aftercontract    Party_code  = ',  @Party_code + '     Scrip_cd   =  ' +@Scrip_cd + '   Series ' + @Series + '   Sauda_date =     ' +@Tdate   + '     Sett_type  =  ' +  @Sett_type +'    Sett_no =   ' ,'     ParticipantCode =  ' + @Participantcode + '        End      '  ,'      ')
*/  

Select @@Sqty  =  Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 2 
and Party_code = @Party_code and Participantcode = @Participantcode
and Scrip_cd = @Scrip_cd and Series = @Series and Tmark Like @Tmark  /* and ( Tmark <> 'D'  ) */
and  Sauda_date Like  @Tdate  +'%' and Sett_type = @Sett_type
and user_id = @@TerminalNo 

/* Print 'Sqty ' + Convert(varchar,@@Sqty) */


Select  @@Pqty = Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 1 
and Party_code = @Party_code and Participantcode = @Participantcode
and Scrip_cd = @Scrip_cd and Series = @Series and Tmark Like @Tmark  /*  and ( Tmark <> 'D'  )  */
and  Sauda_date Like  @Tdate  +'%' and Sett_type = @Sett_type
and user_id = @@TerminalNo 


/* Print 'Pqty ' + Convert(varchar,@@Pqty) */

If  @@Sqty = 0
Begin
         Update Settlement Set Settflag = 4 
         Where Party_code = @Party_code 
         and Scrip_cd = @scrip_cd 
         and Series = @series 
         and Sell_buy = 1 
         and Sauda_date Like  @Tdate +'%' 
         and Sett_Type = @Sett_type 
         and Tmark like @TMark 
         And trade_no not like '%C%'
         and Participantcode = @Participantcode
         and user_id = @@TerminalNo 
 End
 If  @@Pqty = 0
 Begin
           Update Settlement set Settflag = 5 
           Where party_code = @Party_code 
           and Scrip_cd = @Scrip_cd 
           and Series = @Series 
           and Sell_buy = 2
           and sauda_date Like  @Tdate +'%'
           and Sett_Type = @Sett_type 
           and Tmark like @TMark  
           And trade_no not like '%C%'
           and Participantcode = @Participantcode
           and user_id = @@TerminalNo 
 End

 If  ( (@@Pqty > @@Sqty) and (@@Sqty > 0 )) 
 Begin 
           Insert into errorlog Values (Getdate(), '  In    ( (@@Pqty > @@Sqty) and (@@Sqty > 0 ))    Party_code  = ',  @Party_code + '     Scrip_cd   =  ' +@Scrip_cd + '   Series ' + @Series + '   Sauda_date =     ' +@Tdate   + '     Sett_type  =  ' + @Sett_type +'    Sett_no =   ' ,'     ParticipantCode =  ' + @Participantcode + '        End      '  ,'      ')
           Select @@Pdiff = @@Pqty - @@Sqty 
           /* Print ' in Pqty > Sqty ' 
           Select @@Pdiff */
           Set @@Loop  = Cursor For 
           Select Trade_no,Tradeqty From Settlement 
           Where Party_code = @Party_code 
           and Scrip_cd = @Scrip_cd 
          and Series = @Series 
          and Sell_buy = 1 
          and Sauda_date Like @Tdate +'%' 
          and Sett_Type = @Sett_type 
          and Tmark like @TMark  
          and Participantcode = @Participantcode
          And trade_no not like '%C%'
          and user_id = @@TerminalNo 
--        Order by Marketrate Desc  
          Order by Sauda_date
          Open @@Loop
          Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      
          While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
          Begin
                    If @@Pdiff >= @@Lqty 
                    Begin
                              Update Settlement Set Settflag = 4   
                              Where Party_code = @Party_code 
                              and Scrip_cd = @Scrip_cd 
                              and Series = @Series 
                              and Sell_buy = 1 
                              and Trade_no = @@ltrade_no 
                              and Tradeqty = @@lqty  
                              and sauda_date  Like @Tdate +'%' 
                              and Sett_Type = @Sett_type  
                              and Tmark like @TMark  
                              and participantcode = @Participantcode
                              And trade_no not like '%C%'                                
                              and user_id = @@TerminalNo 
                             Select @@Pdiff = @@Pdiff - @@Lqty
                     End    
                     Else If @@Pdiff < @@Lqty 
                     Begin                                                                                                                                                                                                                                     
                                                          
                               Insert into Settlement                                                        
                               Select ContractNo,BillNo,'B'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,4,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,BillFlag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2, tmark,scheme   
                                  From Settlement Where 
                               Party_code = @Party_code 
                               and Scrip_cd = @Scrip_cd 
                               and Series = @Series 
                               and Sell_buy = 1 
                               and Trade_no = @@ltrade_no 
                               and tradeqty = @@lqty  
                               and   sauda_date  Like @Tdate +'%' 
                               and Sett_Type = @Sett_type  
                               and tmark like @TMark  
                               and participantcode = @Participantcode
                               And trade_no not like '%C%' 
                               and user_id = @@TerminalNo 
                               Update Settlement Set Settflag = 2,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                               Where Party_code = @Party_code 
                                and Scrip_cd = @Scrip_cd 
                                and Series = @Series 
                                and Sell_Buy = 1 
                                and Trade_no = @@LTrade_no 
                                and Tradeqty = @@LQty
                                and  sauda_date  Like @Tdate +'%' 
                                and Sett_Type = @Sett_type  
                                and Tmark like @TMark  
                                and participantcode = @Participantcode          
                                And trade_no not like '%C%'        
                                and user_id = @@TerminalNo 
                        Select @@Pdiff = 0  
                      End
                Fetch next from @@Loop into @@Ltrade_no,@@Lqty
        End
End
        If ((@@Pqty < @@Sqty) And (@@PQty > 0 ))  
        Begin 
                 Insert into errorlog Values (Getdate(), '  In    ( (@@Pqty > @@Sqty) and (@@Sqty > 0 ))    Party_code  = ',  @Party_code + '     Scrip_cd   =  ' +@Scrip_cd + '   Series ' + @Series + '   Sauda_date =     ' +@Tdate   + '     Sett_type  =  ' +  @Sett_type +'    Sett_no =   ' ,'     ParticipantCode =  ' + @Participantcode + '        End      '  ,'      ')
                  Select @@Pdiff = @@Sqty - @@Pqty      
                 Set @@Loop  = Cursor For 
                Select Trade_no,Tradeqty From Settlement 
                 Where Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_buy = 2 
                 and  sauda_date  Like @Tdate +'%'  
                 and Sett_Type = @Sett_type 
                 and Tmark like @TMark  
                 and Participantcode = @Participantcode
                 And trade_no not like '%C%'
                 and user_id = @@TerminalNo 
--               Order by Marketrate Desc  
	         Order by Sauda_date
                 Open @@Loop
                 Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      
                 While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
                 Begin
                            If @@Pdiff >= @@Lqty 
                            Begin
                                       Update Settlement Set Settflag = 5
                                        Where Party_code = @Party_code
                                        and Scrip_cd = @Scrip_cd
                                        and Series = @Series 
                                        and Sell_buy = 2 
                                        and Trade_no = @@ltrade_no 
                                        and Tradeqty = @@lqty  
                                        and  sauda_date  Like @Tdate +'%' 
                                        and Sett_Type = @Sett_type  
                                        and Tmark like @TMark  
                                        and participantcode = @Participantcode
                                        And trade_no not like '%C%'      
                                        and user_id = @@TerminalNo                           
                                        Select @@Pdiff = @@Pdiff - @@Lqty
                            End    
                            Else If @@Pdiff < @@Lqty 
                            Begin                                                                                                                                                                                                                              
                                                                 
                                       Insert into Settlement                                                        
                                       Select ContractNo,BillNo,'B'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,5,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,BillFlag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2, tmark,scheme      
                                       From Settlement Where 
                                       Party_code = @Party_code 
                                       and Scrip_cd = @Scrip_cd 
                                       and Series = @Series 
                                       and Sell_buy = 2 
                                       and Trade_no = @@ltrade_no 
                                       and tradeqty = @@lqty  
                                       and  sauda_date  Like @Tdate +'%' 
                                       and Sett_Type = @Sett_type  
                                       and tmark like @TMark  
                                       and participantcode = @Participantcode
                                       And trade_no not like '%C%'  
                                       and user_id = @@TerminalNo 
                                       Update Settlement Set Settflag = 3,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                                       Where Party_code = @Party_code 
                                       and Scrip_cd = @Scrip_cd 
                                       and Series = @Series 
                                       and Sell_Buy = 2
                                       and Trade_no = @@LTrade_no 
                                       and Tradeqty = @@LQty
                                       and  sauda_date  Like @Tdate +'%' 
                                       and Sett_Type = @Sett_type  
                                       and Tmark like @TMark  
                                       and participantcode = @participantcode          
                                       And trade_no not like '%C%'
                                       and user_id = @@TerminalNo 
                                       Select @@Pdiff = 0  
                                End
                                Fetch next from @@Loop into @@Ltrade_no,@@Lqty
                    End
        End

-- End of Rearrange for the Terminal Number from angeltermbrok ---


--- No We will Rearrange all trades for the party and Scrip ---
--- Condition here will be  and t.user_id <> @@TerminalNo 

 Update Settlement Set Settflag = 1  FROM Settlement t , CLIENT2 
 Where  CLIENT2.PARTY_CODE = T.party_code
 and (CLIENT2.tran_cat = 'DEL' OR TMARK = 'D')  
 and  t. party_code = @Party_code 
 and t.scrip_cd = @scrip_cd 
 and t.series = @series    
 and t.sauda_date Like  @Tdate  +'%'
 and t.Sett_Type = @Sett_type  
 and t.Participantcode = @Participantcode
 and t.Tmark like @Tmark
 and t.tradeqty > 0   and t.user_id <> @@TerminalNo 

Update settlement Set Settflag = (Case When Sell_Buy = 1 then 2 else 3 end ), TMark ='N' from settlement T,Client2 
Where T.Party_code = @Party_code 
and T.Scrip_cd = @Scrip_Cd 
and T.Series = @Series 
and T.sauda_date Like @Tdate +'%'
and T.Sett_Type = @Sett_type 
and T.tmark like @TMark  
and T.participantcode = @Participantcode
and tradeqty > 0  
And CLIENT2.PARTY_CODE = T.party_code
And CLIENT2.tran_cat = 'Trd' 
and T.user_id <> @@TerminalNo 

/*Select @Sett_Type ,@Party_code ,@Scrip_cd ,@Series ,@TDate ,@TMark ,@Participantcode 

Insert into errorlog Values (Getdate(), '  In Aftercontract    Party_code  = ',  @Party_code + '     Scrip_cd   =  ' +@Scrip_cd + '   Series ' + @Series + '   Sauda_date =     ' +@Tdate   + '     Sett_type  =  ' +  @Sett_type +'    Sett_no =   ' ,'     ParticipantCode =  ' + @Participantcode + '        End      '  ,'      ')
*/
  
Select @@Sqty  = Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 2 
and Party_code = @Party_code and Participantcode = @Participantcode
and Scrip_cd = @Scrip_cd and Series = @Series and Tmark Like @Tmark  /* and ( Tmark <> 'D'  ) */
and  Sauda_date Like  @Tdate  +'%' and Sett_type = @Sett_type
and user_id <> @@TerminalNo 

/* Print 'Sqty ' + Convert(varchar,@@Sqty) */


Select @@Pqty  = Isnull(Sum(Tradeqty),0) from Settlement where Sell_buy = 1 
and Party_code = @Party_code and Participantcode = @Participantcode
and Scrip_cd = @Scrip_cd and Series = @Series and Tmark Like @Tmark  /*  and ( Tmark <> 'D'  )  */
and  Sauda_date Like  @Tdate  +'%' and Sett_type = @Sett_type
and user_id <> @@TerminalNo 

/* Print 'Pqty ' + Convert(varchar,@@Pqty) */

If  @@Sqty = 0
Begin
         Update Settlement Set Settflag = 4 
         Where Party_code = @Party_code 
         and Scrip_cd = @scrip_cd 
         and Series = @series 
         and Sell_buy = 1 
         and Sauda_date Like  @Tdate +'%' 
         and Sett_Type = @Sett_type 
         and Tmark like @TMark 
         And trade_no not like '%C%'
         and Participantcode = @Participantcode
         and user_id <> @@TerminalNo 
 End
 If  @@Pqty = 0
 Begin
           Update Settlement set Settflag = 5 
           Where party_code = @Party_code 
           and Scrip_cd = @Scrip_cd 
           and Series = @Series 
           and Sell_buy = 2
           and sauda_date Like  @Tdate +'%'
           and Sett_Type = @Sett_type 
           and Tmark like @TMark  
           And trade_no not like '%C%'
           and Participantcode = @Participantcode
           and user_id <> @@TerminalNo 
 End

 If  ( (@@Pqty > @@Sqty) and (@@Sqty > 0 )) 
 Begin 
           Insert into errorlog Values (Getdate(), '  In    ( (@@Pqty > @@Sqty) and (@@Sqty > 0 ))    Party_code  = ',  @Party_code + '     Scrip_cd   =  ' +@Scrip_cd + '   Series ' + @Series + '   Sauda_date =     ' +@Tdate   + '     Sett_type  =  ' + @Sett_type +'    Sett_no =   ' ,'     ParticipantCode =  ' + @Participantcode + '        End      '  ,'      ')
           Select @@Pdiff = @@Pqty - @@Sqty 
           Set @@Loop  = Cursor For 
           Select Trade_no,Tradeqty From Settlement 
           Where Party_code = @Party_code 
           and Scrip_cd = @Scrip_cd 
          and Series = @Series 
          and Sell_buy = 1 
          and Sauda_date Like @Tdate +'%' 
          and Sett_Type = @Sett_type 
          and Tmark like @TMark  
          and Participantcode = @Participantcode
          And trade_no not like '%C%'
          and user_id <> @@TerminalNo 
--        Order by Marketrate Desc  
          Order by Sauda_date
          Open @@Loop
          Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      
          While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
          Begin
                    If @@Pdiff >= @@Lqty 
                    Begin
                              Update Settlement Set Settflag = 4   
                              Where Party_code = @Party_code 
                              and Scrip_cd = @Scrip_cd 
                              and Series = @Series 
                              and Sell_buy = 1 
                              and Trade_no = @@ltrade_no 
                              and Tradeqty = @@lqty  
                              and sauda_date  Like @Tdate +'%' 
                              and Sett_Type = @Sett_type  
                              and Tmark like @TMark  
                              and participantcode = @Participantcode
                              And trade_no not like '%C%'                                
                              and user_id <> @@TerminalNo 
                             Select @@Pdiff = @@Pdiff - @@Lqty
                     End    
                     Else If @@Pdiff < @@Lqty 
                     Begin                                                                                                                                                                                                                                     
                                                          
                               Insert into Settlement                                                        
                               Select ContractNo,BillNo,'B'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,4,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,BillFlag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2, tmark,scheme   
   
                               From Settlement Where 
                               Party_code = @Party_code 
                               and Scrip_cd = @Scrip_cd 
                               and Series = @Series 
                               and Sell_buy = 1 
                               and Trade_no = @@ltrade_no 
                               and tradeqty = @@lqty  
                               and   sauda_date  Like @Tdate +'%' 
                               and Sett_Type = @Sett_type  
                               and tmark like @TMark  
                               and participantcode = @Participantcode
                               And trade_no not like '%C%' 
                               and user_id <> @@TerminalNo 
                               Update Settlement Set Settflag = 2,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                               Where Party_code = @Party_code 
                                and Scrip_cd = @Scrip_cd 
                                and Series = @Series 
                                and Sell_Buy = 1 
                                and Trade_no = @@LTrade_no 
                                and Tradeqty = @@LQty
                                and  sauda_date  Like @Tdate +'%' 
                                and Sett_Type = @Sett_type  
                                and Tmark like @TMark  
                                and participantcode = @Participantcode          
                                And trade_no not like '%C%'        
                                and user_id <> @@TerminalNo 
                        Select @@Pdiff = 0  
                      End
                Fetch next from @@Loop into @@Ltrade_no,@@Lqty
        End
End
        If ((@@Pqty < @@Sqty) And (@@PQty > 0 ))  
        Begin 
                 Insert into errorlog Values (Getdate(), '  In    ( (@@Pqty > @@Sqty) and (@@Sqty > 0 ))    Party_code  = ',  @Party_code + '     Scrip_cd   =  ' +@Scrip_cd + '   Series ' + @Series + '   Sauda_date =     ' +@Tdate   + '     Sett_type  =  ' +  @Sett_type +'    Sett_no =   ' ,'     ParticipantCode =  ' + @Participantcode + '        End      '  ,'      ')
                  Select @@Pdiff = @@Sqty - @@Pqty      
                 Set @@Loop  = Cursor For 
                 Select Trade_no,Tradeqty From Settlement 
                 Where Party_code = @Party_code 
                 and Scrip_cd = @Scrip_cd 
                 and Series = @Series 
                 and Sell_buy = 2 
                 and  sauda_date  Like @Tdate +'%'  
                 and Sett_Type = @Sett_type 
                 and Tmark like @TMark  
                 and Participantcode = @Participantcode
                 And trade_no not like '%C%'
                 and user_id <> @@TerminalNo 
--               Order by Marketrate Desc  
	         Order by Sauda_date
                 Open @@Loop
                 Fetch Next From @@Loop Into @@Ltrade_no,@@Lqty
      
                 While ( @@Fetch_Status = 0 ) and (@@Pdiff > 0) 
                 Begin
                            If @@Pdiff >= @@Lqty 
                            Begin
                                       Update Settlement Set Settflag = 5
                                        Where Party_code = @Party_code
                                        and Scrip_cd = @Scrip_cd
                                        and Series = @Series 
                                        and Sell_buy = 2 
                                        and Trade_no = @@ltrade_no 
                                        and Tradeqty = @@lqty  
                                        and  sauda_date  Like @Tdate +'%' 
                                        and Sett_Type = @Sett_type  
                                        and Tmark like @TMark  
                                        and participantcode = @Participantcode
                                        And trade_no not like '%C%'      
                                        and user_id <> @@TerminalNo                           
                                        Select @@Pdiff = @@Pdiff - @@Lqty
                            End    
                            Else If @@Pdiff < @@Lqty 
                            Begin                                                                                                                                                                                                                              
                                                                 
                                       Insert into Settlement                                                        
                                       Select ContractNo,BillNo,'B'+Trade_no,Party_Code,Scrip_Cd,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,5,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*MarketRate,BillFlag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type  ,ParticiPantCode,Status,Pro_Cli,CpId,Instrument,BookType,Branch_Id,Dummy1,Dummy2, tmark,scheme      
                                       From Settlement Where 
                                       Party_code = @Party_code 
                                       and Scrip_cd = @Scrip_cd 
                                       and Series = @Series 
                                       and Sell_buy = 2 
                                       and Trade_no = @@ltrade_no 
                                       and tradeqty = @@lqty  
                                       and  sauda_date  Like @Tdate +'%' 
                                       and Sett_Type = @Sett_type  
                                       and tmark like @TMark  
                                       and participantcode = @Participantcode
                                       And trade_no not like '%C%'  
                                       and user_id <> @@TerminalNo 
                                       Update Settlement Set Settflag = 3,Tradeqty = @@Lqty - @@Pdiff,Trade_Amount = (@@Lqty - @@pdiff)*MarketRate    
                                       Where Party_code = @Party_code 
                                       and Scrip_cd = @Scrip_cd 
                                       and Series = @Series 
                                       and Sell_Buy = 2
                                       and Trade_no = @@LTrade_no 
                                       and Tradeqty = @@LQty
                                       and  sauda_date  Like @Tdate +'%' 
                                       and Sett_Type = @Sett_type  
                                       and Tmark like @TMark  
                                       and participantcode = @participantcode          
                                       And trade_no not like '%C%'
                                       and user_id <> @@TerminalNo 
                                       Select @@Pdiff = 0  
                                End
                                Fetch next from @@Loop into @@Ltrade_no,@@Lqty
                    End
        End

/*Fetch Next from @@ScripCursor into @Scrip_cd,@Series,@Participantcode
End   */
 /* End Of ScripCursor    
Close @@ScripCursor
Deallocate @@ScripCursor */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temp_Client
-- --------------------------------------------------
CREATE proc temp_Client (@br_code as varchar(20),@Sb_code as varchar(20))                      
as                      
                      
select Top 100 Party_code,Brokerage=sum(Brokerage) into #t                 
from mis_to where sauda_date >= 'Apr 01 2006' and sauda_date <= 'Apr 30 2007' and                      
branch_cd = @br_code and sub_broker = @Sb_code group by Party_code        
       
select Distinct long_name,a.cl_code,sub_broker,branch_cd,Complete_Resi=l_address1+','+l_address2+','+l_state+','+ l_address3+',        
'+l_city++','+l_nation+','+l_zip,Resi_No = res_phone1+','+res_phone2, Office_No=off_phone1+','+off_phone2,         
mobile_pager,email,b.Brokerage,AVG_Brok=b.brokerage/12 /*into #t1*/ from risk.dbo.client_details a inner join #t b on        
b.Party_code = a.cl_code collate latin1_general_cs_as left outer join risk.dbo.client_brok_details c on b.Party_code = c.cl_code collate latin1_general_cs_as and c.InActive_From >= getdate()        
order by b.Brokerage desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temp_mis_ebrok_cli123
-- --------------------------------------------------
CREATE procedure dbo.temp_mis_ebrok_cli123(@fdate as varchar(11),@tdate as varchar(11),@brcode as varchar(10),@sbcode as varchar(10),@cli_stat as varchar(25),@flag as varchar(8))                                                                             
 
as                                                                              
set transaction isolation level read uncommitted                                                                              
set nocount on                                                   
select distinct zone=space(15),region=space(15),brcode=space(10),sbcode=space(10),party_Code,odin_server                                                            
into #cli79                                                             
--from ctcl.dbo.client_mast79                                                             
from vw_ebrok_client1                
--select * from vw_ebrok_client1                
                                                            
update #cli79 set brcode=b.branch_Cd,sbcode=b.sub_Broker from risk.dbo.client_details b                                                            
where #cli79.party_code=b.party_Code         
      
update #cli79 set region=b.reg_code from risk.dbo.region b                                                            
where #cli79.brcode=b.code collate SQL_Latin1_General_CP1_CI_AS        
      
update #cli79 set zone=b.zone from risk.dbo.Vw_RMS_Client_Vertical b                                                            
where #cli79.brcode=b.branch collate SQL_Latin1_General_CP1_CI_AS                                                 
                                            
select * into #mis from MIS_ebroking_cli  where sauda_DAte>=convert(datetime,@fdate,103) 
and sauda_DAte <=convert(datetime,@tdate,103) and user_Stat like @cli_stat                                                                               
and branch_Cd like @brcode                                                
 --select * from #mis   select * from #cli79                                                                 
if @flag='%'                                                 
 begin                                         
                                        
 select distinct b.zone,b.region,a.branch_cd,a.sub_Broker,a.party_code,b.odin_server,                                                               
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                             
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                                            
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                 
 into #odinanywhere                                                                          
 from #mis a left outer join #cli79 b                                                
 on a.party_code=b.party_Code collate Latin1_General_CI_AS                                                                  
 --where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                                               
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                                                
 group by a.party_Code,b.zone,b.region,a.branch_cd,a.sub_Broker,b.odin_server   
                             
  select clientcode,nooflogin=count(clientcode) into #nod   
from [196.1.115.211].bidb.dbo.ebrokingfds_oct_09  
where date>=convert(datetime,@fdate,103)   
and  date<=convert(datetime,@tdate,103)         
group by clientcode      
                                             
update  #odinanywhere set nooflogin=a.nooflogin           
FROM #nod A WHERE party_code=A.clientcode collate Latin1_General_CI_AS      
                                                                           
 select a.*,offline_brok=isnull(c.offline_brok,0),notd=isnull(notd,0) into #file2                 
from #odinanywhere a                                                                  
 left outer join                                                                   
 (                                                                  
 select party_code,sub_broker,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok',notd=count(distinct sauda_DAte)                                                                  
 from ebrok_tobr_period (nolock)                                                                   
 where sauda_DAte>=convert(datetime,@fdate,103)  and sauda_DAte <=convert(datetime,@tdate,103)                                                  
 --and user_Stat like @cli_stat                                                                          
 and branch_Cd like @brcode and sub_Broker like @sbcode                                                                
 group by party_code,sub_broker                                                                  
 ) c                       
 on a.party_code=c.party_code collate Latin1_General_CI_AS  and a.sub_broker=c.sub_broker                                                                  
                                                                               
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                                                                            
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-'),b2c=convert(varchar(3),'NO')                                                                            
into #file1a                                                                            
 from #file2  a  left outer join ebrok_client_access  b  (nolock)  on a.party_code =b.party_Code  collate Latin1_General_CI_AS                                                                           
  --sp_help ebrok_client_access             
update #file1a set b2c='Yes' where sub_broker in (select b2c_sb from mis.remisior.dbo.b2c_sb)          
                                                                         
 select a.*,party_name from #file1a a left outer join intranet.risk.dbo.finmast b                                                                               
 on a.party_Code=b.party_code collate Latin1_General_CI_AS where isnull(a.party_code,'')<>''                
order by a.branch_cd,a.sub_broker,a.party_code                                                 
                                                  
end                                                
                                                    
if @flag<>'%'                                                    
begin                                                
 select distinct b.zone,b.region,a.branch_cd,a.sub_Broker,a.party_code, b.odin_server,                                                                        
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                   
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                                  
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                                 
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                                        
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                                 
 into #odinanywherea                                                                          
 from  #cli79 b left outer join  #mis a                                                   
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                                  
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                      
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                                                
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG)                                                                   
 group by a.party_Code,a.branch_cd,a.sub_Broker,b.zone,b.region,b.odin_server                          
                        
                                   
   select clientcode,nooflogin=count(clientcode) into #nod2 from [196.1.115.211].bidb.dbo.ebrokingfds_oct_09  
 where date>=convert(datetime,@fdate,103)   
and  date<=convert(datetime,@tdate,103)         
group by clientcode      
                                             
update  #odinanywherea set nooflogin=a.nooflogin           
FROM #nod2 A WHERE party_code=A.clientcode collate Latin1_General_CI_AS                                              
                                              
 select a.*,offline_brok=isnull(c.offline_brok,0),notd=isnull(notd,0) into #filea2 from #odinanywherea a                                                                  
 left outer join                                                                   
 (                                                                  
 select party_code,sub_broker,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok'        
,notd=count(distinct sauda_DAte)                                                                                                        
 from ebrok_tobr_period (nolock)                                                                   
 where sauda_DAte>=convert(datetime,@fdate,103) and sauda_DAte <=convert(datetime,@tdate,103)                                                                   
 --and user_Stat like @cli_stat                                                                               
 and branch_Cd like @brcode and sub_Broker like @sbcode                                                 
 group by party_code,sub_broker                                                                  
 ) c                             
 on a.party_code=c.party_code collate Latin1_General_CI_AS  and a.sub_broker=c.sub_broker                                                                
                                                            
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                                          
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-') ,b2c=convert(varchar(3),'NO')                                                                           
 into #filea1a                                                                            
 from #filea2 a left outer join ebrok_client_access b (nolock) on a.party_code=b.party_Code                                               
                                          
update #filea1a set b2c='Yes' where sub_broker in (select b2c_sb from mis.remisior.dbo.b2c_sb)          
                                             
 select a.*,party_name from #filea1a a left outer join intranet.risk.dbo.finmast b                                                                               
 on a.party_Code=b.party_code collate Latin1_General_CI_AS where isnull(a.party_code,'')<>''                  
order by a.branch_cd,a.sub_broker,a.party_code                                         
end                                                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temp_mis_ebrok_cli2
-- --------------------------------------------------
CREATE procedure temp_mis_ebrok_cli2(@fdate as varchar(11),@tdate as varchar(11),@brcode as varchar(10),@sbcode as varchar(10),@cli_stat as varchar(25),@flag as varchar(8))                                                                      
as                                                                      
set transaction isolation level read uncommitted                                                                      
set nocount on                                           
select distinct brcode=space(10),sbcode=space(10),party_Code,odin_server                                                    
into #cli79                                                     
--from ctcl.dbo.client_mast79                                                     
from vw_ebrok_client1        
--select * from vw_ebrok_client1        
                                                    
update #cli79 set brcode=b.branch_Cd,sbcode=b.sub_Broker from risk.dbo.client_details b                                                    
where #cli79.party_code=b.party_Code                                         
                                    
select * into #mis from MIS_ebroking_cli  where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                                       
and branch_Cd like @brcode                                        
 --select * from #mis   select * from #cli79                                                         
if @flag='%'                                         
 begin                                 
                                
 select distinct a.branch_cd,a.sub_Broker,a.party_code,b.odin_server,                                                       
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                                                     
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                          
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                                    
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                                
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                         
 into #odinanywhere                                                                  
 from #mis a left outer join #cli79 b                                        
 on a.party_code=b.party_Code collate Latin1_General_CI_AS                                                          
 --where sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                                       
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                                        
 group by a.party_Code,a.branch_cd,a.sub_Broker,b.odin_server                      
                                 
                                                                     
 select a.*,offline_brok=isnull(c.offline_brok,0),notd=isnull(notd,0) into #file2         
from #odinanywhere a                                                          
 left outer join                                                           
 (                                                          
 select party_code,sub_broker,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok',notd=count(distinct sauda_DAte)                                                          
 from ebrok_tobr_period (nolock)                                                           
 where sauda_DAte>=@fdate  and sauda_DAte <=@tdate                                          
 --and user_Stat like @cli_stat                                                                       
 and branch_Cd like @brcode and sub_Broker like @sbcode                                                        
 group by party_code,sub_broker                                                          
 ) c               
 on a.party_code=c.party_code collate Latin1_General_CI_AS  and a.sub_broker=c.sub_broker                                                          
                                                                       
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                                                                    
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-'),b2c=convert(varchar(3),'NO')                                                                    
into #file1a                                                                    
 from #file2  a  left outer join ebrok_client_access  b  (nolock)  on a.party_code =b.party_Code  collate Latin1_General_CI_AS                                                                   
  --sp_help ebrok_client_access     
update #file1a set b2c='Yes' where sub_broker in (select b2c_sb from mis.remisior.dbo.b2c_sb)  
                                                                 
 select a.*,party_name from #file1a a left outer join intranet.risk.dbo.finmast b                                                                       
 on a.party_Code=b.party_code collate Latin1_General_CI_AS where isnull(a.party_code,'')<>''        
order by a.branch_cd,a.sub_broker,a.party_code                                         
                                          
end                                        
                                            
if @flag<>'%'                                            
begin                                        
 select distinct a.branch_cd,a.sub_Broker,a.party_code, b.odin_server,                                                                
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                           
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                                                                          
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                                                         
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=count(nooflogin),                                                                
 active_from=(case when min(active_from)is null then '01/01/2006' else min(active_from) end)                                         
 into #odinanywherea                                                                  
 from  #cli79 b left outer join  #mis a                                           
 on a.party_code=b.party_code collate Latin1_General_CI_AS                                                          
 where-- sauda_DAte>=@fdate and sauda_DAte <=@tdate and user_Stat like @cli_stat                                                                       
 --and branch_Cd like @brcode and sub_Broker like @sbcode                                                                        
 branch_Cd IN(select BRANCH_CD from intranet.risk.dbo.BRANCH_MASTER where BRMAST_CD=@FLAG)                                                           
 group by a.party_Code,a.branch_cd,a.sub_Broker,b.odin_server                  
                
                           
                                      
                                      
 select a.*,offline_brok=isnull(c.offline_brok,0),notd=isnull(notd,0) into #filea2 from #odinanywherea a                                                          
 left outer join                                                           
 (                                                          
 select party_code,sub_broker,sum(bse_br)+Sum(nse_br)+Sum(fo_br)+sum(mcx_br)+sum(ncdex_br) as 'OffLine_Brok'
,notd=count(distinct sauda_DAte)                                                                                                
 from ebrok_tobr_period (nolock)                                                           
 where sauda_DAte>=@fdate and sauda_DAte <=@tdate                                                           
 --and user_Stat like @cli_stat                                                                       
 and branch_Cd like @brcode and sub_Broker like @sbcode                                         
 group by party_code,sub_broker                                                          
 ) c                     
 on a.party_code=c.party_code collate Latin1_General_CI_AS  and a.sub_broker=c.sub_broker                                                        
                                                    
 select a.*,bse_stat=isnull(b.bse_stat,'-'),nse_stat=isnull(b.nse_stat,'-'),fo_stat=isnull(b.fo_stat,'-'),                                  
 mcdx_stat=isnull(mcdx_stat,'-'),ncdx_stat=isnull(b.ncdx_stat,'-') ,b2c=convert(varchar(3),'NO')                                                                   
 into #filea1a                                                                    
 from #filea2 a left outer join ebrok_client_access b (nolock) on a.party_code=b.party_Code                                       
                                  
update #filea1a set b2c='Yes' where sub_broker in (select b2c_sb from mis.remisior.dbo.b2c_sb)  
                                     
 select a.*,party_name from #filea1a a left outer join intranet.risk.dbo.finmast b                                                                       
 on a.party_Code=b.party_code collate Latin1_General_CI_AS where isnull(a.party_code,'')<>''          
order by a.branch_cd,a.sub_broker,a.party_code                                 
end                                                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temp_mis_to_update
-- --------------------------------------------------
CREATE procedure temp_mis_to_update  
as  
declare @fdate as varchar(25), @tdate as varchar(25)  
--select @fdate=convert(varchar(11),min(sauda_Date)-1)+' 00:00:00',@tdate=convert(varchar(11),min(sauda_Date)-1)+' 23:59:59' from mis_to  
select @fdate=convert(varchar(11),max(sauda_DAte))+' 00:00:00',@tdate=convert(varchar(11),max(sauda_DAte))+' 23:59:59'
from Temp_Commo_date where sauda_date < (select min(sauda_DAte) from mis_to)
--print @fdate  
--print @tdate  

exec mis2 @fdate,@tdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temp_mis2_auto
-- --------------------------------------------------
create procedure temp_mis2_auto
as
declare @fdate as varchar(25),@tdate as varchar(25)
select 
@fdate=convert(varchar(11),max(sauda_date))+' 00:00:00',  
@tdate=convert(varchar(11),max(sauda_date))+' 23:59:59'
from Temp_Commo_date 
where sauda_DAte < (select min(Sauda_date) from mis_to_company where sauda_DAte >='Apr  1 2006')
exec mis2 @fdate,@tdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temp_sb
-- --------------------------------------------------
create proc temp_sb (@br_code as varchar(20))          
as

select sub_broker,Brokerage=sum(Brokerage) into #t              
from mis_to where sauda_date >= 'Apr 01 2006' and sauda_date <= 'Mar 31 2007' and              
branch_cd = @br_code group by sub_broker
              
select distinct b.Name,b.Sub_Broker,b.Branch_code,address=rtrim(ltrim(b.address1)) + ltrim(rtrim(b.address2)) + 
ltrim(rtrim(b.city)) + ltrim(rtrim(b.state)) + ltrim(rtrim(b.Zip)),b.Phone1,b.phone2,a.brokerage,Avgerage=a.brokerage/12 
from #t a left outer join risk.dbo.subbrokers b on a.sub_broker = b.sub_broker collate latin1_general_cs_as
order by brokerage desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.tempmis
-- --------------------------------------------------
create proc tempmis (@Todate  As Varchar(11), @FromDate Varchar(11))
as
begin
delete  tempg1 where  Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.test1
-- --------------------------------------------------
CREATE PROCEDURE test1
AS 
Declare 
 @@Flag cursor,
 @@loop cursor,
 @@branch_cd Varchar(10)
 --Set @@NoofTimes = 0
 Set @@Flag = Cursor for       

		Select Distinct branch_cd from level2mis order by branch_cd 
		Open @@Flag
		Fetch Next from @@Flag into @@branch_cd

	While ( @@Fetch_Status = 0 ) 
	BEGIN
	select d.branch_cd,sum(TradingPurBrok+TradingSaleBrok+DeliveryPurBrok+DeliverySaleBrok),sum(Brokerage),Percentage=sum(Brokerage)*100/sum(TradingPurBrok+TradingSaleBrok+DeliveryPurBrok+DeliverySaleBrok) from (
	select top 10 branch_cd,party_name,sum(b.Brokerage) as Brokerage, percentage= sum(b.brokerage * 100 /a.Brokerage) from 
	(SELECT Brokerage=sum(TradingPurBrok+TradingSaleBrok+DeliveryPurBrok+DeliverySaleBrok)/100000 from level2mis) a,
	(SELECT party_name,branch_cd,Brokerage=sum(TradingPurBrok+TradingSaleBrok+DeliveryPurBrok+DeliverySaleBrok)/100000 from level2mis group by branch_cd,party_name) b
	where branch_cd=@@branch_cd group by party_name,branch_cd order by Brokerage desc
	) d, level2mis

	

	group by d. branch_cd order by d.branch_cd 
	Fetch Next from @@Flag into @@branch_cd



End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TestAngelMisReports
-- --------------------------------------------------
Create PROCEDURE  TestAngelMisReports
@StatusId Varchar(15),
@StatusName Varchar(25),
@FromBranch Varchar(12),
@ToBranch Varchar(12),
@FromSubbroker Varchar(12),
@ToSubbroker Varchar(12),
@FromParty Varchar(15),
@ToParty Varchar(15),
@FromDate Varchar(11),
@ToDate Varchar(11),
@Market  Varchar(40),
@ReportType Varchar(255), 
@GroupBy Varchar(255),
@OrderBy Varchar(255)

AS

Declare
@@Sql Varchar(4000),
@TurnOverSelect1 Varchar(500),
@BrokerageSelect1 Varchar(500),
@TurnOverSelect2 Varchar(500),
@BrokerageSelect2 Varchar(500),
@@From_Year Int,
@@To_Year Int,
@@From_Month int,
@@To_Month int,
@@Q1Days Int,
@@Q2Days Int,
@@Q3Days Int,
@@Q4Days Int,
@@YearDiff Int,
@@CurrentWeek Int,
@@ThreeWeekDays Int,
@@PrevDate DateTime,
@@ThreeweekTurnover Money,
@@ThreeweekBrokerage Money,
@@ThreeweekAvgTurnover Money,
@@ThreeweekAvgBrokerage Money


Begin
     If @StatusId = 'Broker'  
     Begin
          If @Frombranch = ''
             Set @FromBranch = 'A'
          If @Tobranch = ''
             Set @ToBranch = 'ZZZZZZZZ'
 
         If @FromSubbroker = ''
             Set @FromSubbroker = 'A'
          If @ToSubbroker = ''
             Set @ToSubbroker = 'ZZZZZZZZ'
 
         If @FromParty = ''
             Set @FromParty = 'A'
          If @ToParty = ''
             Set @ToParty = 'ZZZZZZZZ'
     End
     If @StatusId = 'Branch'  
     Begin
          Set @Frombranch = @StatusName
     
          Set @Tobranch = @StatusName
  
          If @FromSubbroker = ''
             Set @FromSubbroker = 'A'

          If @ToSubbroker = ''
             Set @ToSubbroker = 'ZZZZZZZZ'
 
          If @FromParty = ''
             Set @FromParty = 'A'
          If @ToParty = ''
             Set @ToParty = 'ZZZZZZZZ'
     End

        
     SET @@From_Year  = DatePart(Year,@Fromdate)
     SET @@To_Year  = DatePart(Year,@Todate)
     SET @@YearDiff = @@To_Year - @@From_Year
     SET @@From_Month  = DatePart(Month,@Fromdate)
     SET @@To_Month  = DatePart(Month,@Todate)
     
     Select @@Prevdate = DateAdd(Day , -21,@Todate)
     --Select @@PrevDate
     --Select @FromBranch
     --Select @ToBranch
     --Select @FromSuBbroker
     --Select @ToSubbroker
     --Select @FromParty
     --Select @ToPArty

     Select @@Threeweekdays = count(Distinct Sauda_date)
     From Level1Mis 
     Where
     Sauda_date >= @@Prevdate
     And
     Sauda_date <= @Todate
     And
     Branch_cd >= @FromBranch
     And
     Branch_cd <= @ToBranch
     And
     Sub_broker >= @FromSubBroker
     And
     Sub_broker <= @ToSubBroker
     And
     Party_code >= @FromParty
     And
     Party_code <= @ToParty
     And Exchangesegment in('NSECM','BSECM','NSEFO','MCX','NCX')  

     --Select @@Threeweekdays

     --Select @MArket

     Select @@ThreeweekTurnover = Sum (TPA + TSA + DPA + DSA),@@ThreeweekAvgTurnover = Sum (TPA + TSA + DPA + DSA) /(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End), @@ThreeweekBrokerage = Sum(TPA + TSA + DPA + DSA)  , @@ThreeweekAvgBrokerage = Sum(TPA + TSA + DPA + DSA)/(Case When @@Threeweekdays = 0 Then 1 Else @@Threeweekdays End)  
     From Level1Mis 
     Where
     Sauda_date >= @@Prevdate
     And
     Sauda_date <= @Todate
     Select @@Threeweekdays = count(Distinct Sauda_date)
     From Level1Mis 
     Where
     Sauda_date >= @@Prevdate
     And
     Sauda_date <= @Todate
     And
     Branch_cd >= @FromBranch
     And
     Branch_cd <= @ToBranch
     And
     Sub_broker >= @FromSubBroker
     And
     Sub_broker <= @ToSubBroker
     And
     Party_code >= @FromParty
     And
     Party_code <= @ToParty
     And Exchangesegment in(@MArket)


     --Select @@ThreeweekTurnover ,@@ThreeweekTurnover, @@ThreeweekBrokerage, @@ThreeweekAvgBrokerage  

     Select DYear = Finyear, Q1Days,
            Q1Turnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q1AvgTurnover = Sum(Case When FinMonth between 4 And 6 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q1Days = 0 Then 1 Else Q1Days End) ,
            Q1Brokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q1AvgBrokerage = SUM((Case When FinMonth between 4 And 6 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q1Days = 0 Then 1 Else Q1Days End),
            Q2Days,
            Q2Turnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q2AvgTurnover = Sum(Case When FinMonth between 7 And 9 Then ((TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q2Days = 0 Then 1 Else Q2Days End) ,
            Q2Brokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q2AvgBrokerage = SUM((Case When FinMonth between 7 And 9 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q2Days = 0 Then 1 Else Q2Days End),
            Q3Days,            
            Q3Turnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA)) Else 0 End),
            Q3AvgTurnover = Sum(Case When FinMonth between 10 And 12 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End)/(Case When Q3Days = 0 Then 1 Else Q3Days End) ,
            Q3Brokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q3AvgBrokerage = SUM((Case When FinMonth between 10 And 12 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q3Days = 0 Then 1 Else Q3Days End),
            Q4Days,
            Q4Turnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA) ) Else 0 End) ,
            Q4AvgTurnover = Sum(Case When FinMonth between 1 And 3 Then ( (TPA + TSA + DPA + DSA)) Else 0 End)/(Case When Q4Days = 0 Then 1 Else Q4Days End) ,
            Q4Brokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End)),
            Q4AvgBrokerage = SUM((Case When FinMonth between 1 And 3 Then ((TPB + TSB + DPB + DSB)) Else 0 End))/(Case When Q4Days = 0 Then 1 Else Q4Days End),
            ThreeweekTo = @@ThreeweekTurnover,ThreweekAvgTo = @@ThreeweekAvgTurnover, ThreeweekBrok = @@Threeweekbrokerage, ThreeweekAvgBrok = @@ThreeweekAvgbrokerage
            From Level1Mis With (Index(ExchangeDate)),( Select FinYear1 = Finyear,
                      Q1Days = Sum(Case When FinMonth between 4 And 6 Then NoDays Else 0 End),
                      Q2Days = Sum(Case When FinMonth between 7 And 9 Then NoDays Else 0 End),
                      Q3Days = Sum(Case When FinMonth between 10 And 12 Then NoDays Else 0 End),
                      Q4Days = Sum(Case When FinMonth between 1 And 3 Then NoDays Else 0 End)
                      From  
                     ( Select Finyear ,FinMonth ,NoDays = Count(Distinct Sauda_date)
                       From Level1Mis  
                       Where Sauda_date >= @FromDate
                       And
                       Sauda_date <= @Todate
                       --And
                       --Branch_cd >= @FromBranch
                       --And
                       --Branch_cd <= @ToBranch
                       --And
                       --Sub_broker >= @FromSubBroker
                       --And
                       --Sub_broker <= @ToSubBroker
                       --And
                       --Party_code >= @FromParty
                       --And
                       --Party_code <= @ToParty
                       --And Exchangesegment in(@MArket)
                       --And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
                       Group By FinYEar,FinMonth ) CountDays
                       Group By FinYear 
                     )QDays
     Where 
     Sauda_date >= @FromDate
     And
     Sauda_date <= @Todate
     And
     FinYear = FinYear1      
     And
     Branch_cd >= @FromBranch
     And
     Branch_cd <= @ToBranch
     And
     Sub_broker >= @FromSubBroker
     And
     Sub_broker <= @ToSubBroker
     And
     Party_code >= @FromParty
     And
     Party_code <= @ToParty
     And Exchangesegment in('BSECM','NSECM','NSEFO','NCX','MCX')
     Group By Finyear,Q1Days,Q2Days,Q3Days,Q4Days
     Order By Finyear
--Select * from level6fyearmis
--EXEC AngelMisReports 'BROKER','','','','Apr  1 2001','Dec 31 2005','','',''

--select Top 10 * from level1mis where Finyear = '3009'
--Exec AngelMisReports 'Broker','BBG','','','','','','','APR  1 2001','DEC  8 2005','''NSECM'',''BSECM'',''NSEFO'',''MCX'',''NCX''','','',''
--Table 'Level1Mis'. Scan count 40, logical reads 1591122, physical reads 42134, read-ahead reads 3314.
--Table 'Level1Mis'. Scan count 40, logical reads 1591138, physical reads 12136, read-ahead reads 2418.

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TestspBranchBrok
-- --------------------------------------------------
CREATE     
Procedure TestspBranchBrok
(  
 @Sauda_Date varchar(50)
)  
  
As  

Begin  
  

 Select  
  [Branch Code] = IsNull(Branch_cd, '--'),  
  [Branch] = RTrim(IsNull((Select tradername From Risk.dbo.Branch Where sbtag=branch_cd),'--')),  
  [BSE Brok] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NSE Brok] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [FO Brok] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end),0),
  [MCX Brok] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [NCDEX Brok] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end),0),  
  [Total Brok] = IsNull(Sum(TPB+DPB+TSB+DSB),0),  

  [Daily TO] = 

	IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0) + 
	IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),

	[Net Brok Yield %] =

	(
		isnull(sum(tpb+dpb+tsb+dsb), 0) /
		(
			case
				when
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				> 0
				then
				(
					isnull(sum(case when exchangesegment='BSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSECM' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NSEFO' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='MCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0) +
					isnull(sum(case when exchangesegment='NCX' and tradetype = 'BT' then tpa+dpa+tsa+dsa else 0 end),0)
				)
				else
				 1
				end
		)
	)
	* 100,


  [Alert] = IsNull((Case When (MBrok)<=Sum(TPB+DPB+TSB+DSB) Then 'High' Else Null End),IsNull((Case When (Mbrok)>=Sum(TPB+DPB+TSB+DSB) Then 'Low' Else Null End),'...')), 
  [BSE Daily TO] = IsNull(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [BSE Brok %] = (Sum(case when ExchangeSegment='BSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [NSE Daily TO] = IsNull(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NSE Brok %] = (Sum(case when ExchangeSegment='NSECM' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [FO Daily TO] = IsNull(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),
  [FO Brok %] = (Sum(case when ExchangeSegment='NSEFO' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='NSEFO' Then TPA+DPA+TSA+DSA else 1 end)))*100,
  [MCX Daily TO] = IsNull(Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [MCX Brok %] = (Sum(case when ExchangeSegment='MCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100,  
  [NCDEX Daily TO] = IsNull(Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPA+DPA+TSA+DSA else 0 end)/10000000,0),  
  [NCDEX Brok %] = (Sum(case when ExchangeSegment='NCX' And TradeType = 'BT' Then TPB+DPB+TSB+DSB else 0 end)/(Sum(case when ExchangeSegment='BSECM' Then TPA+DPA+TSA+DSA else 1 end)))*100  
 From  
  Level1mis L1,( Select Abranch_cd = Branch_cd,Mbrok = Max(TotalBrok) From (
                 Select  Branch_Cd,Sauda_date, TotalBrok = IsNull(Sum(TPB+DPB+TSB+DSB),0) From level1mis Where
                 Sauda_Date < @Sauda_Date + ' 23:59:00'
                 Group by Branch_Cd,Sauda_date) A
                 Group By Branch_Cd )BrokTop
 Where  
	Sauda_Date  = @Sauda_Date + ' 23:59:00'
        And L1.Branch_Cd = BrokTop.Abranch_Cd
 Group By  
  Branch_cd  ,Mbrok 
 Order By  
  Branch
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tnewupdbilltaxafterbill
-- --------------------------------------------------

CREATE proc Tnewupdbilltaxafterbill (@SETTNO VARCHAR(7),@SETTYPE VARCHAR(2),@Party_code Varchar(10),@Scrip_cd varchar(12)) as
Declare
@@TerminalNo Varchar(20),
@@Table_no Smallint,
@@Sub_tableNo SmallInt,
@@P_To_P SmallInt,
@@Sb_TableNo SmallInt,
@@AlBmCf_Tableno Smallint,
@@Brok_Scheme Smallint,
@@StartDate DateTime

Select @@StartDate = Start_date from sett_mst where 
Sett_type = @Settype
and
Sett_no = @Settno

Select Distinct @@TerminalNo = Terminalnumber,@@Brok_Scheme=BrokScheme,@@Table_no=Table_no,@@Sub_TableNo = Sub_TableNo,@@P_To_P = P_To_P,@@Sb_TableNo = Sb_TableNo,@@AlBmCf_TableNo = AlBmCf_TableNo 
from AngelTermBrok where
Party_code = @Party_Code
and FromDate <= @@StartDate
and ToDate >= @@StartDate

Select  @@TerminalNo ,@@Brok_Scheme,@@Table_no,@@Sub_TableNo,@@P_To_P,@@Sb_TableNo,@@AlBmCf_TableNo 

if @settype <> 'C' 
begin
update settlement set
 tmark = 'D',
      NBrokApp = (  case  
    when (  broktable.val_perc ='V' )
                             Then 
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
          BrokApplied 
                        End 
                         ),
       N_NetRate = (  case  
                      when (  broktable.val_perc ='V' AND settlement.SELL_BUY = 1)
                             Then
                                  settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                      when (  broktable.val_perc ='P' AND settlement.SELL_BUY = 1 )
                             Then settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                      when (broktable.val_perc ='V' AND settlement.SELL_BUY =2 )
                             Then settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                      when ( broktable.val_perc ='P' AND settlement.SELL_BUY = 2 )
                             Then   
                      settlement.marketrate - ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
             NetRate 
                        End 
                         ),/*modified by bhayashree on 27-12-2000*/
        NSertax = (case  
   when ( broktable.val_perc ='V' ) Then
    		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (broktable.val_perc ='P' )
                           Then                                       ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

   Else  
       settlement.Service_tax
                        End 
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + settlement.service_tax)  END )*/,
Ins_chrg  =(Case
		when settlement.status = 'N' then 0
			else ((taxes.insurance_chrg * settlement.marketrate * settlement.Tradeqty)/100) End), 
turn_tax  = (Case
		when settlement.status = 'N' then 0
			else ((taxes.turnover_tax * settlement.marketrate * settlement.Tradeqty)/100 ) end),              
other_chrg =(Case
		when settlement.status = 'N' then 0
			else ((taxes.other_chrg * settlement.marketrate * settlement.Tradeqty)/100 ) end), 
sebi_tax = (Case
		when settlement.status = 'N' then 0
			else ((taxes.sebiturn_tax * settlement.marketrate * settlement.Tradeqty)/100) end),              
Broker_chrg =(Case
		when settlement.status = 'N' then 0
else ((taxes.broker_note * settlement.marketrate * settlement.Tradeqty)/100) end)                                                  
      FROM BrokTable BrokTable,Client2 client2,taxes taxes,globals, Client1  
      WHERE 
            settlement.Party_Code = Client2.Party_code
            And Client2.cl_code = Client1.Cl_code 
   And Broktable.Table_no = (Case When (Settlement.tmark = 'D' and client2.Tran_cat = 'TRD') 
					     Then @@sub_tableno  	
					     Else ( case when Settlement.TMARK ='V' 
					        	 Then @@P_To_P
							 Else ( Case When Settlement.tmark = 'S' 
					    			     Then @@Sb_TableNo	
					    			     Else ( Case When Settlement.tmark = 'C'  	
						           			 Then @@AlbmCF_tableno
										 Else @@SUB_TABLENO 
									    End )
					    		        End )
				       		   End )		
					End )
            And 
               Broktable.Line_no = 
                ( case 
                                      		when (client2.Tran_cat = 'TRD')	 then 
					   (Select min(Broktable.line_no) from broktable where
		                                 	  Broktable.table_no = @@Sub_TableNo
					 and Trd_Del = 'D'
                                                  		 and settlement.Party_Code =  Client2.Party_code   	
		                                 	  and settlement.marketrate <= Broktable.upper_lim )				    
		end)               
  And
	taxes.trans_Cat =(case when client1.cl_type = 'PRO' then 'PRO' else  'del' end)
           And
             (taxes.exchange = 'BSE')             
           And
             (Globals.exchange = 'BSE')             

/* and settlement.scrip_Cd  not in(select scrip_cd from nodel  where sett_no = @SettNo and sett_type = @Settype) */
 AND SETTLEMENT.SETT_NO = @SETTNO 
 AND SETTLEMENT.SETT_TYPE = @SETTYPE
and settlement.billflag in(4,5) 
and settlement.status <> 'E'
and settlement.party_code = @party_code
and settlement.scrip_cd = @Scrip_cd
and settlement.Trade_no not like '%C%'
And Sauda_date > Globals.year_start_dt
And Sauda_date < Globals.year_end_dt
And User_id  = @@TerminalNo
end
else if @settype = 'C' 
begin
update settlement set
 tmark = 'D',
      NBrokApp = (  case  
    when (  broktable.val_perc ='V' )
                             Then 
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
          BrokApplied 
                        End 
                         ),
       N_NetRate = (  case  
                      when (  broktable.val_perc ='V' AND settlement.SELL_BUY = 1)
                             Then
                                  settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                      when (  broktable.val_perc ='P' AND settlement.SELL_BUY = 1 )
                             Then settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                      when (broktable.val_perc ='V' AND settlement.SELL_BUY =2 )
                             Then settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                      when ( broktable.val_perc ='P' AND settlement.SELL_BUY = 2 )
                             Then   
                      settlement.marketrate - ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
             NetRate 
                        End 
                         ),/*modified by bhayashree on 27-12-2000*/
        NSertax = (case  
   when ( broktable.val_perc ='V' ) Then
    		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (broktable.val_perc ='P' )
                           Then                                       ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

   Else  
       settlement.Service_tax
                        End 
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + settlement.service_tax)  END )*/,
Ins_chrg  =(Case
		when settlement.status = 'N' then 0
			else ((taxes.insurance_chrg * settlement.marketrate * settlement.Tradeqty)/100) End), 
turn_tax  = (Case
		when settlement.status = 'N' then 0
			else ((taxes.turnover_tax * settlement.marketrate * settlement.Tradeqty)/100 ) end),              
other_chrg =(Case
		when settlement.status = 'N' then 0
			else ((taxes.other_chrg * settlement.marketrate * settlement.Tradeqty)/100 ) end), 
sebi_tax = (Case
		when settlement.status = 'N' then 0
			else ((taxes.sebiturn_tax * settlement.marketrate * settlement.Tradeqty)/100) end),              
Broker_chrg =(Case
		when settlement.status = 'N' then 0
else ((taxes.broker_note * settlement.marketrate * settlement.Tradeqty)/100) end)                                                  
                                                  
      FROM BrokTable BrokTable,Client2 client2,taxes taxes,globals, Client1
      WHERE 
            settlement.Party_Code = Client2.Party_code
            And Client1.Cl_code = Client2.Cl_code
            And Broktable.Table_no = ( Case When (Settlement.tmark = 'D' and client2.Tran_cat = 'TRD') 
					     Then @@sub_tableno  	
					     Else ( case when Settlement.TMARK ='V' 
					        	 Then @@P_To_P
							 Else ( Case When Settlement.tmark = 'S' 
					    			     Then @@Sb_TableNo	
					    			     Else ( Case When Settlement.tmark = 'C'  	
						           			 Then @@AlbmCF_tableno
										 Else @@SUB_TABLENO 
									    End )
					    		        End )
				       		   End )		
					End )
             And 
               Broktable.Line_no = 
                ( case 
                                      		when (client2.Tran_cat = 'TRD')	 then 
					   (Select min(Broktable.line_no) from broktable where
		                                 	  Broktable.table_no = @@Sub_TableNo
					 and Trd_Del = 'D'
                                                  		 and settlement.Party_Code =  Client2.Party_code   	
		                                 	  and settlement.marketrate <= Broktable.upper_lim )				    
		end)               
  And

	taxes.trans_Cat =(case when client1.cl_type = 'PRO' then 'PRO' else  'del' end) /* added by bhagyashree on 7-11-2001*/ /*modified on 20-12-2001*/

           And
             (taxes.exchange = 'BSE')             
           And
             (Globals.exchange = 'BSE')             
/* and settlement.scrip_Cd  not in(select scrip_cd from nodel  where  sett_no = @Settno and sett_type = @settype) */
AND SETTLEMENT.SETT_NO = @SETTNO 
AND SETTLEMENT.SETT_TYPE = @SETTYPE
and settlement.billflag in(4,5) 
and settlement.status <> 'E'
and settlement.party_code = @party_code
and settlement.scrip_cd = @Scrip_cd
and settlement.Trade_no not like '%C%'
And Sauda_date > Globals.year_start_dt
And Sauda_date < Globals.year_end_dt
And User_id  = @@TerminalNo
end

--Now We will apply the brokerage for normal


Select Distinct @@Brok_Scheme=Brok_Scheme,@@Table_no=Table_no,@@Sub_TableNo = Sub_TableNo,@@P_To_P = P_To_P,@@Sb_TableNo = Sb_TableNo,@@AlBmCf_TableNo = AlBmCf_TableNo 
from Client2  where
Party_code = @Party_Code

Select  @@Brok_Scheme,@@Table_no,@@Sub_TableNo,@@P_To_P,@@Sb_TableNo,@@AlBmCf_TableNo 


if @settype <> 'C' 
begin
update settlement set
 tmark = 'D',
      NBrokApp = (  case  
    when (  broktable.val_perc ='V' )
                             Then 
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
          BrokApplied 
                        End 
                         ),
       N_NetRate = (  case  
                      when (  broktable.val_perc ='V' AND settlement.SELL_BUY = 1)
                             Then
                                  settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                      when (  broktable.val_perc ='P' AND settlement.SELL_BUY = 1 )
                             Then settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                      when (broktable.val_perc ='V' AND settlement.SELL_BUY =2 )
                             Then settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                      when ( broktable.val_perc ='P' AND settlement.SELL_BUY = 2 )
                             Then   
                      settlement.marketrate - ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
             NetRate 
                        End 
                         ),/*modified by bhayashree on 27-12-2000*/
        NSertax = (case  
   when ( broktable.val_perc ='V' ) Then
    		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (broktable.val_perc ='P' )
                           Then                                       ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

   Else  
       settlement.Service_tax
                        End 
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + settlement.service_tax)  END )*/,
Ins_chrg  =(Case
		when settlement.status = 'N' then 0
			else ((taxes.insurance_chrg * settlement.marketrate * settlement.Tradeqty)/100) End), 
turn_tax  = (Case
		when settlement.status = 'N' then 0
			else ((taxes.turnover_tax * settlement.marketrate * settlement.Tradeqty)/100 ) end),              
other_chrg =(Case
		when settlement.status = 'N' then 0
			else ((taxes.other_chrg * settlement.marketrate * settlement.Tradeqty)/100 ) end), 
sebi_tax = (Case
		when settlement.status = 'N' then 0
			else ((taxes.sebiturn_tax * settlement.marketrate * settlement.Tradeqty)/100) end),              
Broker_chrg =(Case
		when settlement.status = 'N' then 0
else ((taxes.broker_note * settlement.marketrate * settlement.Tradeqty)/100) end)                                                  
      FROM BrokTable BrokTable,Client2 client2,taxes taxes,globals, Client1  
      WHERE 
            settlement.Party_Code = Client2.Party_code
            And Client2.cl_code = Client1.Cl_code 
   And Broktable.Table_no = (Case When (Settlement.tmark = 'D' and client2.Tran_cat = 'TRD') 
					     Then @@sub_tableno  	
					     Else ( case when Settlement.TMARK ='V' 
					        	 Then @@P_To_P
							 Else ( Case When Settlement.tmark = 'S' 
					    			     Then @@Sb_TableNo	
					    			     Else ( Case When Settlement.tmark = 'C'  	
						           			 Then @@AlbmCF_tableno
										 Else @@SUB_TABLENO 
									    End )
					    		        End )
				       		   End )		
					End )
            And 
               Broktable.Line_no = 
                ( case 
                                      		when (client2.Tran_cat = 'TRD')	 then 
					   (Select min(Broktable.line_no) from broktable where
		                                 	  Broktable.table_no = @@Sub_TableNo
					 and Trd_Del = 'D'
                                                  		 and settlement.Party_Code =  Client2.Party_code   	
		                                 	  and settlement.marketrate <= Broktable.upper_lim )				    
		end)               
  And
	taxes.trans_Cat =(case when client1.cl_type = 'PRO' then 'PRO' else  'del' end)
           And
             (taxes.exchange = 'BSE')             
           And
             (Globals.exchange = 'BSE')             

/* and settlement.scrip_Cd  not in(select scrip_cd from nodel  where sett_no = @SettNo and sett_type = @Settype) */
 AND SETTLEMENT.SETT_NO = @SETTNO 
 AND SETTLEMENT.SETT_TYPE = @SETTYPE
and settlement.billflag in(4,5) 
and settlement.status <> 'E'
and settlement.party_code = @party_code
and settlement.scrip_cd = @Scrip_cd
and settlement.Trade_no not like '%C%'
And Sauda_date > Globals.year_start_dt
And Sauda_date < Globals.year_end_dt
And User_id  <> @@TerminalNo
end
else if @settype = 'C' 
begin
update settlement set
 tmark = 'D',
      NBrokApp = (  case  
    when (  broktable.val_perc ='V' )
                             Then 
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
          BrokApplied 
                        End 
                         ),
       N_NetRate = (  case  
                      when (  broktable.val_perc ='V' AND settlement.SELL_BUY = 1)
                             Then
                                  settlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                      when (  broktable.val_perc ='P' AND settlement.SELL_BUY = 1 )
                             Then settlement.marketrate + ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))

                      when (broktable.val_perc ='V' AND settlement.SELL_BUY =2 )
                             Then settlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                      when ( broktable.val_perc ='P' AND settlement.SELL_BUY = 2 )
                             Then   
                      settlement.marketrate - ((floor(( (((broktable.Normal /100 )* settlement.marketrate)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  
             NetRate 
                        End 
                         ),/*modified by bhayashree on 27-12-2000*/
        NSertax = (case  
   when ( broktable.val_perc ='V' ) Then
    		( ( ((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (broktable.val_perc ='P' )
                           Then                                       ((    ((floor ( (((broktable.Normal /100 ) * settlement.marketrate)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) ) * ( settlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

   Else  
       settlement.Service_tax
                        End 
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + settlement.service_tax)  END )*/,
Ins_chrg  =(Case
		when settlement.status = 'N' then 0
			else ((taxes.insurance_chrg * settlement.marketrate * settlement.Tradeqty)/100) End), 
turn_tax  = (Case
		when settlement.status = 'N' then 0
			else ((taxes.turnover_tax * settlement.marketrate * settlement.Tradeqty)/100 ) end),              
other_chrg =(Case
		when settlement.status = 'N' then 0
			else ((taxes.other_chrg * settlement.marketrate * settlement.Tradeqty)/100 ) end), 
sebi_tax = (Case
		when settlement.status = 'N' then 0
			else ((taxes.sebiturn_tax * settlement.marketrate * settlement.Tradeqty)/100) end),              
Broker_chrg =(Case
		when settlement.status = 'N' then 0
else ((taxes.broker_note * settlement.marketrate * settlement.Tradeqty)/100) end)                                                  
                                                  
      FROM BrokTable BrokTable,Client2 client2,taxes taxes,globals, Client1
      WHERE 
            settlement.Party_Code = Client2.Party_code
            And Client1.Cl_code = Client2.Cl_code
            And Broktable.Table_no = ( Case When (Settlement.tmark = 'D' and client2.Tran_cat = 'TRD') 
					     Then @@sub_tableno  	
					     Else ( case when Settlement.TMARK ='V' 
					        	 Then @@P_To_P
							 Else ( Case When Settlement.tmark = 'S' 
					    			     Then @@Sb_TableNo	
					    			     Else ( Case When Settlement.tmark = 'C'  	
						           			 Then @@AlbmCF_tableno
										 Else @@SUB_TABLENO 
									    End )
					    		        End )
				       		   End )		
					End )
             And 
               Broktable.Line_no = 
                ( case 
                                      		when (client2.Tran_cat = 'TRD')	 then 
					   (Select min(Broktable.line_no) from broktable where
		                                 	  Broktable.table_no = @@Sub_TableNo
					 and Trd_Del = 'D'
                                                  		 and settlement.Party_Code =  Client2.Party_code   	
		                                 	  and settlement.marketrate <= Broktable.upper_lim )				    
		end)               
  And

	taxes.trans_Cat =(case when client1.cl_type = 'PRO' then 'PRO' else  'del' end) /* added by bhagyashree on 7-11-2001*/ /*modified on 20-12-2001*/

           And
             (taxes.exchange = 'BSE')             
           And
             (Globals.exchange = 'BSE')             
/* and settlement.scrip_Cd  not in(select scrip_cd from nodel  where  sett_no = @Settno and sett_type = @settype) */
AND SETTLEMENT.SETT_NO = @SETTNO 
AND SETTLEMENT.SETT_TYPE = @SETTYPE
and settlement.billflag in(4,5) 
and settlement.status <> 'E'
and settlement.party_code = @party_code
and settlement.scrip_cd = @Scrip_cd
and settlement.Trade_no not like '%C%'
And Sauda_date > Globals.year_start_dt
And Sauda_date < Globals.year_end_dt
And User_id  <>  @@TerminalNo
end


Update Settlement Set nbrokapp = Brokapplied , Nsertax = Service_Tax from Settlement S , Nodel N
Where N.sett_no = @Settno
And N.Scrip_cd = S.Scrip_cd 
And S.Sett_no = N.Sett_no
And S.Party_code = @Party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.total_GN
-- --------------------------------------------------
CREATE procedure total_GN(@fdate as varchar(11), @tdate as varchar(11))    
as  
set nocount on  
   

/*CREATE TABLE GN_total (totcg money,totcn money,totlg money,totln money)
declare @fdate as varchar(25)    
declare @tdate as varchar(25)    
set @fdate ='Feb 18 2006'
set @tdate ='Feb 24 2006'    
*/
DECLARE  @branch_cd varchar,
@ncurrgross_perday money,
--@mcurrgross_prday money,
@mcurrgross_perday money,
@nlastgross_perday money,@mlastgross_perday money,
@nlastnet_aperday money,@mlastnet_aperday money,
@ncurrnet_perday money,@mcurrnet_perday money,
@totcg money,@totcn money,@totln money,@totlg money,
@NGcurrRT money,@MGcurrRT money,
@nlastrt money,@mlastrt money,
@NNlast money,@MNlast money,
@NNcurr money,@MNcurr money
SET @NGcurrRT = 0
set @MGcurrRT=0
set @NlastRT=0
set @MlastRT=0
set @NNlast=0
set @MNlast=0
set @NNcurr=0
set @MNcurr=0

set @totcg=0
set @totcn=0
set @totln=0
set @totlg=0

DECLARE rt_cursor CURSOR
FOR

select a.branch_Cd, 
ncurrgross_perday= isnull(convert(money,sum(ncdx_brok)/5.5),0),mcurrgross_perday= isnull(convert(money,sum(mcdx_brok)/5.5),0) ,
ncurrnet_perday= isnull(convert(money,sum(ncdx_ashare)/5.5),0),mcurrnet_perday= isnull(convert(money,sum(mcdx_ashare)/5.5),0) ,
Nlastgross_perday=isnull(b.Ngross_perday,0),Mlastgross_perday=isnull(b.Mgross_perday,0),
Nlastnet_aperday=isnull(b.Nnet_aperday,0),Mlastnet_aperday=isnull(b.Mnet_aperday,0)

from commo_perf_eval a left outer join 
(select branch_cd, 
Ngross_perday= sum(ncdx_brok)/5.5,Mgross_perday= sum(mcdx_brok)/5.5,
Nnet_aperday=sum(ncdx_ashare)/5.5,Mnet_aperday=sum(mcdx_ashare)/5.5 
from commo_perf_eval where
tdate>=(convert(datetime,@fdate)-7) and tdate<=(convert(datetime,@fdate)-1)
group by branch_cd ) b on a.branch_cd=b.branch_cd where tdate>=@fdate and tdate<=@tdate
group by a.branch_cd,branch_name,Ngross_perday,Mgross_perday,Nnet_aperday,Mnet_aperday


OPEN rt_cursor

FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday
,@Nlastgross_perday,@Mlastgross_perday
,@Nlastnet_aperday,@Mlastnet_aperday

WHILE @@FETCH_STATUS = 0

BEGIN
 SET @NGcurrRT = @NGcurrRT + @ncurrgross_perday
 SET @MGcurrRT = @MGcurrRT +@mcurrgross_perday
 set @totcg=@NGcurrRT+@MGcurrRT

set @NNcurr=@NNcurr+@ncurrnet_perday
set @MNcurr=@MNcurr+@mcurrnet_perday
set @totcn=@NNcurr+@MNcurr

set @NlastRT=@NlastRT+@nlastgross_perday
set @MlastRT=@MlastRT+@mlastgross_perday
set @totlg=@NlastRT+@MlastRT

set @NNlast=@NNlast+@nlastnet_aperday
set @MNlast=@MNlast+@mlastnet_aperday
set @totln=@NNlast+@MNlast


---drop table GN_total  
--INSERT GN_total VALUES (@totcg,@totcn,@totlg,@totln)

FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday,
@Nlastgross_perday,@Mlastgross_perday,@Nlastnet_aperday,@Mlastnet_aperday
END
select totcg=@totcg,totcn=@totcn,totlg=@totlg,totln=@totln
CLOSE rt_cursor

DEALLOCATE rt_cursor

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.total_GN1
-- --------------------------------------------------

CREATE procedure total_GN1(@fdate as varchar(11), @tdate as varchar(11))      
as    
set nocount on    
     
  
/*CREATE TABLE GN_total (totcg money,totcn money,totlg money,totln money)  
declare @fdate as varchar(25)      
declare @tdate as varchar(25)      
set @fdate ='Feb 18 2006'  
set @tdate ='Feb 24 2006'      
*/  
DECLARE  @branch_cd varchar,  
@ncurrgross_perday money,  
--@mcurrgross_prday money,  
@mcurrgross_perday money,  
@nlastgross_perday money,@mlastgross_perday money,  
@nlastnet_aperday money,@mlastnet_aperday money,  
@ncurrnet_perday money,@mcurrnet_perday money,  
@totcg money,@totcn money,@totln money,@totlg money,  
@NGcurrRT money,@MGcurrRT money,  
@nlastrt money,@mlastrt money,  
@NNlast money,@MNlast money,  
@NNcurr money,@MNcurr money  
SET @NGcurrRT = 0  
set @MGcurrRT=0  
set @NlastRT=0  
set @MlastRT=0  
set @NNlast=0  
set @MNlast=0  
set @NNcurr=0  
set @MNcurr=0  
  
set @totcg=0  
set @totcn=0  
set @totln=0  
set @totlg=0  
  
DECLARE rt_cursor CURSOR  
FOR  
  
select a.branch_Cd,   
ncurrgross_perday= isnull(convert(money,sum(ncdx_brok)/5.5),0),mcurrgross_perday= isnull(convert(money,sum(mcdx_brok)/5.5),0) ,  
ncurrnet_perday= isnull(convert(money,sum(ncdx_ashare)/5.5),0),mcurrnet_perday= isnull(convert(money,sum(mcdx_ashare)/5.5),0) ,  
Nlastgross_perday=isnull(b.Ngross_perday,0),Mlastgross_perday=isnull(b.Mgross_perday,0),  
Nlastnet_aperday=isnull(b.Nnet_aperday,0),Mlastnet_aperday=isnull(b.Mnet_aperday,0)  
  
from commo_perf_eval a left outer join   
(select branch_cd,   
Ngross_perday= sum(ncdx_brok)/5.5,Mgross_perday= sum(mcdx_brok)/5.5,  
Nnet_aperday=sum(ncdx_ashare)/5.5,Mnet_aperday=sum(mcdx_ashare)/5.5   
from commo_perf_eval where  
tdate>=(convert(datetime,@fdate)-datediff(dw,@fdate,@tdate)) and tdate<=(convert(datetime,@fdate)+datediff(dw,@fdate,@tdate))  
group by branch_cd ) b on a.branch_cd=b.branch_cd where tdate>=@fdate and tdate<=@tdate  
group by a.branch_cd,branch_name,Ngross_perday,Mgross_perday,Nnet_aperday,Mnet_aperday  
  
  
OPEN rt_cursor  
  
FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday  
,@Nlastgross_perday,@Mlastgross_perday  
,@Nlastnet_aperday,@Mlastnet_aperday  
  
WHILE @@FETCH_STATUS = 0  
  
BEGIN  
 SET @NGcurrRT = @NGcurrRT + @ncurrgross_perday  
 SET @MGcurrRT = @MGcurrRT +@mcurrgross_perday  
 set @totcg=@NGcurrRT+@MGcurrRT  
  
set @NNcurr=@NNcurr+@ncurrnet_perday  
set @MNcurr=@MNcurr+@mcurrnet_perday  
set @totcn=@NNcurr+@MNcurr  
  
set @NlastRT=@NlastRT+@nlastgross_perday  
set @MlastRT=@MlastRT+@mlastgross_perday  
set @totlg=@NlastRT+@MlastRT  
  
set @NNlast=@NNlast+@nlastnet_aperday  
set @MNlast=@MNlast+@mlastnet_aperday  
set @totln=@NNlast+@MNlast  
  
  
---drop table GN_total    
--INSERT GN_total VALUES (@totcg,@totcn,@totlg,@totln)  
  
FETCH NEXT FROM rt_cursor INTO @branch_cd,@ncurrgross_perday,@mcurrgross_perday,@ncurrnet_perday,@mcurrnet_perday,  
@Nlastgross_perday,@Mlastgross_perday,@Nlastnet_aperday,@Mlastnet_aperday  
END  
select totcg=@totcg,totcn=@totcn,totlg=@totlg,totln=@totln  
CLOSE rt_cursor  
  
DEALLOCATE rt_cursor  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TotBrok_NetBrok
-- --------------------------------------------------
CREATE Procedure TotBrok_NetBrok(@fdate as varchar(25),@tdate as varchar(25),@user as varchar(10),@code as varchar(10),@BrOrSB as varchar(8),@flag as varchar(1))              
as      
    
set nocount on    
            
if @BrOrSB<>'%' and @flag='B'              
BEGIN     
select branch_cd,sub_broker,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0),             
br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to
  
    
+fo_to+mcx_to+ncdex_to+ebrok_to),0)        
into #filea          
  from ebrok_tobr_period (nolock)              
 where sauda_date>=@fdate and sauda_date<=@tdate and branch_cd=@BrOrSB              
 group by branch_cd,sub_broker     
     
select  branch,subbrokcode,              
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),              
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),              
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),              
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),              
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),            
 Net=sum(case when segment='ABLCM' or segment='ACDLCM' or segment='ACDLFO' or segment='ACPLMCX' or segment='ACPLNCDX' then angel_share else 0 end)     
into #fileb              
 from mis.remisior.dbo.comb_sb where sauda_date>=@fdate and sauda_date<=@tdate              
 and branch=@BrOrSB              
 group by branch,subbrokcode    
            
 select a.*,angel_net_bse=isnull(angel_net_bse,0),angel_net_nse=isnull(angel_net_nse,0),angel_net_fo=isnull(angel_net_fo,0),angel_net_mcx=isnull(angel_net_mcx,0),angel_net_ncx=isnull(angel_net_ncx,0),Net=isnull(Net,0)              
  from              
 #filea a              
 left outer join              
 #fileb b              
 on  a.branch_cd=b.branch and a.sub_broker=b.subbrokcode order by branch_cd,sub_broker              
              
END              
if @BrOrSB<>'%' and @flag='S'              
BEGIN     
    
select branch_cd,sub_broker,party_code,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), 
total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)     
into #filea1             
  from ebrok_tobr_period (nolock)              
 where sauda_date>=@fdate and sauda_date<=@tdate and sub_broker=@BrOrSB              
 group by branch_cd,sub_broker,party_code --order by branch_cd       
       
 select  branch,subbrokcode,party_code,              
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),              
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),              
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),              
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),              
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),            
  Net=sum(case when segment='ABLCM' or segment='ACDLCM' or segment='ACDLFO' or segment='ACPLMCX' or segment='ACPLNCDX' then angel_share else 0 end)     
into #fileb1               
 from mis.remisior.dbo.comb_cli where sauda_date>=@fdate and sauda_date<=@tdate              
 and subbrokcode=@BrOrSB              
 group by branch,subbrokcode,party_code    
          
 select a.*,angel_net_bse=isnull(angel_net_bse,0),angel_net_nse=isnull(angel_net_nse,0),angel_net_fo=isnull(angel_net_fo,0),angel_net_mcx=isnull(angel_net_mcx,0),angel_net_ncx=isnull(angel_net_ncx,0),Net=isnull(Net,0)              
  from              
 #filea1 a              
 left outer join              
 #fileb1 b              
 on  a.party_code=b.party_code collate Latin1_General_CI_AS order by party_code              
 end           
          
if @BrOrSB<>'%' and @flag='O'                
BEGIN     
    
select sauda_date,branch_cd,sub_broker,party_code,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0),            
 total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)     
into #file1               
  from ebrok_tobr_period (nolock)                
 where sauda_date>=@fdate and sauda_date<=@tdate and branch_cd=@BrOrSB                
 group by sauda_date,branch_cd,sub_broker,party_code    
               
select  sauda_date,branch,subbrokcode,party_code,              
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),                
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),                
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),                
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),                
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),              
  Net=sum(case when segment='ABLCM' or segment='ACDLCM' or segment='ACDLFO' or segment='ACPLMCX' or segment='ACPLNCDX' then angel_share else 0 end)    
into #file2               
 from mis.remisior.dbo.comb_cli where sauda_date>=@fdate and sauda_date<=@tdate                
 and branch=@BrOrSB                
 group by sauda_date,branch,subbrokcode,party_code    
    
 select a.*,angel_net_bse=isnull(angel_net_bse,0),angel_net_nse=isnull(angel_net_nse,0),angel_net_fo=isnull(angel_net_fo,0),angel_net_mcx=isnull(angel_net_mcx,0),angel_net_ncx=isnull(angel_net_ncx,0),Net=isnull(Net,0)                   
  from                
  #file1           
  a                
 left outer join                
 #file2 b                
 on  a.party_code=b.party_code collate Latin1_General_CI_AS and a.sauda_date=b.sauda_date  order by party_code                
                
END               
             
if @user='BROKER' and @BrOrSB='%'              
BEGIN              
select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), 
total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)     
INTO #FILEA44            
  from ebrok_tobr_period (nolock)              
 where sauda_date>=@fdate and sauda_date<=@tdate              
 group by branch_cd --order by branch_cd           
    
select  branch,              
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),              
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),              
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),              
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),              
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),            
 Net=sum(case when segment='ABLCM' or segment='ACDLCM' or segment='ACDLFO' or segment='ACPLMCX' or segment='ACPLNCDX' then angel_share else 0 end)    
INTO  #FILEB44              
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate              
 group by branch    
         
 select a.*,angel_net_bse=isnull(angel_net_bse,0),angel_net_nse=isnull(angel_net_nse,0),angel_net_fo=isnull(angel_net_fo,0),angel_net_mcx=isnull(angel_net_mcx,0),angel_net_ncx=isnull(angel_net_ncx,0),Net=isnull(Net,0)              
 from              
#FILEA44 a              
 left outer join              
 #FILEB44 b              
 on  a.branch_cd=b.branch order by branch_cd      End              
if @user='REGION' and @BrOrSB='%'              
BEGIN              
      
select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), total_br=isnull(sum(bse_br+EBse_br+nse_br+   
  
ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)         
INTO  #FILEA33        
  from ebrok_tobr_period (nolock)              
 where sauda_date>=@fdate and sauda_date<=@tdate              
 and branch_cd in (select code from risk.dbo.region where reg_code=@code)               
 group by branch_cd --order by branch_cd     
    
select  branch,              
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),              
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),              
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),              
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),              
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),            
 Net=sum(case when segment='ABLCM' or segment='ACDLCM' or segment='ACDLFO' or segment='ACPLMCX' or segment='ACPLNCDX' then angel_share else 0 end)       
INTO #FILEB33    
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate              
 and branch in (select code from risk.dbo.region where reg_code=@code)               
 group by branch    
            
 select a.*,angel_net_bse=isnull(angel_net_bse,0),angel_net_nse=isnull(angel_net_nse,0),angel_net_fo=isnull(angel_net_fo,0),angel_net_mcx=isnull(angel_net_mcx,0),angel_net_ncx=isnull(angel_net_ncx,0),Net=isnull(Net,0)                
  from              
 #FILEA33 a              
 left outer join              
 #FILEB33 b              
 on  a.branch_cd=b.branch order by branch_cd              
End              
              
if @user='BRMAST' and @BrOrSB='%'              
BEGIN              
    
select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), 
total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)    
INTO #FILEA5              
  from ebrok_tobr_period (nolock)              
 where sauda_date>=@fdate and sauda_date<=@tdate              
 and branch_cd in (select branch_cd from risk.dbo.branch_master where brmast_Cd=@code)               
 group by branch_cd --order by branch_cd             
            
select  branch,              
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),              
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),              
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),              
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),              
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end) ,            
 Net=sum(case when segment='ABLCM' or segment='ACDLCM' or segment='ACDLFO' or segment='ACPLMCX' or segment='ACPLNCDX' then angel_share else 0 end)    
INTO #FILEB5              
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate              
 and branch in (select branch_cd from risk.dbo.branch_master where brmast_Cd=@code)               
 group by branch    
      
 select a.*,angel_net_bse=isnull(angel_net_bse,0),angel_net_nse=isnull(angel_net_nse,0),angel_net_fo=isnull(angel_net_fo,0),angel_net_mcx=isnull(angel_net_mcx,0),angel_net_ncx=isnull(angel_net_ncx,0),Net=isnull(Net,0)                  
  from              
#FILEA5 a              
 left outer join              
 #FILEB5 b              
 on  a.branch_cd=b.branch order by branch_cd              
End              
              
if @user='BRANCH' and @BrOrSB='%'              
BEGIN              
  select branch_cd,br_bse=isnull(sum(bse_br+EBse_br),0),br_nse=isnull(sum(nse_br+ENse_br),0), br_nsefo=isnull(sum(fo_br+Efo_br),0),br_mcx=isnull(sum(mcx_br+EMcx_br),0),br_ncdex=isnull(sum(ncdex_br+Encdex_br),0), 
total_br=isnull(sum(bse_br+EBse_br+nse_br+ENse_br+fo_br+Efo_br+mcx_br+EMcx_br+ncdex_br+Encdex_br),0), total_turn=isnull(sum(bse_to+nse_to+fo_to+mcx_to+ncdex_to+ebrok_to),0)              
INTO #FILEA6    
  from ebrok_tobr_period (nolock)              
 where sauda_date>=@fdate and sauda_date<=@tdate              
 and branch_cd =@code               
 group by branch_cd --order by branch_cd    
      
 select  branch,              
 angel_net_bse=sum(case when segment='ABLCM' then angel_share else 0 end),              
 angel_net_nse=sum(case when segment='ACDLCM' then angel_share else 0 end),              
 angel_net_fo=sum(case when segment='ACDLFO' then angel_share else 0 end),              
 angel_net_mcx=sum(case when segment='ACPLMCX' then angel_share else 0 end),              
 angel_net_ncx=sum(case when segment='ACPLNCDX' then angel_share else 0 end),            
 Net=sum(case when segment='ABLCM' or segment='ACDLCM' or segment='ACDLFO' or segment='ACPLMCX' or segment='ACPLNCDX' then angel_share else 0 end)                  
INTO #FILEB6    
 from mis.remisior.dbo.comb_br where sauda_date>=@fdate and sauda_date<=@tdate              
 and branch =@code               
 group by branch    
          
 select a.*,angel_net_bse=isnull(angel_net_bse,0),angel_net_nse=isnull(angel_net_nse,0),angel_net_fo=isnull(angel_net_fo,0),angel_net_mcx=isnull(angel_net_mcx,0),angel_net_ncx=isnull(angel_net_ncx,0),Net=isnull(Net,0)          
  from              
 #FILEA6             
  a              
 left outer join              
 #FILEB6 b              
 on  a.branch_cd=b.branch order by branch_cd     
            
End     
        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TradeChangeUpload
-- --------------------------------------------------

CREATE  PROCEDURE TradeChangeUpload --'AngelFoTrade', 'Oct 13 2005', 'Trade901917102005.txt', ',', '\n', 'angelfotradebefore'
@DBTable varchar(25),
@strDate varchar(15),
@DataFile varchar(100),
@FldTerminator varchar(5),
@RowTerminator varchar(5),
@DBTableBefore varchar(50),
@DBTableInter varchar(50)
 AS
begin
	declare @strQuery varchar(1000)

	--Step1- To Delete records from table where all records are stored 
	set @strQuery = ''
	set @strQuery = ('TRUNCATE TABLE ' + @DBTableInter) 
	print @strQuery
	exec(@strQuery)

	
	--Step2- Bulk Insert for table where all records are stored 
	set @strQuery = ''
	set @strQuery = ('BULK INSERT ' + @DBTableInter +
			 ' FROM ''' + @DataFile + ''' WITH (
			  FIELDTERMINATOR = ''' + @FldTerminator +
			 ''', ROWTERMINATOR = ''' + @RowTerminator + ''')')
	print @strQuery
	exec(@strQuery)


	--Step3- To Delete records from table where all records are stored 
	set @strQuery = ''
	set @strQuery = ('DELETE FROM ' + @DBTable + ' WHERE  Last_Mod_time like ''' + @strDate + '%''')
	print @strQuery
	exec(@strQuery)
	
	--Step4- To Insert records to table 
	set @strQuery = ''
	set @strQuery = ('INSERT INTO ' + @DBTable + '(Trade_No,Status,Inst_Type,
			  Symbol,Expirydate,Strike_price,Option_type,
			  Sec_Name,BookType,BookTypeName,MarKetType,User_Id,
			  Branch_Id,Sell_Buy,TradeQty,Price,Pro_cli,Party_Code,
			  ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,
			  Last_Mod_time,Order_No,membercode)
			  (SELECT Trade_No,Status,Inst_Type,
			  Symbol,Expirydate,Strike_price,Option_type,
			  Sec_Name,BookType,BookTypeName,MarKetType,User_Id,
			  Branch_Id,Sell_Buy,TradeQty,Price,Pro_cli,Party_Code,
			  ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,
			  Last_Mod_time,Order_No,membercode FROM ' + @DBTableInter + ')')
	print @strQuery
	exec(@strQuery)
	

	--Step5- Delete records from table where records before change are stored
	set @strQuery = ''
	set @strQuery = ('DELETE FROM ' + @DBTableBefore + '  WHERE  Last_Mod_time like ''' + @strDate + '%''')
	print @strQuery
	exec(@strQuery)


	--Step6-Insert selected records in before change table
	set @strQuery = ''
	set @strQuery = ('INSERT INTO ' + @DBTableBefore +  '(Trade_No,Status,Inst_Type,
			  Symbol,Expirydate,Strike_price,Option_type,
			  Sec_Name,BookType,BookTypeName,MarKetType,User_Id,
			  Branch_Id,Sell_Buy,TradeQty,Price,Pro_cli,Party_Code,
			  ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,
			  Last_Mod_time,Order_No,membercode) 
			   (SELECT Trade_No,Status,Inst_Type,
			  Symbol,Expirydate,Strike_price,Option_type,
			  Sec_Name,BookType,BookTypeName,MarKetType,User_Id,
			  Branch_Id,Sell_Buy,TradeQty,Price,Pro_cli,Party_Code,
			  ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,
			  Last_Mod_time,Order_No,membercode FROM ' + 
	@DBTable  + ' WHERE status = ''11'' AND Last_Mod_time like ''' + @strDate + '%'' )')
	print @strQuery
	exec(@strQuery)
End





--truncate table AngelFoTradeBefore 
--select count(*) from AngelFoTradeBefore

--truncate table AngelFoTrade 
--select count(*) from AngelFoTrade

--select count(*) from AngelFoTradeInter
--select top 10 * from AngelFoTradeInter

--exec TradeChangeUpload 'Bsedb_ab.DBO.angelfotrade', 'Oct 17 2005', 'D:\Upload1\FOTrade\Trade901917102005.txt', ',', '\n', 'bsedb_ab.DBO.angelfotradeBefore', 'Bsedb_ab.DBO.angelfotradeInter'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TurnoverCalc
-- --------------------------------------------------
CREATE Procedure [dbo].[TurnoverCalc](@FromDate Varchar(11), @ToDate Varchar(11))
As
Declare
@@StartSett_no As Varchar(15),
@@EndSett_no As Varchar(15)

--Select Min(Sett_no),Max(Sett_no) From AngelNseCM.Msajag.Dbo.Sett_mst
--Where Start_date >= @FromDate
--And StartDate

select Party_code ,Scrip_cd,S.Sett_no,S.Sett_type,Turnover = sum(tradeqty * marketrate),Brokerage = Sum((Brokapplied + Nbrokapp)* tradeqty ),'NSE CM EBROKING'
from intranet.ctcl.dbo.nsecashtrade N, AngelNseCM.msajag.dbo.settlement s
where 
S.Party_code = N.clCode
and
N.Flag like '004%'
--And N.TrdNo Like '%' + S.Trade_no 
And N.ORDNO = S.Order_no
And S.Sett_no = N.Settno
And S.Sett_type = 'N'
And S.Sauda_date >= @FromDate
And S.Sauda_date <= @Todate +' 23:59:00'
group by party_code,Scrip_cd,S.Sett_no,S.Sett_type
Order by Party_code,Scrip_cd,S.Sett_no,S.Sett_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.uccactiveclient_details
-- --------------------------------------------------
CREATE procedure [dbo].[uccactiveclient_details](@company as varchar(10), @date as varchar(11))        
as        
        
set nocount on     
        
if @company='ABLCM'        
 BEGIN        
                   
            ------------ABL-------final    
            select c5.cl_code,c5.Drivelicendtl,c5.Rationcarddtl,c5.passportdtl,c5.VotersIDdtl,Remark=c5.p_address1,c5.introducer,c1.Branch_cd,c1.Sub_Broker,c1.pan_gir_no,c1.short_name,c4.bankid,c4.cltdpid,c4.depository  from AngelBSECM.bsedb_Ab.dbo.client5 c5 
  
   
            left outer join AngelBSECM.bsedb_Ab.dbo.client1 c1 on c5.cl_code=c1.cl_code    
            left outer join AngelBSECM.bsedb_Ab.dbo.client4 c4 on c5.cl_code=c4.cl_code     
            where  c5.activefrom>= @date and  c5.activefrom<= @date + ' 23:59' order by c1.Branch_cd,c1.Sub_Broker,c5.cl_code    
            -------------------final    
 END     
if @company='ACDLCM'        
BEGIN     
            ------------ACDL-------final    
            select c5.cl_code,c5.Drivelicendtl,c5.Rationcarddtl,c5.passportdtl,c5.VotersIDdtl,Remark=c5.p_address1,c5.introducer,c1.pan_gir_no,c1.short_name,c1.Branch_cd,c1.Sub_Broker,c4.bankid,c4.cltdpid,c4.depository  from AngelNseCM.msajag.dbo.client5 c5  
  
            left outer join AngelNseCM.msajag.dbo.client1 c1 on c5.cl_code=c1.cl_code    
            left outer join AngelNseCM.msajag.dbo.client4 c4 on c5.cl_code=c4.cl_code     
            where  c5.activefrom>= @date and  c5.activefrom<= @date + ' 23:59' order by c1.Branch_cd,c1.Sub_Broker,c5.cl_code    
            -------------------final    
end    
if @company='ACDLFO'        
 BEGIN        
    
------------F&O-------final    
select c5.cl_code,c5.Drivelicendtl,c5.Rationcarddtl,c5.passportdtl,c5.VotersIDdtl,Remark=c5.p_address1,c5.introducer,c1.pan_gir_no,c1.short_name,c1.Branch_cd,c1.Sub_Broker,c4.bankid,c4.cltdpid,c4.depository  from angelfo.nsefo.dbo.client5 c5    
left outer join angelfo.nsefo.dbo.client1 c1 on c5.cl_code=c1.cl_code    
left outer join angelfo.nsefo.dbo.client4 c4 on c5.cl_code=c4.cl_code     
where  c5.activefrom>= @date and  c5.activefrom<= @date + ' 23:59'order by c1.Branch_cd,c1.Sub_Broker,c5.cl_code    
-------------------final    
end    
if @company='MCX'        
 BEGIN        
------------MCX-------final    
    
select c5.cl_code,c5.Drivelicendtl,c5.Rationcarddtl,c5.passportdtl,c5.VotersIDdtl,Remark=c5.p_address1,c5.introducer,c1.pan_gir_no,c1.short_name,c1.Branch_cd,c1.Sub_Broker,c4.bankid,c4.cltdpid,c4.depository  from angelcommodity.mcdx.dbo.client5 c5    
left outer join angelcommodity.mcdx.dbo.client1 c1 on c5.cl_code=c1.cl_code    
left outer join angelcommodity.mcdx.dbo.client4 c4 on c5.cl_code=c4.cl_code     
where c5.activefrom>= @date and  c5.activefrom<= @date + ' 23:59' order by c1.Branch_cd,c1.Sub_Broker,c5.cl_code    
-------------------final    
end    
    
        
if @company='NCDEX'        
 BEGIN        
    
------------NCDEX-------final    
    
select c5.cl_code,c5.Drivelicendtl,c5.Rationcarddtl,c5.passportdtl,c5.VotersIDdtl,Remark=c5.p_address1,c5.introducer,c1.pan_gir_no,c1.short_name,c1.Branch_cd,c1.Sub_Broker,c4.bankid,c4.cltdpid,c4.depository from angelcommodity.ncdx.dbo.client5 c5    
left outer join angelcommodity.ncdx.dbo.client1 c1 on c5.cl_code=c1.cl_code    
left outer join angelcommodity.ncdx.dbo.client4 c4 on c5.cl_code=c4.cl_code     
where c5.activefrom>= @date and  c5.activefrom<= @date + ' 23:59' order by c1.Branch_cd,c1.Sub_Broker,c5.cl_code    
-------------------final    
end     
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_mis_ebrok
-- --------------------------------------------------
CREATE procedure upd_mis_ebrok(@tdate as varchar(11))              
as              
set nocount on              
            
            
set transaction isolation level read uncommitted              
select a.party_Code,activefrom=min(isnull(active_Date,convert(datetime,'01/01/2006')))             
into #act_from             
from risk.dbo.client_details a, risk.dbo.client_brok_details b             
where a.cl_code =b.cl_code and b.inactive_from > @tdate            
group by party_Code            
            
            
set transaction isolation level read uncommitted              
select Sauda_Date,terminal_id,party_Code,branch_cd,sub_Broker,ABLCM_TO=sum(case when company='ABLCM' then Turnover else 0 end),                  
ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),                    
ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),                    
ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),                    
ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),                    
ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),                    
Turnover = Sum(Turnover),Brokerage = Sum(Brokerage) ,                    
Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),                    
Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),                    
ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),                    
ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end),              
user_stat=space(10),dealer_Code=space(25),Login_status=space(1),active_from=convert(datetime,'Jan  1 1900')              
into #file2 from mis_to                     
where sauda_date=@tdate              
group by sauda_date,terminal_id,party_Code,branch_cd,sub_Broker                    
            
/*            
update #file2 set user_stat='e-broking' where terminal_id in              
(select terminal_id from MIS.TerminalMaster.dbo.tbl_mst_Terminals                     
where Activation_Date<=@tdate+' 00:00:00' and deActivation_Date>=@tdate+' 23:59:59') */           
        
update #file2 set user_stat='e-broking' where terminal_id in                     
(select terminal_id from MIS.remisior.dbo.ebrok_terminal_master        
where From_date<=@tdate+' 00:00:00' and to_Date>=@tdate+' 23:59:59')            
            
select distinct party_Code,nooflogin=count(*) into #login from                 
(              
select  party_Code,dt=login_date from loginfile               
where login_date >=@tdate+' 00:00:00' and login_date <=@tdate+' 23:59:59' 
and status<>'Failed'             
) a group by party_Code having count(*) >= 0              
              
    
    
    
            
update #file2 set Login_status=(case when b.nooflogin is null then 'N' else 'Y' end)                
from #login b where #file2.party_Code=b.party_code collate Latin1_General_CI_AS                  
            
              
insert into #file2                  
select sauda_Date=convert(Datetime,@tdate),terminal_id=0,a.party_code,branch_Cd=sbtag,sub_Broker=subgroup,              
ablcm_to=convert(money,0),acdlcm_to=convert(money,0),acdlfo_to=convert(money,0),                    
ablcm_brk=convert(money,0),acdlcm_brk=convert(money,0),acdlfo_brk=convert(money,0),                    
turnover=convert(money,0),brokerage=convert(money,0),mcx_turn=convert(money,0),                  
mcx_brok=convert(money,0),ncdx_turn=convert(money,0),ncdx_brok=convert(money,0),              
user_stat='e-broking',dealer_Code=space(25),Login_status='Y',active_from=convert(datetime,'Jan  1 1900')              
from #login a, risk.dbo.finmast b where a.party_Code collate Latin1_General_CI_AS =b.party_Code              
and a.party_code collate Latin1_General_CI_AS                   
not in (select party_Code from #file2)                  
            
              
update #file2 set login_status='N' where user_stat='e-broking' and login_status=''       
              
update #file2 set user_stat='' where party_code collate SQL_Latin1_General_CP1_CI_AS  
not in (select party_code from ctcl.dbo.ebrok_client)  
         
update #file2 set active_from= b.activefrom from #act_from b where #file2.party_code=b.party_code collate Latin1_General_CI_AS                            
delete from MIS_ebroking where sauda_Date = @tdate              
insert into MIS_ebroking select * from #file2              
              
delete from MIS_ebroking_cli where sauda_Date = @tdate              
            
insert into MIS_ebroking_cli              
select sauda_date,branch_cd,sub_Broker,party_code,              
ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                    
ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                    
mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),              
turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=max(login_status),user_stat,active_from              
from #file2              
group by sauda_Date,party_Code,branch_cd,sub_Broker,party_code,user_stat,active_from              
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_mis_ebrok_auto
-- --------------------------------------------------
CREATE procedure upd_mis_ebrok_auto
 as                
 set transaction isolation level read uncommitted                
 set nocount on                
              
 declare @tdate as varchar(25)              
 set @tdate=convert(varchar(11),getdate()-1)              
              
set transaction isolation level read uncommitted                    
select a.party_Code,activefrom=min(isnull(active_Date,convert(datetime,'01/01/2006')))                   
into #act_from                   
from risk.dbo.client_details a, risk.dbo.client_brok_details b                   
where a.cl_code =b.cl_code and b.inactive_from > @tdate                  
group by party_Code                  
              
              
/*                
 select party_Code,activefrom=min(activefrom) into #act_from from                    
 (                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.bse_client5 c5, intranet.risk.dbo.bse_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.nse_client5 c5, intranet.risk.dbo.nse_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.fo_client5 c5, intranet.risk.dbo.fo_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.mcdx_client5 c5, intranet.risk.dbo.mcdx_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.ncdx_client5 c5, intranet.risk.dbo.ncdx_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 ) a group by party_code                    
*/                        
 select Sauda_Date,terminal_id,party_Code,branch_cd,sub_Broker,ABLCM_TO=sum(case when company='ABLCM' then Turnover else 0 end),                    
 ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),                      
 ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),                      
 ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),                      
 ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),                      
 ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),                      
 Turnover = Sum(Turnover),Brokerage = Sum(Brokerage) ,                      
 Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),                      
 Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),                      
 ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),                      
 ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end),                
 user_stat=space(10),dealer_Code=space(25),Login_status=space(1),active_from=convert(datetime,'Jan  1 1900')                
 into #file2 from mis_to                       
 where sauda_date=@tdate                
 group by sauda_date,terminal_id,party_Code,branch_cd,sub_Broker                      
             
      
        
                
 /*update #file2 set user_stat='e-broking' where terminal_id in                
 (select terminal_id from MIS.TerminalMaster.dbo.tbl_mst_Terminals                       
  where Activation_Date<=@tdate+' 00:00:00' and deActivation_Date>=@tdate+' 23:59:59'                
 )  */              
            
 update #file2 set user_stat='e-broking' where terminal_id in                
 (select terminal_id from MIS.remisior.dbo.ebrok_terminal_master                       
  where from_Date<=@tdate+' 00:00:00' and to_Date>=@tdate+' 23:59:59'                
 )                
               
                
 select party_Code,nooflogin=count(*) into #login from                   
 (                
 select distinct party_Code,dt=login_date from loginfile                 
 where login_date >=@tdate+' 00:00:00' and login_date <=@tdate+' 23:59:59'                
 ) a group by party_Code having count(*) >= 0                
                
 update #file2 set Login_status=(case when b.nooflogin is null then 'N' else 'Y' end)                  
 from #login b where #file2.party_Code=b.party_code collate Latin1_General_CI_AS                    
                
 insert into #file2                    
 select sauda_Date=convert(Datetime,@tdate),terminal_id=0,a.party_code,branch_Cd=sbtag,sub_Broker=subgroup,                
 ablcm_to=convert(money,0),acdlcm_to=convert(money,0),acdlfo_to=convert(money,0),                      
 ablcm_brk=convert(money,0),acdlcm_brk=convert(money,0),acdlfo_brk=convert(money,0),                      
 turnover=convert(money,0),brokerage=convert(money,0),mcx_turn=convert(money,0),                    
 mcx_brok=convert(money,0),ncdx_turn=convert(money,0),ncdx_brok=convert(money,0),                
 user_stat='e-broking',dealer_Code=space(25),Login_status='Y',active_from=convert(datetime,'Jan  1 1900')                
 from #login a, risk.dbo.finmast b where a.party_Code collate Latin1_General_CI_AS =b.party_Code                
 and a.party_code collate Latin1_General_CI_AS                     
 not in (select party_Code from #file2)                    
                
 update #file2 set login_status='N' where user_stat='e-broking' and login_status=''                
 update #file2 set active_from= b.activefrom from #act_from b where #file2.party_code=b.party_code collate Latin1_General_CI_AS                    
      
      
  select party_code      
 ,bsecm=sum(case when segment='BSECM' then total_brok else  0 end)      
 ,nsecm=sum(case when segment='NSECM' then total_brok else  0 end)      
 ,nsefo=sum(case when segment='FO' then total_brok else  0 end)      
 ,mcdx=sum(case when segment='MCX' then total_brok else  0 end)      
 ,ncdx=sum(case when segment='NCDEX' then total_brok else  0 end)      
 ,MCD=sum(case when segment='MCXSX' then total_brok else  0 end)      
 ,brok=sum(total_brok)      
 ,bsecm_to=sum(case when segment='BSECM' then turnover else  0 end)      
 ,nsecm_to=sum(case when segment='NSECM' then turnover else  0 end)      
 ,nsefo_to=sum(case when segment='FO' then turnover else  0 end)      
 ,mcdx_to=sum(case when segment='MCX' then turnover else  0 end)      
 ,ncdx_to=sum(case when segment='NCDEX' then turnover else  0 end)      
 ,MCD_to=sum(case when segment='MCXSX' then turnover else  0 end)      
 ,to1=sum(turnover)      
 into #offline      
 from mis.terminalmaster.dbo.ebrokingOfflineTrades with (nolock)      
 where sauda_date=@tdate      
 group by party_code      
                
 ------------------------------------------------------------------------      
      
 select sauda_date,branch_cd=max(branch_cd),sub_Broker=max(sub_Broker),party_code,                
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                      
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                      
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=max(login_status),user_stat,active_from                
 into #file3      
 from #file2                
 group by sauda_Date,party_Code,party_code,user_stat,active_from         
     
--------------------------------------------------------------------------------    
    
--------------------------------------------------------------------------------     
      
 update #file3 set       
 ablcm_to=ablcm_to-b.bsecm_to,      
 acdlcm_to=acdlcm_to-b.nsecm_to,      
 acdlfo_to=acdlfo_to-b.nsefo_to,      
 mcx_turn=mcx_turn-b.mcdx_to,ncdx_turn=ncdx_turn-b.ncdx_to,      
 turnover=turnover-to1,      
 ablcm_brk=ablcm_brk-b.bsecm,      
 acdlcm_brk=acdlcm_brk-b.nsecm,      
 acdlfo_brk=acdlfo_brk-b.nsefo,      
 mcx_brok=mcx_brok-b.mcdx,ncdx_brok=ncdx_brok-b.ncdx,      
 brokerage=brokerage-brok       
 from  #offline b where #file3.party_code=b.party_code collate SQL_Latin1_General_CP1_CI_AS      
 and user_stat='e-broking'     
      
                
 delete from MIS_ebroking where sauda_Date = @tdate                
 insert into MIS_ebroking select * from #file2                

/*
 delete from MIS_ebroking_cli where sauda_Date = @tdate                
 insert into MIS_ebroking_cli                
 select * from #file3             
*/
                
 set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_mis_ebrok_auto_19072012
-- --------------------------------------------------
CREATE procedure upd_mis_ebrok_auto_19072012
 as                
 set transaction isolation level read uncommitted                
 set nocount on                
              
 declare @tdate as varchar(25)              
 set @tdate=convert(varchar(11),getdate()-1)              
              
set transaction isolation level read uncommitted                    
select a.party_Code,activefrom=min(isnull(active_Date,convert(datetime,'01/01/2006')))                   
into #act_from                   
from risk.dbo.client_details a, risk.dbo.client_brok_details b                   
where a.cl_code =b.cl_code and b.inactive_from > @tdate                  
group by party_Code                  
              
              
/*                
 select party_Code,activefrom=min(activefrom) into #act_from from                    
 (                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.bse_client5 c5, intranet.risk.dbo.bse_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.nse_client5 c5, intranet.risk.dbo.nse_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.fo_client5 c5, intranet.risk.dbo.fo_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.mcdx_client5 c5, intranet.risk.dbo.mcdx_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 union all                    
 select party_Code,activefrom=(case when activefrom is null then '01/01/2006' else activefrom end) from intranet.risk.dbo.ncdx_client5 c5, intranet.risk.dbo.ncdx_client2 c2                     
 where c5.cl_code=c2.cl_code                    
 ) a group by party_code                    
*/                        
 select Sauda_Date,terminal_id,party_Code,branch_cd,sub_Broker,ABLCM_TO=sum(case when company='ABLCM' then Turnover else 0 end),                    
 ACDLCM_TO=sum(case when company='ACDLCM' then turnover else 0 end),                      
 ACDLFO_TO=sum(case when company='ACDLFO' then turnover else 0 end),                      
 ABLCM_BRK=sum(case when company='ABLCM' then brokerage else 0 end),                      
 ACDLCM_BRK=sum(case when company='ACDLCM' then brokerage else 0 end),                      
 ACDLFO_BRK=sum(case when company='ACDLFO' then brokerage else 0 end),                      
 Turnover = Sum(Turnover),Brokerage = Sum(Brokerage) ,                      
 Mcx_turn=sum(case when company='ACPLMCX' then Turnover else 0 end),                      
 Mcx_brok=sum(case when company='ACPLMCX' then Brokerage else 0 end),                      
 ncdx_turn=sum(case when company='ACPLNCDEX' then Turnover else 0 end),                      
 ncdx_brok=sum(case when company='ACPLNCDEX' then Brokerage else 0 end),                
 user_stat=space(10),dealer_Code=space(25),Login_status=space(1),active_from=convert(datetime,'Jan  1 1900')                
 into #file2 from mis_to                       
 where sauda_date=@tdate                
 group by sauda_date,terminal_id,party_Code,branch_cd,sub_Broker                      
             
      
        
                
 /*update #file2 set user_stat='e-broking' where terminal_id in                
 (select terminal_id from MIS.TerminalMaster.dbo.tbl_mst_Terminals                       
  where Activation_Date<=@tdate+' 00:00:00' and deActivation_Date>=@tdate+' 23:59:59'                
 )  */              
            
 update #file2 set user_stat='e-broking' where terminal_id in                
 (select terminal_id from MIS.remisior.dbo.ebrok_terminal_master                       
  where from_Date<=@tdate+' 00:00:00' and to_Date>=@tdate+' 23:59:59'                
 )                
               
                
 select party_Code,nooflogin=count(*) into #login from                   
 (                
 select distinct party_Code,dt=login_date from loginfile                 
 where login_date >=@tdate+' 00:00:00' and login_date <=@tdate+' 23:59:59'                
 ) a group by party_Code having count(*) >= 0                
                
 update #file2 set Login_status=(case when b.nooflogin is null then 'N' else 'Y' end)                  
 from #login b where #file2.party_Code=b.party_code collate Latin1_General_CI_AS                    
                
 insert into #file2                    
 select sauda_Date=convert(Datetime,@tdate),terminal_id=0,a.party_code,branch_Cd=sbtag,sub_Broker=subgroup,                
 ablcm_to=convert(money,0),acdlcm_to=convert(money,0),acdlfo_to=convert(money,0),                      
 ablcm_brk=convert(money,0),acdlcm_brk=convert(money,0),acdlfo_brk=convert(money,0),                      
 turnover=convert(money,0),brokerage=convert(money,0),mcx_turn=convert(money,0),                    
 mcx_brok=convert(money,0),ncdx_turn=convert(money,0),ncdx_brok=convert(money,0),                
 user_stat='e-broking',dealer_Code=space(25),Login_status='Y',active_from=convert(datetime,'Jan  1 1900')                
 from #login a, risk.dbo.finmast b where a.party_Code collate Latin1_General_CI_AS =b.party_Code                
 and a.party_code collate Latin1_General_CI_AS                     
 not in (select party_Code from #file2)                    
                
 update #file2 set login_status='N' where user_stat='e-broking' and login_status=''                
 update #file2 set active_from= b.activefrom from #act_from b where #file2.party_code=b.party_code collate Latin1_General_CI_AS                    
      
      
  select party_code      
 ,bsecm=sum(case when segment='BSECM' then total_brok else  0 end)      
 ,nsecm=sum(case when segment='NSECM' then total_brok else  0 end)      
 ,nsefo=sum(case when segment='FO' then total_brok else  0 end)      
 ,mcdx=sum(case when segment='MCX' then total_brok else  0 end)      
 ,ncdx=sum(case when segment='NCDEX' then total_brok else  0 end)      
 ,MCD=sum(case when segment='MCXSX' then total_brok else  0 end)      
 ,brok=sum(total_brok)      
 ,bsecm_to=sum(case when segment='BSECM' then turnover else  0 end)      
 ,nsecm_to=sum(case when segment='NSECM' then turnover else  0 end)      
 ,nsefo_to=sum(case when segment='FO' then turnover else  0 end)      
 ,mcdx_to=sum(case when segment='MCX' then turnover else  0 end)      
 ,ncdx_to=sum(case when segment='NCDEX' then turnover else  0 end)      
 ,MCD_to=sum(case when segment='MCXSX' then turnover else  0 end)      
 ,to1=sum(turnover)      
 into #offline      
 from mis.terminalmaster.dbo.ebrokingOfflineTrades with (nolock)      
 where sauda_date=@tdate      
 group by party_code      
                
 ------------------------------------------------------------------------      
      
 select sauda_date,branch_cd=max(branch_cd),sub_Broker=max(sub_Broker),party_code,                
 ablcm_to=sum(ablcm_to),acdlcm_to=sum(acdlcm_to),acdlfo_to=sum(acdlfo_to),                      
 ablcm_brk=sum(ablcm_brk),acdlcm_brk=sum(acdlcm_brk),acdlfo_brk=sum(acdlfo_brk),                      
 mcx_turn=sum(mcx_turn),mcx_brok=sum(mcx_brok),ncdx_brok=sum(ncdx_brok),ncdx_turn=sum(ncdx_turn),                
 turnover=sum(turnover),brokerage=sum(Brokerage),nooflogin=max(login_status),user_stat,active_from                
 into #file3      
 from #file2                
 group by sauda_Date,party_Code,party_code,user_stat,active_from         
     
--------------------------------------------------------------------------------    
    
--------------------------------------------------------------------------------     
      
 update #file3 set       
 ablcm_to=ablcm_to-b.bsecm_to,      
 acdlcm_to=acdlcm_to-b.nsecm_to,      
 acdlfo_to=acdlfo_to-b.nsefo_to,      
 mcx_turn=mcx_turn-b.mcdx_to,ncdx_turn=ncdx_turn-b.ncdx_to,      
 turnover=turnover-to1,      
 ablcm_brk=ablcm_brk-b.bsecm,      
 acdlcm_brk=acdlcm_brk-b.nsecm,      
 acdlfo_brk=acdlfo_brk-b.nsefo,      
 mcx_brok=mcx_brok-b.mcdx,ncdx_brok=ncdx_brok-b.ncdx,      
 brokerage=brokerage-brok       
 from  #offline b where #file3.party_code=b.party_code collate SQL_Latin1_General_CP1_CI_AS      
 and user_stat='e-broking'     
      
                
 delete from MIS_ebroking where sauda_Date = @tdate                
 insert into MIS_ebroking select * from #file2                
                
 delete from MIS_ebroking_cli where sauda_Date = @tdate                
 insert into MIS_ebroking_cli                
 select * from #file3             
                
                
 set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.updateAPCBPCRemark
-- --------------------------------------------------




CREATE     PROCEDURE updateAPCBPCRemark
 @rem varchar(50),
 @orderNo varchar(15),
 @partyCode varchar(15),
 @SaudaDate datetime,
 @scripCd varchar(15),
 @sellbuy varchar(5),
 @quantity varchar(10),
 @updatedBy varchar(50)


AS

begin
	UPDATE tradeAPC SET remark = @rem , updatedBy = @updatedBy, updatedDate = getDate()
		WHERE Order_no = @orderNo 
		  AND Party_Code = @partyCode		
		  AND Sauda_Date = @saudaDate
		  AND scrip_cd = @scripCd
		  AND sell_buy = @sellbuy
		 -- AND quantity = @quantity
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.updateTradeFORemark
-- --------------------------------------------------



CREATE   PROCEDURE updateTradeFORemark
 @TradeNo varchar(15),
 @rem varchar(50),
 @Inst_type varchar(15),
 @Symbol varchar(15),
 @ExpiryDate varchar(15),
 @Option_type varchar(15),
 @Order_no varchar(15),
 @party_cd varchar(15),
 @sell_buy varchar(10),
 @ActivityTime datetime,
 @updatedBy varchar(50)
AS

begin	
UPDATE AngelFoTrade SET remark = @rem , updatedBy = @updatedBy, updatedDate = getDate()
		WHERE Trade_no = @TradeNo
		  AND Inst_Type = @Inst_Type 
		  AND Symbol = @Symbol	
		  AND Expirydate = @Expirydate
		  AND Option_type = @Option_type
		  AND Order_no = @Order_no
		  AND Party_Code = @party_cd
		  AND Sell_Buy = @sell_buy
		  --AND left(activitytime, 11) = @ActivityTime
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UpLevel1Mis
-- --------------------------------------------------
  
  
CREATE Procedure [dbo].[UpLevel1Mis] (@Exchange As Varchar(15), @FromDate Varchar(11), @ToDate Varchar(11))    
As    
    
--dump transaction bsedb_ab with no_log    
--dump transaction tempdb with no_log    
    
Declare @@LevelDate As DateTime    
Declare @@ValanDate As DateTime    
    
If ( @FromDate = '' And @Todate = '' )    
Begin    
          Select @FromDate = Left(Convert(Varchar,DateAdd(Day,-5,Max(Sauda_date)),109),11) from Level1Mis Where Exchangesegment = @Exchange    
          --Select @Todate = Left(    
          Select @Todate = Left(Convert(Varchar,Getdate(),109),11)    
End    
    
If @Exchange = 'NSECM'    
Begin    
    
 Delete Level1Mis where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' and ExchangeSegment = 'NSECM'    
    
 Insert into Level1Mis     
 Select 'NSECM', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Party_code ,    
 Party_Name = Party_Name,Family =Family,Family_Name=Family_Name,Terminal_Id = Terminal_Id , ClientType = ClientType ,TradeType = TradeType ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = Sett_No, Sett_Type = Sett_Type,     
 TP = Sum(PQtyTrd),TPA =Sum(PAmtTrd),DP= Sum(PQtyDel),DPA=Sum(PAmtDel),TS = Sum(SQtyTrd),TSA =Sum(SAmtTrd), DS = Sum(SQtyDel),    
 DSA= Sum(SAmtDel),TPB =Sum(PBrokTrd),TSB=Sum(SBrokTrd),DPB=Sum(PBrokDel),DSB=Sum(SBrokDel),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(ExService_Tax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_Chrg),    
 Other_Chrg = Sum(Other_Chrg) ,0,0,'',''    /*, From_date = Min(Sauda_date) , To_date = Max(Sauda_date)*/     
 From AngelNseCM.Msajag.Dbo.CmBillvalan     
 Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'                 
 Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00', Party_code ,Party_Name,Family,Family_Name,Terminal_Id,ClientType ,TradeType ,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Sett_No, Sett_Type    
     
 Delete Level1ScripMis where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' and ExchangeSegment = 'NSECM'    
    
 Insert into Level1ScripMis     
 Select ExchangeSegment = 'NSECM', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Scrip_cd = Scrip_cd,    
 Series = Series,IsIN= IsIn,Family =Family,Family_Name=Family_Name,Terminal_Id = Terminal_Id , ClientType = ClientType ,TradeType = TradeType ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = Sett_No, Sett_Type = Sett_Type,     
 TP = Sum(PQtyTrd),TPA =Sum(PAmtTrd),DP= Sum(PQtyDel),DPA=Sum(PAmtDel),TS = Sum(SQtyTrd),TSA =Sum(SAmtTrd), DS = Sum(SQtyDel),    
 DSA= Sum(SAmtDel),TPB =Sum(PBrokTrd),TSB=Sum(SBrokTrd),DPB=Sum(PBrokDel),DSB=Sum(SBrokDel),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(ExService_Tax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_Chrg),    
 Other_Chrg = Sum(Other_Chrg) ,Orders = 0,Trades = 0     
 From AngelNseCM.Msajag.Dbo.CmBillvalan C     
 Where Sauda_date >= @FromDate and Sauda_date <=@Todate  + ' 23:59:00'       And  Tradetype not in ( 'SCF','ICF','IR' )          
 Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00', Scrip_cd,Series,IsIN,Family,Family_Name,Terminal_Id,ClientType ,TradeType ,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Sett_No, Sett_Type      
End    
    
If @Exchange = 'BSECM'    
Begin    
 Delete Level1Mis where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' and ExchangeSegment = 'BSECM'    
    
 Insert into Level1Mis      
 Select 'BSECM', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00',  Party_code = Party_code ,    
 Party_Name = Party_Name,Family =Family,Family_Name=Family_Name,Terminal_Id = Terminal_Id , ClientType = ClientType ,TradeType = TradeType ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = Sett_No, Sett_Type = Sett_Type,     
  TP = Sum(PQtyTrd),TPA =Sum(PAmtTrd),DP= Sum(PQtyDel),DPA=Sum(PAmtDel),TS = Sum(SQtyTrd),TSA =Sum(SAmtTrd), DS = Sum(SQtyDel),    
 DSA= Sum(SAmtDel),TPB =Sum(PBrokTrd),TSB=Sum(SBrokTrd),DPB=Sum(PBrokDel),DSB=Sum(SBrokDel),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(ExService_Tax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_Chrg),    
 Other_Chrg = Sum(Other_Chrg),0,0,'',''  /* , From_date = Min(Sauda_date) , To_date = Max(Sauda_date)  */     
 From AngelBSECM.BsedB_ab.Dbo.CmBillvalan     
 Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'  And  Tradetype not in ( 'SCF','ICF','IR' )    
 Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00', Party_code ,Party_Name,Family,Family_Name,Terminal_Id,ClientType ,TradeType ,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Sett_No, Sett_Type    
     
 Delete Level1ScripMis where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' and ExchangeSegment = 'BSECM'    
     
 Insert into Level1ScripMis     
 Select ExchangeSegment = 'BSECM', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Scrip_cd = Scrip_cd,    
 Series = Series,IsIN= IsIn,Family =Family,Family_Name=Family_Name,Terminal_Id = Terminal_Id , ClientType = ClientType ,TradeType = TradeType ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = Sett_No, Sett_Type = Sett_Type,     
 TP = Sum(PQtyTrd),TPA =Sum(PAmtTrd),DP= Sum(PQtyDel),DPA=Sum(PAmtDel),TS = Sum(SQtyTrd),TSA =Sum(SAmtTrd), DS = Sum(SQtyDel),    
 DSA= Sum(SAmtDel),TPB =Sum(PBrokTrd),TSB=Sum(SBrokTrd),DPB=Sum(PBrokDel),DSB=Sum(SBrokDel),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(ExService_Tax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_Chrg),    
 Other_Chrg = Sum(Other_Chrg) ,Orders = 0,Trades = 0    /*, From_date = Min(Sauda_date) , To_date = Max(Sauda_date)*/     
  From AngelBSECM.bsedb_ab.Dbo.CmBillvalan C     
 Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'                 
 Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00', Scrip_cd,Series,IsIN,Family,Family_Name,Terminal_Id,ClientType ,TradeType ,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Sett_No, Sett_Type     
End    
    
If @Exchange = 'NSEFO'    
Begin    
 Delete Level1Mis where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' and ExchangeSegment = 'NSEFO'    
/*    
 Insert into Level1Mis      
 Select 'NSEFO', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Party_code ,    
 Party_Name = Party_Name,Family =Family,Family_Name=FamilyName,Terminal_Id = Terminal_Id , ClientType = Client_Type ,TradeType = TradeType ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_code, ParticipantCode = ParticipantCode,Sett_No = 2004, Sett_Type = Inst_type,     
 TP = 0 ,    
 TPA =0 ,    
 DP= Sum(PQty),    
 DPA=Sum(PAmt),    
 TS = 0 ,    
 TSA = 0,    
 DS = Sum(SQty),    
 DSA= Sum(SAmt),    
 TPB =0,    
 TSB=0,    
 DPB=Sum(PBrokAmt),DSB=Sum(SBrokAmt),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(ExSer_Tax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_note),    
 Other_Chrg = Sum(Other_Chrg) ,0,0     
 From Angelfo.Nsefo.Dbo.FoBillvalan     
 Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'     
 Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00', Party_code ,Party_Name,Family,FamilyName,Terminal_Id,Client_Type ,TradeType ,Trader,    
 Sub_Broker , Branch_code, ParticipantCode,TradeType,Inst_type    
*/    
             Insert into Level1Mis    
  Select 'NSEFO', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Fs.Party_code ,    
 Party_Name = C1.Short_Name,Family =C1.Family,Family_Name=C1.Family,Terminal_Id = User_Id , ClientType = Cl_Type ,TradeType = '' /*TradeType*/ ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = 2004, Sett_Type = Inst_type,     
 TP = 0 ,    
 TPA =0 ,    
 DP= Sum (Case When Sell_buy = 1 Then (Tradeqty) Else 0 End),    
 DPA=Sum (Case When Sell_buy = 1 Then  (Price+ Strike_Price)* TradeQty Else 0 End),    
 TS = 0 ,    
 TSA = 0,    
 DS = Sum(Case When Sell_buy = 2 Then (Tradeqty) Else 0 End),    
 DSA= Sum(Case When Sell_Buy = 2 Then (Price+ Strike_Price)* TradeQty Else 0 End),    
 TPB =0,    
 TSB=0,    
 DPB=Sum(Case When Sell_buy = 1 Then (Brokapplied * Tradeqty) Else 0 End),    
             DSB=Sum(Case When Sell_buy = 2 Then (Brokapplied * Tradeqty) Else 0 End),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(NSerTax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_chrg),    
 Other_Chrg = Sum(Fs.Other_Chrg) ,0,0 ,'',''     
 From Angelfo.Nsefo.Dbo.FoSettlement Fs ,Angelfo.Nsefo.Dbo.Client1 C1,Angelfo.Nsefo.Dbo.Client2 C2    
 Where Sauda_date >=  @FromDate  and Sauda_date <= @Todate  + ' 23:59:00'     
             And C1.Cl_code = C2.Cl_code    
             And C2.PArty_code = Fs.Party_code      
             Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00',Fs. Party_code ,Short_Name,Family,User_Id,Cl_Type,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Inst_type    
    
Insert into Level1Mis    
  Select 'NSEFO', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Fs.Party_code ,    
 Party_Name = C1.Short_Name,Family =C1.Family,Family_Name=C1.Family,Terminal_Id = User_Id , ClientType = Cl_Type ,TradeType = '' /*TradeType*/ ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = 2004, Sett_Type = Inst_type,     
 TP = 0 ,    
 TPA =0 ,    
 DP= Sum (Case When Sell_buy = 1 Then (Tradeqty) Else 0 End),    
 DPA=Sum (Case When Sell_buy = 1 Then  (Price+ Strike_Price)* TradeQty Else 0 End),    
 TS = 0 ,    
 TSA = 0,    
 DS = Sum(Case When Sell_buy = 2 Then (Tradeqty) Else 0 End),    
 DSA= Sum(Case When Sell_Buy = 2 Then (Price+ Strike_Price)* TradeQty Else 0 End),    
 TPB =0,    
 TSB=0,    
 DPB=Sum(Case When Sell_buy = 1 Then (Brokapplied * Tradeqty) Else 0 End),    
             DSB=Sum(Case When Sell_buy = 2 Then (Brokapplied * Tradeqty) Else 0 End),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(NSerTax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_chrg),    
 Other_Chrg = Sum(Fs.Other_Chrg) ,0,0,'',''      
  From Angelfo.pradnya.Dbo.History_FoSettlement_nsefo Fs ,Angelfo.Nsefo.Dbo.Client1 C1,Angelfo.Nsefo.Dbo.Client2 C2    
 Where Sauda_date >=  @FromDate  and Sauda_date <= @Todate  + ' 23:59:00'     
             And C1.Cl_code = C2.Cl_code    
             And C2.PArty_code = Fs.Party_code      
             Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00',Fs. Party_code ,Short_Name,Family,User_Id,Cl_Type,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Inst_type    
    
    
/*             Select * Into #TermNo From (       
             Select Distinct Party_code = Party_code,User_Id = User_id, Sauda_date = Left(Convert(Varchar,Sauda_date,109),11) From AngelFo.Nsefo.Dbo.FoSettlement    
             Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00') A    
    
             Update Level1Mis Set Terminal_ID = User_Id From #TermNo Where    
             Level1Mis.Party_code = #TermNo.Party_code    
             And    
             Level1Mis.Sauda_date Like #TermNo.Sauda_date +'%'    
             And    
             ExchangeSegment = 'NSEFO'    
     
             Drop Table #TermNo    
*/    
End    
    
    
    
If @Exchange = 'MCX'    
Begin    
 Delete Level1Mis where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' and ExchangeSegment = @Exchange    
              Insert into Level1Mis    
  Select 'MCX', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Fs.Party_code ,    
Party_Name = C1.Short_Name,Family =C1.Family,Family_Name=C1.Family,Terminal_Id = User_Id , ClientType = Cl_Type ,TradeType = '' /*TradeType*/ ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = 2004, Sett_Type = Inst_type,     
 TP = 0 ,    
 TPA =0 ,    
 DP= Sum (Case When Sell_buy = 1 Then (Tradeqty) Else 0 End),    
 DPA=Sum (Case When Sell_buy = 1 Then  (Price+ Strike_Price)* TradeQty Else 0 End),    
 TS = 0 ,    
 TSA = 0,    
 DS = Sum(Case When Sell_buy = 2 Then (Tradeqty) Else 0 End),    
 DSA= Sum(Case When Sell_Buy = 2 Then (Price+ Strike_Price)* TradeQty Else 0 End),    
 TPB =0,    
 TSB=0,    
 DPB=Sum(Case When Sell_buy = 1 Then (Brokapplied * Tradeqty) Else 0 End),    
             DSB=Sum(Case When Sell_buy = 2 Then (Brokapplied * Tradeqty) Else 0 End),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(NSerTax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_chrg),    
 Other_Chrg = Sum(Fs.Other_Chrg) ,0,0 ,'',''     
 From Angelcommodity.MCDX.Dbo.FoSettlement Fs ,Angelcommodity.MCDX.Dbo.Client1 C1,Angelcommodity.MCDX.Dbo.Client2 C2    
 Where Sauda_date >=  @FromDate  and Sauda_date <= @Todate  + ' 23:59:00'     
             And C1.Cl_code = C2.Cl_code    
             And C2.PArty_code = Fs.Party_code      
             Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00',Fs. Party_code ,Short_Name,Family,User_Id,Cl_Type,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Inst_type    
    
    
/*    
 Insert into Level1Mis      
 Select @Exchange, Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Party_code ,    
 Party_Name = Party_Name,Family =Family,Family_Name=FamilyName,Terminal_Id = Terminal_Id , ClientType = Client_Type ,TradeType = TradeType ,Trader = Trader,  Sub_Broker = Sub_Broker , Branch_cd = Branch_code, ParticipantCode = ParticipantCode,Sett_No = 20
  
  
04, Sett_Type = Inst_type,     
 TP = 0 ,    
 TPA =0 ,    
 DP= Sum(PQty),    
 DPA=Sum(PAmt),    
 TS = 0 ,    
 TSA = 0,    
 DS = Sum(SQty),    
 DSA= Sum(SAmt),    
 TPB =0,    
 TSB=0,    
 DPB=Sum(PBrokAmt),DSB=Sum(SBrokAmt),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(ExSer_Tax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_note),    
 Other_Chrg = Sum(Other_Chrg) ,0,0,'',''      
 From Angelcommodity.MCDX.Dbo.FoBillvalan     
 Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'     
 Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00', Party_code ,Party_Name,Family,FamilyName,Terminal_Id,Client_Type ,TradeType ,Trader,    
 Sub_Broker , Branch_code, ParticipantCode,TradeType,Inst_type */    
End    
    
If @Exchange = 'NCX'    
Begin    
 Delete Level1Mis where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00' and ExchangeSegment = @Exchange    
Insert into Level1Mis    
  Select 'NCX', Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Fs.Party_code ,    
 Party_Name = C1.Short_Name,Family =C1.Family,Family_Name=C1.Family,Terminal_Id = User_Id , ClientType = Cl_Type ,TradeType = '' /*TradeType*/ ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_cd, ParticipantCode = ParticipantCode,Sett_No = 2004, Sett_Type = Inst_type,     
 TP = 0 ,    
 TPA =0 ,    
 DP= Sum (Case When Sell_buy = 1 Then (Tradeqty) Else 0 End),    
 DPA=Sum (Case When Sell_buy = 1 Then  (Price+ Strike_Price)* TradeQty Else 0 End),    
 TS = 0 ,    
 TSA = 0,    
 DS = Sum(Case When Sell_buy = 2 Then (Tradeqty) Else 0 End),    
 DSA= Sum(Case When Sell_Buy = 2 Then (Price+ Strike_Price)* TradeQty Else 0 End),    
 TPB =0,    
 TSB=0,    
 DPB=Sum(Case When Sell_buy = 1 Then (Brokapplied * Tradeqty) Else 0 End),    
             DSB=Sum(Case When Sell_buy = 2 Then (Brokapplied * Tradeqty) Else 0 End),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(NSerTax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_chrg),    
 Other_Chrg = Sum(Fs.Other_Chrg) ,0,0 ,'',''     
 From Angelcommodity.NCDX.Dbo.FoSettlement Fs ,Angelcommodity.MCDX.Dbo.Client1 C1,Angelcommodity.MCDX.Dbo.Client2 C2    
 Where Sauda_date >=  @FromDate  and Sauda_date <= @Todate  + ' 23:59:00'     
             And C1.Cl_code = C2.Cl_code    
             And C2.PArty_code = Fs.Party_code      
             Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00',Fs. Party_code ,Short_Name,Family,User_Id,Cl_Type,Trader,    
 Sub_Broker , Branch_cd, ParticipantCode,Inst_type    
    
 /* Insert into Level1Mis      
 Select @Exchange, Sauda_date = Convert(Varchar(11),Sauda_date) + ' 23:59:00' ,  Party_code = Party_code ,    
 Party_Name = Party_Name,Family =Family,Family_Name=FamilyName,Terminal_Id = Terminal_Id , ClientType = Client_Type ,TradeType = TradeType ,Trader = Trader,    
 Sub_Broker = Sub_Broker , Branch_cd = Branch_code, ParticipantCode = ParticipantCode,Sett_No = 2004, Sett_Type = Inst_type,     
 TP = 0 ,    
 TPA =0 ,    
 DP= Sum(PQty),    
 DPA=Sum(PAmt),    
 TS = 0 ,    
 TSA = 0,    
 DS = Sum(SQty),    
 DSA= Sum(SAmt),    
 TPB =0,    
 TSB=0,    
 DPB=Sum(PBrokAmt),DSB=Sum(SBrokAmt),    
 Service_Tax=Sum(Service_Tax),NSerTax=Sum(ExSer_Tax),Turn_Tax = Sum(Turn_Tax),    
 Sebi_Tax = Sum(Sebi_Tax),Ins_Chrg = Sum(Ins_Chrg),Broker_Chrg = Sum(Broker_note),    
 Other_Chrg = Sum(Other_Chrg) ,0,0,'',''     
 From Angelcommodity.NCDX.Dbo.FoBillvalan     
 Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'     
 Group By     
 Convert(Varchar(11),Sauda_date)+' 23:59:00', Party_code ,Party_Name,Family,FamilyName,Terminal_Id,Client_Type ,TradeType ,Trader,    
 Sub_Broker , Branch_code, ParticipantCode,TradeType,Inst_type */    
End    
    
Print 'Going To Update Finmoth and year'    
    
update Level1Mis Set FinMonth = DatePart(Month,Sauda_date) From level1mis    
 Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'    
    
Update Level1Mis Set FinYear = (Case When FinMonth < 4 Then Cast(DatePart(Year,Sauda_date)-1 As Varchar(11)) + '-' + Cast(DatePart(Year,Sauda_date)As Varchar(11)) Else    
Cast(DatePart(Year,Sauda_date)As Varchar(11)) +'-' + Cast(DatePart(Year,Sauda_date)+ 1 As Varchar(11)) End)     
From level1mis     
Where Sauda_date >= @FromDate and Sauda_date <= @Todate + ' 23:59:00'    
    
Update Level1Mis Set     
Actbrok = A.Actbrok ,AngelBrok = Rembrok From     
Mis.remisior.dbo.angelremcalc A    
Where    
Level1Mis.Exchangesegment = ( Case When Coname = 'ACDLFO' Then 'NSEFO' When Coname = 'ACPLNCDX' Then 'NCDX' When Coname = 'ACPLMCX'    
Then 'MCDX' When Coname = 'ABLCM' Then 'BSECM' When Coname = 'ACDLCM' Then 'NSECM' Else '---' End)    
And    
Left(Convert(Varchar,Level1Mis.sauda_date,109),11)= Left(Convert(Varchar,A.sauda_date,109),11)    
And    
Level1Mis.Sauda_date >= @FromDate and Level1Mis.Sauda_date <= @Todate + ' 23:59:00'    
And     
Level1Mis.Party_code = A.Party_code    
    
    
Delete  LevelRemMis Where Sauda_date >= Left(Convert(Varchar,dateadd(day,-4,@FromDate),109),11) and Sauda_date <= @Todate + ' 23:59:00'    
    
Insert Into  LevelRemMis Select * From    
(    
Select Exchangesegment = ( Case When Coname = 'ACDLFO' Then 'NSEFO' When Coname = 'ACPLNCDX' Then 'NCDX' When Coname = 'ACPLMCX'    
Then 'MCDX' When Coname = 'ABLCM' Then 'BSECM' When Coname = 'ACDLCM' Then 'NSECM' Else '---' End),Sauda_date = Sauda_date,Party_code,Branch_Cd =  '',Sub_Broker = '',    
Actbrok = max(Actbrok),AngelBrok = Min(Rembrok)     
From Mis.remisior.dbo.angelremcalc Where Sauda_date >= Left(Convert(Varchar,dateadd(day,-4,@FromDate),109),11) and Sauda_date <= @Todate + ' 23:59:00'     
Group By Coname,Party_code,Sauda_date ) A    
    
Update LevelRemMis set Branch_cd = Abranch_Cd,Sub_Broker = ASub_Broker From    
middleware.mimansa.Dbo.AngelClientSummary A    
Where    
A.Party_code = LevelRemmis.Party_code    
And    
Sauda_date >= Left(Convert(Varchar,dateadd(day,-4,@FromDate),109),11) and Sauda_date <= @Todate + ' 23:59:00'    
    
Exec Level1QMisUp '',''    
    
Print 'Updated Finmoth and year'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_calcTO
-- --------------------------------------------------
CREATE procedure usp_calcTO --'04','2006'  
@month varchar(2),  
@year varchar(4)  
as  
begin  
declare @date varchar(2)  
set @date='31'  
  
while not (select  isdate(@month+'/'+@date+'/'+@year))= 1  
begin  
set @date=cast(@date as int)-1  
  
select [E - broking TO by Amt]=sum(case when terminal_id in ('204','209','223','232','233','234','235','224','236','225','240','241','242','243','244','727','733','734','735','736','737','738','739','740','741','742')then tpa+tsa+dpa+dsa else 0 end),  
       [TO By Amt]=sum(tpa+tsa+dpa+dsa),[E- Brok Turn Over By Shares]=sum(case when terminal_id in ('204','209','223','232','233','234','235','224','236','225','240','241','242','243','244','727','733','734','735','736','737','738','739','740','741','742'
) then dp+ds+ts+tp else 0 end),   
       [TO By Shares]=sum(dp+ds+ts+tp) from bsedb_ab.dbo.level1mis where sauda_date>=cast((@month+'/'+'01/'+@year) as datetime) and sauda_date<=cast((@month+'/'+@date+'/'+@year) as datetime)  
	and exchangesegment='BSECM'
  
end  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CHART_TEST
-- --------------------------------------------------
 
 CREATE PROCEDURE USP_CHART_TEST
 
 AS
 
 CREATE TABLE #TEMP
 (
	MDATE VARCHAR(11),
	TURNOVER MONEY,
	DIFF MONEY,
	PER FLOAT
 )
 
 INSERT INTO #TEMP
 EXEC EBROK_TURNOVER1 '01/01/2011','14/01/2011','A'
 
 SELECT MDATE,TURNOVER FROM #TEMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_display_rpt_UT
-- --------------------------------------------------
CREATE proc USP_display_rpt_UT  
(@branchcd varchar(50))
as  
SELECT Fld_SrNo,branch_cd,Sub_Broker,clt_code,turnover FROM tbl_Rpt_UT where Flag = 'TFB2B' and branch_cd=@branchcd
order by branch_cd,turnover desc   
SELECT Fld_SrNo,branch_cd,Sub_Broker,clt_code,turnover FROM tbl_Rpt_UT where Flag = 'BFB2B' and branch_cd=@branchcd
order by branch_cd,turnover  
SELECT Fld_SrNo,branch_cd,Sub_Broker,clt_code,turnover FROM tbl_Rpt_UT where Flag = 'TFB2C' and branch_cd=@branchcd
order by branch_cd,turnover desc  
SELECT Fld_SrNo,branch_cd,Sub_Broker,clt_code,turnover FROM tbl_Rpt_UT where Flag = 'BFB2C' and branch_cd=@branchcd
order by branch_cd,turnover  

SELECT top 5 Fld_SrNo,branch_cd,Sub_Broker,clt_code,turnover,to_trd_fut,to_del_opt,Receipt,Payment  
FROM tbl_Rpt_UT where Flag = 'IAB2B' and branch_cd=@branchcd order by branch_cd,turnover

SELECT top 5 Fld_SrNo,branch_cd,Sub_Broker,clt_code,turnover,to_trd_fut,to_del_opt,Receipt,Payment
FROM tbl_Rpt_UT where Flag = 'IAB2C' and branch_cd=@branchcd order by branch_cd,turnover

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_EbrokingCreationDate
-- --------------------------------------------------
CREATE  proc dbo.USP_EbrokingCreationDate (@fdays as int)                          
as                          
set nocount on       
declare @fdate as varchar(25),@tdate as varchar(25)             
select @fdate= min(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)         
select @tdate= max(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)            
--print @fdate         
           
         
              
select distinct partycode,EBrokingDate,TrainingDate,Duration into #file_ebrok                                
from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)      
       
--where convert(datetime,ebrokingcreation,103) >=convert(datetime,@fdate,103)                
--and convert(datetime,ebrokingcreation,103) <=convert(datetime,@tdate,103)                                             
--select party_code,user_stat,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,sauda_date=convert(datetime,sauda_date,103)                
-- into #brok_temp                
 --from mis_ebroking_cli (nolock)                
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays                 
-----------------------------------------------------------------    
select party_code,terminal_id,ablcm_brk=(case when company='ABLCM' then sum(brokerage) end),      
acdlcm_brk=(case when company='ACDLCM' then sum(brokerage) end),      
acdlfo_brk=(case when company='ACDLFO' then sum(brokerage) end),      
mcx_brok=(case when company='ACPLMCX' then sum(brokerage) end),      
ncdx_brok=(case when company='ACPLNCDEX' then sum(brokerage) end),      
mcd_brok=(case when company='ACPLMCD' then sum(brokerage) end),      
brokerage=sum(brokerage),cnt=count(party_code),      
sauda_date=convert(datetime,sauda_date,103),Offline='Yes'                
into #brok_temp                 
from mis_to (nolock)                
where sauda_date>=convert(datetime,@fdate,103)-@fdays      
 and sauda_date<=convert(datetime,@tdate,103)+ @fdays      
group by party_code,company,sauda_date,terminal_id      
order by party_code       

/*
declare @fdate as varchar(25),@tdate as varchar(25) ,@fdays  as int    
set @fdays=15       
select @fdate= min(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)         
select @tdate= max(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)            
*/

select  clientcode,dt=convert(datetime,date),nol=count(1) into #logs
from [196.1.115.211].bidb.dbo.ebrokingfds_oct_09 with (nolock)
where convert(datetime,date)>=@fdate
and convert(datetime,date)<=convert(datetime,@tdate)+@fdays
group by clientcode,convert(datetime,date)

  
--select * from #brok_temp where sauda_date>='JAn 01 2010' and party_code='A47589'
--select * from mis.remisior.dbo.ebrok_terminal_master      where terminal_id=24003
     

select segment,terminal_id,from_date,to_date into #ff from mis.remisior.dbo.ebrok_terminal_master          
update #brok_temp set Offline='No'  from #ff b where #brok_temp.terminal_id=b.terminal_id      
and #brok_temp.sauda_date>=b.from_date and #brok_temp.sauda_date<=b.to_date      
---------------------------------------------------------------                
select b.partycode,        
tbrokoff_bse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then ablcm_brk else 0 end,                        
tbrokoff_nse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then acdlcm_brk else 0 end,                        
tbrokoff_fo=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then acdlfo_brk else 0 end,                       
 tbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then mcx_brok else 0 end,                        
tbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then ncdx_brok else 0 end,                        
tbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then mcd_brok else 0 end,               
tbrokoff_tot=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then brokerage else 0 end,                 
tbrokon_bse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then ablcm_brk else 0 end,                        
tbrokon_nse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then acdlcm_brk else 0 end,                       
 tbrokon_fo=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then acdlfo_brk else 0 end,                        
tbrokon_mcx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then mcx_brok else 0 end,                        
tbrokon_ncx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then ncdx_brok else 0 end,                        
tbrokon_mcd=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then mcd_brok else 0 end,                          
tbrokon_tot=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then brokerage else 0 end,                          
tcnton=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then 1 else 0 end                              
into #file2                          
from   #file_ebrok b left outer join #brok_temp  a (nolock) on b.partycode=a.party_code collate SQL_Latin1_General_CP1_CI_AS                          
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays  
                         
group by b.partycode,a.sauda_date,b.EBrokingDate,a.ablcm_brk,a.acdlcm_brk,a.acdlfo_brk,a.mcx_brok,a.ncdx_brok,Offline ,a.brokerage,a.mcd_brok                                                 
  
select partycode,        
tbrokoff_bse=sum(tbrokoff_bse),tbrokoff_nse=sum(tbrokoff_nse),tbrokoff_fo=sum(tbrokoff_fo),tbrokoff_mcx=sum(tbrokoff_mcx),        
tbrokoff_ncx=sum(tbrokoff_ncx),tbrokoff_mcd=sum(tbrokoff_mcd),tbrokoff_tot=sum(tbrokoff_tot),        
tbrokon_bse=sum(tbrokon_bse),tbrokon_nse=sum(tbrokon_nse),tbrokon_fo=sum(tbrokon_fo),tbrokon_mcx=sum(tbrokon_mcx),        
tbrokon_ncx=sum(tbrokon_ncx),tbrokon_mcd=sum(tbrokon_mcd),tbrokon_tot=sum(tbrokon_tot),tcnton=sum(tcnton)        
into #file3 from #file2 group by partycode                                                 
  
select distinct a.partycode,a.TrainingDate,a.duration,c.branch,c.region,c.zone,a.EBrokingDate,       
 b.tbrokoff_bse as offline_after_bse,b.tbrokoff_nse as offline_after_nse,b.tbrokoff_fo as offline_after_fo,      
b.tbrokoff_mcx as offline_after_mcx,b.tbrokoff_ncx as offline_after_ncx,b.tbrokoff_mcd as offline_after_mcd,b.tbrokoff_tot as offline_after_total,          
b.tbrokon_bse as online_after_bse,b.tbrokon_nse as online_after_nse,b.tbrokon_fo as online_after_fo,      
b.tbrokon_mcx as online_after_mcx,b.tbrokon_ncx as online_after_ncx,b.tbrokon_mcd as online_after_mcd,b.tbrokon_tot as online_after_total,tcnton as online_after_logins     
into #f from #file3 b join #file_ebrok a                        
on b.partycode=a.partycode         
join risk.dbo.Vw_RMS_Client_Vertical c (nolock) on b.partycode=c.client order by a.partycode                                       
--delete from mis.upload.dbo.ebrok_training_temp                  
select a.*,nol=sum(isnull(nol,0)) into #file
from #f a     
left outer join
#logs b           
on a.partycode=b.clientcode  
and dt>=ebrokingdate and dt<=ebrokingdate+@fdays
group by partycode,TrainingDate,duration,branch,region,zone,EBrokingDate,offline_after_bse,offline_after_nse,offline_after_fo,offline_after_mcx,offline_after_ncx,offline_after_mcd,offline_after_total,online_after_bse,online_after_nse,online_after_fo,online_after_mcx,online_after_ncx,online_after_mcd,online_after_total,online_after_logins

select * from #file

set nocount oFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_EbrokingCreationDate_backup
-- --------------------------------------------------
CREATE  proc dbo.USP_EbrokingCreationDate_backup (@fdays as int)                              
as                              
set nocount on           
declare @fdate as varchar(25),@tdate as varchar(25)           
select @fdate= min(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)       
select @tdate= max(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)          
--print @fdate       
         
       
            
select distinct partycode,EBrokingDate,TrainingDate,Duration into #file_ebrok                              
from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)                 
--where convert(datetime,ebrokingcreation,103) >=convert(datetime,@fdate,103)                    
--and convert(datetime,ebrokingcreation,103) <=convert(datetime,@tdate,103)                            
                           
--select party_code,user_stat,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,sauda_date=convert(datetime,sauda_date,103)                    
-- into #brok_temp                     
--from mis_ebroking_cli (nolock)                    
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays                     
-----------------------------------------------------------------        
select party_code,terminal_id,ablcm_brk=(case when company='ABLCM' then sum(brokerage) end),          
acdlcm_brk=(case when company='ACDLCM' then sum(brokerage) end),          
acdlfo_brk=(case when company='ACDLFO' then sum(brokerage) end),          
mcx_brok=(case when company='ACPLMCX' then sum(brokerage) end),          
ncdx_brok=(case when company='ACPLNCDEX' then sum(brokerage) end),          
mcd_brok=(case when company='ACPLMCD' then sum(brokerage) end),          
brokerage=sum(brokerage),cnt=count(party_code),          
sauda_date=convert(datetime,sauda_date,103),Offline='Yes'                    
into #brok_temp                     
from mis_to (nolock)                    
where sauda_date>=convert(datetime,@fdate,103)-@fdays           
and sauda_date<=convert(datetime,@tdate,103)+ @fdays          
group by party_code,company,sauda_date,terminal_id          
order by party_code           
        
select segment,terminal_id,from_date,to_date into #ff from mis.remisior.dbo.ebrok_terminal_master  with (Nolock)          
          
update #brok_temp set Offline='No'  from #ff b where #brok_temp.terminal_id=b.terminal_id          
and #brok_temp.sauda_date>=b.from_date and #brok_temp.sauda_date<=b.to_date          
---------------------------------------------------------------                    
select b.partycode,            
tbrokoff_bse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='Yes'  then ablcm_brk else 0 end,                            
tbrokoff_nse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='Yes'  then acdlcm_brk else 0 end,                            
tbrokoff_fo=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='Yes'  then acdlfo_brk else 0 end,                            
tbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='Yes'  then mcx_brok else 0 end,                            
tbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='Yes'  then ncdx_brok else 0 end,                            
tbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='Yes'  then mcd_brok else 0 end,                   
tbrokoff_tot=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='Yes'  then brokerage else 0 end,                   
        
tbrokon_bse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then ablcm_brk else 0 end,                            
tbrokon_nse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then acdlcm_brk else 0 end,                            
tbrokon_fo=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then acdlfo_brk else 0 end,                            
tbrokon_mcx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then mcx_brok else 0 end,                            
tbrokon_ncx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then ncdx_brok else 0 end,                            
tbrokon_mcd=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then mcd_brok else 0 end,                              
tbrokon_tot=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then brokerage else 0 end,                              
tcnton=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.TrainingDate,103) and Offline='No'  then 1 else 0 end                            
            
into #file2                              
from   #file_ebrok b left outer join #brok_temp  a (nolock) on b.partycode=a.party_code collate SQL_Latin1_General_CP1_CI_AS                              
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays                             
group by b.partycode,a.sauda_date,b.EBrokingDate,b.TrainingDate,a.ablcm_brk,a.acdlcm_brk,a.acdlfo_brk,a.mcx_brok,a.ncdx_brok,Offline ,a.brokerage,a.mcd_brok                             
                              
select partycode,            
tbrokoff_bse=sum(tbrokoff_bse),tbrokoff_nse=sum(tbrokoff_nse),tbrokoff_fo=sum(tbrokoff_fo),tbrokoff_mcx=sum(tbrokoff_mcx),            
tbrokoff_ncx=sum(tbrokoff_ncx),tbrokoff_mcd=sum(tbrokoff_mcd),tbrokoff_tot=sum(tbrokoff_tot),            
tbrokon_bse=sum(tbrokon_bse),tbrokon_nse=sum(tbrokon_nse),tbrokon_fo=sum(tbrokon_fo),tbrokon_mcx=sum(tbrokon_mcx),            
tbrokon_ncx=sum(tbrokon_ncx),tbrokon_mcd=sum(tbrokon_mcd),tbrokon_tot=sum(tbrokon_tot),tcnton=sum(tcnton)            
into #file3 from #file2 group by partycode                              
                             
select distinct a.partycode,c.Party_Name,c.branch,c.region,c.zone,a.EBrokingDate,a.TrainingDate,         
b.tbrokoff_bse as offline_after_bse,b.tbrokoff_nse as offline_after_nse,b.tbrokoff_fo as offline_after_fo,        
b.tbrokoff_mcx as offline_after_mcx,b.tbrokoff_ncx as offline_after_ncx,b.tbrokoff_mcd as offline_after_mcd,b.tbrokoff_tot as offline_after_total,            
b.tbrokon_bse as online_after_bse,b.tbrokon_nse as online_after_nse,b.tbrokon_fo as online_after_fo,        
b.tbrokon_mcx as online_after_mcx,b.tbrokon_ncx as online_after_ncx,b.tbrokon_mcd as online_after_mcd,b.tbrokon_tot as online_after_total,tcnton as online_after_logins      
 into #f from #file3 b join #file_ebrok a                          
on b.partycode=a.partycode           
join risk.dbo.Vw_RMS_Client_Vertical c (nolock) on b.partycode=c.client order by a.partycode                       
                          
--delete from mis.upload.dbo.ebrok_training_temp                      
select * from #f                
            
set nocount oFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_EbrokingCreationDate1
-- --------------------------------------------------
create  proc dbo.USP_EbrokingCreationDate1 (@fdays as int)                        
as                        
set nocount on     
declare @fdate as varchar(25),@tdate as varchar(25)           
select @fdate= min(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)       
select @tdate= max(ebrokingdate) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)          
--print @fdate       
         
       
            
select distinct partycode,EBrokingDate,TrainingDate,Duration into #file_ebrok                              
from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)    
     
--where convert(datetime,ebrokingcreation,103) >=convert(datetime,@fdate,103)              
--and convert(datetime,ebrokingcreation,103) <=convert(datetime,@tdate,103)                                           
--select party_code,user_stat,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,sauda_date=convert(datetime,sauda_date,103)              
-- into #brok_temp              
 --from mis_ebroking_cli (nolock)              
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays               
-----------------------------------------------------------------  
select party_code,terminal_id,ablcm_brk=(case when company='ABLCM' then sum(brokerage) end),    
acdlcm_brk=(case when company='ACDLCM' then sum(brokerage) end),    
acdlfo_brk=(case when company='ACDLFO' then sum(brokerage) end),    
mcx_brok=(case when company='ACPLMCX' then sum(brokerage) end),    
ncdx_brok=(case when company='ACPLNCDEX' then sum(brokerage) end),    
mcd_brok=(case when company='ACPLMCD' then sum(brokerage) end),    
brokerage=sum(brokerage),cnt=count(party_code),    
sauda_date=convert(datetime,sauda_date,103),Offline='Yes'              
into #brok_temp               
from mis_to (nolock)              
where sauda_date>=convert(datetime,@fdate,103)-@fdays    
 and sauda_date<=convert(datetime,@tdate,103)+ @fdays    
group by party_code,company,sauda_date,terminal_id    
order by party_code       

select segment,terminal_id,from_date,to_date into #ff from mis.remisior.dbo.ebrok_terminal_master        
update #brok_temp set Offline='No'  from #ff b where #brok_temp.terminal_id=b.terminal_id    
and #brok_temp.sauda_date>=b.from_date and #brok_temp.sauda_date<=b.to_date    
---------------------------------------------------------------              
select b.party_code,      
tbrokoff_bse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then ablcm_brk else 0 end,                      
tbrokoff_nse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then acdlcm_brk else 0 end,                      
tbrokoff_fo=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then acdlfo_brk else 0 end,                     
 tbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then mcx_brok else 0 end,                      
tbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then ncdx_brok else 0 end,                      
tbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then mcd_brok else 0 end,             
tbrokoff_tot=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='Yes'  then brokerage else 0 end,               
tbrokon_bse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then ablcm_brk else 0 end,                      
tbrokon_nse=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then acdlcm_brk else 0 end,                     
 tbrokon_fo=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then acdlfo_brk else 0 end,                      
tbrokon_mcx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then mcx_brok else 0 end,                      
tbrokon_ncx=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then ncdx_brok else 0 end,                      
tbrokon_mcd=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then mcd_brok else 0 end,                        
tbrokon_tot=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then brokerage else 0 end,                        
tcnton=case when a.sauda_date>=convert(datetime,b.EBrokingDate,103) and sauda_date<=convert(datetime,b.EBrokingDate,103)+@fdays and Offline='No'  then 1 else 0 end                            
into #file2                        
from   #file_ebrok b left outer join #brok_temp  a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS                        
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays
                       
group by b.party_code,a.sauda_date,b.EBrokingDate,a.ablcm_brk,a.acdlcm_brk,a.acdlfo_brk,a.mcx_brok,a.ncdx_brok,Offline ,a.brokerage,a.mcd_brok                                               

select party_code,      
tbrokoff_bse=sum(tbrokoff_bse),tbrokoff_nse=sum(tbrokoff_nse),tbrokoff_fo=sum(tbrokoff_fo),tbrokoff_mcx=sum(tbrokoff_mcx),      
tbrokoff_ncx=sum(tbrokoff_ncx),tbrokoff_mcd=sum(tbrokoff_mcd),tbrokoff_tot=sum(tbrokoff_tot),      
tbrokon_bse=sum(tbrokon_bse),tbrokon_nse=sum(tbrokon_nse),tbrokon_fo=sum(tbrokon_fo),tbrokon_mcx=sum(tbrokon_mcx),      
tbrokon_ncx=sum(tbrokon_ncx),tbrokon_mcd=sum(tbrokon_mcd),tbrokon_tot=sum(tbrokon_tot),tcnton=sum(tcnton)      
into #file3 from #file2 group by party_code                                               

select distinct a.party_code,a.name,a.status,c.branch,c.region,c.zone,a.EBrokingDate,     
 b.tbrokoff_bse as offline_after_bse,b.tbrokoff_nse as offline_after_nse,b.tbrokoff_fo as offline_after_fo,    
b.tbrokoff_mcx as offline_after_mcx,b.tbrokoff_ncx as offline_after_ncx,b.tbrokoff_mcd as offline_after_mcd,b.tbrokoff_tot as offline_after_total,        
b.tbrokon_bse as online_after_bse,b.tbrokon_nse as online_after_nse,b.tbrokon_fo as online_after_fo,    
b.tbrokon_mcx as online_after_mcx,b.tbrokon_ncx as online_after_ncx,b.tbrokon_mcd as online_after_mcd,b.tbrokon_tot as online_after_total,tcnton as online_after_logins   
into #f from #file3 b join #file_ebrok a                      
on b.party_code=a.party_code       
join risk.dbo.Vw_RMS_Client_Vertical c (nolock) on b.party_code=c.client order by a.party_code                                     
--delete from mis.upload.dbo.ebrok_training_temp                
select * from #f                
set nocount oFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_EbrokingCreationDatetemp
-- --------------------------------------------------
create  proc dbo.USP_EbrokingCreationDatetemp (@fdays as int)                        
as                        
set nocount on     
declare @fdate as varchar(25),@tdate as varchar(25)     
select @fdate= min(ebrokingcreation) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info     
select @tdate= max(ebrokingcreation) from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info           
select distinct name,partycode as party_code,ebrokingcreation,status into #file_ebrok                        
from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info             
--where convert(datetime,ebrokingcreation,103) >=convert(datetime,@fdate,103)             
 --and convert(datetime,ebrokingcreation,103) <=convert(datetime,@tdate,103)                                          
 --select party_code,user_stat,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,sauda_date=convert(datetime,sauda_date,103)              
-- into #brok_temp               --from mis_ebroking_cli (nolock)              
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays 
              -----------------------------------------------------------------  
select party_code,terminal_id,ablcm_brk=(case when company='ABLCM' then sum(brokerage) end),   
 acdlcm_brk=(case when company='ACDLCM' then sum(brokerage) end),    
acdlfo_brk=(case when company='ACDLFO' then sum(brokerage) end),    
mcx_brok=(case when company='ACPLMCX' then sum(brokerage) end),    
ncdx_brok=(case when company='ACPLNCDEX' then sum(brokerage) end),    
mcd_brok=(case when company='ACPLMCD' then sum(brokerage) end),    
brokerage=sum(brokerage),cnt=count(party_code),   
 sauda_date=convert(datetime,sauda_date,103),Offline='Yes'              
into #brok_temp               
from mis_to (nolock)              
where sauda_date>=convert(datetime,@fdate,103)-@fdays     
and sauda_date<=convert(datetime,@tdate,103)+ @fdays    
group by party_code,company,sauda_date,terminal_id    
order by party_code       

select segment,terminal_id,from_date,to_date into #ff from mis.remisior.dbo.ebrok_terminal_master        
update #brok_temp set Offline='No'  from #ff b where #brok_temp.terminal_id=b.terminal_id    
and #brok_temp.sauda_date>=b.from_date and #brok_temp.sauda_date<=b.to_date    
---------------------------------------------------------------              
select b.party_code,      
tbrokoff_bse=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='Yes'  then ablcm_brk else 0 end,                      
tbrokoff_nse=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='Yes'  then acdlcm_brk else 0 end,                      
tbrokoff_fo=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='Yes'  then acdlfo_brk else 0 end,                      
tbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='Yes'  then mcx_brok else 0 end,                      
tbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='Yes'  then ncdx_brok else 0 end,                      
tbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='Yes'  then mcd_brok else 0 end,             
tbrokoff_tot=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='Yes'  then brokerage else 0 end,               
tbrokon_bse=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then ablcm_brk else 0 end,                      
tbrokon_nse=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then acdlcm_brk else 0 end,                      
tbrokon_fo=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then acdlfo_brk else 0 end,                      
tbrokon_mcx=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then mcx_brok else 0 end,                      
tbrokon_ncx=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then ncdx_brok else 0 end,                      
tbrokon_mcd=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then mcd_brok else 0 end,                        
tbrokon_tot=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then brokerage else 0 end,                        
tcnton=case when a.sauda_date>=convert(datetime,b.ebrokingcreation,103) and sauda_date<=convert(datetime,b.ebrokingcreation,103)+@fdays and Offline='No'  then 1 else 0 end                            
into #file2                        
from   #file_ebrok b left outer join #brok_temp  a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS                        
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays
                       
group by b.party_code,a.sauda_date,b.ebrokingcreation,a.ablcm_brk,a.acdlcm_brk,a.acdlfo_brk,a.mcx_brok,a.ncdx_brok,Offline ,a.brokerage,a.mcd_brok                                               

select party_code,      
tbrokoff_bse=sum(tbrokoff_bse),tbrokoff_nse=sum(tbrokoff_nse),tbrokoff_fo=sum(tbrokoff_fo),tbrokoff_mcx=sum(tbrokoff_mcx),      
tbrokoff_ncx=sum(tbrokoff_ncx),tbrokoff_mcd=sum(tbrokoff_mcd),tbrokoff_tot=sum(tbrokoff_tot),      
tbrokon_bse=sum(tbrokon_bse),tbrokon_nse=sum(tbrokon_nse),tbrokon_fo=sum(tbrokon_fo),tbrokon_mcx=sum(tbrokon_mcx),      
tbrokon_ncx=sum(tbrokon_ncx),tbrokon_mcd=sum(tbrokon_mcd),tbrokon_tot=sum(tbrokon_tot),tcnton=sum(tcnton)      
into #file3 from #file2 group by party_code                                               

select distinct a.party_code,a.name,a.status,c.branch,c.region,c.zone,a.ebrokingcreation,      
b.tbrokoff_bse as offline_after_bse,b.tbrokoff_nse as offline_after_nse,b.tbrokoff_fo as offline_after_fo,    
b.tbrokoff_mcx as offline_after_mcx,b.tbrokoff_ncx as offline_after_ncx,b.tbrokoff_mcd as offline_after_mcd,b.tbrokoff_tot as offline_after_total,       
 b.tbrokon_bse as online_after_bse,b.tbrokon_nse as online_after_nse,b.tbrokon_fo as online_after_fo,    
b.tbrokon_mcx as online_after_mcx,b.tbrokon_ncx as online_after_ncx,b.tbrokon_mcd as online_after_mcd,b.tbrokon_tot as online_after_total,tcnton as online_after_logins   
into #f from #file3 b join #file_ebrok a                      
on b.party_code=a.party_code       
join risk.dbo.Vw_RMS_Client_Vertical c (nolock) on b.party_code=c.client order by a.party_code                                     
--delete from mis.upload.dbo.ebrok_training_temp                
select * from #f               
 set nocount oFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_fds_cashmarket_alertreport
-- --------------------------------------------------
CREATE proc usp_fds_cashmarket_alertreport --'17/11/2009','180','Ablcm','5'        
(        
@date as varchar(11),        
@numberofdays as int,        
@segment as varchar(15),        
@multiply as int        
)        
as        
--declare @date as varchar(11),@numberofdays as int,@segment as varchar(15)        
--set @date='06/11/2009'        
--set @numberofdays=180        
--set @segment='ablcm'        
        
set @date = convert(datetime,@date,103)        
               
select * into #mis_to from mis_to(nolock) where sauda_date >=convert(datetime,@date,103) -180        
and  sauda_date < @date  and company = @segment        
                      
---------------To Calculate no of days total turnover & total del.turnover ------------        
Select distinct party_code,company,sum(turnover)turnover,sum(to_del_opt)as delivery_turnover into #temp        
from #mis_to(nolock)        
group by party_code,company        
---drop table #temp        
--------------------to calculate count of days trade--------------        
Select * into #temp1 from        
(select party_code,count(*)count,company from                       
(select distinct sauda_date,party_code, cnt=count(*),company                      
from #mis_to(nolock)group by sauda_date,party_code,company)a group by party_code,company )x                      
--drop table #temp1                      
--------------------cal--------------------------------------------------                      
Select x.party_code,x.company,count,turnover,Average=@multiply*(turnover/count),delivery_turnover,Del_Based_TO=                      
case when (delivery_turnover=0.00 and turnover=0.00) then '0.00'                      
 when delivery_turnover=0.00 then '0.00'                      
else (delivery_turnover/turnover)*100 end                      
into #alert1                       
from                       
(Select  * from #temp (nolock))x                      
inner join                      
(Select  * from #temp1 (nolock))y                      
on x.party_code=y.party_code                      
--drop table #alert1                      
----------------------------------particular days data--------------------------------------------                      
select distinct party_code,sum(turnover)turnover,sauda_date,sum(to_del_opt)to_del_opt                       
into #mist_todate from mis_to(nolock) where sauda_date = convert(datetime,@date,103)and company =@segment                      
 group by party_code,sauda_date,company                      
--drop table #mist_todate                      
-----------------------------alert one data--------------------------------------------                      
select distinct a.party_code,b.average,a.turnover,error='High Turnover' into #t                       
from                      
(select party_code,turnover,sauda_date,to_del_opt from #mist_todate(nolock))a                      
right outer join                      
(select party_code,average,del_based_to from #alert1(nolock)) b                      
on a.party_code=b.party_code where b.average<a.turnover                       
--drop table #t                      
-----------------------------------alert 2 Del Based Turnover-------------------------------------                      
                      
select a.party_code,b.del_based_to,error='Intraday in Delivery Client' into #alrt11 from                      
(select * from #mist_todate(nolock)where to_del_opt='0.00')a                      
inner join                      
(select distinct party_code,del_based_to from #alert1(nolock) where del_based_to >= '95.00') b                      
on a.party_code=b.party_code                      
--drop table #alrt11                      
--------------------------------------------------------------------------------                      
select distinct party_code=case when a.party_code is null then b.party_code else a.party_code end,                      
del_based_to,average,turnover,                      
Error=case when a.error is not null and b.error is not null then b.error+' & '+a.error                      
when a.error is null then b.error else a.error end into #Mainalert from                      
(select   * from #alrt11(nolock))a                      
full outer join                      
(select  * from #t(nolock))b                 
on a.party_code=b.party_code                      
select * from #Mainalert(nolock)                      

---------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_fds_cashmarket_alertreport_intrday
-- --------------------------------------------------
                      
 CREATE proc [dbo].[Usp_fds_cashmarket_alertreport_intrday]   --'25/11/2009','acdlcm','95','ALL'                                             
(                                             
    @date        AS VARCHAR(11),                                             
    @segment     AS VARCHAR(15),                                             
--           @multiply    AS INT,                                             
       @perc        AS INT,                                             
    @scrip       AS VARCHAR(15)                                             
--           @pl          AS INT,                                             
--           @MrktGrsPerc AS INT,                                             
--           @stkpricvart AS INT                                            
)                                             
AS                                          
SET NOCOUNT ON              
  --declare @date as varchar(11),@date1 as varchar(11),@segment as varchar(15)                           
  --set @date='23/11/2009'                           
  --set @date1='23/11/2009'                           
  --set @segment='ACDLCM'                     
  DECLARE  @exchange  AS VARCHAR(5)                     
                       
--  DECLARE  @pl1  AS INT                     
--                       
--  SET @pl1 = @pl *- 1                     
                       
  IF @scrip = 'HOLDING'                     
    BEGIN                     
      IF @segment = 'ablcm'                     
        BEGIN                     
          SET @exchange = 'BSE'                     
        END                     
      ELSE                     
        IF @segment = 'ACDLCM'                     
          BEGIN                     
            SET @exchange = 'NSE'                     
          END                     
                           
      SELECT TOP 0 *                     
      INTO   #holding                     
      FROM  /* intranet.risk.dbo.holding23112009                     */
      risk.dbo.holding
                           
      DECLARE  @table   AS VARCHAR(50),                     
               @table1  AS VARCHAR(50),                     
               @qry     AS VARCHAR(500),                     
               @date1   AS VARCHAR(11)                     
                           
      SET @table = 'intranet.risk.dbo.holding'                     
                           
--      SET @date = '23/11/2009'                     
                           
      SET @date1 = @date                     
                           
      SET @table1 = @table + Replace(@date,'/','')                     
                           
      SET @qry = 'insert into #holding Select * from ' + @table1 + ' where exchange=''' + @exchange + ''''                     
                           
      --print @qry                     
      EXEC( @qry)                     
                           
      CREATE NONCLUSTERED INDEX ix_#tbl_inward_master ON #holding (                     
            exchange)                     
    END                     
                       
  SET @date = Convert(DATETIME,@date,103)                     
                       
  SELECT *                     
  INTO   #mis_to                     
  FROM   mis_to (nolock)                     
  WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180                     
         AND sauda_date < @date                     
         AND company = @segment                     
                       
  --select top 10 * from mis_to where company='ACDLCM'                           
  --drop table #mis_to                           
  --select * from #mis_to                     
  CREATE NONCLUSTERED INDEX ix_#mis_to ON #mis_to (                     
        sauda_date)                     
                       
  ---------------To Calculate no of days total turnover & total del.turnover ------------                     
  SELECT DISTINCT party_code,                     
                  company,                     
                  Sum(turnover)   turnover,                     
                  Sum(to_del_opt) AS delivery_turnover                     
  INTO     #temp                     
  FROM     #mis_to (nolock)                     
  GROUP BY party_code,                     
           company                     
                       
  ---drop table #temp                     
  --------------------to calculate count of days trade--------------                     
  SELECT *                     
  INTO   #temp1                     
  FROM   (SELECT   party_code,                     
                   Count(* ) COUNT,                     
            company                     
          FROM     (SELECT   DISTINCT sauda_date,                     
                                      party_code,                     
                cnt = Count(* ),                     
                                      company                     
                    FROM     #mis_to (nolock)                     
                    GROUP BY sauda_date,                     
                             party_code,                     
                             company) a                     
          GROUP BY party_code,                     
                   company) x                     
                
  --drop table #temp1                     
  --------------------cal--------------------------------------------------                     
  SELECT x.party_code,                     
         x.company,                     
         COUNT,                     
         turnover,                     
         delivery_turnover,                     
         del_based_to = CASE                     
                          WHEN (delivery_turnover = 0.00                     
                                AND turnover = 0.00)                     
                          THEN '0.00'                     
                          WHEN delivery_turnover = 0.00                     
                          THEN '0.00'                     
                          ELSE (delivery_turnover / turnover) * 100                     
                       END                     
  INTO   #alert1                     
  FROM   (SELECT *                     
          FROM   #temp (nolock)) x                     
         INNER JOIN (SELECT *                     
                     FROM   #temp1 (nolock)) y                     
           ON x.party_code = y.party_code                     
                       
  --drop table #alert1                     
  ----------------------------------particular days data--------------------------------------------                     
  --declare @date as varchar(11),@segment as varchar(15)                     
  --set @date='23/11/2009'                     
  --set @segment='acdlcm'                     
  SELECT DISTINCT party_code,                     
                  Sum(turnover)   turnover,                     
                  sauda_date,                     
                  Sum(to_del_opt) to_del_opt                     
  INTO     #mist_todate                     
  FROM     mis_to (nolock)                     
  WHERE    sauda_date = Convert(DATETIME,@date,103)                     
           AND company = @segment                     
  GROUP BY party_code,                     
           sauda_date,                     
           company                     
                       
  --drop table #mist_todate                     
  -----------------------------------alert 2 Del Based Turnover-------------------------------------                     
  CREATE NONCLUSTERED INDEX ix_#mist_todate ON #mist_todate (                     
        party_code)                     
                       
  CREATE NONCLUSTERED INDEX ix_#alert1 ON #alert1 (                     
        party_code)                     
                       
  SELECT a.party_code,                     
         b.del_based_to,                     
 ERROR = 'Intraday in Delivery Client'                     
  INTO   #alrt11                     
  FROM   (SELECT *                     
          FROM   #mist_todate (nolock)                     
          WHERE  to_del_opt = '0.00') a                     
         INNER JOIN (SELECT DISTINCT party_code,                     
                                     del_based_to                     
                     FROM   #alert1 (nolock)                     
                     WHERE  del_based_to >= @perc) b                     
           ON a.party_code = b.party_code                     
                       
  --drop table #alrt11                     
  --------------------------------------------------------------------------------                                                 
  --declare @date as varchar(11),@segment as varchar(15)                     
  --set @date='23/11/2009'                     
  --set @segment='ACDLCM'                     
  --set @date = convert(datetime,@date,103)                           
  --drop table #main                     
  SELECT TOP 0 party_code,                     
               party_name,                     
               scrip_cd,                     
               scrip_name,                     
               pqtytrd,                     
               pamttrd,                    
               pqtydel,                     
               pamtdel,                     
               sqtytrd,                     
               samttrd,                     
               sqtydel,                     
               samtdel,                     
               sauda_date                     
  INTO   #main                     
  FROM   anand1.msajag.dbo.cmbillvalan                     
              
  ALTER TABLE #main                     
  ALTER COLUMN party_name VARCHAR(100)                     
                       
  IF @segment = 'ABLCM'                     
    BEGIN                     
      INSERT INTO #main                     
      SELECT party_code,                     
             party_name,                     
             scrip_cd,                     
             scrip_name,                     
             pqtytrd,                     
             pamttrd,                 
             pqtydel,                     
             pamtdel,                     
             sqtytrd,                     
             samttrd,                     
             sqtydel,                     
             samtdel,                     
             sauda_date                     
      FROM   anand.bsedb_ab.dbo.cmbillvalan                     
      WHERE  sauda_date = Convert(DATETIME,@date,103)                     
    END                     
  ELSE                     
    IF @segment = 'ACDLCM'                     
      BEGIN                     
        INSERT INTO #main                     
        SELECT party_code,                     
               party_name,                     
               scrip_cd,                     
               scrip_name,                     
               pqtytrd,                     
               pamttrd,                     
               pqtydel,                     
               pamtdel,                     
               sqtytrd,                     
               samttrd,                     
               sqtydel,                     
 samtdel,                     
               sauda_date                     
        FROM   anand1.msajag.dbo.cmbillvalan                     
        WHERE  sauda_date = Convert(DATETIME,@date,103)                     
      END                     
                       
  -----------------------------------------------------------------------------------------------                     
  SELECT TOP 0 *                     
  INTO   #main1                     
  FROM   #main (nolock)                     
                       
  SELECT a.party_code,                     
         b.party_name,                     
         b.scrip_cd,                     
         b.scrip_name,                     
         b.pqtytrd,                     
         b.pamttrd,                     
         b.pqtydel,                     
         b.pamtdel,                     
         b.sqtytrd,                     
         b.samttrd,                     
         b.sqtydel,                     
         b.samtdel,                     
         b.sauda_date                     
  INTO   #abv                     
  FROM   (SELECT *                     
          FROM   #alrt11 (nolock)) a                     
         INNER JOIN (SELECT *                     
                     FROM   #main (nolock)) b                     
           ON a.party_code = b.party_code COLLATE latin1_general_ci_as               
                       
  --drop table #abv                           
  ----drop table #main1                           
  --declare @date as varchar(11),@scrip as varchar(15),@segment as varchar(15)--,@exchange as varchar(5)                           
  --set @date='23/11/2009'                           
  --set @scrip='Ill'                           
  --set @segment='ACDLCM'                           
  --set @date = convert(datetime,@date,103)                     
  CREATE NONCLUSTERED INDEX ix_#abv ON #abv (                     
        scrip_cd)                     
          
  IF @scrip = 'Ill'                     
     AND @segment = 'ABLCM'                     
    BEGIN                     
      INSERT INTO #main1                     
      SELECT DISTINCT a.party_code,                     
                      a.party_name,                     
                      a.scrip_cd,                     
                      a.scrip_name,                     
                      a.pqtytrd,                     
                      a.pamttrd,                     
                      a.pqtydel,                     
                      a.pamtdel,                     
                      a.sqtytrd,                     
                      a.samttrd,                     
                      a.sqtydel,                     
                      a.samtdel,                     
                      a.sauda_date                     
      FROM   (SELECT *                     
              FROM   #abv (nolock)) a                     
             INNER JOIN (SELECT *                     
                         FROM   intranet.misc.dbo.illscrip) b                     
               ON a.scrip_cd = b.scrip_cd                     
    END                     
  ELSE             
    IF @scrip = 'Ill'                     
       AND @segment = 'ACDLCM'                     
      BEGIN                     
        INSERT INTO #main1                     
        SELECT DISTINCT a.party_code,                     
                        a.party_name,                     
                        a.scrip_cd,                     
                        a.scrip_name,                     
                        a.pqtytrd,                     
                        a.pamttrd,                     
                        a.pqtydel,                     
                        a.pamtdel,                     
                        a.sqtytrd,                     
                        a.samttrd,                     
                        a.sqtydel,                     
                        a.samtdel,                     
                        a.sauda_date                     
        FROM   (SELECT *                     
                FROM   #abv (nolock)) a                     
               INNER JOIN (SELECT *                     
                           FROM   intranet.misc.dbo.illscrip_nse) b                     
                 ON a.scrip_cd = b.scrip_cd                     
      END                     
    ELSE                     
      IF @scrip = 'Holding'                     
        BEGIN                     
          IF @exchange = 'BSE'                     
            BEGIN                     
     INSERT INTO #main1                    
              SELECT DISTINCT a.party_code,                     
                              a.party_name,                     
                              a.scrip_cd,                     
                              a.scrip_name,                     
                              a.pqtytrd,                     
                              a.pamttrd,                     
                              a.pqtydel,                     
                              a.pamtdel,                     
                              a.sqtytrd,                     
                              a.samttrd,                     
                              a.sqtydel,                     
                              a.samtdel,                     
                              a.sauda_date                     
              FROM   (SELECT *                     
                FROM   #abv (nolock)) a                     
                     INNER JOIN (SELECT *                     
                                 FROM   #holding) b                     
                       ON a.scrip_cd = b.scrip_cd                     
                          AND a.party_code = b.party_code COLLATE latin1_general_ci_as                     
            END                     
          ELSE                     
            IF @exchange = 'NSE'                     
              BEGIN                     
                INSERT INTO #main1                     
                SELECT DISTINCT a.party_code,                     
                                a.party_name,                     
          a.scrip_cd,                     
a.scrip_name,                     
                                a.pqtytrd,                     
                                a.pamttrd,                     
                                a.pqtydel,                     
                                a.pamtdel,                     
                                a.sqtytrd,                     
                                a.samttrd,                     
                                a.sqtydel,                     
                                a.samtdel,                     
                                a.sauda_date                     
                FROM   (SELECT *                     
                        FROM   #abv (nolock)) a                     
                       INNER JOIN (SELECT *                     
                                   FROM   #holding) b                     
                         ON a.scrip_cd = b.dummy1                     
                            AND a.party_code = b.party_code COLLATE latin1_general_ci_as                     
              END                     
        END                     
      ELSE                     
        IF @scrip = 'All'                     
          BEGIN                     
            INSERT INTO #main1                     
            SELECT *                     
            FROM   #abv (nolock)                     
          END                     
                       
  --drop table #abv                           
  --select * from #main1                           
  ----------------------------------------------------------------------------                     
  SELECT Sum(pamttrd) AS pamttrrd,                     
         Sum(samttrd) AS samttrd,                     
         party_code,                     
         scrip_cd                     
  INTO     #sumamt                     
  FROM     #main1 (nolock)                     
  GROUP BY scrip_cd,                     
           party_code                     
                       
  --drop table #sumamt                            
  ----------------------------------------------------------------------------                     
  SELECT pl = (samttrd - pamttrrd),                     
         party_code,                     
         scrip_cd                     
  INTO   #plill                     
  FROM   #sumamt (nolock)                     
                       
  --drop table #plILL                           
  --------------------------------------------------------------------------------                     
  SELECT CASE                     
           WHEN Sum(pqtytrd) = 0.00                     
           THEN Sum(pamttrd) / (Sum(pqtytrd) + 1)                     
           ELSE Sum(pamttrd) / (Sum(pqtytrd))                     
         END AS buyrate,                     
         CASE                     
           WHEN Sum(sqtytrd) = 0.00                     
           THEN Sum(samttrd) / (Sum(sqtytrd) + 1)                     
           ELSE Sum(samttrd) / (Sum(sqtytrd))                     
         END AS sellrate,                     
         party_code,                     
         scrip_cd                     
  INTO     #tbl                     
  FROM     #main1 (nolock)                     
  GROUP BY scrip_cd,                     
           party_code                     
                       
  --drop table #tbl            
  ----------------------------------------------------------------------------                     
  SELECT Sum(pqtytrd) pqtytrd,                     
         Sum(pqtydel) pqtydel,                     
         Sum(sqtytrd) sqtytrd,                     
         Sum(sqtydel) sqtydel,                     
         scrip_cd,                     
         party_code                     
  INTO     #tbl2                     
  FROM     #main1                     
  GROUP BY scrip_cd,                     
           party_code                     
                       
  --drop table #tbl2                           
  ------------------------------------------------------------------------------                     
  SELECT *,                     
         ratediff = (sellrate - buyrate)                     
  INTO   #tbl1                     
  FROM   #tbl (nolock)                     
      
  --drop table #tbl1                           
  -------------------------------------------------------------------------------------------                     
  SELECT stkprcvariation = ((sellrate - buyrate) / buyrate) * 100,                     
         party_code,                   
         scrip_cd,                     
         sellrate,                     
         buyrate                     
  INTO   #main3                     
  FROM   #tbl1 (nolock)                     
  WHERE  buyrate <> 0.00                     
         AND sellrate <> 0.00                     
                       
  --drop table #main3                            
  ---------------------------------------------------------------------------                     
  SELECT Sum(pqtytrd) pqt,                     
         Sum(pqtydel) pdqt,                     
         Sum(sqtytrd) sqt,                     
         Sum(sqtydel) sdqt,                     
   scrip_cd,                     
         party_code                     
  INTO     #turn                     
  FROM     #main1 (nolock)                     
  GROUP BY scrip_cd,                     
           party_code                     
                       
  --drop table #turn                           
  --------------------------------------------------------------------------------                     
  SELECT *,                     
         Sum(pqt + pdqt + sqt + sdqt) AS turnover                     
  INTO     #turnover                     
  FROM     #turn (nolock)                     
  GROUP BY scrip_cd,                     
           party_code,                     
           pqt,                     
           pdqt,                     
           sqt,                     
           sdqt                     
                       
  --drop table  #turnover                           
  --------------------------------------------------------------------------                           
  --drop table #percbse                           
  --declare @segment as varchar(10)        
  --set @segment='ABLCM'                                  
  --declare @date as varchar(11)                                        
  --set @date = convert(datetime,'23/11/2009',103)                     
  CREATE NONCLUSTERED INDEX ix_#turnover ON #turnover (                     
        scrip_cd)                     
                       
  IF @segment = 'ablcm'                     
    BEGIN                     
      SELECT party_code,                     
             scrip_cd,                     
             turnover,                     
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.no_of_shrs * 100),                     
             sc_name,                     
             no_of_shrs                     
      INTO   #percbse                     
      FROM   (SELECT *                     
              FROM   #turnover (nolock)) a                     
             LEFT OUTER JOIN (SELECT sc_code,                     
                                     sc_name,                     
                                     no_of_shrs                     
                              FROM   intranet.misc.dbo.qe                     
         WHERE  pddate = @date) b               
               ON a.scrip_cd = b.sc_code                     
    --select * from #illpercbse                     
    END                     
                       
  IF @segment = 'ACDLCM'                     
    BEGIN                     
      SELECT party_code,                     
             scrip_cd,                     
             turnover,                     
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.net_trdqty * 100),                     
             b.security,                     
             net_trdqty                     
      INTO   #percnse                     
      FROM   (SELECT *                     
              FROM   #turnover (nolock)) a                     
             LEFT OUTER JOIN (SELECT symbol,                     
                                     security,                     
                                     net_trdqty                     
                              FROM   intranet.misc.dbo.pd301203                                               WHERE  pddate = @date) b                     
               ON a.scrip_cd = b.symbol                     
    --select * from #illpercnse                     
    END                     
                       
  ------------------------------------------------------------------------------------                           
  --drop table #bse1                           
  --declare @pl1 as int                            
  --set @pl1= @pl*-1                                     
  --declare @segment as varchar(10)                                         
  --set @segment='ABLCM'                     
  IF @segment = 'ABLCM'                     
    BEGIN                     
      SELECT a.party_code,                     
             a.scrip_cd,                     
             a.sc_name,                     
             a.turnover AS turnover,                     
             no_of_shrs AS  Market_Volume,                     
             a.turnoverperc,                     
             b.buyrate,                     
             b.sellrate,                     
             c.stkprcvariation,                     
             d.pl                     
      INTO   #bse1                     
      FROM   (SELECT *                     
              FROM   #percbse (nolock)) a                     
             INNER JOIN (SELECT *                     
                         FROM   #tbl1 (nolock)) b                     
               ON a.party_code = b.party_code                     
                  AND a.scrip_cd = b.scrip_cd                     
             INNER JOIN (SELECT *                     
                         FROM   #main3 (nolock)) c                     
               ON a.party_code = c.party_code             
                  AND a.scrip_cd = c.scrip_cd                     
             INNER JOIN (SELECT *                     
                         FROM   #plill (nolock)) d                     
               ON a.party_code = d.party_code                     
                  AND a.scrip_cd = d.scrip_cd                     
                           
      -----                     
      SELECT f.*,                     
             e.pqtytrd,                     
             e.pqtydel,                     
             e.sqtytrd,                     
             e.sqtydel                
      INTO   #cashbse                     
      FROM   (SELECT *                     
              FROM   #bse1 (nolock)) f                     
             INNER JOIN (SELECT *                     
                         FROM   #tbl2 (nolock)) e                     
               ON f.party_code = e.party_code                     
                  AND f.scrip_cd = e.scrip_cd                     
                           
      SELECT   *         
      FROM     #cashbse (nolock)                     
--      WHERE    pl NOT BETWEEN @pl1 AND @pl                     
--                OR turnoverperc >= @MrktGrsPerc                     
--                OR stkprcvariation >= @stkpricvart                     
      ORDER BY party_code,                     
      scrip_cd                     
    END                     
  ELSE                     
    IF @segment = 'ACDLCM'                     
      BEGIN                     
        SELECT a.party_code,                     
               a.scrip_cd,                     
               security,                     
               turnover   AS turnover,                     
               net_trdqty AS Market_Volume,                     
               turnoverperc,                     
               b.buyrate,                     
               b.sellrate,                     
               stkprcvariation,                     
               pl                     
        INTO   #nse1                     
        FROM   (SELECT party_code,                     
                       scrip_cd,                     
                       turnover,                     
                       turnoverperc,                     
                       security,                     
                       net_trdqty                     
                FROM   #percnse (nolock)) a                     
               INNER JOIN (SELECT buyrate,                     
                                  sellrate,                     
                                  party_code,                     
                                  scrip_cd,                     
                                  ratediff                     
  FROM   #tbl1 (nolock)) b                     
                 ON a.party_code = b.party_code                     
                    AND a.scrip_cd = b.scrip_cd                     
               INNER JOIN (SELECT stkprcvariation,                     
                                  party_code,                     
                                  scrip_cd,                     
                                  sellrate,                     
                                  buyrate                     
                           FROM   #main3 (nolock)) c                     
                 ON a.party_code = c.party_code                    
                    AND a.scrip_cd = c.scrip_cd                     
               INNER JOIN (SELECT pl,                     
                                  party_code,                     
                                  scrip_cd                     
                           FROM   #plill (nolock)) d                     
                 ON a.party_code = d.party_code                     
                    AND a.scrip_cd = d.scrip_cd                     
                             
        ---                     
        SELECT f.*,                     
         e.pqtytrd,                     
               e.pqtydel,                     
               e.sqtytrd,                     
               e.sqtydel                     
        INTO   #cashnse                     
        FROM   (SELECT pqtytrd,                     
                       pqtydel,                     
                       sqtytrd,                     
                       sqtydel,                     
                       scrip_cd,                     
                       party_code                     
                FROM   #tbl2 (nolock)) e                     
               INNER JOIN (SELECT *                     
                           FROM   #nse1 (nolock)) f                     
                 ON f.party_code = e.party_code                     
                    AND f.scrip_cd = e.scrip_cd                     
                             
        SELECT   a.*,b.sub_broker,b.branch_cd        
        FROM     #cashnse a  inner join ( select sub_broker,branch_cd ,party_code from risk.dbo.client_details )b  ON a.party_code = b.party_code                     
--        WHERE    pl NOT BETWEEN @pl1 AND @pl                     
--                 OR turnoverperc >= @MrktGrsPerc                     
--                  OR stkprcvariation >= @stkpricvart                     
        ORDER BY party_code,                     
         scrip_cd               
           
  
                 
      END                     
      ---------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_fds_cashmarket_alertreport_intrday_new
-- --------------------------------------------------

CREATE PROC Usp_fds_cashmarket_alertreport_intrday_new --'25/11/2009','ACDLCM','95','ALL','200','5','5'                 
(                 
    @date        AS VARCHAR(11),                 
    @segment     AS VARCHAR(15),                 
--           @multiply    AS INT,                 
       @perc        AS INT,                 
    @scrip       AS VARCHAR(15),
@access_to varchar(25),                 
@access_code varchar(25)
--           @pl          AS INT,                 
--           @MrktGrsPerc AS INT,                 
--           @stkpricvart AS INT                
)                 
AS              
SET NOCOUNT ON          
  --declare @date as varchar(11),@date1 as varchar(11),@segment as varchar(15)                       
  --set @date='23/11/2009'                       
  --set @date1='23/11/2009'                       
  --set @segment='ACDLCM'                 
  DECLARE  @exchange  AS VARCHAR(5)                 
                   
--  DECLARE  @pl1  AS INT                 
--                   
--  SET @pl1 = @pl *- 1                 
                   
  IF @scrip = 'HOLDING'                 
    BEGIN                 
      IF @segment = 'ablcm'                 
        BEGIN                 
          SET @exchange = 'BSE'                 
        END                 
      ELSE                 
        IF @segment = 'ACDLCM'                 
          BEGIN                 
            SET @exchange = 'NSE'                 
          END                 
                       
      SELECT TOP 0 *                 
      INTO   #holding                 
      FROM   intranet.risk.dbo.holding23112009                 
                       
      DECLARE  @table   AS VARCHAR(50),                 
               @table1  AS VARCHAR(50),                 
               @qry     AS VARCHAR(500),                 
               @date1   AS VARCHAR(11)                 
                       
      SET @table = 'intranet.risk.dbo.holding'                 
                       
--      SET @date = '23/11/2009'                 
                       
      SET @date1 = @date                 
                       
      SET @table1 = @table + Replace(@date,'/','')                 
                       
      SET @qry = 'insert into #holding Select * from ' + @table1 + ' where exchange=''' + @exchange + ''''                 
                       
      --print @qry                 
      EXEC( @qry)                 
                       
      CREATE NONCLUSTERED INDEX ix_#tbl_inward_master ON #holding (                 
            exchange)                 
    END                 
                   
  SET @date = Convert(DATETIME,@date,103)                 
                   
  SELECT *                 
  INTO   #mis_to                 
  FROM   mis_to (nolock)                 
  WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180                 
         AND sauda_date < @date                 
         AND company = @segment                 
                   
  --select top 10 * from mis_to where company='ACDLCM'                       
  --drop table #mis_to                       
  --select * from #mis_to                 
  CREATE NONCLUSTERED INDEX ix_#mis_to ON #mis_to (                 
        sauda_date)                 
                   
  ---------------To Calculate no of days total turnover & total del.turnover ------------                 
  SELECT DISTINCT party_code,                 
                  company,                 
                  Sum(turnover)   turnover,                 
                  Sum(to_del_opt) AS delivery_turnover                 
  INTO     #temp                 
  FROM     #mis_to (nolock)                 
  GROUP BY party_code,                 
           company                 
                   
  ---drop table #temp                 
  --------------------to calculate count of days trade--------------                 
  SELECT *                 
  INTO   #temp1                 
  FROM   (SELECT   party_code,                 
                   Count(* ) COUNT,                 
            company                 
          FROM     (SELECT   DISTINCT sauda_date,                 
                                      party_code,                 
                cnt = Count(* ),                 
                                      company                 
                    FROM     #mis_to (nolock)                 
                    GROUP BY sauda_date,                 
                             party_code,                 
                             company) a                 
          GROUP BY party_code,                 
                   company) x                 
            
  --drop table #temp1                 
  --------------------cal--------------------------------------------------                 
  SELECT x.party_code,                 
         x.company,                 
         COUNT,                 
         turnover,                 
         delivery_turnover,                 
         del_based_to = CASE                 
                          WHEN (delivery_turnover = 0.00                 
                                AND turnover = 0.00)                 
                          THEN '0.00'                 
                          WHEN delivery_turnover = 0.00                 
                          THEN '0.00'                 
                          ELSE (delivery_turnover / turnover) * 100                 
                       END                 
  INTO   #alert1                 
  FROM   (SELECT *                 
          FROM   #temp (nolock)) x                 
         INNER JOIN (SELECT *                 
                     FROM   #temp1 (nolock)) y                 
           ON x.party_code = y.party_code                 
                   
  --drop table #alert1                 
  ----------------------------------particular days data--------------------------------------------                 
  --declare @date as varchar(11),@segment as varchar(15)                 
  --set @date='23/11/2009'                 
  --set @segment='acdlcm'                 
  SELECT DISTINCT party_code,                 
                  Sum(turnover)   turnover,                 
                  sauda_date,                 
                  Sum(to_del_opt) to_del_opt                 
  INTO     #mist_todate                 
  FROM     mis_to (nolock)                 
  WHERE    sauda_date = Convert(DATETIME,@date,103)                 
           AND company = @segment                 
  GROUP BY party_code,                 
           sauda_date,                 
           company                 
                   
  --drop table #mist_todate                 
  -----------------------------------alert 2 Del Based Turnover-------------------------------------                 
  CREATE NONCLUSTERED INDEX ix_#mist_todate ON #mist_todate (                 
        party_code)                 
                   
  CREATE NONCLUSTERED INDEX ix_#alert1 ON #alert1 (                 
        party_code)                 
                   
  SELECT a.party_code,                 
         b.del_based_to,                 
         ERROR = 'Intraday in Delivery Client'                 
  INTO   #alrt11                 
  FROM   (SELECT *                 
          FROM   #mist_todate (nolock)                 
          WHERE  to_del_opt = '0.00') a                 
         INNER JOIN (SELECT DISTINCT party_code,                 
                                     del_based_to                 
                     FROM   #alert1 (nolock)                 
                     WHERE  del_based_to >= @perc) b                 
           ON a.party_code = b.party_code                 
                   
  --drop table #alrt11                 
  --------------------------------------------------------------------------------                                             
  --declare @date as varchar(11),@segment as varchar(15)                 
  --set @date='23/11/2009'                 
  --set @segment='ACDLCM'                 
  --set @date = convert(datetime,@date,103)                       
  --drop table #main                 
  SELECT TOP 0 party_code,                 
               party_name,                 
               scrip_cd,                 
               scrip_name,                 
               pqtytrd,                 
               pamttrd,                
               pqtydel,                 
               pamtdel,                 
               sqtytrd,                 
               samttrd,                 
               sqtydel,                 
               samtdel,                 
               sauda_date                 
  INTO   #main                 
  FROM   anand1.msajag.dbo.cmbillvalan                 
          
  ALTER TABLE #main                 
  ALTER COLUMN party_name VARCHAR(100)                 
                   
  IF @segment = 'ABLCM'                 
    BEGIN                 
      INSERT INTO #main                 
      SELECT party_code,                 
             party_name,                 
             scrip_cd,                 
             scrip_name,                 
             pqtytrd,                 
             pamttrd,             
             pqtydel,                 
             pamtdel,                 
             sqtytrd,                 
             samttrd,                 
             sqtydel,                 
             samtdel,                 
             sauda_date                 
      FROM   anand.bsedb_ab.dbo.cmbillvalan                 
      WHERE  sauda_date = Convert(DATETIME,@date,103)                 
    END                 
  ELSE                 
    IF @segment = 'ACDLCM'                 
      BEGIN                 
        INSERT INTO #main                 
        SELECT party_code,                 
               party_name,                 
               scrip_cd,                 
               scrip_name,                 
               pqtytrd,                 
               pamttrd,                 
               pqtydel,                 
               pamtdel,                 
               sqtytrd,                 
               samttrd,                 
               sqtydel,                 
 samtdel,                 
               sauda_date                 
        FROM   anand1.msajag.dbo.cmbillvalan                 
        WHERE  sauda_date = Convert(DATETIME,@date,103)                 
      END                 
                   
  -----------------------------------------------------------------------------------------------                 
  SELECT TOP 0 *                 
  INTO   #main1                 
  FROM   #main (nolock)                 
                   
  SELECT a.party_code,                 
         b.party_name,                 
         b.scrip_cd,                 
         b.scrip_name,                 
         b.pqtytrd,                 
         b.pamttrd,                 
         b.pqtydel,                 
         b.pamtdel,                 
         b.sqtytrd,                 
         b.samttrd,                 
         b.sqtydel,                 
         b.samtdel,                 
         b.sauda_date                 
  INTO   #abv                 
  FROM   (SELECT *                 
          FROM   #alrt11 (nolock)) a                 
         INNER JOIN (SELECT *                 
                     FROM   #main (nolock)) b                 
           ON a.party_code = b.party_code COLLATE latin1_general_ci_as             
                   
  --drop table #abv                       
  ----drop table #main1                       
  --declare @date as varchar(11),@scrip as varchar(15),@segment as varchar(15)--,@exchange as varchar(5)                       
  --set @date='23/11/2009'                       
  --set @scrip='Ill'                       
  --set @segment='ACDLCM'                       
  --set @date = convert(datetime,@date,103)                 
  CREATE NONCLUSTERED INDEX ix_#abv ON #abv (                 
        scrip_cd)                 
      
  IF @scrip = 'Ill'                 
     AND @segment = 'ABLCM'                 
    BEGIN                 
      INSERT INTO #main1                 
      SELECT DISTINCT a.party_code,                 
                      a.party_name,                 
                      a.scrip_cd,                 
                      a.scrip_name,                 
                      a.pqtytrd,                 
                      a.pamttrd,                 
                      a.pqtydel,                 
                      a.pamtdel,                 
                      a.sqtytrd,                 
                      a.samttrd,                 
                      a.sqtydel,                 
                      a.samtdel,                 
                      a.sauda_date                 
      FROM   (SELECT *                 
              FROM   #abv (nolock)) a                 
             INNER JOIN (SELECT *                 
                         FROM   intranet.misc.dbo.illscrip) b                 
               ON a.scrip_cd = b.scrip_cd                 
    END                 
  ELSE         
    IF @scrip = 'Ill'                 
       AND @segment = 'ACDLCM'                 
      BEGIN                 
        INSERT INTO #main1                 
        SELECT DISTINCT a.party_code,                 
                        a.party_name,                 
                        a.scrip_cd,                 
                        a.scrip_name,                 
                        a.pqtytrd,                 
                        a.pamttrd,                 
                        a.pqtydel,                 
                        a.pamtdel,                 
                        a.sqtytrd,                 
                        a.samttrd,                 
                        a.sqtydel,                 
                        a.samtdel,                 
                        a.sauda_date                 
        FROM   (SELECT *                 
                FROM   #abv (nolock)) a                 
               INNER JOIN (SELECT *                 
                           FROM   intranet.misc.dbo.illscrip_nse) b                 
                 ON a.scrip_cd = b.scrip_cd                 
      END                 
    ELSE                 
      IF @scrip = 'Holding'                 
        BEGIN                 
          IF @exchange = 'BSE'                 
            BEGIN                 
              INSERT INTO #main1                
              SELECT DISTINCT a.party_code,                 
                              a.party_name,                 
                              a.scrip_cd,                 
                              a.scrip_name,                 
                              a.pqtytrd,                 
                              a.pamttrd,                 
                              a.pqtydel,                 
                              a.pamtdel,                 
                              a.sqtytrd,                 
                              a.samttrd,                 
                              a.sqtydel,                 
                              a.samtdel,                 
                              a.sauda_date                 
              FROM   (SELECT *                 
                    FROM   #abv (nolock)) a                 
                     INNER JOIN (SELECT *                 
                                 FROM   #holding) b                 
                       ON a.scrip_cd = b.scrip_cd                 
                          AND a.party_code = b.party_code COLLATE latin1_general_ci_as                 
            END                 
          ELSE                 
            IF @exchange = 'NSE'                 
              BEGIN                 
                INSERT INTO #main1                 
                SELECT DISTINCT a.party_code,                 
                                a.party_name,                 
          a.scrip_cd,                 
a.scrip_name,                 
                                a.pqtytrd,                 
                                a.pamttrd,                 
                                a.pqtydel,                 
                                a.pamtdel,                 
                                a.sqtytrd,                 
                                a.samttrd,                 
                                a.sqtydel,                 
                                a.samtdel,                 
                                a.sauda_date                 
                FROM   (SELECT *                 
                        FROM   #abv (nolock)) a                 
                       INNER JOIN (SELECT *                 
                                   FROM   #holding) b                 
                         ON a.scrip_cd = b.dummy1                 
                            AND a.party_code = b.party_code COLLATE latin1_general_ci_as                 
              END                 
        END                 
      ELSE                 
        IF @scrip = 'All'                 
          BEGIN                 
            INSERT INTO #main1                 
            SELECT *                 
            FROM   #abv (nolock)                 
          END                 
                   
  --drop table #abv                       
  --select * from #main1                       
  ----------------------------------------------------------------------------                 
  SELECT Sum(pamttrd) AS pamttrrd,                 
         Sum(samttrd) AS samttrd,                 
         party_code,                 
         scrip_cd                 
  INTO     #sumamt                 
  FROM     #main1 (nolock)                 
  GROUP BY scrip_cd,                 
           party_code                 
                   
  --drop table #sumamt                        
  ----------------------------------------------------------------------------                 
  SELECT pl = (samttrd - pamttrrd),                 
         party_code,                 
         scrip_cd                 
  INTO   #plill                 
  FROM   #sumamt (nolock)                 
                   
  --drop table #plILL                       
  --------------------------------------------------------------------------------                 
  SELECT CASE                 
           WHEN Sum(pqtytrd) = 0.00                 
           THEN Sum(pamttrd) / (Sum(pqtytrd) + 1)                 
           ELSE Sum(pamttrd) / (Sum(pqtytrd))                 
         END AS buyrate,                 
         CASE                 
           WHEN Sum(sqtytrd) = 0.00                 
           THEN Sum(samttrd) / (Sum(sqtytrd) + 1)                 
           ELSE Sum(samttrd) / (Sum(sqtytrd))                 
         END AS sellrate,                 
         party_code,                 
         scrip_cd                 
  INTO     #tbl                 
  FROM     #main1 (nolock)                 
  GROUP BY scrip_cd,                 
           party_code                 
                   
  --drop table #tbl        
  ----------------------------------------------------------------------------                 
  SELECT Sum(pqtytrd) pqtytrd,                 
         Sum(pqtydel) pqtydel,                 
         Sum(sqtytrd) sqtytrd,                 
         Sum(sqtydel) sqtydel,                 
         scrip_cd,                 
         party_code                 
  INTO     #tbl2                 
  FROM     #main1                 
  GROUP BY scrip_cd,                 
           party_code                 
                   
  --drop table #tbl2                       
  ------------------------------------------------------------------------------                 
  SELECT *,                 
         ratediff = (sellrate - buyrate)                 
  INTO   #tbl1                 
  FROM   #tbl (nolock)                 
  
  --drop table #tbl1                       
  -------------------------------------------------------------------------------------------                 
  SELECT stkprcvariation = ((sellrate - buyrate) / buyrate) * 100,                 
         party_code,               
         scrip_cd,                 
         sellrate,                 
         buyrate                 
  INTO   #main3                 
  FROM   #tbl1 (nolock)                 
  WHERE  buyrate <> 0.00                 
         AND sellrate <> 0.00                 
                   
  --drop table #main3                        
  ---------------------------------------------------------------------------                 
  SELECT Sum(pqtytrd) pqt,                 
         Sum(pqtydel) pdqt,                 
         Sum(sqtytrd) sqt,                 
         Sum(sqtydel) sdqt,                 
   scrip_cd,                 
         party_code                 
  INTO     #turn                 
  FROM     #main1 (nolock)                 
  GROUP BY scrip_cd,                 
           party_code                 
                   
  --drop table #turn                       
  --------------------------------------------------------------------------------                 
  SELECT *,                 
         Sum(pqt + pdqt + sqt + sdqt) AS turnover                 
  INTO     #turnover                 
  FROM     #turn (nolock)                 
  GROUP BY scrip_cd,                 
           party_code,                 
           pqt,                 
           pdqt,                 
           sqt,                 
           sdqt                 
                   
  --drop table  #turnover                       
  --------------------------------------------------------------------------                       
  --drop table #percbse                       
  --declare @segment as varchar(10)                                     
  --set @segment='ABLCM'                              
  --declare @date as varchar(11)                                    
  --set @date = convert(datetime,'23/11/2009',103)                 
  CREATE NONCLUSTERED INDEX ix_#turnover ON #turnover (                 
        scrip_cd)                 
                   
  IF @segment = 'ablcm'                 
    BEGIN                 
      SELECT party_code,                 
             scrip_cd,                 
             turnover,                 
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.no_of_shrs * 100),                 
             sc_name,                 
             no_of_shrs                 
      INTO   #percbse                 
      FROM   (SELECT *                 
              FROM   #turnover (nolock)) a                 
             LEFT OUTER JOIN (SELECT sc_code,                 
                                     sc_name,                 
                                     no_of_shrs                 
                              FROM   intranet.misc.dbo.qe                 
         WHERE  pddate = @date) b                 
               ON a.scrip_cd = b.sc_code                 
    --select * from #illpercbse                 
    END                 
                   
  IF @segment = 'ACDLCM'                 
    BEGIN                 
      SELECT party_code,                 
             scrip_cd,                 
             turnover,                 
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.net_trdqty * 100),                 
             b.security,                 
             net_trdqty                 
      INTO   #percnse                 
      FROM   (SELECT *                 
              FROM   #turnover (nolock)) a                 
             LEFT OUTER JOIN (SELECT symbol,                 
                                     security,                 
                                     net_trdqty                 
                              FROM   intranet.misc.dbo.pd301203                                               WHERE  pddate = @date) b                 
               ON a.scrip_cd = b.symbol                 
    --select * from #illpercnse                 
    END                 
                   
  ------------------------------------------------------------------------------------                       
  --drop table #bse1                       
  --declare @pl1 as int                        
  --set @pl1= @pl*-1                                 
  --declare @segment as varchar(10)                                     
  --set @segment='ABLCM'                 
  IF @segment = 'ABLCM'                 
    BEGIN                 
      SELECT a.party_code,                 
             a.scrip_cd,                 
             a.sc_name,                 
             a.turnover AS turnover,                 
             no_of_shrs AS totalnoofshares,                 
             a.turnoverperc,                 
             b.buyrate,                 
             b.sellrate,                 
             c.stkprcvariation,                 
             d.pl                 
      INTO   #bse1                 
      FROM   (SELECT *                 
              FROM   #percbse (nolock)) a                 
             INNER JOIN (SELECT *                 
                         FROM   #tbl1 (nolock)) b                 
               ON a.party_code = b.party_code                 
                  AND a.scrip_cd = b.scrip_cd                 
             INNER JOIN (SELECT *                 
                         FROM   #main3 (nolock)) c                 
               ON a.party_code = c.party_code                 
                  AND a.scrip_cd = c.scrip_cd                 
             INNER JOIN (SELECT *                 
                         FROM   #plill (nolock)) d                 
               ON a.party_code = d.party_code                 
                  AND a.scrip_cd = d.scrip_cd                 
                       
      -----                 
      SELECT f.*,                 
             e.pqtytrd,                 
             e.pqtydel,                 
             e.sqtytrd,                 
             e.sqtydel            
      INTO   #cashbse                 
      FROM   (SELECT *                 
              FROM   #bse1 (nolock)) f                 
             INNER JOIN (SELECT *                 
                         FROM   #tbl2 (nolock)) e                 
               ON f.party_code = e.party_code                 
                  AND f.scrip_cd = e.scrip_cd                 
                       
      SELECT   *     
      FROM     #cashbse (nolock)                 
--      WHERE    pl NOT BETWEEN @pl1 AND @pl                 
--                OR turnoverperc >= @MrktGrsPerc                 
--                OR stkprcvariation >= @stkpricvart                 
      ORDER BY party_code,                 
               scrip_cd                 
    END                 
  ELSE                 
    IF @segment = 'ACDLCM'                 
      BEGIN                 
        SELECT a.party_code,                 
               a.scrip_cd,                 
               security,                 
               turnover   AS turnover,                 
               net_trdqty AS totalnoofshares,                 
               turnoverperc,                 
               b.buyrate,                 
               b.sellrate,                 
               stkprcvariation,                 
               pl                 
        INTO   #nse1                 
        FROM   (SELECT party_code,                 
                       scrip_cd,                 
                       turnover,                 
                       turnoverperc,                 
                       security,                 
                       net_trdqty                 
                FROM   #percnse (nolock)) a                 
               INNER JOIN (SELECT buyrate,                 
                                  sellrate,                 
                                  party_code,                 
                                  scrip_cd,                 
                                  ratediff                 
  FROM   #tbl1 (nolock)) b                 
                 ON a.party_code = b.party_code                 
                    AND a.scrip_cd = b.scrip_cd                 
               INNER JOIN (SELECT stkprcvariation,                 
                                  party_code,                 
                                  scrip_cd,                 
                                  sellrate,                 
                                  buyrate                 
                           FROM   #main3 (nolock)) c                 
                 ON a.party_code = c.party_code                
                    AND a.scrip_cd = c.scrip_cd                 
               INNER JOIN (SELECT pl,                 
                                  party_code,                 
                                  scrip_cd                 
                           FROM   #plill (nolock)) d                 
                 ON a.party_code = d.party_code                 
                    AND a.scrip_cd = d.scrip_cd                 
                         
        ---                 
        SELECT f.*,                 
               e.pqtytrd,                 
               e.pqtydel,                 
               e.sqtytrd,                 
               e.sqtydel                 
        INTO   #cashnse                 
        FROM   (SELECT pqtytrd,                 
                       pqtydel,                 
                       sqtytrd,                 
                       sqtydel,                 
                       scrip_cd,                 
                       party_code                 
                FROM   #tbl2 (nolock)) e                 
               INNER JOIN (SELECT *                 
                           FROM   #nse1 (nolock)) f                 
                 ON f.party_code = e.party_code                 
                    AND f.scrip_cd = e.scrip_cd                 
                         
        SELECT   *    
        FROM     #cashnse (nolock)                 
--        WHERE    pl NOT BETWEEN @pl1 AND @pl                 
--                 OR turnoverperc >= @MrktGrsPerc                 
--                  OR stkprcvariation >= @stkpricvart                 
        ORDER BY party_code,                 
         scrip_cd                 
      END                 
      ---------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_fds_cashmarket_alertreport_intrday_test
-- --------------------------------------------------

CREATE PROC Usp_fds_cashmarket_alertreport_intrday_test --'05/01/2010','ACDLCM','95','ALL','200','5','5'         
(         
           @date        AS VARCHAR(11),         
           @segment     AS VARCHAR(15),         
--           @multiply    AS INT,         
           @perc        AS INT,         
           @scrip       AS VARCHAR(15)       
--           @pl          AS INT,         
--           @MrktGrsPerc AS INT,         
--           @stkpricvart AS INT        
)         
AS         
  --declare @date as varchar(11),@date1 as varchar(11),@segment as varchar(15)               
  --set @date='23/11/2009'               
  --set @date1='23/11/2009'               
  --set @segment='ACDLCM'         
  DECLARE  @exchange  AS VARCHAR(5)         
           
  DECLARE  @pl1  AS INT         
           
--  SET @pl1 = @pl *- 1         
           
  IF @scrip = 'HOLDING'         
    BEGIN         
      IF @segment = 'ablcm'         
        BEGIN         
          SET @exchange = 'BSE'         
        END         
      ELSE         
        IF @segment = 'ACDLCM'         
          BEGIN         
            SET @exchange = 'NSE'         
          END         
               
      SELECT TOP 0 *         
      INTO   #holding         
      FROM   intranet.risk.dbo.holding23112009         
               
      DECLARE  @table   AS VARCHAR(50),         
               @table1  AS VARCHAR(50),         
               @qry     AS VARCHAR(500),         
               @date1   AS VARCHAR(11)         
               
      SET @table = 'intranet.risk.dbo.holding'         
               
--      SET @date = '23/11/2009'         
               
      SET @date1 = @date         
               
      SET @table1 = @table + Replace(@date,'/','')         
               
      SET @qry = 'insert into #holding Select * from ' + @table1 + ' where exchange=''' + @exchange + ''''         
               
      --print @qry         
      EXEC( @qry)         
               
      CREATE NONCLUSTERED INDEX ix_#tbl_inward_master ON #holding (         
            exchange)         
    END         
           
  SET @date = Convert(DATETIME,@date,103)         
           
  SELECT *         
  INTO   #mis_to         
  FROM   mis_to (nolock)         
  WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180         
         AND sauda_date < @date         
         AND company = @segment         
           
  --select top 10 * from mis_to where company='ACDLCM'               
  --drop table #mis_to               
  --select * from #mis_to         
  CREATE NONCLUSTERED INDEX ix_#mis_to ON #mis_to (         
        sauda_date)         
           
  ---------------To Calculate no of days total turnover & total del.turnover ------------         
  SELECT DISTINCT party_code,         
                  company,         
                  Sum(turnover)   turnover,         
                  Sum(to_del_opt) AS delivery_turnover         
  INTO     #temp         
  FROM     #mis_to (nolock)         
  GROUP BY party_code,         
           company         
           
  ---drop table #temp         
  --------------------to calculate count of days trade--------------         
  SELECT *         
  INTO   #temp1         
  FROM   (SELECT   party_code,         
                   Count(* ) COUNT,         
                   company         
          FROM     (SELECT   DISTINCT sauda_date,         
                                      party_code,         
                                      cnt = Count(* ),         
                                      company         
                    FROM     #mis_to (nolock)         
                    GROUP BY sauda_date,         
                             party_code,         
                             company) a         
          GROUP BY party_code,         
                   company) x         
           
  --drop table #temp1         
  --------------------cal--------------------------------------------------         
  SELECT x.party_code,         
         x.company,         
         COUNT,         
         turnover,         
         delivery_turnover,         
         del_based_to = CASE         
                          WHEN (delivery_turnover = 0.00         
                                AND turnover = 0.00)         
                          THEN '0.00'         
                          WHEN delivery_turnover = 0.00         
                          THEN '0.00'         
                          ELSE (delivery_turnover / turnover) * 100         
                       END         
  INTO   #alert1         
  FROM   (SELECT *         
          FROM   #temp (nolock)) x         
         INNER JOIN (SELECT *         
                     FROM   #temp1 (nolock)) y         
           ON x.party_code = y.party_code         
           
  --drop table #alert1         
  ----------------------------------particular days data--------------------------------------------         
  --declare @date as varchar(11),@segment as varchar(15)         
  --set @date='23/11/2009'         
  --set @segment='acdlcm'         
  SELECT DISTINCT party_code,         
                  Sum(turnover)   turnover,         
                  sauda_date,         
                  Sum(to_del_opt) to_del_opt         
  INTO     #mist_todate         
  FROM     mis_to (nolock)         
  WHERE    sauda_date = Convert(DATETIME,@date,103)         
           AND company = @segment         
  GROUP BY party_code,         
           sauda_date,         
           company         
           
  --drop table #mist_todate         
  -----------------------------------alert 2 Del Based Turnover-------------------------------------         
  CREATE NONCLUSTERED INDEX ix_#mist_todate ON #mist_todate (         
        party_code)         
           
  CREATE NONCLUSTERED INDEX ix_#alert1 ON #alert1 (         
        party_code)         
           
  SELECT a.party_code,         
         b.del_based_to,         
         ERROR = 'Intraday in Delivery Client'         
  INTO   #alrt11         
  FROM   (SELECT *         
          FROM   #mist_todate (nolock)         
          WHERE  to_del_opt = '0.00') a         
         INNER JOIN (SELECT DISTINCT party_code,         
                                     del_based_to         
                     FROM   #alert1 (nolock)         
                     WHERE  del_based_to >= @perc) b         
           ON a.party_code = b.party_code         
           
  --drop table #alrt11         
  --------------------------------------------------------------------------------                                     
  --declare @date as varchar(11),@segment as varchar(15)         
  --set @date='23/11/2009'         
  --set @segment='ACDLCM'         
  --set @date = convert(datetime,@date,103)               
  --drop table #main         
  SELECT TOP 0 party_code,         
               party_name,         
               scrip_cd,         
               scrip_name,         
               pqtytrd,         
               pamttrd,         
               pqtydel,         
               pamtdel,         
               sqtytrd,         
               samttrd,         
               sqtydel,         
               samtdel,         
               sauda_date         
  INTO   #main         
  FROM   anand1.msajag.dbo.cmbillvalan         
           
  ALTER TABLE #main         
  ALTER COLUMN party_name VARCHAR(100)         
           
  IF @segment = 'ABLCM'         
    BEGIN         
      INSERT INTO #main         
      SELECT party_code,         
             party_name,         
             scrip_cd,         
             scrip_name,         
             pqtytrd,         
           pamttrd,         
             pqtydel,         
             pamtdel,         
             sqtytrd,         
             samttrd,         
             sqtydel,         
             samtdel,         
             sauda_date         
      FROM   anand.bsedb_ab.dbo.cmbillvalan         
      WHERE  sauda_date = Convert(DATETIME,@date,103)         
    END         
  ELSE         
    IF @segment = 'ACDLCM'         
      BEGIN         
        INSERT INTO #main         
        SELECT party_code,         
               party_name,         
               scrip_cd,         
               scrip_name,         
               pqtytrd,         
               pamttrd,         
               pqtydel,         
               pamtdel,         
               sqtytrd,         
               samttrd,         
               sqtydel,         
 samtdel,         
               sauda_date         
        FROM   anand1.msajag.dbo.cmbillvalan         
        WHERE  sauda_date = Convert(DATETIME,@date,103)         
      END         
           
  -----------------------------------------------------------------------------------------------         
  SELECT TOP 0 *         
  INTO   #main1         
  FROM   #main (nolock)         
           
  SELECT a.party_code,         
         b.party_name,         
         b.scrip_cd,         
         b.scrip_name,         
         b.pqtytrd,         
         b.pamttrd,         
         b.pqtydel,         
         b.pamtdel,         
         b.sqtytrd,         
         b.samttrd,         
         b.sqtydel,         
         b.samtdel,         
         b.sauda_date         
  INTO   #abv         
  FROM   (SELECT *         
          FROM   #alrt11 (nolock)) a         
         INNER JOIN (SELECT *         
                     FROM   #main (nolock)) b         
           ON a.party_code = b.party_code COLLATE latin1_general_ci_as         
           
  --drop table #abv               
  ----drop table #main1               
  --declare @date as varchar(11),@scrip as varchar(15),@segment as varchar(15)--,@exchange as varchar(5)               
  --set @date='23/11/2009'               
  --set @scrip='Ill'               
  --set @segment='ACDLCM'               
  --set @date = convert(datetime,@date,103)         
  CREATE NONCLUSTERED INDEX ix_#abv ON #abv (         
        scrip_cd)         
           
  IF @scrip = 'Ill'         
     AND @segment = 'ABLCM'         
    BEGIN         
      INSERT INTO #main1         
      SELECT DISTINCT a.party_code,         
                      a.party_name,         
                      a.scrip_cd,         
                      a.scrip_name,         
                      a.pqtytrd,         
                      a.pamttrd,         
                      a.pqtydel,         
                      a.pamtdel,         
                      a.sqtytrd,         
                      a.samttrd,         
                      a.sqtydel,         
                      a.samtdel,         
                      a.sauda_date         
      FROM   (SELECT *         
              FROM   #abv (nolock)) a         
             INNER JOIN (SELECT *         
                         FROM   intranet.misc.dbo.illscrip) b         
               ON a.scrip_cd = b.scrip_cd         
    END         
  ELSE         
    IF @scrip = 'Ill'         
       AND @segment = 'ACDLCM'         
      BEGIN         
        INSERT INTO #main1         
        SELECT DISTINCT a.party_code,         
                        a.party_name,         
                        a.scrip_cd,         
                        a.scrip_name,         
                        a.pqtytrd,         
                        a.pamttrd,         
                        a.pqtydel,         
                        a.pamtdel,         
                        a.sqtytrd,         
                 a.samttrd,         
                        a.sqtydel,         
                        a.samtdel,         
                        a.sauda_date         
        FROM   (SELECT *         
                FROM   #abv (nolock)) a         
               INNER JOIN (SELECT *         
                           FROM   intranet.misc.dbo.illscrip_nse) b         
                 ON a.scrip_cd = b.scrip_cd         
      END         
    ELSE         
      IF @scrip = 'Holding'         
        BEGIN         
          IF @exchange = 'BSE'         
            BEGIN         
              INSERT INTO #main1        
              SELECT DISTINCT a.party_code,         
                              a.party_name,         
                              a.scrip_cd,         
                              a.scrip_name,         
                              a.pqtytrd,         
                              a.pamttrd,         
                              a.pqtydel,         
                              a.pamtdel,         
                              a.sqtytrd,         
                              a.samttrd,         
                              a.sqtydel,         
                              a.samtdel,         
                              a.sauda_date         
              FROM   (SELECT *         
                      FROM   #abv (nolock)) a         
                     INNER JOIN (SELECT *         
                                 FROM   #holding) b         
                       ON a.scrip_cd = b.scrip_cd         
                          AND a.party_code = b.party_code COLLATE latin1_general_ci_as         
            END         
          ELSE         
            IF @exchange = 'NSE'         
              BEGIN         
                INSERT INTO #main1         
                SELECT DISTINCT a.party_code,         
                                a.party_name,         
                                a.scrip_cd,         
a.scrip_name,         
                                a.pqtytrd,         
                                a.pamttrd,         
                                a.pqtydel,         
                                a.pamtdel,         
                                a.sqtytrd,         
                                a.samttrd,         
                                a.sqtydel,         
                                a.samtdel,         
                                a.sauda_date         
                FROM   (SELECT *         
                        FROM   #abv (nolock)) a         
                       INNER JOIN (SELECT *         
                                   FROM   #holding) b         
                         ON a.scrip_cd = b.dummy1         
                            AND a.party_code = b.party_code COLLATE latin1_general_ci_as         
              END         
        END         
      ELSE         
        IF @scrip = 'All'         
          BEGIN         
            INSERT INTO #main1         
            SELECT *         
            FROM   #abv (nolock)         
          END         
           
  --drop table #abv               
  --select * from #main1               
  ----------------------------------------------------------------------------         
  SELECT Sum(pamttrd) AS pamttrrd,         
         Sum(samttrd) AS samttrd,         
         party_code,         
         scrip_cd         
  INTO     #sumamt         
  FROM     #main1 (nolock)         
  GROUP BY scrip_cd,         
           party_code         
           
  --drop table #sumamt                
  ----------------------------------------------------------------------------         
  SELECT pl = (samttrd - pamttrrd),         
         party_code,         
         scrip_cd         
  INTO   #plill         
  FROM   #sumamt (nolock)         
           
  --drop table #plILL               
  --------------------------------------------------------------------------------         
  SELECT CASE         
           WHEN Sum(pqtytrd) = 0.00         
           THEN Sum(pamttrd) / (Sum(pqtytrd) + 1)         
           ELSE Sum(pamttrd) / (Sum(pqtytrd))         
         END AS buyrate,         
         CASE         
           WHEN Sum(sqtytrd) = 0.00         
           THEN Sum(samttrd) / (Sum(sqtytrd) + 1)         
           ELSE Sum(samttrd) / (Sum(sqtytrd))         
         END AS sellrate,         
         party_code,         
         scrip_cd         
  INTO     #tbl         
  FROM     #main1 (nolock)         
  GROUP BY scrip_cd,         
           party_code         
           
  --drop table #tbl               
  ----------------------------------------------------------------------------         
  SELECT Sum(pqtytrd) pqtytrd,         
         Sum(pqtydel) pqtydel,         
         Sum(sqtytrd) sqtytrd,         
         Sum(sqtydel) sqtydel,         
         scrip_cd,         
         party_code         
  INTO     #tbl2         
  FROM     #main1         
  GROUP BY scrip_cd,         
           party_code         
           
  --drop table #tbl2               
  ------------------------------------------------------------------------------         
  SELECT *,         
         ratediff = (sellrate - buyrate)         
  INTO   #tbl1         
  FROM   #tbl (nolock)         
           
  --drop table #tbl1               
  -------------------------------------------------------------------------------------------         
  SELECT stkprcvariation = ((sellrate - buyrate) / buyrate) * 100,         
         party_code,       
         scrip_cd,         
         sellrate,         
         buyrate         
  INTO   #main3         
  FROM   #tbl1 (nolock)         
  WHERE  buyrate <> 0.00         
         AND sellrate <> 0.00         
           
  --drop table #main3                
  ---------------------------------------------------------------------------         
  SELECT Sum(pqtytrd) pqt,         
         Sum(pqtydel) pdqt,         
         Sum(sqtytrd) sqt,         
         Sum(sqtydel) sdqt,         
         scrip_cd,         
         party_code         
  INTO     #turn         
  FROM     #main1 (nolock)         
  GROUP BY scrip_cd,         
           party_code         
           
  --drop table #turn               
  --------------------------------------------------------------------------------         
  SELECT *,         
         Sum(pqt + pdqt + sqt + sdqt) AS turnover         
  INTO     #turnover         
  FROM     #turn (nolock)         
  GROUP BY scrip_cd,         
           party_code,         
           pqt,         
           pdqt,         
           sqt,         
           sdqt         
           
  --drop table  #turnover               
  --------------------------------------------------------------------------               
  --drop table #percbse               
  --declare @segment as varchar(10)                             
  --set @segment='ABLCM'                      
  --declare @date as varchar(11)                            
  --set @date = convert(datetime,'23/11/2009',103)         
  CREATE NONCLUSTERED INDEX ix_#turnover ON #turnover (         
        scrip_cd)         
           
  IF @segment = 'ablcm'         
    BEGIN         
      SELECT party_code,         
             scrip_cd,         
             turnover,         
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.no_of_shrs * 100),         
             sc_name,         
             no_of_shrs         
      INTO   #percbse         
      FROM   (SELECT *         
              FROM   #turnover (nolock)) a         
             LEFT OUTER JOIN (SELECT sc_code,         
                                     sc_name,         
               no_of_shrs         
                              FROM   intranet.misc.dbo.qe         
                              WHERE  pddate = @date) b         
               ON a.scrip_cd = b.sc_code         
    --select * from #illpercbse         
    END         
           
  IF @segment = 'ACDLCM'         
    BEGIN         
      SELECT party_code,         
             scrip_cd,         
             turnover,         
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.net_trdqty * 100),         
             b.security,         
             net_trdqty         
      INTO   #percnse         
      FROM   (SELECT *         
              FROM   #turnover (nolock)) a         
             LEFT OUTER JOIN (SELECT symbol,         
                                     security,         
                                     net_trdqty         
                              FROM   intranet.misc.dbo.pd301203         
                              WHERE  pddate = @date) b         
               ON a.scrip_cd = b.symbol         
    --select * from #illpercnse         
    END         
           
  ------------------------------------------------------------------------------------               
  --drop table #bse1               
  --declare @pl1 as int                
  --set @pl1= @pl*-1                         
  --declare @segment as varchar(10)                             
  --set @segment='ABLCM'         
  IF @segment = 'ABLCM'         
    BEGIN         
      SELECT a.party_code,         
             a.scrip_cd,         
             a.sc_name,         
             a.turnover AS turnover,         
             no_of_shrs AS totalnoofshares,         
             a.turnoverperc,         
             b.buyrate,         
             b.sellrate,         
             c.stkprcvariation,         
             d.pl         
      INTO   #bse1         
      FROM   (SELECT *         
              FROM   #percbse (nolock)) a         
             INNER JOIN (SELECT *         
                         FROM   #tbl1 (nolock)) b         
               ON a.party_code = b.party_code         
                  AND a.scrip_cd = b.scrip_cd         
             INNER JOIN (SELECT *         
                         FROM   #main3 (nolock)) c         
               ON a.party_code = c.party_code         
                  AND a.scrip_cd = c.scrip_cd         
             INNER JOIN (SELECT *         
                         FROM   #plill (nolock)) d         
               ON a.party_code = d.party_code         
                  AND a.scrip_cd = d.scrip_cd         
               
      -----         
      SELECT f.*,         
             e.pqtytrd,         
             e.pqtydel,         
             e.sqtytrd,         
             e.sqtydel         
      INTO   #cashbse         
      FROM   (SELECT *         
              FROM   #bse1 (nolock)) f         
             INNER JOIN (SELECT *         
                         FROM   #tbl2 (nolock)) e         
               ON f.party_code = e.party_code         
                  AND f.scrip_cd = e.scrip_cd         
               
      SELECT   *         
      FROM     #cashbse (nolock)         
--      WHERE    pl NOT BETWEEN @pl1 AND @pl         
--                OR turnoverperc >= @MrktGrsPerc         
--                OR stkprcvariation >= @stkpricvart         
      ORDER BY party_code,         
               scrip_cd         
    END         
  ELSE         
    IF @segment = 'ACDLCM'         
      BEGIN         
        SELECT a.party_code,         
               a.scrip_cd,         
               security,         
               turnover   AS turnover,         
               net_trdqty AS totalnoofshares,         
               turnoverperc,         
               b.buyrate,         
               b.sellrate,         
              stkprcvariation,         
               pl         
        INTO   #nse1         
        FROM   (SELECT party_code,         
                       scrip_cd,         
                       turnover,         
                       turnoverperc,         
                       security,         
                       net_trdqty         
                FROM   #percnse (nolock)) a         
               INNER JOIN (SELECT buyrate,         
                                  sellrate,         
                                  party_code,         
                                  scrip_cd,         
                                  ratediff         
  FROM   #tbl1 (nolock)) b         
                 ON a.party_code = b.party_code         
                    AND a.scrip_cd = b.scrip_cd         
               INNER JOIN (SELECT stkprcvariation,         
                                  party_code,         
                                  scrip_cd,         
                                  sellrate,         
                                  buyrate         
                           FROM   #main3 (nolock)) c         
                 ON a.party_code = c.party_code        
                    AND a.scrip_cd = c.scrip_cd         
               INNER JOIN (SELECT pl,         
                                  party_code,         
                                  scrip_cd         
                           FROM   #plill (nolock)) d         
                 ON a.party_code = d.party_code         
                    AND a.scrip_cd = d.scrip_cd         
                 
        ---         
        SELECT f.*,         
               e.pqtytrd,         
               e.pqtydel,         
               e.sqtytrd,         
               e.sqtydel         
        INTO   #cashnse         
        FROM   (SELECT pqtytrd,         
                       pqtydel,         
                       sqtytrd,         
                       sqtydel,         
                       scrip_cd,         
                       party_code         
                FROM   #tbl2 (nolock)) e         
               INNER JOIN (SELECT *         
                           FROM   #nse1 (nolock)) f         
                 ON f.party_code = e.party_code         
                    AND f.scrip_cd = e.scrip_cd         
                 
        SELECT   *         
        FROM     #cashnse (nolock)         
--        WHERE    pl NOT BETWEEN @pl1 AND @pl         
--                 OR turnoverperc >= @MrktGrsPerc         
--                  OR stkprcvariation >= @stkpricvart         
        ORDER BY party_code,         
                 scrip_cd         
      END         
      ---------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_fds_Fmarket_alertreport_intrday
-- --------------------------------------------------
  --usp_fds_Fmarket_alertreport_intrday '28/11/2013','XYZ','100'
CREATE  proc usp_fds_Fmarket_alertreport_intrday                
(                  
@date as varchar(11),                  
@Type as varchar(11),              
@perc AS INT    
)                  
as                 
              
/*              
              
declare @date as varchar(11),              
@perc AS INT ,              
@Type as varchar(11)               
set @date = '15/04/2010'              
set @perc = 100              
set @Type = 'XYZ'              
              
*/              
              
create table #Fo_Data_New                  
(                  
s_party_code  varchar(20),                
s_inst_type varchar(25),                
s_symbol varchar(25),                
s_expirydate datetime,                  
s_strike_price money,                
s_user_id varchar(25),                  
s_sell_buy int,                
s_Sell_trdqty int ,                
s_Sell_price money,                
s_Sell_Amt money,                
b_party_code  varchar(20),                
b_inst_type varchar(25),                
b_symbol varchar(25),                
b_expirydate datetime,                  
b_strike_price money,                
b_user_id varchar(25),                  
b_sell_buy int,                
b_Sell_trdqty int ,                
b_Sell_price money,                
b_Sell_Amt money              
)                  
                
                
declare @maxdate as varchar(25)                  
set @maxdate = (select convert(datetime,max(expirydate),103)+'23:59:59.000' from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock))                  
                
                
/*----------------------------If starts------------------------------------------*/                
if convert(datetime,@date,103)+ '23:59:59.000' = getdate()+'23:59:59.000'                  
begin                 
insert into #Fo_Data_New                  
select * from                  
(                
select                 
clientaccount_no as party_code,                
inst_type,                
symbol,convert(datetime,                
expiry_date,103) as expiry_date,                
strike_price,                
user_id,                
buy_sell,                
sum(trade_qty) as S_TrdQty,                
price,                
sum((trade_qty*PRICE)) AS SellAMOUNT                 
                
from [196.1.115.227].general.dbo.nsefodata with(nolock) where buy_sell = '1' group by clientaccount_no,inst_type,                
symbol,expiry_date,strike_price,user_id,buy_sell,price                
)a                
left outer join                
(                
select                 
clientaccount_no,                
inst_type,                
symbol,                
convert(datetime,expiry_date,103) as expiry_date,                
strike_price,                
user_id,                
buy_sell,                
sum(trade_qty) as buytrdqty,                
price,                
sum((trade_qty*PRICE)) AS BuyAMOUNT                 
from [196.1.115.227].general.dbo.nsefodata with(nolock) where buy_sell = '2'                
group by clientaccount_no,inst_type,                
symbol,expiry_date,strike_price,user_id,buy_sell,price                
)b                
on a.party_code=b.clientaccount_no                 
and a.symbol=b.symbol                 
and a.inst_type=b.inst_type                    
and a.expiry_date=b.expiry_date                 
where a.party_code is not null and b.clientaccount_no is not null                 
end                
/*--------------------------------End Of If and Else If Begins ----------------------------------------------*/                
else if convert(datetime,@date,103)+'23:59:59.000' > @maxdate                 
begin                
              
insert into #Fo_Data_New                
select *                
from                 
(                
select                 
party_code as Code,                
inst_type as InstType,                
symbol as S_Symbol,                
expirydate as S_expirydate,                
strike_price as S_strike_price,   
[user_id] as S_user_id,                  
sell_buy as S_sell_buy,                
sum(tradeqty) as S_tradeqty ,                
price  as S_price,                
sum(amount) as S_amount                 
from ANGELFO.nsefo.dbo.Fosettlement with(nolock)                
where  sell_buy='1' and sauda_date >= convert(datetime,@date,103) and                   
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'  group by                 
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy,sauda_date                
)a                
left outer join                
(                
select                 
party_code,                
inst_type,                
symbol,                
expirydate,            
strike_price,                
[user_id],                  
sell_buy,                
sum(tradeqty) as tradeqty,                
price ,                
sum(amount) as amount                 
from ANGELFO.nsefo.dbo.Fosettlement with(nolock)                
where  sell_buy='2' and sauda_date >= convert(datetime,@date,103) and                   
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                  
group by                 
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy,sauda_date                
)b                
on a.Code=b.party_code                 
and a.S_Symbol=b.symbol                 
and a.InstType=b.inst_type                    
and a.S_expirydate=b.expirydate where a.code is not null and b.party_code is not null                 
end                
/*--------------------------------------End Of Else if and Else Begins -----------------------------------------------*/                
else                 
begin                
insert into #Fo_Data_New                
select * from                 
(                
select                 
party_code as Code,                
inst_type as InstType,                
symbol as S_Symbol,                
expirydate as S_expirydate,                
strike_price as S_strike_price,                
[user_id] as S_user_id,                  
sell_buy as S_sell_buy,                
sum(tradeqty) as S_tradeqty ,                
price  as S_price,                
sum(amount) as S_amount                 
from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                
where  sell_buy='1' and sauda_date >= convert(datetime,@date,103) and                   
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'  group by                 
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy                
)a                
left outer join                
(                
select                 
party_code,                
inst_type,                
symbol,                
expirydate,                
strike_price,                
[user_id],                  
sell_buy,                
sum(tradeqty) as tradeqty,                
price ,                
sum(amount) as amount                 
from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                
where  sell_buy='2' and sauda_date >= convert(datetime,@date,103) and                   
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                  
group by                 
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy                
)b                
on a.Code=b.party_code                 
and a.S_Symbol=b.symbol                 
and a.InstType=b.inst_type                    
and a.S_expirydate=b.expirydate where a.code is not null and b.party_code is not null                 
end                
              
/*-----------------------------------------End of Else-------------------------------------------*/                
/*-----------------------------------------Count Of Last 90 days---------------------------------*/                
SELECT party_code,company,turnover,to_del_opt,sauda_date INTO  #mis_to FROM   mis_to (nolock)                           
WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180              
AND sauda_date < Convert(DATETIME,@date,103) +' 23:59:59.000'                          
AND company = 'ACDLFO'              
              
SELECT DISTINCT party_code, company,Sum(turnover) turnover,Sum(to_del_opt)AS delivery_turnover               
INTO #temp               
FROM  #mis_to (nolock) GROUP BY party_code,company              
              
SELECT *               
INTO  #temp1               
FROM                 
(              
SELECT party_code,Count(*) COUNT, company FROM               
(              
SELECT   DISTINCT sauda_date,party_code,cnt = Count(* ),              
company FROM #mis_to (nolock) GROUP BY sauda_date,party_code,company              
) a               
GROUP BY party_code,company)x              
              
              
SELECT x.party_code,x.company,COUNT,turnover,delivery_turnover,              
del_based_to = CASE WHEN (delivery_turnover = 0.00 AND turnover = 0.00) THEN '0.00'               
WHEN delivery_turnover = 0.00 THEN '0.00' ELSE (delivery_turnover / turnover) * 100 END              
INTO   #alert1              
 FROM                 
(SELECT * FROM   #temp (nolock)) x              
INNER JOIN               
(SELECT * FROM   #temp1 (nolock)) y              
ON x.party_code = y.party_code              
              
              
SELECT DISTINCT party_code,Sum(turnover) turnover,sauda_date,Sum(to_del_opt) to_del_opt              
INTO #mist_todate              
FROM  mis_to (nolock)              
WHERE sauda_date = Convert(DATETIME,@date,103) AND company = 'ACDLFO'              
GROUP BY party_code,sauda_date,company              
              
SELECT a.party_code,b.del_based_to,ERROR = 'Intraday in Delivery Client'                           
INTO #alrt11               
FROM              
(SELECT * FROM  #mist_todate (nolock) WHERE  to_del_opt = '0.00') a              
INNER JOIN               
(SELECT DISTINCT party_code,del_based_to FROM #alert1 (nolock) WHERE  del_based_to >= @perc) b                           
ON a.party_code = b.party_code                     
                
/*-------------------------------End Of Last 90 days-------------------------------------------------------*/                
/*---------------------------------illliquid Script data---------------------------------------------------*/                
                
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103) as ex_date                    
into #illfo from intranet.risk.dbo.FDS_IlllScript_Fo  where                  
Sdate >= convert(datetime,@date,103) and                   
Sdate <= convert(datetime,@date,103) + '23:59:59.000'                
              
/*-------------------------------------end od illliquid scrip----------------------------------------------*/                
/*         
select s_party_code as party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,convert(varchar(11),s_expirydate,103) as s_expirydate ,             
convert(decimal(10,2),sum(s_sell_trdqty)) as s_sell_trdqty,convert(decimal(10,2),sum(s_sell_amt)) as s_sell_amt,                
convert(decimal(10,2),s_sell_price) as s_sell_price,convert(decimal(10,2),sum(b_sell_trdqty))as b_sell_trdqty ,convert(decimal(10,2),sum(b_sell_amt)) as b_sell_amt ,convert(decimal(10,2),b_sell_price) as b_sell_price                          
into #final from #Fo_Data_New group by                
s_party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                
s_sell_price ,b_sell_price ,s_expirydate  */          
        
select s_party_code as party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,        
convert(varchar(11),s_expirydate,103) as s_expirydate ,             
floor(sum(s_sell_trdqty)) as s_sell_trdqty,        
floor(sum(s_sell_amt)) as s_sell_amt,                
convert(decimal(10,2),s_sell_price) as s_sell_price,        
floor(sum(b_sell_trdqty))as b_sell_trdqty ,        
floor(sum(b_sell_amt)) as b_sell_amt ,        
convert(decimal(10,2),b_sell_price) as b_sell_price                          
into #final         
from #Fo_Data_New group by         
s_party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                
s_sell_price ,b_sell_price ,s_expirydate          
        
          
                
/*---------------------------------------------------------------------------*/                
if @type = 'Ill'                
begin                 
              
/*              
select a.* into #final from #data1 a inner join #illfo b                  
on a.s_symbol = b.symbol and a.s_strike_price = b.strike_price                 
and a.s_Inst_Type=b.inst_type                  
and convert(varchar(11),a.s_expirydate,103)=b.ex_date                 
order by a.party_code,a.s_symbol                  
*/              
              
select * into #data2 from #final a inner join #illfo b               
on a.s_symbol = b.symbol and a.s_strike_price = b.strike_price                 
and a.s_Inst_Type=b.inst_type                  
and convert(varchar(11),a.s_expirydate,103)=b.ex_date                 
order by a.party_code,a.s_symbol                  
              
select * into #data3 from #data2 where party_code collate SQL_Latin1_General_CP1_CI_AS                
in (select distinct party_code from #alrt11)                 
              
select *,Pl = floor(s_sell_amt - b_sell_amt),                
RateDiff=floor(S_sell_price-B_sell_price),                
Tover=floor(b_sell_trdqty+s_sell_trdqty) into #data4 from #data3           
          
select a.*,case when a.party_code = b.party_code then 'Online' else 'Offline' end as status,
 CASE WHEN isnull(d.mobile_pager,'')='' THEN 'N' ELSE 'Y' END AS Mobile  from          
(select a.*,b.long_name from #data4 a left outer join risk.dbo.client_details b with(nolock)          
on a.party_code = b.party_code)a        
 left outer join intranet.ctcl.dbo.ebrok_client b on a.party_code = b.party_code 
 LEFT OUTER JOIN  risk.dbo.client_details d ON d.cl_code =a.party_code         
order by a.party_code          
              
/*              
select *,Pl = s_sell_amt - b_sell_amt,                
RateDiff=(S_sell_price-B_sell_price),                
Tover=b_sell_trdqty+s_sell_trdqty                 
from  #data1              
*/              
end             
else            
begin            
        
select * into #data1 from #final where party_code               
collate SQL_Latin1_General_CP1_CI_AS                
in (select distinct party_code from #alrt11)                 
              
select * ,Pl = floor(s_sell_amt - b_sell_amt),                
RateDiff=floor(S_sell_price-B_sell_price),                
Tover=floor(b_sell_trdqty+s_sell_trdqty)         
into #data5         
from #data1              
          
select a.*,case when a.party_code = b.party_code then 'Online' else 'Offline' end as status ,
CASE WHEN isnull(d.mobile_pager,'')='' THEN 'N' ELSE 'Y' END AS Mobile ,
a.sub_broker,a.branch_cd  from        
(        
select a.*,b.long_name,b.sub_broker,b.branch_cd from #data5 a left outer join risk.dbo.client_details b with(nolock)          
on a.party_code = b.party_code          
)a          
left outer join intranet.ctcl.dbo.ebrok_client b on a.party_code = b.party_code 
 LEFT OUTER JOIN  risk.dbo.client_details d ON d.cl_code =a.party_code          
order by a.party_code          
        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_fds_Fmarket_alertreport_intrday_Nsefo
-- --------------------------------------------------

CREATE  proc usp_fds_Fmarket_alertreport_intrday_Nsefo --'23/09/2010','All',100,'STATIC','E32755','broker','CSO'                               
(                              
@date as varchar(11),                              
@Type as varchar(11),                          
@perc AS INT,  
@Flag varchar(25),          
@username varchar(25)=Null,       
@access_to   As varchar(25),              
@access_code   As varchar(25)               
)                              
as                             
    Set Nocount On                      
/*                          
                          
declare @date as varchar(11),                          
@perc AS INT ,                          
@Type as varchar(11)                           
set @date = '15/04/2010'                          
set @perc = 100                          
set @Type = 'XYZ'                          
                          
*/                          
                          
create table #Fo_Data_New                              
(                              
s_party_code  varchar(20),                            
s_inst_type varchar(25),                            
s_symbol varchar(25),                            
s_expirydate datetime,                              
s_strike_price money,                            
s_user_id varchar(25),                              
s_sell_buy int,                            
s_Sell_trdqty int ,                            
s_Sell_price money,                            
s_Sell_Amt money,                            
b_party_code  varchar(20),                            
b_inst_type varchar(25),                            
b_symbol varchar(25),                            
b_expirydate datetime,                              
b_strike_price money,                            
b_user_id varchar(25),                              
b_sell_buy int,                            
b_Sell_trdqty int ,                            
b_Sell_price money,                            
b_Sell_Amt money                          
)                              
                            
                            
declare @maxdate as varchar(25)                              
set @maxdate = (select convert(datetime,max(expirydate),103)+'23:59:59.000' from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock))                              
                            
                            
/*----------------------------If starts------------------------------------------*/                            
if convert(datetime,@date,103)+ '23:59:59.000' = getdate()+'23:59:59.000'                              
begin                             
insert into #Fo_Data_New                              
select * from                              
(                            
select                             
clientaccount_no as party_code,                            
inst_type,                            
symbol,convert(datetime,                            
expiry_date,103) as expiry_date,                            
strike_price,                            
user_id,                            
buy_sell,                            
sum(trade_qty) as S_TrdQty,                            
price,                            
sum((trade_qty*PRICE)) AS SellAMOUNT                             
                            
from [196.1.115.233].general.dbo.nsefodata with(nolock) where buy_sell = '1' group by clientaccount_no,inst_type,                            
symbol,expiry_date,strike_price,user_id,buy_sell,price                            
)a                            
left outer join                            
(                            
select                             
clientaccount_no,                            
inst_type,                            
symbol,                            
convert(datetime,expiry_date,103) as expiry_date,             
strike_price,                            
user_id,                            
buy_sell,                            
sum(trade_qty) as buytrdqty,                            
price,                            
sum((trade_qty*PRICE)) AS BuyAMOUNT                             
from [196.1.115.233].general.dbo.nsefodata with(nolock) where buy_sell = '2'                            
group by clientaccount_no,inst_type,                            
symbol,expiry_date,strike_price,user_id,buy_sell,price                            
)b                            
on a.party_code=b.clientaccount_no                           
and a.symbol=b.symbol                             
and a.inst_type=b.inst_type                                
and a.expiry_date=b.expiry_date                             
where a.party_code is not null and b.clientaccount_no is not null                             
end                            
/*--------------------------------End Of If and Else If Begins ----------------------------------------------*/                            
else if convert(datetime,@date,103)+'23:59:59.000' > @maxdate                             
begin                            
                          
insert into #Fo_Data_New                            
select *                   
from                             
(                            
select                             
party_code as Code,                            
inst_type as InstType,                            
symbol as S_Symbol,                            
expirydate as S_expirydate,                            
strike_price as S_strike_price,               
[user_id] as S_user_id,                              
sell_buy as S_sell_buy,                            
sum(tradeqty) as S_tradeqty ,                            
price  as S_price,                            
sum(amount) as S_amount                             
from ANGELFO.nsefo.dbo.Fosettlement with(nolock)                            
where  sell_buy='1' and sauda_date >= convert(datetime,@date,103) and                               
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'  group by                             
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy,sauda_date                            
)a                            
left outer join                            
(                            
select                             
party_code,                            
inst_type,                            
symbol,                            
expirydate,                        
strike_price,                            
[user_id],                              
sell_buy,                            
sum(tradeqty) as tradeqty,                            
price ,                            
sum(amount) as amount                             
from ANGELFO.nsefo.dbo.Fosettlement with(nolock)                            
where  sell_buy='2' and sauda_date >= convert(datetime,@date,103) and                               
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                              
group by                             
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy,sauda_date                            
)b                            
on a.Code=b.party_code                             
and a.S_Symbol=b.symbol                             
and a.InstType=b.inst_type                                
and a.S_expirydate=b.expirydate where a.code is not null and b.party_code is not null                             
end                            
/*--------------------------------------End Of Else if and Else Begins -----------------------------------------------*/                            
else                             
begin                            
insert into #Fo_Data_New                            
select * from           
(                            
select                             
party_code as Code,                            
inst_type as InstType,                            
symbol as S_Symbol,                            
expirydate as S_expirydate,                            
strike_price as S_strike_price,                            
[user_id] as S_user_id,       
sell_buy as S_sell_buy,                            
sum(tradeqty) as S_tradeqty ,                            
price  as S_price,                            
sum(amount) as S_amount                             
from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                            
where  sell_buy='1' and sauda_date >= convert(datetime,@date,103) and                               
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'  group by                             
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy                            
)a                            
left outer join                      
(                            
select                             
party_code,                            
inst_type,                            
symbol,                            
expirydate,                            
strike_price,                            
[user_id],                              
sell_buy,                            
sum(tradeqty) as tradeqty,                            
price ,                    
sum(amount) as amount                             
from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                            
where  sell_buy='2' and sauda_date >= convert(datetime,@date,103) and                               
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                              
group by                             
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy                            
)b                            
on a.Code=b.party_code                             
and a.S_Symbol=b.symbol                             
and a.InstType=b.inst_type                                
and a.S_expirydate=b.expirydate where a.code is not null and b.party_code is not null                             
end                            
                      
/*-----------------------------------------End of Else-------------------------------------------*/                            
/*-----------------------------------------Count Of Last 90 days---------------------------------*/                            
SELECT party_code,company,turnover,to_del_opt,sauda_date INTO  #mis_to FROM   mis_to (nolock)                                       
WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180                          
AND sauda_date < Convert(DATETIME,@date,103) +' 23:59:59.000'                                      
AND company = 'ACDLFO'                          
                          
SELECT DISTINCT party_code, company,Sum(turnover) turnover,Sum(to_del_opt)AS delivery_turnover                           
INTO #temp                           
FROM  #mis_to (nolock) GROUP BY party_code,company                          
                          
SELECT *                           
INTO  #temp1                           
FROM                             
(                          
SELECT party_code,Count(*) COUNT, company FROM                           
(                          
SELECT   DISTINCT sauda_date,party_code,cnt = Count(* ),                          
company FROM #mis_to (nolock) GROUP BY sauda_date,party_code,company                          
) a                           
GROUP BY party_code,company)x                          
                          
                          
SELECT x.party_code,x.company,COUNT,turnover,delivery_turnover,                          
del_based_to = CASE WHEN (delivery_turnover = 0.00 AND turnover = 0.00) THEN '0.00'                           
WHEN delivery_turnover = 0.00 THEN '0.00' ELSE (delivery_turnover / turnover) * 100 END                          
INTO   #alert1                          
 FROM                             
(SELECT * FROM   #temp (nolock)) x                          
INNER JOIN                           
(SELECT * FROM   #temp1 (nolock)) y                          
ON x.party_code = y.party_code                          
                          
               
SELECT DISTINCT party_code,Sum(turnover) turnover,sauda_date,Sum(to_del_opt) to_del_opt                          
INTO #mist_todate                          
FROM  mis_to (nolock)                          
WHERE sauda_date = Convert(DATETIME,@date,103) AND company = 'ACDLFO'                          
GROUP BY party_code,sauda_date,company                          
                          
SELECT a.party_code,b.del_based_to,ERROR = 'Intraday in Delivery Client'                                       
INTO #alrt11                           
FROM                          
(SELECT * FROM  #mist_todate (nolock) WHERE  to_del_opt = '0.00') a                          
INNER JOIN                           
(SELECT DISTINCT party_code,del_based_to FROM #alert1 (nolock) WHERE  del_based_to >= @perc) b                                       
ON a.party_code = b.party_code                                 
                            
/*-------------------------------End Of Last 90 days-------------------------------------------------------*/                            
/*---------------------------------illliquid Script data---------------------------------------------------*/                            
                            
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103) as ex_date                                
into #illfo from intranet.risk.dbo.FDS_IlllScript_Fo  where                              
Sdate >= convert(datetime,@date,103) and                               
Sdate <= convert(datetime,@date,103) + '23:59:59.000'                            
                          
/*-------------------------------------end od illliquid scrip----------------------------------------------*/                            
/*                     
select s_party_code as party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,convert(varchar(11),s_expirydate,103) as s_expirydate ,                         
convert(decimal(10,2),sum(s_sell_trdqty)) as s_sell_trdqty,convert(decimal(10,2),sum(s_sell_amt)) as s_sell_amt,                            
convert(decimal(10,2),s_sell_price) as s_sell_price,convert(decimal(10,2),sum(b_sell_trdqty))as b_sell_trdqty ,convert(decimal(10,2),sum(b_sell_amt)) as b_sell_amt ,convert(decimal(10,2),b_sell_price) as b_sell_price                                      

into #final from #Fo_Data_New group by                            
s_party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                            
s_sell_price ,b_sell_price ,s_expirydate  */                      
                    
select s_party_code as party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                    
convert(varchar(11),s_expirydate,103) as s_expirydate ,                         
floor(sum(s_sell_trdqty)) as s_sell_trdqty,                    
floor(sum(s_sell_amt)) as s_sell_amt,                            
convert(decimal(10,2),s_sell_price) as s_sell_price,                    
floor(sum(b_sell_trdqty))as b_sell_trdqty ,                    
floor(sum(b_sell_amt)) as b_sell_amt ,                    
convert(decimal(10,2),b_sell_price) as b_sell_price                                      
into #final                     
from #Fo_Data_New group by                            
s_party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                            
s_sell_price ,b_sell_price ,s_expirydate                      
          
                      
                            
/*---------------------------------------------------------------------------*/                            
if @type = 'Ill'                            
begin                             
                          
/*                          
select a.* into #final from #data1 a inner join #illfo b                              
on a.s_symbol = b.symbol and a.s_strike_price = b.strike_price                             
and a.s_Inst_Type=b.inst_type                              
and convert(varchar(11),a.s_expirydate,103)=b.ex_date                             
order by a.party_code,a.s_symbol                              
*/                          
                          
select * into #data2 from #final a inner join #illfo b                           
on a.s_symbol = b.symbol and a.s_strike_price = b.strike_price                             
and a.s_Inst_Type=b.inst_type                              
and convert(varchar(11),a.s_expirydate,103)=b.ex_date                             
order by a.party_code,a.s_symbol                              
                          
select * into #data3 from #data2 where party_code collate SQL_Latin1_General_CP1_CI_AS                            
in (select distinct party_code from #alrt11)                             
                          
select *,Pl = floor(s_sell_amt - b_sell_amt),                            
RateDiff=floor(S_sell_price-B_sell_price),                            
Tover=floor(b_sell_trdqty+s_sell_trdqty) into #data4 from #data3                       
                      
select a.*,case when a.party_code = b.party_code then 'Online' else 'Offline' end as status from                      
(select a.*,b.long_name from #data4 a left outer join risk.dbo.client_details b with(nolock)                      
on a.party_code = b.party_code)a                    
 left outer join intranet.ctcl.dbo.ebrok_client b with(nolock) on a.party_code = b.party_code                      
order by a.party_code                      
                          
/*                          
select *,Pl = s_sell_amt - b_sell_amt,                            
RateDiff=(S_sell_price-B_sell_price),                            
Tover=b_sell_trdqty+s_sell_trdqty                             
from  #data1                          
*/                          
end                         
else                        
begin                        
                    
select * into #data1 from #final where party_code                           
collate SQL_Latin1_General_CP1_CI_AS                            
in (select distinct party_code from #alrt11)                             
                          
select * ,Pl = floor(s_sell_amt - b_sell_amt),                            
RateDiff=floor(S_sell_price-B_sell_price),                            
Tover=floor(b_sell_trdqty+s_sell_trdqty)                     
into #data5                     
from #data1                          
                      
select a.*,case when a.party_code = b.party_code then 'ONLINE CLIENT' else 'OFFLINE CLIENT' end as status into #IntraNsefo  from                    
(                    
select a.*,b.long_name from #data5 a left outer join risk.dbo.client_details b with(nolock)                      
on a.party_code = b.party_code                      
)a                      
left outer join intranet.ctcl.dbo.ebrok_client b with(nolock) on a.party_code = b.party_code                      
order by a.party_code            
          
	--Select          
	--PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))       
	--+'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))      
	--+'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''      
	--+');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+       
	--ltrim(rtrim(PARTY_CODE)) +'</a>'          
	--,s_inst_type,s_symbol,s_strike_price,s_user_id,s_expirydate,s_sell_trdqty,s_sell_amt,s_sell_price,b_sell_trdqty,b_sell_amt,b_sell_price,Pl,RateDiff,Tover,long_name,status          
	--from  #IntraNsefo                    
                    
                    
                    
    if(@Flag='STATIC')          
	BEGIN              
		select * from #IntraNsefo      
		--print @username    
	END          
	ELSE          
	BEGIN    
			Select          
			PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))       
			+'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))      
			+'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''      
			+');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+       
			ltrim(rtrim(PARTY_CODE)) +'</a>'          
			,s_inst_type,s_symbol,s_strike_price,s_user_id,s_expirydate,s_sell_trdqty,s_sell_amt,s_sell_price,b_sell_trdqty,b_sell_amt,b_sell_price,Pl,RateDiff,Tover,long_name,status          
			from  #IntraNsefo                         
	END 
 Set Nocount Off          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDS_ILLSCRIPALERT
-- --------------------------------------------------
 
--USP_FDS_ILLSCRIPALERT '28/11/2013','ACDLCM','2000','20','20' 
CREATE  PROCEDURE [dbo].[USP_FDS_ILLSCRIPALERT] --'28/11/2013','ABLCM','2000','20','20'                                                                        
(                                                                          
 @date as varchar(11),                                                                          
 @segment as varchar(15),                                                                          
 @pl as int,                                                                          
 @Illstkpricvart as int,                                                                          
 @IillMrktGrsPerc as int                                                
 --,                                                  
 --@access_to As varchar(25),                                                                   
 --@access_code As varchar(25)                                                                      
)                                                                          
as                                                           
SET NOCOUNT ON                                                                   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                         
set @date = convert(datetime,@date,103)                                                                        
declare @pl1 as int                                                                                       
set @pl1= @pl*-1                                                                   
                                                                     
DECLARE @PREV_DATE DATETIME                                          
SET @PREV_DATE = (SELECT DATEADD(S,-1,DATEADD(MM, DATEDIFF(M,0,@DATE),0)))                                          
                                                       
                                                                  
select top 0 party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                                                        
PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date into #mainill from AngelNseCM.msajag.dbo.cmbillvalan                                                                                
--drop table #mainill                                                                                     
--declare @segment as varchar(10)                                                                                    
--set @segment='ABLCM'                                                                                   
--declare @date as varchar(11)                                                                         
--set @date = convert(datetime,'20/11/2009',103)                                                                   
                                                                                
alter table #mainill alter column party_name varchar(100)                                                                                
IF @segment='ABLCM'                                                                                    
BEGIN                                                                                    
      insert  into #mainill                                                                                     
      select party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                                                        
PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date from AngelBSECM.bsedb_ab.dbo.cmbillvalan                                                                                 
where sauda_date =convert(datetime,@date,103)                                                                                    
END                                                                                    
ELSE IF @segment='ACDLCM'                                                                                    
BEGIN                                                                      
      insert  into #mainill                      
      select party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                     
PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date from AngelNseCM.msajag.dbo.cmbillvalan                                
 where  sauda_date =convert(datetime,@date,103)                                                               
END                                              
--drop table #mainill                                               
--select top 5 * from #mainill                                                     
-------------------------------chk IllScrpt with particlr dates tred--------------------------------                             
-- drop table  #ill1                                                                        
select top 0 * into #ill1 from  #mainill(nolock)                                                                            
                                          
--declare @segment as varchar(10)                                                                                    
--set @segment='ABLCM'  
Select top 0 * into #illscrip from intranet.misc.dbo.illscrip  
  
if exists(select * from intranet.misc.dbo.illscrip                                   
   where [month] = Datename(month,DateAdd(m,-1,getdate()))                                         
  AND [YEAR] = Datename(year,DateAdd(m,-1,getdate())))  
begin  
    insert into #illscrip  
       select * from intranet.misc.dbo.illscrip                                   
   where [month] = Datename(month,DateAdd(m,-1,getdate()))                                         
  AND [YEAR] = Datename(year,DateAdd(m,-1,getdate()))  
end         
else  
begin  
   insert into #illscrip  
       select * from intranet.misc.dbo.illscrip                                   
   where [month] = Datename(month,DateAdd(m,-2,getdate()))                                         
  AND [YEAR] = Datename(year,DateAdd(m,-2,getdate()))  
end        
  
Select top 0 * into #illscrip_nse from intranet.misc.dbo.illScrip_nse  
  
if exists(select * from intranet.misc.dbo.illScrip_nse                                   
   where [month] = Datename(month,DateAdd(m,-1,getdate()))                                         
  AND [YEAR] = Datename(year,DateAdd(m,-1,getdate())))  
begin  
    insert into #illscrip_nse  
       select * from intranet.misc.dbo.illScrip_nse                                   
   where [month] = Datename(month,DateAdd(m,-1,getdate()))                                         
  AND [YEAR] = Datename(year,DateAdd(m,-1,getdate()))  
end         
else  
begin  
   insert into #illscrip_nse  
       select * from intranet.misc.dbo.illScrip_nse                                   
   where [month] = Datename(month,DateAdd(m,-2,getdate()))                                         
  AND [YEAR] = Datename(year,DateAdd(m,-2,getdate()))  
end                                                                  
                                                                        
if @segment='ABLCM'                                                                     
begin                                                                                     
insert into #ill1                                                                                    
select distinct a.party_code,a.party_name,a.scrip_cd,a.scrip_name,a.PQtyTrd,a.PAmtTrd,a.PQtyDel,                                                                                        
a.PAmtDel,a.SQtyTrd,a.SAmtTrd,a.SQtyDel,a.SAmtDel,a.sauda_date  from                                                                                        
(select  *  from #mainill(nolock))a                                                                                       
INNER JOIN                                                                                        
(                                          
-- select * from intranet.misc.dbo.illScrip                                        
     --   select * from intranet.misc.dbo.illscrip where Month =datename (month,getdate()-30) and year = datename(year,getdate())                            
                           
          --select * from intranet.misc.dbo.illscrip   where month ='February' and year ='2011'                           
                                  
  
         Select * from #illscrip  
          
                                         
) b                                                  
on a.scrip_cd=b.scrip_cd                                                                                     
end                                                                                    
else if @segment='ACDLCM'                                                                                    
begin                                                                                    
insert into #ill1                                                                                
select distinct a.party_code,a.party_name,a.scrip_cd,a.scrip_name,a.PQtyTrd,a.PAmtTrd,a.PQtyDel,                                                                                        
a.PAmtDel,a.SQtyTrd,a.SAmtTrd,a.SQtyDel,a.SAmtDel,a.sauda_date  from                                                                                 
(select  *  from #mainill(nolock))a                                                                                        
inner join                                                                 
(                          
      select * from #illscrip_nse                   
   
)b                                                                                        
on a.scrip_cd=b.scrip_cd                                                     
end                                                                                    
                                                                                      
--------------------------------sum amt----------------------------------------------                                                                                        
select sum(pamttrd)as PamtTrrd, sum(samttrd)as SamtTrd, party_code,scrip_cd into #sumamt from #mainill(nolock)                                                                                        
group by scrip_cd,party_code                                                                                        
--drop table #sumamt                                                                                        
--select * from #sumamt                                                                                        
--------------------------------pl of amt ---------------------------------------------------------------                                                                                    
select PL=(SamtTrd-PamtTrrd),party_code,scrip_cd into #plILL from #sumamt(nolock)                                       
--drop table #plILL                                                                  
-----------------------------cal rate ----------------------------------------------                                                                                    
select case when sum(PQtyTrd)=0.00 then sum(PAmtTrd)/(sum(PQtyTrd)+1)                               
else sum(PAmtTrd)/(sum(PQtyTrd))  end as Buyrate,                                                                                        
case when sum(SQtyTrd)=0.00 then sum(SAmtTrd)/(sum(SQtyTrd)+1)                                                                         
else sum(SAmtTrd)/(sum(SQtyTrd)) end as Sellrate,party_code,scrip_cd into #tbl                                                                                        
from #ill1(nolock) group by scrip_cd,party_code                                                                                
----select * from #tbl1  where party_code='M888'                        
----select *  from #tbl where party_code=''                                                                          
----select top 5 * from #ill1                                                                                        
----drop table #tbl2                                             
select sum(pqtytrd)pqtytrd,sum(pqtydel)pqtydel,sum(sqtytrd)sqtytrd,sum(sqtydel)sqtydel,scrip_cd,party_code                                                                          
into #tbl2 from #mainill group by scrip_cd, party_code                                                       
                                                                   
                                                                          
                                                                                  
-------------------------cal rate diff---------------------------------------------------                                   
select *,RateDiff=(Sellrate-Buyrate) into #tbl1 from #tbl(nolock)                                                                                        
--select * from #tbl1  where party_code='M888'                                                                          
--drop table #tbl1                
--select top 5 * from #tbl1                                                                                        
-------------------------------cal stk prc variation % -------------------------------------------------                                                                   
select stkPrcVariation=((sellrate-buyrate)/buyrate)*100,party_code,scrip_cd,Sellrate,Buyrate into #illstp                                                                                         
from #tbl1(nolock) where buyrate<>0.00 and sellrate<>0.00                                                                   
--select top 5 * from #illstp                                                                                        
--drop table #illstp                                                                                        
-------------------------------take sum of script -----------------------------------------------------------                                                                                        
select sum(pqtytrd)Pqt,sum(pqtydel)PDqt,sum(sqtytrd)Sqt,sum(sqtydel)SDqt,scrip_cd,party_code                                                                                        
into #illturn from #mainill(nolock)                                                                                         
group by scrip_cd,party_code                                                                                        
--select top 5 * from #illturn                                                                                   
--select * from #mainill                                                                                  
--drop table #illturn                                                                                        
------------------------------cal turnover ---------------------------------------------------------                                                           
select *,sum(Pqt+pdqt+sqt+sdqt) as turnover into #turnover from #illturn(nolock)                                   
group by scrip_cd,party_code,Pqt,pdqt,sqt,sdqt                                                                                        
--drop table #turnover                                                         
--select top 5 * from #turnover                                                                                      
----------------------------------chk particlr days trd volume ---------------------------------------------------                                         
--declare @segment as varchar(10)                                                                                
--set @segment='ACDLCM'        
--declare @date as varchar(11)                                                           
--set @date = convert(datetime,'17/11/2009',103)                                                                        
                                                         
if @segment='ablcm'                                                                                
begin                                                                                 
select party_code,scrip_cd,Turnover,TurnoverPerc=isnull(convert(decimal(14,2),convert(float,a.turnover)/b.no_of_shrs *100),0),                                                    
sc_name,no_of_shrs into #illpercbse from                                                                                    
(select * from #turnover(nolock))a                                                                                    
left outer join                                                                                     
(select sc_code,Sc_name,no_of_shrs from intranet.misc.dbo.qe where pddate=@date)b                                                                        
on a.scrip_cd=b.sc_code                                                                                     
--select * from #illpercbse                                   
end                                                                                
if @segment='ACDLCM'                                                                              
begin                                                                                                                       
select party_code,scrip_cd,Turnover,TurnoverPerc=isnull(convert(decimal(14,2),convert(float,a.turnover)/b.net_trdqty*100),0),                                                                                
b.security,net_trdqty into #illpercnse from                                                                         
(select * from #turnover(nolock))a                                                                                    
left outer join                                                                        
(select Symbol,Security,net_trdqty from intranet.misc.dbo.pd301203 where  pddate=@date)b                                                           
on a.scrip_cd=b.symbol                                                                                  
--select * from #illpercnse                                                              
end                                                                                
                                                                                
--drop table #illpercnse                                                                                  
--select top 5 * from #illperc                                                                                        
--drop table #illperc                                                                                     
--------------------------final output ------------------------------------------------------                                                                                        
--declare @segment as varchar(10)                                              
--set @segment='ACDLCM'                                                                          
                                                                          
if @segment='ABLCM'                                                                                
begin                                              
select a.party_code,a.scrip_cd,a.sc_name,a.Turnover,isnull(no_of_shrs,0) as [MarketVolume],a.TurnoverPerC,                                                                                
b.Buyrate,b.Sellrate,c.stkprcvariation,d.PL,case when a.party_code=g.party_code then 'Online Client' else 'Offline Client' end as Status                                                              
 into #bse1                               
from                                                                                    
(select * from #illpercBse(nolock)) a                                                                                        
inner join                                                                                        
(select  * from #tbl1(nolock)) b                                                              
on a.party_code=b.party_code and a.scrip_cd=b.scrip_cd                                                                                         
inner join                                                                                 
(select  * from #illstp(nolock)) c                                                                                    
on a.party_code=c.party_code and a.scrip_cd=c.scrip_cd                                                                                        
inner join                                                                          
(select * from #plILL(nolock))d                                        
on a.party_code=d.party_code and a.scrip_cd=d.scrip_cd                                                                 
left outer join                                                              
(select party_code from intranet.ctcl.dbo.ebrok_client with (nolock))g                                                              
on a.party_code=g.party_code                                                                          
-----                                                                 
select f.*,e.pqtytrd,e.pqtydel,e.sqtytrd,e.sqtydel,g.sub_broker,g.branch_cd           
into #Illbse                               
from                                                                           
(select * from #bse1(nolock))f                                                           
inner join                                                   
(select * from #tbl2(nolock))e                                                                          
on f.party_code=e.party_code and f.scrip_cd=e.scrip_cd           
inner join          
 ( select * from risk.dbo.client_details) g          
 on e.party_code = g.party_code                                
          
          
select b.party_code,CASE WHEN isnull(m.mobile_pager,'')='' THEN 'N' ELSE 'Y' END AS mobile,
b.scrip_cd,b.sc_name,b.turnover,b.marketVolume,b.turnoverperc,
b.buyrate,b.sellrate,b.stkprcvariation,b.pl,b.status,b.pqtytrd,b.pqtydel,b.sqtytrd,
b.sqtydel,b.sub_broker,b.branch_cd
  from #Illbse b (nolock)
LEFT OUTER JOIN  INTRANET.RISK.DBO.CLIENT_DETAILS m
on m.cl_code =b.PARTY_CODE                                  
where pl not between @pl1 and @pl or turnoverperc>=@IillMrktGrsPerc or stkprcvariation>=@Illstkpricvart                                                                  
order by party_code,scrip_cd                                                                             
end                                                                          
                  
                                                                          
else if @segment='ACDLCM'                                                                                
begin                                                          
                                                                          
select a.party_code,a.scrip_cd,security,Turnover,isnull(net_trdqty,0) as [MarketVolume],TurnoverPerc,b.Buyrate,b.Sellrate,                                                                          
stkPrcVariation,PL,case when a.party_code=g.party_code then 'Online Client' else 'Offline Client' end as Status                                                                          
into #nse1                                                                          
 from                                                                          
(select party_code,scrip_cd,Turnover,TurnoverPerc,security,net_trdqty from #illpercnse(nolock))a                                                                          
inner join                                                                          
(select  Buyrate,Sellrate,party_code,scrip_cd,RateDiff from #tbl1(nolock)) b                                                       
on a.party_code=b.party_code and a.scrip_cd=b.scrip_cd                                                                           
inner join                                                                          
(select  stkPrcVariation,party_code,scrip_cd,Sellrate,Buyrate from #illstp(nolock)) c                                                                                        
on a.party_code=c.party_code and a.scrip_cd=c.scrip_cd                                                                            
inner join                                                                          
(select PL,party_code,scrip_cd from #plILL(nolock))d                                                                           
on a.party_code=d.party_code and a.scrip_cd=d.scrip_cd                                                                   
left outer join                                                              
(select party_code from intranet.ctcl.dbo.ebrok_client with (nolock))g                                                              
on a.party_code=g.party_code                                                          
---                                 
select f.*,e.pqtytrd,e.pqtydel,e.sqtytrd,e.sqtydel,g.sub_broker,g.branch_cd into #Illnse                                                                          
 from                                                                           
(select pqtytrd,pqtydel,sqtytrd,sqtydel,scrip_cd,party_code from #tbl2(nolock))e                                                       
inner join                                                                          
(select * from #nse1)f                            
on f.party_code=e.party_code and f.scrip_cd=e.scrip_cd          
inner join           
(select * from risk.dbo.client_details) g  on e.party_code =g.party_code           
                                                                       
SELECT 
b.party_code,
CASE WHEN isnull(m.mobile_pager,'')='' THEN 'N' ELSE 'Y' END AS mobile,
b.scrip_cd,b.security,b.turnover,b.marketVolume,b.turnoverperc,
b.buyrate,b.sellrate,b.stkprcvariation,b.pl,b.status,b.pqtytrd,b.pqtydel,b.sqtytrd,
b.sqtydel,b.sub_broker,b.branch_cd

from #Illnse(nolock) b
LEFT OUTER JOIN  INTRANET.RISK.DBO.CLIENT_DETAILS m
  on m.cl_code =  b.party_code 

                                                                         
where pl not between @pl1 and @pl or turnoverperc>=@IillMrktGrsPerc or stkprcvariation>=@Illstkpricvart                                                      
order by party_code,scrip_cd   


                                                                       
end                                                                         
-----                                                                        
                                                                    
                                                        
-------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_fds_IllScripAlert_new
-- --------------------------------------------------
  
  
CREATE PROCEDURE [dbo].[usp_fds_IllScripAlert_new] --'14/01/2011','AbLCM','2000','20','20','static','','',''                                  
(                                                 
 @DATE AS VARCHAR(11),            
 @SEGMENT AS VARCHAR(15),            
 @PL AS INT,            
 @ILLSTKPRICVART AS INT,            
 @IILLMRKTGRSPERC AS INT,         
 @Flag VARCHAR(15),           
 @USERNAME VARCHAR(25),            
 @ACCESS_TO VARCHAR(25),            
 @ACCESS_CODE VARCHAR(25)                                                            
)                                                
as                                 
SET NOCOUNT ON                                         
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED               
set @date = convert(datetime,@date,103)                                              
declare @pl1 as int                                                             
set @pl1= @pl*-1                                         
                                        
select top 0 party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                              
PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date into #mainill from AngelNseCM.msajag.dbo.cmbillvalan with (nolock)                                                     
                                     
                                                      
alter table #mainill alter column party_name varchar(100)                                                      
IF @segment='ABLCM'                                                          
 BEGIN                                                          
 insert  into #mainill                                                           
 select party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                              
 PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date from AngelBSECM.bsedb_ab.dbo.cmbillvalan   with (nolock)                                                     
 where sauda_date =convert(datetime,@date,103)                                                          
END                                                          
ELSE IF @segment='ACDLCM'                                                          
BEGIN                                                          
 insert  into #mainill                                                           
 select party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                              
 PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date from AngelNseCM.msajag.dbo.cmbillvalan  with (nolock)                                                         
 where  sauda_date =convert(datetime,@date,103)                                                          
END                                                          
                             
-------------------------------chk IllScrpt with particlr dates tred--------------------------------                                                              
select top 0 * into #ill1 from  #mainill(nolock)                                                  
                                              
if @segment='ABLCM'                                           
begin                                                           
 insert into #ill1                                                          
 select distinct a.party_code,a.party_name,a.scrip_cd,a.scrip_name,a.PQtyTrd,a.PAmtTrd,a.PQtyDel,                                                              
 a.PAmtDel,a.SQtyTrd,a.SAmtTrd,a.SQtyDel,a.SAmtDel,a.sauda_date  from                                                              
 (select  *  from #mainill(nolock))a                                                             
 INNER JOIN                                                              
 (                
    select * from intranet.misc.dbo.illscrip where Month =datename (month,getdate()-30) and year = datename(year,getdate())         
 ) b   
 on a.scrip_cd=b.scrip_cd                                                           
end                                                          
else if @segment='ACDLCM'                                                          
begin                                                          
 insert into #ill1                                                      
 select distinct a.party_code,a.party_name,a.scrip_cd,a.scrip_name,a.PQtyTrd,a.PAmtTrd,a.PQtyDel,                                                              
 a.PAmtDel,a.SQtyTrd,a.SAmtTrd,a.SQtyDel,a.SAmtDel,a.sauda_date  from                                                       
 (select  *  from #mainill(nolock))a                                                              
 inner join                                       
 (                
   select * from intranet.misc.dbo.illscrip_nse where Month =datename (month,getdate()-30) and year = datename(year,getdate())   
 )b                                                              
 on a.scrip_cd=b.scrip_cd                                                      
end                                                          
                                                            
--------------------------------sum amt----------------------------------------------                                                              
select sum(pamttrd)as PamtTrrd, sum(samttrd)as SamtTrd, party_code,scrip_cd into #sumamt from #mainill(nolock)                                                              
group by scrip_cd,party_code                                                              
--------------------------------pl of amt ---------------------------------------------------------------                                                              
select PL=(SamtTrd-PamtTrrd),party_code,scrip_cd into #plILL from #sumamt(nolock)                                                              
-----------------------------cal rate ----------------------------------------------                                                          
select case when sum(PQtyTrd)=0.00 then sum(PAmtTrd)/(sum(PQtyTrd)+1)                                            
else sum(PAmtTrd)/(sum(PQtyTrd))  end as Buyrate,                                                              
case when sum(SQtyTrd)=0.00 then sum(SAmtTrd)/(sum(SQtyTrd)+1)                                               
else sum(SAmtTrd)/(sum(SQtyTrd)) end as Sellrate,party_code,scrip_cd into #tbl                                                              
from #ill1(nolock) group by scrip_cd,party_code                                                      
    
    
select sum(pqtytrd)pqtytrd,sum(pqtydel)pqtydel,sum(sqtytrd)sqtytrd,sum(sqtydel)sqtydel,scrip_cd,party_code                                                
into #tbl2 from #mainill group by scrip_cd, party_code                             
                                         
                                                
                                                        
-------------------------cal rate diff---------------------------------------------------                                                              
select *,RateDiff=(Sellrate-Buyrate) into #tbl1 from #tbl(nolock)                                                              
-------------------------------cal stk prc variation % -------------------------------------------------                                                              
select stkPrcVariation=((sellrate-buyrate)/buyrate)*100,party_code,scrip_cd,Sellrate,Buyrate into #illstp                                                               
from #tbl1(nolock) where buyrate<>0.00 and sellrate<>0.00                                                              
-------------------------------take sum of script -----------------------------------------------------------                                                              
select sum(pqtytrd)Pqt,sum(pqtydel)PDqt,sum(sqtytrd)Sqt,sum(sqtydel)SDqt,scrip_cd,party_code    
into #illturn from #mainill(nolock)                                                               
group by scrip_cd,party_code                                                              
------------------------------cal turnover ---------------------------------------------------------                                 
select *,sum(Pqt+pdqt+sqt+sdqt) as turnover into #turnover from #illturn(nolock)                                                               
group by scrip_cd,party_code,Pqt,pdqt,sqt,sdqt                                                              
----------------------------------chk particlr days trd volume ---------------------------------------------------                                                      
                               
if @segment='ablcm'                                                      
begin                                                       
 select party_code,scrip_cd,Turnover,TurnoverPerc=isnull(convert(decimal(14,2),convert(float,a.turnover)/b.no_of_shrs *100),0),                                                      
 sc_name,no_of_shrs into #illpercbse from                                                          
 (select * from #turnover(nolock))a                                                          
 left outer join                                                           
 (select sc_code,Sc_name,no_of_shrs from intranet.misc.dbo.qe with (nolock) where pddate=@date)b                                              
 on a.scrip_cd=b.sc_code                                                           
end                                                      
if @segment='ACDLCM'                                                    
begin                                                                                             
 select party_code,scrip_cd,Turnover,TurnoverPerc=isnull(convert(decimal(14,2),convert(float,a.turnover)/b.net_trdqty*100),0),                                                      
 b.security,net_trdqty into #illpercnse from                                                          
 (select * from #turnover(nolock))a                                                          
 left outer join                                              
 (select Symbol,Security,net_trdqty from intranet.misc.dbo.pd301203 with (nolock) where  pddate=@date)b                                 
 on a.scrip_cd=b.symbol                                                        
end                                                      
--------------------------final output ------------------------------------------------------                                                              
if @segment='ABLCM'                                                      
begin                                                      
 select a.party_code,a.scrip_cd,a.sc_name,a.Turnover,isnull(no_of_shrs,0) as TotalNoOfShares,a.TurnoverPerC,                                                      
 b.Buyrate,b.Sellrate,c.stkprcvariation,d.PL,case when a.party_code=g.party_code then 'Online Client' else 'Offline Client' end as Status                                    
  into #bse1                                                              
 from                                                              
 (select * from #illpercBse(nolock)) a                                                              
 inner join                                                              
 (select  * from #tbl1(nolock)) b                                                              
 on a.party_code=b.party_code and a.scrip_cd=b.scrip_cd                                                               
 inner join                                                       
 (select  * from #illstp(nolock)) c                                                              
 on a.party_code=c.party_code and a.scrip_cd=c.scrip_cd                                                              
 inner join                                 
 (select * from #plILL(nolock))d                                                              
 on a.party_code=d.party_code and a.scrip_cd=d.scrip_cd                                       
 left outer join                                    
 (select party_code from intranet.ctcl.dbo.ebrok_client with (nolock))g               
 on a.party_code=g.party_code                                                
 -----                                       
 select f.*,e.pqtytrd,e.pqtydel,e.sqtytrd,e.sqtydel into #Illbse                                                
 from                                                 
 (select * from #bse1(nolock))f                                                
 inner join                                                 
 (select * from #tbl2(nolock))e                                                
 on f.party_code=e.party_code and f.scrip_cd=e.scrip_cd                     
   
 select * into #ILLBSE2  from  #Illbse(nolock)        
 where pl not between @pl1 and @pl or turnoverperc>=@IillMrktGrsPerc or stkprcvariation>=@Illstkpricvart                                        
 order by party_code,scrip_cd                                                   
                                              
                  
   /**************************************************************************************************/  
   if(@Flag='static')      
  begin      
    SELECT * FROM #ILLBSE2        
  END      
  ELSE      
  BEGIN      
    SELECT PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))             
 +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))            
 +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''            
 +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+             
 ltrim(rtrim(PARTY_CODE)) +'</a>'          
 ,SCRIP_CD AS [SCRIP_CODE],SC_NAME AS SCRIP,PQTYTRD AS [BUY QTY TRD],SQTYTRD AS [SELL QTY TRD],          
 PQTYDEL AS[BUY QTY DEL],SQTYDEL AS [SELL QTY DEL ],BUYRATE,SELLRATE,          
 CASE WHEN PL NOT BETWEEN @PL1 AND @PL THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,PL)+'</FONT>'           
 ELSE CONVERT(VARCHAR,PL) END AS [PL(RS)],          
 TURNOVER,TOTALNOOFSHARES AS [MARKET VOLUME],          
 CASE WHEN TURNOVERPERC>=@IILLMRKTGRSPERC THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,TURNOVERPERC)+'</FONT>'           
 ELSE CONVERT(VARCHAR,TURNOVERPERC) END AS [% TO MKT VOL] ,          
 CASE WHEN STKPRCVARIATION>=@ILLSTKPRICVART THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,STKPRCVARIATION)+'</FONT>'          
 ELSE CONVERT(VARCHAR,STKPRCVARIATION) END AS [RATE DIFFERENCE %],STATUS          
 FROM #ILLBSE2(NOLOCK)          
 ORDER BY PARTY_CODE,SCRIP_CD           
      
  END      
  /****************************************************************************************************/  
     
     
end                                                 
else if @segment='ACDLCM'                                                      
begin                                
                                                
 select a.party_code,a.scrip_cd,security,Turnover,isnull(net_trdqty,0) as TotalNoOfShares,TurnoverPerc,b.Buyrate,b.Sellrate,                                                
 stkPrcVariation,PL,case when a.party_code=g.party_code then 'Online Client' else 'Offline Client' end as Status                                                
 into #nse1                                                
  from                                                
 (select party_code,scrip_cd,Turnover,TurnoverPerc,security,net_trdqty from #illpercnse(nolock))a                                                
 inner join                                                
 (select  Buyrate,Sellrate,party_code,scrip_cd,RateDiff from #tbl1(nolock)) b                
 on a.party_code=b.party_code and a.scrip_cd=b.scrip_cd                                                 
 inner join                                                
 (select  stkPrcVariation,party_code,scrip_cd,Sellrate,Buyrate from #illstp(nolock)) c                                                              
 on a.party_code=c.party_code and a.scrip_cd=c.scrip_cd                                                  
 inner join                                                
 (select PL,party_code,scrip_cd from #plILL(nolock))d                                                 
 on a.party_code=d.party_code and a.scrip_cd=d.scrip_cd                                         
 left outer join                                    
 (select party_code from intranet.ctcl.dbo.ebrok_client with (nolock))g                                    
 on a.party_code=g.party_code                                             
 ---                                                
 select f.*,e.pqtytrd,e.pqtydel,e.sqtytrd,e.sqtydel into #Illnse                                                
  from                                                 
 (select pqtytrd,pqtydel,sqtytrd,sqtydel,scrip_cd,party_code from #tbl2(nolock))e                                                
 inner join                                                
 (select * from #nse1)f                                                
 on f.party_code=e.party_code and f.scrip_cd=e.scrip_cd                                                  
   
 select * into #ILLNSE2 from #Illnse(nolock)                                                
 where pl not between @pl1 and @pl or turnoverperc>=@IillMrktGrsPerc or stkprcvariation>=@Illstkpricvart                            
 order by party_code,scrip_cd                                                
  
  
  
  if(@Flag='static')      
  begin      
    SELECT * FROM #ILLNSE2        
  END      
  ELSE      
  BEGIN      
    SELECT          
 PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))             
 +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))            
 +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''            
 +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+             
 ltrim(rtrim(PARTY_CODE)) +'</a>'          
 ,SCRIP_CD AS [SCRIP_CODE],SECURITY AS SCRIP,PQTYTRD AS [BUY QTY TRD],          
 SQTYTRD AS [SELL QTY TRD],PQTYDEL AS[BUY QTY DEL],SQTYDEL AS [SELL QTY DEL ],BUYRATE,SELLRATE,          
 CASE WHEN PL NOT BETWEEN @PL1 AND @PL THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,PL)+'</FONT>'           
 ELSE CONVERT(VARCHAR,PL) END AS [PL(RS)],          
 TURNOVER,TOTALNOOFSHARES AS [MARKET VOLUME],          
 CASE WHEN TURNOVERPERC>=@IILLMRKTGRSPERC THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,TURNOVERPERC)+'</FONT>'           
 ELSE CONVERT(VARCHAR,TURNOVERPERC) END AS [% TO MKT VOL] ,          
 CASE WHEN STKPRCVARIATION>=@ILLSTKPRICVART THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,STKPRCVARIATION)+'</FONT>'           
 ELSE CONVERT(VARCHAR,STKPRCVARIATION) END AS [RATE DIFFERENCE %],          
 STATUS          
 FROM #ILLNSE2 (NOLOCK)          
 ORDER BY PARTY_CODE,SCRIP_CD        
      
  END  
  
  
end                                               
---------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDS_ILLSCRIPALERT_NEW_DATEWISE
-- --------------------------------------------------


/**********************************************************************************                          
CREATED BY: RAJENDRA VERMA                          
DATE: 14/01/2010                          
PURPOSE:THIS PROCEDURE GIVES TRADE ALERT REPORTS DATEWISE                  
MODIFIED BY: PROGRAMMER NAME                          
DATED: DD/MM/YYYY                          
REASON: REASON TO CHANGE STORE PROCEDURE                          
**********************************************************************************/          
CREATE PROCEDURE [dbo].[USP_FDS_ILLSCRIPALERT_NEW_DATEWISE] --'14/01/2011','14/01/2011','ACDLCM','2000','20','20','all','all','E32755','BROKER','CSO'    
(          
 @FROMDATE AS VARCHAR(11),  /*************FROM DATE FORMAT DD/MM/YYYY*****************************/    
 @TODATE AS VARCHAR(11),   /*************TO DATE FORMAT DD/MM/YYYY*******************************/    
 @SEGMENT AS VARCHAR(15),          
 @PL AS INT,          
 @ILLSTKPRICVART AS INT,          
 @IILLMRKTGRSPERC AS INT,          
 @CODE VARCHAR(25),    /*************CODE VALUE DEPENDS ON CODETYPE**************************/    
 @CODETYPE VARCHAR(25),   /*************CODETYPE ALL(ALL),C(CLIENTCODE) AND S(SCRIPCODE)********/                         
 @USERNAME VARCHAR(25)=NULL,                                
 @ACCESS_TO VARCHAR(25)=NULL,                                
 @ACCESS_CODE VARCHAR(25)=NULL        
)          
AS          
SET NOCOUNT ON     
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED         
BEGIN          
          
                                      
	DECLARE @PL1 AS INT                                                           
	SET @PL1= @PL*-1                                       
	                                      
	SELECT TOP 0 PARTY_CODE,PARTY_NAME,SCRIP_CD,SCRIP_NAME,PQTYTRD,PAMTTRD,PQTYDEL,                                                            
	PAMTDEL,SQTYTRD,SAMTTRD,SQTYDEL,SAMTDEL,SAUDA_DATE INTO #MAINILL FROM AngelNseCM.MSAJAG.DBO.CMBILLVALAN WITH (NOLOCK)                                                   
	                                   
	                                                    
	ALTER TABLE #MAINILL ALTER COLUMN PARTY_NAME VARCHAR(100)                                                    
	IF @SEGMENT='ABLCM'                                                        
	 BEGIN                                                        
	 INSERT  INTO #MAINILL                                                         
	 SELECT PARTY_CODE,PARTY_NAME,SCRIP_CD,SCRIP_NAME,PQTYTRD,PAMTTRD,PQTYDEL,                                                            
	 PAMTDEL,SQTYTRD,SAMTTRD,SQTYDEL,SAMTDEL,SAUDA_DATE FROM AngelBSECM.BSEDB_AB.DBO.CMBILLVALAN   WITH (NOLOCK)                                                   
	 WHERE SAUDA_DATE BETWEEN CONVERT(DATETIME,@FROMDATE+' 00:00:00.000',103) AND CONVERT(DATETIME,@TODATE+' 23:59:59.000',103)                                                         
	END                                                        
	ELSE IF @SEGMENT='ACDLCM'                                                        
	BEGIN                                                        
	 INSERT  INTO #MAINILL                                                         
	 SELECT PARTY_CODE,PARTY_NAME,SCRIP_CD,SCRIP_NAME,PQTYTRD,PAMTTRD,PQTYDEL,                                                            
	 PAMTDEL,SQTYTRD,SAMTTRD,SQTYDEL,SAMTDEL,SAUDA_DATE FROM AngelNseCM.MSAJAG.DBO.CMBILLVALAN  WITH (NOLOCK)                                                       
	 WHERE  SAUDA_DATE BETWEEN CONVERT(DATETIME,@FROMDATE+' 00:00:00.000',103) AND CONVERT(DATETIME,@TODATE+' 23:59:59.000',103)                                                        
	END                                                        
	                           
	-------------------------------CHK ILLSCRPT WITH PARTICLR DATES TRED--------------------------------                                         
	SELECT TOP 0 * INTO #ILL1 FROM  #MAINILL(NOLOCK)                                                
	                                            
	IF @SEGMENT='ABLCM'                                         
	BEGIN                                                         
	 INSERT INTO #ILL1                                                        
	 SELECT DISTINCT A.PARTY_CODE,A.PARTY_NAME,A.SCRIP_CD,A.SCRIP_NAME,A.PQTYTRD,A.PAMTTRD,A.PQTYDEL,                                                            
	 A.PAMTDEL,A.SQTYTRD,A.SAMTTRD,A.SQTYDEL,A.SAMTDEL,A.SAUDA_DATE  FROM                                                            
	 (SELECT  *  FROM #MAINILL(NOLOCK))A                                                           
	 INNER JOIN                                                            
	 (              
		SELECT * FROM INTRANET.RISK.DBO.ILLSCRIP_BSE_DECEMBER WITH (NOLOCK)        
	 ) B                      
	 ON A.SCRIP_CD=B.SCRIP_CD                                                         
	END                                                        
	ELSE IF @SEGMENT='ACDLCM'                                                        
	BEGIN                                                        
	 INSERT INTO #ILL1                                                    
	 SELECT DISTINCT A.PARTY_CODE,A.PARTY_NAME,A.SCRIP_CD,A.SCRIP_NAME,A.PQTYTRD,A.PAMTTRD,A.PQTYDEL,                                                            
	 A.PAMTDEL,A.SQTYTRD,A.SAMTTRD,A.SQTYDEL,A.SAMTDEL,A.SAUDA_DATE  FROM                                                     
	 (SELECT  *  FROM #MAINILL(NOLOCK))A                                                            
	 INNER JOIN                                     
	 (              
	 SELECT * FROM INTRANET.RISK.DBO.ILLSCRIP_NSE_DECEMBER WITH (NOLOCK)   
	 )B                                                            
	 ON A.SCRIP_CD=B.SCRIP_CD                                                    
	END                                                        
	                                                          
	--------------------------------SUM AMT----------------------------------------------                                                            
	SELECT SUM(PAMTTRD)AS PAMTTRRD, SUM(SAMTTRD)AS SAMTTRD, PARTY_CODE,SCRIP_CD INTO #SUMAMT FROM #MAINILL(NOLOCK)                                                            
	GROUP BY SCRIP_CD,PARTY_CODE                                                            
	--------------------------------PL OF AMT ---------------------------------------------------------------                                                            
	SELECT PL=(SAMTTRD-PAMTTRRD),PARTY_CODE,SCRIP_CD INTO #PLILL FROM #SUMAMT(NOLOCK)                                                            
	-----------------------------CAL RATE ----------------------------------------------                                                        
	SELECT CASE WHEN SUM(PQTYTRD)=0.00 THEN SUM(PAMTTRD)/(SUM(PQTYTRD)+1)                                          
	ELSE SUM(PAMTTRD)/(SUM(PQTYTRD))  END AS BUYRATE,                                                            
	CASE WHEN SUM(SQTYTRD)=0.00 THEN SUM(SAMTTRD)/(SUM(SQTYTRD)+1)                                             
	ELSE SUM(SAMTTRD)/(SUM(SQTYTRD)) END AS SELLRATE,PARTY_CODE,SCRIP_CD,SAUDA_DATE INTO #TBL                                                            
	FROM #ILL1(NOLOCK) GROUP BY SCRIP_CD,PARTY_CODE,SAUDA_DATE                                                   
	  
	  
	SELECT SUM(PQTYTRD)PQTYTRD,SUM(PQTYDEL)PQTYDEL,SUM(SQTYTRD)SQTYTRD,SUM(SQTYDEL)SQTYDEL,SCRIP_CD,PARTY_CODE                                              
	INTO #TBL2 FROM #MAINILL GROUP BY SCRIP_CD, PARTY_CODE                           
	                                       
	                                              
	            
	-------------------------CAL RATE DIFF---------------------------------------------------                                                            
	SELECT *,RATEDIFF=(SELLRATE-BUYRATE) INTO #TBL1 FROM #TBL(NOLOCK)                                                            
	-------------------------------CAL STK PRC VARIATION % -------------------------------------------------                                                            
	SELECT STKPRCVARIATION=((SELLRATE-BUYRATE)/BUYRATE)*100,PARTY_CODE,SCRIP_CD,SELLRATE,BUYRATE,SAUDA_DATE INTO #ILLSTP                                                             
	FROM #TBL1(NOLOCK) WHERE BUYRATE<>0.00 AND SELLRATE<>0.00                                                            
	-------------------------------TAKE SUM OF SCRIPT -----------------------------------------------------------                                                            
	SELECT SUM(PQTYTRD)PQT,SUM(PQTYDEL)PDQT,SUM(SQTYTRD)SQT,SUM(SQTYDEL)SDQT,SCRIP_CD,PARTY_CODE                                                            
	INTO #ILLTURN FROM #MAINILL(NOLOCK)                                                             
	GROUP BY SCRIP_CD,PARTY_CODE                                                            
	------------------------------CAL TURNOVER ---------------------------------------------------------                               
	SELECT *,SUM(PQT+PDQT+SQT+SDQT) AS TURNOVER INTO #TURNOVER FROM #ILLTURN(NOLOCK)                                                             
	GROUP BY SCRIP_CD,PARTY_CODE,PQT,PDQT,SQT,SDQT                                                            
	----------------------------------CHK PARTICLR DAYS TRD VOLUME ---------------------------------------------------                                                    
	                             
	IF @SEGMENT='ABLCM'                                                    
	BEGIN                                                     
	 SELECT PARTY_CODE,SCRIP_CD,TURNOVER,TURNOVERPERC=ISNULL(CONVERT(DECIMAL(14,2),CONVERT(FLOAT,A.TURNOVER)/B.NO_OF_SHRS *100),0),                                                    
	 SC_NAME,NO_OF_SHRS INTO #ILLPERCBSE FROM                                                        
	 (SELECT * FROM #TURNOVER(NOLOCK))A                                                        
	 LEFT OUTER JOIN                                                         
	 (SELECT SC_CODE,SC_NAME,NO_OF_SHRS FROM INTRANET.MISC.DBO.QE WITH (NOLOCK) WHERE PDDATE
	 BETWEEN CONVERT(DATETIME,@FROMDATE+' 00:00:00.000',103) AND CONVERT(DATETIME,@TODATE+' 23:59:59.000',103) )B                                            
	 ON A.SCRIP_CD=B.SC_CODE                                                         
	END                                                    
	IF @SEGMENT='ACDLCM'                                                  
	BEGIN                                                                                           
	 SELECT PARTY_CODE,SCRIP_CD,TURNOVER,TURNOVERPERC=ISNULL(CONVERT(DECIMAL(14,2),CONVERT(FLOAT,A.TURNOVER)/B.NET_TRDQTY*100),0),                                                    
	 B.SECURITY,NET_TRDQTY INTO #ILLPERCNSE FROM                                                        
	 (SELECT * FROM #TURNOVER(NOLOCK))A                                                        
	 LEFT OUTER JOIN                                            
	 (SELECT SYMBOL,SECURITY,NET_TRDQTY FROM INTRANET.MISC.DBO.PD301203 WITH (NOLOCK) WHERE  PDDATE
	 BETWEEN CONVERT(DATETIME,@FROMDATE+' 00:00:00.000',103) AND CONVERT(DATETIME,@TODATE+' 23:59:59.000',103) )B                               
	 ON A.SCRIP_CD=B.SYMBOL                                                      
	END                                                    
	--------------------------FINAL OUTPUT ------------------------------------------------------                                                            
	IF @SEGMENT='ABLCM'                                                    
	BEGIN                                                    
	 SELECT A.PARTY_CODE,A.SCRIP_CD,A.SC_NAME,A.TURNOVER,ISNULL(NO_OF_SHRS,0) AS TOTALNOOFSHARES,A.TURNOVERPERC,                                                    
	 B.BUYRATE,B.SELLRATE,C.STKPRCVARIATION,D.PL,CASE WHEN A.PARTY_CODE=G.PARTY_CODE THEN 'ONLINE CLIENT' ELSE 'OFFLINE CLIENT' END AS STATUS
	 ,C.SAUDA_DATE                                  
	  INTO #BSE1                                                            
	 FROM                                                            
	 (SELECT * FROM #ILLPERCBSE(NOLOCK)) A                                                            
	 INNER JOIN                                                            
	 (SELECT  * FROM #TBL1(NOLOCK)) B                                                            
	 ON A.PARTY_CODE=B.PARTY_CODE AND A.SCRIP_CD=B.SCRIP_CD                                                             
	 INNER JOIN                                                     
	 (SELECT  * FROM #ILLSTP(NOLOCK)) C                                                            
	 ON A.PARTY_CODE=C.PARTY_CODE AND A.SCRIP_CD=C.SCRIP_CD                                                            
	 INNER JOIN                                              
	 (SELECT * FROM #PLILL(NOLOCK))D                                                            
	 ON A.PARTY_CODE=D.PARTY_CODE AND A.SCRIP_CD=D.SCRIP_CD                                     
	 LEFT OUTER JOIN                                  
	 (SELECT PARTY_CODE FROM INTRANET.CTCL.DBO.EBROK_CLIENT WITH (NOLOCK))G             
	 ON A.PARTY_CODE=G.PARTY_CODE                                              
	 -----                                     
	 SELECT F.*,E.PQTYTRD,E.PQTYDEL,E.SQTYTRD,E.SQTYDEL INTO #ILLBSE                                              
	 FROM                                               
	 (SELECT * FROM #BSE1(NOLOCK))F                                              
	 INNER JOIN                                               
	 (SELECT * FROM #TBL2(NOLOCK))E                                              
	 ON F.PARTY_CODE=E.PARTY_CODE AND F.SCRIP_CD=E.SCRIP_CD                  
	        
   SELECT TOP 0 * INTO #ILLBSE2 FROM #ILLBSE(NOLOCK)     
           
   --SELECT *          
   --INTO #ILLBSE2          
   --FROM #ILLBSE(NOLOCK)          
   --WHERE PL NOT BETWEEN @PL1 AND @PL OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART          
   --ORDER BY PARTY_CODE,SCRIP_CD          
         
   IF @CODETYPE='C'    
    BEGIN    
   INSERT INTO #ILLBSE2    
    SELECT DISTINCT *          
    FROM #ILLBSE(NOLOCK)          
    WHERE RTRIM(LTRIM(PARTY_CODE))=@CODE AND (PL NOT BETWEEN @PL1 AND @PL     
    OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART)          
    ORDER BY PARTY_CODE,SCRIP_CD       
    END    
    IF @CODETYPE='S'    
    BEGIN    
   INSERT INTO #ILLBSE2    
    SELECT DISTINCT *          
    FROM #ILLBSE(NOLOCK)          
    WHERE RTRIM(LTRIM(SCRIP_CD))=@CODE AND (PL NOT BETWEEN @PL1 AND @PL     
    OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART)          
    ORDER BY PARTY_CODE,SCRIP_CD     
    END    
    IF @CODETYPE='All'    
    BEGIN    
   INSERT INTO #ILLBSE2    
    SELECT DISTINCT *          
    FROM #ILLBSE(NOLOCK)          
    WHERE PL NOT BETWEEN @PL1 AND @PL     
    OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART          
    ORDER BY PARTY_CODE,SCRIP_CD     
    END     
         
   /********************************************************************************************/    
         
   SELECT PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))             
    +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))      
    +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''            
    +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+             
    ltrim(rtrim(PARTY_CODE)) +'</a>'          
   ,SCRIP_CD AS [SCRIP_CODE],SC_NAME AS SCRIP,PQTYTRD AS [BUY QTY TRD],SQTYTRD AS [SELL QTY TRD],          
   PQTYDEL AS[BUY QTY DEL],SQTYDEL AS [SELL QTY DEL ],BUYRATE,SELLRATE,          
   CASE WHEN PL NOT BETWEEN @PL1 AND @PL THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,PL)+'</FONT>'           
   ELSE CONVERT(VARCHAR,PL) END AS [PL(RS)],          
   TURNOVER,TOTALNOOFSHARES AS [MARKET VOLUME],          
   CASE WHEN TURNOVERPERC>=@IILLMRKTGRSPERC THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,TURNOVERPERC)+'</FONT>'           
   ELSE CONVERT(VARCHAR,TURNOVERPERC) END AS [% TO MKT VOL] ,          
   CASE WHEN STKPRCVARIATION>=@ILLSTKPRICVART THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,STKPRCVARIATION)+'</FONT>'          
   ELSE CONVERT(VARCHAR,STKPRCVARIATION) END AS [RATE DIFFERENCE %],STATUS,CONVERT(VARCHAR(11),SAUDA_DATE,103) AS [DATE]         
   FROM #ILLBSE2(NOLOCK)          
   --ORDER BY PARTY_CODE,SCRIP_CD           
     ORDER BY SAUDA_DATE DESC 
 END          
          
          
 ELSE IF @SEGMENT='ACDLCM'          
 BEGIN          
          
	   
	 SELECT A.PARTY_CODE,A.SCRIP_CD,SECURITY,TURNOVER,ISNULL(NET_TRDQTY,0) AS TOTALNOOFSHARES,TURNOVERPERC,B.BUYRATE,B.SELLRATE,                                              
	 STKPRCVARIATION,PL,CASE WHEN A.PARTY_CODE=G.PARTY_CODE THEN 'ONLINE CLIENT' ELSE 'OFFLINE CLIENT' END AS STATUS,C.SAUDA_DATE
	 INTO #NSE1                                              
	  FROM                                              
	 (SELECT PARTY_CODE,SCRIP_CD,TURNOVER,TURNOVERPERC,SECURITY,NET_TRDQTY FROM #ILLPERCNSE(NOLOCK))A                                              
	 INNER JOIN                                              
	 (SELECT  BUYRATE,SELLRATE,PARTY_CODE,SCRIP_CD,RATEDIFF FROM #TBL1(NOLOCK)) B                           
	 ON A.PARTY_CODE=B.PARTY_CODE AND A.SCRIP_CD=B.SCRIP_CD                                               
	 INNER JOIN                                              
	 (SELECT  STKPRCVARIATION,PARTY_CODE,SCRIP_CD,SELLRATE,BUYRATE,SAUDA_DATE FROM #ILLSTP(NOLOCK)) C                                                            
	 ON A.PARTY_CODE=C.PARTY_CODE AND A.SCRIP_CD=C.SCRIP_CD                                                
	 INNER JOIN                                              
	 (SELECT PL,PARTY_CODE,SCRIP_CD FROM #PLILL(NOLOCK))D                                               
	 ON A.PARTY_CODE=D.PARTY_CODE AND A.SCRIP_CD=D.SCRIP_CD                                       
	 LEFT OUTER JOIN                                  
	 (SELECT PARTY_CODE FROM INTRANET.CTCL.DBO.EBROK_CLIENT WITH (NOLOCK))G                                  
	 ON A.PARTY_CODE=G.PARTY_CODE                                           
	 ---                                              
	 SELECT F.*,E.PQTYTRD,E.PQTYDEL,E.SQTYTRD,E.SQTYDEL INTO #ILLNSE                                              
	  FROM                                               
	 (SELECT PQTYTRD,PQTYDEL,SQTYTRD,SQTYDEL,SCRIP_CD,PARTY_CODE FROM #TBL2(NOLOCK))E                                              
	 INNER JOIN                                              
	 (SELECT * FROM #NSE1)F                                              
	 ON F.PARTY_CODE=E.PARTY_CODE AND F.SCRIP_CD=E.SCRIP_CD                                                        
	  /********************************************************************************************/      
	           
	   --SELECT *          
	   --INTO #ILLNSE2          
	   --FROM #ILLNSE(NOLOCK)          
	   --WHERE PL NOT BETWEEN @PL1 AND @PL OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART          
	   --ORDER BY PARTY_CODE,SCRIP_CD          
	         
	   SELECT TOP 0 * INTO #ILLNSE2 FROM #ILLNSE(NOLOCK)     
	       
	  /********************************************************************************************/    
           
	         
	   IF @CODETYPE='C'    
		BEGIN    
	   INSERT INTO #ILLNSE2    
		SELECT DISTINCT *          
		FROM #ILLNSE(NOLOCK)          
		WHERE RTRIM(LTRIM(PARTY_CODE))=@CODE AND (PL NOT BETWEEN @PL1 AND @PL     
		OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART)         
		ORDER BY PARTY_CODE,SCRIP_CD    
		END    
	   IF @CODETYPE='S'    
		BEGIN    
	   INSERT INTO #ILLNSE2    
		SELECT DISTINCT *          
		FROM #ILLNSE(NOLOCK)          
		WHERE RTRIM(LTRIM(SCRIP_CD))=@CODE AND (PL NOT BETWEEN @PL1 AND @PL     
		OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART)         
		ORDER BY PARTY_CODE,SCRIP_CD    
		END    
	   IF @CODETYPE='All'    
		BEGIN    
	   INSERT INTO #ILLNSE2    
		SELECT DISTINCT *          
		FROM #ILLNSE(NOLOCK)            
		WHERE PL NOT BETWEEN @PL1 AND @PL     
		OR TURNOVERPERC>=@IILLMRKTGRSPERC OR STKPRCVARIATION>=@ILLSTKPRICVART          
		ORDER BY PARTY_CODE,SCRIP_CD    
		END     
	         
	   /********************************************************************************************/    
	    
	  SELECT          
	   PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))             
		+'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))            
		+'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''            
		+');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+             
		ltrim(rtrim(PARTY_CODE)) +'</a>'          
	   ,SCRIP_CD AS [SCRIP_CODE],SECURITY AS SCRIP,PQTYTRD AS [BUY QTY TRD],          
	   SQTYTRD AS [SELL QTY TRD],PQTYDEL AS[BUY QTY DEL],SQTYDEL AS [SELL QTY DEL ],BUYRATE,SELLRATE,          
	   CASE WHEN PL NOT BETWEEN @PL1 AND @PL THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,PL)+'</FONT>'           
	   ELSE CONVERT(VARCHAR,PL) END AS [PL(RS)],          
	   TURNOVER,TOTALNOOFSHARES AS [MARKET VOLUME],          
	   CASE WHEN TURNOVERPERC>=@IILLMRKTGRSPERC THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,TURNOVERPERC)+'</FONT>'           
	   ELSE CONVERT(VARCHAR,TURNOVERPERC) END AS [% TO MKT VOL] ,          
	   CASE WHEN STKPRCVARIATION>=@ILLSTKPRICVART THEN '<FONT SIZE="2" COLOR="009933">'+CONVERT(VARCHAR,STKPRCVARIATION)+'</FONT>'           
	   ELSE CONVERT(VARCHAR,STKPRCVARIATION) END AS [RATE DIFFERENCE %],          
	   STATUS,CONVERT(VARCHAR(11),SAUDA_DATE,103) AS [DATE]          
	   FROM #ILLNSE2 (NOLOCK)          
	   ORDER BY SAUDA_DATE DESC  
	   --PARTY_CODE,SCRIP_CD        
  END          
END          
 /**-------------------------------------------------END-------------------------------------------**/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_fds_IllScripAlert_Nsefo
-- --------------------------------------------------


--Usp_fds_IllScripAlert_Nsefo '26/11/2013'  
CREATE   proc Usp_fds_IllScripAlert_Nsefo -- '08/07/2011 '  
(        
@date as varchar(11)    
--,        
--@access_to As varchar(25),                       
--@access_code As varchar(25)      
)        
as        
SET NOCOUNT ON        
        
if convert(datetime,@date,103)+ '23:59:59.000' = getdate()+'23:59:59.000'        
begin         
        
select Symbol as scrip_cd,sec_name as scrip_id,buy_sell,trade_qty as qty,price as rate,              
clientaccount_no as clientid into #nsefo  from [196.1.115.233].general.dbo.nsefodata--nsefo data          
        
select inst_type,symbol,convert(varchar(11),expiry_date,103)expiry_date,strike_price,buy_sell,user_id,trade_qty,price,clientaccount_no         
into #nsefocurnt from [196.1.115.233].general.dbo.nsefodata        
        
--declare @date as varchar(11)        
--set @date='06/04/2010'        
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103)ex_date         
into #illfo from FDS_IlllScript_Fo where convert(varchar(11),Sdate,103) = @date        
         
select a.* into #nsefoill from          
(select * from #nsefocurnt)a        
inner join         
(select * from #illfo)b        
on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type and         
a.expiry_date=b.ex_date        
        
select inst_type,symbol,        
expiry_date,        
strike_price,        
case when buy_sell=1 then 'B' else 'S'end as buy_sell,user_id,        
sum(trade_qty)trade_qty,avg(price)price,clientaccount_no into #data1        
 from #nsefoill group by inst_type,symbol,expiry_date,strike_price,clientaccount_no,buy_sell,user_id        
        
select case when a.clientaccount_no is null then b.clientaccount_no else a.clientaccount_no end as clientaccount_no,              
case when a.symbol is null then b.symbol else a.symbol end as symbol,              
case when a.inst_type is null then b.inst_type else a.inst_type end as inst_type,        
case when a.expiry_date is null then b.expiry_date else a.expiry_date end as expiry_date,        
case when a.strike_price is null then b.strike_price else a.strike_price end as strike_price,        
case when a.user_id is null then b.user_id else a.user_id end as user_id,        
 isnull(a.buy_sell,'-') as Buy ,              
isnull(b.buy_sell,'-') as Sell,              
isnull(a.trade_qty,0) as Buyqty,              
isnull(b.trade_qty,0) as Sellqty,              
isnull(a.price,0) as b_rate,              
isnull(b.price,0) as s_rate              
into #rr         
from              
(select * from #data1 where buy_sell = 'B')a              
full outer join              
(select * from #data1 where buy_sell = 'S')b              
on a.clientaccount_no = b.clientaccount_no and a.symbol = b.symbol              
        
select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty         
into #data2 from #rr        
select *,pL=samt-bamt into #final123 from #data2        
        
     
select a.*,case when a.clientaccount_no = b.party_code then 'Online' else 'Offline' end as status,
CASE WHEN isnull(d.mobile_pager,'')='' THEN 'N' ELSE 'Y' END AS Mobile
 from        
(        
select * from #final123         
)a         
left outer join intranet.ctcl.dbo.ebrok_client b with (nolock)        
on a.clientaccount_no = b.party_code      
LEFT OUTER JOIN INTRANET.RISK.DBO.CLIENT_DETAILS d ON d.cl_code =a.clientaccount_no    
order by a.clientaccount_no        
end        
----------------------------------Else Begins -------------------------------------------        
else        
Begin        
/*        
         
set @date = convert(datetime,@date,103)          
select Party_code,party_name,client_type,inst_type,symbol,convert(varchar(11),expirydate,103)expirydate,strike_price,        
pqty,sqty,prate,srate,pamt,samt into #fodata1         
from ANGELFO.Nsefo.dbo.FoBillValan where convert(char(11),sauda_date)=convert(datetime,@date,103)           
        
--declare @date as varchar(11)        
--set @date='01/04/2010'        
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103)ex_date          
 from FDS_IlllScript_Fo where Convert(varchar(11),Sdate,103)=@date        
        
        
select a.* into #illdata from         
(select Party_code,party_name,client_type,inst_type,symbol,expirydate,strike_price,        
pqty,sqty,prate,srate,pamt,samt from #fodata1)a        
inner join        
(select * from #illfo)b        
on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type        
and a.expirydate=b.ex_date        
        
select case when sum(pqty)=0.00 then sum(pamt)/(sum(pqty)+1)                          
else sum(pamt)/(sum(pqty))  end as Buyrate,                                            
case when sum(sqty)=0.00 then sum(samt)/(sum(sqty)+1)                             
else sum(samt)/(sum(sqty)) end as Sellrate,party_code,symbol --into #tbl                                            
from #illdata(nolock) group by symbol,party_code         
        
select * from #illdata        
select Party_code,Party_name,client_type,inst_type,symbol,expirydate,strike_price,        
sum(pqty)pqty,sum(sqty)sqty,avg(prate)prate,avg(srate)srate,avg(pamt)pamt,avg(samt)samt into #illsumfo         
from #illdata        
group by party_code, party_name,symbol,expirydate,client_type,inst_type,strike_price        
        
        
-------------------------cal rate diff---------------------------------------------------         
select *,RateDiff=srate-prate into #ratediff from #illsumfo         
-------------------------cal STPVR diff---------------------------------------------------         
        
select party_code,        
Tover=(Pqty+sqty),        
PL=(samt-pamt),symbol,expirydate,prate,srate,sqty,pqty,samt,pamt,client_type,inst_type,strike_price         
from #ratediff        
group by party_code, party_name,symbol,expirydate,client_type,inst_type,strike_price,        
prate,srate,sqty,pqty,samt,pamt order by party_code        
*/        
        
create table #Fo_Data_New        
(        
party_code  varchar(20),inst_type varchar(25),symbol varchar(25),expirydate datetime,        
strike_price money,user_id varchar(25),        
sell_buy int,amount money,tradeqty int ,price money        
)        
        
/*        
declare @date as varchar(11)        
set @date='01/04/2010'        
*/        
        
declare @maxdate as varchar(25)        
set @maxdate = (select convert(datetime,max(expirydate),103)+'23:59:59.000' from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock))        
if convert(datetime,@date,103)+'23:59:59.000' > @maxdate        
begin         
insert into #Fo_Data_New        
select party_code,inst_type,symbol,expirydate,strike_price,user_id,        
sell_buy,amount,tradeqty,price  from ANGELFO.nsefo.dbo.Fosettlement        
where sauda_date >= convert(datetime,@date,103) and         
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'         
end         
else         
begin         
insert into #Fo_Data_New        
select party_code,inst_type,symbol,expirydate,strike_price,user_id,        
sell_buy,amount,tradeqty,price  from         
ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo        
where sauda_date >= convert(datetime,@date,103) and         
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'         
end        
        
        
select party_code,        
inst_type,        
symbol,        
expirydate,        
strike_price,        
user_id,        
case when sell_buy=1 then 'B' else 'S'end as sell_buy ,        
sum(amount) as amount,        
sum(tradeqty)tradeqty ,        
avg(price)price         
into #Fo_Data_New1  from #Fo_Data_New        
group by inst_type,symbol,expirydate,strike_price,party_code,sell_buy,user_id        
        
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103)ex_date          
into #illfo1 from intranet.risk.dbo.FDS_IlllScript_Fo  where        
Sdate >= convert(datetime,@date,103) and         
Sdate <= convert(datetime,@date,103) + '23:59:59.000'        
        
        
select a.*         
into #illdata1         
from         
(select * from #Fo_Data_New1)a        
inner join         
(select * from #illfo1)b        
on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type        
and convert(varchar(11),a.expirydate,103)=b.ex_date order by party_code,symbol        
        
        
select case when a.party_code is null then b.party_code else a.party_code end as party_code,              
case when a.symbol is null then b.symbol else a.symbol end as symbol,              
case when a.inst_type is null then b.inst_type else a.inst_type end as inst_type,        
case when a.expirydate is null then b.expirydate else a.expirydate end as expirydate,        
case when a.strike_price is null then b.strike_price else a.strike_price end as strike_price,        
case when a.user_id is null then b.user_id else a.user_id end as user_id,        
 isnull(a.sell_buy,'-') as Buy ,              
isnull(b.sell_buy,'-') as Sell,              
isnull(a.tradeqty,0) as Buyqty,              
isnull(b.tradeqty,0) as Sellqty,              
isnull(a.price,0) as b_rate,              
isnull(b.price,0) as s_rate              
into #rr1        
from              
(select * from #illdata1 where sell_buy = 'B')a              
full outer join              
(select * from #illdata1 where sell_buy = 'S')b              
on a.party_code = b.party_code and a.symbol = b.symbol              
        
        
select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty         
into #Fo_Data_New2         
from #rr1        
        
        
select *,pL=samt-bamt into #Fo_Data_New3 from #Fo_Data_New2        
        
select a.*,case when a.party_code = b.party_code then 'Online' else 'Offline' end as status ,
CASE WHEN isnull(d.mobile_pager,'')='' THEN 'N' ELSE 'Y' END AS Mobile,
c.sub_broker,c.branch_cd from        
(select a.*,b.long_name from #Fo_Data_New3 a         
left outer join  intranet.risk.dbo.client_details b  with (nolock)        
on a.party_code = b.party_code)a        
 left outer join intranet.ctcl.dbo.ebrok_client b on a.party_code = b.party_code        
 LEFT OUTER JOIN intranet.risk.dbo.client_details d
 ON d.cl_code=a.party_code 
inner join (select * from risk.dbo.client_details) c on a.party_code = c.party_code     
   order by a.party_code      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_fds_IllScripAlert_Nsefo_NEW
-- --------------------------------------------------

CREATE  proc Usp_fds_IllScripAlert_Nsefo_NEW --'17/01/2011','STATIC','','',''             
(                    
@date as varchar(11),             
@Flag varchar(25),           
@username varchar(25)=Null,               
@access_to varchar(25)=Null,                    
@access_code varchar(25)=Null                 
)                    
as                    
SET NOCOUNT ON                    
                    
if convert(datetime,@date,103)+ '23:59:59.000' = getdate()+'23:59:59.000'                    
begin                     
-- print 'today'                   
select Symbol as scrip_cd,sec_name as scrip_id,buy_sell,trade_qty as qty,price as rate,                          
clientaccount_no as clientid into #nsefo  from [196.1.115.233].general.dbo.nsefodata with (nolock)--nsefo data                      
                    
select inst_type,symbol,convert(varchar(11),expiry_date,103)expiry_date,strike_price,buy_sell,user_id,trade_qty,price,clientaccount_no                     
into #nsefocurnt from [196.1.115.233].general.dbo.nsefodata with (nolock)                   
                    
--declare @date as varchar(11)                    
--set @date='06/04/2010'                    
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103)ex_date                     
into #illfo from FDS_IlllScript_Fo with (nolock) where convert(varchar(11),Sdate,103) = @date                    
                     
select a.* into #nsefoill from                      
(select * from #nsefocurnt)a                    
inner join                     
(select * from #illfo)b                    
on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type and                     
a.expiry_date=b.ex_date                    
                    
select inst_type,symbol,                    
expiry_date,                    
strike_price,                    
case when buy_sell=1 then 'B' else 'S'end as buy_sell,user_id,                    
sum(trade_qty)trade_qty,avg(price)price,clientaccount_no into #data1                    
 from #nsefoill group by inst_type,symbol,expiry_date,strike_price,clientaccount_no,buy_sell,user_id                    
                    
select case when a.clientaccount_no is null then b.clientaccount_no else a.clientaccount_no end as clientaccount_no,                          
case when a.symbol is null then b.symbol else a.symbol end as symbol,                          
case when a.inst_type is null then b.inst_type else a.inst_type end as inst_type,                    
case when a.expiry_date is null then b.expiry_date else a.expiry_date end as expiry_date,                    
case when a.strike_price is null then b.strike_price else a.strike_price end as strike_price,                    
case when a.user_id is null then b.user_id else a.user_id end as user_id,                    
 isnull(a.buy_sell,'-') as Buy ,                          
isnull(b.buy_sell,'-') as Sell,                          
isnull(a.trade_qty,0) as Buyqty,                          
isnull(b.trade_qty,0) as Sellqty,                          
isnull(a.price,0) as b_rate,                          
isnull(b.price,0) as s_rate                          
into #rr                     
from                          
(select * from #data1 where buy_sell = 'B')a                          
full outer join                          
(select * from #data1 where buy_sell = 'S')b                          
on a.clientaccount_no = b.clientaccount_no and a.symbol = b.symbol                          
                    
select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty                     
into #data2 from #rr                    
select *,pL=samt-bamt into #final123 from #data2                    
                    
                    
select a.*,case when a.clientaccount_no = b.party_code then 'Online' else 'Offline' end as status from                    
(                    
select * from #final123                     
)a                     
left outer join intranet.ctcl.dbo.ebrok_client b with (nolock)                    
on a.clientaccount_no = b.party_code order by a.clientaccount_no           
                    
end                    
----------------------------------Else Begins -------------------------------------------              
else                    
Begin                    
/*                    
                     
set @date = convert(datetime,@date,103)                      
select Party_code,party_name,client_type,inst_type,symbol,convert(varchar(11),expirydate,103)expirydate,strike_price,                    
pqty,sqty,prate,srate,pamt,samt into #fodata1                 
from ANGELFO.Nsefo.dbo.FoBillValan where convert(char(11),sauda_date)=convert(datetime,@date,103)                       
                    
--declare @date as varchar(11)                    
--set @date='01/04/2010'                    
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103)ex_date                      
 from FDS_IlllScript_Fo where Convert(varchar(11),Sdate,103)=@date                    
                
                    
select a.* into #illdata from                     
(select Party_code,party_name,client_type,inst_type,symbol,expirydate,strike_price,                    
pqty,sqty,prate,srate,pamt,samt from #fodata1)a                    
inner join                     
(select * from #illfo)b                    
on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type                    
and a.expirydate=b.ex_date                    
                    
select case when sum(pqty)=0.00 then sum(pamt)/(sum(pqty)+1)                                      
else sum(pamt)/(sum(pqty))  end as Buyrate,                                                        
case when sum(sqty)=0.00 then sum(samt)/(sum(sqty)+1)                                         
else sum(samt)/(sum(sqty)) end as Sellrate,party_code,symbol --into #tbl                                                        
from #illdata(nolock) group by symbol,party_code                     
                    
select * from #illdata                    
select Party_code,Party_name,client_type,inst_type,symbol,expirydate,strike_price,                    
sum(pqty)pqty,sum(sqty)sqty,avg(prate)prate,avg(srate)srate,avg(pamt)pamt,avg(samt)samt into #illsumfo                     
from #illdata                    
group by party_code, party_name,symbol,expirydate,client_type,inst_type,strike_price                    
                    
                    
-------------------------cal rate diff---------------------------------------------------                     
select *,RateDiff=srate-prate into #ratediff from #illsumfo                     
-------------------------cal STPVR diff---------------------------------------------------                     
                    
select party_code,                    
Tover=(Pqty+sqty),                    
PL=(samt-pamt),symbol,expirydate,prate,srate,sqty,pqty,samt,pamt,client_type,inst_type,strike_price                     
from #ratediff                    
group by party_code, party_name,symbol,expirydate,client_type,inst_type,strike_price,                    
prate,srate,sqty,pqty,samt,pamt order by party_code                    
*/                    
                    
create table #Fo_Data_New                    
(                    
party_code  varchar(20),inst_type varchar(25),symbol varchar(25),expirydate datetime,                    
strike_price money,user_id varchar(25),                    
sell_buy int,amount money,tradeqty int ,price money                    
)                    
                    
/*                    
declare @date as varchar(11)                    
set @date='01/04/2010'   
*/                    
                    
declare @maxdate as varchar(25)                    
set @maxdate = (select convert(datetime,max(expirydate),103)+'23:59:59.000' from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock))                    
if convert(datetime,@date,103)+'23:59:59.000' > @maxdate                    
begin                     
insert into #Fo_Data_New                    
select party_code,inst_type,symbol,expirydate,strike_price,user_id,                    
sell_buy,amount,tradeqty,price  from ANGELFO.nsefo.dbo.Fosettlement with (nolock)                    
where sauda_date >= convert(datetime,@date,103) and                     
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                     
end                     
else                     
begin                     
insert into #Fo_Data_New                    
select party_code,inst_type,symbol,expirydate,strike_price,user_id,                    
sell_buy,amount,tradeqty,price  from                     
ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                   
where sauda_date >= convert(datetime,@date,103) and                     
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                     
end                    
                    
                    
select party_code,                    
inst_type,                    
symbol,                    
expirydate,                    
strike_price,                    
user_id,                    
case when sell_buy=1 then 'B' else 'S'end as sell_buy ,                   
sum(amount) as amount,                    
sum(tradeqty)tradeqty ,                    
avg(price)price                     
into #Fo_Data_New1  from #Fo_Data_New                    
group by inst_type,symbol,expirydate,strike_price,party_code,sell_buy,user_id                    
                    
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103)ex_date                      
into #illfo1 from intranet.risk.dbo.FDS_IlllScript_Fo with (nolock) where                    
Sdate >= convert(datetime,@date,103) and                     
Sdate <= convert(datetime,@date,103) + '23:59:59.000'                    
                    
                    
select a.*                     
into #illdata1                     
from                     
(select * from #Fo_Data_New1)a                    
inner join                     
(select * from #illfo1)b                    
on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type                    
and convert(varchar(11),a.expirydate,103)=b.ex_date order by party_code,symbol                    
                    
                    
select case when a.party_code is null then b.party_code else a.party_code end as party_code,                          
case when a.symbol is null then b.symbol else a.symbol end as symbol,                          
case when a.inst_type is null then b.inst_type else a.inst_type end as inst_type,                    
case when a.expirydate is null then b.expirydate else a.expirydate end as expirydate,                    
case when a.strike_price is null then b.strike_price else a.strike_price end as strike_price,                    
case when a.user_id is null then b.user_id else a.user_id end as user_id,                    
 isnull(a.sell_buy,'-') as Buy ,                          
isnull(b.sell_buy,'-') as Sell,                          
isnull(a.tradeqty,0) as Buyqty,                          
isnull(b.tradeqty,0) as Sellqty,                          
isnull(a.price,0) as b_rate,                          
isnull(b.price,0) as s_rate                          
into #rr1                    
from                          
(select * from #illdata1 where sell_buy = 'B')a                          
full outer join                          
(select * from #illdata1 where sell_buy = 'S')b                       
on a.party_code = b.party_code and a.symbol = b.symbol                          
                    
                    
select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty                     
into #Fo_Data_New2                     
from #rr1                    
                    
                    
select *,pL=samt-bamt into #Fo_Data_New3 from #Fo_Data_New2                    
                    
select a.*,case when a.party_code = b.party_code then 'ONLINE CLIENT' else 'OFFLINE CLIENT' end as status  into #NseFo2 from                    
(select a.*,b.long_name from #Fo_Data_New3 a                     
left outer join  intranet.risk.dbo.client_details b  with (nolock)                    
on a.party_code = b.party_code)a                    
left outer join intranet.ctcl.dbo.ebrok_client b with (nolock) on a.party_code = b.party_code                    
order by a.party_code                    
            
 if(@Flag='STATIC')            
 BEGIN                
  select PARTY_CODE,symbol,inst_type,expirydate,strike_price,user_id,  
  Buy,Sell,Buyqty,Sellqty,b_rate,s_rate,RateDiff,BAmt,SAmt,Tover,pL,long_name,status                
  from #NseFo2             
 END            
 ELSE            
 BEGIN                
  select PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))           
  +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))          
  +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''          
  +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+           
  ltrim(rtrim(PARTY_CODE)) +'</a>'                
  ,                
  symbol,inst_type,expirydate,strike_price,user_id,Buy,Sell,Buyqty,Sellqty,b_rate,  
  s_rate,RateDiff,BAmt,SAmt,Tover,pL,long_name,status                
  from #NseFo2                
 END            
SET NOCOUNT OFF              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDS_ILLSCRIPALERT_NSEFO_NEW_DATEWISE
-- --------------------------------------------------

CREATE proc USP_FDS_ILLSCRIPALERT_NSEFO_NEW_DATEWISE --'14/01/2011','14/01/2011','SBIN','S','','',''           
( 
	@FROMDATE AS VARCHAR(11),		/*************FROM DATE FORMAT DD/MM/YYYY*****************************/
	@TODATE AS VARCHAR(11),			/*************TO DATE FORMAT DD/MM/YYYY*******************************/                               
	@CODE		 VARCHAR(25),		/*************CODE VALUE DEPENDS ON CODETYPE**************************/
	@CODETYPE	 VARCHAR(25),   	/*************CODETYPE ALL(ALL),C(CLIENTCODE) AND S(SCRIPCODE)********/           
	@username varchar(25)=Null,               
	@access_to varchar(25)=Null,                    
	@access_code varchar(25)=Null                 
)                    
AS                    
BEGIN
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
SET NOCOUNT ON                                        
	
 /*                    
	select Symbol as scrip_cd,sec_name as scrip_id,buy_sell,trade_qty as qty,price as rate,                          
	clientaccount_no as clientid into #nsefo  from [196.1.115.227].general.dbo.nsefodata with (nolock)--nsefo data                      
	                    
	select inst_type,symbol,convert(varchar(11),expiry_date,103)expiry_date,strike_price,buy_sell,user_id,trade_qty,price,clientaccount_no                     
	into #nsefocurnt from [196.1.115.227].general.dbo.nsefodata with (nolock)                   
	                    
	                  
	select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103)ex_date,Sdate                    
	into #illfo 
	 from RISK.DBO.FDS_IlllScript_Fo  with (nolock)
	where Sdate>=convert(datetime,@FROMDATE+' 00:00:00.000',103) 
		AND Sdate<=convert(datetime,@TODATE+' 23:59:59.000',103) 

	                     
	select a.*,b.Sdate into #nsefoill from                      
		(select * from #nsefocurnt)a                    
	inner join                     
		(select * from #illfo)b                    
	on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type and                     
			a.expiry_date=b.ex_date                    
	                    
	select inst_type,symbol,                    
		expiry_date,                    
		strike_price,                    
		case when buy_sell=1 then 'B' else 'S'end as buy_sell,user_id,                    
		sum(trade_qty)trade_qty,avg(price)price,clientaccount_no,Sdate 
	into #data1                    
	from #nsefoill 
	group by inst_type,symbol,expiry_date,strike_price,clientaccount_no,buy_sell,user_id,Sdate                    
	                    
	select case when a.clientaccount_no is null then b.clientaccount_no else a.clientaccount_no end as clientaccount_no,                          
		case when a.symbol is null then b.symbol else a.symbol end as symbol,                          
		case when a.inst_type is null then b.inst_type else a.inst_type end as inst_type,                    
		case when a.expiry_date is null then b.expiry_date else a.expiry_date end as expiry_date,                    
		case when a.strike_price is null then b.strike_price else a.strike_price end as strike_price,                    
		case when a.user_id is null then b.user_id else a.user_id end as user_id,                    
		isnull(a.buy_sell,'-') as Buy ,                          
		isnull(b.buy_sell,'-') as Sell,                          
		isnull(a.trade_qty,0) as Buyqty,                          
		isnull(b.trade_qty,0) as Sellqty,                          
		isnull(a.price,0) as b_rate,                          
		isnull(b.price,0) as s_rate,
		case when a.Sdate is null then b.Sdate else a.Sdate end as [date]                          
	into #rr                     
	from                          
		(select * from #data1 where buy_sell = 'B')a                          
	full outer join                          
		(select * from #data1 where buy_sell = 'S')b                          
	on a.clientaccount_no = b.clientaccount_no and a.symbol = b.symbol                          
	                    
	select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty                     
	into #data2 from #rr                    

	select *,pL=samt-bamt into #final123 from #data2                    
	
---------------------------------------------------------------------------------------------------------	                    
	
	select a.*,c.long_name,case when a.clientaccount_no = b.party_code then 'Online' else 'Offline' end as status
	 from                    
		(                    
			select * from #final123                     
		)a                     
	left outer join ctcl.dbo.ebrok_client b with (nolock)                    
		on a.clientaccount_no = b.party_code
	left outer join  risk.dbo.client_details c  with (nolock)  
		on a.clientaccount_no = c.party_code  
     order by a.[date] desc           
----------------------------------Else Begins -------------------------------------------              
*/               
                    
	                    
	create table #Fo_Data_New                    
	(                    
		party_code  varchar(20),inst_type varchar(25),symbol varchar(25),expirydate datetime,                    
		strike_price money,user_id varchar(25),                    
		sell_buy int,amount money,tradeqty int ,price money,                
	)                    
	  
	create table #FO_DATA_HISTORY                   
	(                    
		party_code  varchar(20),inst_type varchar(25),symbol varchar(25),expirydate datetime,                    
		strike_price money,user_id varchar(25),                    
		sell_buy int,amount money,tradeqty int ,price money,                
	)                    
	                    
   
	          
	INSERT INTO #Fo_Data_New                    
	SELECT party_code,inst_type,symbol,expirydate,strike_price,user_id,                    
		   sell_buy,amount,tradeqty,price  
	FROM ANGELFO.nsefo.dbo.Fosettlement 
	WITH (NOLOCK)                    
	WHERE sauda_date>=CONVERT(DATETIME,(@FROMDATE+' 00:00:00.000'),103)  
		And sauda_date<=CONVERT(DATETIME,(@TODATE+' 23:59:59.000'),103)     
	                     
	INSERT INTO #FO_DATA_HISTORY                    
	select party_code,inst_type,symbol,expirydate,strike_price,user_id,                    
		sell_buy,amount,tradeqty,price 
	from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                   
	WHERE sauda_date>=CONVERT(DATETIME,(@FROMDATE+' 00:00:00.000'),103)  
		And sauda_date<=CONVERT(DATETIME,(@TODATE+' 23:59:59.000'),103)     
		
	SELECT * INTO #ALL_CLIENT FROM 
	(SELECT * FROM #Fo_Data_New
	UNION
	SELECT * FROM #FO_DATA_HISTORY
	)a	                   
	              
	select party_code,                    
		inst_type,                    
		symbol,                    
		expirydate,                    
		strike_price,                    
		user_id,                    
		case when sell_buy=1 then 'B' else 'S'end as sell_buy ,                   
		sum(amount) as amount,                    
		sum(tradeqty)tradeqty ,                    
		avg(price)price
		                  
	into #Fo_Data_New1  from #ALL_CLIENT                    
	group by inst_type,symbol,expirydate,strike_price,party_code,sell_buy,user_id                
	                    
	select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103) ex_date            
	into #illfo1 
	from risk.dbo.FDS_IlllScript_Fo with (nolock) where                    
			Sdate >= CONVERT(DATETIME,(@FROMDATE+' 00:00:00.000'),103) and                     
			Sdate <= CONVERT(DATETIME,(@TODATE+' 23:59:59.000'),103)                
	                    
	                    
	select a.*                     
	into #illdata1                     
	from                     
		(select * from #Fo_Data_New1)a                    
	inner join                     
		(select * from #illfo1)b                    
	on a.symbol=b.symbol and a.strike_price=b.strike_price and a.inst_type=b.inst_type                    
	and convert(varchar(11),a.expirydate,103)=b.ex_date order by party_code,symbol                    
	                    
	                    
	select case when a.party_code is null then b.party_code else a.party_code end as party_code,                          
		case when a.symbol is null then b.symbol else a.symbol end as symbol,                          
		case when a.inst_type is null then b.inst_type else a.inst_type end as inst_type,                    
		case when a.expirydate is null then b.expirydate else a.expirydate end as expirydate,                    
		case when a.strike_price is null then b.strike_price else a.strike_price end as strike_price,                    
		case when a.user_id is null then b.user_id else a.user_id end as user_id,                    
		isnull(a.sell_buy,'-') as Buy ,                          
		isnull(b.sell_buy,'-') as Sell,                          
		isnull(a.tradeqty,0) as Buyqty,                          
		isnull(b.tradeqty,0) as Sellqty,                          
		isnull(a.price,0) as b_rate,                          
		isnull(b.price,0) as s_rate
	into #rr1                    
	from                          
		(select * from #illdata1 where sell_buy = 'B')a                          
	full outer join                          
		(select * from #illdata1 where sell_buy = 'S')b                          
	on a.party_code = b.party_code and a.symbol = b.symbol                          
	                    
	                    
	--select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty                     
	--into #Fo_Data_New2                     
	--from #rr1                    
	  
	
	--party_code,symbol,inst_type,expirydate,strike_price,user_id,Buy,Sell,Buyqty,Sellqty,b_rate,s_rate,RateDiff,BAmt,SAmt,Tover
	
    create table #Fo_Data_New2                    
	(                    
		party_code  varchar(20),symbol varchar(25),
		inst_type varchar(25),
		expirydate datetime,                    
		strike_price money,
		user_id varchar(25),                    
		buy varchar(4),
		Sell varchar(4),
		Buyqty int,
		Sellqty int,
		b_rate money,
		s_rate money,
		RateDiff money,
		BAmt money,
		SAmt money,
		Tover money
	)
	--select * from #Fo_Data_New2  
	                    
	IF @CODETYPE='C'
	BEGIN
			INSERT INTO #FO_DATA_NEW2
			select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty                     
			from #rr1    
			WHERE LTRIM(RTRIM(PARTY_CODE))=@CODE                
	END
	IF @CODETYPE='S'
	BEGIN
			INSERT INTO #FO_DATA_NEW2
			select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty                     
			from #rr1    
			WHERE LTRIM(RTRIM(symbol))=@CODE 
	END
	IF @CODETYPE='All'
	BEGIN
			INSERT INTO #FO_DATA_NEW2
			select *,RateDiff=(S_rate-B_rate),BAmt=Buyqty*b_rate,SAmt=sellqty*s_rate,Tover=buyqty+sellqty                     
			from #rr1    
	END
	 
	                    
	select *,pL=samt-bamt into #Fo_Data_New3 from #Fo_Data_New2                    
	                    
	select distinct a.*,case when a.party_code = b.party_code then 'ONLINE CLIENT' else 'OFFLINE CLIENT' end as status  into #NseFo2 from                    
		(select a.*,b.long_name from #Fo_Data_New3 a                     
			left outer join  risk.dbo.client_details b  with (nolock)                    
				on a.party_code = b.party_code
		)a                    
	left outer join ctcl.dbo.ebrok_client b with (nolock) 
	on a.party_code = b.party_code                    
	order by a.party_code                    
	            
	               
	  select PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))           
	  +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))          
	  +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''          
	  +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+           
	  ltrim(rtrim(PARTY_CODE)) +'</a>'                
	  ,symbol,inst_type,convert(varchar(11),expirydate,103) AS [Expiry date],strike_price,user_id,Buy,Sell,Buyqty,Sellqty,b_rate,  
	  s_rate,RateDiff,BAmt,SAmt,Tover,pL,long_name,status
	  from #NseFo2   
	  order by PARTY_CODE        
	SET NOCOUNT OFF              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDS_ILLSCRIPALERT_temp
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_FDS_ILLSCRIPALERT_temp] --'06/10/2010','ACDLCM','2000','20','20','',''                                   
(                                      
@date as varchar(11),                                    
@segment as varchar(15),                                    
@pl as int,                                    
@Illstkpricvart as int,                                    
@IillMrktGrsPerc as int,    
@username varchar(25)=Null,           
@access_to varchar(25)=Null,              
@access_code varchar(25)=Null                                      
)                                      
as                       
SET NOCOUNT ON                               
      
set @date = convert(datetime,@date,103)                                    
declare @pl1 as int                                                   
set @pl1= @pl*-1                               
                                 
DECLARE @PREV_DATE DATETIME      
SET @PREV_DATE = (SELECT DATEADD(S,-1,DATEADD(MM, DATEDIFF(M,0,@DATE),0)))      
                   
                              
select top 0 party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                    
PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date into #mainill from AngelNseCM.msajag.dbo.cmbillvalan                                            
--drop table #mainill                                                 
--declare @segment as varchar(10)                                                
--set @segment='ABLCM'                                               
--declare @date as varchar(11)                                     
--set @date = convert(datetime,'20/11/2009',103)                               
                                            
alter table #mainill alter column party_name varchar(100)                                            
IF @segment='ABLCM'                                                
BEGIN                                                
      insert  into #mainill                                                 
      select party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                    
PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date from AngelBSECM.bsedb_ab.dbo.cmbillvalan                                             
where sauda_date =convert(datetime,@date,103)                                                
END                                                
ELSE IF @segment='ACDLCM'                                                
BEGIN                                                
      insert  into #mainill                                                 
      select party_code,party_name,scrip_cd,scrip_name,PQtyTrd,PAmtTrd,PQtyDel,                                                    
PAmtDel,SQtyTrd,SAmtTrd,SQtyDel,SAmtDel,sauda_date from AngelNseCM.msajag.dbo.cmbillvalan                                                
 where  sauda_date =convert(datetime,@date,103)                                                
END                                                
--drop table #mainill                                                    
--select top 5 * from #mainill                                                    
-------------------------------chk IllScrpt with particlr dates tred--------------------------------                                                    
-- drop table  #ill1                                    
select top 0 * into #ill1 from  #mainill(nolock)                                        
                                    
--declare @segment as varchar(10)                                                
--set @segment='ABLCM'                                                   
                                    
if @segment='ABLCM'                                                
begin                                                 
insert into #ill1                                       
select distinct a.party_code,a.party_name,a.scrip_cd,a.scrip_name,a.PQtyTrd,a.PAmtTrd,a.PQtyDel,                                                    
a.PAmtDel,a.SQtyTrd,a.SAmtTrd,a.SQtyDel,a.SAmtDel,a.sauda_date  from                                                    
(select  *  from #mainill(nolock))a                                                   
INNER JOIN                                                    
(      
 select * from intranet.misc.dbo.illScrip       
 where [month] = (SELECT DATENAME(month,@PREV_DATE))      
  AND [YEAR] = (SELECT DATENAME(YEAR,@PREV_DATE))      
) b              
on a.scrip_cd=b.scrip_cd                                                 
end                                                
else if @segment='ACDLCM'                                                
begin                                                
insert into #ill1                                            
select distinct a.party_code,a.party_name,a.scrip_cd,a.scrip_name,a.PQtyTrd,a.PAmtTrd,a.PQtyDel,                                                    
a.PAmtDel,a.SQtyTrd,a.SAmtTrd,a.SQtyDel,a.SAmtDel,a.sauda_date  from                                             
(select  *  from #mainill(nolock))a                                                    
inner join                             
(      
 select * from intranet.misc.dbo.illScrip_nse   
 where [month] = (SELECT DATENAME(month,@PREV_DATE))      
  AND [YEAR] = (SELECT DATENAME(YEAR,@PREV_DATE))          
      
)b                                                    
on a.scrip_cd=b.scrip_cd                                            
end                                                
                                                  
--------------------------------sum amt----------------------------------------------                                                    
select sum(pamttrd)as PamtTrrd, sum(samttrd)as SamtTrd, party_code,scrip_cd into #sumamt from #mainill(nolock)                                                    
group by scrip_cd,party_code                                                    
--drop table #sumamt                                                    
--select * from #sumamt                                                    
--------------------------------pl of amt ---------------------------------------------------------------                                                    
select PL=(SamtTrd-PamtTrrd),party_code,scrip_cd into #plILL from #sumamt(nolock)                                                    
--drop table #plILL                              
-----------------------------cal rate ----------------------------------------------                                                
select case when sum(PQtyTrd)=0.00 then sum(PAmtTrd)/(sum(PQtyTrd)+1)                                  
else sum(PAmtTrd)/(sum(PQtyTrd))  end as Buyrate,                                                    
case when sum(SQtyTrd)=0.00 then sum(SAmtTrd)/(sum(SQtyTrd)+1)                                     
else sum(SAmtTrd)/(sum(SQtyTrd)) end as Sellrate,party_code,scrip_cd into #tbl                                                    
from #ill1(nolock) group by scrip_cd,party_code                                            
----select * from #tbl1  where party_code='M888'                                      
----select *  from #tbl where party_code=''                                      
----select top 5 * from #ill1                                                    
----drop table #tbl2                                        
select sum(pqtytrd)pqtytrd,sum(pqtydel)pqtydel,sum(sqtytrd)sqtytrd,sum(sqtydel)sqtydel,scrip_cd,party_code                                      
into #tbl2 from #mainill group by scrip_cd, party_code                                 
                               
                                      
             
-------------------------cal rate diff---------------------------------------------------                                                    
select *,RateDiff=(Sellrate-Buyrate) into #tbl1 from #tbl(nolock)                                                    
--select * from #tbl1  where party_code='M888'                                      
--drop table #tbl1                                                    
--select top 5 * from #tbl1                                                    
-------------------------------cal stk prc variation % -------------------------------------------------                                                    
select stkPrcVariation=((sellrate-buyrate)/buyrate)*100,party_code,scrip_cd,Sellrate,Buyrate into #illstp                                                     
from #tbl1(nolock) where buyrate<>0.00 and sellrate<>0.00                                                    
--select top 5 * from #illstp                                                    
--drop table #illstp                                                    
-------------------------------take sum of script -----------------------------------------------------------                                                    
select sum(pqtytrd)Pqt,sum(pqtydel)PDqt,sum(sqtytrd)Sqt,sum(sqtydel)SDqt,scrip_cd,party_code                                                    
into #illturn from #mainill(nolock)                                                     
group by scrip_cd,party_code                                                    
--select top 5 * from #illturn                                               
--select * from #mainill                                              
--drop table #illturn                                                    
------------------------------cal turnover ---------------------------------------------------------                       
select *,sum(Pqt+pdqt+sqt+sdqt) as turnover into #turnover from #illturn(nolock)                                                     
group by scrip_cd,party_code,Pqt,pdqt,sqt,sdqt                                                    
--drop table #turnover                     
--select top 5 * from #turnover                                                    
----------------------------------chk particlr days trd volume ---------------------------------------------------                                            
--declare @segment as varchar(10)                                            
--set @segment='ACDLCM'                                     
--declare @date as varchar(11)                                           
--set @date = convert(datetime,'17/11/2009',103)                                    
                     
if @segment='ablcm'                                            
begin                                             
select party_code,scrip_cd,Turnover,TurnoverPerc=isnull(convert(decimal(14,2),convert(float,a.turnover)/b.no_of_shrs *100),0),                                            
sc_name,no_of_shrs into #illpercbse from                                                
(select * from #turnover(nolock))a                                                
left outer join                                                 
(select sc_code,Sc_name,no_of_shrs from intranet.misc.dbo.qe where pddate=@date)b                                    
on a.scrip_cd=b.sc_code                                                 
--select * from #illpercbse                                            
end                                            
if @segment='ACDLCM'                                          
begin                                                                                   
select party_code,scrip_cd,Turnover,TurnoverPerc=isnull(convert(decimal(14,2),convert(float,a.turnover)/b.net_trdqty*100),0),                                            
b.security,net_trdqty into #illpercnse from                                             
(select * from #turnover(nolock))a                                                
left outer join                                    
(select Symbol,Security,net_trdqty from intranet.misc.dbo.pd301203 where  pddate=@date)b                       
on a.scrip_cd=b.symbol                                              
--select * from #illpercnse                                            
end                                            
                                            
--drop table #illpercnse                                              
--select top 5 * from #illperc                                                    
--drop table #illperc                                                    
--------------------------final output ------------------------------------------------------                                                    
--declare @segment as varchar(10)                                            
--set @segment='ACDLCM'                                      
                                      
if @segment='ABLCM'                                            
begin                                            
select a.party_code,a.scrip_cd,a.sc_name,a.Turnover,isnull(no_of_shrs,0) as TotalNoOfShares,a.TurnoverPerC,                                            
b.Buyrate,b.Sellrate,c.stkprcvariation,d.PL,case when a.party_code=g.party_code then 'Online Client' else 'Offline Client' end as Status                          
 into #bse1                                                    
from                                                    
(select * from #illpercBse(nolock)) a                                                    
inner join                                                    
(select  * from #tbl1(nolock)) b                                                    
on a.party_code=b.party_code and a.scrip_cd=b.scrip_cd                                                     
inner join                                             
(select  * from #illstp(nolock)) c                                                    
on a.party_code=c.party_code and a.scrip_cd=c.scrip_cd                                                    
inner join                                      
(select * from #plILL(nolock))d                                                    
on a.party_code=d.party_code and a.scrip_cd=d.scrip_cd                             
left outer join                          
(select party_code from intranet.ctcl.dbo.ebrok_client with (nolock))g                          
on a.party_code=g.party_code                                      
-----                             
select f.*,e.pqtytrd,e.pqtydel,e.sqtytrd,e.sqtydel into #Illbse                                      
from                                       
(select * from #bse1(nolock))f                                      
inner join                                       
(select * from #tbl2(nolock))e                                      
on f.party_code=e.party_code and f.scrip_cd=e.scrip_cd                      

select * into #Illbse2 from #Illbse(nolock)                                    
where pl not between @pl1 and @pl or turnoverperc>=@IillMrktGrsPerc or stkprcvariation>=@Illstkpricvart                              
order by party_code,scrip_cd                                         

 Select        
  party_code='<a href=/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?val='+ ltrim(rtrim(party_code)) +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) +'&username='+ ltrim(rtrim(@username))+' target=_blank>'+   
ltrim(rtrim(party_code)) +'</a>'  
      ,sc_name AS Scrip,pqtytrd AS [Buy Qty Trd],sqtytrd AS [Sell Qty Trd],pqtydel AS[Buy Qty Del],sqtydel AS [Sell Qty Del ],Buyrate,Sellrate,PL AS [PL(Rs)],Turnover,TotalNoOfShares AS [Market Volume],TurnoverPerC AS [% To Mkt Vol],stkprcvariation AS [

Rate Difference %],Status               
   From #Illbse2(nolock)    
  order by party_code,scrip_cd   

end                                      
                                      
                                      
else if @segment='ACDLCM'                                            
begin                      
                                      
select a.party_code,a.scrip_cd,security,Turnover,isnull(net_trdqty,0) as TotalNoOfShares,TurnoverPerc,b.Buyrate,b.Sellrate,                                      
stkPrcVariation,PL,case when a.party_code=g.party_code then 'Online Client' else 'Offline Client' end as Status                                      
into #nse1                                      
 from                                      
(select party_code,scrip_cd,Turnover,TurnoverPerc,security,net_trdqty from #illpercnse(nolock))a                                      
inner join                                      
(select  Buyrate,Sellrate,party_code,scrip_cd,RateDiff from #tbl1(nolock)) b                   
on a.party_code=b.party_code and a.scrip_cd=b.scrip_cd                                       
inner join                                      
(select  stkPrcVariation,party_code,scrip_cd,Sellrate,Buyrate from #illstp(nolock)) c                                                    
on a.party_code=c.party_code and a.scrip_cd=c.scrip_cd                                        
inner join                                      
(select PL,party_code,scrip_cd from #plILL(nolock))d                                       
on a.party_code=d.party_code and a.scrip_cd=d.scrip_cd                               
left outer join                          
(select party_code from intranet.ctcl.dbo.ebrok_client with (nolock))g                          
on a.party_code=g.party_code                                   
---                                      
select f.*,e.pqtytrd,e.pqtydel,e.sqtytrd,e.sqtydel into #Illnse                                      
 from                                       
(select pqtytrd,pqtydel,sqtytrd,sqtydel,scrip_cd,party_code from #tbl2(nolock))e                                      
inner join                                      
(select * from #nse1)f                                      
on f.party_code=e.party_code and f.scrip_cd=e.scrip_cd 
                                       
select * into #Illnse2 from #Illnse(nolock)                                      
where pl not between @pl1 and @pl or turnoverperc>=@IillMrktGrsPerc or stkprcvariation>=@Illstkpricvart                  
order by party_code,scrip_cd                                      



select         
party_code='<a href=/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?val='+ ltrim(rtrim(party_code)) +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) +'&username='+ ltrim(rtrim(@username))+' target=_blank>'+   
ltrim(rtrim(party_code)) +'</a>'   
,scrip_cd AS Scrip,security As [SCRIP_NAME],pqtytrd AS [Buy Qty Trd],sqtytrd AS [Sell Qty Trd],pqtydel AS[Buy Qty Del],sqtydel AS [Sell Qty Del ],Buyrate,Sellrate,PL AS [PL(Rs)],Turnover,TotalNoOfShares AS [Market Volume],TurnoverPerC AS [% To Mkt Vol],
stkprcvariation AS [Rate Difference %],Status         
from #Illnse2 (nolock)      
order by party_code,scrip_cd  

end                                     
                                                         
                                    
-------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDS_IntradayInDelivery
-- --------------------------------------------------
    
      
      
      
CREATE PROC USP_FDS_IntradayInDelivery-- '27/12/2009','ACDLCM','95','ALL','STATIC','200','5','5'                                 
(                                 
@date        AS VARCHAR(11),                                 
@segment     AS VARCHAR(15),                                 
@perc        AS INT,                                 
@scrip       AS VARCHAR(15),          
@Flag      AS VARCHAR(15),          
@username varchar(25)=Null,                         
@access_to   As varchar(25),                                 
@access_code   As varchar(25)                    
)                                 
AS                              
SET NOCOUNT ON                          
  --declare @date as varchar(11),@date1 as varchar(11),@segment as varchar(15)                                       
  --set @date='23/11/2009'                                       
  --set @date1='23/11/2009'                                       
  --set @segment='ACDLCM'                                 
  DECLARE  @exchange  AS VARCHAR(5)                                 
                                   
--  DECLARE  @pl1  AS INT                                 
--                                   
--  SET @pl1 = @pl *- 1                                 
                                   
  IF @scrip = 'HOLDING'                                 
    BEGIN                                 
      IF @segment = 'ablcm'                                 
        BEGIN                                 
          SET @exchange = 'BSE'                                 
        END                                 
      ELSE                                 
        IF @segment = 'ACDLCM'                                 
          BEGIN                                 
            SET @exchange = 'NSE'                                 
          END                                 
                                       
      SELECT TOP 0 *                                 
      INTO   #holding                                 
      FROM   risk.dbo.holding  with (nolock)                                
                                       
      DECLARE  @table   AS VARCHAR(50),                                 
               @table1  AS VARCHAR(50),                                 
               @qry     AS VARCHAR(500),                                 
               @date1   AS VARCHAR(11)                                 
                                       
      SET @table = 'risk.dbo.holding'                                 
                                       
--      SET @date = '23/11/2009'                                 
                                       
      SET @date1 = @date                                 
                                       
      SET @table1 = @table + Replace(@date,'/','')                                 
                                       
      SET @qry = 'insert into #holding Select * from ' + @table1 + 'with (nolock)  where exchange=''' + @exchange + ''''                                 
                                       
      --print @qry                                 
      EXEC( @qry)                                 
                                       
    END                                 
                                   
  SET @date = Convert(DATETIME,@date,103)                                 
                                   
  SELECT *                                 
  INTO   #mis_to                                 
  FROM   mis_to (nolock)                                 
  WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180                                 
         AND sauda_date < @date                                 
         AND company = @segment                                 
                      
                                   
  ---------------To Calculate no of days total turnover & total del.turnover ------------                                 
  SELECT DISTINCT party_code,                                 
                  company,                                 
                  Sum(turnover)   turnover,                 
                  Sum(to_del_opt) AS delivery_turnover                                 
  INTO     #temp                                 
  FROM     #mis_to (nolock)                                 
  GROUP BY party_code,                                 
           company                                 
                        
  ---drop table #temp                                 
  --------------------to calculate count of days trade--------------                                 
  SELECT *                               
  INTO   #temp1                                 
  FROM   (SELECT   party_code,                                 
                   Count(* ) COUNT,                                 
                   company                                 
          FROM     (SELECT   DISTINCT sauda_date,                                 
                                      party_code,                                 
                                 cnt = Count(* ),                                 
                                      company                                 
                    FROM     #mis_to (nolock)                                 
        GROUP BY sauda_date,                                 
                             party_code,                                 
                             company) a                                 
          GROUP BY party_code,                                 
                   company) x                                 
                            
  --drop table #temp1                                 
  --------------------cal--------------------------------------------------                                 
  SELECT x.party_code,                                 
         x.company,                                 
         COUNT,                                 
         turnover,                                 
         delivery_turnover,                                 
         del_based_to = CASE                                 
                          WHEN (delivery_turnover = 0.00                                 
                                AND turnover = 0.00)                                 
                          THEN '0.00'                                 
                          WHEN delivery_turnover = 0.00                                 
                          THEN '0.00'                                 
                          ELSE (delivery_turnover / turnover) * 100                                 
                       END                                 
  INTO   #alert1                                 
  FROM   (SELECT *                                 
          FROM   #temp (nolock)) x                                 
         INNER JOIN (SELECT *                                 
                     FROM   #temp1 (nolock)) y                                 
           ON x.party_code = y.party_code                                 
                                   
                          
  ----------------------------------particular days data--------------------------------------------                                 
                      
  SELECT DISTINCT party_code,                                 
                  Sum(turnover)   turnover,                                 
                  sauda_date,                                 
                  Sum(to_del_opt) to_del_opt                                 
  INTO     #mist_todate                                 
  FROM     mis_to (nolock)                                 
  WHERE    sauda_date = Convert(DATETIME,@date,103)                                 
           AND company = @segment                                 
  GROUP BY party_code,                                 
           sauda_date,                                 
           company                           
                                   
  --drop table #mist_todate                                 
  -----------------------------------alert 2 Del Based Turnover-------------------------------------                                 
                  
  SELECT a.party_code,                                 
         b.del_based_to,                                 
         ERROR = 'Intraday in Delivery Client'                                 
  INTO   #alrt11                                 
  FROM   (SELECT *                        
          FROM   #mist_todate (nolock)                                 
          WHERE  to_del_opt = '0.00') a                                 
         INNER JOIN (SELECT DISTINCT party_code,                                 
                                     del_based_to                             
                     FROM   #alert1 (nolock)                                 
                     WHERE  del_based_to >= @perc) b                                 
           ON a.party_code = b.party_code                                 
                                   
                               
  SELECT TOP 0 party_code,                                 
               party_name,                                 
               scrip_cd,                                 
               scrip_name,                                 
               pqtytrd,                                 
               pamttrd,                                 
               pqtydel,                                 
               pamtdel,                                 
               sqtytrd,                                 
               samttrd,                                 
               sqtydel,                                 
               samtdel,                                 
               sauda_date                                 
  INTO   #main                                 
  FROM   anand1.msajag.dbo.cmbillvalan with (nolock)                                
                          
  ALTER TABLE #main                                 
  ALTER COLUMN party_name VARCHAR(100)                                 
                                   
  IF @segment = 'ABLCM'                                 
    BEGIN                                 
      INSERT INTO #main                                 
      SELECT party_code,                                 
             party_name,                                 
             scrip_cd,                                 
             scrip_name,                                 
             pqtytrd,                                 
             pamttrd,                             
             pqtydel,                                 
             pamtdel,                                 
             sqtytrd,                                 
             samttrd,                                 
             sqtydel,                                
             samtdel,                                 
             sauda_date                                 
      FROM   anand.bsedb_ab.dbo.cmbillvalan  with (nolock)                               
      WHERE  sauda_date = Convert(DATETIME,@date,103)                                 
    END                                 
  ELSE                                 
    IF @segment = 'ACDLCM'                                 
      BEGIN                                 
        INSERT INTO #main                                 
        SELECT party_code,                                 
               party_name,                                 
               scrip_cd,                                 
               scrip_name,                                 
               pqtytrd,                                 
               pamttrd,                                 
               pqtydel,                                 
               pamtdel,                                 
               sqtytrd,      
               samttrd,                                 
               sqtydel,                                 
 samtdel,                                 
               sauda_date                                 
        FROM   anand1.msajag.dbo.cmbillvalan  with (nolock)                               
        WHERE  sauda_date = Convert(DATETIME,@date,103)            
      END                   
                                   
  -----------------------------------------------------------------------------------------------                                 
  SELECT TOP 0 *                                 
  INTO   #main1                                 
  FROM   #main (nolock)                                 
                                   
  SELECT a.party_code,                   
         b.party_name,                                 
         b.scrip_cd,                                 
         b.scrip_name,                                 
         b.pqtytrd,                                 
         b.pamttrd,                                 
         b.pqtydel,                                 
         b.pamtdel,                                 
         b.sqtytrd,                                 
         b.samttrd,                   
         b.sqtydel,                                 
         b.samtdel,                                 
         b.sauda_date                                 
  INTO   #abv                                 
  FROM   (SELECT *                                 
          FROM   #alrt11 (nolock)) a                                 
         INNER JOIN (SELECT *                                 
                     FROM   #main (nolock)) b                                 
           ON a.party_code = b.party_code COLLATE latin1_general_ci_as                                 
                                   
                             
                                   
  IF @scrip = 'Ill'                                 
     AND @segment = 'ABLCM'                                 
    BEGIN                                 
      INSERT INTO #main1                                 
      SELECT DISTINCT a.party_code,                                 
                      a.party_name,                                 
                      a.scrip_cd,                                 
                      a.scrip_name,                             
                      a.pqtytrd,                                 
                      a.pamttrd,                                 
                      a.pqtydel,                                 
                      a.pamtdel,                                 
                      a.sqtytrd,                                 
                      a.samttrd,                                 
                      a.sqtydel,                                 
                      a.samtdel,                                 
                      a.sauda_date                           
      FROM   (SELECT *                                 
              FROM   #abv (nolock)) a                                 
             INNER JOIN (SELECT *                                 
                         FROM   intranet.risk.dbo.illscrip_bse_december with (nolock)) b                                 
               ON a.scrip_cd = b.scrip_cd                                 
    END                  
                
                
----------------------------------------------------------------------------------------------------------------                               
  ELSE                         
    IF @scrip = 'Ill'                                 
       AND @segment = 'ACDLCM'                                 
      BEGIN                                 
        INSERT INTO #main1                                 
        SELECT DISTINCT a.party_code,                                 
                        a.party_name,                                 
                        a.scrip_cd,                           
                        a.scrip_name,                                 
                        a.pqtytrd,                                 
                        a.pamttrd,                                 
                        a.pqtydel,                                 
                        a.pamtdel,                                 
                        a.sqtytrd,                                 
                        a.samttrd,          
               a.sqtydel,          
                        a.samtdel,                                 
                        a.sauda_date                                 
        FROM   (SELECT *                                 
                FROM   #abv (nolock)) a                                 
               INNER JOIN (SELECT *                                 
                           FROM  intranet.risk.dbo.illscrip_nse_december with (nolock)) b                                 
                 ON a.scrip_cd = b.scrip_cd         
      END                                 
    ELSE                                 
      IF @scrip = 'Holding'                                 
        BEGIN                           
          IF @exchange = 'BSE'                                 
            BEGIN                                 
              INSERT INTO #main1                                
              SELECT DISTINCT a.party_code,                                 
                              a.party_name,                                 
                              a.scrip_cd,                                 
           a.scrip_name,                                 
                              a.pqtytrd,                                 
                              a.pamttrd,                                 
                              a.pqtydel,                                 
                              a.pamtdel,                                 
                              a.sqtytrd,                                 
                              a.samttrd,                                 
                              a.sqtydel,                                 
                              a.samtdel,                                 
                              a.sauda_date                                 
              FROM   (SELECT *                                 
                      FROM   #abv (nolock)) a                                 
                     INNER JOIN (SELECT *                                 
                                 FROM   #holding) b                                 
                       ON a.scrip_cd = b.scrip_cd                                 
                          AND a.party_code = b.party_code COLLATE latin1_general_ci_as                                 
            END                                 
          ELSE                                 
            IF @exchange = 'NSE'                                 
              BEGIN                  
                INSERT INTO #main1                                 
                SELECT DISTINCT a.party_code,                                 
                                a.party_name,                                 
                                a.scrip_cd,                                 
        a.scrip_name,                                 
                                a.pqtytrd,                                 
                                a.pamttrd,                                 
                                a.pqtydel,                                 
                                a.pamtdel,                                 
                                a.sqtytrd,                                 
                            a.samttrd,                                 
                                a.sqtydel,                                 
                                a.samtdel,                                 
                                a.sauda_date                                 
                FROM   (SELECT *                                 
                        FROM   #abv (nolock)) a                                 
                       INNER JOIN (SELECT *                                 
                                   FROM   #holding) b                                 
                         ON a.scrip_cd = b.dummy1                                 
                            AND a.party_code = b.party_code COLLATE latin1_general_ci_as                                 
 END                                 
        END               
      ELSE                                 
        IF @scrip = 'All'                                 
          BEGIN                                 
            INSERT INTO #main1                                 
            SELECT *                                 
            FROM   #abv (nolock)                                 
          END                                 
                      
         --        CREATE NONCLUSTERED INDEX ix_#main1 ON #main1 (party_code)                         
  --drop table #abv                                       
  --select * from #main1                                       
----------------------------------------------------------------------------                                 
  SELECT Sum(pamttrd) AS pamttrrd,                                 
         Sum(samttrd) AS samttrd,                                 
         party_code,                                 
         scrip_cd                                 
  INTO     #sumamt                                 
  FROM     #main1 (nolock)                                 
  GROUP BY scrip_cd,                                 
           party_code                                 
                                   
  --drop table #sumamt                                        
  ----------------------------------------------------------------------------                                 
  SELECT pl = (samttrd - pamttrrd),                            
         party_code,                                 
         scrip_cd                                 
  INTO   #plill                                 
  FROM   #sumamt (nolock)                                 
                                   
  --drop table #plILL                                       
  --------------------------------------------------------------------------------                                 
  SELECT CASE                                 
           WHEN Sum(pqtytrd) = 0.00                                 
           THEN Sum(pamttrd) / (Sum(pqtytrd) + 1)                                
           ELSE Sum(pamttrd) / (Sum(pqtytrd))                                 
         END AS buyrate,                                 
         CASE                                 
           WHEN Sum(sqtytrd) = 0.00                                 
           THEN Sum(samttrd) / (Sum(sqtytrd) + 1)                                 
           ELSE Sum(samttrd) / (Sum(sqtytrd))                                 
         END AS sellrate,                                 
         party_code,                                 
         scrip_cd                                 
  INTO     #tbl                                 
  FROM     #main1 (nolock)                                 
  GROUP BY scrip_cd,                                 
           party_code                                 
                                   
  --drop table #tbl                                       
  ----------------------------------------------------------------------------                                 
  SELECT Sum(pqtytrd) pqtytrd,                                 
         Sum(pqtydel) pqtydel,              
         Sum(sqtytrd) sqtytrd,                                 
         Sum(sqtydel) sqtydel,                                 
         scrip_cd,                                 
         party_code        
  INTO     #tbl2                                 
  FROM     #main1                                 
  GROUP BY scrip_cd,                                 
           party_code                                 
                                   
  --drop table #tbl2                                       
  ------------------------------------------------------------------------------                                 
  SELECT *,                                 
         ratediff = (sellrate - buyrate)                                 
  INTO   #tbl1                                 
  FROM   #tbl (nolock)                                 
                                   
  --drop table #tbl1                                       
  -------------------------------------------------------------------------------------------                                 
  SELECT stkprcvariation = ((sellrate - buyrate) / buyrate) * 100,                                 
         party_code,                               
         scrip_cd,                                 
         sellrate,                                 
         buyrate                                 
  INTO   #main3                                 
  FROM   #tbl1 (nolock)                                 
  WHERE  buyrate <> 0.00                                 
         AND sellrate <> 0.00                                 
                                   
  --drop table #main3                                        
  ---------------------------------------------------------------------------                                 
  SELECT Sum(pqtytrd) pqt,                                 
         Sum(pqtydel) pdqt,                                 
         Sum(sqtytrd) sqt,                                 
         Sum(sqtydel) sdqt,                                 
         scrip_cd,                                 
         party_code                                 
  INTO     #turn                                 
  FROM     #main1 (nolock)                                 
  GROUP BY scrip_cd,                                 
           party_code                                 
                                   
  --drop table #turn                                       
  --------------------------------------------------------------------------------                                 
  SELECT *,                                 
         Sum(pqt + pdqt + sqt + sdqt) AS turnover                                 
  INTO     #turnover                                 
  FROM     #turn (nolock)                                 
  GROUP BY scrip_cd,                                 
           party_code,                                 
           pqt,                                 
           pdqt,                                 
           sqt,                                 
           sdqt                                 
                                   
  --drop table  #turnover                                       
  --------------------------------------------------------------------------                                       
  --drop table #percbse                                       
  --declare @segment as varchar(10)                                                     
  --set @segment='ABLCM'                                              
  --declare @date as varchar(11)                                                    
  --set @date = convert(datetime,'23/11/2009',103)                                  
          
 CREATE NONCLUSTERED INDEX ix_#turnover ON #turnover (scrip_cd)                                 
                                   
  IF @segment = 'ablcm'                                 
    BEGIN                                 
      SELECT party_code,                                 
             scrip_cd,                                 
             turnover,                                 
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.no_of_shrs * 100),                                
             sc_name,                                 
             no_of_shrs                                 
      INTO   #percbse                                 
      FROM   (SELECT *                                 
              FROM   #turnover (nolock)) a                                 
             LEFT OUTER JOIN (SELECT sc_code,                                 
                                     sc_name,                                 
    no_of_shrs                                 
                              FROM   intranet.misc.dbo.qe                                 
                              WHERE  pddate = @date) b                                 
               ON a.scrip_cd = b.sc_code                                 
    --select * from #illpercbse                                 
    END            
                                   
  IF @segment = 'ACDLCM'                                 
    BEGIN                                 
      SELECT party_code,                                 
             scrip_cd,                                 
             turnover,                                 
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.net_trdqty * 100),                                 
             b.security,                                 
             net_trdqty                                 
      INTO   #percnse                                 
      FROM   (SELECT *                                 
              FROM   #turnover (nolock)) a                                 
            LEFT OUTER JOIN (SELECT symbol,                                 
                                     security,                                 
               net_trdqty                                 
                              FROM   intranet.misc.dbo.pd301203 with(nolock)                                 
                              WHERE  pddate = @date) b                                 
               ON a.scrip_cd = b.symbol                                 
    --select * from #illpercnse                                 
    END                                 
                                   
  ------------------------------------------------------------------------------------                                       
  --drop table #bse1                                       
  --declare @pl1 as int                                        
  --set @pl1= @pl*-1                                                 
  --declare @segment as varchar(10)                                                     
  --set @segment='ABLCM'                                 
  IF @segment = 'ABLCM'                                 
    BEGIN                                 
      SELECT a.party_code,                                 
             a.scrip_cd,                                 
             a.sc_name,                                 
             a.turnover AS turnover,                                 
             no_of_shrs AS totalnoofshares,                                 
             a.turnoverperc,                                 
             b.buyrate,                                 
             b.sellrate,                                 
             c.stkprcvariation,                                 
             d.pl                                 
      INTO   #bse1                                 
      FROM   (SELECT *                                 
              FROM   #percbse (nolock)) a                                 
             INNER JOIN (SELECT *                                 
                         FROM   #tbl1 (nolock)) b                                 
               ON a.party_code = b.party_code                                 
                  AND a.scrip_cd = b.scrip_cd                                 
             INNER JOIN (SELECT *                                 
                         FROM   #main3 (nolock)) c        
               ON a.party_code = c.party_code                                 
                  AND a.scrip_cd = c.scrip_cd                                 
             INNER JOIN (SELECT *                                 
    FROM   #plill (nolock)) d                                 
               ON a.party_code = d.party_code                                 
                  AND a.scrip_cd = d.scrip_cd                                 
                                       
      -----                                 
      SELECT f.*,                                 
             e.pqtytrd,                                 
             e.pqtydel,                                 
             e.sqtytrd,                                 
             e.sqtydel                            
      INTO   #cashbse                                 
      FROM   (SELECT *                                 
        FROM   #bse1 (nolock)) f                                 
     INNER JOIN (SELECT *                                 
                         FROM   #tbl2 (nolock)) e                                 
               ON f.party_code = e.party_code                                 
                  AND f.scrip_cd = e.scrip_cd                                 
                                       
      SELECT   *,segment='BSE'                                 
      into #IntraBse                
  FROM     #cashbse (nolock)                                 
--      WHERE    pl NOT BETWEEN @pl1 AND @pl                                 
--                OR turnoverperc >= @MrktGrsPerc                                 
--                OR stkprcvariation >= @stkpricvart                          
      ORDER BY party_code,                                 
               scrip_cd                   
                
 --Select                 
 --PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))                 
 --+'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))                
 -- +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''                
 --+');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+                 
 --ltrim(rtrim(PARTY_CODE)) +'</a>'                
 --,scrip_cd,sc_name,turnover,totalnoofshares,turnoverperc,buyrate,sellrate,stkprcvariation,pl,pqtytrd,pqtydel,sqtytrd,sqtydel,segment                
 -- from #IntraBse                
            
  if(@Flag='static')          
  begin          
    SELECT A.*,CASE WHEN A.PARTY_CODE=G.PARTY_CODE THEN 'ONLINE CLIENT' ELSE 'OFFLINE CLIENT' END AS CLIENTSTATUS                    
 from #IntraBse A          
 LEFT OUTER JOIN              
 (SELECT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT WITH (NOLOCK))G              
 ON A.PARTY_CODE=G.PARTY_CODE          
  END          
  ELSE          
  BEGIN          
 Select                 
 PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))                 
 +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))              
 +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''                
 +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+                 
 ltrim(rtrim(PARTY_CODE)) +'</a>'                
 ,scrip_cd,sc_name,turnover,totalnoofshares as [Market Volume],turnoverperc as [%TO Mkt vOl],buyrate,sellrate,stkprcvariation as [Rate Diff%]        
 ,pl,pqtytrd as [Buy Qty Trd],pqtydel as [Buy Qty Del],sqtytrd as [Sell Qty Trd],sqtydel as [Sell Qty Del],segment                
 from #IntraBse            
          
  END          
                              
    END        
---------------------------------------------------------------------------------------------------------------                            
  ELSE                                 
    IF @segment = 'ACDLCM'                                 
      BEGIN                                 
        SELECT a.party_code,                                 
               a.scrip_cd,                                 
               security,                                 
               turnover   AS turnover,                                 
               net_trdqty AS totalnoofshares,                                 
               turnoverperc,                       
               b.buyrate,                                 
               b.sellrate,                                 
               stkprcvariation,                                 
               pl                                 
        INTO   #nse1                                 
        FROM   (SELECT party_code,                                 
              scrip_cd,                                 
                       turnover,                                 
                       turnoverperc,                                 
                       security,                                 
                       net_trdqty                                 
                FROM   #percnse (nolock)) a                                 
               INNER JOIN (SELECT buyrate,                                 
                                  sellrate,                                 
                                  party_code,                                 
                                  scrip_cd,                                 
                                  ratediff                                 
  FROM   #tbl1 (nolock)) b                                 
                 ON a.party_code = b.party_code                                 
                    AND a.scrip_cd = b.scrip_cd                                 
               INNER JOIN (SELECT stkprcvariation,                                 
                                  party_code,                                 
                                  scrip_cd,                
                                  sellrate,                                 
                                  buyrate                                 
                           FROM   #main3 (nolock)) c                                 
                 ON a.party_code = c.party_code                                
                    AND a.scrip_cd = c.scrip_cd                                 
               INNER JOIN (SELECT pl,                                 
                                  party_code,                                 
                                  scrip_cd                                 
                           FROM   #plill (nolock)) d                                 
                 ON a.party_code = d.party_code                                 
                    AND a.scrip_cd = d.scrip_cd                                 
               
        ---                                 
        SELECT f.*,                                 
               e.pqtytrd,                                 
               e.pqtydel,                                 
               e.sqtytrd,                                 
               e.sqtydel                                 
        INTO   #cashnse                                 
        FROM   (SELECT pqtytrd,                                 
                       pqtydel,              
                       sqtytrd,                                 
                       sqtydel,                                 
   scrip_cd,                                 
                       party_code                                 
                FROM   #tbl2 (nolock)) e                                 
               INNER JOIN (SELECT *                                 
        FROM   #nse1 (nolock)) f                                 
                 ON f.party_code = e.party_code                                 
                    AND f.scrip_cd = e.scrip_cd                                 
                                         
        SELECT   *,segment='NSE'                                 
       into #IntraNse FROM     #cashnse (nolock)                                 
--        WHERE    pl NOT BETWEEN @pl1 AND @pl                                 
--                 OR turnoverperc >= @MrktGrsPerc                                 
--                  OR stkprcvariation >= @stkpricvart                                 
        ORDER BY party_code,                                 
         scrip_cd                
                
                
                
 -- SELECT                 
 -- PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))                 
 --+'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))                
 -- +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''                
 --+');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+                 
 --ltrim(rtrim(PARTY_CODE)) +'</a>'                
 -- ,scrip_cd,security,turnover,totalnoofshares,turnoverperc,buyrate,sellrate,stkprcvariation,pl,pqtytrd,pqtydel,sqtytrd,sqtydel,segment                
 -- FROM #IntraNse                 
           
           
  if(@Flag='static')          
  begin          
    SELECT A.*,CASE WHEN A.PARTY_CODE=G.PARTY_CODE THEN 'ONLINE CLIENT' ELSE 'OFFLINE CLIENT' END AS CLIENTSTATUS                    
 from #IntraNse  A          
 LEFT OUTER JOIN              
 (SELECT PARTY_CODE FROM CTCL.DBO.EBROK_CLIENT WITH (NOLOCK))G              
 ON A.PARTY_CODE=G.PARTY_CODE          
  END          
  ELSE          
  BEGIN          
     SELECT                 
  PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))                 
  +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))                
  +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''          
  +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+                 
  ltrim(rtrim(PARTY_CODE)) +'</a>'                
  ,scrip_cd,security,turnover,totalnoofshares as [Market Volume],turnoverperc as [%TO Mkt vOl]        
  ,buyrate,sellrate,stkprcvariation as [Rate Diff%]        
  ,pl,pqtytrd as [Buy Qty Trd],pqtydel as [Buy Qty Del],sqtytrd as [Sell Qty Trd],sqtydel as [Sell Qty Del],segment                
  FROM #IntraNse                 
          
  END                  
END                                 
      ---------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDS_INTRADAYINDELIVERY_DATEWISE
-- --------------------------------------------------

  
  

 
/**********************************************************************************                      
CREATED BY: RAJENDRA VERMA                      
DATE: 14/01/2010                      
PURPOSE:THIS PROCEDURE GIVES INTRADAYINDELIVERY REPORTS DATEWISE              
MODIFIED BY: PROGRAMMER NAME                      
DATED: DD/MM/YYYY                      
REASON: REASON TO CHANGE STORE PROCEDURE                      
**********************************************************************************/     
  
CREATE PROC USP_FDS_INTRADAYINDELIVERY_DATEWISE --'12/12/2009','ACDLCM','95','ALL','','','','',''                             
(                             
	@date        AS VARCHAR(11),                             
	@segment     AS VARCHAR(15),                             
	@perc        AS INT,                             
	@scrip       AS VARCHAR(15),            
	@CODE		 VARCHAR(25),		/*************CODE VALUE DEPENDS ON CODETYPE**************************/
	@CODETYPE	 VARCHAR(25),   	/*************CODETYPE ALL(ALL),C(CLIENTCODE) AND S(SCRIPCODE)********/                     
	@username	 VARCHAR(25)=NULL,                            
	@access_to	 VARCHAR(25)=NULL,                            
	@access_code VARCHAR(25)=NULL            
)                             
AS                          
SET NOCOUNT ON                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                               
  DECLARE  @exchange  AS VARCHAR(5)                             
                                                             
  IF @scrip = 'HOLDING'                             
    BEGIN                             
      IF @segment = 'ablcm'                             
        BEGIN                             
          SET @exchange = 'BSE'                             
        END                             
      ELSE                             
        IF @segment = 'ACDLCM'                             
          BEGIN                             
            SET @exchange = 'NSE'                             
          END                             
                                   
      SELECT TOP 0 *                             
      INTO   #holding                             
      FROM   intranet.risk.dbo.holding23112009 with (nolock)                            
                                   
      DECLARE  @table   AS VARCHAR(50),                             
               @table1  AS VARCHAR(50),                             
               @qry     AS VARCHAR(500),                             
               @date1   AS VARCHAR(11)                             
                                   
      SET @table = 'intranet.risk.dbo.holding'                             
                                                                     
      SET @date1 = @date                             
                                   
      SET @table1 = @table + Replace(@date,'/','')                             
                                   
      SET @qry = 'insert into #holding Select * from ' + @table1 + 'with (nolock)  where exchange=''' + @exchange + ''''                             
                              
      EXEC( @qry)                             
                                   
    END                             
                               
  SET @date = Convert(DATETIME,@date,103)                             
                               
  SELECT *                             
  INTO   #mis_to                             
  FROM   mis_to (nolock)                             
  WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180                             
         AND sauda_date < @date                             
         AND company = @segment                             
                  
                               
  ---------------To Calculate no of days total turnover & total del.turnover ------------                             
  SELECT DISTINCT party_code,                             
                  company,                             
                  Sum(turnover)   turnover,                             
                  Sum(to_del_opt) AS delivery_turnover                             
  INTO     #temp                             
  FROM     #mis_to (nolock)                             
  GROUP BY party_code,                             
           company                             
                    
  --------------------to calculate count of days trade--------------                             
  SELECT *                           
  INTO   #temp1                             
  FROM   (SELECT   party_code,                             
                   Count(* ) COUNT,                             
                   company                             
          FROM     (SELECT   DISTINCT sauda_date,                             
                                      party_code,                             
                                 cnt = Count(* ),                             
                                      company                             
                    FROM     #mis_to (nolock)                             
        GROUP BY sauda_date,                             
                             party_code,                             
                             company) a                             
          GROUP BY party_code,                             
                   company) x                             
                      
  --------------------cal--------------------------------------------------                             
  SELECT x.party_code,                             
         x.company,                             
         COUNT,                             
         turnover,                             
         delivery_turnover,                             
         del_based_to = CASE                             
                          WHEN (delivery_turnover = 0.00                             
                                AND turnover = 0.00)                             
                          THEN '0.00'                             
                          WHEN delivery_turnover = 0.00                             
                          THEN '0.00'                             
                          ELSE (delivery_turnover / turnover) * 100                             
                       END                             
  INTO   #alert1                             
  FROM   (SELECT *                             
          FROM   #temp (nolock)) x                             
         INNER JOIN (SELECT *                             
                     FROM   #temp1 (nolock)) y                             
           ON x.party_code = y.party_code                             
                               
                      
  ----------------------------------particular days data--------------------------------------------                             
                  
  SELECT DISTINCT party_code,                             
                  Sum(turnover)   turnover,                             
                  sauda_date,                             
                  Sum(to_del_opt) to_del_opt                             
  INTO     #mist_todate                             
  FROM     mis_to (nolock)                             
  WHERE    sauda_date = Convert(DATETIME,@date,103)                             
           AND company = @segment                             
  GROUP BY party_code,                             
           sauda_date,                             
           company                             
                          
  -----------------------------------alert 2 Del Based Turnover-------------------------------------                             
                               
  SELECT a.party_code,                             
         b.del_based_to,                             
         ERROR = 'Intraday in Delivery Client'                             
  INTO   #alrt11                             
  FROM   (SELECT *                    
          FROM   #mist_todate (nolock)                             
          WHERE  to_del_opt = '0.00') a                             
         INNER JOIN (SELECT DISTINCT party_code,                             
                                     del_based_to                         
                     FROM   #alert1 (nolock)                             
                     WHERE  del_based_to >= @perc) b                             
           ON a.party_code = b.party_code                             
                               
                           
  SELECT TOP 0 party_code,                             
               party_name,                             
               scrip_cd,                             
               scrip_name,                             
               pqtytrd,                             
               pamttrd,                             
               pqtydel,                             
               pamtdel,                             
               sqtytrd,                             
               samttrd,                             
               sqtydel,                             
               samtdel,                             
               sauda_date                             
  INTO   #main                             
  FROM   anand1.msajag.dbo.cmbillvalan with (nolock)                            
                      
  ALTER TABLE #main                             
  ALTER COLUMN party_name VARCHAR(100)                             
                               
  IF @segment = 'ABLCM'                             
    BEGIN                             
      INSERT INTO #main                             
      SELECT party_code,                             
             party_name,                             
             scrip_cd,                             
             scrip_name,                             
             pqtytrd,                             
             pamttrd,                         
             pqtydel,                             
             pamtdel,                             
             sqtytrd,                             
             samttrd,                             
             sqtydel,                            
             samtdel,                             
             sauda_date                             
      FROM   anand.bsedb_ab.dbo.cmbillvalan  with (nolock)                           
      WHERE  sauda_date = Convert(DATETIME,@date,103)                             
    END                             
  ELSE                             
    IF @segment = 'ACDLCM'                             
      BEGIN                             
        INSERT INTO #main                             
        SELECT party_code,                             
               party_name,                             
               scrip_cd,                             
               scrip_name,                             
               pqtytrd,                             
               pamttrd,                             
               pqtydel,                             
               pamtdel,                             
               sqtytrd,                             
               samttrd,                             
               sqtydel,                             
 samtdel,                             
               sauda_date                             
        FROM   anand1.msajag.dbo.cmbillvalan  with (nolock)                           
        WHERE  sauda_date = Convert(DATETIME,@date,103)                             
      END                             
                               
  -----------------------------------------------------------------------------------------------                             
  SELECT TOP 0 *                             
  INTO   #main1                             
  FROM   #main (nolock)                             
                               
  SELECT a.party_code,               
         b.party_name,                             
         b.scrip_cd,                             
         b.scrip_name,                             
         b.pqtytrd,                             
         b.pamttrd,                             
         b.pqtydel,                             
         b.pamtdel,                             
         b.sqtytrd,                             
         b.samttrd,               
         b.sqtydel,                             
         b.samtdel,                             
         b.sauda_date                             
  INTO   #abv                             
  FROM   (SELECT *                             
          FROM   #alrt11 (nolock)) a                             
         INNER JOIN (SELECT *                             
                     FROM   #main (nolock)) b                             
           ON a.party_code = b.party_code COLLATE latin1_general_ci_as                             
                               
                         
                               
  IF @scrip = 'Ill'                             
     AND @segment = 'ABLCM'                             
    BEGIN                             
      INSERT INTO #main1                             
      SELECT DISTINCT a.party_code,                             
                      a.party_name,                             
                      a.scrip_cd,                             
                      a.scrip_name,                         
                      a.pqtytrd,                             
                      a.pamttrd,                             
                      a.pqtydel,                             
                      a.pamtdel,                             
                      a.sqtytrd,                             
                      a.samttrd,                             
                      a.sqtydel,                             
                      a.samtdel,                             
                      a.sauda_date                       
      FROM   (SELECT *                             
              FROM   #abv (nolock)) a                             
             INNER JOIN (SELECT *                             
                         FROM   intranet.misc.dbo.illscrip with (nolock)) b                             
               ON a.scrip_cd = b.scrip_cd                             
    END              
            
            
----------------------------------------------------------------------------------------------------------------                           
  ELSE                     
    IF @scrip = 'Ill'                             
       AND @segment = 'ACDLCM'                             
      BEGIN                             
        INSERT INTO #main1                             
        SELECT DISTINCT a.party_code,                             
                        a.party_name,                             
                        a.scrip_cd,                             
                        a.scrip_name,                             
                        a.pqtytrd,                             
                        a.pamttrd,                             
                        a.pqtydel,                             
                        a.pamtdel,                             
                        a.sqtytrd,     
                        a.samttrd,                             
               a.sqtydel,                             
                        a.samtdel,                             
                        a.sauda_date                             
        FROM   (SELECT *                             
                FROM   #abv (nolock)) a                             
               INNER JOIN (SELECT *                             
                           FROM   intranet.misc.dbo.illscrip_nse with (nolock)) b                             
                 ON a.scrip_cd = b.scrip_cd     
      END                             
    ELSE                             
      IF @scrip = 'Holding'                             
        BEGIN                       
          IF @exchange = 'BSE'                             
            BEGIN                             
              INSERT INTO #main1                            
              SELECT DISTINCT a.party_code,                             
                              a.party_name,                             
                              a.scrip_cd,                             
           a.scrip_name,                             
                              a.pqtytrd,                             
                              a.pamttrd,                             
                              a.pqtydel,                             
                              a.pamtdel,                             
                              a.sqtytrd,                             
                              a.samttrd,                             
                              a.sqtydel,                             
                              a.samtdel,                             
                              a.sauda_date                             
              FROM   (SELECT *                             
                      FROM   #abv (nolock)) a                             
                     INNER JOIN (SELECT *                             
                                 FROM   #holding) b                             
                       ON a.scrip_cd = b.scrip_cd                             
                          AND a.party_code = b.party_code COLLATE latin1_general_ci_as                             
            END                             
          ELSE                             
            IF @exchange = 'NSE'                             
              BEGIN              
                INSERT INTO #main1                             
                SELECT DISTINCT a.party_code,                             
                                a.party_name,                             
                                a.scrip_cd,                             
								a.scrip_name,                             
                                a.pqtytrd,                             
                                a.pamttrd,                             
                                a.pqtydel,                             
                                a.pamtdel,                             
                                a.sqtytrd,                             
								a.samttrd,                             
                                a.sqtydel,                             
                                a.samtdel,                             
                                a.sauda_date                             
                FROM   (SELECT *                             
                        FROM   #abv (nolock)) a                             
                       INNER JOIN (SELECT *                             
                                   FROM   #holding) b                             
                         ON a.scrip_cd = b.dummy1                             
                            AND a.party_code = b.party_code COLLATE latin1_general_ci_as                          
          END                             
        END                             
      ELSE                             
        IF @scrip = 'All'                             
          BEGIN                             
            INSERT INTO #main1                             
            SELECT *                             
            FROM   #abv (nolock)                             
          END                             
                  
----------------------------------------------------------------------------                             
  SELECT Sum(pamttrd) AS pamttrrd,                             
         Sum(samttrd) AS samttrd,                             
         party_code,                             
         scrip_cd                             
  INTO     #sumamt                             
  FROM     #main1 (nolock)                             
  GROUP BY scrip_cd,                             
           party_code                             
                               
  ----------------------------------------------------------------------------                             
  SELECT pl = (samttrd - pamttrrd),                        
         party_code,                             
         scrip_cd                             
  INTO   #plill                             
  FROM   #sumamt (nolock)                             
                               
  --drop table #plILL                                   
  --------------------------------------------------------------------------------                             
  SELECT CASE                             
           WHEN Sum(pqtytrd) = 0.00                             
           THEN Sum(pamttrd) / (Sum(pqtytrd) + 1)                            
           ELSE Sum(pamttrd) / (Sum(pqtytrd))                             
         END AS buyrate,                             
         CASE                             
           WHEN Sum(sqtytrd) = 0.00                             
           THEN Sum(samttrd) / (Sum(sqtytrd) + 1)                             
           ELSE Sum(samttrd) / (Sum(sqtytrd))                             
         END AS sellrate,                             
         party_code,                             
         scrip_cd                             
  INTO     #tbl                             
  FROM     #main1 (nolock)                             
  GROUP BY scrip_cd,                             
           party_code                             
                               
  ----------------------------------------------------------------------------                             
  SELECT Sum(pqtytrd) pqtytrd,                             
         Sum(pqtydel) pqtydel,          
         Sum(sqtytrd) sqtytrd,                             
         Sum(sqtydel) sqtydel,                             
         scrip_cd,                             
         party_code                             
  INTO     #tbl2                             
  FROM     #main1                             
  GROUP BY scrip_cd,                             
           party_code                             
                               
  ------------------------------------------------------------------------------                             
  SELECT *,                             
         ratediff = (sellrate - buyrate)                             
  INTO   #tbl1                             
  FROM   #tbl (nolock)                             
                               
  -------------------------------------------------------------------------------------------                             
  SELECT stkprcvariation = ((sellrate - buyrate) / buyrate) * 100,                             
         party_code,                           
         scrip_cd,                             
         sellrate,             
         buyrate                             
  INTO   #main3                             
  FROM   #tbl1 (nolock)                             
  WHERE  buyrate <> 0.00                             
         AND sellrate <> 0.00                             
                               
  ---------------------------------------------------------------------------                             
  SELECT Sum(pqtytrd) pqt,                             
         Sum(pqtydel) pdqt,                             
         Sum(sqtytrd) sqt,                             
         Sum(sqtydel) sdqt,                             
         scrip_cd,                             
         party_code                             
  INTO     #turn                             
  FROM     #main1 (nolock)                             
  GROUP BY scrip_cd,                             
           party_code                             
                               
  --------------------------------------------------------------------------------                             
  SELECT *,                             
         Sum(pqt + pdqt + sqt + sdqt) AS turnover                             
  INTO     #turnover                             
  FROM     #turn (nolock)                             
  GROUP BY scrip_cd,                             
           party_code,                             
           pqt,                             
           pdqt,                             
           sqt,                             
           sdqt                             
                               
  --------------------------------------------------------------------------                                   

 CREATE NONCLUSTERED INDEX ix_#turnover ON #turnover (scrip_cd)                             
                               
  IF @segment = 'ablcm'                             
    BEGIN                             
      SELECT party_code,                             
             scrip_cd,                             
             turnover,                             
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.no_of_shrs * 100),                             
             sc_name,                             
             no_of_shrs                             
      INTO   #percbse                             
      FROM   (SELECT *                             
              FROM   #turnover (nolock)) a                             
             LEFT OUTER JOIN (SELECT sc_code,                             
                                     sc_name,                             
    no_of_shrs                             
                              FROM   intranet.misc.dbo.qe                             
                              WHERE  pddate = @date) b                             
               ON a.scrip_cd = b.sc_code                             
    --select * from #illpercbse                             
    END                             
                               
  IF @segment = 'ACDLCM'                             
    BEGIN                             
      SELECT party_code,                             
             scrip_cd,                             
             turnover,                             
             turnoverperc = Convert(DECIMAL(14,2),Convert(FLOAT,a.turnover) / b.net_trdqty * 100),                             
             b.security,                             
             net_trdqty                             
      INTO   #percnse                             
      FROM   (SELECT *                             
              FROM   #turnover (nolock)) a                             
            LEFT OUTER JOIN (SELECT symbol,                             
                                     security,                             
               net_trdqty            
                              FROM   intranet.misc.dbo.pd301203 with(nolock)                             
                              WHERE  pddate = @date) b                             
               ON a.scrip_cd = b.symbol                             
    --select * from #illpercnse                             
    END                             
                               
  ------------------------------------------------------------------------------------                                   
  --drop table #bse1                                   
  --declare @pl1 as int                                    
  --set @pl1= @pl*-1                                             
  --declare @segment as varchar(10)                                                 
  --set @segment='ABLCM'                             
  IF @segment = 'ABLCM'                             
    BEGIN                             
      SELECT a.party_code,                             
             a.scrip_cd,                             
             a.sc_name,                             
             a.turnover AS turnover,                             
             no_of_shrs AS totalnoofshares,                             
             a.turnoverperc,                             
             b.buyrate,                             
             b.sellrate,                             
             c.stkprcvariation,                             
             d.pl                             
      INTO   #bse1                             
      FROM   (SELECT *                             
              FROM   #percbse (nolock)) a                             
             INNER JOIN (SELECT *                             
                         FROM   #tbl1 (nolock)) b                             
               ON a.party_code = b.party_code                             
                  AND a.scrip_cd = b.scrip_cd                             
             INNER JOIN (SELECT *                             
                         FROM   #main3 (nolock)) c                             
               ON a.party_code = c.party_code                             
                  AND a.scrip_cd = c.scrip_cd                             
             INNER JOIN (SELECT *                             
						 FROM   #plill (nolock)) d                             
               ON a.party_code = d.party_code                             
                  AND a.scrip_cd = d.scrip_cd                             
                                   
      -----                             
      SELECT f.*,                             
             e.pqtytrd,                             
             e.pqtydel,                             
             e.sqtytrd,                             
             e.sqtydel                        
      INTO   #cashbse                             
      FROM   (SELECT *                             
              FROM   #bse1 (nolock)) f                             
             INNER JOIN (SELECT *                             
                         FROM   #tbl2 (nolock)) e                             
               ON f.party_code = e.party_code                             
                  AND f.scrip_cd = e.scrip_cd                             
                                   
      SELECT   *,segment='BSE'                             
      into #IntraBse            
	  FROM  #cashbse (nolock)                                               
      ORDER BY party_code,                             
               scrip_cd                         
             
	 Select             
	 PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))             
		 +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))          
		 +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''            
		 +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+             
		 ltrim(rtrim(PARTY_CODE)) +'</a>'            
	 ,scrip_cd,sc_name,turnover,totalnoofshares as [Market Volume],turnoverperc as [%TO Mkt vOl],buyrate,sellrate,stkprcvariation as [Rate Diff%]    
	 ,pl,pqtytrd as [Buy Qty Trd],pqtydel as [Buy Qty Del],sqtytrd as [Sell Qty Trd],sqtydel as [Sell Qty Del],segment            
	 from #IntraBse             
                          
    END                 
---------------------------------------------------------------------------------------------------------------                        
  ELSE                             
    IF @segment = 'ACDLCM'                             
      BEGIN                             
        SELECT a.party_code,                             
               a.scrip_cd,                             
               security,                             
               turnover   AS turnover,                             
               net_trdqty AS totalnoofshares,                             
               turnoverperc,                   
               b.buyrate,                             
               b.sellrate,                             
               stkprcvariation,                             
               pl                             
        INTO   #nse1                             
        FROM   (SELECT party_code,                             
                       scrip_cd,                             
                       turnover,                             
                       turnoverperc,                             
                       security,                             
                       net_trdqty                             
                FROM   #percnse (nolock)) a                             
               INNER JOIN (SELECT buyrate,                             
                                  sellrate,                             
                                  party_code,                             
                                  scrip_cd,                             
                                  ratediff                             
							FROM   #tbl1 (nolock)) b                             
				ON a.party_code = b.party_code                             
				   AND a.scrip_cd = b.scrip_cd                             
               INNER JOIN (SELECT stkprcvariation,                             
                                  party_code,                             
                                  scrip_cd,            
                                  sellrate,                             
                                  buyrate                             
                           FROM   #main3 (nolock)) c                             
                 ON a.party_code = c.party_code                            
                    AND a.scrip_cd = c.scrip_cd                             
               INNER JOIN (SELECT pl,                             
                                  party_code,                             
                                  scrip_cd                             
                           FROM   #plill (nolock)) d                             
                 ON a.party_code = d.party_code                             
                    AND a.scrip_cd = d.scrip_cd                             
           
        ---                             
        SELECT f.*,                             
               e.pqtytrd,                             
               e.pqtydel,                             
               e.sqtytrd,                             
               e.sqtydel                             
        INTO  #cashnse                             
        FROM   (SELECT pqtytrd,                             
                       pqtydel,          
                       sqtytrd,                             
                       sqtydel,                             
   scrip_cd,                             
                       party_code                             
                FROM   #tbl2 (nolock)) e                             
               INNER JOIN (SELECT *                             
                           FROM   #nse1 (nolock)) f                             
                 ON f.party_code = e.party_code                             
                    AND f.scrip_cd = e.scrip_cd                             
                                     
        SELECT   *,segment='NSE'                             
       into #IntraNse FROM     #cashnse (nolock)                                                       
        ORDER BY party_code,                             
         scrip_cd            
                        
  
  SELECT             
  PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))             
	  +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))            
	  +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''      
	  +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+             
	  ltrim(rtrim(PARTY_CODE)) +'</a>'            
  ,scrip_cd,security,turnover,totalnoofshares as [Market Volume],turnoverperc as [%TO Mkt vOl]    
  ,buyrate,sellrate,stkprcvariation as [Rate Diff%]    
  ,pl,pqtytrd as [Buy Qty Trd],pqtydel as [Buy Qty Del],sqtytrd as [Sell Qty Trd],sqtydel as [Sell Qty Del],segment            
  FROM #IntraNse             
             
END                             
      ---------------------------------------------------end-------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDS_INTRDAY_NSEFO_DATEWISE
-- --------------------------------------------------

CREATE proc USP_FDS_INTRDAY_NSEFO_DATEWISE --'23/09/2010','All',100,'STATIC','E32755','broker','CSO'                                 
(                                
@date as varchar(11),                                
@Type as varchar(11),                            
@perc AS INT,    
@Flag varchar(25),            
@username varchar(25)=Null,         
@access_to   As varchar(25),                
@access_code   As varchar(25)                 
)                                
as                               
    Set Nocount On                        
/*                            
                            
declare @date as varchar(11),                            
@perc AS INT ,                            
@Type as varchar(11)                             
set @date = '15/04/2010'                            
set @perc = 100                            
set @Type = 'XYZ'                            
                            
*/                            
                            
create table #Fo_Data_New                                
(                                
s_party_code  varchar(20),                              
s_inst_type varchar(25),                              
s_symbol varchar(25),                              
s_expirydate datetime,                                
s_strike_price money,                              
s_user_id varchar(25),                                
s_sell_buy int,                              
s_Sell_trdqty int ,                              
s_Sell_price money,                              
s_Sell_Amt money,                              
b_party_code  varchar(20),                              
b_inst_type varchar(25),                              
b_symbol varchar(25),                              
b_expirydate datetime,                                
b_strike_price money,                              
b_user_id varchar(25),                                
b_sell_buy int,                              
b_Sell_trdqty int ,                              
b_Sell_price money,                              
b_Sell_Amt money                            
)                                
                              
                              
declare @maxdate as varchar(25)                                
set @maxdate = (select convert(datetime,max(expirydate),103)+'23:59:59.000' from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock))                                
                              
                              
/*----------------------------If starts------------------------------------------*/                              
if convert(datetime,@date,103)+ '23:59:59.000' = getdate()+'23:59:59.000'                                
begin                               
insert into #Fo_Data_New                                
select * from                                
(                              
select                               
clientaccount_no as party_code,                              
inst_type,                              
symbol,convert(datetime,                              
expiry_date,103) as expiry_date,                              
strike_price,                              
user_id,                              
buy_sell,                              
sum(trade_qty) as S_TrdQty,                              
price,                              
sum((trade_qty*PRICE)) AS SellAMOUNT                               
                              
from [196.1.115.227].general.dbo.nsefodata with(nolock) where buy_sell = '1' group by clientaccount_no,inst_type,                              
symbol,expiry_date,strike_price,user_id,buy_sell,price                              
)a                              
left outer join                              
(                              
select                               
clientaccount_no,                              
inst_type,                              
symbol,                              
convert(datetime,expiry_date,103) as expiry_date,               
strike_price,                              
user_id,                              
buy_sell,                              
sum(trade_qty) as buytrdqty,                              
price,                              
sum((trade_qty*PRICE)) AS BuyAMOUNT                               
from [196.1.115.227].general.dbo.nsefodata with(nolock) where buy_sell = '2'                              
group by clientaccount_no,inst_type,                              
symbol,expiry_date,strike_price,user_id,buy_sell,price                              
)b                              
on a.party_code=b.clientaccount_no                             
and a.symbol=b.symbol                               
and a.inst_type=b.inst_type                                  
and a.expiry_date=b.expiry_date                               
where a.party_code is not null and b.clientaccount_no is not null                               
end                              
/*--------------------------------End Of If and Else If Begins ----------------------------------------------*/                              
else if convert(datetime,@date,103)+'23:59:59.000' > @maxdate                               
begin                              
                            
insert into #Fo_Data_New                              
select *                     
from                               
(                              
select                               
party_code as Code,                              
inst_type as InstType,                              
symbol as S_Symbol,                              
expirydate as S_expirydate,                              
strike_price as S_strike_price,                 
[user_id] as S_user_id,                                
sell_buy as S_sell_buy,                              
sum(tradeqty) as S_tradeqty ,                              
price  as S_price,                              
sum(amount) as S_amount                               
from ANGELFO.nsefo.dbo.Fosettlement with(nolock)                              
where  sell_buy='1' and sauda_date >= convert(datetime,@date,103) and                                 
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'  group by                               
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy,sauda_date                              
)a                              
left outer join                              
(                              
select                               
party_code,                              
inst_type,                              
symbol,                              
expirydate,                          
strike_price,                              
[user_id],                                
sell_buy,                              
sum(tradeqty) as tradeqty,                              
price ,                              
sum(amount) as amount                               
from ANGELFO.nsefo.dbo.Fosettlement with(nolock)                              
where  sell_buy='2' and sauda_date >= convert(datetime,@date,103) and                                 
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                                
group by                               
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy,sauda_date                              
)b                              
on a.Code=b.party_code                               
and a.S_Symbol=b.symbol                               
and a.InstType=b.inst_type                                  
and a.S_expirydate=b.expirydate where a.code is not null and b.party_code is not null                               
end                              
/*--------------------------------------End Of Else if and Else Begins -----------------------------------------------*/                              
else                               
begin                              
insert into #Fo_Data_New                              
select * from             
(                              
select                               
party_code as Code,                              
inst_type as InstType,                              
symbol as S_Symbol,                              
expirydate as S_expirydate,                              
strike_price as S_strike_price,                              
[user_id] as S_user_id,         
sell_buy as S_sell_buy,                              
sum(tradeqty) as S_tradeqty ,                              
price  as S_price,                              
sum(amount) as S_amount                               
from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                              
where  sell_buy='1' and sauda_date >= convert(datetime,@date,103) and                                 
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'  group by                               
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy                              
)a                              
left outer join                        
(                              
select                               
party_code,                              
inst_type,                              
symbol,                              
expirydate,                              
strike_price,                              
[user_id],                                
sell_buy,                              
sum(tradeqty) as tradeqty,                              
price ,                      
sum(amount) as amount                               
from ANGELFO.pradnya.dbo.History_Fosettlement_Nsefo with (nolock)                              
where  sell_buy='2' and sauda_date >= convert(datetime,@date,103) and                                 
sauda_date <= convert(datetime,@date,103) + '23:59:59.000'                                
group by                               
party_code,inst_type,symbol,expirydate,strike_price,price,[user_id],sell_buy                              
)b                              
on a.Code=b.party_code                               
and a.S_Symbol=b.symbol                               
and a.InstType=b.inst_type                                  
and a.S_expirydate=b.expirydate where a.code is not null and b.party_code is not null                               
end                              
                        
/*-----------------------------------------End of Else-------------------------------------------*/                              
/*-----------------------------------------Count Of Last 90 days---------------------------------*/                              
SELECT party_code,company,turnover,to_del_opt,sauda_date INTO  #mis_to FROM   mis_to (nolock)                                         
WHERE  sauda_date >= Convert(DATETIME,@date,103) - 180                            
AND sauda_date < Convert(DATETIME,@date,103) +' 23:59:59.000'                                        
AND company = 'ACDLFO'                            
                            
SELECT DISTINCT party_code, company,Sum(turnover) turnover,Sum(to_del_opt)AS delivery_turnover                             
INTO #temp                             
FROM  #mis_to (nolock) GROUP BY party_code,company                            
                            
SELECT *                             
INTO  #temp1                             
FROM                               
(                            
SELECT party_code,Count(*) COUNT, company FROM                             
(                            
SELECT   DISTINCT sauda_date,party_code,cnt = Count(* ),                            
company FROM #mis_to (nolock) GROUP BY sauda_date,party_code,company                            
) a                             
GROUP BY party_code,company)x                            
                            
                            
SELECT x.party_code,x.company,COUNT,turnover,delivery_turnover,                            
del_based_to = CASE WHEN (delivery_turnover = 0.00 AND turnover = 0.00) THEN '0.00'                             
WHEN delivery_turnover = 0.00 THEN '0.00' ELSE (delivery_turnover / turnover) * 100 END                            
INTO   #alert1                            
 FROM                               
(SELECT * FROM   #temp (nolock)) x                            
INNER JOIN                             
(SELECT * FROM   #temp1 (nolock)) y                            
ON x.party_code = y.party_code                            
                            
                 
SELECT DISTINCT party_code,Sum(turnover) turnover,sauda_date,Sum(to_del_opt) to_del_opt                            
INTO #mist_todate                            
FROM  mis_to (nolock)                            
WHERE sauda_date = Convert(DATETIME,@date,103) AND company = 'ACDLFO'                            
GROUP BY party_code,sauda_date,company                            
                            
SELECT a.party_code,b.del_based_to,ERROR = 'Intraday in Delivery Client'                                         
INTO #alrt11                             
FROM                            
(SELECT * FROM  #mist_todate (nolock) WHERE  to_del_opt = '0.00') a                            
INNER JOIN                             
(SELECT DISTINCT party_code,del_based_to FROM #alert1 (nolock) WHERE  del_based_to >= @perc) b                                         
ON a.party_code = b.party_code                                   
                              
/*-------------------------------End Of Last 90 days-------------------------------------------------------*/                              
/*---------------------------------illliquid Script data---------------------------------------------------*/                              
                              
select  symbol,strike_price,inst_type,convert(varchar(11),ex_date,103) as ex_date                                  
into #illfo from intranet.risk.dbo.FDS_IlllScript_Fo  where                                
Sdate >= convert(datetime,@date,103) and                                 
Sdate <= convert(datetime,@date,103) + '23:59:59.000'                              
                            
/*-------------------------------------end od illliquid scrip----------------------------------------------*/                              
/*                       
select s_party_code as party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,convert(varchar(11),s_expirydate,103) as s_expirydate ,                           
convert(decimal(10,2),sum(s_sell_trdqty)) as s_sell_trdqty,convert(decimal(10,2),sum(s_sell_amt)) as s_sell_amt,                              
convert(decimal(10,2),s_sell_price) as s_sell_price,convert(decimal(10,2),sum(b_sell_trdqty))as b_sell_trdqty ,convert(decimal(10,2),sum(b_sell_amt)) as b_sell_amt ,convert(decimal(10,2),b_sell_price) as b_sell_price                                      

  
into #final from #Fo_Data_New group by                              
s_party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                              
s_sell_price ,b_sell_price ,s_expirydate  */                        
                      
select s_party_code as party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                      
convert(varchar(11),s_expirydate,103) as s_expirydate ,                           
floor(sum(s_sell_trdqty)) as s_sell_trdqty,                      
floor(sum(s_sell_amt)) as s_sell_amt,                              
convert(decimal(10,2),s_sell_price) as s_sell_price,        
floor(sum(b_sell_trdqty))as b_sell_trdqty ,                      
floor(sum(b_sell_amt)) as b_sell_amt ,                      
convert(decimal(10,2),b_sell_price) as b_sell_price                                        
into #final                       
from #Fo_Data_New group by                              
s_party_code ,s_inst_type,s_symbol,s_strike_price,s_user_id ,                              
s_sell_price ,b_sell_price ,s_expirydate                        
            
                        
                              
/*---------------------------------------------------------------------------*/                              
if @type = 'Ill'                              
begin                               
                            
/*                            
select a.* into #final from #data1 a inner join #illfo b                                
on a.s_symbol = b.symbol and a.s_strike_price = b.strike_price                               
and a.s_Inst_Type=b.inst_type                                
and convert(varchar(11),a.s_expirydate,103)=b.ex_date                               
order by a.party_code,a.s_symbol                                
*/                            
                            
select * into #data2 from #final a inner join #illfo b                             
on a.s_symbol = b.symbol and a.s_strike_price = b.strike_price                               
and a.s_Inst_Type=b.inst_type                                
and convert(varchar(11),a.s_expirydate,103)=b.ex_date                               
order by a.party_code,a.s_symbol                                
                            
select * into #data3 from #data2 where party_code collate SQL_Latin1_General_CP1_CI_AS                              
in (select distinct party_code from #alrt11)                               
                            
select *,Pl = floor(s_sell_amt - b_sell_amt),                              
RateDiff=floor(S_sell_price-B_sell_price),                              
Tover=floor(b_sell_trdqty+s_sell_trdqty) into #data4 from #data3                         
                        
select a.*,case when a.party_code = b.party_code then 'Online' else 'Offline' end as status from                        
(select a.*,b.long_name from #data4 a left outer join risk.dbo.client_details b with(nolock)                        
on a.party_code = b.party_code)a                      
 left outer join intranet.ctcl.dbo.ebrok_client b with(nolock) on a.party_code = b.party_code                        
order by a.party_code                        
                            
/*                            
select *,Pl = s_sell_amt - b_sell_amt,                              
RateDiff=(S_sell_price-B_sell_price),                              
Tover=b_sell_trdqty+s_sell_trdqty                               
from  #data1                            
*/                            
end                           
else                          
begin                          
                      
select * into #data1 from #final where party_code                             
collate SQL_Latin1_General_CP1_CI_AS                              
in (select distinct party_code from #alrt11)                               
                            
select * ,Pl = floor(s_sell_amt - b_sell_amt),                              
RateDiff=floor(S_sell_price-B_sell_price),                              
Tover=floor(b_sell_trdqty+s_sell_trdqty)                       
into #data5                       
from #data1                            
                        
select a.*,case when a.party_code = b.party_code then 'ONLINE CLIENT' else 'OFFLINE CLIENT' end as status into #IntraNsefo  from                      
(                      
select a.*,b.long_name from #data5 a left outer join risk.dbo.client_details b with(nolock)                        
on a.party_code = b.party_code                        
)a                        
left outer join intranet.ctcl.dbo.ebrok_client b with(nolock) on a.party_code = b.party_code                        
order by a.party_code              
            
 --Select            
 --PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))         
 --+'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))        
 --+'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''        
 --+');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+         
 --ltrim(rtrim(PARTY_CODE)) +'</a>'            
 --,s_inst_type,s_symbol,s_strike_price,s_user_id,s_expirydate,s_sell_trdqty,s_sell_amt,s_sell_price,b_sell_trdqty,b_sell_amt,b_sell_price,Pl,RateDiff,Tover,long_name,status            
 --from  #IntraNsefo                      
                      
                      
                      
    if(@Flag='STATIC')            
 BEGIN                
  select * from #IntraNsefo        
  --print @username      
 END            
 ELSE            
 BEGIN      
   Select            
   PARTY_CODE='<a href="/AngelInhouse/FDSystem/FDS/ClientInfo.aspx?Val='+ ltrim(rtrim(PARTY_CODE))         
   +'&access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code))        
   +'&username='+ ltrim(rtrim(@username))+'" onclick="javascript:newwindow=window.open(this.href,this.target,'+'''scrollbars=yes,directories=no,location=no,menubar=no,resizable=no,status=no,toolbar=no'''        
   +');if (window.focus) {newwindow.focus()}return false;" target=_blank>'+         
   ltrim(rtrim(PARTY_CODE)) +'</a>'            
   ,s_inst_type,s_symbol,s_strike_price,s_user_id,s_expirydate,s_sell_trdqty,s_sell_amt,s_sell_price,b_sell_trdqty,b_sell_amt,b_sell_price,Pl,RateDiff,Tover,long_name,status            
   from  #IntraNsefo                           
 END   
 Set Nocount Off            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FDSIntraDelSumm
-- --------------------------------------------------
CREATE Procedure USP_FDSIntraDelSumm
(@date        AS VARCHAR(11),             
@segment     AS VARCHAR(15),             
@perc        AS INT,             
@scrip       AS VARCHAR(15),
@access_to   As varchar(25),             
@access_code   As varchar(25)
) 
as
set nocount on

Declare  @temp table(
party_code varchar(35),
scrip_cd varchar(70),
sc_name varchar(100),
turnover numeric,
totalnoofshares numeric,
turnoverperc  numeric,
buyrate  numeric,
sellrate  numeric,
stkprcvariation  numeric,
pl  numeric,
pqtytrd int,
pqtydel int,
sqtytrd int,
sqtydel int,
segment varchar(25)
)

if(@segment='ABLCM')
begin 
	INSERT INTO @temp
	exec USP_FDS_IntradayInDelivery @date,@segment,@perc,@scrip,@access_to,@access_code
end
if(@segment='ACDLCM')
begin 
	INSERT INTO @temp
	exec USP_FDS_IntradayInDelivery @date,@segment,@perc,@scrip,@access_to,@access_code
end
if(@segment='ALL')
begin 
	INSERT INTO @temp
	exec USP_FDS_IntradayInDelivery @date,'ABLCM',@perc,@scrip,@access_to,@access_code

	INSERT INTO @temp
	exec USP_FDS_IntradayInDelivery @date,'ACDLCM',@perc,@scrip,@access_to,@access_code
end

select * from @temp 

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findinJobs
-- --------------------------------------------------
Create Procedure usp_findinJobs(@Str as varchar(500))  
as  
select b.name,  
Case when b.enabled=1 then 'Active' else 'Deactive' end as Status,  
date_created,date_modified,a.step_id,a.step_name,a.command  
from msdb.dbo.sysjobsteps a, msdb.dbo.sysjobs b  
where command like '%'+@Str+'%'  
and a.job_id=b.job_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findInUSP
-- --------------------------------------------------
CREATE PROCEDURE USP_FINDINUSP
(
	@DBNAME VARCHAR(500),          
	@SRCSTR VARCHAR(500)            
)
AS            

BEGIN
        
	SET NOCOUNT ON          
	SET @SRCSTR  = '%' + @SRCSTR + '%'            
	      
	DECLARE @STR AS VARCHAR(1000)          
	SET @STR=''          
	
	IF @DBNAME <>''          
	BEGIN          
		SET @DBNAME=@DBNAME+'.DBO.'          
	END          
	ELSE          
	BEGIN          
		SET @DBNAME=DB_NAME()+'.DBO.'          
	END 
	         
	PRINT @DBNAME          
	      
	SET @STR='SELECT DISTINCT O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '           
	SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '           
	SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''            
	
	PRINT @STR          
	EXEC(@STR)          
	
	SET NOCOUNT OFF 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_functions_findInUSP
-- --------------------------------------------------
CREATE PROCEDURE usp_functions_findInUSP    
@str varchar(500)    
AS    
    
 set @str = '%' + @str + '%'    
     
 select O.name from sysComments  C    
 join sysObjects O on O.id = C.id    
 where O.xtype = 'P' and C.text like @str

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ING_DATES
-- --------------------------------------------------
CREATE proc USP_ING_DATES --'23/06/2010','C'
(
@date varchar(11),
@type varchar(5)
)
as
SET NOCOUNT ON 

select  funds_payout as Payout_date,sec_payout as Sec_delvDate,
sec_payin as Sec_setDate from sett_mst(nolock) where convert(varchar(11),start_date,103)=@date and sett_type=@type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_nri_saudasummary
-- --------------------------------------------------
CREATE PROC [dbo].[usp_nri_saudasummary]  
(  
 @FDATE AS VARCHAR(11),  
 @TDATE AS VARCHAR(11),  
 @FCLIENT AS VARCHAR(15),          
 @TCLIENT AS VARCHAR(15),  
 @TYPE AS VARCHAR(10)  
)          
AS          
SET NOCOUNT ON;
----By Amit On 11-Nov-2010       
/*IF @TYPE='D'          
BEGIN     
 SELECT DISTINCT [CL CODE]=PARTY_CODE,  
   [SAUDA DATE]=CONVERT(VARCHAR(11),SAUDA_DATE,103),  
   'B' AS SELL_BUY,        
   TERMINAL_ID=DBO.CONCATLIST(PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103))  
      
 FROM MIS_TO(NOLOCK)           
 WHERE PARTY_CODE LIKE 'ZR%'   
  AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103) AND  SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'          
 ORDER BY PARTY_CODE ,CONVERT(VARCHAR(11),SAUDA_DATE,103)           
  
END          
ELSE           
BEGIN          
--DECLARE @FCLIENT AS VARCHAR(15),@TCLIENT AS VARCHAR(15)          
--SET @FCLIENT='ZR10'          
--SET @TCLIENT='ZR20'          
 SELECT DISTINCT [CL CODE]=PARTY_CODE,  
   [SAUDA DATE]=CONVERT(VARCHAR(11),SAUDA_DATE,103),  
  'B' AS SELL_BUY,  
  TERMINAL_ID=DBO.CONCATLIST(PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103))  
 FROM MIS_TO(NOLOCK) WHERE           
  PARTY_CODE LIKE 'ZR%'      
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))   
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))          
 ORDER BY PARTY_CODE ,CONVERT(VARCHAR(11),SAUDA_DATE,103)           
          
END*/

TRUNCATE TABLE NRI_SAUDA_SUMMARY      
IF @TYPE='D'              
BEGIN         
  --- BSE SEGMENT      
 INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'BSE' AS Segment     
  FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
  AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
  AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
       
     INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'BSE' AS Segment     
  FROM AngelBSECM.BSEDB_AB.DBO.HISTORY NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
  AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
  AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
    
  --- NSE SEGMENT      
 INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'NSE' AS Segment       
 FROM AngelNseCM.MSAJAG.DBO.SETTLEMENT NOLOCK      
 WHERE PARTY_CODE LIKE 'ZR%'       
  AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
  AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY   
   
 INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'NSE' AS Segment       
 FROM AngelNseCM.MSAJAG.DBO.HISTORY NOLOCK      
 WHERE PARTY_CODE LIKE 'ZR%'       
  AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
  AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
  --- NSEFO SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
   SELECT DISTINCT PARTY_CODE,     
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'NSEFO' AS Segment       
  FROM ANGELFO.NSEFO.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY       
    
  --- NCDX SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
   SELECT DISTINCT PARTY_CODE,     
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'NCDX' AS Segment      
  FROM ANGELCOMMODITY.NCDX.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
  --- MCDX SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,       'MCDX' AS Segment      
  FROM ANGELCOMMODITY.MCDX.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
  --- MCDXCDS SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY ,    
   'MCDXCDS' AS Segment     
  FROM ANGELCOMMODITY.MCDXCDS.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
  --- NSECURFO SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,     
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'NSECURFO' AS Segment      
  FROM ANGELFO.NSECURFO.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)       
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'        
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
END              
ELSE               
BEGIN              
  /*DECLARE @FCLIENT AS VARCHAR(15),@TCLIENT AS VARCHAR(15)              
  SET @FCLIENT='ZR10'              
  SET @TCLIENT='ZR20'*/     
  --- BSE SEGMENT      
 INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'BSE' AS Segment       
 FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT NOLOCK      
 WHERE PARTY_CODE LIKE 'ZR%'       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))       
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY       
    
 INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'BSE' AS Segment       
 FROM AngelBSECM.BSEDB_AB.DBO.HISTORY NOLOCK      
 WHERE PARTY_CODE LIKE 'ZR%'       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))       
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY  
  --- NSE SEGMENT      
 INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'NSE' AS Segment       
 FROM AngelNseCM.MSAJAG.DBO.SETTLEMENT NOLOCK      
 WHERE PARTY_CODE LIKE 'ZR%'       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))      
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY       
   
 INSERT INTO NRI_SAUDA_SUMMARY      
  SELECT DISTINCT PARTY_CODE,    
  USER_ID AS TERMINAL_ID,      
  CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
  CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
  'NSE' AS Segment       
 FROM AngelNseCM.MSAJAG.DBO.HISTORY NOLOCK      
 WHERE PARTY_CODE LIKE 'ZR%'       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
  AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))      
 GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY     
  --- NSEFO SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
   SELECT DISTINCT PARTY_CODE,    
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'NSEFO' AS Segment       
  FROM ANGELFO.NSEFO.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY       
    
  --- NCDX SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
   SELECT DISTINCT PARTY_CODE,    
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'NCDX' AS Segment       
  FROM ANGELCOMMODITY.NCDX.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))       
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
  --- MCDX SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
   SELECT DISTINCT PARTY_CODE,    
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'MCDX' AS Segment       
  FROM ANGELCOMMODITY.MCDX.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))        
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
  --- MCDXCDS SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
   SELECT DISTINCT PARTY_CODE,    
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'MCDXCDS' AS Segment       
  FROM ANGELCOMMODITY.MCDXCDS.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
    
  --- NSECURFO SEGMENT      
  INSERT INTO NRI_SAUDA_SUMMARY      
   SELECT DISTINCT PARTY_CODE,    
   USER_ID AS TERMINAL_ID,      
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,      
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,    
   'NSECURFO' AS Segment       
  FROM ANGELFO.NSECURFO.DBO.FOSETTLEMENT NOLOCK      
  WHERE PARTY_CODE LIKE 'ZR%'       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))       
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))       
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY      
END     
 SELECT DISTINCT PARTY_CODE,    
 SAUDA_DATE,      
 TERMINAL_ID=DBO.ConcatList(PARTY_CODE,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY),      
 SELL_BUY      
 FROM NRI_SAUDA_SUMMARY NOLOCK      
 ORDER BY PARTY_CODE ,SAUDA_DATE    
SET NOCOUNT OFF;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_NRI_SAUDASUMMARY_temp11112010
-- --------------------------------------------------
  
CREATE PROC USP_NRI_SAUDASUMMARY_TEMP11112010    
(    
 @FDATE AS VARCHAR(11),    
 @TDATE AS VARCHAR(11),    
 @FCLIENT AS VARCHAR(15),            
 @TCLIENT AS VARCHAR(15),    
 @TYPE AS VARCHAR(10)    
)            
AS    
  
---EXEC USP_NRI_SAUDASUMMARY_TEMP11112010 '','','ZR105','ZR105','C'      
---EXEC USP_NRI_SAUDASUMMARY_TEMP11112010 '09/11/2010','09/11/2010','','','D'        
SET NOCOUNT ON;    
TRUNCATE TABLE NRI_SAUDA_SUMMARY    
IF @TYPE='D'            
BEGIN       
  --- BSE SEGMENT    
	INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'BSE' AS Segment   
		FROM ANAND.BSEDB_AB.DBO.SETTLEMENT NOLOCK    
		WHERE PARTY_CODE LIKE 'ZR%'     
		AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
		AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY  
     
     INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'BSE' AS Segment   
		FROM ANAND.BSEDB_AB.DBO.HISTORY NOLOCK    
		WHERE PARTY_CODE LIKE 'ZR%'     
		AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
		AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY  
  
  --- NSE SEGMENT    
	INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'NSE' AS Segment     
	FROM ANAND1.MSAJAG.DBO.SETTLEMENT NOLOCK    
	WHERE PARTY_CODE LIKE 'ZR%'     
		AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
		AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY 
	
	INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'NSE' AS Segment     
	FROM ANAND1.MSAJAG.DBO.HISTORY NOLOCK    
	WHERE PARTY_CODE LIKE 'ZR%'     
		AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
		AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
  --- NSEFO SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
   SELECT DISTINCT PARTY_CODE,   
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'NSEFO' AS Segment     
  FROM ANGELFO.NSEFO.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY     
  
  --- NCDX SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
   SELECT DISTINCT PARTY_CODE,   
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'NCDX' AS Segment    
  FROM ANGELCOMMODITY.NCDX.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
  --- MCDX SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
  SELECT DISTINCT PARTY_CODE,  
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'MCDX' AS Segment    
  FROM ANGELCOMMODITY.MCDX.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
  --- MCDXCDS SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
  SELECT DISTINCT PARTY_CODE,  
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY ,  
   'MCDXCDS' AS Segment   
  FROM ANGELCOMMODITY.MCDXCDS.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
  --- NSECURFO SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
  SELECT DISTINCT PARTY_CODE,   
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'NSECURFO' AS Segment    
  FROM ANGELFO.NSECURFO.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND SAUDA_DATE>=CONVERT(DATETIME,@FDATE,103)     
   AND SAUDA_DATE<=CONVERT(DATETIME,@TDATE,103)+ ' 23:59:59'      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
END            
ELSE             
BEGIN            
  /*DECLARE @FCLIENT AS VARCHAR(15),@TCLIENT AS VARCHAR(15)            
  SET @FCLIENT='ZR10'            
  SET @TCLIENT='ZR20'*/   
  --- BSE SEGMENT    
	INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'BSE' AS Segment     
	FROM ANAND.BSEDB_AB.DBO.SETTLEMENT NOLOCK    
	WHERE PARTY_CODE LIKE 'ZR%'     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))     
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY     
  
	INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'BSE' AS Segment     
	FROM ANAND.BSEDB_AB.DBO.HISTORY NOLOCK    
	WHERE PARTY_CODE LIKE 'ZR%'     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))     
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY
  --- NSE SEGMENT    
	INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'NSE' AS Segment     
	FROM ANAND1.MSAJAG.DBO.SETTLEMENT NOLOCK    
	WHERE PARTY_CODE LIKE 'ZR%'     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))    
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY     
	
	INSERT INTO NRI_SAUDA_SUMMARY    
		SELECT DISTINCT PARTY_CODE,  
		USER_ID AS TERMINAL_ID,    
		CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
		CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
		'NSE' AS Segment     
	FROM ANAND1.MSAJAG.DBO.HISTORY NOLOCK    
	WHERE PARTY_CODE LIKE 'ZR%'     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
		AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))    
	GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY   
  --- NSEFO SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
   SELECT DISTINCT PARTY_CODE,  
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'NSEFO' AS Segment     
  FROM ANGELFO.NSEFO.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))    
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY     
  
  --- NCDX SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
   SELECT DISTINCT PARTY_CODE,  
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'NCDX' AS Segment     
  FROM ANGELCOMMODITY.NCDX.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))     
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
  --- MCDX SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
   SELECT DISTINCT PARTY_CODE,  
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'MCDX' AS Segment     
  FROM ANGELCOMMODITY.MCDX.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))      
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
  --- MCDXCDS SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
   SELECT DISTINCT PARTY_CODE,  
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'MCDXCDS' AS Segment     
  FROM ANGELCOMMODITY.MCDXCDS.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))    
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
  
  --- NSECURFO SEGMENT    
  INSERT INTO NRI_SAUDA_SUMMARY    
   SELECT DISTINCT PARTY_CODE,  
   USER_ID AS TERMINAL_ID,    
   CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,    
   CASE SELL_BUY WHEN 1 THEN 'B' ELSE 'S' END AS SELL_BUY,  
   'NSECURFO' AS Segment     
  FROM ANGELFO.NSECURFO.DBO.FOSETTLEMENT NOLOCK    
  WHERE PARTY_CODE LIKE 'ZR%'     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))>=CONVERT(INT,DBO.REPLACEALPHBATE(@FCLIENT))     
   AND CONVERT(INT,DBO.REPLACEALPHBATE(PARTY_CODE))<=CONVERT(INT,DBO.REPLACEALPHBATE(@TCLIENT))     
  GROUP BY PARTY_CODE,USER_ID,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY    
END   
 SELECT DISTINCT PARTY_CODE,  
 SAUDA_DATE,    
 TERMINAL_ID=DBO.CONCATLIST_TEMP11112010(PARTY_CODE,CONVERT(VARCHAR,SAUDA_DATE,103),SELL_BUY),    
 SELL_BUY    
 FROM NRI_SAUDA_SUMMARY NOLOCK    
 ORDER BY PARTY_CODE ,SAUDA_DATE      
  
SET NOCOUNT OFF;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_QA_Client_Details
-- --------------------------------------------------
CREATE proc [dbo].[USP_QA_Client_Details](@br_code as varchar(20),@Sb_code as varchar(20),@fdate as varchar(11),@tdate as varchar(11),@cType as varchar(15),@NoOfClients as varchar(15))                          
as                          
  
declare @sql as varchar(5000)  
declare @sb as varchar(50)  
declare @s as varchar(5000)  
declare @s1 as varchar(5000)  
declare @file as varchar(5000)  

/*set @file = 'D:\upload1\QA\'+ltrim(rtrim(@br_code))+''+convert(varchar,getdate()-1,112)+'.csv'   */
set @file = 'I:\upload1\QA\'+ltrim(rtrim(@br_code))+''+convert(varchar,getdate()-1,112)+'.csv'   

  
-- declare @br_code as varchar(20),  
-- @Sb_code as varchar(20),  
-- @fdate as varchar(11),  
-- @tdate as varchar(12),  
-- @cType as varchar(15),  
-- @NoOfClients as varchar(11)  
--   
-- set @br_code = 'ACM'  
-- set @Sb_code = 'HO'  
-- set @fdate = 'Apr 01 2007'  
-- set @tdate = 'June 10 2007'  
-- set @NoOfClients = 100  
-- set @cType = 'D'  
  
set @sb = (case when @cType = 'D' then @br_code else @Sb_code end)  
--print @sb  
  
select Top 0 Party_code,Brokerage into #t from mis_to                             
  
set @sql = 'insert into #t select Top '+@NoOfClients+' Party_code,Brokerage=sum(Brokerage)  from mis_to   
where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and branch_cd = '''+@br_code+''' and sub_broker = '''+@sb+'''  
group by Party_code'            
exec (@sql)    
  
truncate table QA_CLient_Details  
  
insert into QA_CLient_Details  
select 'Client_Name'+','+'Client_Code'+','+'SubBroker_Name'+','+'Branch_Code'+','+'Add1'+','+'Add2'+','+'Add3'+','+'City'+','+'State'+','+'Pin'+','+'Resi_No'+','+'Office_No'+','+'Mobile Number'+','+'Email'+','+'Total Brokerage'   
  
insert into QA_CLient_Details     
select Distinct long_name+','+a.cl_code+','+sub_broker+','+branch_cd+','+l_address1+','+l_address2+','+l_address3+','+l_city+','+l_state+','+l_zip+','+res_phone1+'\'+res_phone2+','+ off_phone1+'\'+off_phone2+','+mobile_pager+','+email+','+convert(varchar,b.Brokerage)  
--+convert(varchar,b.Brokerage) /*,AVG_Brok=b.brokerage/12 into #t1*/   
from risk.dbo.client_details a inner join #t b on b.Party_code = a.cl_code collate latin1_general_cs_as left outer join risk.dbo.client_brok_details c on   
b.Party_code = c.cl_code collate latin1_general_cs_as and c.InActive_From >= getdate()   
--order by convert(varchar,b.Brokerage) desc            
  
set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT Heading FROM INTRANET.bsedb_ab.DBO.QA_CLient_Details" queryout '+@file+' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'            
set @s1= @s+''''            
exec(@s1)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Rpt_UT
-- --------------------------------------------------
CREATE proc USP_Rpt_UT    
(@date_proc varchar(11))    
as            
    
declare @date_process as datetime,@date_start as datetime,@date_end as datetime,@date_lastmonth as datetime    
set @date_process = convert(datetime,@date_proc,103)--getdate()    
set @date_end = @date_process-28    
set @date_start = @date_end-6    
set @date_lastmonth = @date_start-30    
    
print @date_process    
print @date_start    
print @date_end    
print @date_lastmonth           
--------1-------------------------------------------------------            
Select distinct cl_code into #angelclt from risk.dbo.client_details where long_name like 'Angel %'            
            
----------------------------------------------------------------            
/*drop table #mis_to            
drop table #mis_to_B2C            
drop table #mis_to_B2B*/            
--Select * from mis_to        
----------2---All Clients-----------------------------------------------------------------            
Select branch_cd,Sub_Broker,party_code,sum(turnover)turnover,sum(to_trd_fut)to_trd_fut,sum(to_del_opt)to_del_opt             
into #mis from mis_to (nolock)    
where Sauda_date>=@date_start and Sauda_date<=@date_end+' 23:59:59.998'    
---and Company not in ('ABLCM','ACDLCM','ACDLFO')        
group by branch_cd,Sub_Broker,party_code            
            
----------3----Client active in current month (filter 1)----------------------------------            
Select cl_code into #clcd_act_in_curmonth from risk.dbo.client_details with(nolock)             
where First_Active_date > convert(datetime,'01'+ right(convert(varchar(11),@date_process,103),8),103)    
            
----------------4--Filter 1----------------------------------------------------------------            
Select * into #mis_to from #mis (nolock) where party_code collate SQL_Latin1_General_CP1_CI_AS not in             
(Select cl_code from #clcd_act_in_curmonth (nolock))            
            
----------------5---B2C Clients------------------------------------------------------------            
Select branch_cd,Sub_Broker,party_code B2C_clt,sum(turnover)turnover,            
sum(to_trd_fut)to_trd_fut,sum(to_del_opt)to_del_opt into #mis_to_B2C from #mis_to             
where Sub_Broker in (Select b2c_sb from mis.remisior.dbo.b2c_sb)            
group by branch_cd,Sub_Broker,party_code            
            
-----------------6---B2B Clients------------------------------------------------------------            
Select branch_cd,Sub_Broker,party_code B2B_clt,sum(turnover)turnover,            
sum(to_trd_fut)to_trd_fut,sum(to_del_opt)to_del_opt into #mis_to_B2B from #mis_to             
where Sub_Broker not in (Select b2c_sb from mis.remisior.dbo.b2c_sb)            
group by branch_cd,Sub_Broker,party_code            
            
-----------------7---one BR and five diff SB (top 5 B2C)-------------------------------------            
Select  x.bRANCH_cd,x.Sub_Broker,y.B2C_clt,x.turnover into #tc_top from            
(Select DISTINCT bRANCH_cd,Sub_Broker,max(turnover)turnover from #mis_to_B2C             
where B2C_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker)x            
left outer join            
(Select DISTINCT bRANCH_cd,Sub_Broker,B2C_clt,max(turnover)turnover from #mis_to_B2C             
where B2C_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker,B2C_clt)y            
on x.bRANCH_cd=y.bRANCH_cd and x.Sub_Broker=y.Sub_Broker and x.turnover=y.turnover            
order by  branch_cd asc,Sub_broker asc,turnover desc            
            
-----------------8---one BR and five diff SB (bottom 5 B2C)----------------------------------            
Select  x.bRANCH_cd,x.Sub_Broker,y.B2C_clt,x.turnover into #tc_bottom from            
(Select DISTINCT bRANCH_cd,Sub_Broker,min(turnover)turnover from #mis_to_B2C             
where B2C_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker)x            
left outer join            
(Select DISTINCT bRANCH_cd,Sub_Broker,B2C_clt,min(turnover)turnover from #mis_to_B2C             
where B2C_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker,B2C_clt)y            
on x.bRANCH_cd=y.bRANCH_cd and x.Sub_Broker=y.Sub_Broker and x.turnover=y.turnover         
order by turnover asc            
            
-----------------9---one BR and five diff SB (top 5 B2B)-------------------------------------            
Select  x.bRANCH_cd,x.Sub_Broker,y.B2B_clt,x.turnover into #tb_top from            
(Select DISTINCT bRANCH_cd,Sub_Broker,max(turnover)turnover from #mis_to_B2B             
where B2B_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker)x            
left outer join            
(Select DISTINCT bRANCH_cd,Sub_Broker,B2B_clt,max(turnover)turnover from #mis_to_B2B             
where B2B_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker,B2B_clt)y            
on x.bRANCH_cd=y.bRANCH_cd and x.Sub_Broker=y.Sub_Broker and x.turnover=y.turnover            
order by  turnover desc            
            
-----------------10---one BR and five diff SB (bottom 5 B2B)------------------------------------            
Select  x.bRANCH_cd,x.Sub_Broker,y.B2B_clt,x.turnover into #tb_bottom from            
(Select DISTINCT bRANCH_cd,Sub_Broker,min(turnover)turnover from #mis_to_B2B             
where B2B_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker)x            
left outer join            
(Select DISTINCT bRANCH_cd,Sub_Broker,B2B_clt,min(turnover)turnover from #mis_to_B2B             
where B2B_clt collate SQL_Latin1_General_CP1_CI_AS not in  (Select cl_code from #angelclt)            
group by bRANCH_cd,Sub_Broker,B2B_clt)y            
on x.bRANCH_cd=y.bRANCH_cd and x.Sub_Broker=y.Sub_Broker and x.turnover=y.turnover            
order by turnover asc            
            
-------------------------------------------------------------------------------------------------            
/*drop table #topfive_b2b            
drop table #bottomfive_b2b            
drop table #topfive_b2C            
drop table #bottomfive_b2c*/            
            
Select top 0 * into #topfive_b2b from #tb_top            
Select top 0 * into #bottomfive_b2b from #tb_bottom            
Select top 0 * into #topfive_b2C from #tc_top            
Select top 0 * into #bottomfive_b2c from #tc_bottom            
            
------6--Cursor Start----------------------------------------------------------------------------            
declare @branch as varchar(50)                   
DECLARE error_cursor CURSOR FOR                                                           
select DISTINCT bRANCH_cd from #mis_to            
            
OPEN error_cursor                                                          
FETCH NEXT FROM error_cursor                                                           
INTO @branch                                          
WHILE @@FETCH_STATUS = 0                                                          
BEGIN            
            
insert into #topfive_b2b            
Select top 5 * from #tb_top where bRANCH_cd =@branch and      
Sub_Broker+B2b_clt collate SQL_Latin1_General_CP1_CI_AS not in (Select Sub_Broker+clt_code collate SQL_Latin1_General_CP1_CI_AS from tbl_Rpt_UT )      
order by turnover desc            
            
insert into #bottomfive_b2b            
Select top 5 * from #tb_bottom where bRANCH_cd =@branch and       
Sub_Broker+B2b_clt collate SQL_Latin1_General_CP1_CI_AS not in (Select Sub_Broker+clt_code collate SQL_Latin1_General_CP1_CI_AS from tbl_Rpt_UT )      
order by turnover asc      
            
insert into #topfive_b2C            
Select top 5 * from #tc_top where bRANCH_cd =@branch and       
Sub_Broker+B2c_clt collate SQL_Latin1_General_CP1_CI_AS not in (Select Sub_Broker+clt_code collate SQL_Latin1_General_CP1_CI_AS from tbl_Rpt_UT )      
order by turnover desc            
            
insert into #bottomfive_b2c            
Select top 5 * from #tc_bottom where bRANCH_cd =@branch and       
Sub_Broker+B2c_clt collate SQL_Latin1_General_CP1_CI_AS not in (Select Sub_Broker+clt_code collate SQL_Latin1_General_CP1_CI_AS from tbl_Rpt_UT )      
order by turnover asc      
            
---------------------                   
FETCH NEXT FROM error_cursor            
INTO @branch            
END            
CLOSE error_cursor            
DEALLOCATE error_cursor            
            
--------Cursor End----------------------------------------------------------------------------            
/*Select * from #topfive_b2b order by bRANCH_cd,turnover desc            
Select * from #bottomfive_b2b order by bRANCH_cd,turnover            
Select * from #topfive_b2C order by bRANCH_cd,turnover desc            
Select * from #bottomfive_b2c order by bRANCH_cd,turnover */          
----------------------------------------------------------------------------------------------            
             
    
-------7-Inactive Clients---------------------------------------------------------------------            
Select distinct party_code into #inactiveclt            
from mis_to (nolock) where Sauda_date>=@date_start and Sauda_date<=@date_lastmonth+' 23:59:59.998'    
-------8---------------------------------------            
Select * into #B2Bclt from #mis_to_B2B (nolock) where b2b_clt not in            
(Select distinct party_code from #inactiveclt (nolock))            
            
-------9-----------------------------------------            
Select * into #B2Cclt from #mis_to_B2C (nolock) where b2c_clt not in            
(Select distinct party_code from #inactiveclt (nolock))            
            
-------10------------------------------------------            
select cltcode,            
Receipt= isnull(sum(case when vtyp = 2 then vamt end),0),              
Payment = isnull(sum(case when vtyp = 3 then vamt end),0) into #bse_PR            
from risk.dbo.abl_ledger (nolock) where vdt >= @date_start and vdt <= @date_end+' 23:59:59.998'    
and vtyp in (2,3) group by cltcode            
            
select cltcode,            
Receipt= isnull(sum(case when vtyp = 2 then vamt end),0),              
Payment = isnull(sum(case when vtyp = 3 then vamt end),0) into #nse_PR            
from risk.dbo.nse_ledger (nolock) where vdt >= @date_start and vdt <= @date_end+' 23:59:59.998'    
and vtyp in (2,3) group by cltcode            
            
select cltcode,            
Receipt= isnull(sum(case when vtyp = 2 then vamt end),0),              
Payment = isnull(sum(case when vtyp = 3 then vamt end),0) into #fo_PR             
from risk.dbo.fo_ledger (nolock) where vdt >= @date_start and vdt <= @date_end+' 23:59:59.998'    
and vtyp in (2,3) group by cltcode            
            
select cltcode,            
Receipt= isnull(sum(case when vtyp = 2 then vamt end),0),              
Payment = isnull(sum(case when vtyp = 3 then vamt end),0) into #mcd_PR            
from risk.dbo.mcd_ledger (nolock) where vdt >= @date_start and vdt <= @date_end+' 23:59:59.998'    
and vtyp in (2,3) group by cltcode            
            
select cltcode,            
Receipt= isnull(sum(case when vtyp = 2 then vamt end),0),              
Payment = isnull(sum(case when vtyp = 3 then vamt end),0) into #mcdx_PR            
from risk.dbo.mcdx_ledger (nolock) where vdt >= @date_start and vdt <= @date_end+' 23:59:59.998'    
and vtyp in (2,3) group by cltcode            
            
select cltcode,            
Receipt= isnull(sum(case when vtyp = 2 then vamt end),0),              
Payment = isnull(sum(case when vtyp = 3 then vamt end),0) into #ncdx_PR            
from risk.dbo.ncdx_ledger (nolock) where vdt >= @date_start and vdt <= @date_end+' 23:59:59.998'    
and vtyp in (2,3) group by cltcode            
            
select cltcode,            
Receipt= isnull(sum(case when vtyp = 2 then vamt end),0),              
Payment = isnull(sum(case when vtyp = 3 then vamt end),0) into #nsx_PR            
from risk.dbo.nsx_ledger (nolock) where vdt >= @date_start and vdt <= @date_end+' 23:59:59.998'    
and vtyp in (2,3) group by cltcode            
            
--------11-------------------------------------------------            
  
Select cltcode,convert(money,Receipt)Receipt,convert(money,Payment)Payment into #PR from #bse_PR            
union            
Select cltcode,convert(money,Receipt)Receipt,convert(money,Payment)Payment from #nse_PR            
union            
Select cltcode,convert(money,Receipt)Receipt,convert(money,Payment)Payment from #fo_PR            
union             
Select cltcode,convert(money,Receipt)Receipt,convert(money,Payment)Payment from #mcd_PR            
union            
Select cltcode,convert(money,Receipt)Receipt,convert(money,Payment)Payment from #mcdx_PR            
union            
Select cltcode,convert(money,Receipt)Receipt,convert(money,Payment)Payment from #ncdx_PR            
union            
Select cltcode,convert(money,Receipt)Receipt,convert(money,Payment)Payment from #nsx_PR            
            
-------12------------------------------------------------            
insert into tbl_Rpt_UT          
Select *,'0.00','0.00','0.00','0.00','TFB2B' from #topfive_b2b           
union all          
Select *,'0.00','0.00','0.00','0.00','BFB2B' from #bottomfive_b2b          
union all          
Select *,'0.00','0.00','0.00','0.00','TFB2C' from #topfive_b2C          
union all          
Select *,'0.00','0.00','0.00','0.00','BFB2B' from #bottomfive_b2c          
union all          
Select x.branch_cd,x.Sub_Broker,x.B2B_clt,x.turnover,x.to_trd_fut,            
x.to_del_opt,isnull(y.Receipt,0)Receipt,isnull(y.Payment,0)Payment from             
(Select * from #B2Bclt )x            
left outer join            
(Select cltcode,isnull(sum(Receipt),0)Receipt,isnull(sum(Payment),0)Payment,'IAB2B' from #PR group by cltcode)y            
on x.b2b_clt=y.cltcode collate SQL_Latin1_General_CP1_CI_AS            
      
union all            
Select x.branch_cd,x.Sub_Broker,x.B2C_clt,x.turnover,x.to_trd_fut,            
x.to_del_opt,isnull(y.Receipt,0)Receipt,isnull(y.Payment,0)Payment,'IAB2C' from             
(Select * from #B2Cclt )x            
left outer join            
(Select cltcode,isnull(sum(Receipt),0)Receipt,isnull(sum(Payment),0)Payment from #PR group by cltcode)y            
on x.b2c_clt=y.cltcode collate SQL_Latin1_General_CP1_CI_AS            
      
----------------------------------------------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Sel_GenerateMisReportFromLevel1Mis
-- --------------------------------------------------

CREATE  Procedure usp_Sel_GenerateMisReportFromLevel1Mis(@RptType as Varchar(20),@FromDate as datetime,@ToDate as datetime,@Branch_code as varchar(20),@Party_code  varchar(20))

as 

select ExchangeSegment,party_Code,Branch_cd,Sub_broker,sauda_date,a.terminal_id,turnover=sum(TPA+TSA+DPA+DSA),brokerage=sum(TPB+TSB+DPB+DSB)  into #file2 from level1mis a, 
(select * from mis.terminalmaster.dbo.tbl_mst_Terminals 
)b 
where 
a.sauda_Date>=activation_Date and sauda_date<=deactivation_Date 
and a.terminal_id = b.terminal_id collate SQL_Latin1_General_CP1_CI_AS
and sauda_date>=@FromDate and sauda_date<=@ToDate
group by party_Code,sauda_date,a.terminal_id,ExchangeSegment,party_code,Branch_cd,sub_broker

If @RptType='Es' 
begin 
select
executive,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage) 
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code  
group by executive order by executive 

end 

else  if @RptType='Ed'
begin 
select a.party_code,executive,sub_broker,branch_cd,BSECM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),NSECM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),NSEFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),BSECM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),NSECM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),NSEFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by executive,a.party_code,branch_cd,sub_broker order by executive
end 

else  if @RptType='dd'
begin 

select sauda_date,BSECM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),NSECM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),NSEFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),BSECM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),NSECM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),NSEFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sauda_date order by sauda_date
end 

else  if @RptType='sd'

begin 
select sauda_date,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sauda_date order by sauda_date
end 
else  if @RptType='cd'
begin 

select a.party_code,sub_broker,branch_cd,BSECM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),NSECM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),NSEFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),BSECM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),NSECM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),NSEFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by a.party_code,branch_cd,sub_broker order by a.party_code
end 

else  if @RptType='cs'

begin 
select a.Party_code,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by a.party_code order by a.party_code
end 

else  if @RptType='bd'
begin 

select branch_cd,BSECM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),NSECM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),NSEFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),BSECM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),NSECM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),NSEFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by branch_cd order by branch_cd
end 

else  if @RptType='Bs'

begin 
select branch_cd,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by branch_cd order by branch_cd
end 

else  if @RptType='SbS'

begin 
select sub_broker,branch_cd,Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by  sub_broker,branch_cd order by  sub_broker,branch_cd
end 

else  if @RptType='Sbd'
begin 

select sub_broker,branch_cd,BSECM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),NSECM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),NSEFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),BSECM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),NSECM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),NSEFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and branch_cd like @Branch_code and a.party_code like @Party_code 
group by sub_broker,branch_cd order by sub_broker,branch_cd
end 

else  if @RptType='Exe'
begin 

select a.party_code,BSECM_TO=sum(case when ExchangeSegment='BSECM' then turnover else 0 end),NSECM_TO=sum(case when ExchangeSegment='NSECM'  then turnover else 0 end),NSEFO_TO=sum(case when ExchangeSegment='NSEFO'  then turnover else 0 end),BSECM_BRK=sum(case when ExchangeSegment='BSECM' then brokerage else 0 end),NSECM_BRK=sum(case when ExchangeSegment='NSECM'  then brokerage else 0 end),NSEFO_BRK=sum(case when ExchangeSegment='NSEFO'  then brokerage else 0 end),Turnover = Sum(Turnover),Brokerage = Sum(Brokerage)
,Mcx_turn=sum(case when ExchangeSegment='MCX' then Turnover else 0 end),Mcx_brok=sum(case when ExchangeSegment='MCX' then Brokerage else 0 end),ncdx_turn=sum(case when ExchangeSegment='NCX' then Turnover else 0 end),ncdx_brok=sum(case when ExchangeSegment='NCX' then Brokerage else 0 end)
from #file2 a join dotnet.dbo.clientexecutive c on a.party_code=c.party_code collate Latin1_General_CI_AS
and executive like @Branch_code and a.party_code like @Party_code 
group by a.party_code order by a.party_code
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TrainingDate
-- --------------------------------------------------
CREATE  proc dbo.USP_TrainingDate (@fdays as int)                          
as                          
set nocount on      
declare @fdate as varchar(25),@tdate as varchar(25)       
select @fdate= min(remarksdate) from [196.1.115.215].DEMOTRANING.dbo.Training_info       
select @tdate= max(remarksdate) from [196.1.115.215].DEMOTRANING.dbo.Training_info       
--print @fdate       
--print @tdate      
       
select distinct name,partycode as party_code,REMARKSDATE as trainingdate,status into #file_training                          
from [196.1.115.215].DEMOTRANING.dbo.Training_info               
--where convert(datetime,REMARKSDATE,103) >=convert(datetime,@fdate,103)                
--and convert(datetime,REMARKSDATE,103) <=convert(datetime,@tdate,103)                        
                          
--select party_code,user_stat,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,brokerage,sauda_date=convert(datetime,sauda_date,103)                
-- into #brok_temp                 
--from mis_ebroking_cli (nolock)                
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays                 
------------------------------------------------------------------------------------------    
select party_code,terminal_id,ablcm_brk=(case when company='ABLCM' then sum(brokerage) end),    
acdlcm_brk=(case when company='ACDLCM' then sum(brokerage) end),    
acdlfo_brk=(case when company='ACDLFO' then sum(brokerage) end),    
mcx_brok=(case when company='ACPLMCX' then sum(brokerage) end),    
ncdx_brok=(case when company='ACPLNCDEX' then sum(brokerage) end),    
mcd_brok=(case when company='ACPLMCD' then sum(brokerage) end),    
brokerage=sum(brokerage),cnt=count(party_code),    
sauda_date=convert(datetime,sauda_date,103),Offline='Yes'              
into #brok_temp               
from mis_to (nolock)              
where sauda_date>=convert(datetime,@fdate,103)-@fdays     
and sauda_date<=convert(datetime,@tdate,103)+ @fdays    
group by party_code,company,sauda_date,terminal_id    
order by party_code     
    
    
--select top 5 party_code,terminal_id,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,sauda_date=convert(datetime,sauda_date,103),     
--Offline='Yes'    
----into #brok_temp  --select top 5 *                 
--from mis_to (nolock)    
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays                 
    
select segment,terminal_id,from_date,to_date into #ff from mis.remisior.dbo.ebrok_terminal_master    
    
update #brok_temp set Offline='No'  from #ff b where #brok_temp.terminal_id=b.terminal_id    
and #brok_temp.sauda_date>=b.from_date and #brok_temp.sauda_date<=b.to_date    
                
    
    
    
----------------------------------------------------------------------------------------    
    
select b.party_code,        
        
fbrokoff_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then ablcm_brk else 0 end,         
fbrokoff_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then acdlcm_brk else 0 end,         
fbrokoff_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then acdlfo_brk else 0 end,         
fbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then mcx_brok else 0 end,         
fbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then ncdx_brok else 0 end,     
fbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then mcd_brok else 0 end,             
fbrokoff_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then brokerage else 0 end,         
    
         
fbrokon_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then ablcm_brk else 0 end,            
fbrokon_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then acdlcm_brk else 0 end,             
fbrokon_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then acdlfo_brk else 0 end,             
fbrokon_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then mcx_brok else 0 end,             
fbrokon_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then ncdx_brok else 0 end,             
fbrokon_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then mcd_brok else 0 end,    
fbrokon_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then brokerage else 0 end,             
fcnton=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then 1 else 0 end,        
                    
tbrokoff_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then ablcm_brk else 0 end,                        
tbrokoff_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then acdlcm_brk else 0 end,                        
tbrokoff_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then acdlfo_brk else 0 end,                        
tbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then mcx_brok else 0 end,                        
tbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then ncdx_brok else 0 end,             
tbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then mcd_brok else 0 end,             
tbrokoff_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then brokerage else 0 end,             
                        
tbrokon_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then ablcm_brk else 0 end,                        
tbrokon_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then acdlcm_brk else 0 end,                        
tbrokon_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then acdlfo_brk else 0 end,                        
tbrokon_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then mcx_brok else 0 end,                        
tbrokon_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then ncdx_brok else 0 end,                        
tbrokon_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then mcd_brok else 0 end,                        
tbrokon_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then brokerage else 0 end,                        
tcnton=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then 1 else 0 end                        
        
into #file2                          
from   #file_training b left outer join #brok_temp  a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS                          
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays                         
group by b.party_code,a.sauda_date,b.trainingdate,a.ablcm_brk,a.acdlcm_brk,a.acdlfo_brk,a.mcx_brok,a.ncdx_brok,a.brokerage,a.offline,a.mcd_brok                        
                          
select party_code,        
fbrokoff_bse=sum(fbrokoff_bse),fbrokoff_nse=sum(fbrokoff_nse),fbrokoff_fo=sum(fbrokoff_fo),fbrokoff_mcx=sum(fbrokoff_mcx),        
fbrokoff_ncx=sum(fbrokoff_ncx),fbrokoff_mcd=sum(fbrokoff_mcd),fbrokoff_tot=sum(fbrokoff_tot),        
fbrokon_bse=sum(fbrokon_bse),fbrokon_nse=sum(fbrokon_nse),fbrokon_fo=sum(fbrokon_fo),fbrokon_mcx=sum(fbrokon_mcx),        
fbrokon_ncx=sum(fbrokon_ncx),fbrokon_mcd=sum(fbrokon_mcd),fbrokon_tot=sum(fbrokon_tot),fcnton=sum(fcnton),        
tbrokoff_bse=sum(tbrokoff_bse),tbrokoff_nse=sum(tbrokoff_nse),tbrokoff_fo=sum(tbrokoff_fo),tbrokoff_mcx=sum(tbrokoff_mcx),        
tbrokoff_ncx=sum(tbrokoff_ncx),tbrokoff_mcd=sum(tbrokoff_mcd),tbrokoff_tot=sum(tbrokoff_tot),        
tbrokon_bse=sum(tbrokon_bse),tbrokon_nse=sum(tbrokon_nse),tbrokon_fo=sum(tbrokon_fo),tbrokon_mcx=sum(tbrokon_mcx),        
tbrokon_ncx=sum(tbrokon_ncx),tbrokon_mcd=sum(tbrokon_mcd),tbrokon_tot=sum(tbrokon_tot),tcnton=sum(tcnton)        
into #file3 from #file2 group by party_code                          
                         
select distinct a.party_code,a.name,a.status,c.branch,c.region,c.zone,a.trainingdate,    
b.fbrokoff_bse as offline_before_bse,b.fbrokoff_nse as offline_before_nse,b.fbrokoff_fo as offline_before_fo,    
b.fbrokoff_mcx as offline_before_mcx,b.fbrokoff_ncx as offline_before_ncx,b.fbrokoff_mcd as offline_before_mcd ,b.fbrokoff_tot as offline_before_total,       
b.fbrokon_bse as online_before_bse,b.fbrokon_nse as online_before_nse,b.fbrokon_fo as online_before_fo,    
b.fbrokon_mcx as online_before_mcx,b.fbrokon_ncx as online_before_ncx,b.fbrokon_mcd as online_before_mcd,b.fbrokon_tot as online_before_tot,fcnton as online_before_logins,        
b.tbrokoff_bse as offline_after_bse,b.tbrokoff_nse as offline_after_nse,b.tbrokoff_fo as offline_after_fo,    
b.tbrokoff_mcx as offline_after_mcx,b.tbrokoff_ncx as offline_after_ncx,b.tbrokoff_mcd as offline_after_mcd,b.tbrokoff_tot as offline_after_total,        
b.tbrokon_bse as online_after_bse,b.tbrokon_nse as online_after_nse,b.tbrokon_fo as online_after_fo,    
b.tbrokon_mcx as online_after_mcx,b.tbrokon_ncx as online_after_ncx,b.tbrokon_mcd as online_after_mcd,b.tbrokon_tot as online_after_total,tcnton as online_after_logins into #f from #file3 b join #file_training a                        
on b.party_code=a.party_code         
join risk.dbo.Vw_RMS_Client_Vertical c (nolock) on b.party_code=c.client order by a.party_code                   
                      
--delete from mis.upload.dbo.ebrok_training_temp                  
select distinct * from #f            
        
set nocount oFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TrainingDate_temp
-- --------------------------------------------------
create  proc USP_TrainingDate_temp (@fdays as int)                      
as                      
set nocount on  
declare @fdate as varchar(25),@tdate as varchar(25)   
select @fdate= min(remarksdate) from [196.1.115.215].DEMOTRANING.dbo.Training_info   
select @tdate= max(remarksdate) from [196.1.115.215].DEMOTRANING.dbo.Training_info   
--print @fdate   
--print @tdate  
   
select distinct name,partycode as party_code,REMARKSDATE as trainingdate,status into #file_training                      
from [196.1.115.215].DEMOTRANING.dbo.Training_info           
--where convert(datetime,REMARKSDATE,103) >=convert(datetime,@fdate,103)            
--and convert(datetime,REMARKSDATE,103) <=convert(datetime,@tdate,103)                    
                      
select party_code,user_stat,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,sauda_date=convert(datetime,sauda_date,103)            
 into #brok_temp             
from mis_ebroking_cli (nolock)            
where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays             
            
select b.party_code,    
    
fbrokoff_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then ablcm_brk else 0 end,     
fbrokoff_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then acdlcm_brk else 0 end,     
fbrokoff_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then acdlfo_brk else 0 end,     
fbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then mcx_brok else 0 end,     
fbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat<>'e-broking' then ncdx_brok else 0 end,     
     
fbrokon_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then ablcm_brk else 0 end,        
fbrokon_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then acdlcm_brk else 0 end,         
fbrokon_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then acdlfo_brk else 0 end,         
fbrokon_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then mcx_brok else 0 end,         
fbrokon_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then ncdx_brok else 0 end,         
fcnton=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and user_stat='e-broking' then 1 else 0 end,    
                
tbrokoff_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat<>'e-broking'  then ablcm_brk else 0 end,                    
tbrokoff_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat<>'e-broking'  then acdlcm_brk else 0 end,                    
tbrokoff_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat<>'e-broking'  then acdlfo_brk else 0 end,                    
tbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat<>'e-broking'  then mcx_brok else 0 end,                    
tbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat<>'e-broking'  then ncdx_brok else 0 end,         
                    
tbrokon_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat='e-broking'  then ablcm_brk else 0 end,                    
tbrokon_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat='e-broking'  then acdlcm_brk else 0 end,                    
tbrokon_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat='e-broking'  then acdlfo_brk else 0 end,                    
tbrokon_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat='e-broking'  then mcx_brok else 0 end,                    
tbrokon_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat='e-broking'  then ncdx_brok else 0 end,                    
tcnton=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and user_stat='e-broking'  then 1 else 0 end                    
    
into #file2                      
from   #file_training b left outer join #brok_temp  a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS                      
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays                     
group by b.party_code,a.sauda_date,b.trainingdate,a.ablcm_brk,a.acdlcm_brk,a.acdlfo_brk,a.mcx_brok,a.ncdx_brok,a.user_stat                      
                      
select party_code,    
fbrokoff_bse=sum(fbrokoff_bse),fbrokoff_nse=sum(fbrokoff_nse),fbrokoff_fo=sum(fbrokoff_fo),fbrokoff_mcx=sum(fbrokoff_mcx),    
fbrokoff_ncx=sum(fbrokoff_ncx),    
fbrokon_bse=sum(fbrokon_bse),fbrokon_nse=sum(fbrokon_nse),fbrokon_fo=sum(fbrokon_fo),fbrokon_mcx=sum(fbrokon_mcx),    
fbrokon_ncx=sum(fbrokon_ncx),fcnton=sum(fcnton),    
tbrokoff_bse=sum(tbrokoff_bse),tbrokoff_nse=sum(tbrokoff_nse),tbrokoff_fo=sum(tbrokoff_fo),tbrokoff_mcx=sum(tbrokoff_mcx),    
tbrokoff_ncx=sum(tbrokoff_ncx),    
tbrokon_bse=sum(tbrokon_bse),tbrokon_nse=sum(tbrokon_nse),tbrokon_fo=sum(tbrokon_fo),tbrokon_mcx=sum(tbrokon_mcx),    
tbrokon_ncx=sum(tbrokon_ncx),tcnton=sum(tcnton)    
into #file3 from #file2 group by party_code                      
                     
select distinct a.party_code,a.name,a.status,c.branch,c.region,c.zone,a.trainingdate,b.fbrokoff_bse,b.fbrokoff_nse,b.fbrokoff_fo,b.fbrokoff_mcx,b.fbrokoff_ncx,    
b.fbrokon_bse,b.fbrokon_nse,b.fbrokon_fo,b.fbrokon_mcx,b.fbrokon_ncx,fcnton,    
b.tbrokoff_bse,b.tbrokoff_nse,b.tbrokoff_fo,b.tbrokoff_mcx,b.tbrokoff_ncx,    
b.tbrokon_bse,b.tbrokon_nse,b.tbrokon_fo,b.tbrokon_mcx,b.tbrokon_ncx,tcnton into #f from #file3 b join #file_training a                    
on b.party_code=a.party_code     
join risk.dbo.Vw_RMS_Client_Vertical c (nolock) on b.party_code=c.client order by a.party_code               
                  
--delete from mis.upload.dbo.ebrok_training_temp              
select distinct * from #f        
    
set nocount oFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TrainingDate1
-- --------------------------------------------------
CREATE  proc USP_TrainingDate1 (@fdays as int)                        
as                        
set nocount on    
declare @fdate as varchar(25),@tdate as varchar(25)     
select @fdate= min(remarksdate) from [196.1.115.215].DEMOTRANING.dbo.Training_info     
select @tdate= max(remarksdate) from [196.1.115.215].DEMOTRANING.dbo.Training_info     
--print @fdate     
--print @tdate    
     
select distinct name,partycode as party_code,REMARKSDATE as trainingdate,status into #file_training                        
from [196.1.115.215].DEMOTRANING.dbo.Training_info             
--where convert(datetime,REMARKSDATE,103) >=convert(datetime,@fdate,103)              
--and convert(datetime,REMARKSDATE,103) <=convert(datetime,@tdate,103)                      
                        
--select party_code,user_stat,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,brokerage,sauda_date=convert(datetime,sauda_date,103)              
-- into #brok_temp               
--from mis_ebroking_cli (nolock)              
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays               
------------------------------------------------------------------------------------------  
select party_code,terminal_id,ablcm_brk=(case when company='ABLCM' then sum(brokerage) end),  
acdlcm_brk=(case when company='ACDLCM' then sum(brokerage) end),  
acdlfo_brk=(case when company='ACDLFO' then sum(brokerage) end),  
mcx_brok=(case when company='ACPLMCX' then sum(brokerage) end),  
ncdx_brok=(case when company='ACPLNCDEX' then sum(brokerage) end),  
mcd_brok=(case when company='ACPLMCD' then sum(brokerage) end),  
brokerage=sum(brokerage),cnt=count(party_code),  
sauda_date=convert(datetime,sauda_date,103),Offline='Yes'            
into #brok_temp             
from mis_to (nolock)            
where sauda_date>=convert(datetime,@fdate,103)-@fdays   
and sauda_date<=convert(datetime,@tdate,103)+ @fdays  
group by party_code,company,sauda_date,terminal_id  
order by party_code   
  
  
--select top 5 party_code,terminal_id,ablcm_brk,acdlcm_brk,acdlfo_brk,mcx_brok,ncdx_brok,sauda_date=convert(datetime,sauda_date,103),   
--Offline='Yes'  
----into #brok_temp  --select top 5 *               
--from mis_to (nolock)  
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @fdays               
  
select segment,terminal_id,from_date,to_date into #ff from mis.remisior.dbo.ebrok_terminal_master  
  
update #brok_temp set Offline='No'  from #ff b where #brok_temp.terminal_id=b.terminal_id  
and #brok_temp.sauda_date>=b.from_date and #brok_temp.sauda_date<=b.to_date  
              
  
  
  
----------------------------------------------------------------------------------------  
  
select b.party_code,      
      
fbrokoff_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then ablcm_brk else 0 end,       
fbrokoff_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then acdlcm_brk else 0 end,       
fbrokoff_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then acdlfo_brk else 0 end,       
fbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then mcx_brok else 0 end,       
fbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then ncdx_brok else 0 end,   
fbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then mcd_brok else 0 end,           
fbrokoff_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='Yes' then brokerage else 0 end,       
  
       
fbrokon_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then ablcm_brk else 0 end,          
fbrokon_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then acdlcm_brk else 0 end,           
fbrokon_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then acdlfo_brk else 0 end,           
fbrokon_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then mcx_brok else 0 end,           
fbrokon_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then ncdx_brok else 0 end,           
fbrokon_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then mcd_brok else 0 end,  
fbrokon_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then brokerage else 0 end,           
fcnton=case when a.sauda_date>=convert(datetime,b.trainingdate,103)-@fdays and sauda_date<=convert(datetime,b.trainingdate,103) and Offline='No' then 1 else 0 end,      
                  
tbrokoff_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then ablcm_brk else 0 end,                      
tbrokoff_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then acdlcm_brk else 0 end,                      
tbrokoff_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then acdlfo_brk else 0 end,                      
tbrokoff_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then mcx_brok else 0 end,                      
tbrokoff_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then ncdx_brok else 0 end,           
tbrokoff_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then mcd_brok else 0 end,           
tbrokoff_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='Yes'  then brokerage else 0 end,           
                      
tbrokon_bse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then ablcm_brk else 0 end,                      
tbrokon_nse=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then acdlcm_brk else 0 end,                      
tbrokon_fo=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then acdlfo_brk else 0 end,                      
tbrokon_mcx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then mcx_brok else 0 end,                      
tbrokon_ncx=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then ncdx_brok else 0 end,                      
tbrokon_mcd=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then mcd_brok else 0 end,                      
tbrokon_tot=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then brokerage else 0 end,                      
tcnton=case when a.sauda_date>=convert(datetime,b.trainingdate,103) and sauda_date<=convert(datetime,b.trainingdate,103)+@fdays and Offline='No'  then 1 else 0 end                      
      
into #file2                        
from   #file_training b left outer join #brok_temp  a (nolock) on b.party_code=a.party_code collate SQL_Latin1_General_CP1_CI_AS                        
--where sauda_date>=convert(datetime,@fdate,103)-@fdays and sauda_date<=convert(datetime,@tdate,103)+ @tdays                       
group by b.party_code,a.sauda_date,b.trainingdate,a.ablcm_brk,a.acdlcm_brk,a.acdlfo_brk,a.mcx_brok,a.ncdx_brok,a.brokerage,a.offline,a.mcd_brok                      
                        
select party_code,      
fbrokoff_bse=sum(fbrokoff_bse),fbrokoff_nse=sum(fbrokoff_nse),fbrokoff_fo=sum(fbrokoff_fo),fbrokoff_mcx=sum(fbrokoff_mcx),      
fbrokoff_ncx=sum(fbrokoff_ncx),fbrokoff_mcd=sum(fbrokoff_mcd),fbrokoff_tot=sum(fbrokoff_tot),      
fbrokon_bse=sum(fbrokon_bse),fbrokon_nse=sum(fbrokon_nse),fbrokon_fo=sum(fbrokon_fo),fbrokon_mcx=sum(fbrokon_mcx),      
fbrokon_ncx=sum(fbrokon_ncx),fbrokon_mcd=sum(fbrokon_mcd),fbrokon_tot=sum(fbrokon_tot),fcnton=sum(fcnton),      
tbrokoff_bse=sum(tbrokoff_bse),tbrokoff_nse=sum(tbrokoff_nse),tbrokoff_fo=sum(tbrokoff_fo),tbrokoff_mcx=sum(tbrokoff_mcx),      
tbrokoff_ncx=sum(tbrokoff_ncx),tbrokoff_mcd=sum(tbrokoff_mcd),tbrokoff_tot=sum(tbrokoff_tot),      
tbrokon_bse=sum(tbrokon_bse),tbrokon_nse=sum(tbrokon_nse),tbrokon_fo=sum(tbrokon_fo),tbrokon_mcx=sum(tbrokon_mcx),      
tbrokon_ncx=sum(tbrokon_ncx),tbrokon_mcd=sum(tbrokon_mcd),tbrokon_tot=sum(tbrokon_tot),tcnton=sum(tcnton)      
into #file3 from #file2 group by party_code                        
                       
select distinct a.party_code,a.name,a.status,c.branch,c.region,c.zone,a.trainingdate,  
b.fbrokoff_bse as offline_before_bse,b.fbrokoff_nse as offline_before_nse,b.fbrokoff_fo as offline_before_fo,  
b.fbrokoff_mcx as offline_before_mcx,b.fbrokoff_ncx as offline_before_ncx,b.fbrokoff_mcd as offline_before_mcd ,b.fbrokoff_tot as offline_before_total,     
b.fbrokon_bse as online_before_bse,b.fbrokon_nse as online_before_nse,b.fbrokon_fo as online_before_fo,  
b.fbrokon_mcx as online_before_mcx,b.fbrokon_ncx as online_before_ncx,b.fbrokon_mcd as online_before_mcd,b.fbrokon_tot as online_before_tot,fcnton as online_before_logins,      
b.tbrokoff_bse as offline_after_bse,b.tbrokoff_nse as offline_after_nse,b.tbrokoff_fo as offline_after_fo,  
b.tbrokoff_mcx as offline_after_mcx,b.tbrokoff_ncx as offline_after_ncx,b.tbrokoff_mcd as offline_after_mcd,b.tbrokoff_tot as offline_after_total,      
b.tbrokon_bse as online_after_bse,b.tbrokon_nse as online_after_nse,b.tbrokon_fo as online_after_fo,  
b.tbrokon_mcx as online_after_mcx,b.tbrokon_ncx as online_after_ncx,b.tbrokon_mcd as online_after_mcd,b.tbrokon_tot as online_after_total,tcnton as online_after_logins into #f from #file3 b join #file_training a                      
on b.party_code=a.party_code       
join risk.dbo.Vw_RMS_Client_Vertical c (nolock) on b.party_code=c.client order by a.party_code                 
                    
--delete from mis.upload.dbo.ebrok_training_temp                
select distinct * from #f          
      
set nocount oFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_upuserinfo
-- --------------------------------------------------
create procedure usp_upuserinfo(@Party_Code nvarchar(10),@Party_name nvarchar(50),@aaa nvarchar(50),@bbb nvarchar(50),@ccc nvarchar(50),@ddd nvarchar(50),@dealer nvarchar(50),@location nvarchar(50),@odin nvarchar(50))
as
begin
set nocount on
set transaction isolation level repeatable read
declare @count int
	if exists(select * from uinfo)
		set @count=1
	else
		set @count=2

if @count=1
begin
	delete from uinfo 
	insert into uinfo(Party_Code,Party_name,aaa,bbb,ccc,ddd,dealer,location,odin)values(@Party_Code,@Party_name,@aaa,@bbb,@ccc,@ddd,@dealer,@location,@odin)
end
else
	 insert into uinfo(Party_Code,Party_name,aaa,bbb,ccc,ddd,dealer,location,odin)values(@Party_Code,@Party_name,@aaa,@bbb,@ccc,@ddd,@dealer,@location,@odin)
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VerifyAPCwithBPCBranch
-- --------------------------------------------------



--EXEC VerifyAPCwithBPC 'Oct 13 2005','Oct 13 2005'
--SELECT Count(*) FROM TradeAPC
--Truncate Table TradeAPC

CREATE PROCEDURE VerifyAPCwithBPCBranch
@StatusId Varchar(15),
@StatusName Varchar(25),
@FromDate DateTime,
@ToDate DateTime,
@FromBranch Varchar(25),
@ToBranch Varchar(25),
@ReportName  Varchar(20)

AS

Select @ToDate = @ToDate + ' 23:59:00'

If @FromBranch = '' Set @FromBranch = 'A'
If @ToBranch = '' Set @ToBranch = 'ZZZZZZZ'

If @StatusId = 'Branch'
Begin
     Set @FromBranch = @StatusName
     Set @ToBranch = @StatusName
End


/* If @ReportName = 'Detail'
Begin
         Select Branch_cd,BeforeParty = B.Party_Code,B.Order_no,A.Sauda_Date,A.Sauda_Time,A.Col02,
         AfterParty = A.Party_Code,B.Scrip_Cd,B.ScripName,B.Sell_buy,Sum(B.Quantity) as Quantity
         From Anand.Bsedb_ab.Dbo.Client1 C1,
         TradeAPC A JOIN TradeBPC B ON 
         ( A.Order_no=B.Order_no AND A.sell_buy=B.sell_buy And A.scrip_cd=B.Scrip_cd And A.Party_code<>B.Party_code 
           And A.Sauda_Date>=@FromDate  
           And A.Sauda_Date<=@ToDate
          )
          Where A.Party_code = C1.Cl_code  COLLATE Latin1_general_cs_as
          	And C1.branch_cd >= @FromBranch 
		And C1.branch_cd <= @ToBranch
	  Group By Branch_cd,B.Party_Code,B.Order_no,A.Party_code,B.Sell_buy ,B.Scrip_Cd,A.Order_no,B.ScripName,A.sauda_date,A.Sauda_Time,A.Col02
          ORDER BY Branch_Cd,A.Party_Code,B.Order_no
End
*/


If @ReportName = 'Detail'
Begin
Select Diff.Branch_Cd,BeforeParty,Bs.Order_no,Bs.Sauda_Date,Col02,
AfterParty = Bs.Party_code,Bs.Scrip_Cd,Bs.Scripname,
Bs.Sell_buy,
Quantity = Qs ,Remark = Isnull(Remark,'') 
From
( Select Scripname = ScripName,Col02 = Col02,Party_code = Party_code,
	 Scrip_cd = Scrip_Cd,Sauda_date = Sauda_date,Order_no = Order_no,
	 Qs = Sum(Quantity),Sell_buy ,Remark
  From Tradeapc Where
 Sauda_Date>=@FromDate
 And   Sauda_Date<=@Todate +' 23:59'
--And   Sauda_Date<=@Todate
 Group by Party_code,Order_no,Scrip_Cd,Sell_buy,Sauda_date,Col02,Scripname,Remark
) Bs,
(Select Branch_cd = Branch_cd,BeforeParty = B.Party_Code,a.Order_no,
	Sauda_date = A.Sauda_Date,AfterParty = A.Party_Code,A.Scrip_Cd,A.ScripName,
	A.Sell_buy  --,Sum(A.Quantity) as Quantity
              From Anand.Bsedb_ab.Dbo.Client1 C1,
              TradeAPC A JOIN TradeBPC B ON 
               ( A.Order_no=B.Order_no 
		 AND A.sell_buy=B.sell_buy 
		 And A.scrip_cd=B.Scrip_cd 
                 And A.Party_code<>B.Party_code 
                 And A.Sauda_Date>= @FromDate --'OCT 13 2005'  
                 And A.Sauda_Date<=@ToDate +' 23:59' --'OCT 13 2005 23:59'
		--   And A.Sauda_Date<=@ToDate
                )
                Where A.Party_code = C1.Cl_code  COLLATE Latin1_general_cs_as
		 And C1.branch_cd >= @FromBranch 
		 And C1.branch_cd <= @ToBranch 

                Group By Branch_cd,a.Party_Code,a.Order_no,b.Party_code,a.Sell_buy ,a.Scrip_Cd,A.Order_no,a.ScripName,A.sauda_date
) Diff
Where 
Ltrim(RTrim(Bs.PArty_code)) = Ltrim(Rtrim(Diff.AfterParty))
And
Bs.Order_no = Diff.Order_no
And
Bs.Sell_buy = Diff.Sell_buy
And Bs.Scrip_cd = Diff.Scrip_Cd
And Bs.Sauda_date = Diff.Sauda_date
Order By Diff.Branch_cd,Bs.AfterParty,Bs.Scrip_cd
End

If @ReportName = 'NoOrdersBranchWise'
Begin
          Select B.Branch_cd ,isNull(TotalOrders, 0) as TotalOrders,ChangedOrders From 
         ( Select Branch_Cd,ChangedOrders = Count(Order_No) From
            (
              Select Branch_cd = Branch_cd,BeforeParty = B.Party_Code,B.Order_no,
		     A.Sauda_Date,AfterParty = A.Party_Code,B.Scrip_Cd,B.ScripName,
		     B.Sell_buy,Sum(B.Quantity) as Quantity
              From Anand.Bsedb_ab.Dbo.Client1 C1,
              TradeAPC A JOIN TradeBPC B ON 
               ( A.Order_no=B.Order_no 
		 AND A.sell_buy=B.sell_buy 
		 And A.scrip_cd=B.Scrip_cd 
		 And A.Party_code<>B.Party_code 
                 And A.Sauda_Date>=@FromDate  
                 And A.Sauda_Date<=@ToDate
                )
                Where A.Party_code = C1.Cl_code  COLLATE Latin1_general_cs_as
		 And C1.branch_cd >= @FromBranch 
		 And C1.branch_cd <= @ToBranch 

                Group By Branch_cd,B.Party_Code,B.Order_no,A.Party_code,
			 B.Sell_buy ,B.Scrip_Cd,A.Order_no,B.ScripName,
			 A.sauda_date
              ) A        
	      Group By Branch_Cd  ) B,

              (Select Branch_Cd=Branch_Cd,TotalOrders = Count(Order_No) From
                TradeApc Ta,  Anand.Bsedb_ab.Dbo.Client1 C1
                Where Ta.Party_code  = C1.Cl_code COLLATE Latin1_general_cs_as
		And C1.branch_cd >= @FromBranch 
		And C1.branch_cd <= @ToBranch 
                And TA.Sauda_Date>=@FromDate  
                And TA.Sauda_Date<=@ToDate 
                 Group By Branch_Cd ) C
               Where B.Branch_cd = C.Branch_Cd           
End

If @ReportName = 'NoOrders'
Begin
         Select ChangedOrders = Count(OrNo), TotOrder = max(TotalOrder) From
         (          
         Select Branch_cd,BeforeParty = B.Party_Code,B.Order_no as OrNo,A.Sauda_Date,
         AfterParty = A.Party_Code,B.Scrip_Cd,B.ScripName,B.Sell_buy,
	 Sum(B.Quantity) as Quantity
         From Anand.Bsedb_ab.Dbo.Client1 C1,
         TradeAPC A JOIN TradeBPC B ON 
         ( A.Order_no=B.Order_no 
	   AND A.sell_buy=B.sell_buy 
	   And A.scrip_cd=B.Scrip_cd 
	   And A.Party_code<>B.Party_code 
           And A.Sauda_Date>=@FromDate  
           And A.Sauda_Date<=@ToDate
          )
          Where A.Party_code = C1.Cl_code  COLLATE Latin1_general_cs_as
		And C1.Branch_cd >= @FromBranch 
		And C1.Branch_cd <= @ToBranch 
          Group By Branch_cd,B.Party_Code,B.Order_no,A.Party_code,
		   B.Sell_buy ,B.Scrip_Cd,A.Order_no,B.ScripName,A.sauda_date
         ) C,
	(
	 SELECT COUNT(order_no)as TotalOrder
	 from TradeAPC Tp, Anand.Bsedb_ab.Dbo.Client1 C1 
	 where Tp.sauda_date between @FromDate and @ToDate
	 and Tp.party_code = C1.cl_code COLLATE Latin1_general_cs_as
	 And C1.Branch_cd >= @FromBranch 
 	 And C1.Branch_cd <= @ToBranch 
	)D
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VerifyTradePartyCode
-- --------------------------------------------------







-- =============================================
-- ALTER  procedure basic template
-- =============================================
-- creating the store procedure
CREATE       PROCEDURE [dbo].[VerifyTradePartyCode] --'oct 17 2005', 'oct 17 2005', 'Broker',''
@FromDate as datetime,
@ToDate as datetime,
@StatusId Varchar(15),
@StatusName Varchar(25),
@strFromBranch varchar(25),
@strToBranch Varchar(25)



 --@ReportName varchar(25)	
AS
	Select @ToDate = @Todate+ ' 23:59:00'
	--declare @FromBranch Varchar(25)
	--declare @ToBranch Varchar(25)

If @strFromBranch = '' Set @strFromBranch = 'A'
If @strToBranch = '' Set @strToBranch = 'ZZZZZZZ'

If @StatusId = 'Branch'
Begin
     Set @strFromBranch = @StatusName
     Set @strToBranch = @StatusName
End


begin	
	--if @ReportName = ''	
	SELECT tbl1.Trade_No as tradeNo, tbl1.Party_Code as aPartyCode, tbl1.Status, 
	         tbl1.Inst_Type, tbl1.Symbol, tbl1.Strike_price, 
	         tbl1.TradeQty, tbl1.Price, tbl1.Order_No, tbl1.Sell_Buy,
		 tbl1.Last_Mod_time as LastModDate, tbl1.Branch_Id, tbl2.party_code as bPartyCode,
		 tbl2.status as aStatus, C1.branch_cd as BranchCd, tbl1.remark as Remark,
		 tbl1.expiryDate as Expirydate, tbl1.Option_type, tbl1.ActivityTime
	FROM  AngelBSECM.Bsedb_ab.Dbo.Client1 C1,angelfotrade tbl1
	INNER JOIN angelfotradeBefore tbl2 ON 
		    tbl1.trade_no = tbl2.trade_no 
		AND tbl1.status <> tbl2.status
		AND tbl1.ActivityTime >= @FromDate
		AND tbl1.ActivityTime <= @ToDate
		
	WHERE
		    tbl1.Party_Code = C1.cl_code COLLATE Latin1_general_cs_as
		AND C1.branch_cd >= @strFromBranch 
		And C1.branch_cd <= @strToBranch 	

	ORDER BY tradeNo
End
--dump transaction risk with no_log
 -- execute VerifyTradePartyCode
--select * from angelfotrade where trade_no = 105271

GO

-- --------------------------------------------------
-- PROCEDURE dbo.version_modified_file_info
-- --------------------------------------------------
CREATE procedure [dbo].[version_modified_file_info]
AS
declare @k as int,@j as int    
declare @ip as varchar(30),@i as varchar(11),@j_ip as varchar(11),@ip_code as int,@ip_k as varchar(30),@ip_count as int    
select @k=count(distinct regioncode) from AngelNseCM.msajag.dbo.region    
--print @k    
--print @ip_count    
select fld_DB_ip     
into #temp_ip     
from mis.helpdesk.dbo.tbl_server_master where fld_DB_ip <> ''    
    
select distinct regioncode     
into #temp     
from AngelNseCM.msajag.dbo.region     
--print @k     
truncate table roz 
while (@k) > 0            
BEGIN     
BEGIN     
declare @reg_code as varchar(20)        
select distinct @reg_code=replace(regioncode,' ','') from(        
SELECT ROW_NUMBER()         
OVER (order by regioncode) AS Row,regioncode         
FROM #temp) AS reg where Row=@k    
--print @reg_code    
select @ip_count=count(fld_DB_ip) from mis.helpdesk.dbo.tbl_server_master  where fld_DB_ip <> ''    
    
    while (@ip_count) > 0            
    BEGIN     
    BEGIN         
    select @ip_k=fld_DB_ip from(        
    SELECT ROW_NUMBER()         
    OVER (order by fld_DB_ip) AS Row,fld_DB_ip         
    FROM #temp_ip) AS reg where Row=@ip_count    
    --print @ip_k    
    set @i=1    
    set @i=substring(@ip_k,charindex('.',@ip_k)+1,len(@ip_k))    
    --print @i    
    set @j_ip=substring(@i,    
    charindex('.',    
    @i)+1,len(@i))    
    --print @j    
    set @ip_code= substring(@j_ip,    
    charindex('.',    
    @j_ip)+1,len(@j_ip))    
    declare @str as varchar(200) ,@result as varchar(11)    
    set @str='declare @result as int'     
--    print  @reg_code    
--    print @ip_code    
    set @str=@str+' exec @result=MASTER.dbo.xp_cmdshell ''dir \\INHOUSEALLAPP-FS.angelone.in\D$\upload1\VerCtrl\'+@reg_code+'\'+convert(varchar(4),@ip_code)+'Mgr\'+convert(varchar(4),@ip_code)+'Mgr.txt'', NO_OUTPUT'                                              
    set @str=@str+' select Result=@result '    
    create table #temp1(status int)    
    insert into #temp1                              
    exec(@str)                                              
    select @result=status from #temp1  
print @result    
if(@result = '0')    
begin  
declare @fname as varchar(500),@str_temp as varchar(200)    
set @fname=' exec MASTER.dbo.xp_cmdshell ''dir \\INHOUSEALLAPP-FS.angelone.in\D$\upload1\VerCtrl\'+@reg_code+'\'+convert(varchar(4),@ip_code)+'Mgr\'+convert(varchar(4),@ip_code)+'Mgr.txt'''     
--print @fname   truncate table tmp1   
create table #tmp1 (mdate varchar(8000))
--create table roz (mgr_code varchar(10),mod_date varchar(20),corr_date varchar(20))
insert #tmp1
exec(@fname)
;
						with rozina as 
						(select * ,row_number() over (order by mdate) as id from #tmp1)
						select  mgr_code=@ip_code,mod_date=convert(varchar(11),convert(datetime,substring(mdate,1,11)),103),corr_date=convert(varchar(11),getdate(),103) into #data from rozina where id=9
						drop table #tmp1
insert into roz
select * from #data
--						if((select count(*) from #data where mod_date=corr_date) = 0)
--						print @ip_code
--						else
--						print @ip_code
						drop table #data

--select * from roz

end    
                    --print @result     
    drop table #temp1    
    set @ip_count=@ip_count-1    
    end    
    --print @ip_code    
    --print @k    
    --print @reg_code    
    end     
  set @k=@k-1     
end     
end

GO

-- --------------------------------------------------
-- TABLE dbo._ClientQuestionAnswer
-- --------------------------------------------------
CREATE TABLE [dbo].[_ClientQuestionAnswer]
(
    [QID] INT IDENTITY(1,1) NOT NULL,
    [Question] VARCHAR(2000) NULL,
    [Answer] VARCHAR(2000) NULL,
    [QDate] DATETIME NULL,
    [ADate] DATETIME NULL,
    [Source] VARCHAR(500) NULL,
    [Status] BIT NULL DEFAULT 0,
    [Client_Code] VARCHAR(10) NOT NULL,
    [Client_Name] VARCHAR(100) NULL,
    [AnswerSubmittedBy] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.01082006USERS-ver6
-- --------------------------------------------------
CREATE TABLE [dbo].[01082006USERS-ver6]
(
    [Col001] VARCHAR(255) NULL,
    [Col002] VARCHAR(255) NULL,
    [Col003] VARCHAR(255) NULL,
    [Col004] VARCHAR(255) NULL,
    [Col005] VARCHAR(255) NULL,
    [Col006] VARCHAR(255) NULL,
    [Col007] VARCHAR(255) NULL,
    [Col008] VARCHAR(255) NULL,
    [Col009] VARCHAR(255) NULL,
    [Col010] VARCHAR(255) NULL,
    [Col011] VARCHAR(255) NULL,
    [Col012] VARCHAR(255) NULL,
    [Col013] VARCHAR(255) NULL,
    [Col014] VARCHAR(255) NULL,
    [Col015] VARCHAR(255) NULL,
    [Col016] VARCHAR(255) NULL,
    [Col017] VARCHAR(255) NULL,
    [Col018] VARCHAR(255) NULL,
    [Col019] VARCHAR(255) NULL,
    [Col020] VARCHAR(255) NULL,
    [Col021] VARCHAR(255) NULL,
    [Col022] VARCHAR(255) NULL,
    [Col023] VARCHAR(255) NULL,
    [Col024] VARCHAR(255) NULL,
    [Col025] VARCHAR(255) NULL,
    [Col026] VARCHAR(255) NULL,
    [Col027] VARCHAR(255) NULL,
    [Col028] VARCHAR(255) NULL,
    [Col029] VARCHAR(255) NULL,
    [Col030] VARCHAR(255) NULL,
    [Col031] VARCHAR(255) NULL,
    [Col032] VARCHAR(255) NULL,
    [Col033] VARCHAR(255) NULL,
    [Col034] VARCHAR(255) NULL,
    [Col035] VARCHAR(255) NULL,
    [Col036] VARCHAR(255) NULL,
    [Col037] VARCHAR(255) NULL,
    [Col038] VARCHAR(255) NULL,
    [Col039] VARCHAR(255) NULL,
    [Col040] VARCHAR(255) NULL,
    [Col041] VARCHAR(255) NULL,
    [Col042] VARCHAR(255) NULL,
    [Col043] VARCHAR(255) NULL,
    [Col044] VARCHAR(255) NULL,
    [Col045] VARCHAR(255) NULL,
    [Col046] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.4Maping
-- --------------------------------------------------
CREATE TABLE [dbo].[4Maping]
(
    [Col001] VARCHAR(255) NULL,
    [Col002] VARCHAR(255) NULL,
    [Col003] VARCHAR(255) NULL,
    [Col004] VARCHAR(255) NULL,
    [Col005] VARCHAR(255) NULL,
    [Col006] VARCHAR(255) NULL,
    [Col007] VARCHAR(255) NULL,
    [Col008] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.aaa
-- --------------------------------------------------
CREATE TABLE [dbo].[aaa]
(
    [branch_Cd] VARCHAR(10) NULL,
    [branch_name] VARCHAR(100) NULL,
    [NCurrgross_perday] MONEY NULL,
    [NCurrNet_perday] MONEY NULL,
    [MCurrgross_perday] MONEY NULL,
    [MCurrNet_perday] MONEY NULL,
    [NLastgross_perday] MONEY NULL,
    [NLastnet_aperday] MONEY NULL,
    [MLastgross_perday] MONEY NULL,
    [MLastnet_aperday] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AAAAA
-- --------------------------------------------------
CREATE TABLE [dbo].[AAAAA]
(
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [TmonthNo] INT NULL,
    [Tmonth] NVARCHAR(30) NULL,
    [TYear] NVARCHAR(30) NULL,
    [Turnover] MONEY NOT NULL,
    [Brokerage] MONEY NOT NULL,
    [grade] VARCHAR(5) NOT NULL,
    [Status] VARCHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACM_CL
-- --------------------------------------------------
CREATE TABLE [dbo].[ACM_CL]
(
    [Party_code] NVARCHAR(255) NULL,
    [EX] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acm_client
-- --------------------------------------------------
CREATE TABLE [dbo].[acm_client]
(
    [Party_code] NVARCHAR(255) NULL,
    [F2] NVARCHAR(255) NULL,
    [F3] NVARCHAR(255) NULL,
    [F4] NVARCHAR(255) NULL,
    [F5] NVARCHAR(255) NULL,
    [F6] NVARCHAR(255) NULL,
    [F7] NVARCHAR(255) NULL,
    [F8] NVARCHAR(255) NULL,
    [F9] NVARCHAR(255) NULL,
    [F10] NVARCHAR(255) NULL,
    [F11] NVARCHAR(255) NULL,
    [F12] NVARCHAR(255) NULL,
    [F13] NVARCHAR(255) NULL,
    [F14] NVARCHAR(255) NULL,
    [F15] NVARCHAR(255) NULL,
    [F16] NVARCHAR(255) NULL,
    [F17] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL,
    [F45] NVARCHAR(255) NULL,
    [F46] NVARCHAR(255) NULL,
    [F47] NVARCHAR(255) NULL,
    [F48] NVARCHAR(255) NULL,
    [F49] NVARCHAR(255) NULL,
    [F50] NVARCHAR(255) NULL,
    [F51] NVARCHAR(255) NULL,
    [F52] NVARCHAR(255) NULL,
    [F53] NVARCHAR(255) NULL,
    [F54] NVARCHAR(255) NULL,
    [F55] NVARCHAR(255) NULL,
    [F56] NVARCHAR(255) NULL,
    [F57] NVARCHAR(255) NULL,
    [F58] NVARCHAR(255) NULL,
    [F59] NVARCHAR(255) NULL,
    [F60] NVARCHAR(255) NULL,
    [F61] NVARCHAR(255) NULL,
    [F62] NVARCHAR(255) NULL,
    [F63] NVARCHAR(255) NULL,
    [F64] NVARCHAR(255) NULL,
    [F65] NVARCHAR(255) NULL,
    [F66] NVARCHAR(255) NULL,
    [F67] NVARCHAR(255) NULL,
    [F68] NVARCHAR(255) NULL,
    [F69] NVARCHAR(255) NULL,
    [F70] NVARCHAR(255) NULL,
    [F71] NVARCHAR(255) NULL,
    [F72] NVARCHAR(255) NULL,
    [F73] NVARCHAR(255) NULL,
    [F74] NVARCHAR(255) NULL,
    [F75] NVARCHAR(255) NULL,
    [F76] NVARCHAR(255) NULL,
    [F77] NVARCHAR(255) NULL,
    [F78] NVARCHAR(255) NULL,
    [F79] NVARCHAR(255) NULL,
    [F80] NVARCHAR(255) NULL,
    [F81] NVARCHAR(255) NULL,
    [F82] NVARCHAR(255) NULL,
    [F83] NVARCHAR(255) NULL,
    [F84] NVARCHAR(255) NULL,
    [F85] NVARCHAR(255) NULL,
    [F86] NVARCHAR(255) NULL,
    [F87] NVARCHAR(255) NULL,
    [F88] NVARCHAR(255) NULL,
    [F89] NVARCHAR(255) NULL,
    [F90] NVARCHAR(255) NULL,
    [F91] NVARCHAR(255) NULL,
    [F92] NVARCHAR(255) NULL,
    [F93] NVARCHAR(255) NULL,
    [F94] NVARCHAR(255) NULL,
    [F95] NVARCHAR(255) NULL,
    [F96] NVARCHAR(255) NULL,
    [F97] NVARCHAR(255) NULL,
    [F98] NVARCHAR(255) NULL,
    [F99] NVARCHAR(255) NULL,
    [F100] NVARCHAR(255) NULL,
    [F101] NVARCHAR(255) NULL,
    [F102] NVARCHAR(255) NULL,
    [F103] NVARCHAR(255) NULL,
    [F104] NVARCHAR(255) NULL,
    [F105] NVARCHAR(255) NULL,
    [F106] NVARCHAR(255) NULL,
    [F107] NVARCHAR(255) NULL,
    [F108] NVARCHAR(255) NULL,
    [F109] NVARCHAR(255) NULL,
    [F110] NVARCHAR(255) NULL,
    [F111] NVARCHAR(255) NULL,
    [F112] NVARCHAR(255) NULL,
    [F113] NVARCHAR(255) NULL,
    [F114] NVARCHAR(255) NULL,
    [F115] NVARCHAR(255) NULL,
    [F116] NVARCHAR(255) NULL,
    [F117] NVARCHAR(255) NULL,
    [F118] NVARCHAR(255) NULL,
    [F119] NVARCHAR(255) NULL,
    [F120] NVARCHAR(255) NULL,
    [F121] NVARCHAR(255) NULL,
    [F122] NVARCHAR(255) NULL,
    [F123] NVARCHAR(255) NULL,
    [F124] NVARCHAR(255) NULL,
    [F125] NVARCHAR(255) NULL,
    [F126] NVARCHAR(255) NULL,
    [F127] NVARCHAR(255) NULL,
    [F128] NVARCHAR(255) NULL,
    [F129] NVARCHAR(255) NULL,
    [F130] NVARCHAR(255) NULL,
    [F131] NVARCHAR(255) NULL,
    [F132] NVARCHAR(255) NULL,
    [F133] NVARCHAR(255) NULL,
    [F134] NVARCHAR(255) NULL,
    [F135] NVARCHAR(255) NULL,
    [F136] NVARCHAR(255) NULL,
    [F137] NVARCHAR(255) NULL,
    [F138] NVARCHAR(255) NULL,
    [F139] NVARCHAR(255) NULL,
    [F140] NVARCHAR(255) NULL,
    [F141] NVARCHAR(255) NULL,
    [F142] NVARCHAR(255) NULL,
    [F143] NVARCHAR(255) NULL,
    [F144] NVARCHAR(255) NULL,
    [F145] NVARCHAR(255) NULL,
    [F146] NVARCHAR(255) NULL,
    [F147] NVARCHAR(255) NULL,
    [F148] NVARCHAR(255) NULL,
    [F149] NVARCHAR(255) NULL,
    [F150] NVARCHAR(255) NULL,
    [F151] NVARCHAR(255) NULL,
    [F152] NVARCHAR(255) NULL,
    [F153] NVARCHAR(255) NULL,
    [F154] NVARCHAR(255) NULL,
    [F155] NVARCHAR(255) NULL,
    [F156] NVARCHAR(255) NULL,
    [F157] NVARCHAR(255) NULL,
    [F158] NVARCHAR(255) NULL,
    [F159] NVARCHAR(255) NULL,
    [F160] NVARCHAR(255) NULL,
    [F161] NVARCHAR(255) NULL,
    [F162] NVARCHAR(255) NULL,
    [F163] NVARCHAR(255) NULL,
    [F164] NVARCHAR(255) NULL,
    [F165] NVARCHAR(255) NULL,
    [F166] NVARCHAR(255) NULL,
    [F167] NVARCHAR(255) NULL,
    [F168] NVARCHAR(255) NULL,
    [F169] NVARCHAR(255) NULL,
    [F170] NVARCHAR(255) NULL,
    [F171] NVARCHAR(255) NULL,
    [F172] NVARCHAR(255) NULL,
    [F173] NVARCHAR(255) NULL,
    [F174] NVARCHAR(255) NULL,
    [F175] NVARCHAR(255) NULL,
    [F176] NVARCHAR(255) NULL,
    [F177] NVARCHAR(255) NULL,
    [F178] NVARCHAR(255) NULL,
    [F179] NVARCHAR(255) NULL,
    [F180] NVARCHAR(255) NULL,
    [F181] NVARCHAR(255) NULL,
    [F182] NVARCHAR(255) NULL,
    [F183] NVARCHAR(255) NULL,
    [F184] NVARCHAR(255) NULL,
    [F185] NVARCHAR(255) NULL,
    [F186] NVARCHAR(255) NULL,
    [F187] NVARCHAR(255) NULL,
    [F188] NVARCHAR(255) NULL,
    [F189] NVARCHAR(255) NULL,
    [F190] NVARCHAR(255) NULL,
    [F191] NVARCHAR(255) NULL,
    [F192] NVARCHAR(255) NULL,
    [F193] NVARCHAR(255) NULL,
    [F194] NVARCHAR(255) NULL,
    [F195] NVARCHAR(255) NULL,
    [F196] NVARCHAR(255) NULL,
    [F197] NVARCHAR(255) NULL,
    [F198] NVARCHAR(255) NULL,
    [F199] NVARCHAR(255) NULL,
    [F200] NVARCHAR(255) NULL,
    [F201] NVARCHAR(255) NULL,
    [F202] NVARCHAR(255) NULL,
    [F203] NVARCHAR(255) NULL,
    [F204] NVARCHAR(255) NULL,
    [F205] NVARCHAR(255) NULL,
    [F206] NVARCHAR(255) NULL,
    [F207] NVARCHAR(255) NULL,
    [F208] NVARCHAR(255) NULL,
    [F209] NVARCHAR(255) NULL,
    [F210] NVARCHAR(255) NULL,
    [F211] NVARCHAR(255) NULL,
    [F212] NVARCHAR(255) NULL,
    [F213] NVARCHAR(255) NULL,
    [F214] NVARCHAR(255) NULL,
    [F215] NVARCHAR(255) NULL,
    [F216] NVARCHAR(255) NULL,
    [F217] NVARCHAR(255) NULL,
    [F218] NVARCHAR(255) NULL,
    [F219] NVARCHAR(255) NULL,
    [F220] NVARCHAR(255) NULL,
    [F221] NVARCHAR(255) NULL,
    [F222] NVARCHAR(255) NULL,
    [F223] NVARCHAR(255) NULL,
    [F224] NVARCHAR(255) NULL,
    [F225] NVARCHAR(255) NULL,
    [F226] NVARCHAR(255) NULL,
    [F227] NVARCHAR(255) NULL,
    [F228] NVARCHAR(255) NULL,
    [F229] NVARCHAR(255) NULL,
    [F230] NVARCHAR(255) NULL,
    [F231] NVARCHAR(255) NULL,
    [F232] NVARCHAR(255) NULL,
    [F233] NVARCHAR(255) NULL,
    [F234] NVARCHAR(255) NULL,
    [F235] NVARCHAR(255) NULL,
    [F236] NVARCHAR(255) NULL,
    [F237] NVARCHAR(255) NULL,
    [F238] NVARCHAR(255) NULL,
    [F239] NVARCHAR(255) NULL,
    [F240] NVARCHAR(255) NULL,
    [F241] NVARCHAR(255) NULL,
    [F242] NVARCHAR(255) NULL,
    [F243] NVARCHAR(255) NULL,
    [F244] NVARCHAR(255) NULL,
    [F245] NVARCHAR(255) NULL,
    [F246] NVARCHAR(255) NULL,
    [F247] NVARCHAR(255) NULL,
    [F248] NVARCHAR(255) NULL,
    [F249] NVARCHAR(255) NULL,
    [F250] NVARCHAR(255) NULL,
    [F251] NVARCHAR(255) NULL,
    [F252] NVARCHAR(255) NULL,
    [F253] NVARCHAR(255) NULL,
    [F254] NVARCHAR(255) NULL,
    [F255] NVARCHAR(255) NULL,
    [F256] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.active_cl_12mar
-- --------------------------------------------------
CREATE TABLE [dbo].[active_cl_12mar]
(
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ANGEL_ROI
-- --------------------------------------------------
CREATE TABLE [dbo].[ANGEL_ROI]
(
    [Branch] VARCHAR(50) NULL,
    [Sub_Broker] NCHAR(10) NULL,
    [Client_Name] VARCHAR(200) NULL,
    [Party_code] VARCHAR(50) NULL,
    [BSECM_TRD_TO] MONEY NULL,
    [BSECM_DEL_TO] MONEY NULL,
    [BSECM_Trd_Gross] MONEY NULL,
    [BSECM_DEL_Gross] MONEY NULL,
    [BSECM_Trd_Net] MONEY NULL,
    [BSECM_DEL_Net] MONEY NULL,
    [NSECM_TRD_TO] MONEY NULL,
    [NSECM_DEL_TO] MONEY NULL,
    [NSECM_Trd_Gross] MONEY NULL,
    [NSECM_DEL_Gross] MONEY NULL,
    [NSECM_Trd_Net] MONEY NULL,
    [NSECM_DEL_Net] MONEY NULL,
    [NSEFO_TO] MONEY NULL,
    [NSEFO_Gross] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCX_TO] MONEY NULL,
    [MCX_Gross] MONEY NULL,
    [MCX_Net] MONEY NULL,
    [NCDEX_TO] MONEY NULL,
    [NCDEX_Gross] MONEY NULL,
    [NCDEX_Net] MONEY NULL,
    [TOTAL_TO] MONEY NULL,
    [TOTAL_Gross] MONEY NULL,
    [TOTAL_Net] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angel_slab_diff
-- --------------------------------------------------
CREATE TABLE [dbo].[angel_slab_diff]
(
    [segment] VARCHAR(6) NOT NULL,
    [branch_Cd] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NOT NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [table_no] VARCHAR(5) NOT NULL,
    [lower_lim] NUMERIC(10, 2) NULL,
    [upper_lim] MONEY NULL,
    [day_puc] NUMERIC(10, 6) NULL,
    [val_perc] CHAR(1) NULL,
    [scheme_type] VARCHAR(5) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AngelClientSummary
-- --------------------------------------------------
CREATE TABLE [dbo].[AngelClientSummary]
(
    [Party_code] VARCHAR(50) NULL,
    [Long_name] VARCHAR(100) NULL,
    [Res_Phone1] VARCHAR(50) NULL,
    [BseLedger] MONEY NULL,
    [NseLedger] MONEY NULL,
    [NseFoLedger] MONEY NULL,
    [MarginDate] SMALLDATETIME NULL,
    [NseFoLastBillDate] SMALLDATETIME NULL,
    [NseFoBillAmount] MONEY NULL,
    [Cash_coll] MONEY NULL,
    [NonCash_coll] MONEY NULL,
    [InitialMArgin] MONEY NULL,
    [MtmMargin] MONEY NULL,
    [BseCashDeposit] MONEY NULL,
    [NseCashDeposit] MONEY NULL,
    [NSeFoCashDeposit] MONEY NULL,
    [BSELastCDate] SMALLDATETIME NULL,
    [BseLastCheque] MONEY NULL,
    [NSELastCDate] SMALLDATETIME NULL,
    [NseLastCheque] MONEY NULL,
    [NSEFoLastCDate] SMALLDATETIME NULL,
    [NseFoLastCheque] MONEY NULL,
    [BseLastBillDate] SMALLDATETIME NULL,
    [BseLastBillAmt] MONEY NULL,
    [NseLastBillDate] SMALLDATETIME NULL,
    [NseLastBillAmt] MONEY NULL,
    [Bse_Hold] MONEY NULL,
    [Nse_Hold] MONEY NULL,
    [FOPL] MONEY NULL,
    [BseSett_no] VARCHAR(50) NULL,
    [NseSett_no] VARCHAR(50) NULL,
    [Risk] MONEY NULL,
    [Approved] MONEY NULL,
    [NonApproved] MONEY NULL,
    [BsePayinShortage] MONEY NULL,
    [NsePayinShortage] MONEY NULL,
    [ABranch_cd] VARCHAR(50) NULL,
    [ASub_Broker] VARCHAR(50) NULL,
    [QStatus] VARCHAR(50) NULL,
    [ReportDate] SMALLDATETIME NULL,
    [RiskDate] SMALLDATETIME NULL,
    [ProcId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AngelDPC
-- --------------------------------------------------
CREATE TABLE [dbo].[AngelDPC]
(
    [BOID] VARCHAR(16) NULL,
    [ISIN] VARCHAR(12) NULL,
    [Free_Bal] INT NULL,
    [Curr_Bal] INT NULL,
    [Freeze_Bal] INT NULL,
    [Lockin_Bal] INT NULL,
    [Pledge_Bal] INT NULL,
    [Dpv_Bal] INT NULL,
    [Dpc_Bal] INT NULL,
    [Rpc_Bal] INT NULL,
    [Elim_Bal] INT NULL,
    [Earmark_Bal] INT NULL,
    [Remlock_Bal] INT NULL,
    [FileDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelfotrade
-- --------------------------------------------------
CREATE TABLE [dbo].[angelfotrade]
(
    [Trade_No] VARCHAR(20) NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] VARCHAR(15) NULL,
    [Strike_price] MONEY NULL DEFAULT 0,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [BookType] VARCHAR(2) NULL,
    [BookTypeName] VARCHAR(3) NULL,
    [MarKetType] VARCHAR(2) NULL,
    [User_Id] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] MONEY NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [membercode] VARCHAR(10) NULL,
    [Remark] VARCHAR(50) NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelfotradeBefore
-- --------------------------------------------------
CREATE TABLE [dbo].[angelfotradeBefore]
(
    [Trade_No] VARCHAR(20) NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] VARCHAR(15) NULL,
    [Strike_price] MONEY NULL DEFAULT 0,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [BookType] VARCHAR(2) NULL,
    [BookTypeName] VARCHAR(3) NULL,
    [MarKetType] VARCHAR(2) NULL,
    [User_Id] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] MONEY NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [membercode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelfotradeInter
-- --------------------------------------------------
CREATE TABLE [dbo].[angelfotradeInter]
(
    [Trade_No] VARCHAR(20) NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] VARCHAR(15) NULL,
    [Strike_price] MONEY NULL DEFAULT 0,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [BookType] VARCHAR(2) NULL,
    [BookTypeName] VARCHAR(3) NULL,
    [MarKetType] VARCHAR(2) NULL,
    [User_Id] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] MONEY NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [membercode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AngelKycCharges
-- --------------------------------------------------
CREATE TABLE [dbo].[AngelKycCharges]
(
    [Party_Code] CHAR(10) NULL,
    [Sub_broker] CHAR(10) NULL,
    [Branch_cd] CHAR(10) NULL,
    [BseRegStamp] SMALLMONEY NULL,
    [NseRegStamp] SMALLMONEY NULL,
    [NseFoRegStamp] SMALLMONEY NULL,
    [McdxRegStamp] SMALLMONEY NULL,
    [NcdxRegStamp] SMALLMONEY NULL,
    [JvGenDate] SMALLDATETIME NULL,
    [Processor] CHAR(10) NULL,
    [RegSb] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AngelTermBrok
-- --------------------------------------------------
CREATE TABLE [dbo].[AngelTermBrok]
(
    [Party_code] CHAR(10) NULL,
    [BrokScheme] SMALLINT NULL,
    [Table_no] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [P_To_P] SMALLINT NULL,
    [Sb_TableNo] SMALLINT NULL,
    [AlBmCf_TableNo] SMALLINT NULL,
    [Terminalnumber] CHAR(10) NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ARPCCLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[ARPCCLIENT]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [SAUDADATE] DATETIME NULL,
    [BROKERAGE] MONEY NULL,
    [NO_OF_TRADED_DAYS] INT NULL,
    [ARPC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_July_brok
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_July_brok]
(
    [Rid] VARCHAR(255) NULL,
    [Party Code] VARCHAR(255) NULL,
    [Party Name] VARCHAR(255) NULL,
    [From dt.] VARCHAR(255) NULL,
    [To dt.] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BackupTempNumb
-- --------------------------------------------------
CREATE TABLE [dbo].[BackupTempNumb]
(
    [Sauda_date] VARCHAR(20) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [Orders] INT NULL,
    [Trades] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_tradeanywhere_master
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_tradeanywhere_master]
(
    [Client_code] VARCHAR(50) NULL,
    [Client_lock_st] VARCHAR(50) NULL,
    [Pwd_Lock_st] VARCHAR(50) NULL,
    [Source] VARCHAR(50) NULL,
    [Loggedin_Source] VARCHAR(50) NULL,
    [login_id] VARCHAR(50) NULL,
    [Branch] VARCHAR(50) NULL,
    [Suspended_st] VARCHAR(50) NULL,
    [Profile_code] VARCHAR(50) NULL,
    [ClientType] VARCHAR(50) NULL,
    [ClientCategory] VARCHAR(50) NULL,
    [PrimaryDealer] VARCHAR(50) NULL,
    [ClienTStatus] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankBranchMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[BankBranchMaster]
(
    [BankBranchCode] BIGINT NOT NULL,
    [BankCode] BIGINT NOT NULL,
    [BranchName] VARCHAR(50) NOT NULL,
    [Address1] VARCHAR(250) NOT NULL,
    [Address2] VARCHAR(250) NULL,
    [City] VARCHAR(25) NOT NULL,
    [State] VARCHAR(25) NULL,
    [Nation] VARCHAR(25) NULL,
    [Zip] VARCHAR(10) NULL,
    [Phone1] VARCHAR(25) NULL,
    [Phone2] VARCHAR(25) NULL,
    [Fax] VARCHAR(25) NULL,
    [Email] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[BankMaster]
(
    [BankCode] BIGINT NOT NULL,
    [BankName] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankROCRateMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[BankROCRateMaster]
(
    [BankCode] BIGINT NOT NULL,
    [ROC] MONEY NOT NULL,
    [effFromDt] DATETIME NOT NULL,
    [effToDt] DATETIME NOT NULL,
    [Active] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankROIRateMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[BankROIRateMaster]
(
    [BankCode] BIGINT NOT NULL,
    [ROI] MONEY NOT NULL,
    [effFromDt] DATETIME NOT NULL,
    [effToDt] DATETIME NOT NULL,
    [Active] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Baroda
-- --------------------------------------------------
CREATE TABLE [dbo].[Baroda]
(
    [F & O] NVARCHAR(255) NULL,
    [Date] SMALLDATETIME NULL,
    [Time] FLOAT NULL,
    [Strategy] NVARCHAR(255) NULL,
    [Company Name] NVARCHAR(255) NULL,
    [Derivative] NVARCHAR(255) NULL,
    [Lot Size] FLOAT NULL,
    [Der# Price] FLOAT NULL,
    [Cash Price] FLOAT NULL,
    [Stop Loss] FLOAT NULL,
    [Target] FLOAT NULL,
    [Risk] FLOAT NULL,
    [Reward] FLOAT NULL,
    [Bk# Price Profit/Loss] FLOAT NULL,
    [Net Profit/Loss] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BGMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[BGMaster]
(
    [BGCode] BIGINT NOT NULL,
    [BankCode] BIGINT NOT NULL,
    [BGNo] VARCHAR(20) NOT NULL,
    [CompName] VARCHAR(20) NOT NULL,
    [Segment] VARCHAR(10) NOT NULL,
    [New] VARCHAR(5) NOT NULL,
    [Margin] MONEY NOT NULL,
    [ActualExpDate] DATETIME NOT NULL,
    [CGuaranteeSeg] MONEY NOT NULL,
    [CGuaranteeAmt] MONEY NOT NULL,
    [effFrom] DATETIME NOT NULL,
    [effTo] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bhav_mcx
-- --------------------------------------------------
CREATE TABLE [dbo].[Bhav_mcx]
(
    [TDate] DATETIME NULL,
    [Commodity] VARCHAR(50) NULL,
    [Contract Month] VARCHAR(50) NULL,
    [Open(Rs)] VARCHAR(50) NULL,
    [High (Rs)] VARCHAR(50) NULL,
    [Low(Rs)] VARCHAR(50) NULL,
    [Close(Rs)] VARCHAR(50) NULL,
    [PCP(Rs)] VARCHAR(50) NULL,
    [Volume] VARCHAR(50) NULL,
    [Value] VARCHAR(50) NULL,
    [OL] VARCHAR(50) NULL,
    [up_date] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bhav_mcx_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[bhav_mcx_hist]
(
    [TDate] DATETIME NULL,
    [Commodity] VARCHAR(50) NULL,
    [Contract Month] VARCHAR(50) NULL,
    [Open(Rs)] VARCHAR(50) NULL,
    [High (Rs)] VARCHAR(50) NULL,
    [Low(Rs)] VARCHAR(50) NULL,
    [Close(Rs)] VARCHAR(50) NULL,
    [PCP(Rs)] VARCHAR(50) NULL,
    [Volume] VARCHAR(50) NULL,
    [Value] VARCHAR(50) NULL,
    [OL] VARCHAR(50) NULL,
    [up_date] VARCHAR(50) NULL,
    [fname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bhav_ncdx
-- --------------------------------------------------
CREATE TABLE [dbo].[Bhav_ncdx]
(
    [Symbol] VARCHAR(50) NULL,
    [Expiry_date] VARCHAR(50) NULL,
    [Commodity] VARCHAR(100) NULL,
    [deleviry_center] VARCHAR(50) NULL,
    [price_unit] VARCHAR(50) NULL,
    [prev_closeprice] VARCHAR(50) NULL,
    [open_price] MONEY NULL,
    [High_price] MONEY NULL,
    [Low_price] MONEY NULL,
    [Closing_price] MONEY NULL,
    [qty_traded] VARCHAR(50) NULL,
    [Measure] VARCHAR(50) NULL,
    [Trades_no] VARCHAR(50) NULL,
    [Trade_val] VARCHAR(50) NULL,
    [Open_Interest] VARCHAR(50) NULL,
    [up_date] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bhav_ncdx_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[bhav_ncdx_hist]
(
    [Symbol] VARCHAR(50) NULL,
    [Expiry_date] VARCHAR(50) NULL,
    [Commodity] VARCHAR(50) NULL,
    [deleviry_center] VARCHAR(50) NULL,
    [price_unit] VARCHAR(50) NULL,
    [prev_closeprice] VARCHAR(50) NULL,
    [open_price] MONEY NULL,
    [High_price] MONEY NULL,
    [Low_price] MONEY NULL,
    [Closing_price] MONEY NULL,
    [qty_traded] VARCHAR(50) NULL,
    [Measure] VARCHAR(50) NULL,
    [Trades_no] VARCHAR(50) NULL,
    [Trade_val] VARCHAR(50) NULL,
    [Open_Interest] VARCHAR(50) NULL,
    [up_date] VARCHAR(50) NULL,
    [fname] VARCHAR(50) NULL,
    [tdate] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BOfo_to
-- --------------------------------------------------
CREATE TABLE [dbo].[BOfo_to]
(
    [SaudaDate] DATETIME NULL,
    [Total] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch
-- --------------------------------------------------
CREATE TABLE [dbo].[branch]
(
    [BRANCH_CODE] CHAR(6) NULL,
    [BRANCH] CHAR(40) NULL,
    [Long_Name] CHAR(50) NULL,
    [Address1] CHAR(25) NULL,
    [Address2] CHAR(25) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchList
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchList]
(
    [BranchCode] VARCHAR(50) NULL,
    [BranchName] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Brok_FebMar09
-- --------------------------------------------------
CREATE TABLE [dbo].[Brok_FebMar09]
(
    [Id] VARCHAR(255) NULL,
    [Party_Code] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bse_SEBI$
-- --------------------------------------------------
CREATE TABLE [dbo].[bse_SEBI$]
(
    [SB_TAG] NVARCHAR(255) NULL,
    [SEBI_REG_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsebillvalan
-- --------------------------------------------------
CREATE TABLE [dbo].[bsebillvalan]
(
    [party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(12) NULL,
    [sell_buy] INT NOT NULL,
    [pamt] MONEY NOT NULL,
    [samt] MONEY NOT NULL,
    [PRate] MONEY NULL,
    [SRate] MONEY NULL,
    [Brokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [ExService_Tax] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [TrdAmt] MONEY NULL,
    [DelAmt] MONEY NULL,
    [sett_no] VARCHAR(7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [billno] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Client_Type] VARCHAR(10) NULL,
    [TrdType] VARCHAR(1) NULL,
    [PQty] INT NULL,
    [SQty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bsesundry
-- --------------------------------------------------
CREATE TABLE [dbo].[Bsesundry]
(
    [booktype] CHAR(2) NULL,
    [effdt] DATETIME NULL,
    [shortdesc] CHAR(6) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [Narration] VARCHAR(8000) NULL,
    [ddno] VARCHAR(15) NOT NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [edt] VARCHAR(30) NULL,
    [accat] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSeSundryclientMark
-- --------------------------------------------------
CREATE TABLE [dbo].[BSeSundryclientMark]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [chqnogiven] VARCHAR(50) NULL,
    [chqdategiven] DATETIME NULL,
    [banknamegiven] VARCHAR(50) NULL,
    [RegionInput] VARCHAR(20) NULL,
    [BranchInput] VARCHAR(10) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [ourbankcode] VARCHAR(50) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL,
    [BseCm] MONEY NULL,
    [NseCm] MONEY NULL,
    [NSEFO] MONEY NULL,
    [MCDX] MONEY NULL,
    [NCDX] MONEY NULL,
    [party_code] VARCHAR(10) NULL,
    [StatusName] VARCHAR(50) NULL,
    [UpdateDate] SMALLDATETIME NULL,
    [ExchSeg] VARCHAR(10) NULL,
    [ProofBy] VARCHAR(50) NULL,
    [ProofDate] DATETIME NULL,
    [FORemarks] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BseSundryClientReco
-- --------------------------------------------------
CREATE TABLE [dbo].[BseSundryClientReco]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BseSundryclientreco1
-- --------------------------------------------------
CREATE TABLE [dbo].[BseSundryclientreco1]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL,
    [ExchSeg] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.c1_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[c1_temp]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [cl_type] VARCHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cash_GLCode
-- --------------------------------------------------
CREATE TABLE [dbo].[Cash_GLCode]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [GL_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_grade
-- --------------------------------------------------
CREATE TABLE [dbo].[client_grade]
(
    [party_code] VARCHAR(10) NULL,
    [Grade] VARCHAR(3) NOT NULL,
    [TOTALBR] DECIMAL(10, 2) NULL,
    [PREVBR] DECIMAL(10, 2) NULL,
    [br12006] DECIMAL(10, 2) NULL,
    [br22006] DECIMAL(10, 2) NULL,
    [br32006] DECIMAL(10, 2) NULL,
    [br42006] DECIMAL(10, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client2
-- --------------------------------------------------
CREATE TABLE [dbo].[client2]
(
    [Cl_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] SMALLINT NOT NULL,
    [Sub_TableNo] SMALLINT NOT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] SMALLINT NOT NULL,
    [P_To_P] SMALLINT NOT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] SMALLINT NOT NULL,
    [BankId] VARCHAR(15) NULL,
    [CltDpNo] VARCHAR(15) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [contcharge] TINYINT NULL,
    [mincontamt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [dummy6] VARCHAR(4) NULL,
    [dummy7] VARCHAR(4) NULL,
    [dummy8] VARCHAR(4) NULL,
    [dummy9] VARCHAR(4) NULL,
    [dummy10] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientFundsPayOutDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientFundsPayOutDetails]
(
    [ExchangeSegment] VARCHAR(10) NOT NULL,
    [ClientCode] VARCHAR(10) NOT NULL,
    [CrBalance] MONEY NOT NULL,
    [RequestDate] DATETIME NOT NULL,
    [RequestAmount] MONEY NOT NULL,
    [SanctionedAmount] MONEY NOT NULL,
    [RequestIP] CHAR(15) NULL,
    [RequestStatus] CHAR(10) NULL,
    [Reason] CHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clients_accountopen
-- --------------------------------------------------
CREATE TABLE [dbo].[clients_accountopen]
(
    [cl_code] VARCHAR(50) NULL,
    [cl_name] VARCHAR(50) NULL,
    [subbroker_code] VARCHAR(50) NULL,
    [abl] VARCHAR(50) NULL,
    [acdl] VARCHAR(50) NULL,
    [fno] VARCHAR(50) NULL,
    [ncdex] VARCHAR(50) NULL,
    [mcx] VARCHAR(50) NULL,
    [asl] VARCHAR(50) NULL,
    [regndate] VARCHAR(50) NULL,
    [firsttradedate] VARCHAR(50) NULL,
    [tridate] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clients_accountopen08072005del
-- --------------------------------------------------
CREATE TABLE [dbo].[clients_accountopen08072005del]
(
    [cl_code] VARCHAR(50) NULL,
    [cl_name] VARCHAR(50) NULL,
    [subbroker_code] VARCHAR(50) NULL,
    [abl] VARCHAR(50) NULL,
    [acdl] VARCHAR(50) NULL,
    [fno] VARCHAR(50) NULL,
    [ncdex] VARCHAR(50) NULL,
    [mcx] VARCHAR(50) NULL,
    [asl] VARCHAR(50) NULL,
    [regndate] VARCHAR(50) NULL,
    [firsttradedate] VARCHAR(50) NULL,
    [tridate] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientSecuritiesPayOutDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientSecuritiesPayOutDetails]
(
    [ExchangeSegment] VARCHAR(10) NOT NULL,
    [ClientCode] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [ScripName] VARCHAR(50) NOT NULL,
    [Series] CHAR(10) NULL,
    [Sett_no] CHAR(10) NULL,
    [Sett_type] CHAR(10) NULL,
    [Qty] INT NULL,
    [RequestDate] DATETIME NOT NULL,
    [RequestQty] INT NOT NULL,
    [SanctionedQty] INT NOT NULL,
    [RequestIP] CHAR(15) NULL,
    [RequestStatus] VARCHAR(15) NULL,
    [Reason] CHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientSummaryAmounts
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientSummaryAmounts]
(
    [Client_Code] VARCHAR(20) NOT NULL,
    [LdgBSE] MONEY NULL DEFAULT 0,
    [LdgNSE] MONEY NULL DEFAULT 0,
    [LdgFO] MONEY NULL DEFAULT 0,
    [LdgMCX] MONEY NULL DEFAULT 0,
    [LdgNCDEX] MONEY NULL DEFAULT 0,
    [LdgExtra1] MONEY NULL DEFAULT 0,
    [LdgExtra2] MONEY NULL DEFAULT 0,
    [DepCashBSE] MONEY NULL DEFAULT 0,
    [DepCashNSE] MONEY NULL DEFAULT 0,
    [DepCashFO] MONEY NULL DEFAULT 0,
    [DepCashMCX] MONEY NULL DEFAULT 0,
    [DepCashNCDEX] MONEY NULL DEFAULT 0,
    [DepCashExtra1] MONEY NULL DEFAULT 0,
    [DepCashExtra2] MONEY NULL DEFAULT 0,
    [DepSecBSE] MONEY NULL DEFAULT 0,
    [DepSecNE] MONEY NULL DEFAULT 0,
    [DepSecFO] MONEY NULL DEFAULT 0,
    [DepSecMCX] MONEY NULL DEFAULT 0,
    [DepSecNCDEX] MONEY NULL DEFAULT 0,
    [DepSecExtra1] MONEY NULL DEFAULT 0,
    [DepSecExtra2] MONEY NULL DEFAULT 0,
    [MarginReqBSE] MONEY NULL DEFAULT 0,
    [MarginReqNSE] MONEY NULL DEFAULT 0,
    [MarginReqFO] MONEY NULL DEFAULT 0,
    [MarginReqMCX] MONEY NULL DEFAULT 0,
    [MarginReqNCDEX] MONEY NULL DEFAULT 0,
    [MarginReqExtra1] MONEY NULL DEFAULT 0,
    [MarginReqExtra2] MONEY NULL DEFAULT 0,
    [LastChqBSE] MONEY NULL DEFAULT 0,
    [LastChqNSE] MONEY NULL DEFAULT 0,
    [LastChqFO] MONEY NULL DEFAULT 0,
    [LastChqMCX] MONEY NULL DEFAULT 0,
    [LastChqNCDEX] MONEY NULL DEFAULT 0,
    [LastChqExtra1] MONEY NULL DEFAULT 0,
    [LastChqExtra2] MONEY NULL DEFAULT 0,
    [LastBillBSE] MONEY NULL DEFAULT 0,
    [LastBillNSE] MONEY NULL DEFAULT 0,
    [LastBillFO] MONEY NULL DEFAULT 0,
    [LastBillMCX] MONEY NULL DEFAULT 0,
    [LastBillNCDEX] MONEY NULL DEFAULT 0,
    [LastBillExtra1] MONEY NULL DEFAULT 0,
    [LastBillExtra2] MONEY NULL DEFAULT 0,
    [BrokBSE] MONEY NULL DEFAULT 0,
    [BrokNSE] MONEY NULL DEFAULT 0,
    [BrokFO] MONEY NULL DEFAULT 0,
    [BrokMCX] MONEY NULL DEFAULT 0,
    [BrokNCDEX] MONEY NULL DEFAULT 0,
    [BrokExtra1] MONEY NULL DEFAULT 0,
    [BrokExtra2] MONEY NULL DEFAULT 0,
    [RemisierBSE] MONEY NULL DEFAULT 0,
    [RemisierNSE] MONEY NULL DEFAULT 0,
    [RemisierFO] MONEY NULL DEFAULT 0,
    [RemisierMCX] MONEY NULL DEFAULT 0,
    [RemisierNCDEX] MONEY NULL DEFAULT 0,
    [RemisierExtra1] MONEY NULL DEFAULT 0,
    [RemisierExtra2] MONEY NULL DEFAULT 0,
    [PLAmount] MONEY NULL DEFAULT 0,
    [UserType] MONEY NULL DEFAULT 0,
    [UpdatedOn] MONEY NULL DEFAULT 0,
    [Branch_Code] VARCHAR(5) NULL,
    [SubBroker_Code] VARCHAR(10) NULL,
    [Family] VARCHAR(10) NULL,
    [Dummy1] MONEY NULL DEFAULT 0,
    [Dummy2] VARCHAR(20) NULL,
    [Dummy3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientWelCome
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientWelCome]
(
    [StatusID] VARCHAR(15) NULL,
    [PartyCode] VARCHAR(15) NULL,
    [Password] VARCHAR(15) NULL,
    [PasswordDate] SMALLDATETIME NULL,
    [EHPassword] VARCHAR(15) NULL,
    [EHPasswordDate] SMALLDATETIME NULL,
    [Couriered] VARCHAR(15) NULL,
    [CourierDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.commo_perf_eval
-- --------------------------------------------------
CREATE TABLE [dbo].[commo_perf_eval]
(
    [tdate] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [branch_name] VARCHAR(100) NULL,
    [location] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [mcdx_to] MONEY NOT NULL,
    [mcdx_brok] MONEY NOT NULL,
    [mcdx_ashare] MONEY NOT NULL,
    [ncdx_to] MONEY NOT NULL,
    [ncdx_brok] MONEY NOT NULL,
    [ncdx_ashare] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.commo_perf_eval_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[commo_perf_eval_hist]
(
    [tdate] DATETIME NULL,
    [branch_name] VARCHAR(100) NULL,
    [NGrossBrok] MONEY NULL,
    [NNetAngel] MONEY NULL,
    [Ngross_perday] NUMERIC(23, 7) NULL,
    [Nnet_aperday] NUMERIC(23, 7) NULL,
    [MGrossBrok] MONEY NULL,
    [MNetAngel] MONEY NULL,
    [Mgross_perday] NUMERIC(23, 7) NULL,
    [Mnet_aperday] NUMERIC(23, 7) NULL,
    [currweek_brok] NUMERIC(24, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.commo_perf_eval_sb
-- --------------------------------------------------
CREATE TABLE [dbo].[commo_perf_eval_sb]
(
    [tdate] DATETIME NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [branch_name] VARCHAR(100) NULL,
    [location] VARCHAR(50) NULL,
    [party_code] VARCHAR(10) NULL,
    [branch] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [mcdx_to] MONEY NOT NULL,
    [mcdx_brok] MONEY NOT NULL,
    [mcdx_ashare] MONEY NOT NULL,
    [ncdx_to] MONEY NOT NULL,
    [ncdx_brok] MONEY NOT NULL,
    [ncdx_ashare] MONEY NOT NULL,
    [SBNAME] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.commo_perf_eval1
-- --------------------------------------------------
CREATE TABLE [dbo].[commo_perf_eval1]
(
    [tdate] DATETIME NULL,
    [branch_Cd] VARCHAR(10) NULL,
    [branch_name] VARCHAR(100) NULL,
    [NCurrgross_perday] MONEY NULL,
    [NCurrNet_perday] MONEY NULL,
    [MCurrgross_perday] MONEY NULL,
    [MCurrNet_perday] MONEY NULL,
    [NLastgross_perday] NUMERIC(23, 7) NULL,
    [NLastnet_aperday] MONEY NULL,
    [MLastgross_perday] NUMERIC(23, 7) NULL,
    [MLastnet_aperday] NUMERIC(23, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMPDATE
-- --------------------------------------------------
CREATE TABLE [dbo].[COMPDATE]
(
    [party_code] CHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [branch] CHAR(40) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [sbname] CHAR(25) NULL,
    [Long_name] VARCHAR(100) NULL,
    [L_address1] VARCHAR(40) NULL,
    [L_address2] VARCHAR(40) NULL,
    [L_address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(20) NULL,
    [COMPDATE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.contr_comm
-- --------------------------------------------------
CREATE TABLE [dbo].[contr_comm]
(
    [branch_cd] VARCHAR(10) NULL,
    [mctot] VARCHAR(30) NULL,
    [mltot] VARCHAR(30) NULL,
    [rctot] VARCHAR(30) NULL,
    [rltot] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CTCL_adminuser
-- --------------------------------------------------
CREATE TABLE [dbo].[CTCL_adminuser]
(
    [fldauto] INT NOT NULL,
    [fldpartycode] VARCHAR(40) NOT NULL,
    [fldpassword] VARCHAR(40) NOT NULL,
    [fldpasscheck] VARCHAR(40) NULL,
    [fldfavshare] VARCHAR(40) NULL,
    [fldfirstname] VARCHAR(50) NULL,
    [fldmidname] VARCHAR(40) NULL,
    [fldlastname] VARCHAR(40) NULL,
    [fldemail] VARCHAR(30) NULL,
    [fldbdate] VARCHAR(10) NULL,
    [fldgender] VARCHAR(7) NULL,
    [fldzip] VARCHAR(10) NULL,
    [fldcountry] VARCHAR(30) NULL,
    [fldstate] VARCHAR(20) NULL,
    [fldcity] VARCHAR(30) NULL,
    [fldaddress] VARCHAR(150) NULL,
    [fldphone1] VARCHAR(15) NULL,
    [fldphone2] VARCHAR(15) NULL,
    [abl_upd] DATETIME NULL,
    [acdl_upd] DATETIME NULL,
    [fo_upd] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CTCL_TO
-- --------------------------------------------------
CREATE TABLE [dbo].[CTCL_TO]
(
    [branch] VARCHAR(100) NULL,
    [sauda_date] DATETIME NULL,
    [BSE_TO] MONEY NULL,
    [BSE_BR] MONEY NULL,
    [NSE_TO] MONEY NULL,
    [NSE_BR] MONEY NULL,
    [FO_TO] MONEY NULL,
    [FO_BR] MONEY NULL,
    [MCX_TO] MONEY NULL,
    [MCX_BR] MONEY NULL,
    [NCDEX_TO] MONEY NULL,
    [NCDEX_BR] MONEY NULL,
    [teminal_no] VARCHAR(10) NULL,
    [segment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.data_new
-- --------------------------------------------------
CREATE TABLE [dbo].[data_new]
(
    [Branch_Cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Turnover] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DividendDetail
-- --------------------------------------------------
CREATE TABLE [dbo].[DividendDetail]
(
    [ScripName] VARCHAR(12) NOT NULL,
    [ScripCode] VARCHAR(12) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [FaceValue] MONEY NOT NULL,
    [DivPercentage] DECIMAL(18, 4) NOT NULL,
    [DivType] VARCHAR(50) NOT NULL,
    [BookClosureDate] DATETIME NOT NULL,
    [Dummy0] VARCHAR(1) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [FinancialYearFrom] DATETIME NOT NULL,
    [FinancialYearTo] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DuplicateChq
-- --------------------------------------------------
CREATE TABLE [dbo].[DuplicateChq]
(
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [Enteredby] VARCHAR(25) NOT NULL,
    [checkedby] VARCHAR(25) NOT NULL,
    [narration] VARCHAR(234) NULL,
    [BnkName] VARCHAR(35) NOT NULL,
    [BrnName] VARCHAR(20) NOT NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [relamt] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [Acname] VARCHAR(100) NULL,
    [branch] CHAR(35) NOT NULL,
    [Cltcode] VARCHAR(10) NULL,
    [exchseg] VARCHAR(5) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_client_access
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_client_access]
(
    [party_Code] NVARCHAR(255) NULL,
    [bse_stat] VARCHAR(1) NOT NULL,
    [nse_stat] VARCHAR(1) NOT NULL,
    [fo_stat] VARCHAR(1) NOT NULL,
    [mcdx_stat] VARCHAR(1) NOT NULL,
    [ncdx_stat] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_log_status
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_log_status]
(
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [bse_br] MONEY NULL,
    [E_BSE] MONEY NULL,
    [nse_br] MONEY NULL,
    [E_NSE] MONEY NULL,
    [fo_br] MONEY NULL,
    [E_FO] MONEY NULL,
    [mcx_br] MONEY NULL,
    [E_MCX] MONEY NULL,
    [ncdex_br] MONEY NULL,
    [E_NCDX] MONEY NULL,
    [TOTAL_SEG] MONEY NULL,
    [ebrok_br] MONEY NULL,
    [BSE_STAT] VARCHAR(1) NOT NULL,
    [NSE_STAT] VARCHAR(1) NOT NULL,
    [FO_STAT] VARCHAR(1) NOT NULL,
    [MCDX_STAT] VARCHAR(1) NOT NULL,
    [NCDX_STAT] VARCHAR(1) NOT NULL,
    [nooflogin] INT NULL,
    [sauda_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ebrok_mis
-- --------------------------------------------------
CREATE TABLE [dbo].[Ebrok_mis]
(
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [bse_to] MONEY NULL,
    [nse_to] MONEY NULL,
    [fo_to] MONEY NULL,
    [mcx_to] MONEY NULL,
    [ncdex_to] MONEY NULL,
    [ebrok_to] MONEY NULL,
    [bse_br] MONEY NULL,
    [nse_br] MONEY NULL,
    [fo_br] MONEY NULL,
    [mcx_br] MONEY NULL,
    [ncdex_br] MONEY NULL,
    [ebrok_br] MONEY NULL,
    [Ebse_br] MONEY NULL,
    [Ense_br] MONEY NULL,
    [Efo_br] MONEY NULL,
    [Emcx_br] MONEY NULL,
    [Encdex_br] MONEY NULL,
    [bse_stat] VARCHAR(1) NOT NULL,
    [nse_stat] VARCHAR(1) NOT NULL,
    [fo_stat] VARCHAR(1) NOT NULL,
    [mcdx_stat] VARCHAR(1) NOT NULL,
    [ncdx_stat] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ebrok_mis1
-- --------------------------------------------------
CREATE TABLE [dbo].[Ebrok_mis1]
(
    [sauda_date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [bse_to] MONEY NULL,
    [nse_to] MONEY NULL,
    [fo_to] MONEY NULL,
    [mcx_to] MONEY NULL,
    [ncdex_to] MONEY NULL,
    [ebrok_to] MONEY NULL,
    [bse_br] MONEY NULL,
    [nse_br] MONEY NULL,
    [fo_br] MONEY NULL,
    [mcx_br] MONEY NULL,
    [ncdex_br] MONEY NULL,
    [ebrok_br] MONEY NULL,
    [ebse_br] MONEY NULL,
    [ense_br] MONEY NULL,
    [efo_br] MONEY NULL,
    [emcx_br] MONEY NULL,
    [encdex_br] MONEY NULL,
    [bse_stat] VARCHAR(1) NOT NULL,
    [nse_stat] VARCHAR(1) NOT NULL,
    [fo_stat] VARCHAR(1) NOT NULL,
    [mcdx_stat] VARCHAR(1) NOT NULL,
    [ncdx_stat] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ebrok_mis1_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[Ebrok_mis1_hist]
(
    [sauda_date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [bse_to] MONEY NULL,
    [nse_to] MONEY NULL,
    [fo_to] MONEY NULL,
    [mcx_to] MONEY NULL,
    [ncdex_to] MONEY NULL,
    [ebrok_to] MONEY NULL,
    [bse_br] MONEY NULL,
    [nse_br] MONEY NULL,
    [fo_br] MONEY NULL,
    [mcx_br] MONEY NULL,
    [ncdex_br] MONEY NULL,
    [ebrok_br] MONEY NULL,
    [ebse_br] MONEY NULL,
    [ense_br] MONEY NULL,
    [efo_br] MONEY NULL,
    [emcx_br] MONEY NULL,
    [encdex_br] MONEY NULL,
    [bse_stat] VARCHAR(1) NOT NULL,
    [nse_stat] VARCHAR(1) NOT NULL,
    [fo_stat] VARCHAR(1) NOT NULL,
    [mcdx_stat] VARCHAR(1) NOT NULL,
    [ncdx_stat] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_tobr_period
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_tobr_period]
(
    [sauda_date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [bse_to] MONEY NULL,
    [nse_to] MONEY NULL,
    [fo_to] MONEY NULL,
    [mcx_to] MONEY NULL,
    [ncdex_to] MONEY NULL,
    [ebrok_to] MONEY NULL,
    [bse_br] MONEY NULL,
    [nse_br] MONEY NULL,
    [fo_br] MONEY NULL,
    [mcx_br] MONEY NULL,
    [ncdex_br] MONEY NULL,
    [ebrok_br] MONEY NULL,
    [ebse_br] MONEY NULL,
    [ense_br] MONEY NULL,
    [efo_br] MONEY NULL,
    [emcx_br] MONEY NULL,
    [encdex_br] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking]
(
    [segment] VARCHAR(25) NULL,
    [description] VARCHAR(50) NULL,
    [userid] VARCHAR(25) NULL,
    [version] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_Trades
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_Trades]
(
    [ServerIP] VARCHAR(15) NULL,
    [sSymbol] VARCHAR(15) NULL,
    [BSE_Code] VARCHAR(10) NULL,
    [nQuantityTraded] INT NULL,
    [nTradedPrice] MONEY NULL,
    [nTradeNumber] VARCHAR(15) NULL,
    [nBuyOrSell] VARCHAR(5) NULL,
    [nTradedOrderNumber] VARCHAR(15) NULL,
    [sBrokerID] VARCHAR(15) NULL,
    [nUserID] VARCHAR(15) NULL,
    [sAccountCode] VARCHAR(15) NULL,
    [nMarketSegmentId] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(15) NULL,
    [dCurrentTime] DATETIME NULL,
    [nProductType] VARCHAR(5) NULL,
    [sDealerId] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.email_cbs_data_check
-- --------------------------------------------------
CREATE TABLE [dbo].[email_cbs_data_check]
(
    [email_data_flag] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.executivecode
-- --------------------------------------------------
CREATE TABLE [dbo].[executivecode]
(
    [party_code] VARCHAR(50) NOT NULL,
    [executive_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FD-BG-Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[FD-BG-Detail]
(
    [BGCode] INT NULL,
    [FDCode] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FDDetail
-- --------------------------------------------------
CREATE TABLE [dbo].[FDDetail]
(
    [FDCode] INT NOT NULL,
    [GrossInterest] MONEY NOT NULL,
    [TDS] MONEY NOT NULL,
    [ActualGrossInterest] MONEY NOT NULL,
    [ActualTDS] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FDMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[FDMaster]
(
    [FDCode] BIGINT NOT NULL,
    [BankBranchCode] BIGINT NOT NULL,
    [FDNo] VARCHAR(20) NOT NULL,
    [CompName] VARCHAR(20) NOT NULL,
    [Segment] VARCHAR(10) NOT NULL,
    [New] VARCHAR(5) NOT NULL,
    [DepositAmount] MONEY NOT NULL,
    [ActualExpDate] DATETIME NOT NULL,
    [effFrom] DATETIME NOT NULL,
    [effTo] DATETIME NOT NULL,
    [ROI] MONEY NOT NULL,
    [CustomerID] VARCHAR(20) NULL,
    [TDS] MONEY NULL,
    [Commission] MONEY NULL,
    [Reinvest] VARCHAR(15) NULL,
    [ModificationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FDS_IntraInDelivery_BSE_NSE
-- --------------------------------------------------
CREATE TABLE [dbo].[FDS_IntraInDelivery_BSE_NSE]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [sc_name] VARCHAR(25) NULL,
    [turnover] INT NULL,
    [totalnoofshares] DECIMAL(10, 0) NULL,
    [turnoverperc] DECIMAL(14, 2) NULL,
    [buyrate] MONEY NULL,
    [sellrate] MONEY NULL,
    [stkprcvariation] MONEY NULL,
    [pl] MONEY NULL,
    [pqtytrd] INT NULL,
    [pqtydel] INT NULL,
    [sqtytrd] INT NULL,
    [sqtydel] INT NULL,
    [segment] VARCHAR(50) NULL,
    [clientstatus] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FDS_INTRAINDELIVERY_NSE
-- --------------------------------------------------
CREATE TABLE [dbo].[FDS_INTRAINDELIVERY_NSE]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [sc_name] VARCHAR(25) NULL,
    [turnover] INT NULL,
    [totalnoofshares] DECIMAL(10, 0) NULL,
    [turnoverperc] DECIMAL(14, 2) NULL,
    [buyrate] MONEY NULL,
    [sellrate] MONEY NULL,
    [stkprcvariation] MONEY NULL,
    [pl] MONEY NULL,
    [pqtytrd] INT NULL,
    [pqtydel] INT NULL,
    [sqtytrd] INT NULL,
    [sqtydel] INT NULL,
    [segment] VARCHAR(50) NULL,
    [clientstatus] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FDS_IntraInDelivery_NSEFO
-- --------------------------------------------------
CREATE TABLE [dbo].[FDS_IntraInDelivery_NSEFO]
(
    [party_code] VARCHAR(20) NULL,
    [s_inst_type] VARCHAR(25) NULL,
    [s_symbol] VARCHAR(25) NULL,
    [s_strike_price] MONEY NULL,
    [s_user_id] VARCHAR(25) NULL,
    [s_expirydate] VARCHAR(11) NULL,
    [s_sell_trdqty] INT NULL,
    [s_sell_amt] MONEY NULL,
    [s_sell_price] DECIMAL(10, 2) NULL,
    [b_sell_trdqty] INT NULL,
    [b_sell_amt] MONEY NULL,
    [b_sell_price] DECIMAL(10, 2) NULL,
    [Pl] MONEY NULL,
    [RateDiff] DECIMAL(11, 0) NULL,
    [Tover] INT NULL,
    [long_name] VARCHAR(100) NULL,
    [status] VARCHAR(7) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FINAL
-- --------------------------------------------------
CREATE TABLE [dbo].[FINAL]
(
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [BSECM_TRD_TO] MONEY NULL,
    [BSECM_DEL_TO] MONEY NULL,
    [BSECM_TRD_GROSS] MONEY NULL,
    [BSECM_DEL_GROSS] MONEY NULL,
    [BSECM_TRD_NET] MONEY NULL,
    [BSECM_DEL_NET] MONEY NULL,
    [NSECM_TRD_TO] MONEY NULL,
    [NSECM_DEL_TO] MONEY NULL,
    [NSECM_TRD_GROSS] MONEY NULL,
    [NSECM_DEL_GROSS] MONEY NULL,
    [NSECM_TRD_NET] MONEY NULL,
    [NSECM_DEL_NET] MONEY NULL,
    [NSEFO_TO] MONEY NULL,
    [NSEFO_GROSS] MONEY NULL,
    [NSEFO_NET] MONEY NULL,
    [MCX_TO] MONEY NULL,
    [MCX_GROSS] MONEY NULL,
    [MCX_NET] MONEY NULL,
    [NCDEX_TO] MONEY NULL,
    [NCDEX_GROSS] MONEY NULL,
    [NCDEX_NET] MONEY NULL,
    [TOTAL_TO] MONEY NULL,
    [TOTAL_GROSS] MONEY NULL,
    [TOTAL_NET] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.first_Etrade_date
-- --------------------------------------------------
CREATE TABLE [dbo].[first_Etrade_date]
(
    [party_code] VARCHAR(10) NULL,
    [first_trade_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.firstfinal
-- --------------------------------------------------
CREATE TABLE [dbo].[firstfinal]
(
    [cl_code] VARCHAR(10) NULL,
    [long_name] VARCHAR(100) NULL,
    [activefrom] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [Firsttrading] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Gabriel_Vol
-- --------------------------------------------------
CREATE TABLE [dbo].[Gabriel_Vol]
(
    [tdate] DATETIME NULL,
    [bsecm_not] INT NOT NULL,
    [nsecm_not] INT NOT NULL,
    [nsefo_not] INT NOT NULL,
    [bsecm_to] MONEY NULL,
    [nsecm_to] MONEY NULL,
    [nsefo_to] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.GN_total
-- --------------------------------------------------
CREATE TABLE [dbo].[GN_total]
(
    [totcg] MONEY NULL,
    [totcn] MONEY NULL,
    [totlg] MONEY NULL,
    [totln] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HighestBrokerage
-- --------------------------------------------------
CREATE TABLE [dbo].[HighestBrokerage]
(
    [branch_cd] VARCHAR(10) NULL,
    [Max_Brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HighLowBrokerage
-- --------------------------------------------------
CREATE TABLE [dbo].[HighLowBrokerage]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Max_Brok] MONEY NULL,
    [Min_Brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.hnibroktot
-- --------------------------------------------------
CREATE TABLE [dbo].[hnibroktot]
(
    [party_code] VARCHAR(10) NULL,
    [Grade] VARCHAR(3) NOT NULL,
    [TOTALBR] DECIMAL(10, 2) NULL,
    [PREVBR] DECIMAL(10, 2) NULL,
    [br12006] DECIMAL(10, 2) NULL,
    [br22006] DECIMAL(10, 2) NULL,
    [br32006] DECIMAL(10, 2) NULL,
    [br42006] DECIMAL(10, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.hnibroktot1
-- --------------------------------------------------
CREATE TABLE [dbo].[hnibroktot1]
(
    [party_code] VARCHAR(10) NULL,
    [Grade] VARCHAR(3) NOT NULL,
    [TOTALBR] DECIMAL(10, 2) NULL,
    [PREVBR] DECIMAL(10, 2) NULL,
    [br12006] DECIMAL(10, 2) NULL,
    [br22006] DECIMAL(10, 2) NULL,
    [br32006] DECIMAL(10, 2) NULL,
    [br42006] DECIMAL(10, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HoldingData
-- --------------------------------------------------
CREATE TABLE [dbo].[HoldingData]
(
    [ISIN] VARCHAR(12) NULL,
    [accno] VARCHAR(16) NULL,
    [company_name] VARCHAR(50) NULL,
    [quantity] INT NULL,
    [BenPledge] VARCHAR(15) NULL,
    [holding_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.hyd2
-- --------------------------------------------------
CREATE TABLE [dbo].[hyd2]
(
    [Party_code] VARCHAR(10) NULL,
    [Turnover] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.indexdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[indexdetails]
(
    [IndexName] CHAR(10) NULL,
    [cNetChangeIndicator] CHAR(10) NULL,
    [dMktCapitalisation] MONEY NULL,
    [lClosingIndex] SMALLMONEY NULL,
    [lHighIndexValue] SMALLMONEY NULL,
    [lIndexValue] SMALLMONEY NULL,
    [lLowIndexValue] SMALLMONEY NULL,
    [lNoOfDownmoves] INT NULL,
    [lNoOfUpmoves] INT NULL,
    [lOpeningIndex] SMALLMONEY NULL,
    [lPercentChange] SMALLMONEY NULL,
    [lYearlyHigh] SMALLMONEY NULL,
    [lYearlyLow] SMALLMONEY NULL,
    [ExchangeSegment] CHAR(10) NULL,
    [RecordDate] SMALLDATETIME NULL,
    [DeleteFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IntranetAngelRemcalc
-- --------------------------------------------------
CREATE TABLE [dbo].[IntranetAngelRemcalc]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [Coname] VARCHAR(50) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.jaganbro
-- --------------------------------------------------
CREATE TABLE [dbo].[jaganbro]
(
    [party_code] VARCHAR(10) NULL,
    [brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.jaip_cl
-- --------------------------------------------------
CREATE TABLE [dbo].[jaip_cl]
(
    [Executive] NVARCHAR(255) NULL,
    [Client Name] NVARCHAR(255) NULL,
    [Party Code] NVARCHAR(255) NULL,
    [Jan] NVARCHAR(255) NULL,
    [Feb] NVARCHAR(255) NULL,
    [Mar] NVARCHAR(255) NULL,
    [April Till date] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KIRANSHEET2
-- --------------------------------------------------
CREATE TABLE [dbo].[KIRANSHEET2]
(
    [SRNO] FLOAT NULL,
    [Party Code] VARCHAR(255) NULL,
    [Party Name] VARCHAR(255) NULL,
    [Active From Dt#] DATETIME NULL,
    [Expiry Dt#] DATETIME NULL,
    [brok] NUMERIC(14, 2) NULL,
    [noofdaystraded] INT NULL,
    [workingdays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_documents
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_documents]
(
    [cl_code] VARCHAR(50) NOT NULL,
    [short_name] VARCHAR(50) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [resident_proof] VARCHAR(50) NULL,
    [demat] VARCHAR(50) NULL,
    [bank] VARCHAR(50) NULL,
    [identitycard] VARCHAR(50) NULL,
    [tarpartite] VARCHAR(50) NULL,
    [mapin] VARCHAR(50) NULL,
    [mapin_no] VARCHAR(50) NULL,
    [non_mapin_aggrement] VARCHAR(50) NULL,
    [update_pan_date] DATETIME NULL,
    [resident_proof_date] DATETIME NULL,
    [demat_date] DATETIME NULL,
    [bank_date] DATETIME NULL,
    [identitycard_date] DATETIME NULL,
    [tarpartite_date] DATETIME NULL,
    [mapin_date] DATETIME NULL,
    [non_mapin_aggrement_date] DATETIME NULL,
    [board_resolution] VARCHAR(50) NULL,
    [annualreport] VARCHAR(50) NULL,
    [moa] VARCHAR(50) NULL,
    [board_reso_date] DATETIME NULL,
    [annualreport_date] DATETIME NULL,
    [moa_date] DATETIME NULL,
    [approve] VARCHAR(50) NULL,
    [approve_date] DATETIME NULL,
    [eff_to] DATETIME NULL,
    [eff_from] DATETIME NULL,
    [tabl] VARCHAR(50) NULL,
    [tacdl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_documents07072005del
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_documents07072005del]
(
    [cl_code] VARCHAR(50) NOT NULL,
    [short_name] VARCHAR(50) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [resident_proof] VARCHAR(50) NULL,
    [demat] VARCHAR(50) NULL,
    [bank] VARCHAR(50) NULL,
    [identitycard] VARCHAR(50) NULL,
    [tarpartite] VARCHAR(50) NULL,
    [mapin] VARCHAR(50) NULL,
    [mapin_no] VARCHAR(50) NULL,
    [non_mapin_aggrement] VARCHAR(50) NULL,
    [update_pan_date] DATETIME NULL,
    [resident_proof_date] DATETIME NULL,
    [demat_date] DATETIME NULL,
    [bank_date] DATETIME NULL,
    [identitycard_date] DATETIME NULL,
    [tarpartite_date] DATETIME NULL,
    [mapin_date] DATETIME NULL,
    [non_mapin_aggrement_date] DATETIME NULL,
    [board_resolution] VARCHAR(50) NULL,
    [annualreport] VARCHAR(50) NULL,
    [moa] VARCHAR(50) NULL,
    [board_reso_date] DATETIME NULL,
    [annualreport_date] DATETIME NULL,
    [moa_date] DATETIME NULL,
    [approve] VARCHAR(50) NULL,
    [approve_date] DATETIME NULL,
    [eff_to] DATETIME NULL,
    [eff_from] DATETIME NULL,
    [tabl] VARCHAR(50) NULL,
    [tacdl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.level1QMis
-- --------------------------------------------------
CREATE TABLE [dbo].[level1QMis]
(
    [DYear] VARCHAR(11) NULL,
    [Q1Days] INT NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Q1Turnover] MONEY NULL,
    [Q1AvgTurnover] MONEY NULL,
    [Q1Brokerage] MONEY NULL,
    [Q1AvgBrokerage] MONEY NULL,
    [Q2Days] INT NULL,
    [Q2Turnover] MONEY NULL,
    [Q2AvgTurnover] MONEY NULL,
    [Q2Brokerage] MONEY NULL,
    [Q2AvgBrokerage] MONEY NULL,
    [Q3Days] INT NULL,
    [Q3Turnover] MONEY NULL,
    [Q3AvgTurnover] MONEY NULL,
    [Q3Brokerage] MONEY NULL,
    [Q3AvgBrokerage] MONEY NULL,
    [Q4Days] INT NULL,
    [Q4Turnover] MONEY NULL,
    [Q4AvgTurnover] MONEY NULL,
    [Q4Brokerage] MONEY NULL,
    [Q4AvgBrokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Level1ScripMis
-- --------------------------------------------------
CREATE TABLE [dbo].[Level1ScripMis]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Sauda_date] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [IsIN] VARCHAR(12) NULL,
    [Family] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(50) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [ClientType] VARCHAR(10) NULL,
    [TradeType] VARCHAR(3) NULL,
    [Trader] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [TP] INT NULL,
    [TPA] MONEY NULL,
    [DP] INT NULL,
    [DPA] MONEY NULL,
    [TS] INT NULL,
    [TSA] MONEY NULL,
    [DS] INT NULL,
    [DSA] MONEY NULL,
    [TPB] MONEY NULL,
    [TSB] MONEY NULL,
    [DPB] MONEY NULL,
    [DSB] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [NSerTax] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Orders] INT NOT NULL,
    [Trades] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Level2Mis
-- --------------------------------------------------
CREATE TABLE [dbo].[Level2Mis]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Year] INT NULL,
    [Month] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Party_name] VARCHAR(100) NULL,
    [Family] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Client_Type] VARCHAR(10) NULL,
    [Trade_type] VARCHAR(3) NULL,
    [Trader] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [TradingPurQty] INT NULL,
    [TradingPurAmt] MONEY NULL,
    [DeliveryPurQty] INT NULL,
    [DeliveryPurAmt] MONEY NULL,
    [TradingSaleQty] INT NULL,
    [TradingSaleAmt] MONEY NULL,
    [DeliverySaleQty] INT NULL,
    [DeliverySaleAmt] MONEY NULL,
    [TradingPurBrok] MONEY NULL,
    [TradingSaleBrok] MONEY NULL,
    [DeliveryPurBrok] MONEY NULL,
    [DeliverySaleBrok] MONEY NULL,
    [Service_tax] MONEY NULL,
    [NotAppSertax] MONEY NULL,
    [Turn_tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [From_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [ActBrok] MONEY NULL DEFAULT 0,
    [AngelBrok] MONEY NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.level2mis_test
-- --------------------------------------------------
CREATE TABLE [dbo].[level2mis_test]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Year] INT NULL,
    [Month] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Party_name] VARCHAR(100) NULL,
    [Family] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Client_Type] VARCHAR(10) NULL,
    [Trade_type] VARCHAR(3) NULL,
    [Trader] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [TradingPurQty] INT NULL,
    [TradingPurAmt] MONEY NULL,
    [DeliveryPurQty] INT NULL,
    [DeliveryPurAmt] MONEY NULL,
    [TradingSaleQty] INT NULL,
    [TradingSaleAmt] MONEY NULL,
    [DeliverySaleQty] INT NULL,
    [DeliverySaleAmt] MONEY NULL,
    [TradingPurBrok] MONEY NULL,
    [TradingSaleBrok] MONEY NULL,
    [DeliveryPurBrok] MONEY NULL,
    [DeliverySaleBrok] MONEY NULL,
    [Service_tax] MONEY NULL,
    [NotAppSertax] MONEY NULL,
    [Turn_tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [From_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [Orders] INT NULL,
    [Trades] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Level3Mis
-- --------------------------------------------------
CREATE TABLE [dbo].[Level3Mis]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Year] INT NULL,
    [Month] INT NULL,
    [Family] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(100) NULL,
    [Trader] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [TradingPurQty] INT NULL,
    [TradingPurAmt] MONEY NULL,
    [DeliveryPurQty] INT NULL,
    [DeliveryPurAmt] MONEY NULL,
    [TradingSaleQty] INT NULL,
    [TradingSaleAmt] MONEY NULL,
    [DeliverySaleQty] INT NULL,
    [DeliverySaleAmt] MONEY NULL,
    [TradingPurBrok] MONEY NULL,
    [TradingSaleBrok] MONEY NULL,
    [DeliveryPurBrok] MONEY NULL,
    [DeliverySaleBrok] MONEY NULL,
    [Service_tax] MONEY NULL,
    [NotAppSertax] MONEY NULL,
    [Turn_tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [From_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [ActBrok] MONEY NULL DEFAULT 0,
    [AngelBrok] MONEY NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.Level4Mis
-- --------------------------------------------------
CREATE TABLE [dbo].[Level4Mis]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Year] INT NULL,
    [Month] INT NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [TradingPurQty] INT NULL,
    [TradingPurAmt] MONEY NULL,
    [DeliveryPurQty] INT NULL,
    [DeliveryPurAmt] MONEY NULL,
    [TradingSaleQty] INT NULL,
    [TradingSaleAmt] MONEY NULL,
    [DeliverySaleQty] INT NULL,
    [DeliverySaleAmt] MONEY NULL,
    [TradingPurBrok] MONEY NULL,
    [TradingSaleBrok] MONEY NULL,
    [DeliveryPurBrok] MONEY NULL,
    [DeliverySaleBrok] MONEY NULL,
    [Service_tax] MONEY NULL,
    [NotAppSertax] MONEY NULL,
    [Turn_tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [ActBrok] MONEY NULL DEFAULT 0,
    [AngelBrok] MONEY NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.Level5Mis
-- --------------------------------------------------
CREATE TABLE [dbo].[Level5Mis]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Year] INT NULL,
    [Month] INT NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [TradingPurQty] INT NULL,
    [TradingPurAmt] MONEY NULL,
    [DeliveryPurQty] INT NULL,
    [DeliveryPurAmt] MONEY NULL,
    [TradingSaleQty] INT NULL,
    [TradingSaleAmt] MONEY NULL,
    [DeliverySaleQty] INT NULL,
    [DeliverySaleAmt] MONEY NULL,
    [TradingPurBrok] MONEY NULL,
    [TradingSaleBrok] MONEY NULL,
    [DeliveryPurBrok] MONEY NULL,
    [DeliverySaleBrok] MONEY NULL,
    [Service_tax] MONEY NULL,
    [NotAppSertax] MONEY NULL,
    [Turn_tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [ActBrok] MONEY NULL DEFAULT 0,
    [AngelBrok] MONEY NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.Level6FyearMis
-- --------------------------------------------------
CREATE TABLE [dbo].[Level6FyearMis]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [CYear] INT NULL,
    [CMonth] INT NULL,
    [TradingPurQty] INT NULL,
    [TradingPurAmt] MONEY NULL,
    [DeliveryPurQty] INT NULL,
    [DeliveryPurAmt] MONEY NULL,
    [TradingSaleQty] INT NULL,
    [TradingSaleAmt] MONEY NULL,
    [DeliverySaleQty] INT NULL,
    [DeliverySaleAmt] MONEY NULL,
    [TradingPurBrok] MONEY NULL,
    [TradingSaleBrok] MONEY NULL,
    [DeliveryPurBrok] MONEY NULL,
    [DeliverySaleBrok] MONEY NULL,
    [Service_tax] MONEY NULL,
    [NotAppSertax] MONEY NULL,
    [Turn_tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [ActBrok] MONEY NULL,
    [AngelBrok] MONEY NULL,
    [FinYear] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Level6Mis
-- --------------------------------------------------
CREATE TABLE [dbo].[Level6Mis]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Year] INT NULL,
    [Month] INT NULL,
    [TradingPurQty] INT NULL,
    [TradingPurAmt] MONEY NULL,
    [DeliveryPurQty] INT NULL,
    [DeliveryPurAmt] MONEY NULL,
    [TradingSaleQty] INT NULL,
    [TradingSaleAmt] MONEY NULL,
    [DeliverySaleQty] INT NULL,
    [DeliverySaleAmt] MONEY NULL,
    [TradingPurBrok] MONEY NULL,
    [TradingSaleBrok] MONEY NULL,
    [DeliveryPurBrok] MONEY NULL,
    [DeliverySaleBrok] MONEY NULL,
    [Service_tax] MONEY NULL,
    [NotAppSertax] MONEY NULL,
    [Turn_tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [ActBrok] MONEY NULL DEFAULT 0,
    [AngelBrok] MONEY NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.LevelRemMis
-- --------------------------------------------------
CREATE TABLE [dbo].[LevelRemMis]
(
    [Exchangesegment] VARCHAR(5) NOT NULL,
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [Branch_Cd] CHAR(10) NULL,
    [Sub_Broker] CHAR(10) NULL,
    [Actbrok] MONEY NULL,
    [AngelBrok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.levelscrip
-- --------------------------------------------------
CREATE TABLE [dbo].[levelscrip]
(
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Sauda_date] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [IsIN] VARCHAR(12) NULL,
    [Family] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(50) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [ClientType] VARCHAR(10) NULL,
    [TradeType] VARCHAR(3) NULL,
    [Trader] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [TP] INT NULL,
    [TPA] MONEY NULL,
    [DP] INT NULL,
    [DPA] MONEY NULL,
    [TS] INT NULL,
    [TSA] MONEY NULL,
    [DS] INT NULL,
    [DSA] MONEY NULL,
    [TPB] MONEY NULL,
    [TSB] MONEY NULL,
    [DPB] MONEY NULL,
    [DSB] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [NSerTax] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Orders] INT NOT NULL,
    [Trades] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Log_DupChqAmtUp
-- --------------------------------------------------
CREATE TABLE [dbo].[Log_DupChqAmtUp]
(
    [LastUpdate] DATETIME NOT NULL,
    [ProcessName] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LogDelete_bsesundryclientmark
-- --------------------------------------------------
CREATE TABLE [dbo].[LogDelete_bsesundryclientmark]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL,
    [BseCm] MONEY NULL,
    [NseCm] MONEY NULL,
    [NSEFO] MONEY NULL,
    [MCDX] MONEY NULL,
    [NCDX] MONEY NULL,
    [party_code] VARCHAR(10) NULL,
    [StatusName] CHAR(20) NULL,
    [UpdateDate] SMALLDATETIME NULL,
    [ExchSeg] VARCHAR(10) NULL,
    [DeleteDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOGINFILE
-- --------------------------------------------------
CREATE TABLE [dbo].[LOGINFILE]
(
    [PARTY_cODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(200) NULL,
    [BRANCH] VARCHAR(25) NULL,
    [LOGIN_DATE] DATETIME NULL,
    [LOGIN_TIME] VARCHAR(25) NULL,
    [STATUS] VARCHAR(100) NULL,
    [SEGMENT] VARCHAR(100) NULL,
    [FNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOGINFILE_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[LOGINFILE_TEMP]
(
    [PARTY_cODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(200) NULL,
    [BRANCH] VARCHAR(25) NULL,
    [LOGIN_DATE] DATETIME NULL,
    [LOGIN_TIME] VARCHAR(25) NULL,
    [STATUS] VARCHAR(100) NULL,
    [SEGMENT] VARCHAR(100) NULL,
    [FNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.m_mis_to
-- --------------------------------------------------
CREATE TABLE [dbo].[m_mis_to]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(10) NULL,
    [Region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [dummy1] VARCHAR(10) NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mapping_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[mapping_temp]
(
    [pcode] VARCHAR(10) NULL,
    [executive] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Master]
(
    [SrNo] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCX_client
-- --------------------------------------------------
CREATE TABLE [dbo].[MCX_client]
(
    [Column 0] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MessageTable
-- --------------------------------------------------
CREATE TABLE [dbo].[MessageTable]
(
    [message] CHAR(80) NULL,
    [today] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.minTbl
-- --------------------------------------------------
CREATE TABLE [dbo].[minTbl]
(
    [BSE_TRD_TO] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS$
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS$]
(
    [Annexure] NVARCHAR(255) NULL,
    [Approved_User_Name] NVARCHAR(255) NULL,
    [Neat_CTCL_Id] NVARCHAR(255) NULL,
    [NEAT_ID] FLOAT NULL,
    [CTCL_ID] FLOAT NULL,
    [Segment] NVARCHAR(255) NULL,
    [Region ] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [SB] NVARCHAR(255) NULL,
    [OdinId] NVARCHAR(255) NULL,
    [CertificateRegistrationNo] NVARCHAR(255) NULL,
    [Remarks] NVARCHAR(255) NULL,
    [Emp_Code_Expiry] NVARCHAR(255) NULL,
    [Terminal Type] NVARCHAR(255) NULL,
    [TurnOver] MONEY NULL,
    [SegmentTurnover] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_br
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_br]
(
    [branch_cd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_Client_grade
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_Client_grade]
(
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [TmonthNo] INT NULL,
    [Tmonth] NVARCHAR(30) NULL,
    [TYear] NVARCHAR(30) NULL,
    [Turnover] MONEY NOT NULL,
    [Brokerage] MONEY NOT NULL,
    [grade] VARCHAR(5) NOT NULL,
    [Status] VARCHAR(3) NOT NULL,
    [grade_no] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_ebroking
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_ebroking]
(
    [Sauda_Date] DATETIME NULL,
    [terminal_id] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [ABLCM_TO] MONEY NULL,
    [ACDLCM_TO] MONEY NULL,
    [ACDLFO_TO] MONEY NULL,
    [ABLCM_BRK] MONEY NULL,
    [ACDLCM_BRK] MONEY NULL,
    [ACDLFO_BRK] MONEY NULL,
    [Turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [Mcx_turn] MONEY NULL,
    [Mcx_brok] MONEY NULL,
    [ncdx_turn] MONEY NULL,
    [ncdx_brok] MONEY NULL,
    [user_stat] VARCHAR(10) NULL,
    [dealer_Code] VARCHAR(25) NULL,
    [Login_status] VARCHAR(1) NULL,
    [active_from] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_ebroking_cli_tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_ebroking_cli_tbl]
(
    [sauda_date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [ablcm_to] MONEY NULL,
    [acdlcm_to] MONEY NULL,
    [acdlfo_to] MONEY NULL,
    [ablcm_brk] MONEY NULL,
    [acdlcm_brk] MONEY NULL,
    [acdlfo_brk] MONEY NULL,
    [mcx_turn] MONEY NULL,
    [mcx_brok] MONEY NULL,
    [ncdx_brok] MONEY NULL,
    [ncdx_turn] MONEY NULL,
    [turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [nooflogin] VARCHAR(1) NULL,
    [user_stat] VARCHAR(10) NULL,
    [active_from] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_NoOfTrade
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_NoOfTrade]
(
    [sauda_date] DATETIME NULL,
    [company] VARCHAR(10) NULL,
    [party_code] VARCHAR(12) NULL,
    [nooftrade] INT NULL,
    [terminal_id] VARCHAR(6) NULL,
    [ebrok] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_TO_Branch
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_TO_Branch]
(
    [company] VARCHAR(10) NULL,
    [region] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(20) NULL,
    [sauda_Date] DATETIME NULL,
    [turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_to_bsecm
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_to_bsecm]
(
    [Company] VARCHAR(5) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to_bsedb
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to_bsedb]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(10) NULL,
    [Region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [dummy1] VARCHAR(10) NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_To_Company
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_To_Company]
(
    [company] VARCHAR(10) NULL,
    [sauda_Date] DATETIME NULL,
    [turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to_hist]
(
    [Company] VARCHAR(10) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to_history
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to_history]
(
    [Company] VARCHAR(10) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_to_Nsecm
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_to_Nsecm]
(
    [Company] VARCHAR(6) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(50) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_to_nsefo
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_to_nsefo]
(
    [Company] VARCHAR(6) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_to_nsefo1
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_to_nsefo1]
(
    [Company] VARCHAR(6) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_TO_Region
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_TO_Region]
(
    [company] VARCHAR(10) NULL,
    [region] VARCHAR(50) NULL,
    [sauda_Date] DATETIME NULL,
    [turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_TO_SB
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_TO_SB]
(
    [company] VARCHAR(10) NULL,
    [region] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [sauda_Date] DATETIME NULL,
    [turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to_Shift
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to_Shift]
(
    [SAUDA_DATE] DATETIME NULL,
    [branch] VARCHAR(12) NULL,
    [sub_broker] VARCHAR(12) NULL,
    [Terminal_Id] VARCHAR(30) NULL,
    [Shift] INT NOT NULL,
    [no_of_trade] INT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [Segment] VARCHAR(10) NULL,
    [symbol] VARCHAR(30) NULL,
    [expirydate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to_temp]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(10) NULL,
    [Region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [dummy1] VARCHAR(10) NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to_temp31July
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to_temp31July]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(10) NULL,
    [Region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [dummy1] VARCHAR(10) NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to_temp31July_TurnOver
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to_temp31July_TurnOver]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(10) NULL,
    [Region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [dummy1] VARCHAR(10) NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_TO_Terminal
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_TO_Terminal]
(
    [company] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NULL,
    [sauda_Date] DATETIME NULL,
    [turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_TO_Terminal_Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_TO_Terminal_Detail]
(
    [company] VARCHAR(10) NULL,
    [region] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [terminal_id] VARCHAR(10) NULL,
    [sauda_Date] DATETIME NULL,
    [turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_to1
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_to1]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(10) NULL,
    [Region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [dummy1] VARCHAR(10) NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MISTotal
-- --------------------------------------------------
CREATE TABLE [dbo].[MISTotal]
(
    [Volume] MONEY NULL,
    [TurnOver] MONEY NULL,
    [Brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mngrwise
-- --------------------------------------------------
CREATE TABLE [dbo].[mngrwise]
(
    [branch_cd] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [odin_server] VARCHAR(11) NOT NULL,
    [ablcm_to] MONEY NULL,
    [acdlcm_to] MONEY NULL,
    [acdlfo_to] MONEY NULL,
    [ablcm_brk] MONEY NULL,
    [acdlcm_brk] MONEY NULL,
    [acdlfo_brk] MONEY NULL,
    [mcx_turn] MONEY NULL,
    [mcx_brok] MONEY NULL,
    [ncdx_brok] MONEY NULL,
    [ncdx_turn] MONEY NULL,
    [turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [nooflogin] INT NULL,
    [active_from] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NRI_SAUDA_SUMMARY
-- --------------------------------------------------
CREATE TABLE [dbo].[NRI_SAUDA_SUMMARY]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [TERMINAL_ID] VARCHAR(500) NULL,
    [SAUDA_DATE] VARCHAR(30) NULL,
    [SELL_BUY] VARCHAR(1) NOT NULL,
    [Segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Nse
-- --------------------------------------------------
CREATE TABLE [dbo].[Nse]
(
    [Branch_cd] VARCHAR(255) NULL,
    [Sub_Broker] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nse_position
-- --------------------------------------------------
CREATE TABLE [dbo].[nse_position]
(
    [sauda_Date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [scripname] VARCHAR(30) NOT NULL,
    [isin] VARCHAR(20) NOT NULL,
    [pqty] INT NULL,
    [pamt] MONEY NULL,
    [sqty] INT NULL,
    [samt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecm_test
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecm_test]
(
    [Company] VARCHAR(6) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(50) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Nsefo
-- --------------------------------------------------
CREATE TABLE [dbo].[Nsefo]
(
    [Branch_cd] VARCHAR(255) NULL,
    [Sub_Broker] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSEFO_DATA_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[NSEFO_DATA_temp]
(
    [party_code] VARCHAR(20) NULL,
    [symbol] VARCHAR(25) NULL,
    [inst_type] VARCHAR(25) NULL,
    [expirydate] DATETIME NULL,
    [strike_price] MONEY NULL,
    [user_id] VARCHAR(25) NULL,
    [Buy] VARCHAR(1) NOT NULL,
    [Sell] VARCHAR(1) NOT NULL,
    [Buyqty] INT NOT NULL,
    [Sellqty] INT NOT NULL,
    [b_rate] MONEY NOT NULL,
    [s_rate] MONEY NOT NULL,
    [RateDiff] MONEY NULL,
    [BAmt] MONEY NULL,
    [SAmt] MONEY NULL,
    [Tover] INT NULL,
    [pL] MONEY NULL,
    [long_name] VARCHAR(100) NULL,
    [status] VARCHAR(7) NOT NULL,
    [Mobile] VARCHAR(1) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsefosundryclientmark
-- --------------------------------------------------
CREATE TABLE [dbo].[nsefosundryclientmark]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL,
    [BseCm] MONEY NULL,
    [NseCm] MONEY NULL,
    [NSeFo] MONEY NULL,
    [party_code] VARCHAR(10) NULL,
    [StatusName] CHAR(20) NULL,
    [UpdateDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NseFoSundryClientReco
-- --------------------------------------------------
CREATE TABLE [dbo].[NseFoSundryClientReco]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NseFOSundryclientreco1
-- --------------------------------------------------
CREATE TABLE [dbo].[NseFOSundryclientreco1]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsesundryclientmark
-- --------------------------------------------------
CREATE TABLE [dbo].[nsesundryclientmark]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL,
    [BseCm] MONEY NULL,
    [NseCm] MONEY NULL,
    [NSeFo] MONEY NULL,
    [party_code] VARCHAR(10) NULL,
    [StatusName] CHAR(20) NULL,
    [UpdateDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NseSundryClientReco
-- --------------------------------------------------
CREATE TABLE [dbo].[NseSundryClientReco]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NseSundryclientreco1
-- --------------------------------------------------
CREATE TABLE [dbo].[NseSundryclientreco1]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(10) NULL,
    [ddno] VARCHAR(50) NULL,
    [vtyp] CHAR(10) NULL,
    [vno] CHAR(20) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(2) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [CheckedBy] VARCHAR(20) NULL,
    [Narration] VARCHAR(200) NULL,
    [Branch] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Oct_10
-- --------------------------------------------------
CREATE TABLE [dbo].[Oct_10]
(
    [Client] NVARCHAR(255) NULL,
    [Sub_broker] NVARCHAR(255) NULL,
    [Executive] NVARCHAR(255) NULL,
    [First date of trade] NVARCHAR(255) NULL,
    [TO] NVARCHAR(255) NULL,
    [BRKRG] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.oct_cllist06
-- --------------------------------------------------
CREATE TABLE [dbo].[oct_cllist06]
(
    [client] NVARCHAR(255) NULL,
    [Executive] NVARCHAR(255) NULL,
    [PARTY_CODE] NVARCHAR(255) NULL,
    [branch_cd] NVARCHAR(255) NULL,
    [sub_broker] NVARCHAR(255) NULL,
    [OCT 2006 Brokerage] NVARCHAR(255) NULL,
    [Oct 2006 TO] NVARCHAR(255) NULL,
    [ActiveFrom] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Odine_server_ebrok
-- --------------------------------------------------
CREATE TABLE [dbo].[Odine_server_ebrok]
(
    [odin_server] VARCHAR(15) NULL,
    [odin_name] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.overall_mrg
-- --------------------------------------------------
CREATE TABLE [dbo].[overall_mrg]
(
    [BrokerCode] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [PArty_name] VARCHAR(50) NULL,
    [dummy1] INT NULL,
    [Scrip_cd] VARCHAR(10) NULL,
    [Qty] INT NULL,
    [Funding_amt] MONEY NULL,
    [Funding_date] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pe_data
-- --------------------------------------------------
CREATE TABLE [dbo].[pe_data]
(
    [company] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [region] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [TO_intraday] MONEY NULL,
    [TO_Delivery] MONEY NULL,
    [Turnover] MONEY NULL,
    [Brk_intraday] MONEY NULL,
    [Brk_Delivery] MONEY NULL,
    [brokerage] MONEY NULL,
    [B2B] VARCHAR(1) NOT NULL,
    [INS] CHAR(1) NULL,
    [branch_city] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pe_data_fo
-- --------------------------------------------------
CREATE TABLE [dbo].[pe_data_fo]
(
    [party_code] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [futurestradedvalue] MONEY NULL,
    [optionstradedvalue] MONEY NULL,
    [excercisevalue] MONEY NULL,
    [assignmentvalue] INT NOT NULL,
    [closeoutvalue] MONEY NULL,
    [total] MONEY NULL,
    [brokerage] MONEY NULL,
    [servicetax] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turnovertax] MONEY NULL,
    [sebitax] MONEY NULL,
    [stampduty] MONEY NULL,
    [clearingcharges] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pe_franch_sharing_perc
-- --------------------------------------------------
CREATE TABLE [dbo].[pe_franch_sharing_perc]
(
    [ftag] VARCHAR(8) NOT NULL,
    [b2c_income] FLOAT NULL,
    [b2b_income] FLOAT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mmonth] INT NULL,
    [myear] INT NULL,
    [b2c_income_f] MONEY NULL,
    [b2b_income_f] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PE_MF
-- --------------------------------------------------
CREATE TABLE [dbo].[PE_MF]
(
    [TxDAte] DATETIME NULL,
    [party_code] VARCHAR(50) NULL,
    [LogicalLedger] NUMERIC(19, 2) NULL,
    [Volume] MONEY NULL,
    [DeliveryTO] MONEY NULL,
    [IntradayTO] MONEY NULL,
    [DerivativesTO] MONEY NULL,
    [DrDaysMF] INT NULL,
    [DrDaysBrok] INT NULL,
    [TradingDay] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pe_net_brok
-- --------------------------------------------------
CREATE TABLE [dbo].[pe_net_brok]
(
    [company] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [branch] VARCHAR(10) NULL,
    [party_code] CHAR(20) NULL,
    [brokerage] MONEY NULL,
    [Net] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pe_nooftrade
-- --------------------------------------------------
CREATE TABLE [dbo].[pe_nooftrade]
(
    [company] VARCHAR(9) NOT NULL,
    [sauda_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [nooftrade] INT NULL,
    [terminal_id] INT NULL,
    [ebrok] CHAR(1) NULL,
    [sb] CHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pp0306$
-- --------------------------------------------------
CREATE TABLE [dbo].[pp0306$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [ActiveFrom] DATETIME NULL,
    [ExpiryDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PP3$
-- --------------------------------------------------
CREATE TABLE [dbo].[PP3$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [ActiveFromDt] DATETIME NULL,
    [ExpiryDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PP5$
-- --------------------------------------------------
CREATE TABLE [dbo].[PP5$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [ActiveFromDt] DATETIME NULL,
    [ExpiryDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PP6$
-- --------------------------------------------------
CREATE TABLE [dbo].[PP6$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [ActiveFromDt] DATETIME NULL,
    [ExpiryDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PPDATA$
-- --------------------------------------------------
CREATE TABLE [dbo].[PPDATA$]
(
    [Party_Code] NVARCHAR(255) NULL,
    [Party_Name] NVARCHAR(255) NULL,
    [Active_FromDt] DATETIME NULL,
    [Expiry_Dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PPFinal$
-- --------------------------------------------------
CREATE TABLE [dbo].[PPFinal$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [PartyName] NVARCHAR(255) NULL,
    [VocName] FLOAT NULL,
    [Mode Of Pay] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Request Dt#] DATETIME NULL,
    [ActiveFromDate] DATETIME NULL,
    [ExpiryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PPnew$
-- --------------------------------------------------
CREATE TABLE [dbo].[PPnew$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [PartyName] NVARCHAR(255) NULL,
    [VocName] FLOAT NULL,
    [RequestDt] DATETIME NULL,
    [ActiveFrom] DATETIME NULL,
    [ExpiryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prepaid
-- --------------------------------------------------
CREATE TABLE [dbo].[prepaid]
(
    [Party Code] NVARCHAR(255) NULL,
    [Party Name] NVARCHAR(255) NULL,
    [Active From Dt#] DATETIME NULL,
    [Expiry Dt#] DATETIME NULL,
    [brok] DECIMAL(14, 2) NULL,
    [noofdaystraded] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pune1
-- --------------------------------------------------
CREATE TABLE [dbo].[pune1]
(
    [IN_DPID] CHAR(25) NULL,
    [IN_ACNO] CHAR(25) NULL,
    [IN_NAME] CHAR(30) NULL,
    [IN_ADD1] CHAR(30) NULL,
    [IN_ADD2] CHAR(30) NULL,
    [IN_ADD3] CHAR(30) NULL,
    [IN_ADD4] VARCHAR(30) NULL,
    [IN_PIN] VARCHAR(30) NULL,
    [TELEPHONE] VARCHAR(30) NULL,
    [IN_SHARES] INT NULL,
    [Closing] MONEY NULL,
    [CO_NAME] CHAR(30) NULL,
    [IN_SHARES1] INT NULL,
    [Closing1] MONEY NULL,
    [CO_NAME1] CHAR(30) NULL,
    [IN_SHARES2] INT NULL,
    [Closing2] MONEY NULL,
    [CO_NAME2] CHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_CLient_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_CLient_Details]
(
    [Heading] VARCHAR(5000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QueryTimeTest
-- --------------------------------------------------
CREATE TABLE [dbo].[QueryTimeTest]
(
    [qtime] NVARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rashmi
-- --------------------------------------------------
CREATE TABLE [dbo].[Rashmi]
(
    [sub_broker] VARCHAR(10) NULL,
    [bsecm_to] MONEY NULL,
    [nsecm_to] MONEY NULL,
    [nsefo_to] MONEY NULL,
    [mcx_to] MONEY NULL,
    [mcdex_to] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rcs_cl_details
-- --------------------------------------------------
CREATE TABLE [dbo].[Rcs_cl_details]
(
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [cl_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [Long_name] VARCHAR(100) NULL,
    [l_address1] VARCHAR(40) NOT NULL,
    [l_address2] VARCHAR(40) NULL,
    [l_address3] VARCHAR(40) NULL,
    [l_city] VARCHAR(40) NULL,
    [L_state] VARCHAR(50) NULL,
    [l_zip] VARCHAR(10) NULL,
    [dpid1] VARCHAR(16) NULL,
    [cltdpid1] VARCHAR(16) NULL,
    [bank_name] VARCHAR(50) NULL,
    [Branch_name] VARCHAR(50) NULL,
    [Ac_num] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rcs_cl_details1
-- --------------------------------------------------
CREATE TABLE [dbo].[Rcs_cl_details1]
(
    [branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [cl_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [Long_name] VARCHAR(100) NULL,
    [l_address1] VARCHAR(40) NOT NULL,
    [l_address2] VARCHAR(40) NULL,
    [l_address3] VARCHAR(40) NULL,
    [l_city] VARCHAR(40) NULL,
    [L_state] VARCHAR(50) NULL,
    [l_zip] VARCHAR(10) NULL,
    [dpid1] VARCHAR(16) NULL,
    [cltdpid1] VARCHAR(16) NULL,
    [bank_name] VARCHAR(50) NULL,
    [Branch_name] VARCHAR(50) NULL,
    [Ac_num] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RegionBranchTag
-- --------------------------------------------------
CREATE TABLE [dbo].[RegionBranchTag]
(
    [vno] CHAR(20) NULL,
    [vtyp] CHAR(10) NULL,
    [vdt] DATETIME NULL,
    [drcr] CHAR(2) NULL,
    [regioninput] VARCHAR(20) NULL,
    [branchinput] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.report_excel
-- --------------------------------------------------
CREATE TABLE [dbo].[report_excel]
(
    [HEADING] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ReportOffset
-- --------------------------------------------------
CREATE TABLE [dbo].[ReportOffset]
(
    [Report_Name] NVARCHAR(50) NOT NULL,
    [Col_Name] NVARCHAR(50) NOT NULL,
    [Col_Width] SMALLINT NOT NULL,
    [Col_Align] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.result
-- --------------------------------------------------
CREATE TABLE [dbo].[result]
(
    [status] VARCHAR(19) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rm_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[rm_temp]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [SqOffDate] DATETIME NULL,
    [CF] CHAR(1) NULL,
    [valid] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rmbillvalan
-- --------------------------------------------------
CREATE TABLE [dbo].[rmbillvalan]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [SqOffDate] DATETIME NULL,
    [CF] CHAR(1) NULL DEFAULT 'Y',
    [valid] CHAR(1) NULL DEFAULT 'Y',
    [srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rmbillvalan1
-- --------------------------------------------------
CREATE TABLE [dbo].[rmbillvalan1]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [SqOffDate] DATETIME NULL,
    [CF] CHAR(1) NULL,
    [valid] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rmbillvalan2
-- --------------------------------------------------
CREATE TABLE [dbo].[rmbillvalan2]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [SqOffDate] DATETIME NULL,
    [CF] CHAR(1) NULL,
    [valid] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.roz
-- --------------------------------------------------
CREATE TABLE [dbo].[roz]
(
    [mgr_code] VARCHAR(10) NULL,
    [mod_date] VARCHAR(20) NULL,
    [corr_date] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB
-- --------------------------------------------------
CREATE TABLE [dbo].[SB]
(
    [SB] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_Brok
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_Brok]
(
    [Segment] VARCHAR(255) NULL,
    [SB] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sb_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[sb_temp]
(
    [SB] NVARCHAR(255) NULL,
    [Date_From] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_TO
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_TO]
(
    [Branch] VARCHAR(255) NULL,
    [SB_Tag] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_TRADE_DETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_TRADE_DETAILS]
(
    [BRANCH_CD] VARCHAR(100) NULL,
    [SUB_BROKER] VARCHAR(100) NULL,
    [BSECM_TO_TRD_FUT] FLOAT NULL,
    [BSECM_TO_DEL_OPT] FLOAT NULL,
    [NSECM_TO_TRD_FUT] FLOAT NULL,
    [NSECM_TO_DEL_OPT] FLOAT NULL,
    [NSEFO_TO_TRD_FUT] FLOAT NULL,
    [NSEFO_TO_DEL_OPT] FLOAT NULL,
    [NCDEX_TO_TRD_FUT] FLOAT NULL,
    [NCDEX_TO_DEL_OPT] FLOAT NULL,
    [MCX_TO_TRD_FUT] FLOAT NULL,
    [MCX_TO_DEL_OPT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sblabel
-- --------------------------------------------------
CREATE TABLE [dbo].[sblabel]
(
    [valid] VARCHAR(1) NOT NULL,
    [company] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [name] CHAR(25) NOT NULL,
    [contact_person] VARCHAR(100) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [city] CHAR(20) NULL,
    [state] CHAR(15) NULL,
    [nation] CHAR(15) NULL,
    [zip] CHAR(10) NULL,
    [phone1] CHAR(15) NULL,
    [phone2] CHAR(15) NULL,
    [turnover] MONEY NULL,
    [brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sbwise_ClientPotential
-- --------------------------------------------------
CREATE TABLE [dbo].[Sbwise_ClientPotential]
(
    [Fyear] INT NULL,
    [Fmonth] INT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [cntparty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sbwise_TOBrok
-- --------------------------------------------------
CREATE TABLE [dbo].[Sbwise_TOBrok]
(
    [SYear] INT NULL,
    [Smonth] INT NULL,
    [Sub_broker] VARCHAR(20) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [tradingdays] INT NULL,
    [Tradedclients] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ScripMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[ScripMaster]
(
    [ISIN] VARCHAR(20) NULL,
    [Scrip_CD] VARCHAR(15) NULL,
    [ExchangeSegment] VARCHAR(8) NULL,
    [Scrip_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBI_ActiveCL
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBI_ActiveCL]
(
    [Cl_code] VARCHAR(10) NOT NULL,
    [PRN_Flag] VARCHAR(6) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBI_CLmailID
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBI_CLmailID]
(
    [Cl_code] VARCHAR(10) NOT NULL,
    [email] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] CHAR(7) NOT NULL,
    [Start_date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] DATETIME NULL,
    [Funds_Payout] DATETIME NULL,
    [Sec_Payin] DATETIME NULL,
    [Sec_Payout] DATETIME NULL,
    [Series] VARCHAR(3) NULL,
    [MarketType] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1]
(
    [Series No#] VARCHAR(20) NULL,
    [Account's Name] VARCHAR(50) NULL,
    [Group] VARCHAR(50) NULL,
    [Remark] VARCHAR(50) NULL,
    [F5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1$
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1$]
(
    [Branch#Code] NVARCHAR(255) NULL,
    [ori_sub_broker] NVARCHAR(255) NULL,
    [Party#Name] NVARCHAR(255) NULL,
    [Party#Code] NVARCHAR(255) NULL,
    [From Date] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SkCodes
-- --------------------------------------------------
CREATE TABLE [dbo].[SkCodes]
(
    [Party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sub_details
-- --------------------------------------------------
CREATE TABLE [dbo].[sub_details]
(
    [Sb_Code] VARCHAR(10) NULL,
    [Mcx_Brokerage] MONEY NOT NULL,
    [Ncdex_Brokerage] MONEY NOT NULL,
    [Mcx_Turnover] MONEY NOT NULL,
    [Ncdex_Turnover] MONEY NOT NULL,
    [sub_broker] VARCHAR(10) NULL,
    [mcx_no] INT NULL,
    [ncdx_no] INT NULL,
    [mcx_inactive] INT NOT NULL,
    [ncx_inactive] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sundry
-- --------------------------------------------------
CREATE TABLE [dbo].[sundry]
(
    [chqnogiven] VARCHAR(50) NULL,
    [chqdategiven] DATETIME NULL,
    [banknamegiven] VARCHAR(50) NULL,
    [vamt] MONEY NULL,
    [BseCm] MONEY NULL,
    [NseCm] MONEY NULL,
    [NSEFO] MONEY NULL,
    [MCDX] MONEY NULL,
    [NCDX] MONEY NULL,
    [party_code] VARCHAR(10) NULL,
    [StatusName] VARCHAR(50) NULL,
    [UpdateDate] SMALLDATETIME NULL,
    [ProofBy] VARCHAR(50) NULL,
    [ProofDate] DATETIME NULL,
    [Branch] VARCHAR(50) NULL,
    [Remarks] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t2
-- --------------------------------------------------
CREATE TABLE [dbo].[t2]
(
    [br] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tb
-- --------------------------------------------------
CREATE TABLE [dbo].[tb]
(
    [bRANCH_cd] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [B2B_clt] VARCHAR(10) NULL,
    [turnover] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tb_Pivot
-- --------------------------------------------------
CREATE TABLE [dbo].[Tb_Pivot]
(
    [Party_code] VARCHAR(10) NULL,
    [Family] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [OYear] INT NULL,
    [JanTradingTurnover] MONEY NULL,
    [JanDelTurnover] MONEY NULL,
    [JanBrokerage] MONEY NULL,
    [JanDelBrokerage] MONEY NULL,
    [JanSertax] MONEY NULL,
    [JanOtherlevies] MONEY NULL,
    [FebTradingTurnover] MONEY NULL,
    [FebDelTurnover] MONEY NULL,
    [FebBrokerage] MONEY NULL,
    [FebDelBrokerage] MONEY NULL,
    [FebSertax] MONEY NULL,
    [FebOtherlevies] MONEY NULL,
    [MArTradingTurnover] MONEY NULL,
    [MarDelTurnover] MONEY NULL,
    [MarBrokerage] MONEY NULL,
    [MarDelBrokerage] MONEY NULL,
    [MarSertax] MONEY NULL,
    [MarOtherlevies] MONEY NULL,
    [AprTradingTurnover] MONEY NULL,
    [AprDelTurnover] MONEY NULL,
    [AprBrokerage] MONEY NULL,
    [AprDelBrokerage] MONEY NULL,
    [AprSertax] MONEY NULL,
    [AprOtherlevies] MONEY NULL,
    [MayTradingTurnover] MONEY NULL,
    [MayDelTurnover] MONEY NULL,
    [MayBrokerage] MONEY NULL,
    [MayDelBrokerage] MONEY NULL,
    [MaySertax] MONEY NULL,
    [MayOtherlevies] MONEY NULL,
    [JunTradingTurnover] MONEY NULL,
    [JunDelTurnover] MONEY NULL,
    [JunBrokerage] MONEY NULL,
    [JunDelBrokerage] MONEY NULL,
    [JunSertax] MONEY NULL,
    [JunOtherlevies] MONEY NULL,
    [JulTradingTurnover] MONEY NULL,
    [JulDelTurnover] MONEY NULL,
    [JulBrokerage] MONEY NULL,
    [JulDelBrokerage] MONEY NULL,
    [JulSertax] MONEY NULL,
    [JulOtherlevies] MONEY NULL,
    [AugTradingTurnover] MONEY NULL,
    [AugDelTurnover] MONEY NULL,
    [AugBrokerage] MONEY NULL,
    [AugDelBrokerage] MONEY NULL,
    [AugSertax] MONEY NULL,
    [AugOtherlevies] MONEY NULL,
    [SepTradingTurnover] MONEY NULL,
    [SepDelTurnover] MONEY NULL,
    [SepBrokerage] MONEY NULL,
    [SepDelBrokerage] MONEY NULL,
    [SepSertax] MONEY NULL,
    [SepOtherlevies] MONEY NULL,
    [OctTradingTurnover] MONEY NULL,
    [OctDelTurnover] MONEY NULL,
    [OctBrokerage] MONEY NULL,
    [OctDelBrokerage] MONEY NULL,
    [OctSertax] MONEY NULL,
    [OctOtherlevies] MONEY NULL,
    [NovTradingTurnover] MONEY NULL,
    [NovDelTurnover] MONEY NULL,
    [NovBrokerage] MONEY NULL,
    [NovDelBrokerage] MONEY NULL,
    [NovSertax] MONEY NULL,
    [NovOtherlevies] MONEY NULL,
    [DecTradingTurnover] MONEY NULL,
    [DecDelTurnover] MONEY NULL,
    [DecBrokerage] MONEY NULL,
    [DecDelBrokerage] MONEY NULL,
    [DecSertax] MONEY NULL,
    [DecOtherlevies] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Admin_Login
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Admin_Login]
(
    [Login_id] NUMERIC(18, 0) IDENTITY(101,1) NOT NULL,
    [Login_Name] VARCHAR(25) NULL,
    [Login_Password] VARCHAR(50) NULL,
    [First_Name] VARCHAR(25) NULL,
    [Middle_Name] VARCHAR(25) NULL,
    [Last_Name] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Client_First_Date
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Client_First_Date]
(
    [party_Code] VARCHAR(10) NOT NULL,
    [First_trade_date] DATETIME NULL,
    [BSECM_FirstTradeDate] DATETIME NULL,
    [NSECM_FirstTradeDate] DATETIME NULL,
    [NSEFO_FirstTradeDate] DATETIME NULL,
    [MCX_FirstTradeDate] DATETIME NULL,
    [NCDEX_FirstTradeDate] DATETIME NULL,
    [MCD_FirstTradeDate] DATETIME NULL,
    [NSX_FirstTradeDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_cmn_usr_rm
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_cmn_usr_rm]
(
    [RM_User_Id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [cmn_usr_name] VARCHAR(25) NULL,
    [RM_Party_Code] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_common_login
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_common_login]
(
    [cmn_usr_name] VARCHAR(25) NOT NULL,
    [cmn_usr_pwd] VARCHAR(15) NOT NULL,
    [first_name] VARCHAR(25) NOT NULL,
    [middle_name] VARCHAR(25) NULL,
    [last_name] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_common_login_bo
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_common_login_bo]
(
    [exchseg] VARCHAR(20) NOT NULL,
    [cmn_usr_name] VARCHAR(25) NOT NULL,
    [bo_usr_name] VARCHAR(25) NOT NULL,
    [bo_usr_pwd] VARCHAR(15) NOT NULL,
    [bo_usr_admin_id] BIGINT NOT NULL,
    [bo_usr_category] BIGINT NOT NULL,
    [bo_usr_status_id] VARCHAR(25) NOT NULL,
    [bo_usr_status_name] VARCHAR(25) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_common_login_serverinfo
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_common_login_serverinfo]
(
    [application] VARCHAR(25) NOT NULL,
    [exchange] VARCHAR(5) NULL,
    [segment] VARCHAR(15) NULL,
    [servername] VARCHAR(25) NOT NULL,
    [dbname] VARCHAR(25) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_fifo_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_fifo_temp]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [SqOffDate] DATETIME NULL,
    [CF] CHAR(1) NULL,
    [valid] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MIN_ARPC_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MIN_ARPC_TEMP]
(
    [Party_code] VARCHAR(10) NULL,
    [Sauda_date] DATETIME NULL,
    [Company] VARCHAR(10) NULL,
    [Turnover] DECIMAL(10, 2) NULL,
    [Brokerage] DECIMAL(10, 2) NULL,
    [ARPC] DECIMAL(10, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Rpt_UT
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Rpt_UT]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [clt_code] VARCHAR(10) NULL,
    [turnover] MONEY NULL,
    [to_trd_fut] MONEY NULL,
    [to_del_opt] MONEY NULL,
    [Receipt] MONEY NOT NULL,
    [Payment] MONEY NOT NULL,
    [Flag] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Trade_Alert_Nsefo_summary
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Trade_Alert_Nsefo_summary]
(
    [party_code] VARCHAR(25) NULL,
    [symbol] VARCHAR(50) NULL,
    [inst_type] VARCHAR(50) NULL,
    [expirydate] VARCHAR(50) NULL,
    [strike_price] MONEY NULL,
    [user_id] VARCHAR(30) NULL,
    [Buy] VARCHAR(50) NULL,
    [Sell] VARCHAR(50) NULL,
    [Buyqty] INT NULL,
    [Sellqty] INT NULL,
    [b_rate] DECIMAL(18, 0) NULL,
    [s_rate] DECIMAL(18, 0) NULL,
    [RateDiff] DECIMAL(18, 0) NULL,
    [BAmt] MONEY NULL,
    [SAmt] MONEY NULL,
    [Tover] MONEY NULL,
    [pL] DECIMAL(18, 0) NULL,
    [long_name] VARCHAR(100) NULL,
    [status] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbladmin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbladmin]
(
    [fldauto_admin] INT NOT NULL,
    [fldname] VARCHAR(30) NOT NULL,
    [fldpassword] VARCHAR(30) NOT NULL,
    [fldcompany] VARCHAR(50) NULL,
    [fldstname] VARCHAR(50) NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [flddesc] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory]
(
    [fldcategorycode] INT NOT NULL,
    [fldcategoryname] VARCHAR(50) NOT NULL,
    [fldadminauto] INT NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblMarketExecFieldMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblMarketExecFieldMaster]
(
    [MarketExecFieldId] BIGINT NOT NULL,
    [FieldExecName] VARCHAR(100) NOT NULL,
    [MarketExecRegionId] BIGINT NOT NULL,
    [Region] VARCHAR(100) NOT NULL,
    [ExchSeg] VARCHAR(15) NOT NULL,
    [Field] VARCHAR(100) NOT NULL,
    [Deleted] VARCHAR(1) NOT NULL,
    [Eff_FromDate] DATETIME NOT NULL,
    [Eff_ToDate] DATETIME NOT NULL,
    [dummy01] VARCHAR(1) NOT NULL,
    [dummy02] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblMarketExecRegionMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblMarketExecRegionMaster]
(
    [MarketExecRegionId] BIGINT NOT NULL,
    [ExecName] VARCHAR(100) NOT NULL,
    [MarketHeadId] BIGINT NOT NULL,
    [ExchSeg] VARCHAR(15) NOT NULL,
    [Region] VARCHAR(100) NOT NULL,
    [Deleted] VARCHAR(1) NOT NULL,
    [Eff_FromDate] DATETIME NOT NULL,
    [Eff_ToDate] DATETIME NOT NULL,
    [dummy01] VARCHAR(1) NOT NULL,
    [dummy02] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblMarketHeadMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblMarketHeadMaster]
(
    [MarketHeadId] BIGINT NOT NULL,
    [MarketHeadName] VARCHAR(100) NOT NULL,
    [Deleted] CHAR(1) NOT NULL,
    [Eff_FromDate] DATETIME NOT NULL,
    [Eff_ToDate] DATETIME NOT NULL,
    [dummy01] VARCHAR(1) NOT NULL,
    [dummy02] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblMarketRegionMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblMarketRegionMaster]
(
    [RegionId] BIGINT NOT NULL,
    [Region] VARCHAR(100) NOT NULL,
    [Deleted] VARCHAR(1) NOT NULL,
    [Eff_FromDate] DATETIME NOT NULL,
    [Eff_ToDate] DATETIME NOT NULL,
    [dummy01] VARCHAR(1) NOT NULL,
    [dummy02] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblMarketWorkDoneMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblMarketWorkDoneMaster]
(
    [MarketWorkDoneId] BIGINT NOT NULL,
    [MarketHeadId] BIGINT NOT NULL,
    [MarketExecRegionId] BIGINT NOT NULL,
    [MarketExecFieldId] BIGINT NOT NULL,
    [ExchSeg] VARCHAR(15) NOT NULL,
    [BranchCode] VARCHAR(10) NOT NULL,
    [SubbrokerOrRemisierCode] VARCHAR(10) NOT NULL,
    [Deleted] VARCHAR(1) NOT NULL,
    [Eff_FromDate] DATETIME NOT NULL,
    [Eff_ToDate] DATETIME NOT NULL,
    [dummy01] VARCHAR(1) NOT NULL,
    [dummy02] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPradnyausers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPradnyausers]
(
    [fldauto] INT NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPradnyausers1
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPradnyausers1]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPradnyausers2
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPradnyausers2]
(
    [fldauto] INT NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblTerminals
-- --------------------------------------------------
CREATE TABLE [dbo].[tblTerminals]
(
    [Terminal_ID] VARCHAR(10) NOT NULL,
    [ExchangeSegment] VARCHAR(20) NULL,
    [DateFrom] DATETIME NULL,
    [DateTo] DATETIME NULL,
    [HeadingType] VARCHAR(50) NULL,
    [Dummy1] VARCHAR(50) NULL,
    [Dummy2] VARCHAR(50) NULL,
    [Trade_Type] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblTrackingVisits
-- --------------------------------------------------
CREATE TABLE [dbo].[tblTrackingVisits]
(
    [Log_id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Log_Date] DATETIME NULL,
    [TCP_IP] VARCHAR(25) NULL,
    [URL] VARCHAR(1000) NULL,
    [Browser] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUpdateMISLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUpdateMISLog]
(
    [Log_id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Log_Date] DATETIME NOT NULL,
    [ExchangeSegment] VARCHAR(25) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL,
    [UpdatedBy] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbluserslog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbluserslog]
(
    [fldusername] VARCHAR(25) NULL,
    [fldcategory] VARCHAR(25) NULL,
    [segment] VARCHAR(25) NULL,
    [ipaddress] VARCHAR(25) NULL,
    [login_time] DATETIME NULL DEFAULT (getdate()),
    [logout_time] DATETIME NULL DEFAULT '1/1/2050',
    [status] INT NULL DEFAULT 1,
    [dummy1] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tejal
-- --------------------------------------------------
CREATE TABLE [dbo].[tejal]
(
    [segment] VARCHAR(15) NULL,
    [pcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_abc
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_abc]
(
    [sauda_DAte] DATETIME NULL,
    [brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_BrkData
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_BrkData]
(
    [MonthYear] VARCHAR(25) NULL,
    [B2BTotTO] MONEY NULL,
    [B2BDelTO] MONEY NULL,
    [B2BGrsRev] MONEY NULL,
    [B2BDelGrsRev] MONEY NULL,
    [B2BNetRev] MONEY NULL,
    [B2BDelNetRev] MONEY NULL,
    [B2CTotTO] MONEY NULL,
    [B2CDelTO] MONEY NULL,
    [B2CGrsRev] MONEY NULL,
    [B2CDelGrsRev] MONEY NULL,
    [B2CNetRev] MONEY NULL,
    [B2CDelNetRev] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_BrkData1
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_BrkData1]
(
    [MonthYear] VARCHAR(25) NULL,
    [B2BTotTO] MONEY NULL,
    [B2BDelTO] MONEY NULL,
    [B2BGrsRev] MONEY NULL,
    [B2BDelGrsRev] MONEY NULL,
    [B2BNetRev] MONEY NULL,
    [B2BDelNetRev] MONEY NULL,
    [B2CTotTO] MONEY NULL,
    [B2CDelTO] MONEY NULL,
    [B2CGrsRev] MONEY NULL,
    [B2CDelGrsRev] MONEY NULL,
    [B2CNetRev] MONEY NULL,
    [B2CDelNetRev] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_Brokdata
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_Brokdata]
(
    [Branch#Code] NVARCHAR(255) NULL,
    [ori_sub_broker] NVARCHAR(255) NULL,
    [Party#Name] NVARCHAR(255) NULL,
    [Party#Code] NVARCHAR(255) NULL,
    [From Date] NVARCHAR(255) NULL,
    [Tdays] VARCHAR(5) NULL,
    [Brokerage] MONEY NULL,
    [LastTradeDate] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_Brokdatafinal
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_Brokdatafinal]
(
    [Region] VARCHAR(10) NULL,
    [Branch] VARCHAR(15) NULL,
    [Category] VARCHAR(25) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Activation_date] VARCHAR(25) NULL,
    [Turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TdatyInEQ] VARCHAR(10) NULL,
    [TdaysInCmdty] VARCHAR(10) NULL,
    [Tdays_comb] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [fmaxslab] VARCHAR(25) NULL,
    [Smaxslab] VARCHAR(25) NULL,
    [Dmaxslab] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_broke
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_broke]
(
    [party] VARCHAR(50) NULL,
    [broke] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_cl
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_cl]
(
    [Code] NVARCHAR(255) NULL,
    [Client Name] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_Cltcode
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_Cltcode]
(
    [PartyCode] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_Commo_date
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_Commo_date]
(
    [Sauda_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_date2
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_date2]
(
    [sub_broker] VARCHAR(10) NULL,
    [first_trade_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_DEc08
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_DEc08]
(
    [sauda_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(10) NULL,
    [brok] MONEY NULL,
    [brokonline] MONEY NULL,
    [dif] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_ebrok
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_ebrok]
(
    [pcode] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [loca] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_Ebrok_mis1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_Ebrok_mis1]
(
    [sauda_date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [bse_to] MONEY NULL,
    [nse_to] MONEY NULL,
    [fo_to] MONEY NULL,
    [mcx_to] MONEY NULL,
    [ncdex_to] MONEY NULL,
    [ebrok_to] MONEY NULL,
    [bse_br] MONEY NULL,
    [nse_br] MONEY NULL,
    [fo_br] MONEY NULL,
    [mcx_br] MONEY NULL,
    [ncdex_br] MONEY NULL,
    [ebrok_br] MONEY NULL,
    [ebse_br] MONEY NULL,
    [ense_br] MONEY NULL,
    [efo_br] MONEY NULL,
    [emcx_br] MONEY NULL,
    [encdex_br] MONEY NULL,
    [bse_stat] VARCHAR(1) NOT NULL,
    [nse_stat] VARCHAR(1) NOT NULL,
    [fo_stat] VARCHAR(1) NOT NULL,
    [mcdx_stat] VARCHAR(1) NOT NULL,
    [ncdx_stat] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_f
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_f]
(
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Name] VARCHAR(100) NULL,
    [BranchName] VARCHAR(100) NULL,
    [GeographicalRegion] VARCHAR(100) NULL,
    [Region] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_Feb09
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_Feb09]
(
    [sauda_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(10) NULL,
    [brok] MONEY NULL,
    [brokonline] MONEY NULL,
    [dif] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_HNI
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_HNI]
(
    [Branch_Cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Turnover] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_Jan08
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_Jan08]
(
    [sauda_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(10) NULL,
    [brok] MONEY NULL,
    [brokonline] MONEY NULL,
    [dif] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_log
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_log]
(
    [PARTY_cODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(200) NULL,
    [BRANCH] VARCHAR(25) NULL,
    [LOGIN_DATE] DATETIME NULL,
    [LOGIN_TIME] VARCHAR(25) NULL,
    [STATUS] VARCHAR(100) NULL,
    [SEGMENT] VARCHAR(100) NULL,
    [FNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_loginfile
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_loginfile]
(
    [PARTY_cODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(200) NULL,
    [BRANCH] VARCHAR(25) NULL,
    [LOGIN_DATE] VARCHAR(20) NULL,
    [LOGIN_TIME] VARCHAR(25) NULL,
    [STATUS] VARCHAR(100) NULL,
    [SEGMENT] VARCHAR(100) NULL,
    [FNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_loginfile1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_loginfile1]
(
    [PARTY_cODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(200) NULL,
    [BRANCH] VARCHAR(25) NULL,
    [LOGIN_DATE] VARCHAR(20) NULL,
    [LOGIN_TIME] VARCHAR(25) NULL,
    [STATUS] VARCHAR(100) NULL,
    [SEGMENT] VARCHAR(100) NULL,
    [FNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_logs
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_logs]
(
    [sauda_date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [ablcm_to] MONEY NULL,
    [acdlcm_to] MONEY NULL,
    [acdlfo_to] MONEY NULL,
    [ablcm_brk] MONEY NULL,
    [acdlcm_brk] MONEY NULL,
    [acdlfo_brk] MONEY NULL,
    [mcx_turn] MONEY NULL,
    [mcx_brok] MONEY NULL,
    [ncdx_brok] MONEY NULL,
    [ncdx_turn] MONEY NULL,
    [turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [nooflogin] VARCHAR(1) NULL,
    [user_stat] VARCHAR(10) NULL,
    [active_from] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_Mar09
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_Mar09]
(
    [sauda_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(10) NULL,
    [brok] MONEY NULL,
    [brokonline] MONEY NULL,
    [dif] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_mis
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_mis]
(
    [Company] VARCHAR(10) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_mis_client
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_mis_client]
(
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_misBK
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_misBK]
(
    [party_code] VARCHAR(10) NULL,
    [BSECM_DEL_brk] MONEY NULL,
    [NSECM_DEL_BRK] MONEY NULL,
    [BSECM_TRD_BRK] MONEY NULL,
    [NSECM_TRD_BRK] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_misto
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_misto]
(
    [party_code] VARCHAR(10) NULL,
    [BSECM_DEL_TO] MONEY NULL,
    [BSECM_TRD_TO] MONEY NULL,
    [NSECM_DEL_TO] MONEY NULL,
    [NSECM_TRD_TO] MONEY NULL,
    [NSEFO_TO] MONEY NULL,
    [Ncdex_TO] MONEY NULL,
    [mcx_TO] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_Nov08
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_Nov08]
(
    [sauda_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(10) NULL,
    [brok] MONEY NULL,
    [brokonline] MONEY NULL,
    [dif] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_odin
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_odin]
(
    [BRCODE] VARCHAR(15) NULL,
    [SBCODE] VARCHAR(15) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_TEMP0_BSE_CF
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_TEMP0_BSE_CF]
(
    [vdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [balance] MONEY NULL,
    [opn_balance] MONEY NULL,
    [funds_payin] DATETIME NULL,
    [billamt] MONEY NOT NULL,
    [payin_balance] MONEY NOT NULL,
    [diff_billamt] MONEY NOT NULL,
    [value] MONEY NOT NULL,
    [uf_margin] NUMERIC(38, 6) NOT NULL,
    [SETT_OBLGN] MONEY NULL,
    [MARGIN_FUNDING] MONEY NULL,
    [holding] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TERMINAL_ID
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TERMINAL_ID]
(
    [TERMINAL_ID] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TERMINAL_ID_new
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TERMINAL_ID_new]
(
    [101] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_TO
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_TO]
(
    [Branch] NVARCHAR(50) NULL,
    [Region] NVARCHAR(50) NULL,
    [CLIENT CODE] NVARCHAR(50) NULL,
    [CLIENT NAME] NVARCHAR(50) NULL,
    [CLIENT GRADE] NVARCHAR(50) NULL,
    [Active From] NVARCHAR(50) NULL,
    [Current DEALER] NVARCHAR(50) NULL,
    [Last Trade Date] NVARCHAR(50) NULL,
    [Net Available] NVARCHAR(50) NULL,
    [Margin] NVARCHAR(50) NULL,
    [1-Jul] NVARCHAR(50) NULL,
    [2-Jul] NVARCHAR(50) NULL,
    [6-Jul] NVARCHAR(50) NULL,
    [7-Jul] NVARCHAR(50) NULL,
    [8-Jul] NVARCHAR(50) NULL,
    [9-Jul] NVARCHAR(50) NULL,
    [12-Jul] NVARCHAR(50) NULL,
    [13-Jul] NVARCHAR(50) NULL,
    [14-Jul] NVARCHAR(50) NULL,
    [15-Jul] NVARCHAR(50) NULL,
    [16-Jul] NVARCHAR(50) NULL,
    [19-Jul] NVARCHAR(50) NULL,
    [20-Jul] NVARCHAR(50) NULL,
    [21-Jul] NVARCHAR(50) NULL,
    [22-Jul] NVARCHAR(50) NULL,
    [23-Jul] NVARCHAR(50) NULL,
    [26-Jul] NVARCHAR(50) NULL,
    [27-Jul] NVARCHAR(50) NULL,
    [28-Jul] NVARCHAR(50) NULL,
    [29-Jul] NVARCHAR(50) NULL,
    [30-Jul] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_Turnover
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_Turnover]
(
    [ClientCode] VARCHAR(8000) NULL,
    [Branch] VARCHAR(8000) NULL,
    [ClientName] VARCHAR(8000) NULL,
    [Turnover] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_Turnover10
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_Turnover10]
(
    [ClientCode] VARCHAR(8000) NULL,
    [Branch] VARCHAR(8000) NULL,
    [ClientName] VARCHAR(8000) NULL,
    [Turnover] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_ver6
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_ver6]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [Name] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] NVARCHAR(255) NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] NVARCHAR(255) NULL,
    [City] NVARCHAR(255) NULL,
    [State pin] NVARCHAR(255) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] NVARCHAR(255) NULL,
    [Surv On/Off] NVARCHAR(255) NULL,
    [Surv Auto/Manual] NVARCHAR(255) NULL,
    [BankDPOnOff] NVARCHAR(255) NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Markets Allowed] NVARCHAR(255) NULL,
    [ClientValidationOnOff] NVARCHAR(255) NULL,
    [SpanOnOff] NVARCHAR(255) NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] NVARCHAR(255) NULL,
    [DervFlag] NVARCHAR(255) NULL,
    [CombFlag] NVARCHAR(255) NULL,
    [BSEEq] NVARCHAR(255) NULL,
    [NEBEComb] NVARCHAR(255) NULL,
    [NEBEEq] NVARCHAR(255) NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_ver7
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_ver7]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [UserName] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] NVARCHAR(53) NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] NVARCHAR(50) NULL,
    [City] NVARCHAR(255) NULL,
    [State pin] NVARCHAR(255) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] NVARCHAR(255) NULL,
    [Surv On/Off] NVARCHAR(255) NULL,
    [Surv Auto/Manual] NVARCHAR(255) NULL,
    [BankDPOnOff] NVARCHAR(255) NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Trading Allowed] NVARCHAR(255) NULL,
    [ClientValidationOnOff] NVARCHAR(255) NULL,
    [SpanOnOff] NVARCHAR(255) NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] NVARCHAR(255) NULL,
    [DervFlag] NVARCHAR(255) NULL,
    [CombFlag] NVARCHAR(255) NULL,
    [BSEEq] NVARCHAR(255) NULL,
    [NEBEComb] NVARCHAR(255) NULL,
    [NEBEEq] NVARCHAR(255) NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [Group Admin] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId1] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp1]
(
    [party_code] VARCHAR(10) NULL,
    [activefrom] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [firsttrading] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [branch] CHAR(40) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [sbname] CHAR(25) NULL,
    [Long_name] VARCHAR(100) NULL,
    [L_address1] VARCHAR(40) NULL,
    [L_address2] VARCHAR(40) NULL,
    [L_address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(20) NULL,
    [COMPDATE] VARCHAR(10) NULL,
    [reg_no] CHAR(30) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Registered] BIT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [branch_code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempBranch
-- --------------------------------------------------
CREATE TABLE [dbo].[tempBranch]
(
    [branch_Cd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempDuplicateAmtC
-- --------------------------------------------------
CREATE TABLE [dbo].[tempDuplicateAmtC]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempDuplicateAmtD
-- --------------------------------------------------
CREATE TABLE [dbo].[tempDuplicateAmtD]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempDuplicateC
-- --------------------------------------------------
CREATE TABLE [dbo].[TempDuplicateC]
(
    [VOtyp] SMALLINT NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempDuplicateD
-- --------------------------------------------------
CREATE TABLE [dbo].[TempDuplicateD]
(
    [VOtyp] SMALLINT NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempfinal
-- --------------------------------------------------
CREATE TABLE [dbo].[tempfinal]
(
    [party_code] VARCHAR(10) NULL,
    [activefrom] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [firsttrading] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [branch] CHAR(40) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [sbname] CHAR(25) NULL,
    [Long_name] VARCHAR(100) NULL,
    [L_address1] VARCHAR(40) NULL,
    [L_address2] VARCHAR(40) NULL,
    [L_address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(20) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(20) NULL,
    [COMPDATE] VARCHAR(10) NULL,
    [reg_no] CHAR(30) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Registered] BIT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [branch_code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempg
-- --------------------------------------------------
CREATE TABLE [dbo].[tempg]
(
    [ExchangeSegment] VARCHAR(15) NULL,
    [Sauda_date] VARCHAR(11) NULL,
    [Party_code] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempg1
-- --------------------------------------------------
CREATE TABLE [dbo].[tempg1]
(
    [ExchangeSegment] VARCHAR(15) NULL,
    [Sauda_date] VARCHAR(11) NULL,
    [Party_code] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Templevel
-- --------------------------------------------------
CREATE TABLE [dbo].[Templevel]
(
    [DYear] VARCHAR(11) NULL,
    [Q1Days] INT NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Q1Turnover] MONEY NULL,
    [Q1AvgTurnover] MONEY NULL,
    [Q1Brokerage] MONEY NULL,
    [Q1AvgBrokerage] MONEY NULL,
    [Q2Days] INT NULL,
    [Q2Turnover] MONEY NULL,
    [Q2AvgTurnover] MONEY NULL,
    [Q2Brokerage] MONEY NULL,
    [Q2AvgBrokerage] MONEY NULL,
    [Q3Days] INT NULL,
    [Q3Turnover] MONEY NULL,
    [Q3AvgTurnover] MONEY NULL,
    [Q3Brokerage] MONEY NULL,
    [Q3AvgBrokerage] MONEY NULL,
    [Q4Days] INT NULL,
    [Q4Turnover] MONEY NULL,
    [Q4AvgTurnover] MONEY NULL,
    [Q4Brokerage] MONEY NULL,
    [Q4AvgBrokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempNumb
-- --------------------------------------------------
CREATE TABLE [dbo].[TempNumb]
(
    [Sauda_date] VARCHAR(20) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [Orders] INT NULL,
    [Trades] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempo
-- --------------------------------------------------
CREATE TABLE [dbo].[tempo]
(
    [username] VARCHAR(100) NULL,
    [userpwd] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempver6
-- --------------------------------------------------
CREATE TABLE [dbo].[tempver6]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [Name] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] FLOAT NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] NVARCHAR(255) NULL,
    [City] NVARCHAR(255) NULL,
    [State] NVARCHAR(255) NULL,
    [pin] NVARCHAR(50) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] FLOAT NULL,
    [Surv On/Off] FLOAT NULL,
    [Surv Auto/Manual] FLOAT NULL,
    [BankDPOnOff] FLOAT NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Markets Allowed] INT NULL,
    [ClientValidationOnOff] FLOAT NULL,
    [SpanOnOff] FLOAT NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] FLOAT NULL,
    [DervFlag] FLOAT NULL,
    [CombFlag] FLOAT NULL,
    [BSEEq] NVARCHAR(255) NULL,
    [NEBEComb] NVARCHAR(255) NULL,
    [NEBEEq] NVARCHAR(255) NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempver7
-- --------------------------------------------------
CREATE TABLE [dbo].[tempver7]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [UserName] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] FLOAT NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] SMALLDATETIME NULL,
    [City] NVARCHAR(255) NULL,
    [State] NVARCHAR(255) NULL,
    [pin] NVARCHAR(50) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] FLOAT NULL,
    [Surv On/Off] FLOAT NULL,
    [Surv Auto/Manual] FLOAT NULL,
    [BankDPOnOff] FLOAT NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Trading Allowed] FLOAT NULL,
    [ClientValidationOnOff] FLOAT NULL,
    [SpanOnOff] FLOAT NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] FLOAT NULL,
    [DervFlag] FLOAT NULL,
    [CombFlag] FLOAT NULL,
    [BSEEq] FLOAT NULL,
    [NEBEComb] FLOAT NULL,
    [NEBEEq] FLOAT NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [Group Admin] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId1] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Termid
-- --------------------------------------------------
CREATE TABLE [dbo].[Termid]
(
    [DEALER NAME] NVARCHAR(255) NULL,
    [DEALER SEGMENT] NVARCHAR(255) NULL,
    [Connectivity ] NVARCHAR(255) NULL,
    [USER ID] NVARCHAR(255) NULL,
    [DEALER TYPE] NVARCHAR(255) NULL,
    [Volume] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test
-- --------------------------------------------------
CREATE TABLE [dbo].[test]
(
    [seg] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_wasim
-- --------------------------------------------------
CREATE TABLE [dbo].[test_wasim]
(
    [Client] VARCHAR(255) NULL,
    [Col002] VARCHAR(255) NULL,
    [Col003] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEstDataGrading
-- --------------------------------------------------
CREATE TABLE [dbo].[TEstDataGrading]
(
    [party_code] VARCHAR(20) NULL,
    [party_name] VARCHAR(100) NULL,
    [TmonthNo] INT NULL,
    [Tmonth] NVARCHAR(30) NULL,
    [TYear] NVARCHAR(30) NULL,
    [Turnover] MONEY NOT NULL,
    [Brokerage] MONEY NOT NULL,
    [grade] VARCHAR(5) NOT NULL,
    [Status] VARCHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.testGrading
-- --------------------------------------------------
CREATE TABLE [dbo].[testGrading]
(
    [timer] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tmp_Brokdata
-- --------------------------------------------------
CREATE TABLE [dbo].[Tmp_Brokdata]
(
    [Region] VARCHAR(10) NULL,
    [Branch] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Activation_date] VARCHAR(25) NULL,
    [EQTO] MONEY NULL,
    [EQBrkg] MONEY NULL,
    [TdatyInEQ] VARCHAR(10) NULL,
    [CmdtyTO] MONEY NULL,
    [CmdtyBrkg] MONEY NULL,
    [TdaysInCmdty] VARCHAR(10) NULL,
    [Cltype] VARCHAR(15) NULL,
    [sbCode] VARCHAR(20) NULL,
    [Tdaty_Comb] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_overall_mrg
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_overall_mrg]
(
    [BrokerCode] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [PArty_name] VARCHAR(50) NULL,
    [dummy1] INT NULL,
    [Scrip_cd] VARCHAR(10) NULL,
    [Qty] INT NULL,
    [Funding_amt] MONEY NULL,
    [Funding_date] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp1
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp1]
(
    [mdate] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmpBrk
-- --------------------------------------------------
CREATE TABLE [dbo].[tmpBrk]
(
    [brokrage] MONEY NULL,
    [party_code] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TradeAPC
-- --------------------------------------------------
CREATE TABLE [dbo].[TradeAPC]
(
    [ParticipantCode] BIGINT NOT NULL,
    [Col02] BIGINT NOT NULL,
    [Scrip_Cd] BIGINT NOT NULL,
    [ScripName] VARCHAR(50) NOT NULL,
    [User_id] BIGINT NOT NULL,
    [Quantity] BIGINT NOT NULL,
    [Col07] BIGINT NOT NULL,
    [Col08] BIGINT NOT NULL,
    [Sauda_Time] DATETIME NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Party_code] VARCHAR(50) NOT NULL,
    [Order_no] BIGINT NOT NULL,
    [MarketType] VARCHAR(5) NOT NULL,
    [Sell_buy] VARCHAR(50) NOT NULL,
    [Trade_no] BIGINT NOT NULL,
    [Col16] VARCHAR(50) NOT NULL,
    [Col17] VARCHAR(50) NOT NULL,
    [Remark] VARCHAR(50) NULL DEFAULT '    ',
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TradeAPCBPCInter
-- --------------------------------------------------
CREATE TABLE [dbo].[TradeAPCBPCInter]
(
    [ParticipantCode] BIGINT NOT NULL,
    [Col02] BIGINT NOT NULL,
    [Scrip_Cd] BIGINT NOT NULL,
    [ScripName] VARCHAR(50) NOT NULL,
    [User_id] BIGINT NOT NULL,
    [Quantity] BIGINT NOT NULL,
    [Col07] BIGINT NOT NULL,
    [Col08] BIGINT NOT NULL,
    [Sauda_Time] DATETIME NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Party_code] VARCHAR(50) NOT NULL,
    [Order_no] BIGINT NOT NULL,
    [MarketType] VARCHAR(5) NOT NULL,
    [Sell_buy] VARCHAR(50) NOT NULL,
    [Trade_no] BIGINT NOT NULL,
    [Col16] VARCHAR(50) NOT NULL,
    [Col17] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TradeBPC
-- --------------------------------------------------
CREATE TABLE [dbo].[TradeBPC]
(
    [ParticipantCode] BIGINT NOT NULL,
    [Col02] BIGINT NOT NULL,
    [Scrip_Cd] BIGINT NOT NULL,
    [ScripName] VARCHAR(50) NOT NULL,
    [User_id] BIGINT NOT NULL,
    [Quantity] BIGINT NOT NULL,
    [Col07] BIGINT NOT NULL,
    [Col08] BIGINT NOT NULL,
    [Sauda_Time] DATETIME NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Party_code] VARCHAR(50) NOT NULL,
    [Order_no] BIGINT NOT NULL,
    [MarketType] VARCHAR(5) NOT NULL,
    [Sell_buy] VARCHAR(3) NOT NULL,
    [Trade_no] BIGINT NOT NULL,
    [Col16] VARCHAR(50) NOT NULL,
    [Col17] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tripartitetest1$
-- --------------------------------------------------
CREATE TABLE [dbo].[tripartitetest1$]
(
    [Tag] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [Name] NVARCHAR(255) NULL,
    [Registration No#] NVARCHAR(255) NULL,
    [Registered date] SMALLDATETIME NULL,
    [CONSTITUTION] NVARCHAR(255) NULL,
    [F7] NVARCHAR(255) NULL,
    [F8] NVARCHAR(255) NULL,
    [F9] NVARCHAR(255) NULL,
    [F10] NVARCHAR(255) NULL,
    [F11] NVARCHAR(255) NULL,
    [F12] NVARCHAR(255) NULL,
    [F13] NVARCHAR(255) NULL,
    [F14] NVARCHAR(255) NULL,
    [F15] NVARCHAR(255) NULL,
    [F16] NVARCHAR(255) NULL,
    [F17] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL,
    [F45] NVARCHAR(255) NULL,
    [F46] NVARCHAR(255) NULL,
    [F47] NVARCHAR(255) NULL,
    [F48] NVARCHAR(255) NULL,
    [F49] NVARCHAR(255) NULL,
    [F50] NVARCHAR(255) NULL,
    [F51] NVARCHAR(255) NULL,
    [F52] NVARCHAR(255) NULL,
    [F53] NVARCHAR(255) NULL,
    [F54] NVARCHAR(255) NULL,
    [F55] NVARCHAR(255) NULL,
    [F56] NVARCHAR(255) NULL,
    [F57] NVARCHAR(255) NULL,
    [F58] NVARCHAR(255) NULL,
    [F59] NVARCHAR(255) NULL,
    [F60] NVARCHAR(255) NULL,
    [F61] NVARCHAR(255) NULL,
    [F62] NVARCHAR(255) NULL,
    [F63] NVARCHAR(255) NULL,
    [F64] NVARCHAR(255) NULL,
    [F65] NVARCHAR(255) NULL,
    [F66] NVARCHAR(255) NULL,
    [F67] NVARCHAR(255) NULL,
    [F68] NVARCHAR(255) NULL,
    [F69] NVARCHAR(255) NULL,
    [F70] NVARCHAR(255) NULL,
    [F71] NVARCHAR(255) NULL,
    [F72] NVARCHAR(255) NULL,
    [F73] NVARCHAR(255) NULL,
    [F74] NVARCHAR(255) NULL,
    [F75] NVARCHAR(255) NULL,
    [F76] NVARCHAR(255) NULL,
    [F77] NVARCHAR(255) NULL,
    [F78] NVARCHAR(255) NULL,
    [F79] NVARCHAR(255) NULL,
    [F80] NVARCHAR(255) NULL,
    [F81] NVARCHAR(255) NULL,
    [F82] NVARCHAR(255) NULL,
    [F83] NVARCHAR(255) NULL,
    [F84] NVARCHAR(255) NULL,
    [F85] NVARCHAR(255) NULL,
    [F86] NVARCHAR(255) NULL,
    [F87] NVARCHAR(255) NULL,
    [F88] NVARCHAR(255) NULL,
    [F89] NVARCHAR(255) NULL,
    [F90] NVARCHAR(255) NULL,
    [F91] NVARCHAR(255) NULL,
    [F92] NVARCHAR(255) NULL,
    [F93] NVARCHAR(255) NULL,
    [F94] NVARCHAR(255) NULL,
    [F95] NVARCHAR(255) NULL,
    [F96] NVARCHAR(255) NULL,
    [F97] NVARCHAR(255) NULL,
    [F98] NVARCHAR(255) NULL,
    [F99] NVARCHAR(255) NULL,
    [F100] NVARCHAR(255) NULL,
    [F101] NVARCHAR(255) NULL,
    [F102] NVARCHAR(255) NULL,
    [F103] NVARCHAR(255) NULL,
    [F104] NVARCHAR(255) NULL,
    [F105] NVARCHAR(255) NULL,
    [F106] NVARCHAR(255) NULL,
    [F107] NVARCHAR(255) NULL,
    [F108] NVARCHAR(255) NULL,
    [F109] NVARCHAR(255) NULL,
    [F110] NVARCHAR(255) NULL,
    [F111] NVARCHAR(255) NULL,
    [F112] NVARCHAR(255) NULL,
    [F113] NVARCHAR(255) NULL,
    [F114] NVARCHAR(255) NULL,
    [F115] NVARCHAR(255) NULL,
    [F116] NVARCHAR(255) NULL,
    [F117] NVARCHAR(255) NULL,
    [F118] NVARCHAR(255) NULL,
    [F119] NVARCHAR(255) NULL,
    [F120] NVARCHAR(255) NULL,
    [F121] NVARCHAR(255) NULL,
    [F122] NVARCHAR(255) NULL,
    [F123] NVARCHAR(255) NULL,
    [F124] NVARCHAR(255) NULL,
    [F125] NVARCHAR(255) NULL,
    [F126] NVARCHAR(255) NULL,
    [F127] NVARCHAR(255) NULL,
    [F128] NVARCHAR(255) NULL,
    [F129] NVARCHAR(255) NULL,
    [F130] NVARCHAR(255) NULL,
    [F131] NVARCHAR(255) NULL,
    [F132] NVARCHAR(255) NULL,
    [F133] NVARCHAR(255) NULL,
    [F134] NVARCHAR(255) NULL,
    [F135] NVARCHAR(255) NULL,
    [F136] NVARCHAR(255) NULL,
    [F137] NVARCHAR(255) NULL,
    [F138] NVARCHAR(255) NULL,
    [F139] NVARCHAR(255) NULL,
    [F140] NVARCHAR(255) NULL,
    [F141] NVARCHAR(255) NULL,
    [F142] NVARCHAR(255) NULL,
    [F143] NVARCHAR(255) NULL,
    [F144] NVARCHAR(255) NULL,
    [F145] NVARCHAR(255) NULL,
    [F146] NVARCHAR(255) NULL,
    [F147] NVARCHAR(255) NULL,
    [F148] NVARCHAR(255) NULL,
    [F149] NVARCHAR(255) NULL,
    [F150] NVARCHAR(255) NULL,
    [F151] NVARCHAR(255) NULL,
    [F152] NVARCHAR(255) NULL,
    [F153] NVARCHAR(255) NULL,
    [F154] NVARCHAR(255) NULL,
    [F155] NVARCHAR(255) NULL,
    [F156] NVARCHAR(255) NULL,
    [F157] NVARCHAR(255) NULL,
    [F158] NVARCHAR(255) NULL,
    [F159] NVARCHAR(255) NULL,
    [F160] NVARCHAR(255) NULL,
    [F161] NVARCHAR(255) NULL,
    [F162] NVARCHAR(255) NULL,
    [F163] NVARCHAR(255) NULL,
    [F164] NVARCHAR(255) NULL,
    [F165] NVARCHAR(255) NULL,
    [F166] NVARCHAR(255) NULL,
    [F167] NVARCHAR(255) NULL,
    [F168] NVARCHAR(255) NULL,
    [F169] NVARCHAR(255) NULL,
    [F170] NVARCHAR(255) NULL,
    [F171] NVARCHAR(255) NULL,
    [F172] NVARCHAR(255) NULL,
    [F173] NVARCHAR(255) NULL,
    [F174] NVARCHAR(255) NULL,
    [F175] NVARCHAR(255) NULL,
    [F176] NVARCHAR(255) NULL,
    [F177] NVARCHAR(255) NULL,
    [F178] NVARCHAR(255) NULL,
    [F179] NVARCHAR(255) NULL,
    [F180] NVARCHAR(255) NULL,
    [F181] NVARCHAR(255) NULL,
    [F182] NVARCHAR(255) NULL,
    [F183] NVARCHAR(255) NULL,
    [F184] NVARCHAR(255) NULL,
    [F185] NVARCHAR(255) NULL,
    [F186] NVARCHAR(255) NULL,
    [F187] NVARCHAR(255) NULL,
    [F188] NVARCHAR(255) NULL,
    [F189] NVARCHAR(255) NULL,
    [F190] NVARCHAR(255) NULL,
    [F191] NVARCHAR(255) NULL,
    [F192] NVARCHAR(255) NULL,
    [F193] NVARCHAR(255) NULL,
    [F194] NVARCHAR(255) NULL,
    [F195] NVARCHAR(255) NULL,
    [F196] NVARCHAR(255) NULL,
    [F197] NVARCHAR(255) NULL,
    [F198] NVARCHAR(255) NULL,
    [F199] NVARCHAR(255) NULL,
    [F200] NVARCHAR(255) NULL,
    [F201] NVARCHAR(255) NULL,
    [F202] NVARCHAR(255) NULL,
    [F203] NVARCHAR(255) NULL,
    [F204] NVARCHAR(255) NULL,
    [F205] NVARCHAR(255) NULL,
    [F206] NVARCHAR(255) NULL,
    [F207] NVARCHAR(255) NULL,
    [F208] NVARCHAR(255) NULL,
    [F209] NVARCHAR(255) NULL,
    [F210] NVARCHAR(255) NULL,
    [F211] NVARCHAR(255) NULL,
    [F212] NVARCHAR(255) NULL,
    [F213] NVARCHAR(255) NULL,
    [F214] NVARCHAR(255) NULL,
    [F215] NVARCHAR(255) NULL,
    [F216] NVARCHAR(255) NULL,
    [F217] NVARCHAR(255) NULL,
    [F218] NVARCHAR(255) NULL,
    [F219] NVARCHAR(255) NULL,
    [F220] NVARCHAR(255) NULL,
    [F221] NVARCHAR(255) NULL,
    [F222] NVARCHAR(255) NULL,
    [F223] NVARCHAR(255) NULL,
    [F224] NVARCHAR(255) NULL,
    [F225] NVARCHAR(255) NULL,
    [F226] NVARCHAR(255) NULL,
    [F227] NVARCHAR(255) NULL,
    [F228] NVARCHAR(255) NULL,
    [F229] NVARCHAR(255) NULL,
    [F230] NVARCHAR(255) NULL,
    [F231] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uinfo
-- --------------------------------------------------
CREATE TABLE [dbo].[uinfo]
(
    [Party_Code] VARCHAR(10) NULL,
    [Party_name] VARCHAR(50) NULL,
    [aaa] VARCHAR(50) NULL,
    [bbb] VARCHAR(50) NULL,
    [ccc] VARCHAR(50) NULL,
    [ddd] VARCHAR(50) NULL,
    [dealer] VARCHAR(50) NULL,
    [location] VARCHAR(50) NULL,
    [odin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.userlist
-- --------------------------------------------------
CREATE TABLE [dbo].[userlist]
(
    [UserId] NVARCHAR(255) NULL,
    [GroupId] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Trading Allowed] NVARCHAR(255) NULL,
    [bse_STAT] NVARCHAR(255) NULL,
    [NSE_STAT] NVARCHAR(255) NULL,
    [FO_STAT] NVARCHAR(255) NULL,
    [MCDX_STAT] NVARCHAR(255) NULL,
    [NCDX_STAT] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.utb_fnomappingstatus
-- --------------------------------------------------
CREATE TABLE [dbo].[utb_fnomappingstatus]
(
    [party_code] VARCHAR(15) NULL,
    [status] CHAR(10) NULL,
    [segment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VBB_dkm
-- --------------------------------------------------
CREATE TABLE [dbo].[VBB_dkm]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(15) NOT NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ver6
-- --------------------------------------------------
CREATE TABLE [dbo].[ver6]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [Name] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] NVARCHAR(255) NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] NVARCHAR(255) NULL,
    [City] NVARCHAR(255) NULL,
    [State pin] NVARCHAR(255) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] NVARCHAR(255) NULL,
    [Surv On/Off] NVARCHAR(255) NULL,
    [Surv Auto/Manual] NVARCHAR(255) NULL,
    [BankDPOnOff] NVARCHAR(255) NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Markets Allowed] NVARCHAR(255) NULL,
    [ClientValidationOnOff] NVARCHAR(255) NULL,
    [SpanOnOff] NVARCHAR(255) NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] NVARCHAR(255) NULL,
    [DervFlag] NVARCHAR(255) NULL,
    [CombFlag] NVARCHAR(255) NULL,
    [BSEEq] NVARCHAR(255) NULL,
    [NEBEComb] NVARCHAR(255) NULL,
    [NEBEEq] NVARCHAR(255) NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] NVARCHAR(255) NULL,
    [tdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ver6_01082006USERS
-- --------------------------------------------------
CREATE TABLE [dbo].[ver6_01082006USERS]
(
    [Col001] VARCHAR(255) NULL,
    [Col002] VARCHAR(255) NULL,
    [Col003] VARCHAR(255) NULL,
    [Col004] VARCHAR(255) NULL,
    [Col005] VARCHAR(255) NULL,
    [Col006] VARCHAR(255) NULL,
    [Col007] VARCHAR(255) NULL,
    [Col008] VARCHAR(255) NULL,
    [Col009] VARCHAR(255) NULL,
    [Col010] VARCHAR(255) NULL,
    [Col011] VARCHAR(255) NULL,
    [Col012] VARCHAR(255) NULL,
    [Col013] VARCHAR(255) NULL,
    [Col014] VARCHAR(255) NULL,
    [Col015] VARCHAR(255) NULL,
    [Col016] VARCHAR(255) NULL,
    [Col017] VARCHAR(255) NULL,
    [Col018] VARCHAR(255) NULL,
    [Col019] VARCHAR(255) NULL,
    [Col020] VARCHAR(255) NULL,
    [Col021] VARCHAR(255) NULL,
    [Col022] VARCHAR(255) NULL,
    [Col023] VARCHAR(255) NULL,
    [Col024] VARCHAR(255) NULL,
    [Col025] VARCHAR(255) NULL,
    [Col026] VARCHAR(255) NULL,
    [Col027] VARCHAR(255) NULL,
    [Col028] VARCHAR(255) NULL,
    [Col029] VARCHAR(255) NULL,
    [Col030] VARCHAR(255) NULL,
    [Col031] VARCHAR(255) NULL,
    [Col032] VARCHAR(255) NULL,
    [Col033] VARCHAR(255) NULL,
    [Col034] VARCHAR(255) NULL,
    [Col035] VARCHAR(255) NULL,
    [Col036] VARCHAR(255) NULL,
    [Col037] VARCHAR(255) NULL,
    [Col038] VARCHAR(255) NULL,
    [Col039] VARCHAR(255) NULL,
    [Col040] VARCHAR(255) NULL,
    [Col041] VARCHAR(255) NULL,
    [Col042] VARCHAR(255) NULL,
    [Col043] VARCHAR(255) NULL,
    [Col044] VARCHAR(255) NULL,
    [Col045] VARCHAR(255) NULL,
    [Col046] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ver6_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[ver6_temp]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [Name] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] NVARCHAR(255) NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] NVARCHAR(255) NULL,
    [City] NVARCHAR(255) NULL,
    [State pin] NVARCHAR(255) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] NVARCHAR(255) NULL,
    [Surv On/Off] NVARCHAR(255) NULL,
    [Surv Auto/Manual] NVARCHAR(255) NULL,
    [BankDPOnOff] NVARCHAR(255) NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Markets Allowed] NVARCHAR(255) NULL,
    [ClientValidationOnOff] NVARCHAR(255) NULL,
    [SpanOnOff] NVARCHAR(255) NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] NVARCHAR(255) NULL,
    [DervFlag] NVARCHAR(255) NULL,
    [CombFlag] NVARCHAR(255) NULL,
    [BSEEq] NVARCHAR(255) NULL,
    [NEBEComb] NVARCHAR(255) NULL,
    [NEBEEq] NVARCHAR(255) NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] NVARCHAR(255) NULL,
    [tdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ver7
-- --------------------------------------------------
CREATE TABLE [dbo].[ver7]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [UserName] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] NVARCHAR(53) NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] NVARCHAR(50) NULL,
    [City] NVARCHAR(255) NULL,
    [State pin] NVARCHAR(255) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] NVARCHAR(255) NULL,
    [Surv On/Off] NVARCHAR(255) NULL,
    [Surv Auto/Manual] NVARCHAR(255) NULL,
    [BankDPOnOff] NVARCHAR(255) NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Trading Allowed] NVARCHAR(255) NULL,
    [ClientValidationOnOff] NVARCHAR(255) NULL,
    [SpanOnOff] NVARCHAR(255) NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] NVARCHAR(255) NULL,
    [DervFlag] NVARCHAR(255) NULL,
    [CombFlag] NVARCHAR(255) NULL,
    [BSEEq] NVARCHAR(255) NULL,
    [NEBEComb] NVARCHAR(255) NULL,
    [NEBEEq] NVARCHAR(255) NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [Group Admin] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId1] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] NVARCHAR(255) NULL,
    [tdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ver7_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[ver7_temp]
(
    [OpCode] FLOAT NULL,
    [User Id] NVARCHAR(255) NULL,
    [Group Id] NVARCHAR(255) NULL,
    [UserName] NVARCHAR(255) NULL,
    [Password] NVARCHAR(255) NULL,
    [Category] NVARCHAR(53) NULL,
    [Address1] NVARCHAR(255) NULL,
    [Address2] NVARCHAR(50) NULL,
    [City] NVARCHAR(255) NULL,
    [State pin] NVARCHAR(255) NULL,
    [Telephone No] NVARCHAR(255) NULL,
    [Fax No] NVARCHAR(255) NULL,
    [Email] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Brokerage] NVARCHAR(255) NULL,
    [Surv On/Off] NVARCHAR(255) NULL,
    [Surv Auto/Manual] NVARCHAR(255) NULL,
    [BankDPOnOff] NVARCHAR(255) NULL,
    [ParticipantCode] NVARCHAR(255) NULL,
    [Filler] NVARCHAR(255) NULL,
    [Filler1] NVARCHAR(255) NULL,
    [Filler2] NVARCHAR(255) NULL,
    [Filler3] NVARCHAR(255) NULL,
    [Trading Allowed] NVARCHAR(255) NULL,
    [ClientValidationOnOff] NVARCHAR(255) NULL,
    [SpanOnOff] NVARCHAR(255) NULL,
    [dervpartcode] NVARCHAR(255) NULL,
    [IP Address] NVARCHAR(255) NULL,
    [MaxNoOfOrder] NVARCHAR(255) NULL,
    [Max# BCast Scrips] NVARCHAR(255) NULL,
    [Alias DealerId] NVARCHAR(255) NULL,
    [PinCode] NVARCHAR(255) NULL,
    [EqFlag] NVARCHAR(255) NULL,
    [DervFlag] NVARCHAR(255) NULL,
    [CombFlag] NVARCHAR(255) NULL,
    [BSEEq] NVARCHAR(255) NULL,
    [NEBEComb] NVARCHAR(255) NULL,
    [NEBEEq] NVARCHAR(255) NULL,
    [Cash CTCL BranchId] NVARCHAR(255) NULL,
    [NSE Cash CTCL Id] NVARCHAR(255) NULL,
    [Branch Name] NVARCHAR(255) NULL,
    [Derv CTCL BranchId] NVARCHAR(255) NULL,
    [Derv CTCL Id] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId] NVARCHAR(255) NULL,
    [Group Admin] NVARCHAR(255) NULL,
    [BSE Cash CTCL BranchId1] NVARCHAR(255) NULL,
    [BSE Cash CTCL Id] NVARCHAR(255) NULL,
    [tdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vol1920
-- --------------------------------------------------
CREATE TABLE [dbo].[vol1920]
(
    [scode] VARCHAR(10) NULL,
    [br] VARCHAR(25) NULL,
    [vol] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.zuari
-- --------------------------------------------------
CREATE TABLE [dbo].[zuari]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [SqOffDate] DATETIME NULL,
    [CF] CHAR(1) NULL,
    [valid] CHAR(1) NULL,
    [dd] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.Client_First_Date
-- --------------------------------------------------
create view Client_First_Date 
as
select party_code,First_trade_date from tbl_Client_First_Date (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.ebrkTeminalProduct
-- --------------------------------------------------

create view ebrkTeminalProduct
as
select x.*,y.fld_product_name from
(select terminal_id,Servermapped,from_date,To_date from mis.remisior.dbo.ebrok_terminal_master where servermapped <> 'DIRECT') x
left outer join 
(select * from mis.genodinlimit.dbo.v_tbl_ebrok_manager_master) y
on x.servermapped=y.fld_manager_ip

GO

-- --------------------------------------------------
-- VIEW dbo.MDelCltView
-- --------------------------------------------------
Create View MDelCltView as 
Select Sett_no,Sett_Type,scrip_cd,series,Party_code,
BuyQty=Sum(Case When Inout = 'O' Then Qty Else 0 End),
SellQty=Sum(Case When Inout = 'I' Then Qty Else 0 End)
from angeldemat.msajag.dbo.DeliveryClt
Group BY Sett_no,Sett_Type,scrip_cd,series,Party_code

GO

-- --------------------------------------------------
-- VIEW dbo.mis_ebroking_Cli
-- --------------------------------------------------

CREATE View mis_ebroking_Cli
as

select sauda_date,branch_cd,sub_broker,party_Code collate Latin1_General_CI_AS as party_Code ,
ablcm_to=sum(Case when company='ABLCM' then turnover else 0 end),
acdlcm_to=sum(Case when company='ACDLCM' then turnover else 0 end),
acdlfo_to=sum(Case when company='ACDLFO' then turnover else 0 end),
ablcm_brk=sum(Case when company='ABLCM' then brokerage else 0 end),
acdlcm_brk=sum(Case when company='ACDLCM' then brokerage else 0 end),
acdlfo_brk=sum(Case when company='ACDLFO' then brokerage else 0 end),
mcx_turn=sum(Case when company='ACPLMCX' then turnover else 0 end),
mcx_brok=sum(Case when company='ACPLMCX' then brokerage else 0 end),
ncdx_brok=sum(Case when company='ACPLNCDEX' then brokerage else 0 end),
ncdx_turn=sum(Case when company='ACPLNCDEX' then turnover else 0 end),
turnover=sum(turnover),
brokerage=sum(brokerage),
nooflogin='',
user_stat='',
active_from=convert(datetime,'Jan  1 1900')
from ebroking.dbo.mis_to with (nolock)
group by sauda_date,branch_cd,sub_broker,party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.mis_to
-- --------------------------------------------------
create View mis_to
as
select * from mis_to_bsedb with (nolock) where sauda_date <='Dec 31 2010 23:59:59'
union all

select Company,sauda_date,Dealer,Region,branch_cd,Sub_broker,
party_code collate Latin1_General_CI_AS as party_Code
,party_name,
Terminal_id,Product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,
dummy1='',dummy2=''
from ebroking.dbo.mis_to with (nolock)
where sauda_Date > 'Dec 31 2010 23:59:59'

GO

-- --------------------------------------------------
-- VIEW dbo.vw_aa
-- --------------------------------------------------
create view vw_aa
as

select mcdx_to=sum(mcdx_to)/10000000,ncdx_to=sum(ncdx_to)/10000000,
to1=(sum(mcdx_to)+ sum(ncdx_to))/10000000
--into #aaa
from commo_perf_eval where tdate >= 'Feb 18 2006' 
and tdate<='Feb 24 2006'
union all
select mcdx_to=sum(mcdx_to)/10000000,ncdx_to=sum(ncdx_to)/10000000,
to1=(sum(mcdx_to)+ sum(ncdx_to))/10000000
--into #aaa
from commo_perf_eval where tdate >= 'Feb 11 2006' 
and tdate<='Feb 17 2006'

GO

-- --------------------------------------------------
-- VIEW dbo.vw_bb
-- --------------------------------------------------
create view vw_bb
as
SELECT VALMCX=SUM(CONVERT(MONEY,VALUE))/100 
--into #bb
FROM BHAV_MCX_hist where convert(varchar(11),tdate)>='Feb 18 2006' 
and convert(varchar(11),tdate)<='Feb 24 2006'
union 
SELECT VALMCX=SUM(CONVERT(MONEY,VALUE))/100 
--into #bb
FROM BHAV_MCX_hist where convert(varchar(11),tdate)>='Feb 11 2006' 
and convert(varchar(11),tdate)<='Feb 17 2006'

GO

-- --------------------------------------------------
-- VIEW dbo.vw_cc
-- --------------------------------------------------
create view vw_cc
as
SELECT VALNCDX=SUM(CONVERT(MONEY,trade_val))/100 
--into #cc
FROM BHAV_ncdx_hist 
where tdate >= 'Feb 18 2006' and tdate<='Feb 24 2006'  and trade_val<>'NA'
union all
SELECT VALNCDX=SUM(CONVERT(MONEY,trade_val))/100 
--into #cc
FROM BHAV_ncdx_hist 
where tdate >= 'Feb 11 2006' and tdate<='Feb 17 2006'  and trade_val<>'NA'

GO

-- --------------------------------------------------
-- VIEW dbo.vw_ebrok_client1
-- --------------------------------------------------
CREATE view vw_ebrok_client1  
as  
select party_code,odin_server=max(odin_server) from ctcl.dbo.ebrok_client group by party_code

GO

-- --------------------------------------------------
-- VIEW dbo.vw_mis_to_ebroking
-- --------------------------------------------------
CREATE View vw_mis_to_ebroking
as
select Company,sauda_date,Dealer,Region,branch_cd,Sub_broker,
party_code collate Latin1_General_CI_AS as party_Code
,party_name,
Terminal_id,Product,Turnover,brokerage,TO_Trd_Fut,TO_Del_Opt,BK_Trd_Fut,BK_Del_Opt,
dummy1='',dummy2=''
from ebroking.dbo.mis_to with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_training_cli
-- --------------------------------------------------
Create View vw_training_cli
as
select * from [196.1.115.215].DEMOTRANING.dbo.EbrokingCreation_info2  with (Nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_turnover
-- --------------------------------------------------
CREATE view vw_turnover  
As  
select a.SAUDA_DATE,a.Terminal_Id,a.Shift,a.no_of_trade,a.party_code,a.Turnover,a.brokerage,a.Segment,a.symbol,a.expirydate  
,b.* from mis_to_shift a  join  risk.dbo.Vw_RMS_Client_Vertical b  on a.party_Code=b.client

GO

