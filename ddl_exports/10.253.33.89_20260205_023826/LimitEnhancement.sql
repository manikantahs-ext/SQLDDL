-- DDL Export
-- Server: 10.253.33.89
-- Database: LimitEnhancement
-- Exported: 2026-02-05T02:38:49.400364

USE LimitEnhancement;
GO

-- --------------------------------------------------
-- FUNCTION dbo.aksdate
-- --------------------------------------------------
 create function dbo.aksdate()  
 returns @date table  
 (  
      fromdate date,todate date  
 )  
 as   
 begin  
 Declare @Cmonth date, @from date, @to date    
set @Cmonth= cast(cast(YEAR( GETDATE()) as varchar(4))+'-'+cast(Month(GETDATE())as varchar(2))+'-'+'25' as date)    
set @to = cast(cast(YEAR(DATEADD(month, -1, GETDATE())) as varchar(4))+'-'+cast(Month(DATEADD(month, -1, GETDATE()))as varchar(2))+'-'+'25' as date)    
set @from= cast(cast(YEAR(DATEADD(month, -4, GETDATE())) as varchar(4))+'-'+cast(Month(DATEADD(month, -4, GETDATE()))as varchar(2))+'-'+'26' as date)    
    
if (@Cmonth >=CAST(GETDATE() as date))    
begin     
set @from =@from     
set @to =@to     
end    
else    
begin    
set @from = cast(cast(YEAR(DATEADD(month, -3, GETDATE())) as varchar(4))+'-'+cast(Month(DATEADD(month, -3, GETDATE()))as varchar(2))+'-'+'26' as date)    
set @to =@Cmonth     
end    
insert into @date(fromdate ,todate)  
select fromdate=@from ,todate=@to    
return  
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_string_To_EncodeBASE64
-- --------------------------------------------------
CREATE FUNCTION [dbo].[fn_string_To_EncodeBASE64]    
(    
    @inputString VARCHAR(MAX)    
)    
    
    
RETURNS VARCHAR(MAX)    
AS    
BEGIN    
       
  RETURN (    
   SELECT    
    CAST(N'' AS XML).value(    
          'xs:base64Binary(xs:hexBinary(sql:column("bin")))'    
        , 'VARCHAR(MAX)'    
    )   Base64Encoding    
FROM (    
    SELECT CAST(@inputString AS VARBINARY(MAX)) AS bin    
) AS bin_sql_server_temp)    
        
END

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_APICALLLog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_tbl_APICALLLog_RecID] ON [dbo].[tbl_APICALLLog] ([RecID])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_APICALLLog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_tbl_APICALLLog_SBCode_ClientCode_TotalEnterLimit_Segment_LimitResponse] ON [dbo].[tbl_APICALLLog] ([SBCode], [ClientCode], [TotalEnterLimit], [Segment], [LimitResponse])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_SBLimitAllocation
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_missing_tbl_SBLimitAllocation_SBCode] ON [dbo].[tbl_SBLimitAllocation] ([SBCode])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_SBLimitAllocation_LogDetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_tbl_SBLimitAllocation_LogDetails_SBCode_ClientCode_TotalEnterLimit_Segment_LimitResponse] ON [dbo].[tbl_SBLimitAllocation_LogDetails] ([SBCode], [ClientCode], [TotalEnterLimit], [Segment], [LimitResponse])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_InstClinetLimit_newAPI
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_InstClinetLimit_newAPI] ADD CONSTRAINT [RecId_pk] PRIMARY KEY ([RecId])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Get_LimitUpdation_Report
-- --------------------------------------------------
--[Get_LimitUpdation_Report]  '13/07/2016','13/07/2016','',''
CREATE PROCEDURE [dbo].[Get_LimitUpdation_Report] --rp61,'R',''
(
@FromDate as varchar(22),                
@toDate as varchar(22),
@access_to varchar(30),                    
@access_code varchar(30)   
)
As
Begin
if(convert(varchar(12),convert(datetime,@FromDate,103),106)=convert(varchar(12),getdate(),106))
Begin
set @toDate=@toDate+' 23:59:59.000'
print @toDate
--select SBCode,SBNAme,TotalLimitAvail,ClientCode,ClientName,EnterLimit as AdditionalLimit,Segment,ClientCodeStatus,IntradayCode,LimitResPonse,substring(LimitResponseMesaage,0,56) as LimitResponseMesaage,ServerMapped,CreatedDT as CreationDate from tbl_SBLimitAllocation with(nolock)
select c.region as Region,o.tag as GroupCode,r.sb_category as Category,SBCode,SBNAme,TotalLimitAvail,ClientCode,ClientName,EnterLimit as AdditionalLimit,Segment,ClientCodeStatus,IntradayCode,LimitResPonse,substring(LimitResponseMesaage,0,56) as LimitResponseMesaage,t.ServerMapped,CreatedDT as CreationDate from tbl_SBLimitAllocation t with(nolock) left join mis.dbo.odinclientinfo o on t.ClientCode=o.pcode 
left join risk.dbo.client_details c on t.clientcode=c.party_code
left join (select sub_broker,max(sb_category) as sb_category from [CSOKYC-6].general.dbo.tbl_RMS_collection_SB with(nolock) group by sub_broker)r
on t.sbcode=r.sub_broker

where CreatedDT>=convert(varchar(12),convert(datetime,@FromDate,103),106) and
CreatedDT<=convert(varchar(12),convert(datetime,@toDate,103)+ '23:59:59.000',106) order by RecID
End
else
Begin
set @toDate=@toDate+' 23:59:59.000'
print @toDate
--select SBCode,SBNAme,TotalLimitAvail,ClientCode,ClientName,EnterLimit as AdditionalLimit,Segment,ClientCodeStatus,IntradayCode,LimitResPonse,substring(LimitResponseMesaage,0,56) as LimitResponseMesaage,ServerMapped,CreatedDT as CreationDate from tbl_SBLimitAllocation_LogDetails with(nolock) 
select c.region as Region,o.tag as GroupCode,r.sb_category as Category,SBCode,SBNAme,TotalLimitAvail,ClientCode,ClientName,EnterLimit as AdditionalLimit,Segment,ClientCodeStatus,IntradayCode,LimitResPonse,substring(LimitResponseMesaage,0,56) as LimitResponseMesaage,t.ServerMapped,CreatedDT as CreationDate from tbl_SBLimitAllocation_LogDetails t with(nolock) left join mis.dbo.odinclientinfo o on t.ClientCode=o.pcode 
left join risk.dbo.client_details c on t.clientcode=c.party_code
left join (select sub_broker,max(sb_category) as sb_category from [CSOKYC-6].general.dbo.tbl_RMS_collection_SB with(nolock) group by sub_broker)r
on t.sbcode=r.sub_broker
where CreatedDT>=convert(varchar(12),convert(datetime,@FromDate,103),106) and
CreatedDT<=convert(varchar(12),convert(datetime,@toDate,103)+ '23:59:59.000',106) order by CreatedDT
End
--print convert(varchar(12),convert(datetime,@toDate,103) '''23:59:59.000''',106) 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_DelSBData
-- --------------------------------------------------
CReate Procedure prc_DelSBData
@Process varchar(50),
@RecId int
As
Begin
delete from tbl_SBIndividual where RecID=@RecID
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetAngelHoliday
-- --------------------------------------------------
CREATE Procedure [dbo].[Prc_GetAngelHoliday]
As
Begin

--return 0
select top 0 pid	,HDATE,	HOLIDAY,	HSET,	LOC_No,	Div_no,	Remark from MIDDLEWARE.harmony.dbo.HOLIMST with(nolock) 
--where hdate=convert(varchar(12),getdate(),106)
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'TTRO',''

--Prc_GetLimitAvailable_testphase_23April2020  'PBO',''
                      
CREATE  Procedure [dbo].[Prc_GetLimitAvailable]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'

IF OBJECT_ID('tempdb..#tbl_RMS_collection_SB') IS NOT NULL        
DROP TABLE #tbl_RMS_collection_SB                         

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [CSOKYC-6].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE


select a.*,b.* into #tbl_RMS_collection_SB from [CSOKYC-6].general.dbo.tbl_RMS_collection_SB a inner join [CSOKYC-6].general.dbo.tbl_SB_purerisk_afterDPADj b
on a.Sub_Broker=b.sb 
where b.sb=@Sbcode
                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_Credit,0)+(purerisk_afterdp_adj)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [CSOKYC-6].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN #tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [CSOKYC-6].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [CSOKYC-6].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK' or @Sbcode='PJMA' or @Sbcode='AKJ'  or @Sbcode='GGIV' )
begin 
set @SBCredit=10000000
end

else if ( @Sbcode='ET')
begin 
set @SBCredit=20000000
end 


else if ( @Sbcode='TTRO')
begin 
set @SBCredit=30000000
end 


--else if ( @Sbcode='AJYC')
--begin 
--set @SBCredit=2100000
--end 

else if(@Sbcode='FFIS' or @Sbcode='MIKM')
begin 
set @SBCredit=0
end


else if(@Sbcode='VOVV' or @Sbcode='SIFA')
begin 
set @SBCredit=7500000
end

else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='DDOD'  or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU')
Begin
set @SBCredit=5000000
End

else if (@Sbcode='DDRK')
BEGIN
set @SBCredit=7000000
END

else if(@Sbcode='DDM' or @Sbcode='DSB' or @Sbcode='KKLE')
begin
set @SBCredit=7500000
End

else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 


else if(@Sbcode='RFU')
BEGIN 
	set @SBCredit=6500000
END 

else if(@Sbcode='MUKK')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='PPSF')
BEGIN 
	set @SBCredit=8000000
END 

--else if(@Sbcode='BBH')
--BEGIN 
--	set @SBCredit=900000
--END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='PODK')
BEGIN 
	set @SBCredit=500000
END


else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 


else if(@Sbcode='DDMC')
BEGIN 
	set @SBCredit=3500000
END 


else if(@sbcode='HEKA' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT' or @sbcode='EEEC')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ')
BEGIN 
	set @SBCredit=1000000
END 


--else if(@Sbcode='NNJD')
--BEGIN 
--	set @SBCredit=2500000
--END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=2500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR'  or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK' or @Sbcode='GGJU')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold') or (@SBcategory='Gold Plus')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU' or @Sbcode='DDOD')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		else if(@Sbcode='RFU')
		BEGIN 
			set @SBCredit=6500000
		END 
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		else if (@SbCode='NVP')
		Begin
		  Set @SBCredit=1500000
		End
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else if(@Sbcode='ADHC')
		Begin
		set @SBCredit=1000000
		End
		else if(@Sbcode='PJMA')
		Begin
		set @SBCredit=10000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_01dec2020
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'DFC',''

--Prc_GetLimitAvailable_testphase_23April2020  'PBO',''
                      
create Procedure [dbo].[Prc_GetLimitAvailable_01dec2020]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'

IF OBJECT_ID('tempdb..#tbl_RMS_collection_SB') IS NOT NULL        
DROP TABLE #tbl_RMS_collection_SB                         

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE


select a.*,b.* into #tbl_RMS_collection_SB from [196.1.115.182].general.dbo.tbl_RMS_collection_SB a inner join [196.1.115.182].general.dbo.tbl_SB_purerisk_afterDPADj b
on a.Sub_Broker=b.sb 
where b.sb=@Sbcode
                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_Credit,0)+(purerisk_afterdp_adj)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN #tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK' or @Sbcode='PJMA' or @Sbcode='AKJ'  or @Sbcode='GGIV' )
begin 
set @SBCredit=10000000
end

else if ( @Sbcode='ET')
begin 
set @SBCredit=20000000
end 


--else if ( @Sbcode='AJYC')
--begin 
--set @SBCredit=2100000
--end 

else if(@Sbcode='FFIS' or @Sbcode='MIKM')
begin 
set @SBCredit=0
end


else if(@Sbcode='VOVV' or @Sbcode='SIFA')
begin 
set @SBCredit=7500000
end

else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='DDOD'  or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU')
Begin
set @SBCredit=5000000
End

else if (@Sbcode='DDRK')
BEGIN
set @SBCredit=7000000
END

else if(@Sbcode='DDM' or @Sbcode='DSB' or @Sbcode='KKLE')
begin
set @SBCredit=7500000
End

else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 


else if(@Sbcode='RFU')
BEGIN 
	set @SBCredit=6500000
END 

else if(@Sbcode='MUKK')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='PPSF')
BEGIN 
	set @SBCredit=8000000
END 

--else if(@Sbcode='BBH')
--BEGIN 
--	set @SBCredit=900000
--END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='PODK')
BEGIN 
	set @SBCredit=500000
END


else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 


else if(@Sbcode='DDMC')
BEGIN 
	set @SBCredit=3500000
END 


else if(@sbcode='HEKA' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT' or @sbcode='EEEC')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ')
BEGIN 
	set @SBCredit=1000000
END 


--else if(@Sbcode='NNJD')
--BEGIN 
--	set @SBCredit=2500000
--END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=2500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR'  or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK' or @Sbcode='GGJU')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold') or (@SBcategory='Gold Plus')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU' or @Sbcode='DDOD')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		else if(@Sbcode='RFU')
		BEGIN 
			set @SBCredit=6500000
		END 
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		else if (@SbCode='NVP')
		Begin
		  Set @SBCredit=1500000
		End
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else if(@Sbcode='ADHC')
		Begin
		set @SBCredit=1000000
		End
		else if(@Sbcode='PJMA')
		Begin
		set @SBCredit=10000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_01Nov2017
-- --------------------------------------------------
--Prc_GetLimitAvailable 'PK',''                      
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_01Nov2017]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out                      
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                                        
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money                      
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print @netbrokerage                      
                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              


set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else
Begin
set @SBCredit=@SBCredit
End

    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin                      
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_01Sep2017
-- --------------------------------------------------
--Prc_GetLimitAvailable 'PK',''                      
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_01Sep2017]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out                      
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                                        
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money                      
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print @netbrokerage                      
                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              


set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else
Begin
set @SBCredit=@SBCredit
End

    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin                      
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_02Dec2019
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'AMRHM',''
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_02Dec2019]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='AMRHM'                      

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin              
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK')
begin 
set @SBCredit=10000000
end


else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='DSB' or @sbcode='DDM' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 

else if(@Sbcode='BBH')
BEGIN 
	set @SBCredit=700000
END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='IIIT' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' or @Sbcode='EEEC' Or @Sbcode='CCVH' or @Sbcode='DSM' or @Sbcode='VVMT')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ')
BEGIN 
	set @SBCredit=1000000
END 

else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='VOVV' or @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=1500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='VIBB' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or @Sbcode='SSMW' or @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=2000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus') 
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
 
                      
End           
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_04032019
-- --------------------------------------------------
--Prc_GetLimitAvailable 'ET',''                     
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_04032019]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End
else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
Begin
set @SBCredit=5000000
End
else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 
else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=10000000
End
else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End

ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin

		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		if(@Sbcode='DDPM')
		Begin
		set @SBCredit=10000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_04May2017
-- --------------------------------------------------
--Prc_GetLimitAvailable 'PK',''                      
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_04May2017]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out                      
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE)                      
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money                      
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print @netbrokerage                      
                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              


set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin                      
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_05092018
-- --------------------------------------------------
--Prc_GetLimitAvailable 'CCNU',''                      
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_05092018]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out                      
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                                        
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC' or @Sbcode='SRKS' or @Sbcode='CCNU')
Begin
set @SBCredit=0
End
else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
Begin
set @SBCredit=5000000
End
else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 
else IF (@Sbcode='FRIL')
Begin
set @SBCredit=20000000
End
ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin

		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_06Feb2020
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'DDM',''
                      
create Procedure [dbo].[Prc_GetLimitAvailable_06Feb2020]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'                      

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK')
begin 
set @SBCredit=10000000
end


else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU' or @Sbcode='DDM' or @Sbcode='DSB' or @Sbcode='DDOD')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 

else if(@Sbcode='BBH')
BEGIN 
	set @SBCredit=900000
END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='IIIT' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT' or @sbcode='EEEC')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ' or @Sbcode='AINE')
BEGIN 
	set @SBCredit=1000000
END 

else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='VOVV' or @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=1500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_10dec2019
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'DDM',''
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_10dec2019]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'                      

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK')
begin 
set @SBCredit=10000000
end


else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 

else if(@Sbcode='BBH')
BEGIN 
	set @SBCredit=700000
END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='IIIT' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' or @Sbcode='EEEC' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ')
BEGIN 
	set @SBCredit=1000000
END 

else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='VOVV' or @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=1500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or @Sbcode='SSMW' or @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=2000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_11062019
-- --------------------------------------------------
--Prc_GetLimitAvailable_11062019 'TAKE',''                     
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_11062019]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End
else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='DSB' or @sbcode='DDM')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=10000000
End
else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
Begin
set @SBCredit=2500000
End





ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else 
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin

		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		if(@Sbcode='DDPM')
		Begin
		set @SBCredit=10000000
		End
		
		else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
		Begin
		set @SBCredit=2500000
		End
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_13May2020
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'DDM',''
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_13May2020]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'                      

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK' or @Sbcode='PJMA' or @Sbcode='AKJ' or @Sbcode='ET')
begin 
set @SBCredit=10000000
end


--else if(@Sbcode='ET')
--begin 
--set @SBCredit=7500000
--end

else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='DDOD' or @Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='DDM' or @Sbcode='DSB')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=4000000
END 


else if(@Sbcode='PPSF')
BEGIN 
	set @SBCredit=8000000
END 

--else if(@Sbcode='BBH')
--BEGIN 
--	set @SBCredit=900000
--END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ' or @Sbcode='AINE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if( @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=2500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

--else if(@Sbcode='JJHH')
--Begin
--set @SBCredit=2500000
--End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End
else if(@Sbcode='RFU')
	Begin
	set @SBCredit=6500000
	End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='NEW')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		if(@Sbcode='RFU')
		Begin
		set @SBCredit=6500000
		End
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU' or @Sbcode='DDOD')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		else if (@SbCode='NVP')
		Begin
		  Set @SBCredit=1500000
		End
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else if(@Sbcode='ADHC')
		Begin
		set @SBCredit=1000000
		End
		else if(@Sbcode='PJMA')
		Begin
		set @SBCredit=10000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_15102019
-- --------------------------------------------------
--Prc_GetLimitAvailable 'TTNC',''                     
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_15102019]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='GRW'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='DSB' or @sbcode='DDM')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='BBH')
BEGIN 
	set @SBCredit=700000
END 

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 


else if(@Sbcode='DLH')
BEGIN 
	set @SBCredit=1000000
END 

else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=1500000
END

else if(@Sbcode='TTNC')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='RRBY')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='ICFS')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


--

		--else if(@Sbcode='ALHG')
		--Begin
		--set @SBCredit=3000000
		--End 

		--else if(@Sbcode='MAVD')
		--Begin
		--set @SBCredit=3000000
		--End 

		--else if(@Sbcode='JJIS')
		--Begin
		--set @SBCredit=1000000
		--End 

		--else if(@Sbcode='DLH')
		--Begin
		--set @SBCredit=1000000
		--End 

		--else if(@Sbcode='BAJA')
		--Begin
		--set @SBCredit=200000
		--End 

		----else if(@Sbcode='PBV')
		----Begin
		----set @SBCredit=400000
		----End 

		--else if(@Sbcode='JNT')
		--Begin
		--set @SBCredit=500000
		--End 

		--else if(@Sbcode='RVB1')
		--Begin
		--set @SBCredit=200000
		--End 

		--else if(@Sbcode='JNT')
		--Begin
		--set @SBCredit=500000
		--End 

		--else if(@Sbcode='MRMK')
		--Begin
		--set @SBCredit=1000000
		--End 


		--else if(@Sbcode='AKSS')
		--Begin
		--set @SBCredit=100000
		--End 

		--else if(@Sbcode='NBG')
		--Begin
		--set @SBCredit=100000
		--End

		--else if(@Sbcode='SMIR')
		--Begin
		--set @SBCredit=2500000
		--End

		--else if(@Sbcode='KKLE'  or @Sbcode='PPS' or @Sbcode='MYIG' or @Sbcode='ATK')
		--Begin
		--set @SBCredit=3000000
		--End

		--else if(@Sbcode='RIPK'  or @Sbcode='MMNN' or @sbcode='KLY' or @sbCode='KGD')
		--Begin
		--set @SBCredit=2000000
		--End

		--else if(@Sbcode='GHNS')
		--Begin
		--set @SBCredit=600000
		--End

		--else if(@Sbcode='VAS')
		--Begin
		--set @SBCredit=1200000
		--End

		--else if(@Sbcode='STIN')
		--Begin
		--set @SBCredit=3200000
		--End

		--else if(@Sbcode='PPJI')
		--Begin
		--set @SBCredit=1500000
		--End

		--else if(@Sbcode='SSI')
		--Begin
		--set @SBCredit=1000000
		--End

		--else if(@Sbcode='JJJL')
		--Begin
		--set @SBCredit=200000
		--End

		--else if(@Sbcode='HIKA')
		--Begin
		--set @SBCredit=1200000
		--End

		--else if(@Sbcode='AKFI')
		--Begin
		--set @SBCredit=5000000
		--End

		--else if(@Sbcode='DFC')
		--Begin
		--set @SBCredit=1500000
		--End

		--else if(@Sbcode='AKSH' or @Sbcode='VIHM' or @Sbcode='JRDT')
		--Begin
		--set @SBCredit=1000000
		--End










else if(@Sbcode='BLI')
Begin
set @SBCredit=1800000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2000000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=700000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End
else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
Begin
set @SBCredit=2500000
End

ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin

		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		else if(@Sbcode='ICFS')
		Begin
		set @SBCredit=500000
		End
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END 
		
		else if(@Sbcode='PPSU')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
		Begin
		set @SBCredit=2500000
		End
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		--
		
			--else if(@Sbcode='ALHG')
			--Begin
			--set @SBCredit=3000000
			--End 

			--else if(@Sbcode='MAVD')
			--Begin
			--set @SBCredit=3000000
			--End 

			--else if(@Sbcode='JJIS')
			--Begin
			--set @SBCredit=1000000
			--End 

			--else if(@Sbcode='DLH')
			--Begin
			--set @SBCredit=1000000
			--End 

			--else if(@Sbcode='BAJA')
			--Begin
			--set @SBCredit=200000
			--End 

			----else if(@Sbcode='PBV')
			----Begin
			----set @SBCredit=400000
			----End 

			--else if(@Sbcode='JNT')
			--Begin
			--set @SBCredit=500000
			--End 

			--else if(@Sbcode='RVB1')
			--Begin
			--set @SBCredit=200000
			--End 

			--else if(@Sbcode='JNT')
			--Begin
			--set @SBCredit=500000
			--End 

			--else if(@Sbcode='MRMK')
			--Begin
			--set @SBCredit=1000000
			--End 


			--else if(@Sbcode='AKSS')
			--Begin
			--set @SBCredit=100000
			--End 

			--else if(@Sbcode='NBG')
			--Begin
			--set @SBCredit=100000
			--End

			--else if(@Sbcode='SMIR')
			--Begin
			--set @SBCredit=2500000
			--End

			--else if(@Sbcode='KKLE'  or @Sbcode='PPS' or @Sbcode='MYIG' or @Sbcode='ATK')
			--Begin
			--set @SBCredit=3000000
			--End

			--else if(@Sbcode='RIPK'  or @Sbcode='MMNN' or @sbcode='KLY' or @sbCode='KGD')
			--Begin
			--set @SBCredit=2000000
			--End

			--else if(@Sbcode='GHNS')
			--Begin
			--set @SBCredit=600000
			--End

			--else if(@Sbcode='VAS')
			--Begin
			--set @SBCredit=1200000
			--End

			--else if(@Sbcode='STIN')
			--Begin
			--set @SBCredit=3200000
			--End

			--else if(@Sbcode='PPJI')
			--Begin
			--set @SBCredit=1500000
			--End

			--else if(@Sbcode='SSI')
			--Begin
			--set @SBCredit=1000000
			--End

			--else if(@Sbcode='JJJL')
			--Begin
			--set @SBCredit=200000
			--End

			--else if(@Sbcode='HIKA')
			--Begin
			--set @SBCredit=1200000
			--End

			--else if(@Sbcode='AKFI')
			--Begin
			--set @SBCredit=5000000
			--End

			--else if(@Sbcode='DFC')
			--Begin
			--set @SBCredit=1500000
			--End

			--else if(@Sbcode='AKSH' or @Sbcode='VIHM' or @Sbcode='JRDT')
			--Begin
			--set @SBCredit=1000000
			--End	
		--
		
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_15Feb2017
-- --------------------------------------------------
--Prc_GetLimitAvailable_15Feb2017 'GDS',''                      
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_15Feb2017]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out                      
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE)                      
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money                      
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print @netbrokerage                      
                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              


set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin                      
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_16102018
-- --------------------------------------------------
--Prc_GetLimitAvailable 'JJRT',''                     
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_16102018]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                                        
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End
else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
Begin
set @SBCredit=5000000
End
else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 
else IF (@Sbcode='FRIL')
Begin
set @SBCredit=20000000
End
ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin

		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_16Apr2020
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'DDM',''
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_16Apr2020]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'                      

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK' or @Sbcode='PJMA' or @Sbcode='AKJ')
begin 
set @SBCredit=10000000
end


else if(@Sbcode='ET')
begin 
set @SBCredit=7500000
end

else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU' or @Sbcode='DDM' or @Sbcode='DSB')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 


else if(@Sbcode='PPSF')
BEGIN 
	set @SBCredit=8000000
END 

--else if(@Sbcode='BBH')
--BEGIN 
--	set @SBCredit=900000
--END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT' or @sbcode='EEEC')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ' or @Sbcode='AINE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=2500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else if(@Sbcode='ADHC')
		Begin
		set @SBCredit=1000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_18Jul2016
-- --------------------------------------------------
--Prc_GetLimitAvailable_18Jul2016 'pjma',''                      
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_18Jul2016]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out                      
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE)                      
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money                      
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print @netbrokerage                      
                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 select * into t from #OPFILE                     
set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+sum(NetBrokerage) from #OPFILE)       
print 'pureRisk'
print @pureRisk  
if(@pureRisk>0)                      
Begin                      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end)) from #OPFILE )                    
set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin                      
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_19Dec2017
-- --------------------------------------------------
--Prc_GetLimitAvailable 'ppje',''                      
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_19Dec2017]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out                      
As                      
Begin                      
--declare @Sbcode varchar(50)                      
--set @Sbcode ='alc'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                                        
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      


print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              


set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else
Begin
set @SBCredit=@SBCredit
End

    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin                      
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_22102019
-- --------------------------------------------------
--Prc_GetLimitAvailable 'TTNC',''                     
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_22102019]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='GRW'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='DSB' or @sbcode='DDM')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='BBH')
BEGIN 
	set @SBCredit=700000
END 

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='GRW' or @Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP')
BEGIN 
	set @SBCredit=800000
END 

else if(@Sbcode='DDMC')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ')
BEGIN 
	set @SBCredit=500000
END 

else if(@Sbcode='GFS')
BEGIN 
	set @SBCredit=700000
END 

else if(@Sbcode='ANAA')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF')
BEGIN 
	set @SBCredit=1000000
END 

else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=1800000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KKRR' or @Sbcode='VOVV' or @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 


else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=1500000
END

else if(@Sbcode='TTNC')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='RRBY')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='ICFS')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


--

		--else if(@Sbcode='ALHG')
		--Begin
		--set @SBCredit=3000000
		--End 

		--else if(@Sbcode='MAVD')
		--Begin
		--set @SBCredit=3000000
		--End 

		--else if(@Sbcode='JJIS')
		--Begin
		--set @SBCredit=1000000
		--End 

		--else if(@Sbcode='DLH')
		--Begin
		--set @SBCredit=1000000
		--End 

		--else if(@Sbcode='BAJA')
		--Begin
		--set @SBCredit=200000
		--End 

		----else if(@Sbcode='PBV')
		----Begin
		----set @SBCredit=400000
		----End 

		--else if(@Sbcode='JNT')
		--Begin
		--set @SBCredit=500000
		--End 

		--else if(@Sbcode='RVB1')
		--Begin
		--set @SBCredit=200000
		--End 

		--else if(@Sbcode='JNT')
		--Begin
		--set @SBCredit=500000
		--End 

		--else if(@Sbcode='MRMK')
		--Begin
		--set @SBCredit=1000000
		--End 


		--else if(@Sbcode='AKSS')
		--Begin
		--set @SBCredit=100000
		--End 

		--else if(@Sbcode='NBG')
		--Begin
		--set @SBCredit=100000
		--End

		--else if(@Sbcode='SMIR')
		--Begin
		--set @SBCredit=2500000
		--End

		--else if(@Sbcode='KKLE'  or @Sbcode='PPS' or @Sbcode='MYIG' or @Sbcode='ATK')
		--Begin
		--set @SBCredit=3000000
		--End

		--else if(@Sbcode='RIPK'  or @Sbcode='MMNN' or @sbcode='KLY' or @sbCode='KGD')
		--Begin
		--set @SBCredit=2000000
		--End

		--else if(@Sbcode='GHNS')
		--Begin
		--set @SBCredit=600000
		--End

		--else if(@Sbcode='VAS')
		--Begin
		--set @SBCredit=1200000
		--End

		--else if(@Sbcode='STIN')
		--Begin
		--set @SBCredit=3200000
		--End

		--else if(@Sbcode='PPJI')
		--Begin
		--set @SBCredit=1500000
		--End

		--else if(@Sbcode='SSI')
		--Begin
		--set @SBCredit=1000000
		--End

		--else if(@Sbcode='JJJL')
		--Begin
		--set @SBCredit=200000
		--End

		--else if(@Sbcode='HIKA')
		--Begin
		--set @SBCredit=1200000
		--End

		--else if(@Sbcode='AKFI')
		--Begin
		--set @SBCredit=5000000
		--End

		--else if(@Sbcode='DFC')
		--Begin
		--set @SBCredit=1500000
		--End

		--else if(@Sbcode='AKSH' or @Sbcode='VIHM' or @Sbcode='JRDT')
		--Begin
		--set @SBCredit=1000000
		--End










else if(@Sbcode='BLI')
Begin
set @SBCredit=1800000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2000000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=700000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End
else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
Begin
set @SBCredit=2500000
End

ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin

		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		else if(@Sbcode='ICFS')
		Begin
		set @SBCredit=500000
		End
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END 
		
		else if(@Sbcode='PPSU')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
		Begin
		set @SBCredit=2500000
		End
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		--
		
			--else if(@Sbcode='ALHG')
			--Begin
			--set @SBCredit=3000000
			--End 

			--else if(@Sbcode='MAVD')
			--Begin
			--set @SBCredit=3000000
			--End 

			--else if(@Sbcode='JJIS')
			--Begin
			--set @SBCredit=1000000
			--End 

			--else if(@Sbcode='DLH')
			--Begin
			--set @SBCredit=1000000
			--End 

			--else if(@Sbcode='BAJA')
			--Begin
			--set @SBCredit=200000
			--End 

			----else if(@Sbcode='PBV')
			----Begin
			----set @SBCredit=400000
			----End 

			--else if(@Sbcode='JNT')
			--Begin
			--set @SBCredit=500000
			--End 

			--else if(@Sbcode='RVB1')
			--Begin
			--set @SBCredit=200000
			--End 

			--else if(@Sbcode='JNT')
			--Begin
			--set @SBCredit=500000
			--End 

			--else if(@Sbcode='MRMK')
			--Begin
			--set @SBCredit=1000000
			--End 


			--else if(@Sbcode='AKSS')
			--Begin
			--set @SBCredit=100000
			--End 

			--else if(@Sbcode='NBG')
			--Begin
			--set @SBCredit=100000
			--End

			--else if(@Sbcode='SMIR')
			--Begin
			--set @SBCredit=2500000
			--End

			--else if(@Sbcode='KKLE'  or @Sbcode='PPS' or @Sbcode='MYIG' or @Sbcode='ATK')
			--Begin
			--set @SBCredit=3000000
			--End

			--else if(@Sbcode='RIPK'  or @Sbcode='MMNN' or @sbcode='KLY' or @sbCode='KGD')
			--Begin
			--set @SBCredit=2000000
			--End

			--else if(@Sbcode='GHNS')
			--Begin
			--set @SBCredit=600000
			--End

			--else if(@Sbcode='VAS')
			--Begin
			--set @SBCredit=1200000
			--End

			--else if(@Sbcode='STIN')
			--Begin
			--set @SBCredit=3200000
			--End

			--else if(@Sbcode='PPJI')
			--Begin
			--set @SBCredit=1500000
			--End

			--else if(@Sbcode='SSI')
			--Begin
			--set @SBCredit=1000000
			--End

			--else if(@Sbcode='JJJL')
			--Begin
			--set @SBCredit=200000
			--End

			--else if(@Sbcode='HIKA')
			--Begin
			--set @SBCredit=1200000
			--End

			--else if(@Sbcode='AKFI')
			--Begin
			--set @SBCredit=5000000
			--End

			--else if(@Sbcode='DFC')
			--Begin
			--set @SBCredit=1500000
			--End

			--else if(@Sbcode='AKSH' or @Sbcode='VIHM' or @Sbcode='JRDT')
			--Begin
			--set @SBCredit=1000000
			--End	
		--
		
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_23April2020
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'DDM',''
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_23April2020]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'                      

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK' or @Sbcode='PJMA' or @Sbcode='AKJ' or @Sbcode='ET')
begin 
set @SBCredit=10000000
end


--else if(@Sbcode='ET')
--begin 
--set @SBCredit=7500000
--end

else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='DDOD' or @Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU' or @Sbcode='DDM' or @Sbcode='DSB')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 


else if(@Sbcode='PPSF')
BEGIN 
	set @SBCredit=8000000
END 

--else if(@Sbcode='BBH')
--BEGIN 
--	set @SBCredit=900000
--END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT' or @sbcode='EEEC')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ' or @Sbcode='AINE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=2500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU' or @Sbcode='DDOD')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		else if (@SbCode='NVP')
		Begin
		  Set @SBCredit=1500000
		End
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else if(@Sbcode='ADHC')
		Begin
		set @SBCredit=1000000
		End
		else if(@Sbcode='PJMA')
		Begin
		set @SBCredit=10000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_23july2019
-- --------------------------------------------------
--Prc_GetLimitAvailable 'GRW',''                     
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_23july2019]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='GRW'                      
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin                      
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End
else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='DSB' or @sbcode='DDM')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End

else if(@Sbcode='ICFS')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU')
Begin
set @SBCredit=2500000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


--

else if(@Sbcode='BLI')
Begin
set @SBCredit=1800000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2000000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=700000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=10000000
End
else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
Begin
set @SBCredit=2500000
End

ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
set @SBCredit=@limit
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                      
End           
else                      
Begin

		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		if(@Sbcode='DDPM')
		Begin
		set @SBCredit=10000000
		End
		else if(@Sbcode='ICFS')
		Begin
		set @SBCredit=500000
		End
		
		else if(@Sbcode='PPSU')
		Begin
		set @SBCredit=2500000
		End
		
		else IF (@Sbcode='DDPMC' or @Sbcode='CSCS')
		Begin
		set @SBCredit=2500000
		End
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH')
		Begin
		set @SBCredit=5000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_above2008
-- --------------------------------------------------


--Prc_GetLimitAvailable 'nyan',''  
                        
Create Procedure [dbo].[Prc_GetLimitAvailable_above2008]                        
@Sbcode varchar(50),                      
@SBCredit varchar(max) out  
--@SBTotalLimit varchar(max) out  
                        
As                        
Begin                        
  
--declare @Sbcode varchar(50),@SBCredit varchar(max)                        
--set @Sbcode ='ET'                        
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL          
DROP TABLE #OPFILE          
          
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                        
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                        
Begin                    
--drop table #OPFILE                        
SELECT a.Region,a.Branch,                          
[Sub Broker]=a.SB,                        
[SB Name]=a.SB_Name,                        
MAX(B.Sb_Category) as [SB Cat],                        
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                          
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                        
INTO #OPFILE                         
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                         
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                           
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                          
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                          
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                          
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                          
                        
alter table #OPFILE                        
alter column NetBrokerage int                        
set @SBcategory=(select top 1 [SB Cat] from #OPFILE)   
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)   
  
  
--//New logic from total limit added by Prashant P on 16102018//--  
  
SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS  
money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client   
WHERE v.sb LIKE '%'  and SB=@Sbcode GROUP BY v.sb, t.party_code  
UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND   
unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit ))   
WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (   
net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00   
THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end   
UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00   
  
  
SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM   
#sb_riskafterunclearcheque  GROUP BY sb  
  
----///END//---  
                                         
                        
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                        
Begin                        
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
End                        
else                        
Begin           
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
End                        
print @SBcategory                      
print @percentage                        
print @Multiplier                        
                        
                        
--declare @netbrokerage money                        
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                        
print @netbrokerage                        
                        
update #OPFILE                        
set NetBrokerage=@netbrokerage                        
                         
 --select * into t from #OPFILE                       
   
 --commented by sandeep on 13 Feb 2017   
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                        
  
set @pureRisk=(select (sum([SB Cr After Adj])) from #OPFILE)                        
  
  
print 'pureRisk'  
print @pureRisk   
if(@pureRisk>0)                        
Begin                        
  
--commented by sandeep on 13 Feb 2017        
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )                
  
  
  
--//Added by Prashant P on 16102018  
--set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )                
  
set @SBCredit=@pureRisk*@Multiplier--( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)  
print 'SBCREDIT'  
print @SBCredit   
---///END//---  
  
--if(@SBCredit>@limit)  
--Begin  
--set @SBCredit=@limit  
--End      
--else  
--Begin  
--set @SBCredit=@SBCredit  
--End  
  
      
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                   
 print 'SBCREDIT'                  
 print @SBCredit                       
                        
                        
End             
else                        
Begin                        
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')           
End                    
End                    
else                    
Begin                    
print 'HI'                    
set @SBCredit=(Select 'Subbroker does not exists')                        
End          
 --declare @SBTotalLimit varchar(max)  
 --set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode=@Sbcode)  
 --print @SBTotalLimit  
   
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_Franchise
-- --------------------------------------------------
--Prc_GetLimitAvailable_Franchise 'AMRHM',''                        
                        
CREATE Procedure [dbo].[Prc_GetLimitAvailable_Franchise]                        
@Sbcode varchar(50),                      
@SBCredit varchar(max) out                        
As                        
Begin                        
--declare @Sbcode varchar(50)                        
--set @Sbcode ='alc'                        
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL          
DROP TABLE #OPFILE          
          
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50)                        
--if exists(select * from [CSOKYC-6].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                        
if exists(select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)             

Begin                    
--drop table #OPFILE    

  SELECT a.Region,  Branch,[Branch Name]=a.BranchName,convert(varchar(50),'') as [SB Cat],convert(decimal(15,0),Sum(a.Tot_SBRisk)/1) as [Risk],    
  convert(decimal(15,0),Sum(a.Sb_ProjRisk)/1) as [Projected Risk],convert(money,'0') as SBCredit,convert(money,'0') as NetBrokerage,convert(money,'0') as [SB Cr After Adj]    into #OPFILE 
  From (  SELECT a.Region,A.BRANCH,a.BranchName,
  a.SB,a.BrType, Sum(b.Net) Net, Sum(b.Exp_Gross)Exp_Gross, br_credit=Case WHEN (BRTYPE='FR' OR A.BRANCH IN ('VD','AHD')) then MAX(b.br_credit) 
  else 0 end , Sum(b.Margin_Shortage) Margin_Shortage, MAX(b.Tot_SBRisk) Tot_SBRisk,  BR_CrAdjusted= Case WHEN (BRTYPE='FR' OR A.BRANCH 
  IN ('VD','AHD')) then MAX(b.BR_CrAdjusted) else 0 end ,  MAX(b.Sb_ProjRisk)Sb_ProjRisk , Sum(b.cli_count ) cli_count, MAX(a.NoOfClients ) 
  NoOfClients FROM [CSOKYC-6].general.dbo.Vw_RMS_SB_Vertical a  INNER JOIN [CSOKYC-6].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and a.Branch=b.Branch_cd  and a.BRANCH like @Sbcode
  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'  group by a.BrType,a.Region,a.Branch,a.BranchName,SB )a 
  group by a.BrType,a.BrType,a.Region,a.Branch,a.BranchName ORDER BY sum(a.Net) 


  update #OPFILE
  set SBCredit=(select SB_Credit=CONVERT(decimal(15,2),MAX(isnull(SB_Credit,0)) ) from [CSOKYC-6].general.dbo.tbl_RMS_collection_SB with(nolock) 
  where Branch_Cd=@Sbcode),
  [SB Cat]=(select MAX(a.Sb_Category) from [CSOKYC-6].general.dbo.tbl_RMS_collection_SB a where Branch_Cd=@Sbcode)
 
  update #OPFILE
  set [SB Cr After Adj]=(select (sum([SBCredit])-(sum([Risk])*-1))  from #OPFILE)   

                    
  set @SBcategory=(select top 1 [SB Cat] from #OPFILE)                        
                        
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                        
Begin                        
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
End                        
else                        
Begin                        
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
End                        
print @SBcategory                      
print @percentage                        
print @Multiplier                        
                        
                        
--declare @netbrokerage money                        
exec  sp_Viewsharing_Franchise @Sbcode,@Percentage,@netbrokerage out                        
print @netbrokerage                        
                        
update #OPFILE                        
set NetBrokerage=@netbrokerage                        
                         
 --select * into t from #OPFILE                       
 --commented by sandeep on 13 Feb 2017
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                        
set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                        
if(@Sbcode='TRFBR')
BEGIN
set @pureRisk=1
END

print 'pureRisk'  
print @pureRisk   
if(@pureRisk>0)                        
Begin                        
--commented by sandeep on 13 Feb 2017
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )                

--Manual Set the Limit for the Subbroker 

if(@Sbcode='TRFBR')
Begin
set @SBCredit=2500000
End
else if(@Sbcode='INDOYN')
Begin
set @SBCredit=5000000
End
else if(@Sbcode='AMRHM')
Begin
set @SBCredit=25000000
End
Else
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj])  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )                
END      
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                   
 print 'SBCREDIT'                  
 print @SBCredit                       
 --select @SBCredit                       
                        
End             
else                        
Begin                        
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')           
End                    
End                    
else                    
Begin                    
print 'HI'                    
set @SBCredit=(Select 'Subbroker does not exists')                        
End                        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_Franchise_01Sep2017
-- --------------------------------------------------
--Prc_GetLimitAvailable_Franchise 'xn',''                        
                        
Create Procedure [dbo].[Prc_GetLimitAvailable_Franchise_01Sep2017]                        
@Sbcode varchar(50),                      
@SBCredit varchar(max) out                        
As                        
Begin                        
--declare @Sbcode varchar(50)                        
--set @Sbcode ='alc'                        
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL          
DROP TABLE #OPFILE          
          
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50)                        
--if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                        
if exists(select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)             

Begin                    
--drop table #OPFILE    

  SELECT a.Region,  Branch,[Branch Name]=a.BranchName,convert(varchar(50),'') as [SB Cat],convert(decimal(15,0),Sum(a.Tot_SBRisk)/1) as [Risk],    
  convert(decimal(15,0),Sum(a.Sb_ProjRisk)/1) as [Projected Risk],convert(money,'0') as SBCredit,convert(money,'0') as NetBrokerage,convert(money,'0') as [SB Cr After Adj]    into #OPFILE 
  From (  SELECT a.Region,A.BRANCH,a.BranchName,
  a.SB,a.BrType, Sum(b.Net) Net, Sum(b.Exp_Gross)Exp_Gross, br_credit=Case WHEN (BRTYPE='FR' OR A.BRANCH IN ('VD','AHD')) then MAX(b.br_credit) 
  else 0 end , Sum(b.Margin_Shortage) Margin_Shortage, MAX(b.Tot_SBRisk) Tot_SBRisk,  BR_CrAdjusted= Case WHEN (BRTYPE='FR' OR A.BRANCH 
  IN ('VD','AHD')) then MAX(b.BR_CrAdjusted) else 0 end ,  MAX(b.Sb_ProjRisk)Sb_ProjRisk , Sum(b.cli_count ) cli_count, MAX(a.NoOfClients ) 
  NoOfClients FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a  INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and a.Branch=b.Branch_cd  and a.BRANCH like @Sbcode
  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'  group by a.BrType,a.Region,a.Branch,a.BranchName,SB )a 
  group by a.BrType,a.BrType,a.Region,a.Branch,a.BranchName ORDER BY sum(a.Net) 


  update #OPFILE
  set SBCredit=(select SB_Credit=CONVERT(decimal(15,2),MAX(isnull(SB_Credit,0)) ) from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) 
  where Branch_Cd=@Sbcode),
  [SB Cat]=(select MAX(a.Sb_Category) from [196.1.115.182].general.dbo.tbl_RMS_collection_SB a where Branch_Cd=@Sbcode)
 
  update #OPFILE
  set [SB Cr After Adj]=(select (sum([SBCredit])-(sum([Risk])*-1))  from #OPFILE)   

                    
  set @SBcategory=(select top 1 [SB Cat] from #OPFILE)                        
                        
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                        
Begin                        
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
End                        
else                        
Begin                        
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
End                        
print @SBcategory                      
print @percentage                        
print @Multiplier                        
                        
                        
--declare @netbrokerage money                        
exec  sp_Viewsharing_Franchise @Sbcode,@Percentage,@netbrokerage out                        
print @netbrokerage                        
                        
update #OPFILE                        
set NetBrokerage=@netbrokerage                        
                         
 --select * into t from #OPFILE                       
 --commented by sandeep on 13 Feb 2017
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                        
set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                        

print 'pureRisk'  
print @pureRisk   
if(@pureRisk>0)                        
Begin                        
--commented by sandeep on 13 Feb 2017
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )                

set @SBCredit=(select (sum([SB Cr After Adj])  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )                
      
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                   
 print 'SBCREDIT'                  
 print @SBCredit                       
 --select @SBCredit                       
                        
End             
else                        
Begin                        
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')           
End                    
End                    
else                    
Begin                    
print 'HI'                    
set @SBCredit=(Select 'Subbroker does not exists')                        
End                        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_test
-- --------------------------------------------------
--Prc_GetLimitAvailable_test 'FRIL',''  
--Prc_GetLimitAvailable_test 'DDOD',''
                      
CREATE Procedure [dbo].[Prc_GetLimitAvailable_test]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='GGDB'                      
IF OBJECT_ID('tempdb..#tbl_RMS_collection_SB') IS NOT NULL        
DROP TABLE #tbl_RMS_collection_SB   

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE 

select a.*,b.* into #tbl_RMS_collection_SB from [196.1.115.182].general.dbo.tbl_RMS_collection_SB a inner join [196.1.115.182].general.dbo.tbl_SB_purerisk_afterDPADj b
on a.Sub_Broker=b.sb 
where b.sb=@Sbcode

                     
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_Credit,0)+(purerisk_afterdp_adj)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN #tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK' or @Sbcode='PJMA' or @Sbcode='AKJ' or @Sbcode='ET')
begin 
set @SBCredit=10000000
end


--else if(@Sbcode='ET')
--begin 
--set @SBCredit=7500000
--end

else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='DDOD' or @Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU' or @Sbcode='DDM' or @Sbcode='DSB')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 


else if(@Sbcode='PPSF')
BEGIN 
	set @SBCredit=8000000
END 

--else if(@Sbcode='BBH')
--BEGIN 
--	set @SBCredit=900000
--END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT' or @sbcode='EEEC')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ' or @Sbcode='AINE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=2500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU' or @Sbcode='DDOD')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		else if (@SbCode='NVP')
		Begin
		  Set @SBCredit=1500000
		End
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else if(@Sbcode='ADHC')
		Begin
		set @SBCredit=1000000
		End
		else if(@Sbcode='PJMA')
		Begin
		set @SBCredit=10000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_testphase_23April2020
-- --------------------------------------------------
--Prc_GetLimitAvailable 'FRIL',''  
--Prc_GetLimitAvailable 'BIBL',''
                      
Create Procedure [dbo].[Prc_GetLimitAvailable_testphase_23April2020]                      
@Sbcode varchar(50),                    
@SBCredit varchar(max) out   
--@SBTotalLimit varchar(max) out
As                      
Begin                      

--declare @Sbcode varchar(50),@SBCredit varchar(50)
--set @Sbcode ='DDM'

IF OBJECT_ID('tempdb..#tbl_RMS_collection_SB') IS NOT NULL        
DROP TABLE #tbl_RMS_collection_SB                         

IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL        
DROP TABLE #OPFILE        
        declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50),@Limit decimal(38,2)                      
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                      
Begin                  
--drop table #OPFILE


select a.*,b.* into #tbl_RMS_collection_SB from [196.1.115.182].general.dbo.tbl_RMS_collection_SB a inner join [196.1.115.182].general.dbo.tbl_SB_purerisk_afterDPADj b
on a.Sub_Broker=b.sb 
where b.sb=@Sbcode
                      
SELECT a.Region,a.Branch,                        
[Sub Broker]=a.SB,                      
[SB Name]=a.SB_Name,                      
MAX(B.Sb_Category) as [SB Cat],                      
CONVERT(decimal(15,2),MAX(isnull(b.SB_Credit,0)+(purerisk_afterdp_adj)) ) as [SB Cr After Adj],                        
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                      
INTO #OPFILE                       
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN #tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                       
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                         
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                        
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                        
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                        
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                        
                      
alter table #OPFILE                      
alter column NetBrokerage int                      
set @SBcategory=(select top 1 [SB Cat] from #OPFILE) 
set @Limit=(select Limit from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)     

--//New logic from total limit added by Prashant P on 16102018//--

--SELECT v.sb, t.party_code, unreco_credit=sum(t.unreco_credit), net_available=sum(t.net_available), pure_risk=sum(t.pure_risk), cheque_ret_val=cast(0.00 AS
--money) INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock) ON t.party_code=v.client 
--WHERE v.sb LIKE '%' GROUP BY v.sb, t.party_code
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=CASE WHEN pure_risk <0.00 AND 
--unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), (pure_risk - unreco_credit )) 
--WHEN pure_risk =0.00 AND unreco_credit>0.00 THEN CONVERT(DECIMAL(15, 2), ( 
--net_available - unreco_credit )) WHEN pure_risk <0.00 AND unreco_credit=0.00 
--THEN CONVERT(DECIMAL(15, 2), (pure_risk)) ELSE 0.00 end 
--UPDATE #sb_riskafterunclearcheque SET cheque_ret_val=0.00 WHERE cheque_ret_val>0.00 


--SELECT sb, cheque_ret_val=sum(cheque_ret_val)/100000 into #dd FROM 
--#sb_riskafterunclearcheque  GROUP BY sb

----///END//---

                                   
                      
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                      
Begin                      
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                      
End                      
else                      
Begin          
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                      
End                      
print @SBcategory                    
print @percentage                      
print @Multiplier                      
                      
                      
--declare @netbrokerage money  
if(select sum([SB Cr After Adj]) from #OPFILE)>0  
BEGIN                    
exec  sp_Viewsharing @Sbcode,@Percentage,@netbrokerage out                      
print 'SBCREDIT is in Positive'
print @netbrokerage                      
END
ELSE
BEGIN
PRINT 'SBCREDIT IS IN PURE RISK'
SET @NETBROKERAGE=0
END

                      
update #OPFILE                      
set NetBrokerage=@netbrokerage                      
                       
 --select * into t from #OPFILE                     
 
 --commented by sandeep on 13 Feb 2017 
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)                      



print 'pureRisk'
print @pureRisk 
if(@pureRisk>0)                      
Begin                      

--commented by sandeep on 13 Feb 2017   
---***   
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              

if(@Sbcode='AMMT' or @Sbcode='MMJC'  or @Sbcode='CCNU')
Begin
set @SBCredit=0
End

else if(@Sbcode='NK' or @Sbcode='PJMA' or @Sbcode='AKJ' or @Sbcode='ET')
begin 
set @SBCredit=10000000
end


--else if(@Sbcode='ET')
--begin 
--set @SBCredit=7500000
--end

else if(@Sbcode='TTAC')
begin 
set @SBCredit=1370000
end

else if(@Sbcode='SHBR')
Begin 
	set @SBCredit=1250000
end

else if(@Sbcode='DDOD' or @Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='PTSH' or @Sbcode='RUTR' or @Sbcode='SHHA' or @SbCode='AD'  or @Sbcode='NU' or @Sbcode='DDM' or @Sbcode='DSB')
Begin
set @SBCredit=5000000
End


else if(@Sbcode='PPNR')
BEGIN 
	set @SBCredit=6000000
END 


else if(@Sbcode='PPSF')
BEGIN 
	set @SBCredit=8000000
END 

--else if(@Sbcode='BBH')
--BEGIN 
--	set @SBCredit=900000
--END 

else if (@Sbcode='DFC')
begin 
	set @SBCredit=4000000
end

else if(@Sbcode='KTG' or @Sbcode='BBGU')
BEGIN 
	set @SBCredit=300000
END

else if(@Sbcode='NGP')
BEGIN 
	set @SBCredit=2600000
END

else if(@Sbcode='DHMS')
BEGIN 
	set @SBCredit=200000
END 

else if(@Sbcode='SUDR')
BEGIN 
	set @SBCredit=5000000
END 

else if(@Sbcode='PRYP' or @Sbcode='BOP')
BEGIN 
	set @SBCredit=250000
END 

else if(@Sbcode='WANT' or @Sbcode='AAOAB' or @Sbcode='DAKS' or @Sbcode='AMBK3' or @Sbcode='RRNS' or @Sbcode='AMBC')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='SBPP' or @sbcode='MLL')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='DDMC' or @sbcode='HEKA' or @Sbcode='RIPK')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='DLH' Or @Sbcode='CCVH' or @Sbcode='DSM')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='KLY' or @Sbcode='VVMT' or @sbcode='EEEC')
BEGIN 
	set @SBCredit=2000000
END

else if(@Sbcode='ALHG')
BEGIN 
	set @SBCredit=5000000
END

else if(@Sbcode='DDHY')
BEGIN 
	set @SBCredit=7000000
END


else if (@Sbcode='HLDWNI')
begin 
set @SBCredit=2000000
end

else if(@Sbcode='WANT' or @Sbcode='AAOAB')
BEGIN 
	set @SBCredit=2000000
END 

else if(@Sbcode='IPHO' or @sbcode='VVMJ' or @sbcode='ASIM' or @sbcode='MPRO'  or @Sbcode='KOKN' or @Sbcode='JLP')
BEGIN 
	set @SBCredit=500000
END 

--else if(@Sbcode='GFS')
--BEGIN 
--	set @SBCredit=700000
--END 

else if(@Sbcode='ANAA' or @Sbcode='AOAK')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='ASDA' or @Sbcode='YYSB' or @Sbcode='BBCN' or @Sbcode='SREV' or @Sbcode='SMD' or @Sbcode='MF' or @SbCode='MMGG' or @Sbcode='KFN' Or @Sbcode='SSON' or @Sbcode='GOD' or @Sbcode='DFCD' or @Sbcode='CN' or @Sbcode='AMRP' or @Sbcode='CAZ' or @Sbcode='AINE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='NNJD')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='AAGI' or @Sbcode='OPGS')
BEGIN 
	set @SBCredit=1500000
END 

else if(@Sbcode='MLB' Or @Sbcode='NNVI' or @Sbcode='MMYG' or @Sbcode='HHUP')
BEGIN 
	set @SBCredit=3000000
END 

else if(@Sbcode='DDNJ')
BEGIN 
	set @SBCredit=400000
END 

else if(@Sbcode='RFSL')
BEGIN 
	set @SBCredit=600000
END 

else if(@Sbcode='SLJ')
BEGIN 
	set @SBCredit=500000
END 



else if(@Sbcode='MAEJ')
BEGIN 
	set @SBCredit=1500000
END 

else if (@Sbcode='KKRR')
BEGIN
set @SBCredit=3000000
END

else if( @Sbcode='NTP')
BEGIN 
	set @SBCredit=2500000
END 

else if(@Sbcode='HARV' or @Sbcode='SKAC')
BEGIN 
	set @SBCredit=1200000
END 



else if(@Sbcode='JJIS')
BEGIN 
	set @SBCredit=2500000
END

else if(@Sbcode='TTNC' or @Sbcode='MZ')
BEGIN 
	set @SBCredit=5000000
END


else if(@Sbcode='PUPW' or @Sbcode='RDE')
BEGIN 
	set @SBCredit=1000000
END 


else if(@Sbcode='LC')
BEGIN 
	set @SBCredit=525000
END 

else if(@Sbcode='SMIR')
Begin
set @SBCredit=10000000
End


else if(@Sbcode='DR' or @Sbcode='RGA' or @Sbcode='SSUAB' or @Sbcode='BBDY' or @Sbcode='ICFS')
Begin
set @SBCredit=1000000
End

else if(@Sbcode='NNDE' Or @Sbcode='DDBC' or @Sbcode='BBMB')
Begin
set @SBCredit=400000
End

else if(@Sbcode='RMAG')
Begin
set @SBCredit=1800000
End

else if(@Sbcode='AAOA')
Begin
set @SBCredit=200000
End

else if(@Sbcode='SKACA' or @Sbcode='JJOD')
Begin
set @SBCredit=700000	
End

else if(@Sbcode='KOS')
Begin
set @SBCredit=450000	
End

else if(@Sbcode='SSMW')
Begin
set @SBCredit=0	
End


else if(@Sbcode='HHNF' or @Sbcode='DEBB' or @SbCode='BBKG' or @Sbcode='PPCW' or @Sbcode='ACU' or @Sbcode='JIKU' or  @Sbcode='AWS' or @Sbcode='JJUI' or @sbcode='RRSV' or @Sbcode='GETA')
Begin
set @SBCredit=500000
End

else if(@Sbcode='PPSU' or @sbcode='PPS' or @Sbcode='WALT')
Begin
set @SBCredit=5000000
End

else if(@Sbcode='ADHC' or @Sbcode='VIK')
Begin
set @SBCredit=2000000
End 

else if(@Sbcode='JJHH')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='BLI')
Begin
set @SBCredit=2300000
End 


else if(@Sbcode='KKRK')
Begin
set @SBCredit=600000
End 

else if(@Sbcode='DRT')
Begin
set @SBCredit=2500000
End 


else if(@Sbcode='GGJU'  or @Sbcode='KKI')
Begin
set @SBCredit=1200000
End 

else if(@Sbcode='CHT')
Begin
set @SBCredit=1500000
End 

else if(@Sbcode='RRBY')
Begin
set @SBCredit=3000000
End 


else if(@Sbcode='VIVL')
Begin
set @SBCredit=2500000
End 

--

else if (@Sbcode='SSFJ')
Begin 
Set @SBCredit=3000000
END

else IF (@Sbcode = 'FRIL')
Begin
set @SBCredit=20000000
End

else IF (@Sbcode = 'AGO')
Begin
set @SBCredit=2000000
End

else IF (@Sbcode='DDPM')
Begin
set @SBCredit=15000000
End

else If(@Sbcode='CSCS')
BEGIN
SET @SBCredit=5000000
END

else IF (@Sbcode='DDPMC')
Begin
set @SBCredit=2500000
End


ELSE
BEGIN
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
--//Added by Prashant P on 16102018
--set @SBCredit=( select (sum([SB Cr After Adj])+ sum(cheque_ret_val)+ sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE a inner join #dd b on a.[Sub Broker]=b.sb)

---///END//---

if(@SBCredit>@limit)
Begin
		if (@SBcategory='Silver') or (@SBcategory='Silver Plus')  or (@SBcategory='Gold')
		begin 
			set @SBCredit=@SBCredit
		END
	    else
	    BEGIN 
			set @SBCredit=@Limit
	    END
End    
else
Begin
set @SBCredit=@SBCredit
End
END
    
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                 
 print 'SBCREDIT'                
 print @SBCredit                     
                      
                 
End          
else                      
Begin

		
		
		if(@Sbcode='JJHH')
		Begin
		set @SBCredit=2500000
		End
		
		
		else if(@Sbcode='DDPM')
		Begin
		set @SBCredit=15000000
		End
		
		else if(@Sbcode='AMRHM')
		begin 
		set @SBCredit=20000000
		end
		
		else if(@Sbcode='DHMS')
		BEGIN 
			set @SBCredit=200000
		END
		 
		-- if(@Sbcode='ICFS')
		--Begin
		--set @SBCredit=500000
		--End
		
		else if(@Sbcode='PPSU' or @Sbcode='DDOD')
		Begin
		set @SBCredit=5000000
		End
		
		else IF (@Sbcode='DDPMC')
		Begin
		set @SBCredit=2500000
		End
		
		else if(@Sbcode='RDE' or @Sbcode='AMRP')
		BEGIN 
			Set @SBCredit=1000000
		END
		
		else IF (@Sbcode='SOSP')
		Begin
		set @SBCredit=200000
		End
		
		
		else if (@SbCode='ICFS')
		BEGIN
			Set @SBCredit=1000000
		END
		else if (@SbCode='NVP')
		Begin
		  Set @SBCredit=1500000
		End
		--else if(@Sbcode='AMRHM')
		--Begin
		--set @SBCredit=20000000
		--End
		
		else if(@Sbcode='GGIV' or @Sbcode='SSIE' or @Sbcode='AKFI' or @Sbcode='AKSH' or @Sbcode='CSCS')
		Begin
		set @SBCredit=5000000
		End
		else if(@Sbcode='ADHC')
		Begin
		set @SBCredit=1000000
		End
		else if(@Sbcode='PJMA')
		Begin
		set @SBCredit=10000000
		End
		else
		Begin
		set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')         
        End              

End                  
End                  
else                  
Begin                  
print 'HI'                  
set @SBCredit=(Select 'Subbroker does not exists')                      
End   
	--declare @SBTotalLimit varchar(max)
	--set @SBTotalLimit=(select sum(enterlimit) from dbo.tbl_SBLimitAllocation where sbcode='JJRT')
	--print @SBTotalLimit
                   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetLimitAvailable_Uat
-- --------------------------------------------------
--Prc_GetLimitAvailable_Uat 'PPJE',''                        
                        
CREATE Procedure [dbo].[Prc_GetLimitAvailable_Uat]                        
@Sbcode varchar(50),                      
@SBCredit varchar(max) out                        
As                        
Begin                        
--declare @Sbcode varchar(50)                        
--set @Sbcode ='alc'                        
IF OBJECT_ID('tempdb..#OPFILE') IS NOT NULL          
DROP TABLE #OPFILE          
          
declare @netbrokerage int,@pureRisk money,@percentage int,@Multiplier int,@SBcategory varchar(50)                        
if exists(select * from [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where sb=@sbcode)                        
Begin                    
--drop table #OPFILE                        
SELECT a.Region,a.Branch,                          
[Sub Broker]=a.SB,                        
[SB Name]=a.SB_Name,                        
MAX(B.Sb_Category) as [SB Cat],                        
CONVERT(decimal(15,2),MAX(isnull(b.SB_CrAfterAdjPureRisk,0)) ) as [SB Cr After Adj],                          
CONVERT(decimal(15,2),MAX(b.Tot_ProjRisk) ) as [Projected Risk],'0' as NetBrokerage                        
INTO #OPFILE                         
FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB=b.Sub_Broker and                         
a.Branch=b.Branch_cd  AND B.cli_Priorities like '%'  AND B.Cli_category like '%'  AND B.DrCr like '%'                           
and a.SB in ( select distinct regtag from mis.sb_comp.dbo.bpregmaster                          
where (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) =                          
(select distinct (case when isnull(regreferencetag,'') = '' then regtag else regreferencetag end) ParentTAG from mis.sb_comp.dbo.bpregmaster                          
where regtag = @Sbcode)) where a.sb=@Sbcode  group by a.Region,a.Branch,a.SB,a.SB_Type ,B.Sb_Category ,a.SB_Name,SB_ROI  ORDER BY sum(b.Net)                          
                        
alter table #OPFILE                        
alter column NetBrokerage int                        
set @SBcategory=(select top 1 [SB Cat] from #OPFILE)                        
                        
if exists (select * from tbl_SBIndividual where SBcode=@Sbcode)                        
Begin                        
set @percentage=(select percentage from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
set @Multiplier=(select Multiplier from tbl_SBIndividual with(nolock) where SBcode=@SBcode)                        
End                        
else                        
Begin                        
set @percentage=(select percentage from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
set @Multiplier=(select Multiplier from tbl_SBCategoryGoodWill with(nolock)  where SBCategory=@SBcategory)                        
End                        
print @SBcategory                      
print @percentage                        
print @Multiplier                        
                        
if(select sum([SB Cr After Adj]) from #OPFILE)>0                        
--declare @netbrokerage money                   
Begin     
exec  sp_Viewsharing_uat @Sbcode,@Percentage,@netbrokerage out                        
print 'SBCREDIT is in Positive'
print @netbrokerage                        
End
else
Begin
print 'SBCREDIT is in Pure Risk'
set @netbrokerage=0
End

                        
update #OPFILE                        
set NetBrokerage=@netbrokerage                        
--drop table t                         
 select * into t from #OPFILE                       
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                        
--set @pureRisk=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1))+ sum(NetBrokerage) from #OPFILE)                      

set @pureRisk=(select (sum([SB Cr After Adj]))+ sum(NetBrokerage) from #OPFILE)
if(@Sbcode='TRFBR')
BEGIN
set @pureRisk=1
END
print 'pureRisk'  
print @pureRisk   
if(@pureRisk>0)                        
Begin                        
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end)) from #OPFILE )                      
--set @SBCredit=(select (sum([SB Cr After Adj])-(sum([Projected Risk])*-1)  + sum(NetBrokerage))*(case when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )                
if(@Sbcode='TRFBR')
Begin
set @SBCredit=2500000
End
else 
Begin
set @SBCredit=(select (sum([SB Cr After Adj]) + sum(NetBrokerage))*(case when @Sbcode='RATO' then 0 when isnull(@Multiplier,0)=0 then 1 else @Multiplier end) from #OPFILE )              
End
      
--select SBCredit=(sum([SB Cr After Adj])-(sum([Projected Risk])*-1)) +(sum(NetBrokerage)*@Multiplier) from #OPFILE                   
 print 'SBCREDIT'                  
 print @SBCredit                       
 
 print 'Multiplier'
 print @Multiplier
                        
                        
End             
else                        
Begin                        
set @SBCredit=(Select 'SB is in pure risk Additional Limit Cannot be Granted')           
End                    
End                    
else                    
Begin                    
print 'HI'                    
set @SBCredit=(Select 'Subbroker does not exists')                        
End                        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_InsErrLog
-- --------------------------------------------------
Create Procedure Prc_InsErrLog  
@Errdesc varchar(max),  
@Functionname varchar(50),  
@Pagename varchar(50),  
@CreatedBy varchar(50)  
As  
Begin  
insert into tbl_Errorlog  
(Err_desc,Function_Name,PageName,CreatedBy,CreatedDT)  
values  
(@Errdesc,@Functionname,@Pagename,@CreatedBy,getdate())  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_InsSBAllocationLog
-- --------------------------------------------------

CREATE Procedure [dbo].[Prc_InsSBAllocationLog]  
As  
Begin  
  
if exists (select * from tbl_SBLimitAllocation where convert(varchar(12),CreatedDT,106)=convert(varchar(12),getdate(),106))  
begin  
insert into tbl_SBLimitAllocation_LogDetails
(RecID,SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT,UpdatedBy,UpdatedDT)  
select 
RecID,SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT,UpdatedBy,UpdatedDT
 from tbl_SBLimitAllocation with(nolock)  

truncate table tbl_SBLimitAllocation 

End  


if exists (select * from tbl_InstClinetLimit_newAPI where convert(varchar(12),Createdate,106)=convert(varchar(12),getdate(),106))  
begin  
	insert into tbl_InstClinetLimit_newAPI_Hist
	(party_code,tag,servermapped,Segments,Clientlimit,LimitResponse,LimitResponseMesaage,Createdate,Updateddate,TotalLimit,Update_Histtable)  
	select 
	party_code,tag,servermapped,Segments,Clientlimit,LimitResponse,LimitResponseMesaage,Createdate,Updateddate,TotalLimit,GETDATE() as Update_Histtable
	from tbl_InstClinetLimit_newAPI with(nolock)  

	truncate table tbl_InstClinetLimit_newAPI 

End
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_UpdLimitResponse
-- --------------------------------------------------
CREATE Procedure [dbo].[Prc_UpdLimitResponse]   
@ClientCode varchar(50),  
@Segment varchar(50),  
@LimitAmt money,  
@LimitResponse bit,  
@LimitResponseMessage varchar(50)  
As  
Begin  
declare @SBCode varchar(50)  
set @SBCOde=(select Sub_broker from [CSOKYC-6].general.dbo.client_details with(nolock) where party_code=@ClientCode)  
  
  
update tbl_SBLimitAllocation   
set LimitResponse=@LimitResponse,  
LimitResponseMesaage=@LimitResponseMessage ,
UpdatedDT=getdate()

where sbcode=@sbcode and TotalEnterlimit=@LimitAmt and Clientcode=@ClientCode and LimitResponse=0 and segment=case when @Segment='41' then 'Equity+FNO+Curr' when @segment='17' then 'NBFC' when @segment='16' then 'Commodity' end  
  
update tbl_APICALLLog   
set LimitResponse=@LimitResponse,  
LimitResponseMesaage=@LimitResponseMessage ,
UpdatedDT=getdate()
 
where sbcode=@sbcode and TotalEnterlimit=@LimitAmt and Clientcode=@ClientCode and LimitResponse=0 and segment=case when @Segment='41' then 'Equity+FNO+Curr' when @segment='17' then 'NBFC' when @segment='16' then 'Commodity' end  



update tbl_SBLimitAllocation_LogDetails   
set LimitResponse=@LimitResponse,  
LimitResponseMesaage=@LimitResponseMessage,
UpdatedDT=getdate()
where sbcode=@sbcode and TotalEnterlimit=@LimitAmt and Clientcode=@ClientCode and LimitResponse=0 and segment=case when @Segment='41' then 'Equity+FNO+Curr' when @segment='17' then 'NBFC' when @segment='16' then 'Commodity' end  
  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_7Viewsharing
-- --------------------------------------------------
--sp_7Viewsharing 'NGG'  
  
CREATE proc sp_7Viewsharing (@sbcode varchar(20))          
 as           
 begin       
 Declare @from date, @to date    
 select @from =fromdate,@to=todate from  dbo.aksdate()    
           
 set transaction isolation level read uncommitted                
   
                
 select  Angel_Share=isnull(sum(Angel_Share),0)                
 from                 
 MIS.remisior.dbo.company b with(nolock) left outer join                 
 (                
 select segment,Angel_Share=sum(Angel_Share)                
 from MIS.remisior.dbo.comb_sb with(nolock) where  cast(sauda_DAte as date) between  @from  and @to                  
 and subbrokcode=@sbcode                
 group by segment                
 ) a on a.segment=b.coshrtname                
   
 --order by b.coshrtname               
           
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Viewsharing
-- --------------------------------------------------
--sp_Viewsharing  'et','50',''          
CREATE proc [dbo].[sp_Viewsharing] (@sbcode varchar(20),@percentage int,@netbrokerage int out)                  
 as                   
 begin               
 Declare @from date, @to date,@brokerage money           
 select @from =fromdate,@to=todate from dbo.aksdate()            
           
                   
 set transaction isolation level read uncommitted                        
 set @netbrokerage=(                        
 select  Angel_Share=isnull(sum(remi_share),0)                        
 from                         
 MIS.remisior.dbo.company b (nolock) left outer join                         
 (                        
 select segment,                        
 Gross_Brok=sum(Brok_earned),Remi_share=sum(remi_share),Sub_Remi_Share=sum(sub_remi_share),                        
 Angel_Share=sum(Angel_Share)                        
 from MIS.remisior.dbo.comb_sb where  cast(sauda_DAte as date) between  @from  and @to                          
 and subbrokcode=@sbcode                        
 group by segment                        
 ) a on a.segment=b.coshrtname              )           
 --order by b.coshrtname     
 print @netbrokerage  
 print @percentage                    
 if(@percentage>=0)        
 Begin          
 set @netbrokerage=(select round((@netbrokerage*@percentage)/100,0))          
 set @netbrokerage=convert(int,@netbrokerage)    
 end        
 else        
 begin        
 set @netbrokerage=(select  round(@netbrokerage,0))        
 set @netbrokerage=convert(int,@netbrokerage)    
 end        
  --select  @netbrokerage         
 --          select @netbrokerage        
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Viewsharing_Franchise
-- --------------------------------------------------
--sp_Viewsharing  'xn','50',''            
CREATE proc [dbo].[sp_Viewsharing_Franchise] (@sbcode varchar(20),@percentage int,@netbrokerage int out)                    
 as                     
 begin                 
 Declare @from date, @to date,@brokerage money             
 select @from =fromdate,@to=todate from dbo.aksdate()              
 print @from   
 print @to            
                     
 set transaction isolation level read uncommitted                          
 set @netbrokerage=(                          
 select  Angel_Share=isnull(sum(Franshare),0)                          
 from                           
 MIS.remisior.dbo.company b (nolock) left outer join                           
 (                          
 select segment,                          
 Gross_Brok=sum(Brok_earned),Remi_share=sum(remi_share),Sub_Remi_Share=sum(sub_remi_share),                          
 Angel_Share=sum(Angel_Share),Franshare=sum(Franshare)                          
 from MIS.remisior.dbo.comb_sb where  cast(sauda_DAte as date) between  @from  and @to                            
 and branch=@sbcode      
 group by segment                          
 ) a on a.segment=b.coshrtname              )             
 --order by b.coshrtname       
 print @netbrokerage    
 print @percentage                      
 if(@percentage>=0)          
 Begin            
 set @netbrokerage=(select round((@netbrokerage*@percentage)/100,0))            
 set @netbrokerage=convert(int,@netbrokerage)      
 end          
 else          
 begin          
 set @netbrokerage=(select  round(@netbrokerage,0))          
 set @netbrokerage=convert(int,@netbrokerage)      
 end          
  --select  @netbrokerage           
 --          select @netbrokerage          
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Viewsharing_uat
-- --------------------------------------------------
CREATE proc sp_Viewsharing_uat (@sbcode varchar(20),@percentage int,@netbrokerage int out)                      
 as                       
 begin                   
 Declare @from date, @to date,@brokerage money               
 select @from =fromdate,@to=todate from dbo.aksdate()                
               
                       
 set transaction isolation level read uncommitted                            
 set @netbrokerage=(                            
 select  Angel_Share=isnull(sum(remi_share),0)                            
 from                             
 [MIS].remisior.dbo.company b (nolock) left outer join                             
 (                            
 select segment,                            
 Gross_Brok=sum(Brok_earned),Remi_share=sum(remi_share),Sub_Remi_Share=sum(sub_remi_share),                            
 Angel_Share=sum(Angel_Share)                            
 from [MIS].remisior.dbo.comb_sb where  cast(sauda_DAte as date) between  @from  and @to                              
 and subbrokcode=@sbcode                            
 group by segment                            
 ) a on a.segment=b.coshrtname              )               
 --order by b.coshrtname         
 print @netbrokerage      
 print @percentage                        
 if(@percentage>=0)            
 Begin              
 set @netbrokerage=(select round((@netbrokerage*@percentage)/100,0))              
 set @netbrokerage=convert(int,@netbrokerage)        
 end            
 else            
 begin            
 set @netbrokerage=(select  round(@netbrokerage,0))            
 set @netbrokerage=convert(int,@netbrokerage)        
 end            
  --select  @netbrokerage             
 --          select @netbrokerage            
 print 'LatestBrok'  
 print @netbrokerage  
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CheckLimitAvailedLog
-- --------------------------------------------------


--exec USP_CheckLimitAvailedLog 'R64678'
CREATE Proc USP_CheckLimitAvailedLog
(
@ClientCode varchar(100)
)
As
BEGIN

    declare @message varchar(10) 
	
	IF EXISTS(select BalLimit from tbl_LimitAvailedLog where BalLimit='0.00' and ClientCode=@ClientCode)
	 begin
	   SET @message='BLOCK'
	 end
	ELSE
	 BEGIN
	   SET @message='UNBLOCK'
	 END
	 SELECT @message AS BlockMessage
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_CheckLimitClient
-- --------------------------------------------------

--exec Usp_CheckLimitClient 'RP61'            
CREATE  Proc [dbo].[Usp_CheckLimitClient]             
(              
@Party_code varchar(20)            
)              
As              
Begin             
            
 declare @newClientLimit money            
             
 select @newClientLimit= isnull (sum(Clientlimit),0) from tbl_InstClinetLimit_newAPI where party_code=@Party_code  --and  LimitResponse='1'          
             
 declare @LEClientLimit money         
         
 select @LEClientLimit=isnull (sum (EnterLimit),0) from tbl_SBLimitAllocation where ClientCode=@Party_code and LimitResponse='1'     
    
declare @OTHERDEBIT money   
    if exists(select * from  [196.1.115.182].general.dbo.tbl_FINALOTHERDEBIT where Client=@Party_code)
    begin 
		select @OTHERDEBIT =  isnull (OTHERDEBIT,0) from [196.1.115.182].general.dbo.tbl_FINALOTHERDEBIT where Client=@Party_code
		
		END
	ELSE
	BEGIN
		set @OTHERDEBIT=0.00	
	END 
   
 select @newClientLimit+@LEClientLimit+@OTHERDEBIT  as ClinetLimit          
             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_CheckVintageSB
-- --------------------------------------------------


--exec Usp_CheckVintageSB 'NVP'
CREATE Procedure [dbo].[Usp_CheckVintageSB]                        
@Sbcode varchar(50)

As
begin
 
	 if exists (select * from tbl_vintage where SBTag=@Sbcode)
	 begin 
			select 'True'
	 END
	 else
	 begin 
			select 'False'
	 END
	 
	 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Client50perjob
-- --------------------------------------------------
CREATE proc [dbo].[Usp_Client50perjob]
as
begin
	
	select SBCode,ClientCode,TotalLimitAvail,sum (EnterLimit)/TotalLimitAvail*100 as ClientPer into #ff from tbl_SBLimitAllocation           
	where  LimitResponse='1' and  TotalLimitAvail<>0         
	group by SBCode,ClientCode,TotalLimitAvail  
     
     
     if exists (select SBCode from #ff where ClientPer >50.00)
	  Begin 
	     declare @filequery as varchar(500) 		  
		 declare @bodymsg as varchar(1000)
		 declare @subj as varchar(500)	
		 declare @count as varchar(10) 

		 select @count = count(1) from #ff where ClientPer >=50.00

		 set @bodymsg='Client count: '+@count+'<br><br>Please find the file attacahed.'
	      set @subj='Limit Enchancement ' + Convert(varchar,getdate(),103)      
		 set @filequery= 'select SBCode,ClientCode,TotalLimitAvail,sum (EnterLimit)/TotalLimitAvail*100 as ClientPer  from LimitEnhancement.dbo.tbl_SBLimitAllocation           
	                      where LimitResponse=1 and  TotalLimitAvail<>0 group by SBCode,ClientCode,TotalLimitAvail having (sum (EnterLimit)/TotalLimitAvail*100)>50.00'

		 EXEC msdb.dbo.sp_send_dbmail    
		 @profile_name = 'AngelBroking',    
		 --@recipients = 'rahulc.shah@angelbroking.com;sumit.bisai@angelbroking.com;bhavin@angelbroking.com;rohit.ambosta@angelbroking.com',    
		 @recipients = 'Prashant.Patade@angelbroking.com;mukesh.pandey@angelbroking.com;yogen.gandhi@angelbroking.com;paras.joshi@angelbroking.com;jogendar.dhoble@angelbroking.com;',  
		 @blind_copy_recipients='Prashant.Patade@angelbroking.com;leon.vaz@angelbroking.com',    
		 @query = @filequery,    
		 @subject = @subj,    
		 @body=@bodymsg,    
		 @attach_query_result_as_file = 1,    
		 @query_attachment_filename='File.csv',    
		 @query_result_separator = ',',    
		 --@exclude_query_output = 1,    
		 @append_query_error = 1,    
		 @query_result_header=1,    
		 @query_result_no_padding =1,
		 @body_format='HTML'  
      End

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Client50perjob_19Aug2020
-- --------------------------------------------------
CREATE proc [dbo].[Usp_Client50perjob_19Aug2020]
as
begin
	
	select SBCode,ClientCode,TotalLimitAvail,sum (EnterLimit)/TotalLimitAvail*100 as ClientPer into #ff from tbl_SBLimitAllocation           
	where  LimitResponse='1' and  TotalLimitAvail<>0         
	group by SBCode,ClientCode,TotalLimitAvail  
     
     
     if exists (select SBCode from #ff where ClientPer >50.00)
	  Begin 
	     declare @filequery as varchar(500) 		  
		 declare @bodymsg as varchar(1000)
		 declare @subj as varchar(500)	
		 declare @count as varchar(10) 

		 select @count = count(1) from #ff where ClientPer >=50.00

		 set @bodymsg='Client count: '+@count+'<br><br>Please find the file attacahed.'
	      set @subj='Limit Enchancement ' + Convert(varchar,getdate(),103)      
		 set @filequery= 'select SBCode,ClientCode,TotalLimitAvail,sum (EnterLimit)/TotalLimitAvail*100 as ClientPer  from LimitEnhancement.dbo.tbl_SBLimitAllocation           
	                      where LimitResponse=1 and  TotalLimitAvail<>0 group by SBCode,ClientCode,TotalLimitAvail having (sum (EnterLimit)/TotalLimitAvail*100)>50.00'

		 EXEC msdb.dbo.sp_send_dbmail    
		 @profile_name = 'AngelBroking',    
		 --@recipients = 'rahulc.shah@angelbroking.com;sumit.bisai@angelbroking.com;bhavin@angelbroking.com;rohit.ambosta@angelbroking.com',    
		 @recipients = 'Prashant.Patade@angelbroking.com;mukesh.pandey@angelbroking.com;yogen.gandhi@angelbroking.com;subbulakshmi.sk@angelbroking.com;paras.joshi@angelbroking.com;jogendar.dhoble@angelbroking.com;',  
		 @blind_copy_recipients='Prashant.Patade@angelbroking.com;leon.vaz@angelbroking.com',    
		 @query = @filequery,    
		 @subject = @subj,    
		 @body=@bodymsg,    
		 @attach_query_result_as_file = 1,    
		 @query_attachment_filename='File.csv',    
		 @query_result_separator = ',',    
		 --@exclude_query_output = 1,    
		 @append_query_error = 1,    
		 @query_result_header=1,    
		 @query_result_no_padding =1,
		 @body_format='HTML'  
      End

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ClientLimitPer
-- --------------------------------------------------
--exec USP_ClientLimitPer 'p67591'        
CREATE  PROC USP_ClientLimitPer        
(        
@ClientCode as varchar(50)        
)        
as        
BEGIN         
      
--declare @ClientCode as varchar(50)       
--set @ClientCode='A12240'      
      
if exists (select * from tbl_SBLimitAllocation where ClientCode=@ClientCode and LimitResponse='1')      
begin       
  select SBCode,ClientCode,TotalLimitAvail,sum (EnterLimit)/TotalLimitAvail*100 as ClientPer from tbl_SBLimitAllocation         
  where ClientCode =@ClientCode and LimitResponse='1'        
  group by SBCode,ClientCode,TotalLimitAvail        
END      
ELSE      
BEGIN       
 select '0' as SBCode ,@ClientCode as ClientCode,0 as  TotalLimitAvail,0 as ClientPer      
END      
          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ClientTypeOmnOrFT
-- --------------------------------------------------
  
  
--exec  Usp_ClientTypeOmnOrFT J14287    
CREATE Proc [dbo].[Usp_ClientTypeOmnOrFT]    
(    
@ClientCode varchar(50)=''     
)    
AS    
Begin     
  
 --declare @ClientCode varchar(100)    
 --set @ClientCode='J14287'   
  
 if exists (select * from [ABVSAWUARQ1].Angel_WMS.dbo.Users where  angelID=@ClientCode)   
 BEGIN   
  select angelID,tradingPlatform from [ABVSAWUARQ1].Angel_WMS.dbo.Users where angelID=@ClientCode     
 END  
 ELSE  
 BEGIN   
  select @ClientCode as angelID,'FT' as tradingPlatform  
 END   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Collateral_DBLog
-- --------------------------------------------------
CREATE proc Usp_Collateral_DBLog
(
@ClientID varchar(20),
@ISINCode varchar(50),
@qty varchar(10),
@Price money,
@PledgedQty varchar(10),
@grpCode varchar(10),
@buyPrice money,
@CFSHaircut money,
@HairCut money,
@Indicator varchar(10),
@collateralQTY varchar(10)
)
As
BEGIN

insert into tbl_Collateral_log(ClientID,ISINCode,qty,Price,PledgedQty,grpCode,buyPrice,CFSHaircut,HairCut,Indicator,collateralQTY)
values (@ClientID,@ISINCode,@qty,@Price,@PledgedQty,@grpCode,@buyPrice,@CFSHaircut,@HairCut,@Indicator,@collateralQTY)

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------
CREATE PROCEDURE USP_FINDINUSP                    
 @DBNAME VARCHAR(500),                  
 @SRCSTR VARCHAR(500)                    
AS                    
                    
 SET NOCOUNT ON                  
 SET @SRCSTR  = '%' + @SRCSTR + '%'                    
                  
 DECLARE @STR AS VARCHAR(1000),@xdbname as varchar(500)                  
      
 set @xdbname=@DBNAME      
      
 SET @STR=''                  
 IF @DBNAME <>''                  
 BEGIN                  
 SET @DBNAME=@DBNAME+'.DBO.'                  
 END                  
 ELSE                  
 BEGIN                  
 SET @DBNAME=DB_NAME()+'.DBO.'                  
 END                  
 ----PRINT @DBNAME                  
                  
 SET @STR='SELECT DISTINCT '''+@xdbname+''' as DBNAME,O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '                   
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '                   
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                    
 PRINT @STR                  
  EXEC(@STR)                  
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_getEnterLimitAmt
-- --------------------------------------------------

CREATE proc [dbo].[Usp_getEnterLimitAmt] 
(
@ClientCode varchar(50)
)
As
BEGIN
	if exists (select * from tbl_SBLimitAllocation_testPladge where ClientCode=@ClientCode)
	BEGIN	
		select ClientCode,isnull (sum(EnterLimit),0) TotalLimit from tbl_SBLimitAllocation_testPladge 
		where ClientCode=@clientCode and LimitResponse='1' group by ClientCode
	END
	ELSE
	BEGIN
		select @ClientCode as Clientcode,'0.00' as TotalLimit
	END	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetLimitEnch
-- --------------------------------------------------
--exec Usp_GetLimitEnch 'Et'
CREATE Proc Usp_GetLimitEnch

(
@SbTag varchar(50)
)
AS
BEGIN 
	select * from SB_LimitEnch where SBTag=@SbTag
	
	--select 'true' as MSG
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_InstClinetLimit_newAPI
-- --------------------------------------------------
CREATE Proc Usp_InstClinetLimit_newAPI  
(  
@Party_code varchar(20),  
@tag varchar(20),  
@servermapped varchar(20),  
@Segments varchar(20),  
@Clientlimit varchar (20),
@TotalLimit varchar(20)
--@LimitResponse bit null,  
--@LimitResponseMesaage varchar(100) null  
)  
As  
Begin   
  
 insert into tbl_InstClinetLimit_newAPI(party_code,tag,servermapped,Segments,Clientlimit,Createdate,TotalLimit)  
 values( @Party_code,@tag,@servermapped,@Segments,@Clientlimit,GETDATE(),@TotalLimit)  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LE_DBLog
-- --------------------------------------------------
create proc Usp_LE_DBLog
(
@ClientCode varchar(20),
@EnterLimit varchar(10)
)
As
BEGIN

insert into tbl_LE_Log (ClientCode,Amount)
Values(@ClientCode,@EnterLimit)

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LE_module_instPledge
-- --------------------------------------------------
--exec Usp_LE_module_instPledge 'M78244','123.22'
CREATE Proc Usp_LE_module_instPledge
(
@ClientCode varchar(50),
@EnterLimit money
)
As
BEGIN 
		--declare @ClientCode varchar(50),@EnterLimit money
		--set @ClientCode='M78244'
		--set  @EnterLimit='123.22'
		
		declare @SBCode varchar(50)
		select @SBCode =sub_broker from risk.dbo.Client_details where Cl_code=@ClientCode
		--select @SBCode  


		insert into tbl_SBLimitAllocation_testPladge(SBCode,ClientCode,EnterLimit,LimitResponse,LimitResponseMesaage,UpdatedBy,UpdatedDT)
		select @SBCode,@ClientCode,@EnterLimit,'1','Pledge_Module','Pledge_Module',GETDATE()
		
		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LE_OmneUpdateLimit
-- --------------------------------------------------
--EXEC Usp_LE_OmneUpdateLimit 'P94526',15  
CREATE Proc Usp_LE_OmneUpdateLimit  
(  
@ClientCode VARCHAR(100),  
@AdditionalLimit VARCHAR(10)  
)  
As  
Begin   
  
 Insert into [172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates(Broker,AccountId,Exchange,Segment,Symbol,Product,UpdateFor,Amount,Validated,ValidationText,DtTime,SourceUser,BORefStr)  
 select '' as Broker,@ClientCode as AccountId ,'' as Exchange,'' as Segment,'' as Symbol,'' as Product,'NOTIONAL' as UpdateFor,  
 @AdditionalLimit as Amount,'' as Validated,'' as ValidationText,GETDATE(),@ClientCode as SourceUser,'' as BORefStr  
 
 
 --select Validated from  [172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates where AccountId=@ClientCode and Amount=@AdditionalLimit
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LEOmnesysMIS
-- --------------------------------------------------

--exec Usp_LEOmnesysMIS
CREATE Proc [dbo].[Usp_LEOmnesysMIS]
As 
BEGIN 
		select a.AccountId,b.AccountName,a.Amount,a.Validated,a.DtTime  from [172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates  
		a inner join [172.31.15.250].[Uploader-db-NEW].dbo.investorclient b
		on a.AccountId=b.AccountId collate SQL_Latin1_General_CP1_CI_AS
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LEOmnesysMIS_17072021
-- --------------------------------------------------

--exec Usp_LEOmnesysMIS
Create Proc [dbo].[Usp_LEOmnesysMIS_17072021]
As 
BEGIN 
		select a.AccountId,b.AccountName,a.Amount,a.Validated,a.DtTime  from [172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates  a inner join [172.31.15.250].[Uploader-db].dbo.investorclient b
		on a.AccountId=b.AccountId
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LEOmnesysMIS_NXT
-- --------------------------------------------------
CREATE Proc [dbo].[Usp_LEOmnesysMIS_NXT]
(
	@SubBroker varchar(100),
	@PartyCode varchar(100)=null
)
As 
BEGIN 

if isnull(@PartyCode ,'')=''
begin

		select 
			a.AccountId ClientCode
			,b.AccountName ClientName
			,a.Amount EnterLimit
			,'' Segment 
			,a.DtTime CreatedDT 
			,a.Validated LimitUpdation
		from 
		[172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates  a
		 inner join [172.31.15.250].[Uploader-db-NEW].dbo.investorclient b
		on a.AccountId=b.AccountId collate SQL_Latin1_General_CP1_CI_AS
		inner join risk.dbo.client_details SB on SB.party_code collate SQL_Latin1_General_CP1_CI_AS=b.AccountId
		where 
		--Party_Code= @PartyCode
		--and 
		sub_broker=@SubBroker
END
ELSE 
BEGIN

		select 
			a.AccountId ClientCode
			,b.AccountName ClientName
			,a.Amount EnterLimit
			,'' Segment 
			,a.DtTime CreatedDT 
			,a.Validated LimitUpdation
		from 
		[172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates  a
		 inner join [172.31.15.250].[Uploader-db-NEW].dbo.investorclient b
		on a.AccountId=b.AccountId collate SQL_Latin1_General_CP1_CI_AS
		inner join risk.dbo.client_details SB on SB.party_code collate SQL_Latin1_General_CP1_CI_AS=b.AccountId
		where Party_Code= @PartyCode
		and sub_broker=@SubBroker

END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LEOmnesysMIS_NXT_17072021
-- --------------------------------------------------
Create Proc [dbo].[Usp_LEOmnesysMIS_NXT_17072021]
(
	@SubBroker varchar(100),
	@PartyCode varchar(100)=null
)
As 
BEGIN 

if isnull(@PartyCode ,'')=''
begin

		select 
			a.AccountId ClientCode
			,b.AccountName ClientName
			,a.Amount EnterLimit
			,'' Segment 
			,a.DtTime CreatedDT 
			,a.Validated LimitUpdation
		from 
		[172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates  a
		 inner join [172.31.15.250].[Uploader-db].dbo.investorclient b
		on a.AccountId=b.AccountId
		inner join risk.dbo.client_details SB on SB.party_code collate SQL_Latin1_General_CP1_CI_AS=b.AccountId
		where 
		--Party_Code= @PartyCode
		--and 
		sub_broker=@SubBroker
END
ELSE 
BEGIN

		select 
			a.AccountId ClientCode
			,b.AccountName ClientName
			,a.Amount EnterLimit
			,'' Segment 
			,a.DtTime CreatedDT 
			,a.Validated LimitUpdation
		from 
		[172.31.15.250].[Sri_DB].dbo.SchedRMSIncremUpdates  a
		 inner join [172.31.15.250].[Uploader-db].dbo.investorclient b
		on a.AccountId=b.AccountId
		inner join risk.dbo.client_details SB on SB.party_code collate SQL_Latin1_General_CP1_CI_AS=b.AccountId
		where Party_Code= @PartyCode
		and sub_broker=@SubBroker

END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data
-- --------------------------------------------------

/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','PAWO','','','','0.0','','','','PAWO1001','','','143926.95','','All Segments' 

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
CREATE  Procedure [dbo].[Usp_Limit_Data]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  


-- return 0


print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [CSOKYC-6].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [CSOKYC-6].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [CSOKYC-6].general.dbo.client_Details a with (nolock) join       
		[CSOKYC-6].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [CSOKYC-6].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [CSOKYC-6].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE and LimitResponse='1') 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.108].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [CSOKYC-6].general.dbo.tbl_Client_purerisk_afterDPADj    with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk_afterDpAdj from [CSOKYC-6].general.dbo.tbl_Client_purerisk_afterDPADj  with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin

	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits)',GETDATE()
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	 

End
if(@CommPureRisk<-1000)
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Client is in Commodities Pure Risk(Please call RMS team for taking limits)',GETDATE()
	
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	
End
if(@Intraday<>'')
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)',GETDATE()
	
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
 End
 else
 Begin
	
 	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [CSOKYC-6].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [CSOKYC-6].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'CLient is in Pure Risk(Please call RMS team for taking limits)-- AllSegments',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
		 return
	End
	else if(@Intraday<>'')
	Begin
		
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)-- Intraday1',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
		
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts',GETDATE()
		 
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	
	  
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts2',GETDATE()
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [CSOKYC-6].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [CSOKYC-6].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits) --Commodity1',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
	End
	else if(@Intraday<>'')
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits) --Commodity2',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg 
		 
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity3',GETDATE() 
	     
	     select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity4',GETDATE() 
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	 
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select purerisk_afterDpAdj from [CSOKYC-6].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [CSOKYC-6].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits) --Commodity5',GETDATE() 
	     
	     select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity6',GETDATE() 
	     
	     select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity7',GETDATE() 
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [CSOKYC-6].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [CSOKYC-6].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [CSOKYC-6].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode and LimitResponse='1')

if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
				end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven
				from tbl_SBLimitAllocation with(nolock) where  SBCode=@SBCode and  LimitResponse='1'     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and LimitResponse='1') 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				
				declare @OTHERDEBIT money 
				set  @OTHERDEBIT =  isnull((select isnull (OTHERDEBIT,0) from [CSOKYC-6].general.dbo.tbl_FINALOTHERDEBIT where Client=@CLientCode),0)
				
				declare @newClientLimit money              
				select @newClientLimit= isnull (sum(Clientlimit),0) from tbl_InstClinetLimit_newAPI where party_code=@CLientCode  --and  LimitResponse='1'  
				
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
					end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven 
					from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and  LimitResponse='1'
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0)+@newClientLimit+@OTHERDEBIT as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
					end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven
					from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and  LimitResponse='1' and
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
	
		
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client --CheckClientLimit2',GETDATE() 
	 
	 	select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_01Aug2016
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data_01Aug2016 'CheckClient','NNSG','','','','0.0','','','','r85684',''    
*/    
CReate Procedure [dbo].[Usp_Limit_Data_01Aug2016]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50)
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    
select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin
insert into tbl_SBLimitAllocation    
(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit
 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
 Begin 
 select @SBCredit as ErrMsg
 End
 else
 Begin
 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
 End
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')
if(@PureRisk<-1000)
Begin
	 select 'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
	 Begin
	 select pcode,pname,case when bbb=4 then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 


if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,'' as ErrMsg 
End

End 

if(@Process='TotalLimit')
Begin
select isnull(sum(EnterLimit),0) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_01Nov2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    
*/    
create Procedure [dbo].[Usp_Limit_Data_01Nov2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin

				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
								
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_01Nov2017BackUp
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    
*/    
Create Procedure [dbo].[Usp_Limit_Data_01Nov2017BackUp]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
		
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_02May2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'TotalLimit','RRLV','','','','0.0','','','','N56488','','','','','Equity+FNO+Curr'    
*/    
Create Procedure [dbo].[Usp_Limit_Data_02May2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
set @TotalLimit=(select isnull(sum(EnterLimit),0) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
if (isnull(@TotalLimit,0)>isnull(@SBCredit,0))
	BEGIN				 
	select top 1  0 as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
    Clientcode=@CLientCode and Segment=@Segment
	END
	ELSE
	BEGIN
	select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
    Clientcode=@CLientCode and Segment=@Segment
	END

End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_06Jun2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data_06Jun2017 'TotalLimit','RADD','','','','0.0','','','','RADD1001','','','','','Equity+FNO+Curr'    
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_06Jun2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
	
if(@EnterLimit<0)		
		Begin
		
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
				Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End

End

if(@Process='CheckClientLimit')
Begin
	if(@EnterLimit<0)
   Begin

		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
			End
			else
			Begin
				select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
			End
	End
	else
	Begin
	Select 0 as ClientLimitGiven,'' as ErrMsg
	End
End

if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End


End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_07Mar2018
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_07Mar2018]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_07Nov2016
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'GetPercentageMul','RRBT','','','','0.0','','','','r85684',''    
*/    
Create Procedure [dbo].[Usp_Limit_Data_07Nov2016]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    
select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin
insert into tbl_SBLimitAllocation    
(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit
 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
 Begin 
 select @SBCredit as ErrMsg
 End
 else
 Begin
 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
 End
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and sub_broker=@SBCode)
End
Else if(@Segment='Commodity')
Begin
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and sub_broker=@SBCode)
End
else
Begin
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and sub_broker=@SBCode)
End
select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select Commodities from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)

select isnull(sum(EnterLimit),0) as TotalLimit,@PureRisk as PureRisk,@CommPureRisk as Commodities from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_08112019
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create Procedure [dbo].[Usp_Limit_Data_08112019]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_09Nov2016
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'GetClientLedger','MMMY','','','','0.0','','','','S161838','','','','','Equity+FNO+Curr'    
*/    
Create Procedure [dbo].[Usp_Limit_Data_09Nov2016]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    
select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin
insert into tbl_SBLimitAllocation    
(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit
 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
 Begin 
 select @SBCredit as ErrMsg
 End
 else
 Begin
 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
 End
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and sub_broker=@SBCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
		return
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and sub_broker=@SBCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
		return
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and sub_broker=@SBCode)
	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	End
End


if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select Commodities from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)

select isnull(sum(EnterLimit),0) as TotalLimit,@PureRisk as PureRisk,@CommPureRisk as Commodities from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_10Oct2016
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'GetPercentageMul','RRBT','','','','0.0','','','','r85684',''    
*/    
Create Procedure [dbo].[Usp_Limit_Data_10Oct2016]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50)
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    
select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin
insert into tbl_SBLimitAllocation    
(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit
 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
 Begin 
 select @SBCredit as ErrMsg
 End
 else
 Begin
 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
 End
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')
if(@PureRisk<-1000)
Begin
	 select 'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 


if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
select isnull(sum(EnterLimit),0) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_13052019
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_13052019]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_14Aug2020
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','PAWO','','','','0.0','','','','PAWO1001','','','143926.95','','All Segments' 

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_14Aug2020]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE and LimitResponse='1') 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj    with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj  with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin

	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits)',GETDATE()
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	 

End
if(@CommPureRisk<-1000)
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Client is in Commodities Pure Risk(Please call RMS team for taking limits)',GETDATE()
	
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	
End
if(@Intraday<>'')
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)',GETDATE()
	
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
 End
 else
 Begin
	
 	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'CLient is in Pure Risk(Please call RMS team for taking limits)-- AllSegments',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
		 return
	End
	else if(@Intraday<>'')
	Begin
		
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)-- Intraday1',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
		
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts',GETDATE()
		 
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	
	  
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts2',GETDATE()
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits) --Commodity1',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
	End
	else if(@Intraday<>'')
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits) --Commodity2',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg 
		 
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity3',GETDATE() 
	     
	     select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity4',GETDATE() 
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	 
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits) --Commodity5',GETDATE() 
	     
	     select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity6',GETDATE() 
	     
	     select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity7',GETDATE() 
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode and LimitResponse='1')

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
				end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven
				from tbl_SBLimitAllocation with(nolock) where  SBCode=@SBCode and  LimitResponse='1'     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and LimitResponse='1') 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				
				declare @OTHERDEBIT money 
				select  @OTHERDEBIT =  isnull (OTHERDEBIT,0) from [196.1.115.182].general.dbo.tbl_FINALOTHERDEBIT where Client=@CLientCode 
				
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
					end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven 
					from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and  LimitResponse='1'
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0)+@OTHERDEBIT as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
					end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven
					from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and  LimitResponse='1' and
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
	
		
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client --CheckClientLimit2',GETDATE() 
	 
	 	select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_16AUg2016
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'GetPercentageMul','ET','','','','0.0','','','','r85684',''    
*/    
CReate Procedure [dbo].[Usp_Limit_Data_16AUg2016]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50)
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    
select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin
insert into tbl_SBLimitAllocation    
(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit
 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
 Begin 
 select @SBCredit as ErrMsg
 End
 else
 Begin
 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
 End
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')
if(@PureRisk<-1000)
Begin
	 select 'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
	 Begin
	 select pcode,pname,case when bbb=4 then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 


if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
select isnull(sum(EnterLimit),0) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_17Aug2020
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','PAWO','','','','0.0','','','','PAWO1001','','','143926.95','','All Segments' 

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
create  Procedure [dbo].[Usp_Limit_Data_17Aug2020]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE and LimitResponse='1') 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj    with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj  with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin

	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits)',GETDATE()
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	 

End
if(@CommPureRisk<-1000)
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Client is in Commodities Pure Risk(Please call RMS team for taking limits)',GETDATE()
	
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	
End
if(@Intraday<>'')
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)',GETDATE()
	
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
 End
 else
 Begin
	
 	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'CLient is in Pure Risk(Please call RMS team for taking limits)-- AllSegments',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
		 return
	End
	else if(@Intraday<>'')
	Begin
		
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)-- Intraday1',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
		
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts',GETDATE()
		 
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	
	  
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts2',GETDATE()
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits) --Commodity1',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
	End
	else if(@Intraday<>'')
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits) --Commodity2',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg 
		 
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity3',GETDATE() 
	     
	     select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity4',GETDATE() 
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	 
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits) --Commodity5',GETDATE() 
	     
	     select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity6',GETDATE() 
	     
	     select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity7',GETDATE() 
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode and LimitResponse='1')

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
				end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven
				from tbl_SBLimitAllocation with(nolock) where  SBCode=@SBCode and  LimitResponse='1'     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and LimitResponse='1') 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				
				declare @OTHERDEBIT money 
				select  @OTHERDEBIT =  isnull (OTHERDEBIT,0) from [196.1.115.182].general.dbo.tbl_FINALOTHERDEBIT where Client=@CLientCode
				
				declare @newClientLimit money              
				select @newClientLimit= isnull (sum(Clientlimit),0) from tbl_InstClinetLimit_newAPI where party_code=@CLientCode  --and  LimitResponse='1'  
				
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
					end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven 
					from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and  LimitResponse='1'
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0)+@newClientLimit+@OTHERDEBIT as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0'
					end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven
					from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and  LimitResponse='1' and
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
	
		
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client --CheckClientLimit2',GETDATE() 
	 
	 	select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_18May2020
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','PAWO','','','','0.0','','','','PAWO1001','','','143926.95','','All Segments' 

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_18May2020]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE and LimitResponse='1') 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin

	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits)',GETDATE()
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	 

End
if(@CommPureRisk<-1000)
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Client is in Commodities Pure Risk(Please call RMS team for taking limits)',GETDATE()
	
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	
End
if(@Intraday<>'')
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)',GETDATE()
	
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
 End
 else
 Begin
	
 	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'CLient is in Pure Risk(Please call RMS team for taking limits)-- AllSegments',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
		 return
	End
	else if(@Intraday<>'')
	Begin
		
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)-- Intraday1',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
		
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts',GETDATE()
		 
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	
	  
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts2',GETDATE()
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits) --Commodity1',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
	End
	else if(@Intraday<>'')
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits) --Commodity2',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg 
		 
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity3',GETDATE() 
	     
	     select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity4',GETDATE() 
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	 
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits) --Commodity5',GETDATE() 
	     
	     select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity6',GETDATE() 
	     
	     select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity7',GETDATE() 
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode and LimitResponse='1')

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where  SBCode=@SBCode and  LimitResponse='1'     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and LimitResponse='1') 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
	
		
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client --CheckClientLimit2',GETDATE() 
	 
	 	select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_20march2020
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_20march2020]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_20May2020
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','PAWO','','','','0.0','','','','PAWO1001','','','143926.95','','All Segments' 

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_20May2020]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE and LimitResponse='1') 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj    with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj  with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin

	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits)',GETDATE()
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	 

End
if(@CommPureRisk<-1000)
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Client is in Commodities Pure Risk(Please call RMS team for taking limits)',GETDATE()
	
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	
End
if(@Intraday<>'')
Begin
	
	
	insert into tbl_LimitEnchValidationLog
	select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)',GETDATE()
	
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
 End
 else
 Begin
	
 	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- CheckClient',GETDATE()
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'CLient is in Pure Risk(Please call RMS team for taking limits)-- AllSegments',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
		 return
	End
	else if(@Intraday<>'')
	Begin
		
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits)-- Intraday1',GETDATE()
		 
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
		
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
		 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts',GETDATE()
		 
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	
	  
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping)-- UnmappedAllSegemnts2',GETDATE()
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits) --Commodity1',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		
	End
	else if(@Intraday<>'')
	Begin
		
		
		insert into tbl_LimitEnchValidationLog
	    select @ClientCode,@SBCode,'Intraday Code(Please call RMS team for taking limits) --Commodity2',GETDATE()
	    
	    select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg 
		 
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity3',GETDATE() 
	     
	     select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity4',GETDATE() 
	 
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
	 
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Client is in Pure Risk(Please call RMS team for taking limits) --Commodity5',GETDATE() 
	     
	     select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 
		 
		 insert into tbl_LimitEnchValidationLog
	     select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity6',GETDATE() 
	     
	     select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 
		 End
	 End
	 else
	 Begin
	 
	 
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Unmapped Client(Please Call RMS Team for Mapping) --Commodity7',GETDATE() 
	 
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select purerisk_afterDpAdj from [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode and LimitResponse='1')

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where  SBCode=@SBCode and  LimitResponse='1'     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and LimitResponse='1') 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
	
		
	 insert into tbl_LimitEnchValidationLog
	 select @ClientCode,@SBCode,'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client --CheckClientLimit2',GETDATE() 
	 
	 	select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_25Apr2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data_25Apr2017 'TotalLimit','POJ','','','','0.0','','','','D57003','','','','','Equity+FNO+Curr'    
*/    
Create Procedure [dbo].[Usp_Limit_Data_25Apr2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_26Apr2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'GetClientLedger','aago','','','','0.0','','','','Y4248','','','','','nbfc'    
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_26Apr2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_27Apr2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'TotalLimit','RRLV','','','','0.0','','','','N56488','','','','','Equity+FNO+Curr'    
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_27Apr2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
set @TotalLimit=(select isnull(sum(EnterLimit),0) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
if (isnull(@TotalLimit,0)>isnull(@SBCredit,0))
	BEGIN				 
	select top 1  0 as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
    Clientcode=@CLientCode and Segment=@Segment
	END
	ELSE
	BEGIN
	select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
    Clientcode=@CLientCode and Segment=@Segment
	END

End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_27JUN2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'TotalLimit','RRLV','','','','0.0','','','','N56488','','','','','Equity+FNO+Curr'    
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_27JUN2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
	BEGIN				 
	select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
	END
	ELSE
	BEGIN
	select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
    Clientcode=@CLientCode and Segment=@Segment
	END

End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_28112019
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create Procedure [dbo].[Usp_Limit_Data_28112019]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_28112019_2
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create Procedure [dbo].[Usp_Limit_Data_28112019_2]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_28122017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_28122017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_28Dec2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create Procedure [dbo].[Usp_Limit_Data_28Dec2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and  servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_28Feb2018
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_28Feb2018]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_29Jun2017
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data 'GetLimit','BBSY','','','','0.0','','','','','','','-100','','Equity+FNO+Curr'    
*/    
Create Procedure [dbo].[Usp_Limit_Data_29Jun2017]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
	BEGIN				 
	select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
	END
	ELSE
	BEGIN
	select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
    Clientcode=@CLientCode and Segment=@Segment
	END

End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_31March2020
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'TotalLimit','abad','','','','0.0','','','','N56212','','','-75000.00','','Equity+FNO+Curr'    

Usp_Limit_Data 'CheckClient','CCIE','','','','0.0','','','','31595','','','','',''


*/    
Create  Procedure [dbo].[Usp_Limit_Data_31March2020]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'All Segments' as Segment,'All Segments' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

----change on 13052019
	if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
		Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
		End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0)=0 then round(@SBCredit,0) 
			else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode and LimitResponse<>'0'),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  

----///Changes By Prashant Patade on 08 Nov 2019  from Hirak and Tushar -----------//////
	--if exists (select NISE_PARTY_CODE,*  from  [172.31.16.94].DMAT.dbo.TBL_CLIENT_MASTER T    
 --     where ISNULL(POA_VER,'') <>'2' and STATUS='ACTIVE' and NISE_PARTY_CODE=@ClientCode)
 --     begin 
	--	select 'Client has not activated POA' as ErrMsg
	--	return
 --     end

--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)

set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='All Segments')
Begin
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF','MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
--set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
--set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli   with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
			
				select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     										
				
				/*
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
				*/
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='All Segments' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_Back
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data_Back 'GetLimit','HHOH','','','','0.0','','','','S161838','','','','','Equity+FNO+Curr'    
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_Back]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode) 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
	if(@LimitGiven>0)
	Begin
		insert into tbl_SBLimitAllocation    
		(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
		values    
		(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select  top 1 EnterLimit   from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select top 1 EnterLimit  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select Commodities from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select top 1 EnterLimit as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
select isnull(sum(EnterLimit),0) as TotalLimit,@PureRisk as PureRisk,@CommPureRisk as Commodities,@LimitGiven as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_bak
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data_bak 'GetPercentageMul','PJMA','','','','0.0','','','',''    
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_bak]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50)
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    
select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin
insert into tbl_SBLimitAllocation    
(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='') then 'In-Process' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit
 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
 Begin 
 select @SBCredit as ErrMsg
 End
 else
 Begin
 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
 End
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.tbl_rms_collection  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'')<>'')
if(@PureRisk<0)
Begin
	 select 'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode)
	 Begin
	 select pcode,pname,case when bbb=4 then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and c.sub_broker=@SBCode
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 


if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
 print 'SBCredit'
 print @SBCredit

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End 

if(@Process='TotalLimit')
Begin
select isnull(sum(EnterLimit),0) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and Clientcode=@CLientCode and Segment=@Segment
End

End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_new_V1
-- --------------------------------------------------

/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'GetClientLedger','ET','','','','0.0','','','','px45','','','1','',''    
    
Usp_Limit_Data 'GetPercentageMul','JJRT','','','','0.0','','','','','','','','',''  

Usp_Limit_Data 'CheckClient','ET','','','','0.0','','','','A77588','','','','','' 

exec Usp_Limit_Data_new_V1 @Process='GetClientLedger',@SBCode='BLF',@ClientCode='A44984',@Segment='All Segments'
  
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_new_V1]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@newsblimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ScriptCode varchar(50)='',
@TypeOfOrder varchar(50)='',
@SBCrAdditional varchar(50)='',
@PaymentHistory varchar(50)='',
--@LimitAvailed varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@SBTotalLimit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [CSOKYC-6].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [CSOKYC-6].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [CSOKYC-6].general.dbo.client_Details a with (nolock) join       
		[CSOKYC-6].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [CSOKYC-6].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [CSOKYC-6].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else 
  
 --Begin  
 --select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 --end
 select Segment,SegmentVal from tbl_SegmentMaster  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

--if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
--	Begin
--	insert into tbl_SBLimitAllocation    
--	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT,ScriptCode,TypeOfOrder,SBCrAdditional,PaymentHistory)    
--	values    
--	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate(),@ScriptCode,@TypeOfOrder ,@SBCrAdditional ,@PaymentHistory)    
--	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			
					--if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
					--begin 
						--print 'Hi'	
						Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
						--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					--END
					--ELSE
					--BEGIN
						--print 'BYE'	
						--Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
					---END	
					 print 'SBCredit'
					 print @SBCredit
					 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
					 Begin 
					 select @SBCredit as ErrMsg
					 End
					 else
					 Begin
					 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
					 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

					-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
					 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
	
	set @PureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @CommPureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
	set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code =@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

		if(@PureRisk<-1000)
		Begin
			 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End
		if(@CommPureRisk<-1000)
		Begin
			select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End

--///Change by prashant patade on 28012019--
--if(@Intraday<>'')
--Begin
	--select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--select 'Intraday Code' as ErrMsg
--End
------------END//-------------------
-- if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
-- Begin
-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
--	 Begin
--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
--	 End
--	 Else
--	 Begin
--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
--	 End
-- End
-- else
-- Begin
-- select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
-- End
--End 
if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 
	 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else

 Begin
 
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
END


if(@Process='GetClientLedger')
Begin
print 'test'
if(@Segment='All Segments')
Begin
set @PureRisk=(select pure_risk from [CSOKYC-6].general.dbo.tbl_rms_collection_cli  with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [CSOKYC-6].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalEqMarginLimit) as total  from [CSOKYC-6].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')



print 'test 2'

---///Added By Prashant on 6 nov 2017//---
		

--Exec Usp_PaymentHistoryFlag @ClientCode,@Segment,@PaymentHistory out
--print @ClientCode
--Print @Segment
--print @PaymentHistory


--exec [CSOKYC-6].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode
--declare @LimitAvailed money
--exec [CSOKYC-6].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode,@LimitAvailed out
----print @LimitAvailed

exec [CSOKYC-6].General.dbo.Usp_ALGgetLimitAvailed  @SBCode,@ClientCode


if not  EXISTS (select * from tbl_LimitAvailedLog where ClientCode=@ClientCode)  
 BEGIN   
 print 'Availed'

	declare @LimitAvailed money
	insert into tbl_TempLimitAvailed
	exec [CSOKYC-6].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode  
	print @LimitAvailed

	if(@Intraday='Both')
	begin 
		if EXISTS (select * from tbl_TempLimitAvailed where (LimitAvailed <='25000') and PARTY_CODE=@ClientCode)
		begin 
			update tbl_TempLimitAvailed
			set LimitAvailed='25000'
			where PARTY_CODE=@ClientCode and SB=@SBCode
		
		END
	END

	--//change by prashant patade on 18042019
	--if(@Intraday='Both')
	begin 
	if EXISTS (select * from tbl_TempLimitAvailed where (LimitAvailed ='0.00' ) and PARTY_CODE=@ClientCode)
	begin 
		update tbl_TempLimitAvailed
		set LimitAvailed='25000'
		where PARTY_CODE=@ClientCode and SB=@SBCode
		
	END
	END
	
END


--if(@PaymentHistory='Green' or @PaymentHistory='Yellow' or @PaymentHistory='Red' )
--			 Begin 
--			 select @PaymentHistory as ErrMsg
--			 End

---///End //----- 
print @PureRisk
	if(@PureRisk<convert (decimal,-1000))
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--else if(@Intraday='Both')
	--Begin
	--		--select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger ,'' as ErrMsg
	--	END
		
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,@PaymentHistory as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	--	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	 
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
 
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [CSOKYC-6].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalCommMarginLimit) as total  from [CSOKYC-6].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	--else if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66' )
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	-- select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mappingbbbbb)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [CSOKYC-6].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [CSOKYC-6].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )--and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Not an Intraday Code 6' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,'' as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	 --else
	 --Begin
	 --select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 --End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 print 'SBCredit'
			 print @SBCredit
			 print @SBTotalLimit
			 --if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				--begin 
				--	--print 'Hi'	
				--	Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--	--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--END
				--ELSE
				--BEGIN
				--	--print 'BYE'	
				--	Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				--END	
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [CSOKYC-6].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)


--insert into tbl_LimitAvailedLog
--select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed


if exists  (select * from tbl_LimitAvailedLog where BalLimit ='0.00' and ClientCode=@ClientCode)
BEGIN
select 'BYE' as ErrMsg
END
ELSE
BEGIN
if exists (select * from LimitEnhancement.dbo.tbl_LimitAvailedLog where ClientCode=@ClientCode)
	begin 
		
		insert into LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select  top 1  SBtag,BalLimit,(BalLimit-@EnterLimit),Clientcode from  LimitEnhancement.dbo.tbl_LimitAvailedLog  where ClientCode=@ClientCode   order by Update_date desc
		
		
	END
	ELSE
	BEGIN
	
		insert into LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed where PARTY_CODE =@ClientCode
		
	END	
END


if exists (select * from [CSOKYC-6].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode , @SBCredit out 
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 print 'SBCredit'
			 print @SBCredit
			 --if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				--begin 
				--	--print 'Hi'	
				--	Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--	--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--END
				--ELSE
				--BEGIN
				--	--print 'BYE'	
				--	Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				--END	
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
		
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End


---///Added by prashant on 8 Nov 2011//----
--if(@Process='Usp_NewSBLimit')
--BEGIN
	
--Exec Usp_NewSBLimit @PaymentHistory,@ScriptCode,@SBCode,@TotalLimitGiven,@TotallimitAvailable,@ClientCredit,@newsblimit out
--print @PaymentHistory
--Print @Segment
--print @newsblimit
--END

END
    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_new_V1_12jul2019
-- --------------------------------------------------

/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'GetClientLedger','ET','','','','0.0','','','','px45','','','1','',''    
    
Usp_Limit_Data 'GetPercentageMul','JJRT','','','','0.0','','','','','','','','',''  

Usp_Limit_Data 'CheckClient','ET','','','','0.0','','','','A77588','','','','','' 

exec Usp_Limit_Data_new_V1 @Process='GetClientLedger',@SBCode='BLF',@ClientCode='A44984',@Segment='All Segments'
  
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_new_V1_12jul2019]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@newsblimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ScriptCode varchar(50)='',
@TypeOfOrder varchar(50)='',
@SBCrAdditional varchar(50)='',
@PaymentHistory varchar(50)='',
--@LimitAvailed varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@SBTotalLimit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else 
  
 --Begin  
 --select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 --end
 select Segment,SegmentVal from tbl_SegmentMaster  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

--if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
--	Begin
--	insert into tbl_SBLimitAllocation    
--	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT,ScriptCode,TypeOfOrder,SBCrAdditional,PaymentHistory)    
--	values    
--	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate(),@ScriptCode,@TypeOfOrder ,@SBCrAdditional ,@PaymentHistory)    
--	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			
					--if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
					--begin 
						--print 'Hi'	
						Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
						--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					--END
					--ELSE
					--BEGIN
						--print 'BYE'	
						--Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
					---END	
					 print 'SBCredit'
					 print @SBCredit
					 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
					 Begin 
					 select @SBCredit as ErrMsg
					 End
					 else
					 Begin
					 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
					 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

					-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
					 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
	
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code =@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

		if(@PureRisk<-1000)
		Begin
			 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End
		if(@CommPureRisk<-1000)
		Begin
			select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End

--///Change by prashant patade on 28012019--
--if(@Intraday<>'')
--Begin
	--select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--select 'Intraday Code' as ErrMsg
--End
------------END//-------------------
-- if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
-- Begin
-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
--	 Begin
--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
--	 End
--	 Else
--	 Begin
--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
--	 End
-- End
-- else
-- Begin
-- select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
-- End
--End 
if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 
	 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else

 Begin
 
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
END


if(@Process='GetClientLedger')
Begin
print 'test'
if(@Segment='All Segments')
Begin
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli  with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalEqMarginLimit) as total  from [196.1.115.182].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')



print 'test 2'

---///Added By Prashant on 6 nov 2017//---
		

--Exec Usp_PaymentHistoryFlag @ClientCode,@Segment,@PaymentHistory out
--print @ClientCode
--Print @Segment
--print @PaymentHistory


--exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode
--declare @LimitAvailed money
--exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode,@LimitAvailed out
----print @LimitAvailed

exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed  @SBCode,@ClientCode


if not  EXISTS (select * from tbl_LimitAvailedLog where ClientCode=@ClientCode)  
 BEGIN   
 print 'Availed'

	declare @LimitAvailed money
	insert into tbl_TempLimitAvailed
	exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode  
	print @LimitAvailed

	if(@Intraday='Both')
	begin 
		if EXISTS (select * from tbl_TempLimitAvailed where (LimitAvailed <='25000') and PARTY_CODE=@ClientCode)
		begin 
			update tbl_TempLimitAvailed
			set LimitAvailed='25000'
			where PARTY_CODE=@ClientCode and SB=@SBCode
		
		END
	END

	--//change by prashant patade on 18042019
	--if(@Intraday='Both')
	begin 
	if EXISTS (select * from tbl_TempLimitAvailed where (LimitAvailed ='0.00' ) and PARTY_CODE=@ClientCode)
	begin 
		update tbl_TempLimitAvailed
		set LimitAvailed='25000'
		where PARTY_CODE=@ClientCode and SB=@SBCode
		
	END
	END
	
END


--if(@PaymentHistory='Green' or @PaymentHistory='Yellow' or @PaymentHistory='Red' )
--			 Begin 
--			 select @PaymentHistory as ErrMsg
--			 End

---///End //----- 
print @PureRisk
	if(@PureRisk<convert (decimal,-1000))
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--else if(@Intraday='Both')
	--Begin
	--		--select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger ,'' as ErrMsg
	--	END
		
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,@PaymentHistory as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	--	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	 
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
 
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalCommMarginLimit) as total  from [196.1.115.182].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	--else if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66' )
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	-- select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mappingbbbbb)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )--and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Not an Intraday Code 6' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,'' as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	 --else
	 --Begin
	 --select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 --End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 print 'SBCredit'
			 print @SBCredit
			 print @SBTotalLimit
			 --if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				--begin 
				--	--print 'Hi'	
				--	Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--	--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--END
				--ELSE
				--BEGIN
				--	--print 'BYE'	
				--	Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				--END	
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)


--insert into tbl_LimitAvailedLog
--select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed


if exists  (select * from tbl_LimitAvailedLog where BalLimit ='0.00' and ClientCode=@ClientCode)
BEGIN
select 'BYE' as ErrMsg
END
ELSE
BEGIN
if exists (select * from [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog where ClientCode=@ClientCode)
	begin 
		
		insert into [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select  top 1  SBtag,BalLimit,(BalLimit-@EnterLimit),Clientcode from [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog  where ClientCode=@ClientCode   order by Update_date desc
		
		
	END
	ELSE
	BEGIN
	
		insert into [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed where PARTY_CODE =@ClientCode
		
	END	
END


if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode , @SBCredit out 
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 print 'SBCredit'
			 print @SBCredit
			 --if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				--begin 
				--	--print 'Hi'	
				--	Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--	--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				--END
				--ELSE
				--BEGIN
				--	--print 'BYE'	
				--	Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				--END	
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
		
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End


---///Added by prashant on 8 Nov 2011//----
--if(@Process='Usp_NewSBLimit')
--BEGIN
	
--Exec Usp_NewSBLimit @PaymentHistory,@ScriptCode,@SBCode,@TotalLimitGiven,@TotallimitAvailable,@ClientCredit,@newsblimit out
--print @PaymentHistory
--Print @Segment
--print @newsblimit
--END

END
    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_new_V1_13052019
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'GetClientLedger','ET','','','','0.0','','','','px45','','','1','',''    
    
Usp_Limit_Data 'GetPercentageMul','JJRT','','','','0.0','','','','','','','','',''  

Usp_Limit_Data 'CheckClient','ET','','','','0.0','','','','A77588','','','','',''   
  
*/    
Create Procedure [dbo].[Usp_Limit_Data_new_V1_13052019]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@newsblimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ScriptCode varchar(50)='',
@TypeOfOrder varchar(50)='',
@SBCrAdditional varchar(50)='',
@PaymentHistory varchar(50)='',
--@LimitAvailed varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@SBTotalLimit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else 
  
 --Begin  
 --select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 --end
 select Segment,SegmentVal from tbl_SegmentMaster  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT,ScriptCode,TypeOfOrder,SBCrAdditional,PaymentHistory)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate(),@ScriptCode,@TypeOfOrder ,@SBCrAdditional ,@PaymentHistory)    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			
			 if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
					begin 
						print 'Hi'	
						Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
						--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					END
					ELSE
					BEGIN
						print 'BYE'	
						Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
					END	
					 print 'SBCredit'
					 print @SBCredit
					 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
					 Begin 
					 select @SBCredit as ErrMsg
					 End
					 else
					 Begin
					 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
					 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

					-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
					 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
	
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code =@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

		if(@PureRisk<-1000)
		Begin
			 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End
		if(@CommPureRisk<-1000)
		Begin
			select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End

--///Change by prashant patade on 28012019--
--if(@Intraday<>'')
--Begin
	--select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--select 'Intraday Code' as ErrMsg
--End
------------END//-------------------
-- if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
-- Begin
-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
--	 Begin
--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
--	 End
--	 Else
--	 Begin
--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
--	 End
-- End
-- else
-- Begin
-- select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
-- End
--End 
if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 
	 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else

 Begin
 
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
END


if(@Process='GetClientLedger')
Begin
if(@Segment='Cash' or @Segment='Future & Option Sell' or  @Segment='Option Buy')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalEqMarginLimit) as total  from [196.1.115.182].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')





---///Added By Prashant on 6 nov 2017//---
		

--Exec Usp_PaymentHistoryFlag @ClientCode,@Segment,@PaymentHistory out
--print @ClientCode
--Print @Segment
--print @PaymentHistory


--exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode
--declare @LimitAvailed money
--exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode,@LimitAvailed out
----print @LimitAvailed

exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed  @SBCode,@ClientCode


if not  EXISTS (select * from [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog where ClientCode=@ClientCode)  
 BEGIN   

	declare @LimitAvailed money
	insert into tbl_TempLimitAvailed
	exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode  
	print @LimitAvailed
	
END


--if(@PaymentHistory='Green' or @PaymentHistory='Yellow' or @PaymentHistory='Red' )
--			 Begin 
--			 select @PaymentHistory as ErrMsg
--			 End

---///End //----- 
print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--else if(@Intraday='Both')
	--Begin
	--		--select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger ,'' as ErrMsg
	--	END
		
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,@PaymentHistory as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	--	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	 
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
 
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalCommMarginLimit) as total  from [196.1.115.182].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	--else if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66' )
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	-- select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mappingbbbbb)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )--and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Not an Intraday Code 6' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,'' as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	 --else
	 --Begin
	 --select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 --End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 --Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 --print 'SBCredit'
			 --print @SBCredit
			 --print @SBTotalLimit
			 if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				begin 
					print 'Hi'	
					Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				END
				ELSE
				BEGIN
					print 'BYE'	
					Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				END	
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)


--insert into tbl_LimitAvailedLog
--select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed



if exists (select * from [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog where ClientCode=@ClientCode)
	begin 
		
		insert into [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select  top 1  SBtag,BalLimit,(BalLimit-10),Clientcode from [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog  where ClientCode=@ClientCode   order by Update_date desc
		
		
	END
	ELSE
	BEGIN
	
		insert into [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed where PARTY_CODE =@ClientCode
		
	END	
	


if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 --Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 --print 'SBCredit'
			 --print @SBCredit
			 if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				begin 
					print 'Hi'	
					Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				END
				ELSE
				BEGIN
					print 'BYE'	
					Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				END	
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
		
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End


---///Added by prashant on 8 Nov 2011//----
--if(@Process='Usp_NewSBLimit')
--BEGIN
	
--Exec Usp_NewSBLimit @PaymentHistory,@ScriptCode,@SBCode,@TotalLimitGiven,@TotallimitAvailable,@ClientCredit,@newsblimit out
--print @PaymentHistory
--Print @Segment
--print @newsblimit
--END

END
    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_new_V1_20191005_bak
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
Usp_Limit_Data 'GetClientLedger','ET','','','','0.0','','','','px45','','','1','',''    
    
Usp_Limit_Data 'GetPercentageMul','JJRT','','','','0.0','','','','','','','','',''  

Usp_Limit_Data 'CheckClient','ET','','','','0.0','','','','A77588','','','','','' 

exec Usp_Limit_Data_new_V1 @Process='GetClientLedger',@SBCode='BLF',@ClientCode='A44984',@Segment='All Segments'
  
*/    
Create Procedure [dbo].[Usp_Limit_Data_new_V1_20191005_bak]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@newsblimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ScriptCode varchar(50)='',
@TypeOfOrder varchar(50)='',
@SBCrAdditional varchar(50)='',
@PaymentHistory varchar(50)='',
--@LimitAvailed varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@SBTotalLimit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else 
  
 --Begin  
 --select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 --union all  
 --select  'Commodity' as Segment,'Commodity' as SegmentVal   
 --end
 select Segment,SegmentVal from tbl_SegmentMaster  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

--if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
--	Begin
--	insert into tbl_SBLimitAllocation    
--	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT,ScriptCode,TypeOfOrder,SBCrAdditional,PaymentHistory)    
--	values    
--	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate(),@ScriptCode,@TypeOfOrder ,@SBCrAdditional ,@PaymentHistory)    
--	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			
			 if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
					begin 
						print 'Hi'	
						Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
						--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					END
					ELSE
					BEGIN
						print 'BYE'	
						Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
					END	
					 print 'SBCredit'
					 print @SBCredit
					 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
					 Begin 
					 select @SBCredit as ErrMsg
					 End
					 else
					 Begin
					 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
					 when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

					-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
					 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
	
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
	set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code =@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

		if(@PureRisk<-1000)
		Begin
			 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End
		if(@CommPureRisk<-1000)
		Begin
			select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		End

--///Change by prashant patade on 28012019--
--if(@Intraday<>'')
--Begin
	--select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--select 'Intraday Code' as ErrMsg
--End
------------END//-------------------
-- if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
-- Begin
-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
--	 Begin
--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
--	 End
--	 Else
--	 Begin
--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
--	 End
-- End
-- else
-- Begin
-- select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
-- End
--End 
if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 
	 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else

 Begin
 
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
END


if(@Process='GetClientLedger')
Begin
print 'test'
if(@Segment='All Segments')
Begin
set @PureRisk=(select pure_risk from [196.1.115.182].general.dbo.tbl_rms_collection_cli  with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD','MTF') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalEqMarginLimit) as total  from [196.1.115.182].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')



print 'test 2'

---///Added By Prashant on 6 nov 2017//---
		

--Exec Usp_PaymentHistoryFlag @ClientCode,@Segment,@PaymentHistory out
--print @ClientCode
--Print @Segment
--print @PaymentHistory


--exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode
--declare @LimitAvailed money
--exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode,@LimitAvailed out
----print @LimitAvailed

exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed  @SBCode,@ClientCode


if not  EXISTS (select * from tbl_LimitAvailedLog where ClientCode=@ClientCode)  
 BEGIN   
 print 'Availed'

	declare @LimitAvailed money
	insert into tbl_TempLimitAvailed
	exec [196.1.115.182].General.dbo.Usp_ALGgetLimitAvailed @SBCode,@ClientCode  
	print @LimitAvailed

	if(@Intraday='Both')
	begin 
		if EXISTS (select * from tbl_TempLimitAvailed where (LimitAvailed <='25000') and PARTY_CODE=@ClientCode)
		begin 
			update tbl_TempLimitAvailed
			set LimitAvailed='25000'
			where PARTY_CODE=@ClientCode and SB=@SBCode
		
		END
	END

	--//change by prashant patade on 18042019
	--if(@Intraday='Both')
	begin 
	if EXISTS (select * from tbl_TempLimitAvailed where (LimitAvailed ='0.00' ) and PARTY_CODE=@ClientCode)
	begin 
		update tbl_TempLimitAvailed
		set LimitAvailed='25000'
		where PARTY_CODE=@ClientCode and SB=@SBCode
		
	END
	END
	
END


--if(@PaymentHistory='Green' or @PaymentHistory='Yellow' or @PaymentHistory='Red' )
--			 Begin 
--			 select @PaymentHistory as ErrMsg
--			 End

---///End //----- 
print @PureRisk
	if(@PureRisk<convert (decimal,-1000))
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--else if(@Intraday='Both')
	--Begin
	--		--select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger ,'' as ErrMsg
	--	END
		
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,@PaymentHistory as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	--	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	 
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
 
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
--set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @ClientLedger=(select SUM(TotalCommMarginLimit) as total  from [196.1.115.182].general.dbo.client_limit  where  party_code=@ClientCode and  (BRANCH =@SBCode or SB=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode)-- and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	--else if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66' )
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	-- else
	-- Begin
	-- select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	-- End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mappingbbbbb)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode )--and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	--if(@Intraday='Both')
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code' as ErrMsg
	--End
	--else if (@Intraday<>'Both' or @Intraday is null)
	--	begin 
	--		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Not an Intraday Code 6' as ErrMsg
	--	END
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	--if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	-- Begin
	-- if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	--	 Begin
	--	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg,'' as PaymentHistory from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	--	 End
	--	 Else
	--	 Begin
	--	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	--	 End
	-- End
	 --else
	 --Begin
	 --select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 --End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode and servermapped<>'172.31.15.66')
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,convert(decimal(18,2),@ClientLedger) as ClientLedger,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday='' Or @Intraday in ('Equity','Client2C','0')or @Intraday IS Null then 'Not an Intraday Code' else 'Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 --Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 --print 'SBCredit'
			 --print @SBCredit
			 --print @SBTotalLimit
			 if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				begin 
					print 'Hi'	
					Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				END
				ELSE
				BEGIN
					print 'BYE'	
					Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				END	
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,@SBTotalLimit as TotalGivenLimit,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)


--insert into tbl_LimitAvailedLog
--select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed


if exists  (select * from tbl_LimitAvailedLog where BalLimit ='0.00' and ClientCode=@ClientCode)
BEGIN
select 'BYE' as ErrMsg
END
ELSE
BEGIN
if exists (select * from [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog where ClientCode=@ClientCode)
	begin 
		
		insert into [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select  top 1  SBtag,BalLimit,(BalLimit-@EnterLimit),Clientcode from [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog  where ClientCode=@ClientCode   order by Update_date desc
		
		
	END
	ELSE
	BEGIN
	
		insert into [196.1.115.132].LimitEnhancement.dbo.tbl_LimitAvailedLog(Sbtag,LimitAvailed,BalLimit,ClientCode)
		select distinct  SB,LimitAvailed,(LimitAvailed-@EnterLimit),PARTY_CODE from tbl_TempLimitAvailed where PARTY_CODE =@ClientCode
		
	END	
END


if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 --Exec Prc_GetLimitAvailable @SBCode,@SBCredit out--,@SBTotalLimit out
			 --print 'SBCredit'
			 --print @SBCredit
			 if exists (select * from mis.sb_comp.dbo.sb_broker where TAGGeneratedDate <='2008-12-31 00:00:00.000' and SBTAG=@SBCode)
				begin 
					--print 'Hi'	
					Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
					--Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
				END
				ELSE
				BEGIN
					--print 'BYE'	
					Exec Prc_GetLimitAvailable_above2008 @SBCode,@SBCredit out
				END	
		End	 	 
		
		if(@EnterLimit<0)		
		Begin
		
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
				Begin
				set @LimitGiven=isnull(round(@SBCredit,0),0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
                set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,case when ISNULL(@LimitGiven,0)=0.00 then 1 else  ISNULL(@LimitGiven,0) end as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode and Segment=@Segment)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
   
		/*	
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
			*/
	  		SELECT '-10' AS ErrMsg	
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End


---///Added by prashant on 8 Nov 2011//----
--if(@Process='Usp_NewSBLimit')
--BEGIN
	
--Exec Usp_NewSBLimit @PaymentHistory,@ScriptCode,@SBCode,@TotalLimitGiven,@TotallimitAvailable,@ClientCredit,@newsblimit out
--print @PaymentHistory
--Print @Segment
--print @newsblimit
--END

END
    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Limit_Data_Test
-- --------------------------------------------------
/*    
CreateBY:-Sandeep    
CReateOn:-24 Jun 2016    
Reason:- To Get SB Cateory and Insert Limit Data Entry from Sub broker    
    
Usp_Limit_Data_Test 'TotalLimit','XXFC','','','','0.0','','','','A89545','','','-310000.00','','Equity+FNO+Curr'    
*/    
CREATE Procedure [dbo].[Usp_Limit_Data_Test]    
(    
@Process varchar(50),    
@SBCode varchar(50)='',    
@SBName varchar(100)='',    
@SbCategory varchar(50)='',    
@Percentage int='',    
@Multiplier decimal(18,2)='',    
@TotalLimitAvailable money='',    
@TotalLimitGiven money='',    
@BalanceLimit money='',    
@ClientCode varchar(50)='',    
@ClientName varchar(50)='',    
@ClientCredit money='',    
@EnterLimit money='',
@TotalEnterLimit money='',
@Segment varchar(50)='',
@Status varchar(50)='',    
@ServerMapped varchar(50)='',
@IntradayCode varchar(50)='',
@Access_to varchar(50)='',    
@Access_code varchar(50)='',    
@UserName varchar(50)='',    
@filterdata1 varchar(50)='',    
@filterdata2 varchar(50)='',    
@filterdata3 varchar(50)='',    
@filterdata4 varchar(50)='',    
@filterdata5 varchar(50)='',    
@filterdata6 varchar(50)='',
@IPAddress varchar(50)='',
@ResponseData varchar(100)='',
@Response bit='',
@APILogID varchar(50) =NULL out    
)    
As    
Begin  
print 'APILOG'
print @APILogID
declare @SBCredit varchar(max),@Sub_category varchar(50),@PureRisk money,@Intraday varchar(50),@CommPureRisk money,@ClientLedger money,@LimitGiven money
if(@Process='SBCategory')    
Begin    
select SbCategory,SbCategory from tbl_MstSBCategory    
End    
if(@Process='GetSBCode')    
Begin    
select SB as SBtag,SB_Name as ContactPerson  from  [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical with(nolock) where SB like + @SBCode+'%'    
--select  SBtag,ContactPerson from mis.sb_comp.dbo.sb_broker with(nolock) where sbtag like '%'+ @SBCode+'%'    
End 
if(@Process='GetClientCode')    
Begin    

	if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
		--select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where party_code like '%'+ @ClientCode+'%' 
		select  party_code,short_name from 
		(
		select a.party_code,a.short_name,a.branch_cd, 
		(Case when b.cli_type='B2C' then 'Y' else 'N' end) as  b2c      
		from [196.1.115.182].general.dbo.client_Details a with (nolock) join       
		[196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock) on a.party_Code=b.client 		 
		)x
		where --b2c='Y' and
		 branch_cd=@SBCode  and  party_code like '%'+ @ClientCode+'%' 
		End
		Else
		Begin
		select  party_code,short_name from [196.1.115.182].general.dbo.client_details with(nolock) where sub_broker=@SBCode and party_code like '%'+ @ClientCode+'%'    
	    End
End  
if(@Process='GetSegment')    
Begin    
if exists(select * from [196.1.115.182].general.dbo.client_details with(nolock) where cl_type in ('NBF','TMF') and party_code=@ClientCode)  
 begin  
 select  'NBFC' as Segment,'NBFC' as SegmentVal  
 end  
 else  
 Begin  
 select  'Equity+FNO+Curr' as Segment,'Equity+FNO+Curr' as SegmentVal    
 union all  
 select  'Commodity' as Segment,'Commodity' as SegmentVal   
 end  
End   

if(@Process='InsGoodMultiplier')    
Begin    
 if exists(select * from tbl_SBCategoryGoodWill where SBCategory=@SbCategory)    
 Begin    
 update tbl_SBCategoryGoodWill    
 set Percentage=@Percentage,    
 Multiplier=@Multiplier,    
 UpdatedBy=@UserName,--@UserName    
 UpdatedDT=getdate()    
 where SBCategory=@SbCategory    
 End    
 else    
 Begin    
 insert into tbl_SBCategoryGoodWill    
 (SBCategory,Percentage,Multiplier,CreatedBy,CreatedDT)    
 values    
 (@SbCategory,@Percentage,@Multiplier,@UserName,getdate())    
 End    
End    
if(@Process='InsSBIndividualData')    
Begin   
if exists(select * from tbl_SBIndividual with(nolock) where Sbcode=@SBCode)
Begin
	update tbl_SBIndividual
	set SBName=@SBName,
	Percentage=@Percentage,
	Multiplier=@Multiplier,
	UpdatedBy=@UserName,--@Username
	UpdatedDt=getdate()
	where SBCode=@SBCode

End
else
Begin
insert into tbl_SBIndividual    
(SBCode,SBName,Percentage,Multiplier,CreatedBy,CreatedDT)    
values    
(@SBCode,@SBName,@Percentage,@Multiplier,@UserName,getdate())    
End
End  
if(@Process='InsSBLimitData')    
Begin   
set @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
declare @SBGivenLimitCurrent money
set @SBGivenLimitCurrent =(select isnull(Sum(EnterLimit),0) from tbl_SBLimitAllocation With(nolock)  where SBCODE=@SBCODE) 
--if  exists (select * from tbl_SBLimitAllocation with(nolock) where ClientCode=@ClientCode and SBCode=@SBCode and segment=@segment)
--Begin
--update tbl_SBLimitAllocation
--set EnterLimit=@EnterLimit,
-- LimitResponse=@Response,
-- UpdatedBy=@UserName,--@UserName    
-- UpdatedDT=getdate()
--where ClientCode=@ClientCode and SBCode=@SBCode
--End
--else
--Begin

if(@SBGivenLimitCurrent<=@TotalLimitAvailable)
	Begin
	insert into tbl_SBLimitAllocation    
	(SBCode,SBName,TotalLimitAvail,TotalLimitGiven,BalanceLimit,ClientCode,ClientName,ClientCredit,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,IntradayCode,LimitResponse,LimitResponseMesaage,ServerMapped,IpAddress,CreatedBy,CreatedDT)    
	values    
	(@SBCode,@SBName,@TotalLimitAvailable,@TotalLimitGiven,@BalanceLimit,@ClientCode,@ClientName,@ClientCredit,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@IntradayCode,@Response,@ResponseData,@ServerMapped,@IPAddress,@UserName,getdate())    
	End
--End
End 
if(@Process='GETSBLIMIT')    
Begin
select ClientCode,ClientName,convert(decimal(18,2),EnterLimit) as EnterLimit,Segment,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT,case when limitResponse=1 then 'Success' when(limitResponse=0 and isnull(LimitResponseMesaage,'')='' and isnull(ServerMapped,'')<>'') then 'Limit Updated on Odin Response Awaited' else 'Failed' end as LimitUpdation
from tbl_SBLimitAllocation with(nolock) where SBCode=@sbcode --and limitResponse=1
End
if(@Process='APILog')    
Begin
if(@APILogID='' or @APILogID is null)
Begin
print 'bye'
set  @SBName=(select TradeName from mis.sb_comp.dbo.sb_broker where sbtag=@SBCode)
insert into tbl_APICALLLog
(SBCode,SBName,ClientCode,ClientName,EnterLimit,TotalEnterLimit,Segment,ClientCodeStatus,LimitResponse,LimitResponseMesaage,CreatedBy,CreatedDT)
values
(@SBCode,@SBName,@ClientCode,@ClientName,@EnterLimit,@TotalEnterLimit,@Segment,@Status,@Response,@ResponseData,@UserName,getdate())
select @APILogID=@@identity
print @APILogID
end
else
Begin
print 'update'
update tbl_APICALLLog
set LimitResponse=@Response,
LimitResponseMesaage=@ResponseData
where RecID=@APILogID
End
End
if(@Process='GetLimit')    
Begin  

		if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
			 if(@SBCredit='SB is in pure risk Additional Limit Cannot be Granted' or @SBCredit='Subbroker does not exists')
			 Begin 
			 select @SBCredit as ErrMsg
			 End
			 else
			 Begin
			 select round(@SBCredit,0) as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) =0 then 0 
			when  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode),0)=0 then round(@SBCredit,0) else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@SBCode ),0) end as LimitGivenD,'' as ErrMsg 

			-- select @SBCredit as SBCredit,case when isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0) =0 then 0 else  convert(money,round(@SBCredit,0))-isnull((select Sum(EnterLimit)  from tbl_SBLimitAllocation where sbcode=@sbcode),0)   end as LimitGivenD,'' as ErrMsg 
			 End
		End 
End 
if(@Process='LimitAvialable')    
Begin  
 select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode
End 

if(@Process='CheckClient')    
Begin  
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

if(@PureRisk<-1000)
Begin
	 select 'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@CommPureRisk<-1000)
Begin
	select 'Client is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
End
if(@Intraday<>'')
Begin
	select 'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
End
 if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
 Begin
 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
	 Begin
	 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	 End
	 Else
	 Begin
	 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
 End
 else
 Begin
 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
 End
End 
if(@Process='GetClientLedger')
Begin
if(@Segment='Equity+FNO+Curr')
Begin
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('BSECM','NSECM','NSEFO','NSX','MCD') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

print @PureRisk
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
	
End
Else if(@Segment='Commodity')
Begin
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('MCX','NCDEX') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	if(@CommPureRisk<-1000)
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'CLient is in Commodities Pure Risk(Please call RMS team for taking limits)' as ErrMsg
	End
	else if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	--else
	--Begin
	--	select convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg
	--End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  convert(decimal(18,2),0) as ClientLedger,'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
	
End
else
	Begin
	set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL   with(nolock) where party_code=@ClientCode)
    set @ClientLedger=(select isnull(sum(ledger),0) from [196.1.115.182].general.dbo.rms_dtclfi  where co_code in('NBFC') and party_code=@ClientCode and (sub_broker=@SBCode or Branch_cd=@SBCode))
	set @Intraday=(select Intraday_type from [196.1.115.182].general.dbo.alg_exp_mast with(nolock) where entity_code=@ClientCode and isnull(Intraday_type,'0')<>'0' and isnull(Intraday_type,'')<>'' and isnull(Intraday_type,'')<>'Client2C')

	--select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	--from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
	
	--select case when ISNULL(@Intraday,'')<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg 
	if(@PureRisk<-1000)
	Begin	
		 select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Client is in Pure Risk(Please call RMS team for taking limits)' as ErrMsg
		 return
	End
	if(@Intraday<>'')
	Begin
		select convert(decimal(18,2),@ClientLedger) as ClientLedger,'Intraday Code(Please call RMS team for taking limits)' as ErrMsg
	End
	
	if exists (select * from intranet.mis.dbo.odinclientinfo with(nolock) where pcode=@ClientCode)
	 Begin
	 if exists (select * from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode))
		 Begin
		 select pcode,pname,case when bbb in (4,134) then 'ONLINE' else 'OFFLINE' end as Status,Tag as tag,o.servermapped,case when @Intraday<>'' then 'Intraday Code(Please call RMS team for taking limits)' else 'Not an Intraday code' end as IntradayCode,convert(decimal(18,2),@ClientLedger) as ClientLedger,'' as ErrMsg from intranet.risk.dbo.client_details c with(nolock) inner join intranet.mis.dbo.odinclientinfo  o with(nolock) on c.party_code=o.pcode where c.party_code=@ClientCode and (c.sub_broker=@SBCode or c.branch_cd=@SBCode)
		 End
		 Else
		 Begin
		 select 'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
		 End
	 End
	 else
	 Begin
	 select  'Unmapped Client(Please Call RMS Team for Mapping)' as ErrMsg
	 End
		
		
	
	
	End
End

if(@Process='SBCategoryList')    
Begin    
select SBCategory,Percentage,Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBCategoryGoodWill    with(nolock)
End 

if(@Process='SBCategoryIndividual')    
Begin    
select RecId,SBCode,SBName,Percentage,convert(decimal(18,2),Multiplier) as Multiplier,CreatedBy,convert(varchar,CreatedDT,103)+' ' +convert(char , CreatedDT, 108) as CreatedDT from tbl_SBIndividual with(nolock)    
End 
if(@Process='GetPercentageMul')    
Begin    
if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			 Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End		 

set @Sub_category=(select max(Sb_Category) as Sb_Category from [196.1.115.182].general.dbo.tbl_RMS_collection_SB with(nolock) where Sub_Broker=@sbcode)
if exists (select percentage,Multiplier,SbCategory,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category)))
begin
		if exists (select percentage,Multiplier,@Sub_category as SbCategory,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode)))
		Begin
		select percentage,Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBIndividual with(nolock) where rtrim(ltrim(SBCODE))=rtrim(ltrim(@SBCode))
		End
		Else
		Begin
		select percentage,Multiplier,SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg from tbl_SBCategoryGoodWill with(nolock) where rtrim(ltrim(Sbcategory))=rtrim(ltrim(@Sub_category))
		End
end
else
Begin
select top 1 '0' as percentage,'0' as Multiplier,@Sub_category as SbCategory,@SBCredit as TotalLimitAvailable,'' as ErrMsg 
End

End

if(@Process='TotalLimit')
Begin
declare @TotalLimit money,@TotalLimitSB money
set @PureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ABL  with(nolock) where party_code=@ClientCode)
set @CommPureRisk=(select purerisk from [196.1.115.182].general.dbo.RMS_DTCLFI_SUMM_ACBPL  with(nolock) where party_code=@ClientCode)
set @LimitGiven=(select Sum(EnterLimit) as LimitGivenD from tbl_SBLimitAllocation where sbcode=@sbcode)

if exists (select * from [196.1.115.182].Franchisee.dbo.Franchisee_Mast with(nolock) where todate>=getdate() and Ftag=@SBCode)
		Begin 
			Exec Prc_GetLimitAvailable_Franchise @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End
		ELSE
		Begin
			 Exec Prc_GetLimitAvailable @SBCode,@SBCredit out
			 print 'SBCredit'
			 print @SBCredit
		End	 	 
		print 'EnterLimit'
		print @EnterLimit
		if(@EnterLimit<0)		
		Begin
		
				if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
				Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode and ClientCode=@ClientCode) 
				set @TotalLimitSB=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode ) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				set @TotalLimitSB=isnull(@TotalLimitSB,0)+isnull(@EnterLimit,0)
				print 'TotalLimit'
				print @TotalLimit
				print 'SBCredit'
				print @SBCredit
				if (isnull(@TotalLimitSB,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE IF(isnull(@TotalLimit,0)<0)
					BEGIN
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     						
					END
					ELSE
					BEGIN
					print 'xyz'
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
				End
				Else
				Begin
					select top 1 'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --where --SBCode=@SBCode and 
					--Clientcode=@CLientCode and Segment=@Segment
				End	
	     End
	     Else
	     Begin
				set @LimitGiven=isnull(@SBCredit,0)-isnull(@LimitGiven,0)
				set @TotalLimit=(select abs(isnull(sum(EnterLimit),0)) as TotalLimit from tbl_SBLimitAllocation with(nolock) where SBCode=@SBCode) 
				set @TotalLimit=isnull(@TotalLimit,0)+isnull(@EnterLimit,0)
				if (isnull(@TotalLimit,0)>isnull(round(@SBCredit,0),0))
					BEGIN				 
					select top 1  'Enter limit exceeding total available limit' as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) --SBCode=@SBCode and     
					END
					ELSE
					BEGIN
					select isnull(sum(EnterLimit),0) as TotalLimit,case when @Segment ='Equity+FNO+Curr' then ISNULL(@PureRisk,0) else '0' end as PureRisk,case when @Segment ='Commodity' then ISNULL(@CommPureRisk,0) else 0 end as Commodities,ISNULL(@LimitGiven,0) as ChkLimitGiven from tbl_SBLimitAllocation with(nolock) where --SBCode=@SBCode and 
					Clientcode=@CLientCode and Segment=@Segment
					END
	     End
		
End


if(@Process='CheckClientLimit')
Begin
if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
	Begin
			select isnull(SUM(isnull(EnterLimit,0)),0) as ClientLimitGiven,'' as ErrMsg   from tbl_SBLimitAllocation where sbcode=@sbcode and ClientCode=@ClientCode
	End
	else
	Begin
		select 'Negative Limit for the above client cannot be proceed since you have not given limit to the mentioned client' as ErrMsg   
	End
End
if(@Process='CheckClientLimitMob')
Begin
if(@EnterLimit<0)
   Begin
   --print 'hi'
		if exists(select * from tbl_SBLimitAllocation where SBCODE=@sbcode and ClientCode=@ClientCode)
			Begin
					DECLARE @ENTERlIMITMOB AS MONEY=0.0
					
			
					select @ENTERlIMITMOB =isnull(SUM(isnull(EnterLimit,0)),0) from tbl_SBLimitAllocation where 
					sbcode=@sbcode and ClientCode=@ClientCode
					IF((@EnterLimit*-1)>@ENTERlIMITMOB)
					BEGIN					
					SELECT '-10' AS ErrMsg					
					END
					ELSE
					BEGIN
					SELECT '' AS ErrMsg
					END
			End
			else
			Begin
				select '-10' as ErrMsg   
			End
	End
	Else
	Begin
	select '' as ErrMsg   
	--print 'hi'
	End
End



End    
 
  
    
--truncate table tbl_SBCategoryGoodWill

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LimitAvailedJob
-- --------------------------------------------------

CREATE Proc Usp_LimitAvailedJob
As
begin 
		

		
		truncate table tbl_TempLimitAvailed
		truncate table tbl_LimitAvailedLog
		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_LimitResponseStatusUpdate
-- --------------------------------------------------

CREATE Proc Usp_LimitResponseStatusUpdate
As
begin 
	
	Update tbl_SBLimitAllocation 
	set LimitResponseMesaage='Limit updation Failed. Limit Reinstated'
	where LimitResponse='0'
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Odin_Collater_OdinGroupIdServerId
-- --------------------------------------------------


  
  
--exec Usp_Odin_Collater_OdinGroupIdServerId 'S250357'    
    
CREATE   proc Usp_Odin_Collater_OdinGroupIdServerId     
(    
@Party_code varchar(20)    
)    
As    
begin     
    
 select opcode,pcode,tag,servermapped from mis.dbo.odinclientinfo where pcode =@Party_code  --and tag='AKSTR'  
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_OdinGroupIdServerId
-- --------------------------------------------------
CREATE  proc Usp_OdinGroupIdServerId   
(  
@Party_code varchar(20)  
)  
As  
begin   
  
 --select opcode,pcode,tag,servermapped from MIS.dbo.V_odinclientinfo where pcode =@Party_code  --and tag='AKSTR'
  select opcode,pcode,tag,servermapped from MIS.dbo.odinclientinfo where pcode =@Party_code  --and tag='AKSTR'
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Omn_AdditionalLimit_LE
-- --------------------------------------------------


 --exec  Usp_Omn_AdditionalLimit_LE 'P94373','10'
    
CREATE Proc Usp_Omn_AdditionalLimit_LE  
(  
@ClientCode varchar (50),  
@AdditionalLimit varchar (50)  
)  
AS  
Begin   
  
 declare @Account_No varchar(100),@Group_ID varchar(100),  
 @Amount varchar(100),@Token varchar(100),@Segment varchar(100),@Source varchar(100)  
  
 declare @Token1 varchar(100)  
 set @Token1= replace(convert(varchar, getdate(),101),'/','') + replace(convert(varchar, getdate(),108),':','')+'_LE'  
  
 Set @Account_No=(select dbo.[fn_string_To_EncodeBASE64](@ClientCode))  
 Set @Group_ID=''  
 Set @Amount=(select dbo.[fn_string_To_EncodeBASE64](@AdditionalLimit))  
 Set @Token=(select dbo.[fn_string_To_EncodeBASE64](@Token1))  
 Set @Segment=(select dbo.[fn_string_To_EncodeBASE64]('AllSegments'))  
 set @Source=(select dbo.[fn_string_To_EncodeBASE64]('Inhouse_LE'))  
  
 --Set @Account_No='UDk0Mzcz'  
 --Set @Group_ID=''  
 --Set @Amount='MQ=='  
 --Set @Token='MTgxMjIwMTlfTEU='  
 --Set @Segment='QWxsIFNlZ21lbnRz'  
 --set @Source='U1BfTEU='  
  
 DECLARE @Object AS INT;      
 DECLARE @ResponseText AS VARCHAR(100);      
 DECLARE @Body AS VARCHAR(MAX) =      
 '{  "Account_No":"'+@Account_No+'",      
  "Group_ID":"'+@Group_ID+'",      
  "Amount":"'+@Amount+'",      
  "Token":"'+@Token+'",    
  "Segment":"'+@Segment+'",  
  "Source":"'+@Source+'"  
 }'        
      
 EXEC sp_OACreate 'MSXML2.ServerXMLHTTP', @Object OUT;      
 EXEC sp_OAMethod @Object, 'open', NULL, 'post','https://tab.angelbroking.com/api/OmnesysValidation/Add_Omnesys_Limit_Enhance_Reduce', 'false'      
      
 EXEC sp_OAMethod @Object, 'setRequestHeader', null, 'Content-Type', 'application/json'      
 EXEC sp_OAMethod @Object, 'send', null, @body      
      
 EXEC sp_OAMethod @Object, 'responseText',@ResponseText OUTPUT    
        
 EXEC sp_OADestroy @Object      
    
 select @ResponseText as Response  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_repush_limitAPI
-- --------------------------------------------------
CREATE Proc USP_repush_limitAPI  

@Source varchar(50),  
@SubBroker varchar(50),  
@ClientCode varchar(50),  
@Segments varchar(50),  
@Limit_Given varchar(50),  
@Limit_Status varchar(50)  
As  
begin  
   
 insert into Tbl_repush_limitAPI  
 select @Source,@SubBroker,@ClientCode,GETDATE(),@Segments,@Limit_Given,@Limit_Status  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UpdateClinetLimit_NewAPI
-- --------------------------------------------------
  
CREATE Proc [dbo].[Usp_UpdateClinetLimit_NewAPI]  
(  
@Party_code varchar(20),  
@LimitAmt varchar(20),  
@LimitResponse bit,      
@LimitResponseMessage varchar(50),
@RePushed varchar(100),
@Status varchar(100) 
)  
As  
Begin   
 Update tbl_InstClinetLimit_newAPI  
 set LimitResponse=@LimitResponse,LimitResponseMesaage=@LimitResponseMessage,Updateddate=GETDATE(),RePushed=@RePushed,Status=@Status
 where party_code=@Party_code and  TotalLimit=@LimitAmt  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UpdateFailRepushedAndGenerateOdinFile
-- --------------------------------------------------
  
CREATE  Proc [dbo].[Usp_UpdateFailRepushedAndGenerateOdinFile]  
(  
@Party_code varchar(20),    
@LimitAmt varchar(20),    
@RePushed varchar(100),  
@Status varchar(100)   
)  
As  
BEGIN   
    
   truncate table tbl_RepushedData  
     
   Update tbl_InstClinetLimit_newAPI    
   set Updateddate=GETDATE(),RePushed=@RePushed,Status=@Status  
   where party_code=@Party_code and  TotalLimit=@LimitAmt   
     
    
  declare @tag varchar(50)  
  select @tag=tag from  MIS.dbo.odinclientinfo where pcode =@Party_code  
  select @tag   
    
  insert into tbl_RepushedData(Data)  
  select  '2,'+@Party_code+','+@tag+',17,'+@LimitAmt+','  
    
    
   DECLARE   @FILENAME_1      AS VARCHAR(100)  ,  @s1 VARCHAR(MAX) = ''    
   SET @FILENAME_1 ='Repushed_failed'+ replace(convert(varchar(8), Getdate(), 112)+convert(varchar(8),Getdate(), 114), ':','')+'.txt'               
   SET @s1 = 'exec MASTER.dbo.xp_cmdshell ' + ''''    
   SET @s1 = @s1 + 'bcp "select * from INTRANET.LimitEnhancement.dbo.tbl_RepushedData" queryout \\INHOUSELIVEAPP2-FS.angelone.in\D$\upload1\Repushed_failed\'+@FILENAME_1+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                     
   SET @s1 = @s1 + ''''                                                                  
   --Print (@s1)    
   EXEC(@s1)     
  
     
     
END

GO

-- --------------------------------------------------
-- TABLE dbo.ExcludeUser
-- --------------------------------------------------
CREATE TABLE [dbo].[ExcludeUser]
(
    [sub_broker] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.limitlog
-- --------------------------------------------------
CREATE TABLE [dbo].[limitlog]
(
    [clientcode] VARCHAR(50) NULL,
    [Amt] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Limitlog04092020
-- --------------------------------------------------
CREATE TABLE [dbo].[Limitlog04092020]
(
    [Column 0] VARCHAR(50) NULL,
    [Column 1] VARCHAR(50) NULL,
    [Column 2] VARCHAR(50) NULL,
    [Column 3] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_LimitEnch
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_LimitEnch]
(
    [SBTag] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t
-- --------------------------------------------------
CREATE TABLE [dbo].[t]
(
    [Region] VARCHAR(20) NULL,
    [Branch] VARCHAR(10) NULL,
    [Sub Broker] VARCHAR(10) NULL,
    [SB Name] VARCHAR(100) NULL,
    [SB Cat] VARCHAR(10) NULL,
    [SB Cr After Adj] DECIMAL(15, 2) NULL,
    [Projected Risk] DECIMAL(15, 2) NULL,
    [NetBrokerage] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_APICALLLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_APICALLLog]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Collateral_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Collateral_log]
(
    [ClientID] VARCHAR(20) NULL,
    [ISINCode] VARCHAR(50) NULL,
    [qty] VARCHAR(10) NULL,
    [Price] MONEY NULL,
    [PledgedQty] VARCHAR(10) NULL,
    [grpCode] VARCHAR(10) NULL,
    [buyPrice] MONEY NULL,
    [CFSHaircut] MONEY NULL,
    [HairCut] MONEY NULL,
    [Indicator] VARCHAR(10) NULL,
    [collateralQTY] VARCHAR(10) NULL,
    [UpdatedDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Errorlog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Errorlog]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [Err_Desc] VARCHAR(MAX) NULL,
    [Function_Name] VARCHAR(50) NULL,
    [PageName] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_InstClinetLimit_newAPI
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_InstClinetLimit_newAPI]
(
    [RecId] INT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(20) NULL,
    [tag] VARCHAR(20) NULL,
    [servermapped] VARCHAR(20) NULL,
    [Segments] VARCHAR(20) NULL,
    [Clientlimit] MONEY NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [Createdate] DATETIME NULL,
    [Updateddate] DATETIME NULL,
    [TotalLimit] MONEY NULL,
    [RePushed] VARCHAR(100) NULL,
    [Status] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_InstClinetLimit_newAPI_03082020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_InstClinetLimit_newAPI_03082020]
(
    [RecId] INT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(20) NULL,
    [tag] VARCHAR(20) NULL,
    [servermapped] VARCHAR(20) NULL,
    [Segments] VARCHAR(20) NULL,
    [Clientlimit] MONEY NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [Createdate] DATETIME NULL,
    [Updateddate] DATETIME NULL,
    [TotalLimit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_InstClinetLimit_newAPI_4Aug2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_InstClinetLimit_newAPI_4Aug2020]
(
    [RecId] INT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(20) NULL,
    [tag] VARCHAR(20) NULL,
    [servermapped] VARCHAR(20) NULL,
    [Segments] VARCHAR(20) NULL,
    [Clientlimit] MONEY NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [Createdate] DATETIME NULL,
    [Updateddate] DATETIME NULL,
    [TotalLimit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_InstClinetLimit_newAPI_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_InstClinetLimit_newAPI_Hist]
(
    [RecId] INT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(20) NULL,
    [tag] VARCHAR(20) NULL,
    [servermapped] VARCHAR(20) NULL,
    [Segments] VARCHAR(20) NULL,
    [Clientlimit] MONEY NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [Createdate] DATETIME NULL,
    [Updateddate] DATETIME NULL,
    [TotalLimit] MONEY NULL,
    [Update_Histtable] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_LE_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_LE_Log]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ClientCode] VARCHAR(20) NULL,
    [Amount] MONEY NULL,
    [Updateddate] DATETIME NULL DEFAULT (getdate()),
    [FileGenerated] VARCHAR(10) NULL,
    [FileGendt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_LimitAvailedLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_LimitAvailedLog]
(
    [Sbtag] VARCHAR(50) NULL,
    [LimitAvailed] MONEY NULL,
    [BalLimit] MONEY NULL,
    [ClientCode] VARCHAR(20) NULL,
    [Update_date] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_LimitAvailedLog_10042019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_LimitAvailedLog_10042019]
(
    [Sbtag] VARCHAR(50) NULL,
    [LimitAvailed] MONEY NULL,
    [BalLimit] MONEY NULL,
    [ClientCode] VARCHAR(20) NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_LimitEnchValidationLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_LimitEnchValidationLog]
(
    [Client_code] VARCHAR(30) NULL,
    [SBCode] VARCHAR(50) NULL,
    [ErrMsg] VARCHAR(500) NULL,
    [CreatedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Monthly_TB_YTD
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Monthly_TB_YTD]
(
    [ENTITY] VARCHAR(50) NULL,
    [ACCOUNT] VARCHAR(50) NULL,
    [ACCOUNT_DESCRIPTION] VARCHAR(50) NULL,
    [BEGINING_BALANCE] VARCHAR(50) NULL,
    [ACCOUNTED_DR] VARCHAR(50) NULL,
    [ACCOUNTED_CR] VARCHAR(50) NULL,
    [END_BALANCE] VARCHAR(50) NULL,
    [BO_CODE] VARCHAR(50) NULL,
    [BO_DESCRIPTION] VARCHAR(50) NULL,
    [Report_Date] VARCHAR(50) NULL,
    [Period] VARCHAR(50) NULL,
    [Code] VARCHAR(50) NULL,
    [Code_B] VARCHAR(50) NULL,
    [COMPANY_GRP] VARCHAR(50) NULL,
    [COMPANY] VARCHAR(50) NULL,
    [TYPE] VARCHAR(50) NULL,
    [SUB_TYPE] VARCHAR(50) NULL,
    [L] VARCHAR(50) NULL,
    [SYSTEM] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Monthly_TB_YTD_2018_22
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Monthly_TB_YTD_2018_22]
(
    [ENTITY] VARCHAR(50) NULL,
    [ACCOUNT] VARCHAR(50) NULL,
    [ACCOUNT_DESCRIPTION] VARCHAR(500) NULL,
    [BEGINING_BALANCE] VARCHAR(50) NULL,
    [ACCOUNTED_DR] VARCHAR(50) NULL,
    [ACCOUNTED_CR] VARCHAR(50) NULL,
    [END_BALANCE] DECIMAL(28, 0) NULL,
    [BO_CODE] VARCHAR(50) NULL,
    [BO_DESCRIPTION] VARCHAR(500) NULL,
    [Report_Date] VARCHAR(50) NULL,
    [Period] VARCHAR(50) NULL,
    [Code] VARCHAR(50) NULL,
    [Code_B] VARCHAR(50) NULL,
    [COMPANY_GRP] VARCHAR(50) NULL,
    [COMPANY] VARCHAR(50) NULL,
    [TYPE] VARCHAR(50) NULL,
    [SUB_TYPE] VARCHAR(50) NULL,
    [L] VARCHAR(50) NULL,
    [SYSTEM] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MstSBCategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MstSBCategory]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCategory] VARCHAR(50) NULL,
    [SbCategoryDesc] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDt] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MstSBCategory_28052019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MstSBCategory_28052019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCategory] VARCHAR(50) NULL,
    [SbCategoryDesc] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDt] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_repush_limitAPI
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_repush_limitAPI]
(
    [Source] VARCHAR(200) NULL,
    [SubBroker] VARCHAR(200) NULL,
    [clientCode] VARCHAR(200) NULL,
    [CreatedDate] DATETIME NULL,
    [Segments] VARCHAR(200) NULL,
    [Limit_Given] VARCHAR(200) NULL,
    [Limit_Status] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RepushedData
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RepushedData]
(
    [Data] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBCategoryGoodWill
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBCategoryGoodWill]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCategory] VARCHAR(50) NULL,
    [Percentage] INT NULL,
    [Multiplier] DECIMAL(18, 2) NULL,
    [Limit] DECIMAL(38, 2) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBCategoryGoodWill_28052019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBCategoryGoodWill_28052019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCategory] VARCHAR(50) NULL,
    [Percentage] INT NULL,
    [Multiplier] DECIMAL(18, 2) NULL,
    [Limit] DECIMAL(38, 2) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBCategoryGoodWill_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBCategoryGoodWill_log]
(
    [RecID] INT NOT NULL,
    [SBCategory] VARCHAR(50) NULL,
    [Percentage] INT NULL,
    [Multiplier] DECIMAL(18, 2) NULL,
    [Limit] DECIMAL(38, 2) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL,
    [DBactionOn] DATETIME NULL,
    [DBaction] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBIndividual
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBIndividual]
(
    [RecId] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [Percentage] INT NULL,
    [Multiplier] DECIMAL(18, 2) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDt] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBIndividual_13032019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBIndividual_13032019]
(
    [RecId] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [Percentage] INT NULL,
    [Multiplier] DECIMAL(18, 2) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDt] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBIndividual_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBIndividual_log]
(
    [RecId] INT NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [Percentage] INT NULL,
    [Multiplier] DECIMAL(18, 2) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDt] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDt] DATETIME NULL,
    [DBactionOn] DATETIME NULL,
    [DBaction] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_01dec2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_01dec2020]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_04052020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_04052020]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_05052020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_05052020]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_08Aug2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_08Aug2019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_09Aug2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_09Aug2019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_13Aug2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_13Aug2020]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_16july2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_16july2019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_20112019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_20112019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_5Aug2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_5Aug2020]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_bkp13May2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_bkp13May2019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL,
    [ScriptCode] VARCHAR(50) NULL,
    [TypeOfOrder] VARCHAR(50) NULL,
    [SBCrAdditional] VARCHAR(50) NULL,
    [PaymentHistory] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_log]
(
    [RecID] INT NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IPAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL,
    [DBactionOn] DATETIME NULL,
    [DBaction] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_LogDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_LogDetails]
(
    [RecID] INT NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL,
    [ScriptCode] VARCHAR(50) NULL,
    [TypeOfOrder] VARCHAR(50) NULL,
    [SBCrAdditional] VARCHAR(50) NULL,
    [PaymentHistory] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_test
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_test]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_test_28112019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_test_28112019]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBLimitAllocation_testPladge
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBLimitAllocation_testPladge]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [SBCode] VARCHAR(50) NULL,
    [SBName] VARCHAR(100) NULL,
    [TotalLimitAvail] MONEY NULL,
    [TotalLimitGiven] MONEY NULL,
    [BalanceLimit] MONEY NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCredit] MONEY NULL,
    [EnterLimit] MONEY NULL,
    [TotalEnterLimit] MONEY NULL,
    [Segment] VARCHAR(50) NULL,
    [ClientCodeStatus] VARCHAR(50) NULL,
    [IntradayCode] VARCHAR(50) NULL,
    [LimitResponse] BIT NULL,
    [LimitResponseMesaage] VARCHAR(100) NULL,
    [ServerMapped] VARCHAR(50) NULL,
    [IpAddress] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDT] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SegmentMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SegmentMaster]
(
    [SrNo] INT NULL,
    [Segment] VARCHAR(50) NULL,
    [SegmentVal] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_TempLimitAvailed
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_TempLimitAvailed]
(
    [PARTY_NAME] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(100) NULL,
    [SB] VARCHAR(100) NULL,
    [LimitAvailed] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_TempLimitAvailed_10042019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_TempLimitAvailed_10042019]
(
    [PARTY_NAME] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(100) NULL,
    [SB] VARCHAR(100) NULL,
    [LimitAvailed] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_vintage
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_vintage]
(
    [SBTag] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.SBCategoryGoodWill_trig
-- --------------------------------------------------
CREATE trigger [dbo].SBCategoryGoodWill_trig      
on dbo.tbl_SBCategoryGoodWill      
for insert,update      
as      
begin   
 BEGIN TRY  
   if exists(select * from inserted) and not exists(select * from deleted) --in case of insert.      
    insert into tbl_SBCategoryGoodWill_log      
    select *, GETDATE(),'I'      
    from inserted       
   else if exists(select * from inserted) and exists(select * from deleted) --in case of Update.      
    insert into tbl_SBCategoryGoodWill_log      
    select *, GETDATE(),'U'      
    from inserted  
 END TRY  
 begin catch  
  SELECT   
        ERROR_NUMBER() AS ErrorNumber  
       ,ERROR_MESSAGE() AS ErrorMessage;  
 end catch  
end

GO

-- --------------------------------------------------
-- TRIGGER dbo.SBIndividual_trig
-- --------------------------------------------------
CREATE trigger [dbo].SBIndividual_trig        
on dbo.tbl_SBIndividual        
for insert,update,delete       
as        
begin     
 BEGIN TRY    
   if exists(select * from inserted) and not exists(select * from deleted) --in case of insert.        
    insert into tbl_SBIndividual_log        
    select *, GETDATE(),'I'        
    from inserted         
   else if exists(select * from inserted) and exists(select * from deleted) --in case of Update.        
    insert into tbl_SBIndividual_log        
    select *, GETDATE(),'U'        
    from inserted   
   else if not exists(select * from inserted) and exists(select * from deleted) --in case of Delete.      
    insert into OFS_ORDER_log      
    select *, GETDATE(),'D'      
    from deleted  
 END TRY    
 begin catch    
  SELECT     
        ERROR_NUMBER() AS ErrorNumber    
       ,ERROR_MESSAGE() AS ErrorMessage;    
 end catch    
end

GO

-- --------------------------------------------------
-- TRIGGER dbo.SBLimitAllocation_trig
-- --------------------------------------------------
CREATE trigger [dbo].SBLimitAllocation_trig      
on dbo.tbl_SBLimitAllocation      
for insert,update      
as      
begin   
 BEGIN TRY  
   if exists(select * from inserted) and not exists(select * from deleted) --in case of insert.      
    insert into tbl_SBLimitAllocation_log      
    select *, GETDATE(),'I'      
    from inserted       
   else if exists(select * from inserted) and exists(select * from deleted) --in case of Update.      
    insert into tbl_SBLimitAllocation_log      
    select *, GETDATE(),'U'      
    from inserted  
 END TRY  
 begin catch  
  SELECT   
        ERROR_NUMBER() AS ErrorNumber  
       ,ERROR_MESSAGE() AS ErrorMessage;  
 end catch  
end

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SBLimitEnhancer
-- --------------------------------------------------
Create View Vw_SBLimitEnhancer
As
select * from tbl_SBLimitAllocation with(nolock)

GO

