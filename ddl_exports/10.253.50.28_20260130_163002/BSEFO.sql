-- DDL Export
-- Server: 10.253.50.28
-- Database: BSEFO
-- Exported: 2026-01-30T16:30:26.991686

USE BSEFO;
GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertDigit
-- --------------------------------------------------

CREATE Function [dbo].[ConvertDigit] ( @MyDigit char(1)) returns varchar(10) 
	as 
	Begin
	 declare @vOutput varchar(8)
	 set @vOutput =  Case @MyDigit
	            when '1' then 'One'
	            when '2' then 'Two'
	            when '3' then 'Three'
	            when '4' then 'Four'
	            when '5' then 'Five'
	            when '6' then 'Six'
	            when '7' then 'Seven'
	            when '8' then 'Eight'
	            when '9' then 'Nine'
        	    Else '' end 
      	Return (@vOutPut)
	End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertHundreds
-- --------------------------------------------------
/*
Print dbo.ConvertHundreds('121')
*/
CREATE Function [dbo].[ConvertHundreds](@MyNumber varchar(3)) returns varchar(200)
as
Begin
	Declare @Result varchar(200)
	set @Result = ''
	-- Exit if there is nothing to convert.
	If convert(int,@MyNumber) <> 0 
	Begin
		--' Append leading zeros to number.
		set @MyNumber = Right('000' + @MyNumber, 3)
		--' Do we have a hundreds place digit to convert?
		If Left(@MyNumber, 1) <> '0' 
		Begin
			set @Result = dbo.ConvertDigit(Left(@MyNumber, 1)) + ' Hundred '
		End
		
		--' Do we have a tens place digit to convert?
		If SubString(@MyNumber, 2, 1) <> '0' 
		Begin
			set @Result = @Result + dbo.ConvertTens(SubString(@MyNumber, 2,2))
		End
		Else
		Begin
			--' If not, then convert the ones place digit.
			set @Result = @Result +  dbo.ConvertDigit(SubString(@MyNumber, 3,1))
		end
		
	End
	return (@Result)
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertIntoIndianCurEng
-- --------------------------------------------------
/*
Print dbo.ConvertIntoIndianCurEng('500.51')
*/

CREATE Function [dbo].[ConvertIntoIndianCurEng]( @MyNumber varchar(200)) returns varchar(200)
as
Begin
	Declare @Temp varchar(200),
	@Dollars varchar(200), @Cents varchar(100),
	@DecimalPlace int, @Count int , @Return varchar(200)
	
	--' Convert MyNumber to a string, trimming extra spaces.
	set @MyNumber = ltrim(rtrim(@mynumber))
	
	--' Find decimal place.
	set @DecimalPlace = CHARINDEX ('.',@MyNumber)

	set @Cents = ''
	set @Dollars = ''

	--' If we find decimal place...
	If @DecimalPlace > 0 
	Begin
		--' Convert cents
		set @Temp = Left(substring(@MyNumber, @DecimalPlace + 1,2) + '00', 2)
		set @Cents = dbo.ConvertTens(@Temp)
		--' Strip off cents from remainder to convert.
		set @MyNumber = Left(@MyNumber, @DecimalPlace - 1)
	End 

	

	set @Count = 1
	set @Temp = dbo.ConvertHundreds(Right(@MyNumber, 3))


	If @Temp <> '' 
		set @Dollars = @Temp + dbo.Place(@Count) + @Dollars
	
	If Len(@MyNumber) > 3 
		--' Remove last 3 converted digits from MyNumber.
		set @MyNumber = Left(@MyNumber, Len(@MyNumber) - 3)
	Else
		set @MyNumber = ''

	set @Count = @Count + 1

	While @MyNumber <> ''
	Begin
		--' Convert last 2 digits of MyNumber to Indian Rs.
		set @Temp = dbo.ConvertHundreds(Right(@MyNumber, 2))
		If @Temp <> '' 
			set @Dollars = @Temp + dbo.Place(@Count) + @Dollars

		If Len(@MyNumber) > 2 
			--' Remove last 2 converted digits from MyNumber.
			set @MyNumber = Left(@MyNumber, Len(@MyNumber) - 2)
		Else
			set @MyNumber = ''
		set @Count = @Count + 1
	end
	
	--' Clean up Rupees.

	set @Dollars = Case @Dollars
			when '' then 'Zero '
			when 'One' then 'One '
			Else @Dollars + ''
			end 

	
	--' Clean up cents.
	set @Cents  = Case @Cents
			when '' then '' 	--'Cents = " And zero Paise"
			when 'One' then ' And Paisa One '
			Else ' And ' +  'Paise ' + @Cents 
			end 
	

	set @Return =  @Dollars + @Cents + ' Only'
	Return (@Return) 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertTens
-- --------------------------------------------------

/*
Print dbo.ConvertTens(13)
*/
CREATE Function [dbo].[ConvertTens] (@MyTens char(2)) returns varchar(15)
  as 
  Begin
  Declare @Result varchar(15)
  
  -- Is value between 10 and 19?
	If Left(@MyTens, 1) = 1 
	Begin
		set  @Result = Case convert(int,(@MyTens))
		when 10 then 'Ten'
		when 11 then 'Eleven'
		when 12 then 'Twelve'
		when 13 then 'Thirteen'
		when 14 then 'Fourteen'
		when 15 then 'Fifteen'
		when 16 then 'Sixteen'
		when 17 then 'Seventeen'
		when 18 then 'Eighteen'
		when 19 then 'Nineteen'
		Else ''
		end 
	End
	Else
	Begin
		--' .. otherwise it's between 20 and 99.
		set  @Result = Case convert(int,Left(@MyTens, 1))
		when 2 then 'Twenty '
		when 3 then 'Thirty '
		when 4 then 'Forty '
		when 5 then 'Fifty '
		when 6 then 'Sixty '
		when 7 then 'Seventy '
		when 8 then 'Eighty '
		when 9 then 'Ninety '
		Else ''
		end 
		set @Result = @Result + dbo.ConvertDigit(Right(@MyTens, 1))
	End


    -- Convert ones place digit.
    
  Return (@Result)
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_GET_TBLREPORT
-- --------------------------------------------------



CREATE  FUNCTION [dbo].[FUN_GET_TBLREPORT](  
                @OLDSTRING VARCHAR(2000),  
                @NEWSTRING VARCHAR(2000))  
RETURNS  VARCHAR (8000)
AS

  
BEGIN 

    DECLARE @RETURNSTR VARCHAR(8000)
    SET @RETURNSTR =''

    DECLARE @DIFF_STRING  TABLE(  
    [STR1_VALUE] [VARCHAR](100) NOT NULL,  
    [STR2_VALUE] [VARCHAR](100) NOT NULL)  

    DECLARE      
	@REPCODE1 VARCHAR(10),
	@REPCODE2 VARCHAR(10),
	@TBLREPCUR CURSOR ,     
        @CATNAME VARCHAR(20)
  
  
	INSERT INTO @DIFF_STRING
	SELECT 
		STR1= CASE WHEN A.SPLITTED_VALUE IS NOT NULL THEN A.SPLITTED_VALUE ELSE '' END,
		STR2= CASE WHEN B.SPLITTED_VALUE IS NOT NULL THEN B.SPLITTED_VALUE ELSE '' END
	FROM
	(
		SELECT * FROM PRADNYA..FUN_SPLITSTRING(@OLDSTRING,',')
	) A
	 FULL OUTER JOIN
	(
		SELECT * FROM PRADNYA..FUN_SPLITSTRING(@NEWSTRING,',')
	) B
	 ON (A.SPLITTED_VALUE=B.SPLITTED_VALUE)
	WHERE A.SPLITTED_VALUE IS NULL OR B.SPLITTED_VALUE IS NULL
	

	SET @TBLREPCUR = CURSOR FOR  SELECT ISNULL(STR1_VALUE,''),ISNULL(STR2_VALUE,'') FROM  @DIFF_STRING
	OPEN @TBLREPCUR      
	     
	FETCH NEXT FROM @TBLREPCUR INTO @REPCODE1,@REPCODE2
	WHILE @@FETCH_STATUS = 0       
	BEGIN      
	      
	
	 IF @REPCODE1<>''
		BEGIN
			SET @CATNAME = NULL
			SELECT @CATNAME =FLDCATEGORYNAME FROM TBLCATEGORY (NOLOCK) WHERE FLDCATEGORYCODE = CONVERT(INT,@REPCODE1)
			SELECT @RETURNSTR = @RETURNSTR + '-' + ISNULL(@CATNAME,@REPCODE1) +', '
		END
	IF @REPCODE2<>''
		BEGIN
			SET @CATNAME = NULL
			SELECT @CATNAME =FLDCATEGORYNAME FROM TBLCATEGORY (NOLOCK)  WHERE FLDCATEGORYCODE = CONVERT(INT,@REPCODE2)
			SELECT @RETURNSTR = @RETURNSTR + '+' + ISNULL(@CATNAME,@REPCODE2) +', '
		END

	    
	 FETCH NEXT FROM @TBLREPCUR INTO @REPCODE1,@REPCODE2
	END      
	CLOSE @TBLREPCUR      
	DEALLOCATE @TBLREPCUR
     

	RETURN LEFT(@RETURNSTR,LEN(@RETURNSTR)-1)

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_PRINTF
-- --------------------------------------------------

  
CREATE FUNCTION [dbo].[FUN_PRINTF](  
                @PRINTF   VARCHAR(6))  
RETURNS @PRINTF_TAB TABLE (  
    [PRINTF] [TINYINT] NOT NULL)  
  
AS  
  
/* FUNCTION TO GET VALID PRINTF FLAGS FOR THE PURPOSES OF FILTERING IN CONTRACT PRINTING */  
BEGIN     
  IF @PRINTF = 'ALL'  
    BEGIN  
      INSERT INTO @PRINTF_TAB VALUES (0)  
      INSERT INTO @PRINTF_TAB VALUES (2)  
      INSERT INTO @PRINTF_TAB VALUES (3)  
      INSERT INTO @PRINTF_TAB VALUES (4)  
      INSERT INTO @PRINTF_TAB VALUES (5)  
    END  
  ELSE  
    IF @PRINTF = 'ECN'  
    BEGIN  
      INSERT INTO @PRINTF_TAB VALUES (2)  
    END  
  ELSE  
    IF @PRINTF = 'NONECN'  
    BEGIN  
      INSERT INTO @PRINTF_TAB VALUES (0)  
      INSERT INTO @PRINTF_TAB VALUES (3)  
      INSERT INTO @PRINTF_TAB VALUES (4)  
      INSERT INTO @PRINTF_TAB VALUES (5)  
    END  
  
  RETURN   
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING
-- --------------------------------------------------
  
create  FUNCTION [dbo].[FUN_SPLITSTRING](  
                @SPLITSTRING VARCHAR(8000),  
                @DELIMITER   VARCHAR(3))  
RETURNS @SPLITTED TABLE (  
    [SNO] [INT] IDENTITY(1,1) NOT NULL,   
    [SPLITTED_VALUE] [VARCHAR](100) NOT NULL)  
  
AS  
  
/* Split the String and get splitted values in the result-set. Delimiter upto 3 characters long can be used for splitting */  
BEGIN     
  DECLARE  @STRING         VARCHAR(8000),  
           @POSITION       INT,  
           @START_LOCATION INT,  
           @STRING_LENGTH  INT  
                             
  SET @STRING = @SPLITSTRING  
                  
  SET @POSITION = 0  
                    
  SET @START_LOCATION = 0  
                          
  SET @STRING_LENGTH = LEN(@STRING)  
                         
  WHILE @STRING_LENGTH > 0  
    BEGIN  
      
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)  
                        
      IF @POSITION = 0  
        BEGIN  
          INSERT INTO @SPLITTED  
          SELECT @STRING  
                   
          SET @STRING_LENGTH = 0  
                                 
        END  
      ELSE  
        BEGIN  
          INSERT INTO @SPLITTED  
          SELECT LEFT(@STRING,@POSITION - 1)  
                   
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)  
                          
          SET @STRING_LENGTH = LEN(@STRING)  
        END  
          
    END  
  
  RETURN   
  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING_2NUM
-- --------------------------------------------------



CREATE FUNCTION [dbo].[FUN_SPLITSTRING_2NUM](
                @SPLITSTRING VARCHAR(8000),
                @DELIMITER   VARCHAR(3))
RETURNS  INT
AS

BEGIN   

  DECLARE @INTRETURN INT
  DECLARE  @STRING         VARCHAR(8000),
           @POSITION       INT,
           @START_LOCATION INT,
           @STRING_LENGTH  INT
                           
  SET @STRING = @SPLITSTRING
                
  SET @POSITION = 0
                  
  SET @START_LOCATION = 0
  SET @INTRETURN = 0                    
  SET @STRING_LENGTH = LEN(@STRING)
                       
  WHILE @STRING_LENGTH > 0
    BEGIN
    
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)
                      
      IF @POSITION = 0
        BEGIN
          SET @INTRETURN = @INTRETURN +  CONVERT(INT,@STRING )                
          SET @STRING_LENGTH = 0
                               
        END
      ELSE
        BEGIN
          SET @INTRETURN = @INTRETURN + CONVERT(INT,LEFT(@STRING,@POSITION - 1))               
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)
                        
          SET @STRING_LENGTH = LEN(@STRING)
        END
        
    END


   RETURN  @INTRETURN
        
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[PIECE] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Place
-- --------------------------------------------------

CREATE Function [dbo].[Place](@Count as int ) Returns varchar(15)
as 
Begin
	Declare @Return varchar(15)
	set @Return = case @Count
			when 2 then ' Thousand '
			when 3 then ' Lakhs '
			when 4 then ' Crores '
			when 5 then ' Arab '
			else ''
			end
	Return(@Return)
End

GO

-- --------------------------------------------------
-- INDEX dbo.ACCBILL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[ACCBILL] ([SETT_NO], [SETT_TYPE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.Area
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxArea] ON [dbo].[Area] ([Branch_Code], [Areacode])

GO

-- --------------------------------------------------
-- INDEX dbo.BBGBFOSETTLEMENT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BBGBFOSETTLEMENT] ([SAUDA_DATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFoAccBill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [partycd] ON [dbo].[BFoAccBill] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOAdhocMargin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[BFOAdhocMargin] ([Sauda_Date], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOAdhocMargin_Exch
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[BFOAdhocMargin_Exch] ([Sauda_Date], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOAdhocMargin_Imp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[BFOAdhocMargin_Imp] ([Sauda_Date], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.BfoBillno
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[BfoBillno] ([BILLDATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOBILLVALAN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOBILLVALAN] ([SAUDA_DATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [SERIES_ID], [SERIES_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.bfoclearingchrg
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[bfoclearingchrg] ([Sauda_date], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOCLOSING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOCLOSING] ([TRADE_DATE], [PRODUCT_TYPE], [PRODUCT_CODE], [SERIES_ID], [SERIES_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOCLOSING_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOCLOSING_IMP] ([TRADE_DATE], [PRODUCT_TYPE], [PRODUCT_CODE], [SERIES_ID], [SERIES_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.Bfoerrorlog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxErr] ON [dbo].[Bfoerrorlog] ([ErrDate])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOERRTRADE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOERRTRADE] ([SAUDA_DATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOEXALLOCSETTLEMENT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOEXALLOCSETTLEMENT] ([SAUDA_DATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOEXALLOCTRADE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOEXALLOCTRADE] ([SAUDA_DATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOEXERCISEALLOCATION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOEXERCISEALLOCATION] ([POSITION_DATE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOEXERCISEALLOCATION_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOEXERCISEALLOCATION_IMP] ([POSITION_DATE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOEXPIRYSETTLEMENT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOEXPIRYSETTLEMENT] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFoFinalClosing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[BFoFinalClosing] ([ClosingDate], [Series_code])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOFTTRADE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOFTTRADE] ([SAUDA_DATE], [BUY_CLIENT_CODE], [SELL_CLIENT_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOFTTRADE_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOFTTRADE_IMP] ([SAUDA_DATE], [BUY_CLIENT_CODE], [SELL_CLIENT_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.bfofuttrade
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[bfofuttrade] ([Party_Code], [product_type], [product_code], [Series_code], [Series_id], [expirydate])

GO

-- --------------------------------------------------
-- INDEX dbo.bfoglobals_BKUP_14Aug2023
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxGl] ON [dbo].[bfoglobals_BKUP_14Aug2023] ([year_start_dt], [year_end_dt])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOMARGIN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOMARGIN] ([MARGIN_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOMARGIN_EXCH
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOMARGIN_EXCH] ([MARGIN_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOMARGIN_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOMARGIN_IMP] ([MARGIN_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.bfosett_mst
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxsr] ON [dbo].[bfosett_mst] ([Series_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOSETTLEMENT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOSETTLEMENT] ([SAUDA_DATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOSETTLEMENTEXPIRY
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOSETTLEMENTEXPIRY] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.bfoSpanMargin_intraday
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[bfoSpanMargin_intraday] ([Intradate])

GO

-- --------------------------------------------------
-- INDEX dbo.BFoSpMargin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[BFoSpMargin] ([Date])

GO

-- --------------------------------------------------
-- INDEX dbo.bfostat_trd
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[bfostat_trd] ([sysdate])

GO

-- --------------------------------------------------
-- INDEX dbo.bfotaxes
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[bfotaxes] ([Exchange])

GO

-- --------------------------------------------------
-- INDEX dbo.BfoTMinfo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTm] ON [dbo].[BfoTMinfo] ([TM_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOTRADE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOTRADE] ([SAUDA_DATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOTRADE1_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOTRADE1_IMP] ([TRD_DATE], [TRADE_NO], [ORDER_NO], [SCRIP_CD], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOTRADE2_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[BFOTRADE2_IMP] ([SAUDA_DATE], [TRADE_NO], [ORDER_NO], [SERIES_ID], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BranchBrokTable
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBrTbl] ON [dbo].[BranchBrokTable] ([Sr_No], [Branch_Code], [Table_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Branches
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Branches] ON [dbo].[Branches] ([Short_Name], [Branch_Cd], [Com_Perc])

GO

-- --------------------------------------------------
-- INDEX dbo.Branches
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Branchshort] ON [dbo].[Branches] ([Branch_Cd], [Short_Name], [Com_Perc])

GO

-- --------------------------------------------------
-- INDEX dbo.Branches
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Pk_Branches] ON [dbo].[Branches] ([Short_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.BranchPayMode
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxBrPmode] ON [dbo].[BranchPayMode] ([Sr_no], [Branch], [CltCode])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [bk] ON [dbo].[broktable] ([Table_No], [Line_No], [Trd_Del], [Val_perc], [Upper_lim])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [broktable_upperlim] ON [dbo].[broktable] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [tabnouplim] ON [dbo].[broktable] ([Table_No], [Upper_lim], [Line_No], [Val_perc], [Trd_Del], [Def_table])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [upperlim] ON [dbo].[broktable] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch], [sett_sales], [round_to])

GO

-- --------------------------------------------------
-- INDEX dbo.CHARGES_DETAIL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[CHARGES_DETAIL] ([CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_PRODUCT_TYPE], [CD_PRODUCT_CODE], [CD_SERIES_ID], [CD_SERIES_CODE], [CD_EXPIRYDATE], [CD_STRIKE_PRICE], [CD_OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableIndex] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableListing] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Client_Party_Modification_Tmp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Client_Party_Modification_Tmp] ([SrNo], [Old_Party_Code], [New_Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.client1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clcode] ON [dbo].[client1] ([Cl_Code], [trader], [Family])

GO

-- --------------------------------------------------
-- INDEX dbo.client1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[client1] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.client1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Tclcode] ON [dbo].[client1] ([trader], [Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.client2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clcode] ON [dbo].[client2] ([Cl_Code], [Party_code], [Tran_Cat])

GO

-- --------------------------------------------------
-- INDEX dbo.client2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[client2] ([Cl_Code], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.client2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partycode] ON [dbo].[client2] ([Party_code], [Cl_Code], [Tran_Cat], [brok_scheme])

GO

-- --------------------------------------------------
-- INDEX dbo.client2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Pk_Client2] ON [dbo].[client2] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Client2_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Indx_Log_Report] ON [dbo].[Client2_Log] ([Party_Code], [Logfld_When_109])

GO

-- --------------------------------------------------
-- INDEX dbo.Client2_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Party_Log_Ind] ON [dbo].[Client2_Log] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Client3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clcodeparty] ON [dbo].[Client3] ([Cl_Code], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.client4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clparty] ON [dbo].[client4] ([Cl_code], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.client4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clt4] ON [dbo].[client4] ([Party_code], [DefDp], [Depository], [BankID], [Cltdpid])

GO

-- --------------------------------------------------
-- INDEX dbo.Client5
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [clcodeidx] ON [dbo].[Client5] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientCharges
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxExchange] ON [dbo].[ClientCharges] ([Exchange], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientSettings
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[ClientSettings] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.clientstatus
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSt] ON [dbo].[clientstatus] ([Cl_Status])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientTaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partyfrom] ON [dbo].[ClientTaxes] ([Party_code], [FromDate], [ToDate])

GO

-- --------------------------------------------------
-- INDEX dbo.clienttype
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[clienttype] ([Cl_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.CLS_EXCH_IMPFILE_TYPE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXCD] ON [dbo].[CLS_EXCH_IMPFILE_TYPE] ([FILETYPE_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.CLS_TRADEFILE_TYPE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXCD] ON [dbo].[CLS_TRADEFILE_TYPE] ([FILETYPE_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.COMPANY_LOGO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXTYPE] ON [dbo].[COMPANY_LOGO] ([CL_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.ContLogin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[ContLogin] ([Sauda_date], [FromParty], [ToParty])

GO

-- --------------------------------------------------
-- INDEX dbo.Contract_Rounding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Contract_Rounding] ([CR_Party_Code], [CR_Date_From], [CR_Date_To])

GO

-- --------------------------------------------------
-- INDEX dbo.Custodian
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCust] ON [dbo].[Custodian] ([Custodiancode])

GO

-- --------------------------------------------------
-- INDEX dbo.DELIVERY_POSITION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[DELIVERY_POSITION] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.Email_Blank_Check
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxFlag] ON [dbo].[Email_Blank_Check] ([Email_Blank_Flag])

GO

-- --------------------------------------------------
-- INDEX dbo.Email_Login_User
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[Email_Login_User] ([Email_Login_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.Email_Partyreport
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxPartty] ON [dbo].[Email_Partyreport] ([Email_Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Email_Report_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[Email_Report_Log] ([Email_Report_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Email_Report_Settings
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxReport] ON [dbo].[Email_Report_Settings] ([Email_Report_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.ErrorLog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[ErrorLog] ([ErrDate])

GO

-- --------------------------------------------------
-- INDEX dbo.FO_POS_DETAILS_DAS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FO_POS_DETAILS_DAS] ([FOPDD_SAUDA_DATE], [FOPDD_PARTY_CODE], [FOPDD_INST_TYPE], [FOPDD_SYMBOL], [FOPDD_STRIKE_PRICE], [FOPDD_OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FO_TRADE_DETAILS_DAS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FO_TRADE_DETAILS_DAS] ([FOTDD_SAUDA_DATE], [FOTDD_PARTY_CODE], [FOTDD_INST_TYPE], [FOTDD_SYMBOL], [FOTDD_STRIKE_PRICE], [FOTDD_OPTION_TYPE], [FOTDD_EXPIRY_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FoClientBrokScheme
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[FoClientBrokScheme] ([Party_Code], [Date_From], [Date_To])

GO

-- --------------------------------------------------
-- INDEX dbo.FoClientTaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[FoClientTaxes] ([Party_Code], [Date_From], [Date_To])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMargin_Span
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[FoMargin_Span] ([Mdate], [Party_Code], [Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.IMP_FilePath
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxFl] ON [dbo].[IMP_FilePath] ([File_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Instclient_Tbl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[Instclient_Tbl] ([Partycode])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER_DETAILS_DAS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[LEDGER_DETAILS_DAS] ([LEDDD_SAUDA_DATE], [LEDDD_PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.LOG_PWDMAILS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[LOG_PWDMAILS] ([UPDATEDATE], [FLDID])

GO

-- --------------------------------------------------
-- INDEX dbo.MARGIN_REPORTING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [mindx] ON [dbo].[MARGIN_REPORTING] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.mcxucc
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [UV] ON [dbo].[mcxucc] ([Client Code])

GO

-- --------------------------------------------------
-- INDEX dbo.PartyMapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxPartyMap] ON [dbo].[PartyMapping] ([OldParty_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.paymentmode
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxP] ON [dbo].[paymentmode] ([paycode])

GO

-- --------------------------------------------------
-- INDEX dbo.Rating
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRt] ON [dbo].[Rating] ([Rating])

GO

-- --------------------------------------------------
-- INDEX dbo.Region
-- --------------------------------------------------
CREATE CLUSTERED INDEX [irdregion] ON [dbo].[Region] ([Regioncode], [Branch_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.roundparam
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRd] ON [dbo].[roundparam] ([RoundStyle])

GO

-- --------------------------------------------------
-- INDEX dbo.Sbu_Master
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSub] ON [dbo].[Sbu_Master] ([Sbu_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Scheme_Mapping] ([SP_Party_Code], [SP_Date_From], [SP_Date_To], [SP_Product_Type], [SP_Product_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxS] ON [dbo].[Scheme_Mapping] ([SP_Brok_ComputeType])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxScheme] ON [dbo].[Scheme_Master] ([SM_Scheme_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.Schemes
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSc] ON [dbo].[Schemes] ([schemeID])

GO

-- --------------------------------------------------
-- INDEX dbo.Scrip1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cocode] ON [dbo].[Scrip1] ([Co_Code], [Series])

GO

-- --------------------------------------------------
-- INDEX dbo.Scrip1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Scrip1] ([Co_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Scrip2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cocode] ON [dbo].[Scrip2] ([Co_Code], [Scrip_Cd], [Series])

GO

-- --------------------------------------------------
-- INDEX dbo.Scrip2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Scrip2] ([Co_Code], [Scrip_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Scrip2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl2] ON [dbo].[Scrip2] ([Scrip_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Scrip2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxcl3] ON [dbo].[Scrip2] ([Exchange])

GO

-- --------------------------------------------------
-- INDEX dbo.SPANMARGIN_IMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[SPANMARGIN_IMP] ([ACCT])

GO

-- --------------------------------------------------
-- INDEX dbo.Spanmargin_Intraday
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Intradate] ON [dbo].[Spanmargin_Intraday] ([Acct], [Intradate])

GO

-- --------------------------------------------------
-- INDEX dbo.State_Master
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxState] ON [dbo].[State_Master] ([State])

GO

-- --------------------------------------------------
-- INDEX dbo.Stt_Clientdetail_BKUP_10Aug2023
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxStt] ON [dbo].[Stt_Clientdetail_BKUP_10Aug2023] ([Party_Code], [Rectype], [Sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_ADDITIONAL_TAX_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXADDTAX1] ON [dbo].[TBL_ADDITIONAL_TAX_DATA] ([SAUDA_DATE], [PARTY_CODE], [CONTRACTNO], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE], [SELL_BUY])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_clientmargin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partydate] ON [dbo].[tbl_clientmargin] ([Party_Code], [Margindate])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_COLLATERAL_MARGIN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[TBL_COLLATERAL_MARGIN] ([EFFDATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTOMPREMIUMBILL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[TBL_MTOMPREMIUMBILL] ([BILLDATE], [PARTY_CODE], [PRODUCT_TYPE], [PRODUCT_CODE], [SERIES_ID], [SERIES_CODE], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_TURNOVER_SLAB_SYMBOL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXTAX] ON [dbo].[TBL_TURNOVER_SLAB_SYMBOL] ([INST_TYPE], [SYMBOL])

GO

-- --------------------------------------------------
-- INDEX dbo.tbladmin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[tbladmin] ([fldauto_admin])

GO

-- --------------------------------------------------
-- INDEX dbo.TblAdminconfig
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TblAdminconfig] ([Fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.tblcategory
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [categoryidx] ON [dbo].[tblcategory] ([fldcategorycode])

GO

-- --------------------------------------------------
-- INDEX dbo.tblcatmenu
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[tblcatmenu] ([fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCATMENU_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXREP] ON [dbo].[TBLCATMENU_LOG] ([Fldreportcode], [Fldadminauto], [CREATED_ON])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXLOGIN] ON [dbo].[TBLCLASSUSERLOGINS] ([FLDUSERNAME], [FLDSESSION], [FLDIPADDRESS])

GO

-- --------------------------------------------------
-- INDEX dbo.tblmenuhead
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxMenu] ON [dbo].[tblmenuhead] ([fldmenucode])

GO

-- --------------------------------------------------
-- INDEX dbo.tblPradnyausers
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[tblPradnyausers] ([fldauto], [fldadminauto])

GO

-- --------------------------------------------------
-- INDEX dbo.tblreportgrp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRpr] ON [dbo].[tblreportgrp] ([fldreportgrp], [fldmenugrp])

GO

-- --------------------------------------------------
-- INDEX dbo.tblreports
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxReport] ON [dbo].[tblreports] ([fldreportcode])

GO

-- --------------------------------------------------
-- INDEX dbo.TblReports_Blocked
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRpt] ON [dbo].[TblReports_Blocked] ([fldadminauto], [Fldreportcode])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[tblUserControlGlobals] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [AutoIDx] ON [dbo].[tblUserControlMaster] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[tblUserControlMaster_Jrnl] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.termparty
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [TermParty_Inx] ON [dbo].[termparty] ([ProCli])

GO

-- --------------------------------------------------
-- INDEX dbo.termparty
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [TermParty_User] ON [dbo].[termparty] ([UserId])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Bill_Digital_TEXT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[V2_Bill_Digital_TEXT] ([C_Type], [C_SR_NO])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_BillPrint_Setting
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[V2_BillPrint_Setting] ([Rpt_Type], [Rpt_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_BUSINESS_PROCESS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[V2_BUSINESS_PROCESS] ([BUSINESS_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Contract_Digital_TEXT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[V2_Contract_Digital_TEXT] ([C_Type], [C_SR_NO])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Digital_File_Name
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[V2_Digital_File_Name] ([D_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LOGIN_ERR_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[V2_LOGIN_ERR_LOG] ([LOGIN_DT])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Login_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxUser] ON [dbo].[V2_Login_Log] ([AddDt], [UserId])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Report_Access_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxReport] ON [dbo].[V2_Report_Access_Log] ([Sno])

GO

-- --------------------------------------------------
-- INDEX dbo.ValanAccount
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAcc] ON [dbo].[ValanAccount] ([AcCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Client_Print_Settings
-- --------------------------------------------------
ALTER TABLE [dbo].[Client_Print_Settings] ADD CONSTRAINT [Pk_Client_Print_Settings] PRIMARY KEY ([Print_Flag])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Delpartyflag
-- --------------------------------------------------
ALTER TABLE [dbo].[Delpartyflag] ADD CONSTRAINT [Pk_Delpartyflag] PRIMARY KEY ([Party_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Multicltid
-- --------------------------------------------------
ALTER TABLE [dbo].[Multicltid] ADD CONSTRAINT [PK_Multicltid_1] PRIMARY KEY ([Party_Code], [Cltdpno], [Dpid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_CLIENT_GST_DATA
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_CLIENT_GST_DATA] ADD CONSTRAINT [PK_TBL_CLIENT_GST_DATA] PRIMARY KEY ([PARTY_CODE], [EFF_FROM_DATE], [EFF_TO_DATE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblUserControlMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tblUserControlMaster] ADD CONSTRAINT [PK_TBLUSERCONTROLMASTER] PRIMARY KEY ([FLDUSERID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBLUSERPASSHIST
-- --------------------------------------------------
ALTER TABLE [dbo].[TBLUSERPASSHIST] ADD CONSTRAINT [PK_TBLUSERPASSHIST] PRIMARY KEY ([FLDAUTO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Ucc_Client
-- --------------------------------------------------
ALTER TABLE [dbo].[Ucc_Client] ADD CONSTRAINT [Pk_Ucc_Client] PRIMARY KEY ([Party_Code])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_SHARE_PROC_INSERT
-- --------------------------------------------------
CREATE PROC [DBO].[ADD_CLIENT_SHARE_PROC_INSERT] (
@EXCHANGE VARCHAR(3), 
@SEGMENT VARCHAR(7), 
@BRANCH_CD VARCHAR(10), 
@FROMPARTY VARCHAR(10),
@TOPARTY VARCHAR(10),
@MAINDATE VARCHAR(30),
@DETDATE VARCHAR(30)
) AS
UPDATE OWNER SET MEMBERCODE = MEMBERCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_SHARE_PROC_UPDATE
-- --------------------------------------------------



/****** OBJECT:  STORED PROCEDURE DBO.ADD_CLIENT_SHARE_PROC_UPDATE    SCRIPT DATE: 01/18/2006 12:58:59 ******/    
CREATE PROC [dbo].[ADD_CLIENT_SHARE_PROC_UPDATE] (      
@EXCHANGE VARCHAR(3),       
@SEGMENT VARCHAR(7),       
@BRANCH_CD VARCHAR(10),       
@FROMPARTY VARCHAR(10),      
@TOPARTY VARCHAR(10),      
@MAINDATE VARCHAR(30),      
@DETDATE VARCHAR(30)      
) AS      
/*      
STATUS = 'U', IMP_STATUS = '0' -- FOR FRESH INSERT      
IF IMP_STATUS = '0' THEN --DON'T UPDATE STATUS FEILD      
ELSE --UPDATE STATUS FEILD AS 'U'AND IMP_STATUS AS '0'      
*/      
      
TRUNCATE TABLE CLIENT_DETAILS_TMP      
TRUNCATE TABLE CLIENT_BROK_DETAILS_TMP      
TRUNCATE TABLE CLIENT_PARTY_MODIFICATION_TMP  
  
INSERT INTO CLIENT_DETAILS_TMP      
SELECT C.*       
       FROM MSAJAG.DBO.CLIENT_DETAILS C, MSAJAG.DBO.CLIENT_BROK_DETAILS D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE      
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')  
      -- AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'      
       AND C.BRANCH_CD LIKE @BRANCH_CD      
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY       
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE  
       
	 
      
INSERT INTO CLIENT_BROK_DETAILS_TMP      
SELECT D.*       
       FROM MSAJAG.DBO.CLIENT_DETAILS C, MSAJAG.DBO.CLIENT_BROK_DETAILS D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE      
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')   
      -- AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'      
       AND C.BRANCH_CD LIKE @BRANCH_CD      
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY       
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE      
  
UPDATE CLIENT_BROK_DETAILS_TMP SET Rounding_Method='ACTUAL'WHERE Rounding_Method=''

INSERT INTO CLIENT_PARTY_MODIFICATION_TMP  
SELECT OLD_PARTY_CODE,NEW_PARTY_CODE,BRANCH_CD,SUB_BROKER,TRADER,FAMILY,AREA,REGION,STATUS,  
ADDEDBY,ADDEDON,UPDATEDON  
FROM ANAND1.MSAJAG.DBO.CLIENT_PARTY_MODIFICATION  
WHERE STATUS = 0  
  
DELETE FROM CLIENT1 WHERE CL_CODE IN ( SELECT C.CL_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE)      
      
/* CLIENT1 INSERT QUERY */      
INSERT INTO CLIENT1      
SELECT C.CL_CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,FAX,RES_PHONE1,      
RES_PHONE2,OFF_PHONE1,OFF_PHONE2,EMAIL,BRANCH_CD,CREDIT_LIMIT,CL_TYPE,CL_STATUS,GL_CODE=PAYLOCATION,FD_CODE=SEBI_REGN_NO,FAMILY,      
PENALTY=0,SUB_BROKER,CONFIRM_FAX=0,PHONEOLD='',L_ADDRESS3,MOBILE_PAGER,PAN_GIR_NO,TRADER,WARD_NO,REGION,AREA,CLRATING=CLIENT_RATING     
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
      
DELETE FROM CLIENT2 WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE )      
      
/* CLIENT2 INSERT QUERY */      
INSERT INTO CLIENT2      
SELECT C.CL_CODE,D.EXCHANGE,TRAN_CAT='TRD',SCRIP_CAT=0,PARTY_CODE=C.CL_CODE,TRD_BROK,DEL_BROK,MARGIN=0,      
TURNOVER_TAX=FUT_TRAN_CHRGS,      
SEBI_TURN_TAX=FUT_SEBI_FEES,      
INSURANCE_CHRG=FUT_STT,      
SER_TAX,STD_RATE=FUT_BROK,P_TO_P=0,      
EXPOSURE_LIM=0,DEMAT_TABLENO=DEL_BROK,BANKID=PARTICIPANT_CODE,CLTDPNO=CUSTODIAN_CODE,PRINTF=PRINT_OPTIONS,      
ALBMDELCHRG=0,ALBMDELIVERY=0,ALBMCF_TABLENO=0,MF_TABLENO=DEL_BROK,SB_TABLENO=0,      
BROK1_TABLENO=FUT_FUT_FIN_BROK,BROK2_TABLENO=FUT_OPT_BROK,BROK3_TABLENO=0,      
BROKERNOTE=FUT_STAMP_DUTY,      
OTHER_CHRG=FUT_OTHER_CHRGS,      
D.BROK_SCHEME,CONTCHARGE=0,MINCONTAMT=0,ADDLEDGERBAL=0,DUMMY1=FUT_BROK_APPLICABLE,      
DUMMY2=FUT_OPT_EXC,INSCONT=(CASE WHEN INST_CONTRACT = '' OR INST_CONTRACT IS NULL THEN 'N' ELSE INST_CONTRACT END),SERTAXMETHOD=SER_TAX_METHOD,DUMMY6=STP_PROVIDER,      
DUMMY7=STP_RP_STYLE,DUMMY8=REL_MGR,DUMMY9=SBU,DUMMY10=C_GROUP, PARENTCODE, PRODUCTCODE  
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
      
DELETE FROM CLIENT3 WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE)      
      
/* CLIENT3 INSERT QUERY */      
INSERT INTO CLIENT3      
SELECT C.CL_CODE,C.PARTY_CODE,EXCHANGE,MARKETTYPE=SEGMENT,MARGIN=0,NOOFTIMES=0,MARGIN_RECD=CHARGED,MTOM=0,      
PMARGINRATE=MULTIPLIER,MTOMDATE=GETDATE(),INITIALMARGIN=CHARGED,MAINENANCETMARGIN=MAINTENANCE,MARGINEXCHANGE=REQD_BY_EXCH,MARGINBROKER=0,      
DUMMY1=0,DUMMY2=0      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE  
      
INSERT INTO CLIENT4      
SELECT C.CL_CODE,PARTY_CODE,INSTRU=0,BANKID=DPID1,CLTDPID1,DEPOSITORY1,DEF=1       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID1 <> '' AND CLTDPID1 <> ''       
AND DEPOSITORY1 IN ('NSDL', 'CDSL')       
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY IN ('NSDL', 'CDSL') )      
      
INSERT INTO MULTICLTID      
SELECT PARTY_CODE, CLTDPID1, DPID1, LONG_NAME, DEPOSITORY1, POA1       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID1 <> '' AND CLTDPID1 <> ''       
AND DEPOSITORY1 IN ('NSDL', 'CDSL')      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID1 AND CLTDPNO = CLTDPID1)      
      
/* MULTICLTID INSERT QUERY */      
INSERT INTO MULTICLTID      
SELECT PARTY_CODE, CLTDPID2, DPID2, LONG_NAME, DEPOSITORY2, POA2       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID2 <> '' AND CLTDPID2 <> ''      
AND DEPOSITORY2 IN ('NSDL', 'CDSL')      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID2 AND CLTDPNO = CLTDPID2)      
      
/* MULTICLTID INSERT QUERY */      
INSERT INTO MULTICLTID      
SELECT PARTY_CODE, CLTDPID3, DPID3, LONG_NAME, DEPOSITORY3, POA3       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID3 <> '' AND CLTDPID3 <> ''      
AND DEPOSITORY3 IN ('NSDL', 'CDSL')      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID3 AND CLTDPNO = CLTDPID3)      
      
DELETE FROM CLIENT4 WHERE CL_CODE IN ( SELECT C.CL_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE )      
       AND DEPOSITORY NOT IN ('NSDL', 'CDSL')      
      
INSERT INTO POBANK (BANK_NAME,BRANCH_NAME)      
SELECT DISTINCT BANK_NAME, BRANCH_NAME       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE      
       AND BANK_NAME NOT IN (SELECT BANK_NAME FROM POBANK WHERE POBANK.BANK_NAME = C.BANK_NAME AND POBANK.BRANCH_NAME = C.BRANCH_NAME )      
      
/* CLIENT4 INSERT QUERY */      
INSERT INTO CLIENT4      
SELECT C.CL_CODE,PARTY_CODE,INSTRU=1,BANKID=P.BANKID,CLTDPID=AC_NUM,      
DEPOSITORY=ISNULL((CASE WHEN AC_TYPE = 'S' THEN 'SAVING'       
                        WHEN AC_TYPE = 'C' THEN 'CURRENT'       
                        ELSE 'OTHER' END), 'OTHER'),      
DEF=0      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, POBANK P      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE      
AND AC_TYPE <> ''      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY NOT IN ('CDSL','NSDL'))      
AND P.BANK_NAME = C.BANK_NAME AND P.BRANCH_NAME = C.BRANCH_NAME      
       
DELETE FROM CLIENT5 WHERE CL_CODE IN ( SELECT C.CL_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE)      
      
/* CLIENT5 INSERT QUERY */      
INSERT INTO CLIENT5      
SELECT C.CL_CODE,BIRTHDATE=DOB,SEX,ACTIVEFROM=ACTIVE_DATE,INTERACTMODE,      
REPATRIATAC=(CASE WHEN LEN(REPATRIAT_BANK) = 0 THEN 1 ELSE 0 END),      
REPATRIATBANK=REPATRIAT_BANK,REPATRIATACNO=REPATRIAT_BANK_AC_NO,      
INTRODUCER,APPROVER,KYCFORM=CHK_KYC_FORM,BANKCERT=CHK_BANK_CERTIFICATE,      
PASSPORT=(CASE WHEN PASSPORT_NO <> '' THEN 1 ELSE 0 END), PASSPORTDTL=PASSPORT_NO,      
VOTERSID=(CASE WHEN VOTERSID_NO <> '' THEN 1 ELSE 0 END), VOTERSIDDTL = VOTERSID_NO,      
ITRETURN=(CASE WHEN IT_RETURN_YR <> '' THEN 1 ELSE 0 END), ITRETURNDTL=IT_RETURN_YR,      
DRIVELICEN=(CASE WHEN LICENCE_NO <> '' THEN 1 ELSE 0 END), DRIVELICENDTL = LICENCE_NO,      
RATIONCARD=(CASE WHEN RAT_CARD_NO <> '' THEN 1 ELSE 0 END), RATIONCARDDTL = RAT_CARD_NO,      
CORPDTLRECD=CHK_CORPORATE_DEED,CORPDEED=CHK_CORP_DTLS_RECD,      
ANUALREPORT=CHK_ANNUAL_REPORT,NETWORTHCERT=CHK_NETWORTH_CERT,INACTIVEFROM=INACTIVE_FROM,      
P_ADDRESS1,P_ADDRESS2,P_ADDRESS3,P_CITY,P_STATE,P_NATION,P_PHONE,P_ZIP,ADDEMAILID,      
PASSPORTDATEOFISSUE=PASSPORT_ISSUED_ON,PASSPORTPLACEOFISSUE=PASSPORT_ISSUED_AT,      
VOTERIDDATEOFISSUE=VOTERSID_ISSUED_ON,VOTERIDPLACEOFISSUE=VOTERSID_ISSUED_AT,      
ITRETURNDATEOFFILING=IT_RETURN_FILED_ON,LICENCENODATEOFISSUE=LICENCE_ISSUED_ON,      
LICENCENOPLACEOFISSUE=LICENCE_ISSUED_AT,RATIONCARDDATEOFISSUE=RAT_CARD_ISSUED_ON,      
RATIONCARDPLACEOFISSUE=RAT_CARD_ISSUED_AT,CLIENT_AGRE_DT=CLIENT_AGREEMENT_ON,REGR_NO=REGR_NO,      
REGR_PLACE=REGR_AT,REGR_DATE=REGR_ON,REGR_AUTH=REGR_AUTHORITY,INTROD_CLIENT_ID=INTRODUCER_ID,      
INTROD_RELATION=INTRODUCER_RELATION,      
ANY_OTHER_ACC=OTHER_AC_NO,SETT_MODE,DEALING_WITH_OTHRER_TM=ISNULL(DEALING_WITH_OTHER_TM,''),      
SYSTUMDATE=SYSTEMDATE,PASSPORTEXPDATE=PASSPORT_EXPIRES_ON,DRIVEEXPDATE=LICENCE_EXPIRES_ON,DIRECTOR_NAME       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE      
      
DELETE FROM INSTCLIENT_TBL WHERE PARTYCODE IN ( SELECT PARTY_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE )      
      
/* INSTCLIENT_TBL INSERT QUERY */      
INSERT INTO INSTCLIENT_TBL      
SELECT PARTY_CODE, ROUNDMARKETRATE, ROUNDBROKERAGE, ROUNDNETRATE, NO_OF_COPIES, RES1 = 0, RES2 = 0, RES3 = 0, RES4 = 0      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, ROUNDPARAM R      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND D.ROUND_STYLE = R.ROUNDSTYLE      
  
IF @SEGMENT = 'CAPITAL' OR @SEGMENT = 'SLBS'   
BEGIN  
 UPDATE CLIENTBROK_SCHEME SET TO_DATE = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE       
      AND C.PARTY_CODE = CLIENTBROK_SCHEME.PARTY_CODE      
      AND TO_DATE LIKE 'DEC 31 2049%'      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD NORMAL */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL NORMAL */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD INS */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = INST_TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL INS */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = INST_DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 UPDATE CLIENTTAXES_NEW SET TODATE = TRD_EFF_DT - 1       
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE       
      AND C.PARTY_CODE = CLIENTTAXES_NEW.PARTY_CODE      
      AND CLIENTTAXES_NEW.TODATE LIKE 'DEC 31 2049%'      
         
 /* CLIENTTAXES_NEW INSERT QUERY FOR TRD */      
 INSERT INTO CLIENTTAXES_NEW      
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'TRD', INSURANCE_CHRG = TRD_STT,      
 TURNOVER_TAX = TRD_TRAN_CHRGS, OTHER_CHRG = TRD_OTHER_CHRGS, SEBITURN_TAX = TRD_SEBI_FEES,       
 BROKER_NOTE = TRD_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,       
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(TRD_EFF_DT,11),      
 TODATE = 'DEC 31 2049 23:59',       
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,       
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'       
                THEN 0.5      
                WHEN ROUNDING_METHOD = 'NEXT'      
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN -0.01      
                           ELSE -0.1      
                      END)                     
         WHEN ROUNDING_METHOD = 'PREVIOUS'       
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1  
                           THEN 0.000001     
                           ELSE 0.000001  
                      END)                     
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'  
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5      
                           THEN -2.5      
                           ELSE 2.5      
                      END)                     
           END ),       
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTTAXES_NEW INSERT QUERY FOR DEL */      
 INSERT INTO CLIENTTAXES_NEW      
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'DEL', INSURANCE_CHRG = DEL_STT,      
 TURNOVER_TAX = DEL_TRAN_CHRGS, OTHER_CHRG = DEL_OTHER_CHRGS, SEBITURN_TAX = DEL_SEBI_FEES,       
 BROKER_NOTE = DEL_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,       
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(DEL_EFF_DT,11),       
 TODATE = 'DEC 31 2049 23:59',       
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,       
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'       
                THEN 0.5      
                WHEN ROUNDING_METHOD = 'NEXT'      
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN -0.01      
                           ELSE -0.1      
                      END)                     
         WHEN ROUNDING_METHOD = 'PREVIOUS'       
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN 0.000001      
                           ELSE 0.000001      
                      END)                     
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'  
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5      
                           THEN -2.5      
                           ELSE 2.5      
                      END)                     
           END ),       
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE   
  
 DELETE FROM CLIENTTAXES_NEW WHERE FROMDATE > TODATE  
 DELETE FROM CLIENTBROK_SCHEME WHERE FROM_DATE > TO_DATE  
  
END  
  
IF @SEGMENT = 'FUTURES'  
BEGIN  

 UPDATE CLIENT_BROK_DETAILS_TMP SET BROK_EFF_DATE = LEFT(GETDATE (),11),
 TRD_STT = (CASE WHEN FUT_STT = 1 THEN insurance_chrg ELSE 0 END),
 TRD_TRAN_CHRGS = (CASE WHEN FUT_TRAN_CHRGS = 1 THEN TURNOVER_TAX ELSE 0 END),
 TRD_OTHER_CHRGS = (CASE WHEN FUT_OTHER_CHRGS = 1 THEN OTHER_CHRG ELSE 0 END),
 TRD_SEBI_FEES = (CASE WHEN FUT_SEBI_FEES = 1 THEN SEBITURN_TAX ELSE 0 END),
 TRD_STAMP_DUTY = (CASE WHEN FUT_STAMP_DUTY = 1 THEN BROKER_NOTE ELSE 0 END)
 FROM BFOTAXES 
 WHERE TRANS_CAT = 'TRD'
 AND GETDATE() BETWEEN FROM_DATE AND TO_DATE

  UPDATE CLIENT_BROK_DETAILS_TMP SET BROK_EFF_DATE = LEFT(GETDATE (),11),
 DEL_STT = (CASE WHEN FUT_STT = 1 THEN insurance_chrg ELSE 0 END),
 DEL_TRAN_CHRGS = (CASE WHEN FUT_TRAN_CHRGS = 1 THEN TURNOVER_TAX ELSE 0 END),
 DEL_OTHER_CHRGS = (CASE WHEN FUT_OTHER_CHRGS = 1 THEN OTHER_CHRG ELSE 0 END),
 DEL_SEBI_FEES = (CASE WHEN FUT_SEBI_FEES = 1 THEN SEBITURN_TAX ELSE 0 END),
 DEL_STAMP_DUTY = (CASE WHEN FUT_STAMP_DUTY = 1 THEN BROKER_NOTE ELSE 0 END)
 FROM BFOTAXES 
 WHERE TRANS_CAT = 'DEL'
 AND GETDATE() BETWEEN FROM_DATE AND TO_DATE

 UPDATE FOCLIENTBROKSCHEME SET DATE_TO = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT  
 AND C.CL_CODE = D.CL_CODE       
 AND C.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE      
 AND DATE_TO LIKE 'DEC 31 2049%'  
  
 INSERT INTO FOCLIENTBROKSCHEME      
 SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59:59',  
 FUT_BROKTABLE = FUT_BROK, OPT_BROKTABLE = FUT_OPT_BROK,   
 FUT_EXP_BROKTABLE = FUT_FUT_FIN_BROK, OPT_EXC_BROKTABLE = FUT_OPT_EXC,  
 COMM_DEL_BROKTABLE = DEL_BROK, BROK_SCHEME,   
 OPT_BROK_COMPUTEON = (CASE WHEN FUT_BROK_APPLICABLE = 0  
           THEN 'PRICE'   
       WHEN FUT_BROK_APPLICABLE = 1  
       THEN 'SPRICE'     
           ELSE 'SSPRICE'   
          END)  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE  
  
 UPDATE FOCLIENTTAXES SET DATE_TO = TRD_EFF_DT - 1       
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE       
 AND C.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE      
 AND FOCLIENTTAXES.DATE_TO LIKE 'DEC 31 2049%'  
  
 INSERT INTO FOCLIENTTAXES      
 SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59',  
 FUT_INSURANCE_CHRG = TRD_STT, FUT_TURNOVER_TAX = TRD_TRAN_CHRGS,   
 FUT_OTHER_CHRG = TRD_OTHER_CHRGS, FUT_SEBITURN_TAX = TRD_SEBI_FEES,       
 FUT_BROKER_NOTE = TRD_STAMP_DUTY,  
 OPT_INSURANCE_CHRG = DEL_STT, OPT_TURNOVER_TAX = DEL_TRAN_CHRGS,   
 OPT_OTHER_CHRG = DEL_OTHER_CHRGS, OPT_SEBITURN_TAX = DEL_SEBI_FEES,       
 OPT_BROKER_NOTE = DEL_STAMP_DUTY,  
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,       
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'       
                THEN 0.5      
                WHEN ROUNDING_METHOD = 'NEXT'      
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN -0.01      
                           ELSE -0.1      
                      END)                     
         WHEN ROUNDING_METHOD = 'PREVIOUS'       
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1  
                           THEN 0.000001   
                           ELSE 0.000001    
                      END)                     
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'  
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5      
                           THEN -2.5      
                           ELSE 2.5      
                      END)                     
           END ),       
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE  
  
 DELETE FROM FOCLIENTTAXES WHERE DATE_FROM > DATE_TO  
 DELETE FROM FOCLIENTBROKSCHEME WHERE DATE_FROM > DATE_TO  
  
END  
  
IF @SEGMENT = 'SLBS'  
BEGIN  
 UPDATE CLIENT_DETAILS_TMP SET UCC_CODE = ISNULL(U.UCC_CODE, '')   
 FROM UCC_CLIENT U  
 WHERE U.PARTY_CODE = CLIENT_DETAILS_TMP.PARTY_CODE  
END  
  
DELETE FROM UCC_CLIENT      
WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE)       
      
INSERT INTO UCC_CLIENT      
SELECT PARTY_CODE, LONG_NAME, CONTRACT_PERSON = INTRODUCER, CLEARINGNO1 = '', CLEARINGNO2 = '', CLEARINGNO3 = '',      
CLEARINGNO4 = '', MAPIDID = MAPIN_ID, FMCODE = FMCODE, DEALING_WITH_OTHER_TM, ANY_OTHER_ACC = OTHER_AC_NO,       
FAMILY_CODE1 = '', FAMILY_CODE2 = '', FAMILY_CODE3 = '', FAMILY_CODE4 = '', REMARK = '', UCC_CODE,       
STPPROVIDER = '', DUMMY1 = '', DUMMY2 = ''      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE  
  
DELETE FROM DELPARTYFLAG     
WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE)       
  
INSERT INTO DELPARTYFLAG  
SELECT PARTY_CODE, DEBIT_BALANCE, INTER_SETT  
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE  
  
DELETE FROM CLIENT4 WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)  
AND DEPOSITORY IN ('NSDL', 'CDSL')  
  
DELETE FROM MULTICLTID WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)  


------------------------GST

UPDATE TBL_CLIENT_GST_DATA SET EFF_TO_DATE = LEFT(GETDATE()-1,11) + ' 23:59:59'
FROM CLIENT_DETAILS_TMP
WHERE TBL_CLIENT_GST_DATA.PARTY_CODE = CLIENT_DETAILS_TMP.CL_CODE
AND EFF_TO_DATE >= LEFT(GETDATE(),11)

DELETE FROM TBL_CLIENT_GST_DATA
WHERE EFF_FROM_DATE > EFF_TO_DATE

INSERT INTO TBL_CLIENT_GST_DATA 
SELECT PARTY_CODE, BRANCH_CD, SUB_BROKER, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE, L_ZIP, L_NATION, GST_NO, GST_LOCATION,
EFF_FROM_DATE = LEFT(GETDATE(),11), EFF_TO_DATE = 'DEC 31 2049 23:59:59', CREATED_ON = GETDATE()
FROM CLIENT_DETAILS_TMP

--------------------------END GST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_SHARE_PROC_UPDATE_23122011
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.ADD_CLIENT_SHARE_PROC_UPDATE    SCRIPT DATE: 01/18/2006 12:58:59 ******/      
CREATE PROC [dbo].[ADD_CLIENT_SHARE_PROC_UPDATE_23122011] (        
@EXCHANGE VARCHAR(3),         
@SEGMENT VARCHAR(7),         
@BRANCH_CD VARCHAR(10),         
@FROMPARTY VARCHAR(10),        
@TOPARTY VARCHAR(10),        
@MAINDATE VARCHAR(30),        
@DETDATE VARCHAR(30)        
) AS        
/*        
STATUS = 'U', IMP_STATUS = '0' -- FOR FRESH INSERT        
IF IMP_STATUS = '0' THEN --DON'T UPDATE STATUS FEILD        
ELSE --UPDATE STATUS FEILD AS 'U'AND IMP_STATUS AS '0'        
*/        
        
TRUNCATE TABLE CLIENT_DETAILS_TMP        
TRUNCATE TABLE CLIENT_BROK_DETAILS_TMP        
TRUNCATE TABLE CLIENT_PARTY_MODIFICATION_TMP    
    
INSERT INTO CLIENT_DETAILS_TMP        
SELECT C.*         
       FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C, ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE        
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')    
       AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'        
       AND C.BRANCH_CD LIKE @BRANCH_CD        
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY         
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE        
        
INSERT INTO CLIENT_BROK_DETAILS_TMP        
SELECT D.*         
       FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C, ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE        
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')     
       AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'        
       AND C.BRANCH_CD LIKE @BRANCH_CD        
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY         
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE        
    
INSERT INTO CLIENT_PARTY_MODIFICATION_TMP    
SELECT OLD_PARTY_CODE,NEW_PARTY_CODE,BRANCH_CD,SUB_BROKER,TRADER,FAMILY,AREA,REGION,STATUS,    
ADDEDBY,ADDEDON,UPDATEDON    
FROM anand1.MSAJAG.DBO.CLIENT_PARTY_MODIFICATION    
WHERE STATUS = 0    
    
DELETE FROM CLIENT1 WHERE CL_CODE IN ( SELECT C.CL_CODE         
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE)        
        
/* CLIENT1 INSERT QUERY */        
INSERT INTO CLIENT1        
SELECT C.CL_CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,FAX,RES_PHONE1,        
RES_PHONE2,OFF_PHONE1,OFF_PHONE2,EMAIL,BRANCH_CD,CREDIT_LIMIT,CL_TYPE,CL_STATUS,GL_CODE=PAYLOCATION,FD_CODE=SEBI_REGN_NO,FAMILY,        
PENALTY=0,SUB_BROKER,CONFIRM_FAX=0,PHONEOLD='',L_ADDRESS3,MOBILE_PAGER,PAN_GIR_NO,TRADER,WARD_NO,REGION,AREA,CLRATING=CLIENT_RATING       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE         
        
DELETE FROM CLIENT2 WHERE PARTY_CODE IN ( SELECT PARTY_CODE         
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE )        
        
/* CLIENT2 INSERT QUERY */        
INSERT INTO CLIENT2        
SELECT C.CL_CODE,D.EXCHANGE,TRAN_CAT='TRD',SCRIP_CAT=0,PARTY_CODE=C.CL_CODE,TRD_BROK,DEL_BROK,MARGIN=0,        
TURNOVER_TAX=FUT_TRAN_CHRGS,        
SEBI_TURN_TAX=FUT_SEBI_FEES,        
INSURANCE_CHRG=FUT_STT,        
SER_TAX,STD_RATE=FUT_BROK,P_TO_P=0,        
EXPOSURE_LIM=0,DEMAT_TABLENO=DEL_BROK,BANKID=PARTICIPANT_CODE,CLTDPNO=CUSTODIAN_CODE,PRINTF=PRINT_OPTIONS,        
ALBMDELCHRG=0,ALBMDELIVERY=0,ALBMCF_TABLENO=0,MF_TABLENO=DEL_BROK,SB_TABLENO=0,        
BROK1_TABLENO=FUT_FUT_FIN_BROK,BROK2_TABLENO=FUT_OPT_BROK,BROK3_TABLENO=0,        
BROKERNOTE=FUT_STAMP_DUTY,        
OTHER_CHRG=FUT_OTHER_CHRGS,        
D.BROK_SCHEME,CONTCHARGE=0,MINCONTAMT=0,ADDLEDGERBAL=0,DUMMY1=FUT_BROK_APPLICABLE,        
DUMMY2=FUT_OPT_EXC,INSCONT=(CASE WHEN INST_CONTRACT = '' OR INST_CONTRACT IS NULL THEN 'N' ELSE INST_CONTRACT END),SERTAXMETHOD=SER_TAX_METHOD,DUMMY6=STP_PROVIDER,        
DUMMY7=STP_RP_STYLE,DUMMY8=REL_MGR,DUMMY9=SBU,DUMMY10=C_GROUP, PARENTCODE, PRODUCTCODE    
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE         
        
DELETE FROM CLIENT3 WHERE PARTY_CODE IN ( SELECT PARTY_CODE         
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE)        
        
/* CLIENT3 INSERT QUERY */        
INSERT INTO CLIENT3        
SELECT C.CL_CODE,C.PARTY_CODE,EXCHANGE,MARKETTYPE=SEGMENT,MARGIN=0,NOOFTIMES=0,MARGIN_RECD=CHARGED,MTOM=0,        
PMARGINRATE=MULTIPLIER,MTOMDATE=GETDATE(),INITIALMARGIN=CHARGED,MAINENANCETMARGIN=MAINTENANCE,MARGINEXCHANGE=REQD_BY_EXCH,MARGINBROKER=0,        
DUMMY1=0,DUMMY2=0        
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE    
        
INSERT INTO CLIENT4        
SELECT C.CL_CODE,PARTY_CODE,INSTRU=0,BANKID=DPID1,CLTDPID1,DEPOSITORY1,DEF=1         
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE         
AND DPID1 <> '' AND CLTDPID1 <> ''         
AND DEPOSITORY1 IN ('NSDL', 'CDSL')         
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY IN ('NSDL', 'CDSL') )        
        
INSERT INTO MULTICLTID        
SELECT PARTY_CODE, CLTDPID1, DPID1, LONG_NAME, DEPOSITORY1, POA1         
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE         
AND DPID1 <> '' AND CLTDPID1 <> ''         
AND DEPOSITORY1 IN ('NSDL', 'CDSL')        
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID1 AND CLTDPNO = CLTDPID1)        
        
/* MULTICLTID INSERT QUERY */        
INSERT INTO MULTICLTID        
SELECT PARTY_CODE, CLTDPID2, DPID2, LONG_NAME, DEPOSITORY2, POA2         
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE         
AND DPID2 <> '' AND CLTDPID2 <> ''        
AND DEPOSITORY2 IN ('NSDL', 'CDSL')        
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID2 AND CLTDPNO = CLTDPID2)        
        
/* MULTICLTID INSERT QUERY */        
INSERT INTO MULTICLTID        
SELECT PARTY_CODE, CLTDPID3, DPID3, LONG_NAME, DEPOSITORY3, POA3         
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE         
AND DPID3 <> '' AND CLTDPID3 <> ''        
AND DEPOSITORY3 IN ('NSDL', 'CDSL')        
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID3 AND CLTDPNO = CLTDPID3)        
        
DELETE FROM CLIENT4 WHERE CL_CODE IN ( SELECT C.CL_CODE         
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE )        
       AND DEPOSITORY NOT IN ('NSDL', 'CDSL')        
        
INSERT INTO POBANK (BANK_NAME,BRANCH_NAME)        
SELECT DISTINCT BANK_NAME, BRANCH_NAME         
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE        
       AND BANK_NAME NOT IN (SELECT BANK_NAME FROM POBANK WHERE POBANK.BANK_NAME = C.BANK_NAME AND POBANK.BRANCH_NAME = C.BRANCH_NAME )        
        
/* CLIENT4 INSERT QUERY */        
INSERT INTO CLIENT4        
SELECT C.CL_CODE,PARTY_CODE,INSTRU=1,BANKID=P.BANKID,CLTDPID=AC_NUM,        
DEPOSITORY=ISNULL((CASE WHEN AC_TYPE = 'S' THEN 'SAVING'         
                        WHEN AC_TYPE = 'C' THEN 'CURRENT'         
                        ELSE 'OTHER' END), 'OTHER'),        
DEF=0        
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, POBANK P        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE       
AND AC_TYPE <> ''        
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY NOT IN ('CDSL','NSDL'))        
AND P.BANK_NAME = C.BANK_NAME AND P.BRANCH_NAME = C.BRANCH_NAME        
         
DELETE FROM CLIENT5 WHERE CL_CODE IN ( SELECT C.CL_CODE         
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE)        
        
/* CLIENT5 INSERT QUERY */        
INSERT INTO CLIENT5        
SELECT C.CL_CODE,BIRTHDATE=DOB,SEX,ACTIVEFROM=ACTIVE_DATE,INTERACTMODE,        
REPATRIATAC=(CASE WHEN LEN(REPATRIAT_BANK) = 0 THEN 1 ELSE 0 END),        
REPATRIATBANK=REPATRIAT_BANK,REPATRIATACNO=REPATRIAT_BANK_AC_NO,        
INTRODUCER,APPROVER,KYCFORM=CHK_KYC_FORM,BANKCERT=CHK_BANK_CERTIFICATE,        
PASSPORT=(CASE WHEN PASSPORT_NO <> '' THEN 1 ELSE 0 END), PASSPORTDTL=PASSPORT_NO,        
VOTERSID=(CASE WHEN VOTERSID_NO <> '' THEN 1 ELSE 0 END), VOTERSIDDTL = VOTERSID_NO,        
ITRETURN=(CASE WHEN IT_RETURN_YR <> '' THEN 1 ELSE 0 END), ITRETURNDTL=IT_RETURN_YR,        
DRIVELICEN=(CASE WHEN LICENCE_NO <> '' THEN 1 ELSE 0 END), DRIVELICENDTL = LICENCE_NO,        
RATIONCARD=(CASE WHEN RAT_CARD_NO <> '' THEN 1 ELSE 0 END), RATIONCARDDTL = RAT_CARD_NO,        
CORPDTLRECD=CHK_CORPORATE_DEED,CORPDEED=CHK_CORP_DTLS_RECD,        
ANUALREPORT=CHK_ANNUAL_REPORT,NETWORTHCERT=CHK_NETWORTH_CERT,INACTIVEFROM=INACTIVE_FROM,        
P_ADDRESS1,P_ADDRESS2,P_ADDRESS3,P_CITY,P_STATE,P_NATION,P_PHONE,P_ZIP,ADDEMAILID,        
PASSPORTDATEOFISSUE=PASSPORT_ISSUED_ON,PASSPORTPLACEOFISSUE=PASSPORT_ISSUED_AT,        
VOTERIDDATEOFISSUE=VOTERSID_ISSUED_ON,VOTERIDPLACEOFISSUE=VOTERSID_ISSUED_AT,        
ITRETURNDATEOFFILING=IT_RETURN_FILED_ON,LICENCENODATEOFISSUE=LICENCE_ISSUED_ON,        
LICENCENOPLACEOFISSUE=LICENCE_ISSUED_AT,RATIONCARDDATEOFISSUE=RAT_CARD_ISSUED_ON,        
RATIONCARDPLACEOFISSUE=RAT_CARD_ISSUED_AT,CLIENT_AGRE_DT=CLIENT_AGREEMENT_ON,REGR_NO=REGR_NO,        
REGR_PLACE=REGR_AT,REGR_DATE=REGR_ON,REGR_AUTH=REGR_AUTHORITY,INTROD_CLIENT_ID=INTRODUCER_ID,        
INTROD_RELATION=INTRODUCER_RELATION,        
ANY_OTHER_ACC=OTHER_AC_NO,SETT_MODE,DEALING_WITH_OTHRER_TM=ISNULL(DEALING_WITH_OTHER_TM,''),        
SYSTUMDATE=SYSTEMDATE,PASSPORTEXPDATE=PASSPORT_EXPIRES_ON,DRIVEEXPDATE=LICENCE_EXPIRES_ON,DIRECTOR_NAME         
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE        
        
DELETE FROM INSTCLIENT_TBL WHERE PARTYCODE IN ( SELECT PARTY_CODE         
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
       AND C.CL_CODE = D.CL_CODE )        
        
/* INSTCLIENT_TBL INSERT QUERY */        
INSERT INTO INSTCLIENT_TBL        
SELECT PARTY_CODE, ROUNDMARKETRATE, ROUNDBROKERAGE, ROUNDNETRATE, NO_OF_COPIES, RES1 = 0, RES2 = 0, RES3 = 0, RES4 = 0        
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, ROUNDPARAM R        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE         
AND D.ROUND_STYLE = R.ROUNDSTYLE        
    
IF @SEGMENT = 'CAPITAL' OR @SEGMENT = 'SLBS'     
BEGIN    
 UPDATE CLIENTBROK_SCHEME SET TO_DATE = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'    
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
      AND C.CL_CODE = D.CL_CODE         
      AND C.PARTY_CODE = CLIENTBROK_SCHEME.PARTY_CODE        
      AND TO_DATE LIKE 'DEC 31 2049%'        
         
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD NORMAL */        
 INSERT INTO CLIENTBROK_SCHEME        
 SELECT PARTY_CODE, TABLE_NO = TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',         
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'        
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE        
         
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL NORMAL */        
 INSERT INTO CLIENTBROK_SCHEME        
 SELECT PARTY_CODE, TABLE_NO = DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',         
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'        
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE        
         
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD INS */        
 INSERT INTO CLIENTBROK_SCHEME        
 SELECT PARTY_CODE, TABLE_NO = INST_TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',         
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'        
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE        
         
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL INS */        
 INSERT INTO CLIENTBROK_SCHEME        
 SELECT PARTY_CODE, TABLE_NO = INST_DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',         
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'        
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE        
         
 UPDATE CLIENTTAXES_NEW SET TODATE = TRD_EFF_DT - 1         
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
      AND C.CL_CODE = D.CL_CODE         
      AND C.PARTY_CODE = CLIENTTAXES_NEW.PARTY_CODE        
      AND CLIENTTAXES_NEW.TODATE LIKE 'DEC 31 2049%'        
           
 /* CLIENTTAXES_NEW INSERT QUERY FOR TRD */        
 INSERT INTO CLIENTTAXES_NEW        
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'TRD', INSURANCE_CHRG = TRD_STT,        
 TURNOVER_TAX = TRD_TRAN_CHRGS, OTHER_CHRG = TRD_OTHER_CHRGS, SEBITURN_TAX = TRD_SEBI_FEES,         
 BROKER_NOTE = TRD_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,         
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(TRD_EFF_DT,11),        
 TODATE = 'DEC 31 2049 23:59',         
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,         
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'         
                THEN 0.5        
                WHEN ROUNDING_METHOD = 'NEXT'        
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1         
                           THEN -0.01        
                           ELSE -0.1        
                      END)                       
         WHEN ROUNDING_METHOD = 'PREVIOUS'         
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1    
                           THEN 0.000001       
                           ELSE 0.000001    
                      END)                       
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'    
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5        
                           THEN -2.5        
                           ELSE 2.5        
                      END)                       
           END ),         
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)        
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE        
         
 /* CLIENTTAXES_NEW INSERT QUERY FOR DEL */        
 INSERT INTO CLIENTTAXES_NEW        
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'DEL', INSURANCE_CHRG = DEL_STT,        
 TURNOVER_TAX = DEL_TRAN_CHRGS, OTHER_CHRG = DEL_OTHER_CHRGS, SEBITURN_TAX = DEL_SEBI_FEES,         
 BROKER_NOTE = DEL_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,         
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(DEL_EFF_DT,11),         
 TODATE = 'DEC 31 2049 23:59',         
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,         
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'         
                THEN 0.5        
                WHEN ROUNDING_METHOD = 'NEXT'        
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1         
                           THEN -0.01        
                           ELSE -0.1        
                      END)                       
         WHEN ROUNDING_METHOD = 'PREVIOUS'         
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1         
                           THEN 0.000001        
                           ELSE 0.000001        
                      END)                       
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'    
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5        
                           THEN -2.5        
                           ELSE 2.5        
                      END)                       
           END ),         
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)        
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE     
    
 DELETE FROM CLIENTTAXES_NEW WHERE FROMDATE > TODATE    
 DELETE FROM CLIENTBROK_SCHEME WHERE FROM_DATE > TO_DATE    
    
END    
    
/*IF @SEGMENT = 'FUTURES'    
BEGIN    
 UPDATE FOCLIENTBROKSCHEME SET DATE_TO = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'    
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
 AND C.CL_CODE = D.CL_CODE         
 AND C.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE        
 AND DATE_TO LIKE 'DEC 31 2049%'    
    
 INSERT INTO FOCLIENTBROKSCHEME        
 SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59:59',    
 FUT_BROKTABLE = FUT_BROK, OPT_BROKTABLE = FUT_OPT_BROK,     
 FUT_EXP_BROKTABLE = FUT_FUT_FIN_BROK, OPT_EXC_BROKTABLE = FUT_OPT_EXC,    
 COMM_DEL_BROKTABLE = DEL_BROK, BROK_SCHEME,     
 OPT_BROK_COMPUTEON = (CASE WHEN FUT_BROK_APPLICABLE = 0    
           THEN 'PRICE'     
       WHEN FUT_BROK_APPLICABLE = 1    
       THEN 'SPRICE'       
           ELSE 'SSPRICE'     
          END)    
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE    
    
 UPDATE FOCLIENTTAXES SET DATE_TO = TRD_EFF_DT - 1         
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE         
 AND C.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE        
 AND FOCLIENTTAXES.DATE_TO LIKE 'DEC 31 2049%'    
    
 INSERT INTO FOCLIENTTAXES        
 SELECT PARTY_CODE, DATE_FROM = LEFT(TRD_EFF_DT,11), DATE_TO = 'DEC 31 2049 23:59',    
 FUT_INSURANCE_CHRG = TRD_STT, FUT_TURNOVER_TAX = TRD_TRAN_CHRGS,     
 FUT_OTHER_CHRG = TRD_OTHER_CHRGS, FUT_SEBITURN_TAX = TRD_SEBI_FEES,         
 FUT_BROKER_NOTE = TRD_STAMP_DUTY,    
 OPT_INSURANCE_CHRG = DEL_STT, OPT_TURNOVER_TAX = DEL_TRAN_CHRGS,     
 OPT_OTHER_CHRG = DEL_OTHER_CHRGS, OPT_SEBITURN_TAX = DEL_SEBI_FEES,         
 OPT_BROKER_NOTE = DEL_STAMP_DUTY,    
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,         
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'         
                THEN 0.5        
                WHEN ROUNDING_METHOD = 'NEXT'        
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1         
                           THEN -0.01        
             ELSE -0.1        
                      END)                       
         WHEN ROUNDING_METHOD = 'PREVIOUS'         
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1    
                           THEN 0.000001     
                           ELSE 0.000001      
                      END)                       
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'    
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5        
                           THEN -2.5        
                           ELSE 2.5        
                      END)                       
           END ),         
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)        
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
 AND C.CL_CODE = D.CL_CODE    
    
 DELETE FROM FOCLIENTTAXES WHERE DATE_FROM > DATE_TO    
 DELETE FROM FOCLIENTBROKSCHEME WHERE DATE_FROM > DATE_TO    
    
END*/    
    
IF @SEGMENT = 'SLBS'    
BEGIN    
 UPDATE CLIENT_DETAILS_TMP SET UCC_CODE = ISNULL(U.UCC_CODE, '')     
 FROM UCC_CLIENT U    
 WHERE U.PARTY_CODE = CLIENT_DETAILS_TMP.PARTY_CODE    
END    
    
DELETE FROM UCC_CLIENT        
WHERE PARTY_CODE IN ( SELECT PARTY_CODE         
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
      AND C.CL_CODE = D.CL_CODE)         
        
INSERT INTO UCC_CLIENT        
SELECT PARTY_CODE, LONG_NAME, CONTRACT_PERSON = INTRODUCER, CLEARINGNO1 = '', CLEARINGNO2 = '', CLEARINGNO3 = '',        
CLEARINGNO4 = '', MAPIDID = MAPIN_ID, FMCODE = FMCODE, DEALING_WITH_OTHER_TM, ANY_OTHER_ACC = OTHER_AC_NO,         
FAMILY_CODE1 = '', FAMILY_CODE2 = '', FAMILY_CODE3 = '', FAMILY_CODE4 = '', REMARK = '', UCC_CODE,         
STPPROVIDER = '', DUMMY1 = '', DUMMY2 = ''        
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE    
    
DELETE FROM DELPARTYFLAG       
WHERE PARTY_CODE IN ( SELECT PARTY_CODE         
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
      AND C.CL_CODE = D.CL_CODE)         
    
INSERT INTO DELPARTYFLAG    
SELECT PARTY_CODE, DEBIT_BALANCE, INTER_SETT    
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE    
    
DELETE FROM CLIENT4 WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)    
AND DEPOSITORY IN ('NSDL', 'CDSL')    
    
DELETE FROM MULTICLTID WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)    
    
    
EXEC BFOClientTaxesPop_clmast

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADDCOSTMAST
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[ADDCOSTMAST]
AS

DECLARE
@@ERRCOUNT INT,
@@CATCODE TINYINT

SELECT @@ERRCOUNT = COUNT(1) FROM CATEGORY WHERE CATEGORY = 'BRANCH'

IF @@ERRCOUNT = 0 
BEGIN
	SELECT @@CATCODE = ISNULL(MAX(CATCODE),0) + 1 FROM CATEGORY
	INSERT INTO CATEGORY VALUES('BRANCH', @@CATCODE)
END

CREATE TABLE #COSTMAST
(
	COSTNAME VARCHAR(10),
	COSTCODE INT IDENTITY(1,1),
	CATCODE INT,
	GRPCODE VARCHAR(12)
)

INSERT INTO #COSTMAST 
SELECT BRANCH_CODE, @@CATCODE, '100000000000'
FROM BSEFO.DBO.BRANCH

INSERT INTO COSTMAST SELECT * FROM #COSTMAST 

INSERT INTO BRANCHACCOUNTS
SELECT BRANCH_CODE, LEFT(BRANCH_CODE + 'CTRL', 10), 'HOCTRL', 0
FROM BSEFO.DBO.BRANCH

UPDATE BRANCHACCOUNTS SET DEFAULTAC = 1 WHERE LTRIM(RTRIM(BRANCHNAME)) = 'HO'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_ADDREPORT
-- --------------------------------------------------
CREATE PROC [DBO].[ADMIN_ADDREPORT]
(
	@REPORT VARCHAR(35),
	@PATH VARCHAR(500),
	@TARGET VARCHAR(25),
	@DESC VARCHAR(80),
	@REPORTGRP VARCHAR(10),
	@MENUGRP VARCHAR(3),
	@STATUS VARCHAR(20)
	
)
/*
BEGIN TRAN
EXEC ADMIN_ADDREPORT 'VOUCHER EDIT','/ACCOUNT/ACCMODULES/VOUCHER_EDIT/V2_VOUCHER_MAIN.ASP','FRATOPIC','DCA','98',5,'ALL'
SELECT * FROM TBLREPORTS WHERE FLDREPORTNAME = 'VOUCHER EDIT'
ROLLBACK
*/
AS
	DECLARE 
		@RESULT VARCHAR(50),
		@COUNT INT
SELECT @COUNT = COUNT(*) FROM TBLREPORTS WHERE UPPER(RTRIM(LTRIM(FLDREPORTNAME))) = UPPER(RTRIM(LTRIM(@REPORT)))

IF @COUNT > 0 
 BEGIN
	SET @RESULT = 'REPORT NAME ALREADY EXIST...'
	SELECT @RESULT AS MESSAGE
	RETURN;
 END


BEGIN TRY
	SET NOCOUNT ON;

	INSERT INTO TBLREPORTS 
	VALUES(@REPORT,@PATH,@TARGET,@DESC,@REPORTGRP,@MENUGRP,@STATUS,0)
	
	SET @RESULT = 'REPORT SUCCESSFULLY INSERTED!'

	IF @@ERROR = 0
	 BEGIN
		SELECT @RESULT AS MESSAGE
    END 
		
END TRY
BEGIN CATCH
	SELECT 
        ERROR_MESSAGE() AS MESSAGE;
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_DELREPORT
-- --------------------------------------------------
CREATE PROC [DBO].[ADMIN_DELREPORT]
(
	@FLDAUTO VARCHAR(500),
	@ADMIN_NAME VARCHAR(50),
	@IPADD VARCHAR(20)
)

AS
/*
ADMIN_DELREPORT '2452','ADMINISTRATOR',''
2445, 2444, 2446

SELECT * FROM TBLCATMENU_LOG WHERE FLDREPORTCODE = 2452

SELECT * FROM TBLREPORTS_LOG WHERE FLDREPORTNAME = 'VOUCHER EDIT1'

*/
CREATE TABLE #TEMPID
(
	ID INT
)

DECLARE 
	@LOOPID INT,
	@LOOPDATA VARCHAR(300),
	@GLOBALDATE DATETIME,
	@ADMINID INT, 
	@RESULT VARCHAR(50)	


SET @GLOBALDATE = GETDATE()

BEGIN TRY
	SET NOCOUNT ON;
	SET @LOOPID = 1
	WHILE 1 = 1
	 BEGIN
		SET @LOOPDATA = .DBO.PIECE(@FLDAUTO,',',@LOOPID)

		IF @LOOPDATA = '' OR @LOOPDATA IS NULL
		 BEGIN
			BREAK
		 END
			
		INSERT INTO #TEMPID(ID) VALUES(@LOOPDATA)
		SET @LOOPID = @LOOPID + 1 
	 END


	INSERT INTO TBLREPORTS_LOG (
		FLDREPORTCODE,
		FLDREPORTNAME,
		FLDPATH,
		FLDTARGET,
		FLDDESC,
		FLDREPORTGRP,
		FLDMENUGRP,
		FLDSTATUS,
		FLDORDER,
		EDIT_FLAG,
		CREATED_BY,
		CREATED_ON )
	SELECT 
		FLDREPORTCODE,
		FLDREPORTNAME,
		FLDPATH,
		FLDTARGET,
		FLDDESC,
		FLDREPORTGRP,
		FLDMENUGRP,
		FLDSTATUS,
		FLDORDER,
		'D',
		@ADMIN_NAME,
		@GLOBALDATE
	FROM
		TBLREPORTS, #TEMPID
	WHERE 
		FLDREPORTCODE = ID

	DELETE 
		TR
	FROM 
		TBLREPORTS TR, #TEMPID 
	WHERE 
		FLDREPORTCODE = ID

	INSERT INTO TBLCATMENU_LOG (
		FLDREPORTCODE,
		FLDADMINAUTO,
		FLDCATEGORYCODE_OLD,
		FLDCATEGORYCODE_NEW,
		EDIT_FLAG,
		CREATED_BY,
		CREATED_ON,
		MACHINE_IP )
	SELECT 
		FLDREPORTCODE,
		FLDADMINAUTO,
		FLDCATEGORYCODE,
		'',
		'D',
		@ADMIN_NAME,
		@GLOBALDATE,
		@IPADD 
	FROM 
		TBLCATMENU, #TEMPID 
	WHERE 
		FLDREPORTCODE = ID
		
	DELETE 
		TC
	FROM 
		TBLCATMENU TC, #TEMPID  
	WHERE 
		FLDREPORTCODE = ID
	

		SET @RESULT = 'DELETED SUCCESSFULLY!'

		IF @@ERROR = 0
		 BEGIN
			SELECT @RESULT AS MESSAGE
         END 
		DROP TABLE #TEMPID
END TRY
BEGIN CATCH
	SELECT 
        ERROR_MESSAGE() AS MESSAGE;
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_DELUSER
-- --------------------------------------------------
CREATE PROC [DBO].[ADMIN_DELUSER]
(
	@FLDAUTO VARCHAR(500),
	@ADMIN_NAME VARCHAR(50),
	@IPADD VARCHAR(20)
)

AS
/*
ADMIN_DELUSER '19,10,11,13','BROKER_CHECKER','10.11.12.74' 
SELECT * FROM TBLUSERCONTROLMASTER_JRNL
SELECT * FROM TBLPRADNYAUSERS_LOG WHERE FLDUSERNAME  ='TESTBHRT'

ROLLBACK
*/
CREATE TABLE #TEMPID
(
	ID INT
)

DECLARE 
	@LOOPID INT,
	@LOOPDATA VARCHAR(300),
	@GLOBALDATE DATETIME,
	@ADMINID INT

SET @GLOBALDATE = GETDATE()
SELECT  @ADMINID = FLDAUTO_ADMIN FROM TBLADMIN WHERE FLDNAME = @ADMIN_NAME

BEGIN TRAN
	SET @LOOPID = 1
	WHILE 1 = 1
	 BEGIN
		SET @LOOPDATA = .DBO.PIECE(@FLDAUTO,',',@LOOPID)

		IF @LOOPDATA = '' OR @LOOPDATA IS NULL
		 BEGIN
			BREAK
		 END
			
		INSERT INTO #TEMPID(ID) VALUES(@LOOPDATA)
		SET @LOOPID = @LOOPID + 1 
	 END	
SELECT * FROM #TEMPID
	INSERT INTO TBLPRADNYAUSERS_LOG 
		(FLDAUTO,
		FLDUSERNAME,
		FLDPASSWORD,
		FLDFIRSTNAME,
		FLDMIDDLENAME,
		FLDLASTNAME,
		FLDSEX,
		FLDADDRESS1,
		FLDADDRESS2,
		FLDPHONE1,
		FLDPHONE2,
		FLDCATEGORY,
		FLDADMINAUTO,
		FLDSTNAME,
		PWD_EXPIRY_DATE,
		EDIT_FLAG,
		CREATED_BY,
		CREATED_ON,
		MACHINEIP,
		FLDLOG_DATA)
	SELECT 
		FLDAUTO,
		FLDUSERNAME,
		FLDPASSWORD,
		FLDFIRSTNAME,
		FLDMIDDLENAME,
		FLDLASTNAME,
		FLDSEX,
		FLDADDRESS1,
		FLDADDRESS2,
		FLDPHONE1,
		FLDPHONE2,
		FLDCATEGORY,
		FLDADMINAUTO,
		FLDSTNAME,
		PWD_EXPIRY_DATE,
		'D',
		@ADMIN_NAME,
		@GLOBALDATE,
		@IPADD,
		'DELETEENTRY' 
	FROM 
		TBLPRADNYAUSERS, #TEMPID
	WHERE 
		FLDAUTO = ID

	INSERT INTO TBLUSERCONTROLMASTER_JRNL
		(FLDAUTO,
		FLDUSERID,
		FLDPWDEXPIRY,
		FLDMAXATTEMPT,
		FLDATTEMPTCNT,
		FLDSTATUS,
		FLDLOGINFLAG,
		FLDACCESSLVL,
		FLDIPADD,
		FLDTIMEOUT,
		FLDFIRSTLOGIN,
		FLDFORCELOGOUT,
		FLDUPDTBY,
		FLDUPDTDT)
	SELECT 
		FLDAUTO,
		FLDUSERID,
		FLDPWDEXPIRY,
		FLDMAXATTEMPT,
		FLDATTEMPTCNT,
		FLDSTATUS,
		FLDLOGINFLAG,
		FLDACCESSLVL,
		FLDIPADD,
		FLDTIMEOUT,
		FLDFIRSTLOGIN,
		FLDFORCELOGOUT,
		@ADMINID,
		@GLOBALDATE 
	FROM 
		TBLUSERCONTROLMASTER TBC, #TEMPID
	WHERE 
		FLDUSERID = ID
	
	DELETE 
		TB
	FROM 
		TBLPRADNYAUSERS TB,  #TEMPID 
	WHERE 
		FLDAUTO = ID
COMMIT

DROP TABLE #TEMPID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_GET_CATEGORIES
-- --------------------------------------------------
CREATE PROC [DBO].[ADMIN_GET_CATEGORIES]
(
	@FLDADMINAUTO INT
)
AS
/*
ADMIN_GET_CATEGORIES 26
SELECT * FROM TBLADMIN
SELECT * FROM TBLCATEGORY
DROP PROC  GET_CATEGORIES
*/

SELECT 
	FLDAUTO_ADMIN, FLDSTATUS 
INTO 
	#TEMP
FROM 
	TBLADMIN 
WHERE FLDSTATUS = (SELECT FLDSTATUS FROM TBLADMIN WHERE FLDAUTO_ADMIN = @FLDADMINAUTO)

--SELECT * FROM #TEMP

SELECT * FROM TBLCATEGORY, #TEMP WHERE FLDAUTO_ADMIN = FLDADMINAUTO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_updCliPswd
-- --------------------------------------------------
CREATE procedure Angel_updCliPswd  
(  
    @username as varchar(15),  
    @pswd as varchar(15)  
)  
as  
begin  
    declare @fld1 as int,@fldadm as int  
    select @fld1=fldauto,@fldadm=fldadminauto   
    from tblPradnyausers (nolock)   
    where fldusername=@username  
  
    update tblPradnyausers set fldpassword =@pswd   
    where fldauto =@fld1 and fldadminauto = fldadminauto  
  
    INSERT INTO TBLUSERCONTROLMASTER_JRNL   
    SELECT *,'10',GETDATE() FROM TBLUSERCONTROLMASTER   
    WHERE FLDUSERID = @fld1  
      
    if not exists (Select emp_no from intranet.risk.dbo.emp_info a(nolock)  
    where emp_no=@username and Status<>'A')  
    begin  
        update TBLUSERCONTROLMASTER set FLDPWDEXPIRY = 30, FLDMAXATTEMPT = 5, FLDSTATUS = 0,  
        --FLDATTEMPTCNT = (CASE WHEN (0 = 1 AND 0 = 0) THEN 0 ELSE FLDATTEMPTCNT END),  
        FLDATTEMPTCNT = 0,  
        FLDFIRSTLOGIN = 'Y', FLDFORCELOGOUT = 0 WHERE FLDUSERID = @fld1  
    end  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BAk_CLS_TURNOVER_RPT
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/*  
EXEC CLS_TURNOVER_RPT '01/01/2010','10/10/2014','','','','','BROKER','BROKER',1,'PARTY','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'PARTY','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2010','10/10/2014','','','','','BROKER','BROKER',3,'PARTY','','','',0,'STRIKE'
  
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',1,'SCRIP','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'SCRIP','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',3,'SCRIP','','','',0,'STRIKE'
*/  
  
Create PROC [dbo].[BAk_CLS_TURNOVER_RPT]
(  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @FROMPARTY VARCHAR(20),  
 @TOPARTY VARCHAR (20),   
 @FROMSCRIP VARCHAR(20),  
 @TOSCRIP VARCHAR (20),    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25),  
 @REPORTTYPE INT=1,  
 @REPORT_BY VARCHAR(10)='PARTY',  
 @INST_TYPE VARCHAR(7) ='',  
 @EXPIRYDATE VARCHAR(11) ='',  
 @OPTION_TYPE VARCHAR(2) ='',  
 @STRIKE_PRICE MONEY =0,
 @REPORTBY VARCHAR(10) = 'PRICE'   
 )  AS  
  
/*  
 @REPORTTYPE = 1 : PARTY / SCRIP WISE SUMMARY  
 @REPORTTYPE = 2 : PARTY + SCRIP / SCRIP + PARTY  
 @REPORTTYPE = 3 : PARTY + SCRIP + SAUDA_DATE / SCRIP + PARTY + SAUDA_DATE   
   
 @REPORT_BY : PARTY / SCRIP  
  
*/  
  
  
SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)  
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)  
  
  
IF @TOPARTY =''  
SET @TOPARTY ='ZZZZZZZ'  
  
IF @TOSCRIP =''  
SET @TOSCRIP ='ZZZZZZZ'  
  
SELECT   
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),  
	PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME,  
	SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,   
	FUTURESTRADEDVALUE = SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'EA'  THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END),
	OPTIONSTRADEDVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*STRIKE_PRICE)+(SQTY*STRIKE_PRICE))) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*(STRIKE_PRICE+PRATE))+(SQTY*(STRIKE_PRICE+SRATE)))) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
		ELSE SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
	END), 
	EXCERCISEVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*SRATE) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*STRIKE_PRICE) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*(STRIKE_PRICE+SRATE)) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*STRIKE_PRICE) ELSE 0 END)
		ELSE SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*SRATE) ELSE 0 END)
	END),	
	ASSIGNMENTVALUE = 0,
	CLOSEOUTVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		ELSE SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
	END),
	TOTAL = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'STRIKE'	THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'BOTH'		THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'EXCHG'	THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		ELSE (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
			+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END))
	END),
	BROKERAGE = SUM(PBROKAMT + SBROKAMT),  
	FUT_BROKERAGE = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'FUT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END),
	OPT_BROKERAGE = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'OPT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END),
	SERVICETAX = SUM(SERVICE_TAX-EXSER_TAX), 
	INS_CHRG = SUM(INS_CHRG), 
	TURNOVERTAX = SUM(TURN_TAX),  
	FUT_TURNOVERTAX = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'FUT' THEN (TURN_TAX) ELSE 0 END),  
	OPT_TURNOVERTAX = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'OPT' THEN (TURN_TAX) ELSE 0 END),  
	SEBITAX = SUM(SEBI_TAX),
	STAMPDUTY = SUM(BROKER_NOTE),
	OTHERCHARGES = SUM(OTHER_CHRG)  
INTO #TURNOVER  
FROM FOBILLVALAN (NOLOCK)  
WHERE  
 SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'   
 AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
 AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP  
 AND INST_TYPE = CASE WHEN @INST_TYPE = '' THEN INST_TYPE ELSE @INST_TYPE END  
 AND EXPIRYDATE = CASE WHEN @EXPIRYDATE = '' THEN EXPIRYDATE ELSE LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11) + ' 23:59' END  
 AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '' THEN OPTION_TYPE ELSE @OPTION_TYPE END  
 AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END  
 AND TRADETYPE = 'BT'  
 AND 'BROKER' =     
 (CASE  
  WHEN 'BROKER' = 'BRANCH' THEN BRANCH_CODE  
  WHEN 'BROKER' = 'SUBBROKER' THEN SUB_BROKER  
  WHEN 'BROKER' = 'TRADER' THEN TRADER  
  WHEN 'BROKER' = 'FAMILY' THEN FAMILY  
  WHEN 'BROKER' = 'AREA' THEN AREA  
  WHEN 'BROKER' = 'REGION' THEN REGION  
  WHEN 'BROKER' = 'CLIENT' THEN PARTY_CODE   
  ELSE 'BROKER'   
 END)  
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE ,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE    
ALTER TABLE #TURNOVER  
ADD SRNO INT IDENTITY(1,1)  
IF @REPORTTYPE = 1  -- SUMMARY  
BEGIN  
 IF @REPORT_BY = 'PARTY'  
 BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE,PARTY_NAME,INST_TYPE='',SYMBOL='',EXPIRYDATE='',STRIKE_PRICE=0,OPTION_TYPE='',  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME  
  --ORDER BY 1,2,3,4,5  
  ORDER BY PARTY_CODE,PARTY_NAME  
 END  
 ELSE  
 BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE='',PARTY_NAME='',INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
  ORDER BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
 END  
END  
  
IF @REPORTTYPE = 2  -- DETAILS  
BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
  ORDER BY 3,4,5 ,6
  --ORDER BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE,PARTY_CODE,PARTY_NAME  
END  
  
IF @REPORTTYPE = 3  -- FURTHER DETAILS  
BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE,PARTY_CODE,PARTY_NAME,INST_TYPE = LTRIM(RTRIM(INST_TYPE)),SYMBOL = LTRIM(RTRIM(SYMBOL)),EXPIRYDATE=LTRIM(RTRIM(EXPIRYDATE)),STRIKE_PRICE=LTRIM(RTRIM(STRIKE_PRICE)),OPTION_TYPE=LTRIM(RTRIM(OPTION_TYPE)),  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE  
  --ORDER BY 1,2,3,4,5  
  ORDER BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE
END  
  
  
DROP TABLE #TURNOVER  
  
/*------------------------------------------ END OF THE PROC -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOAFTERCONTCURSOR
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.BFOAFTERCONTCURSOR    SCRIPT DATE: 04/02/2002 2:48:09 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BFOAFTERCONTCURSOR    SCRIPT DATE: 2/14/02 1:43:05 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BFOAFTERCONTCURSOR    SCRIPT DATE: 01/04/1980 1:05:02 AM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BFOAFTERCONTCURSOR    SCRIPT DATE: 09/25/2001 6:15:59 AM ******/
/*  RECENT CHANGES DONE BY VAISHALI ON 06/08/2001 - ADDED 2 PARAMETERS MARKETRATE & MARKETRATEFLAG. (IF MARKETRATE IS SELECTED THEN MARKETRATEFLAG = 1 ELSE 0)*/
/*  RECENT CHANGES DONE BY VAISHALI  CHANGES THE TYPE OF EXPIRY DATE TO VARCHAR INSTEAD OF DATETIME ON 25/07/2001*/
/****** OBJECT:  STORED PROCEDURE DBO.FOAFTERCONTCURSOR    SCRIPT DATE: 4/3/01 12:58:39 PM ******/
CREATE PROC [DBO].[BFOAFTERCONTCURSOR] 
@UID VARCHAR(30),
@PARTYCD VARCHAR(10),
@TDATE VARCHAR(11),
@PRODUCT_TYPE VARCHAR(3),
@PRODUCT_CODE VARCHAR(10),
@SERIES_CODE VARCHAR(13),
@EXPIRYDATE VARCHAR(11),
@SERIES_ID INT,
@SELLBUY VARCHAR(2),
@TRADE_NO VARCHAR(10),
@ORDER_NO VARCHAR(15),
@TOPARTY AS VARCHAR(10),
@TQTY INT,
@MARKETRATE MONEY,
@MKTRATEFLAG INT,
@FLAG INT
 AS
DECLARE 
@@CONTRACTNO VARCHAR(5),
@@CONT CURSOR,
@@CNO CURSOR,
@@TNO CURSOR,
@@TTRADENO VARCHAR(14),
@@TRADE_NO VARCHAR(14),
@@XTRADENO VARCHAR(14),
@@TRADEQTY INT,
@@MARKETRATE MONEY,
@@NETRATE MONEY,
@@TFLAG INT,
@@PRODUCT_TYPE VARCHAR(3),
@@PRODUCT_CODE VARCHAR(10),
@@SERIES_CODE VARCHAR(13),
@@EXPIRYDATE VARCHAR(12),
@@SERIES_ID INT,
@@SELL_BUY VARCHAR(1),
@@REMQTY INT
SET @@CNO = CURSOR FOR 
        SELECT DISTINCT CONTRACTNO FROM BFOSETTLEMENT 
        WHERE PARTY_CODE = @TOPARTY
        AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)= @TDATE
	
OPEN @@CNO 
FETCH NEXT FROM @@CNO INTO @@CONTRACTNO
IF @@FETCH_STATUS <> 0 
BEGIN
	CLOSE @@CNO
	DEALLOCATE @@CNO
	SET @@CNO = CURSOR FOR 
   		SELECT ISNULL(MAX(CONTRACTNO),'00001') FROM BFOSETTLEMENT 
	  	WHERE LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)= @TDATE
	OPEN @@CNO
	FETCH NEXT FROM @@CNO INTO @@CONTRACTNO
END
CLOSE @@CNO
DEALLOCATE @@CNO
IF @FLAG =1
BEGIN
SET @@CONT = CURSOR FOR
       SELECT TRADE_NO ,TRADEQTY,MARKETRATE,NETRATE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,SELL_BUY
       FROM BFOSETTLEMENT WHERE  BILLNO = 0 
       AND PARTY_CODE LIKE @PARTYCD
       AND  LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE 
       ORDER BY TRADEQTY DESC 
END
IF @FLAG =2
BEGIN
SET @@CONT = CURSOR FOR
       SELECT TRADE_NO ,TRADEQTY,MARKETRATE,NETRATE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,SELL_BUY
       FROM BFOSETTLEMENT WHERE  BILLNO = 0 
       AND PARTY_CODE LIKE @PARTYCD
       AND  LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) LIKE @TDATE 
       AND PRODUCT_TYPE =  @PRODUCT_TYPE 
       AND PRODUCT_CODE = @PRODUCT_CODE
       AND SERIES_CODE = @SERIES_CODE 
       AND  LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
       AND SERIES_ID = @SERIES_ID				
       ORDER BY TRADEQTY DESC 
END
IF @FLAG = 3
BEGIN
SET @@CONT = CURSOR FOR
       SELECT TRADE_NO ,TRADEQTY,MARKETRATE,NETRATE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,SELL_BUY
       FROM BFOSETTLEMENT WHERE  BILLNO = 0 
       AND PARTY_CODE LIKE @PARTYCD
       AND  LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) LIKE @TDATE 
        AND PRODUCT_TYPE =  @PRODUCT_TYPE 
       AND PRODUCT_CODE = @PRODUCT_CODE
       AND SERIES_CODE = @SERIES_CODE 
       AND  LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
       AND SERIES_ID = @SERIES_ID		
       AND SELL_BUY = @SELLBUY		
       ORDER BY TRADEQTY DESC 
END
IF @FLAG = 4
BEGIN
	IF @MKTRATEFLAG = 0   /*  IF CONDITION ADDED BY VAISHALI ON 06/08/2001*/ 
	BEGIN
		SET @@CONT = CURSOR FOR
       		SELECT TRADE_NO ,TRADEQTY,MARKETRATE,NETRATE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,SELL_BUY
       		FROM BFOSETTLEMENT WHERE  BILLNO = 0 
       		AND PARTY_CODE LIKE @PARTYCD
       		AND  LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) LIKE @TDATE 
        		AND PRODUCT_TYPE =  @PRODUCT_TYPE 
       		AND PRODUCT_CODE = @PRODUCT_CODE
       		AND SERIES_CODE = @SERIES_CODE 
       		AND  LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
       		AND SERIES_ID = @SERIES_ID		
       		AND SELL_BUY = @SELLBUY	
       		AND TRADE_NO LIKE @TRADE_NO 
       		AND ORDER_NO LIKE @ORDER_NO 
       		ORDER BY TRADEQTY DESC
	END
	ELSE IF @MKTRATEFLAG = 1
	BEGIN
		SET @@CONT = CURSOR FOR        		
		SELECT TRADE_NO ,TRADEQTY,MARKETRATE,NETRATE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,SELL_BUY
       		FROM BFOSETTLEMENT WHERE  BILLNO = 0 
       		AND PARTY_CODE LIKE @PARTYCD
       		AND  LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) LIKE @TDATE 
        		AND PRODUCT_TYPE =  @PRODUCT_TYPE 
       		AND PRODUCT_CODE = @PRODUCT_CODE
       		AND SERIES_CODE = @SERIES_CODE 
       		AND  LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
       		AND SERIES_ID = @SERIES_ID		
       		AND SELL_BUY = @SELLBUY	
       		AND TRADE_NO LIKE @TRADE_NO 
       		AND ORDER_NO LIKE @ORDER_NO
		AND MARKETRATE = @MARKETRATE
       		ORDER BY TRADEQTY DESC
	END
END 
OPEN @@CONT 
FETCH NEXT FROM @@CONT INTO @@TRADE_NO ,@@TRADEQTY,@@MARKETRATE,@@NETRATE,@@PRODUCT_TYPE,@@PRODUCT_CODE,@@SERIES_CODE,@@EXPIRYDATE,@@SERIES_ID,@@SELL_BUY  
/*SELECT @@TRADE_NO ,@@TRADEQTY,@@MARKETRATE,@@NETRATE,@@PRODUCT_TYPE,@@PRODUCT_CODE,@@SERIES_CODE,@@EXPIRYDATE,@@SERIES_ID,@@SELL_BUY  */
WHILE @@FETCH_STATUS = 0 AND @TQTY > 0
BEGIN
	SELECT @@TTRADENO = 'R' + @@TRADE_NO
	SELECT @@TFLAG = 1 
	SELECT @@XTRADENO = '0'
	WHILE  @@TFLAG = 1 	
	BEGIN		 		
		SET @@TNO = CURSOR FOR
		SELECT TRADE_NO FROM BFOSETTLEMENT 
    		WHERE TRADE_NO LIKE @@TTRADENO
	    	
		OPEN @@TNO 
		FETCH NEXT FROM @@TNO INTO @@XTRADENO
		IF @@FETCH_STATUS = 0 AND @@XTRADENO <> '0' 
			SELECT @@TTRADENO = 'R' +  @@XTRADENO
		ELSE
			SELECT @@TFLAG = 0 
	END
	
	
	IF @@TRADEQTY = @TQTY 
	BEGIN
		
		INSERT INTO BFOSETTLEMENT SELECT
		@@CONTRACTNO,BILLNO,@@TTRADENO,@TOPARTY,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,MULTIPLIER,
                		USER_ID,@@TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,MARKETRATE,STRIKE_PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,
		VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT = (@TQTY *@@NETRATE),
		INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT= (@TQTY * @@MARKETRATE),BILLFLAG,
		SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_TYPE,ORDER_DATE,OPPMEMCODE,OPPTRADERCODE,CL_RATE,GROUPID,TRADERCODE,
		RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,STATUS,BRANCH_CD,PRO_CLI,PARTICIPANTCODE,CPID,INSTRUMENT,
		BOOKTYPE,BRANCH_ID,SCHEME,TMARK,DUMMY1,DUMMY2
		FROM BFOSETTLEMENT 
		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND  LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID 
		AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE   AND MARKETRATE = @@MARKETRATE
		
		
		INSERT INTO CONTLOGIN SELECT @UID,@PARTYCD,@TOPARTY,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,
		@TQTY,SELL_BUY,SAUDA_DATE,CONTRACTNO,GETDATE(),0,@@TTRADENO FROM BFOSETTLEMENT 
		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID 
		AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE   AND MARKETRATE = @@MARKETRATE
	     	UPDATE BFOSETTLEMENT SET TRADEQTY= 0,NORMAL = 0,DAY_PUC = 0,DAY_SALES = 0,SETT_PURCH = 0,SETT_SALES  = 0, 
         		MARKETRATE = 0,BROKAPPLIED = 0,NETRATE = 0,AMOUNT = 0,INS_CHRG = 0,TURN_TAX = 0,OTHER_CHRG = 0,
    		SEBI_TAX = 0,BROKER_CHRG = 0,SERVICE_TAX = 0,TRADE_AMOUNT = 0,NBROKAPP = 0,NSERTAX = 0,N_NETRATE = 0
    		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID AND 
 		LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE  AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE   AND MARKETRATE = @@MARKETRATE
		SELECT @TQTY = 0
	END
	ELSE IF @@TRADEQTY > @TQTY 
	BEGIN
		SELECT @@REMQTY = @@TRADEQTY - @TQTY
	
		
		INSERT INTO BFOSETTLEMENT SELECT
		@@CONTRACTNO,BILLNO,@@TTRADENO,@TOPARTY,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,MULTIPLIER,
                		USER_ID,@TQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,MARKETRATE,STRIKE_PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,
		VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT = (@TQTY *@@NETRATE),
		INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT= (@TQTY * @@MARKETRATE),BILLFLAG,
		SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_TYPE,ORDER_DATE,OPPMEMCODE,OPPTRADERCODE,CL_RATE,GROUPID,TRADERCODE,
		RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,STATUS,BRANCH_CD,PRO_CLI,PARTICIPANTCODE,CPID,INSTRUMENT,
		BOOKTYPE,BRANCH_ID,SCHEME,TMARK,DUMMY1,DUMMY2
		FROM BFOSETTLEMENT 
		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND  LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID 
		AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE   AND MARKETRATE = @@MARKETRATE
		INSERT INTO CONTLOGIN SELECT @UID,@PARTYCD,@TOPARTY,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,
		@TQTY,SELL_BUY,SAUDA_DATE,CONTRACTNO,GETDATE(),0,@@TTRADENO FROM BFOSETTLEMENT 
		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID 
		AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE   AND MARKETRATE = @@MARKETRATE
		UPDATE BFOSETTLEMENT SET TRADEQTY =@@REMQTY , AMOUNT = (@@REMQTY * @@NETRATE ) ,
		TRADE_AMOUNT = @@REMQTY * @@MARKETRATE 
    		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID  
		AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE  AND MARKETRATE = @@MARKETRATE
		
		SELECT @TQTY = 0 	
	END
	ELSE IF @@TRADEQTY < @TQTY 
	BEGIN
		/*SELECT @@TRADEQTY,@TQTY,@TOPARTY
		SELECT  @@TRADE_NO ,@@TRADEQTY,@@MARKETRATE,@@NETRATE,@@PRODUCT_TYPE,@@PRODUCT_CODE,@@SERIES_CODE,@@EXPIRYDATE,@@SERIES_ID,@@SELL_BUY  */
		INSERT INTO BFOSETTLEMENT SELECT
		@@CONTRACTNO,BILLNO,@@TTRADENO,@TOPARTY,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,MULTIPLIER,
                		USER_ID,@@TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,MARKETRATE,STRIKE_PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,
		VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT = (@@TRADEQTY *@@NETRATE),
		INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT= (@@TRADEQTY * @@MARKETRATE),BILLFLAG,
		SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_TYPE,ORDER_DATE,OPPMEMCODE,OPPTRADERCODE,CL_RATE,GROUPID,TRADERCODE,
		RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,STATUS,BRANCH_CD,PRO_CLI,PARTICIPANTCODE,CPID,INSTRUMENT,
		BOOKTYPE,BRANCH_ID,SCHEME,TMARK,DUMMY1,DUMMY2
		FROM BFOSETTLEMENT 
		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND  LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID 
		AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE   AND MARKETRATE = @@MARKETRATE
		INSERT INTO CONTLOGIN SELECT @UID,@PARTYCD,@TOPARTY,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,EXPIRYDATE,SERIES_ID,
		@@TRADEQTY,SELL_BUY,SAUDA_DATE,CONTRACTNO,GETDATE(),0,@@TTRADENO FROM BFOSETTLEMENT 
		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID 
		AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE   AND MARKETRATE = @@MARKETRATE
		UPDATE BFOSETTLEMENT SET TRADEQTY= 0,NORMAL = 0,DAY_PUC = 0,DAY_SALES = 0,SETT_PURCH = 0,SETT_SALES  = 0, 
             		MARKETRATE = 0,BROKAPPLIED = 0,NETRATE = 0,AMOUNT = 0,INS_CHRG = 0,TURN_TAX = 0,OTHER_CHRG = 0,
    		SEBI_TAX = 0,BROKER_CHRG = 0,SERVICE_TAX = 0,TRADE_AMOUNT = 0,NBROKAPP = 0,NSERTAX = 0,N_NETRATE = 0
    		WHERE TRADE_NO = @@TRADE_NO AND PRODUCT_TYPE = @@PRODUCT_TYPE AND PRODUCT_CODE = @@PRODUCT_CODE 
		AND SERIES_CODE = @@SERIES_CODE AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @@EXPIRYDATE AND SERIES_ID = @@SERIES_ID AND 
 		LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE  AND SELL_BUY =@@SELL_BUY  AND PARTY_CODE = @PARTYCD
  		AND NETRATE= @@NETRATE  AND MARKETRATE = @@MARKETRATE
	
		SELECT @TQTY = @TQTY - @@TRADEQTY 
	END
	FETCH NEXT FROM @@CONT INTO @@TRADE_NO ,@@TRADEQTY,@@MARKETRATE,@@NETRATE,@@PRODUCT_TYPE,@@PRODUCT_CODE,@@SERIES_CODE,@@EXPIRYDATE,@@SERIES_ID,@@SELL_BUY  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOAUPDBILLTAX
-- --------------------------------------------------
CREATE  PROC [DBO].[BFOAUPDBILLTAX](@EXPIRYDATE  VARCHAR(11)) AS    
UPDATE BFOSETTLEMENT SET    
BROKAPPLIED = (  CASE      
	WHEN ( BFOSETTLEMENT.BILLFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
	THEN     
		((FLOOR(( BROKTABLE.NORMAL * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /      
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /     
		POWER(10,BROKTABLE.ROUND_TO))    
	WHEN ( BFOSETTLEMENT.BILLFLAG=4 AND BROKTABLE.VAL_PERC ='P' )    
	THEN     
		((FLOOR(( ((BROKTABLE.NORMAL/100) * (BFOCLOSING.CL_RATE)) *     
		POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /      
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /     
		POWER(10,BROKTABLE.ROUND_TO))    
	WHEN ( BFOSETTLEMENT.BILLFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )    
	THEN     
		((FLOOR(( BROKTABLE.NORMAL * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /      
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /     
		POWER(10,BROKTABLE.ROUND_TO))                           
	WHEN ( BFOSETTLEMENT.BILLFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )    
	THEN     
		((FLOOR(( (BROKTABLE.NORMAL/100 *BFOCLOSING.CL_RATE)* POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /      
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /     
		POWER(10,BROKTABLE.ROUND_TO))                             
	ELSE      
		BROKAPPLIED  
	END     
	),    
NETRATE = (  CASE      
	WHEN ( BFOSETTLEMENT.BILLFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
	THEN     
		((FLOOR(( (BROKTABLE.NORMAL + BFOCLOSING.CL_RATE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG +     
		BROKTABLE.ERRNUM ) /      
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /     
		POWER(10,BROKTABLE.ROUND_TO))    
	WHEN ( BFOSETTLEMENT.BILLFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )    
	THEN    
		((FLOOR(( ( ( BFOCLOSING.CL_RATE+((BROKTABLE.NORMAL/100)*BFOCLOSING.CL_RATE))) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG +     
		BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /     
		POWER(10,BROKTABLE.ROUND_TO))    	
	WHEN ( BFOSETTLEMENT.BILLFLAG =5  AND BROKTABLE.VAL_PERC ='V' )    	
	THEN    
		((FLOOR((  (BFOCLOSING.CL_RATE- BROKTABLE.NORMAL)* POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG +     
		BROKTABLE.ERRNUM ) /      
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /     
		POWER(10,BROKTABLE.ROUND_TO))    	
	WHEN ( BFOSETTLEMENT.BILLFLAG =5  AND BROKTABLE.VAL_PERC ='P' )    	
	THEN    
		((FLOOR((  ((   (BFOCLOSING.CL_RATE -((BROKTABLE.NORMAL/100) * BFOCLOSING.CL_RATE))    )) *     
		POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) *     
		(BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /  POWER(10,BROKTABLE.ROUND_TO))    
	ELSE      
		NETRATE     
	END     
	),    
SERVICE_TAX  =  (CASE      	
	WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
	THEN      
		((FLOOR((     
		(((((FLOOR((( BROKTABLE.NORMAL)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /    
		POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /    
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))        
	WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )    
	THEN     
		((FLOOR((     
		(((((FLOOR((( (BROKTABLE.NORMAL/100) *  (BFOCLOSING.CL_RATE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /    
		POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /    
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))        
	WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )    
	THEN       
		((FLOOR((     
		(((((FLOOR((( BROKTABLE.NORMAL)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /    
		POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /    
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))        
	WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )    
	THEN      
		((FLOOR((     
		(((((FLOOR((( (BROKTABLE.NORMAL/100) * (BFOCLOSING.CL_RATE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /    
		POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /    
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))        
	ELSE  0     
	END  ),    
        INS_CHRG  = ((FLOOR(( ((BFOTAXES.INSURANCE_CHRG * (BFOCLOSING.CL_RATE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / 
			(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO)),    
        TURN_TAX  =  ((FLOOR(( ((BFOTAXES.TURNOVER_TAX * (BFOCLOSING.CL_RATE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /    
			  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /    
			  POWER(10,BROKTABLE.ROUND_TO)),    
        OTHER_CHRG = ((FLOOR(( ((BFOTAXES.OTHER_CHRG * (BFOCLOSING.CL_RATE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / 
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /  POWER(10,BROKTABLE.ROUND_TO)),    
        SEBI_TAX =     ((FLOOR(( ((BFOTAXES.SEBITURN_TAX *(BFOCLOSING.CL_RATE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / 
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),    
        BROKER_CHRG =  ((FLOOR(( ((BFOTAXES.BROKER_NOTE * (BFOCLOSING.CL_RATE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / 
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO))    
        FROM 
		BROKTABLE,CLIENT2,BFOTAXES,BFOGLOBALS,BFOSCRIP2,CLIENT1,BFOCLOSING    
        WHERE
		BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE    
		AND CLIENT1.CL_CODE=CLIENT2.CL_CODE               
		AND BFOSETTLEMENT.SERIES_CODE = BFOSCRIP2.SERIES_CODE    
		AND BFOCLOSING.TRADE_DATE=BFOSCRIP2.MATURITYDATE    
		AND BFOCLOSING.SERIES_CODE=BFOSCRIP2.SERIES_CODE    	
		AND BROKTABLE.TABLE_NO = ( CASE WHEN (CLIENT2.TRAN_CAT = 'TRD')  THEN     
			CLIENT2.BROK1_TABLENO              
			END )    
		AND  BROKTABLE.LINE_NO = ( CASE WHEN (CLIENT2.TRAN_CAT = 'TRD')   THEN     
		(SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE    
		BROKTABLE.TABLE_NO = CLIENT2.BROK1_TABLENO        
		AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE        
		AND TRD_DEL = 'D'    
		AND BFOCLOSING.CL_RATE <= BROKTABLE.UPPER_LIM )                
		END )
		AND    
			(CLIENT2.TRAN_CAT = BFOTAXES.TRANS_CAT)    
		AND    
			(BFOTAXES.EXCHANGE = 'BSE')    	
		AND CLIENT2.TRAN_CAT = 'TRD'    
		AND (BILLFLAG = 4 OR BILLFLAG = 5)    
		AND BFOSETTLEMENT.TRADEQTY > 0
		AND BFOSETTLEMENT.EXPIRYDATE LIKE  @EXPIRYDATE  + '%'      
		AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOBILLGENERATE
-- --------------------------------------------------
CREATE PROC [DBO].[BFOBILLGENERATE]   
 (  
 @SAUDA_DATE VARCHAR(11),  
 @USERNAME VARCHAR(50) =''  
 ) AS  
  
DECLARE  @@MATURITYDATE VARCHAR(17)          
  
  
SELECT TOP 1 @@MATURITYDATE = LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) + ' 23:59'  
FROM BFOSCRIP2 (NOLOCK) WHERE  LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) = @SAUDA_DATE      
          
IF @@MATURITYDATE IS NOT NULL           
BEGIN          

	UPDATE  BFOCLOSING
	SET CLOSE_PRICE = SETTLEMENT_PRICE
	FROM BFOEXERCISEALLOCATION P
	WHERE TRADE_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	AND POSITION_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	AND BFOCLOSING.SERIES_CODE = P.SERIES_CODE
	-- AND PRODUCT_TYPE = P.PRODUCT_TYPE
	AND BFOCLOSING.PRODUCT_CODE = P.PRODUCT_CODE
	AND BFOCLOSING.ASSET_CODE = P.ASSET_CODE
	AND BFOCLOSING.EXPIRYDATE = P.EXPIRYDATE
	AND BFOCLOSING.STRIKE_PRICE = P.STRIKE_PRICE
	AND BFOCLOSING.OPTION_TYPE = P.OPTION_TYPE



  EXEC BFOREARRANGEBILLFLAG @@MATURITYDATE , @USERNAME  
END  
  
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'BILLGEN','',@USERNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOCLIENTTAXESPOP
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[BFOCLIENTTAXESPOP]     
 (    
  @IMPORTDATE VARCHAR(11)    = 'jan  1 2011'
 ) AS    
  
    
/*---------------------------------------------------------------------------------------------------------    
PROC NAME : BFOCLIENTTAXESPOP    
DESCRIPTION : POPULATING DATA INTO BFOCLIENTTAXES & FOCLIENTBROKSCHEME (FOR FIRST TIME ONLY)    
PARAMETER  : @IMPORTDATE - DATA IMPORT DATE    
----------------------------------------------------------------------------------------------------------*/    
    
TRUNCATE TABLE FOCLIENTBROKSCHEME    
TRUNCATE TABLE FOCLIENTTAXES    
    
/*----------------------------------------------------------------------------------------------------------    
  POPULATING CLIENT' BROKERAGE DETAILS AT FOCLIENTBROKSCHEME    
-----------------------------------------------------------------------------------------------------------*/    
INSERT INTO FOCLIENTBROKSCHEME    
SELECT    
 PARTY_CODE,    
 DATE_FROM   = @IMPORTDATE,    
 DATE_TO   = 'DEC 31 2049 23:59',    
 FUT_BROKTABLE  = STD_RATE,    
 OPT_BROKTABLE  = BROK2_TABLENO,    
 FUT_EXP_BROKTABLE = BROK1_TABLENO,    
 OPT_EXC_BROKTABLE = DUMMY2,    
 COMM_DEL_BROKTABLE = MF_TABLENO,    
 BROK_SCHEME  = BROK_SCHEME,    
 OPT_BROK_COMPUTEON = CASE WHEN DUMMY1 = 0     
    THEN 'PRICE' ELSE CASE     
    WHEN DUMMY1 = 1 THEN 'SPRICE'     
    ELSE  'SSPRICE' END END    
FROM    
 CLIENT2     
WHERE    
 PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOCLIENTBROKSCHEME)    
    
    
/*----------------------------------------------------------------------------------------------------------    
  POPULATING CLIENT' TAXES AND BROKERAGE ROUNDING DETAILS AT BFOCLIENTTAXES    
-----------------------------------------------------------------------------------------------------------*/    
    
INSERT INTO FOCLIENTTAXES    
SELECT     
 PARTY_CODE,    
 DATE_FROM = @IMPORTDATE,    
 DATE_TO = 'DEC 31 2049 23:59',    
 FUT_INSURANCE_CHRG = MAX(CASE WHEN INSURANCE_CHRG =1 THEN 1 ELSE 0 END),    
 FUT_TURNOVER_TAX = MAX(CASE WHEN TURNOVER_TAX =1 THEN FUT_TURNOVER_TAX ELSE 0 END),    
 FUT_OTHER_CHRG=MAX(CASE WHEN OTHER_CHRG =1 THEN FUT_OTHER_CHRG ELSE 0 END ),    
 FUT_SEBITURN_TAX=MAX(CASE WHEN SEBI_TURN_TAX=1 THEN FUT_SEBITURN_TAX ELSE 0 END),    
 FUT_BROKER_NOTE=MAX(CASE WHEN BROKERNOTE=1 THEN FUT_BROKER_NOTE ELSE 0 END),    
 OPT_INSURANCE_CHRG=MAX(CASE WHEN INSURANCE_CHRG =1 THEN 1 ELSE 0 END),    
 OPT_TURNOVER_TAX=MAX(CASE WHEN TURNOVER_TAX =1 THEN OPT_TURNOVER_TAX ELSE 0 END),    
 OPT_OTHER_CHRG=MAX(CASE WHEN OTHER_CHRG = 1 THEN OPT_OTHER_CHRG ELSE 0 END),    
 OPT_SEBITURN_TAX=MAX(CASE WHEN SEBI_TURN_TAX =1 THEN OPT_SEBITURN_TAX ELSE 0 END),    
 OPT_BROKER_NOTE =MAX(CASE WHEN BROKERNOTE =1 THEN OPT_BROKER_NOTE ELSE 0 END),    
 ROUND_TO,ROFIG,ERRNUM,NOZERO    
FROM    
(    
 SELECT     
  TRANS_CAT,    
  FUT_INSURANCE_CHRG  = 1,    
  FUT_TURNOVER_TAX  = TURNOVER_TAX,    
  FUT_OTHER_CHRG   = OTHER_CHRG,    
  FUT_SEBITURN_TAX  = SEBITURN_TAX,    
  FUT_BROKER_NOTE   = BROKER_NOTE,    
  OPT_INSURANCE_CHRG  = 0,    
  OPT_TURNOVER_TAX  = 0,    
  OPT_OTHER_CHRG   = 0,    
  OPT_SEBITURN_TAX  = 0,    
  OPT_BROKER_NOTE   = 0    
 FROM    
 BFOTAXES     

     
 UNION ALL    
     
 SELECT     
  TRANS_CAT,    
  FUT_INSURANCE_CHRG = 0,    
  FUT_TURNOVER_TAX = 0,    
  FUT_OTHER_CHRG  = 0,    
  FUT_SEBITURN_TAX = 0,    
  FUT_BROKER_NOTE  = 0,    
  OPT_INSURANCE_CHRG = INSURANCE_CHRG,    
  OPT_TURNOVER_TAX = TURNOVER_TAX,    
  OPT_OTHER_CHRG  = OTHER_CHRG,    
  OPT_SEBITURN_TAX = SEBITURN_TAX,    
  OPT_BROKER_NOTE  = BROKER_NOTE    
 FROM    
  BFOTAXES     
  
) BFOTAX,    
 CLIENT2,    
 BROKTABLE    
WHERE    
 CLIENT2.STD_RATE = BROKTABLE.TABLE_NO    
 AND BROKTABLE.LINE_NO = 1    
 AND CLIENT2.TRAN_CAT = BFOTAX.TRANS_CAT    
 AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOCLIENTTAXES)    
GROUP BY     
 BFOTAX.TRANS_CAT,PARTY_CODE,    
 ROUND_TO,ROFIG,ERRNUM,NOZERO    
    
UPDATE FOCLIENTTAXES SET FUT_INSURANCE_CHRG = TRDSELLTRANS, OPT_INSURANCE_CHRG = TRDSELLTRANS    
FROM BFOGLOBALS WHERE DATE_FROM BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND FUT_INSURANCE_CHRG = 1    

/*    
UPDATE CLIENT2 SET INSURANCE_CHRG = 1, TURNOVER_TAX = 1, OTHER_CHRG = 1, SEBI_TURN_TAX = 1, BROKERNOTE = 1    
    
UPDATE    
 MSAJAG.DBO.CLIENT_BROK_DETAILS    
SET    
 FUT_STT=1,FUT_TRAN_CHRGS=1,FUT_SEBI_FEES=1,    
 FUT_STAMP_DUTY=1,FUT_OTHER_CHRGS=1,    
    
 TRD_STT=FUT_INSURANCE_CHRG,TRD_TRAN_CHRGS=FUT_TURNOVER_TAX,    
 TRD_SEBI_FEES=FUT_SEBITURN_TAX,TRD_STAMP_DUTY=FUT_BROKER_NOTE,    
 TRD_OTHER_CHRGS=FUT_OTHER_CHRG,    
    
 DEL_STT=OPT_INSURANCE_CHRG,DEL_TRAN_CHRGS=OPT_TURNOVER_TAX,    
 DEL_SEBI_FEES=OPT_SEBITURN_TAX,DEL_STAMP_DUTY=OPT_BROKER_NOTE,    
 DEL_OTHER_CHRGS=OPT_OTHER_CHRG    
FROM    
 FOCLIENTTAXES    
WHERE    
 EXCHANGE ='BSE'    
 AND SEGMENT = 'FUTURES'    
 AND CL_CODE = FOCLIENTTAXES.PARTY_CODE    
*/    
/*----------------------------------------------- END OF FILE ---------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOClientTaxesPop_clmast
-- --------------------------------------------------

CREATE Procedure dbo.BFOClientTaxesPop_clmast     
 (    
  @ImportDate Varchar(11)  = 'jan  1 2000'  
 ) AS    
  
    
/*---------------------------------------------------------------------------------------------------------    
Proc Name : BFOClientTaxesPop    
Description : Populating Data into BFoClientTaxes & FoClientBrokScheme (for first time only)    
Parameter  : @ImportDate - Data Import Date    
----------------------------------------------------------------------------------------------------------*/    
    
delete  FoClientBrokScheme    where exists (select cl_code from Client_Brok_Details_Tmp
	where Client_Brok_Details_Tmp.cl_code = FoClientBrokScheme.party_code)
delete FoClientTaxes     where exists (select cl_code from Client_Brok_Details_Tmp
	where Client_Brok_Details_Tmp.cl_code = FoClientTaxes.party_code)
    
/*----------------------------------------------------------------------------------------------------------    
  Populating Client' Brokerage Details at FOCLIENTBROKSCHEME    
-----------------------------------------------------------------------------------------------------------*/    
Insert Into FoClientBrokScheme    
Select    
 Party_Code,    
 Date_From   = @ImportDate,    
 Date_To   = 'Dec 31 2049 23:59',    
 Fut_BrokTable  = Std_Rate,    
 Opt_BrokTable  = Brok2_TableNo,    
 Fut_Exp_BrokTable = Brok1_TableNo,    
 Opt_Exc_BrokTable = Dummy2,    
 Comm_Del_BrokTable = MF_TableNo,    
 Brok_Scheme  = Brok_Scheme,    
 Opt_Brok_ComputeOn = Case When Dummy1 = 0     
    Then 'PRICE' else Case     
    When Dummy1 = 1 Then 'SPRICE'     
    Else  'SSPRICE' End End    
From    
 Client2     
Where    
 Party_Code Not In (Select Party_Code From foClientBrokScheme)    
    
    
/*----------------------------------------------------------------------------------------------------------    
  Populating Client' Taxes and Brokerage Rounding Details at BFOCLIENTTAXES    
-----------------------------------------------------------------------------------------------------------*/    
    
Insert Into FoClientTaxes    
Select     
 Party_Code,    
 Date_From = @ImportDate,    
 Date_To = 'Dec 31 2049 23:59',    
 FUT_Insurance_Chrg = Max(Case When Insurance_Chrg =1 then 1 else 0 end),    
 FUT_Turnover_Tax = Max(case when Turnover_Tax =1 then FUT_Turnover_Tax else 0 end),    
 FUT_Other_Chrg=Max(case when Other_Chrg =1 then FUT_Other_Chrg else 0 end ),    
 FUT_Sebiturn_Tax=Max(case when Sebi_Turn_Tax=1 then FUT_Sebiturn_Tax else 0 end),    
 FUT_Broker_Note=Max(case when BrokerNote=1 then FUT_Broker_Note else 0 end),    
 OPT_Insurance_Chrg=Max(case when Insurance_Chrg =1 then 1 else 0 end),    
 OPT_Turnover_Tax=Max(case when Turnover_Tax =1 then OPT_Turnover_Tax else 0 end),    
 OPT_Other_Chrg=Max(case when Other_Chrg = 1 then OPT_Other_Chrg else 0 end),    
 OPT_Sebiturn_Tax=Max(case when Sebi_Turn_Tax =1 then OPT_Sebiturn_Tax else 0 end),    
 OPT_Broker_Note =Max(case when BrokerNote =1 then OPT_Broker_Note else 0 end),    
 Round_To,RoFig,ErrNum,NoZero    
From    
(    
 Select     
  Trans_Cat,    
  FUT_Insurance_Chrg  = 1,    
  FUT_Turnover_Tax  = Turnover_Tax,    
  FUT_Other_Chrg   = Other_Chrg,    
  FUT_Sebiturn_Tax  = Sebiturn_Tax,    
  FUT_Broker_Note   = Broker_Note,    
  OPT_Insurance_Chrg  = 0,    
  OPT_Turnover_Tax  = 0,    
  OPT_Other_Chrg   = 0,    
  OPT_Sebiturn_Tax  = 0,    
  OPT_Broker_Note   = 0    
 From    
 BFoTaxes     
where trans_cat = 'TRD'
     
 Union ALL    
     
 Select     
  Trans_Cat,    
  FUT_Insurance_Chrg = 0,    
  FUT_Turnover_Tax = 0,    
  FUT_Other_Chrg  = 0,    
  FUT_Sebiturn_Tax = 0,    
  FUT_Broker_Note  = 0,    
  OPT_Insurance_Chrg = Insurance_Chrg,    
  OPT_Turnover_Tax = Turnover_Tax,    
  OPT_Other_Chrg  = Other_Chrg,    
  OPT_Sebiturn_Tax = Sebiturn_Tax,    
  OPT_Broker_Note  = Broker_Note    
 From    
  BFoTaxes     
where trans_cat = 'TRD'
  
) BFoTax,    
 Client2,    
 BrokTable    
Where    
 Client2.Std_Rate = Broktable.Table_No    
 And BrokTable.Line_No = 1    
 And Client2.Tran_Cat = BFoTax.Trans_Cat    
 And Party_Code Not In (Select Party_Code From FOClientTaxes)    
Group By     
 BFoTax.Trans_Cat,Party_Code,   
 Round_To,RoFig,ErrNum,NoZero    
    
UPDATE FoClientTaxes SET Fut_Insurance_Chrg = TRDSELLTRANS, OPT_Insurance_Chrg = TRDSELLTRANS    
FROM BFOGLOBALS WHERE DATE_FROM BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND Fut_Insurance_Chrg = 1    
 
/*   
UPDATE CLIENT2 SET Insurance_Chrg = 1, Turnover_tax = 1, Other_chrg = 1, Sebi_Turn_tax = 1, BrokerNote = 1    
    
UPDATE    
 Msajag.dbo.Client_Brok_Details    
Set    
 Fut_Stt=1,Fut_Tran_Chrgs=1,Fut_Sebi_Fees=1,    
 Fut_Stamp_Duty=1,Fut_Other_Chrgs=1,    
    
 TRD_STT=Fut_Insurance_Chrg,Trd_Tran_Chrgs=Fut_Turnover_Tax,    
 Trd_Sebi_Fees=Fut_Sebiturn_Tax,Trd_Stamp_Duty=Fut_Broker_Note,    
 Trd_Other_Chrgs=Fut_Other_Chrg,    
    
 Del_Stt=Opt_Insurance_Chrg,Del_Tran_Chrgs=Opt_Turnover_Tax,    
 Del_SEBI_Fees=Opt_Sebiturn_Tax,Del_Stamp_Duty=Opt_Broker_Note,    
 Del_Other_Chrgs=OPT_Other_Chrg    
From    
 FoClientTaxes    
Where    
 Exchange ='BSE'    
 And Segment = 'FUTURES'    
 And Cl_Code = FoClientTaxes.Party_Code    
    */

/*----------------------------------------------- End of File ---------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOCLOSING_UPD
-- --------------------------------------------------

CREATE PROC BFOCLOSING_UPD 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT ,
	@INTFILETYPE INT
) AS 

IF @INTMODE=1
BEGIN
	TRUNCATE TABLE BFOCLOSING_IMP
	IF @INTFILETYPE = 1  /*NEW FORMAT*/
	BEGIN
	

		CREATE TABLE [dbo].[#BFOCLOSING_IMP]
		(
			[TRADE_DATE] [datetime] ,
			[SESSION_ID] [numeric](10, 0) ,
			[SERIES_ID] [numeric](10, 0) ,
			[SERIES_CODE] [varchar](22) ,
			[PRODUCT_TYPE] [varchar](3) ,
			[PRODUCT_CODE] [varchar](7) ,
			[ASSET_CODE] [varchar](8) ,
			[EXPIRYDATE] [datetime] ,
			[STRIKE_PRICE] [numeric](11, 4) ,
			[OPTION_TYPE] [varchar](2) ,
			[PRV_CLOSE_PRICE] [varchar](20) ,
			[OPEN_PRICE] [varchar](20) ,
			[HIGH_PRICE] [varchar](20) ,
			[LOW_PRICE] [varchar](20) ,
			[CLOSE_PRICE] [varchar](22) ,
			[TOTAL_TRADED_QTY] [varchar](20) ,
			[TOTAL_TRADED_VALUE] [varchar](20) ,
			[AVRG_TRADED_PRICE] [varchar](20) ,
			[NO_OF_TRADES] [varchar](20) ,
			[WEEK_HIGH] [varchar](20) ,
			[WEEK_LOW] [varchar](20) ,
			[OPEN_INTEREST] [varchar](20)
		) 
		INSERT INTO #BFOCLOSING_IMP

		SELECT
			TRADE_DATE = DBO.PIECE(FILE_DATA,',',1),
			SESSION_ID = DBO.PIECE(FILE_DATA,',',2),
			SERIES_ID = DBO.PIECE(FILE_DATA,',',3),
			SERIES_CODE = DBO.PIECE(FILE_DATA,',',4),
			PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',5),
			PRODUCT_CODE = DBO.PIECE(FILE_DATA,',',6),
			ASSET_CODE = DBO.PIECE(FILE_DATA,',',7),
			EXPIRYDATE = DBO.PIECE(FILE_DATA,',',8),
			STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',9),
			OPTION_TYPE = DBO.PIECE(FILE_DATA,',',10),
			PRV_CLOSE_PRICE = DBO.PIECE(FILE_DATA,',',11),
			OPEN_PRICE = DBO.PIECE(FILE_DATA,',',12),
			HIGH_PRICE = DBO.PIECE(FILE_DATA,',',13),
			LOW_PRICE = DBO.PIECE(FILE_DATA,',',14),
			CLOSE_PRICE = DBO.PIECE(FILE_DATA,',',15),
			TOTAL_TRADED_QTY = DBO.PIECE(FILE_DATA,',',16),
			TOTAL_TRADED_VALUE = DBO.PIECE(FILE_DATA,',',17),
			AVRG_TRADED_PRICE = DBO.PIECE(FILE_DATA,',',18),
			NO_OF_TRADES = DBO.PIECE(FILE_DATA,',',19),
			WEEK_HIGH = DBO.PIECE(FILE_DATA,',',20),
			WEEK_LOW = DBO.PIECE(FILE_DATA,',',21),
			OPEN_INTEREST = DBO.PIECE(FILE_DATA,',',22)
						
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID	
			
	
		UPDATE #BFOCLOSING_IMP SET PRV_CLOSE_PRICE =0 WHERE PRV_CLOSE_PRICE = '.-1'
		UPDATE #BFOCLOSING_IMP SET OPEN_PRICE =0 WHERE OPEN_PRICE = '.-1'
		UPDATE #BFOCLOSING_IMP SET CLOSE_PRICE =0 WHERE CLOSE_PRICE = '.-1'
		UPDATE #BFOCLOSING_IMP	SET PRV_CLOSE_PRICE =0 WHERE ISNULL(PRV_CLOSE_PRICE,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET OPEN_PRICE =0 WHERE ISNULL(OPEN_PRICE,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET HIGH_PRICE =0 WHERE ISNULL(HIGH_PRICE,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET LOW_PRICE =0 WHERE ISNULL(LOW_PRICE,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET CLOSE_PRICE =0 WHERE ISNULL(CLOSE_PRICE,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET TOTAL_TRADED_QTY =0 WHERE ISNULL(TOTAL_TRADED_QTY,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET TOTAL_TRADED_VALUE =0 WHERE ISNULL(TOTAL_TRADED_VALUE,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET AVRG_TRADED_PRICE =0 WHERE ISNULL(AVRG_TRADED_PRICE,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET NO_OF_TRADES =0 WHERE ISNULL(NO_OF_TRADES,'') = '' 
		UPDATE #BFOCLOSING_IMP	SET WEEK_HIGH =0 WHERE ISNULL(WEEK_HIGH,'') = ''
		UPDATE #BFOCLOSING_IMP	SET WEEK_LOW =0 WHERE ISNULL(WEEK_LOW,'') = ''
		UPDATE #BFOCLOSING_IMP	SET OPEN_INTEREST =0 WHERE ISNULL(OPEN_INTEREST,'') = ''
			
		INSERT INTO BFOCLOSING_IMP
		SELECT TRADE_DATE,SESSION_ID,SERIES_ID,SERIES_CODE,PRODUCT_TYPE,PRODUCT_CODE,
		ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		PRV_CLOSE_PRICE,OPEN_PRICE,HIGH_PRICE,LOW_PRICE,CLOSE_PRICE,
		TOTAL_TRADED_QTY,TOTAL_TRADED_VALUE,AVRG_TRADED_PRICE,
		NO_OF_TRADES,WEEK_HIGH,WEEK_LOW,OPEN_INTEREST
		FROM #BFOCLOSING_IMP
		
		DROP TABLE #BFOCLOSING_IMP
	
	END
	ELSE		/*OLD FORMAT*/
	BEGIN
		INSERT INTO BFOCLOSING_IMP
		SELECT
			TRADE_DATE = @SAUDA_DATE,
			SESSION_ID = 0,
			SERIES_ID = DBO.PIECE(FILE_DATA,'|',3),
			SERIES_CODE = DBO.PIECE(FILE_DATA,'|',4),
			PRODUCT_TYPE = DBO.PIECE(FILE_DATA,'|',2),
			PRODUCT_CODE = DBO.PIECE(FILE_DATA,'|',1),
			ASSET_CODE = LEFT(DBO.PIECE(FILE_DATA,'|',1),3),
			EXPIRYDATE = '',
			STRIKE_PRICE = 0,
			OPTION_TYPE = '',
			PRV_CLOSE_PRICE = DBO.PIECE(FILE_DATA,'|',5),
			OPEN_PRICE = 0,
			HIGH_PRICE = DBO.PIECE(FILE_DATA,'|',6),
			LOW_PRICE = DBO.PIECE(FILE_DATA,'|',7),
			CLOSE_PRICE = DBO.PIECE(FILE_DATA,'|',8),
			TOTAL_TRADED_QTY = DBO.PIECE(FILE_DATA,'|',10),
			TOTAL_TRADED_VALUE = DBO.PIECE(FILE_DATA,'|',11),
			AVRG_TRADED_PRICE = 0,
			NO_OF_TRADES = DBO.PIECE(FILE_DATA,'|',12),
			WEEK_HIGH = 0,
			WEEK_LOW = 0,
			OPEN_INTEREST = DBO.PIECE(FILE_DATA,'|',15)
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID
			AND LEN(FILE_DATA) > 100	
	END
		
END

UPDATE BFOCLOSING_IMP SET PRV_CLOSE_PRICE  = 0 WHERE ISNULL(PRV_CLOSE_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET OPEN_PRICE  = 0 WHERE ISNULL(OPEN_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET HIGH_PRICE  = 0 WHERE ISNULL(HIGH_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET LOW_PRICE  = 0 WHERE  ISNULL(LOW_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET TOTAL_TRADED_QTY  = 0 WHERE ISNULL(TOTAL_TRADED_QTY,'') = ''
UPDATE BFOCLOSING_IMP SET TOTAL_TRADED_VALUE  = 0 WHERE ISNULL(TOTAL_TRADED_VALUE,'') = ''
UPDATE BFOCLOSING_IMP SET AVRG_TRADED_PRICE  = 0 WHERE ISNULL(AVRG_TRADED_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET NO_OF_TRADES  = 0 WHERE  ISNULL(NO_OF_TRADES,'') = ''
UPDATE BFOCLOSING_IMP SET WEEK_HIGH  = 0 WHERE ISNULL(WEEK_HIGH,'') = ''
UPDATE BFOCLOSING_IMP SET WEEK_LOW  = 0 WHERE ISNULL(WEEK_LOW,'') = ''


DELETE BFOCLOSING FROM
	BFOCLOSING (NOLOCK), BFOCLOSING_IMP 
WHERE
	BFOCLOSING.TRADE_DATE = BFOCLOSING_IMP.TRADE_DATE
	AND BFOCLOSING.SERIES_CODE = BFOCLOSING_IMP.SERIES_CODE

UPDATE BFOCLOSING_IMP SET EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59'
	
INSERT INTO BFOCLOSING
SELECT *,@UNAME,GETDATE()
FROM BFOCLOSING_IMP

TRUNCATE TABLE BFOCLOSING_IMP

EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CLRATE','',@UNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFODUPRECSETTCHECK
-- --------------------------------------------------
CREATE PROC [DBO].[BFODUPRECSETTCHECK] AS
DELETE BFOTRADE FROM BFOSETTLEMENT S WHERE 
CONVERT(VARCHAR,BFOTRADE.SAUDA_DATE,106) = CONVERT(VARCHAR,S.SAUDA_DATE,106)
AND REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(BFOTRADE.TRADE_NO,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','') = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(S.TRADE_NO,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','')
AND BFOTRADE.ORDER_NO =  S.ORDER_NO
AND BFOTRADE.PRODUCT_TYPE=S.PRODUCT_TYPE
AND BFOTRADE.PRODUCT_CODE=S.PRODUCT_CODE
AND BFOTRADE.SERIES_ID = S.SERIES_ID
AND BFOTRADE.SERIES_CODE =S.SERIES_CODE
AND BFOTRADE.SELL_BUY = S.SELL_BUY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOGENBILLNO
-- --------------------------------------------------
CREATE PROC [DBO].[BFOGENBILLNO] (@BILLDATE VARCHAR(11)) AS
DECLARE @@BILLFLAG INT,
@@PARTY_CODE VARCHAR(10),
@@BILLNO INT,
@@BILLCUR CURSOR
PRINT "TEST"
UPDATE BFOACCBILL SET BILL_NO = 0 WHERE BILLDATE LIKE @BILLDATE + '%'
SELECT "TEST1"
UPDATE BFOACCBILL SET START_DATE=@BILLDATE +' 23:59:00',END_DATE=@BILLDATE +' 23:59:00',PAYIN_DATE=@BILLDATE +' 23:59:00',PAYOUT_DATE=@BILLDATE +' 23:59:00'  
WHERE BILLDATE  LIKE @BILLDATE + '%'
  SELECT "TEST2"
SELECT @@BILLNO = 0 
SET @@BILLCUR = CURSOR FOR
SELECT ISNULL(COUNT(*),0) FROM BFOBILLNO WHERE BILLDATE LIKE @BILLDATE + '%'
OPEN @@BILLCUR 
FETCH NEXT FROM @@BILLCUR INTO @@BILLFLAG 
CLOSE @@BILLCUR
SELECT "BILLFLAG" , @@BILLFLAG
IF @@BILLFLAG = 0 
BEGIN
  SELECT "TEST3"
	SET  @@BILLCUR = CURSOR FOR
	SELECT A.PARTY_CODE FROM BFOACCBILL A,CLIENT2 C WHERE BILLDATE LIKE @BILLDATE + '%'
	AND C.PARTY_CODE = A.PARTY_CODE ORDER BY A.PARTY_CODE
	OPEN @@BILLCUR 
	FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
             SELECT   "TEST4" ,@@PARTY_CODE
	SELECT @@BILLNO = 1
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		UPDATE BFOACCBILL SET BILL_NO = @@BILLNO WHERE BILLDATE LIKE @BILLDATE + '%' AND PARTY_CODE = @@PARTY_CODE
		SELECT @@BILLNO = @@BILLNO + 1
		FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
	END	
END
ELSE
BEGIN
SELECT "TEST5"
	UPDATE BFOACCBILL SET BILL_NO = BFOBILLNO.BILL_NO FROM BFOBILLNO WHERE BFOACCBILL.BILLDATE LIKE @BILLDATE + '%' 
	AND BFOACCBILL.BILLDATE = BFOBILLNO.BILLDATE AND BFOACCBILL.PARTY_CODE = BFOBILLNO.PARTY_CODE 
	
	SELECT @@BILLNO = 0 
	SET @@BILLCUR = CURSOR FOR
	SELECT ISNULL(MAX(BILL_NO),0)+1 FROM BFOBILLNO WHERE BILLDATE LIKE @BILLDATE + '%'
	OPEN @@BILLCUR 
	FETCH NEXT FROM @@BILLCUR INTO @@BILLNO
	CLOSE @@BILLCUR
           --  DEALLOCATE @@BILLCUR
	SET @@BILLCUR = CURSOR FOR
	SELECT A.PARTY_CODE FROM BFOACCBILL A,CLIENT2 C WHERE BILLDATE LIKE @BILLDATE + '%'
	AND C.PARTY_CODE = A.PARTY_CODE AND BILL_NO = 0 ORDER BY A.PARTY_CODE
	OPEN @@BILLCUR 
	FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		UPDATE BFOACCBILL SET BILL_NO = @@BILLNO WHERE BILLDATE LIKE @BILLDATE + '%' AND PARTY_CODE = @@PARTY_CODE
		SELECT @@BILLNO = @@BILLNO + 1
		FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
	END
END
INSERT INTO BFOBILLNO
SELECT DISTINCT A.PARTY_CODE,A.BILL_NO,BILLDATE FROM BFOACCBILL A,CLIENT2 C WHERE BILLDATE LIKE @BILLDATE + '%'
AND C.PARTY_CODE = A.PARTY_CODE AND A.PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM BFOBILLNO WHERE 
BILLDATE = A.BILLDATE )
SET @@BILLCUR = CURSOR FOR
SELECT PARTY_CODE,BILL_NO FROM BFOBILLNO WHERE BILLDATE LIKE @BILLDATE + '%'
AND PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM BFOACCBILL WHERE BILLDATE = BFOBILLNO.BILLDATE )
OPEN @@BILLCUR 
FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE,@@BILLNO
WHILE @@FETCH_STATUS = 0 
BEGIN
	INSERT INTO BFOACCBILL
	/*SELECT @@PARTY_CODE,@@BILLNO,1,SETT_NO,SETT_TYPE,BILLDATE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,0,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION FROM FOACCBILL 
	WHERE PARTY_CODE = '99885' AND BILLDATE LIKE @BILLDATE + '%'*/
        
        SELECT @@PARTY_CODE,@@BILLNO,1,SETT_NO,SETT_TYPE,BILLDATE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,AMOUNT,MTM,PREMIUMPAYABLE,PREMIUMRECEIVABLE,NETPREMIUM,BROKERAGE,SERVICETAX,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,BRANCHCD,NARRATION FROM BFOACCBILL 
	WHERE PARTY_CODE = ( SELECT ACCODE FROM VALANACCOUNT A WHERE
                               EFFDATE = (SELECT MAX(EFFDATE) FROM VALANACCOUNT V
                                          WHERE EFFDATE <=@BILLDATE AND A.ACNAME=V.ACNAME) 
                             AND ACNAME ='CLEARING HOUSE') AND BILLDATE LIKE @BILLDATE + '%'
        
	FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE,@@BILLNO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOGENCONTRACT
-- --------------------------------------------------

CREATE PROCEDURE [DBO].BFOGENCONTRACT  ( @UNAME VARCHAR(50)='')
AS     
DECLARE @@PARTY VARCHAR(12),    
 @@SETT_TYPE VARCHAR(2),      
 @@CONTNO VARCHAR(7),    
 @@CONTNOPARTIPANT VARCHAR(7),    
 @@PARTICIPANTCODE VARCHAR(15),    
 @@MEMBERCODE VARCHAR(15),    
 @@SAUDA_DATE VARCHAR(11),    
 @@ORDER_NO VARCHAR(20),    
 @@SCRIP_CD VARCHAR(12),    
 @@SERIES VARCHAR(2),    
 @@SELL_BUY INT,    
 @@STYLE INT,    
 @@STARTDATE VARCHAR(11),    
 @@ENDDATE VARCHAR(11),    
 @@FLAG INT,    
 @@CONT CURSOR  ,      
 @@PARTYCONT CURSOR    ,    
 @@CURSETTTYPE VARCHAR(2),    
 @@INSCONTNO VARCHAR(7),    
 @@EXPIRYDATE DATETIME,    
 @@STRIKEPRICE MONEY,    
 @@OPTIONTYPE VARCHAR(2),          
 @@PRODUCT_TYPE VARCHAR(6),    
 @@PRODUCT_CODE VARCHAR(12),    
 @@SERIES_CODE VARCHAR(12),    
 @@SERIES_ID INT,   
 @@MAXCONTNOS INT,    
 @@MAXCONNOI  INT,    
 @@BBGCONTCUR CURSOR,    
 @@GETMAXCONTNO CURSOR,    
 @@INSCONT   VARCHAR(4),    
 @@CL_RATE NUMERIC(36,12)    
    
 SELECT TOP 1 @@SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) FROM BFOTRADE     
 SELECT @@MEMBERCODE=MEMBERCODE,@@STYLE=ISNULL(STYLE,0) FROM BFOOWNER    

TRUNCATE TABLE BBGBFOSETTLEMENT    
  

INSERT INTO BBGBFOSETTLEMENT 
SELECT CONTRACTNO='0000000',TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,
PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,
SELL_BUY,TRADEQTY,SETTFLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,
CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,
BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,BFOCONFIRMVIEW.TABLE_NO,LINE_NO,
VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,
SEBI_TAX,BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART='',
RESERVED1 = CASE WHEN ISNULL(PARTICIPANTCODE,'') = MEMBERCODE OR ISNULL(PARTICIPANTCODE,'') ='' THEN 0 ELSE 1 END,
DUMMY1=0,DUMMY2=TRADE_PRICE,STATUS = '11'
FROM BFOCONFIRMVIEW, BFOOWNER

IF (SELECT MEMBERTYPE FROM BFOOWNER) = 'CM'
BEGIN
	UPDATE BBGBFOSETTLEMENT SET RESERVED1 = 2
END

IF @@STYLE = 0    
BEGIN    
     SET @@BBGCONTCUR =  CURSOR FOR    
     SELECT ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM BFOSETTLEMENT    
     WHERE SAUDA_DATE BETWEEN  @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:9'   
     AND CONVERT(INT,CONTRACTNO) <> 0    
END    
    
IF @@STYLE = 1     
BEGIN    
     SET @@BBGCONTCUR = CURSOR FOR     
     SELECT ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE         
END     
                       
OPEN @@BBGCONTCUR    
FETCH NEXT FROM @@BBGCONTCUR INTO @@MAXCONTNOS    
CLOSE @@BBGCONTCUR    
     SET @@PARTYCONT = CURSOR FOR    
     SELECT DISTINCT I.PARTY_CODE,I.CONTRACTNO,I.ORDER_NO,SERIES_CODE,INSCONT     
     FROM BFOSETTLEMENT I (NOLOCK),CLIENT2 C2 (NOLOCK)    
     WHERE I.SAUDA_DATE BETWEEN  @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:9'       
     AND I.PARTY_CODE = C2.PARTY_CODE     
     AND CONVERT(INT,I.CONTRACTNO) <> 0    
     ORDER BY I.PARTY_CODE,SERIES_CODE,I.CONTRACTNO    
     OPEN @@PARTYCONT    
     FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@CONTNO,@@ORDER_NO,@@SERIES_CODE,@@INSCONT    
     WHILE @@FETCH_STATUS = 0    
     BEGIN    
          IF @@INSCONT = 'N' OR @@INSCONT IS NULL OR @@INSCONT = ''    
          BEGIN    
               UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = @@CONTNO     
               WHERE    
               PARTY_CODE = @@PARTY    
          END    
          IF @@INSCONT = 'O'     
			BEGIN
				UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = @@CONTNO     
				WHERE PARTY_CODE = @@PARTY AND    
				ORDER_NO = @@ORDER_NO    
			END    
			IF @@INSCONT = 'S'     
			BEGIN     
				UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = @@CONTNO     
				WHERE  
				PARTY_CODE = @@PARTY AND   
				SERIES_CODE = @@SERIES_CODE     
			END    
     FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@CONTNO,@@ORDER_NO,@@SERIES_CODE,@@INSCONT      
     END         
     CLOSE @@PARTYCONT    
     SET @@PARTY=''    
            
     SET @@PARTYCONT = CURSOR FOR     
     SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE  FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1     
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE     
     AND INSCONT = 'N' AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'    
     ORDER BY BBGBFOSETTLEMENT.PARTY_CODE     
     OPEN @@PARTYCONT    
     FETCH NEXT  FROM @@PARTYCONT INTO   @@PARTY    
     WHILE @@FETCH_STATUS = 0    
     BEGIN    
          SET @@CONTNO =@@MAXCONTNOS +1    
          SET @@MAXCONTNOS = @@MAXCONTNOS + 1    
          UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE    
          PARTY_CODE =@@PARTY     
          FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY    
     END    
     CLOSE @@PARTYCONT    
     SET @@PARTY=''    
    
     SET @@PARTYCONT = CURSOR FOR     
     SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.ORDER_NO FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1    
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE    
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'    
     AND INSCONT  =  'O'    
     ORDER BY BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.ORDER_NO      
     OPEN @@PARTYCONT    
     FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@ORDER_NO    
     WHILE @@FETCH_STATUS = 0    
     BEGIN    
          SET @@CONTNO = 0    
          SET @@CONTNO =@@MAXCONTNOS +1    
          SET @@MAXCONTNOS = @@MAXCONTNOS + 1    
          UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE    
          PARTY_CODE =@@PARTY     
          AND ORDER_NO = @@ORDER_NO    
          FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@ORDER_NO    
     END    
    
     CLOSE @@PARTYCONT    
     SET @@PARTY=''    
     SET @@ORDER_NO = ''     
          
        SET @@PARTYCONT = CURSOR FOR     
		SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE,SERIES_CODE    
		FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1    
		WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'    
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'    
        ORDER BY BBGBFOSETTLEMENT.PARTY_CODE,SERIES_CODE   
        OPEN @@PARTYCONT    
        FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@SERIES_CODE
        WHILE @@FETCH_STATUS = 0    
        BEGIN    
		  SET @@CONTNO = 0    
		  SET @@CONTNO =@@MAXCONTNOS +1    
		  SET @@MAXCONTNOS = @@MAXCONTNOS + 1    
		  UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE    
		  PARTY_CODE = @@PARTY AND    
		  SERIES_CODE = @@SERIES_CODE     
 
        FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@SERIES_CODE    
        END    
        CLOSE @@PARTYCONT    
 DEALLOCATE @@PARTYCONT    
 UPDATE BFOOWNER SET CONTNO = @@CONTNO     
  
IF @@STYLE = 1     
 BEGIN     
 UPDATE CONTGEN SET CONTRACTNO = @@CONTNO WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE     
 END    
INSERT INTO BFOSETTLEMENT SELECT * FROM BBGBFOSETTLEMENT    
    
    
TRUNCATE TABLE  BFOTRADE    
  
EXEC CALCULATE_STAMP_DUTY @@SAUDA_DATE

EXEC V2_PROCESS_STATUS_LOG_UPD @@SAUDA_DATE,'IMPTRD','',@UNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOGENCONTRACT_EXPIRY
-- --------------------------------------------------


CREATE PROCEDURE BFOGENCONTRACT_EXPIRY 
AS 

DECLARE @@PARTY			VARCHAR(12),
        @@CONTNO		VARCHAR(7),
        @@MEMBERCODE	VARCHAR(15),
        @@SAUDA_DATE	VARCHAR(11),
        @@ORDER_NO		VARCHAR(20),
        @@STYLE			INT,
        @@PARTYCONT		CURSOR    ,
        @@PRODUCT_CODE		VARCHAR(10),
		@@SERIES_CODE		VARCHAR(20),
		@@EXPIRYDATE	DATETIME,
		@@STRIKEPRICE	MONEY,
		@@MARKETTYPE	VARCHAR(2),      
		@@MAXCONTNOS	INT,
		@@MAXCONNOI		INT,
		@@INSCONT		VARCHAR(4),
		@@TRDDELFLAG	INT

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	SELECT TOP 1  @@SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) FROM  BFOTRADE 

	SELECT @@MEMBERCODE=MEMBERCODE,@@STYLE=ISNULL(STYLE,0) FROM BFOOWNER

	SET  @@TRDDELFLAG = 0
	SELECT @@TRDDELFLAG = TRDDELFLAG FROM CONTGEN WHERE
	@@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 

	IF @@TRDDELFLAG = 0
	BEGIN
		IF @@STYLE = 0
		BEGIN
			SELECT @@MAXCONTNOS  = ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM BFOSETTLEMENT
			WHERE SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59'
			AND CONVERT(INT,CONTRACTNO) <> 0
		END
		ELSE
		BEGIN
			SELECT @@MAXCONTNOS = ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 	
		END
	END
	ELSE
	BEGIN
		SELECT @@MAXCONTNOS = ISNULL(CONVERT(INT,FUTDELCONTRACTNO),0) FROM CONTGEN WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 	
	END

	IF @@TRDDELFLAG = 0
	BEGIN
		SELECT DISTINCT I.PARTY_CODE,I.CONTRACTNO,I.ORDER_NO,I.SERIES_CODE,INSCONT 
		INTO #CONTRACTNO
		FROM BFOSETTLEMENT I ,CLIENT2_VIEW C2 
		WHERE I.SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59'
		AND I.PARTY_CODE = C2.PARTY_CODE 
		AND I.CONTRACTNO <> '0000000' 
		AND EXISTS (SELECT PARTY_CODE FROM BBGBFOSETTLEMENT F WHERE F.PARTY_CODE = I.PARTY_CODE)
		  
		UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = C.CONTRACTNO 
		FROM #CONTRACTNO C
		WHERE
			BBGBFOSETTLEMENT.PARTY_CODE = C.PARTY_CODE			
			AND ISNULL(INSCONT,'') IN ('N','')
			
		UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = C.CONTRACTNO 
		FROM #CONTRACTNO C
		WHERE
			BBGBFOSETTLEMENT.PARTY_CODE = C.PARTY_CODE			
			AND C.ORDER_NO = BBGBFOSETTLEMENT.ORDER_NO
			AND INSCONT ='O'			

		UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = C.CONTRACTNO 
		FROM #CONTRACTNO C
		WHERE
			BBGBFOSETTLEMENT.PARTY_CODE = C.PARTY_CODE
			AND C.SERIES_CODE = BBGBFOSETTLEMENT.SERIES_CODE
			AND INSCONT ='S'
		
		DROP TABLE #CONTRACTNO
	  
	END

        
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE  FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1 
     WHERE CONTRACTNO <> '0000000'  AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE 
     AND INSCONT NOT IN ('O','S')
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'  AND TRADE_PRICE <> 0
     ORDER BY BBGBFOSETTLEMENT.PARTY_CODE 
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO   @@PARTY
     WHILE @@FETCH_STATUS = 0
     BEGIN
			SET @@CONTNO =@@MAXCONTNOS +1
			SET @@MAXCONTNOS = @@MAXCONTNOS + 1

			UPDATE BBGBFOSETTLEMENT SET 
			CONTRACTNO = CASE WHEN @@TRDDELFLAG = 1 THEN 'C' ELSE '' END + 
						 STUFF('0000000', (CASE WHEN @@TRDDELFLAG = 1 THEN 7 ELSE 8 END) - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO)
			WHERE
				PARTY_CODE =@@PARTY 

			FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY
     END
     CLOSE @@PARTYCONT
     
     SET @@PARTY=''
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.ORDER_NO FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1
     WHERE CONTRACTNO <> '0000000'  AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'   AND TRADE_PRICE <> 0
     AND INSCONT  =  'O'
     ORDER BY BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.ORDER_NO  
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@ORDER_NO
     WHILE @@FETCH_STATUS = 0
     BEGIN
			SET @@CONTNO = 0
			SET @@CONTNO =@@MAXCONTNOS +1
			SET @@MAXCONTNOS = @@MAXCONTNOS + 1

			UPDATE BBGBFOSETTLEMENT SET 
			CONTRACTNO = CASE WHEN @@TRDDELFLAG = 1 THEN 'C' ELSE '' END + 
						 STUFF('0000000', (CASE WHEN @@TRDDELFLAG = 1 THEN 7 ELSE 8 END) - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO)
			WHERE
				PARTY_CODE =@@PARTY 
				AND ORDER_NO = @@ORDER_NO

			FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@ORDER_NO
     END
 
     CLOSE @@PARTYCONT
     SET @@PARTY=''
     SET @@ORDER_NO = ''	
      
        SET @@PARTYCONT = CURSOR FOR 
        SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.PRODUCT_CODE,
			BBGBFOSETTLEMENT.SERIES_CODE
		FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1
		WHERE CONTRACTNO <> '0000000' 
		AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'
     	AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'   AND TRADE_PRICE <> 0
        ORDER BY BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.PRODUCT_CODE,
        BBGBFOSETTLEMENT.SERIES_CODE
        OPEN @@PARTYCONT
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@PRODUCT_CODE,@@SERIES_CODE

        WHILE @@FETCH_STATUS = 0
        BEGIN
				SET @@CONTNO = 0
				SET @@CONTNO =@@MAXCONTNOS +1
				SET @@MAXCONTNOS = @@MAXCONTNOS + 1

				UPDATE BBGBFOSETTLEMENT SET 
				CONTRACTNO = CASE WHEN @@TRDDELFLAG = 1 THEN 'C' ELSE '' END + 
						 STUFF('0000000', (CASE WHEN @@TRDDELFLAG = 1 THEN 7 ELSE 8 END) - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO)
				WHERE
					PARTY_CODE =@@PARTY 
					AND SERIES_CODE = @@SERIES_CODE
	
				
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@PRODUCT_CODE,@@SERIES_CODE
        END
        CLOSE @@PARTYCONT

	IF @@MAXCONTNOS IS NOT NULL
	BEGIN
		UPDATE BFOOWNER SET CONTNO = @@MAXCONTNOS 
	
		IF @@TRDDELFLAG = 1 
		BEGIN
			UPDATE CONTGEN SET FUTDELCONTRACTNO = @@MAXCONTNOS WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 
		END
		ELSE
		BEGIN
			UPDATE CONTGEN SET CONTRACTNO = @@MAXCONTNOS WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 
		END
	END
	
	DEALLOCATE @@PARTYCONT

/*--------------------------------------------- END OF THE PROC ---------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOIMPTRDSPCHG
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.BFOIMPTRDSPCHG    SCRIPT DATE: 01/10/2003 7:33:12 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BFOIMPTRDSPCHG    SCRIPT DATE: 10/13/2001 3:50:04 AM ******/
CREATE PROC  [DBO].[BFOIMPTRDSPCHG] 
 (@PARTYCODE VARCHAR(7),
  @USERID VARCHAR(5)
  )
 AS
 /*USED IN BSE FO */ 
 /*CONTROL NAME :BFOIMPORTTRADE MODULE NAME :CMDPSAVE_CLICK()*/
 /*TABLE USED :WRITE ONLY FOTRADE*/
 /*FUNCTION:THIS USED TO MISSING CLIENT I.E THE CLIENTS PARTYCODE PRSERNT IN THE FOTRADE TABLE BUT NOT IN CLIENT2 TABLE*/            
 /*WRITTEN BY :RANJEET CHOUDHARY */
 UPDATE BFOTRADE SET PARTY_CODE = @PARTYCODE
 WHERE USER_ID =@USERID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOINSERTINSTTRD
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.BFOINSERTINSTTRD    SCRIPT DATE: 01/10/2003 7:33:00 PM ******/
CREATE PROCEDURE [DBO].[BFOINSERTINSTTRD]
       @FILEDATE                 DATETIME            = NULL,   
       @PRODUCT_CODE             VARCHAR(7)          = NULL,   
       @PRODUCT_TYPE             VARCHAR(5)          = NULL,   
       @SERIES_ID                INT                 = NULL,   
       @SERIESCODE               VARCHAR(14)         = NULL,   
       @SELLBUY                  INT                 = NULL,   
       @QUANTITY                 INT                 = NULL,   
       @PRICE                    MONEY               = NULL,   
       @PARTYCODE                VARCHAR(10)         = NULL,   
       @MEMBERCODE               VARCHAR(10)         = NULL,   
       @TRADERCODE               VARCHAR(10)         = NULL,   
       @TRADE_NO                 VARCHAR(20)         = NULL,   
       @SAUDA_DATE               DATETIME            = NULL,   
       @STATUS                   VARCHAR(5)          = NULL,   
       @ORDER_NO                 VARCHAR(20)         = NULL,   
       @CL_TYPE             VARCHAR(3)  = NULL,
       @RESERVED1                VARCHAR(10)         = NULL,   
       @RESERVED2                VARCHAR(10)         = NULL,   
       @RESERVED3                VARCHAR(10)         = NULL    
AS
       DECLARE @PROCNAME VARCHAR(50)
       SELECT @PROCNAME = OBJECT_NAME(@@PROCID)
       BEGIN TRANSACTION TRNINSTRADE
              BEGIN
                     INSERT INTO BFOINSTTRADE(
                                          FILEDATE,
                                          PRODUCT_CODE,
                                          PRODUCT_TYPE,
                                          SERIES_ID,
                                          SERIES_CODE,
                                          SELL_BUY,
                                          TRADEQTY,
                                         MARKETRATE,
                                          PARTYCODE,
                                          MEMBERCODE,
                                          TRADERCODE,
                                          TRADE_NO,
                                          SAUDA_DATE,
                                          STATUS,
                                          ORDER_NO,
                                          CL_TYPE, 
                                          RESERVED1,
                                          RESERVED2,
                                          RESERVED3
                                          )
                     SELECT
                                          @FILEDATE,
                                          @PRODUCT_CODE,
                                          @PRODUCT_TYPE,
                                          @SERIES_ID,
                                          @SERIESCODE,
                                          @SELLBUY,
                                          @QUANTITY,
                                          @PRICE,
                                          @PARTYCODE,
                                          @MEMBERCODE,
                                          @TRADERCODE,
                                          @TRADE_NO,
                                          @SAUDA_DATE,
                                          @STATUS,
                                          @ORDER_NO,
                                          @CL_TYPE,
                                          @RESERVED1,
                                          @RESERVED2,
                                          @RESERVED3
                     IF @@ERROR != 0
                            BEGIN
                                   ROLLBACK TRANSACTION TRNINSTRADE
                                   RAISERROR('ERROR INSERTING INTO TABLE BFOINSTTRADE.  ERROR OCCURRED IN PROCEDURE %S.  ROLLING BACK TRANSACTION...', 16, 1, @PROCNAME)
                                   RETURN
                            END
                     ELSE
                            BEGIN
                                   COMMIT TRANSACTION TRNINSTRADE
                            END
              END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOINSTREARRANGEAFTERCONTFLAG
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.BFOINSTREARRANGEAFTERCONTFLAG    SCRIPT DATE: 01/10/2003 7:32:58 PM ******/
CREATE PROCEDURE [DBO].[BFOINSTREARRANGEAFTERCONTFLAG] 
@PARTY_CODE VARCHAR(10),
@PRODUCT_TYPE VARCHAR(3),
@PRODUCT_CODE VARCHAR(10),
@SERIES_CODE VARCHAR(13),
@EXPIRYDATE VARCHAR(11),
@SERIES_ID INT,
@TDATE VARCHAR(11)
AS 

DECLARE 
 @@TRADE_NO VARCHAR(14),
 @@PQTY NUMERIC(9), 
 @@SQTY NUMERIC(9),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(9), 
 @@PDIFF NUMERIC(9),
 @@FLAG CURSOR,
 @@LOOP CURSOR
	UPDATE BFOSETTLEMENT SET SETTFLAG = (CASE WHEN S.SELL_BUY = 1 THEN 2
						ELSE 3 END )
	FROM BFOSETTLEMENT S,BFOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
        	AND B.PRODUCT_CODE = B.PRODUCT_CODE
	AND B.PRODUCT_TYPE = B.PRODUCT_TYPE
	AND B.SERIES_CODE = S.SERIES_CODE
	AND B.EXPIRYDATE = S.EXPIRYDATE
	AND B.SERIES_ID = B.SERIES_ID
	AND B.SQTY<> 0 AND B.PQTY <>  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.PRODUCT_CODE = @PRODUCT_CODE
	AND S.PRODUCT_TYPE = @PRODUCT_TYPE
	AND S.SERIES_CODE = @SERIES_CODE
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND S.SERIES_ID = @SERIES_ID
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   
	
	UPDATE BFOSETTLEMENT SET SETTFLAG = 4 FROM BFOSETTLEMENT S,BFOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
        	AND B.PRODUCT_CODE = B.PRODUCT_CODE
	AND B.PRODUCT_TYPE = B.PRODUCT_TYPE
	AND B.SERIES_CODE = S.SERIES_CODE
	AND B.EXPIRYDATE = S.EXPIRYDATE
	AND B.SERIES_ID = B.SERIES_ID
	AND  B.SQTY = 0 AND B.PQTY >  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.PRODUCT_CODE = @PRODUCT_CODE
	AND S.PRODUCT_TYPE = @PRODUCT_TYPE
	AND S.SERIES_CODE = @SERIES_CODE
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND S.SERIES_ID = @SERIES_ID
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   
	UPDATE BFOSETTLEMENT SET SETTFLAG = 5 FROM BFOSETTLEMENT S,BFOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
        	AND B.PRODUCT_CODE = B.PRODUCT_CODE
	AND B.PRODUCT_TYPE = B.PRODUCT_TYPE
	AND B.SERIES_CODE = S.SERIES_CODE
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND B.SERIES_ID = B.SERIES_ID
	AND  B.SQTY > 0 AND B.PQTY =  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.PRODUCT_CODE = @PRODUCT_CODE
	AND S.PRODUCT_TYPE = @PRODUCT_TYPE
	AND S.SERIES_CODE = @SERIES_CODE
	AND S.EXPIRYDATE = @EXPIRYDATE
	AND S.SERIES_ID = @SERIES_ID
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   
SET @@FLAG = CURSOR FOR
	 SELECT PQTY,SQTY FROM BFOCURSORCONTUNEQUALSALEPUR
	 WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE
	 AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
	 AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
	 AND SERIES_ID = @SERIES_ID
	 AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
	 AND PQTY <> 0 AND  SQTY <> 0 AND ISNULL(PQTY,0) <> ISNULL(SQTY,0)
	 GROUP BY PQTY,SQTY
OPEN @@FLAG
FETCH NEXT FROM @@FLAG INTO @@PQTY,@@SQTY
IF @@FETCH_STATUS = 0 	
	BEGIN
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @@PQTY > @@SQTY 
		        	BEGIN 
				SELECT @@PDIFF = @@PQTY - @@SQTY 
				  /*FIND A TRADE WHOSE TRADEQTY = THE DIFF IN PATY AND SQTY AND UPDATE IT WITH SETFLAG = 4 */	
				SET @@LOOP  = CURSOR FOR 
					SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
					WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 1 AND TRADEQTY = @@PDIFF 
				 OPEN @@LOOP
				 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				 IF @@FETCH_STATUS = 0 
				 BEGIN 
					UPDATE BFOSETTLEMENT SET SETTFLAG = 4   
					WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  
				CLOSE @@LOOP
				DEALLOCATE @@LOOP 
			  	END
			  	ELSE IF @@FETCH_STATUS <> 0  
			 	BEGIN 
					CLOSE @@LOOP
				   	DEALLOCATE @@LOOP  
				   	SET @@LOOP  = CURSOR FOR 
						SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
					   	WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
		   			        AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID 
						AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   AND SELL_BUY = 1 
						ORDER BY TRADEQTY DESC
				   	OPEN @@LOOP
				  	FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				  	WHILE @@PDIFF > 0       
				  	BEGIN
						IF @@PDIFF >= @@LQTY 	
	                                        BEGIN
					     		UPDATE BFOSETTLEMENT SET SETTFLAG = 4   
							WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  
					     		SELECT @@PDIFF = @@PDIFF - @@LQTY
						END    
					        ELSE IF @@PDIFF < @@LQTY 
			    			BEGIN
							
 							
							INSERT INTO BFOSETTLEMENT SELECT CONTRACTNO,BILLNO,'B'+TRADE_NO,PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,MULTIPLIER,USER_ID,@@PDIFF,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,MARKETRATE,STRIKE_PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,4,BROKAPPLIED,NETRATE,AMOUNT = (@@PDIFF * NETRATE),INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT= (@@PDIFF * MARKETRATE),BILLFLAG,
							SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_TYPE,ORDER_DATE,OPPMEMCODE,OPPTRADERCODE,CL_RATE,GROUPID,TRADERCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,STATUS,BRANCH_CD,PRO_CLI,PARTICIPANTCODE,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,SCHEME,TMARK ,DUMMY1,DUMMY2  
							FROM BFOSETTLEMENT WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY   	
				     		        UPDATE BFOSETTLEMENT SET SETTFLAG = 2,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*MARKETRATE    
				    		        WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
							SELECT @@PDIFF = 0   
						END 
			    			FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
			   		END
		   			CLOSE @@LOOP
				END    
 			END
			ELSE IF @@PQTY < @@SQTY
			BEGIN 
				SELECT @@PDIFF = @@SQTY - @@PQTY
 				SET @@LOOP  = CURSOR FOR 
				SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
        	     	        WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
				AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
				AND SELL_BUY = 2 AND TRADEQTY = @@PDIFF 
 				
				OPEN @@LOOP
			  	 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
			 	 IF @@FETCH_STATUS = 0 
				 BEGIN
 				 	UPDATE BFOSETTLEMENT SET SETTFLAG = 5  
  				  	WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
			 		
					CLOSE @@LOOP
				 	DEALLOCATE @@LOOP 
			  	END
				ELSE IF @@FETCH_STATUS <> 0  
			 	BEGIN 
					CLOSE @@LOOP
				   	DEALLOCATE @@LOOP  
				   	SET @@LOOP  = CURSOR FOR 
				    	SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
					WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
		   			AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 2 
					ORDER BY TRADEQTY DESC
				   	OPEN @@LOOP
					FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				  	WHILE @@PDIFF > 0       
				   	BEGIN
						IF @@PDIFF >= @@LQTY 
						BEGIN
							UPDATE BFOSETTLEMENT SET SETTFLAG = 5   
						    	WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  
						     	
							SELECT @@PDIFF = @@PDIFF - @@LQTY
					   	 END    
					    	 ELSE IF @@PDIFF < @@LQTY 
					    	 BEGIN	
							
	     						
						     	INSERT INTO BFOSETTLEMENT SELECT CONTRACTNO,BILLNO,'B'+TRADE_NO,PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,MULTIPLIER,USER_ID,@@PDIFF,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,MARKETRATE,STRIKE_PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,5,BROKAPPLIED,NETRATE,AMOUNT = (@@PDIFF * NETRATE),INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT= (@@PDIFF * MARKETRATE),BILLFLAG,
							SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_TYPE,ORDER_DATE,OPPMEMCODE,OPPTRADERCODE,CL_RATE,GROUPID,TRADERCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,STATUS,BRANCH_CD,PRO_CLI,PARTICIPANTCODE,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,SCHEME,TMARK ,DUMMY1,DUMMY2  
							FROM BFOSETTLEMENT WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY   	
							UPDATE BFOSETTLEMENT SET SETTFLAG = 3,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*MARKETRATE    
				    		        WHERE PARTY_CODE = @PARTY_CODE AND PRODUCT_CODE = @PRODUCT_CODE AND PRODUCT_TYPE = @PRODUCT_TYPE AND SERIES_CODE = @SERIES_CODE
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND SERIES_ID = @SERIES_ID AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
     						    	SELECT @@PDIFF = 0   
					   	 END 
					    	FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
				   	END
 				  	CLOSE @@LOOP
				  END	
			 END 
			 FETCH NEXT FROM @@FLAG INTO @@PQTY,@@SQTY
		END 
		CLOSE @@FLAG
		DEALLOCATE @@FLAG
	END
/**EXEC BFOSETTBROKUPDATE @TDATE,@PARTY_CODE,@PRODUCT_CODE,@PRODUCT_TYPE,@SERIES_CODE,@EXPIRYDATE,@SERIES_ID*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOMARGIN_UPD
-- --------------------------------------------------

CREATE PROC BFOMARGIN_UPD 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT ,
	@INTFILETYPE INT,
	@WITHMARKUP CHAR(1)
) AS 

IF @INTMODE=1
BEGIN
	IF @INTFILETYPE = 0  OR @INTFILETYPE = 1 
	TRUNCATE TABLE BFOMARGIN_IMP

	IF @INTFILETYPE = 0  /*NEW FORMAT MARGIN CSV*/
	BEGIN
		INSERT INTO BFOMARGIN_IMP
		SELECT
			MARGIN_DATE = DBO.PIECE(FILE_DATA,',',1),
			PARTY_CODE = DBO.PIECE(FILE_DATA,',',2),
			SPAN_MARGIN = DBO.PIECE(FILE_DATA,',',3),
			EXTREME_LOSS_MARGIN = DBO.PIECE(FILE_DATA,',',4),
			NET_PREMIUM = DBO.PIECE(FILE_DATA,',',5),
			DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',6),
			FINAL_SETTLEMENT_MARGIN = DBO.PIECE(FILE_DATA,',',7),
			TOTAL_MARGIN = DBO.PIECE(FILE_DATA,',',8),
			ACCOUNT_TYPE = DBO.PIECE(FILE_DATA,',',9)
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID
			AND LEN(FILE_DATA) > 50
	END 
	ELSE  /*OLD FORMAT NORMAL MARGIN*/
	BEGIN	
		INSERT INTO BFOMARGIN_IMP
		SELECT
			MARGIN_DATE = @SAUDA_DATE,
			PARTY_CODE = DBO.PIECE(FILE_DATA,'|',1),
			SPAN_MARGIN = DBO.PIECE(FILE_DATA,'|',5),
			EXTREME_LOSS_MARGIN = 0,
			NET_PREMIUM = DBO.PIECE(FILE_DATA,'|',9),
			DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,'|',8),
			FINAL_SETTLEMENT_MARGIN = 0,
			TOTAL_MARGIN = 0,
			ACCOUNT_TYPE = DBO.PIECE(FILE_DATA,'|',2)
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID
			AND LEN(FILE_DATA) > 50
			AND DBO.PIECE(FILE_DATA,'|',2) IS NOT NULL
			
		UPDATE BFOMARGIN_IMP SET TOTAL_MARGIN = SPAN_MARGIN+DAILY_MTM_SETTLEMENT_VALUE
	END 
	DELETE BFOMARGIN FROM BFOMARGIN_IMP WHERE BFOMARGIN_IMP.MARGIN_DATE = BFOMARGIN.MARGIN_DATE

	UPDATE BFOMARGIN_IMP SET PARTY_CODE = MEMBERCODE FROM BFOOWNER WHERE PARTY_CODE ='OWN'

	UPDATE BFOMARGIN_IMP SET PARTY_CODE = NEWPARTY_CODE FROM PARTYMAPPING
	WHERE PARTY_CODE = OLDPARTY_CODE

	IF (SELECT MEMBERTYPE FROM BFOOWNER) = 'CM'
	BEGIN

		UPDATE BFOMARGIN_IMP SET PARTY_CODE= BFOTMINFO.PARTY_CODE 
		FROM BFOTMINFO WHERE BFOTMINFO.TM_CODE=BFOMARGIN_IMP.PARTY_CODE

		UPDATE BFOMARGIN_IMP SET PARTY_CODE= CLIENT2.PARTY_CODE
		FROM CLIENT2 WHERE CLIENT2.BANKID = BFOMARGIN_IMP.PARTY_CODE AND 
		BFOMARGIN_IMP.PARTY_CODE NOT IN (SELECT TM_CODE FROM BFOTMINFO)

	END

	IF @WITHMARKUP = 'Y'
	BEGIN	
		EXEC PR_BFOMARGINCOLL_EXCH @SAUDA_DATE,'NORMAL'
	END

	INSERT INTO BFOMARGIN
	SELECT *,@UNAME,GETDATE()
	FROM BFOMARGIN_IMP

	TRUNCATE TABLE BFOMARGIN_IMP

END

IF @INTFILETYPE = 2  /*OLD FORMAT - EXPOSURE MARGIN*/
BEGIN
		SELECT
			PARTY_CODE = DBO.PIECE(FILE_DATA,'|',1),
			EXP_MARGIN = DBO.PIECE(FILE_DATA,'|',6)
		INTO #BFOMARGIN_EXP
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID
			AND LEN(FILE_DATA) > 50
			AND DBO.PIECE(FILE_DATA,'|',2) IS NOT NULL	
		
		UPDATE BFOMARGIN SET DAILY_MTM_SETTLEMENT_VALUE = EXP_MARGIN
		FROM #BFOMARGIN_EXP
		WHERE MARGIN_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND #BFOMARGIN_EXP.PARTY_CODE = BFOMARGIN.PARTY_CODE
		
		DROP TABLE #BFOMARGIN_EXP
END

IF @INTFILETYPE = 3  /*ADDITIONAL MARGIN*/
BEGIN
		SELECT		
			PARTY_CODE = DBO.PIECE(FILE_DATA,',',2),
			ADDMARGIN = DBO.PIECE(FILE_DATA,',',3),
			CHARGEFLAG = DBO.PIECE(FILE_DATA,',',4),
			DIS_PENALTY = DBO.PIECE(FILE_DATA,',',5),
			MWL_PENALTY = DBO.PIECE(FILE_DATA,',',6),
			CLPL_PENALTY = DBO.PIECE(FILE_DATA,',',7)			
		INTO #BFOMARGIN_ADD
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID
			AND LEN(FILE_DATA) > 50
			AND DBO.PIECE(FILE_DATA,'|',7) IS NOT NULL	
		
		DELETE BFOADHOCMARGIN WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		
		INSERT INTO BFOADHOCMARGIN
		SELECT @SAUDA_DATE,*,GETDATE() FROM #BFOMARGIN_ADD
		
		DROP TABLE #BFOMARGIN_ADD
END

EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'MRGIMP','',@UNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOMARGINCOLL_EXCH_GET
-- --------------------------------------------------
CREATE  PROC [DBO].[BFOMARGINCOLL_EXCH_GET] 
(
	@MARGINDATE VARCHAR(11),
	@INTACCOPT INT,
	@INTCOLLOPT INT
)
AS

/*-----------------------------------------------------------------
	FETCHING DATA TO MARGIN REPORTING FILE
	PARAMETER 
		1. MARGIN DATE
		2. ACCOPT 1- WITH OUT VALIDATION
			  2- WITH COLLATERAL
			  3- WITH COLLATERAL & LEDGER BALANCE
		3. COLL OPT 1- BEFORE HAIRCUT
			    2- AFTER HAIRCUT
			    3- AFTER CASH COMPOSITION
-------------------------------------------------------------------*/


DECLARE @SDTCUR AS VARCHAR(11)
SELECT @SDTCUR = SDTCUR FROM ACCOUNTFO.DBO.PARAMETER WHERE @MARGINDATE BETWEEN SDTCUR AND LDTCUR


SELECT
	PARTY_CODE,CL_TYPE,GROUPID,
	MDATE= CONVERT(VARCHAR,FILE_DATE,103),
	COLL5= CASE 
		WHEN @INTACCOPT = 1
		THEN ISNULL(IM_COLL,0)
		ELSE CASE
			WHEN @INTACCOPT = 2 THEN
				CASE
					WHEN @INTCOLLOPT = 1
					THEN ISNULL(ORIGINALCOLLATERAL,0)
					ELSE CASE
						WHEN @INTCOLLOPT = 2
						THEN ISNULL(HAIRCUTCOLLATERAL,0)
						ELSE ISNULL(EFFCOLL,0)
						END
					END 				
			ELSE
				CASE
					WHEN @INTCOLLOPT = 1
					THEN ISNULL(ORIGINALCOLLATERAL,0) + ISNULL(LEDBAL,0)
					ELSE CASE
						WHEN @INTCOLLOPT = 2
						THEN ISNULL(HAIRCUTCOLLATERAL,0) + ISNULL(LEDBAL,0)
						ELSE ISNULL(EFFCOLL,0) + ISNULL(LEDBAL,0)
						END
					END 
			END
		END,
	PREMIUM_COLL,
	0 PENALITY
FROM
	BFOMARGINCOLL_EXCH (NOLOCK)
	LEFT OUTER JOIN
	(
	SELECT
		PARTYCODE = PARTY_CODE,
		ISNULL(SUM((ISNULL(ORGCASH,0))+(ISNULL(ORGNONCASH,0))),0)AS ORIGINALCOLLATERAL,
		ISNULL(SUM((ISNULL(CASH,0))+(ISNULL(NONCASH,0))),0) AS HAIRCUTCOLLATERAL,
		ISNULL(SUM(EFFECTIVECOLL),0) AS EFFCOLL 
	FROM
		MSAJAG.DBO.COLLATERAL (NOLOCK)
	WHERE
		TRANS_DATE LIKE @MARGINDATE +  '%' 
		AND EXCHANGE = 'BSE' AND SEGMENT='FUTURES'
	GROUP BY PARTY_CODE
	) COLL
	ON (PARTYCODE = PARTY_CODE)

	LEFT OUTER JOIN
	(
		SELECT 
			CLTCODE, 
			SUM( CASE WHEN DRCR ='C' THEN VAMT ELSE - VAMT END) LEDBAL
		FROM 
			ACCOUNTBFO.DBO.LEDGER (NOLOCK)
		WHERE 
			VDT BETWEEN @SDTCUR  AND @MARGINDATE +' 23:59:59'
		GROUP BY CLTCODE
	) LEDBAL
	ON (CLTCODE = PARTY_CODE)

WHERE 
	FILE_DATE LIKE @MARGINDATE + '%'
	AND CL_TYPE <> 'F'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOMARGINCOLL_GET
-- --------------------------------------------------

CREATE PROC [DBO].[BFOMARGINCOLL_GET]   
(  
 @MARGINDATE VARCHAR(11),  
 @INTACCOPT INT,  
 @INTCOLLOPT INT,  
 @UNAME VARCHAR(20)  
)  
AS  
  
/*-----------------------------------------------------------------  
 FETCHING DATA TO MARGIN REPORTING FILE  
 PARAMETER   
  1. MARGIN DATE  
  2. ACCOPT 1- WITH OUT VALIDATION  
     2- WITH COLLATERAL  
     3- WITH COLLATERAL & LEDGER BALANCE  
  3. COLL OPT 1- BEFORE HAIRCUT  
       2- AFTER HAIRCUT  
       3- AFTER CASH COMPOSITION  
-------------------------------------------------------------------*/  
  
  
  
DECLARE @SDTCUR AS VARCHAR(11)  
SELECT @SDTCUR = SDTCUR FROM ACCOUNTBFO.DBO.PARAMETER WHERE @MARGINDATE BETWEEN SDTCUR AND LDTCUR  
  
 CREATE TABLE [#COLLATERAL]     
 (    
  [PARTYCODE] [VARCHAR] (12) ,    
  [ORIGINALCOLLATERAL] [MONEY],    
  [HAIRCUTCOLLATERAL] [MONEY],    
  [EFFCOLL] [MONEY]    
 )    
   
CREATE TABLE [#BFOMARGIN]  
(  
 [MARGIN_DATE] [DATETIME] ,  
 [PARTY_CODE] [VARCHAR](16) ,  
 [SPAN_MARGIN] [NUMERIC](22, 2) ,  
 [EXTREME_LOSS_MARGIN] [NUMERIC](22, 2) ,  
 [NET_PREMIUM] [NUMERIC](22, 2) ,  
 [DAILY_MTM_SETTLEMENT_VALUE] [NUMERIC](22, 2) ,  
 [FINAL_SETTLEMENT_MARGIN] [NUMERIC](22, 2) ,  
 [TOTAL_MARGIN] [NUMERIC](22, 2) ,  
 [ACCOUNT_TYPE] [VARCHAR](3)   
)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 IF (SELECT COUNT(1) FROM FOMG13REFERENCE WHERE SUBJECT ='MRGOPTION' AND HEADING = 'T -1 DAY VALUATION' AND SUBMENUREFNO = 1) > 0  
 BEGIN  
    
  EXEC TBL_COLLATERAL_MARGIN_UPD @MARGINDATE  
  
  INSERT INTO #COLLATERAL  
  SELECT   
   PARTY_CODE,  
   SUM(FINALAMOUNT),  
   MAX(CASH+NONCASH),  
   SUM(AMOUNT)  
  FROM   
    TBL_COLLATERAL_MARGIN C (NOLOCK)  
  WHERE  
   EFFDATE BETWEEN @MARGINDATE  AND @MARGINDATE + ' 23:59'  
  GROUP BY PARTY_CODE  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #COLLATERAL    
   SELECT     
    PARTY_CODE,    
    ISNULL(CASH+NONCASH,0),    
    ISNULL(ACTUALCASH+ACTUALNONCASH,0),    
    ISNULL(EFFECTIVECOLL,0)    
   FROM     
    MSAJAG.DBO.COLLATERAL    
   WHERE    
    EXCHANGE = (SELECT  TOP 1 EXCHANGE FROM BFOGLOBALS)    
    AND SEGMENT LIKE 'FUT%'    
    AND TRANS_DATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'    
 END  
  
 IF (SELECT COUNT(1) FROM BFOMARGIN_EXCH WHERE  MARGIN_DATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59' ) > 0  
 BEGIN  
  INSERT INTO #BFOMARGIN  
  SELECT MARGIN_DATE,PARTY_CODE,SPAN_MARGIN,EXTREME_LOSS_MARGIN,NET_PREMIUM,DAILY_MTM_SETTLEMENT_VALUE,FINAL_SETTLEMENT_MARGIN,TOTAL_MARGIN,ACCOUNT_TYPE  
  FROM BFOMARGIN_EXCH WHERE  MARGIN_DATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'   
 END  
 ELSE  
 BEGIN  
  INSERT INTO #BFOMARGIN  
  SELECT MARGIN_DATE,PARTY_CODE,SPAN_MARGIN,EXTREME_LOSS_MARGIN,NET_PREMIUM,DAILY_MTM_SETTLEMENT_VALUE,FINAL_SETTLEMENT_MARGIN,TOTAL_MARGIN,ACCOUNT_TYPE  
  FROM BFOMARGIN WHERE  MARGIN_DATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'   
 END  
  
SELECT  
 MDATE= CONVERT(VARCHAR,MARGIN_DATE,106),  
 PARTY_CODE ,  
 SPAN_MARGIN,  
 EXTREME_LOSS_MARGIN,  
 NET_PREMIUM,  
 DAILY_MTM_SETTLEMENT_VALUE,  
 FINAL_SETTLEMENT_MARGIN,  
 TOTAL_MARGIN ,  
 ACCOUNT_TYPE ,  
 NET_MARGIN= CASE   
  WHEN @INTACCOPT = 1  
  THEN ISNULL(TOTAL_MARGIN,0)  
  ELSE CASE  
   WHEN @INTACCOPT = 2 THEN  
    CASE  
     WHEN @INTCOLLOPT = 1  
     THEN ISNULL(ORIGINALCOLLATERAL,0)  
     ELSE CASE  
      WHEN @INTCOLLOPT = 2  
      THEN ISNULL(HAIRCUTCOLLATERAL,0)  
      ELSE ISNULL(EFFCOLL,0)  
      END  
     END       
   ELSE  
    CASE  
     WHEN @INTCOLLOPT = 1  
     THEN ISNULL(ORIGINALCOLLATERAL,0) + ISNULL(LEDBAL,0)  
     ELSE CASE  
      WHEN @INTCOLLOPT = 2  
      THEN ISNULL(HAIRCUTCOLLATERAL,0) + ISNULL(LEDBAL,0)  
      ELSE ISNULL(EFFCOLL,0) + ISNULL(LEDBAL,0)  
      END  
     END   
   END  
  END  
 INTO #FOSHORTMARGIN  
 FROM  
 #BFOMARGIN (NOLOCK)  
 LEFT OUTER JOIN  
 #COLLATERAL COLL  
 ON (PARTYCODE = PARTY_CODE)  
  
 LEFT OUTER JOIN  
 (  
 SELECT         
  CLTCODE,        
  SUM(VAMT) LEDBAL        
  FROM        
  (        
   SELECT         
    CLTCODE,        
    SUM( CASE WHEN DRCR ='C' THEN VAMT ELSE - VAMT END) VAMT        
   FROM        
    ACCOUNTBFO.DBO.LEDGER  (NOLOCK)        
   WHERE        
    VDT >=  @SDTCUR          
    AND VDT <= @MARGINDATE + ' 23:59'  
    AND VTYP <> '15'  
   GROUP BY CLTCODE        
  
   UNION         
  
   SELECT         
    CLTCODE,         
    SUM( CASE WHEN DRCR ='C' THEN VAMT ELSE - VAMT END) VAMT        
   FROM         
    ACCOUNTBFO.DBO.LEDGER  (NOLOCK)        
   WHERE         
    VDT >=  @SDTCUR          
    AND VDT < @MARGINDATE    
    AND VTYP='15'  
    AND VDT < (SELECT LEFT(MAX(SEC_PAYIN),11) FROM MSAJAG.DBO.SETT_MST WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59')  
   GROUP BY CLTCODE  
  ) CLOSEBAL        
  GROUP BY        
  CLTCODE   
      
 ) LEDBAL  
 ON (CLTCODE = PARTY_CODE)  
  
WHERE   
 MARGIN_DATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'  
  
IF (SELECT MEMBERTYPE FROM BFOOWNER) = 'CM'  
BEGIN  
    
 UPDATE #FOSHORTMARGIN SET PARTY_CODE = CLIENT2.BANKID    
 FROM CLIENT2 WHERE #FOSHORTMARGIN.PARTY_CODE = CLIENT2.PARTY_CODE    
 AND CLIENT2.BANKID <> ''    
     
 UPDATE #FOSHORTMARGIN SET PARTY_CODE = FOTMINFO.TM_CODE    
 FROM FOTMINFO WHERE  #FOSHORTMARGIN.PARTY_CODE = FOTMINFO.PARTY_CODE  
 AND FOTMINFO.PARTY_CODE NOT IN (SELECT BANKID FROM CLIENT2 (NOLOCK) WHERE CLIENT2.BANKID <> '')  
  
END  

UPDATE #FOSHORTMARGIN SET PARTY_CODE = OLDPARTY_CODE
FROM PARTYMAPPING WHERE #FOSHORTMARGIN.PARTY_CODE = NEWPARTY_CODE
  

SELECT MDATE,PARTY_CODE,SPAN_MARGIN,EXTREME_LOSS_MARGIN,NET_PREMIUM,DAILY_MTM_SETTLEMENT_VALUE,
FINAL_SETTLEMENT_MARGIN,TOTAL_MARGIN,ACCOUNT_TYPE=LTRIM(RTRIM(ACCOUNT_TYPE)),NET_MARGIN
FROM #FOSHORTMARGIN  

  
EXEC V2_PROCESS_STATUS_LOG_UPD @MARGINDATE,'MRGFILE','',@UNAME,''  
  
DROP TABLE #BFOMARGIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOPOSITION_UPD
-- --------------------------------------------------

CREATE PROC [dbo].[BFOPOSITION_UPD] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS 

DECLARE @TRADE_DATE DATETIME

IF @INTMODE=1
BEGIN
	TRUNCATE TABLE BFOEXERCISEALLOCATION_IMP

	SELECT
		POSITION_DATE = DBO.PIECE(FILE_DATA,',',1),
		SEGMENT = DBO.PIECE(FILE_DATA,',',2),
		SETT_TYPE = DBO.PIECE(FILE_DATA,',',3),
		CM_CODE = DBO.PIECE(FILE_DATA,',',4),
		MEMBER_TYPE = DBO.PIECE(FILE_DATA,',',5),
		TM_CODE = DBO.PIECE(FILE_DATA,',',6),
		ACCOUNT_TYPE = DBO.PIECE(FILE_DATA,',',7),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',8),
		PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',9),
		PRODUCT_CODE = DBO.PIECE(FILE_DATA,',',10),
		ASSET_CODE = DBO.PIECE(FILE_DATA,',',11),
		EXPIRYDATE = DBO.PIECE(FILE_DATA,',',12),
		STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',13),
		OPTION_TYPE = DBO.PIECE(FILE_DATA,',',14),
		SERIES_CODE = DBO.PIECE(FILE_DATA,',',15),
		CA_LEVEL = DBO.PIECE(FILE_DATA,',',16),
		BF_LONG_QTY = DBO.PIECE(FILE_DATA,',',17),
		BF_LONG_VALUE = DBO.PIECE(FILE_DATA,',',18),
		BF_SHORT_QTY = DBO.PIECE(FILE_DATA,',',19),
		BF_SHORT_VALUE = DBO.PIECE(FILE_DATA,',',20),
		DAY_BUY_QTY = DBO.PIECE(FILE_DATA,',',21),
		DAY_BUY_VALUE = DBO.PIECE(FILE_DATA,',',22),
		DAY_SELL_QTY = DBO.PIECE(FILE_DATA,',',23),
		DAY_SELL_VALUE = DBO.PIECE(FILE_DATA,',',24),
		PRE_LONG_QTY = DBO.PIECE(FILE_DATA,',',25),
		PRE_LONG_VALUE = DBO.PIECE(FILE_DATA,',',26),
		PRE_SHORT_QTY = DBO.PIECE(FILE_DATA,',',27),
		PRE_SHORT_VALUE = DBO.PIECE(FILE_DATA,',',28),
		EXERCISED_QTY = DBO.PIECE(FILE_DATA,',',29),
		ASSIGNED_QTY = DBO.PIECE(FILE_DATA,',',30),
		POST_LONG_QTY = DBO.PIECE(FILE_DATA,',',31),
		POST_LONG_VALUE = DBO.PIECE(FILE_DATA,',',32),
		POST_SHORT_QTY = DBO.PIECE(FILE_DATA,',',33),
		POST_SHORT_VALUE = DBO.PIECE(FILE_DATA,',',34),
		SETTLEMENT_PRICE = DBO.PIECE(FILE_DATA,',',35),
		NET_PREMIUM = DBO.PIECE(FILE_DATA,',',36),
		DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',37),
		FINAL_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',38),
		EXERCISED_ASSIGNED_VALUE = DBO.PIECE(FILE_DATA,',',39)
	INTO #BFOEXERCISEALLOCATION_IMP
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID
		AND LEN(FILE_DATA) > 100

	UPDATE #BFOEXERCISEALLOCATION_IMP
	SET SETTLEMENT_PRICE = 0 WHERE ISNULL(SETTLEMENT_PRICE,'') = ''
	
	INSERT INTO BFOEXERCISEALLOCATION_IMP
	SELECT * FROM #BFOEXERCISEALLOCATION_IMP
	
	DROP TABLE #BFOEXERCISEALLOCATION_IMP
	
	DELETE CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID		
END

SELECT TOP 1 @TRADE_DATE = POSITION_DATE FROM BFOEXERCISEALLOCATION_IMP

UPDATE BFOEXERCISEALLOCATION_IMP SET EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59'

DELETE BFOEXERCISEALLOCATION 
WHERE
	POSITION_DATE = @TRADE_DATE

IF (SELECT MEMBERTYPE FROM BFOOWNER) = 'CM'
BEGIN

	UPDATE BFOEXERCISEALLOCATION_IMP SET PARTY_CODE= BFOTMINFO.PARTY_CODE 
	FROM BFOTMINFO WHERE BFOTMINFO.TM_CODE=BFOEXERCISEALLOCATION_IMP.TM_CODE

END

UPDATE BFOEXERCISEALLOCATION_IMP SET PARTY_CODE = NEWPARTY_CODE
FROM PARTYMAPPING WHERE PARTY_CODE = OLDPARTY_CODE
	
INSERT INTO BFOEXERCISEALLOCATION
SELECT 	*,@UNAME,GETDATE()
FROM BFOEXERCISEALLOCATION_IMP

TRUNCATE TABLE BFOEXERCISEALLOCATION_IMP

EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'POSIMP','',@UNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOREARRANGEAFTERCONTFLAG
-- --------------------------------------------------




CREATE  PROCEDURE [DBO].[BFOREARRANGEAFTERCONTFLAG]

@PARTY_CODE VARCHAR(10),
@PRODUCT_TYPE VARCHAR(6),
@PRODUCT_CODE VARCHAR(12),
@SERIES_CODE VARCHAR(20),
@EXPIRYDATE VARCHAR(11),
@STRIKE_PRICE MONEY,
@TDATE VARCHAR(11),
@SERIESID INT


AS 

DECLARE 
 @@TRADE_NO VARCHAR(14),
 @@PQTY NUMERIC(18,0), 
 @@SQTY NUMERIC(18,0),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(18,0), 
 @@PDIFF NUMERIC(18,0),
 @@FLAG CURSOR,
 @@LOOP CURSOR,
 @@BROKSCHEME VARCHAR(3)
 
 DECLARE @OPTION_TYPE VARCHAR(2)
 SET @OPTION_TYPE =''
 
	UPDATE BFOSETTLEMENT SET SETTFLAG = (CASE WHEN S.SELL_BUY = 1 THEN 2
						ELSE 3 END )
	FROM BFOSETTLEMENT S,BFOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
	AND B.PRODUCT_TYPE = B.PRODUCT_TYPE
	AND B.PRODUCT_CODE = S.PRODUCT_CODE
	AND B.EXPIRYDATE = S.EXPIRYDATE
	AND B.SQTY<> 0 AND B.PQTY <>  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.PRODUCT_TYPE = @PRODUCT_TYPE
	AND S.PRODUCT_CODE = @PRODUCT_CODE
	AND S.SERIES_ID = @SERIESID
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   
	
	UPDATE BFOSETTLEMENT SET SETTFLAG = 4 FROM BFOSETTLEMENT S,BFOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
	AND B.PRODUCT_TYPE = B.PRODUCT_TYPE
	AND B.PRODUCT_CODE = S.PRODUCT_CODE
	AND B.EXPIRYDATE = S.EXPIRYDATE
	AND  B.SQTY = 0 AND B.PQTY >  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.PRODUCT_TYPE = @PRODUCT_TYPE
	AND S.PRODUCT_CODE = @PRODUCT_CODE
	AND S.SERIES_ID = @SERIESID
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   

	UPDATE BFOSETTLEMENT SET SETTFLAG = 5 FROM BFOSETTLEMENT S,BFOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
	AND B.PRODUCT_TYPE = B.PRODUCT_TYPE
	AND B.PRODUCT_CODE = S.PRODUCT_CODE
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND  B.SQTY > 0 AND B.PQTY =  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.PRODUCT_TYPE = @PRODUCT_TYPE
	AND S.PRODUCT_CODE = @PRODUCT_CODE
	AND S.EXPIRYDATE = @EXPIRYDATE
	AND S.SERIES_ID = @SERIESID
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   


SET @@FLAG = CURSOR FOR
	 SELECT PQTY,SQTY FROM 
		(
		SELECT S1.PARTY_CODE,S1.PRODUCT_CODE,S1.SERIES_ID,S1.SERIES_CODE,S1.SEC_NAME,S1.EXPIRYDATE,S1.STRIKE_PRICE,S1.PRODUCT_TYPE,SAUDA_DATE,
		ISNULL(S1.PQTY,0) PQTY,ISNULL(S1.SQTY,0) SQTY 
		FROM 
			(
			SELECT T1.PARTY_CODE,T1.PRODUCT_CODE,T1.SERIES_CODE,T1.SERIES_ID,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,
			T1.PRODUCT_TYPE,SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),    
			PQTY = SUM(PQTY),SQTY=SUM(SQTY)
			FROM 
				(
				SELECT T1.PARTY_CODE,T1.PRODUCT_CODE,T1.SERIES_ID,T1.SERIES_CODE,'' SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.PRODUCT_TYPE,T1.SELL_BUY,
				TRADEQTY,SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
				PQTY =
					(CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END ),
				
				SQTY = 
					(CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END )
				FROM BFOSETTLEMENT T1, CLIENT2  WHERE  TRADEQTY > 0  
					AND T1.PARTY_CODE = CLIENT2.PARTY_CODE
					AND T1.PARTY_CODE = @PARTY_CODE 
					AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
					AND SERIES_ID = @SERIESID
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
					AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
				GROUP BY T1.PARTY_CODE,T1.PRODUCT_CODE,T1.SERIES_CODE,T1.EXPIRYDATE,
				T1.STRIKE_PRICE,T1.PRODUCT_TYPE,T1.SERIES_ID,
				T1.SELL_BUY,T1.TRADEQTY,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)  
				) T1 
			GROUP BY T1.PARTY_CODE,T1.PRODUCT_CODE,T1.SERIES_CODE,T1.SEC_NAME,
			T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.PRODUCT_TYPE,T1.SERIES_ID,
			LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)  
			) S1 
		GROUP BY SAUDA_DATE,S1.PARTY_CODE,S1.PRODUCT_CODE,S1.SERIES_CODE,S1.SEC_NAME,
		S1.EXPIRYDATE,S1.STRIKE_PRICE,S1.PRODUCT_TYPE,SQTY,PQTY,S1.SERIES_ID
		) TRD

	 WHERE PARTY_CODE = @PARTY_CODE 
	 AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
	 AND SERIES_ID = @SERIESID
	 AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
	 AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
	 AND PQTY <> 0 AND  SQTY <> 0 AND ISNULL(PQTY,0) <> ISNULL(SQTY,0)
	 GROUP BY PQTY,SQTY
OPEN @@FLAG
FETCH NEXT FROM @@FLAG INTO @@PQTY,@@SQTY

IF @@FETCH_STATUS = 0 	
	BEGIN
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @@PQTY > @@SQTY 
		        	BEGIN 
				SELECT @@PDIFF = @@PQTY - @@SQTY 
				  /*FIND A TRADE WHOSE TRADEQTY = THE DIFF IN PATY AND SQTY AND UPDATE IT WITH SETFLAG = 4 */	
				SET @@LOOP  = CURSOR FOR 
					SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
					WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
					AND SERIES_ID = @SERIESID
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE  AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 1 AND TRADEQTY = @@PDIFF 
				 OPEN @@LOOP
				 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				 IF @@FETCH_STATUS = 0 
				 BEGIN 
					UPDATE BFOSETTLEMENT SET SETTFLAG = 4   
					WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
					AND SERIES_ID = @SERIESID
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  

				CLOSE @@LOOP
				DEALLOCATE @@LOOP 
			  	END
			  	ELSE IF @@FETCH_STATUS <> 0  
			 	BEGIN 
					CLOSE @@LOOP
				   	DEALLOCATE @@LOOP  
				   	SET @@LOOP  = CURSOR FOR 
						SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
					   	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
						AND SERIES_ID = @SERIESID
	   			        	AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
						AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   AND SELL_BUY = 1 
						ORDER BY TRADEQTY DESC
				   	OPEN @@LOOP
				  	FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				  	WHILE @@PDIFF > 0       
				  	BEGIN
						IF @@PDIFF >= @@LQTY 	
	                                        BEGIN
					     		UPDATE BFOSETTLEMENT SET SETTFLAG = 4   
							WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
							AND SERIES_ID = @SERIESID
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  

					     		SELECT @@PDIFF = @@PDIFF - @@LQTY
						END    
					        ELSE IF @@PDIFF < @@LQTY 
			    			BEGIN


INSERT INTO BFOSETTLEMENT
SELECT 
	CONTRACTNO,'B' + TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,
	OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,
	CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,
	SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
FROM BFOSETTLEMENT
WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY   	
							AND SERIES_ID = @SERIESID

	     		        	UPDATE BFOSETTLEMENT SET SETTFLAG = 2,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*TRADE_PRICE    
	    		        	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
				   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
						AND SERIES_ID = @SERIESID
				   		AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 

							SELECT @@PDIFF = 0   
						END 
			    			FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
			   		END
		   			CLOSE @@LOOP
				END    
 			END
			ELSE IF @@PQTY < @@SQTY
			BEGIN 
				SELECT @@PDIFF = @@SQTY - @@PQTY

 				SET @@LOOP  = CURSOR FOR 
				SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
        	     	        		WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
				AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
				AND SERIES_ID = @SERIESID		
				AND SELL_BUY = 2 AND TRADEQTY = @@PDIFF 
 				
				OPEN @@LOOP
			  	 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
			 	 IF @@FETCH_STATUS = 0 
				 BEGIN
 				 	UPDATE BFOSETTLEMENT SET SETTFLAG = 5  
  				  	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
					AND SERIES_ID = @SERIESID
			 		
					CLOSE @@LOOP
				 	DEALLOCATE @@LOOP 
			  	END
				ELSE IF @@FETCH_STATUS <> 0  
			 	BEGIN 
					CLOSE @@LOOP
				   	DEALLOCATE @@LOOP  

				   	SET @@LOOP  = CURSOR FOR 
				    	SELECT TRADE_NO,TRADEQTY FROM BFOSETTLEMENT 
					WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
		   			AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 2 
					AND SERIES_ID = @SERIESID
					ORDER BY TRADEQTY DESC

				   	OPEN @@LOOP
					FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				  	WHILE @@PDIFF > 0       
				   	BEGIN
						IF @@PDIFF >= @@LQTY 
						BEGIN
							UPDATE BFOSETTLEMENT SET SETTFLAG = 5   
						    	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  
					     		AND SERIES_ID = @SERIESID
							SELECT @@PDIFF = @@PDIFF - @@LQTY
					   	 END    
					    	ELSE IF @@PDIFF < @@LQTY 
					    	BEGIN	


INSERT INTO BFOSETTLEMENT
SELECT 
	CONTRACTNO,'B' + TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,
	OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,
	CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,
	SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
FROM BFOSETTLEMENT
WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY   	
							AND SERIES_ID = @SERIESID	
	     						
						     	UPDATE BFOSETTLEMENT SET SETTFLAG = 3,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*TRADE_PRICE    
				    		        	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND PRODUCT_TYPE = @PRODUCT_TYPE AND PRODUCT_CODE = @PRODUCT_CODE
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
							AND SERIES_ID = @SERIESID

     						    	SELECT @@PDIFF = 0   
					   	 END 
					    	FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
				   	END
 				  	CLOSE @@LOOP
				  END	
			 END 
			 FETCH NEXT FROM @@FLAG INTO @@PQTY,@@SQTY
		END 
		CLOSE @@FLAG
		DEALLOCATE @@FLAG
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOREARRANGEBILLFLAG
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[BFOREARRANGEBILLFLAG]
(
	@EXPIRYDATE SMALLDATETIME,
	@USERNAME VARCHAR(50) =''
)
	 

AS 

DECLARE  
@@EXPDATE DATETIME,  
@@SELFOTRADE CURSOR,  
@@MYPKEY  INT,  
@@PRODUCT_TYPE VARCHAR(2),
@@PRODUCT_CODE VARCHAR(10),
@@SERIES_CODE VARCHAR(13),      
@@SERIES_ID VARCHAR(10),
@@SECNAME VARCHAR(20),  
@@EXPIRYDATE SMALLDATETIME,  
@@MYSETTNO INT,  
@@PARTICIPANTCODE VARCHAR(15),  
@@BRANCHID VARCHAR(10),  
@@ACTIVITYTIME SMALLDATETIME,  
@@SELLBUY INT,  
@@PROCLI INT,  
@@PRICE NUMERIC(36,12),  
@@PARTYCODE VARCHAR(10),  
@@MEMBERCODE VARCHAR(6),  
@@TRADEQTY AS INT,  
@@GETEXPIRYDATE AS CURSOR,  
@@TEMPEXPIRYDATE AS SMALLDATETIME,  
@@TEMPSAUDADATE AS VARCHAR(11)

SET @@MEMBERCODE = (SELECT LTRIM(RTRIM(ISNULL(MEMBERCODE,''))) FROM BFOOWNER)  

UPDATE BFOSCRIP2 SET MATURITYDATE = LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) + ' 23:59'  
WHERE MATURITYDATE <> LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) + ' 23:59'  

 
SET @@GETEXPIRYDATE=CURSOR FOR 
SELECT DISTINCT 
	LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11), 
	LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) 
FROM 
	BFOSCRIP2 
WHERE 
	MATURITYDATE=@EXPIRYDATE 

OPEN @@GETEXPIRYDATE  
FETCH NEXT FROM @@GETEXPIRYDATE INTO @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
  
WHILE @@FETCH_STATUS=0 AND @@TEMPEXPIRYDATE=@@TEMPEXPIRYDATE AND @@TEMPSAUDADATE=@@TEMPSAUDADATE  
  
 BEGIN  

		SET @EXPIRYDATE=''  
		SET @EXPIRYDATE=@@TEMPEXPIRYDATE  
		
		SET @@EXPDATE = (SELECT LEFT(CONVERT(VARCHAR,@EXPIRYDATE,109),11))  + ' 23:59'
		SET @@MYPKEY = 0  
		
		TRUNCATE TABLE BFOSETTLEMENTEXPIRY    
		
		
		INSERT INTO BFOSETTLEMENTEXPIRY 
		SELECT
			CONTRACTNO,TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,
			ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,
			TRADEQTY,SETT_FLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,
			CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,
			REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
			TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,
			ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,
			OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,
			STATUS ='11'
		FROM
			BFOSETTLEMENT 
		WHERE
			SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND EXPIRYDATE = @@EXPDATE 
			AND AUCTIONPART = 'EA'
			AND RIGHT(PRODUCT_CODE,3) ='FUT'

		DELETE FROM 
			BFOSETTLEMENT 
		WHERE 
			SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND EXPIRYDATE = @@EXPDATE 
			AND AUCTIONPART = 'EA'
			AND RIGHT(PRODUCT_CODE,3) ='FUT'
			
		TRUNCATE TABLE BFOTRADE   
		
		SELECT 
			PRODUCT_TYPE,
			PRODUCT_CODE,
			SERIES_CODE,
			SERIES_ID,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			CL_RATE =CLOSE_PRICE
		INTO
			#BFOCLOSING
		FROM 
			BFOCLOSING
		WHERE 
			TRADE_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND EXPIRYDATE =  @@EXPDATE
			AND RIGHT(PRODUCT_CODE,3) ='FUT'

		INSERT INTO BFOTRADE
		SELECT TRADE_NO=1,@@TEMPSAUDADATE,'11','C','F',E.PRODUCT_TYPE,E.PRODUCT_CODE,E.ASSET_CODE,E.EXPIRYDATE,E.STRIKE_PRICE,
		E.OPTION_TYPE,E.SERIES_CODE,E.SERIES_ID,MINIMUM_LOT_SIZE,SELL_BUY=CASE WHEN SUM(PQTY-SQTY) > 0 THEN 2 ELSE 1 END,
		TRADEQTY=ABS(SUM(PQTY-SQTY)),SETTFLAG=CASE WHEN SUM(PQTY-SQTY) > 0 THEN 3 ELSE 5 END,CA_LEVEL=0,
		@@MEMBERCODE,TRADE_PRICE=ISNULL(#BFOCLOSING.CL_RATE,0),
		LOCATIONID='',@@MEMBERCODE,@@MEMBERCODE,CP_CONFIRMATION='N',OC_FLAG=0,
		OLD_CP_CODE='',OLD_CM_CODE='',TERMINALID=0,ORDER_NO='9000000',PARTY_CODE,REMARKS='',
		BUY_POSITION=0,SELL_POSITION=0,PRO_CLI='C',ORDER_TIMESTAMP=@@EXPDATE,ORDER_ACTIVEFLAG=0,
		0,0,0,0,0,0,0
		FROM 
		(
			SELECT
				S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.SERIES_CODE,S.SERIES_ID,
				S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,S.ASSET_CODE,
				PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END ),  
				SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END ),
				PARTICIPANTCODE = @@MEMBERCODE,MINIMUM_LOT_SIZE
			FROM 
				BFOSETTLEMENT S,
				BFOSCRIP2 F    
			WHERE  
				 F.EXPIRYDATE =  @@EXPDATE 
				--AND F.PRODUCT_TYPE = S.PRODUCT_TYPE 
				AND F.PRODUCT_CODE=S.PRODUCT_CODE   
				AND F.SERIES_CODE=S.SERIES_CODE 
				AND F.SERIES_ID =S.SERIES_ID   
				AND S.EXPIRYDATE = F.EXPIRYDATE
				AND S.STRIKE_PRICE = F.STRIKE_PRICE
				AND S.OPTION_TYPE = F.OPTION_TYPE
				AND F.MATURITYDATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'  
				AND S.SAUDA_DATE <= @@TEMPSAUDADATE + ' 23:59'
				AND S.RESERVED1 <> 1 
				AND S.EXPIRYDATE = F.EXPIRYDATE
				--AND RIGHT(S.PRODUCT_CODE,3) ='FUT'
			GROUP BY 
				S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.SERIES_CODE,
				S.SERIES_ID,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
				MINIMUM_LOT_SIZE,S.ASSET_CODE
		) E 
		LEFT OUTER JOIN 
		#BFOCLOSING
		ON 
		(
			--#BFOCLOSING.PRODUCT_TYPE = E.PRODUCT_TYPE 
			 #BFOCLOSING.PRODUCT_CODE=E.PRODUCT_CODE   
			AND #BFOCLOSING.SERIES_CODE=E.SERIES_CODE 
			AND #BFOCLOSING.SERIES_ID =E.SERIES_ID   
			AND #BFOCLOSING.EXPIRYDATE = E.EXPIRYDATE
		)
		GROUP BY PARTY_CODE,E.PRODUCT_TYPE,E.PRODUCT_CODE,E.SERIES_CODE,E.SERIES_ID,
			E.EXPIRYDATE,PARTICIPANTCODE,#BFOCLOSING.CL_RATE,E.ASSET_CODE,
			E.STRIKE_PRICE,E.OPTION_TYPE,MINIMUM_LOT_SIZE
		HAVING SUM(PQTY - SQTY)  <> 0  
		ORDER BY PARTY_CODE,E.PRODUCT_TYPE,E.PRODUCT_CODE,E.SERIES_CODE,E.SERIES_ID	
		
		
		CREATE TABLE #TRADE
		(
			SRNO INT IDENTITY NOT NULL,
			PARTY_CODE		VARCHAR(10),
			PRODUCT_TYPE	VARCHAR(3),
			PRODUCT_CODE	VARCHAR(7),
			EXPIRYDATE		DATETIME,
			STRIKE_PRICE	NUMERIC	(9),
			OPTION_TYPE		VARCHAR	(2)
		)
		INSERT INTO #TRADE
		SELECT DISTINCT		
		PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,
		EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
		FROM BFOTRADE
		
		UPDATE BFOTRADE SET TRADE_NO = CONVERT(NUMERIC,TRADE_NO) + SRNO, 
		ORDER_NO = CONVERT(NUMERIC,ORDER_NO) + SRNO
		FROM  #TRADE
		WHERE
			#TRADE.PARTY_CODE = BFOTRADE.PARTY_CODE AND
			#TRADE.PRODUCT_TYPE = BFOTRADE.PRODUCT_TYPE AND
			#TRADE.PRODUCT_CODE = BFOTRADE.PRODUCT_CODE AND
			#TRADE.EXPIRYDATE = BFOTRADE.EXPIRYDATE AND
			#TRADE.STRIKE_PRICE = BFOTRADE.STRIKE_PRICE AND
			#TRADE.OPTION_TYPE = BFOTRADE.OPTION_TYPE 

		DROP TABLE #TRADE

		TRUNCATE TABLE BBGBFOSETTLEMENT    		

		INSERT INTO BBGBFOSETTLEMENT  
		SELECT
			CONTRACTNO='0000000',TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,
			PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,
			SELL_BUY,TRADEQTY,SETTFLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,
			CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,
			BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,
			VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
			ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,
			SEBI_TAX,BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART='EA',RESERVED1 =0,
			DUMMY1=0,DUMMY2=TRADE_PRICE,STATUS='11'
		FROM
			BFOCONFIRMVIEW_EXPIRY

		INSERT INTO BBGBFOSETTLEMENT  
			SELECT CONTRACTNO='0000000',TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,
			PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,
			SELL_BUY,TRADEQTY,SETTFLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,
			CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,
			BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO=0,LINE_NO=0,
			VAL_PERC='P',NORMAL=0,DAY_PUC=0,DAY_SALES=0,SETT_PURCH=0,SETT_SALES=0,SETTFLAG,ROFIG=0,ERRNUM=0,NOZERO=0,
			ROUND_TO=0,TRADE_AMOUNT=TRADE_PRICE*TRADEQTY,BRANCH_CD=PARTY_CODE,BROKAPPLIED=0,INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,
			SEBI_TAX=0,BROKER_CHRG=0,NETRATE=0,SERVICE_TAX=0,AUCTIONPART='EA',
			RESERVED1 = 0,DUMMY1=0,DUMMY2=TRADE_PRICE,STATUS='11'
			FROM BFOTRADE 
			WHERE BFOTRADE.TRADE_NO NOT IN (SELECT DISTINCT TRADE_NO FROM BFOCONFIRMVIEW_EXPIRY) 

        INSERT INTO BFOSETTLEMENT 
		SELECT 
			CONTRACTNO,TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,
			ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,
			TRADEQTY,SETT_FLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,
			CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,
			REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
			TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,
			ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,
			OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,
			STATUS ='11'
		FROM BFOSETTLEMENTEXPIRY
		
		UPDATE BBGBFOSETTLEMENT SET AUCTIONPART = CASE WHEN RIGHT(PRODUCT_CODE,3) = 'OPT' THEN 'CA' ELSE 'EA' END

		TRUNCATE TABLE BFOSETTLEMENTEXPIRY    
		
		---EXEC BFOGENCONTRACT_EXPIRY  		

		UPDATE BBGBFOSETTLEMENT SET CONTRACTNO =0,AUCTIONPART='CA',
		BROKAPPLIED = 0,SERVICE_TAX = 0,INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,NETRATE = 0		
		WHERE RIGHT(PRODUCT_CODE,3) = 'OPT' AND AUCTIONPART ='CA'
		
		INSERT INTO BFOEXPIRYBACKUP SELECT *,GETDATE() FROM BFOSETTLEMENT 
		WHERE 
			SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND EXPIRYDATE = @@EXPDATE 
			AND AUCTIONPART = 'EA'
		
		DELETE FROM BFOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59' AND EXPIRYDATE = @@EXPDATE  
		AND ((AUCTIONPART = 'EA' AND RIGHT(PRODUCT_CODE,3) ='FUT') OR (AUCTIONPART = 'CA' AND RIGHT(PRODUCT_CODE,3) ='OPT'))
		
		
		DELETE FROM BFOEXPIRYSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59' 
		AND EXPIRYDATE = @@EXPDATE
		AND ((AUCTIONPART = 'EA' AND RIGHT(PRODUCT_CODE,3) ='FUT') OR (AUCTIONPART = 'CA' AND RIGHT(PRODUCT_CODE,3) ='OPT'))

		INSERT INTO BFOEXPIRYSETTLEMENT 
		SELECT * FROM BBGBFOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
		AND ((AUCTIONPART = 'EA' AND RIGHT(PRODUCT_CODE,3) ='FUT') OR (AUCTIONPART = 'CA' AND RIGHT(PRODUCT_CODE,3) ='OPT'))
		
		INSERT INTO BFOSETTLEMENT 
		SELECT * FROM BBGBFOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59' AND EXPIRYDATE = @@EXPDATE 
		AND AUCTIONPART IN('EA','CA')
		
		TRUNCATE TABLE BBGBFOSETTLEMENT    
		TRUNCATE TABLE BFOTRADE   
		TRUNCATE TABLE BFOFTTRADE    
		DROP TABLE #BFOCLOSING
		
		FETCH NEXT FROM @@GETEXPIRYDATE INTO @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
   END         
  
CLOSE @@GETEXPIRYDATE  
DEALLOCATE @@GETEXPIRYDATE

SET @@TEMPSAUDADATE = LEFT(@EXPIRYDATE,11)

EXEC DELIVERY_VALANGENERATE @@TEMPSAUDADATE,@USERNAME

/*-------------------------------------------------- END OF THE PROC -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSCRIP_UPD
-- --------------------------------------------------



CREATE  PROC [dbo].[BFOSCRIP_UPD]  
(        
                @SESSIONID VARCHAR(30),
                @UNAME VARCHAR(30),
                @SAUDA_DATE VARCHAR(11),
                @INTMODE INT,
                @INTFILETYPE INT=0,
                @FILENAME VARCHAR(MAX) = ''
) AS         

SET XACT_ABORT ON
        
/*
                @INTFILETYPE = 0 : CONTRACT MASTER CO<DDMMYY>.CSV
                @INTFILETYPE = 1 : NEW CONTRACT MASTER EQD_CO<DDMMYY>.CSV
                
*/
/*
BEGIN TRAN
EXEC BFOSCRIP_UPD '559046020', '', 'JUL 26 2023', 1, 1, 'EQD_CO250723.csv'
ROLLBACK 

SELECT TOP 1 * FROM CLASSFILEUPD 
*/ 
DECLARE @STRSQL VARCHAR(MAX)

TRUNCATE TABLE BFOSCRIP2_IMP


IF @INTMODE=1        
BEGIN

                IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
                BEGIN
                                
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                )

                                SELECT 
                                                SERIES_ID                                            = DBO.PIECE(FILE_DATA,',',          1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILE_DATA,',',          3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILE_DATA,',',          66),--(CASE WHEN DBO.PIECE(FILE_DATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILE_DATA,',',   4)+'OPT' ELSE DBO.PIECE(FILE_DATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILE_DATA,',',          4),
                                                --DBO.PIECE(FILE_DATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILE_DATA,',',8))/100,
                                                OPTION_TYPE                                    = DBO.PIECE(FILE_DATA,',',          9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',', 53),'') <> '' THEN ISNULL(DBO.PIECE(FILE_DATA,',',   53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILE_DATA,',',    54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILE_DATA,',',          2),
                                                CA_LEVEL                                            = DBO.PIECE(FILE_DATA,',',          61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILE_DATA,',',   11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILE_DATA,',',          31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILE_DATA,',',          32),
                                                PRICE_TICK                                         = DBO.PIECE(FILE_DATA,',',          33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILE_DATA,',',          69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILE_DATA,',', 62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILE_DATA,',',             5) 
                                                                                                                                                    ELSE DBO.PIECE(FILE_DATA,',', 62)
                                                                                                                                  END)   
                                FROM CLASSFILEUPD  (NOLOCK)
                                WHERE
                                SESSION_ID= @SESSIONID
                                AND ISNULL(DBO.PIECE(FILE_DATA,',',7),'')<>''                     

--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100              
                END
                ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
                BEGIN
                                
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN 
                                 )
                                
                                 SELECT 
                                                SERIES_ID                                            = DBO.PIECE(FILE_DATA,',',          1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILE_DATA,',',          3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILE_DATA,',',          66),--(CASE WHEN DBO.PIECE(FILE_DATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILE_DATA,',',   4)+'OPT' ELSE DBO.PIECE(FILE_DATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILE_DATA,',',          4),
                                                --DBO.PIECE(FILE_DATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILE_DATA,',',8))/100,
                                                OPTION_TYPE                                    = DBO.PIECE(FILE_DATA,',',          9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',', 53),'') <> '' THEN ISNULL(DBO.PIECE(FILE_DATA,',',   53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILE_DATA,',',    54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILE_DATA,',',          2),
                                                CA_LEVEL                                            = DBO.PIECE(FILE_DATA,',',          61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILE_DATA,',',   11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILE_DATA,',',          31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILE_DATA,',',          32),
                                                PRICE_TICK                                         = DBO.PIECE(FILE_DATA,',',          33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILE_DATA,',',          69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILE_DATA,',', 62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILE_DATA,',',             5) 
                                                                                                                                                    ELSE DBO.PIECE(FILE_DATA,',', 62)
                                                                                                                                  END) 
                                FROM CLASSFILEUPD  (NOLOCK)
                                WHERE
                                SESSION_ID= @SESSIONID
                                AND ISNULL(DBO.PIECE(FILE_DATA,',',     7),'') <> ''

                                DELETE FROM CLASSFILEUPD WHERE SESSION_ID= @SESSIONID
                                
--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
                END

END
ELSE                                                       -- BULK IMPORTS
BEGIN
                IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
                BEGIN
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                )

                                SELECT
                                                SERIES_ID                                            = DBO.PIECE(FILEDATA,',',             1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILEDATA,',',             3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILEDATA,',',             66),--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',',        4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILEDATA,',',             4),
                                                --DBO.PIECE(FILEDATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILEDATA,',',        8))/100,
                                                OPTION_TYPE                                    = DBO.PIECE(FILEDATA,',',             9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILEDATA,',',   53),'') <> '' THEN ISNULL(DBO.PIECE(FILEDATA,',',     53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILEDATA,',',       54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILEDATA,',',             2),
                                                CA_LEVEL                                            = DBO.PIECE(FILEDATA,',',             61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILEDATA,',',     11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILEDATA,',',             31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILEDATA,',',             32),
                                                PRICE_TICK                                         = DBO.PIECE(FILEDATA,',',             33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILEDATA,',',             69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILEDATA,',',  62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILEDATA,',', 5) 
                                                                                                                                                    ELSE DBO.PIECE(FILEDATA,',',  62)
                                                                                                                                  END) 
                                                    
                                FROM CLASSFILEUPD_BULK  (NOLOCK)
                                WHERE
                                SPID= @@SPID

                                --DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @@SPID
                                DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @SESSIONID
                END
                ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
                BEGIN 
                                IF @FILENAME <> ''
                                BEGIN
                                                SET @STRSQL = LOWER('BULK INSERT BFOSCRIP2_IMP_TEMP FROM ''' + @FILENAME  + '''  WITH (FIRSTROW = 2,FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'')')          
                                                EXEC(@STRSQL)
                                                
                                                INSERT INTO BFOSCRIP2_IMP
                                                (
                                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                                )

                                                SELECT		DISTINCT
                                                                SERIES_ID = COL1,
                                                                PRODUCT_TYPE = COL3,
                                                                PRODUCT_CODE = COL66,--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',', 4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',    4)+'FUT' END),
                                                                ASSET_CODE = COL4,
                                                                EXPIRYDATE = CONVERT(DATETIME,(COL7)),
                                                                STRIKE_PRICE = CONVERT(NUMERIC(18,2),COL8)/100,
                                                                OPTION_TYPE  = isnull(COL9,''),
                                                                SERIES_CODE = (CASE WHEN ISNULL(COL53,'') <> '' THEN ISNULL(COL53,'') 
                                                                                                                                                ELSE ISNULL(COL54,'') END),
                                                                UNDERLYING_ASSET = COL2,
                                                                CA_LEVEL = COL61,
                                                                BASE_PRICE = 0, --COL            11), 
                                                                STARTDATE = CONVERT(DATETIME,COL27),
                                                                MATURITYDATE = CONVERT(DATETIME,COL28),
                                                                EXERCISE_STARTDATE = CONVERT(DATETIME,COL49),
                                                                EXERCISE_ENDDATE = CONVERT(DATETIME,COL50),
                                                                MINIMUM_LOT_SIZE = COL31,
                                                                LOT_SIZE_MULTIPLE = COL32,
                                                                PRICE_TICK = ISNULL(COL33,''),
                                                                MARGIN_INDICATOR = 0,
                                                                INITAIL_MARGIN_PERC = 0,        
                                                                STATUS_FLAG = ISNULL(COL69,''),
                                                                ISIN = (CASE WHEN ISNULL(COL62,'') = '' THEN ISNULL(COL5,'') ELSE ISNULL(COL62,'') END) 
                                                    
                                                FROM BFOSCRIP2_IMP_TEMP  (NOLOCK)
                                END
                                ELSE
                                BEGIN
                                                INSERT INTO BFOSCRIP2_IMP
                                                (
                                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                                )

                                                SELECT
                                                                SERIES_ID                                            = DBO.PIECE(FILEDATA,',',             1),
                                                                PRODUCT_TYPE                = DBO.PIECE(FILEDATA,',',             3),
                                                                PRODUCT_CODE                              = DBO.PIECE(FILEDATA,',',             66),--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',',        4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',                4)+'FUT' END),
                                                                ASSET_CODE                                      = DBO.PIECE(FILEDATA,',',             4),
                                                                --DBO.PIECE(FILEDATA,',',7),
                                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',7))),
                                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILEDATA,',',                8))/100,
                                                                OPTION_TYPE                                    = DBO.PIECE(FILEDATA,',',             9),
                                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILEDATA,',',   53),'') <> '' THEN ISNULL(DBO.PIECE(FILEDATA,',',            53),'') 
                                                                                                                                                ELSE ISNULL(DBO.PIECE(FILEDATA,',',       54),'') END),
                                                                UNDERLYING_ASSET       = DBO.PIECE(FILEDATA,',',             2),
                                                                CA_LEVEL                                            = DBO.PIECE(FILEDATA,',',             61),
                                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILEDATA,',',     11), 
                                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',27))),
                                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',28))),
                                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',49))),
                                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',50))),
                                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILEDATA,',',             31),
                                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILEDATA,',',             32),
                                                                PRICE_TICK                                         = DBO.PIECE(FILEDATA,',',             33),
                                                                MARGIN_INDICATOR      = 0          ,
                                                                INITAIL_MARGIN_PERC = 0 ,        
                                                                STATUS_FLAG                                    = DBO.PIECE(FILEDATA,',',             69),
                                                                ISIN = (CASE WHEN DBO.PIECE(FILEDATA,',',  62) = ''
                                                                          THEN DBO.PIECE(FILEDATA,',',                5) 
                                                                          ELSE DBO.PIECE(FILEDATA,',',                62)
                                                                       END) 
                                                FROM CLASSFILEUPD_BULK  (NOLOCK)
                                                WHERE
                                                --SPID= @@SPID
                                                SPID = @SESSIONID
                                                AND ISNULL(DBO.PIECE(FILEDATA,',',       3),'') <> ''
                                
                                                --DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @@SPID
                                                DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @SESSIONID
                                END
--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
                END

END
         
UPDATE BFOSCRIP2_IMP SET EXPIRYDATE = MATURITYDATE WHERE EXPIRYDATE ='' OR EXPIRYDATE IS NULL        
        
UPDATE BFOSCRIP2_IMP SET         
ISIN=ISNULL(ISIN,''),        
BASE_PRICE=ISNULL(BASE_PRICE,0),
OPTION_TYPE  = ISNULL(oPTION_TYPE,'')        
 
DELETE BFOSCRIP2 FROM        
BFOSCRIP2, BFOSCRIP2_IMP         
WHERE        
BFOSCRIP2.PRODUCT_TYPE = BFOSCRIP2_IMP.PRODUCT_TYPE 
and BFOSCRIP2.SERIES_CODE = REPLACE(BFOSCRIP2_IMP.SERIES_CODE,' ','')       
AND LEFT(BFOSCRIP2.EXPIRYDATE,11)  =  LEFT(BFOSCRIP2_IMP.EXPIRYDATE,11)  
AND BFOSCRIP2.STRIKE_PRICE = BFOSCRIP2_IMP.STRIKE_PRICE 
AND BFOSCRIP2.OPTION_TYPE = ISNULL(BFOSCRIP2_IMP.OPTION_TYPE,'')      
     
INSERT INTO BFOSCRIP2 (SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
SERIES_CODE,UNDERLYING_ASSET,CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,
MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,TRADE_DATE,UPDATED_BY,UPDATED_ON)      
SELECT         
                SERIES_ID,PRODUCT_TYPE,REPLACE(PRODUCT_CODE,' ',''),REPLACE(ASSET_CODE,' ',''),    
                EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',    
                STRIKE_PRICE,ISNULL(OPTION_TYPE,''),REPLACE(SERIES_CODE,' ',''),REPLACE(UNDERLYING_ASSET,' ',''),    
                CA_LEVEL,BASE_PRICE,STARTDATE,    
                MATURITYDATE = LEFT(MATURITYDATE,11) + ' 23:59',    
                EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,    
                LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,    
                INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,@SAUDA_DATE,@UNAME,GETDATE()    
FROM BFOSCRIP2_IMP    

INSERT INTO TBL_FOSCRIPMAP
SELECT N_INST_TYPE = 
(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END), 
N_SYMBOL=ISIN, N_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
N_STRIKE_PRICE = STRIKE_PRICE, N_OPTION_TYPE = OPTION_TYPE, 
B_INST_TYPE=PRODUCT_CODE, B_SYMBOL = SERIES_CODE, B_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
B_STRIKE_PRICE = STRIKE_PRICE, B_OPTION_TYPE = OPTION_TYPE,
M_INST_TYPE='',M_SYMBOL='',M_EXPIRYDATE='',M_STRIKE_PRICE='',M_OPTION_TYPE='', 
B_INST_TYPE=PRODUCT_CODE, B_SYMBOL = SERIES_CODE, B_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
B_STRIKE_PRICE = STRIKE_PRICE, B_OPTION_TYPE = OPTION_TYPE,
EFF_FROM=STARTDATE,EFF_TO='DEC 31 2049 23:59',UPLOAD_ON=GETDATE(),UPLOAD_BY=@UNAME
FROM BFOSCRIP2_IMP I
WHERE ISIN <> '' and 
ISIN <> '0' AND
ISIN NOT IN (SELECT N_SYMBOL FROM TBL_FOSCRIPMAP T                                 
                                                                WHERE T.N_SYMBOL = I.ISIN 
                                                                -- AND   T.N_INST_TYPE = INST_TYPE
                                                                AND   T.N_STRIKE_PRICE = I.STRIKE_PRICE
                                                                AND   T.N_OPTION_TYPE = I.OPTION_TYPE
                                                                AND   T.N_EXPIRYDATE = LEFT(I.EXPIRYDATE,11) + ' 23:59')
AND SERIES_CODE <> '' 
                    
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CNTMST','',@UNAME,''

TRUNCATE TABLE CLASSFILEUPD  
TRUNCATE TABLE CLASSFILEUPD_BULK

-----Added ON 25-08-2023 FOR BSEFO Below conditions are commented
--INSERT INTO [ANGELFO].NSEFO.DBO.FOSCRIP1
--SELECT N_INST_TYPE = 
--(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
--WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
--WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END),ISIN,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
--FROM BSEFO.DBO.BFOSCRIP2 T
--WHERE  NOT EXISTS (
--                    SELECT SYMBOL FROM [ANGELFO].NSEFO.DBO.FOSCRIP1 F
--                    WHERE LEFT(F.INST_TYPE,3) = RIGHT(T.PRODUCT_CODE,3)
--                    AND F.SYMBOL = T.ISIN
--                    AND F.EXPIRYDATE = T.EXPIRYDATE
--                    AND F.STRIKE_PRICE = T.STRIKE_PRICE
--                    AND F.OPTION_TYPE = T.OPTION_TYPE)
--                    AND T.ISIN <> '' 
--					AND T.ISIN <> '0'
--                    AND T.ISIN LIKE '%SENSEX%'
--                    AND EXPIRYDATE > GETDATE()

					
--INSERT INTO [ANGELFO].NSEFO.DBO.FOSCRIP2
--SELECT P_KEY=0,INST_TYPE=(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
--WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
--WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END),SYMBOL=ISIN,SEC_NAME=SERIES_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
--                   STARTDATE,MATURITYDATE=EXPIRYDATE,
--                   SERIES='0',COR_ACT_LEVEL='0',C_REGULAR_LOT=MINIMUM_LOT_SIZE,
--                   C_ISSUE_MAT_DT='',C_U_INST_TYPE='',C_U_SYMBOL='',C_U_SERIES='',C_U_EXPIRYDATE='',C_U_STRIKEPRICE='',C_U_OPTION_TYPE='',C_U_CAL=''
--FROM BSEFO.DBO.BFOSCRIP2 T WHERE ISIN <> ''
--AND ISIN <> '0' AND NOT EXISTS (
--                                SELECT SYMBOL FROM [ANGELFO].NSEFO.DBO.FOSCRIP2 F
--                                WHERE LEFT(F.INST_TYPE,3) = RIGHT(T.PRODUCT_CODE,3)
--                                AND F.SYMBOL = T.ISIN
--                                AND F.EXPIRYDATE = T.EXPIRYDATE
--                                AND F.STRIKE_PRICE = T.STRIKE_PRICE
--                                AND F.OPTION_TYPE = T.OPTION_TYPE)
--AND T.ISIN <> '' AND T.ISIN <> '0'
--AND T.ISIN LIKE '%SENSEX%'
--AND EXPIRYDATE > GETDATE()
-----Added ON 25-08-2023 FOR BSEFO Below conditions are commented

SET XACT_ABORT OFF


--EXEC NSEFO.DBO.FOSCRIP_DUPDEL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSCRIP_UPD_BKUP_20JUL_2023
-- --------------------------------------------------

CREATE PROC [dbo].[BFOSCRIP_UPD_BKUP_20JUL_2023] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS 

IF @INTMODE=1
BEGIN
	TRUNCATE TABLE BFOSCRIP2_IMP

	INSERT INTO BFOSCRIP2_IMP
	(
		SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
		CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
		PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
	)
		
	SELECT 
		SERIES_ID = DBO.PIECE(FILE_DATA,',',1),
		PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',2),
		PRODUCT_CODE = DBO.PIECE(FILE_DATA,',',3),
		ASSET_CODE = DBO.PIECE(FILE_DATA,',',4),
		EXPIRYDATE = DBO.PIECE(FILE_DATA,',',5),
		STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',6),
		OPTION_TYPE = ISNULL(DBO.PIECE(FILE_DATA,',',7),''),
		SERIES_CODE = DBO.PIECE(FILE_DATA,',',8),
		UNDERLYING_ASSET = LEFT(DBO.PIECE(FILE_DATA,',',9),10),
		CA_LEVEL = DBO.PIECE(FILE_DATA,',',10),
		BASE_PRICE =0 , -- DBO.PIECE(FILE_DATA,',',11),
		STARTDATE = DBO.PIECE(FILE_DATA,',',12),
		MATURITYDATE = DBO.PIECE(FILE_DATA,',',13),
		EXERCISE_STARTDATE = DBO.PIECE(FILE_DATA,',',14),
		EXERCISE_ENDDATE = DBO.PIECE(FILE_DATA,',',15),
		MINIMUM_LOT_SIZE = DBO.PIECE(FILE_DATA,',',16),
		LOT_SIZE_MULTIPLE = DBO.PIECE(FILE_DATA,',',17),
		PRICE_TICK = DBO.PIECE(FILE_DATA,',',18),
		MARGIN_INDICATOR = DBO.PIECE(FILE_DATA,',',19),
		INITAIL_MARGIN_PERC = DBO.PIECE(FILE_DATA,',',20),
		STATUS_FLAG = DBO.PIECE(FILE_DATA,',',21),
		ISIN = DBO.PIECE(FILE_DATA,',',22)
	FROM CLASSFILEUPD  (NOLOCK)
	WHERE
		SESSION_ID= @SESSIONID
END

UPDATE BFOSCRIP2_IMP SET EXPIRYDATE = MATURITYDATE WHERE EXPIRYDATE ='' OR EXPIRYDATE IS NULL


UPDATE BFOSCRIP2_IMP SET 
					ISIN=ISNULL(ISIN,''),
					BASE_PRICE=ISNULL(BASE_PRICE,0)

DELETE BFOSCRIP2 FROM
	BFOSCRIP2, BFOSCRIP2_IMP 
WHERE
	BFOSCRIP2.SERIES_ID = BFOSCRIP2_IMP.SERIES_ID
	AND LEFT(BFOSCRIP2.EXPIRYDATE,11)  =  LEFT(BFOSCRIP2_IMP.EXPIRYDATE,11)
	
INSERT INTO BFOSCRIP2
SELECT 
	SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',
	STRIKE_PRICE,ISNULL(OPTION_TYPE,''),SERIES_CODE,UNDERLYING_ASSET,
	CA_LEVEL,BASE_PRICE,STARTDATE,
	MATURITYDATE = LEFT(MATURITYDATE,11) + ' 23:59',
	EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,
	LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,
	INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,@SAUDA_DATE,@UNAME,GETDATE()
FROM BFOSCRIP2_IMP

EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CNTMST','',@UNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSCRIP_UPD_BKUP_20JUL2023
-- --------------------------------------------------


CREATE  PROC [dbo].[BFOSCRIP_UPD_BKUP_20JUL2023]  
(        
                @SESSIONID VARCHAR(30),
                @UNAME VARCHAR(30),
                @SAUDA_DATE VARCHAR(11),
                @INTMODE INT,
                @INTFILETYPE INT=0,
                @FILENAME VARCHAR(MAX) = ''
) AS         
        
/*
                @INTFILETYPE = 0 : CONTRACT MASTER CO<DDMMYY>.CSV
                @INTFILETYPE = 1 : NEW CONTRACT MASTER EQD_CO<DDMMYY>.CSV
                
*/
/*
BEGIN TRAN
EXEC BFOSCRIP_UPD'559046020', '', 'SEP 20 2019', 1, 1
ROLLBACK 

SELECT TOP 1 * FROM CLASSFILEUPD 
*/ 
DECLARE @STRSQL VARCHAR(MAX)

TRUNCATE TABLE BFOSCRIP2_IMP

SET @INTFILETYPE = 1

IF @INTMODE=1        
BEGIN

                IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
                BEGIN
                                
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                )

                                SELECT 
                                                SERIES_ID                                            = DBO.PIECE(FILE_DATA,',',          1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILE_DATA,',',          3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILE_DATA,',',          66),--(CASE WHEN DBO.PIECE(FILE_DATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILE_DATA,',',   4)+'OPT' ELSE DBO.PIECE(FILE_DATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILE_DATA,',',          4),
                                                --DBO.PIECE(FILE_DATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILE_DATA,',',8)),
                                                OPTION_TYPE                                    = DBO.PIECE(FILE_DATA,',',          9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',', 53),'') <> '' THEN ISNULL(DBO.PIECE(FILE_DATA,',',   53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILE_DATA,',',    54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILE_DATA,',',          2),
                                                CA_LEVEL                                            = DBO.PIECE(FILE_DATA,',',          61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILE_DATA,',',   11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILE_DATA,',',          31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILE_DATA,',',          32),
                                                PRICE_TICK                                         = DBO.PIECE(FILE_DATA,',',          33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILE_DATA,',',          69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILE_DATA,',', 62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILE_DATA,',',             5) 
                                                                                                                                                    ELSE DBO.PIECE(FILE_DATA,',', 62)
                                                                                                                                  END)   
                                FROM CLASSFILEUPD  (NOLOCK)
                                WHERE
                                SESSION_ID= @SESSIONID
                                AND ISNULL(DBO.PIECE(FILE_DATA,',',7),'')<>''                     

--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100              
                END
                ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
                BEGIN
                                
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN 
                                 )
                                
                                 SELECT 
                                                SERIES_ID                                            = DBO.PIECE(FILE_DATA,',',          1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILE_DATA,',',          3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILE_DATA,',',          66),--(CASE WHEN DBO.PIECE(FILE_DATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILE_DATA,',',   4)+'OPT' ELSE DBO.PIECE(FILE_DATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILE_DATA,',',          4),
                                                --DBO.PIECE(FILE_DATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILE_DATA,',',8)),
                                                OPTION_TYPE                                    = DBO.PIECE(FILE_DATA,',',          9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',', 53),'') <> '' THEN ISNULL(DBO.PIECE(FILE_DATA,',',   53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILE_DATA,',',    54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILE_DATA,',',          2),
                                                CA_LEVEL                                            = DBO.PIECE(FILE_DATA,',',          61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILE_DATA,',',   11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILE_DATA,',',          31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILE_DATA,',',          32),
                                                PRICE_TICK                                         = DBO.PIECE(FILE_DATA,',',          33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILE_DATA,',',          69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILE_DATA,',', 62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILE_DATA,',',             5) 
                                                                                                                                                    ELSE DBO.PIECE(FILE_DATA,',', 62)
                                                                                                                                  END) 
                                FROM CLASSFILEUPD  (NOLOCK)
                                WHERE
                                SESSION_ID= @SESSIONID
                                AND ISNULL(DBO.PIECE(FILE_DATA,',',     7),'') <> ''

                                DELETE FROM CLASSFILEUPD WHERE SESSION_ID= @SESSIONID
                                
--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
                END

END
ELSE                                                       -- BULK IMPORTS
BEGIN
                IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
                BEGIN
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                )

                                SELECT
                                                SERIES_ID                                            = DBO.PIECE(FILEDATA,',',             1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILEDATA,',',             3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILEDATA,',',             66),--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',',        4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILEDATA,',',             4),
                                                --DBO.PIECE(FILEDATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILEDATA,',',        8))/100,
                                                OPTION_TYPE                                    = DBO.PIECE(FILEDATA,',',             9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILEDATA,',',   53),'') <> '' THEN ISNULL(DBO.PIECE(FILEDATA,',',     53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILEDATA,',',       54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILEDATA,',',             2),
                                                CA_LEVEL                                            = DBO.PIECE(FILEDATA,',',             61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILEDATA,',',     11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILEDATA,',',             31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILEDATA,',',             32),
                                                PRICE_TICK                                         = DBO.PIECE(FILEDATA,',',             33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILEDATA,',',             69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILEDATA,',',  62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILEDATA,',', 5) 
                                                                                                                                                    ELSE DBO.PIECE(FILEDATA,',',  62)
                                                                                                                                  END) 
                                                    
                                FROM CLASSFILEUPD_BULK  (NOLOCK)
                                WHERE
                                SPID= @@SPID

                                --DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @@SPID
                                DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @SESSIONID
                END
                ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
                BEGIN 
                                IF @FILENAME <> ''
                                BEGIN
                                                SET @STRSQL = LOWER('BULK INSERT BFOSCRIP2_IMP_TEMP FROM ''' + @FILENAME  + '''  WITH (FIRSTROW = 2,FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'')')          
                                                EXEC(@STRSQL)
                                                
                                                INSERT INTO BFOSCRIP2_IMP
                                                (
                                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                                )

                                                SELECT
                                                                SERIES_ID                                            = COL1,
                                                                PRODUCT_TYPE                = COL3,
                                                                PRODUCT_CODE                              = COL66,--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',', 4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',    4)+'FUT' END),
                                                                ASSET_CODE                                      = COL4,
                                                                EXPIRYDATE                                        = CONVERT(DATETIME,(COL7)),
                                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),COL8)/100,
                                                                OPTION_TYPE                                    = isnull(COL9,''),
                                                                SERIES_CODE                                     = (CASE WHEN ISNULL(COL53,'') <> '' THEN ISNULL(COL53,'') 
                                                                                                                                                ELSE ISNULL(COL54,'') END),
                                                                UNDERLYING_ASSET       = COL2,
                                                                CA_LEVEL                                            = COL61,
                                                                BASE_PRICE                                        = 0, --COL            11), 
                                                                STARTDATE                                         = CONVERT(DATETIME,COL27),
                                                                MATURITYDATE                = CONVERT(DATETIME,COL28),
                                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,COL49),
                                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,COL50),
                                                                MINIMUM_LOT_SIZE     = COL31,
                                                                LOT_SIZE_MULTIPLE       = COL32,
                                                                PRICE_TICK                                         = ISNULL(COL33,''),
                                                                MARGIN_INDICATOR      = 0          ,
                                                                INITAIL_MARGIN_PERC = 0 ,        
                                                                STATUS_FLAG                                    = ISNULL(COL69,''),
                                                                ISIN	= (CASE WHEN ISNULL(COL62,'') = '' THEN ISNULL(COL5,'') ELSE ISNULL(COL62,'') END) 
                                                    
                                                FROM BFOSCRIP2_IMP_TEMP  (NOLOCK)
                                END
                                ELSE
                                BEGIN
                                                INSERT INTO BFOSCRIP2_IMP
                                                (
                                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                                )

                                                SELECT
                                                                SERIES_ID                                            = DBO.PIECE(FILEDATA,',',             1),
                                                                PRODUCT_TYPE                = DBO.PIECE(FILEDATA,',',             3),
                                                                PRODUCT_CODE                              = DBO.PIECE(FILEDATA,',',             66),--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',',        4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',                4)+'FUT' END),
                                                                ASSET_CODE                                      = DBO.PIECE(FILEDATA,',',             4),
                                                                --DBO.PIECE(FILEDATA,',',7),
                                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',7))),
                                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILEDATA,',',                8))/100,
                                                                OPTION_TYPE                                    = DBO.PIECE(FILEDATA,',',             9),
                                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILEDATA,',',   53),'') <> '' THEN ISNULL(DBO.PIECE(FILEDATA,',',            53),'') 
                                                                                                                                                ELSE ISNULL(DBO.PIECE(FILEDATA,',',       54),'') END),
                                                                UNDERLYING_ASSET       = DBO.PIECE(FILEDATA,',',             2),
                                                                CA_LEVEL                                            = DBO.PIECE(FILEDATA,',',             61),
                                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILEDATA,',',     11), 
                                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',27))),
                                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',28))),
                                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',49))),
                                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',50))),
                                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILEDATA,',',             31),
                                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILEDATA,',',             32),
                                                                PRICE_TICK                                         = DBO.PIECE(FILEDATA,',',             33),
                                                                MARGIN_INDICATOR      = 0          ,
                                                                INITAIL_MARGIN_PERC = 0 ,        
                                                                STATUS_FLAG                                    = DBO.PIECE(FILEDATA,',',             69),
                                                                ISIN = (CASE WHEN DBO.PIECE(FILEDATA,',',  62) = ''
                                                                          THEN DBO.PIECE(FILEDATA,',',                5) 
                                                                          ELSE DBO.PIECE(FILEDATA,',',                62)
                                                                       END) 
                                                FROM CLASSFILEUPD_BULK  (NOLOCK)
                                                WHERE
                                                --SPID= @@SPID
                                                SPID = @SESSIONID
                                                AND ISNULL(DBO.PIECE(FILEDATA,',',       3),'') <> ''
                                
                                                --DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @@SPID
                                                DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @SESSIONID
                                END
--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
                END

END
         
UPDATE BFOSCRIP2_IMP SET EXPIRYDATE = MATURITYDATE WHERE EXPIRYDATE ='' OR EXPIRYDATE IS NULL        
        
UPDATE BFOSCRIP2_IMP SET         
ISIN=ISNULL(ISIN,''),        
BASE_PRICE=ISNULL(BASE_PRICE,0),
OPTION_TYPE  = ISNULL(oPTION_TYPE,'')        
 
DELETE BFOSCRIP2 FROM        
BFOSCRIP2, BFOSCRIP2_IMP         
WHERE        
BFOSCRIP2.PRODUCT_TYPE = BFOSCRIP2_IMP.PRODUCT_TYPE 
and BFOSCRIP2.SERIES_CODE = REPLACE(BFOSCRIP2_IMP.SERIES_CODE,' ','')       
AND LEFT(BFOSCRIP2.EXPIRYDATE,11)  =  LEFT(BFOSCRIP2_IMP.EXPIRYDATE,11)  
AND BFOSCRIP2.STRIKE_PRICE = BFOSCRIP2_IMP.STRIKE_PRICE 
AND BFOSCRIP2.OPTION_TYPE = ISNULL(BFOSCRIP2_IMP.OPTION_TYPE,'')      
     
INSERT INTO BFOSCRIP2 (SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
SERIES_CODE,UNDERLYING_ASSET,CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,
MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,TRADE_DATE,UPDATED_BY,UPDATED_ON)      
SELECT         
                SERIES_ID,PRODUCT_TYPE,REPLACE(PRODUCT_CODE,' ',''),REPLACE(ASSET_CODE,' ',''),    
                EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',    
                STRIKE_PRICE,ISNULL(OPTION_TYPE,''),REPLACE(SERIES_CODE,' ',''),REPLACE(UNDERLYING_ASSET,' ',''),    
                CA_LEVEL,BASE_PRICE,STARTDATE,    
                MATURITYDATE = LEFT(MATURITYDATE,11) + ' 23:59',    
                EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,    
                LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,    
                INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,@SAUDA_DATE,@UNAME,GETDATE()    
FROM BFOSCRIP2_IMP    


INSERT INTO TBL_FOSCRIPMAP
SELECT N_INST_TYPE = 
(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END), 
N_SYMBOL=ISIN, N_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
N_STRIKE_PRICE = STRIKE_PRICE, N_OPTION_TYPE = OPTION_TYPE, 
B_INST_TYPE=PRODUCT_CODE, B_SYMBOL = SERIES_CODE, B_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
B_STRIKE_PRICE = STRIKE_PRICE, B_OPTION_TYPE = OPTION_TYPE,
M_INST_TYPE='',M_SYMBOL='',M_EXPIRYDATE='',M_STRIKE_PRICE='',M_OPTION_TYPE='', 
B_INST_TYPE=PRODUCT_CODE, B_SYMBOL = SERIES_CODE, B_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
B_STRIKE_PRICE = STRIKE_PRICE, B_OPTION_TYPE = OPTION_TYPE,
EFF_FROM=STARTDATE,EFF_TO='DEC 31 2049 23:59',UPLOAD_ON=GETDATE(),UPLOAD_BY=@UNAME
FROM BFOSCRIP2_IMP I
WHERE ISIN <> '' and 
ISIN <> '0' AND
ISIN NOT IN (SELECT N_SYMBOL FROM TBL_FOSCRIPMAP T                                 
                                                                WHERE T.N_SYMBOL = I.ISIN 
                                                                -- AND   T.N_INST_TYPE = INST_TYPE
                                                                AND   T.N_STRIKE_PRICE = I.STRIKE_PRICE
                                                                AND   T.N_OPTION_TYPE = I.OPTION_TYPE
                                                                AND   T.N_EXPIRYDATE = LEFT(I.EXPIRYDATE,11) + ' 23:59')
AND SERIES_CODE <> '' 
                    
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CNTMST','',@UNAME,''

TRUNCATE TABLE CLASSFILEUPD  
TRUNCATE TABLE CLASSFILEUPD_BULK

INSERT INTO NSEFO.DBO.FOSCRIP1
SELECT N_INST_TYPE = 
(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END),ISIN,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
FROM BSEFO.DBO.BFOSCRIP2 T
WHERE  NOT EXISTS (
                    SELECT SYMBOL FROM NSEFO.DBO.FOSCRIP1 F
                    WHERE F.INST_TYPE = RIGHT(T.PRODUCT_CODE,3)
                    AND F.SYMBOL = T.ISIN
                    AND F.EXPIRYDATE = T.EXPIRYDATE
                    AND F.STRIKE_PRICE = T.STRIKE_PRICE
                    AND F.OPTION_TYPE = T.OPTION_TYPE)
                    AND T.ISIN <> '' 
					AND T.ISIN <> '0'
                    AND T.ISIN LIKE '%SENSEX%'
                    AND EXPIRYDATE > GETDATE()

INSERT INTO NSEFO.DBO.FOSCRIP2
SELECT P_KEY=0,INST_TYPE=(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END),SYMBOL=ISIN,SEC_NAME=SERIES_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
                   STARTDATE,MATURITYDATE=EXPIRYDATE,
                   SERIES='0',COR_ACT_LEVEL='0',C_REGULAR_LOT=MINIMUM_LOT_SIZE,
                   C_ISSUE_MAT_DT='',C_U_INST_TYPE='',C_U_SYMBOL='',C_U_SERIES='',C_U_EXPIRYDATE='',C_U_STRIKEPRICE='',C_U_OPTION_TYPE='',C_U_CAL=''
FROM BSEFO.DBO.BFOSCRIP2 T WHERE ISIN <> ''
AND ISIN <> '0' AND NOT EXISTS (
                                SELECT SYMBOL FROM NSEFO.DBO.FOSCRIP2 F
                                WHERE F.INST_TYPE = RIGHT(T.PRODUCT_CODE,3)
                                AND F.SYMBOL = T.ISIN
                                AND F.EXPIRYDATE = T.EXPIRYDATE
                                AND F.STRIKE_PRICE = T.STRIKE_PRICE
                                AND F.OPTION_TYPE = T.OPTION_TYPE)
AND T.ISIN <> '' AND T.ISIN <> '0'
AND T.ISIN LIKE '%SENSEX%'
AND EXPIRYDATE > GETDATE()


--EXEC NSEFO.DBO.FOSCRIP_DUPDEL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSCRIP_UPD_BKUP_26JUl2023
-- --------------------------------------------------



CREATE  PROC [dbo].[BFOSCRIP_UPD_BKUP_26JUl2023]  
(        
                @SESSIONID VARCHAR(30),
                @UNAME VARCHAR(30),
                @SAUDA_DATE VARCHAR(11),
                @INTMODE INT,
                @INTFILETYPE INT=0,
                @FILENAME VARCHAR(MAX) = ''
) AS         
        
/*
                @INTFILETYPE = 0 : CONTRACT MASTER CO<DDMMYY>.CSV
                @INTFILETYPE = 1 : NEW CONTRACT MASTER EQD_CO<DDMMYY>.CSV
                
*/
/*
BEGIN TRAN
EXEC BFOSCRIP_UPD'559046020', '', 'SEP 20 2019', 1, 1
ROLLBACK 

SELECT TOP 1 * FROM CLASSFILEUPD 
*/ 
DECLARE @STRSQL VARCHAR(MAX)

TRUNCATE TABLE BFOSCRIP2_IMP

SET @INTFILETYPE = 1

IF @INTMODE=1        
BEGIN

                IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
                BEGIN
                                
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                )

                                SELECT 
                                                SERIES_ID                                            = DBO.PIECE(FILE_DATA,',',          1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILE_DATA,',',          3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILE_DATA,',',          66),--(CASE WHEN DBO.PIECE(FILE_DATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILE_DATA,',',   4)+'OPT' ELSE DBO.PIECE(FILE_DATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILE_DATA,',',          4),
                                                --DBO.PIECE(FILE_DATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILE_DATA,',',8)),
                                                OPTION_TYPE                                    = DBO.PIECE(FILE_DATA,',',          9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',', 53),'') <> '' THEN ISNULL(DBO.PIECE(FILE_DATA,',',   53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILE_DATA,',',    54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILE_DATA,',',          2),
                                                CA_LEVEL                                            = DBO.PIECE(FILE_DATA,',',          61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILE_DATA,',',   11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILE_DATA,',',          31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILE_DATA,',',          32),
                                                PRICE_TICK                                         = DBO.PIECE(FILE_DATA,',',          33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILE_DATA,',',          69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILE_DATA,',', 62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILE_DATA,',',             5) 
                                                                                                                                                    ELSE DBO.PIECE(FILE_DATA,',', 62)
                                                                                                                                  END)   
                                FROM CLASSFILEUPD  (NOLOCK)
                                WHERE
                                SESSION_ID= @SESSIONID
                                AND ISNULL(DBO.PIECE(FILE_DATA,',',7),'')<>''                     

--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100              
                END
                ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
                BEGIN
                                
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN 
                                 )
                                
                                 SELECT 
                                                SERIES_ID                                            = DBO.PIECE(FILE_DATA,',',          1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILE_DATA,',',          3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILE_DATA,',',          66),--(CASE WHEN DBO.PIECE(FILE_DATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILE_DATA,',',   4)+'OPT' ELSE DBO.PIECE(FILE_DATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILE_DATA,',',          4),
                                                --DBO.PIECE(FILE_DATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILE_DATA,',',8)),
                                                OPTION_TYPE                                    = DBO.PIECE(FILE_DATA,',',          9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',', 53),'') <> '' THEN ISNULL(DBO.PIECE(FILE_DATA,',',   53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILE_DATA,',',    54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILE_DATA,',',          2),
                                                CA_LEVEL                                            = DBO.PIECE(FILE_DATA,',',          61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILE_DATA,',',   11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILE_DATA,',',          31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILE_DATA,',',          32),
                                                PRICE_TICK                                         = DBO.PIECE(FILE_DATA,',',          33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILE_DATA,',',          69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILE_DATA,',', 62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILE_DATA,',',             5) 
                                                                                                                                                    ELSE DBO.PIECE(FILE_DATA,',', 62)
                                                                                                                                  END) 
                                FROM CLASSFILEUPD  (NOLOCK)
                                WHERE
                                SESSION_ID= @SESSIONID
                                AND ISNULL(DBO.PIECE(FILE_DATA,',',     7),'') <> ''

                                DELETE FROM CLASSFILEUPD WHERE SESSION_ID= @SESSIONID
                                
--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
                END

END
ELSE                                                       -- BULK IMPORTS
BEGIN
                IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
                BEGIN
                                INSERT INTO BFOSCRIP2_IMP
                                (
                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                )

                                SELECT
                                                SERIES_ID                                            = DBO.PIECE(FILEDATA,',',             1),
                                                PRODUCT_TYPE                = DBO.PIECE(FILEDATA,',',             3),
                                                PRODUCT_CODE                              = DBO.PIECE(FILEDATA,',',             66),--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',',        4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',                4)+'FUT' END),
                                                ASSET_CODE                                      = DBO.PIECE(FILEDATA,',',             4),
                                                --DBO.PIECE(FILEDATA,',',7),
                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',7))),
                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILEDATA,',',        8))/100,
                                                OPTION_TYPE                                    = DBO.PIECE(FILEDATA,',',             9),
                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILEDATA,',',   53),'') <> '' THEN ISNULL(DBO.PIECE(FILEDATA,',',     53),'') 
                                                                                                                                ELSE ISNULL(DBO.PIECE(FILEDATA,',',       54),'') END),
                                                UNDERLYING_ASSET       = DBO.PIECE(FILEDATA,',',             2),
                                                CA_LEVEL                                            = DBO.PIECE(FILEDATA,',',             61),
                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILEDATA,',',     11), 
                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',27))),
                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',28))),
                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',49))),
                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',50))),
                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILEDATA,',',             31),
                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILEDATA,',',             32),
                                                PRICE_TICK                                         = DBO.PIECE(FILEDATA,',',             33),
                                                MARGIN_INDICATOR      = 0          ,
                                                INITAIL_MARGIN_PERC = 0 ,        
                                                STATUS_FLAG                                    = DBO.PIECE(FILEDATA,',',             69),
                                                ISIN                                                        = (CASE WHEN DBO.PIECE(FILEDATA,',',  62) = ''
                                                                                                                                                    THEN DBO.PIECE(FILEDATA,',', 5) 
                                                                                                                                                    ELSE DBO.PIECE(FILEDATA,',',  62)
                                                                                                                                  END) 
                                                    
                                FROM CLASSFILEUPD_BULK  (NOLOCK)
                                WHERE
                                SPID= @@SPID

                                --DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @@SPID
                                DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @SESSIONID
                END
                ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
                BEGIN 
                                IF @FILENAME <> ''
                                BEGIN
                                                SET @STRSQL = LOWER('BULK INSERT BFOSCRIP2_IMP_TEMP FROM ''' + @FILENAME  + '''  WITH (FIRSTROW = 2,FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'')')          
                                                EXEC(@STRSQL)
                                                
                                                INSERT INTO BFOSCRIP2_IMP
                                                (
                                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                                )

                                                SELECT
                                                                SERIES_ID                                            = COL1,
                                                                PRODUCT_TYPE                = COL3,
                                                                PRODUCT_CODE                              = COL66,--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',', 4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',    4)+'FUT' END),
                                                                ASSET_CODE                                      = COL4,
                                                                EXPIRYDATE                                        = CONVERT(DATETIME,(COL7)),
                                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),COL8)/100,
                                                                OPTION_TYPE                                    = isnull(COL9,''),
                                                                SERIES_CODE                                     = (CASE WHEN ISNULL(COL53,'') <> '' THEN ISNULL(COL53,'') 
                                                                                                                                                ELSE ISNULL(COL54,'') END),
                                                                UNDERLYING_ASSET       = COL2,
                                                                CA_LEVEL                                            = COL61,
                                                                BASE_PRICE                                        = 0, --COL            11), 
                                                                STARTDATE                                         = CONVERT(DATETIME,COL27),
                                                                MATURITYDATE                = CONVERT(DATETIME,COL28),
                                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,COL49),
                                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,COL50),
                                                                MINIMUM_LOT_SIZE     = COL31,
                                                                LOT_SIZE_MULTIPLE       = COL32,
                                                                PRICE_TICK                                         = ISNULL(COL33,''),
                                                                MARGIN_INDICATOR      = 0          ,
                                                                INITAIL_MARGIN_PERC = 0 ,        
                                                                STATUS_FLAG                                    = ISNULL(COL69,''),
                                                                ISIN	= (CASE WHEN ISNULL(COL62,'') = '' THEN ISNULL(COL5,'') ELSE ISNULL(COL62,'') END) 
                                                    
                                                FROM BFOSCRIP2_IMP_TEMP  (NOLOCK)
                                END
                                ELSE
                                BEGIN
                                                INSERT INTO BFOSCRIP2_IMP
                                                (
                                                  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
                                                  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
                                                  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
                                                )

                                                SELECT
                                                                SERIES_ID                                            = DBO.PIECE(FILEDATA,',',             1),
                                                                PRODUCT_TYPE                = DBO.PIECE(FILEDATA,',',             3),
                                                                PRODUCT_CODE                              = DBO.PIECE(FILEDATA,',',             66),--(CASE WHEN DBO.PIECE(FILEDATA,',',3) IN ('SO','IO') THEN DBO.PIECE(FILEDATA,',',        4)+'OPT' ELSE DBO.PIECE(FILEDATA,',',                4)+'FUT' END),
                                                                ASSET_CODE                                      = DBO.PIECE(FILEDATA,',',             4),
                                                                --DBO.PIECE(FILEDATA,',',7),
                                                                EXPIRYDATE                                        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',7))),
                                                                STRIKE_PRICE                    = CONVERT(NUMERIC(18,2),DBO.PIECE(FILEDATA,',',                8))/100,
                                                                OPTION_TYPE                                    = DBO.PIECE(FILEDATA,',',             9),
                                                                SERIES_CODE                                     = (CASE WHEN ISNULL(DBO.PIECE(FILEDATA,',',   53),'') <> '' THEN ISNULL(DBO.PIECE(FILEDATA,',',            53),'') 
                                                                                                                                                ELSE ISNULL(DBO.PIECE(FILEDATA,',',       54),'') END),
                                                                UNDERLYING_ASSET       = DBO.PIECE(FILEDATA,',',             2),
                                                                CA_LEVEL                                            = DBO.PIECE(FILEDATA,',',             61),
                                                                BASE_PRICE                                        = 0, --DBO.PIECE(FILEDATA,',',     11), 
                                                                STARTDATE                                         = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',27))),
                                                                MATURITYDATE                = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',28))),
                                                                EXERCISE_STARTDATE    = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',49))),
                                                                EXERCISE_ENDDATE        = CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',50))),
                                                                MINIMUM_LOT_SIZE     = DBO.PIECE(FILEDATA,',',             31),
                                                                LOT_SIZE_MULTIPLE       = DBO.PIECE(FILEDATA,',',             32),
                                                                PRICE_TICK                                         = DBO.PIECE(FILEDATA,',',             33),
                                                                MARGIN_INDICATOR      = 0          ,
                                                                INITAIL_MARGIN_PERC = 0 ,        
                                                                STATUS_FLAG                                    = DBO.PIECE(FILEDATA,',',             69),
                                                                ISIN = (CASE WHEN DBO.PIECE(FILEDATA,',',  62) = ''
                                                                          THEN DBO.PIECE(FILEDATA,',',                5) 
                                                                          ELSE DBO.PIECE(FILEDATA,',',                62)
                                                                       END) 
                                                FROM CLASSFILEUPD_BULK  (NOLOCK)
                                                WHERE
                                                --SPID= @@SPID
                                                SPID = @SESSIONID
                                                AND ISNULL(DBO.PIECE(FILEDATA,',',       3),'') <> ''
                                
                                                --DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @@SPID
                                                DELETE FROM CLASSFILEUPD_BULK WHERE SPID= @SESSIONID
                                END
--                                UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
                END

END
         
UPDATE BFOSCRIP2_IMP SET EXPIRYDATE = MATURITYDATE WHERE EXPIRYDATE ='' OR EXPIRYDATE IS NULL        
        
UPDATE BFOSCRIP2_IMP SET         
ISIN=ISNULL(ISIN,''),        
BASE_PRICE=ISNULL(BASE_PRICE,0),
OPTION_TYPE  = ISNULL(oPTION_TYPE,'')        
 
DELETE BFOSCRIP2 FROM        
BFOSCRIP2, BFOSCRIP2_IMP         
WHERE        
BFOSCRIP2.PRODUCT_TYPE = BFOSCRIP2_IMP.PRODUCT_TYPE 
and BFOSCRIP2.SERIES_CODE = REPLACE(BFOSCRIP2_IMP.SERIES_CODE,' ','')       
AND LEFT(BFOSCRIP2.EXPIRYDATE,11)  =  LEFT(BFOSCRIP2_IMP.EXPIRYDATE,11)  
AND BFOSCRIP2.STRIKE_PRICE = BFOSCRIP2_IMP.STRIKE_PRICE 
AND BFOSCRIP2.OPTION_TYPE = ISNULL(BFOSCRIP2_IMP.OPTION_TYPE,'')      
     
INSERT INTO BFOSCRIP2 (SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
SERIES_CODE,UNDERLYING_ASSET,CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,
MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,TRADE_DATE,UPDATED_BY,UPDATED_ON)      
SELECT         
                SERIES_ID,PRODUCT_TYPE,REPLACE(PRODUCT_CODE,' ',''),REPLACE(ASSET_CODE,' ',''),    
                EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',    
                STRIKE_PRICE,ISNULL(OPTION_TYPE,''),REPLACE(SERIES_CODE,' ',''),REPLACE(UNDERLYING_ASSET,' ',''),    
                CA_LEVEL,BASE_PRICE,STARTDATE,    
                MATURITYDATE = LEFT(MATURITYDATE,11) + ' 23:59',    
                EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,    
                LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,    
                INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,@SAUDA_DATE,@UNAME,GETDATE()    
FROM BFOSCRIP2_IMP    


INSERT INTO TBL_FOSCRIPMAP
SELECT N_INST_TYPE = 
(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END), 
N_SYMBOL=ISIN, N_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
N_STRIKE_PRICE = STRIKE_PRICE, N_OPTION_TYPE = OPTION_TYPE, 
B_INST_TYPE=PRODUCT_CODE, B_SYMBOL = SERIES_CODE, B_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
B_STRIKE_PRICE = STRIKE_PRICE, B_OPTION_TYPE = OPTION_TYPE,
M_INST_TYPE='',M_SYMBOL='',M_EXPIRYDATE='',M_STRIKE_PRICE='',M_OPTION_TYPE='', 
B_INST_TYPE=PRODUCT_CODE, B_SYMBOL = SERIES_CODE, B_EXPIRYDATE=LEFT(EXPIRYDATE,11) + ' 23:59', 
B_STRIKE_PRICE = STRIKE_PRICE, B_OPTION_TYPE = OPTION_TYPE,
EFF_FROM=STARTDATE,EFF_TO='DEC 31 2049 23:59',UPLOAD_ON=GETDATE(),UPLOAD_BY=@UNAME
FROM BFOSCRIP2_IMP I
WHERE ISIN <> '' and 
ISIN <> '0' AND
ISIN NOT IN (SELECT N_SYMBOL FROM TBL_FOSCRIPMAP T                                 
                                                                WHERE T.N_SYMBOL = I.ISIN 
                                                                -- AND   T.N_INST_TYPE = INST_TYPE
                                                                AND   T.N_STRIKE_PRICE = I.STRIKE_PRICE
                                                                AND   T.N_OPTION_TYPE = I.OPTION_TYPE
                                                                AND   T.N_EXPIRYDATE = LEFT(I.EXPIRYDATE,11) + ' 23:59')
AND SERIES_CODE <> '' 
                    
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CNTMST','',@UNAME,''

TRUNCATE TABLE CLASSFILEUPD  
TRUNCATE TABLE CLASSFILEUPD_BULK

INSERT INTO NSEFO.DBO.FOSCRIP1
SELECT N_INST_TYPE = 
(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END),ISIN,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
FROM BSEFO.DBO.BFOSCRIP2 T
WHERE  NOT EXISTS (
                    SELECT SYMBOL FROM NSEFO.DBO.FOSCRIP1 F
                    WHERE F.INST_TYPE = RIGHT(T.PRODUCT_CODE,3)
                    AND F.SYMBOL = T.ISIN
                    AND F.EXPIRYDATE = T.EXPIRYDATE
                    AND F.STRIKE_PRICE = T.STRIKE_PRICE
                    AND F.OPTION_TYPE = T.OPTION_TYPE)
                    AND T.ISIN <> '' 
					AND T.ISIN <> '0'
                    AND T.ISIN LIKE '%SENSEX%'
                    AND EXPIRYDATE > GETDATE()

INSERT INTO NSEFO.DBO.FOSCRIP2
SELECT P_KEY=0,INST_TYPE=(CASE WHEN PRODUCT_TYPE = 'SO' THEN 'OPTSTK' WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX' 
WHEN PRODUCT_TYPE = 'SF' THEN 'FUTSTK' 
WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX' ELSE '' END),SYMBOL=ISIN,SEC_NAME=SERIES_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
                   STARTDATE,MATURITYDATE=EXPIRYDATE,
                   SERIES='0',COR_ACT_LEVEL='0',C_REGULAR_LOT=MINIMUM_LOT_SIZE,
                   C_ISSUE_MAT_DT='',C_U_INST_TYPE='',C_U_SYMBOL='',C_U_SERIES='',C_U_EXPIRYDATE='',C_U_STRIKEPRICE='',C_U_OPTION_TYPE='',C_U_CAL=''
FROM BSEFO.DBO.BFOSCRIP2 T WHERE ISIN <> ''
AND ISIN <> '0' AND NOT EXISTS (
                                SELECT SYMBOL FROM NSEFO.DBO.FOSCRIP2 F
                                WHERE F.INST_TYPE = RIGHT(T.PRODUCT_CODE,3)
                                AND F.SYMBOL = T.ISIN
                                AND F.EXPIRYDATE = T.EXPIRYDATE
                                AND F.STRIKE_PRICE = T.STRIKE_PRICE
                                AND F.OPTION_TYPE = T.OPTION_TYPE)
AND T.ISIN <> '' AND T.ISIN <> '0'
AND T.ISIN LIKE '%SENSEX%'
AND EXPIRYDATE > GETDATE()


--EXEC NSEFO.DBO.FOSCRIP_DUPDEL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSETTBROKEDITUP
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BFOSettBrokEditUp](
               @PRODUCT_TYPE VARCHAR(5),
               @PRODUCT_CODE VARCHAR(10),
               @SERIES_CODE  VARCHAR(13),
               @EXPIRYDATE   VARCHAR(11),
               @PARTY_CODE   VARCHAR(10),
               @TRADE_NO     VARCHAR(14),
               @ORDER_NO     VARCHAR(20),
               @CONTRACTNO   VARCHAR(10),
               @TRADE_PRICE   NUMERIC(18,9),
               @BROK         NUMERIC(18,8),
               @VAL_PERC     VARCHAR(1),
               @SELL_BUY     INT,
               @NETRATE      NUMERIC(18,9),
               @SAUDA_DATE   VARCHAR(11),
               @FLAG         INT,
               @SERIES_ID    INT,
               @STATUSID     VARCHAR(50)  = 'BROKER',
               @STRMODULE    VARCHAR(50)  = 'BROKER')

     AS

     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED	
     SELECT DISTINCT 
		CONTRACTNO,
                F.TRADE_NO,
                F.PRODUCT_CODE,
                F.PRODUCT_TYPE,
                F.PARTY_CODE,
                F.SERIES_CODE,
                F.SERIES_ID,
                S2.EXPIRYDATE,
                TRADEQTY,
                AUCTIONPART,
                 ORDER_NO,
                TRADE_PRICE,
                F.STRIKE_PRICE,
                SAUDA_DATE,
                F.SELL_BUY,
                F.SETTFLAG,

		C2.TRAN_CAT,
		C2.STD_RATE,
		C2.BROK2_TABLENO,
                MPRICE = (CASE 
                            WHEN C2.DUMMY1 = 0 THEN TRADE_PRICE
                            ELSE (CASE 
                                    WHEN C2.DUMMY1 = 1 THEN (CASE 
                                                               WHEN S2.STRIKE_PRICE = 0 THEN F.TRADE_PRICE
                                                               ELSE S2.STRIKE_PRICE
                                                             END)
                                    ELSE S2.STRIKE_PRICE + TRADE_PRICE
                                  END)
                          END),

		MULTIPLIER = 1,	
                TAXPRICE = (CASE 
                              WHEN TAXESFLAG = 0 THEN TRADE_PRICE
                              ELSE (CASE 
                                      WHEN TAXESFLAG = 1 THEN (CASE 
                                                                 WHEN F.STRIKE_PRICE = 0 THEN F.TRADE_PRICE
  ELSE F.STRIKE_PRICE
                                                               END)
                                      ELSE F.TRADE_PRICE + TRADE_PRICE
                                    END)
                            END)
	INTO   #BFOTRADE
	FROM   BFOSETTLEMENT F,
	       BFOSCRIP2 S2,
	       CLIENT2 C2,
	       CLIENT1 C1,
	       BFOOWNER
	WHERE  C2.PARTY_CODE = F.PARTY_CODE
	       AND C1.CL_CODE = C2.CL_CODE
	       AND F.PRODUCT_TYPE = S2.PRODUCT_TYPE
	       AND F.PRODUCT_CODE = S2.PRODUCT_CODE
	       AND F.SERIES_CODE = S2.SERIES_CODE
	       AND F.SERIES_ID = S2.SERIES_ID
	       AND F.PRODUCT_CODE = @PRODUCT_CODE
	       AND F.PRODUCT_TYPE = @PRODUCT_TYPE
	       AND F.SERIES_CODE = @SERIES_CODE
	       AND CONVERT(VARCHAR(11),F.EXPIRYDATE,109) = @EXPIRYDATE
	       --AND F.SERIES_ID = @SERIES_ID
	       AND F.PARTY_CODE = @PARTY_CODE
	       AND F.TRADE_NO LIKE @TRADE_NO
	       AND F.ORDER_NO LIKE @ORDER_NO
	       AND F.CONTRACTNO LIKE @CONTRACTNO


  IF @FLAG = 1
    BEGIN
      UPDATE BFOSETTLEMENT
      SET    BROKAPPLIED = (CASE 
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'V') THEN ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'V') THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'V') THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'V') THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
ELSE 0
                            END),
             NETRATE = (CASE 
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
ELSE 0
END),
             SERVICE_TAX = (CASE 
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
ELSE 0
                            END),
             STATUS = 'E'
      FROM   BFOSETTLEMENT,
             BROKTABLE,
             BFOTAXES,
             BFOGLOBALS,
	     #BFOTRADE F

      WHERE  CONVERT(VARCHAR(11),BFOSETTLEMENT.SAUDA_DATE,109) = @SAUDA_DATE
             AND BFOSETTLEMENT.PRODUCT_CODE = @PRODUCT_CODE
             AND BFOSETTLEMENT.PRODUCT_TYPE = @PRODUCT_TYPE
             AND BFOSETTLEMENT.SERIES_CODE = @SERIES_CODE
             AND CONVERT(VARCHAR(11),BFOSETTLEMENT.EXPIRYDATE,109) = @EXPIRYDATE
             --AND BFOSETTLEMENT.SERIES_ID = @SERIES_ID
             AND BFOSETTLEMENT.PARTY_CODE = @PARTY_CODE
             AND BFOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
             AND BFOSETTLEMENT.ORDER_NO LIKE @ORDER_NO
             AND BFOSETTLEMENT.CONTRACTNO LIKE @CONTRACTNO
             --AND CLIENT2.PARTY_CODE = @PARTY_CODE
             AND F.TRAN_CAT = BFOTAXES.TRANS_CAT
             AND BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE
             AND BFOSETTLEMENT.PRODUCT_TYPE = F.PRODUCT_TYPE
             AND BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE
             AND BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE
             AND BFOSETTLEMENT.EXPIRYDATE = F.EXPIRYDATE
             AND BFOSETTLEMENT.SERIES_ID = F.SERIES_ID
             AND BFOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE
             AND BFOSETTLEMENT.TRADE_NO = F.TRADE_NO
             AND BFOSETTLEMENT.ORDER_NO = F.ORDER_NO
             AND BFOSETTLEMENT.SELL_BUY = F.SELL_BUY
             AND BROKTABLE.TABLE_NO = (SELECT TABLE_NO
                                       FROM   BROKTABLE
                                       WHERE  TABLE_NO = (CASE 
                                                            WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN F.STD_RATE
                                                            ELSE F.BROK2_TABLENO
                                                          END)
                                              AND LINE_NO = 1)
             AND BROKTABLE.LINE_NO = 1
    END
    
  IF @FLAG = 2
    BEGIN
      UPDATE BFOSETTLEMENT
      SET    BROKAPPLIED = (CASE 
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'V') THEN ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'V') THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'V') THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'V') THEN ((FLOOR((@BROK * F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'P') THEN ((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
ELSE 0
END),
             
             NETRATE = (CASE 
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P'
AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) + ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR((((@BROK * F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) - ((FLOOR(((((@BROK * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
ELSE 0
END),
             
     
             
             SERVICE_TAX = (CASE 
WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 1
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 2
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) /

POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 3
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) /

POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'V') THEN ((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) 
/ POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 4
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) /

POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'V') THEN

((FLOOR(((((((FLOOR(((@BROK * F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))
) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

WHEN (BFOSETTLEMENT.SETTFLAG = 5
AND @VAL_PERC = 'P') THEN ((FLOOR(((((((FLOOR((((@BROK * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) /

POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM) / (BROKTABLE.ROFIG + 
BROKTABLE.NOZERO)) * (BROKTABLE.ROFIG + BROKTABLE.NOZERO)) / POWER(10,BROKTABLE.ROUND_TO))

ELSE 0
END),
         
            STATUS = 'E'
      FROM   BFOSETTLEMENT,
             BROKTABLE,
             BFOTAXES,
             BFOGLOBALS,
	     #BFOTRADE F
      WHERE  CONVERT(VARCHAR(11),BFOSETTLEMENT.SAUDA_DATE,109) = @SAUDA_DATE
             AND BFOSETTLEMENT.PRODUCT_CODE = @PRODUCT_CODE
             AND BFOSETTLEMENT.PRODUCT_TYPE = @PRODUCT_TYPE
             AND BFOSETTLEMENT.SERIES_CODE = @SERIES_CODE
             AND CONVERT(VARCHAR(11),BFOSETTLEMENT.EXPIRYDATE,109) = @EXPIRYDATE
             --AND BFOSETTLEMENT.SERIES_ID = @SERIES_ID
             AND BFOSETTLEMENT.PARTY_CODE = @PARTY_CODE
             AND BFOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
             AND BFOSETTLEMENT.ORDER_NO LIKE @ORDER_NO
             AND BFOSETTLEMENT.CONTRACTNO LIKE @CONTRACTNO
             AND BFOSETTLEMENT.TRADE_PRICE = @TRADE_PRICE
             --AND CLIENT2.PARTY_CODE = @PARTY_CODE
             AND F.TRAN_CAT = BFOTAXES.TRANS_CAT
             AND BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE
             AND BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE
             AND BFOSETTLEMENT.PRODUCT_TYPE = F.PRODUCT_TYPE
             AND BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE
             AND BFOSETTLEMENT.EXPIRYDATE = F.EXPIRYDATE
             AND BFOSETTLEMENT.SERIES_ID = F.SERIES_ID
             AND BFOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE
             AND BFOSETTLEMENT.TRADE_NO = F.TRADE_NO
             AND BFOSETTLEMENT.ORDER_NO = F.ORDER_NO
             AND BFOSETTLEMENT.SELL_BUY = F.SELL_BUY
             AND BROKTABLE.TABLE_NO = (SELECT TABLE_NO
                                       FROM   BROKTABLE
                                       WHERE  TABLE_NO = (CASE 
                                                            WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN F.STD_RATE
                                                            ELSE F.BROK2_TABLENO
                                                          END)
                                              AND LINE_NO = 1)
                                      
             AND BROKTABLE.LINE_NO = 1
                 
    END
    
  ELSE
    IF @FLAG = 3
      BEGIN

        UPDATE BFOSETTLEMENT
        SET    NETRATE = ROUND(@NETRATE,ROUND_TO),
               N_NETRATE = ROUND(@NETRATE,ROUND_TO),
               BROKAPPLIED = ROUND(ABS(@NETRATE - F.MPRICE),BROKTABLE.ROUND_TO),
               NBROKAPP = ROUND(ABS(@NETRATE - F.MPRICE),BROKTABLE.ROUND_TO),
               SERVICE_TAX = ROUND(BFOSETTLEMENT.TRADEQTY * ABS(@NETRATE - F.MPRICE) * BFOGLOBALS.SERVICE_TAX / 100,
                                   BROKTABLE.ROUND_TO),
               NSERTAX = ROUND(BFOSETTLEMENT.TRADEQTY * ABS(@NETRATE - F.MPRICE) * BFOGLOBALS.SERVICE_TAX / 100,
                               BROKTABLE.ROUND_TO),
               AMOUNT = ROUND(@NETRATE * BFOSETTLEMENT.TRADEQTY,BROKTABLE.ROUND_TO),
               STATUS = 'E'
        FROM   BFOGLOBALS,
               BROKTABLE,
               BFOSETTLEMENT,
	       #BFOTRADE F
        WHERE  CONVERT(VARCHAR(11),BFOSETTLEMENT.SAUDA_DATE,109) = @SAUDA_DATE
               AND BFOSETTLEMENT.PRODUCT_CODE = @PRODUCT_CODE
               AND BFOSETTLEMENT.PRODUCT_TYPE = @PRODUCT_TYPE
               AND BFOSETTLEMENT.SERIES_CODE = @SERIES_CODE
               AND CONVERT(VARCHAR(11),BFOSETTLEMENT.EXPIRYDATE,109) = @EXPIRYDATE
               --AND BFOSETTLEMENT.SERIES_ID = @SERIES_ID
               AND BFOSETTLEMENT.PARTY_CODE = @PARTY_CODE
               AND BFOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
               AND BFOSETTLEMENT.ORDER_NO LIKE @ORDER_NO
	       AND BFOSETTLEMENT.CONTRACTNO LIKE @CONTRACTNO             
               --AND CLIENT2.PARTY_CODE = @PARTY_CODE
               AND BFOSETTLEMENT.SELL_BUY = @SELL_BUY
               AND BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE
               AND BFOSETTLEMENT.PRODUCT_TYPE = F.PRODUCT_TYPE
               AND BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE
               AND BFOSETTLEMENT.EXPIRYDATE = F.EXPIRYDATE
               AND BFOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE
               AND BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE
               AND BFOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE
               AND BFOSETTLEMENT.TRADE_NO = F.TRADE_NO
               AND BFOSETTLEMENT.ORDER_NO = F.ORDER_NO
               AND BFOSETTLEMENT.SELL_BUY = F.SELL_BUY
                                            
               AND BROKTABLE.TABLE_NO = (SELECT TABLE_NO
                                         FROM   BROKTABLE
                                         WHERE  TABLE_NO = (CASE 
                                                              WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN F.STD_RATE
                                                              ELSE F.BROK2_TABLENO
                                                            END)
                                                AND LINE_NO = 1)
                                        
               AND BROKTABLE.LINE_NO = 1 
      END
      
    ELSE
      IF @FLAG = 4
        BEGIN
          UPDATE BFOSETTLEMENT
          SET    NETRATE = ROUND(@NETRATE,ROUND_TO),
                 N_NETRATE = ROUND(@NETRATE,ROUND_TO),
                 BROKAPPLIED = ROUND(ABS(@NETRATE - F.MPRICE),BROKTABLE.ROUND_TO),
                 NBROKAPP = ROUND(ABS(@NETRATE - F.MPRICE),BROKTABLE.ROUND_TO),
                 SERVICE_TAX = ROUND(BFOSETTLEMENT.TRADEQTY * ABS(@NETRATE - F.MPRICE) * BFOGLOBALS.SERVICE_TAX / 100,
                                     BROKTABLE.ROUND_TO),
                 NSERTAX = ROUND(BFOSETTLEMENT.TRADEQTY * ABS(@NETRATE - F.MPRICE) * BFOGLOBALS.SERVICE_TAX / 100,
                                 BROKTABLE.ROUND_TO),
                 AMOUNT = ROUND(@NETRATE * BFOSETTLEMENT.TRADEQTY,BROKTABLE.ROUND_TO),
                 STATUS = 'E'
          FROM   BFOGLOBALS,
                 BROKTABLE,
                 BFOSETTLEMENT,
 				#BFOTRADE F
                 
          WHERE  CONVERT(VARCHAR(11),BFOSETTLEMENT.SAUDA_DATE,109) = @SAUDA_DATE
                 AND BFOSETTLEMENT.PRODUCT_CODE = @PRODUCT_CODE
                 AND BFOSETTLEMENT.PRODUCT_TYPE = @PRODUCT_TYPE
                 AND BFOSETTLEMENT.SERIES_CODE = @SERIES_CODE
                 AND CONVERT(VARCHAR(11),BFOSETTLEMENT.EXPIRYDATE,109) = @EXPIRYDATE
                 --AND BFOSETTLEMENT.SERIES_ID = @SERIES_ID
                 AND BFOSETTLEMENT.PARTY_CODE = @PARTY_CODE
                 AND BFOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
                 AND BFOSETTLEMENT.ORDER_NO LIKE @ORDER_NO
				 AND BFOSETTLEMENT.CONTRACTNO LIKE @CONTRACTNO
                 AND BFOSETTLEMENT.TRADE_PRICE = @TRADE_PRICE
                 --AND CLIENT2.PARTY_CODE = @PARTY_CODE
                 AND BFOSETTLEMENT.SELL_BUY = @SELL_BUY
                 AND BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE
                 AND BFOSETTLEMENT.PRODUCT_TYPE = F.PRODUCT_TYPE
                 AND BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE
                 AND BFOSETTLEMENT.EXPIRYDATE = F.EXPIRYDATE
                 AND BFOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE
                 AND BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE
                 AND BFOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE
                 AND BFOSETTLEMENT.TRADE_NO = F.TRADE_NO
                 AND BFOSETTLEMENT.ORDER_NO = F.ORDER_NO
                 AND BFOSETTLEMENT.SELL_BUY = F.SELL_BUY
                 AND BFOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT
                  AND YEAR_END_DT
                 AND BROKTABLE.TABLE_NO = (SELECT TABLE_NO
                                           FROM   BROKTABLE
                                           WHERE  TABLE_NO = (CASE 
                                                                WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN F.STD_RATE
                                                                ELSE F.BROK2_TABLENO
                                                              END)
                                                  AND LINE_NO = 1)
                 AND BROKTABLE.LINE_NO = 1
        END
        


	IF @@ERROR = 0
	  BEGIN
			EXEC CONSOLE_LOG
			@PARTY_CODE,'',@SAUDA_DATE,@PRODUCT_CODE,@SERIES_CODE,@EXPIRYDATE,0,
			@PRODUCT_TYPE,@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACTNO,'',0,
			@BROK,@TRADE_PRICE,0,@NETRATE,0,0,0,0,'','',@STATUSID,@STRMODULE,'RECAL BROK'
	  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSETTBROKRECAL
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[BFOSETTBROKRECAL]
@SAUDA_DATE VARCHAR(11),
@PARTY_CODE VARCHAR(10),
@FLAG INT 
AS
IF @FLAG = 1
BEGIN
	SELECT 
	S.TRADE_NO,S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.EXPIRYDATE,S.SERIES_CODE,S.SERIES_ID ,
	 BROK=S.BROKAPPLIED,NEWBORK=CONVERT(NUMERIC(9,4), C.BROKAPPLIED),S.TRADEQTY,S.MARKETRATE,S.SELL_BUY,S.BILLNO 
	FROM BFOSETTLEMENT S, VBFOSETTBROKRECAL C
	WHERE S.EXPIRYDATE = C.EXPIRYDATE		
	AND S.PRODUCT_TYPE = C.PRODUCT_TYPE
	AND S.PRODUCT_CODE = C.PRODUCT_CODE
	AND S.SERIES_CODE = C.SERIES_CODE
	AND S.SERIES_ID = C.SERIES_ID
	AND S.PARTY_CODE = C.PARTY_CODE
	AND S.TRADE_NO = C.TRADE_NO
	AND S.TRADEQTY = C.TRADEQTY
	AND S.SELL_BUY = C.SELL_BUY 
	AND S.SAUDA_DATE = C.SAUDA_DATE
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @SAUDA_DATE
	/*AND STATUS <>  'E'*/
END 
IF @FLAG = 2
BEGIN
	SELECT 
	S.TRADE_NO,S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.EXPIRYDATE,S.SERIES_CODE,S.SERIES_ID ,
	 BROK=S.BROKAPPLIED,NEWBORK=CONVERT(NUMERIC(9,4), C.BROKAPPLIED),S.TRADEQTY,S.MARKETRATE,S.SELL_BUY,S.BILLNO 
	FROM BFOSETTLEMENT S, VBFOSETTBROKRECAL C
	WHERE S.EXPIRYDATE = C.EXPIRYDATE		
	AND S.PRODUCT_TYPE = C.PRODUCT_TYPE
	AND S.PRODUCT_CODE = C.PRODUCT_CODE
	AND S.SERIES_CODE = C.SERIES_CODE
	AND S.SERIES_ID = C.SERIES_ID
	AND S.PARTY_CODE = C.PARTY_CODE
	AND S.TRADE_NO = C.TRADE_NO
	AND S.TRADEQTY = C.TRADEQTY
	AND S.SELL_BUY = C.SELL_BUY 
	AND S.SAUDA_DATE = C.SAUDA_DATE
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @SAUDA_DATE
	AND S.PARTY_CODE = @PARTY_CODE
	/*AND STATUS <>  'E'*/
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSETTBROKRECALUP
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.BFOSETTBROKRECALUP    SCRIPT DATE: 01/10/2003 7:32:58 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BFOSETTBROKRECALUP    SCRIPT DATE: 09/25/2001 6:15:59 AM ******/
CREATE PROCEDURE [DBO].[BFOSETTBROKRECALUP]
@SAUDA_DATE VARCHAR(11),
@PARTY_CODE VARCHAR(10),
@FLAG INT
AS
IF @FLAG = 1 
BEGIN 
       UPDATE BFOSETTLEMENT SET 
       TABLE_NO = BROKTABLE.TABLE_NO,LINE_NO = BROKTABLE.LINE_NO,
       VAL_PERC = BROKTABLE.VAL_PERC,NORMAL = BROKTABLE.NORMAL,DAY_PUC = BROKTABLE.DAY_PUC,DAY_SALES = BROKTABLE.DAY_SALES,
       SETT_PURCH = BROKTABLE.SETT_PURCH, SETT_SALES = BROKTABLE.SETT_SALES,  
 BROKAPPLIED = (  CASE  
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                              THEN 
		((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                              THEN 
		((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                               THEN  
                                          ((FLOOR ( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                             THEN 
		((FLOOR(( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                            THEN 
		((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                             THEN 
		((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.DAY_SALES*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                  WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                             THEN /*ROUND((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE ,BROKTABLE.ROUND_TO) */
		((FLOOR(( ((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.SETT_PURCH*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
		((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
             WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.SETT_SALES*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
		((FLOOR(( ((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
   		ELSE  0 
                        END 
                         ),
     
NETRATE = (  CASE  
                  WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                       THEN 
                  (BFOSETTLEMENT.MARKETRATE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                           WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                                                       THEN 
                                                                  (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO))
                                           WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                                                        THEN 
                                                             (BFOSETTLEMENT.MARKETRATE)+ ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                                                       THEN 
                                                                   (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                                                    THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                                                    THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                                                     THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                                                    THEN 
                                                        (BFOSETTLEMENT.MARKETRATE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                                                     THEN 
                                                                (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                                                      THEN 
                                                           (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                        WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="V" )
                                                      THEN 
                                                                   (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="P" )
                                                     THEN 
                                                                (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO))
   ELSE  0 
                        END 
                         ),
   AMOUNT = 
            (  CASE  
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                         THEN 
                   BFOSETTLEMENT.TRADEQTY  *  ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO)))
                 
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY  * ((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE)+ ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                                       
                   WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * (  (BFOSETTLEMENT.MARKETRATE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))) 
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
 
                   WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="V" )
                         THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)) )
  
                   WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="P" )
                         THEN 
                   BFOSETTLEMENT.TRADEQTY  * (  (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO)))
   ELSE  0 
                        END 
                         ),
        INS_CHRG  = ((FLOOR(( ((BFOTAXES.INSURANCE_CHRG * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO)),
        TURN_TAX  =  ((FLOOR(( ((BFOTAXES.TURNOVER_TAX * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
		POWER(10,BROKTABLE.ROUND_TO)),
        OTHER_CHRG = ((FLOOR(( ((BFOTAXES.OTHER_CHRG * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / 	POWER(10,BROKTABLE.ROUND_TO)),
        SEBI_TAX =     ((FLOOR(( ((BFOTAXES.SEBITURN_TAX * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /	POWER(10,BROKTABLE.ROUND_TO)),
        BROKER_CHRG =  ((FLOOR(( ((BFOTAXES.BROKER_NOTE * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO)),
        SERVICE_TAX =  (CASE  
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V")
                             THEN 
                                 ((FLOOR(( 
                                        (((((FLOOR((( BROKTABLE.NORMAL*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                      POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                      (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P")
                             THEN 
                                      ((FLOOR(( 
                                                   (((((FLOOR((   ((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                          POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                          (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))
                        WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR(( (BROKTABLE.DAY_PUC*F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.DAY_PUC*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.DAY_SALES*F.MULTIPLIER ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.DAY_SALES*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.SETT_PURCH*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
 
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="V" )
                             THEN   
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="P" )
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
   ELSE  0 
                        END 
                         ),
      TRADE_AMOUNT = BFOSETTLEMENT.TRADEQTY * BFOSETTLEMENT.MARKETRATE
      FROM BROKTABLE,BFOSETTLEMENT,BFOTAXES,BFOSCRIP2,CLIENT1,CLIENT2,BFOGLOBALS,BFOSETTSALEPUR1 S,BFOSETTVIEW F
      WHERE BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND 
	   CLIENT1.CL_CODE=CLIENT2.CL_CODE AND           
           BFOSETTLEMENT.PRODUCT_TYPE = BFOSCRIP2.PRODUCT_TYPE AND
           BFOSETTLEMENT.PRODUCT_CODE = BFOSCRIP2.PRODUCT_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=BFOSCRIP2.EXPIRYDATE AND
           BFOSETTLEMENT.SERIES_CODE = BFOSCRIP2.SERIES_CODE AND
	   BFOSETTLEMENT.SERIES_ID = BFOSCRIP2.SERIES_ID AND
           BFOSETTLEMENT.PARTY_CODE = S.PARTY_CODE AND
           BFOSETTLEMENT.PRODUCT_TYPE=S.PRODUCT_TYPE AND  
           BFOSETTLEMENT.PRODUCT_CODE=S.PRODUCT_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=S.EXPIRYDATE  AND
           BFOSETTLEMENT.SERIES_CODE = S.SERIES_CODE AND                  
	   BFOSETTLEMENT.SERIES_ID = S.SERIES_ID AND             
	   BFOSETTLEMENT.SAUDA_DATE LIKE S.SDATE + '%' AND
           BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND
           BFOSETTLEMENT.PRODUCT_TYPE=F.PRODUCT_TYPE AND  
           BFOSETTLEMENT.PRODUCT_CODE=F.PRODUCT_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND
           BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE AND                  
           BFOSETTLEMENT.SERIES_ID = F.SERIES_ID AND                
	   BFOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND
	   BFOSETTLEMENT.TRADE_NO = F.TRADE_NO AND 
	   BFOSETTLEMENT.ORDER_NO = F.ORDER_NO AND
	   BFOSETTLEMENT.SELL_BUY = F.SELL_BUY AND 	
 BFOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND
           BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            THEN CLIENT2.STD_RATE
			             ELSE CLIENT2.BROK2_TABLENO
		 	 END) 
AND   
           BROKTABLE.LINE_NO =  ( CASE WHEN (CLIENT2.BROK_SCHEME = 1 OR CLIENT2.BROK_SCHEME = 5) THEN					
			         (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                               		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                            						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY >= S.SQTY 
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 ELSE
										      ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )					
									    END )
                                                	    AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE   	
                                               		    AND F.MPRICE <= BROKTABLE.UPPER_LIM)							    
			   	        WHEN (CLIENT2.BROK_SCHEME = 3 OR CLIENT2.BROK_SCHEME = 6) THEN					
					       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                               		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                    						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY > S.SQTY 
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 ELSE
										      ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )					
									    END )
                                        	            AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE   	
                                               		    AND F.MPRICE <= BROKTABLE.UPPER_LIM)		
				    ELSE 
                                       (  SELECT MIN(LINE_NO) FROM BROKTABLE 
                                          WHERE F.MPRICE <= BROKTABLE.UPPER_LIM 
			                  AND BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END))
				   END )
             AND                (CLIENT2.TRAN_CAT = BFOTAXES.TRANS_CAT)
           AND
             (BFOTAXES.EXCHANGE = 'BSE') 
	AND LEFT(CONVERT(VARCHAR,BFOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE
	AND STATUS <>  'E'
END
IF @FLAG = 2 
BEGIN
	 UPDATE BFOSETTLEMENT SET 
       TABLE_NO = BROKTABLE.TABLE_NO,LINE_NO = BROKTABLE.LINE_NO,
       VAL_PERC = BROKTABLE.VAL_PERC,NORMAL = BROKTABLE.NORMAL,DAY_PUC = BROKTABLE.DAY_PUC,DAY_SALES = BROKTABLE.DAY_SALES,
       SETT_PURCH = BROKTABLE.SETT_PURCH, SETT_SALES = BROKTABLE.SETT_SALES,
  
 BROKAPPLIED = (  CASE  
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                              THEN 
		((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                              THEN 
		((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                               THEN  
                                          ((FLOOR ( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                             THEN 
		((FLOOR(( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                            THEN 
		((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                             THEN 
		((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.DAY_SALES*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                  WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                             THEN /*ROUND((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE ,BROKTABLE.ROUND_TO) */
		((FLOOR(( ((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.SETT_PURCH*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
		((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
             WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.SETT_SALES*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
		((FLOOR(( ((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
   		ELSE  0 
                        END 
                         ),
     
NETRATE = (  CASE  
                  WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                       THEN 
                  (BFOSETTLEMENT.MARKETRATE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                           WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                                                       THEN 
                                                                  (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO))
                                           WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                                                        THEN 
                                                             (BFOSETTLEMENT.MARKETRATE)+ ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                                                       THEN 
                                                                   (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                                                    THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                                                    THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                                                     THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                                                    THEN 
                                                        (BFOSETTLEMENT.MARKETRATE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                                                     THEN 
                                                                (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                                                      THEN 
                                                           (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                        WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="V" )
                                                      THEN 
                                                                   (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="P" )
                                                     THEN 
                                                                (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO))
   ELSE  0 
                        END 
                         ),
   AMOUNT = 
            (  CASE  
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                         THEN 
                   BFOSETTLEMENT.TRADEQTY  *  ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO)))
                 
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY  * ((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE)+ ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                                       
                   WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * (  (BFOSETTLEMENT.MARKETRATE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))) 
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
 
                   WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="V" )
                         THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)) )
  
                   WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="P" )
                         THEN 
                   BFOSETTLEMENT.TRADEQTY  * (  (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO)))
   ELSE  0 
                        END 
                         ),
        INS_CHRG  = ((FLOOR(( ((BFOTAXES.INSURANCE_CHRG * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO)),
        TURN_TAX  =  ((FLOOR(( ((BFOTAXES.TURNOVER_TAX * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
		POWER(10,BROKTABLE.ROUND_TO)),
        OTHER_CHRG = ((FLOOR(( ((BFOTAXES.OTHER_CHRG * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / 	POWER(10,BROKTABLE.ROUND_TO)),
        SEBI_TAX =     ((FLOOR(( ((BFOTAXES.SEBITURN_TAX *(F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /	POWER(10,BROKTABLE.ROUND_TO)),
        BROKER_CHRG =  ((FLOOR(( ((BFOTAXES.BROKER_NOTE * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO)),
        SERVICE_TAX =  (CASE  
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V")
                             THEN 
                                 ((FLOOR(( 
                                        (((((FLOOR((( BROKTABLE.NORMAL*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                      POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                      (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P")
                             THEN 
                                      ((FLOOR(( 
                                                   (((((FLOOR((   ((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                          POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                          (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))
                        WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR(( (BROKTABLE.DAY_PUC*F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.DAY_PUC*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.DAY_SALES*F.MULTIPLIER ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.DAY_SALES*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.SETT_PURCH*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))     
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="V" )
                             THEN   
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="P" )
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
   ELSE  0 
                        END 
                         ),
      TRADE_AMOUNT = BFOSETTLEMENT.TRADEQTY * BFOSETTLEMENT.MARKETRATE
      FROM BROKTABLE,BFOSETTLEMENT,BFOTAXES,BFOSCRIP2,CLIENT1,CLIENT2,BFOGLOBALS,BFOSETTSALEPUR1 S,BFOSETTVIEW F
      WHERE BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND 
	    CLIENT1.CL_CODE=CLIENT2.CL_CODE AND           
           BFOSETTLEMENT.PRODUCT_TYPE = BFOSCRIP2.PRODUCT_TYPE AND
           BFOSETTLEMENT.PRODUCT_CODE = BFOSCRIP2.PRODUCT_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=BFOSCRIP2.EXPIRYDATE AND
           BFOSETTLEMENT.SERIES_CODE = BFOSCRIP2.SERIES_CODE AND
	   BFOSETTLEMENT.SERIES_ID = BFOSCRIP2.SERIES_ID AND
           BFOSETTLEMENT.PARTY_CODE = S.PARTY_CODE AND
           BFOSETTLEMENT.PRODUCT_TYPE=S.PRODUCT_TYPE AND  
           BFOSETTLEMENT.PRODUCT_CODE=S.PRODUCT_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=S.EXPIRYDATE  AND
           BFOSETTLEMENT.SERIES_CODE = S.SERIES_CODE AND                  
	   BFOSETTLEMENT.SERIES_ID = S.SERIES_ID AND             
	   BFOSETTLEMENT.SAUDA_DATE LIKE S.SDATE + '%' AND
           BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND
           BFOSETTLEMENT.PRODUCT_TYPE=F.PRODUCT_TYPE AND  
           BFOSETTLEMENT.PRODUCT_CODE=F.PRODUCT_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND
           BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE AND                  
           BFOSETTLEMENT.SERIES_ID = F.SERIES_ID AND                
	   BFOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND
	   BFOSETTLEMENT.TRADE_NO = F.TRADE_NO AND 
	   BFOSETTLEMENT.ORDER_NO = F.ORDER_NO AND
	   BFOSETTLEMENT.SELL_BUY = F.SELL_BUY AND 	
 BFOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND
           BFOSETTLEMENT.SERIES_CODE = S.SERIES_CODE    AND                         /*   ADDED BY BBG  ON 4 JUL 2001   WE NEED THIS TO SET UP RELATIONSHIP  */ 
	   BFOSETTLEMENT.SERIES_ID = S.SERIES_ID AND                 /*   ADDED BY BBG  ON 4 JUL 2001   WE NEED THIS TO SET UP RELATIONSHIP  */ 
           BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            THEN CLIENT2.STD_RATE
			             ELSE CLIENT2.BROK2_TABLENO
		                    END) AND   
           BROKTABLE.LINE_NO =  ( CASE WHEN (CLIENT2.BROK_SCHEME = 1 OR CLIENT2.BROK_SCHEME = 5) THEN					
					       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE                                                		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                            						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY >= S.SQTY 
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 ELSE
										      ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )					
									    END )
                                                	    AND BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE   	
                                               		    AND F.MPRICE <= BROKTABLE.UPPER_LIM)							    
			   	        WHEN (CLIENT2.BROK_SCHEME = 3 OR CLIENT2.BROK_SCHEME = 6) THEN					
					       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                               		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                    						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY > S.SQTY 
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 ELSE
										      ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )					
									    END )
                                        	            AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE   	
							AND F.MPRICE <= BROKTABLE.UPPER_LIM)	
				    ELSE 
                                       (  SELECT MIN(LINE_NO) FROM BROKTABLE 
                                          WHERE F.MPRICE <= BROKTABLE.UPPER_LIM 
			                  AND BROKTABLE.TABLE_NO =(CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END))
				   END )
             AND                (CLIENT2.TRAN_CAT = BFOTAXES.TRANS_CAT)
           AND
             (BFOTAXES.EXCHANGE = 'BSE') 
	AND LEFT(CONVERT(VARCHAR,BFOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE
	AND BFOSETTLEMENT.PARTY_CODE = @PARTY_CODE
	AND STATUS <>  'E'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSETTBROKUPDATE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.BFOSETTBROKUPDATE    SCRIPT DATE: 01/10/2003 7:32:58 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BFOSETTBROKUPDATE    SCRIPT DATE: 09/25/2001 6:15:59 AM ******/
CREATE PROCEDURE [DBO].[BFOSETTBROKUPDATE]
@SAUDA_DATE VARCHAR(11),
@PARTY_CODE VARCHAR(10),
@PRODUCT_CODE VARCHAR(10),
@PRODUCT_TYPE VARCHAR(5),
@SERIES_CODE VARCHAR(13),
@EXPIRYDATE VARCHAR(11),
@SERIES_ID INT
AS 
       UPDATE BFOSETTLEMENT SET 
       TABLE_NO = BROKTABLE.TABLE_NO,LINE_NO = BROKTABLE.LINE_NO,
       VAL_PERC = BROKTABLE.VAL_PERC,NORMAL = BROKTABLE.NORMAL,DAY_PUC = BROKTABLE.DAY_PUC,DAY_SALES = BROKTABLE.DAY_SALES,
       SETT_PURCH = BROKTABLE.SETT_PURCH, SETT_SALES = BROKTABLE.SETT_SALES,
       BROKAPPLIED = (  CASE  
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                              THEN 
		((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                              THEN 
		((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                               THEN   
                                          ((FLOOR ( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                             THEN 
		((FLOOR(( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                            THEN 
		((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                             THEN 
		((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.DAY_SALES*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                  WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                             THEN /*ROUND((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE ,BROKTABLE.ROUND_TO) */
		((FLOOR(( ((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.SETT_PURCH*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
		((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
             WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
		((FLOOR(( BROKTABLE.SETT_SALES*F.MULTIPLIER * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
		((FLOOR(( ((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
		POWER(10,BROKTABLE.ROUND_TO))
   		ELSE  0 
                        END 
                         ),
     
NETRATE = (  CASE  
                  WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                       THEN 
                  (BFOSETTLEMENT.MARKETRATE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                           WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                                                       THEN 
                                                                  (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO))
                                           WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                                                        THEN 
                                                             (BFOSETTLEMENT.MARKETRATE)+ ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                                                       THEN 
                                                                   (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                                                    THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                                                    THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                          WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                                                     THEN 
                                                         (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                                                    THEN 
                                                        (BFOSETTLEMENT.MARKETRATE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                                                     THEN 
                                                                (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                                                      THEN 
                                                           (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                        WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="V" )
                                                      THEN 
                                                                   (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                                         WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="P" )
                                                     THEN 
                                                                (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO))
   ELSE  0 
                        END 
                         ),
   AMOUNT = 
            (  CASE  
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 1)
                         THEN 
                   BFOSETTLEMENT.TRADEQTY  *  ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V" AND BFOSETTLEMENT.SELL_BUY = 2)
                        THEN                     BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO)))
                 
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 1)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY  * ((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P" AND BFOSETTLEMENT.SELL_BUY = 2)
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ((BFOSETTLEMENT.MARKETRATE)+ ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                                       
                   WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * (  (BFOSETTLEMENT.MARKETRATE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))) 
                   WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                        THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
 
                   WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="V" )
                         THEN 
                   BFOSETTLEMENT.TRADEQTY * ( (BFOSETTLEMENT.MARKETRATE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  	(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)) )
  
                   WHEN ( BFOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ="P" )
                         THEN 
                   BFOSETTLEMENT.TRADEQTY  * (  (BFOSETTLEMENT.MARKETRATE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 	POWER(10,BROKTABLE.ROUND_TO)))
   ELSE  0 
                        END 
                         ),
        INS_CHRG  = ((FLOOR(( ((BFOTAXES.INSURANCE_CHRG * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO)),
        TURN_TAX  =  ((FLOOR(( ((BFOTAXES.TURNOVER_TAX * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
		(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
		POWER(10,BROKTABLE.ROUND_TO)),
        OTHER_CHRG = ((FLOOR(( ((BFOTAXES.OTHER_CHRG * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / 	POWER(10,BROKTABLE.ROUND_TO)),
        SEBI_TAX =     ((FLOOR(( ((BFOTAXES.SEBITURN_TAX *(F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /	POWER(10,BROKTABLE.ROUND_TO)),
        BROKER_CHRG =  ((FLOOR(( ((BFOTAXES.BROKER_NOTE * (F.TAXPRICE) * BFOSETTLEMENT.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO)),
        SERVICE_TAX =  (CASE  
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="V")
                             THEN 
                                 ((FLOOR(( 
                                        (((((FLOOR((( BROKTABLE.NORMAL*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                      POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                      (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ="P")
                             THEN 
                                      ((FLOOR(( 
                                                   (((((FLOOR((   ((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                          POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                          (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))
                        WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="V" ) 
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR(( (BROKTABLE.DAY_PUC*F.MULTIPLIER) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ="P" ) 
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.DAY_PUC*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="V" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.DAY_SALES*F.MULTIPLIER ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN (BFOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.DAY_SALES*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="V" )
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.SETT_PURCH*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /                                                             POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ="P" )
                             THEN 
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="V" )
                             THEN   
                                       ((FLOOR(( 
                                                    (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
                        WHEN ( BFOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ="P" )
                             THEN  
                                       ((FLOOR(( 
                                                    (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
                                                            POWER(10,BROKTABLE.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
                                                             (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
   ELSE  0 
                        END 
                         ),
      TRADE_AMOUNT = BFOSETTLEMENT.TRADEQTY * BFOSETTLEMENT.MARKETRATE
      FROM BROKTABLE,BFOSETTLEMENT,BFOTAXES,BFOSCRIP2,CLIENT1,CLIENT2,BFOGLOBALS,BFOSETTSALEPUR1 S,BFOSETTVIEW F
      WHERE BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE
	   AND CLIENT1.CL_CODE=CLIENT2.CL_CODE            
           AND BFOSETTLEMENT.PRODUCT_TYPE = BFOSCRIP2.PRODUCT_TYPE 
           AND BFOSETTLEMENT.SERIES_CODE = BFOSCRIP2.SERIES_CODE      
           AND BFOSETTLEMENT.EXPIRYDATE=BFOSCRIP2.EXPIRYDATE AND
           BFOSETTLEMENT.PRODUCT_CODE = BFOSCRIP2.PRODUCT_CODE AND
           BFOSETTLEMENT.PARTY_CODE = S.PARTY_CODE AND
           BFOSETTLEMENT.PRODUCT_TYPE=S.PRODUCT_TYPE AND  
           BFOSETTLEMENT.SERIES_CODE=S.SERIES_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=S.EXPIRYDATE  AND
           BFOSETTLEMENT.SERIES_ID = S.SERIES_ID AND                
           BFOSETTLEMENT.PRODUCT_CODE = S.PRODUCT_CODE AND                  
           BFOSETTLEMENT.SAUDA_DATE LIKE S.SDATE + '%' AND
           BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND
           BFOSETTLEMENT.PRODUCT_TYPE=F.PRODUCT_TYPE AND  
           BFOSETTLEMENT.SERIES_CODE=F.SERIES_CODE AND
           BFOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND
           BFOSETTLEMENT.SERIES_ID = F.SERIES_ID AND                
           BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE AND                  
	   BFOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND
	   BFOSETTLEMENT.TRADE_NO = F.TRADE_NO AND 
	   BFOSETTLEMENT.ORDER_NO = F.ORDER_NO AND
	   BFOSETTLEMENT.SELL_BUY = F.SELL_BUY AND 	
     BFOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND
           BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			           THEN CLIENT2.STD_RATE
			            ELSE CLIENT2.BROK2_TABLENO
			 END) AND   
           BROKTABLE.LINE_NO =  ( CASE WHEN CLIENT2.BROK_SCHEME = 1 THEN					
					       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                               		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                            						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY >= S.SQTY 
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 ELSE
										      ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )					
									    END )
                                                	    AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE   	
                                               		    AND F.MPRICE <= BROKTABLE.UPPER_LIM)							    
			   	        WHEN CLIENT2.BROK_SCHEME = 3 THEN					
					       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                               		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                    						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY > S.SQTY 
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 ELSE
										      ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )					
									    END )
                                        	            AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE   	
                                               		    AND F.MPRICE <= BROKTABLE.UPPER_LIM)	
 /*BROKSCHEME IS FLAT BROKERAGE SCHEME ON THE PRODUCT TYPE*/
					WHEN CLIENT2.BROK_SCHEME = 4 THEN					
					       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                               		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                            						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY <= S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='OPT'
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 WHEN S.PQTY > S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='OPT'
										  THEN    ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										            END )	
										WHEN S.PQTY >= S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='FUT'
										 THEN     ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										           END )
										WHEN S.PQTY < S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='FUT'
										THEN     ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										           END )									         				
										
								                END)					
                                                                               
                                                	    AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE   	
                                               		    AND F.MPRICE <= BROKTABLE.UPPER_LIM)	
/*BROKSCHEME IS FLAT BROKERAGE SCHEME ON THE PRODUCT TYPE*/
					WHEN CLIENT2.BROK_SCHEME =5 THEN					
					       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                               		    BROKTABLE.TABLE_NO = (CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END)                                            						
				                	    AND TRD_DEL = ( CASE WHEN S.PQTY <= S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='OPT'
										 THEN ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										       END )
									     	 WHEN S.PQTY > S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='OPT'
										  THEN    ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										            END )	
										WHEN S.PQTY >= S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='FUT'
										 THEN     ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 1 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										           END )
										WHEN S.PQTY < S.SQTY AND UPPER(LEFT(S.PRODUCT_TYPE,3))='FUT'
										THEN     ( CASE WHEN ( BFOSETTLEMENT.SELL_BUY = 2 ) 
							    			 	    THEN 'F'  
							    			 	    ELSE 'S'
										           END )									         				
										
								                END)					
                                                                               
                                                	              AND BFOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE   	
                                               		    AND F.MPRICE <= BROKTABLE.UPPER_LIM)	
				    ELSE 
                                       (  SELECT MIN(LINE_NO) FROM BROKTABLE 
                                          WHERE F.MPRICE <= BROKTABLE.UPPER_LIM 
			                  AND BROKTABLE.TABLE_NO =(CASE WHEN LEFT(F.PRODUCT_TYPE,3) = 'FUT'  
			            					         THEN CLIENT2.STD_RATE
			              					         ELSE CLIENT2.BROK2_TABLENO
							                END))
				   END )
             AND                (CLIENT2.TRAN_CAT = BFOTAXES.TRANS_CAT)
           AND
             (BFOTAXES.EXCHANGE = 'BSE') 
	AND LEFT(CONVERT(VARCHAR,BFOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE
	AND BFOSETTLEMENT.PARTY_CODE = @PARTY_CODE
	AND BFOSETTLEMENT.PRODUCT_CODE = @PRODUCT_CODE
	AND BFOSETTLEMENT.PRODUCT_TYPE = @PRODUCT_TYPE
	AND BFOSETTLEMENT.SERIES_CODE = @SERIES_CODE
	AND LEFT(CONVERT(VARCHAR,BFOSETTLEMENT.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND BFOSETTLEMENT.SERIES_ID = @SERIES_ID
/*	AND BFOSETTLEMENT.STATUS <>  'E'*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOTRADE_UPD
-- --------------------------------------------------
CREATE PROC [dbo].[BFOTRADE_UPD] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT ,
	@INTFILETYPE INT
) AS 

IF @INTMODE=1
BEGIN
	TRUNCATE TABLE BFOFTTRADE    
	TRUNCATE TABLE BFOTRADE 
	TRUNCATE TABLE FOTRADE_STANDARD_IMP

	IF @INTFILETYPE  = 1 /*New Format - EOD File (coma Delimited)*/
	BEGIN
		INSERT INTO FOTRADE_STANDARD_IMP
		SELECT
				 DBO.PIECE(FILE_DATA,',',1),
				 DBO.PIECE(FILE_DATA,',',2),
				 DBO.PIECE(FILE_DATA,',',3),
				 DBO.PIECE(FILE_DATA,',',4),
				 DBO.PIECE(FILE_DATA,',',5),
				 DBO.PIECE(FILE_DATA,',',6),
				 DBO.PIECE(FILE_DATA,',',7),
				 DBO.PIECE(FILE_DATA,',',8),
				 DBO.PIECE(FILE_DATA,',',9),
				 DBO.PIECE(FILE_DATA,',',10),
				 DBO.PIECE(FILE_DATA,',',11),
				 DBO.PIECE(FILE_DATA,',',12),
				 DBO.PIECE(FILE_DATA,',',13),
				 DBO.PIECE(FILE_DATA,',',14),
				 DBO.PIECE(FILE_DATA,',',15),
				 DBO.PIECE(FILE_DATA,',',16),
				 DBO.PIECE(FILE_DATA,',',17),
				 DBO.PIECE(FILE_DATA,',',18),
				 DBO.PIECE(FILE_DATA,',',19),
				 DBO.PIECE(FILE_DATA,',',20),
				 DBO.PIECE(FILE_DATA,',',21),
				 DBO.PIECE(FILE_DATA,',',22),
				 DBO.PIECE(FILE_DATA,',',23),
				 DBO.PIECE(FILE_DATA,',',24),
				 DBO.PIECE(FILE_DATA,',',25),
				 DBO.PIECE(FILE_DATA,',',26),
				 DBO.PIECE(FILE_DATA,',',27),
				 DBO.PIECE(FILE_DATA,',',28),
				 DBO.PIECE(FILE_DATA,',',29),
				 DBO.PIECE(FILE_DATA,',',30),
				 DBO.PIECE(FILE_DATA,',',31),
				 DBO.PIECE(FILE_DATA,',',32),
				 DBO.PIECE(FILE_DATA,',',33),
				 DBO.PIECE(FILE_DATA,',',34),
				 DBO.PIECE(FILE_DATA,',',35),
				 DBO.PIECE(FILE_DATA,',',36),
				 DBO.PIECE(FILE_DATA,',',37),
				 DBO.PIECE(FILE_DATA,',',38),
				 DBO.PIECE(FILE_DATA,',',39),
				 DBO.PIECE(FILE_DATA,',',40),
				 DBO.PIECE(FILE_DATA,',',41),
				 DBO.PIECE(FILE_DATA,',',42),
				 DBO.PIECE(FILE_DATA,',',43),
				 DBO.PIECE(FILE_DATA,',',44),
				 DBO.PIECE(FILE_DATA,',',45),
				 DBO.PIECE(FILE_DATA,',',46) 
		FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= @SESSIONID
		AND  DBO.PIECE(FILE_DATA,',',1) <> '' AND  DBO.PIECE(FILE_DATA,',',1) NOT LIKE 'TradDt%'

		EXEC INS_FOFTTRADE 1 
		return
	END
	
	IF @INTFILETYPE = 3 OR @INTFILETYPE = 4
	/*
		3 - Old Format - EOD File (| Delimited Member's Trade)
		4 - Old Format - EOD File (| Delimited TM's Trade)
	*/
	BEGIN
		IF @INTFILETYPE = 3
		BEGIN
			SELECT

				PRODUCTCODE = DBO.PIECE(FILE_DATA,'|',3),
				PRODUCTTYPE = DBO.PIECE(FILE_DATA,'|',4),
				SERIESID = DBO.PIECE(FILE_DATA,'|',5),
				SERIESCODE = DBO.PIECE(FILE_DATA,'|',6),
				SELLBUY = DBO.PIECE(FILE_DATA,'|',7),
				TRADEQTY = DBO.PIECE(FILE_DATA,'|',8),
				MARKETRATE = DBO.PIECE(FILE_DATA,'|',9),
				CLCODE = DBO.PIECE(FILE_DATA,'|',10),
				TRADENO = DBO.PIECE(FILE_DATA,'|',12),
				SAUDADATE = DBO.PIECE(FILE_DATA,'|',13),
				SAUDATIME = DBO.PIECE(FILE_DATA,'|',14),
				ORDERNO = DBO.PIECE(FILE_DATA,'|',17)

			INTO #BFOFTTRADE_IMP_0

			FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= @SESSIONID

			INSERT INTO BFOFTTRADE_IMP
			SELECT
				TRADE_NO = TRADENO,
				SAUDA_DATE = SAUDADATE,
				TRADESTATUS = '11',
				SEGMENT = 'F',
				SETT_TYPE = 'F',
				PRODUCT_TYPE = PRODUCTTYPE,
				PRODUCT_CODE = PRODUCTCODE,
				ASSET_CODE = '',
				EXPIRYDATE = '',
				STRIKE_PRICE = 0,
				OPTION_TYPE = '',
				CA_LEVEL = 0,
				BUY_BROKER = '',
				SELL_BROKER = '',
				TRADE_PRICE = MARKETRATE,
				TRADEQTY = TRADEQTY,
				SERIES_ID = SERIESID,
				BUYER_LOCATIONID = '',
				BUY_CM_CODE = '',
				SELL_CM_CODE = '',
				SELLER_LOCATIONID = '',  
				BUY_PARTICIPANT =  '',
				BUY_CONFIRMATION =  '',
				SELL_PARTICIPANT =  '',
				SELL_CONFIRMATION =  '',
				BUY_OC_FLAG =  '',
				SELL_OC_FLAG =  '',
				BUY_OLD_PARTICIPANT = ''  ,
				BUY_OLD_CM_CODE =  '',
				SELL_OLD_PARTICIPANT =  '',
				SELL_OLD_CM_CODE =  '',
				BUY_TERMINALID =  '',
				SELL_TERMINALID =  '',
				BUY_ORDER_NO =  CASE WHEN SELLBUY ='B' THEN ORDERNO ELSE '' END,
				SELL_ORDER_NO =  CASE WHEN SELLBUY ='S' THEN ORDERNO ELSE '' END ,
				BUY_CLIENT_CODE =   CASE WHEN SELLBUY ='B' THEN CLCODE ELSE '' END,
				SELL_CLIENT_CODE =   CASE WHEN SELLBUY ='S' THEN CLCODE ELSE '' END,
				BUY_REMARKS =  '',
				SELL_REMARKS =  '',
				BUY_POSITION =  0,
				SELL_POSITION =  0,
				BUY_PRO_CLI =  'C',
				SELL_PRO_CLI = 'C',
				BUY_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='B' THEN SAUDATIME ELSE '' END ,
				SELL_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='S' THEN SAUDATIME ELSE '' END ,
				BUY_ORDER_ACTIVEFLAG = '',
				SELL_ORDER_ACTIVEFLAG  = ''
			FROM #BFOFTTRADE_IMP_0

			DROP TABLE #BFOFTTRADE_IMP_0
			
			UPDATE BFOFTTRADE_IMP SET SAUDA_DATE = LEFT(CONVERT(DATETIME,SAUDA_DATE,103),11)

		END
		ELSE
		BEGIN
			SELECT

				TM_CODE = DBO.PIECE(FILE_DATA,'|',3),
				PRODUCTCODE = DBO.PIECE(FILE_DATA,'|',4),
				PRODUCTTYPE = DBO.PIECE(FILE_DATA,'|',5),
				SERIESID = DBO.PIECE(FILE_DATA,'|',6),
				SERIESCODE = DBO.PIECE(FILE_DATA,'|',7),
				SELLBUY = DBO.PIECE(FILE_DATA,'|',8),
				TRADEQTY = DBO.PIECE(FILE_DATA,'|',9),
				MARKETRATE = DBO.PIECE(FILE_DATA,'|',10),
				CLCODE = DBO.PIECE(FILE_DATA,'|',11),
				TRADENO = DBO.PIECE(FILE_DATA,'|',13),
				SAUDADATE = DBO.PIECE(FILE_DATA,'|',14),
				SAUDATIME = DBO.PIECE(FILE_DATA,'|',15),
				ORDERNO = DBO.PIECE(FILE_DATA,'|',18)

			INTO #BFOFTTRADE_IMP_1

			FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= @SESSIONID
			INSERT INTO BFOFTTRADE_IMP
			SELECT
				TRADE_NO = TRADENO,
				SAUDA_DATE = CONVERT(DATETIME,SAUDADATE,103),
				TRADESTATUS = '11',
				SEGMENT = 'F',
				SETT_TYPE = 'F',
				PRODUCT_TYPE = PRODUCTTYPE,
				PRODUCT_CODE = PRODUCTCODE,
				ASSET_CODE = '',
				EXPIRYDATE = '',
				STRIKE_PRICE = 0,
				OPTION_TYPE = '',
				CA_LEVEL = 0,
				BUY_BROKER = '',
				SELL_BROKER = '',
				TRADE_PRICE = MARKETRATE,
				TRADEQTY = TRADEQTY,
				SERIES_ID = SERIESID,
				BUYER_LOCATIONID = '',
				BUY_CM_CODE = '',
				SELL_CM_CODE = '',
				SELLER_LOCATIONID = '',  
				BUY_PARTICIPANT =  CASE WHEN SELLBUY ='B' THEN TM_CODE ELSE '' END,
				BUY_CONFIRMATION =  '',
				SELL_PARTICIPANT =  CASE WHEN SELLBUY ='S' THEN TM_CODE ELSE '' END,
				SELL_CONFIRMATION = ''  ,
				BUY_OC_FLAG =  '',
				SELL_OC_FLAG =  '',
				BUY_OLD_PARTICIPANT = ''  ,
				BUY_OLD_CM_CODE =  '',
				SELL_OLD_PARTICIPANT =  '',
				SELL_OLD_CM_CODE =  '',
				BUY_TERMINALID =  '',
				SELL_TERMINALID =  '',
				BUY_ORDER_NO =  CASE WHEN SELLBUY ='B' THEN ORDERNO ELSE '' END,
				SELL_ORDER_NO =  CASE WHEN SELLBUY ='S' THEN ORDERNO ELSE '' END ,
				BUY_CLIENT_CODE =   CASE WHEN SELLBUY ='B' THEN CLCODE ELSE '' END,
				SELL_CLIENT_CODE =   CASE WHEN SELLBUY ='S' THEN CLCODE ELSE '' END,
				BUY_REMARKS =  '',
				SELL_REMARKS =  '',
				BUY_POSITION =  0,
				SELL_POSITION =  0,
				BUY_PRO_CLI =  'C',
				SELL_PRO_CLI = 'C',
				BUY_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='B' THEN SAUDATIME ELSE '' END ,
				SELL_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='S' THEN SAUDATIME ELSE '' END ,
				BUY_ORDER_ACTIVEFLAG = '',
				SELL_ORDER_ACTIVEFLAG  = ''
			FROM #BFOFTTRADE_IMP_1

			DROP TABLE #BFOFTTRADE_IMP_1
		END		


		
		UPDATE BFOFTTRADE_IMP 
		SET 
			EXPIRYDATE = F.EXPIRYDATE,
			ASSET_CODE = F.ASSET_CODE,
			STRIKE_PRICE = F.STRIKE_PRICE,
			OPTION_TYPE = F.OPTION_TYPE
		FROM BFOSCRIP2 F (NOLOCK)
		WHERE
			F.PRODUCT_TYPE = BFOFTTRADE_IMP.PRODUCT_TYPE
			AND F.PRODUCT_CODE = BFOFTTRADE_IMP.PRODUCT_CODE
			AND F.SERIES_ID = BFOFTTRADE_IMP.SERIES_ID
	END
	
	IF @INTFILETYPE = 2	 	/*Old Format - Intra Day File (coma Delimited)*/ 
	BEGIN
	
		SELECT 
			USERID = DBO.PIECE(FILE_DATA,',',1),
			BOOKTYPE = DBO.PIECE(FILE_DATA,',',2),
			SCRIP_CD = DBO.PIECE(FILE_DATA,',',3),
			SCRIP_NAME = DBO.PIECE(FILE_DATA,',',4),
			MARKETRATE = DBO.PIECE(FILE_DATA,',',5),
			TRADEQTY = DBO.PIECE(FILE_DATA,',',6),
			INSTRUMENTYPE = DBO.PIECE(FILE_DATA,',',7),
			INSTRUMENT = DBO.PIECE(FILE_DATA,',',8),
			TRD_DATE = DBO.PIECE(FILE_DATA,',',9),
			TRD_TIME = DBO.PIECE(FILE_DATA,',',10),
			PARTY_CODE = DBO.PIECE(FILE_DATA,',',11),
			ORDER_NO = DBO.PIECE(FILE_DATA,',',12),
			MARKETTYPE = DBO.PIECE(FILE_DATA,',',13),
			SELL_BUY = DBO.PIECE(FILE_DATA,',',14),
			TRADE_NO = DBO.PIECE(FILE_DATA,',',15),
			PARTICIPANTCODE = DBO.PIECE(FILE_DATA,',',16),
			ISIN = DBO.PIECE(FILE_DATA,',',17),
			GROUP_CODE = DBO.PIECE(FILE_DATA,',',18),
			SETTNO = DBO.PIECE(FILE_DATA,',',19),
			ORDER_TIME = DBO.PIECE(FILE_DATA,',',20),
			FILLER = DBO.PIECE(FILE_DATA,',',21),
			FILLER1 = DBO.PIECE(FILE_DATA,',',22),
			FILLER2 = DBO.PIECE(FILE_DATA,',',23)
		INTO #BFOFTTRADE_IMP1
		FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= @SESSIONID

		INSERT INTO BFOFTTRADE_IMP
		SELECT
			TRADE_NO = TRADE_NO,
			SAUDA_DATE = LEFT(CONVERT(DATETIME,TRD_DATE),11),
			TRADESTATUS = '11',
			SEGMENT = 'F',
			SETT_TYPE = 'F',
			PRODUCT_TYPE = '',
			PRODUCT_CODE = '',
			ASSET_CODE = '',
			EXPIRYDATE = '',
			STRIKE_PRICE = 0,
			OPTION_TYPE = '',
			CA_LEVEL = 0,
			BUY_BROKER = '',
			SELL_BROKER = '',
			TRADE_PRICE = MARKETRATE,
			TRADEQTY = TRADEQTY,
			SERIES_ID = SCRIP_CD,
			BUYER_LOCATIONID = '',
			BUY_CM_CODE = '',
			SELL_CM_CODE = '',
			SELLER_LOCATIONID = '',  
			BUY_PARTICIPANT =  '',
			BUY_CONFIRMATION =  '',
			SELL_PARTICIPANT =  '',
			SELL_CONFIRMATION =  '',
			BUY_OC_FLAG =  '',
			SELL_OC_FLAG =  '',
			BUY_OLD_PARTICIPANT = ''  ,
			BUY_OLD_CM_CODE =  '',
			SELL_OLD_PARTICIPANT =  '',
			SELL_OLD_CM_CODE =  '',
			BUY_TERMINALID =  '',
			SELL_TERMINALID =  '',
			BUY_ORDER_NO =  CASE WHEN SELL_BUY ='B' THEN ORDER_NO ELSE '' END,
			SELL_ORDER_NO =  CASE WHEN SELL_BUY ='S' THEN ORDER_NO ELSE '' END ,
			BUY_CLIENT_CODE =   CASE WHEN SELL_BUY ='B' THEN PARTY_CODE ELSE '' END,
			SELL_CLIENT_CODE =   CASE WHEN SELL_BUY ='S' THEN PARTY_CODE ELSE '' END,
			BUY_REMARKS =  '',
			SELL_REMARKS =  '',
			BUY_POSITION =  0,
			SELL_POSITION =  0,
			BUY_PRO_CLI =  'C',
			SELL_PRO_CLI = 'C',
			BUY_ORDER_TIMESTAMP =  CASE WHEN SELL_BUY ='B' THEN TRD_TIME ELSE '' END ,
			SELL_ORDER_TIMESTAMP =  CASE WHEN SELL_BUY ='S' THEN TRD_TIME ELSE '' END ,
			BUY_ORDER_ACTIVEFLAG = '',
			SELL_ORDER_ACTIVEFLAG  = ''
		FROM #BFOFTTRADE_IMP1

		DROP TABLE #BFOFTTRADE_IMP1
		
		UPDATE BFOFTTRADE_IMP 
		SET 
			EXPIRYDATE = F.EXPIRYDATE,
			ASSET_CODE = F.ASSET_CODE,
			STRIKE_PRICE = F.STRIKE_PRICE,
			OPTION_TYPE = F.OPTION_TYPE,
			PRODUCT_TYPE = F.PRODUCT_TYPE,
			PRODUCT_CODE = F.PRODUCT_CODE			
		FROM BFOSCRIP2 F (NOLOCK)
		WHERE
			F.SERIES_ID = BFOFTTRADE_IMP.SERIES_ID		

			TRUNCATE TABLE BFOFTTRADE
	
	INSERT INTO BFOFTTRADE
	SELECT * FROM BFOFTTRADE_IMP
END
	
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOTRADE_UPD_BAK_27072023
-- --------------------------------------------------

CREATE PROC BFOTRADE_UPD_BAK_27072023 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT ,
	@INTFILETYPE INT
) AS 

IF @INTMODE=1
BEGIN

	TRUNCATE TABLE BFOFTTRADE_IMP

	IF @INTFILETYPE  = 1 /*New Format - EOD File (coma Delimited)*/
	BEGIN
		INSERT INTO BFOFTTRADE_IMP
		SELECT
			TRADE_NO = DBO.PIECE(FILE_DATA,',',1),
			SAUDA_DATE = DBO.PIECE(FILE_DATA,',',2),
			TRADESTATUS = DBO.PIECE(FILE_DATA,',',3),
			SEGMENT = DBO.PIECE(FILE_DATA,',',4),
			SETT_TYPE = DBO.PIECE(FILE_DATA,',',5),
			PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',6),
			PRODUCT_CODE = DBO.PIECE(FILE_DATA,',',7),
			ASSET_CODE = DBO.PIECE(FILE_DATA,',',8),
			EXPIRYDATE = DBO.PIECE(FILE_DATA,',',9),
			STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',10),
			OPTION_TYPE = DBO.PIECE(FILE_DATA,',',11),
			CA_LEVEL = DBO.PIECE(FILE_DATA,',',12),
			BUY_BROKER = DBO.PIECE(FILE_DATA,',',13),
			SELL_BROKER = DBO.PIECE(FILE_DATA,',',14),
			TRADE_PRICE = DBO.PIECE(FILE_DATA,',',15),
			TRADEQTY = DBO.PIECE(FILE_DATA,',',16),
			SERIES_ID = DBO.PIECE(FILE_DATA,',',17),
			BUYER_LOCATIONID = DBO.PIECE(FILE_DATA,',',18),
			BUY_CM_CODE = DBO.PIECE(FILE_DATA,',',19),
			SELL_CM_CODE = DBO.PIECE(FILE_DATA,',',20),
			SELLER_LOCATIONID = DBO.PIECE(FILE_DATA,',',21),
			BUY_PARTICIPANT = DBO.PIECE(FILE_DATA,',',22),
			BUY_CONFIRMATION = DBO.PIECE(FILE_DATA,',',23),
			SELL_PARTICIPANT = DBO.PIECE(FILE_DATA,',',24),
			SELL_CONFIRMATION = DBO.PIECE(FILE_DATA,',',25),
			BUY_OC_FLAG = DBO.PIECE(FILE_DATA,',',26),
			SELL_OC_FLAG = DBO.PIECE(FILE_DATA,',',27),
			BUY_OLD_PARTICIPANT = DBO.PIECE(FILE_DATA,',',28),
			BUY_OLD_CM_CODE = DBO.PIECE(FILE_DATA,',',29),
			SELL_OLD_PARTICIPANT = DBO.PIECE(FILE_DATA,',',30),
			SELL_OLD_CM_CODE = DBO.PIECE(FILE_DATA,',',31),
			BUY_TERMINALID = DBO.PIECE(FILE_DATA,',',32),
			SELL_TERMINALID = DBO.PIECE(FILE_DATA,',',33),
			BUY_ORDER_NO = DBO.PIECE(FILE_DATA,',',34),
			SELL_ORDER_NO = DBO.PIECE(FILE_DATA,',',35),
			BUY_CLIENT_CODE = DBO.PIECE(FILE_DATA,',',36),
			SELL_CLIENT_CODE = DBO.PIECE(FILE_DATA,',',37),
			BUY_REMARKS = DBO.PIECE(FILE_DATA,',',38),
			SELL_REMARKS = DBO.PIECE(FILE_DATA,',',39),
			BUY_POSITION = DBO.PIECE(FILE_DATA,',',40),
			SELL_POSITION = DBO.PIECE(FILE_DATA,',',41),
			BUY_PRO_CLI = DBO.PIECE(FILE_DATA,',',42),
			SELL_PRO_CLI = DBO.PIECE(FILE_DATA,',',43),
			BUY_ORDER_TIMESTAMP = DBO.PIECE(FILE_DATA,',',44),
			SELL_ORDER_TIMESTAMP = DBO.PIECE(FILE_DATA,',',45),
			BUY_ORDER_ACTIVEFLAG = DBO.PIECE(FILE_DATA,',',46),
			SELL_ORDER_ACTIVEFLAG = DBO.PIECE(FILE_DATA,',',47)
		FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= '304593688'

	END
	
	IF @INTFILETYPE = 3 OR @INTFILETYPE = 4
	/*
		3 - Old Format - EOD File (| Delimited Member's Trade)
		4 - Old Format - EOD File (| Delimited TM's Trade)
	*/
	BEGIN
		IF @INTFILETYPE = 3
		BEGIN
			SELECT

				PRODUCTCODE = DBO.PIECE(FILE_DATA,'|',3),
				PRODUCTTYPE = DBO.PIECE(FILE_DATA,'|',4),
				SERIESID = DBO.PIECE(FILE_DATA,'|',5),
				SERIESCODE = DBO.PIECE(FILE_DATA,'|',6),
				SELLBUY = DBO.PIECE(FILE_DATA,'|',7),
				TRADEQTY = DBO.PIECE(FILE_DATA,'|',8),
				MARKETRATE = DBO.PIECE(FILE_DATA,'|',9),
				CLCODE = DBO.PIECE(FILE_DATA,'|',10),
				TRADENO = DBO.PIECE(FILE_DATA,'|',12),
				SAUDADATE = DBO.PIECE(FILE_DATA,'|',13),
				SAUDATIME = DBO.PIECE(FILE_DATA,'|',14),
				ORDERNO = DBO.PIECE(FILE_DATA,'|',17)

			INTO #BFOFTTRADE_IMP_0

			FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= @SESSIONID

			INSERT INTO BFOFTTRADE_IMP
			SELECT
				TRADE_NO = TRADENO,
				SAUDA_DATE = SAUDADATE,
				TRADESTATUS = '11',
				SEGMENT = 'F',
				SETT_TYPE = 'F',
				PRODUCT_TYPE = PRODUCTTYPE,
				PRODUCT_CODE = PRODUCTCODE,
				ASSET_CODE = '',
				EXPIRYDATE = '',
				STRIKE_PRICE = 0,
				OPTION_TYPE = '',
				CA_LEVEL = 0,
				BUY_BROKER = '',
				SELL_BROKER = '',
				TRADE_PRICE = MARKETRATE,
				TRADEQTY = TRADEQTY,
				SERIES_ID = SERIESID,
				BUYER_LOCATIONID = '',
				BUY_CM_CODE = '',
				SELL_CM_CODE = '',
				SELLER_LOCATIONID = '',  
				BUY_PARTICIPANT =  '',
				BUY_CONFIRMATION =  '',
				SELL_PARTICIPANT =  '',
				SELL_CONFIRMATION =  '',
				BUY_OC_FLAG =  '',
				SELL_OC_FLAG =  '',
				BUY_OLD_PARTICIPANT = ''  ,
				BUY_OLD_CM_CODE =  '',
				SELL_OLD_PARTICIPANT =  '',
				SELL_OLD_CM_CODE =  '',
				BUY_TERMINALID =  '',
				SELL_TERMINALID =  '',
				BUY_ORDER_NO =  CASE WHEN SELLBUY ='B' THEN ORDERNO ELSE '' END,
				SELL_ORDER_NO =  CASE WHEN SELLBUY ='S' THEN ORDERNO ELSE '' END ,
				BUY_CLIENT_CODE =   CASE WHEN SELLBUY ='B' THEN CLCODE ELSE '' END,
				SELL_CLIENT_CODE =   CASE WHEN SELLBUY ='S' THEN CLCODE ELSE '' END,
				BUY_REMARKS =  '',
				SELL_REMARKS =  '',
				BUY_POSITION =  0,
				SELL_POSITION =  0,
				BUY_PRO_CLI =  'C',
				SELL_PRO_CLI = 'C',
				BUY_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='B' THEN SAUDATIME ELSE '' END ,
				SELL_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='S' THEN SAUDATIME ELSE '' END ,
				BUY_ORDER_ACTIVEFLAG = '',
				SELL_ORDER_ACTIVEFLAG  = ''
			FROM #BFOFTTRADE_IMP_0

			DROP TABLE #BFOFTTRADE_IMP_0
			
			UPDATE BFOFTTRADE_IMP SET SAUDA_DATE = LEFT(CONVERT(DATETIME,SAUDA_DATE,103),11)

		END
		ELSE
		BEGIN
			SELECT

				TM_CODE = DBO.PIECE(FILE_DATA,'|',3),
				PRODUCTCODE = DBO.PIECE(FILE_DATA,'|',4),
				PRODUCTTYPE = DBO.PIECE(FILE_DATA,'|',5),
				SERIESID = DBO.PIECE(FILE_DATA,'|',6),
				SERIESCODE = DBO.PIECE(FILE_DATA,'|',7),
				SELLBUY = DBO.PIECE(FILE_DATA,'|',8),
				TRADEQTY = DBO.PIECE(FILE_DATA,'|',9),
				MARKETRATE = DBO.PIECE(FILE_DATA,'|',10),
				CLCODE = DBO.PIECE(FILE_DATA,'|',11),
				TRADENO = DBO.PIECE(FILE_DATA,'|',13),
				SAUDADATE = DBO.PIECE(FILE_DATA,'|',14),
				SAUDATIME = DBO.PIECE(FILE_DATA,'|',15),
				ORDERNO = DBO.PIECE(FILE_DATA,'|',18)

			INTO #BFOFTTRADE_IMP_1

			FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= @SESSIONID
			INSERT INTO BFOFTTRADE_IMP
			SELECT
				TRADE_NO = TRADENO,
				SAUDA_DATE = CONVERT(DATETIME,SAUDADATE,103),
				TRADESTATUS = '11',
				SEGMENT = 'F',
				SETT_TYPE = 'F',
				PRODUCT_TYPE = PRODUCTTYPE,
				PRODUCT_CODE = PRODUCTCODE,
				ASSET_CODE = '',
				EXPIRYDATE = '',
				STRIKE_PRICE = 0,
				OPTION_TYPE = '',
				CA_LEVEL = 0,
				BUY_BROKER = '',
				SELL_BROKER = '',
				TRADE_PRICE = MARKETRATE,
				TRADEQTY = TRADEQTY,
				SERIES_ID = SERIESID,
				BUYER_LOCATIONID = '',
				BUY_CM_CODE = '',
				SELL_CM_CODE = '',
				SELLER_LOCATIONID = '',  
				BUY_PARTICIPANT =  CASE WHEN SELLBUY ='B' THEN TM_CODE ELSE '' END,
				BUY_CONFIRMATION =  '',
				SELL_PARTICIPANT =  CASE WHEN SELLBUY ='S' THEN TM_CODE ELSE '' END,
				SELL_CONFIRMATION = ''  ,
				BUY_OC_FLAG =  '',
				SELL_OC_FLAG =  '',
				BUY_OLD_PARTICIPANT = ''  ,
				BUY_OLD_CM_CODE =  '',
				SELL_OLD_PARTICIPANT =  '',
				SELL_OLD_CM_CODE =  '',
				BUY_TERMINALID =  '',
				SELL_TERMINALID =  '',
				BUY_ORDER_NO =  CASE WHEN SELLBUY ='B' THEN ORDERNO ELSE '' END,
				SELL_ORDER_NO =  CASE WHEN SELLBUY ='S' THEN ORDERNO ELSE '' END ,
				BUY_CLIENT_CODE =   CASE WHEN SELLBUY ='B' THEN CLCODE ELSE '' END,
				SELL_CLIENT_CODE =   CASE WHEN SELLBUY ='S' THEN CLCODE ELSE '' END,
				BUY_REMARKS =  '',
				SELL_REMARKS =  '',
				BUY_POSITION =  0,
				SELL_POSITION =  0,
				BUY_PRO_CLI =  'C',
				SELL_PRO_CLI = 'C',
				BUY_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='B' THEN SAUDATIME ELSE '' END ,
				SELL_ORDER_TIMESTAMP =  CASE WHEN SELLBUY ='S' THEN SAUDATIME ELSE '' END ,
				BUY_ORDER_ACTIVEFLAG = '',
				SELL_ORDER_ACTIVEFLAG  = ''
			FROM #BFOFTTRADE_IMP_1

			DROP TABLE #BFOFTTRADE_IMP_1
		END		


		
		UPDATE BFOFTTRADE_IMP 
		SET 
			EXPIRYDATE = F.EXPIRYDATE,
			ASSET_CODE = F.ASSET_CODE,
			STRIKE_PRICE = F.STRIKE_PRICE,
			OPTION_TYPE = F.OPTION_TYPE
		FROM BFOSCRIP2 F (NOLOCK)
		WHERE
			F.PRODUCT_TYPE = BFOFTTRADE_IMP.PRODUCT_TYPE
			AND F.PRODUCT_CODE = BFOFTTRADE_IMP.PRODUCT_CODE
			AND F.SERIES_ID = BFOFTTRADE_IMP.SERIES_ID
	END
	
	IF @INTFILETYPE = 2	 	/*Old Format - Intra Day File (coma Delimited)*/ 
	BEGIN
	
		SELECT 
			USERID = DBO.PIECE(FILE_DATA,',',1),
			BOOKTYPE = DBO.PIECE(FILE_DATA,',',2),
			SCRIP_CD = DBO.PIECE(FILE_DATA,',',3),
			SCRIP_NAME = DBO.PIECE(FILE_DATA,',',4),
			MARKETRATE = DBO.PIECE(FILE_DATA,',',5),
			TRADEQTY = DBO.PIECE(FILE_DATA,',',6),
			INSTRUMENTYPE = DBO.PIECE(FILE_DATA,',',7),
			INSTRUMENT = DBO.PIECE(FILE_DATA,',',8),
			TRD_DATE = DBO.PIECE(FILE_DATA,',',9),
			TRD_TIME = DBO.PIECE(FILE_DATA,',',10),
			PARTY_CODE = DBO.PIECE(FILE_DATA,',',11),
			ORDER_NO = DBO.PIECE(FILE_DATA,',',12),
			MARKETTYPE = DBO.PIECE(FILE_DATA,',',13),
			SELL_BUY = DBO.PIECE(FILE_DATA,',',14),
			TRADE_NO = DBO.PIECE(FILE_DATA,',',15),
			PARTICIPANTCODE = DBO.PIECE(FILE_DATA,',',16),
			ISIN = DBO.PIECE(FILE_DATA,',',17),
			GROUP_CODE = DBO.PIECE(FILE_DATA,',',18),
			SETTNO = DBO.PIECE(FILE_DATA,',',19),
			ORDER_TIME = DBO.PIECE(FILE_DATA,',',20),
			FILLER = DBO.PIECE(FILE_DATA,',',21),
			FILLER1 = DBO.PIECE(FILE_DATA,',',22),
			FILLER2 = DBO.PIECE(FILE_DATA,',',23)
		INTO #BFOFTTRADE_IMP1
		FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID= @SESSIONID

		INSERT INTO BFOFTTRADE_IMP
		SELECT
			TRADE_NO = TRADE_NO,
			SAUDA_DATE = LEFT(CONVERT(DATETIME,TRD_DATE),11),
			TRADESTATUS = '11',
			SEGMENT = 'F',
			SETT_TYPE = 'F',
			PRODUCT_TYPE = '',
			PRODUCT_CODE = '',
			ASSET_CODE = '',
			EXPIRYDATE = '',
			STRIKE_PRICE = 0,
			OPTION_TYPE = '',
			CA_LEVEL = 0,
			BUY_BROKER = '',
			SELL_BROKER = '',
			TRADE_PRICE = MARKETRATE,
			TRADEQTY = TRADEQTY,
			SERIES_ID = SCRIP_CD,
			BUYER_LOCATIONID = '',
			BUY_CM_CODE = '',
			SELL_CM_CODE = '',
			SELLER_LOCATIONID = '',  
			BUY_PARTICIPANT =  '',
			BUY_CONFIRMATION =  '',
			SELL_PARTICIPANT =  '',
			SELL_CONFIRMATION =  '',
			BUY_OC_FLAG =  '',
			SELL_OC_FLAG =  '',
			BUY_OLD_PARTICIPANT = ''  ,
			BUY_OLD_CM_CODE =  '',
			SELL_OLD_PARTICIPANT =  '',
			SELL_OLD_CM_CODE =  '',
			BUY_TERMINALID =  '',
			SELL_TERMINALID =  '',
			BUY_ORDER_NO =  CASE WHEN SELL_BUY ='B' THEN ORDER_NO ELSE '' END,
			SELL_ORDER_NO =  CASE WHEN SELL_BUY ='S' THEN ORDER_NO ELSE '' END ,
			BUY_CLIENT_CODE =   CASE WHEN SELL_BUY ='B' THEN PARTY_CODE ELSE '' END,
			SELL_CLIENT_CODE =   CASE WHEN SELL_BUY ='S' THEN PARTY_CODE ELSE '' END,
			BUY_REMARKS =  '',
			SELL_REMARKS =  '',
			BUY_POSITION =  0,
			SELL_POSITION =  0,
			BUY_PRO_CLI =  'C',
			SELL_PRO_CLI = 'C',
			BUY_ORDER_TIMESTAMP =  CASE WHEN SELL_BUY ='B' THEN TRD_TIME ELSE '' END ,
			SELL_ORDER_TIMESTAMP =  CASE WHEN SELL_BUY ='S' THEN TRD_TIME ELSE '' END ,
			BUY_ORDER_ACTIVEFLAG = '',
			SELL_ORDER_ACTIVEFLAG  = ''
		FROM #BFOFTTRADE_IMP1

		DROP TABLE #BFOFTTRADE_IMP1
		
		UPDATE BFOFTTRADE_IMP 
		SET 
			EXPIRYDATE = F.EXPIRYDATE,
			ASSET_CODE = F.ASSET_CODE,
			STRIKE_PRICE = F.STRIKE_PRICE,
			OPTION_TYPE = F.OPTION_TYPE,
			PRODUCT_TYPE = F.PRODUCT_TYPE,
			PRODUCT_CODE = F.PRODUCT_CODE			
		FROM BFOSCRIP2 F (NOLOCK)
		WHERE
			F.SERIES_ID = BFOFTTRADE_IMP.SERIES_ID		
	END
	
	TRUNCATE TABLE BFOFTTRADE
	
	INSERT INTO BFOFTTRADE
	SELECT * FROM BFOFTTRADE_IMP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOVALANACCOUNT
-- --------------------------------------------------
CREATE PROC [DBO].[BFOVALANACCOUNT] (@SDATE VARCHAR(11))AS
 DECLARE
     /*DECLARING OUTPUT PARAMETERS*/
     @@VAROPTIONEXERCISE AS VARCHAR(10),
     @@VARINCLUSIVESERTAX AS VARCHAR(10),
     @@VARINCLUSIVETURNTAX AS VARCHAR(10),
     @@VARINCLUSIVESEBITAX AS VARCHAR(10),
     @@VARINCLUSIVESTAMPDUTY AS VARCHAR(10),
     @@VARCLEARINGHOUSE AS VARCHAR(10),
     @@VARREMISSORACCOUNT AS VARCHAR(10),
     @@VARSERVICETAXPAYABLE AS VARCHAR(10),
     @@VARSERVICETAXACCOUNT AS VARCHAR(10),
     @@VARBROKERAGEREALISED AS VARCHAR(10),
     @@VARCARRYFORWARDCHARGE AS VARCHAR(10),
     @@VARSEBITAX AS VARCHAR(10),
     @@VARTURNOVERTAX AS VARCHAR(10),
     @@VARCLEARINGCHARGES AS VARCHAR(10),
     @@VARREVERSECLEARINGCHARGES AS VARCHAR(10),
     @@VARCLEARINGPREMIUMACCOUNT AS VARCHAR(10),
     @@VARSTAMPDUTY AS VARCHAR(10),
     @@VARROUNDING AS VARCHAR(10),
     /*DECLARING VARIABLES THAT HOLD THE VALUES FROM THE QUERY*/
     @@VARACCODE AS VARCHAR(10),
     @@VARACNAME AS VARCHAR(50),
     @@INTRESERVED AS INT,
     @@VARREVCODE AS VARCHAR(10),
     @@VAROPPCODE AS VARCHAR(10),
     @@DTEFFDATE AS DATETIME,   
     /*DECLARING CURSOR FLAG*/
     @@FLAG AS CURSOR
/* SETTING THE OUTPUT PARAMETERS FIELDS AS ZERO HERE*/
 SELECT @@VAROPTIONEXERCISE=0
 SELECT @@VARINCLUSIVESERTAX=0
 SELECT @@VARINCLUSIVETURNTAX=0
 SELECT @@VARINCLUSIVESEBITAX=0
 SELECT @@VARINCLUSIVESTAMPDUTY=0
 SELECT @@VARCLEARINGHOUSE=0
 SELECT @@VARREMISSORACCOUNT=0
 SELECT @@VARSERVICETAXPAYABLE=0
 SELECT @@VARSERVICETAXACCOUNT=0
 SELECT @@VARBROKERAGEREALISED=0
 SELECT @@VARCARRYFORWARDCHARGE=0
 SELECT @@VARSEBITAX=0
 SELECT @@VARTURNOVERTAX=0
 SELECT @@VARCLEARINGCHARGES=0
 SELECT @@VARREVERSECLEARINGCHARGES=0
 SELECT @@VARCLEARINGPREMIUMACCOUNT=0
 SELECT @@VARSTAMPDUTY=0
 SELECT @@VARROUNDING=0
 SELECT @@VARACCODE=0 
SET @@FLAG=CURSOR FOR 
   --SELECT ACCODE,ACNAME,REVERSED,REVCODE,OPPCODE,EFFDATE FROM VALANACCOUNT V WHERE
   --EFFDATE = (SELECT MIN(EFFDATE) FROM VALANACCOUNT
   --WHERE EFFDATE >=@SDATE)
 SELECT ACCODE,ACNAME,REVERSED,REVCODE,OPPCODE,EFFDATE FROM VALANACCOUNT V WHERE
   EFFDATE = (SELECT MAX(EFFDATE) FROM VALANACCOUNT A 
   WHERE EFFDATE<=@SDATE AND V.ACNAME=A.ACNAME)
OPEN @@FLAG
  FETCH NEXT FROM @@FLAG INTO
     @@VARACCODE ,
     @@VARACNAME ,
     @@INTRESERVED,
     @@VARREVCODE,
     @@VAROPPCODE,
     @@DTEFFDATE
  WHILE @@FETCH_STATUS =0
    BEGIN 	
      /*SELECT  @@VARACNAME*/
     
      IF @@VARACNAME ='OPTION EXERCISE'
          BEGIN
             SELECT @@VAROPTIONEXERCISE = @@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='INCLUSIVE SERVICE TAX'
          BEGIN
             SELECT @@VARINCLUSIVESERTAX =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='INCLUSIVE TURN TAX'
          BEGIN
             SELECT @@VARINCLUSIVETURNTAX =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='INCLUSIVE SEBI TAX'
          BEGIN
             SELECT @@VARINCLUSIVESEBITAX =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='INCLUSIVE STAMP TAX'
          BEGIN
             SELECT @@VARINCLUSIVESTAMPDUTY =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='CLEARING HOUSE'
          BEGIN
             SELECT @@VARCLEARINGHOUSE =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='REMISSOR ACCOUNT'
          BEGIN
             SELECT @@VARREMISSORACCOUNT =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='SERVICE TAX PAYABLE'
          BEGIN
             SELECT @@VARSERVICETAXPAYABLE =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='SERVICE TAX'
          BEGIN
             SELECT @@VARSERVICETAXACCOUNT =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='BROKERAGE REALISED'
          BEGIN
             SELECT @@VARBROKERAGEREALISED =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME='CARRY FORWARD CHARGE'
          BEGIN
             SELECT @@VARCARRYFORWARDCHARGE =@@VARACCODE
          END
      ELSE
       IF @@VARACNAME ='SEBI TAX'
          BEGIN
             SELECT @@VARSEBITAX =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='TURN OVER TAX'
          BEGIN
             SELECT @@VARTURNOVERTAX =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='CLEARING CHARGES'
          BEGIN
             SELECT @@VARCLEARINGCHARGES =@@VARACCODE
          END
      ELSE
         IF @@VARACNAME ='REVERSE CLEARING CHARGES'
          BEGIN
             SELECT @@VARREVERSECLEARINGCHARGES =@@VARACCODE
          END
     ELSE
         IF @@VARACNAME ='CLEARING PREMIUM ACCOUNT'
          BEGIN
             SELECT @@VARCLEARINGPREMIUMACCOUNT =@@VARACCODE
          END
     ELSE
         IF @@VARACNAME ='STAMP DUTY'
          BEGIN
             SELECT @@VARSTAMPDUTY =@@VARACCODE
          END    
     ELSE
        IF @@VARACNAME ='ROUNDING OFF'
          BEGIN
             SELECT @@VARROUNDING =@@VARACCODE
          END   
        
         
          
     FETCH NEXT FROM @@FLAG INTO
     @@VARACCODE ,
     @@VARACNAME ,
     @@INTRESERVED,
     @@VARREVCODE,
     @@VAROPPCODE,
     @@DTEFFDATE  
    END
   
   SELECT @@VAROPTIONEXERCISE AS OPTIONEXERCISE ,
  @@VARINCLUSIVESERTAX AS INCLUSIVESERTAX,
  @@VARINCLUSIVETURNTAX AS INCLUSIVETURNTAX,
  @@VARINCLUSIVESEBITAX AS INCLUSIVESEBITAX,
  @@VARINCLUSIVESTAMPDUTY AS INCLUSIVESTAMPDUTY,
  @@VARCLEARINGHOUSE AS CLEARINGHOUSE,
  @@VARREMISSORACCOUNT AS REMISSORACCOUNT,
  @@VARSERVICETAXPAYABLE AS SERVICETAXPAYABLE,
  @@VARSERVICETAXACCOUNT AS SERVICETAXACCOUNT,
  @@VARBROKERAGEREALISED AS BROKERAGEREALISED,
  @@VARCARRYFORWARDCHARGE AS CARRYFORWARDCHARGE,
  @@VARSEBITAX AS SEBITAX,
  @@VARTURNOVERTAX AS TURNOVERTAX,
  @@VARCLEARINGCHARGES AS CLEARINGCHARGES,
  @@VARREVERSECLEARINGCHARGES AS REVERSECLEARINGCHARGES,
  @@VARCLEARINGPREMIUMACCOUNT AS CLEARINGPREMIUMACCOUNT,
  @@VARSTAMPDUTY AS STAMPDUTY ,
  @@VARROUNDING AS ROUNDING
CLOSE @@FLAG
DEALLOCATE @@FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOVALANGENERATE
-- --------------------------------------------------









CREATE PROCEDURE [dbo].[BFoValanGenerate] 
(
	@SAUDA_DATE VARCHAR(11),
	@USERNAME VARCHAR(20) =''
) AS            
DECLARE             
@@START_DATE DATETIME,            
@@EXPIRYDATE DATETIME,            
@@SETT_NO VARCHAR(12),            
@@SETT_TYPE VARCHAR(2),            
            
@@BILLNO INT,            
@@FROMPARTY VARCHAR(10),            
@@TOPARTY VARCHAR(10),            
            
@@ACNAME VARCHAR(50),            
@@ACCODE VARCHAR(10),            
@@OPPCODE VARCHAR(10),            
@@REVCODE VARCHAR(10),            
@@DUMMYOPPCODE VARCHAR(10),            
@@DUMMYREVCODE VARCHAR(10),            
            
@@CLRHSGPARTY VARCHAR(10) ,            
@@BRKRELPARTY VARCHAR(10) ,            
@@SERTAXPARTY VARCHAR(10) ,            
@@CESSTAXPARTY VARCHAR(10) ,                  
@@EDUCESSTAXPARTY VARCHAR(10) ,                  
@@OPTEXEPARTY VARCHAR(10) ,            
@@RNDOFFPARTY VARCHAR(10) ,            
@@CARFORPARTY VARCHAR(10) ,            
@@SERTAXPAYPARTY VARCHAR(10) ,            
@@CESSTAXPAYPARTY VARCHAR(10),                  
@@EDUCESSTAXPAYPARTY VARCHAR(10),                  
@@INSSERTAXPARTY VARCHAR(10) ,            
@@INSSEBITAXPARTY VARCHAR(10) ,            
@@INSTURNTAXPARTY VARCHAR(10) ,            
@@INSBRKNOTEPARTY VARCHAR(10) ,            
@@REMACCPARTY VARCHAR(10) ,            
@@SEBITAXPARTY VARCHAR(10) ,            
@@TURNTAXPARTY VARCHAR(10) ,            
@@BRKNOTEPARTY VARCHAR(10) ,            
@@REVCLRHSGPARTY VARCHAR(10) ,             
@@CONCLRHSGPARTY VARCHAR(10) ,            
@@CLRPREPARTY VARCHAR(10) ,            
@@CLRCHRGPARTY VARCHAR(10) ,            
@@REVCLRCHRGPARTY VARCHAR(10) ,            
@@INSCHRGPARTY VARCHAR(10),                  
@@OTHER_CHRGPARTY VARCHAR(10),    
@@DUMMYBRANCH_CD VARCHAR(10),            
@@BRANCH_CD VARCHAR(10),            
@@SELL_BUY INT,            
@@MTOM NUMERIC(18,6),            
@@PREMIUM NUMERIC(18,6),            
@@EXEASSIGN NUMERIC(18,6),            
@@BROKERAGE NUMERIC(18,6),            
@@SERVICE_TAX NUMERIC(18,6),            
@@CESS_TAX NUMERIC(18,6),                  
@@EDUCESS_TAX NUMERIC(18,6),                  
@@TSERVICE_TAX NUMERIC(18,6),                    
@@TCESS_TAX NUMERIC(18,6),                    
@@TEDUCESS_TAX NUMERIC(18,6),                    
@@TBROKERAGE NUMERIC(18,6),                
@@EXSERVICE_TAX NUMERIC(18,6),            
@@TURN_TAX NUMERIC(18,6),            
@@SEBI_TAX NUMERIC(18,6),            
@@BROKER_CHRG NUMERIC(18,6),            
@@CL_CHRG NUMERIC(18,6),            
@@EXCL_CHRG NUMERIC(18,6),            
@@DIFFAMT NUMERIC(18,6),            
@@TRDAMT  NUMERIC(18,6),            
@@DELAMT  NUMERIC(18,6),            
@@OPPAMT  NUMERIC(18,6),            
@@REVAMT  NUMERIC(18,6),            
@@ACCAMT  NUMERIC(18,6),            
@@CALSERAMT  NUMERIC(18,6),            
@@INSCHRG NUMERIC(18,6),    
@@OTHER_CHRG NUMERIC(18,6),      
@@TEXSERVICE_TAX NUMERIC(18,6),                  
@@TEXCESS_TAX NUMERIC(18,6),                  
@@TEXEDUCESS_TAX NUMERIC(18,6),                  
            
@@NETMTOM NUMERIC(18,6),            
@@NETPREMIUM NUMERIC(18,6),            
@@NETEXEASSIGN NUMERIC(18,6),            
@@NETBROKERAGE NUMERIC(18,6),            
@@NETSERVICE_TAX NUMERIC(18,6),            
@@NETCESS_TAX NUMERIC(18,6),                    
@@NETEDUCESS_TAX NUMERIC(18,6),                    
@@NETEXCESS_TAX NUMERIC(18,6),                    
@@NETEXEDUCESS_TAX NUMERIC(18,6),                    
@@NETEXSERVICE_TAX NUMERIC(18,6),            
@@NETTURN_TAX NUMERIC(18,6),            
@@NETSEBI_TAX NUMERIC(18,6),            
@@NETBROKER_CHRG NUMERIC(18,6),            
@@NETCL_CHRG NUMERIC(18,6),            
@@NETEXCL_CHRG NUMERIC(18,6),            
@@NETDIFFAMT NUMERIC(18,6),            
@@GROSSDIFFAMT NUMERIC(18,6),            
@@NETTRDAMT  NUMERIC(18,6),            
@@NETDELAMT NUMERIC(18,6),            
@@NETINSCHRG NUMERIC(18,6),                  
@@NETOTHER_CHRG NUMERIC(18,6),     
@@TRDSTDUTY NUMERIC(18,6),            
@@DELSTDUTY NUMERIC(18,6),            
@@STDUTY NUMERIC(18,6),            
@@TRDTTDUTY NUMERIC(18,6),            
@@DELTTDUTY NUMERIC(18,6),            
@@TTDUTY NUMERIC(18,6),            
@@TRANS_CAT VARCHAR(3),            
@@SERVICE_CHRG NUMERIC(18,6),            
@@CESS_CHRG NUMERIC(18,6),                  
@@EDUCESS_CHRG NUMERIC(18,6),                  
            
@@SUB_BROKER VARCHAR(10),            
@@COM_PER NUMERIC(18,6),            
@@BROKSHARE NUMERIC(18,6),            
@@NETBROKSHARE NUMERIC(18,6),            
@@GROSSBROKSHARE NUMERIC(18,6),            
            
@@SETMSTCUR CURSOR,        
@@VALANACCCUR CURSOR,            
@@VALANAMTCUR CURSOR            
            
SELECT @@NETMTOM = 0             
SELECT @@NETPREMIUM = 0             
SELECT @@NETEXEASSIGN = 0             
SELECT @@NETBROKERAGE = 0             
SELECT @@NETSERVICE_TAX = 0             
SELECT @@NETCESS_TAX = 0                     
SELECT @@NETEDUCESS_TAX = 0                     
SELECT @@TBROKERAGE = 0                 
SELECT @@TSERVICE_TAX = 0                    
SELECT @@TCESS_TAX = 0                    
SELECT @@TEDUCESS_TAX = 0                    
SELECT @@TEXSERVICE_TAX = 0                    
SELECT @@TEXCESS_TAX = 0                  
SELECT @@TEXEDUCESS_TAX = 0                  
SELECT @@NETEXSERVICE_TAX = 0             
SELECT @@NETEXCESS_TAX = 0                     
SELECT @@NETEXEDUCESS_TAX = 0                     
SELECT @@NETTURN_TAX = 0             
SELECT @@NETSEBI_TAX = 0             
SELECT @@NETBROKER_CHRG = 0             
SELECT @@NETCL_CHRG = 0             
SELECT @@NETEXCL_CHRG = 0             
SELECT @@NETDIFFAMT = 0             
SELECT @@GROSSDIFFAMT = 0             
SELECT @@NETTRDAMT  = 0             
SELECT @@NETDELAMT  = 0            
SELECT @@NETINSCHRG  = 0    
SELECT @@NETOTHER_CHRG = 0                  
            
SET @@SETMSTCUR = CURSOR FOR                    
SELECT SERVICE_TAX, CESS_TAX, EDUCESS_TAX FROM BFOGLOBALS  WHERE @SAUDA_DATE >= YEAR_START_DT AND @SAUDA_DATE <=  YEAR_END_DT                   
OPEN @@SETMSTCUR                     
FETCH NEXT FROM @@SETMSTCUR INTO @@SERVICE_CHRG, @@CESS_CHRG , @@EDUCESS_CHRG                   
CLOSE @@SETMSTCUR                    
DEALLOCATE @@SETMSTCUR                    

DELETE FROM BFOCLOSING
WHERE TRADE_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59' 


--SELECT * INTO #TBL_FOSCRIPMAP FROM TBL_FOSCRIPMAP WHERE UPLOAD_ON  BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59' 

SELECT DISTINCT N_INST_TYPE,N_SYMBOL,N_EXPIRYDATE,N_STRIKE_PRICE,N_OPTION_TYPE,B_INST_TYPE,B_SYMBOL,B_EXPIRYDATE,B_STRIKE_PRICE,B_OPTION_TYPE,M_INST_TYPE,M_SYMBOL,M_EXPIRYDATE,
M_STRIKE_PRICE,M_OPTION_TYPE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,EFF_FROM,EFF_TO
INTO #TBL_FOSCRIPMAP FROM TBL_FOSCRIPMAP B(NOLOCK) WHERE @SAUDA_DATE  BETWEEN EFF_FROM AND EFF_TO
AND EXISTS (SELECT Symbol FROM NSEFO..FOCLOSING F(NOLOCK) WHERE 
F.TRADE_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59' 
AND B.N_INST_TYPE = F.Inst_Type
AND B.N_SYMBOL = F.Symbol
AND B.N_EXPIRYDATE = F.EXPIRYDATE
AND B.N_STRIKE_PRICE = F.Strike_price
AND B.N_OPTION_TYPE = F.Option_type 
)

CREATE INDEX [IDX_TBL_FOSCRIPMAP] ON #TBL_FOSCRIPMAP
	(
	N_INST_TYPE ASC,
	N_SYMBOL ASC,
	N_EXPIRYDATE ASC,
	N_STRIKE_PRICE ASC,
	N_OPTION_TYPE ASC
	)

 
INSERT INTO BFOCLOSING
SELECT DISTINCT F.TRADE_DATE, SESSION_ID = '0', SERIES_ID, SERIES_CODE, PRODUCT_TYPE, PRODUCT_CODE,  
ASSET_CODE, B.B_Expirydate, B.B_Strike_price,
B.B_Option_type, 0, 0, 0, 0, F.Cl_Rate, 0, 0, 0, 0, 0, 0, 0, '', GETDATE()
FROM NSEFO..FOCLOSING F, #TBL_FOSCRIPMAP B, BFOSCRIP2 S  
WHERE 
--B.UPLOAD_ON  BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59' AND 
F.TRADE_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59' 
AND B.N_INST_TYPE = F.Inst_Type
AND B.N_SYMBOL = F.Symbol
AND B.N_EXPIRYDATE = F.EXPIRYDATE
AND B.N_STRIKE_PRICE = F.Strike_price
AND B.N_OPTION_TYPE = F.Option_type 
AND S.SERIES_CODE = B.B_Symbol
AND B.N_EXPIRYDATE = B.B_EXPIRYDATE
AND B.N_STRIKE_PRICE = B.B_Strike_price
AND B.N_OPTION_TYPE = B.B_Option_type  ----AND B.N_SYMBOL='SENSEX'
AND  B.B_SYMBOL = S.SERIES_CODE


EXEC BFOVALANPOP @SAUDA_DATE,'','ZZZZZZZZZ'            
           
DELETE FROM BFOACCBILL WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'            
            
        
SET @@VALANACCCUR = CURSOR FOR        
SELECT TOP 1 SETT_NO=' ',SETT_TYPE = ' ',START_DATE=LEFT(CONVERT(VARCHAR,STARTDATE,109),11),EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)        
FROM BFOSCRIP2 WHERE MATURITYDATE >= @SAUDA_DATE        
OPEN @@VALANACCCUR        
FETCH NEXT FROM @@VALANACCCUR INTO @@SETT_NO,@@SETT_TYPE,@@START_DATE,@@EXPIRYDATE        
CLOSE @@VALANACCCUR        
DEALLOCATE @@VALANACCCUR           
            
SELECT @@SETT_NO='0',@@SETT_TYPE='F',@@START_DATE=@SAUDA_DATE,@@EXPIRYDATE=@SAUDA_DATE      
      
/* START OF PARTY BILL AMOUNT */            
            
INSERT INTO BFOACCBILL              
SELECT PARTY_CODE,BILLNO='0',            
SELL_BUY = (CASE WHEN SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE             
          THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)       
          ELSE -1 END ) > 0             
   THEN 2            
          ELSE 1            
     END),            
SETT_NO=@@SETT_NO,SETT_TYPE=@@SETT_TYPE,@SAUDA_DATE,START_DATE=@SAUDA_DATE,END_DATE=@SAUDA_DATE,SEC_PAYIN=@SAUDA_DATE,SEC_PAYOUT=@SAUDA_DATE,            
AMOUNT = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE             
                    THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)            
                                         ELSE - (SBILLAMT + PBILLAMT + (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG))
          END)),2) ,            
MTM = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE             
                    THEN SBILLAMT - PBILLAMT + SBROKAMT - PBROKAMT             
                                         ELSE SBILLAMT + PBILLAMT - SBROKAMT - PBROKAMT             
          END)),2) ,            
0,0,0,            
BROKERAGE=ROUND(SUM(SBROKAMT + PBROKAMT),2),            
SERVICE_TAX=ROUND(SUM(SERVICE_TAX - EXSER_TAX),4),            
0,0,0,0,0,            
BRANCH_CODE,'BILL POSTED'            
FROM BFOBILLVALAN, BFOOWNER WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'            
GROUP BY BRANCH_CODE,PARTY_CODE    
            
/* END OF PARTY BILL AMOUNT */            
            
SET @@VALANACCCUR = CURSOR FOR            
 SELECT ACNAME,ACCODE FROM VALANACCOUNT V WHERE EFFDATE = (SELECT MAX(EFFDATE) FROM VALANACCOUNT A            
 WHERE A.EFFDATE <= @SAUDA_DATE AND V.ACNAME = A.ACNAME) ORDER BY ACNAME            
OPEN @@VALANACCCUR            
FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE            
WHILE @@FETCH_STATUS = 0             
BEGIN            
 IF @@ACNAME = 'CLEARING HOUSE'              
  SELECT @@CLRHSGPARTY = @@ACCODE            
 IF @@ACNAME = 'BROKERAGE REALISED'         
  SELECT @@BRKRELPARTY = @@ACCODE            
 IF @@ACNAME = 'SERVICE TAX'              
  SELECT @@SERTAXPARTY = @@ACCODE            
 IF @@ACNAME = 'CESS TAX'                      
   SELECT @@CESSTAXPARTY = @@ACCODE                    
 IF @@ACNAME = 'EDU CESS TAX'                      
   SELECT @@EDUCESSTAXPARTY = @@ACCODE                    
 IF @@ACNAME = 'OPTION EXERCISE'              
  SELECT @@OPTEXEPARTY = @@ACCODE            
 IF @@ACNAME = 'ROUNDING OFF'              
  SELECT @@RNDOFFPARTY = @@ACCODE            
 IF @@ACNAME = 'CARRY FORWARD CHARGE'              
  SELECT @@CARFORPARTY = @@ACCODE            
 IF @@ACNAME = 'SERVICE TAX PAYABLE'              
  SELECT @@SERTAXPAYPARTY = @@ACCODE            
 IF @@ACNAME = 'INCLUSIVE SERVICE TAX'              
  SELECT @@INSSERTAXPARTY = @@ACCODE            
 IF @@ACNAME = 'INCLUSIVE SEBI TAX'              
  SELECT @@INSSEBITAXPARTY = @@ACCODE            
 IF @@ACNAME = 'INCLUSIVE TURN TAX'              
  SELECT @@INSTURNTAXPARTY = @@ACCODE            
 IF @@ACNAME = 'INCLUSIVE STAMP TAX'              
  SELECT @@INSBRKNOTEPARTY = @@ACCODE            
 IF @@ACNAME = 'REMISSOR ACCOUNT'              
  SELECT @@REMACCPARTY = @@ACCODE            
 IF @@ACNAME = 'SEBI TAX'              
  SELECT @@SEBITAXPARTY = @@ACCODE            
 IF @@ACNAME = 'CESS TAX PAYABLE'                      
   SELECT @@CESSTAXPAYPARTY = @@ACCODE                    
 IF @@ACNAME = 'EDU CESS TAX PAYABLE'                      
   SELECT @@EDUCESSTAXPAYPARTY = @@ACCODE                    
 IF @@ACNAME = 'TURN OVER TAX'              
  SELECT @@TURNTAXPARTY = @@ACCODE            
 IF @@ACNAME = 'STAMP DUTY'              
  SELECT @@BRKNOTEPARTY = @@ACCODE            
 IF @@ACNAME = 'REVERSE CLRG HOUSE'              
  SELECT @@REVCLRHSGPARTY = @@ACCODE             
 IF @@ACNAME = 'CONS. CLRG HOUSE'              
  SELECT @@CONCLRHSGPARTY = @@ACCODE            
 IF @@ACNAME = 'CLEARING CHARGES'              
  SELECT @@CLRCHRGPARTY = @@ACCODE            
 IF @@ACNAME = 'REVERSE CLEARING CHARGES'              
  SELECT @@REVCLRCHRGPARTY = @@ACCODE            
 IF @@ACNAME = 'CLEARING PREMIUM ACCOUNT'              
  SELECT @@CLRPREPARTY = @@ACCODE            
 IF @@ACNAME = 'SECURITY TRANSACTION TAX'                    
  SELECT @@INSCHRGPARTY = @@ACCODE                  
 IF @@ACNAME = 'OTHER CHARGES'                
  SELECT @@OTHER_CHRGPARTY = @@ACCODE     
            
 FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE            
END            
CLOSE @@VALANACCCUR            
DEALLOCATE @@VALANACCCUR            
            
/* EXCHANGE AND LEVIS BRANCH WISE OBLIGATION AMOUNT */            
SET @@VALANAMTCUR = CURSOR FOR             
 SELECT BRANCH_CODE,            
 MTOM      = ISNULL(SUM(CASE WHEN RIGHT(PRODUCT_CODE,3) =  'FUT'  AND PARTICIPANTCODE = MEMBERCODE             
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT             
        ELSE 0             
          END),0),            
 PREMIUM   = ISNULL(SUM(CASE WHEN RIGHT(PRODUCT_CODE,3) =  'OPT'  AND AUCTIONPART <> 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE             
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT             
        ELSE 0             
          END),0),            
 EXEASSIGN = ISNULL(SUM(CASE WHEN RIGHT(PRODUCT_CODE,3) =  'OPT'  AND AUCTIONPART = 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE             
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT             
        ELSE 0             
          END),0),            
 BROKERAGE=SUM(SBROKAMT + PBROKAMT),            
 SERVICE_TAX=SUM(SERVICE_TAX),EXSERVICE_TAX=SUM(EXSER_TAX),            
 TURN_TAX=SUM(TURN_TAX),SEBI_TAX=SUM(SEBI_TAX), INS_CHRG=SUM(INS_CHRG),            
 BROKER_CHRG=SUM(BROKER_NOTE),CL_CHRG = SUM(CL_CHRG),EXCL_CHRG = SUM(EXCL_CHRG),    
 OTHER_CHRG = SUM(OTHER_CHRG)    
 FROM BFOBILLVALAN, BFOOWNER WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'            
 GROUP BY BRANCH_CODE            
 ORDER BY BRANCH_CODE            
OPEN @@VALANAMTCUR             
FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,            
                @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG, @@OTHER_CHRG            
WHILE @@FETCH_STATUS = 0             
BEGIN             
 SELECT @@NETMTOM = @@NETMTOM + @@MTOM                  
 SELECT @@NETPREMIUM = @@NETPREMIUM + @@PREMIUM                  
 SELECT @@NETEXEASSIGN = @@NETEXEASSIGN + @@EXEASSIGN                   
 SELECT @@NETTURN_TAX = @@NETTURN_TAX + @@TURN_TAX                  
 SELECT @@NETSEBI_TAX = @@NETSEBI_TAX + @@SEBI_TAX                  
 SELECT @@NETBROKER_CHRG = @@NETBROKER_CHRG + @@BROKER_CHRG                   
 SELECT @@NETCL_CHRG = @@NETCL_CHRG + @@CL_CHRG                  
 SELECT @@NETEXCL_CHRG = @@NETEXCL_CHRG + @@EXCL_CHRG                  
 SELECT @@NETINSCHRG  = @@NETINSCHRG + @@INSCHRG                  
 SELECT @@NETOTHER_CHRG  = @@NETOTHER_CHRG + @@OTHER_CHRG    
 SELECT @@TSERVICE_TAX =  @@SERVICE_TAX                    
 SELECT @@TEXSERVICE_TAX =  @@EXSERVICE_TAX                     

IF (@@CESS_CHRG+@@EDUCESS_CHRG) > 0                 
BEGIN                   
 SELECT @@TCESS_TAX = @@SERVICE_TAX - ROUND(( @@SERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG) ),2)                
 SELECT @@TEDUCESS_TAX = ROUND(@@TCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2) 

END
ELSE
BEGIN
 SELECT @@TCESS_TAX = 0
 SELECT @@TEDUCESS_TAX = 0


END                 
 SELECT @@TCESS_TAX = @@TCESS_TAX - @@TEDUCESS_TAX               
 SELECT @@TSERVICE_TAX = @@SERVICE_TAX - @@TCESS_TAX - @@TEDUCESS_TAX             
 
IF (@@CESS_CHRG+@@EDUCESS_CHRG) > 0   
BEGIN                                 
 SELECT @@TEXCESS_TAX = @@TEXSERVICE_TAX - ROUND(( @@TEXSERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG)),2)       
 SELECT @@TEXEDUCESS_TAX = ROUND(@@TEXCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)   

END
ELSE
BEGIN
 SELECT @@TEXCESS_TAX = 0
 SELECT @@TEXEDUCESS_TAX = 0


END  
 SELECT @@TEXCESS_TAX = @@TEXCESS_TAX - @@TEXEDUCESS_TAX               
 SELECT @@TEXSERVICE_TAX = @@TEXSERVICE_TAX - @@TEXCESS_TAX - @@TEXEDUCESS_TAX       
              
 SELECT @@NETCESS_TAX = @@NETCESS_TAX + @@TCESS_TAX                
 SELECT @@NETEDUCESS_TAX = @@NETEDUCESS_TAX + @@TEDUCESS_TAX                
 SELECT @@NETEXCESS_TAX = @@NETEXCESS_TAX + @@TEXCESS_TAX                 
 SELECT @@NETEXEDUCESS_TAX = @@NETEXEDUCESS_TAX + @@TEXEDUCESS_TAX    
                     
  
 SELECT @@NETEXSERVICE_TAX = @@NETEXSERVICE_TAX + @@TEXSERVICE_TAX   
 SELECT @@NETSERVICE_TAX = @@NETSERVICE_TAX + @@TSERVICE_TAX                  
 SELECT @@TBROKERAGE = @@BROKERAGE                
 SELECT @@NETBROKERAGE = @@NETBROKERAGE + @@TBROKERAGE                  
             
 IF @@MTOM > 0             
  SELECT @@SELL_BUY = 1              
 ELSE            
  SELECT @@SELL_BUY = 2            
    INSERT INTO BFOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@MTOM),2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')             
                
 IF @@PREMIUM > 0             
  SELECT @@SELL_BUY = 1              
 ELSE            
  SELECT @@SELL_BUY = 2         
    INSERT INTO BFOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@PREMIUM),2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
            
 IF @@EXEASSIGN > 0             
  SELECT @@SELL_BUY = 1              
 ELSE            
  SELECT @@SELL_BUY = 2            
    INSERT INTO BFOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@EXEASSIGN),2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@TBROKERAGE,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@TSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
              
 INSERT INTO BFOACCBILL VALUES (@@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@TEXSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
            
 IF ROUND(@@TCESS_TAX,2) <> 0                   
 BEGIN                  
   INSERT INTO BFOACCBILL VALUES (@@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@TCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
 END                  
 IF ROUND(@@TEDUCESS_TAX,2) <> 0                   
 BEGIN                  
   INSERT INTO BFOACCBILL VALUES (@@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@TEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
 END                  
                  
                  
  IF ROUND(@@TEXCESS_TAX,2) <> 0                  
   BEGIN                  
    INSERT INTO BFOACCBILL VALUES (@@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@TEXCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')     
  END                  
  IF ROUND(@@TEXEDUCESS_TAX,2) <> 0                  
   BEGIN           
    INSERT INTO BFOACCBILL VALUES (@@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@TEXEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
  END                  
                  
          
 INSERT INTO BFOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@TURN_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED') 
     
 INSERT INTO BFOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@SEBI_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@BROKER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@CL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
              
 INSERT INTO BFOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@EXCL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
          
          
 INSERT INTO BFOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@INSCHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
          
 INSERT INTO BFOACCBILL VALUES ( @@OTHER_CHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@OTHER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
            
 FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,            
                      @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG,@@OTHER_CHRG            
            
END            
CLOSE @@VALANAMTCUR            
DEALLOCATE @@VALANAMTCUR            
            
SELECT @@NETBROKSHARE = 0            
SELECT @@GROSSBROKSHARE = 0            
            
SET @@VALANAMTCUR = CURSOR FOR            
SELECT SB.SUB_BROKER,COM_PERC, BRANCH_CD, BROKERAGE = SUM(PBROKAMT+SBROKAMT)*COM_PERC/100            
FROM BFOBILLVALAN S, CLIENT2 C2,CLIENT1 C1,SUBBROKERS SB            
WHERE S.PARTY_CODE = C2.PARTY_CODE AND C1.CL_CODE = C2.CL_CODE             
AND C1.SUB_BROKER = SB.SUB_BROKER             
AND SB.COM_PERC > 0             
AND S.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'            
GROUP BY SB.SUB_BROKER,COM_PERC,BRANCH_CD            
ORDER BY SB.SUB_BROKER,BRANCH_CD            
OPEN @@VALANAMTCUR             
FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD,@@BROKSHARE            
WHILE @@FETCH_STATUS = 0              
BEGIN            
 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD            
 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0              
 BEGIN            
  SELECT @@NETBROKSHARE = @@NETBROKSHARE + @@BROKSHARE            
  SELECT @@GROSSBROKSHARE = @@GROSSBROKSHARE + @@BROKSHARE            
            
  INSERT INTO BFOACCBILL VALUES ( @@SUB_BROKER,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
               ROUND(@@BROKSHARE,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
               
  FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD        
 END  
 /*          
INSERT INTO BFOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
       ROUND(@@NETBROKSHARE,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
 SELECT @@NETBROKSHARE = 0            
*/          
END            
            
SET @@VALANAMTCUR = CURSOR FOR            
 SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),BRANCHCD,SELL_BUY FROM BFOACCBILL WHERE      
 BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59' AND BRANCHCD <> 'ZZZ'            
 GROUP BY BRANCHCD,SELL_BUY             
 ORDER BY BRANCHCD,SELL_BUY            
OPEN @@VALANAMTCUR             
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY            
WHILE @@FETCH_STATUS = 0              
BEGIN            
 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD            
 SELECT @@NETDIFFAMT = 0            
 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0             
 BEGIN            
  IF @@SELL_BUY = 1             
  BEGIN            
   SELECT @@NETDIFFAMT = @@NETDIFFAMT + @@DIFFAMT            
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT            
  END             
  ELSE            
  BEGIN                                    
   SELECT @@NETDIFFAMT = @@NETDIFFAMT - @@DIFFAMT             
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT            
  END            
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY              
 END            
 IF @@NETDIFFAMT > 0             
  INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')            
 ELSE IF @@NETDIFFAMT < 0             
  INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')            
             
END            
CLOSE @@VALANAMTCUR            
DEALLOCATE @@VALANAMTCUR            
            
 IF @@NETMTOM > 0             
  SELECT @@SELL_BUY = 1              
 ELSE            
  SELECT @@SELL_BUY = 2            
    INSERT INTO BFOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@NETMTOM),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')             
                
 IF @@NETPREMIUM > 0             
  SELECT @@SELL_BUY = 1              
 ELSE            
  SELECT @@SELL_BUY = 2            
    INSERT INTO BFOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@NETPREMIUM),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
 IF @@NETEXEASSIGN > 0             
  SELECT @@SELL_BUY = 1              
 ELSE            
  SELECT @@SELL_BUY = 2            
    INSERT INTO BFOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@NETEXEASSIGN),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETBROKERAGE,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')             
              
 IF ROUND(@@NETCESS_TAX,2) <> 0               
  BEGIN              
   INSERT INTO BFOACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@NETCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')             
  END        
      
 IF ROUND(@@NETEDUCESS_TAX,2) <> 0                   
  BEGIN                  
   INSERT INTO BFOACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,      
         ROUND(@@NETEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')             
  END        
                
 IF ROUND(@@NETEXCESS_TAX,2) <> 0                   
  BEGIN                  
   INSERT INTO BFOACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@NETEXCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')             
  END                  
      
 IF ROUND(@@NETEXEDUCESS_TAX,2) <> 0                   
  BEGIN                  
   INSERT INTO BFOACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@NETEXEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')             
  END                  
          
 INSERT INTO BFOACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETEXSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETTURN_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
             
 INSERT INTO BFOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETSEBI_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETBROKER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
 INSERT INTO BFOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETCL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
              
 INSERT INTO BFOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@NETEXCL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
 /*INSERT INTO BFOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(@@GROSSBROKSHARE,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
*/        
            
 INSERT INTO BFOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@NETINSCHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
    
 INSERT INTO BFOACCBILL VALUES ( @@OTHER_CHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                  
         ROUND(@@NETOTHER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')    
          
SELECT @@OPPAMT = 0            
            
SET @@VALANAMTCUR = CURSOR FOR            
 SELECT OPPCODE,REVCODE,ACCODE FROM VALANACCOUNT WHERE REVERSED = 1             
 AND EFFDATE = (SELECT MIN(EFFDATE) FROM VALANACCOUNT            
 WHERE EFFDATE <= @SAUDA_DATE ) ORDER BY OPPCODE,REVCODE            
OPEN @@VALANAMTCUR             
FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE       
WHILE @@FETCH_STATUS =  0            
BEGIN            
 SELECT @@DUMMYOPPCODE = @@OPPCODE            
 WHILE @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0            
 BEGIN            
  SELECT @@REVAMT = 0            
  SELECT @@DUMMYREVCODE = @@REVCODE            
  WHILE @@DUMMYREVCODE = @@REVCODE AND @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0            
  BEGIN            
   SET @@VALANACCCUR = CURSOR FOR            
    SELECT AMOUNT,SELL_BUY FROM BFOACCBILL WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'            
    AND PARTY_CODE = @@ACCODE AND BRANCHCD = 'ZZZ'            
   OPEN @@VALANACCCUR             
   FETCH NEXT FROM @@VALANACCCUR INTO @@ACCAMT,@@SELL_BUY            
            
   IF @@FETCH_STATUS =  0            
   BEGIN            
    IF @@SELL_BUY = 1             
    BEGIN            
     SELECT @@REVAMT = @@REVAMT + @@ACCAMT            
     SELECT @@OPPAMT = @@OPPAMT + @@ACCAMT            
    END            
    ELSE            
    BEGIN            
     SELECT @@REVAMT = @@REVAMT - @@ACCAMT            
     SELECT @@OPPAMT = @@OPPAMT - @@ACCAMT            
    END            
   END            
   ELSE            
   CLOSE @@VALANACCCUR            
 DEALLOCATE @@VALANACCCUR            
   FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE             
  END            
  IF @@REVAMT > 0             
   INSERT INTO BFOACCBILL VALUES ( @@DUMMYREVCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
          ROUND(ABS(@@REVAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
  ELSE            
   INSERT INTO BFOACCBILL VALUES ( @@DUMMYREVCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
          ROUND(ABS(@@REVAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
 END             
 IF @@OPPAMT > 0            
  INSERT INTO BFOACCBILL VALUES ( @@DUMMYOPPCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@OPPAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
 ELSE            
  INSERT INTO BFOACCBILL VALUES ( @@DUMMYOPPCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
         ROUND(ABS(@@OPPAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
END            
CLOSE @@VALANAMTCUR            
DEALLOCATE @@VALANAMTCUR            
            
SELECT @@GROSSDIFFAMT = 0            
            
SET @@VALANAMTCUR = CURSOR FOR            
            
SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),SELL_BUY FROM BFOACCBILL A,ACCOUNTBFO..ACMAST M             
WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'            
AND A.PARTY_CODE = M.CLTCODE AND (BRANCHCD = 'ZZZ' OR ACCAT = 4 )            
GROUP BY SELL_BUY            
            
OPEN @@VALANAMTCUR             
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY            
WHILE @@FETCH_STATUS = 0              
BEGIN            
 BEGIN            
  IF @@SELL_BUY = 1             
  BEGIN              
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT            
  END              
  ELSE            
  BEGIN                                
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT                     
  END            
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY            
 END            
END            
CLOSE @@VALANAMTCUR            
DEALLOCATE @@VALANAMTCUR            
  
IF @@GROSSDIFFAMT > 0             
 INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
ELSE             
 INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,            
        ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')            
            
--DELETE FROM BFOACCBILL WHERE AMOUNT = 0 AND BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'            
   
EXEC BFOGENBILLNO @SAUDA_DATE     
    
/*---------------------------------- PROCESS CONTROLER PLUG IN START-------------------------------------*/     
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'VALANGEN','',@USERNAME,''
  
/*---------------------------------- PROCESS CONTROLER PLUG IN END-------------------------------------*/ 


EXEC VALAN_ADDITIONAL_PROCESS @Sauda_Date

/*GST*/

EXEC VALAN_GST_BILLPOST @SAUDA_DATE

EXEC VALAN_INTEROP @SAUDA_DATE



DROP TABLE #TBL_FOSCRIPMAP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOVALANGENERATE_BKUP_10Aug2023
-- --------------------------------------------------



  
CREATE PROCEDURE [dbo].[BFOVALANGENERATE_BKUP_10Aug2023]   
(  
 @SAUDA_DATE VARCHAR(11),  
 @USERNAME VARCHAR(20) =''  
) AS              
DECLARE               
@@START_DATE DATETIME,              
@@EXPIRYDATE DATETIME,              
@@SETT_NO VARCHAR(12),              
@@SETT_TYPE VARCHAR(2),              
              
@@BILLNO INT,              
@@FROMPARTY VARCHAR(10),              
@@TOPARTY VARCHAR(10),              
              
@@ACNAME VARCHAR(50),              
@@ACCODE VARCHAR(10),              
@@OPPCODE VARCHAR(10),              
@@REVCODE VARCHAR(10),              
@@DUMMYOPPCODE VARCHAR(10),              
@@DUMMYREVCODE VARCHAR(10),              
              
@@CLRHSGPARTY VARCHAR(10) ,              
@@BRKRELPARTY VARCHAR(10) ,              
@@SERTAXPARTY VARCHAR(10) ,              
@@CESSTAXPARTY VARCHAR(10) ,                    
@@EDUCESSTAXPARTY VARCHAR(10) ,                    
@@OPTEXEPARTY VARCHAR(10) ,              
@@RNDOFFPARTY VARCHAR(10) ,              
@@CARFORPARTY VARCHAR(10) ,              
@@SERTAXPAYPARTY VARCHAR(10) ,              
@@CESSTAXPAYPARTY VARCHAR(10),                    
@@EDUCESSTAXPAYPARTY VARCHAR(10),                    
@@INSSERTAXPARTY VARCHAR(10) ,              
@@INSSEBITAXPARTY VARCHAR(10) ,              
@@INSTURNTAXPARTY VARCHAR(10) ,              
@@INSBRKNOTEPARTY VARCHAR(10) ,              
@@REMACCPARTY VARCHAR(10) ,              
@@SEBITAXPARTY VARCHAR(10) ,              
@@TURNTAXPARTY VARCHAR(10) ,              
@@BRKNOTEPARTY VARCHAR(10) ,              
@@REVCLRHSGPARTY VARCHAR(10) ,               
@@CONCLRHSGPARTY VARCHAR(10) ,              
@@CLRPREPARTY VARCHAR(10) ,              
@@CLRCHRGPARTY VARCHAR(10) ,              
@@REVCLRCHRGPARTY VARCHAR(10) ,              
@@INSCHRGPARTY VARCHAR(10),                    
@@OTHER_CHRGPARTY VARCHAR(10),      
@@DUMMYBRANCH_CD VARCHAR(10),              
@@BRANCH_CD VARCHAR(10),              
@@SELL_BUY INT,              
@@MTOM NUMERIC(18,6),              
@@PREMIUM NUMERIC(18,6),              
@@EXEASSIGN NUMERIC(18,6),              
@@BROKERAGE NUMERIC(18,6),              
@@SERVICE_TAX NUMERIC(18,6),              
@@CESS_TAX NUMERIC(18,6),                    
@@EDUCESS_TAX NUMERIC(18,6),                    
@@TSERVICE_TAX NUMERIC(18,6),                      
@@TCESS_TAX NUMERIC(18,6),                      
@@TEDUCESS_TAX NUMERIC(18,6),                      
@@TBROKERAGE NUMERIC(18,6),                  
@@EXSERVICE_TAX NUMERIC(18,6),              
@@TURN_TAX NUMERIC(18,6),              
@@SEBI_TAX NUMERIC(18,6),              
@@BROKER_CHRG NUMERIC(18,6),              
@@CL_CHRG NUMERIC(18,6),              
@@EXCL_CHRG NUMERIC(18,6),              
@@DIFFAMT NUMERIC(18,6),              
@@TRDAMT  NUMERIC(18,6),              
@@DELAMT  NUMERIC(18,6),              
@@OPPAMT  NUMERIC(18,6),              
@@REVAMT  NUMERIC(18,6),              
@@ACCAMT  NUMERIC(18,6),              
@@CALSERAMT  NUMERIC(18,6),              
@@INSCHRG NUMERIC(18,6),      
@@OTHER_CHRG NUMERIC(18,6),        
@@TEXSERVICE_TAX NUMERIC(18,6),                    
@@TEXCESS_TAX NUMERIC(18,6),                    
@@TEXEDUCESS_TAX NUMERIC(18,6),                    
              
@@NETMTOM NUMERIC(18,6),              
@@NETPREMIUM NUMERIC(18,6),              
@@NETEXEASSIGN NUMERIC(18,6),              
@@NETBROKERAGE NUMERIC(18,6),              
@@NETSERVICE_TAX NUMERIC(18,6),              
@@NETCESS_TAX NUMERIC(18,6),                      
@@NETEDUCESS_TAX NUMERIC(18,6),                      
@@NETEXCESS_TAX NUMERIC(18,6),                      
@@NETEXEDUCESS_TAX NUMERIC(18,6),                      
@@NETEXSERVICE_TAX NUMERIC(18,6),              
@@NETTURN_TAX NUMERIC(18,6),              
@@NETSEBI_TAX NUMERIC(18,6),              
@@NETBROKER_CHRG NUMERIC(18,6),              
@@NETCL_CHRG NUMERIC(18,6),              
@@NETEXCL_CHRG NUMERIC(18,6),              
@@NETDIFFAMT NUMERIC(18,6),              
@@GROSSDIFFAMT NUMERIC(18,6),              
@@NETTRDAMT  NUMERIC(18,6),              
@@NETDELAMT NUMERIC(18,6),              
@@NETINSCHRG NUMERIC(18,6),                    
@@NETOTHER_CHRG NUMERIC(18,6),       
@@TRDSTDUTY NUMERIC(18,6),              
@@DELSTDUTY NUMERIC(18,6),              
@@STDUTY NUMERIC(18,6),              
@@TRDTTDUTY NUMERIC(18,6),              
@@DELTTDUTY NUMERIC(18,6),              
@@TTDUTY NUMERIC(18,6),              
@@TRANS_CAT VARCHAR(3),              
@@SERVICE_CHRG NUMERIC(18,6),              
@@CESS_CHRG NUMERIC(18,6),                    
@@EDUCESS_CHRG NUMERIC(18,6),                    
              
@@SUB_BROKER VARCHAR(10),              
@@COM_PER NUMERIC(18,6),              
@@BROKSHARE NUMERIC(18,6),              
@@NETBROKSHARE NUMERIC(18,6),              
@@GROSSBROKSHARE NUMERIC(18,6),              
              
@@SETMSTCUR CURSOR,          
@@VALANACCCUR CURSOR,              
@@VALANAMTCUR CURSOR              
              
SELECT @@NETMTOM = 0               
SELECT @@NETPREMIUM = 0               
SELECT @@NETEXEASSIGN = 0               
SELECT @@NETBROKERAGE = 0               
SELECT @@NETSERVICE_TAX = 0               
SELECT @@NETCESS_TAX = 0                       
SELECT @@NETEDUCESS_TAX = 0                       
SELECT @@TBROKERAGE = 0                   
SELECT @@TSERVICE_TAX = 0                      
SELECT @@TCESS_TAX = 0                      
SELECT @@TEDUCESS_TAX = 0                      
SELECT @@TEXSERVICE_TAX = 0                      
SELECT @@TEXCESS_TAX = 0                    
SELECT @@TEXEDUCESS_TAX = 0                    
SELECT @@NETEXSERVICE_TAX = 0               
SELECT @@NETEXCESS_TAX = 0                       
SELECT @@NETEXEDUCESS_TAX = 0                       
SELECT @@NETTURN_TAX = 0               
SELECT @@NETSEBI_TAX = 0               
SELECT @@NETBROKER_CHRG = 0               
SELECT @@NETCL_CHRG = 0               
SELECT @@NETEXCL_CHRG = 0               
SELECT @@NETDIFFAMT = 0               
SELECT @@GROSSDIFFAMT = 0               
SELECT @@NETTRDAMT  = 0               
SELECT @@NETDELAMT  = 0              
SELECT @@NETINSCHRG  = 0      
SELECT @@NETOTHER_CHRG = 0                    
              
SET @@SETMSTCUR = CURSOR FOR                      
SELECT SERVICE_TAX, CESS_TAX, EDUCESS_TAX FROM BFOGLOBALS  WHERE @SAUDA_DATE >= YEAR_START_DT AND @SAUDA_DATE <=  YEAR_END_DT                     
OPEN @@SETMSTCUR                       
FETCH NEXT FROM @@SETMSTCUR INTO @@SERVICE_CHRG, @@CESS_CHRG , @@EDUCESS_CHRG                     
CLOSE @@SETMSTCUR                      
DEALLOCATE @@SETMSTCUR                      
  
  
EXEC PROC_TURN_TAX_UPDATE_ADNL @SAUDA_DATE,'','ZZZZZZZZZ'   
EXEC BFOVALANPOP @SAUDA_DATE,'','ZZZZZZZZZ'              
             
DELETE FROM BFOACCBILL WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'              
              
          
SET @@VALANACCCUR = CURSOR FOR          
SELECT TOP 1 SETT_NO=' ',SETT_TYPE = ' ',START_DATE=LEFT(CONVERT(VARCHAR,STARTDATE,109),11),EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)          
FROM BFOSCRIP2 WHERE MATURITYDATE >= @SAUDA_DATE          
OPEN @@VALANACCCUR          
FETCH NEXT FROM @@VALANACCCUR INTO @@SETT_NO,@@SETT_TYPE,@@START_DATE,@@EXPIRYDATE          
CLOSE @@VALANACCCUR          
DEALLOCATE @@VALANACCCUR             
              
SELECT @@SETT_NO='0',@@SETT_TYPE='F',@@START_DATE=@SAUDA_DATE,@@EXPIRYDATE=@SAUDA_DATE        
        
/* START OF PARTY BILL AMOUNT */              
              
INSERT INTO BFOACCBILL                
SELECT PARTY_CODE,BILLNO='0',              
SELL_BUY = (CASE WHEN SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE               
          THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)         
          ELSE -1 END ) > 0               
   THEN 2              
          ELSE 1              
     END),              
SETT_NO=@@SETT_NO,SETT_TYPE=@@SETT_TYPE,@SAUDA_DATE,START_DATE=@SAUDA_DATE,END_DATE=@SAUDA_DATE,SEC_PAYIN=@SAUDA_DATE,SEC_PAYOUT=@SAUDA_DATE,              
AMOUNT = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE               
                    THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)              
                                         ELSE SBILLAMT + PBILLAMT + (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)               
          END)),2) ,              
MTM = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE               
                    THEN SBILLAMT - PBILLAMT + SBROKAMT - PBROKAMT               
                                         ELSE SBILLAMT + PBILLAMT - SBROKAMT - PBROKAMT               
          END)),2) ,              
0,0,0,              
BROKERAGE=ROUND(SUM(SBROKAMT + PBROKAMT),2),              
SERVICE_TAX=ROUND(SUM(SERVICE_TAX - EXSER_TAX),4),              
0,0,0,0,0,              
BRANCH_CODE,'BILL POSTED'              
FROM BFOBILLVALAN, BFOOWNER WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'              
GROUP BY BRANCH_CODE,PARTY_CODE      
              
/* END OF PARTY BILL AMOUNT */              
              
SET @@VALANACCCUR = CURSOR FOR              
 SELECT ACNAME,ACCODE FROM VALANACCOUNT V WHERE EFFDATE = (SELECT MAX(EFFDATE) FROM VALANACCOUNT A              
 WHERE A.EFFDATE <= @SAUDA_DATE AND V.ACNAME = A.ACNAME) ORDER BY ACNAME              
OPEN @@VALANACCCUR              
FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE              
WHILE @@FETCH_STATUS = 0               
BEGIN              
 IF @@ACNAME = 'CLEARING HOUSE'                
  SELECT @@CLRHSGPARTY = @@ACCODE              
 IF @@ACNAME = 'BROKERAGE REALISED'           
  SELECT @@BRKRELPARTY = @@ACCODE              
 IF @@ACNAME = 'SERVICE TAX'                
  SELECT @@SERTAXPARTY = @@ACCODE              
 IF @@ACNAME = 'CESS TAX'                        
   SELECT @@CESSTAXPARTY = @@ACCODE                      
 IF @@ACNAME = 'EDU CESS TAX'                        
   SELECT @@EDUCESSTAXPARTY = @@ACCODE                      
 IF @@ACNAME = 'OPTION EXERCISE'                
  SELECT @@OPTEXEPARTY = @@ACCODE              
 IF @@ACNAME = 'ROUNDING OFF'                
  SELECT @@RNDOFFPARTY = @@ACCODE              
 IF @@ACNAME = 'CARRY FORWARD CHARGE'                
  SELECT @@CARFORPARTY = @@ACCODE              
 IF @@ACNAME = 'SERVICE TAX PAYABLE'                
  SELECT @@SERTAXPAYPARTY = @@ACCODE              
 IF @@ACNAME = 'INCLUSIVE SERVICE TAX'                
  SELECT @@INSSERTAXPARTY = @@ACCODE              
 IF @@ACNAME = 'INCLUSIVE SEBI TAX'                
  SELECT @@INSSEBITAXPARTY = @@ACCODE              
 IF @@ACNAME = 'INCLUSIVE TURN TAX'                
  SELECT @@INSTURNTAXPARTY = @@ACCODE              
 IF @@ACNAME = 'INCLUSIVE STAMP TAX'                
  SELECT @@INSBRKNOTEPARTY = @@ACCODE              
 IF @@ACNAME = 'REMISSOR ACCOUNT'                
  SELECT @@REMACCPARTY = @@ACCODE              
 IF @@ACNAME = 'SEBI TAX'                
  SELECT @@SEBITAXPARTY = @@ACCODE              
 IF @@ACNAME = 'CESS TAX PAYABLE'                        
   SELECT @@CESSTAXPAYPARTY = @@ACCODE                      
 IF @@ACNAME = 'EDU CESS TAX PAYABLE'                        
   SELECT @@EDUCESSTAXPAYPARTY = @@ACCODE                      
 IF @@ACNAME = 'TURN OVER TAX'                
  SELECT @@TURNTAXPARTY = @@ACCODE              
 IF @@ACNAME = 'STAMP DUTY'                
  SELECT @@BRKNOTEPARTY = @@ACCODE              
 IF @@ACNAME = 'REVERSE CLRG HOUSE'                
  SELECT @@REVCLRHSGPARTY = @@ACCODE               
 IF @@ACNAME = 'CONS. CLRG HOUSE'                
  SELECT @@CONCLRHSGPARTY = @@ACCODE              
 IF @@ACNAME = 'CLEARING CHARGES'                
  SELECT @@CLRCHRGPARTY = @@ACCODE              
 IF @@ACNAME = 'REVERSE CLEARING CHARGES'                
  SELECT @@REVCLRCHRGPARTY = @@ACCODE              
 IF @@ACNAME = 'CLEARING PREMIUM ACCOUNT'                
  SELECT @@CLRPREPARTY = @@ACCODE              
 IF @@ACNAME = 'SECURITY TRANSACTION TAX'                      
  SELECT @@INSCHRGPARTY = @@ACCODE                    
 IF @@ACNAME = 'OTHER CHARGES'                  
  SELECT @@OTHER_CHRGPARTY = @@ACCODE       
              
 FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE              
END              
CLOSE @@VALANACCCUR              
DEALLOCATE @@VALANACCCUR              
              
/* EXCHANGE AND LEVIS BRANCH WISE OBLIGATION AMOUNT */              
SET @@VALANAMTCUR = CURSOR FOR               
 SELECT BRANCH_CODE,              
 MTOM      = ISNULL(SUM(CASE WHEN RIGHT(PRODUCT_CODE,3) =  'FUT'  AND PARTICIPANTCODE = MEMBERCODE               
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT               
        ELSE 0               
          END),0),              
 PREMIUM   = ISNULL(SUM(CASE WHEN RIGHT(PRODUCT_CODE,3) =  'OPT'  AND AUCTIONPART <> 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE               
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT               
        ELSE 0               
          END),0),              
 EXEASSIGN = ISNULL(SUM(CASE WHEN RIGHT(PRODUCT_CODE,3) =  'OPT'  AND AUCTIONPART = 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE               
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT               
        ELSE 0               
          END),0),              
 BROKERAGE=SUM(SBROKAMT + PBROKAMT),              
 SERVICE_TAX=SUM(SERVICE_TAX),EXSERVICE_TAX=SUM(EXSER_TAX),              
 TURN_TAX=SUM(TURN_TAX),SEBI_TAX=SUM(SEBI_TAX), INS_CHRG=SUM(INS_CHRG),              
 BROKER_CHRG=SUM(BROKER_NOTE),CL_CHRG = SUM(CL_CHRG),EXCL_CHRG = SUM(EXCL_CHRG),      
 OTHER_CHRG = SUM(OTHER_CHRG)      
 FROM BFOBILLVALAN, BFOOWNER WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'              
 GROUP BY BRANCH_CODE              
 ORDER BY BRANCH_CODE              
OPEN @@VALANAMTCUR               
FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,              
                @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG, @@OTHER_CHRG              
WHILE @@FETCH_STATUS = 0               
BEGIN               
 SELECT @@NETMTOM = @@NETMTOM + @@MTOM                    
 SELECT @@NETPREMIUM = @@NETPREMIUM + @@PREMIUM                    
 SELECT @@NETEXEASSIGN = @@NETEXEASSIGN + @@EXEASSIGN                     
 SELECT @@NETTURN_TAX = @@NETTURN_TAX + @@TURN_TAX                    
 SELECT @@NETSEBI_TAX = @@NETSEBI_TAX + @@SEBI_TAX                    
 SELECT @@NETBROKER_CHRG = @@NETBROKER_CHRG + @@BROKER_CHRG                     
 SELECT @@NETCL_CHRG = @@NETCL_CHRG + @@CL_CHRG                    
 SELECT @@NETEXCL_CHRG = @@NETEXCL_CHRG + @@EXCL_CHRG                    
 SELECT @@NETINSCHRG  = @@NETINSCHRG + @@INSCHRG                    
 SELECT @@NETOTHER_CHRG  = @@NETOTHER_CHRG + @@OTHER_CHRG      
 SELECT @@TSERVICE_TAX =  @@SERVICE_TAX                      
 SELECT @@TEXSERVICE_TAX =  @@EXSERVICE_TAX                       
                    
 SELECT @@TCESS_TAX = @@SERVICE_TAX - ROUND(( @@SERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG) ),2)                  
 SELECT @@TEDUCESS_TAX = ROUND(@@TCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)                  
 SELECT @@TCESS_TAX = @@TCESS_TAX - @@TEDUCESS_TAX                 
 SELECT @@TSERVICE_TAX = @@SERVICE_TAX - @@TCESS_TAX - @@TEDUCESS_TAX               
                      
 SELECT @@TEXCESS_TAX = @@TEXSERVICE_TAX - ROUND(( @@TEXSERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG)),2)         
 SELECT @@TEXEDUCESS_TAX = ROUND(@@TEXCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)     
 SELECT @@TEXCESS_TAX = @@TEXCESS_TAX - @@TEXEDUCESS_TAX                 
 SELECT @@TEXSERVICE_TAX = @@TEXSERVICE_TAX - @@TEXCESS_TAX - @@TEXEDUCESS_TAX         
                
 SELECT @@NETCESS_TAX = @@NETCESS_TAX + @@TCESS_TAX                  
 SELECT @@NETEDUCESS_TAX = @@NETEDUCESS_TAX + @@TEDUCESS_TAX                  
 SELECT @@NETEXCESS_TAX = @@NETEXCESS_TAX + @@TEXCESS_TAX                   
 SELECT @@NETEXEDUCESS_TAX = @@NETEXEDUCESS_TAX + @@TEXEDUCESS_TAX      
                       
    
 SELECT @@NETEXSERVICE_TAX = @@NETEXSERVICE_TAX + @@TEXSERVICE_TAX     
 SELECT @@NETSERVICE_TAX = @@NETSERVICE_TAX + @@TSERVICE_TAX                    
 SELECT @@TBROKERAGE = @@BROKERAGE                  
 SELECT @@NETBROKERAGE = @@NETBROKERAGE + @@TBROKERAGE                    
               
 IF @@MTOM > 0               
  SELECT @@SELL_BUY = 1                
 ELSE              
  SELECT @@SELL_BUY = 2              
    INSERT INTO BFOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@MTOM),2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')               
                  
 IF @@PREMIUM > 0               
  SELECT @@SELL_BUY = 1                
 ELSE              
  SELECT @@SELL_BUY = 2           
    INSERT INTO BFOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@PREMIUM),2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
              
 IF @@EXEASSIGN > 0               
  SELECT @@SELL_BUY = 1                
 ELSE              
  SELECT @@SELL_BUY = 2              
    INSERT INTO BFOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@EXEASSIGN),2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@TBROKERAGE,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@TSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
                
 INSERT INTO BFOACCBILL VALUES (@@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@TEXSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
              
 IF ROUND(@@TCESS_TAX,2) <> 0                     
 BEGIN                    
   INSERT INTO BFOACCBILL VALUES (@@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@TCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
 END                    
 IF ROUND(@@TEDUCESS_TAX,2) <> 0                     
 BEGIN                    
   INSERT INTO BFOACCBILL VALUES (@@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@TEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
 END                    
                    
                    
  IF ROUND(@@TEXCESS_TAX,2) <> 0                    
   BEGIN                    
    INSERT INTO BFOACCBILL VALUES (@@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@TEXCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')       
  END                    
  IF ROUND(@@TEXEDUCESS_TAX,2) <> 0                    
   BEGIN             
    INSERT INTO BFOACCBILL VALUES (@@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@TEXEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
  END                    
                    
            
 INSERT INTO BFOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@TURN_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')             
               
 INSERT INTO BFOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@SEBI_TAX,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@BROKER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@CL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
                
 INSERT INTO BFOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@EXCL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
            
            
 INSERT INTO BFOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@INSCHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
            
 INSERT INTO BFOACCBILL VALUES ( @@OTHER_CHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@OTHER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')            
              
 FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,              
                      @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG,@@OTHER_CHRG              
              
END              
CLOSE @@VALANAMTCUR              
DEALLOCATE @@VALANAMTCUR              
              
SELECT @@NETBROKSHARE = 0              
SELECT @@GROSSBROKSHARE = 0              
              
SET @@VALANAMTCUR = CURSOR FOR              
SELECT SB.SUB_BROKER,COM_PERC, BRANCH_CD, BROKERAGE = SUM(PBROKAMT+SBROKAMT)*COM_PERC/100              
FROM BFOBILLVALAN S, CLIENT2 C2,CLIENT1 C1,SUBBROKERS SB              
WHERE S.PARTY_CODE = C2.PARTY_CODE AND C1.CL_CODE = C2.CL_CODE               
AND C1.SUB_BROKER = SB.SUB_BROKER               
AND SB.COM_PERC > 0               
AND S.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'              
GROUP BY SB.SUB_BROKER,COM_PERC,BRANCH_CD              
ORDER BY SB.SUB_BROKER,BRANCH_CD              
OPEN @@VALANAMTCUR               
FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD,@@BROKSHARE              
WHILE @@FETCH_STATUS = 0                
BEGIN              
 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD              
 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0                
 BEGIN              
  SELECT @@NETBROKSHARE = @@NETBROKSHARE + @@BROKSHARE              
  SELECT @@GROSSBROKSHARE = @@GROSSBROKSHARE + @@BROKSHARE              
              
  INSERT INTO BFOACCBILL VALUES ( @@SUB_BROKER,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
               ROUND(@@BROKSHARE,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
                 
  FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD          
 END    
 /*            
INSERT INTO BFOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
       ROUND(@@NETBROKSHARE,2),0,0,0,0,0,0,0,0,0,0,0,@@BRANCH_CD,'BILL POSTED')              
 SELECT @@NETBROKSHARE = 0              
*/            
END              
              
SET @@VALANAMTCUR = CURSOR FOR              
 SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),BRANCHCD,SELL_BUY FROM BFOACCBILL WHERE        
 BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59' AND BRANCHCD <> 'ZZZ'              
 GROUP BY BRANCHCD,SELL_BUY               
 ORDER BY BRANCHCD,SELL_BUY              
OPEN @@VALANAMTCUR               
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY              
WHILE @@FETCH_STATUS = 0                
BEGIN              
 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD              
 SELECT @@NETDIFFAMT = 0              
 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0               
 BEGIN              
  IF @@SELL_BUY = 1               
  BEGIN              
   SELECT @@NETDIFFAMT = @@NETDIFFAMT + @@DIFFAMT              
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT              
  END               
  ELSE              
  BEGIN                                      
   SELECT @@NETDIFFAMT = @@NETDIFFAMT - @@DIFFAMT               
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT              
  END              
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY                
 END              
 IF @@NETDIFFAMT > 0               
  INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')              
 ELSE IF @@NETDIFFAMT < 0               
  INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')              
               
END              
CLOSE @@VALANAMTCUR              
DEALLOCATE @@VALANAMTCUR              
              
 IF @@NETMTOM > 0               
  SELECT @@SELL_BUY = 1                
 ELSE              
  SELECT @@SELL_BUY = 2              
    INSERT INTO BFOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@NETMTOM),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')               
                  
 IF @@NETPREMIUM > 0               
  SELECT @@SELL_BUY = 1                
 ELSE              
  SELECT @@SELL_BUY = 2              
    INSERT INTO BFOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@NETPREMIUM),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
 IF @@NETEXEASSIGN > 0               
  SELECT @@SELL_BUY = 1                
 ELSE              
  SELECT @@SELL_BUY = 2              
    INSERT INTO BFOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@NETEXEASSIGN),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETBROKERAGE,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')               
                
 IF ROUND(@@NETCESS_TAX,2) <> 0                 
  BEGIN                
   INSERT INTO BFOACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@NETCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')               
  END          
        
 IF ROUND(@@NETEDUCESS_TAX,2) <> 0                     
  BEGIN                    
   INSERT INTO BFOACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                   
         ROUND(@@NETEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')               
  END          
                  
 IF ROUND(@@NETEXCESS_TAX,2) <> 0                     
  BEGIN                    
   INSERT INTO BFOACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@NETEXCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')               
  END                    
        
 IF ROUND(@@NETEXEDUCESS_TAX,2) <> 0                     
  BEGIN                    
   INSERT INTO BFOACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@NETEXEDUCESS_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')               
  END                    
            
 INSERT INTO BFOACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETEXSERVICE_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETTURN_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
               
 INSERT INTO BFOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETSEBI_TAX,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETBROKER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
 INSERT INTO BFOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETCL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
                
 INSERT INTO BFOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@NETEXCL_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
 /*INSERT INTO BFOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(@@GROSSBROKSHARE,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
*/          
              
 INSERT INTO BFOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@NETINSCHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
      
 INSERT INTO BFOACCBILL VALUES ( @@OTHER_CHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,                    
         ROUND(@@NETOTHER_CHRG,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')      
            
SELECT @@OPPAMT = 0              
              
SET @@VALANAMTCUR = CURSOR FOR              
 SELECT OPPCODE,REVCODE,ACCODE FROM VALANACCOUNT WHERE REVERSED = 1               
 AND EFFDATE = (SELECT MIN(EFFDATE) FROM VALANACCOUNT              
 WHERE EFFDATE <= @SAUDA_DATE ) ORDER BY OPPCODE,REVCODE              
OPEN @@VALANAMTCUR               
FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE         
WHILE @@FETCH_STATUS =  0              
BEGIN              
 SELECT @@DUMMYOPPCODE = @@OPPCODE              
 WHILE @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0              
 BEGIN              
  SELECT @@REVAMT = 0              
  SELECT @@DUMMYREVCODE = @@REVCODE              
  WHILE @@DUMMYREVCODE = @@REVCODE AND @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0              
  BEGIN              
   SET @@VALANACCCUR = CURSOR FOR              
    SELECT AMOUNT,SELL_BUY FROM BFOACCBILL WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'              
    AND PARTY_CODE = @@ACCODE AND BRANCHCD = 'ZZZ'              
   OPEN @@VALANACCCUR               
   FETCH NEXT FROM @@VALANACCCUR INTO @@ACCAMT,@@SELL_BUY              
              
   IF @@FETCH_STATUS =  0              
   BEGIN              
    IF @@SELL_BUY = 1               
    BEGIN              
     SELECT @@REVAMT = @@REVAMT + @@ACCAMT              
     SELECT @@OPPAMT = @@OPPAMT + @@ACCAMT              
    END              
    ELSE              
    BEGIN              
     SELECT @@REVAMT = @@REVAMT - @@ACCAMT              
     SELECT @@OPPAMT = @@OPPAMT - @@ACCAMT              
    END              
   END              
   ELSE              
   CLOSE @@VALANACCCUR              
 DEALLOCATE @@VALANACCCUR              
   FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE               
  END              
  IF @@REVAMT > 0               
   INSERT INTO BFOACCBILL VALUES ( @@DUMMYREVCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
          ROUND(ABS(@@REVAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
  ELSE              
   INSERT INTO BFOACCBILL VALUES ( @@DUMMYREVCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
          ROUND(ABS(@@REVAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
 END               
 IF @@OPPAMT > 0              
  INSERT INTO BFOACCBILL VALUES ( @@DUMMYOPPCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@OPPAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')                
 ELSE              
  INSERT INTO BFOACCBILL VALUES ( @@DUMMYOPPCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
         ROUND(ABS(@@OPPAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
END              
CLOSE @@VALANAMTCUR              
DEALLOCATE @@VALANAMTCUR              
              
SELECT @@GROSSDIFFAMT = 0              
              
SET @@VALANAMTCUR = CURSOR FOR              
              
SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),SELL_BUY FROM BFOACCBILL A,ACCOUNTBFO.DBO.ACMAST M               
WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'              
AND A.PARTY_CODE = M.CLTCODE AND (BRANCHCD = 'ZZZ' OR ACCAT = 4 )              
GROUP BY SELL_BUY              
              
OPEN @@VALANAMTCUR               
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY              
WHILE @@FETCH_STATUS = 0                
BEGIN              
 BEGIN              
  IF @@SELL_BUY = 1               
  BEGIN                
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT              
  END                
  ELSE              
  BEGIN                                  
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT                       
  END              
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY              
 END              
END              
CLOSE @@VALANAMTCUR              
DEALLOCATE @@VALANAMTCUR              
    
IF @@GROSSDIFFAMT > 0               
 INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
ELSE               
 INSERT INTO BFOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,              
        ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','BILL POSTED')              
              
--DELETE FROM BFOACCBILL WHERE AMOUNT = 0 AND BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'              
        
--EXEC FOGENBILLNO @SAUDA_DATE              
  EXEC VALANGENERATE_CLCHRG @SAUDA_DATE    
/*---------------------------------- PROCESS CONTROLER PLUG IN START-------------------------------------*/       
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'VALANGEN','',@USERNAME,''  
    
/*---------------------------------- PROCESS CONTROLER PLUG IN END-------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOVALANPOP
-- --------------------------------------------------

--EXEC BFOVALANPOP 'OCT 31 2023', 'RP61', 'RP61'

CREATE PROC [dbo].[BFOVALANPOP]     
(    
  @SDATE VARCHAR(11),    
  @FPARTY VARCHAR(12) ='0',    
  @TPARTY VARCHAR(12) ='ZZZZZZZ'    
) AS         
        
--- Added on 25-08-2023 FOR BSEFO
--EXEC PROC_TOTTAX_SLAB @SDATE

UPDATE BFOSETTLEMENT   
SET SERIES_CODE = BFOSCRIP2.SERIES_CODE
FROM BFOSCRIP2 (NOLOCK)  
WHERE   
 BFOSCRIP2.PRODUCT_TYPE = BFOSETTLEMENT.PRODUCT_TYPE AND  
 BFOSCRIP2.PRODUCT_CODE = BFOSETTLEMENT.PRODUCT_CODE AND  
 BFOSCRIP2.EXPIRYDATE = BFOSETTLEMENT.EXPIRYDATE AND  
 BFOSCRIP2.STRIKE_PRICE = BFOSETTLEMENT.STRIKE_PRICE AND  
 BFOSCRIP2.OPTION_TYPE = BFOSETTLEMENT.OPTION_TYPE AND  
 BFOSCRIP2.SERIES_ID = BFOSETTLEMENT.SERIES_ID AND
 SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59' AND
 BFOSCRIP2.SERIES_CODE <> BFOSETTLEMENT.SERIES_CODE 
--- Added on 25-08-2023 FOR BSEFO
UPDATE  BFOCLOSING  
SET CLOSE_PRICE = SETTLEMENT_PRICE  
FROM BFOEXERCISEALLOCATION P  
WHERE TRADE_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'  
AND POSITION_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'  
AND BFOCLOSING.SERIES_CODE = P.SERIES_CODE  
-- AND PRODUCT_TYPE = P.PRODUCT_TYPE  
AND BFOCLOSING.PRODUCT_CODE = P.PRODUCT_CODE  
AND BFOCLOSING.ASSET_CODE = P.ASSET_CODE  
AND BFOCLOSING.EXPIRYDATE = P.EXPIRYDATE  
AND BFOCLOSING.STRIKE_PRICE = P.STRIKE_PRICE  
AND BFOCLOSING.OPTION_TYPE = P.OPTION_TYPE  
  
  
EXEC CALCULATE_STAMP_DUTY @SDATE  
  
  --- Added on 25-08-2023 FOR BSEFO
----------- for turn tax changes ----------
EXEC PROC_TURN_TAX_UPDATE_ADNL @SDATE, '0', 'ZZZZZZ'

EXEC PROC_TOTTAX_SLAB_SCRIP @SDATE
--- Added on 25-08-2023 FOR BSEFO

DELETE FROM TBL_MTOMPREMIUMBILL WHERE BILLDATE BETWEEN  @SDATE AND @SDATE + ' 23:59' AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY        
                    
SELECT * INTO #BFOCLOSING    
FROM  BFOCLOSING    
WHERE BFOCLOSING.TRADE_DATE = ( SELECT MAX(TRADE_DATE) FROM BFOCLOSING    
                    WHERE BFOCLOSING.TRADE_DATE < @SDATE)    
    
SELECT * INTO #BFOCLOSINGTODAY                   
FROM  BFOCLOSING                     
WHERE BFOCLOSING.TRADE_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'  
    
UPDATE BFOSETTLEMENT SET   
SERVICE_TAX = ((TRADEQTY*BROKAPPLIED)+  
       (CASE WHEN G.INSURANCE_CHRG_AC = 1 AND C2.INSURANCE_CHRG = 1   
      THEN BFOSETTLEMENT.INS_CHRG  
             ELSE 0   
        END)+  
       (CASE WHEN G.TURNOVER_AC = 1 AND C2.TURNOVER_TAX = 1   
      THEN BFOSETTLEMENT.TURN_TAX  
             ELSE 0   
        END)+  
       (CASE WHEN G.SEBI_TURN_AC = 1 AND C2.SEBI_TURN_TAX = 1   
      THEN BFOSETTLEMENT.SEBI_TAX  
             ELSE 0   
        END)+  
       (CASE WHEN G.BROKER_NOTE_AC = 1 AND C2.BROKERNOTE = 1   
      THEN BFOSETTLEMENT.BROKER_CHRG  
             ELSE 0   
        END)+  
       (CASE WHEN G.OTHER_CHRG_AC = 1 AND C2.OTHER_CHRG = 1  
      THEN BFOSETTLEMENT.OTHER_CHRG  
             ELSE 0   
        END)) * G.SERVICE_TAX /100  
FROM BFOGLOBALS G, CLIENT2 C2  
WHERE   
 SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'  AND  
 SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND  
 BFOSETTLEMENT.PARTY_CODE = C2.PARTY_CODE AND  
 1 <> (CASE WHEN SERVICE_CHRG = 1 AND SERTAXMETHOD = 1   
        THEN 1 ELSE 0 END)  
		

  
INSERT INTO TBL_MTOMPREMIUMBILL                    
SELECT BILLDATE =@SDATE + ' 23:59:00' ,                    
PQTY = SUM(CASE WHEN S.SELL_BUY = 1                    
   THEN (S.TRADEQTY)                    
             ELSE 0                    
        END),                    
SQTY = SUM(CASE WHEN S.SELL_BUY = 2                    
             THEN (S.TRADEQTY)                    
             ELSE 0                     
        END )  ,                    
NETRATE = ISNULL(( SELECT DISTINCT     
    BFOCLOSING.CLOSE_PRICE     
   FROM     
    #BFOCLOSING BFOCLOSING    
   WHERE    
    BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE    
                ),0),    
CL_RATE  = ISNULL(( SELECT     
    BFOCLOSING.CLOSE_PRICE     
   FROM     
    #BFOCLOSINGTODAY BFOCLOSING    
   WHERE    
    BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE     
                ),0),    
S.PARTY_CODE,    
S.PRODUCT_TYPE,  
S.PRODUCT_CODE,  
S.ASSET_CODE,  
S.EXPIRYDATE,  
S.STRIKE_PRICE,  
S.OPTION_TYPE,  
S.SERIES_CODE,  
S.SERIES_ID,  
S.LOT_SIZE,  
SDATE = @SDATE,                    
SELL_BUY ,                    
SERVICE_TAX=0,                    
BROK= 0,                    
NONEXPIRYSERVICE_TAX=0,                  
NONEXPIRYBROK = 0,                    
SEBI_TAX=0,TURN_TAX=0,STAMPDUTY=0,                    
INEX_SERVICE_TAX=0,                    
INEX_SEBI_TAX=0,                    
INEX_TURN_TAX=0,                    
INEX_STAMPDUTY=0,                    
EXPIRYBROK= 0,                    
EXPIRYSERVICE_TAX= 0,                    
INSURANCE_CHRG = 0,                    
INEX_INSURANCE_CHRG = 0,                    
OTHER_CHRG = 0,                    
INEX_OTHER_CHRG = 0,                    
AUCTIONPART = '',                    
NETWITHBROK  = ISNULL(( SELECT DISTINCT     
    BFOCLOSING.CLOSE_PRICE  
   FROM     
    #BFOCLOSING BFOCLOSING    
   WHERE    
    BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE   
                ),0),    
BFDAYFLAG = 'B-F',                    
S.RESERVED1 ,                    
ACTBUYQTY = SUM(  CASE WHEN S.SELL_BUY = 1                    
               THEN                      
                  (S.TRADEQTY)                    
            ELSE                    
               0                     
             END                     
),                    
ACTSELLQTY = SUM( CASE WHEN S.SELL_BUY = 2                    
               THEN                     
    (S.TRADEQTY)         
   ELSE                    
  0                     
           END )                    
FROM BFOSETTLEMENT S,  BFOSCRIP2                     
WHERE     
 SAUDA_DATE < @SDATE                    
 AND BFOSCRIP2.PRODUCT_TYPE = S.PRODUCT_TYPE    
 AND BFOSCRIP2.PRODUCT_CODE = S.PRODUCT_CODE    
 AND BFOSCRIP2.SERIES_CODE = S.SERIES_CODE    
 AND BFOSCRIP2.SERIES_ID = S.SERIES_ID    
 AND BFOSCRIP2.EXPIRYDATE = S.EXPIRYDATE    
 AND BFOSCRIP2.STRIKE_PRICE = S.STRIKE_PRICE    
 AND BFOSCRIP2.OPTION_TYPE = S.OPTION_TYPE   
 AND BFOSCRIP2.MATURITYDATE >= @SDATE       
GROUP BY  
 S.PARTY_CODE,  
S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,  
S.STRIKE_PRICE,S.OPTION_TYPE,S.SERIES_CODE,  
S.SERIES_ID,S.LOT_SIZE,  
  
SELL_BUY,CONVERT(VARCHAR,S.EXPIRYDATE,103),    
 S.EXPIRYDATE,BFOSCRIP2.MATURITYDATE,S.RESERVED1                   
                  
    
SELECT  CONTRACTNO,BILLNO=LOT_SIZE,TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),    
 PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,  
 STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,TRADEQTY,AUCTIONPART,    
 TRADE_PRICE,SAUDA_DATE,SELL_BUY,NETRATE,    
 INS_CHRG=SUM(INS_CHRG),TURN_TAX=SUM(TURN_TAX),    
 OTHER_CHRG=SUM(OTHER_CHRG),SEBI_TAX=SUM(SEBI_TAX),BROKER_CHRG=SUM(BROKER_CHRG),    
 SERVICE_TAX=SUM(SERVICE_TAX),PARTICIPANTCODE,    
 TOTALBROK = SUM(BROKAPPLIED * TRADEQTY),    
 RESERVED1    
INTO #BFOSETTLEMENT     
FROM    
 BFOSETTLEMENT     
WHERE     
 SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
 AND TRADEQTY * TRADE_PRICE > 0    
GROUP BY    
 CONTRACTNO,PRADNYA.DBO.REPLACETRADENO(TRADE_NO),    
 PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,  
 STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,  
 TRADEQTY,AUCTIONPART,LOT_SIZE,  
 TRADE_PRICE,SAUDA_DATE,SELL_BUY,NETRATE,    
 PARTICIPANTCODE,RESERVED1    
    
UPDATE    
 #BFOSETTLEMENT    
SET     
 TOTALBROK = CD_TOT_BROK,     
 SERVICE_TAX = SERVICE_TAX+CD_TOT_SERTAX    
FROM    
 CHARGES_DETAIL    
WHERE    
 LEFT(CD_SAUDA_DATE,11) = @SDATE    
 AND LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE    
 AND CD_PRODUCT_CODE = PRODUCT_CODE    
 AND CD_SERIES_CODE = SERIES_CODE    
 AND CD_SERIES_ID = SERIES_ID    
 AND CD_TRADE_NO = TRADE_NO    
    

    
INSERT INTO TBL_MTOMPREMIUMBILL                    
SELECT BILLDATE = @SDATE + ' 23:59:00' ,                    
PQTY = SUM(  CASE WHEN S.SELL_BUY = 1                    
               THEN                      
               (S.TRADEQTY)                     
            ELSE                    
               0                     
             END    
),    
SQTY = SUM( CASE WHEN S.SELL_BUY = 2                    
               THEN                     
                   (S.TRADEQTY)                    
             ELSE                    
              0                     
                END ) ,    
ISNULL(S.TRADE_PRICE,0),                    
CL_RATE  = ISNULL(( SELECT DISTINCT    
    BFOCLOSING.CLOSE_PRICE    
   FROM     
    #BFOCLOSINGTODAY BFOCLOSING    
   WHERE    
   BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE   
                ),0),    
S.PARTY_CODE,                    
S.PRODUCT_TYPE,  
S.PRODUCT_CODE,  
S.ASSET_CODE,  
S.EXPIRYDATE,  
S.STRIKE_PRICE,  
S.OPTION_TYPE,  
S.SERIES_CODE,  
S.SERIES_ID,  
S.LOT_SIZE,  
SDATE=@SDATE,                    
SELL_BUY= CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END) > SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END)  
   THEN 1 ELSE 2 END,    
SERVICE_TAX=(CASE WHEN (C2.SERVICE_CHRG=1 OR  C2.SERVICE_CHRG=0) THEN                    
                                    SUM(SERVICE_TAX)                     
                          ELSE                    
                 0                    
                       END),                    
                    
BROK=  SUM(TOTALBROK),                    
                    
NONEXPIRYSERVICE_TAX=(CASE WHEN (C2.SERVICE_CHRG=1 OR  C2.SERVICE_CHRG=0) THEN                    
                              SUM(SERVICE_TAX)                     
                          ELSE                    
                             0                    
                       END),                    
                    
NONEXPIRYBROK= SUM(TOTALBROK),                    
                    
SEBI_TAX=(CASE WHEN ( C2.SEBI_TURN_TAX=1 ) THEN                    
                 ISNULL(SUM(S.SEBI_TAX),0)                      
             ELSE                    
                0                      
           END ) ,                    
TURN_TAX=(CASE WHEN( C2.TURNOVER_TAX=1) THEN                    
  ISNULL(SUM(S.TURN_TAX),0)                    
 ELSE 0                     
 END ),                    
STAMPDUTY=(CASE WHEN( C2.BROKERNOTE=1) THEN                    
                    SUM(S.BROKER_CHRG)             
             ELSE                    
                0                      
           END ) ,                    
INEX_SERVICE_TAX=(CASE WHEN C2.SERVICE_CHRG=2 THEN                    
  ISNULL(SUM(SERVICE_TAX),0)                     
             ELSE                    
                0                      
           END ),                    
INEX_SEBI_TAX=(CASE WHEN C2.SEBI_TURN_TAX=1 THEN                    
                 ISNULL(SUM(S.SEBI_TAX),0)                      
             ELSE                    
                0                      
           END ),                    
INEX_TURN_TAX=(CASE WHEN C2.TURNOVER_TAX=1 THEN                    
                 ISNULL(SUM(S.TURN_TAX),0)                    
             ELSE                    
                0                      
           END ),                    
INEX_STAMPDUTY=(CASE WHEN C2.BROKERNOTE=1 THEN                    
                    SUM(S.BROKER_CHRG)                    
             ELSE                    
                0                      
           END ),                    
                    
EXPIRYBROK= SUM(ABS(SERVICE_TAX)*TRADEQTY),                    
EXPIRYSERVICE_TAX=(CASE WHEN (C2.SERVICE_CHRG=1 OR  C2.SERVICE_CHRG=0) THEN                    
                                    ISNULL(SUM( SERVICE_TAX  ),0)                     
                          ELSE                    
                             0   
                       END),                    
INSURANCE_CHRG=(CASE WHEN( C2.INSURANCE_CHRG=1) THEN                    
                    SUM(S.INS_CHRG)                    
             ELSE                    
                0                      
           END ) ,                    
INEX_INSURANCE_CHRG=(CASE WHEN C2.INSURANCE_CHRG=1 THEN                    
                    SUM(S.INS_CHRG)                    
          ELSE                    
                0                      
END ),        
          
OTHER_CHRG=(CASE WHEN( C2.OTHER_CHRG=1) THEN                    
           SUM(S.OTHER_CHRG)           
 ELSE                    
           0                      
        END ) ,                    
INEX_OTHER_CHRG=(CASE WHEN C2.OTHER_CHRG=1 THEN                    
            SUM(S.OTHER_CHRG)                    
         ELSE                    
              0                      
         END ),                    
AUCTIONPART = S.AUCTIONPART,                    
NETWITHBROK = S.NETRATE,                    
BFDAYFLAG = '',                    
S.RESERVED1  ,                    
ACTBUYQTY = SUM(  CASE WHEN S.SELL_BUY = 1                    
               THEN                      
                  (S.TRADEQTY)                    
            ELSE                    
               0                     
             END                     
),                    
ACTSELLQTY = SUM( CASE WHEN S.SELL_BUY = 2                    
               THEN                     
                           (S.TRADEQTY)                     
   ELSE                    
  0                     
                END )    
FROM CLIENT2 C2, #BFOSETTLEMENT S , BFOSCRIP2                    
WHERE     
 SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
 AND BFOSCRIP2.PRODUCT_TYPE = S.PRODUCT_TYPE    
 AND BFOSCRIP2.PRODUCT_CODE = S.PRODUCT_CODE    
 AND BFOSCRIP2.SERIES_CODE = S.SERIES_CODE    
 AND BFOSCRIP2.SERIES_ID = S.SERIES_ID    
 AND BFOSCRIP2.EXPIRYDATE = S.EXPIRYDATE    
 AND BFOSCRIP2.STRIKE_PRICE = S.STRIKE_PRICE    
 AND BFOSCRIP2.OPTION_TYPE = S.OPTION_TYPE   
 AND S.PARTY_CODE=C2.PARTY_CODE      
GROUP BY     
S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,  
S.STRIKE_PRICE,S.OPTION_TYPE,S.SERIES_CODE,  
S.SERIES_ID,S.LOT_SIZE,SEBI_TAX,S.EXPIRYDATE,S.TRADE_PRICE,   
C2.SERVICE_CHRG,C2.SEBI_TURN_TAX,C2.TURNOVER_TAX,C2.BROKERNOTE,S.RESERVED1,    
C2.INSURANCE_CHRG,C2.OTHER_CHRG,S.AUCTIONPART,BFOSCRIP2.MATURITYDATE,  
NETRATE                 
  
    
/*=========================================================================================*/    
DELETE FROM BFOBILLVALAN WHERE SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59' AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY        
        
/* BROUGHT FORWARD TRADES */          
INSERT INTO BFOBILLVALAN         
SELECT S.PARTY_CODE,LONG_NAME=LEFT(LONG_NAME,50),CLIENT_TYPE=C1.CL_TYPE,BILLNO=S.LOT_SIZE,0 CONTRACTNO,  
S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,        
'0' AUCTIONPART,F.MATURITYDATE,SAUDA_DATE=@SDATE + ' 23:59',        
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END),                 
SQTY=SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END),        
PRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END ),4),        
SRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END),4) ,          
PAMT =ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*NETRATE) + (CASE WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END) ELSE 0 END),4),         
SAMT =ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*NETRATE) + (CASE WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END) ELSE 0 END),4),   
PBROKAMT=0, SBROKAMT=0, PBILLAMT=0, SBILLAMT=0, CL_RATE = 0,CL_CHRG=0,EXCL_CHRG=0,SERVICE_TAX=0,EXSER_TAX=0,INEXSERFLAG=SERVICE_CHRG,        
SEBI_TAX=0,TURN_TAX=0,BROKER_NOTE=0,INS_CHRG=0,OTHER_CHRG=0,TRADETYPE='BF',PARTICIPANTCODE=MEMBERCODE,       
FAMILY,FAMILYNAME='',TRADER,BRANCH_CODE=C1.BRANCH_CD,SUB_BROKER,        
REGION=C1.REGION,UPDATEDATE=GETDATE(),C1.EMAIL,C1.AREA        
FROM BFOSCRIP2 F,BFOSETTLEMENT S, BFOOWNER, CLIENT1 C1, CLIENT2 C2           
WHERE           
 SAUDA_DATE < @SDATE   
 AND F.PRODUCT_TYPE = S.PRODUCT_TYPE    
 AND F.PRODUCT_CODE = S.PRODUCT_CODE    
 AND F.SERIES_CODE = S.SERIES_CODE    
 AND F.SERIES_ID = S.SERIES_ID    
 AND F.EXPIRYDATE = S.EXPIRYDATE    
 AND F.STRIKE_PRICE = S.STRIKE_PRICE    
 AND F.OPTION_TYPE = S.OPTION_TYPE   
 AND F.MATURITYDATE >= @SDATE         
 AND S.PARTY_CODE BETWEEN @FPARTY AND  @TPARTY        
 AND S.PARTY_CODE = C2.PARTY_CODE   
 AND C2.CL_CODE = C1.CL_CODE AND S.RESERVED1<>1
 ---Added on 25-08-2023 For BSEFO        
AND F.SERIES_CODE  IN (SELECT B_SYMBOL FROM TBL_FOSCRIPMAP M, BFOOWNER B 
                                                                                                WHERE  S.PARTICIPANTCODE = B.MEMBERCODE
                                                                                                AND B_SYMBOL = F.SERIES_CODE 
                                                                                                AND B_EXPIRYDATE = F.EXPIRYDATE
                                                                                                AND B_STRIKE_PRICE = F.STRIKE_PRICE
                                                                                                AND B_OPTION_TYPE = F.OPTION_TYPE AND N_SYMBOL <>'')   
---Added on 25-08-2023 For BSEFO												
GROUP BY S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,MATURITYDATE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,LONG_NAME,C1.CL_TYPE,SERVICE_CHRG,PARTICIPANTCODE,FAMILY,  
TRADER,C1.BRANCH_CD,SUB_BROKER,MEMBERTYPE,MEMBERCODE,S.SERIES_CODE,S.SERIES_ID,C1.AREA,C1.REGION,C1.EMAIL   
HAVING SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) <> SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END)         
        
/* BROUGHT FORWARD TRADES */          
        
/* TODAYS TRADE */          
        
INSERT INTO BFOBILLVALAN        
SELECT S.PARTY_CODE,LONG_NAME=LEFT(LONG_NAME,50),CLIENT_TYPE=C1.CL_TYPE,BILLNO=S.LOT_SIZE,CONTRACTNO,  
S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,        
S.AUCTIONPART,F.MATURITYDATE,SAUDA_DATE=@SDATE + ' 23:59',  
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END),          
SQTY=SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END),          
PRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END ),4),        
SRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END),4) ,          
PAMT =ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*(TRADE_PRICE+BROKAPPLIED)) ELSE 0 END),4),         
SAMT =ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*(TRADE_PRICE-BROKAPPLIED)) ELSE 0 END),4),        
PBROKAMT =ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*BROKAPPLIED) ELSE 0 END),4),         
SBROKAMT =ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*BROKAPPLIED) ELSE 0 END),4),         
PBILLAMT= ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*(TRADE_PRICE+BROKAPPLIED)) ELSE 0 END),4),         
SBILLAMT= ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*(TRADE_PRICE-BROKAPPLIED)) ELSE 0 END),4),        
CL_RATE = 0, CL_CHRG=0,EXCL_CHRG=0,SERVICE_TAX=SUM(SERVICE_TAX),        
EXSER_TAX=(CASE WHEN C2.SERVICE_CHRG = 2 THEN SUM(SERVICE_TAX) ELSE 0 END ),        
INEXSERFLAG=SERVICE_CHRG,        
SEBI_TAX=(CASE WHEN SEBI_TURN_TAX = 1 THEN SUM(SEBI_TAX) ELSE 0 END),          
TURN_TAX=(CASE WHEN C2.TURNOVER_TAX = 1 THEN SUM(TURN_TAX) ELSE 0 END),          
BROKER_NOTE=(CASE WHEN BROKERNOTE = 1 THEN SUM(BROKER_CHRG) ELSE 0 END),        
INS_CHRG=(CASE WHEN C2.INSURANCE_CHRG=1 THEN SUM(INS_CHRG) ELSE  0 END ),        
OTHER_CHRG=(CASE WHEN C2.OTHER_CHRG=1 THEN SUM(S.OTHER_CHRG) ELSE  0 END ),        
TRADETYPE='BT',        
PARTICIPANTCODE=(CASE WHEN S.RESERVED1 = 1 THEN PARTICIPANTCODE ELSE MEMBERCODE END),        
FAMILY,FAMILYNAME='',TRADER,BRANCH_CODE=C1.BRANCH_CD,SUB_BROKER,      
REGION=C1.REGION,UPDATEDATE=GETDATE(),        
C1.EMAIL,C1.AREA    
FROM BFOSCRIP2 F,BFOSETTLEMENT S, BFOOWNER, CLIENT1 C1, CLIENT2 C2           
WHERE SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'         
		AND F.PRODUCT_TYPE = S.PRODUCT_TYPE  --Added ON 25-08-2023 FOR BSEFO
                AND F.PRODUCT_CODE = S.PRODUCT_CODE  --Added ON 25-08-2023 FOR BSEFO
     		AND F.SERIES_CODE=S.SERIES_CODE        
		AND F.SERIES_ID = S.SERIES_ID  --Added ON 25-08-2023 FOR BSEFO
                AND F.EXPIRYDATE = S.EXPIRYDATE  --Added ON 25-08-2023 FOR BSEFO
                AND F.STRIKE_PRICE = S.STRIKE_PRICE  --Added ON 25-08-2023 FOR BSEFO
                AND F.OPTION_TYPE = S.OPTION_TYPE --Added ON 25-08-2023 FOR BSEFO
     		AND F.MATURITYDATE >= @SDATE           
     		AND S.PARTY_CODE BETWEEN @FPARTY AND  @TPARTY  
     		AND S.PARTY_CODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE AND TRADEQTY > 0         
GROUP BY S.PARTY_CODE,S.PRODUCT_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,LONG_NAME,C1.CL_TYPE,CONTRACTNO,AUCTIONPART,SERVICE_CHRG,  
PARTICIPANTCODE,FAMILY,TRADER,C1.BRANCH_CD,SUB_BROKER,MATURITYDATE,   
MEMBERTYPE,SEBI_TURN_TAX,C2.OTHER_CHRG,C2.TURNOVER_TAX,BROKERNOTE,MEMBERCODE,S.RESERVED1,S.SERIES_CODE  ,  
INSURANCE_CHRG ,C1.AREA,C1.REGION,C1.EMAIL  
        
INSERT INTO BFOBILLVALAN       
SELECT    
PARTY_CODE=CD_PARTY_CODE,LONG_NAME=LEFT(C1.LONG_NAME,50),CLIENT_TYPE=CL_TYPE,BILLNO=0,    
CONTRACTNO=CD_CONTRACT_NO,    
CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_ASSET_CODE,CD_EXPIRYDATE,CD_STRIKE_PRICE,  
CD_OPTION_TYPE,CD_SERIES_CODE,CD_SERIES_ID,CD_LOT_SIZE,        
AUCTIONPART=CD_AUCTIONPART,    
 ISNULL(F.MATURITYDATE,'1900-01-01'),SAUDA_DATE=CD_SAUDA_DATE +' 23:59',   
 PQTY=0,    
 SQTY=0,    
 PRATE=0,    
 SRATE=0,    
 PAMT=0,    
 SAMT=0,    
 PBROKAMT=SUM(CD_TOT_BUYBROK),    
 SBROKAMT=SUM(CD_TOT_SELLBROK),    
 PBILLAMT=SUM(CD_TOT_BUYBROK+CD_TOT_SELLBROK),    
 SBILLAMT=SUM(0),    
 CL_RATE = 0, CL_CHRG=0,EXCL_CHRG=0,    
 SERVICE_TAX = SUM(CD_TOT_SERTAX),    
 EXSER_TAX=(CASE WHEN C2.SERVICE_CHRG = 2 THEN SUM(CD_TOT_SERTAX) ELSE 0 END ),                    
 INEXSERFLAG=SERVICE_CHRG,       
 SEBI_TAX=0,    
 TURN_TAX =0,    
 BROKER_CHRG =0,    
 INS_CHRG = 0,    
 OTHER_CHRG = 0,    
 TRADETYPE='BT',PARTICIPANTCODE=MEMBERCODE,    
 FAMILY,FAMILYNAME='',TRADER,BRANCH_CODE=BRANCH_CD,SUB_BROKER,  
 REGION,UPDATEDATE= GETDATE(),                    
 EMAIL=C1.EMAIL,C1.AREA    
FROM CHARGES_DETAIL S LEFT OUTER JOIN BFOSCRIP2 F    
ON (F.PRODUCT_TYPE = S.CD_PRODUCT_TYPE    
 AND F.PRODUCT_CODE = S.CD_PRODUCT_CODE    
 AND F.SERIES_CODE = S.CD_SERIES_CODE    
 AND F.SERIES_ID = S.CD_SERIES_ID    
 AND F.EXPIRYDATE = CD_EXPIRYDATE  
 --AND F.STRIKE_PRICE = STRIKE_PRICE  
 --AND F.OPTION_TYPE = OPTION_TYPE  
 AND F.STRIKE_PRICE = CD_STRIKE_PRICE --Added ON 25-08-2023 FOR BSEFO
 AND F.OPTION_TYPE = CD_OPTION_TYPE --Added ON 25-08-2023 FOR BSEFO
 ),  
CLIENT1 C1, CLIENT2 C2, BFOOWNER    
WHERE     
 S.CD_SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'      
 AND S.CD_PARTY_CODE = C2.PARTY_CODE    
 AND C1.CL_CODE = C2.CL_CODE    
     
GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,CD_ASSET_CODE,CD_STRIKE_PRICE,  
 CD_OPTION_TYPE,CD_LOT_SIZE,CD_AUCTIONPART, C1.AREA,LEFT(C1.LONG_NAME,50),C1.CL_TYPE,F.MATURITYDATE,C2.SERVICE_CHRG,C1.FAMILY,    
 C1.TRADER,C1.BRANCH_CD,C1.SUB_BROKER,BFOOWNER.MEMBERTYPE,C1.REGION,C1.EMAIL,    
 MEMBERCODE         
    
  
/* TODAYS TRADE */            
--EXEC PR_CUT_CHRGS_FROM_BROK @SDATE
      
UPDATE BFOBILLVALAN SET EXCL_CHRG = CL_CHRG FROM BFOOWNER         
WHERE ( CLRGCHG = 1 AND CHMCLCHRG = 1 ) OR ( CLRGCHG = 4 AND CHMCLCHRG = 1 )         
OR ( CLRGCHG = 2 AND CHMCLCHRG = 0 )  OR ( CLRGCHG = 0 AND CHMCLCHRG = 0 )         
AND BFOBILLVALAN.TRADETYPE = 'BT'        
AND BFOBILLVALAN.PARTY_CODE >= @FPARTY  AND BFOBILLVALAN.PARTY_CODE <= @TPARTY        
AND BFOBILLVALAN.SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
        
UPDATE BFOBILLVALAN SET PBILLAMT=PQTY*BFOCLOSING.CLOSE_PRICE,SBILLAMT=SQTY*BFOCLOSING.CLOSE_PRICE,        
PAMT=PQTY*BFOCLOSING.CLOSE_PRICE,SAMT=SQTY*BFOCLOSING.CLOSE_PRICE        
FROM BFOCLOSING WHERE BFOCLOSING.TRADE_DATE = ( SELECT MAX(TRADE_DATE) FROM BFOCLOSING           
                   WHERE BFOCLOSING.TRADE_DATE < @SDATE )           
--AND BFOCLOSING.PRODUCT_TYPE = BFOBILLVALAN.PRODUCT_TYPE    
AND BFOCLOSING.PRODUCT_CODE = BFOBILLVALAN.PRODUCT_CODE    
AND BFOCLOSING.SERIES_CODE = BFOBILLVALAN.SERIES_CODE    
AND BFOCLOSING.SERIES_ID = BFOBILLVALAN.SERIES_ID    
AND BFOCLOSING.EXPIRYDATE = BFOBILLVALAN.EXPIRYDATE    
AND BFOCLOSING.STRIKE_PRICE = BFOBILLVALAN.STRIKE_PRICE    
AND BFOCLOSING.OPTION_TYPE = BFOBILLVALAN.OPTION_TYPE  
AND BFOBILLVALAN.TRADETYPE = 'BF'         
AND BFOBILLVALAN.SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
AND BFOBILLVALAN.PARTY_CODE >= @FPARTY  AND BFOBILLVALAN.PARTY_CODE <= @TPARTY        
AND RIGHT(BFOBILLVALAN.PRODUCT_CODE, 3) = 'FUT'    
  
UPDATE BFOBILLVALAN SET CL_RATE = BFOCLOSING.CLOSE_PRICE FROM BFOCLOSING          
WHERE BFOCLOSING.TRADE_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
--AND BFOCLOSING.PRODUCT_TYPE = BFOBILLVALAN.PRODUCT_TYPE    
AND BFOCLOSING.PRODUCT_CODE = BFOBILLVALAN.PRODUCT_CODE    
AND BFOCLOSING.SERIES_CODE = BFOBILLVALAN.SERIES_CODE    
AND BFOCLOSING.SERIES_ID = BFOBILLVALAN.SERIES_ID    
AND BFOCLOSING.EXPIRYDATE = BFOBILLVALAN.EXPIRYDATE    
AND BFOCLOSING.STRIKE_PRICE = BFOBILLVALAN.STRIKE_PRICE    
AND BFOCLOSING.OPTION_TYPE = BFOBILLVALAN.OPTION_TYPE  
AND BFOBILLVALAN.SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
AND BFOBILLVALAN.PARTY_CODE >= @FPARTY  AND BFOBILLVALAN.PARTY_CODE <= @TPARTY        
  
  
UPDATE BFOBILLVALAN SET         
PBILLAMT= (CASE WHEN PARTICIPANTCODE = MEMBERCODE         
  THEN (CASE WHEN PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT > 0         
              THEN PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT         
                           ELSE 0 END)        
        ELSE PBROKAMT END),        
SBILLAMT= (CASE WHEN PARTICIPANTCODE = MEMBERCODE         
         THEN (CASE WHEN PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT < 0         
                           THEN ABS(PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT)         
                    ELSE 0 END)        
        ELSE SBROKAMT END)        
FROM BFOOWNER WHERE SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'  
AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY     
AND RIGHT(PRODUCT_CODE, 3) = 'FUT'      
  
--Added ON 25-08-2023 FOR BSEFO
UPDATE BFOBILLVALAN        
    SET    PBILLAMT = PBROKAMT,      
           SBILLAMT = SBROKAMT       
FROM BFOOWNER WHERE SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'
AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY   
AND RIGHT(PRODUCT_CODE, 3) = 'OPT'
AND PARTICIPANTCODE <> MEMBERCODE
--Added ON 25-08-2023 FOR BSEFO

UPDATE BFOBILLVALAN SET FAMILYNAME = LEFT(C1.LONG_NAME,50) FROM CLIENT1 C1, CLIENT2 C2        
WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = BFOBILLVALAN.FAMILY         
        
UPDATE BFOBILLVALAN SET EMAIL = (CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END) 
FROM CLIENT1 C1, CLIENT2 C2        
WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = BFOBILLVALAN.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOVALANPOP_BAK_11082023
-- --------------------------------------------------

  
CREATE PROC [dbo].[BFOVALANPOP_BAK_11082023]     
(    
  @SDATE VARCHAR(11),    
  @FPARTY VARCHAR(12) ='0',    
  @TPARTY VARCHAR(12) ='ZZZZZZZ'    
) AS         
        
UPDATE  BFOCLOSING  
SET CLOSE_PRICE = SETTLEMENT_PRICE  
FROM BFOEXERCISEALLOCATION P  
WHERE TRADE_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'  
AND POSITION_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'  
AND BFOCLOSING.SERIES_CODE = P.SERIES_CODE  
-- AND PRODUCT_TYPE = P.PRODUCT_TYPE  
AND BFOCLOSING.PRODUCT_CODE = P.PRODUCT_CODE  
AND BFOCLOSING.ASSET_CODE = P.ASSET_CODE  
AND BFOCLOSING.EXPIRYDATE = P.EXPIRYDATE  
AND BFOCLOSING.STRIKE_PRICE = P.STRIKE_PRICE  
AND BFOCLOSING.OPTION_TYPE = P.OPTION_TYPE  
  
  
EXEC CALCULATE_STAMP_DUTY @SDATE  
  
DELETE FROM TBL_MTOMPREMIUMBILL WHERE BILLDATE BETWEEN  @SDATE AND @SDATE + ' 23:59' AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY        
                    
SELECT * INTO #BFOCLOSING    
FROM  BFOCLOSING    
WHERE BFOCLOSING.TRADE_DATE = ( SELECT MAX(TRADE_DATE) FROM BFOCLOSING    
                    WHERE BFOCLOSING.TRADE_DATE < @SDATE)    
    
SELECT * INTO #BFOCLOSINGTODAY                   
FROM  BFOCLOSING                     
WHERE BFOCLOSING.TRADE_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'  
    
UPDATE BFOSETTLEMENT SET   
SERVICE_TAX = ((TRADEQTY*BROKAPPLIED)+  
       (CASE WHEN G.INSURANCE_CHRG_AC = 1 AND C2.INSURANCE_CHRG = 1   
      THEN BFOSETTLEMENT.INS_CHRG  
             ELSE 0   
        END)+  
       (CASE WHEN G.TURNOVER_AC = 1 AND C2.TURNOVER_TAX = 1   
      THEN BFOSETTLEMENT.TURN_TAX  
             ELSE 0   
        END)+  
       (CASE WHEN G.SEBI_TURN_AC = 1 AND C2.SEBI_TURN_TAX = 1   
      THEN BFOSETTLEMENT.SEBI_TAX  
             ELSE 0   
        END)+  
       (CASE WHEN G.BROKER_NOTE_AC = 1 AND C2.BROKERNOTE = 1   
      THEN BFOSETTLEMENT.BROKER_CHRG  
             ELSE 0   
        END)+  
       (CASE WHEN G.OTHER_CHRG_AC = 1 AND C2.OTHER_CHRG = 1  
      THEN BFOSETTLEMENT.OTHER_CHRG  
             ELSE 0   
        END)) * G.SERVICE_TAX /100  
FROM BFOGLOBALS G, CLIENT2 C2  
WHERE   
 SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'  AND  
 SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND  
 BFOSETTLEMENT.PARTY_CODE = C2.PARTY_CODE AND  
 1 <> (CASE WHEN SERVICE_CHRG = 1 AND SERTAXMETHOD = 1   
        THEN 1 ELSE 0 END)   
  
INSERT INTO TBL_MTOMPREMIUMBILL                    
SELECT BILLDATE =@SDATE + ' 23:59:00' ,                    
PQTY = SUM(CASE WHEN S.SELL_BUY = 1                    
   THEN (S.TRADEQTY)                    
             ELSE 0                    
        END),                    
SQTY = SUM(CASE WHEN S.SELL_BUY = 2                    
             THEN (S.TRADEQTY)                    
             ELSE 0                     
        END )  ,                    
NETRATE = ISNULL(( SELECT     
    BFOCLOSING.CLOSE_PRICE     
   FROM     
    #BFOCLOSING BFOCLOSING    
   WHERE    
    BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE    
                ),0),    
CL_RATE  = ISNULL(( SELECT     
    BFOCLOSING.CLOSE_PRICE     
   FROM     
    #BFOCLOSINGTODAY BFOCLOSING    
   WHERE    
    BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE     
                ),0),    
S.PARTY_CODE,    
S.PRODUCT_TYPE,  
S.PRODUCT_CODE,  
S.ASSET_CODE,  
S.EXPIRYDATE,  
S.STRIKE_PRICE,  
S.OPTION_TYPE,  
S.SERIES_CODE,  
S.SERIES_ID,  
S.LOT_SIZE,  
SDATE = @SDATE,                    
SELL_BUY ,                    
SERVICE_TAX=0,                    
BROK= 0,                    
NONEXPIRYSERVICE_TAX=0,                  
NONEXPIRYBROK = 0,                    
SEBI_TAX=0,TURN_TAX=0,STAMPDUTY=0,                    
INEX_SERVICE_TAX=0,                    
INEX_SEBI_TAX=0,                    
INEX_TURN_TAX=0,                    
INEX_STAMPDUTY=0,                    
EXPIRYBROK= 0,                    
EXPIRYSERVICE_TAX= 0,                    
INSURANCE_CHRG = 0,                    
INEX_INSURANCE_CHRG = 0,                    
OTHER_CHRG = 0,                    
INEX_OTHER_CHRG = 0,                    
AUCTIONPART = '',                    
NETWITHBROK  = ISNULL(( SELECT     
    BFOCLOSING.CLOSE_PRICE  
   FROM     
    #BFOCLOSING BFOCLOSING    
   WHERE    
    BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE   
                ),0),    
BFDAYFLAG = 'B-F',                    
S.RESERVED1 ,                    
ACTBUYQTY = SUM(  CASE WHEN S.SELL_BUY = 1                    
               THEN                      
                  (S.TRADEQTY)                    
            ELSE                    
               0                     
             END                     
),                    
ACTSELLQTY = SUM( CASE WHEN S.SELL_BUY = 2                    
               THEN                     
    (S.TRADEQTY)         
   ELSE                    
  0                     
           END )                    
FROM BFOSETTLEMENT S,  BFOSCRIP2                     
WHERE     
 SAUDA_DATE < @SDATE                    
 AND BFOSCRIP2.PRODUCT_TYPE = S.PRODUCT_TYPE    
 AND BFOSCRIP2.PRODUCT_CODE = S.PRODUCT_CODE    
 AND BFOSCRIP2.SERIES_CODE = S.SERIES_CODE    
 AND BFOSCRIP2.SERIES_ID = S.SERIES_ID    
 AND BFOSCRIP2.EXPIRYDATE = S.EXPIRYDATE    
 AND BFOSCRIP2.STRIKE_PRICE = S.STRIKE_PRICE    
 AND BFOSCRIP2.OPTION_TYPE = S.OPTION_TYPE   
 AND BFOSCRIP2.MATURITYDATE >= @SDATE       
GROUP BY  
 S.PARTY_CODE,  
S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,  
S.STRIKE_PRICE,S.OPTION_TYPE,S.SERIES_CODE,  
S.SERIES_ID,S.LOT_SIZE,  
  
SELL_BUY,CONVERT(VARCHAR,S.EXPIRYDATE,103),    
 S.EXPIRYDATE,BFOSCRIP2.MATURITYDATE,S.RESERVED1                   
                  
    
SELECT  CONTRACTNO,BILLNO=LOT_SIZE,TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),    
 PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,  
 STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,TRADEQTY,AUCTIONPART,    
 TRADE_PRICE,SAUDA_DATE,SELL_BUY,NETRATE,    
 INS_CHRG=SUM(INS_CHRG),TURN_TAX=SUM(TURN_TAX),    
 OTHER_CHRG=SUM(OTHER_CHRG),SEBI_TAX=SUM(SEBI_TAX),BROKER_CHRG=SUM(BROKER_CHRG),    
 SERVICE_TAX=SUM(SERVICE_TAX),PARTICIPANTCODE,    
 TOTALBROK = SUM(BROKAPPLIED * TRADEQTY),    
 RESERVED1    
INTO #BFOSETTLEMENT     
FROM    
 BFOSETTLEMENT     
WHERE     
 SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
 AND TRADEQTY * TRADE_PRICE > 0    
GROUP BY    
 CONTRACTNO,PRADNYA.DBO.REPLACETRADENO(TRADE_NO),    
 PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,  
 STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,  
 TRADEQTY,AUCTIONPART,LOT_SIZE,  
 TRADE_PRICE,SAUDA_DATE,SELL_BUY,NETRATE,    
 PARTICIPANTCODE,RESERVED1    
    
UPDATE    
 #BFOSETTLEMENT    
SET     
 TOTALBROK = CD_TOT_BROK,     
 SERVICE_TAX = SERVICE_TAX+CD_TOT_SERTAX    
FROM    
 CHARGES_DETAIL    
WHERE    
 LEFT(CD_SAUDA_DATE,11) = @SDATE    
 AND LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE    
 AND CD_PRODUCT_CODE = PRODUCT_CODE    
 AND CD_SERIES_CODE = SERIES_CODE    
 AND CD_SERIES_ID = SERIES_ID    
 AND CD_TRADE_NO = TRADE_NO    
    
  
    
INSERT INTO TBL_MTOMPREMIUMBILL                    
SELECT BILLDATE = @SDATE + ' 23:59:00' ,                    
PQTY = SUM(  CASE WHEN S.SELL_BUY = 1                    
               THEN                      
               (S.TRADEQTY)                     
            ELSE                    
               0                     
             END    
),    
SQTY = SUM( CASE WHEN S.SELL_BUY = 2                    
               THEN                     
                   (S.TRADEQTY)                    
             ELSE                    
              0                     
                END ) ,    
ISNULL(S.TRADE_PRICE,0),                    
CL_RATE  = ISNULL(( SELECT     
    BFOCLOSING.CLOSE_PRICE    
   FROM     
    #BFOCLOSINGTODAY BFOCLOSING    
   WHERE    
   BFOCLOSING.PRODUCT_TYPE = S.PRODUCT_TYPE    
    AND BFOCLOSING.PRODUCT_CODE = S.PRODUCT_CODE    
    AND BFOCLOSING.SERIES_CODE = S.SERIES_CODE    
    AND BFOCLOSING.SERIES_ID = S.SERIES_ID    
    AND BFOCLOSING.EXPIRYDATE = S.EXPIRYDATE    
    AND BFOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE    
    AND BFOCLOSING.OPTION_TYPE = S.OPTION_TYPE   
                ),0),    
S.PARTY_CODE,                    
S.PRODUCT_TYPE,  
S.PRODUCT_CODE,  
S.ASSET_CODE,  
S.EXPIRYDATE,  
S.STRIKE_PRICE,  
S.OPTION_TYPE,  
S.SERIES_CODE,  
S.SERIES_ID,  
S.LOT_SIZE,  
SDATE=@SDATE,                    
SELL_BUY= CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END) > SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END)  
   THEN 1 ELSE 2 END,    
SERVICE_TAX=(CASE WHEN (C2.SERVICE_CHRG=1 OR  C2.SERVICE_CHRG=0) THEN                    
                                    SUM(SERVICE_TAX)                     
                          ELSE                    
                 0                    
                       END),                    
                    
BROK=  SUM(TOTALBROK),                    
                    
NONEXPIRYSERVICE_TAX=(CASE WHEN (C2.SERVICE_CHRG=1 OR  C2.SERVICE_CHRG=0) THEN                    
                              SUM(SERVICE_TAX)                     
                          ELSE                    
                             0                    
                       END),                    
                    
NONEXPIRYBROK= SUM(TOTALBROK),                    
                    
SEBI_TAX=(CASE WHEN ( C2.SEBI_TURN_TAX=1 ) THEN                    
                 ISNULL(SUM(S.SEBI_TAX),0)                      
             ELSE                    
                0                      
           END ) ,                    
TURN_TAX=(CASE WHEN( C2.TURNOVER_TAX=1) THEN                    
  ISNULL(SUM(S.TURN_TAX),0)                    
 ELSE 0                     
 END ),                    
STAMPDUTY=(CASE WHEN( C2.BROKERNOTE=1) THEN                    
                    SUM(S.BROKER_CHRG)             
             ELSE                    
                0                      
           END ) ,                    
INEX_SERVICE_TAX=(CASE WHEN C2.SERVICE_CHRG=2 THEN                    
  ISNULL(SUM(SERVICE_TAX),0)                     
             ELSE                    
                0                      
           END ),                    
INEX_SEBI_TAX=(CASE WHEN C2.SEBI_TURN_TAX=1 THEN                    
                 ISNULL(SUM(S.SEBI_TAX),0)                      
             ELSE                    
                0                      
           END ),                    
INEX_TURN_TAX=(CASE WHEN C2.TURNOVER_TAX=1 THEN                    
                 ISNULL(SUM(S.TURN_TAX),0)                    
             ELSE                    
                0                      
           END ),                    
INEX_STAMPDUTY=(CASE WHEN C2.BROKERNOTE=1 THEN                    
                    SUM(S.BROKER_CHRG)                    
             ELSE                    
                0                      
           END ),                    
                    
EXPIRYBROK= SUM(ABS(SERVICE_TAX)*TRADEQTY),                    
EXPIRYSERVICE_TAX=(CASE WHEN (C2.SERVICE_CHRG=1 OR  C2.SERVICE_CHRG=0) THEN                    
                                    ISNULL(SUM( SERVICE_TAX  ),0)                     
                          ELSE                    
                             0   
                       END),                    
INSURANCE_CHRG=(CASE WHEN( C2.INSURANCE_CHRG=1) THEN                    
                    SUM(S.INS_CHRG)                    
             ELSE                    
                0                      
           END ) ,                    
INEX_INSURANCE_CHRG=(CASE WHEN C2.INSURANCE_CHRG=1 THEN                    
                    SUM(S.INS_CHRG)                    
          ELSE                    
                0                      
END ),        
          
OTHER_CHRG=(CASE WHEN( C2.OTHER_CHRG=1) THEN                    
           SUM(S.OTHER_CHRG)           
 ELSE                    
           0                      
        END ) ,                    
INEX_OTHER_CHRG=(CASE WHEN C2.OTHER_CHRG=1 THEN                    
            SUM(S.OTHER_CHRG)                    
         ELSE                    
              0                      
         END ),                    
AUCTIONPART = S.AUCTIONPART,                    
NETWITHBROK = S.NETRATE,                    
BFDAYFLAG = '',                    
S.RESERVED1  ,                    
ACTBUYQTY = SUM(  CASE WHEN S.SELL_BUY = 1                    
               THEN                      
                  (S.TRADEQTY)                    
            ELSE                    
               0                     
             END                     
),                    
ACTSELLQTY = SUM( CASE WHEN S.SELL_BUY = 2                    
               THEN                     
                           (S.TRADEQTY)                     
   ELSE                    
  0                     
                END )    
FROM CLIENT2 C2, #BFOSETTLEMENT S , BFOSCRIP2                    
WHERE     
 SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
 AND BFOSCRIP2.PRODUCT_TYPE = S.PRODUCT_TYPE    
 AND BFOSCRIP2.PRODUCT_CODE = S.PRODUCT_CODE    
 AND BFOSCRIP2.SERIES_CODE = S.SERIES_CODE    
 AND BFOSCRIP2.SERIES_ID = S.SERIES_ID    
 AND BFOSCRIP2.EXPIRYDATE = S.EXPIRYDATE    
 AND BFOSCRIP2.STRIKE_PRICE = S.STRIKE_PRICE    
 AND BFOSCRIP2.OPTION_TYPE = S.OPTION_TYPE   
 AND S.PARTY_CODE=C2.PARTY_CODE      
GROUP BY     
S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,  
S.STRIKE_PRICE,S.OPTION_TYPE,S.SERIES_CODE,  
S.SERIES_ID,S.LOT_SIZE,SEBI_TAX,S.EXPIRYDATE,S.TRADE_PRICE,   
C2.SERVICE_CHRG,C2.SEBI_TURN_TAX,C2.TURNOVER_TAX,C2.BROKERNOTE,S.RESERVED1,    
C2.INSURANCE_CHRG,C2.OTHER_CHRG,S.AUCTIONPART,BFOSCRIP2.MATURITYDATE,  
NETRATE                 
  
    
/*=========================================================================================*/    
DELETE FROM BFOBILLVALAN WHERE SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59' AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY        
        
/* BROUGHT FORWARD TRADES */          
INSERT INTO BFOBILLVALAN         
SELECT S.PARTY_CODE,LONG_NAME=LEFT(LONG_NAME,50),CLIENT_TYPE=C1.CL_TYPE,BILLNO=S.LOT_SIZE,0 CONTRACTNO,  
S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,        
'0' AUCTIONPART,F.MATURITYDATE,SAUDA_DATE=@SDATE + ' 23:59',        
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END),                 
SQTY=SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END),        
PRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END ),4),        
SRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END),4) ,          
PAMT =ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*NETRATE) + (CASE WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END) ELSE 0 END),4),         
SAMT =ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*NETRATE) + (CASE WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END) ELSE 0 END),4),   
PBROKAMT=0, SBROKAMT=0, PBILLAMT=0, SBILLAMT=0, CL_RATE = 0,CL_CHRG=0,EXCL_CHRG=0,SERVICE_TAX=0,EXSER_TAX=0,INEXSERFLAG=SERVICE_CHRG,        
SEBI_TAX=0,TURN_TAX=0,BROKER_NOTE=0,INS_CHRG=0,OTHER_CHRG=0,TRADETYPE='BF',PARTICIPANTCODE=MEMBERCODE,       
FAMILY,FAMILYNAME='',TRADER,BRANCH_CODE=C1.BRANCH_CD,SUB_BROKER,        
REGION=C1.REGION,UPDATEDATE=GETDATE(),C1.EMAIL,C1.AREA        
FROM BFOSCRIP2 F,BFOSETTLEMENT S, BFOOWNER, CLIENT1 C1, CLIENT2 C2           
WHERE           
 SAUDA_DATE < @SDATE   
 AND F.PRODUCT_TYPE = S.PRODUCT_TYPE    
 AND F.PRODUCT_CODE = S.PRODUCT_CODE    
 AND F.SERIES_CODE = S.SERIES_CODE    
 AND F.SERIES_ID = S.SERIES_ID    
 AND F.EXPIRYDATE = S.EXPIRYDATE    
 AND F.STRIKE_PRICE = S.STRIKE_PRICE    
 AND F.OPTION_TYPE = S.OPTION_TYPE   
 AND F.MATURITYDATE >= @SDATE         
 AND S.PARTY_CODE BETWEEN @FPARTY AND  @TPARTY        
 AND S.PARTY_CODE = C2.PARTY_CODE   
 AND C2.CL_CODE = C1.CL_CODE AND S.RESERVED1<>1        
GROUP BY S.PARTY_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,MATURITYDATE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,LONG_NAME,C1.CL_TYPE,SERVICE_CHRG,PARTICIPANTCODE,FAMILY,  
TRADER,C1.BRANCH_CD,SUB_BROKER,MEMBERTYPE,MEMBERCODE,S.SERIES_CODE,S.SERIES_ID,C1.AREA,C1.REGION,C1.EMAIL   
HAVING SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) <> SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END)         
        
/* BROUGHT FORWARD TRADES */          
        
/* TODAYS TRADE */          
        
INSERT INTO BFOBILLVALAN        
SELECT S.PARTY_CODE,LONG_NAME=LEFT(LONG_NAME,50),CLIENT_TYPE=C1.CL_TYPE,BILLNO=S.LOT_SIZE,CONTRACTNO,  
S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,        
S.AUCTIONPART,F.MATURITYDATE,SAUDA_DATE=@SDATE + ' 23:59',  
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END),          
SQTY=SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END),          
PRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END ),4),        
SRATE=ROUND((CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) > 0 THEN SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY*TRADE_PRICE ELSE 0 END)/SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) ELSE 0 END),4) ,          
PAMT =ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*(TRADE_PRICE+BROKAPPLIED)) ELSE 0 END),4),         
SAMT =ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*(TRADE_PRICE-BROKAPPLIED)) ELSE 0 END),4),        
PBROKAMT =ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*BROKAPPLIED) ELSE 0 END),4),         
SBROKAMT =ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*BROKAPPLIED) ELSE 0 END),4),         
PBILLAMT= ROUND(SUM(CASE WHEN SELL_BUY = 1 THEN (S.TRADEQTY*(TRADE_PRICE+BROKAPPLIED)) ELSE 0 END),4),         
SBILLAMT= ROUND(SUM(CASE WHEN SELL_BUY = 2 THEN (S.TRADEQTY*(TRADE_PRICE-BROKAPPLIED)) ELSE 0 END),4),        
CL_RATE = 0, CL_CHRG=0,EXCL_CHRG=0,SERVICE_TAX=SUM(SERVICE_TAX),        
EXSER_TAX=(CASE WHEN C2.SERVICE_CHRG = 2 THEN SUM(SERVICE_TAX) ELSE 0 END ),        
INEXSERFLAG=SERVICE_CHRG,        
SEBI_TAX=(CASE WHEN SEBI_TURN_TAX = 1 THEN SUM(SEBI_TAX) ELSE 0 END),          
TURN_TAX=(CASE WHEN C2.TURNOVER_TAX = 1 THEN SUM(TURN_TAX) ELSE 0 END),          
BROKER_NOTE=(CASE WHEN BROKERNOTE = 1 THEN SUM(BROKER_CHRG) ELSE 0 END),        
INS_CHRG=(CASE WHEN C2.INSURANCE_CHRG=1 THEN SUM(INS_CHRG) ELSE  0 END ),        
OTHER_CHRG=(CASE WHEN C2.OTHER_CHRG=1 THEN SUM(S.OTHER_CHRG) ELSE  0 END ),        
TRADETYPE='BT',        
PARTICIPANTCODE=(CASE WHEN S.RESERVED1 = 1 THEN PARTICIPANTCODE ELSE MEMBERCODE END),        
FAMILY,FAMILYNAME='',TRADER,BRANCH_CODE=C1.BRANCH_CD,SUB_BROKER,      
REGION=C1.REGION,UPDATEDATE=GETDATE(),        
C1.EMAIL,C1.AREA    
FROM BFOSCRIP2 F,BFOSETTLEMENT S, BFOOWNER, CLIENT1 C1, CLIENT2 C2           
WHERE SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'         
     AND F.SERIES_CODE=S.SERIES_CODE        
     AND F.MATURITYDATE >= @SDATE           
     AND S.PARTY_CODE BETWEEN @FPARTY AND  @TPARTY  
     AND S.PARTY_CODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE AND TRADEQTY > 0         
GROUP BY S.PARTY_CODE,S.PRODUCT_CODE,S.PRODUCT_TYPE,S.PRODUCT_CODE,S.ASSET_CODE,S.EXPIRYDATE,S.STRIKE_PRICE,  
S.OPTION_TYPE,S.SERIES_CODE,S.SERIES_ID,S.LOT_SIZE,LONG_NAME,C1.CL_TYPE,CONTRACTNO,AUCTIONPART,SERVICE_CHRG,  
PARTICIPANTCODE,FAMILY,TRADER,C1.BRANCH_CD,SUB_BROKER,MATURITYDATE,   
MEMBERTYPE,SEBI_TURN_TAX,C2.OTHER_CHRG,C2.TURNOVER_TAX,BROKERNOTE,MEMBERCODE,S.RESERVED1,S.SERIES_CODE  ,  
INSURANCE_CHRG ,C1.AREA,C1.REGION,C1.EMAIL  
        
INSERT INTO BFOBILLVALAN       
SELECT    
PARTY_CODE=CD_PARTY_CODE,LONG_NAME=LEFT(C1.LONG_NAME,50),CLIENT_TYPE=CL_TYPE,BILLNO=0,    
CONTRACTNO=CD_CONTRACT_NO,    
CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_ASSET_CODE,CD_EXPIRYDATE,CD_STRIKE_PRICE,  
CD_OPTION_TYPE,CD_SERIES_CODE,CD_SERIES_ID,CD_LOT_SIZE,        
AUCTIONPART=CD_AUCTIONPART,    
 ISNULL(F.MATURITYDATE,'1900-01-01'),SAUDA_DATE=CD_SAUDA_DATE +' 23:59',   
 PQTY=0,    
 SQTY=0,    
 PRATE=0,    
 SRATE=0,    
 PAMT=0,    
 SAMT=0,    
 PBROKAMT=SUM(CD_TOT_BUYBROK),    
 SBROKAMT=SUM(CD_TOT_SELLBROK),    
 PBILLAMT=SUM(CD_TOT_BUYBROK+CD_TOT_SELLBROK),    
 SBILLAMT=SUM(0),    
 CL_RATE = 0, CL_CHRG=0,EXCL_CHRG=0,    
 SERVICE_TAX = SUM(CD_TOT_SERTAX),    
 EXSER_TAX=(CASE WHEN C2.SERVICE_CHRG = 2 THEN SUM(CD_TOT_SERTAX) ELSE 0 END ),                    
 INEXSERFLAG=SERVICE_CHRG,       
 SEBI_TAX=0,    
 TURN_TAX =0,    
 BROKER_CHRG =0,    
 INS_CHRG = 0,    
 OTHER_CHRG = 0,    
 TRADETYPE='BT',PARTICIPANTCODE=MEMBERCODE,    
 FAMILY,FAMILYNAME='',TRADER,BRANCH_CODE=BRANCH_CD,SUB_BROKER,  
 REGION,UPDATEDATE= GETDATE(),                    
 EMAIL=C1.EMAIL,C1.AREA    
FROM CHARGES_DETAIL S LEFT OUTER JOIN BFOSCRIP2 F    
ON (F.PRODUCT_TYPE = S.CD_PRODUCT_TYPE    
 AND F.PRODUCT_CODE = S.CD_PRODUCT_CODE    
 AND F.SERIES_CODE = S.CD_SERIES_CODE    
 AND F.SERIES_ID = S.CD_SERIES_ID    
 AND F.EXPIRYDATE = CD_EXPIRYDATE  
 AND F.STRIKE_PRICE = STRIKE_PRICE  
 AND F.OPTION_TYPE = OPTION_TYPE  
   
 ),  
CLIENT1 C1, CLIENT2 C2, BFOOWNER    
WHERE     
 S.CD_SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'      
 AND S.CD_PARTY_CODE = C2.PARTY_CODE    
 AND C1.CL_CODE = C2.CL_CODE    
     
GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,CD_ASSET_CODE,CD_STRIKE_PRICE,  
 CD_OPTION_TYPE,CD_LOT_SIZE,CD_AUCTIONPART, C1.AREA,LEFT(C1.LONG_NAME,50),C1.CL_TYPE,F.MATURITYDATE,C2.SERVICE_CHRG,C1.FAMILY,    
 C1.TRADER,C1.BRANCH_CD,C1.SUB_BROKER,BFOOWNER.MEMBERTYPE,C1.REGION,C1.EMAIL,    
 MEMBERCODE         
    
  
/* TODAYS TRADE */            
      
UPDATE BFOBILLVALAN SET EXCL_CHRG = CL_CHRG FROM BFOOWNER         
WHERE ( CLRGCHG = 1 AND CHMCLCHRG = 1 ) OR ( CLRGCHG = 4 AND CHMCLCHRG = 1 )         
OR ( CLRGCHG = 2 AND CHMCLCHRG = 0 )  OR ( CLRGCHG = 0 AND CHMCLCHRG = 0 )         
AND BFOBILLVALAN.TRADETYPE = 'BT'        
AND BFOBILLVALAN.PARTY_CODE >= @FPARTY  AND BFOBILLVALAN.PARTY_CODE <= @TPARTY        
AND BFOBILLVALAN.SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
        
UPDATE BFOBILLVALAN SET PBILLAMT=PQTY*BFOCLOSING.CLOSE_PRICE,SBILLAMT=SQTY*BFOCLOSING.CLOSE_PRICE,        
PAMT=PQTY*BFOCLOSING.CLOSE_PRICE,SAMT=SQTY*BFOCLOSING.CLOSE_PRICE        
FROM BFOCLOSING WHERE BFOCLOSING.TRADE_DATE = ( SELECT MAX(TRADE_DATE) FROM BFOCLOSING           
                   WHERE BFOCLOSING.TRADE_DATE < @SDATE )           
--AND BFOCLOSING.PRODUCT_TYPE = BFOBILLVALAN.PRODUCT_TYPE    
AND BFOCLOSING.PRODUCT_CODE = BFOBILLVALAN.PRODUCT_CODE    
AND BFOCLOSING.SERIES_CODE = BFOBILLVALAN.SERIES_CODE    
AND BFOCLOSING.SERIES_ID = BFOBILLVALAN.SERIES_ID    
AND BFOCLOSING.EXPIRYDATE = BFOBILLVALAN.EXPIRYDATE    
AND BFOCLOSING.STRIKE_PRICE = BFOBILLVALAN.STRIKE_PRICE    
AND BFOCLOSING.OPTION_TYPE = BFOBILLVALAN.OPTION_TYPE  
AND BFOBILLVALAN.TRADETYPE = 'BF'         
AND BFOBILLVALAN.SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
AND BFOBILLVALAN.PARTY_CODE >= @FPARTY  AND BFOBILLVALAN.PARTY_CODE <= @TPARTY        
AND RIGHT(BFOBILLVALAN.PRODUCT_CODE, 3) = 'FUT'    
  
UPDATE BFOBILLVALAN SET CL_RATE = BFOCLOSING.CLOSE_PRICE FROM BFOCLOSING          
WHERE BFOCLOSING.TRADE_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
--AND BFOCLOSING.PRODUCT_TYPE = BFOBILLVALAN.PRODUCT_TYPE    
AND BFOCLOSING.PRODUCT_CODE = BFOBILLVALAN.PRODUCT_CODE    
AND BFOCLOSING.SERIES_CODE = BFOBILLVALAN.SERIES_CODE    
AND BFOCLOSING.SERIES_ID = BFOBILLVALAN.SERIES_ID    
AND BFOCLOSING.EXPIRYDATE = BFOBILLVALAN.EXPIRYDATE    
AND BFOCLOSING.STRIKE_PRICE = BFOBILLVALAN.STRIKE_PRICE    
AND BFOCLOSING.OPTION_TYPE = BFOBILLVALAN.OPTION_TYPE  
AND BFOBILLVALAN.SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'    
AND BFOBILLVALAN.PARTY_CODE >= @FPARTY  AND BFOBILLVALAN.PARTY_CODE <= @TPARTY        
  
  
UPDATE BFOBILLVALAN SET         
PBILLAMT= (CASE WHEN PARTICIPANTCODE = MEMBERCODE         
  THEN (CASE WHEN PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT > 0         
              THEN PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT         
                           ELSE 0 END)        
        ELSE PBROKAMT END),        
SBILLAMT= (CASE WHEN PARTICIPANTCODE = MEMBERCODE         
         THEN (CASE WHEN PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT < 0         
                           THEN ABS(PBILLAMT-PQTY*CL_RATE+SQTY*CL_RATE-SBILLAMT)         
                    ELSE 0 END)        
        ELSE SBROKAMT END)        
FROM BFOOWNER WHERE SAUDA_DATE BETWEEN  @SDATE AND @SDATE + ' 23:59'  
AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY     
AND RIGHT(PRODUCT_CODE, 3) = 'FUT'      
  
UPDATE BFOBILLVALAN SET FAMILYNAME = LEFT(C1.LONG_NAME,50) FROM CLIENT1 C1, CLIENT2 C2        
WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = BFOBILLVALAN.FAMILY         
        
UPDATE BFOBILLVALAN SET EMAIL = (CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END) FROM CLIENT1 C1, CLIENT2 C2        
WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = BFOBILLVALAN.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCBROK_ONTHEFLY
-- --------------------------------------------------
CREATE PROC [DBO].[CALCBROK_ONTHEFLY]
(
	@PARTYCODE VARCHAR(10),
	@SELLBUY INT,
	@MKTRATE NUMERIC(18, 4)
)
/*-------------------------------------------------------------------------
	PROC NAME	: CALCBROK_ONTHEFLY
	PROJECT		: .NET NSEFO CONSOLIDATION
	DESCRIPTION : FOR DISPLYING BROKERAGE ON THE FLY WHILE SPLITTING TRADE
---------------------------------------------------------------------------*/
AS
	DECLARE
		@CNT INT,
		@BRKTABLENO INT,
		@VALPER VARCHAR(1),
		@BRKRATE NUMERIC(18, 4),
		@BROKERAGE NUMERIC(18, 9),
		@NETRATE NUMERIC(18, 4),
		@ACTBRK CHAR(18),
		@ACTNET CHAR(18),
		@NETRND INT,
		@ROUND_TO INT,
		@ROFIG INT,
		@ERRNUM NUMERIC(18, 9),
		@NOZERO INT
		SET @CNT = 0
		SET @NETRND = 0

		SELECT
			@CNT = ISNULL(COUNT(1), 0),
			@BRKTABLENO = ISNULL(C2.STD_RATE, 0)
		FROM
			CLIENT1 C1,
			CLIENT2 C2
		WHERE
			C1.CL_CODE = C2.CL_CODE
			AND C2.PARTY_CODE = @PARTYCODE
		GROUP BY C2.STD_RATE

		IF @CNT > 0
			BEGIN
				SELECT
					@VALPER = VAL_PERC,
					@BRKRATE = (CASE WHEN @SELLBUY = 1 THEN DAY_PUC ELSE DAY_SALES END),
					@ROFIG = ROFIG,
					@ERRNUM = ERRNUM,
					@NOZERO = NOZERO
				FROM
					BROKTABLE
				WHERE
					TABLE_NO = @BRKTABLENO
					AND @MKTRATE >= LOWER_LIM AND @MKTRATE < UPPER_LIM


				IF @VALPER = 'V'
					BEGIN
						SELECT
							@BROKERAGE = @MKTRATE * @BRKRATE
					END
				ELSE
					BEGIN
						SELECT @BROKERAGE = (@MKTRATE * @BRKRATE) / 100
				END

				SELECT
					@ROUND_TO = CASE WHEN BROKERAGE =0 THEN 4 ELSE BROKERAGE END ,
					@NETRND = CASE WHEN NETRATE=0 THEN 4 ELSE NETRATE END
				FROM
					INSTCLIENT_TBL
				WHERE
					PARTYCODE = @PARTYCODE

				SET @BROKERAGE = ((FLOOR((@BROKERAGE * POWER(10, @ROUND_TO)+ @ROFIG + @ERRNUM)/(@ROFIG + @NOZERO )) * (@ROFIG + @NOZERO))/POWER(10,@ROUND_TO))

				SET @ACTBRK = CONVERT(CHAR(18), @BROKERAGE)
				SET @NETRATE = CASE WHEN @SELLBUY = 1 THEN (@MKTRATE + @BROKERAGE) ELSE (@MKTRATE - @BROKERAGE) END
				SET @NETRATE = ROUND(@NETRATE, @NETRND, 1)
				SET @ACTNET = CONVERT(CHAR(18), @NETRATE)
			END
		ELSE
			BEGIN
				SET @CNT = 0
				SET @ACTBRK = CONVERT(CHAR(18), 0)
				SET @ACTNET = CONVERT(CHAR(18), @MKTRATE)
				SET @NETRND = 4
			END

		SELECT
			CNT = ISNULL(@CNT, 0),
			BROKERAGE = ISNULL(@ACTBRK, CONVERT(CHAR(18), 0)),
			NETROUND = CONVERT(VARCHAR(1), @NETRND),
			NETRATE = ISNULL(@ACTNET, CONVERT(CHAR(18), @MKTRATE))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_BROKERAGE
-- --------------------------------------------------
CREATE PROC [DBO].[CALCULATE_BROKERAGE]  
(
	 @DATA VARCHAR(2000)  
)
AS  


/*---------------------------------------------------------------------------
	PROC NAME   : CALCULATE_BROKERAGE
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CALLING FOR THE TRADE/FOSETTLEMENT BEFORE & AFTER CONTRACT
				  CONSOLIDATION FROM CONSOLIDATETRANS PROC
------------------------------------------------------------------------------*/

 DECLARE  
  @CONTRACTNO VARCHAR(7),  
  @PARTYCODE VARCHAR(10),  
  @PARTICIPANT VARCHAR(30),  
  @TERMID VARCHAR(30),  
  @SYMBOL VARCHAR(10), 
  @INST_TYPE VARCHAR(10),
  @EXPIRYDATE VARCHAR(11),
  @STRIKE_PRICE NUMERIC(18,2),
  @OPTION_TYPE VARCHAR(10),	   
  @SAUDADATE VARCHAR(10),  
  @ORDERNO VARCHAR(16),  
  @TRADENO VARCHAR(14),  
  @SELLBUY VARCHAR(1),  
  @MKTRATE NUMERIC(18, 4),  
  @NEWNETRATE NUMERIC(18, 4),  
  @OLDNETRATE NUMERIC(18, 4),  
  @OPTION VARCHAR(1),  
  @LEVEL INT,  
  @SQL VARCHAR(2000),  
  @STMETHOD VARCHAR(10),  
  @STVAL NUMERIC(18, 4),  
  @BROKERAGE NUMERIC(18, 4),  
  @NEWST NUMERIC(18, 4),  
  @GROSSVAL NUMERIC(18, 4),  
  @MKTROUND TINYINT,  
  @NETROUND TINYINT,  
  @BRKROUND TINYINT  
  
  
	SET @LEVEL = CONVERT(INT, LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 12))))  
	SET @CONTRACTNO = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 2)))  
	SET @PARTYCODE = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 3)))  
	SET @TERMID = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 4)))  
	IF @TERMID = '%' BEGIN SET @TERMID ='' END 
	SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 5)))  
	SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 6))) 
	SET @EXPIRYDATE = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 7))) 
	SET @STRIKE_PRICE = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 8))) 
	SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 9)))  
	SET @SAUDADATE = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 10)))  
	SET @SELLBUY = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 13)))  
	SET @OPTION = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 11))) 
	SET @MKTRATE = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 14)))  
	SET @NEWNETRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 15))))  
	SET @OLDNETRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 16))))  
	SET @PARTICIPANT = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 17)))  
	SET @BROKERAGE = ABS(CONVERT(NUMERIC(18, 4), @MKTRATE) - @NEWNETRATE)  

	IF @LEVEL = 3 OR @LEVEL = 4  
	BEGIN  
		SET @ORDERNO = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 8)))  
		IF @ORDERNO = '%' BEGIN SET @ORDERNO = '' END 
	END  
	ELSE
	BEGIN
		SET @ORDERNO= ''
	END 

	IF @LEVEL = 4  
	BEGIN  
		SET @TRADENO = LTRIM(RTRIM(.DBO.PIECE(@DATA, ',', 9)))  
		IF @TRADENO = '%' BEGIN SET @TRADENO ='' END 
	END
	ELSE
	BEGIN
		SET @TRADENO = ''
	END  

	SELECT @STVAL = SERVICE_TAX FROM FOGLOBALS WHERE CONVERT(DATETIME, @SAUDADATE, 103) BETWEEN YEAR_START_DT AND YEAR_END_DT  
	IF @STVAL IS NULL  
	BEGIN  
		SET @STVAL = 0  
	END  

	SELECT 
		@STMETHOD = LTRIM(RTRIM(CONVERT(VARCHAR, SERVICE_CHRG))) + '-' + LTRIM(RTRIM(CONVERT(VARCHAR, SERTAXMETHOD))) 
	FROM 
		CLIENT2 (NOLOCK) 
	WHERE 
		CL_CODE = @PARTYCODE  

	SELECT 
		@MKTROUND = CASE WHEN MARKETRATE =0 THEN 4 ELSE MARKETRATE END,
		@NETROUND = CASE WHEN NETRATE =0 THEN 4 ELSE NETRATE END ,
		@BRKROUND = CASE WHEN BROKERAGE = 0 THEN 4 ELSE BROKERAGE END
	FROM 
		INSTCLIENT_TBL (NOLOCK) 
	WHERE 
		PARTYCODE = @PARTYCODE  

	  IF @STMETHOD = '1-1' -- SERVIEC TAX IS 0  
	   BEGIN  
			UPDATE
				FOSETTLEMENT 
			SET 
				DUMMY1 = 1, PRICE = @MKTRATE,
				NETRATE = @NEWNETRATE , N_NETRATE = @NEWNETRATE ,
				BROKAPPLIED = @BROKERAGE , NBROKAPP = @BROKERAGE,
				SERVICE_TAX = 0, NSERTAX = 0, STATUS = 'E' 
			WHERE 
				CONVERT(VARCHAR(10), SAUDA_DATE, 103) =  @SAUDADATE 
				AND PARTY_CODE = @PARTYCODE
				AND INST_TYPE = @INST_TYPE  
				AND SYMBOL = @SYMBOL 
				AND CONVERT(VARCHAR(11),EXPIRYDATE,103) =  @EXPIRYDATE 
				AND STRIKE_PRICE = @STRIKE_PRICE  
				AND OPTION_TYPE = @OPTION_TYPE 
				AND SELL_BUY = @SELLBUY AND CONTRACTNO = @CONTRACTNO 
				AND PARTICIPANTCODE = @PARTICIPANT		
				AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END
				AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END
				AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END


	   END  
	  ELSE IF @STMETHOD = '1-0' -- SERVIEC TAX IS INCLUDED IN BROKERAGE, NEED TO SEPARATE  
	   BEGIN  
			SET @GROSSVAL = 100 + @STVAL  
			SET @BROKERAGE = ((@BROKERAGE * 100) / @GROSSVAL)  
			SET @NEWNETRATE = CONVERT(NUMERIC(18, 4), @MKTRATE) + CASE @SELLBUY WHEN 1 THEN (@BROKERAGE) ELSE (-@BROKERAGE) END  
			SET @NEWNETRATE = ROUND(@NEWNETRATE, @NETROUND)  

			UPDATE 
				FOSETTLEMENT 
			SET 
				DUMMY1 = 1, 
				PRICE = @MKTRATE ,
				NETRATE = @NEWNETRATE, N_NETRATE = @NEWNETRATE ,
				BROKAPPLIED = @BROKERAGE, NBROKAPP = @BROKERAGE ,
				SERVICE_TAX = TRADEQTY * @BROKERAGE * @STVAL/10, NSERTAX = TRADEQTY * @BROKERAGE * @STVAL/100, STATUS = 'E'   
			WHERE 
				CONVERT(VARCHAR(10), SAUDA_DATE, 103) =  @SAUDADATE 
				AND PARTY_CODE = @PARTYCODE
				AND INST_TYPE = @INST_TYPE  
				AND SYMBOL = @SYMBOL 
				AND CONVERT(VARCHAR(11),EXPIRYDATE,103) =  @EXPIRYDATE 
				AND STRIKE_PRICE = @STRIKE_PRICE  
				AND OPTION_TYPE = @OPTION_TYPE 
				AND SELL_BUY = @SELLBUY AND CONTRACTNO = @CONTRACTNO 
				AND PARTICIPANTCODE = @PARTICIPANT		
				AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END
				AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END
				AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END
	   END  
	  ELSE -- CALULATE SERVIEC TAX NORMALLY  
	   BEGIN  
			UPDATE 
				FOSETTLEMENT 
			SET 
				DUMMY1 = 1, 
				PRICE = @MKTRATE ,
				NETRATE = @NEWNETRATE, N_NETRATE = @NEWNETRATE ,
				BROKAPPLIED = @BROKERAGE, NBROKAPP = @BROKERAGE ,
				SERVICE_TAX = TRADEQTY * @BROKERAGE * @STVAL/10, NSERTAX = TRADEQTY * @BROKERAGE * @STVAL/100, STATUS = 'E'   
			WHERE 
				CONVERT(VARCHAR(10), SAUDA_DATE, 103) =  @SAUDADATE 
				AND PARTY_CODE = @PARTYCODE
				AND INST_TYPE = @INST_TYPE  
				AND SYMBOL = @SYMBOL 
				AND CONVERT(VARCHAR(11),EXPIRYDATE,103) =  @EXPIRYDATE 
				AND STRIKE_PRICE = @STRIKE_PRICE  
				AND OPTION_TYPE = @OPTION_TYPE 
				AND SELL_BUY = @SELLBUY AND CONTRACTNO = @CONTRACTNO 
				AND PARTICIPANTCODE = @PARTICIPANT		
				AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END
				AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END
				AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END
	   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_STAMP_DUTY
-- --------------------------------------------------
CREATE PROC [dbo].[CALCULATE_STAMP_DUTY]
(                    
 @SAUDA_DATE VARCHAR(11),              
 @FROMPARTY VARCHAR(10)='0',                     
 @TOPARTY VARCHAR(10)='ZZ'                    
)
AS    

DECLARE @MINDATE VARCHAR(11)

SELECT @MINDATE = ISNULL(MIN(FROM_DATE),'DEC 31 2049') FROM TBL_STAMP_TAX

IF CONVERT(DATETIME,@MINDATE) <= CONVERT(DATETIME,LEFT(GETDATE(),11))
AND CONVERT(DATETIME,@SAUDA_DATE) >= CONVERT(DATETIME,@MINDATE)

BEGIN
	EXEC CALCULATE_STAMP_DUTY_NEW @SAUDA_DATE, @FROMPARTY, @TOPARTY
END
ELSE
BEGIN
	EXEC CALCULATE_STAMP_DUTY_STATE @SAUDA_DATE, @FROMPARTY, @TOPARTY
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_STAMP_DUTY_NEW
-- --------------------------------------------------
  
  
  
CREATE PROC [dbo].[CALCULATE_STAMP_DUTY_NEW]    
(                        
 @SAUDA_DATE VARCHAR(11),                  
 @FROMPARTY VARCHAR(10)='0',                         
 @TOPARTY VARCHAR(10)='ZZZZZZZ'                        
)                  
AS     
  
  DECLARE 
		@SETTCUR		CURSOR,
		@PARTY_CODE		VARCHAR(10),
		@FLAG			INT,
		@SNO			NUMERIC(18,0),
		@TOTALSTAMP		NUMERIC(18,4),
		@DIFF			NUMERIC(18,4),
		@CONTRACTNO		VARCHAR(7),
		@STAMPCUR CURSOR,
		@DIFFCUR	CURSOR 


-- EXEC CALCULATE_STAMP_DUTY_NEW_MODIFY_SIVA_06OCT2023 'OCT  9 2023', '0', 'ZZZZZZZZ'  
IF @SAUDA_DATE = '' OR @SAUDA_DATE = '%' BEGIN  RETURN  END              
  
CREATE TABLE [#FOCLIENTTAXES]  
(  
 [SRNO] [INT] ,  
 [PARTY_CODE] [VARCHAR](10) ,  
 [DATE_FROM] [DATETIME] ,  
 [DATE_TO] [DATETIME] ,  
 [FUT_INSURANCE_CHRG] [FLOAT] ,  
 [FUT_TURNOVER_TAX] [FLOAT] ,  
 [FUT_OTHER_CHRG] [FLOAT] ,  
 [FUT_SEBITURN_TAX] [FLOAT] ,  
 [FUT_BROKER_NOTE] [FLOAT] ,  
 [OPT_INSURANCE_CHRG] [FLOAT] ,  
 [OPT_TURNOVER_TAX] [FLOAT] ,  
 [OPT_OTHER_CHRG] [FLOAT] ,  
 [OPT_SEBITURN_TAX] [FLOAT] ,  
 [OPT_BROKER_NOTE] [FLOAT] ,  
 [ROUND_TO] [DECIMAL](18, 0) ,  
 [ROFIG] [INT] ,  
 [ERRNUM] [NUMERIC](18, 10) ,  
 [NOZERO] [INT]   
)   
CREATE CLUSTERED INDEX [IDXCL] ON [#FOCLIENTTAXES]   
(  
 [PARTY_CODE] ASC,  
 [DATE_FROM] ASC,  
 [DATE_TO] ASC  
)  
  
CREATE TABLE [dbo].[#FoSettlement](  
 [SrNo] [int] IDENTITY(1,1) NOT NULL,  
 [OrgSrNo] [int] NOT NULL,  
 [Contractno] [varchar](14) NOT NULL,  
 [Billno] [int] NULL,  
 [Trade_No] [varchar](15) NULL,  
 [Party_Code] [varchar](10) NOT NULL,  
 [Inst_Type] [varchar](6) NULL,  
 [Symbol] [varchar](12) NULL,  
 [Sec_Name] [varchar](25) NOT NULL,  
 [Expirydate] [datetime] NULL,  
 [Strike_Price] [money] NULL,  
 [Option_Type] [varchar](2) NULL,  
 [User_Id] [varchar](15) NULL,  
 [Pro_Cli] [int] NULL,  
 [O_C_Flag] [varchar](5) NULL,  
 [C_U_Flag] [varchar](7) NULL,  
 [Tradeqty] [int] NULL,  
 [Auctionpart] [varchar](2) NULL,  
 [Markettype] [varchar](2) NULL,  
 [Series] [char](2) NOT NULL,  
 [Order_No] [varchar](20) NULL,  
 [Price] [numeric](18, 8) NULL,  
 [Sauda_Date] [datetime] NOT NULL,  
 [Table_No] [varchar](4) NOT NULL,  
 [Line_No] [decimal](3, 0) NOT NULL,  
 [Val_Perc] [char](1) NULL,  
 [Normal] [money] NULL,  
 [Day_Puc] [money] NULL,  
 [Day_Sales] [money] NULL,  
 [Sett_Purch] [money] NULL,  
 [Sett_Sales] [money] NULL,  
 [Sell_Buy] [int] NOT NULL,  
 [Settflag] [int] NULL,  
 [Brokapplied] [numeric](18, 8) NULL,  
 [Netrate] [numeric](18, 8) NULL,  
 [Amount] [money] NULL,  
 [Ins_Chrg] [money] NULL,  
 [Turn_Tax] [money] NULL,  
 [Other_Chrg] [money] NULL,  
 [Sebi_Tax] [money] NULL,  
 [Broker_Chrg] [money] NULL,  
 [Service_Tax] [numeric](18, 8) NULL,  
 [Trade_Amount] [money] NULL,  
 [Billflag] [int] NULL,  
 [Sett_No] [varchar](12) NULL,  
 [Nbrokapp] [numeric](18, 8) NULL,  
 [Nsertax] [money] NULL,  
 [N_Netrate] [numeric](18, 8) NULL,  
 [Sett_Type] [varchar](3) NULL,  
 [Cl_Rate] [money] NULL,  
 [Participantcode] [varchar](15) NULL,  
 [Status] [varchar](3) NULL,  
 [Cpid] [varchar](20) NULL,  
 [Instrument] [int] NULL,  
 [Booktype] [varchar](5) NULL,  
 [Branch_Id] [varchar](15) NULL,  
 [Tmark] [varchar](10) NULL,  
 [Scheme] [int] NULL,  
 [Dummy1] [int] NULL,  
 [Dummy2] [numeric](18, 8) NULL,  
 [Reserved1] [int] NULL,  
 [Reserved2] [int] NULL,  
 [EXCHG] VARCHAR(5)  
)    
  
DECLARE @CLEARINGCODE VARCHAR(10)   
  
set @CLEARINGCODE = ''   
  
SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM TBL_INTEROP_SETTING  
WHERE  @SAUDA_Date BETWEEN FROM_DATE AND TO_DATE  
  
IF @CLEARINGCODE = 'ICCL'     
BEGIN  
 EXEC NSEFO.DBO.CALCULATE_STAMP_DUTY_NEW @SAUDA_DATE, @FROMPARTY, @TOPARTY  
END  
  
  
  
--IF @CLEARINGCODE = 'ICCL'     
--BEGIN  
-- UPDATE [ANGELFO].NSEFO.DBO.FOSETTLEMENT SET BROKER_CHRG = 0   
-- WHERE  SAUDA_DATE BETWEEN  @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
--    AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
-- AND RESERVED1 = 0   
--END  
  
--IF @CLEARINGCODE = 'NSCCL'     
--BEGIN  
-- INSERT INTO #FOSETTLEMENT  
-- SELECT *, EXCHG = 'NSEFO' FROM [ANGELFO].NSEFO.DBO.FOSETTLEMENT (NOLOCK)  
-- WHERE  SAUDA_DATE BETWEEN  @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
--     AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
-- AND RESERVED1 = 0   
--END  
  
  
IF @CLEARINGCODE = 'ICCL'     
BEGIN  
 INSERT INTO #FOSETTLEMENT  
 SELECT *, EXCHG = 'NSEFO' FROM NSEFO.DBO.FOSETTLEMENT With(NOLOCK)  
 WHERE  SAUDA_DATE BETWEEN  @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
     AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
 AND RESERVED1 = 0    
END  
  
  
  
INSERT INTO #FOSETTLEMENT  
SELECT SRNO,CONTRACTNO,BILLNO=LOT_SIZE,TRADE_NO,PARTY_CODE,N_INST_TYPE,N_SYMBOL,SEC_NAME='',N_EXPIRYDATE,N_STRIKE_PRICE,  
 N_OPTION_TYPE,USER_ID='',PRO_CLI='',O_C_FLAG='O',C_U_FLAG='O',TRADEQTY,AUCTIONPART,MARKETTYPE='',SERIES='',ORDER_NO,TRADE_PRICE,SAUDA_DATE,  
 TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,  
 AMOUNT=TRADE_PRICE*TRADEQTY,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG=0,SETT_NO='',NBROKAPP=0,NSERTAX=0,  
 N_NETRATE=0,SETT_TYPE,CL_RATE=0,PARTICIPANTCODE,STATUS,CPID='',INSTRUMENT=1,BOOKTYPE=1,BRANCH_ID=PARTY_CODE,TMARK='N',SCHEME='',DUMMY1,DUMMY2,  
 RESERVED1,RESERVED2='', EXCHG = 'BSEFO'   
FROM BSEFO.DBO.BFOSETTLEMENT B, BSEFO.DBO.TBL_FOSCRIPMAP T  
 WHERE SAUDA_DATE BETWEEN  @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
 AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
 AND B_INST_TYPE = B.PRODUCT_CODE  
 AND B_SYMBOL = B.SERIES_CODE  
 AND B_EXPIRYDATE = B.EXPIRYDATE  
 AND B_STRIKE_PRICE = B.STRIKE_PRICE  
 AND B_OPTION_TYPE = B.OPTION_TYPE  
 AND RESERVED1 = 0  
    
IF @CLEARINGCODE = 'ICCL'     
BEGIN  
 INSERT INTO #FOSETTLEMENT  
 SELECT SRNO,CONTRACTNO,BILLNO=LOT_SIZE,TRADE_NO,PARTY_CODE,N_INST_TYPE,N_SYMBOL,SEC_NAME='',N_EXPIRYDATE,N_STRIKE_PRICE,  
 N_OPTION_TYPE,USER_ID='',PRO_CLI='',O_C_FLAG='O',C_U_FLAG='O',TRADEQTY,AUCTIONPART,MARKETTYPE='',SERIES='',ORDER_NO,TRADE_PRICE,SAUDA_DATE,  
 TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,  
 AMOUNT=TRADE_PRICE*TRADEQTY,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG=0,SETT_NO='',NBROKAPP=0,NSERTAX=0,  
 N_NETRATE=0,SETT_TYPE,CL_RATE=0,PARTICIPANTCODE,STATUS,CPID='',INSTRUMENT=1,BOOKTYPE=1,BRANCH_ID=PARTY_CODE,TMARK='N',SCHEME='',DUMMY1,DUMMY2,  
 RESERVED1,RESERVED2='', EXCHG = 'BSEFO'  
 FROM BSEFO.DBO.BFOSETTLEMENT B, BSEFO.DBO.TBL_FOSCRIPMAP T  
 WHERE SAUDA_DATE BETWEEN  @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
 AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
 AND B_INST_TYPE = B.PRODUCT_CODE  
 AND B_SYMBOL = B.SERIES_CODE  
 AND B_EXPIRYDATE = B.EXPIRYDATE  
 AND B_STRIKE_PRICE = B.STRIKE_PRICE  
 AND B_OPTION_TYPE = B.OPTION_TYPE  
 AND RESERVED1 = 0   
END  
  
  
INSERT INTO #FOCLIENTTAXES  
SELECT * FROM FOCLIENTTAXES F (NOLOCK)  
WHERE @SAUDA_DATE BETWEEN F.DATE_FROM AND F.DATE_TO  
AND EXISTS (SELECT PARTY_CODE FROM #FOSETTLEMENT S   
   WHERE S.PARTY_CODE = F.PARTY_CODE)  
  
  
UPDATE #FOSETTLEMENT SET BROKER_CHRG = 0  
  
SELECT SAUDA_DATE=CONVERT(DATETIME,LEFT(SAUDA_DATE,11)), CONTRACTNO = (CASE WHEN RESERVED1 <> 0 THEN '' ELSE CONTRACTNO END),   
PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,  
BUYQTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),   
SELLQTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),   
BUYAVGRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 THEN  
        (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0   
           THEN CONVERT(NUMERIC(18,2),(SUM(CASE WHEN SELL_BUY = 1 THEN PRICE * TRADEQTY ELSE 0 END)  
                / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END))) ELSE 0 END) ELSE 0 END),  
      SELLAVGRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 THEN  
        (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0   
           THEN CONVERT(NUMERIC(18,2),(SUM(CASE WHEN SELL_BUY = 2 THEN PRICE * TRADEQTY ELSE 0 END)  
                / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END))) ELSE 0 END) ELSE 0 END),  
BUYSTAMP = CONVERT(NUMERIC(18,2),0),  
SELLSTAMP = CONVERT(NUMERIC(18,2),0),  
TOTALSTAMP =  CONVERT(NUMERIC(18,2),0),  
SRNO = 0, TRADEQTY = MAX(TRADEQTY),  
L_STATE = CONVERT(VARCHAR(100),''),  
SELL_BUY   
INTO #STAMP_DATA  
FROM #FOSETTLEMENT  
WHERE AUCTIONPART =''  
AND TRADEQTY > 0   
AND PRICE > 0   
GROUP BY CONVERT(DATETIME,LEFT(SAUDA_DATE,11)), (CASE WHEN RESERVED1 <> 0 THEN '' ELSE CONTRACTNO END), PARTY_CODE,   
INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, SELL_BUY  
/*  
UPDATE #STAMP_DATA SET L_STATE = C.L_STATE  
FROM #TBL_STAMP_DATA C  
WHERE C.PARTY_CODE = #STAMP_DATA.PARTY_CODE  
*/  
  
UPDATE #STAMP_DATA SET L_STATE = C1.L_STATE  
FROM CLIENT1 C1  
WHERE C1.CL_CODE = #STAMP_DATA.PARTY_CODE  
AND #STAMP_DATA.L_STATE = ''  
  
  
UPDATE #STAMP_DATA SET SRNO = C.SRNO  
FROM #FOSETTLEMENT C  
WHERE   
#STAMP_DATA.INST_TYPE = C.INST_TYPE  
AND #STAMP_DATA.SYMBOL = C.SYMBOL  
AND #STAMP_DATA.EXPIRYDATE = C.EXPIRYDATE   
AND #STAMP_DATA.STRIKE_PRICE = C.STRIKE_PRICE  
AND #STAMP_DATA.OPTION_TYPE = C.OPTION_TYPE    
AND #STAMP_DATA.PARTY_CODE = C.PARTY_CODE  
AND #STAMP_DATA.CONTRACTNO = C.CONTRACTNO  
AND #STAMP_DATA.SELL_BUY = C.SELL_BUY    
AND #STAMP_DATA.TRADEQTY = C.TRADEQTY  
AND C.TRADEQTY > 0   
AND AUCTIONPART =''  
AND PRICE > 0  
  
  
UPDATE #STAMP_DATA SET   
BUYSTAMP = (BUYAVGRATE * BUYQTY * BUYTAX) / 100,  
SELLSTAMP = (SELLAVGRATE * SELLQTY * SELLTAX) / 100  
FROM TBL_STAMP_TAX  
WHERE TBL_STAMP_TAX.INST_TYPE = #STAMP_DATA.INST_TYPE  
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
AND L_STATE <> 'SIKKIM'  
  
  
    
UPDATE #STAMP_DATA SET   
BUYSTAMP = CONVERT(NUMERIC(18,2),BUYSTAMP),  
SELLSTAMP = CONVERT(NUMERIC(18,2),SELLSTAMP)   
  
--UPDATE #STAMP_DATA SET TOTALSTAMP = CONVERT(NUMERIC(18,0),BUYSTAMP + SELLSTAMP)  
 UPDATE #STAMP_DATA SET TOTALSTAMP = BUYSTAMP + SELLSTAMP
 /** Differnce amount adjustment Start ***/ 
ALTER TABLE #STAMP_DATA
ADD SNO INT IDENTITY(1,1)

SELECT 
PARTY_CODE, CONTRACTNO, 
BROKER_CHRG = SUM(TOTALSTAMP), 
ACT_BROKER_CHRG = CONVERT(NUMERIC(18,0),SUM(TOTALSTAMP))
INTO #DIFF
FROM #STAMP_DATA
GROUP BY PARTY_CODE, CONTRACTNO
HAVING SUM(TOTALSTAMP) <> CONVERT(NUMERIC(18,0),SUM(TOTALSTAMP))
 
CREATE CLUSTERED INDEX IDX_SNO ON #STAMP_DATA
(	
	SNO
)		

CREATE INDEX #IDX_party ON #STAMP_DATA
(	
	party_code,Totalstamp
)	

		SET @STAMPCUR = CURSOR FOR 
			SELECT PARTY_CODE, CONTRACTNO, DIFF = ACT_BROKER_CHRG - BROKER_CHRG, 
			FLAG = (CASE WHEN ACT_BROKER_CHRG - BROKER_CHRG > 0 THEN 0 ELSE 1 END)
			FROM #DIFF
			WHERE BROKER_CHRG <> ACT_BROKER_CHRG 
		OPEN @STAMPCUR
		FETCH NEXT FROM @STAMPCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF, @FLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN 
			
			SET @DIFFCUR = CURSOR FOR
				SELECT SNO, TOTALSTAMP
				FROM #STAMP_DATA
				WHERE PARTY_CODE = @PARTY_CODE
				AND CONTRACTNO = (CASE WHEN @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END)
				AND TOTALSTAMP > 0 
				ORDER BY TOTALSTAMP DESC
			OPEN @DIFFCUR
			FETCH NEXT FROM @DIFFCUR INTO @SNO, @TOTALSTAMP
			WHILE @@FETCH_STATUS = 0 
			BEGIN
				IF @TOTALSTAMP > ABS(@DIFF) 
				BEGIN
					UPDATE #STAMP_DATA SET TOTALSTAMP = TOTALSTAMP + @DIFF
					WHERE SNO = @SNO
					SET @DIFF = 0 
				END
				ELSE
				BEGIN
					IF @FLAG = 0
					BEGIN
						UPDATE #STAMP_DATA SET TOTALSTAMP = TOTALSTAMP + @DIFF
						WHERE SNO = @SNO
						SET @DIFF = 0 
					END 
					ELSE
					BEGIN
						UPDATE #STAMP_DATA SET TOTALSTAMP = 0
						WHERE SNO = @SNO
						SET @DIFF = @DIFF + @TOTALSTAMP
					END 
				END
				FETCH NEXT FROM @DIFFCUR INTO @SNO, @TOTALSTAMP
			END
			CLOSE @DIFFCUR
			DEALLOCATE @DIFFCUR
		
			FETCH NEXT FROM @STAMPCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF, @FLAG
		END
		CLOSE @STAMPCUR
		DEALLOCATE @STAMPCUR 


		 /** Differnce amount adjustment End ***/ 
		  
DELETE FROM TBL_STAMP_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
  
INSERT INTO TBL_STAMP_DATA  
SELECT SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
    BUYQTY=SUM(BUYQTY),SELLQTY=SUM(SELLQTY),BUYAVGRATE=SUM(BUYAVGRATE),SELLAVGRATE=SUM(SELLAVGRATE),  
    BUYSTAMP=SUM(BUYSTAMP),SELLSTAMP=SUM(SELLSTAMP),TOTALSTAMP=SUM(TOTALSTAMP),  
    L_STATE,LASTRUNDATE=GETDATE()   
FROM #STAMP_DATA  
GROUP BY SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE, L_STATE  
  
UPDATE #STAMP_DATA SET BUYSTAMP = 0, SELLSTAMP = 0, TOTALSTAMP = 0    
FROM #FOCLIENTTAXES  
WHERE #FOCLIENTTAXES.PARTY_CODE = #STAMP_DATA.PARTY_CODE  
AND (FUT_BROKER_NOTE = 0  OR OPT_BROKER_NOTE = 0)  
--AND (Fut_Insurance_Chrg = 0  OR Opt_Insurance_Chrg = 0)  
  
UPDATE #STAMP_DATA SET BUYSTAMP = 0, SELLSTAMP = 0, TOTALSTAMP = 0    
FROM CLIENT2  
WHERE CLIENT2.PARTY_CODE = #STAMP_DATA.PARTY_CODE  
AND BrokerNOTE = 0    
  
UPDATE #FOSETTLEMENT  
SET BROKER_CHRG = #STAMP_DATA.TOTALSTAMP  
FROM #STAMP_DATA  
WHERE #FOSETTLEMENT.SRNO = #STAMP_DATA.SRNO  
  
--UPDATE  F 
--SET BROKER_CHRG = #FOSETTLEMENT.BROKER_CHRG  
--FROM #FOSETTLEMENT  ,[ANGELFO].NSEFO.DBO.FOSETTLEMENT  F With(Nolock)
--WHERE #FOSETTLEMENT.ORGSRNO = F.SRNO  
--AND EXCHG = 'NSEFO'  
  
UPDATE BSEFO.DBO.BFOSETTLEMENT  
SET BROKER_CHRG = #FOSETTLEMENT.BROKER_CHRG  
FROM #FOSETTLEMENT  
WHERE #FOSETTLEMENT.ORGSRNO = BFOSETTLEMENT.SRNO  
AND EXCHG = 'BSEFO'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_STAMP_DUTY_STATE
-- --------------------------------------------------



CREATE PROC [dbo].[CALCULATE_STAMP_DUTY_STATE]    
(          
	@SAUDA_DATE VARCHAR(11),    
	@FROMPARTY VARCHAR(10)='0',           
	@TOPARTY VARCHAR(10)='ZZZZZZZ'          
)    
AS    
    

IF @SAUDA_DATE = '' OR @SAUDA_DATE = '%' BEGIN  RETURN  END
  
BEGIN TRAN

CREATE TABLE #STAMP 
(
  [PARTY_CODE]         [VARCHAR](10),
  [BROKER_NOTE]        NUMERIC(36,12),
  [L_STATE]            [VARCHAR](50),
  [TURNOVER]           [DECIMAL](18,4),
  [ROUNDEDTURNOVER]    [DECIMAL](18,4),
  [TOBECHRG_STAMPDUTY] [DECIMAL](18,4)
)

CREATE TABLE #CLIENTLIST 
(
  PARTYCODE VARCHAR(10)
)

INSERT INTO #CLIENTLIST
SELECT PARTY_CODE
FROM   FOCLIENTTAXES (NOLOCK)
WHERE  @SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO
       AND FUT_BROKER_NOTE = 0
                             
INSERT INTO #CLIENTLIST
SELECT PARTY_CODE
FROM   CLIENT2 (NOLOCK)
WHERE  BROKERNOTE = 0
AND    PARTY_CODE NOT IN (SELECT PARTYCODE FROM #CLIENTLIST)
                    
/*UPDATING REST RECORDS BASED ON CLIENT'S STATE*/
UPDATE BFOSETTLEMENT
SET    BROKER_CHRG = 0
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
       AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
       AND EXISTS (SELECT PARTYCODE
                   FROM   #CLIENTLIST (NOLOCK) WHERE PARTY_CODE = PARTYCODE)


          
UPDATE BFOSETTLEMENT WITH (ROWLOCK)
SET    BROKER_CHRG = (CASE 
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY
                        ELSE (CASE WHEN AUCTIONPART='EA' THEN DELSTAMPDUTY ELSE TRDSTAMPDUTY END)
                      END * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'OPT' AND AUCTIONPART='EA' THEN STRIKE_PRICE ELSE TRADE_PRICE END) * TRADEQTY / 100)
FROM   CLIENT1 (NOLOCK),
       CLIENT2 (NOLOCK),
       STATE_MASTER
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE
       AND CLIENT2.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE
       AND L_STATE = STATE_MASTER.STATE
       AND BFOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE
       AND BFOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
       AND AUCTIONPART <> 'CA'
       AND NOT EXISTS (SELECT PARTYCODE
                       FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)
                      
/*UPDATING REST RECORDS BASED ON MEMEBER'S STATE*/
UPDATE BFOSETTLEMENT WITH(ROWLOCK)
SET    BROKER_CHRG = (CASE 
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY
                        ELSE (CASE WHEN AUCTIONPART='EA' THEN DELSTAMPDUTY ELSE TRDSTAMPDUTY END)
                      END * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'OPT' AND AUCTIONPART='EA' THEN STRIKE_PRICE ELSE TRADE_PRICE END) * TRADEQTY / 100)
FROM   CLIENT1 (NOLOCK),
       CLIENT2 (NOLOCK),
       STATE_MASTER,
       BFOOWNER
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE
       AND CLIENT2.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE
       AND L_STATE = BFOOWNER.STATE 
       AND L_STATE NOT IN (SELECT STATE
                           FROM   STATE_MASTER
                           WHERE  @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)
       AND BFOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
       AND BFOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
       AND AUCTIONPART <> 'CA'
       AND NOT EXISTS (SELECT PARTYCODE
                       FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)
                     
 
INSERT INTO #STAMP
SELECT   S.PARTY_CODE,
         BROKER_NOTE = SUM(BROKER_CHRG),
         L_STATE,
         TURNOVER = SUM(TRADEQTY * TRADE_PRICE),
         ROUNDEDTURNOVER = SUM(TRADEQTY * TRADE_PRICE),
         TOBECHRG_STAMPDUTY = SUM(BROKER_CHRG)
FROM     BFOSETTLEMENT S (NOLOCK),
         CLIENT1 C1 (NOLOCK),
         CLIENT2 C2 (NOLOCK)
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
         AND C1.CL_CODE = C2.CL_CODE
         AND C2.PARTY_CODE = S.PARTY_CODE
         AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
         AND TRADEQTY > 0
         AND TRADE_PRICE > 0
         AND AUCTIONPART <> 'CA'
         AND NOT EXISTS (SELECT PARTYCODE
                         FROM   #CLIENTLIST (NOLOCK) WHERE C2.PARTY_CODE = PARTYCODE)
   AND L_STATE IN (SELECT STATE
                         FROM   STATE_MASTER
                         WHERE  MIN_MULTIPLIER > 0
                                OR MAXIMUM_LIMIT > 0
                                    AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)
GROUP BY S.PARTY_CODE,L_STATE
         
UPDATE #STAMP
SET    ROUNDEDTURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(TURNOVER,FOR_TURNOVER)
FROM   STATE_MASTER (NOLOCK)
WHERE  L_STATE = STATE
       AND FOR_TURNOVER > 0
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE
                                                   
UPDATE #STAMP
SET    TOBECHRG_STAMPDUTY = (CASE 
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > MAXIMUM_LIMIT
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > BROKER_NOTE 
			 	THEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER
                               WHEN BROKER_NOTE > MAXIMUM_LIMIT
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT
                               ELSE BROKER_NOTE
                             END)
FROM   STATE_MASTER (NOLOCK)
WHERE  L_STATE = STATE
       AND FOR_TURNOVER > 0
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE
                                                   
UPDATE BFOSETTLEMENT WITH (ROWLOCK)
SET    BROKER_CHRG = 0
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
	AND EXISTS (SELECT PARTY_CODE
               FROM   #STAMP
               WHERE  BFOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
                      AND #STAMP.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE)
              
SELECT   PARTY_CODE,
         TRADESCRIPSELL = MIN(TRADE_NO + ORDER_NO + CONVERT(CHAR(1),SELL_BUY))
INTO     #SETTSTAMP
FROM     BFOSETTLEMENT (NOLOCK)
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
         AND AUCTIONPART <> 'CA'
         AND TRADEQTY > 0
         AND TRADE_PRICE > 0
         AND EXISTS (SELECT PARTY_CODE
                     FROM   #STAMP
                     WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
                            AND #STAMP.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE)
GROUP BY PARTY_CODE
         
UPDATE BFOSETTLEMENT WITH (ROWLOCK)
SET    BROKER_CHRG = TOBECHRG_STAMPDUTY
FROM   #STAMP (NOLOCK),
       #SETTSTAMP (NOLOCK)
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
       AND #STAMP.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE
       AND #SETTSTAMP.PARTY_CODE = #STAMP.PARTY_CODE
       AND #SETTSTAMP.TRADESCRIPSELL = BFOSETTLEMENT.TRADE_NO + BFOSETTLEMENT.ORDER_NO +
				 CONVERT(CHAR(1),BFOSETTLEMENT.SELL_BUY)
                                                                                       
EXEC CALCULATE_TRANS_CHRG @SAUDA_DATE

COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_TRANS_CHRG
-- --------------------------------------------------


CREATE PROC [dbo].[CALCULATE_TRANS_CHRG] (@SAUDA_DATE VARCHAR(11)) AS

IF (SELECT COUNT(1) FROM BFOOWNER (NOLOCK) WHERE ISNULL(TURN_CHRG_ON,2) = 1) > 0
BEGIN
	UPDATE BFOSETTLEMENT 
	SET TURN_TAX = ((FLOOR((((CASE 
						WHEN ORDER_ACTIVEFLAG = 0 THEN TURN_TAX_OPT_NONLEIPS_ACTIVE 
						ELSE TURN_TAX_OPT_NONLEIPS_PASSIVE 
						END * (BFOSETTLEMENT.TRADE_PRICE) * BFOSETTLEMENT.TRADEQTY) / 100) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))
	FROM
		FOCLIENTTAXES (NOLOCK), 
		BFOTAXES (NOLOCK),
		BFOSCRIP2 (NOLOCK),
		CLIENT1 C1(NOLOCK),
		CLIENT2 C2 (NOLOCK)
	 WHERE  
		C1.CL_CODE = C2.CL_CODE
		AND C2.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE
		AND BFOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE 
		AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO 
		AND BFOSETTLEMENT.AUCTIONPART <> 'EA'
		AND BFOTAXES.TRANS_CAT = CASE WHEN C2.TRAN_CAT = 'PRO' THEN 'PRO' ELSE 'TRD' END
		AND BFOSETTLEMENT.SAUDA_DATE BETWEEN BFOTAXES.FROM_DATE AND BFOTAXES.TO_DATE 
		AND RIGHT(BFOSETTLEMENT.PRODUCT_CODE,3) ='OPT'	 
		AND BFOSETTLEMENT.SERIES_ID = BFOSCRIP2.SERIES_ID
		AND BFOSETTLEMENT.PRODUCT_TYPE = BFOSCRIP2.PRODUCT_TYPE
		AND BFOSETTLEMENT.PRODUCT_CODE = BFOSCRIP2.PRODUCT_CODE
		AND BFOSETTLEMENT.EXPIRYDATE = BFOSCRIP2.EXPIRYDATE
		AND BFOSETTLEMENT.STRIKE_PRICE = BFOSCRIP2.STRIKE_PRICE
		AND BFOSETTLEMENT.OPTION_TYPE = BFOSCRIP2.OPTION_TYPE
		AND BFOSETTLEMENT.SERIES_CODE = BFOSCRIP2.SERIES_CODE
		--AND EXISTS (SELECT UL_ASSET_CODE FROM NONLEIPS_SCRIPTS (NOLOCK) WHERE  UL_ASSET_CODE=BFOSCRIP2.CA_LEVEL) 
		AND BFOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND OPT_TURNOVER_TAX <> 0

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_ACCESSIBLEUSER
-- --------------------------------------------------
CREATE PROC [DBO].[CBO_ACCESSIBLEUSER]
	@REPORTCODE INT,
	@USERCATEGORY VARCHAR(2000)
AS
/*
	CBO_ACCESSIBLEUSER 945, 388
*/

IF (SELECT COUNT(1) FROM TBLCATMENU WHERE FLDREPORTCODE = @REPORTCODE AND FLDCATEGORYCODE LIKE '%' + @USERCATEGORY + '%') > 0
	SELECT ALLOWED = 1
ELSE
	SELECT ALLOWED = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECK_USER
-- --------------------------------------------------
CREATE PROC [dbo].[CHECK_USER]      
(      
 @UID VARCHAR(50),      
 @STNAME VARCHAR(50),      
 @RESULT INT OUTPUT      
)       
/*      
CHECK_USER 'DFS','',''
      
SELECT * FROM MSAJAG..CLIENT_DETAILS WHERE CL_CODE = '00000031'       
SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME ='TEST'
*/       
     
AS      
 DECLARE @COUNT SMALLINT      
       
SET @COUNT = 0       
      
IF UPPER(@STNAME) = 'CLIENT'      
 BEGIN      
 SELECT @COUNT = COUNT(*) FROM MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = @UID      
       
 IF @COUNT = 0       
  BEGIN      
  SET @RESULT = 2 --'NOTEXISTS'      
  SELECT @RESULT      
  RETURN      
  END      
 END       

SELECT @COUNT = COUNT(FLDNAME) FROM TBLUSERBLOCK WHERE FLDNAME LIKE '%'+@UID OR FLDNAME LIKE @UID+'%'
IF @COUNT <> 0       
 BEGIN      
 SET @RESULT = 4 --'INVALID'      
 SELECT @RESULT      
 RETURN      
 END      

      
SELECT       
 @COUNT = COUNT(FLDUSERNAME) FROM TBLPRADNYAUSERS (NOLOCK) WHERE FLDUSERNAME LIKE @UID      
      
IF @COUNT <> 0       
 BEGIN      
 SET @RESULT = 1 --'EXSITSINMASTER'      
 SELECT @RESULT      
 RETURN      
 END      
ELSE      
 BEGIN      
 SET @RESULT = 0 --'OK'      
 SELECT @RESULT      
 RETURN      
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION
-- --------------------------------------------------

CREATE PROC [dbo].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '0=>9S32WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_03052012
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_03052012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@Z'  
SET @ERRCODE2 = '<<!9S02WJ759S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '///\3?0'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'N75'  
SET @ERRCODE11 = 'R7X'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'R5X'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_11Jan2019
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '</{9U72WJ7Z9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16102012
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_16102012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@Z'  
SET @ERRCODE2 = '5,/9S42WJ759S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '///\3?0'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'N75'  
SET @ERRCODE11 = 'R7X'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'R5X'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_17072012
-- --------------------------------------------------

  
CREATE PROC [DBO].[CHECKVERSION_17072012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@Z'  
SET @ERRCODE2 = '0/*9S32WJ759S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '///\3?0'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'N75'  
SET @ERRCODE11 = 'R7X'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'R5X'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_23062017
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '0/*9S22WJ7 9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_24May2019
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '7=99U72WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_Bkup_20Jan2020
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '5,/9S52WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_26Jul2023
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '0/*9U92WJ649S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_USER_COUNT
-- --------------------------------------------------
CREATE PROC [dbo].[CLASS_USER_COUNT]  
(  
 @UNAME VARCHAR(30),  
 @ADMIN_NAME VARCHAR(30),
 @CUREXCHSEG VARCHAR(50) 	  
)  
/*  
 CLASS_USER_COUNT 'TEST', 'ADMINISTRATOR', ''  
 SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DSS'  
EXEC CLASS_USER_COUNT 'SAMARTHLANJEKAR','Broker','NSE~~CAPITAL'

*/  
AS  
 DECLARE    
 @@EXCHANGE AS VARCHAR(3),  
 @@SEGMENT AS VARCHAR(15),  
 @@SHARESVR AS VARCHAR(20),  
 @@SHAREDB   AS VARCHAR(20),  
 @@SEGORD AS TINYINT,  
 @@SQL  AS VARCHAR(500),  
 @@MAINREC AS CURSOR  
   
  CREATE TABLE [DBO].[#RESULT]    
  (    
  EXCHANGE VARCHAR(6),     
  SEGMENT VARCHAR(10),  
  RESULT VARCHAR(100)  
  ) ON [PRIMARY]  
    
 CREATE TABLE #USERS  
 (  
  FLDUSERNAME VARCHAR(30)  
 )  
  
 IF UPPER(@ADMIN_NAME) = 'ADMINISTRATOR'
 BEGIN
  SET @@MAINREC = CURSOR FOR 	  	
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE PRIMARYSERVER = 1 ORDER BY 1   
 END
 ELSE
 BEGIN
  SET @@MAINREC = CURSOR FOR 	
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE EXCHANGE + '~~' + SEGMENT = 	@CUREXCHSEG  AND PRIMARYSERVER = 1 ORDER BY 1
 END		
   
 SET @@SEGORD = 1    
 OPEN @@MAINREC    
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR   
  WHILE @@FETCH_STATUS = 0  
   BEGIN  
   IF @@SHARESVR <> @@SERVERNAME   
    BEGIN  
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "  
    END  
    ELSE  
    BEGIN   
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME #USERS FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "  
    END  
   PRINT(@@SQL)  
   EXEC(@@SQL)   
  --SELECT * FROM #USERS   
  IF @@ROWCOUNT <> 0  
   BEGIN  
   INSERT INTO #RESULT VALUES(@@EXCHANGE,@@SEGMENT,'USER AVAILABLE')  
   END   
    
 SET @@SEGORD = @@SEGORD + 1  
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR  
 END   
  
 SELECT * FROM #RESULT  
 DROP TABLE #RESULT  
 DROP TABLE #USERS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_ADMIN
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[CLASS_VALIDATE_ADMIN]    
(    
    @ADMINID     VARCHAR(50),    
    @IPADDRESS  VARCHAR(20),    
    @RETCODE    INT  OUTPUT,    
    @RETMSG     VARCHAR(200)  OUTPUT,    
    @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,    
    @LASTLOGIN VARCHAR(40) OUTPUT    
)    
AS    

  DECLARE  @@USER_COUNT TINYINT    
  DECLARE  @@LASTLOGIN VARCHAR(40)      
  DECLARE  @@USER_SESSION VARCHAR(200)    
    
                              
  SELECT @@USER_COUNT = COUNT(1)    
  FROM   TBLCLASSADMINLOGINS (NOLOCK)    
  WHERE  FLDADMINNAME = @ADMINID    
                        
  IF ISNULL(@@USER_COUNT,0) = 0    
    BEGIN    
      INSERT INTO TBLCLASSADMINLOGINS    
	  (    
	   FLDAUTO,    
	   FLDADMINNAME,    
	   FLDSTATUS,    
	   FLDSTNAME,    
	   FLDSESSION,    
	   FLDIPADDRESS,    
	   FLDLASTVISIT,    
	   FLDTIMEOUTPRD    
	  )  
	  SELECT A.FLDAUTO_ADMIN,    
		A.FLDNAME,    
		A.FLDSTATUS,    
		A.FLDSTNAME,    
		'',    
		'',    
		GETDATE(),    
		''   
	  FROM   TBLADMIN A (NOLOCK)    
	  WHERE  A.FLDNAME = @ADMINID   
                                 
	  IF @@ERROR <> 0    
		BEGIN    
		 SET @RETCODE = 0    
		 SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'    
		 RETURN    
		END    
	END    
        
    
 SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)    
 FROM TBLCLASSADMINLOGINS    
 WHERE FLDADMINNAME = @ADMINID    
    
    
 SET @@USER_SESSION = NEWID()    
                           
 UPDATE TBLCLASSADMINLOGINS    
 SET    FLDIPADDRESS = @IPADDRESS,    
   FLDSESSION = @@USER_SESSION,    
   FLDLASTVISIT = GETDATE(),    
   FLDLASTLOGIN = GETDATE()    
 WHERE  FLDADMINNAME = @ADMINID    
                            
  IF @@ERROR <> 0    
    BEGIN    
  SET @RETCODE = 0    
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'    
  RETURN    
    END    
        
  SET @RETCODE = 1    
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'    
  SET @UM_SESSION = @@USER_SESSION    
  SET @LASTLOGIN = @@LASTLOGIN                    
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_USER
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[CLASS_VALIDATE_USER]  
(  
                @USERID     VARCHAR(50),  
                @IPADDRESS  VARCHAR(20),  
                @RETCODE    INT  OUTPUT,  
                @RETMSG     VARCHAR(200)  OUTPUT,  
                @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,  
				@LASTLOGIN VARCHAR(40) OUTPUT  
)  
AS  
  
  DECLARE  @@USER_COUNT TINYINT  
  DECLARE  @@LASTLOGIN VARCHAR(40)    
  DECLARE  @@USER_SESSION VARCHAR(200)  
  
                            
  SELECT @@USER_COUNT = COUNT(1)  
  FROM   TBLCLASSUSERLOGINS (NOLOCK)  
  WHERE  FLDUSERNAME = @USERID  
                         
  IF ISNULL(@@USER_COUNT,0) = 0  
    BEGIN  
      
  INSERT INTO TBLCLASSUSERLOGINS  
  (  
   FLDAUTO,  
   FLDUSERNAME,  
   FLDSTATUS,  
   FLDSTNAME,  
   FLDSESSION,  
   FLDIPADDRESS,  
   FLDLASTVISIT,  
   FLDTIMEOUTPRD  
  )  
  SELECT P.FLDAUTO,  
     P.FLDUSERNAME,  
     A.FLDSTATUS,  
     P.FLDSTNAME,  
     '',  
     '',  
     GETDATE(),  
     ISNULL(M.FLDTIMEOUT,1)  
  FROM   TBLPRADNYAUSERS P (NOLOCK)  
     LEFT OUTER JOIN TBLUSERCONTROLMASTER M (NOLOCK)  
    ON (M.FLDUSERID = P.FLDAUTO)  
     INNER JOIN TBLADMIN A (NOLOCK)  
    ON (P.FLDADMINAUTO = A.FLDAUTO_ADMIN)  
  WHERE  P.FLDUSERNAME = @USERID  
                               
  IF @@ERROR <> 0  
    BEGIN  
   SET @RETCODE = 0  
             
   SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'  
             
   RETURN  
    END  
          
    END  
      
  
     SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)  
 FROM TBLCLASSUSERLOGINS  
 WHERE FLDUSERNAME = @USERID  
  
  
 SET @@USER_SESSION = NEWID()  
                         
 UPDATE TBLCLASSUSERLOGINS  
 SET    FLDIPADDRESS = @IPADDRESS,  
   FLDSESSION = @@USER_SESSION,  
   FLDLASTVISIT = GETDATE(),  
   FLDLASTLOGIN = GETDATE()  
 WHERE  FLDUSERNAME = @USERID  
                          
  IF @@ERROR <> 0  
    BEGIN  
  SET @RETCODE = 0  
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'  
  RETURN  
    END  
      
  SET @RETCODE = 1  
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'  
  SET @UM_SESSION = @@USER_SESSION  
  SET @LASTLOGIN = @@LASTLOGIN                  
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENTMARGIN_UPD
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[CLIENTMARGIN_UPD] 
(
	@MDATE VARCHAR(11)
 ) AS        
         
 DECLARE @@OPENDATE  AS VARCHAR(11)          
         
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
 SELECT * INTO #TBL_CLIENTMARGIN FROM TBL_CLIENTMARGIN WHERE 1=2        
         
 INSERT INTO #TBL_CLIENTMARGIN         
         
 SELECT DISTINCT C2.PARTY_CODE,@MDATE + ' 00:00',0,0,0,0,0,GETDATE(),C1.SHORT_NAME,         
 LEFT(C1.LONG_NAME,50),C1.BRANCH_CD,C1.FAMILY,C1.SUB_BROKER,        
 C1.TRADER,0,0 FROM CLIENT2 C2, CLIENT1 C1        
 WHERE C1.CL_CODE = C2.CL_CODE        
         
 SELECT PARTY_CODE,AMOUNT=ISNULL(SUM((CASE WHEN SELL_BUY=2 THEN      
 ISNULL(AMOUNT,0) ELSE (0-ISNULL(AMOUNT,0)) END)),0)          
 INTO #PARTYBILL        
 FROM BFOACCBILL WHERE         
 PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #TBL_CLIENTMARGIN) AND BILLDATE BETWEEN @MDATE AND @MDATE + ' 23:59'    
 GROUP BY PARTY_CODE        
         
 UPDATE T SET BILLAMOUNT=AMOUNT FROM #TBL_CLIENTMARGIN T, #PARTYBILL P WHERE P.PARTY_CODE = T.PARTY_CODE        
         
        
         
 /*GETTING CLOSING BALANCE FROM LEDGER WITH OUT  TODAY'S BILL*/        
DECLARE @SDTCUR AS VARCHAR(11)
SELECT @SDTCUR = SDTCUR FROM ACCOUNTBFO.DBO.PARAMETER WHERE @MDATE BETWEEN SDTCUR AND LDTCUR

SELECT 
	CLTCODE, 
	OPPBAL = SUM( CASE WHEN DRCR ='C' THEN VAMT ELSE - VAMT END) 
INTO #OPPBALANCEFINAL
FROM 
	ACCOUNTBFO.DBO.LEDGER (NOLOCK)
WHERE 
	VDT BETWEEN @SDTCUR  AND @MDATE +' 23:59:59'
GROUP BY CLTCODE
		
 UPDATE T SET LEDGERAMOUNT=OPPBAL FROM #TBL_CLIENTMARGIN T,#OPPBALANCEFINAL P WHERE P.CLTCODE = T.PARTY_CODE        
         
        
 /*GETTING COLLATERAL FROM MSAJAG*/        
         
 SELECT PARTY_CODE,ACTCASH = ISNULL(CASH,0),ACTNONCASH=ISNULL(NONCASH,0)         
 INTO #COLLATERAL        
 FROM MSAJAG.DBO.COLLATERAL          
 WHERE EXCHANGE = (SELECT TOP 1 EXCHANGE FROM BFOTAXES (NOLOCK))          
 AND SEGMENT = 'FUTURES'          
 AND PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #TBL_CLIENTMARGIN)      
 AND TRANS_DATE BETWEEN @MDATE AND @MDATE + ' 23:59'         
         
 UPDATE T SET CASH_COLL=ACTCASH,NONCASH_COLL=ACTNONCASH FROM #TBL_CLIENTMARGIN T, #COLLATERAL P       
 WHERE P.PARTY_CODE = T.PARTY_CODE        
         
        
 /*GETTING MARGIN DETAILS*/        
         
 SELECT  PARTY_CODE,ABS(SUM(SPAN_MARGIN)) MARGINAMOUNT, MTMMARGIN = 0      
 INTO #MARGIN        
 FROM BFOMARGIN   
 WHERE MARGIN_DATE = @MDATE
 GROUP BY PARTY_CODE         
         
 UPDATE T SET INITIALMARGIN=P.MARGINAMOUNT,MTMMARGIN=P.MTMMARGIN FROM #TBL_CLIENTMARGIN T, #MARGIN P       
 WHERE P.PARTY_CODE = T.PARTY_CODE        
     
 /*UPDATING TBL_CLIENTMARGIN*/        
 DELETE TBL_CLIENTMARGIN  WHERE MARGINDATE = @MDATE       
         
 INSERT  INTO TBL_CLIENTMARGIN SELECT * FROM #TBL_CLIENTMARGIN  WHERE      
 (BILLAMOUNT<>0 OR INITIALMARGIN <> 0 OR LEDGERAMOUNT <> 0 OR  CASH_COLL <> 0 OR NONCASH_COLL <> 0)        
 ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENTMARGIN_UPD_NEW
-- --------------------------------------------------
CREATE  PROC  [DBO].[CLIENTMARGIN_UPD_NEW] (@DATEFROM VARCHAR (20),@DATETO AS VARCHAR(20))
AS      
  
DECLARE      
@MDATE  VARCHAR(11),
@DATECUR CURSOR      
      
SET @DATECUR = CURSOR FOR      
SELECT  DISTINCT  LEFT(FILE_DATE,11)  FROM BFOMARGINCOLL WHERE FILE_DATE BETWEEN @DATEFROM AND @DATETO
OPEN @DATECUR      
      
FETCH NEXT FROM @DATECUR INTO @MDATE
WHILE @@FETCH_STATUS = 0       
BEGIN      
      
 EXECUTE CLIENTMARGIN_UPD  @MDATE
    
 FETCH NEXT FROM @DATECUR INTO @MDATE
END      
CLOSE @DATECUR      
DEALLOCATE @DATECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_ADDITIONAL_TAX_CAL
-- --------------------------------------------------




CREATE PROC [dbo].[CLS_ADDITIONAL_TAX_CAL]
	(
	@SAUDA_DATE VARCHAR(11),
	@FROMPARTY  VARCHAR(10)='0',      
	@TOPARTY	VARCHAR(10)='ZZZZZZZZZZ'
	)
	
	AS
	
	/*
	EXEC CLS_ADDITIONAL_TAX_CAL 'JUN 12 2023','','ZZZZZZ'
	*/

	DECLARE	@IPFTCHRG_FUT	NUMERIC(18,4),
			@IPFTCHRG_OPT	NUMERIC(18,4),
			@IPFTCHRG_INS	NUMERIC(18,4)

	
	SELECT	@IPFTCHRG_FUT = ISNULL(IPFTCHRG_FUT,0), @IPFTCHRG_OPT = ISNULL(IPFTCHRG_OPT,0), @IPFTCHRG_INS = ISNULL(IPFTCHRG_INS,0) 
	FROM	BFOGLOBALS (NOLOCK)
	WHERE	@SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

	IF (@IPFTCHRG_FUT+@IPFTCHRG_OPT) = 0
	BEGIN
		RETURN 
	END
		
	CREATE TABLE #ADDITIONAL_TAX_DATA
		(
		PARTY_CODE	VARCHAR(20),
		SAUDA_DATE	DATETIME,
		SETT_NO		VARCHAR(10),
		SETT_TYPE	VARCHAR(3),
		CONTRACTNO	VARCHAR(10),
		ORDER_NO	VARCHAR(20),
		TRADE_NO	VARCHAR(20),
		INST_TYPE	VARCHAR(12),
		SYMBOL		VARCHAR(50),
		EXPIRYDATE	DATETIME,
		STRIKE_PRICE	NUMERIC(18,4),
		OPTION_TYPE	VARCHAR(2),
		PRICE		NUMERIC(18,4),
		TRADEQTY	INT,
		AMOUNT		NUMERIC(18,4),
		SELL_BUY	INT,
		TRDTYPE		CHAR(1),
		IPFT_CHRG	NUMERIC(18,4),
		ADD_CHRG_1	NUMERIC(18,4),
		ADD_CHRG_2	NUMERIC(18,4),
		ADD_CHRG_3	NUMERIC(18,4),
		ADD_CHRG_4	NUMERIC(18,4),
		ADD_CHRG_5	NUMERIC(18,4)
		)

	CREATE NONCLUSTERED INDEX [IDXADX1] ON [#ADDITIONAL_TAX_DATA] 
		(
		[SAUDA_DATE] ASC,
		[PARTY_CODE] ASC,
		[CONTRACTNO] ASC,
		[INST_TYPE] ASC,
		[SYMBOL] ASC,
		[EXPIRYDATE] ASC,
		[STRIKE_PRICE] ASC,
		[OPTION_TYPE] ASC,
		[SELL_BUY] ASC
		)

	INSERT	INTO #ADDITIONAL_TAX_DATA
	SELECT	PARTY_CODE,
			SAUDA_DATE = LEFT(SAUDA_DATE,11),
			SETT_NO = '',
			SETT_TYPE = '',
			CONTRACTNO,
			ORDER_NO = '',
			TRADE_NO = '',
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			PRICE = SUM(PRICE*TRADEQTY)/SUM(TRADEQTY),
			TRADEQTY = SUM(TRADEQTY),
			AMOUNT = SUM(PRICE*TRADEQTY),
			SELL_BUY,
			TRDTYPE	= 'N',
			IPFT_CHRG = 0,
			ADD_CHRG_1 = 0,
			ADD_CHRG_2 = 0,
			ADD_CHRG_3 = 0,
			ADD_CHRG_4 = 0,
			ADD_CHRG_5 = 0
	FROM	FOSETTLEMENT
	WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
			AND TRADEQTY > 0 AND PRICE > 0
			AND AUCTIONPART <> 'CA'
			AND ( RESERVED1 = 0  
 			OR NOT EXISTS (SELECT CL_CODE FROM CLIENT1 C1 (NOLOCK) WHERE CL_TYPE = 'INS' AND C1.CL_CODE = FOSETTLEMENT.PARTY_CODE) ) 
	GROUP BY
			PARTY_CODE,
			LEFT(SAUDA_DATE,11),
			SETT_NO,
			SETT_TYPE,
			CONTRACTNO,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			SELL_BUY


	IF (@IPFTCHRG_INS = 1)
	BEGIN
		INSERT	INTO #ADDITIONAL_TAX_DATA
		SELECT	PARTY_CODE,
				SAUDA_DATE = LEFT(SAUDA_DATE,11),
				SETT_NO = '',
				SETT_TYPE = '',
				CONTRACTNO,
				ORDER_NO = '',
				TRADE_NO = '',
				INST_TYPE,
				SYMBOL,
				EXPIRYDATE,
				STRIKE_PRICE,
				OPTION_TYPE,
				PRICE = SUM(PRICE*TRADEQTY)/SUM(TRADEQTY),
				TRADEQTY = SUM(TRADEQTY),
				AMOUNT = SUM(PRICE*TRADEQTY),
				SELL_BUY,
				TRDTYPE	= 'I',
				IPFT_CHRG = 0,
				ADD_CHRG_1 = 0,
				ADD_CHRG_2 = 0,
				ADD_CHRG_3 = 0,
				ADD_CHRG_4 = 0,
				ADD_CHRG_5 = 0
		FROM	FOSETTLEMENT
		WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' 
				AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
				AND TRADEQTY > 0 AND PRICE > 0
				AND AUCTIONPART <> 'CA'
				AND ( RESERVED1 = 1  
 				OR EXISTS (SELECT CL_CODE FROM CLIENT1 C1 (NOLOCK) WHERE CL_TYPE = 'INS' AND C1.CL_CODE = FOSETTLEMENT.PARTY_CODE) ) 
		GROUP BY
				PARTY_CODE,
				LEFT(SAUDA_DATE,11),
				SETT_NO,
				SETT_TYPE,
				CONTRACTNO,
				INST_TYPE,
				SYMBOL,
				EXPIRYDATE,
				STRIKE_PRICE,
				OPTION_TYPE,
				SELL_BUY
	END

	/*
	UPDATE	#ADDITIONAL_TAX_DATA
	SET		IPFT_CHRG = ROUND(AMOUNT*TAX1/100,4)
	FROM	CLIENTTAXES_NEW C (NOLOCK)
	WHERE	C.PARTY_CODE = #ADDITIONAL_TAX_DATA.PARTY_CODE
			AND @SAUDA_DATE BETWEEN FROMDATE AND TODATE
			AND TAX1 > 0
	*/
	
	UPDATE	#ADDITIONAL_TAX_DATA
	SET		IPFT_CHRG = ROUND(AMOUNT*@IPFTCHRG_FUT/100,4)
	WHERE	AMOUNT > 0 AND @IPFTCHRG_FUT <> 0
			AND RIGHT(INST_TYPE,3) = 'FUT'
			AND TRDTYPE	= 'N'

	UPDATE	#ADDITIONAL_TAX_DATA
	SET		IPFT_CHRG = ROUND(AMOUNT*@IPFTCHRG_OPT/100,4)
	WHERE	AMOUNT > 0 AND @IPFTCHRG_OPT <> 0
			AND RIGHT(INST_TYPE,3) = 'OPT'
			AND TRDTYPE	= 'N'
	
	UPDATE	#ADDITIONAL_TAX_DATA
	SET		IPFT_CHRG = ROUND(AMOUNT*@IPFTCHRG_FUT/100,4)
	WHERE	AMOUNT > 0 AND @IPFTCHRG_FUT <> 0
			AND RIGHT(INST_TYPE,3) = 'FUT'
			AND TRDTYPE	= 'I'

	UPDATE	#ADDITIONAL_TAX_DATA
	SET		IPFT_CHRG = ROUND(AMOUNT*@IPFTCHRG_OPT/100,4)
	WHERE	AMOUNT > 0 AND @IPFTCHRG_OPT <> 0
			AND RIGHT(INST_TYPE,3) = 'OPT'
			AND TRDTYPE	= 'I'
	
	DELETE	FROM TBL_ADDITIONAL_TAX_DATA
	WHERE	SAUDA_DATE	BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 


	INSERT	INTO TBL_ADDITIONAL_TAX_DATA
	SELECT	* FROM #ADDITIONAL_TAX_DATA


	DROP TABLE #ADDITIONAL_TAX_DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BULK_INS
-- --------------------------------------------------


CREATE PROC [DBO].[CLS_BULK_INS] (@FILENAME VARCHAR(200), @SESSIONID VARCHAR(30), @PARSESTRING VARCHAR(2) = ',', @ROWDELI VARCHAR(10) = '\N') AS 

DECLARE @STRSQL VARCHAR(500)
IF @ROWDELI ='E' SET @ROWDELI = CHAR(10)

DELETE CLASSFILEUPD_BULK WHERE SPID =
 CONVERT(VARCHAR,@@SPID)
DELETE CLASSFILEUPD_BULK WHERE SPID = @SESSIONID

SET @STRSQL = 'BULK INSERT  CLASSFILEUPD_BULK_VIEW FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = ''' + @PARSESTRING + ''', ROWTERMINATOR = ''' + @ROWDELI +''' )'
EXEC(@STRSQL)

UPDATE CLASSFILEUPD_BULK SET SPID = @SESSIONID WHERE SPID = CONVERT(VARCHAR,@@SPID)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLIST_REPORT
-- --------------------------------------------------

-- EXEC CLS_CLIENTLIST_REPORT '30/07/2014','30/07/2014','','','','','ALL','PARTYCODE','BRANCH','STAFF'

CREATE PROCEDURE  [DBO].[CLS_CLIENTLIST_REPORT]
 (
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@CLTYPE VARCHAR(10) ='',
	@CLTSTATUS VARCHAR(10)='',
	@FILTERCD VARCHAR(10) ='ALL',
	@ORDER_BY AS VARCHAR(16)='PARTYCODE',
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25)
 )
 
 AS
 
 
 /*
	@FILTERCD
	A 		 - 	 ACTIVE
	IN 		 - 	 INACTIVE
	ACT 	 - 	 ACTIVATED
	DACT 	 - 	 DEACTIVATED
	MAIL 	 - 	 NOT HAVING MAIL ID
	PAN 	 - 	 NOT HAVING PAN NO
	TELR 	 - 	 NOT HAVING TELEPHONE (R)
	TELO 	 - 	 NOT HAVING TELEPHONE (O)
	MOBILE 	 - 	 NOT HAVING MOBILE
	FAX 	 - 	 NOT HAVING FAX
	ADD1 	 - 	 NOT HAVING ADDRESS1
	ADD2 	 - 	 NOT HAVING ADDRESS2
	ADD3 	 - 	 NOT HAVING ADDRESS3
	CITY 	 - 	 NOT HAVING CITY
	STATE 	 - 	 NOT HAVING STATE
	ZIP 	 - 	 NOT HAVING ZIP
	
	
	@ORDER_BY
	BRANCH		-	BRANCH
	PARTYCODE	-	PARTY CODE
	CLIENT		-	CLIENT NAME
	ACTIVE		-	ACTIVE
	INACTIVE	-	INACTIVE

*/

SET @FROMDATE = LEFT(CONVERT(DATETIME,@FROMDATE,103),11)
SET @TODATE = LEFT(CONVERT(DATETIME,@TODATE,103),11)

IF @TOPARTY =''
SET @TOPARTY = 'ZZZZZZZ'

SELECT            
    C1.CL_CODE,         
    C1.SHORT_NAME,         
    C1.LONG_NAME,         
    ISNULL(C1.BRANCH_CD,'-') AS BRANCH_CD,         
    ISNULL(C1.PAN_GIR_NO,'-') AS PAN_GIR_NO,
    ISNULL(CONVERT(VARCHAR(11),ACTIVEFROM),'-') AS ACTIVEFROM,         
    ISNULL(CONVERT(VARCHAR(11),INACTIVEFROM),'-') AS INACTIVEFROM,
	ORDERBY = (          
    CASE           
        WHEN @ORDER_BY = 'BRANCH'           
        THEN C1.BRANCH_CD+C2.PARTY_CODE           
        ELSE       
        CASE
            WHEN @ORDER_BY = 'PARTYCODE'           
            THEN C2.PARTY_CODE           
            ELSE           
            CASE           
                WHEN @ORDER_BY = 'CLIENT'           
                THEN C1.SHORT_NAME+C2.PARTY_CODE           
                ELSE           
                CASE           
                    WHEN @ORDER_BY = 'ACTIVE'           
                    THEN CONVERT(VARCHAR(11),ACTIVEFROM)+C2.PARTY_CODE           
                    ELSE           
                    CASE           
                        WHEN @ORDER_BY = 'INACTIVE'           
                        THEN CONVERT(VARCHAR(11),INACTIVEFROM)+C2.PARTY_CODE        
                    END           
                END           
            END           
        END           
    END           
    )        
FROM CLIENT1 C1 (NOLOCK),    
CLIENT5 CL5 (NOLOCK), 
CLIENT2 C2 (NOLOCK)  
WHERE  1 = (CASE WHEN @FILTERCD='' THEN CASE WHEN CL5.ACTIVEFROM BETWEEN  @FROMDATE AND @TODATE + ' 23:59:59'  THEN 1 ELSE 2 END ELSE   
	   CASE WHEN @FILTERCD = 'MAIL' THEN (CASE WHEN C1.EMAIL = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'PAN' THEN (CASE WHEN C1.PAN_GIR_NO = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'TELR' THEN (CASE WHEN C1.RES_PHONE1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'TELO' THEN (CASE WHEN C1.OFF_PHONE1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'MOBILE' THEN (CASE WHEN C1.MOBILE_PAGER = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'FAX' THEN (CASE WHEN C1.FAX = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD1' THEN (CASE WHEN C1.L_ADDRESS1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD2' THEN (CASE WHEN C1.L_ADDRESS2 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD3' THEN (CASE WHEN C1.L_ADDRESS3 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'CITY' THEN (CASE WHEN C1.L_CITY = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'STATE' THEN (CASE WHEN C1.L_STATE = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ZIP' THEN (CASE WHEN C1.L_ZIP = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'A' THEN (CASE WHEN GETDATE() BETWEEN ACTIVEFROM AND INACTIVEFROM THEN 1 ELSE 2 END)
	   WHEN @FILTERCD = 'IN' THEN (CASE WHEN INACTIVEFROM < GETDATE()  THEN 1 ELSE 2 END) 
	   WHEN @FILTERCD = 'ACT' THEN (CASE WHEN CL5.ACTIVEFROM BETWEEN @FROMDATE AND @TODATE + ' 23:59' THEN 1 ELSE 2 END) 
	   WHEN @FILTERCD = 'DACT' THEN (CASE WHEN CL5.INACTIVEFROM BETWEEN @FROMDATE AND @TODATE + ' 23:59'  THEN 1 ELSE 2 END) 
     ELSE 1
    END
    END )      
	AND	
C1.CL_CODE = CL5.CL_CODE
AND C1.CL_CODE = C2.CL_CODE        
AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND CL5.SYSTUMDATE BETWEEN  @FROMDATE AND @TODATE + ' 23:59:59'
	AND CL_TYPE  = CASE WHEN @CLTYPE = '' THEN CL_TYPE ELSE @CLTYPE END
	AND CL_STATUS  = CASE WHEN @CLTSTATUS = '' THEN CL_STATUS ELSE @CLTSTATUS END
	AND @STATUSNAME = (CASE WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
		WHEN @STATUSID = 'TRADER' THEN C1.TRADER
		WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
		WHEN @STATUSID = 'AREA' THEN C1.AREA
		WHEN @STATUSID = 'REGION' THEN C1.REGION
		WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
	ELSE 'BROKER' END)
ORDER BY 8

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLOSING_RATE
-- --------------------------------------------------

  
CREATE PROC [DBO].[CLS_CLOSING_RATE]  
 (  
	@FRMDATE VARCHAR(10),  
	@TODATE  VARCHAR(10),
	@SCRIPCD VARCHAR(20),
	@INST_TYPE VARCHAR(3)
 )  
   
 AS  
  
 --EXEC CLS_CLOSING_RATE '01/05/2000','31/12/2014' ,'' ,'' 
   
 DECLARE @R_FRMDATE VARCHAR(11),  
   @R_TODATE VARCHAR(11)  
   
 SELECT @R_FRMDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FRMDATE,103),109)  
 SELECT @R_TODATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE,103),109)  
   
 SELECT  
	TRADE_DATE=CONVERT(VARCHAR(11),TRADE_DATE,103),
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE = CONVERT(VARCHAR(11),EXPIRYDATE,103),
	STRIKE_PRICE,
	OPTION_TYPE,
	CL_RATE
 FROM  
  FOCLOSING (NOLOCK)  
 WHERE  
  TRADE_DATE BETWEEN @R_FRMDATE AND @R_TODATE + ' 23:59:59' 
  AND SYMBOL = (CASE WHEN @SCRIPCD = '' THEN SYMBOL ELSE @SCRIPCD END)
  AND LEFT(INST_TYPE,3) = (CASE WHEN @INST_TYPE = '' THEN LEFT(INST_TYPE,3) ELSE @INST_TYPE END)
 ORDER BY  1,2,3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_DAS_HEADER
-- --------------------------------------------------
  
CREATE PROC [DBO].[CLS_DAS_HEADER]  
 (  
  @FROMDATE VARCHAR(11)  
 )  
   
 AS  
   
 /*  
 DECLARE @FROMDATE VARCHAR(11)  
 SET  @FROMDATE = '12/09/2014'  
 EXEC CLS_COMMON_CONTRACT_HEADER '17/03/2009'   
 */  
  
 CREATE TABLE #COMPANY_INFO  
  (  
  COMPANY   VARCHAR(100),   
  COMPANY_ADDR1 VARCHAR(100),   
  COMPANY_ADDR2 VARCHAR(100),   
  COMPANY_CITY VARCHAR(50),   
  COMPANY_ZIP  VARCHAR(10),   
  COMPANY_PHONE VARCHAR(50),   
  COMPANY_FAX  VARCHAR(50),  
  EXCHANGECODE VARCHAR(3),   
  TM_CODE   VARCHAR(20),  
  BROKERSEBIREGNO VARCHAR(20),  
  COMPANY_PANNO VARCHAR(50),   
  COMPANY_EMAIL VARCHAR(100),  
  COMPLIANCE_NAME VARCHAR(100),  
  COMPLIANCE_EMAIL VARCHAR(100),  
  COMPLIANCE_PHONE VARCHAR(50),  
  COMPLIANCE_MOBILE VARCHAR(50),  
  SERVICES_TAXNO  VARCHAR(50),  
  WEBSITE_ID   VARCHAR(100),  
  LOGO_FILE_PATH  VARCHAR(100),  
  COMPANY_CIN   VARCHAR(30) 
  /*COMMONSEBINO  VARCHAR(200),  
  COMMONMEMBERCODE VARCHAR(200),  
  IGRIV_EMAIL   VARCHAR(200),   
  CORP_ADDR1   VARCHAR(100),  
  CORP_ADDR2   VARCHAR(100),  
  CORP_ADDR3   VARCHAR(100),  
  CORP_PHONE   VARCHAR(50),  
  CORP_ZIP   VARCHAR(10),  
  CORP_CITY   VARCHAR(50),  
  CORP_STATE   VARCHAR(50),  
  CORP_COUNTRY  VARCHAR(50),  
  AUTHORISEDSIGNETORY1 VARCHAR(150),  
  AUTHORISEDSIGNETORY2 VARCHAR(150),  
  AUTHORISEDSIGNETORY3 VARCHAR(150),  
  AUTHORISEDSIGNETORY4 VARCHAR(150),  
  AUTHORISEDSIGNETORY5 VARCHAR(150),  
  AUTHORISEDSIGNETORY6 VARCHAR(150),  
  AUTHORISEDSIGNETORY7 VARCHAR(150),  
  CONTRACT_TYPE  INT,   
  FNO_CONTRACT_BILL INT,  
  PRINT_SUB_TOT  INT,  
  PRINT_NET_TOT  INT,  
  PRINT_DEALING  VARCHAR(10),  
  PRINT_STT_COLUMN INT,  
  SERTAXPER   NUMERIC(18,2),  
  CONTRACTDATE  VARCHAR(11),  
  CESS_TAX   NUMERIC(18,2),  
  EDUCESSTAX   NUMERIC(18,2) */   
  )  
   
 INSERT INTO #COMPANY_INFO    
 SELECT   
  COMPANY,   
  ADDR1,   
  ADDR2,   
  CITY,   
  ZIP,   
  PHONE,   
  FAX,   
  EXCHANGECODE='',   
  TM_CODE='',   
  BROKERSEBIREGNO,   
  PANNO,   
  EMAIL,   
  COMPLIANCE_NAME = ISNULL(COMPLIANCE_NAME,''),  
  COMPLIANCE_EMAIL = ISNULL(COMPLIANCE_EMAIL,''),  
  COMPLIANCE_PHONE = ISNULL(COMPLIANCE_PHONE,''),  
  COMPLIANCE_MOBILE = ISNULL(COMPLIANCE_MOBILE,''),  
  SERVICES_TAXNO = ISNULL(SERVICES_TAXNO,''),  
  WEBSITE_ID = ISNULL(WEBSITE_ID,''),  
  LOGO_FILE_PATH = '',  
  CIN = ISNULL(CIN,'')  
  
  /*COMMONSEBINO = ISNULL(COMMONSEBINO,''),  
  COMMONMEMBERCODE = ISNULL(COMMONMEMBERCODE,''),  
  
  IGRIV_EMAIL = ISNULL(IGRIV_EMAIL,''),   
  CORP_ADDR1 = ISNULL(CORP_ADDR1,''),  
  CORP_ADDR2 = ISNULL(CORP_ADDR2,''),  
  CORP_ADDR3 = ISNULL(CORP_ADDR3,''),  
  CORP_PHONE = ISNULL(CORP_PHONE,''),  
  CORP_ZIP = ISNULL(CORP_ZIP,''),  
  CORP_CITY = ISNULL(CORP_CITY,''),  
  CORP_STATE = ISNULL(CORP_STATE,''),  
  CORP_COUNTRY = ISNULL(CORP_COUNTRY,''),  
  AUTHORISEDSIGNETORY1 = '',  
  AUTHORISEDSIGNETORY2 = '',  
  AUTHORISEDSIGNETORY3 = '',  
  AUTHORISEDSIGNETORY4 = '',  
  AUTHORISEDSIGNETORY5 = '',  
  AUTHORISEDSIGNETORY6 = '',  
  AUTHORISEDSIGNETORY7 = '',  
  CONTRACT_TYPE  = '',  
  FNO_CONTRACT_BILL = '',  
  PRINT_SUB_TOT  = '',  
  PRINT_NET_TOT  = '',  
  PRINT_DEALING  = '',  
  PRINT_STT_COLUMN = 0,  
  SERTAXPER   = 0,  
  CONTRACTDATE  = '',  
  CESS_TAX   = 0,  
  EDUCESSTAX   = 0 */ 
      
 FROM   
 BFOOWNER (NOLOCK)  
  
  
 /*UPDATE #COMPANY_INFO  
 SET  AUTHORISEDSIGNETORY1 = ISNULL(A.AUTHORISEDSIGNETORY1,''),  
   AUTHORISEDSIGNETORY2 = ISNULL(A.AUTHORISEDSIGNETORY2,''),  
   AUTHORISEDSIGNETORY3 = ISNULL(A.AUTHORISEDSIGNETORY3,''),  
   AUTHORISEDSIGNETORY4 = ISNULL(A.AUTHORISEDSIGNETORY4,''),  
   AUTHORISEDSIGNETORY5 = ISNULL(A.AUTHORISEDSIGNETORY5,''),  
   AUTHORISEDSIGNETORY6 = ISNULL(A.AUTHORISEDSIGNETORY6,''),  
   AUTHORISEDSIGNETORY7 = ISNULL(A.AUTHORISEDSIGNETORY7,'')  
 FROM AUTHORISEDSIGNETORIES A (NOLOCK)  
   
   
 UPDATE #COMPANY_INFO  
 SET  CONTRACT_TYPE  = ISNULL(T.CONTRACT_TYPE,0),  
   FNO_CONTRACT_BILL = ISNULL(T.FNO_CONTRACT_BILL,0),  
   PRINT_SUB_TOT  = ISNULL(T.PRINT_SUB_TOT,0),  
   PRINT_NET_TOT  = ISNULL(T.PRINT_NET_TOT,0),  
   PRINT_DEALING  = ISNULL(T.PRINT_DEALING,''),  
   PRINT_STT_COLUMN = ISNULL(T.PRINT_STT_COLUMN,'')  
 FROM TBL_COMMONCONTRACT_MASTER T (NOLOCK)   
 WHERE GETDATE() BETWEEN EFFECTIVE_FROM AND EFFECTIVE_TO   
  
  
 UPDATE #COMPANY_INFO  
 SET  SERTAXPER  = SERVICE_TAX,  
   CONTRACTDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE,103),112),  
   CESS_TAX  = ISNULL(G.CESS_TAX,0),  
   EDUCESSTAX  = ISNULL(G.EDUCESSTAX,0)  
 FROM GLOBALS G (NOLOCK)  
 WHERE @FROMDATE BETWEEN YEAR_START_DT AND YEAR_END_DT*/  
   
   
 SELECT * FROM #COMPANY_INFO  
   
 DROP TABLE #COMPANY_INFO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_BILLDETAIL_RPT
-- --------------------------------------------------

/*
EXEC CLS_FO_BILLDETAIL_RPT '17 AUG 2004', '17 AUG 2014','','','BROKER','BROKER','SUMMARY'
EXEC CLS_FO_BILLDETAIL_RPT '14/11/2010', '14/11/2014','0','AKB2','BROKER','BROKER','DETAIL'

*/

CREATE PROC [dbo].[CLS_FO_BILLDETAIL_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@REPORTTYPE VARCHAR(10) = 'SUMMARY'
)

AS

/*
	@REPORTTYPE  : SUMMARY /DETAIL
*/


SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)


IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF @REPORTTYPE = 'SUMMARY'
BEGIN
	SELECT
		CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDA_DATE,
		CLIENT_CODE=F.PARTY_CODE, 
		LEFT(C1.LONG_NAME, 25) AS CLIENT_NAME,
		

		CONVERT(NUMERIC(18,2), SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			(F.PBILLAMT - F.SBILLAMT)
		ELSE
			(F.PBILLAMT+F.SBILLAMT)
		END))
		 AS NET_DRCR, 
		CONVERT(NUMERIC(18,2), SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) 
			+ (F.OTHER_CHRG) + (F.PBROKAMT+F.SBROKAMT)) )) AS CHRG_TOTAL,
			
		CONVERT(NUMERIC(18,2), SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - ((F.SBILLAMT)  )
		ELSE
			((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + ((F.SBILLAMT)  )
		END))
		 AS NETBILLAMT
	FROM
		FOBILLVALAN F (NOLOCK), 
		CLIENT1 C1 (NOLOCK), 
		CLIENT2 C2 (NOLOCK),
		FOOWNER (NOLOCK)
	WHERE
		C1.CL_CODE = C2.CL_CODE AND
		C2.PARTY_CODE = F.PARTY_CODE AND
		F.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY AND
		F.SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' AND	
		F.TRADETYPE = CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 'BT' ELSE F.TRADETYPE  END AND	
		@STATUSNAME = (CASE 	
					WHEN @STATUSID = 'BRANCH' THEN F.BRANCH_CODE
					WHEN @STATUSID = 'SUBBROKER' THEN F.SUB_BROKER
					WHEN @STATUSID = 'TRADER' THEN F.TRADER
					WHEN @STATUSID = 'FAMILY' THEN F.FAMILY
					WHEN @STATUSID = 'AREA' THEN F.AREA
					WHEN @STATUSID = 'REGION' THEN F.REGION
					WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE
					WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
				END)
	GROUP BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME

	ORDER BY 
		F.SAUDA_DATE,
		F.PARTY_CODE
		
END
ELSE			-- DETAIL REPORT
BEGIN
	SELECT
		CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDA_DATE,
		CLIENT_CODE=F.PARTY_CODE, 
		LEFT(C1.LONG_NAME, 25) AS CLIENT_NAME,		
		F.INST_TYPE, 
		SYMBOL = F.SYMBOL + ' - ' + TRADETYPE,
		CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,
		F.STRIKE_PRICE, 
		CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,		
		CL_RATE AS CLOSINGRATE,	

		CONVERT(NUMERIC(18,2), CASE WHEN TRADETYPE = 'BF' 
			 THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) 
				   THEN CASE WHEN SUM(PQTY) > 0 
						 THEN SUM(PAMT)/SUM(PQTY) 
						 ELSE 0 
					END 
				   ELSE 0 
			  END 
			 ELSE CASE WHEN SUM(PQTY) > 0 
				   THEN SUM(PRATE*PQTY+PBROKAMT) /SUM(PQTY) 
				   ELSE 0 
			  END 
		END) AS PRATE,
		CONVERT(NUMERIC(18,2), CASE WHEN TRADETYPE = 'BF' 
			 THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) 
					   THEN CASE WHEN SUM(SQTY) > 0 
					 THEN SUM(SAMT)/SUM(SQTY) 
					 ELSE 0 
					END 
				   ELSE 0 
			  END 
			 ELSE CASE WHEN SUM(SQTY) > 0 
				   THEN SUM(SRATE*SQTY -SBROKAMT)/SUM(SQTY)
				   ELSE 0
			  END 
		END) AS SRATE,

		CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,
		CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END 
		ELSE
			SUM(F.PBILLAMT+F.SBILLAMT)
		END)
		AS PBILLAMT,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END 
		ELSE
			0
		END)
		AS SBILLAMT,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			SUM((F.PBILLAMT)) - SUM((F.SBILLAMT))
		ELSE
			SUM(F.PBILLAMT+F.SBILLAMT)
		END)
		 AS NET_DRCR,
		
		CONVERT(NUMERIC(18,4), SUM(F.SERVICE_TAX - F.EXSER_TAX))AS 'SERVICE_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.SEBI_TAX)) AS 'SEBI_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.TURN_TAX)) AS 'TURNOVER_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.BROKER_NOTE)) AS 'STAMP_DUTY',
		CONVERT(NUMERIC(18,4), SUM(F.INS_CHRG)) AS 'STT_CHARGES',
		CONVERT(NUMERIC(18,4), SUM(F.OTHER_CHRG)) AS  'OTHER_CHARGES',
		CONVERT(NUMERIC(18,4), SUM(F.PBROKAMT+F.SBROKAMT)) AS 'BROKERAGE',
		
		CONVERT(NUMERIC(18,4), SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) 
			+ (F.OTHER_CHRG) + (F.PBROKAMT+F.SBROKAMT)) )) AS CHRG_TOTAL,
			
		CONVERT(NUMERIC(18,4), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )
		ELSE
			SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + SUM((F.SBILLAMT)  )
		END)
		 AS NETBILLAMT,

		C1.L_ADDRESS1, 
		C1.L_ADDRESS2,
		C1.L_ADDRESS3,
		C1.L_CITY,
		C1.L_STATE,
		C1.L_NATION,
		C1.L_ZIP,
		C1.RES_PHONE1,
		C1.EMAIL 
		 
		 
	FROM
		FOBILLVALAN F (NOLOCK), 
		CLIENT1 C1 (NOLOCK), 
		CLIENT2 C2 (NOLOCK),
		FOOWNER (NOLOCK)
	WHERE
		C1.CL_CODE = C2.CL_CODE AND
		C2.PARTY_CODE = F.PARTY_CODE AND
		F.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY AND
		F.SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' AND	
		F.TRADETYPE = CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 'BT' ELSE F.TRADETYPE  END AND	
		@STATUSNAME = (CASE 	
					WHEN @STATUSID = 'BRANCH' THEN F.BRANCH_CODE
					WHEN @STATUSID = 'SUBBROKER' THEN F.SUB_BROKER
					WHEN @STATUSID = 'TRADER' THEN F.TRADER
					WHEN @STATUSID = 'FAMILY' THEN F.FAMILY
					WHEN @STATUSID = 'AREA' THEN F.AREA
					WHEN @STATUSID = 'REGION' THEN F.REGION
					WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE
					WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
				END)
	GROUP BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME,  
		F.SYMBOL, 
		F.INST_TYPE, 
		F.EXPIRYDATE, 
		F.STRIKE_PRICE, 
		F.OPTION_TYPE,
		F.TRADETYPE, 
		CL_RATE,
		AUCTIONPART,
		PARTICIPANTCODE,
		MEMBERCODE,		
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2,
		C1.L_ADDRESS3,
		C1.L_CITY,
		C1.L_STATE,
		C1.L_NATION,
		C1.L_ZIP,
		C1.RES_PHONE1,
		C1.EMAIL 		

	HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0 

	ORDER BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME, 
		F.SYMBOL, 
		F.INST_TYPE, 
		F.EXPIRYDATE, 
		F.STRIKE_PRICE, 
		F.OPTION_TYPE, 
		F.TRADETYPE
END

/*---------------------------------------------------------- END OF THE PROC -------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_COLLATERAL_DETAILS_DAS_GET
-- --------------------------------------------------


CREATE PROC [DBO].[CLS_FO_COLLATERAL_DETAILS_DAS_GET]
	(
 	@SDATE VARCHAR(11),
	@PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = ''
	)

	AS
	
	IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
	SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)  
	
	IF @TOCODE = ''
		BEGIN
			SET @TOCODE = @PARTYCODE
		END
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	IF @DISPLAY <> ''
		BEGIN
			SELECT 
				PARTY_CODE=PARENTCODE,
				EXCHANGE = 'NSE',
				SEGMENT = 'FUTURES',
				QTY=SUM(QTY),
				FINALAMOUNT=SUM(FINALAMOUNT)
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'NSE'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE LIKE @SDATE + '%'
				AND PARENTCODE BETWEEN @PARTYCODE AND @TOCODE
			GROUP BY 
				PARENTCODE
			ORDER BY
				PARENTCODE
		END
	ELSE
		BEGIN
			SELECT 
				PARTY_CODE=PARENTCODE,
				EXCHANGE = 'NSE',
				SEGMENT = 'FUTURES',
				SCRIP_CD =(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END),
				EXPIRYDATE = (
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),	
				QTY=SUM(QTY),
				CL_RATE,
				VAKUATIONPER = MAX(100 - HAIRCUT),
				FINALAMOUNT=SUM(FINALAMOUNT),
				CASH_NCASH,
				SERIES = ISNULL(SERIES,'')
			INTO
				#COLLDETAILS
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'NSE'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE LIKE @SDATE + '%'
				AND PARENTCODE BETWEEN @PARTYCODE AND @TOCODE
			GROUP BY 
				PARENTCODE,SCRIP_CD,CL_RATE,CASH_NCASH,ISNULL(SERIES,''),
				(
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),
				(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END)				
			ORDER BY
				CASH_NCASH,
				PARTY_CODE,
				SCRIP_CD


			UPDATE 
				#COLLDETAILS
				SET SCRIP_CD = S2.SCRIP_CD
			FROM 
				BSEDB.DBO.SCRIP2 S2,
				BSEDB.DBO.SCRIP2 S1
			WHERE 
				S1.CO_CODE = S2.CO_CODE
				AND S1.SERIES = S2.SERIES
				AND #COLLDETAILS.SCRIP_CD = S2.BSECODE
				AND #COLLDETAILS.SERIES = 'BSE'
				

			SELECT *
			FROM #COLLDETAILS C
			ORDER BY PARTY_CODE,CASH_NCASH, SCRIP_CD
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_LEDGER_DETAILS_DAS_UP
-- --------------------------------------------------

/****** OBJECT:  STORED PROCEDURE DBO.PR_FO_LEDGER_DETAILS_DAS_UP    SCRIPT DATE: 4/28/2009 4:16:42 PM ******/


CREATE  PROCEDURE [DBO].[CLS_FO_LEDGER_DETAILS_DAS_UP]                 
(                
    @SDATE VARCHAR(11),                 
    @PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = ''
)
       
        
AS

IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
	SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)                  

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			MARGINAMT = SUM((LEDDD_CASH_MARGIN + LEDDD_NONCASH_COLL_HC) - (LEDDD_INIT_EXPO_MARGIN ))
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE LIKE @SDATE +'%'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
	END
ELSE
	BEGIN
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_SAUDA_DATE = @SDATE,
			LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),
			LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),
			LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),
			LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),
			LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),
			LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),
			LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),
			LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),
			LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),
			LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),
			LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),
			LEDDD_CREATED_BY = 'BACK-END',
			LEDDD_CREATED_DT = GETDATE(),
			LEDDD_ADD_MARGIN = 0,
			LEDDD_FT_D = 0,
			LEDDD_FT_C = 0,
			LEDDD_MRG_FT = 0,
			LEDDD_RUNNINGBAL = 0,
			LEDDD_CASH_COLL_HC = 0
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE LIKE @SDATE +'%'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_OPEN_POSITION_DAS_GET
-- --------------------------------------------------

CREATE  PROCEDURE [DBO].[CLS_FO_OPEN_POSITION_DAS_GET]
(            
    @SDATE VARCHAR(11),             
    @PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            
            
AS  


IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)            

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOPDD_PARTY_CODE,
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),
			FOPDD_INST_TYPE
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
		ORDER BY             
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
	END
ELSE
	BEGIN
		PRINT @BLOCK
		SELECT             
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			FOPDD_INTFLAG=ISNULL(FOPDD_INTFLAG,'IN'),            
			FOPDD_EXPIRYDATE = LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_OPENING_PQTY = SUM(FOPDD_OPENING_PQTY),   
			FOPDD_OPENING_SQTY = SUM(FOPDD_OPENING_SQTY),   
			FOPDD_TODAY_PQTY = SUM(FOPDD_TODAY_PQTY),   
			FOPDD_TODAY_SQTY = SUM(FOPDD_TODAY_SQTY),   
			FOPDD_EXERCISEDQTY = SUM(FOPDD_EXERCISEDQTY) ,   
			FOPDD_ASSIGNEDQTY = SUM(FOPDD_ASSIGNEDQTY),   
			FOPDD_INS_PQTY = SUM(FOPDD_INS_PQTY),   
			FOPDD_INS_SQTY = SUM(FOPDD_INS_SQTY),   
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),   
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),   
			FOPDD_EXPQTY = SUM(FOPDD_EXPQTY),   
			FOPDD_AUTOCORPQTY = SUM(FOPDD_AUTOCORPQTY),   
			FOPDD_LONGVALUE = SUM(FOPDD_LONGVALUE),   
			FOPDD_SHORTVALUE = SUM(FOPDD_SHORTVALUE),   
			FOPDD_CLOSINGPRICE= MAX(FOPDD_CLOSINGPRICE) ,           
			FOPDD_STLMNTPRICE=MAX(FOPDD_STLMNTPRICE)  ,            
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     FOPDD_CREATED_BY   ,          
			FOPDD_CREATED_DT = LEFT(FOPDD_CREATED_DT,11)             
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			ISNULL(FOPDD_INTFLAG,'IN'),            
			LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     
			FOPDD_CREATED_BY   ,          
			LEFT(FOPDD_CREATED_DT,11)
		ORDER BY             
			FOPDD_PARTY_CODE,             
			FOPDD_FLAG,               
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE ,           
			FOPDD_EXPIRYDATE   
	END
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_TRADE_DETAILS_DAS_GET
-- --------------------------------------------------


CREATE PROCEDURE [DBO].[CLS_FO_TRADE_DETAILS_DAS_GET]             
(            
    @SDATE VARCHAR(11),             
    @PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            

AS

IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)             

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_PQTY = SUM(FOTDD_PQTY),
			FOTDD_SQTY = SUM(FOTDD_SQTY),
			FOTDD_PAMT = SUM(FOTDD_PAMT),
			FOTDD_SAMT = SUM(FOTDD_SAMT),
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),
			FOTDD_INST_TYPE
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		GROUP BY
			FOTDD_PARTY_CODE,
			RIGHT(FOTDD_FLAG,2),   
		    FOTDD_INST_TYPE
		ORDER BY             
			FOTDD_PARTY_CODE ,
			RIGHT(FOTDD_FLAG,2)
	END
ELSE
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_INST_TYPE,             
			FOTDD_SYMBOL,             
			FOTDD_STRIKE_PRICE,             
			FOTDD_OPTION_TYPE,             
			FOTDD_EXPIRY_DATE = LEFT(FOTDD_EXPIRY_DATE,11),             
			FOTDD_SEC_NAME,             
			FOTDD_TRADEQTY,             
			FOTDD_VALUE,             
			FOTDD_PRICE,             
			FOTDD_PQTY,             
			FOTDD_SQTY,             
			FOTDD_PAMT,             
			FOTDD_SAMT,             
			FOTDD_NETRATE,             
			FOTDD_CFPPRICE,             
			FOTDD_CFSPRICE,             
			FOTDD_SETTPRICE,             
			FOTDD_SAUDA_DATE = LEFT(FOTDD_SAUDA_DATE,11),             
			FOTDD_PNETRATE,             
			FOTDD_SNETRATE,             
			FOTDD_CHARGES,             
			FOTDD_BROKERAGE,             
			FOTDD_SERVICE_TAX,             
			FOTDD_BROKER_NOTE,             
			FOTDD_TURN_TAX,             
			FOTDD_SEBI_TAX,             
			FOTDD_CONTRACTNO,             
			FOTDD_PCOMM,             
			FOTDD_SCOMM,             
			FOTDD_INS_CHRG,             
			FOTDD_FLAG = LEFT(FOTDD_FLAG,2),     
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),     
			FOTDD_O_C_FLAG,             
			FOTDD_AUCTIONPART,             
			FOTDD_CREATED_BY,             
			FOTDD_CREATED_DT = LEFT(FOTDD_CREATED_DT,11)--,
			--CONTRACTDESCRIPTOR =  FOTDD_INST_TYPE + ' ' + FOTDD_SYMBOL + ' ' + FOTDD_OPTION_TYPE + ' ' + CONVERT(VARCHAR, FOTDD_STRIKE_PRICE) + ' ' + CONVERT(VARCHAR(11), FOTDD_EXPIRY_DATE, 109)
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		ORDER BY             
			FOTDD_PARTY_CODE,           
			LEFT(FOTDD_FLAG,2),           
			FOTDD_INST_TYPE,           
			FOTDD_SYMBOL,           
			FOTDD_STRIKE_PRICE,           
			FOTDD_OPTION_TYPE,           
			FOTDD_EXPIRY_DATE,     
			TRADE_TYPE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPFILE_FILECOUNT
-- --------------------------------------------------


CREATE PROC CLS_IMPFILE_FILECOUNT( @SESSIONID VARCHAR(30), @INTMODE INT) AS

IF @INTMODE=1
BEGIN
	SELECT COUNT(1) AS ROW_COUNT FROM CLASSFILEUPD WHERE	SESSION_ID= @SESSIONID
END
ELSE
BEGIN
	SELECT COUNT(1) AS ROW_COUNT	FROM CLASSFILEUPD_BULK WHERE SPID= 
@SESSIONID
END

/*----------------------------- END OF THE PROC ---------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPFILE_PARAM_GET
-- --------------------------------------------------


CREATE  PROC [DBO].[CLS_IMPFILE_PARAM_GET] 
(	@MODE VARCHAR(20),
	@FILETYPE VARCHAR(20) ='',
	@EXCHANGE VARCHAR(3)='',
	@SEGMENT VARCHAR(7)='',
	@SAUDA_DATE VARCHAR(11)=''
	
) AS 

/*
	@MODE : IMPFILE_TYPE - TO FETCH IMPORT TRADE FILE TYPES
	@MODE : TRDFILE_TYPE - TO FETCH IMPORT TRADE FILE TYPES
	@MODE : BULK_IMP_PATH - TO FETCH THE BULK IMPORT DEFAULT PATH
	@MODE : MEMBER_DET - TO FETCH THE MEMBER DETAILS
	@MODE : TMINFO_DET - TO FETCH THE TM INFO
	@MODE : TRDATE_STAT - TO FETCH THE BUSSINESS DATE CLOSE STATUS
*/

DECLARE @STRSQL VARCHAR(MAX)


-----------------------------------------------------------------
IF @MODE = 'IMPFILE_TYPE'			-- IMPORT EXCHANGE FILES
BEGIN
	SELECT FILETYPE_CD,FILETYPE_DESC FROM CLS_EXCH_IMPFILE_TYPE (NOLOCK)
	WHERE VALID_FLAG =1 ORDER BY 2
END

-----------------------------------------------------------------
IF @MODE = 'TRDFILE_TYPE'		-- TRADE FILE IMPORT
BEGIN
	SELECT FILETYPE_CD,FILETYPE_DESC FROM CLS_TRADEFILE_TYPE (NOLOCK)
	WHERE VALID_FLAG =1 ORDER BY 2
END
-----------------------------------------------------------------

IF @MODE = 'BULK_IMP_PATH'
BEGIN
	IF (SELECT COUNT(1) FROM IMP_FILEPATH WHERE FILE_TYPE =@FILETYPE) > 0
	BEGIN
		SELECT FILE_PATH FROM IMP_FILEPATH WHERE FILE_TYPE =@FILETYPE
	END
	ELSE
	BEGIN
		SELECT 'C:' AS FILE_PATH
	END
END
-------------------------------------------------------------------

IF @MODE = 'MEMBER_DET'
BEGIN
	IF @SEGMENT = 'FUTURES'
	BEGIN
		SET @STRSQL ='SELECT COMPANY,MEMBERTYPE,MEMBERCODE FROM [FOOWNER] (NOLOCK)'
	END
	ELSE
	BEGIN
		SET @STRSQL ='SELECT COMPANY,MEMBERTYPE=''TM'',MEMBERCODE FROM [OWNER] (NOLOCK)'
	END
	EXEC (@STRSQL)
END
-----------------------------------------------------------------------------

IF @MODE = 'TMINFO_DET' AND @SEGMENT = 'FUTURES'
BEGIN
	SET @STRSQL = 'SELECT ISNULL(COUNT(1),0) AS TMCOUNT FROM FOTMINFO'
	EXEC (@STRSQL)
END
-----------------------------------------------------------------------------

IF @MODE = 'TRDATE_STAT'
BEGIN
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF (SELECT COUNT(1)  FROM V2_BUSINESS_PROCESS (NOLOCK)
		WHERE BUSINESS_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59') > 0
	BEGIN
		IF (SELECT COUNT(1)  FROM V2_BUSINESS_PROCESS (NOLOCK)
		WHERE OPEN_CLOSE = 1 AND BUSINESS_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59') = 0
		BEGIN
			SELECT 'OPEN' AS TRDATE_STAT, ERRMSG =''
		END
		ELSE
		BEGIN
			SELECT 'CLOSED' AS TRDATE_STAT, ERRMSG ='CANNOT PROCEED. BUSINESS DATE ' +  @SAUDA_DATE + ' IS CLOSED'
		END
	END
	ELSE
	BEGIN
		SELECT 'OPEN' AS TRDATE_STAT, ERRMSG =''
	END
END
/*------------------------------------------ END OF THE PROC ------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_FILE
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_IMPORT_FILE] 
(
	@IMPFILE VARCHAR(20),
	@FILETYPE VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@SESSIONID VARCHAR(30),
	@UNAME VARCHAR(20),
	@IMPORTMODE INT 
) AS 

IF @IMPFILE <> 'TRADE'
BEGIN
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
END


IF @IMPFILE = 'F_CN01'
BEGIN
	EXEC CLS_PR_IMPORT_CONTRACT_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE ,0
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CNTMST','',@UNAME,''
END


IF @IMPFILE = 'CONTRACT'
BEGIN
	EXEC CLS_PR_IMPORT_CONTRACT_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE ,1
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CNTMST','',@UNAME,''
END

IF @IMPFILE = 'TRADE'
BEGIN
	EXEC CLS_IMPORT_TRADE_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE ,@FILETYPE
END


IF @IMPFILE = 'CLOSING'
BEGIN
	EXEC CLS_PR_IMPORT_CLOSING_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CLOSING','',@UNAME,''
END


IF @IMPFILE = 'POSITION'
BEGIN
	EXEC CLS_PR_IMPORT_POSITION_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'POSIMP','',@UNAME,''
END


IF @IMPFILE = 'MARGIN'
BEGIN
	EXEC CLS_PR_IMPORT_MARGIN_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'MRGIMP','',@UNAME,''
END


IF @IMPFILE = 'STT'
BEGIN
	EXEC CLS_PR_IMPORT_STT_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CHKSTTIMP','',@UNAME,''
END

IF @IMPFILE = 'CORPACT_1' OR @IMPFILE = 'CORPACT_2'
BEGIN
	EXEC CLS_PR_IMPORT_CORPACTFILE_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @IMPORTMODE , @IMPFILE
END

/*--------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE
-- --------------------------------------------------


CREATE PROC [DBO].[CLS_IMPORT_TRADE_FILE] 
(
	@SESSIONID VARCHAR(30),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@IMPORTMODE INT ,
	@FILETYPE VARCHAR(20)
) AS

/*
	@IMPORTMODE : 1 - NORMAL / 2 - BULK IMPORT
	@FILETYPE   : FTP
*/

	
	TRUNCATE TABLE BFOFTTRADE

	IF @FILETYPE  ='EXCHANGE'
	BEGIN
		IF @IMPORTMODE=1
		BEGIN
			INSERT INTO BFOFTTRADE
			SELECT
				TRADE_NO					= DBO.PIECE(FILE_DATA,',',1),
				SAUDA_DATE					= DBO.PIECE(FILE_DATA,',',2),
				TRADESTATUS					= DBO.PIECE(FILE_DATA,',',3),
				SEGMENT						= DBO.PIECE(FILE_DATA,',',4),
				SETT_TYPE					= DBO.PIECE(FILE_DATA,',',5),
				PRODUCT_TYPE				= DBO.PIECE(FILE_DATA,',',6),
				PRODUCT_CODE				= DBO.PIECE(FILE_DATA,',',7),
				ASSET_CODE					= DBO.PIECE(FILE_DATA,',',8),
				EXPIRYDATE					= LEFT(CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',9)),11) + ' 23:59',
				STRIKE_PRICE				= DBO.PIECE(FILE_DATA,',',10),
				OPTION_TYPE					= DBO.PIECE(FILE_DATA,',',11),
				CA_LEVEL					= DBO.PIECE(FILE_DATA,',',12),
				BUY_BROKER					= DBO.PIECE(FILE_DATA,',',13),
				SELL_BROKER					= DBO.PIECE(FILE_DATA,',',14),
				TRADE_PRICE					= DBO.PIECE(FILE_DATA,',',15),
				TRADEQTY					= DBO.PIECE(FILE_DATA,',',16),
				SERIES_ID					= DBO.PIECE(FILE_DATA,',',17),
				BUYER_LOCATIONID			= DBO.PIECE(FILE_DATA,',',18),
				BUY_CM_CODE					= DBO.PIECE(FILE_DATA,',',19),
				SELL_CM_CODE				= DBO.PIECE(FILE_DATA,',',20),
				SELLER_LOCATIONID			= DBO.PIECE(FILE_DATA,',',21),
				BUY_PARTICIPANT				= DBO.PIECE(FILE_DATA,',',22),
				BUY_CONFIRMATION			= DBO.PIECE(FILE_DATA,',',23),
				SELL_PARTICIPANT			= DBO.PIECE(FILE_DATA,',',24),
				SELL_CONFIRMATION			= DBO.PIECE(FILE_DATA,',',25),
				BUY_OC_FLAG					= DBO.PIECE(FILE_DATA,',',26),
				SELL_OC_FLAG				= DBO.PIECE(FILE_DATA,',',27),
				BUY_OLD_PARTICIPANT			= DBO.PIECE(FILE_DATA,',',28),
				BUY_OLD_CM_CODE				= DBO.PIECE(FILE_DATA,',',29),
				SELL_OLD_PARTICIPANT		= DBO.PIECE(FILE_DATA,',',30),
				SELL_OLD_CM_CODE			= DBO.PIECE(FILE_DATA,',',31),
				BUY_TERMINALID				= DBO.PIECE(FILE_DATA,',',32),
				SELL_TERMINALID				= DBO.PIECE(FILE_DATA,',',33),
				BUY_ORDER_NO				= DBO.PIECE(FILE_DATA,',',34),
				SELL_ORDER_NO				= DBO.PIECE(FILE_DATA,',',35),
				BUY_CLIENT_CODE				= DBO.PIECE(FILE_DATA,',',36),
				SELL_CLIENT_CODE			= DBO.PIECE(FILE_DATA,',',37),
				BUY_REMARKS					= DBO.PIECE(FILE_DATA,',',38),
				SELL_REMARKS				= DBO.PIECE(FILE_DATA,',',39),
				BUY_POSITION				= DBO.PIECE(FILE_DATA,',',40),
				SELL_POSITION				= DBO.PIECE(FILE_DATA,',',41),
				BUY_PRO_CLI					= DBO.PIECE(FILE_DATA,',',42),
				SELL_PRO_CLI				= DBO.PIECE(FILE_DATA,',',43),
				BUY_ORDER_TIMESTAMP			= DBO.PIECE(FILE_DATA,',',44),
				SELL_ORDER_TIMESTAMP		= DBO.PIECE(FILE_DATA,',',45),
				BUY_ORDER_ACTIVEFLAG		= DBO.PIECE(FILE_DATA,',',46),
				SELL_ORDER_ACTIVEFLAG		= DBO.PIECE(FILE_DATA,',',47)
			FROM CLASSFILEUPD
			WHERE
				SESSION_ID= @SESSIONID
				AND  DBO.PIECE(FILE_DATA,',',1) <> ''
		END
		ELSE
		BEGIN
			INSERT INTO BFOFTTRADE
			SELECT
				TRADE_NO					= DBO.PIECE(FILEDATA,',',1),
				SAUDA_DATE					= DBO.PIECE(FILEDATA,',',2),
				TRADESTATUS					= DBO.PIECE(FILEDATA,',',3),
				SEGMENT						= DBO.PIECE(FILEDATA,',',4),
				SETT_TYPE					= DBO.PIECE(FILEDATA,',',5),
				PRODUCT_TYPE				= DBO.PIECE(FILEDATA,',',6),
				PRODUCT_CODE				= DBO.PIECE(FILEDATA,',',7),
				ASSET_CODE					= DBO.PIECE(FILEDATA,',',8),
				EXPIRYDATE					= LEFT(CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',9)),11) + ' 23:59',
				STRIKE_PRICE				= DBO.PIECE(FILEDATA,',',10),
				OPTION_TYPE					= DBO.PIECE(FILEDATA,',',11),
				CA_LEVEL					= DBO.PIECE(FILEDATA,',',12),
				BUY_BROKER					= DBO.PIECE(FILEDATA,',',13),
				SELL_BROKER					= DBO.PIECE(FILEDATA,',',14),
				TRADE_PRICE					= DBO.PIECE(FILEDATA,',',15),
				TRADEQTY					= DBO.PIECE(FILEDATA,',',16),
				SERIES_ID					= DBO.PIECE(FILEDATA,',',17),
				BUYER_LOCATIONID			= DBO.PIECE(FILEDATA,',',18),
				BUY_CM_CODE					= DBO.PIECE(FILEDATA,',',19),
				SELL_CM_CODE				= DBO.PIECE(FILEDATA,',',20),
				SELLER_LOCATIONID			= DBO.PIECE(FILEDATA,',',21),
				BUY_PARTICIPANT				= DBO.PIECE(FILEDATA,',',22),
				BUY_CONFIRMATION			= DBO.PIECE(FILEDATA,',',23),
				SELL_PARTICIPANT			= DBO.PIECE(FILEDATA,',',24),
				SELL_CONFIRMATION			= DBO.PIECE(FILEDATA,',',25),
				BUY_OC_FLAG					= DBO.PIECE(FILEDATA,',',26),
				SELL_OC_FLAG				= DBO.PIECE(FILEDATA,',',27),
				BUY_OLD_PARTICIPANT			= DBO.PIECE(FILEDATA,',',28),
				BUY_OLD_CM_CODE				= DBO.PIECE(FILEDATA,',',29),
				SELL_OLD_PARTICIPANT		= DBO.PIECE(FILEDATA,',',30),
				SELL_OLD_CM_CODE			= DBO.PIECE(FILEDATA,',',31),
				BUY_TERMINALID				= DBO.PIECE(FILEDATA,',',32),
				SELL_TERMINALID				= DBO.PIECE(FILEDATA,',',33),
				BUY_ORDER_NO				= DBO.PIECE(FILEDATA,',',34),
				SELL_ORDER_NO				= DBO.PIECE(FILEDATA,',',35),
				BUY_CLIENT_CODE				= DBO.PIECE(FILEDATA,',',36),
				SELL_CLIENT_CODE			= DBO.PIECE(FILEDATA,',',37),
				BUY_REMARKS					= DBO.PIECE(FILEDATA,',',38),
				SELL_REMARKS				= DBO.PIECE(FILEDATA,',',39),
				BUY_POSITION				= DBO.PIECE(FILEDATA,',',40),
				SELL_POSITION				= DBO.PIECE(FILEDATA,',',41),
				BUY_PRO_CLI					= DBO.PIECE(FILEDATA,',',42),
				SELL_PRO_CLI				= DBO.PIECE(FILEDATA,',',43),
				BUY_ORDER_TIMESTAMP			= DBO.PIECE(FILEDATA,',',44),
				SELL_ORDER_TIMESTAMP		= DBO.PIECE(FILEDATA,',',45),
				BUY_ORDER_ACTIVEFLAG		= DBO.PIECE(FILEDATA,',',46),
				SELL_ORDER_ACTIVEFLAG		= DBO.PIECE(FILEDATA,',',47)
					FROM CLASSFILEUPD_BULK
			WHERE
				SPID= @SESSIONID
				AND  DBO.PIECE(FILEDATA,',',1) <> ''
		END	
	END	

	EXEC DUPRECSETTCHECK
	
	IF (SELECT COUNT(1) FROM FOTRADE) > 0
	BEGIN
		SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
		INSERT INTO FOSTAT_TRD
		SELECT ACTIONCODE	 = 'I10',SYSDATE = @SAUDA_DATE,FILEDATE = @SAUDA_DATE,COM_DATE = LEFT(GETDATE(),11)
	END
	
	/*---------------------------------------------------------------- END OF THE PROC --------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE_CONFIRM
-- --------------------------------------------------



CREATE  PROC CLS_IMPORT_TRADE_FILE_CONFIRM
(	
	@SAUDA_DATE VARCHAR(11)
) AS 

DECLARE @ERR_CD AS INT
DECLARE @ERR_DESC AS VARCHAR(200)

SET @ERR_CD  = 0
SET @ERR_DESC = ''

SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

IF (SELECT COUNT(1) FROM FOSTAT_TRD WHERE SYSDATE = @SAUDA_DATE AND ACTIONCODE = 'I50')=0
BEGIN
	SET @ERR_CD = -1
	SET @ERR_DESC = 'PLEASE CLEAR THE ERROR CORRECTED FIRST'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
	RETURN
END

EXEC FOREARRANGETRDFLAG

--EXEC FOTRD_CLIENTMASTER

INSERT INTO FOSTAT_TRD
SELECT ACTIONCODE	 = 'I60',SYSDATE = @SAUDA_DATE,FILEDATE = @SAUDA_DATE,COM_DATE = LEFT(GETDATE(),11)

SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

/*------------------------------------------- END OF THE PROC ---------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE_CONTRACT
-- --------------------------------------------------


CREATE  PROC CLS_IMPORT_TRADE_FILE_CONTRACT
(	
	@SAUDA_DATE VARCHAR(11),
	@USERNAME VARCHAR(30)
) AS 

DECLARE @ERR_CD AS INT
DECLARE @ERR_DESC AS VARCHAR(200)

SET @ERR_CD  = 0
SET @ERR_DESC = ''

SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

IF (SELECT COUNT(1) FROM FOSTAT_TRD WHERE SYSDATE = @SAUDA_DATE AND ACTIONCODE = 'I60')=0
BEGIN
	SET @ERR_CD = -1
	SET @ERR_DESC = 'PLEASE COMPLETE THE CONFIRM TRADE FIRST'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
	RETURN
END

DECLARE @TRDCOUNT BIGINT
DECLARE @CONFCOUNT BIGINT
DECLARE @TRDQTY BIGINT
DECLARE @CONFQTY BIGINT
DECLARE @TRDAMT MONEY
DECLARE @CONFAMT MONEY

SELECT @CONFQTY=ISNULL(SUM(TRADEQTY),0),@CONFAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@CONFCOUNT=COUNT(1) FROM FOCONFIRMVIEW 
SELECT @TRDQTY=ISNULL(SUM(TRADEQTY),0),@TRDAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@TRDCOUNT=COUNT(1) FROM FOTRADE  
 
IF @TRDQTY <> @CONFQTY OR @TRDCOUNT <> @CONFCOUNT OR @TRDAMT <> @CONFAMT
BEGIN
	SET @ERR_CD = -1
	SET @ERR_DESC = 'STILL SOME ERROS IN MASTERS . HENCE THE BELOW TRADE AND CONFIRMVIEW IS NOT MATCHING'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
	
	SELECT 'TRADE COUNT ' +  CONVERT(VARCHAR,@TRDCOUNT) AS [TRADE] , 'CONFIRM TRADE COUNT ' +  CONVERT(VARCHAR,@CONFCOUNT) AS [CONFIRM TRADE] 
	UNION ALL
	SELECT 'TRADE QTY ' +  CONVERT(VARCHAR,@TRDQTY) AS [TRADE] , 'CONFIRM TRADE QTY ' +  CONVERT(VARCHAR,@CONFQTY) AS [CONFIRM TRADE] 
	UNION ALL
	SELECT 'TRADE AMT ' +  CONVERT(VARCHAR,@TRDAMT) AS [TRADE] , 'CONFIRM TRADE AMT ' +  CONVERT(VARCHAR,@CONFAMT) AS [CONFIRM TRADE] 
	
	RETURN	
END

IF (SELECT ISNULL(STYLE,0) FROM FOOWNER) =1
BEGIN
	IF (SELECT COUNT(1) FROM CONTGEN,FOTRADE WHERE ACTIVITYTIME >= START_DATE AND ACTIVITYTIME <= END_DATE)=0
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'PLEASE ENTER THE CONTRACT NO IN THE TABLE FOR THE CURRENT YEAR'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END
END

EXEC BFOGENCONTRACT @USERNAME


EXEC CLS_IMPORT_TRADE_FILE_PROCESS @MODE ='RESET_TRD'

SET @ERR_DESC = ''

SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

/*------------------------------------------- END OF THE PROC ---------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE_PROCESS
-- --------------------------------------------------



CREATE PROC CLS_IMPORT_TRADE_FILE_PROCESS
(	@MODE VARCHAR(20),
	@SAUDA_DATE VARCHAR(11)='',
	@SESSIONID VARCHAR(30)='',
	@IMPORTMODE INT=0	
) AS 

/*
	@MODE : RESET_TRD - TO RESET THE TRADE
	@MODE : TRDCOUNT_GET - TO GET THE TRADE REC COUNTS
	@MODE : NEXTSTEP_GET - TO GET THE IMP TRD PROCESS NEXT STEP
	@MODE : ERRTRD_GET - TO GET THE ERROR TRADE LIST
	@MODE : CHECK_ERR - TO CHECK THE TRADE ERROS
*/
/*
TRADE PROCESS STEP - ACTION CODES
I10 - TRADE FILE IMPORTED
I50 - ERROR CORRECTED CHECKED
I60 - TRADE CONFIRMED
I70 - CONCTRACT GENERATED
*/
-----------------------------------------------------------------------------------------
DECLARE @ERR_CD AS INT
DECLARE @ERR_DESC AS VARCHAR(200)

SET @ERR_CD  = 0
SET @ERR_DESC = ''

IF @MODE = 'RESET_TRD'
BEGIN	
	TRUNCATE TABLE BFOFTTRADE
	TRUNCATE TABLE FOTRADE
	TRUNCATE TABLE FOSTAT_TRD
END
-----------------------------------------------------------------------------------------

IF @MODE = 'TRDCOUNT_GET'
BEGIN	
	DECLARE @TRADE_DATE VARCHAR(11)

	IF (SELECT COUNT(1) FROM FOTRADE) >0
	BEGIN
		SELECT TOP 1 @TRADE_DATE = CONVERT(VARCHAR,ACTIVITYTIME,103) FROM FOTRADE
		IF @TRADE_DATE <> @SAUDA_DATE
		BEGIN
			IF @SESSIONID=''
			BEGIN
				SELECT ROW_COUNT = 0, IMPORT_COUNT= 0, PROCEED_COUNT= COUNT(1),
				ERRMSG = @TRADE_DATE
				FROM FOTRADE
			END
			ELSE
			BEGIN
				SELECT ROW_COUNT = 0, IMPORT_COUNT= 0, PROCEED_COUNT= 0, 
				ERRMSG = 'ERROR - TRADE DATE IN THE FILE ' + @TRADE_DATE + ' IS NOT MACHING THE ENTERED DATE'
				RETURN
			END
		END
	END
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF @IMPORTMODE  = 1 -- NORMAL IMPORT
	BEGIN
		SELECT ROW_COUNT = MAX(ROW_COUNT), IMPORT_COUNT= MAX(IMPORT_COUNT), PROCEED_COUNT= MAX(PROCEED_COUNT), ERRMSG = ''
		FROM
		(
			SELECT COUNT(1) AS ROW_COUNT, 0 AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM CLASSFILEUPD WHERE SESSION_ID = @SESSIONID
			UNION ALL
			SELECT 0 AS ROW_COUNT ,COUNT(1) AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM BFOFTTRADE WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
			UNION ALL
			SELECT 0 AS ROW_COUNT , 0 AS IMPORT_COUNT, COUNT(1) AS PROCEED_COUNT FROM FOTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		) A
	END
	ELSE
	BEGIN
		SELECT ROW_COUNT = MAX(ROW_COUNT), IMPORT_COUNT= MAX(IMPORT_COUNT), PROCEED_COUNT= MAX(PROCEED_COUNT), ERRMSG = ''
		FROM
		(
			SELECT COUNT(1) AS ROW_COUNT, 0 AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM CLASSFILEUPD_BULK WHERE SPID = @SESSIONID
			UNION ALL
			SELECT 0 AS ROW_COUNT ,COUNT(1) AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM BFOFTTRADE WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
			UNION ALL
			SELECT 0 AS ROW_COUNT , 0 AS IMPORT_COUNT, COUNT(1) AS PROCEED_COUNT FROM FOTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		) A
	END

END
-----------------------------------------------------------------------------------------

IF @MODE = 'NEXTSTEP_GET'
BEGIN	
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF (SELECT COUNT(1) FROM FOSTAT_TRD WHERE SYSDATE = @SAUDA_DATE )=0
	BEGIN
		SELECT CURR_STEP='', NEXT_STEP = 'START_IMP'
		RETURN
	END

	SELECT 
			CURR_STEP = CASE 
							WHEN LAST_STEP='I10' THEN 'START_IMP'
							WHEN LAST_STEP='I50' THEN 'ERROR_CORR'
							WHEN LAST_STEP='I60' THEN 'CONFIRM_TRD'
						ELSE 'CONTRACT_TRD'
						END,

			NEXT_STEP = CASE 
							WHEN LAST_STEP='I10' THEN 'ERROR_CORR'
							WHEN LAST_STEP='I50' THEN 'CONFIRM_TRD'
							WHEN LAST_STEP='I60' THEN 'CONTRACT_TRD'
						ELSE 'RESET_TRD'
						END
	FROM
	(
		SELECT LAST_STEP = MAX(ACTIONCODE) FROM FOSTAT_TRD 
		WHERE SYSDATE = @SAUDA_DATE
	) A
END
-----------------------------------------------------------------------------------------

IF @MODE = 'ERRTRD_GET'
BEGIN

	SET @ERR_CD = -1
	SET @ERR_DESC = 'ERROR TRADE LIST. PLEASE VERIFY'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

	SELECT BUY_CLIENT_CODE AS [PARTY CODE],TRADE_NO AS [TRADE NO],BUY_ORDER_NO AS [ORDER NO],TRADESTATUS AS [STATUS],
	[CONTRACT] = PRODUCT_TYPE + ' ' + ASSET_CODE + ' ' + LEFT(EXPIRYDATE,11) + ' ' + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + OPTION_TYPE
	FROM BFOFTTRADE  
	WHERE TRADESTATUS IN (12,17)
	AND BUY_ORDER_NO NOT IN ( SELECT ORDER_NO FROM FOTRADE)
	
	UNION ALL 
	
	SELECT SELL_CLIENT_CODE AS [PARTY CODE],TRADE_NO AS [TRADE NO],SELL_ORDER_NO AS [ORDER NO],TRADESTATUS AS [STATUS],
	[CONTRACT] = PRODUCT_TYPE + ' ' + ASSET_CODE + ' ' + LEFT(EXPIRYDATE,11) + ' ' + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + OPTION_TYPE
	FROM BFOFTTRADE  
	WHERE TRADESTATUS IN (12,17)
	AND SELL_ORDER_NO NOT IN ( SELECT ORDER_NO FROM FOTRADE)


	ORDER BY 1,2,3,4,5
	
	RETURN
END
-----------------------------------------------------------------------------------------------------
IF @MODE = 'CHECK_ERR'
BEGIN
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
	
	IF(SELECT COUNT(1) FROM FOTRADE ) = 0
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. NO RECORD TO PROCESS'
		
		TRUNCATE TABLE BFOFTTRADE
		TRUNCATE TABLE FOTRADE
		TRUNCATE TABLE FOSTAT_TRD
		
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END

	IF(SELECT COUNT(1) FROM (SELECT  DISTINCT LEFT(ACTIVITYTIME,11) AS SDATE FROM FOTRADE) TRD) > 1
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. DUPLICATE TRADE DATES FOUND IN THE FILE'
		
		TRUNCATE TABLE BFOFTTRADE
		TRUNCATE TABLE FOTRADE
		TRUNCATE TABLE FOSTAT_TRD
		
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END

	IF (SELECT MEMBERTYPE FROM FOOWNER) = 'CM'
	BEGIN
		UPDATE FOTRADE SET RESERVED2='0'
		UPDATE FOTRADE SET PARTY_CODE= CLIENT2.PARTY_CODE,RESERVED2='2' FROM CLIENT2 WHERE CLIENT2.BANKID =FOTRADE.PARTICIPANTCODE
		UPDATE FOTRADE SET PARTY_CODE=FOTMINFO.PARTY_CODE,RESERVED2='2' FROM FOTMINFO WHERE FOTMINFO.TM_CODE=FOTRADE.MEMBERCODE AND FOTRADE.RESERVED2='0'
	END


	UPDATE FOTRADE SET FOTRADE.PARTY_CODE = TERMPARTY.PARTY_CODE FROM TERMPARTY WHERE TERMPARTY.USERID = FOTRADE.USER_ID 
	AND FOTRADE.PRO_CLI = PROCLI 

	IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK) WHERE  CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE))> 1
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. MISSING CLIENT CODE FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

		SELECT DISTINCT PARTY_CODE AS [PARTY CODE],USER_ID AS [TERMIAL ID],ISNULL(PARTICIPANTCODE,'') AS [PARTICIPANT CODE],
		MEMBERCODE AS [MEMBER CODE]
		FROM FOTRADE WHERE NOT EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK) WHERE  CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE)
			
		RETURN
	END

	IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK) 
													WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL
													AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE
													AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE
													AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE))> 1
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. MISSING SCRIPTS FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		
		SELECT DISTINCT INST_TYPE AS [INST TYPE],SYMBOL, LEFT(EXPIRYDATE,11) AS [EXPIRY DATE],
		STRIKE_PRICE AS [STRIKE PRICE], OPTION_TYPE AS [OPTION TYPE]
		FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK) 
													WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL
													AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE
													AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE
													AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE)
		RETURN
	END

	--EXEC FOTRD_CLIENTMASTER

	SELECT FOTRADE.* INTO #FOERRTRADE 
	FROM FOTRADE (NOLOCK), FOOWNER (NOLOCK) WHERE EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK)
	WHERE CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE AND CLIENT2.BANKID <> FOTRADE.PARTICIPANTCODE)
	AND ISNULL(PARTICIPANTCODE,'') <> ''
	AND PARTICIPANTCODE <> FOOWNER.MEMBERCODE

	INSERT INTO FOERRTRADE      
	SELECT * FROM #FOERRTRADE

	IF (((SELECT COUNT(1) FROM #FOERRTRADE) > 0) OR ((SELECT COUNT(1) FROM FOTRADE (NOLOCK), CLIENT5 (NOLOCK) 
												WHERE FOTRADE.PARTY_CODE = CLIENT5.CL_CODE
												AND CLIENT5.INACTIVEFROM <= GETDATE())>0))
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. WRONG CLIENT CODE FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]


		SELECT PARTY_CODE,'IN ACTIVE' FROM FOTRADE (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRADE.PARTY_CODE = CLIENT5.CL_CODE
		AND CLIENT5.INACTIVEFROM <= GETDATE()

		/*UNION ALL

		SELECT C.PARTY_CODE,'EXPIRED SEBI REG' FROM 
		FOTRD_CLIENT2 (NOLOCK), CLIENT_DETAILS_VIEW C (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = C.CL_CODE
		AND ISNULL(C.SEBI_REGN_NO,'') <> '' AND C.SEBI_EXP_DATE <= GETDATE()*/

		UNION ALL

		SELECT DISTINCT PARTY_CODE,'WRONG CP CODE' FROM #FOERRTRADE 
		
		RETURN
	END

	--EXEC FOTRD_SCRIPMASTER


	DECLARE @TRDCOUNT BIGINT
	DECLARE @CONFCOUNT BIGINT
	DECLARE @TRDQTY BIGINT
	DECLARE @CONFQTY BIGINT
	DECLARE @TRDAMT MONEY
	DECLARE @CONFAMT MONEY

	SELECT @CONFQTY=ISNULL(SUM(TRADEQTY),0),@CONFAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@CONFCOUNT=COUNT(1) FROM FOCONFIRMVIEW 
	SELECT @TRDQTY=ISNULL(SUM(TRADEQTY),0),@TRDAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@TRDCOUNT=COUNT(1) FROM FOTRADE  
	 
	IF @TRDQTY <> @CONFQTY OR @TRDCOUNT <> @CONFCOUNT OR @TRDAMT <> @CONFAMT
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'STILL SOME ERROS IN MASTERS . HENCE THE BELOW TRADE AND CONFIRMVIEW IS NOT MATCHING'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		
		SELECT 'TRADE COUNT ' +  CONVERT(VARCHAR,@TRDCOUNT) AS [TRADE] , 'CONFIRM TRADE COUNT ' +  CONVERT(VARCHAR,@CONFCOUNT) AS [CONFIRM TRADE] 
		UNION ALL
		SELECT 'TRADE QTY ' +  CONVERT(VARCHAR,@TRDQTY) AS [TRADE] , 'CONFIRM TRADE QTY ' +  CONVERT(VARCHAR,@CONFQTY) AS [CONFIRM TRADE] 
		UNION ALL
		SELECT 'TRADE AMT ' +  CONVERT(VARCHAR,@TRDAMT) AS [TRADE] , 'CONFIRM TRADE AMT ' +  CONVERT(VARCHAR,@CONFAMT) AS [CONFIRM TRADE] 
		
		RETURN	
	END

	INSERT INTO FOSTAT_TRD
	SELECT ACTIONCODE	 = 'I50',SYSDATE = @SAUDA_DATE,FILEDATE = @SAUDA_DATE,COM_DATE = LEFT(GETDATE(),11)

	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
END
/*------------------------------------------ END OF THE PROC ------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGIN_RPT
-- --------------------------------------------------

--EXEC CLS_MARGIN_RPT '01/01/2000','10/10/2014','','','BROKER','BROKER'

CREATE  PROC [DBO].[CLS_MARGIN_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25)
)  AS


SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)


IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'


IF (SELECT COUNT(1) FROM PRADNYA.DBO.HISTORY_TBL_CLIENTMARGIN_NSEFO (NOLOCK)
WHERE MARGINDATE  BETWEEN @DATEFROM  AND  @DATETO + ' 23:59:00' ) > 0
BEGIN
SELECT
		CLIENT2.PARTY_CODE,
		PARTY_NAME = CLIENT1.LONG_NAME,		
		MARGIN_DATE = CONVERT(VARCHAR,MARGINDATE,103),
		BILL_AMOUNT = BILLAMOUNT ,
		LEDGER_AMOUNT = LEDGERAMOUNT ,      
		NET_CASH_AVAILABLE = BILLAMOUNT + LEDGERAMOUNT,
		COLLATERAL_AVAILABLE = CASH_COLL + NONCASH_COLL,
		REPORTED_MRG_COLLATERAL = ISNULL(F.FINALAMOUNT,0),
		INITIALMARGIN = INITIALMARGIN, 
		MTMMARGIN = MTMMARGIN,
		ADDMARGIN = ADDMARGIN,
		FREE_COLLATERALS = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT),
		FREE_COLLATERALS_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT)
	FROM
		CLIENT1 (NOLOCK) ,  CLIENT2 (NOLOCK),
		PRADNYA.DBO.HISTORY_TBL_CLIENTMARGIN_NSEFO FO (NOLOCK)
		LEFT OUTER JOIN
		(
			SELECT EFFDATE,PARTY_CODE, FINALAMOUNT = SUM(FINALAMOUNT) FROM 
			TBL_COLLATERAL_MARGIN (NOLOCK) 
			WHERE EFFDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
			GROUP BY EFFDATE,PARTY_CODE
		) F
		ON (MARGINDATE = EFFDATE AND F.PARTY_CODE = FO.PARTY_CODE)
	WHERE
		MARGINDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT
		CLIENT2.PARTY_CODE,
		PARTY_NAME = CLIENT1.LONG_NAME,		
		MARGIN_DATE = CONVERT(VARCHAR,MARGINDATE,103),
		BILL_AMOUNT = BILLAMOUNT ,
		LEDGER_AMOUNT = LEDGERAMOUNT ,      
		NET_CASH_AVAILABLE = BILLAMOUNT + LEDGERAMOUNT,
		COLLATERAL_AVAILABLE = CASH_COLL + NONCASH_COLL,
		REPORTED_MRG_COLLATERAL = ISNULL(F.FINALAMOUNT,0),
		INITIALMARGIN = INITIALMARGIN, 
		MTMMARGIN = MTMMARGIN,
		ADDMARGIN = ADDMARGIN,
		FREE_COLLATERALS = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT),
		FREE_COLLATERALS_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT)
	FROM
		CLIENT1 (NOLOCK) ,  CLIENT2 (NOLOCK),
		TBL_CLIENTMARGIN FO (NOLOCK)
		LEFT OUTER JOIN
		(
			SELECT EFFDATE,PARTY_CODE, FINALAMOUNT = SUM(FINALAMOUNT) FROM 
			TBL_COLLATERAL_MARGIN (NOLOCK) 
			WHERE EFFDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
			GROUP BY EFFDATE,PARTY_CODE
		) F
		ON (MARGINDATE = EFFDATE AND F.PARTY_CODE = FO.PARTY_CODE)
	WHERE
		MARGINDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGIN_RPT_COLLATERAL
-- --------------------------------------------------



/*
EXEC CLS_MARGIN_RPT_COLLATERAL '18/04/2013','A001','COLL'
CLS_MARGIN_RPT_COLLATERAL EXEC '02/02/2009','0A1411','MRG'
*/

CREATE  PROC [DBO].[CLS_MARGIN_RPT_COLLATERAL]
(
	@MARGINDATE VARCHAR(11),
	@PARTYCODE VARCHAR (20), 
	@REPORT_FOR VARCHAR(10)
)  AS


/*
	@REPORT_FOR : COLL - COLLATEAL ACTUAL  / MRG - MARGIN REPORTED
*/

SET @MARGINDATE = LEFT(CONVERT(DATETIME,@MARGINDATE,103),11)


IF @REPORT_FOR ='COLL'
BEGIN

	SELECT 
		PARTICULARS = CASE WHEN CASH_NCASH = 'N' THEN SCRIP_CD + '-' + SERIES ELSE 'FD/BG -' + FD_BG_NO END,
		RATE  = CL_RATE,QTY ,HAIRCUT,
		CASH = CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END,
		NONCASH = CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END,
		RPT_TYPE=1
	FROM MSAJAG..COLLATERALDETAILS WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE
	AND EXCHANGE = (SELECT  TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
	AND SEGMENT = 'FUTURES'	
	AND PARTY_CODE = @PARTYCODE	
	

	UNION ALL

	SELECT 
		PARTICULARS = 'TOTAL :',
		RATE = 0,QTY=ISNULL(SUM(QTY),0) ,HAIRCUT=0,
		CASH = ISNULL(SUM(CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END),0),
		NONCASH = ISNULL(SUM(CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END),0),
		RPT_TYPE=2
	FROM MSAJAG..COLLATERALDETAILS WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE
	AND EXCHANGE = (SELECT  TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
	AND SEGMENT = 'FUTURES'	
	AND PARTY_CODE = @PARTYCODE
	
	ORDER BY RPT_TYPE , PARTICULARS,5 DESC
	
END

ELSE
BEGIN

	SELECT 
		PARTICULARS = CASE WHEN CASH_NCASH = 'N' THEN SCRIP_CD + '-' + SERIES ELSE 'FD/BG -' + FD_BG_NO END,
		RATE  = CL_RATE,QTY ,HAIRCUT,
		CASH = CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END,
		NONCASH = CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END,
		RPT_TYPE=1
	FROM TBL_COLLATERAL_MARGIN WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE

	AND PARTY_CODE = @PARTYCODE

	UNION ALL

	SELECT 
		PARTICULARS = 'TOTAL :',
		RATE = 0,QTY=ISNULL(SUM(QTY),0) ,HAIRCUT=0,
		CASH = ISNULL(SUM(CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END),0),
		NONCASH = ISNULL(SUM(CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END),0),
		RPT_TYPE=2
	FROM TBL_COLLATERAL_MARGIN WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE
	AND PARTY_CODE = @PARTYCODE
	
	ORDER BY RPT_TYPE ,PARTICULARS, 5 DESC

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_NETPOSITION_RPT
-- --------------------------------------------------

/*
EXEC CLS_NETPOSITION_RPT '01/01/2000','10/10/2014','','','','','BROKER','BROKER',1,'PARTY','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'PARTY','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',3,'PARTY','','','',0,'STRIKE'

EXEC CLS_NETPOSITION_RPT '26/09/2014','26/09/2014','10100044','10100044','','','BROKER','BROKER',1,'SCRIP','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '26/09/2014','26/09/2014','10100044','10100044','','','BROKER','BROKER',2,'SCRIP','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '26/09/2014','26/09/2014','10100044','10100044','','','BROKER','BROKER',3,'SCRIP','','','',0,'BOTH'
*/

CREATE PROC [DBO].[CLS_NETPOSITION_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@FROMSCRIP VARCHAR(20),
	@TOSCRIP VARCHAR (20), 	
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25),
	@REPORTTYPE INT=1,
	@REPORT_BY VARCHAR(10)='PARTY',
	@INST_TYPE VARCHAR(7) ='',
	@EXPIRYDATE VARCHAR(11) ='',
	@OPTION_TYPE VARCHAR(2) ='',
	@STRIKE_PRICE MONEY = 0,
	@REPORTBY VARCHAR(10) = 'PRICE'
	
)  AS


/*
	@REPORTTYPE = 1 : PARTY / SCRIP WISE SUMMARY
	@REPORTTYPE = 2 : PARTY + SCRIP / SCRIP + PARTY
	@REPORTTYPE = 3 : PARTY + SCRIP + SAUDA_DATE / SCRIP + PARTY + SAUDA_DATE 
	
	@REPORT_BY : PARTY / SCRIP

*/

SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)


IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF @TOSCRIP =''
SET @TOSCRIP ='ZZZZZZZ'

SELECT 
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),
	PARTY_CODE, PARTY_NAME = MAX(LEFT(PARTY_NAME,20)),
	SYMBOL, 
	INST_TYPE, 
	EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103), STRIKE_PRICE, OPTION_TYPE, 
	PQTY = SUM(PQTY),
	SQTY = SUM(SQTY),	
	PAMT = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(PRATE*PQTY)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*PQTY) ELSE (PRATE*PQTY) END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM((STRIKE_PRICE+PRATE)*PQTY)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM((STRIKE_PRICE+PRATE)*PQTY)
		ELSE SUM(PRATE*PQTY)
	END), 
	SAMT = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(SRATE*SQTY)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*SQTY) ELSE (SRATE*SQTY) END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM((STRIKE_PRICE+SRATE)*SQTY)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM((STRIKE_PRICE+SRATE)*SQTY)
		ELSE SUM(SRATE*SQTY)
	END), 
	NETQTY = SUM(PQTY) - SUM(SQTY), 
	NETVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN (SUM(PRATE*PQTY)-SUM(SRATE*SQTY))
		WHEN @REPORTBY = 'STRIKE'	THEN (SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*PQTY) ELSE (PRATE*PQTY) END)-SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*SQTY) ELSE (SRATE*SQTY) END))
		WHEN @REPORTBY = 'BOTH'		THEN (SUM((STRIKE_PRICE+PRATE)*PQTY)-SUM((STRIKE_PRICE+SRATE)*SQTY))
		WHEN @REPORTBY = 'EXCHG'	THEN (SUM((STRIKE_PRICE+PRATE)*PQTY)-SUM((STRIKE_PRICE+SRATE)*SQTY))
		ELSE (SUM(PRATE*PQTY)-SUM(SRATE*SQTY))
	END),
	AVGPRICE = (CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 THEN SUM(((PQTY*PRATE) - (SQTY*SRATE)) )/ (SUM(PQTY) - SUM(SQTY)) ELSE 0 END),  
	NETOPENVALUE = SUM((PQTY - SQTY)*CL_RATE),
	CLOSEPRICE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ),
	PAMT_NEW = SUM(PRATE*PQTY),
	SAMT_NEW = SUM(SRATE*SQTY)
INTO #NETPOSITION
FROM FOBILLVALAN (NOLOCK), FOOWNER (NOLOCK)
WHERE
	SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' 
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP
	AND MEMBERCODE = PARTICIPANTCODE
	AND INST_TYPE = CASE WHEN @INST_TYPE = '' THEN INST_TYPE ELSE @INST_TYPE END
	AND LEFT(EXPIRYDATE,11) = CASE WHEN @EXPIRYDATE = '' THEN LEFT(EXPIRYDATE,11) ELSE LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11)  END
	AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '' THEN OPTION_TYPE ELSE @OPTION_TYPE END
	AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
	AND @STATUSNAME = 		
	(CASE
		WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
		WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
		WHEN @STATUSID = 'TRADER' THEN TRADER
		WHEN @STATUSID = 'FAMILY' THEN FAMILY
		WHEN @STATUSID = 'AREA' THEN AREA
		WHEN @STATUSID = 'REGION' THEN REGION
		WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE 
		ELSE 'BROKER' 
	END)
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE ,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE  


ALTER TABLE #NETPOSITION ADD SRNO INT IDENTITY(1,1)

IF @REPORTTYPE = 1  -- SUMMARY
BEGIN
	IF @REPORT_BY = 'PARTY'
	BEGIN

		SELECT 
		PARTY_CODE AS CLIENT_CODE,PARTY_NAME AS CLIENT_NAME,
		SYMBOL = '',INST_TYPE= '',EXPIRYDATE= '',STRIKE_PRICE= '',OPTION_TYPE= '',
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,2),SUM(SAMT)),
		NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,2),SUM(NETVALUE)),
		AVGPRICE = 0,
		NETOPENVALUE = CONVERT(NUMERIC(18,2),SUM(NETOPENVALUE)),
		CLOSEPRICE = 0
		FROM
		(
			SELECT 
			PARTY_CODE ,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
			PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
			PAMT = SUM(PAMT),
			SAMT = SUM(SAMT),
			NETQTY = SUM(NETQTY),
			NETVALUE = SUM(NETVALUE),
			NETOPENVALUE = SUM(NETOPENVALUE),
			PAMT_NEW = SUM(PAMT_NEW),
			SAMT_NEW = SUM(SAMT_NEW)
			FROM #NETPOSITION
			GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
			HAVING SUM(PQTY-SQTY)<>0
		) A
		GROUP BY PARTY_CODE,PARTY_NAME
		ORDER BY PARTY_CODE,PARTY_NAME
	
		
	END
	ELSE
	BEGIN
		
		
		SELECT 
		SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,2),SUM(SAMT)),NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,2),SUM(NETVALUE)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT_NEW)>SUM(SAMT_NEW) THEN SUM(PAMT_NEW)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT_NEW)/SUM(SQTY) ELSE 0 END END),
		NETOPENVALUE = CONVERT(NUMERIC(18,2),SUM(NETOPENVALUE)),
		CLOSEPRICE = CONVERT(NUMERIC(18,2),CLOSEPRICE)
		FROM
		(
			SELECT 
			PARTY_CODE ,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
			PQTY = SUM(PQTY ),SQTY = SUM(SQTY),PAMT = SUM(PAMT),
			SAMT = SUM(SAMT),NETQTY = SUM(NETQTY),
			NETVALUE = SUM(NETVALUE),
			NETOPENVALUE = SUM(NETOPENVALUE),
			PAMT_NEW = SUM(PAMT_NEW),
			SAMT_NEW = SUM(SAMT_NEW),
			CLOSEPRICE
			FROM #NETPOSITION
			GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		HAVING SUM(PQTY-SQTY)<>0
		) A
		GROUP BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		ORDER BY SYMBOL,INST_TYPE,CONVERT(DATETIME,EXPIRYDATE,103),STRIKE_PRICE,OPTION_TYPE
	
	END
END

IF @REPORTTYPE = 2  -- DETAILS
BEGIN
		
		SELECT 
		--SRNO = MAX(SRNO),
		PARTY_CODE AS CLIENT_CODE,PARTY_NAME AS CLIENT_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,4),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,4),SUM(SAMT)),NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,4),SUM(NETVALUE)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT_NEW)>SUM(SAMT_NEW) THEN SUM(PAMT_NEW)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT_NEW)/SUM(SQTY) ELSE 0 END END),
		NETOPENVALUE = CONVERT(NUMERIC(18,4),SUM(NETOPENVALUE)),
		CLOSEPRICE = CONVERT(NUMERIC(18,2),CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END)
		FROM #NETPOSITION
		GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END
		HAVING SUM(PQTY-SQTY)<>0
		ORDER BY (CASE WHEN @REPORT_BY = 'PARTY' THEN PARTY_CODE ELSE SYMBOL END),(CASE WHEN @REPORT_BY = 'PARTY' THEN SYMBOL ELSE PARTY_CODE END),INST_TYPE,CONVERT(DATETIME,EXPIRYDATE,103),STRIKE_PRICE,OPTION_TYPE
END

IF @REPORTTYPE = 3  -- FURTHER DETAILS
BEGIN
		SELECT 
		--SRNO = MAX(SRNO),
		SAUDA_DATE,PARTY_CODE AS CLIENT_CODE ,PARTY_NAME AS CLIENT_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,4),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,4),SUM(SAMT)),NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,4),SUM(NETVALUE)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT_NEW)>SUM(SAMT_NEW) THEN SUM(PAMT_NEW)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT_NEW)/SUM(SQTY) ELSE 0 END END),
		NETOPENVALUE = CONVERT(NUMERIC(18,4),SUM(NETOPENVALUE)),
		CLOSEPRICE = CONVERT(NUMERIC(18,2),CLOSEPRICE)
		FROM #NETPOSITION
		GROUP BY SAUDA_DATE,PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		HAVING SUM(PQTY-SQTY)<>0
		ORDER BY (CASE WHEN @REPORT_BY = 'PARTY' THEN PARTY_CODE ELSE SYMBOL END),(CASE WHEN @REPORT_BY = 'PARTY' THEN SYMBOL ELSE PARTY_CODE END),CONVERT(DATETIME,SAUDA_DATE,103)
END


DROP TABLE #NETPOSITION

/*------------------------------------------ END OF THE PROC -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_OPTION_EXERCISE_VALID
-- --------------------------------------------------
CREATE PROCEDURE CLS_OPTION_EXERCISE_VALID    
(    
 @TRADEDATE VARCHAR(11),    
 @MODE VARCHAR(2),    
 @PARTC0DE VARCHAR(12)    
)    
AS    
BEGIN       
   
  SELECT      
   @TRADEDATE = CASE WHEN LEN(@TRADEDATE) = 10 AND CHARINDEX('/', @TRADEDATE) > 0              
   THEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @TRADEDATE, 103), 109)              
   ELSE @TRADEDATE END    
          
  IF @MODE='1'    
  BEGIN    
  SELECT BUSINESS_DATE FROM V2_BUSINESS_PROCESS (NOLOCK) WHERE BUSINESS_DATE LIKE @TRADEDATE AND OPEN_CLOSE=1    
  END    
    
  IF @MODE='2'    
  BEGIN    
  SELECT DISTINCT FOEATRD_PARTY_CODE FROM FOEXALLOCTRADE WHERE FOEATRD_PARTY_CODE NOT IN (SELECT DISTINCT PARTY_CODE FROM CLIENT2)    
  END    
    
  IF @MODE='3'    
  BEGIN    
    SELECT A.FOEATRD_PARTY_CODE,A.FOEATRD_INST_TYPE,A.FOEATRD_SYMBOL,FOEATRD_EXPIRYDATE = CONVERT(CHAR(11),A.FOEATRD_EXPIRYDATE,109),    
    A.FOEATRD_STRIKE_PRICE,A.FOEATRD_SELL_BUY,A.FOEATRD_OPTION_TYPE, BUYQTY = CASE A.FOEATRD_SELL_BUY WHEN 1 THEN SUM(A.FOEATRD_TRADEQTY) ELSE 0 END,    
    SELLQTY = CASE A.FOEATRD_SELL_BUY WHEN 2 THEN SUM(A.FOEATRD_TRADEQTY) ELSE 0 END    
    FROM FOEXALLOCTRADE A       
    WHERE A.FOEATRD_PARTY_CODE = @PARTC0DE    
    AND FOEATRD_TRADEQTY <> 0    
    GROUP BY A.FOEATRD_PARTY_CODE,A.FOEATRD_INST_TYPE,A.FOEATRD_SYMBOL,    
    A.FOEATRD_EXPIRYDATE,A.FOEATRD_STRIKE_PRICE,A.FOEATRD_OPTION_TYPE,A.FOEATRD_SELL_BUY     
    ORDER BY A.FOEATRD_INST_TYPE,A.FOEATRD_SYMBOL,A.FOEATRD_EXPIRYDATE,A.FOEATRD_STRIKE_PRICE,A.FOEATRD_OPTION_TYPE, A.FOEATRD_SELL_BUY    
  END    
    
  IF @MODE='4'    
  BEGIN  
  SELECT @TRADEDATE  
  SELECT TOP 1 FOEATRD_ACTIVITYTIME FROM FOEXALLOCTRADEHIST (NOLOCK) WHERE FOEATRD_ACTIVITYTIME BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'  
  END  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETAILS_RPT
-- --------------------------------------------------


-- EXEC CLS_PARTYDETAILS_RPT '010A141'

CREATE PROCEDURE [DBO].[CLS_PARTYDETAILS_RPT]     
(    
	@PARTYCODE AS VARCHAR(20)    
)       
AS  
   
/*
	RECORD SET 1 - BASIC INFO
	RECORD SET 2 - TRD & DEL BROK FOR EQ / FUT & OPT FOR F&O
	RECORD SET 3 - TRD & DEL VBB BROK EQ / FUT & OPT FOR F&O
	RECORD SET 4 - DP DETAILS - PAYIN A/C 
	RECORD SET 5 - DP DETAILS - PAYOUT A/C 
	
*/
    

------------------------------------------------------------------------------------------------------------------------------
DECLARE @SEGMENT VARCHAR(20)
SELECT TOP 1 @SEGMENT= SEGMENT FROM PRADNYA.DBO.MULTICOMPANY  WITH(NOLOCK) WHERE SHAREDB = DB_NAME()

IF @SEGMENT = 'CAPITAL'
BEGIN

	    
	SELECT 
		CL2.PARTY_CODE,
		CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,     
		CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX,CL1.RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,      
		CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,      
		S1.NAME,B1.BRANCH,    
		
		TURNOVER_TAX =  (CASE WHEN ISNULL(CT.TURNOVER_TAX,CL2.TURNOVER_TAX)=0 THEN 'N' ELSE 'Y' END),
		SEBI_TURN_TAX =  (CASE WHEN ISNULL(CT.SEBITURN_TAX,CL2.SEBI_TURN_TAX)=0 THEN 'N' ELSE 'Y' END),
		STT_CHARGES  =  (CASE WHEN ISNULL(CT.INSURANCE_CHRG,CL2.INSURANCE_CHRG)=0 THEN 'N' ELSE 'Y' END),
		OTHER_CHRG  =  (CASE WHEN ISNULL(CT.OTHER_CHRG,CL2.OTHER_CHRG)=0 THEN 'N' ELSE 'Y' END),
		STAMP_DUTY  =  (CASE WHEN ISNULL(CT.BROKER_NOTE,CL2.BROKERNOTE)=0 THEN 'N' ELSE 'Y' END),
		
		ROUNDING_STYLE
			 = CASE WHEN CT.PARTY_CODE IS NULL THEN '' ELSE CONVERT(VARCHAR,ROUND_TO) + ' DECIMAL ' + 
				( CASE WHEN ( ROFIG =0 AND ERRNUM=0.5 AND NOZERO=1) THEN 'ACTUAL'  ELSE 
				( CASE WHEN ( ROFIG =1 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
				( CASE WHEN ( ROFIG =5 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 5P' ELSE 
				( CASE WHEN ( ROFIG =-1 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 1P' ELSE 
				( CASE WHEN ( ROFIG =-5 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
				( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'  END )END )END )END )END )END )
			END,
				
		SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'      
						WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'      
						WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'      
						END),      

		BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'      
							WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'    
							WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'      
							WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'      
							WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'      
							END) ,
		CONTRACT_STYLE = (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'      
							WHEN CL2.INSCONT='O' THEN 'ORDERWISE'      
							ELSE 'NORMAL' END) ,
		PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID   ELSE  '' END) ,
		CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO ELSE  '' END) ,
		CONTRACT_PRINT = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT' ELSE 'DONT PRINT' END) ,        
		PRINTING  = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'      
					WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'      
					WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'      
					WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'      
					WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'      
					END) ,
		ACTIVEFROM= CONVERT(VARCHAR,C5.ACTIVEFROM,103),
		INACTIVEFROM= CONVERT(VARCHAR,C5.INACTIVEFROM,103),  
		C5.INTRODUCER,
		PAYLOCATION = CL1.GL_CODE,
		SEBI_NO = FD_CODE,
		MAPINID = ISNULL(MAPIDID,''),
		UCC_CODE = ISNULL(UCC_CODE,''),
		BIRTHDATE = (CASE WHEN LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) = 'JAN  1 1900' THEN '' ELSE LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) END),
		BROK_ROUNDING_STYLE = 'MARKETRATE: ' + CONVERT(VARCHAR,ISNULL(MARKETRATE,'')) +', BROKERAGE: '+ CONVERT(VARCHAR,ISNULL(BROKERAGE,'')) +' NETRATE: '+ CONVERT(VARCHAR,ISNULL(NETRATE,''))  
	FROM CLIENT2 CL2 (NOLOCK)
		LEFT OUTER JOIN MSAJAG.DBO.UCC_CLIENT UC WITH (NOLOCK) ON (CL2.PARTY_CODE = UC.PARTY_CODE)
		LEFT OUTER JOIN CLIENTTAXES_NEW CT (NOLOCK) ON (CT.PARTY_CODE = CL2.PARTY_CODE AND GETDATE() BETWEEN FROMDATE AND TODATE
														AND TRANS_CAT = 'TRD' )
		LEFT OUTER JOIN INSTCLIENT_TBL I (NOLOCK) ON (I.PARTYCODE = CL2.PARTY_CODE),  
		CLIENT1 CL1,
		CLIENT5 C5 (NOLOCK),    
		SUBBROKERS S1 (NOLOCK),
		BRANCH B1 (NOLOCK)
	WHERE CL1.CL_CODE = CL2.CL_CODE      
	AND C5.CL_CODE = CL1.CL_CODE
	AND S1.SUB_BROKER = CL1.SUB_BROKER      
	AND CL2.PARTY_CODE = @PARTYCODE    
	AND B1.BRANCH_CODE = CL1.BRANCH_CD    
	  
	--------------------------------------------------------------------------------------------------------------------------------------------------
	SELECT 
		BROKERAGE = 'TRADING BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO FROM CLIENTBROK_SCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND TRADE_TYPE = 'NRM' AND SCHEME_TYPE = 'TRD' AND GETDATE() BETWEEN FROM_DATE AND TO_DATE
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	UNION ALL

	SELECT 
		BROKERAGE = 'DELIVERY BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO FROM CLIENTBROK_SCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND TRADE_TYPE = 'NRM' AND SCHEME_TYPE = 'DEL' AND GETDATE() BETWEEN FROM_DATE AND TO_DATE
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	ORDER BY 1,2,3
END
ELSE
BEGIN


	    
	SELECT 
		CL2.PARTY_CODE,
		CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,     
		CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX,CL1.RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,      
		CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,      
		S1.NAME,B1.BRANCH,    
		
		TURNOVER_TAX =  (CASE WHEN ISNULL(CT.FUT_TURNOVER_TAX,CL2.TURNOVER_TAX)=0 THEN 'N' ELSE 'Y' END),
		SEBI_TURN_TAX =  (CASE WHEN ISNULL(CT.FUT_SEBITURN_TAX,CL2.SEBI_TURN_TAX)=0 THEN 'N' ELSE 'Y' END),
		STT_CHARGES  =  (CASE WHEN ISNULL(CT.FUT_INSURANCE_CHRG,CL2.INSURANCE_CHRG)=0 THEN 'N' ELSE 'Y' END),
		OTHER_CHRG  =  (CASE WHEN ISNULL(CT.FUT_OTHER_CHRG,CL2.OTHER_CHRG)=0 THEN 'N' ELSE 'Y' END),
		STAMP_DUTY  =  (CASE WHEN ISNULL(CT.FUT_BROKER_NOTE,CL2.BROKERNOTE)=0 THEN 'N' ELSE 'Y' END),
		
		ROUNDING_STYLE
			 = CASE WHEN CT.PARTY_CODE IS NULL THEN '' ELSE CONVERT(VARCHAR,ROUND_TO) + ' DECIMAL ' + 
				( CASE WHEN ( ROFIG =0 AND ERRNUM=0.5 AND NOZERO=1) THEN 'ACTUAL'  ELSE 
				( CASE WHEN ( ROFIG =1 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
				( CASE WHEN ( ROFIG =5 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 5P' ELSE 
				( CASE WHEN ( ROFIG =-1 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 1P' ELSE 
				( CASE WHEN ( ROFIG =-5 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
				( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'  END )END )END )END )END )END )
			END,
				
		SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'      
						WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'      
						WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'      
						END),      

		BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'      
							WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'    
							WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'      
							WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'      
							WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'      
							END) ,
		CONTRACT_STYLE = (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'      
							WHEN CL2.INSCONT='O' THEN 'ORDERWISE'      
							ELSE 'NORMAL' END) ,
		PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID   ELSE  '' END) ,
		CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO ELSE  '' END) ,
		CONTRACT_PRINT = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT' ELSE 'DONT PRINT' END) ,        
		PRINTING  = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'      
					WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'      
					WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'      
					WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'      
					WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'      
					END) ,
		ACTIVEFROM= CONVERT(VARCHAR,C5.ACTIVEFROM,103),
		INACTIVEFROM= CONVERT(VARCHAR,C5.INACTIVEFROM,103),  
		C5.INTRODUCER,
		PAYLOCATION = CL1.GL_CODE,
		SEBI_NO = FD_CODE,
		MAPINID = ISNULL(MAPIDID,''),
		UCC_CODE = ISNULL(UCC_CODE,''),
		BIRTHDATE = (CASE WHEN LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) = 'JAN  1 1900' THEN '' ELSE LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) END),
		BROK_ROUNDING_STYLE = 'MARKETRATE: ' + CONVERT(VARCHAR,ISNULL(MARKETRATE,'')) +', BROKERAGE: '+ CONVERT(VARCHAR,ISNULL(BROKERAGE,'')) +' NETRATE: '+ CONVERT(VARCHAR,ISNULL(NETRATE,''))  
	FROM CLIENT2 CL2 (NOLOCK)
		LEFT OUTER JOIN MSAJAG.DBO.UCC_CLIENT UC WITH (NOLOCK) ON (CL2.PARTY_CODE = UC.PARTY_CODE)
		LEFT OUTER JOIN FOCLIENTTAXES CT (NOLOCK) ON (CT.PARTY_CODE = CL2.PARTY_CODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO)
		LEFT OUTER JOIN INSTCLIENT_TBL I (NOLOCK) ON (I.PARTYCODE = CL2.PARTY_CODE),  
		CLIENT1 CL1,
		CLIENT5 C5 (NOLOCK),    
		SUBBROKERS S1 (NOLOCK),
		BRANCH B1 (NOLOCK)
	WHERE CL1.CL_CODE = CL2.CL_CODE      
	AND C5.CL_CODE = CL1.CL_CODE
	AND S1.SUB_BROKER = CL1.SUB_BROKER      
	AND CL2.PARTY_CODE = @PARTYCODE    
	AND B1.BRANCH_CODE = CL1.BRANCH_CD    
	  	
	---------------------------------------------------------------------------------------------------------------------------------
	SELECT 
		BROKERAGE = 'FUTURE BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO=FUT_BROKTABLE FROM FOCLIENTBROKSCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	UNION ALL

	SELECT 
		BROKERAGE = 'OPTION BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO=OPT_BROKTABLE FROM FOCLIENTBROKSCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	ORDER BY 1,2,3

END

--------------------------------------------------------------------------------------------------------------------------------
SELECT 
	BROKERAGE = CASE 
			WHEN SP_TRD_TYPE='TRD' THEN 'TRADING' 
			WHEN SP_TRD_TYPE='DEL' THEN 'DELIVERY' 
			END + 
			CASE WHEN @SEGMENT = 'CAPITAL' THEN '' ELSE '' END
			+' VOLUME BASED BROKERAGE' ,
	SCHEMEDT = LEFT(SP_DATE_FROM,11) + ' -  ' + LEFT(SP_DATE_TO,11),
	SCHEMEID = SP_SCHEME_ID,
	SCHEMEDESC = ISNULL(SM_SCHEME_DESC,''),
	SCHEMETYPE = CASE 
			WHEN SP_TRD_TYPE='TRD' THEN 'NORMAL TRADE' 
			WHEN SP_TRD_TYPE='DEL' THEN 'DELIVERY TRADE' 
			END,
	SYMBOL = SP_SCRIP , 
	COMPUTATIONTYPE = CASE SP_BROK_COMPUTETYPE WHEN  'I' THEN 'INCREMENTAL' ELSE 'VARIABLE' END,
	BROKCOMPUTEON = CASE WHEN SP_BROK_COMPUTEON ='T' THEN 'TURNOVER' ELSE
				CASE WHEN SP_BROK_COMPUTEON ='Q' THEN 'QUANTITY' ELSE
				CASE WHEN SP_BROK_COMPUTEON ='L' THEN 'LOT SIZE' ELSE
				'VALUE OF LOT' END END END ,
	COMPUTATIONLEVEL = CASE WHEN SP_COMPUTATION_LEVEL ='T' THEN 'TRADES' ELSE
				CASE WHEN SP_COMPUTATION_LEVEL ='O' THEN 'ORDER' ELSE
				CASE WHEN SP_COMPUTATION_LEVEL ='S' THEN 'SCRIP' ELSE
					'CONTRACT' END END END,
	SCHEME = CASE WHEN SP_SCHEME_TYPE=0 THEN 'DEFAULT' ELSE
			 CASE WHEN SP_SCHEME_TYPE=1 THEN 'MAX LOGIC BS FL' ELSE 
			'MAX LOGIC SS FL' END END,
	VALUERANGE = CONVERT(VARCHAR,SP_VALUE_FROM) + ' - ' + CASE WHEN SP_VALUE_TO = -1 THEN 'UN LIMIT' ELSE
		CONVERT(VARCHAR,SP_VALUE_TO) END,
	BROK = 'BUY ' + CONVERT(VARCHAR,SP_BUY_BROK) + CASE WHEN SP_BUY_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END  +
		' SELL ' + CONVERT(VARCHAR,SP_SELL_BROK) + CASE WHEN SP_SELL_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END,

	SCRORD = CASE WHEN SP_SCRIP='ALL' THEN 1 ELSE 2 END,
	RCOUNT = 1
FROM SCHEME_MAPPING MP LEFT OUTER JOIN SCHEME_MASTER MS ON (SM_SCHEME_ID = SP_SCHEME_ID)
WHERE SP_PARTY_CODE = @PARTYCODE
AND GETDATE() BETWEEN SP_DATE_FROM AND SP_DATE_TO
ORDER BY 1,3,SCRORD

----------------------------------------------------------------------------------------------------------------------

SELECT 
	DP_DETAILS = 'PAY IN ACCOUNT',
	DEPOSITORY  = BANKTYPE,
	DP_ID =DPID,
	DP_NAME = BANKNAME,
	ACCOUNT_NO = CLTDPNO,
	POA_STATUS = CASE WHEN DEF = 1 THEN 'RECEIVED' ELSE 'NOT RECEIVED' END
FROM MULTICLTID M (NOLOCK),BANK B (NOLOCK)
WHERE  B.BANKID = M.DPID AND PARTY_CODE= @PARTYCODE AND M.DPTYPE = B.BANKTYPE

----------------------------------------------------------------------------------------------------------------------

SELECT 
	DP_DETAILS = 'PAY OUT ACCOUNT',
	DEPOSITORY  = BANKTYPE,
	DP_ID =B.BANKID,
	DP_NAME = BANKNAME,
	ACCOUNT_NO = CLTDPID
FROM CLIENT4 M (NOLOCK),BANK B (NOLOCK)
WHERE  B.BANKID = M.BANKID AND PARTY_CODE= @PARTYCODE AND  B.BANKTYPE = M.DEPOSITORY

----------------------------------------------------------------------------------------------------------------------

	CREATE TABLE  #MULTIBANKID
	(
		[CLTCODE] [VARCHAR](20),
		[BANKID] [VARCHAR](16),
		[ACCNO] [VARCHAR](20),
		[ACCTYPE] [VARCHAR](7)
	) 

	DECLARE @ACCOUNTDB VARCHAR(50)
	DECLARE @STRSQL VARCHAR(1000)
	
	SELECT TOP 1 @ACCOUNTDB= ACCOUNTDB FROM PRADNYA.DBO.MULTICOMPANY  WITH(NOLOCK)  WHERE SHAREDB = DB_NAME()
	
	SET @STRSQL = 'INSERT INTO #MULTIBANKID SELECT CLTCODE,BANKID,ACCNO,ACCTYPE FROM ' + @ACCOUNTDB + '.DBO.MULTIBANKID (NOLOCK) WHERE CLTCODE ='''+ @PARTYCODE +''''
	EXEC (@STRSQL)


	 SELECT 
	  BANK_DETAILS = 'BANK DETAILS',  
	  BANKNAME = ISNULL(P.BANK_NAME,''),      
	  BRANCH = ISNULL(P.BRANCH_NAME,''),      
	  ACNUM = ISNULL(C.ACCNO,''),      
	  ACTYPE = (CASE WHEN ISNULL(C.ACCTYPE,'')  = 'SAVING' OR ISNULL(C.ACCTYPE,'')  = 'SB' THEN 'SAVING'     
							   WHEN ISNULL(C.ACCTYPE,'')  = 'CURRENT' OR ISNULL(C.ACCTYPE,'')  = 'CA' THEN 'CURRENT'     
							   WHEN ISNULL(C.ACCTYPE,'')  = 'OD' THEN 'OVER DRAFT'     
							   ELSE 'OTHER'    
					  END)
	 FROM      
	  #MULTIBANKID C      
	   JOIN POBANK P (NOLOCK)      
	   ON (P.BANKID = C.BANKID)      
	 WHERE      
	  C.CLTCODE = @PARTYCODE    
	 ORDER BY       
	  BANKNAME 
	  
	  DROP TABLE #MULTIBANKID

/*--------------------------------------------------END OF THE PROC ---------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETDAILYNEW
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[CLS_PARTYDETDAILYNEW]    
 (    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @FPARTY VARCHAR(20),    
 @TPARTY VARCHAR(20),    
 @SAUDA VARCHAR(11),    
 @BRANCHCD VARCHAR(16) ='%',  
 @DIGIFLAG INT = 0  
 )    
   
 AS    
  
 IF @BRANCHCD ='' BEGIN SET @BRANCHCD ='%' END    
 IF @TPARTY ='' BEGIN SET @TPARTY ='ZZZZZZZZZZ' END 
 
 DECLARE @SAUDADATE VARCHAR(11)
 SET  @SAUDADATE=@SAUDA
 
IF LEN(@SAUDA) = 10 AND CHARINDEX('/',@SAUDA) > 0    
SET @SAUDA=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SAUDA,103),109)    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 
 SELECT     
      
  [CLIENT CODE]=C2.CL_CODE,  
  [CLIENT NAME]=C1.LONG_NAME, 
  [TRADE DATE] =  @SAUDADATE, 
  C2.EXCHANGE,    
  C2.TRAN_CAT,    
  C1.EMAIL,    
  C1.RES_PHONE1,    
  C1.SHORT_NAME,    
  C1.L_ADDRESS1,    
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_ZIP,    
  C1.FAMILY,    
  C1.BRANCH_CD,
  C2.PARTY_CODE,     
  TRADER = ISNULL(C1.TRADER,''),  
  C1.PAN_GIR_NO    
 FROM    
  CLIENT1 C1 (NOLOCK),    
  CLIENT2 C2 (NOLOCK),    
  (    
   SELECT    
    DISTINCT PARTY_CODE = FOPDD_PARTY_CODE FROM FO_POS_DETAILS_DAS (NOLOCK)    
   WHERE     
    FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
    AND ((FOPDD_OPENING_PQTY+FOPDD_TODAY_PQTY)-(FOPDD_OPENING_SQTY+FOPDD_TODAY_SQTY)) <> 0  
   
   UNION  
     
   SELECT    
    DISTINCT PARTY_CODE = FOTDD_PARTY_CODE FROM FO_TRADE_DETAILS_DAS  (NOLOCK)    
   WHERE     
    FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
  ) F,  
  CLIENT_PRINT_SETTINGS CP (NOLOCK)  
 WHERE    
  F.PARTY_CODE = C2.PARTY_CODE         
  AND C1.CL_CODE = C2.CL_CODE    
  AND C1.BRANCH_CD LIKE @BRANCHCD    
  AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY    
  AND C2.PRINTF = CP.PRINT_FLAG  
  AND CP.VALID_REPORT LIKE (CASE   
      WHEN @DIGIFLAG = 0 THEN '%'   
      WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
      WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
      ELSE CP.VALID_REPORT   
      END)  
  AND @STATUSNAME =(CASE     
            WHEN @STATUSID = 'BRANCH'     
            THEN C1.BRANCH_CD     
            WHEN @STATUSID = 'SUBBROKER'     
            THEN C1.SUB_BROKER     
            WHEN @STATUSID = 'TRADER'     
            THEN C1.TRADER     
            WHEN @STATUSID = 'FAMILY'     
            THEN C1.FAMILY     
            WHEN @STATUSID = 'AREA'     
            THEN C1.AREA     
            WHEN @STATUSID = 'REGION'     
            THEN C1.REGION     
            WHEN @STATUSID = 'CLIENT'     
            THEN C2.PARTY_CODE     
            ELSE 'BROKER'   
     END)  
 ORDER BY   
  C2.PARTY_CODE
   
   
  /*
 
 SELECT     
  DISTINCT  
  [CLIENT CODE] = FOTDD_PARTY_CODE,
  [CLIENT NAME] = '', 
  [TRADE DATE] = CONVERT(VARCHAR, FOTDD_SAUDA_DATE, 103),
  EXCHANGE = '',    
  TRAN_CAT = '',    
  EMAIL = '',    
  RES_PHONE1 = '',    
  SHORT_NAME = '',    
  L_ADDRESS1 = '',    
  L_ADDRESS2 = '',    
  L_ADDRESS3 = '',    
  L_CITY = '',    
  L_ZIP = '',    
  FAMILY = '',    
  BRANCH_CD = '',     
  TRADER = '',  
  PAN_GIR_NO = '',
  PARTY_CODE = FOTDD_PARTY_CODE      
 FROM    
  FO_TRADE_DETAILS_DAS (NOLOCK)  
 WHERE   
  FOTDD_SAUDA_DATE LIKE @SAUDA +'%'  
  AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 ORDER BY   
  FOTDD_PARTY_CODE  
  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETDAILYNEW_SUMMARY
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[CLS_PARTYDETDAILYNEW_SUMMARY]    
 (    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @FPARTY VARCHAR(20),    
 @TPARTY VARCHAR(20),    
 @SAUDA VARCHAR(11),    
 @BRANCHCD VARCHAR(16) ='%',  
 @DIGIFLAG INT = 0  
 )    
   
 AS    
  
 IF @BRANCHCD ='' BEGIN SET @BRANCHCD ='%' END    
 IF @TPARTY ='' BEGIN SET @TPARTY ='ZZZZZZZZZZ' END 
 
 DECLARE @SAUDADATE VARCHAR(11)
 SET  @SAUDADATE=@SAUDA
 
IF LEN(@SAUDA) = 10 AND CHARINDEX('/',@SAUDA) > 0    
SET @SAUDA=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SAUDA,103),109)    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 
 SELECT     
      
  [CLIENT CODE]=C2.CL_CODE,  
  [CLIENT NAME]=C1.LONG_NAME, 
  [TRADE DATE] =  @SAUDADATE 
 /* C2.EXCHANGE,    
  C2.TRAN_CAT,    
  C1.EMAIL,    
  C1.RES_PHONE1,    
  C1.SHORT_NAME,    
  C1.L_ADDRESS1,    
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_ZIP,    
  C1.FAMILY,    
  C1.BRANCH_CD,
  C2.PARTY_CODE,     
  TRADER = ISNULL(C1.TRADER,''),  
  C1.PAN_GIR_NO */   
 FROM    
  CLIENT1 C1 (NOLOCK),    
  CLIENT2 C2 (NOLOCK),    
  (    
   SELECT    
    DISTINCT PARTY_CODE = FOPDD_PARTY_CODE FROM FO_POS_DETAILS_DAS (NOLOCK)    
   WHERE     
    FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
    AND ((FOPDD_OPENING_PQTY+FOPDD_TODAY_PQTY)-(FOPDD_OPENING_SQTY+FOPDD_TODAY_SQTY)) <> 0  
   
   UNION  
     
   SELECT    
    DISTINCT PARTY_CODE = FOTDD_PARTY_CODE FROM FO_TRADE_DETAILS_DAS  (NOLOCK)    
   WHERE     
    FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
  ) F
  ,  CLIENT_PRINT_SETTINGS CP (NOLOCK)  
 WHERE    
  F.PARTY_CODE = C2.PARTY_CODE         
  AND C1.CL_CODE = C2.CL_CODE    
  AND C1.BRANCH_CD LIKE @BRANCHCD    
  AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY    
  AND C2.PRINTF = CP.PRINT_FLAG  
  AND CP.VALID_REPORT LIKE (CASE   
      WHEN @DIGIFLAG = 0 THEN '%'   
      WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
      WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
      ELSE CP.VALID_REPORT   
      END) 
  AND @STATUSNAME =(CASE     
            WHEN @STATUSID = 'BRANCH'     
            THEN C1.BRANCH_CD     
            WHEN @STATUSID = 'SUBBROKER'     
            THEN C1.SUB_BROKER     
            WHEN @STATUSID = 'TRADER'     
            THEN C1.TRADER     
            WHEN @STATUSID = 'FAMILY'     
            THEN C1.FAMILY     
            WHEN @STATUSID = 'AREA'     
            THEN C1.AREA     
            WHEN @STATUSID = 'REGION'     
            THEN C1.REGION     
            WHEN @STATUSID = 'CLIENT'     
            THEN C2.PARTY_CODE     
            ELSE 'BROKER'   
     END)  
 ORDER BY   
  C2.PARTY_CODE
   
   
  
 /*
 SELECT     
  DISTINCT  
  [CLIENT CODE] = FOTDD_PARTY_CODE,
  [CLIENT NAME] = '', 
  [TRADE DATE] = @SAUDADATE 
  /*,
  EXCHANGE = '',    
  TRAN_CAT = '',    
  EMAIL = '',    
  RES_PHONE1 = '',    
  SHORT_NAME = '',    
  L_ADDRESS1 = '',    
  L_ADDRESS2 = '',    
  L_ADDRESS3 = '',    
  L_CITY = '',    
  L_ZIP = '',    
  FAMILY = '',    
  BRANCH_CD = '',     
  TRADER = '',  
  PAN_GIR_NO = '',
  PARTY_CODE = FOTDD_PARTY_CODE*/      
 FROM    
  FO_TRADE_DETAILS_DAS (NOLOCK)  
 WHERE   
  FOTDD_SAUDA_DATE LIKE @SAUDA +'%'  
  AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 ORDER BY   
  FOTDD_PARTY_CODE 
  */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_IMPORT_CLOSING_FILE
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_PR_IMPORT_CLOSING_FILE] 
(
	@SESSIONID VARCHAR(30),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS

TRUNCATE TABLE BFOCLOSING_IMP


CREATE TABLE [dbo].[#BFOCLOSING_IMP]
(
	[TRADE_DATE] [datetime] ,
	[SESSION_ID] [numeric](10, 0) ,
	[SERIES_ID] [numeric](10, 0) ,
	[SERIES_CODE] [varchar](22) ,
	[PRODUCT_TYPE] [varchar](3) ,
	[PRODUCT_CODE] [varchar](7) ,
	[ASSET_CODE] [varchar](8) ,
	[EXPIRYDATE] [datetime] ,
	[STRIKE_PRICE] [numeric](11, 4) ,
	[OPTION_TYPE] [varchar](2) ,
	[PRV_CLOSE_PRICE] [varchar](20) ,
	[OPEN_PRICE] [varchar](20) ,
	[HIGH_PRICE] [varchar](20) ,
	[LOW_PRICE] [varchar](20) ,
	[CLOSE_PRICE] [varchar](22) ,
	[TOTAL_TRADED_QTY] [varchar](20) ,
	[TOTAL_TRADED_VALUE] [varchar](20) ,
	[AVRG_TRADED_PRICE] [varchar](20) ,
	[NO_OF_TRADES] [varchar](20) ,
	[WEEK_HIGH] [varchar](20) ,
	[WEEK_LOW] [varchar](20) ,
	[OPEN_INTEREST] [varchar](20)
) 
		
IF @INTMODE=1
BEGIN

		INSERT INTO #BFOCLOSING_IMP
		SELECT
			TRADE_DATE = DBO.PIECE(FILE_DATA,',',1),
			SESSION_ID = DBO.PIECE(FILE_DATA,',',2),
			SERIES_ID = DBO.PIECE(FILE_DATA,',',3),
			SERIES_CODE = DBO.PIECE(FILE_DATA,',',4),
			PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',5),
			PRODUCT_CODE = DBO.PIECE(FILE_DATA,',',6),
			ASSET_CODE = DBO.PIECE(FILE_DATA,',',7),
			EXPIRYDATE = DBO.PIECE(FILE_DATA,',',8),
			STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',9),
			OPTION_TYPE = DBO.PIECE(FILE_DATA,',',10),
			PRV_CLOSE_PRICE = DBO.PIECE(FILE_DATA,',',11),
			OPEN_PRICE = DBO.PIECE(FILE_DATA,',',12),
			HIGH_PRICE = DBO.PIECE(FILE_DATA,',',13),
			LOW_PRICE = DBO.PIECE(FILE_DATA,',',14),
			CLOSE_PRICE = DBO.PIECE(FILE_DATA,',',15),
			TOTAL_TRADED_QTY = DBO.PIECE(FILE_DATA,',',16),
			TOTAL_TRADED_VALUE = DBO.PIECE(FILE_DATA,',',17),
			AVRG_TRADED_PRICE = DBO.PIECE(FILE_DATA,',',18),
			NO_OF_TRADES = DBO.PIECE(FILE_DATA,',',19),
			WEEK_HIGH = DBO.PIECE(FILE_DATA,',',20),
			WEEK_LOW = DBO.PIECE(FILE_DATA,',',21),
			OPEN_INTEREST = DBO.PIECE(FILE_DATA,',',22)
						
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID	
END
ELSE
BEGIN
	INSERT INTO #BFOCLOSING_IMP
		SELECT
			TRADE_DATE = DBO.PIECE(FILEDATA,',',1),
			SESSION_ID = DBO.PIECE(FILEDATA,',',2),
			SERIES_ID = DBO.PIECE(FILEDATA,',',3),
			SERIES_CODE = DBO.PIECE(FILEDATA,',',4),
			PRODUCT_TYPE = DBO.PIECE(FILEDATA,',',5),
			PRODUCT_CODE = DBO.PIECE(FILEDATA,',',6),
			ASSET_CODE = DBO.PIECE(FILEDATA,',',7),
			EXPIRYDATE = DBO.PIECE(FILEDATA,',',8),
			STRIKE_PRICE = DBO.PIECE(FILEDATA,',',9),
			OPTION_TYPE = DBO.PIECE(FILEDATA,',',10),
			PRV_CLOSE_PRICE = DBO.PIECE(FILEDATA,',',11),
			OPEN_PRICE = DBO.PIECE(FILEDATA,',',12),
			HIGH_PRICE = DBO.PIECE(FILEDATA,',',13),
			LOW_PRICE = DBO.PIECE(FILEDATA,',',14),
			CLOSE_PRICE = DBO.PIECE(FILEDATA,',',15),
			TOTAL_TRADED_QTY = DBO.PIECE(FILEDATA,',',16),
			TOTAL_TRADED_VALUE = DBO.PIECE(FILEDATA,',',17),
			AVRG_TRADED_PRICE = DBO.PIECE(FILEDATA,',',18),
			NO_OF_TRADES = DBO.PIECE(FILEDATA,',',19),
			WEEK_HIGH = DBO.PIECE(FILEDATA,',',20),
			WEEK_LOW = DBO.PIECE(FILEDATA,',',21),
			OPEN_INTEREST = DBO.PIECE(FILEDATA,',',22)
	FROM CLASSFILEUPD_BULK
	WHERE
		SPID= @SESSIONID
		AND DBO.PIECE(FILEDATA,',',3) <> ''

END


UPDATE #BFOCLOSING_IMP SET PRV_CLOSE_PRICE =0 WHERE PRV_CLOSE_PRICE = '.-1'
UPDATE #BFOCLOSING_IMP SET OPEN_PRICE =0 WHERE OPEN_PRICE = '.-1'
UPDATE #BFOCLOSING_IMP SET CLOSE_PRICE =0 WHERE CLOSE_PRICE = '.-1'
UPDATE #BFOCLOSING_IMP	SET PRV_CLOSE_PRICE =0 WHERE ISNULL(PRV_CLOSE_PRICE,'') = '' 
UPDATE #BFOCLOSING_IMP	SET OPEN_PRICE =0 WHERE ISNULL(OPEN_PRICE,'') = '' 
UPDATE #BFOCLOSING_IMP	SET HIGH_PRICE =0 WHERE ISNULL(HIGH_PRICE,'') = '' 
UPDATE #BFOCLOSING_IMP	SET LOW_PRICE =0 WHERE ISNULL(LOW_PRICE,'') = '' 
UPDATE #BFOCLOSING_IMP	SET CLOSE_PRICE =0 WHERE ISNULL(CLOSE_PRICE,'') = '' 
UPDATE #BFOCLOSING_IMP	SET TOTAL_TRADED_QTY =0 WHERE ISNULL(TOTAL_TRADED_QTY,'') = '' 
UPDATE #BFOCLOSING_IMP	SET TOTAL_TRADED_VALUE =0 WHERE ISNULL(TOTAL_TRADED_VALUE,'') = '' 
UPDATE #BFOCLOSING_IMP	SET AVRG_TRADED_PRICE =0 WHERE ISNULL(AVRG_TRADED_PRICE,'') = '' 
UPDATE #BFOCLOSING_IMP	SET NO_OF_TRADES =0 WHERE ISNULL(NO_OF_TRADES,'') = '' 
UPDATE #BFOCLOSING_IMP	SET WEEK_HIGH =0 WHERE ISNULL(WEEK_HIGH,'') = ''
UPDATE #BFOCLOSING_IMP	SET WEEK_LOW =0 WHERE ISNULL(WEEK_LOW,'') = ''
UPDATE #BFOCLOSING_IMP	SET OPEN_INTEREST =0 WHERE ISNULL(OPEN_INTEREST,'') = ''
	
	
INSERT INTO BFOCLOSING_IMP
SELECT TRADE_DATE,SESSION_ID,SERIES_ID,SERIES_CODE,PRODUCT_TYPE,PRODUCT_CODE,
ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
PRV_CLOSE_PRICE,OPEN_PRICE,HIGH_PRICE,LOW_PRICE,CLOSE_PRICE,
TOTAL_TRADED_QTY,TOTAL_TRADED_VALUE,AVRG_TRADED_PRICE,
NO_OF_TRADES,WEEK_HIGH,WEEK_LOW,OPEN_INTEREST
FROM #BFOCLOSING_IMP

DROP TABLE #BFOCLOSING_IMP

UPDATE BFOCLOSING_IMP SET PRV_CLOSE_PRICE  = 0 WHERE ISNULL(PRV_CLOSE_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET OPEN_PRICE  = 0 WHERE ISNULL(OPEN_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET HIGH_PRICE  = 0 WHERE ISNULL(HIGH_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET LOW_PRICE  = 0 WHERE  ISNULL(LOW_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET TOTAL_TRADED_QTY  = 0 WHERE ISNULL(TOTAL_TRADED_QTY,'') = ''
UPDATE BFOCLOSING_IMP SET TOTAL_TRADED_VALUE  = 0 WHERE ISNULL(TOTAL_TRADED_VALUE,'') = ''
UPDATE BFOCLOSING_IMP SET AVRG_TRADED_PRICE  = 0 WHERE ISNULL(AVRG_TRADED_PRICE,'') = ''
UPDATE BFOCLOSING_IMP SET NO_OF_TRADES  = 0 WHERE  ISNULL(NO_OF_TRADES,'') = ''
UPDATE BFOCLOSING_IMP SET WEEK_HIGH  = 0 WHERE ISNULL(WEEK_HIGH,'') = ''
UPDATE BFOCLOSING_IMP SET WEEK_LOW  = 0 WHERE ISNULL(WEEK_LOW,'') = ''


DELETE BFOCLOSING FROM
	BFOCLOSING (NOLOCK), BFOCLOSING_IMP 
WHERE
	BFOCLOSING.TRADE_DATE = BFOCLOSING_IMP.TRADE_DATE
	AND BFOCLOSING.SERIES_CODE = BFOCLOSING_IMP.SERIES_CODE

UPDATE BFOCLOSING_IMP SET EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59'
	
INSERT INTO BFOCLOSING
SELECT *,@UNAME,GETDATE()
FROM BFOCLOSING_IMP

TRUNCATE TABLE BFOCLOSING_IMP

/*-------------------------------------------- END OF THE PROC ----------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_IMPORT_CONTRACT_FILE
-- --------------------------------------------------

CREATE PROC [DBO].[CLS_PR_IMPORT_CONTRACT_FILE] 
(
	@SESSIONID VARCHAR(30),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT ,
	@INTFILETYPE INT
) AS

/*
	@INTFILETYPE = 0 : CONTRACT MASTER	CO<ddmmyy>.csv
	@INTFILETYPE = 1 : NEW CONTRACT MASTER EQD_CO<ddmmyy>.csv
	
*/
        
TRUNCATE TABLE BFOSCRIP2_IMP

IF @INTMODE=1        
BEGIN
	

	IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
	BEGIN
		 INSERT INTO BFOSCRIP2_IMP
		 (
		  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
		  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
		  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
		 )

		 SELECT
			SERIES_ID			= DBO.PIECE(FILE_DATA,',',	1),
			PRODUCT_TYPE		= DBO.PIECE(FILE_DATA,',',	2),
			PRODUCT_CODE		= DBO.PIECE(FILE_DATA,',',	3),
			ASSET_CODE			= DBO.PIECE(FILE_DATA,',',	4),
			EXPIRYDATE			= CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',5))),
			STRIKE_PRICE		= DBO.PIECE(FILE_DATA,',',	6),
			OPTION_TYPE			= DBO.PIECE(FILE_DATA,',',	7),
			SERIES_CODE			= DBO.PIECE(FILE_DATA,',',	8),
			UNDERLYING_ASSET	= DBO.PIECE(FILE_DATA,',',	9),
			CA_LEVEL			= 0,
			BASE_PRICE			= 0, --DBO.PIECE(FILE_DATA,',',	11),
			STARTDATE			= CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',12))),
			MATURITYDATE		= CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',13))),
			EXERCISE_STARTDATE	= CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',14))),
			EXERCISE_ENDDATE	= CONVERT(DATETIME,(DBO.PIECE(FILE_DATA,',',15))),
			MINIMUM_LOT_SIZE	= DBO.PIECE(FILE_DATA,',',	16),
			LOT_SIZE_MULTIPLE	= DBO.PIECE(FILE_DATA,',',	17),
			PRICE_TICK			= DBO.PIECE(FILE_DATA,',',	18),
			MARGIN_INDICATOR	= 0	,
			INITAIL_MARGIN_PERC	= 0 ,	
			STATUS_FLAG			= DBO.PIECE(FILE_DATA,',',	21),
			ISIN				= DBO.PIECE(FILE_DATA,',',	22)
			    
		FROM CLASSFILEUPD  (NOLOCK)
		WHERE
		SESSION_ID= @SESSIONID			
	END
	ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
	BEGIN
		 INSERT INTO BFOSCRIP2_IMP
		 (
		  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
		  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
		  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
		 )

		 SELECT
			SERIES_ID			= DBO.PIECE(FILE_DATA,',',	1),
			PRODUCT_TYPE		= DBO.PIECE(FILE_DATA,',',	3),
			PRODUCT_CODE		= DBO.PIECE(FILE_DATA,',',	66),
			ASSET_CODE			= DBO.PIECE(FILE_DATA,',',	4),
			EXPIRYDATE			= DBO.PIECE(FILE_DATA,',',	7),
			STRIKE_PRICE		= DBO.PIECE(FILE_DATA,',',	8),
			OPTION_TYPE			= DBO.PIECE(FILE_DATA,',',	9),
			SERIES_CODE			= DBO.PIECE(FILE_DATA,',',	53),
			UNDERLYING_ASSET	= DBO.PIECE(FILE_DATA,',',	5),
			CA_LEVEL			= 0,
			BASE_PRICE			= 0, --DBO.PIECE(FILE_DATA,',',	68),
			STARTDATE			= DBO.PIECE(FILE_DATA,',',	27),
			MATURITYDATE		= DBO.PIECE(FILE_DATA,',',	28),
			EXERCISE_STARTDATE	= DBO.PIECE(FILE_DATA,',',	49),
			EXERCISE_ENDDATE	= DBO.PIECE(FILE_DATA,',',	50),
			MINIMUM_LOT_SIZE	= DBO.PIECE(FILE_DATA,',',	31),
			LOT_SIZE_MULTIPLE	= DBO.PIECE(FILE_DATA,',',	32),
			PRICE_TICK			= DBO.PIECE(FILE_DATA,',',	33),
			MARGIN_INDICATOR	= 0,	
			INITAIL_MARGIN_PERC	= 0,
			STATUS_FLAG			= DBO.PIECE(FILE_DATA,',',	69),
			ISIN				= ''  
		FROM CLASSFILEUPD  (NOLOCK)
		WHERE
		SESSION_ID= @SESSIONID
		AND ISNULL(DBO.PIECE(FILE_DATA,',',	3),'') <> ''
		
		UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
	END

END
ELSE				-- BULK IMPORTS
BEGIN
	IF @INTFILETYPE = 0  -- CONTRACT MASTER CO<DDMMYYYY>
	BEGIN
		 INSERT INTO BFOSCRIP2_IMP
		 (
		  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
		  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
		  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
		 )

		 SELECT
			SERIES_ID			= DBO.PIECE(FILEDATA,',',	1),
			PRODUCT_TYPE		= DBO.PIECE(FILEDATA,',',	2),
			PRODUCT_CODE		= DBO.PIECE(FILEDATA,',',	3),
			ASSET_CODE			= DBO.PIECE(FILEDATA,',',	4),
			EXPIRYDATE			= CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',5))),
			STRIKE_PRICE		= DBO.PIECE(FILEDATA,',',	6),
			OPTION_TYPE			= DBO.PIECE(FILEDATA,',',	7),
			SERIES_CODE			= DBO.PIECE(FILEDATA,',',	8),
			UNDERLYING_ASSET	= DBO.PIECE(FILEDATA,',',	9),
			CA_LEVEL			= 0,
			BASE_PRICE			= 0, --DBO.PIECE(FILEDATA,',',	11),
			STARTDATE			= CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',12))),
			MATURITYDATE		= CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',13))),
			EXERCISE_STARTDATE	= CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',14))),
			EXERCISE_ENDDATE	= CONVERT(DATETIME,(DBO.PIECE(FILEDATA,',',15))),
			MINIMUM_LOT_SIZE	= DBO.PIECE(FILEDATA,',',	16),
			LOT_SIZE_MULTIPLE	= DBO.PIECE(FILEDATA,',',	17),
			PRICE_TICK			= DBO.PIECE(FILEDATA,',',	18),
			MARGIN_INDICATOR	= 0	,
			INITAIL_MARGIN_PERC	= 0 ,	
			STATUS_FLAG			= DBO.PIECE(FILEDATA,',',	21),
			ISIN				= DBO.PIECE(FILEDATA,',',	22)
			    
		FROM CLASSFILEUPD_BULK  (NOLOCK)
		WHERE
		SPID= @SESSIONID 
	END
	ELSE IF @INTFILETYPE = 1  -- NEW CONTRACT MASTER EQD_CO<DDMMYYYY>
	BEGIN
		 INSERT INTO BFOSCRIP2_IMP
		 (
		  SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,UNDERLYING_ASSET,
		  CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,
		  PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN
		 )

		 SELECT
			SERIES_ID			= DBO.PIECE(FILEDATA,',',	1),
			PRODUCT_TYPE		= DBO.PIECE(FILEDATA,',',	3),
			PRODUCT_CODE		= DBO.PIECE(FILEDATA,',',	66),
			ASSET_CODE			= DBO.PIECE(FILEDATA,',',	4),
			EXPIRYDATE			= DBO.PIECE(FILEDATA,',',	7),
			STRIKE_PRICE		= DBO.PIECE(FILEDATA,',',	8),
			OPTION_TYPE			= DBO.PIECE(FILEDATA,',',	9),
			SERIES_CODE			= DBO.PIECE(FILEDATA,',',	53),
			UNDERLYING_ASSET	= DBO.PIECE(FILEDATA,',',	5),
			CA_LEVEL			= 0,
			BASE_PRICE			= 0, --DBO.PIECE(FILEDATA,',',	68),
			STARTDATE			= DBO.PIECE(FILEDATA,',',	27),
			MATURITYDATE		= DBO.PIECE(FILEDATA,',',	28),
			EXERCISE_STARTDATE	= DBO.PIECE(FILEDATA,',',	49),
			EXERCISE_ENDDATE	= DBO.PIECE(FILEDATA,',',	50),
			MINIMUM_LOT_SIZE	= DBO.PIECE(FILEDATA,',',	31),
			LOT_SIZE_MULTIPLE	= DBO.PIECE(FILEDATA,',',	32),
			PRICE_TICK			= DBO.PIECE(FILEDATA,',',	33),
			MARGIN_INDICATOR	= 0,	
			INITAIL_MARGIN_PERC	= 0,
			STATUS_FLAG			= DBO.PIECE(FILEDATA,',',	69),
			ISIN				= ''  
		FROM CLASSFILEUPD_BULK  (NOLOCK)
		WHERE
		SPID= @SESSIONID 
		AND ISNULL(DBO.PIECE(FILEDATA,',',	3),'') <> ''
		
		UPDATE BFOSCRIP2_IMP SET STRIKE_PRICE = STRIKE_PRICE / 100
	END

END
        
UPDATE BFOSCRIP2_IMP SET EXPIRYDATE = MATURITYDATE WHERE EXPIRYDATE ='' OR EXPIRYDATE IS NULL        
        
UPDATE BFOSCRIP2_IMP SET         
ISIN=ISNULL(ISIN,''),        
BASE_PRICE=ISNULL(BASE_PRICE,0)        
    
DELETE BFOSCRIP2 FROM        
BFOSCRIP2, BFOSCRIP2_IMP         
WHERE        
BFOSCRIP2.SERIES_ID = BFOSCRIP2_IMP.SERIES_ID        
AND LEFT(BFOSCRIP2.EXPIRYDATE,11)  =  LEFT(BFOSCRIP2_IMP.EXPIRYDATE,11)        
     
INSERT INTO BFOSCRIP2 (SERIES_ID,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
SERIES_CODE,UNDERLYING_ASSET,CA_LEVEL,BASE_PRICE,STARTDATE,MATURITYDATE,EXERCISE_STARTDATE,EXERCISE_ENDDATE,
MINIMUM_LOT_SIZE,LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,TRADE_DATE,UPDATED_BY,UPDATED_ON)      
SELECT         
	SERIES_ID,PRODUCT_TYPE,REPLACE(PRODUCT_CODE,' ',''),REPLACE(ASSET_CODE,' ',''),    
	EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',    
	STRIKE_PRICE,ISNULL(OPTION_TYPE,''),REPLACE(SERIES_CODE,' ',''),REPLACE(UNDERLYING_ASSET,' ',''),    
	CA_LEVEL,BASE_PRICE,STARTDATE,    
	MATURITYDATE = LEFT(MATURITYDATE,11) + ' 23:59',    
	EXERCISE_STARTDATE,EXERCISE_ENDDATE,MINIMUM_LOT_SIZE,    
	LOT_SIZE_MULTIPLE,PRICE_TICK,MARGIN_INDICATOR,    
	INITAIL_MARGIN_PERC,STATUS_FLAG,ISIN,@SAUDA_DATE,@UNAME,GETDATE()    
FROM BFOSCRIP2_IMP    
	    

/*------------------------------------------------------ END OF THE PROC -------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_IMPORT_CORPACTFILE_FILE
-- --------------------------------------------------

CREATE PROC [DBO].[CLS_PR_IMPORT_CORPACTFILE_FILE]   
(  
 @SESSIONID VARCHAR(30),  
 @UNAME VARCHAR(20),  
 @SAUDA_DATE VARCHAR(11),  
 @INTMODE INT   ,
 @STRFILETYPE VARCHAR(20)
) AS  

/*
	CORPACT_1  - EXISTING POSITIONS
	CORPACT_2	- ADJUSTED POSITIONS
*/

IF @INTMODE=1  
BEGIN  
	SELECT TOP 1 @SAUDA_DATE = DBO.PIECE(FILE_DATA,',',1)
	FROM CLASSFILEUPD  
	WHERE SESSION_ID= @SESSIONID  
END
ELSE
BEGIN  
	SELECT TOP 1 @SAUDA_DATE = DBO.PIECE(FILEDATA,',',1)
	FROM CLASSFILEUPD_BULK  
	WHERE SPID= @SESSIONID  
END

  
IF @STRFILETYPE = 'CORPACT_1'
BEGIN
	DELETE FOCORPACTPOSITION_IMP  
	WHERE TRADE_DATE = @SAUDA_DATE
	AND DUMMY1 = 'E'
END
ELSE
BEGIN
	DELETE FOCORPACTPOSITION_IMP  
	WHERE TRADE_DATE = @SAUDA_DATE
	AND DUMMY1 = 'A'
END

 
  
IF @INTMODE=1  
BEGIN  
  
 INSERT INTO FOCORPACTPOSITION_IMP  
 SELECT  
		TRADE_DATE = DBO.PIECE(FILE_DATA,',',1),
		SEGMENT = DBO.PIECE(FILE_DATA,',',2),
		SETT_TYPE = DBO.PIECE(FILE_DATA,',',3),
		CM_CODE = DBO.PIECE(FILE_DATA,',',4),
		MEMBER_TYPE = DBO.PIECE(FILE_DATA,',',5),
		TM_CODE = DBO.PIECE(FILE_DATA,',',6),
		CL_TYPE = DBO.PIECE(FILE_DATA,',',7),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',8),
		PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',9),
		PRODUCT_CODE = DBO.PIECE(FILE_DATA,',',10),
		ASSET_CODE = DBO.PIECE(FILE_DATA,',',11),
		EXPIRYDATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',12)),11) + ' 23:59',
		STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',13),
		OPTION_TYPE = DBO.PIECE(FILE_DATA,',',14),
		SERIES_CODE = DBO.PIECE(FILE_DATA,',',15),
		SERIES_ID = DBO.PIECE(FILE_DATA,',',16),
		BF_LNG_QTY = DBO.PIECE(FILE_DATA,',',17),
		BF_LNG_VAL = DBO.PIECE(FILE_DATA,',',18),
		BF_SHORT_QTY = DBO.PIECE(FILE_DATA,',',19),
		BF_SHORT_VAL = DBO.PIECE(FILE_DATA,',',20),
		BUY_OPEN_QTY = DBO.PIECE(FILE_DATA,',',21),
		BUY_OPEN_VAL = DBO.PIECE(FILE_DATA,',',22),
		SELL_OPEN_QTY = DBO.PIECE(FILE_DATA,',',23),
		SELL_OPEN_VAL = DBO.PIECE(FILE_DATA,',',24),
		DUMMY1 = CASE WHEN @STRFILETYPE = 'CORPACT_1' THEN 'E' ELSE 'A' END,
		DUMMY2 = DBO.PIECE(FILE_DATA,',',26)
	FROM CLASSFILEUPD  
	WHERE  
	SESSION_ID= @SESSIONID  
END  
ELSE  
BEGIN  
  
 INSERT INTO FOCORPACTPOSITION_IMP  
 SELECT    
		TRADE_DATE = DBO.PIECE(FILEDATA,',',1),
		SEGMENT = DBO.PIECE(FILEDATA,',',2),
		SETT_TYPE = DBO.PIECE(FILEDATA,',',3),
		CM_CODE = DBO.PIECE(FILEDATA,',',4),
		MEMBER_TYPE = DBO.PIECE(FILEDATA,',',5),
		TM_CODE = DBO.PIECE(FILEDATA,',',6),
		CL_TYPE = DBO.PIECE(FILEDATA,',',7),
		PARTY_CODE = DBO.PIECE(FILEDATA,',',8),
		PRODUCT_TYPE = DBO.PIECE(FILEDATA,',',9),
		PRODUCT_CODE = DBO.PIECE(FILEDATA,',',10),
		ASSET_CODE = DBO.PIECE(FILEDATA,',',11),
		EXPIRYDATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',12)),11) + ' 23:59',
		STRIKE_PRICE = DBO.PIECE(FILEDATA,',',13),
		OPTION_TYPE = DBO.PIECE(FILEDATA,',',14),
		SERIES_CODE = DBO.PIECE(FILEDATA,',',15),
		SERIES_ID = DBO.PIECE(FILEDATA,',',16),
		BF_LNG_QTY = DBO.PIECE(FILEDATA,',',17),
		BF_LNG_VAL = DBO.PIECE(FILEDATA,',',18),
		BF_SHORT_QTY = DBO.PIECE(FILEDATA,',',19),
		BF_SHORT_VAL = DBO.PIECE(FILEDATA,',',20),
		BUY_OPEN_QTY = DBO.PIECE(FILEDATA,',',21),
		BUY_OPEN_VAL = DBO.PIECE(FILEDATA,',',22),
		SELL_OPEN_QTY = DBO.PIECE(FILEDATA,',',23),
		SELL_OPEN_VAL = DBO.PIECE(FILEDATA,',',24),
		DUMMY1 = CASE WHEN @STRFILETYPE = 'CORPACT_1' THEN 'E' ELSE 'A' END,
		DUMMY2 = DBO.PIECE(FILEDATA,',',26)
	FROM CLASSFILEUPD_BULK  
	WHERE  
	SPID= @SESSIONID  
END  
  

/*------------------------------------------------ END OF THE PROC ----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_IMPORT_MARGIN_FILE
-- --------------------------------------------------

CREATE PROC [dbo].[CLS_PR_IMPORT_MARGIN_FILE] 
(
	@SESSIONID VARCHAR(30),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS


TRUNCATE TABLE BFOMARGIN_IMP

IF @INTMODE=1
BEGIN
		INSERT INTO BFOMARGIN_IMP
		SELECT
			MARGIN_DATE = DBO.PIECE(FILE_DATA,',',1),
			PARTY_CODE = DBO.PIECE(FILE_DATA,',',2),
			SPAN_MARGIN = DBO.PIECE(FILE_DATA,',',3),
			EXTREME_LOSS_MARGIN = DBO.PIECE(FILE_DATA,',',4),
			NET_PREMIUM = DBO.PIECE(FILE_DATA,',',5),
			DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',6),
			FINAL_SETTLEMENT_MARGIN = DBO.PIECE(FILE_DATA,',',7),
			TOTAL_MARGIN = DBO.PIECE(FILE_DATA,',',8),
			ACCOUNT_TYPE = DBO.PIECE(FILE_DATA,',',9)
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID
END
ELSE
BEGIN

		INSERT INTO BFOMARGIN_IMP
		SELECT
			MARGIN_DATE = DBO.PIECE(FILEDATA,',',1),
			PARTY_CODE = DBO.PIECE(FILEDATA,',',2),
			SPAN_MARGIN = DBO.PIECE(FILEDATA,',',3),
			EXTREME_LOSS_MARGIN = DBO.PIECE(FILEDATA,',',4),
			NET_PREMIUM = DBO.PIECE(FILEDATA,',',5),
			DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILEDATA,',',6),
			FINAL_SETTLEMENT_MARGIN = DBO.PIECE(FILEDATA,',',7),
			TOTAL_MARGIN = DBO.PIECE(FILEDATA,',',8),
			ACCOUNT_TYPE = DBO.PIECE(FILEDATA,',',9)
		FROM CLASSFILEUPD_BULK
		WHERE
			SPID= @SESSIONID	

END

UPDATE BFOMARGIN_IMP SET PARTY_CODE = A.NEWPARTY_CODE FROM  PARTYMAPPING  A WHERE A.OLDPARTY_CODE = BFOMARGIN_IMP.PARTY_CODE
UPDATE BFOMARGIN_IMP SET PARTY_CODE = MEMBERCODE FROM BFOOWNER WHERE PARTY_CODE ='OWN'

IF (SELECT UPPER(MEMBERTYPE) FROM FOOWNER) ='CM'
BEGIN
	UPDATE BFOMARGIN_IMP SET PARTY_CODE = CLIENT2.PARTY_CODE
	FROM CLIENT2 WHERE CLIENT2.BANKID = BFOMARGIN_IMP.PARTY_CODE
	AND CLIENT2.BANKID <> ''

	UPDATE BFOMARGIN_IMP SET PARTY_CODE = FOTMINFO.PARTY_CODE
	FROM FOTMINFO WHERE FOTMINFO.TM_CODE = BFOMARGIN_IMP.PARTY_CODE
END



DELETE BFOMARGIN
WHERE MARGIN_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'



INSERT INTO BFOMARGIN
SELECT *,@UNAME,GETDATE()
FROM BFOMARGIN_IMP

TRUNCATE TABLE BFOMARGIN_IMP


/*----------------------------------- END OF THE PROC ------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_IMPORT_POSITION_FILE
-- --------------------------------------------------

CREATE PROC [DBO].[CLS_PR_IMPORT_POSITION_FILE]   
(  
 @SESSIONID VARCHAR(30),  
 @UNAME VARCHAR(20),  
 @SAUDA_DATE VARCHAR(11),  
 @INTMODE INT   
) AS  
  
  
DECLARE @TRADE_DATE DATETIME

TRUNCATE TABLE BFOEXERCISEALLOCATION_IMP

IF @INTMODE=1
BEGIN

	INSERT INTO BFOEXERCISEALLOCATION_IMP
	SELECT
		POSITION_DATE = DBO.PIECE(FILE_DATA,',',1),
		SEGMENT = DBO.PIECE(FILE_DATA,',',2),
		SETT_TYPE = DBO.PIECE(FILE_DATA,',',3),
		CM_CODE = DBO.PIECE(FILE_DATA,',',4),
		MEMBER_TYPE = DBO.PIECE(FILE_DATA,',',5),
		TM_CODE = DBO.PIECE(FILE_DATA,',',6),
		ACCOUNT_TYPE = DBO.PIECE(FILE_DATA,',',7),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',8),
		PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',9),
		PRODUCT_CODE = DBO.PIECE(FILE_DATA,',',10),
		ASSET_CODE = DBO.PIECE(FILE_DATA,',',11),
		EXPIRYDATE = DBO.PIECE(FILE_DATA,',',12),
		STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',13),
		OPTION_TYPE = DBO.PIECE(FILE_DATA,',',14),
		SERIES_CODE = DBO.PIECE(FILE_DATA,',',15),
		CA_LEVEL = DBO.PIECE(FILE_DATA,',',16),
		BF_LONG_QTY = DBO.PIECE(FILE_DATA,',',17),
		BF_LONG_VALUE = DBO.PIECE(FILE_DATA,',',18),
		BF_SHORT_QTY = DBO.PIECE(FILE_DATA,',',19),
		BF_SHORT_VALUE = DBO.PIECE(FILE_DATA,',',20),
		DAY_BUY_QTY = DBO.PIECE(FILE_DATA,',',21),
		DAY_BUY_VALUE = DBO.PIECE(FILE_DATA,',',22),
		DAY_SELL_QTY = DBO.PIECE(FILE_DATA,',',23),
		DAY_SELL_VALUE = DBO.PIECE(FILE_DATA,',',24),
		PRE_LONG_QTY = DBO.PIECE(FILE_DATA,',',25),
		PRE_LONG_VALUE = DBO.PIECE(FILE_DATA,',',26),
		PRE_SHORT_QTY = DBO.PIECE(FILE_DATA,',',27),
		PRE_SHORT_VALUE = DBO.PIECE(FILE_DATA,',',28),
		EXERCISED_QTY = DBO.PIECE(FILE_DATA,',',29),
		ASSIGNED_QTY = DBO.PIECE(FILE_DATA,',',30),
		POST_LONG_QTY = DBO.PIECE(FILE_DATA,',',31),
		POST_LONG_VALUE = DBO.PIECE(FILE_DATA,',',32),
		POST_SHORT_QTY = DBO.PIECE(FILE_DATA,',',33),
		POST_SHORT_VALUE = DBO.PIECE(FILE_DATA,',',34),
		SETTLEMENT_PRICE = CASE WHEN DBO.PIECE(FILE_DATA,',',35) ='' THEN 0 ELSE DBO.PIECE(FILE_DATA,',',35) END,
		NET_PREMIUM = DBO.PIECE(FILE_DATA,',',36),
		DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',37),
		FINAL_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',38),
		EXERCISED_ASSIGNED_VALUE = DBO.PIECE(FILE_DATA,',',39)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID
		AND LEN(FILE_DATA) > 100
END
ELSE
BEGIN

	INSERT INTO BFOEXERCISEALLOCATION_IMP
	SELECT
		POSITION_DATE = DBO.PIECE(FILEDATA,',',1),
		SEGMENT = DBO.PIECE(FILEDATA,',',2),
		SETT_TYPE = DBO.PIECE(FILEDATA,',',3),
		CM_CODE = DBO.PIECE(FILEDATA,',',4),
		MEMBER_TYPE = DBO.PIECE(FILEDATA,',',5),
		TM_CODE = DBO.PIECE(FILEDATA,',',6),
		ACCOUNT_TYPE = DBO.PIECE(FILEDATA,',',7),
		PARTY_CODE = DBO.PIECE(FILEDATA,',',8),
		PRODUCT_TYPE = DBO.PIECE(FILEDATA,',',9),
		PRODUCT_CODE = DBO.PIECE(FILEDATA,',',10),
		ASSET_CODE = DBO.PIECE(FILEDATA,',',11),
		EXPIRYDATE = DBO.PIECE(FILEDATA,',',12),
		STRIKE_PRICE = DBO.PIECE(FILEDATA,',',13),
		OPTION_TYPE = DBO.PIECE(FILEDATA,',',14),
		SERIES_CODE = DBO.PIECE(FILEDATA,',',15),
		CA_LEVEL = DBO.PIECE(FILEDATA,',',16),
		BF_LONG_QTY = DBO.PIECE(FILEDATA,',',17),
		BF_LONG_VALUE = DBO.PIECE(FILEDATA,',',18),
		BF_SHORT_QTY = DBO.PIECE(FILEDATA,',',19),
		BF_SHORT_VALUE = DBO.PIECE(FILEDATA,',',20),
		DAY_BUY_QTY = DBO.PIECE(FILEDATA,',',21),
		DAY_BUY_VALUE = DBO.PIECE(FILEDATA,',',22),
		DAY_SELL_QTY = DBO.PIECE(FILEDATA,',',23),
		DAY_SELL_VALUE = DBO.PIECE(FILEDATA,',',24),
		PRE_LONG_QTY = DBO.PIECE(FILEDATA,',',25),
		PRE_LONG_VALUE = DBO.PIECE(FILEDATA,',',26),
		PRE_SHORT_QTY = DBO.PIECE(FILEDATA,',',27),
		PRE_SHORT_VALUE = DBO.PIECE(FILEDATA,',',28),
		EXERCISED_QTY = DBO.PIECE(FILEDATA,',',29),
		ASSIGNED_QTY = DBO.PIECE(FILEDATA,',',30),
		POST_LONG_QTY = DBO.PIECE(FILEDATA,',',31),
		POST_LONG_VALUE = DBO.PIECE(FILEDATA,',',32),
		POST_SHORT_QTY = DBO.PIECE(FILEDATA,',',33),
		POST_SHORT_VALUE = DBO.PIECE(FILEDATA,',',34),
		SETTLEMENT_PRICE = CASE WHEN DBO.PIECE(FILEDATA,',',35) ='' THEN 0 ELSE DBO.PIECE(FILEDATA,',',35) END,
		NET_PREMIUM = DBO.PIECE(FILEDATA,',',36),
		DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILEDATA,',',37),
		FINAL_SETTLEMENT_VALUE = DBO.PIECE(FILEDATA,',',38),
		EXERCISED_ASSIGNED_VALUE = DBO.PIECE(FILEDATA,',',39)
	FROM CLASSFILEUPD_BULK
	WHERE
		SPID= @SESSIONID 
		AND LEN(FILEDATA) > 100
END

SELECT TOP 1 @TRADE_DATE = POSITION_DATE FROM BFOEXERCISEALLOCATION_IMP

UPDATE BFOEXERCISEALLOCATION_IMP SET EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59'

DELETE BFOEXERCISEALLOCATION 
WHERE
	POSITION_DATE = @TRADE_DATE

IF (SELECT MEMBERTYPE FROM BFOOWNER) = 'CM'
BEGIN

	UPDATE BFOEXERCISEALLOCATION_IMP SET PARTY_CODE= BFOTMINFO.PARTY_CODE 
	FROM BFOTMINFO WHERE BFOTMINFO.TM_CODE=BFOEXERCISEALLOCATION_IMP.TM_CODE

	UPDATE BFOEXERCISEALLOCATION_IMP SET BFOEXERCISEALLOCATION_IMP.PARTY_CODE= CLIENT2.PARTY_CODE 
	FROM CLIENT2 WHERE CLIENT2.BANKID=BFOEXERCISEALLOCATION_IMP.TM_CODE

END

UPDATE BFOEXERCISEALLOCATION_IMP SET PARTY_CODE = NEWPARTY_CODE
FROM PARTYMAPPING WHERE PARTY_CODE = OLDPARTY_CODE
	
INSERT INTO BFOEXERCISEALLOCATION
SELECT 	*,@UNAME,GETDATE()
FROM BFOEXERCISEALLOCATION_IMP

TRUNCATE TABLE BFOEXERCISEALLOCATION_IMP


/*------------------------------------------------ END OF THE PROC ----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_IMPORT_STT_FILE
-- --------------------------------------------------

CREATE PROC [dbo].[CLS_PR_IMPORT_STT_FILE] 
(
	@SESSIONID VARCHAR(30),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS


CREATE TABLE #STT_EXCHG
(
	[STT_DATE] [datetime] ,
	[PARTY_CODE] [varchar](20) ,
	[SERIES_ID] [int] 	,
	[ASSET_CODE] [varchar](8) ,	
	[PRODUCT_TYPE] [varchar](3) ,	
	[SERIES_CODE] [varchar](22) ,	
	[EXPIRYDATE] [datetime] ,
	[STRIKE_PRICE] [numeric](9, 0) ,
	[OPTION_TYPE] [varchar](2) ,	
	[TOT_TURNOVER] [numeric](18, 4) ,
	[TOT_STT] [numeric](18, 4) 
)

IF @INTMODE=1
BEGIN

	INSERT INTO #STT_EXCHG
	SELECT	
		STT_DATE = DBO.PIECE(FILE_DATA,',',1),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',2),
		SERIES_ID = DBO.PIECE(FILE_DATA,',',4),
		ASSET_CODE = DBO.PIECE(FILE_DATA,',',5),
		PRODUCT_TYPE = DBO.PIECE(FILE_DATA,',',6),
		SERIES_CODE = DBO.PIECE(FILE_DATA,',',7),
		EXPIRYDATE = DBO.PIECE(FILE_DATA,',',8),
		STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',9),
		OPTION_TYPE = DBO.PIECE(FILE_DATA,',',10),
		TOT_TURNOVER = DBO.PIECE(FILE_DATA,',',11),
		TOT_STT = DBO.PIECE(FILE_DATA,',',12)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID	
		AND DBO.PIECE(FILE_DATA,',',1) IN ('40','30')
END
ELSE
BEGIN

	INSERT INTO #STT_EXCHG
	SELECT 	
		STT_DATE = DBO.PIECE(FILEDATA,',',1),
		PARTY_CODE = DBO.PIECE(FILEDATA,',',2),
		SERIES_ID = DBO.PIECE(FILEDATA,',',4),
		ASSET_CODE = DBO.PIECE(FILEDATA,',',5),
		PRODUCT_TYPE = DBO.PIECE(FILEDATA,',',6),
		SERIES_CODE = DBO.PIECE(FILEDATA,',',7),
		EXPIRYDATE = DBO.PIECE(FILEDATA,',',8),
		STRIKE_PRICE = DBO.PIECE(FILEDATA,',',9),
		OPTION_TYPE = DBO.PIECE(FILEDATA,',',10),
		TOT_TURNOVER = DBO.PIECE(FILEDATA,',',11),
		TOT_STT = DBO.PIECE(FILEDATA,',',12)
	FROM CLASSFILEUPD_BULK
	WHERE
		SPID= @SESSIONID 
		AND DBO.PIECE(FILEDATA,',',1) IN ('40','30')
	
END

UPDATE #STT_EXCHG SET PARTY_CODE = NEWPARTY_CODE
FROM PARTYMAPPING
WHERE OLDPARTY_CODE = #STT.PARTY_CODE


IF (SELECT MEMBERTYPE FROM FOOWNER) ='CM'
BEGIN
   UPDATE #STT_EXCHG SET PARTY_CODE = FOTMINFO.PARTY_CODE   
   FROM  FOTMINFO (NOLOCK) WHERE FOTMINFO.TM_CODE = #STT_EXCHG.TM_CODE  
  
   UPDATE #STT_EXCHG SET PARTY_CODE = C2.PARTY_CODE   
   FROM  CLIENT2 C2 (NOLOCK) WHERE C2.BANKID = #STT_EXCHG.TM_CODE  
   AND TM_CODE NOT IN (SELECT PARTY_CODE FROM FOTMINFO (NOLOCK))  
	
END

UPDATE #STT_EXCHG SET STRIKE_PRICE = '0' WHERE ISNULL(STRIKE_PRICE,'') = ''

DELETE STT_EXCHG WHERE STT_DATE = @SAUDA_DATE

INSERT INTO STT_EXCHG
SELECT STT_DATE,PARTY_CODE,ASSET_CODE,PRODUCT_TYPE,SERIES_CODE,EXPIRYDATE,
STRIKE_PRICE,OPTION_TYPE,TOT_TURNOVER,TOT_STT,SERIES_ID
FROM #STT_EXCHG

DROP TABLE #STT_EXCHG


/*--------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_VALIDATEFILE
-- --------------------------------------------------


CREATE PROCEDURE [DBO].[CLS_PR_VALIDATEFILE] 
(
	@FILETYPE VARCHAR(12),
	@FILEPATHNAME VARCHAR(400),
	@SAUDA_DATE VARCHAR(11)
) AS

DECLARE @FILENAME VARCHAR(100)
DECLARE @INTSTAT INT
DECLARE @STRRET VARCHAR(200)
DECLARE @EXCHANGECODE VARCHAR(3)
DECLARE @INTDATEVAL INT

IF  CHARINDEX('\',@FILEPATHNAME) > 0
BEGIN
	SET @FILENAME = REVERSE(LEFT(REVERSE(@FILEPATHNAME),CHARINDEX('\',REVERSE(@FILEPATHNAME))-1))
END
ELSE
BEGIN
	SET @FILENAME = @FILEPATHNAME
END

SET @INTSTAT = 0
SET @STRRET  = ''
SET @INTDATEVAL = 0

SELECT @EXCHANGECODE = UPPER(EXCHANGE)  FROM FOGLOBALS (NOLOCK)


IF @FILETYPE ='F_CN01'
BEGIN
		IF LEFT(@FILENAME,2) <> 'CO' OR LEFT(@FILENAME,10) <> 'EQD_SPD_CO'  OR LEFT(@FILENAME,6) <> 'EQD_CO'
		BEGIN
			SET @INTSTAT = 1
			SET @STRRET  = 'INVALID CONTRACT FILE SELECTED'
		END
END

IF @FILETYPE ='CLOSING'
BEGIN
	IF RIGHT(@FILENAME,3) <> 'MS_' 
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET  = 'INVALID CLOSING FILE SELECTED'
	END

END


IF @FILETYPE ='MARGIN'
BEGIN
	IF LEFT(@FILENAME,2) <> 'MG'
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET  = 'INVALID MARGIN FILE SELECTED'
	END
	SET @INTDATEVAL = 1
END


IF @FILETYPE ='POSITION'
BEGIN

	IF LEFT(@FILENAME,2) <> 'PO'
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET  = 'INVALID POSITION FILE SELECTED'
	END
	SET @INTDATEVAL = 1
END



IF @INTDATEVAL = 1 AND @INTSTAT = 0
BEGIN
	DECLARE @FILEDATE_V VARCHAR(12)
	DECLARE @FILEDATE VARCHAR(12)
	SET @FILENAME = REPLACE(@FILENAME,'-01.CSV','.CSV')
	SET @FILEDATE_V = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
	
	
	IF LEN(@FILEDATE_V) <> 8
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET = 'WRONG FILE NAME'		
	END	 
	ELSE
	BEGIN
		IF @FILEDATE_V <> CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),112)
		BEGIN
			SET @INTSTAT = 1	
			SET @STRRET = 'FILE DATE AND ENTER SELECT DATE IS DIFFERENT'			
		END
	END
END	

SELECT @INTSTAT AS INTSTAT,@STRRET AS STRRET

/*-------------------------------------- END OF THE PROC ---------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWCLIENTSUMMARY
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_RPT_PROC_FO_NEWCLIENTSUMMARY]
	(
	@STATUSID		VARCHAR(20),
	@STATUSNAME		VARCHAR(25),
	@FROMDATE		VARCHAR(11),
	@FROMPARTY		VARCHAR(20),
	@TOPARTY		VARCHAR(20),
	@RATE_FLAG		VARCHAR(10),
	@NETPOS_FLAG	INT = 0,
	@BILL_FLAG		INT = 0,
	@EXCHANGE		VARCHAR(3),
	@SEGMENT 		VARCHAR(10),
	@RPT_TYPE		INT = 0
	)
	
	AS	
	
	/*
	EXEC CLS_RPT_PROC_FO_NEWCLIENTSUMMARY 'BROKER','BROKER','28/03/2013','','ZZZZZZZZZ','PRICE',1,1,'BSE','FUTURES',1
	*/
	
	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
	BEGIN
		SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
	END
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZ'
	END
	
	
	CREATE TABLE #CLIENTSUMMARY
		(
		CLIENT_CODE	VARCHAR(20),
		CLIENT_NAME	VARCHAR(100),
		CLIENT_TYPE	VARCHAR(5),
		EMAIL		VARCHAR(100),
		L_ADDRESS1	VARCHAR(100), 
		L_ADDRESS2	VARCHAR(100), 
		L_ADDRESS3	VARCHAR(100),  
		L_CITY		VARCHAR(50),
		L_ZIP		VARCHAR(20),
		PAN_GIR_NO	VARCHAR(20),
		OFF_PHONE1	VARCHAR(50),
		OFF_PHONE2	VARCHAR(50),
		BRANCH_CODE VARCHAR(20),
		SUB_BROKER	VARCHAR(20),
		DAILYMTOMSETTLEMENT			MONEY,
		FINALFUTURESSETTLEMENT		MONEY,
		PREMIUMSETTLEMENT			MONEY,
		OPTIONSEXERCISEASSIGNMENT	MONEY,
		BROKANDMISC					MONEY,
		CLEARINGCHARGES				MONEY,

		MARGINDATE	VARCHAR(11),
		LEDBALANCE	MONEY,
		PAYREC		MONEY,
		MINLEDBAL	MONEY,
		MINMARGIN	MONEY,      
		MARGIN		MONEY,
		AVLCOLL		MONEY,
		SPANMAR		MONEY,
		VARMARGIN	MONEY,
		TOTCASH		MONEY,
		TOTCOLLNONCASH MONEY,      
		TOTNONCASH	MONEY,
		TOTCOLL		MONEY,
		EFFCOLL		MONEY,
		SPREADMARGIN	MONEY, 
		NONSPREADMARGIN	MONEY,
		MTOMMARGIN		MONEY,
		EFFNONCASH		MONEY,

		INST_TYPE		VARCHAR(10), 
		SYMBOL			VARCHAR(25), 
		EXPIRYDATE		VARCHAR(11),
		STRIKE_PRICE	MONEY, 
		OPTION_TYPE		VARCHAR(2), 
		OPENPOSITION	MONEY,
		PROFITORLOSS	MONEY,

		S_SPANMARGIN	MONEY,
		S_PREMIUM		MONEY,
		S_ADDMARGINPERC MONEY,
		S_TOTALMARGIN	MONEY,
		E_MARGINPERC	MONEY,
		E_MARGINAMT		MONEY,
		
		REC_TYPE		INT
		)
	
	SELECT	* INTO #FOBILLVALAN
	FROM	FOBILLVALAN (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY

	
	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,CLIENT_NAME,CLIENT_TYPE,EMAIL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,PAN_GIR_NO,OFF_PHONE1,OFF_PHONE2,BRANCH_CODE,SUB_BROKER,DAILYMTOMSETTLEMENT,FINALFUTURESSETTLEMENT,PREMIUMSETTLEMENT,OPTIONSEXERCISEASSIGNMENT,BROKANDMISC,CLEARINGCHARGES,REC_TYPE)
	SELECT 
		CLIENT_CODE = F.PARTY_CODE, 
		PARTY_NAME = C1.LONG_NAME,
		CLIENT_TYPE,
		EMAIL = C1.EMAIL,
		L_ADDRESS1 = C1.L_ADDRESS1, 
		L_ADDRESS2 = C1.L_ADDRESS2, 
		L_ADDRESS3 = C1.L_ADDRESS3,  
		L_CITY = C1.L_CITY,
		L_ZIP = C1.L_ZIP, 
		PAN_GIR_NO = C1.PAN_GIR_NO, 
		OFF_PHONE1 = C1.OFF_PHONE1,
		OFF_PHONE2 = C1.OFF_PHONE2,
		BRANCH_CODE = F.BRANCH_CODE,
		SUB_BROKER = F.SUB_BROKER,		 
		DAILYMTOMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0
		END),
		FINALFUTURESSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		PREMIUMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		OPTIONSEXERCISEASSIGNMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		BROKANDMISC = (
		CASE
			WHEN @RATE_FLAG = 'PRICE' THEN -(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			WHEN @RATE_FLAG = 'NETRATE' THEN -(SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			ELSE 0
		END),
		CLEARINGCHARGES = -(SUM(CL_CHRG) - SUM(EXCL_CHRG)),
		REC_TYPE = 1
	FROM 
		#FOBILLVALAN F (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE
		F.PARTY_CODE = C1.CL_CODE  
		--AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		--AND SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
		AND @STATUSID = (
		CASE 			
			WHEN @STATUSNAME = 'BRANCH'		THEN F.BRANCH_CODE			
			WHEN @STATUSNAME = 'SUBBROKER'	THEN F.SUB_BROKER			
			WHEN @STATUSNAME = 'TRADER'		THEN F.TRADER			
			WHEN @STATUSNAME = 'FAMILY'		THEN F.FAMILY			
			WHEN @STATUSNAME = 'AREA'		THEN F.AREA			
			WHEN @STATUSNAME = 'REGION'		THEN F.REGION			
			WHEN @STATUSNAME = 'CLIENT'		THEN F.PARTY_CODE			
			ELSE 'BROKER'		
		END)    
	GROUP BY 
		F.PARTY_CODE, 
		C1.LONG_NAME,
		CLIENT_TYPE,
		C1.EMAIL,
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2, 
		C1.L_ADDRESS3,  
		C1.L_CITY,
		C1.L_ZIP, 
		C1.PAN_GIR_NO, 
		C1.OFF_PHONE1,
		C1.OFF_PHONE2,
		F.BRANCH_CODE,
		F.SUB_BROKER
	ORDER BY 
		F.PARTY_CODE, 
		PARTY_NAME, 
		CLIENT_TYPE
		


	CREATE TABLE #CL_LEDGER
		(
		CLIENT_CODE		VARCHAR(20),
		OPENBALANCE   	MONEY,
		LEDBALANCE   	MONEY,
		PAYREC       	MONEY,    
		MINLEDBAL   	MONEY,    
		MINMARGIN   	MONEY,    
		MARGIN			MONEY,    
		AVLCOLL      	MONEY,    
		SPANMAR      	MONEY,    
		VARMARGIN		MONEY,    
		TOTCASH     	MONEY,    
		TOTNONCASH		MONEY,    
		TOTCOLL  		MONEY,    
		EFFCOLL    		MONEY,    
		SPREADMARGIN 	MONEY,    
		NONSPREADMARGIN MONEY,    
		MTOMMARGIN 		MONEY,    
		MARGINPER 		MONEY,
		EFFNONCASH		MONEY  
		)

	INSERT	INTO #CL_LEDGER 
	SELECT	DISTINCT CLIENT_CODE,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	FROM	#CLIENTSUMMARY
	    
	/* LEDGER BALANCE */    
	UPDATE	#CL_LEDGER
	SET		LEDBALANCE = ISNULL(A.LEDBALANCE,0)
	FROM	(
			SELECT CLTCODE, LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK), ACCOUNTFO.DBO.PARAMETER P (NOLOCK)
			WHERE VDT < @FROMDATE AND VDT >= SDTCUR AND VDT<= LDTCUR    
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
			AND @FROMDATE BETWEEN SDTCUR AND LDTCUR
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
		    
	/* OPEN BALANCE */    
	UPDATE	#CL_LEDGER
	SET		OPENBALANCE = ISNULL(A.OPENBALANCE,0)
	FROM	(
			SELECT CLTCODE, OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK)
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND VTYP = 18 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* PAYMENT RECEIVED FOR THE DAY */    
	UPDATE	#CL_LEDGER
	SET		PAYREC = ISNULL(A.PAYREC,0)
	FROM	(
			SELECT CLTCODE, PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK) 
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			AND VTYP NOT IN (15,18)
			GROUP  BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* MARGIN AMOUNT */    
	UPDATE	#CL_LEDGER
	SET		MARGIN = ISNULL(A.MARGIN,0)
	FROM	(
			SELECT PARTY_CODE, MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)    
			FROM ACCOUNTFO.DBO.MARGINLEDGER L (NOLOCK), ACCOUNTFO.DBO.PARAMETER P (NOLOCK)  
			WHERE VDT <= @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT 
			AND VDT < @FROMDATE AND VDT >= SDTCUR AND CURYEAR = 1
			GROUP BY PARTY_CODE     
			) A
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	    
	/* SPAN AND VAR MARGIN */    
	IF (SELECT COUNT(1) FROM FOMARGIN_SPAN WHERE MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0 OR  (SELECT COUNT(1) FROM FOMARGIN_EXP_DETAILS (NOLOCK) WHERE SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(TOTALMARGIN),0) ,  
					SPREADMARGIN = -ISNULL(SUM(TOTALMARGIN),0)
				FROM 
					FOMARGIN_SPAN (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE	
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

				
		UPDATE	#CL_LEDGER
		SET		VARMARGIN = ISNULL(A.VARMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					VARMARGIN = -ISNULL(SUM(MARGINAMT),0) ,  
					MTOMMARGIN = -ISNULL(SUM(MARGINAMT),0)
				FROM 
					FOMARGIN_EXP_DETAILS (NOLOCK)
				WHERE 
					SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE		
				) A	
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

	END
	ELSE
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				VARMARGIN = ISNULL(A.VARMARGIN,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0),
				NONSPREADMARGIN = ISNULL(A.NONSPREADMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(PMARGINAMOUNT),0) , 
					VARMARGIN = -ISNULL(SUM(MTOM),0) , 
					SPREADMARGIN = -ISNULL(SUM(SPREADMARGIN),0), 
					NONSPREADMARGIN = -ISNULL(SUM(NONSPREADMARGIN),0),
					MTOMMARGIN = -ISNULL(SUM(MTOM),0) 
				FROM 
					FOMARGINNEW (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' 
					AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND CL_TYPE <> 'TM'     
				GROUP BY
					PARTY_CODE							
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	END 

	/* COLLATERAL DETAILS */    
	UPDATE	#CL_LEDGER
	SET		TOTCASH = ISNULL(A.TOTCASH,0),
			TOTNONCASH = ISNULL(A.TOTNONCASH,0),
			TOTCOLL = ISNULL(A.TOTCOLL,0),
			EFFCOLL = ISNULL(A.EFFCOLL,0),
			AVLCOLL = ISNULL(A.AVLCOLL,0),
			EFFNONCASH = ISNULL(A.EFFNONCASH,0)
	FROM	(			
			SELECT 
				PARTY_CODE,
				TOTCASH = ISNULL(SUM(CASH),0), 
				TOTNONCASH = ISNULL(SUM(NONCASH),0), 
				TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),     
				EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				EFFNONCASH = ISNULL(SUM(ACTUALNONCASH),0)
			FROM 
				MSAJAG.DBO.COLLATERAL (NOLOCK)
			WHERE 
				PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				AND TRANS_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
				AND EXCHANGE = @EXCHANGE    
				AND SEGMENT = @SEGMENT     
			GROUP BY
				PARTY_CODE	
			) A	
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	 

	UPDATE	#CL_LEDGER
	SET		MARGINPER = 100,
			LEDBALANCE = LEDBALANCE + OPENBALANCE
	     

	--INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,MARGINDATE,LEDBALANCE,PAYREC,MINLEDBAL,MINMARGIN,MARGIN,AVLCOLL,SPANMAR,VARMARGIN,TOTCASH, TOTCOLLNONCASH,TOTNONCASH,TOTCOLL,EFFCOLL,SPREADMARGIN,NONSPREADMARGIN,MTOMMARGIN,EFFNONCASH,REC_TYPE)
	--SELECT       
			--CLIENT_CODE,

	UPDATE	#CLIENTSUMMARY
	SET		MARGINDATE = @FROMDATE,       
			LEDBALANCE = C.LEDBALANCE,
			PAYREC = C.PAYREC,
			MINLEDBAL = C.MINLEDBAL,
			MINMARGIN = (C.SPREADMARGIN + C.NONSPREADMARGIN + C.VARMARGIN),
			MARGIN = C.MARGIN,
			AVLCOLL = C.AVLCOLL,
			SPANMAR = C.SPANMAR,
			VARMARGIN = C.VARMARGIN,
			TOTCASH = C.TOTCASH,
			TOTCOLLNONCASH = C.TOTNONCASH,      
			TOTNONCASH = C.TOTNONCASH,
			TOTCOLL = C.TOTCOLL,
			EFFCOLL = (
			CASE 
				WHEN C.LEDBALANCE + C.PAYREC + C.TOTCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN 
					CASE 
						WHEN (C.TOTNONCASH > C.LEDBALANCE + C.PAYREC + C.TOTCASH) THEN C.LEDBALANCE + C.TOTCASH      
						ELSE C.TOTNONCASH       
					END      
				ELSE      
					CASE 
						WHEN C.TOTNONCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100)
						ELSE C.TOTNONCASH       
					END       
			END) + C.TOTCASH,
			SPREADMARGIN = C.SPREADMARGIN, 
			NONSPREADMARGIN = C.NONSPREADMARGIN,
			MTOMMARGIN = C.MTOMMARGIN,
			EFFNONCASH = C.EFFNONCASH
			--REC_TYPE = 2
	FROM	#CL_LEDGER C
	WHERE	--(LEDBALANCE+PAYREC+MINLEDBAL+SPREADMARGIN+NONSPREADMARGIN+VARMARGIN+MARGIN+AVLCOLL+SPANMAR+TOTCASH+TOTNONCASH+TOTCOLL+MTOMMARGIN+EFFNONCASH) <> 0
			C.CLIENT_CODE = #CLIENTSUMMARY.CLIENT_CODE
			AND REC_TYPE = 1


	IF @RPT_TYPE = 0
	BEGIN
		SELECT	CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE,
				NET_BILL_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES),2)),
				NET_SETT_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES) ELSE 0 END),2)),
				NET_REC_PAYABLE = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES-ISNULL(NONSPREADMARGIN,0)) ELSE 0 END)
									+ SUM(ISNULL(AVLCOLL,0)+ISNULL(SPANMAR,0)+ISNULL(VARMARGIN,0)),2))
		FROM	#CLIENTSUMMARY
		GROUP BY
				CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE
		ORDER BY
				CLIENT_CODE		
		RETURN		
	END
	

	IF @NETPOS_FLAG = 1
	BEGIN
		INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,OPENPOSITION,PROFITORLOSS,REC_TYPE)
		SELECT
			CLIENT_CODE=PARTY_CODE,
			INST_TYPE, SYMBOL, 
			EXPIRYDATE = LEFT(EXPIRYDATE,11), 
			STRIKE_PRICE, 
			OPTION_TYPE, 
			OPENPOSITION = SUM(PQTY-SQTY),
			PROFITORLOSS = SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),
			REC_TYPE = 2
		FROM
			#FOBILLVALAN (NOLOCK)
		GROUP BY
			PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE			
		HAVING SUM(PQTY-SQTY) <> 0
	END
		

	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,SYMBOL,S_SPANMARGIN,S_PREMIUM,S_ADDMARGINPERC,S_TOTALMARGIN,E_MARGINPERC,E_MARGINAMT,REC_TYPE)
	SELECT
		CLIENT_CODE = ISNULL(S_PARTY_CODE,E_PARTY_CODE),
		--PARTYNAME = ISNULL(S_PARTYNAME,E_PARTYNAME),
		SYMBOL = ISNULL(S_SYMBOL,E_SYMBOL),
		S_SPANMARGIN =ISNULL(S_SPANMARGIN,0),
		S_PREMIUM = ISNULL(S_PREMIUM,0),
		S_ADDMARGINPERC = ISNULL(S_ADDMARGINPERC,0),
		S_TOTALMARGIN = ISNULL(S_TOTALMARGIN,0),
		E_MARGINPERC = ISNULL(E_MARGINPERC,0),
		E_MARGINAMT = ISNULL(E_MARGINAMT,0),
		REC_TYPE = 3
	FROM 
		(
		SELECT
			S_PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE,
			--S_PARTYNAME = LONG_NAME,
			S_SYMBOL = REPLACE(FOMARGIN_SPAN.SYMBOL,'&AMP;','&'),
			S_SPANMARGIN = SPANMARGIN,
			S_PREMIUM = PREMIUM,
			S_ADDMARGINPERC = PMARGINRATE,
			S_TOTALMARGIN = TOTALMARGIN
		FROM
			FOMARGIN_SPAN (NOLOCK) 
		WHERE
			MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_SPAN.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND FOMARGIN_SPAN.CL_TYPE ='CL'
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_SPAN.PARTY_CODE)
		) FOMRG

	FULL OUTER JOIN 
		(
		SELECT
			E_PARTY_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE,
			--E_PARTYNAME = LONG_NAME,
			E_SYMBOL = SYMBOL,
			E_MARGINPERC = MARGIN_PERC,
			E_MARGINAMT = MARGINAMT
		FROM
			FOMARGIN_EXP_DETAILS (NOLOCK)
		WHERE
			SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_EXP_DETAILS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE)
		) EXPMRG
		ON (E_PARTY_CODE = S_PARTY_CODE AND E_SYMBOL = S_SYMBOL)
	ORDER BY 1,3
	
	SELECT * FROM #CLIENTSUMMARY
	ORDER BY CLIENT_CODE, REC_TYPE
	
	DROP TABLE #FOBILLVALAN
	DROP TABLE #CLIENTSUMMARY
	DROP TABLE #CL_LEDGER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWCLIENTSUMMARY_bak_23022016
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_RPT_PROC_FO_NEWCLIENTSUMMARY]
	(
	@STATUSID		VARCHAR(20),
	@STATUSNAME		VARCHAR(25),
	@FROMDATE		VARCHAR(11),
	@FROMPARTY		VARCHAR(20),
	@TOPARTY		VARCHAR(20),
	@RATE_FLAG		VARCHAR(10),
	@NETPOS_FLAG	INT = 0,
	@BILL_FLAG		INT = 0,
	@EXCHANGE		VARCHAR(3),
	@SEGMENT 		VARCHAR(10),
	@RPT_TYPE		INT = 0
	)
	
	AS	
	
	/*
	EXEC CLS_RPT_PROC_FO_NEWCLIENTSUMMARY 'BROKER','BROKER','DEC  2 2010','','ZZZZZZZZZ','PRICE',1,1,'NSE','FUTURES',0
	*/
	
	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
	BEGIN
		SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
	END
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZ'
	END
	
	CREATE TABLE #CLIENTSUMMARY
		(
		CLIENT_CODE	VARCHAR(20),
		CLIENT_NAME	VARCHAR(100),
		CLIENT_TYPE	VARCHAR(5),
		EMAIL		VARCHAR(100),
		L_ADDRESS1	VARCHAR(100), 
		L_ADDRESS2	VARCHAR(100), 
		L_ADDRESS3	VARCHAR(100),  
		L_CITY		VARCHAR(50),
		L_ZIP		VARCHAR(20),
		PAN_GIR_NO	VARCHAR(20),
		OFF_PHONE1	VARCHAR(50),
		OFF_PHONE2	VARCHAR(50),
		BRANCH_CODE VARCHAR(20),
		SUB_BROKER	VARCHAR(20),
		DAILYMTOMSETTLEMENT			MONEY,
		FINALFUTURESSETTLEMENT		MONEY,
		PREMIUMSETTLEMENT			MONEY,
		OPTIONSEXERCISEASSIGNMENT	MONEY,
		BROKANDMISC					MONEY,
		CLEARINGCHARGES				MONEY,

		MARGINDATE	VARCHAR(11),
		LEDBALANCE	MONEY,
		PAYREC		MONEY,
		MINLEDBAL	MONEY,
		MINMARGIN	MONEY,      
		MARGIN		MONEY,
		AVLCOLL		MONEY,
		SPANMAR		MONEY,
		VARMARGIN	MONEY,
		TOTCASH		MONEY,
		TOTCOLLNONCASH MONEY,      
		TOTNONCASH	MONEY,
		TOTCOLL		MONEY,
		EFFCOLL		MONEY,
		SPREADMARGIN	MONEY, 
		NONSPREADMARGIN	MONEY,
		MTOMMARGIN		MONEY,
		EFFNONCASH		MONEY,

		INST_TYPE		VARCHAR(6), 
		SYMBOL			VARCHAR(25), 
		EXPIRYDATE		VARCHAR(11),
		STRIKE_PRICE	MONEY, 
		OPTION_TYPE		VARCHAR(2), 
		OPENPOSITION	MONEY,
		PROFITORLOSS	MONEY,

		S_SPANMARGIN	MONEY,
		S_PREMIUM		MONEY,
		S_ADDMARGINPERC MONEY,
		S_TOTALMARGIN	MONEY,
		E_MARGINPERC	MONEY,
		E_MARGINAMT		MONEY,
		
		REC_TYPE		INT
		)
	
	SELECT	* INTO #FOBILLVALAN
	FROM	FOBILLVALAN (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		

	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,CLIENT_NAME,CLIENT_TYPE,EMAIL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,PAN_GIR_NO,OFF_PHONE1,OFF_PHONE2,BRANCH_CODE,SUB_BROKER,DAILYMTOMSETTLEMENT,FINALFUTURESSETTLEMENT,PREMIUMSETTLEMENT,OPTIONSEXERCISEASSIGNMENT,BROKANDMISC,CLEARINGCHARGES,REC_TYPE)
	SELECT 
		CLIENT_CODE = F.PARTY_CODE, 
		PARTY_NAME = C1.LONG_NAME,
		CLIENT_TYPE,
		EMAIL = C1.EMAIL,
		L_ADDRESS1 = C1.L_ADDRESS1, 
		L_ADDRESS2 = C1.L_ADDRESS2, 
		L_ADDRESS3 = C1.L_ADDRESS3,  
		L_CITY = C1.L_CITY,
		L_ZIP = C1.L_ZIP, 
		PAN_GIR_NO = C1.PAN_GIR_NO, 
		OFF_PHONE1 = C1.OFF_PHONE1,
		OFF_PHONE2 = C1.OFF_PHONE2,
		BRANCH_CODE = F.BRANCH_CODE,
		SUB_BROKER = F.SUB_BROKER,		 
		DAILYMTOMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND RIGHT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND RIGHT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0
		END),
		FINALFUTURESSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND RIGHT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND RIGHT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		PREMIUMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND RIGHT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND RIGHT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		OPTIONSEXERCISEASSIGNMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND RIGHT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND RIGHT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		BROKANDMISC = (
		CASE
			WHEN @RATE_FLAG = 'PRICE' THEN -(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			WHEN @RATE_FLAG = 'NETRATE' THEN -(SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			ELSE 0
		END),
		CLEARINGCHARGES = -(SUM(CL_CHRG) - SUM(EXCL_CHRG)),
		REC_TYPE = 1
	FROM 
		#FOBILLVALAN F (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE
		F.PARTY_CODE = C1.CL_CODE  
		--AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		--AND SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
		AND @STATUSID = (
		CASE 			
			WHEN @STATUSNAME = 'BRANCH'		THEN F.BRANCH_CODE			
			WHEN @STATUSNAME = 'SUBBROKER'	THEN F.SUB_BROKER			
			WHEN @STATUSNAME = 'TRADER'		THEN F.TRADER			
			WHEN @STATUSNAME = 'FAMILY'		THEN F.FAMILY			
			WHEN @STATUSNAME = 'AREA'		THEN F.AREA			
			WHEN @STATUSNAME = 'REGION'		THEN F.REGION			
			WHEN @STATUSNAME = 'CLIENT'		THEN F.PARTY_CODE			
			ELSE 'BROKER'		
		END)    
	GROUP BY 
		F.PARTY_CODE, 
		C1.LONG_NAME,
		CLIENT_TYPE,
		C1.EMAIL,
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2, 
		C1.L_ADDRESS3,  
		C1.L_CITY,
		C1.L_ZIP, 
		C1.PAN_GIR_NO, 
		C1.OFF_PHONE1,
		C1.OFF_PHONE2,
		F.BRANCH_CODE,
		F.SUB_BROKER
	ORDER BY 
		F.PARTY_CODE, 
		PARTY_NAME, 
		CLIENT_TYPE
		


	CREATE TABLE #CL_LEDGER
		(
		CLIENT_CODE		VARCHAR(20),
		OPENBALANCE   	MONEY,
		LEDBALANCE   	MONEY,
		PAYREC       	MONEY,    
		MINLEDBAL   	MONEY,    
		MINMARGIN   	MONEY,    
		MARGIN			MONEY,    
		AVLCOLL      	MONEY,    
		SPANMAR      	MONEY,    
		VARMARGIN		MONEY,    
		TOTCASH     	MONEY,    
		TOTNONCASH		MONEY,    
		TOTCOLL  		MONEY,    
		EFFCOLL    		MONEY,    
		SPREADMARGIN 	MONEY,    
		NONSPREADMARGIN MONEY,    
		MTOMMARGIN 		MONEY,    
		MARGINPER 		MONEY,
		EFFNONCASH		MONEY  
		)

	INSERT	INTO #CL_LEDGER 
	SELECT	DISTINCT CLIENT_CODE,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	FROM	#CLIENTSUMMARY
	    
	/* LEDGER BALANCE */    
	UPDATE	#CL_LEDGER
	SET		LEDBALANCE = ISNULL(A.LEDBALANCE,0)
	FROM	(
			SELECT CLTCODE, LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTBFO.DBO.LEDGER L (NOLOCK), ACCOUNTBFO.DBO.PARAMETER P (NOLOCK)
			WHERE VDT < @FROMDATE AND VDT >= SDTCUR AND VDT<= LDTCUR    
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
			AND @FROMDATE BETWEEN SDTCUR AND LDTCUR
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
		    
	/* OPEN BALANCE */    
	UPDATE	#CL_LEDGER
	SET		OPENBALANCE = ISNULL(A.OPENBALANCE,0)
	FROM	(
			SELECT CLTCODE, OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTBFO.DBO.LEDGER L (NOLOCK)
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND VTYP = 18 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* PAYMENT RECEIVED FOR THE DAY */    
	UPDATE	#CL_LEDGER
	SET		PAYREC = ISNULL(A.PAYREC,0)
	FROM	(
			SELECT CLTCODE, PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTBFO.DBO.LEDGER L (NOLOCK) 
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			AND VTYP NOT IN (15,18)
			GROUP  BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* MARGIN AMOUNT */    
	UPDATE	#CL_LEDGER
	SET		MARGIN = ISNULL(A.MARGIN,0)
	FROM	(
			SELECT PARTY_CODE, MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)    
			FROM ACCOUNTBFO.DBO.MARGINLEDGER L (NOLOCK), ACCOUNTBFO.DBO.PARAMETER P (NOLOCK)  
			WHERE VDT <= @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT 
			AND VDT < @FROMDATE AND VDT >= SDTCUR AND CURYEAR = 1
			GROUP BY PARTY_CODE     
			) A
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	    
	/* SPAN AND VAR MARGIN */    
	/*
	IF (SELECT COUNT(1) FROM FOMARGIN_SPAN WHERE MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0 OR  (SELECT COUNT(1) FROM FOMARGIN_EXP_DETAILS (NOLOCK) WHERE SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(TOTALMARGIN),0) ,  
					SPREADMARGIN = -ISNULL(SUM(TOTALMARGIN),0)
				FROM 
					FOMARGIN_SPAN (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE	
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

				
		UPDATE	#CL_LEDGER
		SET		VARMARGIN = ISNULL(A.VARMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					VARMARGIN = -ISNULL(SUM(MARGINAMT),0) ,  
					MTOMMARGIN = -ISNULL(SUM(MARGINAMT),0)
				FROM 
					FOMARGIN_EXP_DETAILS (NOLOCK)
				WHERE 
					SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE		
				) A	
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

	END
	ELSE
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				VARMARGIN = ISNULL(A.VARMARGIN,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0),
				NONSPREADMARGIN = ISNULL(A.NONSPREADMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(PMARGINAMOUNT),0) , 
					VARMARGIN = -ISNULL(SUM(MTOM),0) , 
					SPREADMARGIN = -ISNULL(SUM(SPREADMARGIN),0), 
					NONSPREADMARGIN = -ISNULL(SUM(NONSPREADMARGIN),0),
					MTOMMARGIN = -ISNULL(SUM(MTOM),0) 
				FROM 
					FOMARGINNEW (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' 
					AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND CL_TYPE <> 'TM'     
				GROUP BY
					PARTY_CODE							
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	END 
	*/
	/* COLLATERAL DETAILS */    
	UPDATE	#CL_LEDGER
	SET		TOTCASH = ISNULL(A.TOTCASH,0),
			TOTNONCASH = ISNULL(A.TOTNONCASH,0),
			TOTCOLL = ISNULL(A.TOTCOLL,0),
			EFFCOLL = ISNULL(A.EFFCOLL,0),
			AVLCOLL = ISNULL(A.AVLCOLL,0),
			EFFNONCASH = ISNULL(A.EFFNONCASH,0)
	FROM	(			
			SELECT 
				PARTY_CODE,
				TOTCASH = ISNULL(SUM(CASH),0), 
				TOTNONCASH = ISNULL(SUM(NONCASH),0), 
				TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),     
				EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				EFFNONCASH = ISNULL(SUM(ACTUALNONCASH),0)
			FROM 
				MSAJAG.DBO.COLLATERAL (NOLOCK)
			WHERE 
				PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				AND TRANS_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
				AND EXCHANGE = @EXCHANGE    
				AND SEGMENT = @SEGMENT     
			GROUP BY
				PARTY_CODE	
			) A	
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	 

	UPDATE	#CL_LEDGER
	SET		MARGINPER = 100,
			LEDBALANCE = LEDBALANCE + OPENBALANCE
	     

	--INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,MARGINDATE,LEDBALANCE,PAYREC,MINLEDBAL,MINMARGIN,MARGIN,AVLCOLL,SPANMAR,VARMARGIN,TOTCASH, TOTCOLLNONCASH,TOTNONCASH,TOTCOLL,EFFCOLL,SPREADMARGIN,NONSPREADMARGIN,MTOMMARGIN,EFFNONCASH,REC_TYPE)
	--SELECT       
			--CLIENT_CODE,

	UPDATE	#CLIENTSUMMARY
	SET		MARGINDATE = @FROMDATE,       
			LEDBALANCE = C.LEDBALANCE,
			PAYREC = C.PAYREC,
			MINLEDBAL = C.MINLEDBAL,
			MINMARGIN = (C.SPREADMARGIN + C.NONSPREADMARGIN + C.VARMARGIN),
			MARGIN = C.MARGIN,
			AVLCOLL = C.AVLCOLL,
			SPANMAR = C.SPANMAR,
			VARMARGIN = C.VARMARGIN,
			TOTCASH = C.TOTCASH,
			TOTCOLLNONCASH = C.TOTNONCASH,      
			TOTNONCASH = C.TOTNONCASH,
			TOTCOLL = C.TOTCOLL,
			EFFCOLL = (
			CASE 
				WHEN C.LEDBALANCE + C.PAYREC + C.TOTCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN 
					CASE 
						WHEN (C.TOTNONCASH > C.LEDBALANCE + C.PAYREC + C.TOTCASH) THEN C.LEDBALANCE + C.TOTCASH      
						ELSE C.TOTNONCASH       
					END      
				ELSE      
					CASE 
						WHEN C.TOTNONCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100)
						ELSE C.TOTNONCASH       
					END       
			END) + C.TOTCASH,
			SPREADMARGIN = C.SPREADMARGIN, 
			NONSPREADMARGIN = C.NONSPREADMARGIN,
			MTOMMARGIN = C.MTOMMARGIN,
			EFFNONCASH = C.EFFNONCASH
			--REC_TYPE = 2
	FROM	#CL_LEDGER C
	WHERE	--(LEDBALANCE+PAYREC+MINLEDBAL+SPREADMARGIN+NONSPREADMARGIN+VARMARGIN+MARGIN+AVLCOLL+SPANMAR+TOTCASH+TOTNONCASH+TOTCOLL+MTOMMARGIN+EFFNONCASH) <> 0
			C.CLIENT_CODE = #CLIENTSUMMARY.CLIENT_CODE
			AND REC_TYPE = 1


	IF @RPT_TYPE = 0
	BEGIN
		SELECT	CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE,
				NET_BILL_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES),2)),
				NET_SETT_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES) ELSE 0 END),2)),
				NET_REC_PAYABLE = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES-ISNULL(NONSPREADMARGIN,0)) ELSE 0 END)
									+ SUM(ISNULL(AVLCOLL,0)+ISNULL(SPANMAR,0)+ISNULL(VARMARGIN,0)),2))
		FROM	#CLIENTSUMMARY
		GROUP BY
				CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE
		ORDER BY
				CLIENT_CODE		
		RETURN		
	END
	

	IF @NETPOS_FLAG = 1
	BEGIN
		INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,OPENPOSITION,PROFITORLOSS,REC_TYPE)
		SELECT
			CLIENT_CODE=PARTY_CODE,
			INST_TYPE, SYMBOL, 
			EXPIRYDATE = LEFT(EXPIRYDATE,11), 
			STRIKE_PRICE, 
			OPTION_TYPE, 
			OPENPOSITION = SUM(PQTY-SQTY),
			PROFITORLOSS = SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),
			REC_TYPE = 2
		FROM
			#FOBILLVALAN (NOLOCK)
		GROUP BY
			PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE			
		HAVING SUM(PQTY-SQTY) <> 0
	END
		

	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,SYMBOL,S_SPANMARGIN,S_PREMIUM,S_ADDMARGINPERC,S_TOTALMARGIN,E_MARGINPERC,E_MARGINAMT,REC_TYPE)
	SELECT
		CLIENT_CODE = ISNULL(S_PARTY_CODE,E_PARTY_CODE),
		--PARTYNAME = ISNULL(S_PARTYNAME,E_PARTYNAME),
		SYMBOL = ISNULL(S_SYMBOL,E_SYMBOL),
		S_SPANMARGIN =ISNULL(S_SPANMARGIN,0),
		S_PREMIUM = ISNULL(S_PREMIUM,0),
		S_ADDMARGINPERC = ISNULL(S_ADDMARGINPERC,0),
		S_TOTALMARGIN = ISNULL(S_TOTALMARGIN,0),
		E_MARGINPERC = ISNULL(E_MARGINPERC,0),
		E_MARGINAMT = ISNULL(E_MARGINAMT,0),
		REC_TYPE = 3
	FROM 
		(
		SELECT
			S_PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE,
			--S_PARTYNAME = LONG_NAME,
			S_SYMBOL = REPLACE(FOMARGIN_SPAN.SYMBOL,'&AMP;','&'),
			S_SPANMARGIN = SPANMARGIN,
			S_PREMIUM = PREMIUM,
			S_ADDMARGINPERC = PMARGINRATE,
			S_TOTALMARGIN = TOTALMARGIN
		FROM
			FOMARGIN_SPAN (NOLOCK) 
		WHERE
			MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_SPAN.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND FOMARGIN_SPAN.CL_TYPE ='CL'
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_SPAN.PARTY_CODE)
		) FOMRG

	FULL OUTER JOIN 
		(
		SELECT
			E_PARTY_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE,
			--E_PARTYNAME = LONG_NAME,
			E_SYMBOL = SYMBOL,
			E_MARGINPERC = MARGIN_PERC,
			E_MARGINAMT = MARGINAMT
		FROM
			FOMARGIN_EXP_DETAILS (NOLOCK)
		WHERE
			SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_EXP_DETAILS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE)
		) EXPMRG
		ON (E_PARTY_CODE = S_PARTY_CODE AND E_SYMBOL = S_SYMBOL)
	ORDER BY 1,3
	
	SELECT * FROM #CLIENTSUMMARY
	ORDER BY CLIENT_CODE, REC_TYPE
	
	DROP TABLE #FOBILLVALAN
	DROP TABLE #CLIENTSUMMARY
	DROP TABLE #CL_LEDGER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_SAUDA_SUMMARY_RPT
-- --------------------------------------------------
CREATE PROC [dbo].[CLS_SAUDA_SUMMARY_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@FROMSCRIP VARCHAR(20),
	@TOSCRIP VARCHAR (20), 		
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25),
	@REPORTTYPE INT=1,
	@REPORT_BY VARCHAR(10)='PARTY',
	@INST_TYPE VARCHAR(7) ='',
	@EXPIRYDATE VARCHAR(11) ='',
	@OPTION_TYPE VARCHAR(2) ='',
	@STRIKE_PRICE MONEY =0
)  AS

/*
	@REPORTTYPE = 1 : PARTY / SCRIP WISE SUMMARY
	@REPORTTYPE = 2 : PARTY + SCRIP / SCRIP + PARTY
	@REPORTTYPE = 3 : PARTY + SCRIP + SAUDA_DATE / SCRIP + PARTY + SAUDA_DATE 
	
	@REPORT_BY : PARTY / SCRIP

*/

/*SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)*/

  IF LEN(@DATEFROM) = 10 AND CHARINDEX('/',@DATEFROM) > 0    
  SET @DATEFROM=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @DATEFROM,103),109)
  
  IF LEN(@DATETO) = 10 AND CHARINDEX('/',@DATETO) > 0    
  SET @DATETO=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @DATETO,103),109) 




IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF @TOSCRIP =''
SET @TOSCRIP ='ZZZZZZZ'

DECLARE @OPENDATE VARCHAR(11)
SELECT @OPENDATE= CONVERT(VARCHAR,MIN(SAUDA_DATE),109) FROM FOBILLVALAN  (NOLOCK) WHERE SAUDA_DATE >=  @DATEFROM 



SELECT 
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),
	PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME,
	SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS  EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,	
	(SUM(CASE WHEN CONVERT(VARCHAR,SAUDA_DATE,103) = @OPENDATE AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) AS OPENQTY,
	TRADETYPE, 	
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) AS PQTY, 
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) AS SQTY, 
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) AS PAMT, 	 	
	(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) / 
	SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) AS PRATE,	
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) AS SAMT,	
	(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) / 
	SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) AS SRATE,	
	SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) AS NETQTY,	
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) AS NETAMT,	
	(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) THEN 
	SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*PRATE)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) WHEN  
	SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*SRATE)/
	SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) ELSE 0 END)AS AVGPRICE,	
	(SUM(CASE WHEN SAUDA_DATE =@OPENDATE AND  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - 
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) AS CLOSEQTY,	
	(CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY))
	ELSE 0 END )AS CLOSEPRICE 		
INTO #SAUDA_SUMMARY	
FROM FOBILLVALAN (NOLOCK)
WHERE
	SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' 
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP
	AND PQTY +SQTY > 0 
	AND INST_TYPE = CASE WHEN @INST_TYPE = '' THEN INST_TYPE ELSE @INST_TYPE END
	AND EXPIRYDATE = CASE WHEN @EXPIRYDATE = '' THEN EXPIRYDATE ELSE LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11) + ' 23:59' END
	AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '' THEN OPTION_TYPE ELSE @OPTION_TYPE END
	AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
	AND 'BROKER' = 		
	(CASE
		WHEN 'BROKER' = 'BRANCH' THEN BRANCH_CODE
		WHEN 'BROKER' = 'SUBBROKER' THEN SUB_BROKER
		WHEN 'BROKER' = 'TRADER' THEN TRADER
		WHEN 'BROKER' = 'FAMILY' THEN FAMILY
		WHEN 'BROKER' = 'AREA' THEN AREA
		WHEN 'BROKER' = 'REGION' THEN REGION
		WHEN 'BROKER' = 'CLIENT' THEN PARTY_CODE 
		ELSE 'BROKER' 
	END)
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE ,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,TRADETYPE  

IF @REPORTTYPE = 1  -- SUMMARY
BEGIN
	IF @REPORT_BY = 'PARTY'
	BEGIN
		SELECT SAUDA_DATE='',CLIENT_CODE=PARTY_CODE ,CLIENT_NAME=PARTY_NAME ,INST_TYPE='',SYMBOL='',EXP_DATE='',STRIKE_PRICE=0,OPTION_TYPE='',
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT),2)),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		--CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT)/SUM(CASE WHEN PQTY>0 THEN PQTY ELSE 1 END),2)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)),
		--SRATE = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT)/SUM(CASE WHEN SQTY>0 THEN SQTY ELSE 1 END),2)),
        SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
	    NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)), 
	    AVGPRICE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) 
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) 
		WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)
		ELSE 0 END)),
		CLOSEQTY = SUM(CLOSEQTY)--,CLOSEPRICE = 0	
		FROM #SAUDA_SUMMARY
		GROUP BY PARTY_CODE,PARTY_NAME
		ORDER BY 1,2,3,4,5
	END
	ELSE
	BEGIN
		SELECT SAUDA_DATE='',CLIENT_CODE='',CLIENT_NAME='',SYMBOL,INST_TYPE,EXP_DATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT),2)),
		--PRATE = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT)/SUM(CASE WHEN PQTY>0 THEN PQTY ELSE 1 END),2)),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)) ,
		SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
		--CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT)/SUM(CASE WHEN SQTY>0 THEN SQTY ELSE 1 END),2)),
		NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)) ,
		AVGPRICE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) 
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) 
		WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)
		ELSE 0 END)),
		CLOSEQTY = SUM(CLOSEQTY)--,CLOSEPRICE =0
		FROM #SAUDA_SUMMARY
		GROUP BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
		ORDER BY 1,2,3,4,5
	END
END

IF @REPORTTYPE = 2  -- DETAILS
BEGIN
		SELECT SAUDA_DATE='',CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,SYMBOL,INST_TYPE,EXP_DATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT),2)),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)) ,
		SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
		
		NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)),
		AVGPRICE =  CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) 
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) 
		WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)
		ELSE 0 END)),
		CLOSEQTY = SUM(CLOSEQTY),
		CLOSEPRICE = CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END
		FROM #SAUDA_SUMMARY
		GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END
		HAVING SUM(PQTY+SQTY)<>0
		ORDER BY 1,2,3,4,5
END

IF @REPORTTYPE = 3  -- FURTHER DETAILS
BEGIN
		SELECT SAUDA_DATE,CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,SYMBOL,INST_TYPE,EXP_DATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)) ,
		SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
		NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT)>SUM(SAMT) THEN SUM(PAMT)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END END),
		CLOSEQTY = SUM(CLOSEQTY),
		CLOSEPRICE
		FROM #SAUDA_SUMMARY
		GROUP BY SAUDA_DATE,PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		HAVING SUM(PQTY+SQTY)<>0
		ORDER BY 1,2,3,4,5
END


DROP TABLE #SAUDA_SUMMARY

/*----------------------------------- END OF THE PROC -------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_STTANNEXURE
-- --------------------------------------------------

CREATE PROC [DBO].[CLS_STTANNEXURE]
	(  
	@FROMDATE	VARCHAR(11),   
	@TODATE		VARCHAR(11),
	@FROMPARTY	VARCHAR(20),   
	@TOPARTY	VARCHAR(20),
	@STATUSID	VARCHAR(15),   
	@STATUSNAME VARCHAR(25),
	@OUT_FLAG	VARCHAR(1) = 'D',
	@RPT_TYPE	INT = 0,
	@CONTRACTNO	VARCHAR(10) = ''
	)  

	AS  
  
	/*
	EXEC DBO.[CLS_STTANNEXURE] @FROMDATE='24/05/2011',@TODATE='24/05/2011',@FROMPARTY='0A143',@TOPARTY='0A143',@STATUSID='BROKER',@STATUSNAME='BROKER',@OUT_FLAG='D',@RPT_TYPE=1,@CONTRACTNO='0000001'
	EXEC [CLS_STTANNEXURE] '01/01/2010','31/12/2014','','ZZZZZZZ','BROKER','BROKER'
	EXEC .[CLS_STTANNEXURE] @FROMDATE='22/07/2011',@TODATE='22/07/2014',@FROMPARTY='',@TOPARTY='',@STATUSID='BROKER',@STATUSNAME='BROKER',@OUT_FLAG='D'
	*/
	
	SET @FROMDATE = LEFT(CONVERT(DATETIME,@FROMDATE,103),11)
	SET @TODATE = LEFT(CONVERT(DATETIME,@TODATE,103),11)
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZZ'
	END

	SELECT	*,
	STRIKE_PRICE=0.00,OPTION_TYPE ='',
	ORD_FLAG=1 
	INTO	#STT_CLIENTDETAIL
	FROM	STT_CLIENTDETAIL (NOLOCK)
	WHERE	PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND	SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
			AND CONTRACTNO = (CASE WHEN @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END)
			AND	SQTYTRD > 0 
			AND	LEN(LTRIM(RTRIM(CONTRACTNO))) > 0
			AND	TOTALSTT > 0

	CREATE INDEX [INDXSTT] ON #STT_CLIENTDETAIL ([PARTY_CODE],[SAUDA_DATE],[CONTRACTNO])
	
	SELECT	PARTY_CODE, COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, COMP_FAX = O.FAX, COMP_EMAIL = O.EMAIL, 
			EXCHANGECODE ='BSE', --ISNULL(EXCHANGECODE, 'NSE'),
			MEMBERCODE,
			LONG_NAME, PAN_GIR_NO,BRANCH_CD, SUB_BROKER, L_ADDRESS1,L_ADDRESS2, L_ADDRESS3, L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,EMAIL=C1.EMAIL,
			MAPIDID = CONVERT(VARCHAR(20),'')
	INTO	#CLIENTMASTER
	FROM	CLIENT1 C1 (NOLOCK),
			CLIENT2 C2 (NOLOCK),
			OWNER O (NOLOCK)		
	WHERE	C1.CL_CODE = C2.CL_CODE
			AND	EXISTS (SELECT DISTINCT PARTY_CODE FROM #STT_CLIENTDETAIL S WHERE S.PARTY_CODE = C2.PARTY_CODE)
			AND	C2.INSURANCE_CHRG = 1 
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'	THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'	THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'	THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'		THEN C1.AREA
				WHEN @STATUSID = 'REGION'	THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'	THEN C2.PARTY_CODE
				ELSE 'BROKER'
			END)

	CREATE INDEX [INDXCLIENT] ON #CLIENTMASTER ([PARTY_CODE])

	IF @RPT_TYPE = 0
	BEGIN
		
		SELECT
			CLIENT_CODE = LTRIM(RTRIM(S.PARTY_CODE)),
			CLIENT_NAME = ISNULL(LONG_NAME,''),
			TRADE_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONTRACT_NO = CONTRACTNO,
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(SUM(TOTALSTT),2)),
			ORD_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,112)
		FROM
			#STT_CLIENTDETAIL S,
			#CLIENTMASTER C
		WHERE
			S.PARTY_CODE = C.PARTY_CODE
		GROUP BY
			LTRIM(RTRIM(S.PARTY_CODE)),
			ISNULL(LONG_NAME,''),
			CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONVERT(VARCHAR(11),SAUDA_DATE,112),
			CONTRACTNO
		ORDER BY
			LTRIM(RTRIM(S.PARTY_CODE)),	
			CONVERT(VARCHAR(11),SAUDA_DATE,112),
			CONTRACT_NO
			
	END
	ELSE
	BEGIN

		UPDATE	#CLIENTMASTER
		SET		MAPIDID = ISNULL(U.MAPIDID, '')
		FROM	UCC_CLIENT U (NOLOCK)
		WHERE	U.PARTY_CODE = #CLIENTMASTER.PARTY_CODE		
		
		/*
		ALTER TABLE #STT_CLIENTDETAIL_NEW
		ALTER COLUMN TRADE_DATE VARCHAR(11)	

		UPDATE #STT_CLIENTDETAIL	
		SET  SAUDA_DATE = (CASE WHEN ORD_FLAG=1 THEN CONVERT(VARCHAR,'TOTAL') ELSE CONVERT(VARCHAR,CONVERT(DATETIME,SAUDA_DATE, 109),103) END)
		*/		

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
		SELECT  
			TRADE_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONTRACT_NO = CONTRACTNO,
			SCRIP_CODE = PRODUCT_CODE + ' ' + SERIES_CODE + ' ' + LEFT(EXPIRYDATE,11) + ' ' + CAST(CAST(STRIKE_PRICE AS NUMERIC(18,2)) AS VARCHAR) + ' ' + OPTION_TYPE ,
			TRD_SELL_QTY = CONVERT(NUMERIC(18,2),ROUND(SQTYTRD,2)), 
			TRD_SELL_PRICE = CONVERT(NUMERIC(18,2),ROUND(TRDPRICE,2)), 
			TRD_SELL_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(SAMTTRD,2)), 
			TRD_SELL_STT = CONVERT(NUMERIC(18,2),ROUND(SSTTTRD,2)), 
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(TOTALSTT,2)),
			CLIENT_CODE = LTRIM(RTRIM(S.PARTY_CODE)),
			CLIENT_NAME = ISNULL(LONG_NAME,''),
			PAN_GIR_NO,
			L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
			MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1 = ADDR1, COMP_ADDRES2 = ADDR2, 
			COMP_CITY = CITY, COMP_ZIP = ZIP, COMP_PHONE = PHONE, COMP_FAX, 
			COMP_EMAIL, EXCHANGECODE, MEMBERCODE,
			ORDDATE = CONVERT(VARCHAR,SAUDA_DATE,112),
			ORD_FLAG
		INTO
			#STT_CLIENTDETAIL_NEW
		FROM  
			#STT_CLIENTDETAIL S (NOLOCK),
			#CLIENTMASTER C (NOLOCK)
		WHERE  
			S.PARTY_CODE = C.PARTY_CODE 


		INSERT INTO #STT_CLIENTDETAIL_NEW
		SELECT
			TRADE_DATE = 'TOTAL',
			CONTRACT_NO = '',
			SCRIP_CODE = '',
			TRD_SELL_QTY = 0, 
			TRD_SELL_PRICE = 0, 
			TRD_SELL_AMOUNT = 0, 
			TRD_SELL_STT = 0, 
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(SUM(TOTAL_STT),2)),
			CLIENT_CODE = LTRIM(RTRIM(CLIENT_CODE)), 
			CLIENT_NAME = '',
			PAN_GIR_NO,
			L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
			MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
			COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
			COMP_EMAIL, EXCHANGECODE, MEMBERCODE,
			ORDDATE = '',
			ORD_FLAG=2
		FROM	
			#STT_CLIENTDETAIL_NEW
		GROUP BY	
				LTRIM(RTRIM(CLIENT_CODE)),
				PAN_GIR_NO,
				L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
				MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
				COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
				COMP_EMAIL,  EXCHANGECODE, MEMBERCODE

		IF @OUT_FLAG NOT IN ('P','D')
		BEGIN
  			ALTER TABLE #STT_CLIENTDETAIL_NEW
			ALTER COLUMN CONTRACT_NO VARCHAR(100)	

  			/*
  			ALTER TABLE #STT_CLIENTDETAIL_NEW
			ALTER COLUMN SCRIP_CODE VARCHAR(100)	
			*/	

  			INSERT INTO #STT_CLIENTDETAIL_NEW
			SELECT
				DISTINCT
				TRADE_DATE = LTRIM(RTRIM(CLIENT_CODE)),
				CONTRACT_NO = ISNULL(CLIENT_NAME,''),
				SCRIP_CODE = '',
				TRD_SELL_QTY = 0, 
				TRD_SELL_PRICE = 0, 
				TRD_SELL_AMOUNT = 0, 
				TRD_SELL_STT = 0, 
				TOTAL_STT = 0,
				CLIENT_CODE = LTRIM(RTRIM(CLIENT_CODE)), 
				CLIENT_NAME = ISNULL(CLIENT_NAME,''),
				PAN_GIR_NO,
				L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
				MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
				COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
				COMP_EMAIL,  EXCHANGECODE, MEMBERCODE,
				ORDDATE = 'HEADER',
				ORD_FLAG=0
			FROM	
				#STT_CLIENTDETAIL_NEW
			WHERE 
				TRADE_DATE <> 'TOTAL'
		END	
			
		SELECT *,REPORT_PERIOD = @FROMDATE + ' - ' + @TODATE FROM #STT_CLIENTDETAIL_NEW
		ORDER BY  
			CLIENT_CODE, 
			ORD_FLAG ASC,
			CONTRACT_NO, 
			ORDDATE, 
			SCRIP_CODE
		
		DROP TABLE #STT_CLIENTDETAIL_NEW
		
	END	

	DROP TABLE #STT_CLIENTDETAIL
	DROP TABLE #CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TURNOVER_RPT
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/*  
EXEC CLS_TURNOVER_RPT '01/01/2010','10/10/2014','','','','','BROKER','BROKER',1,'PARTY','','','',0,'STRIKE','test1'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'PARTY','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2010','10/10/2014','','','','','BROKER','BROKER',3,'PARTY','','','',0,'STRIKE'
  
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',1,'SCRIP','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'SCRIP','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',3,'SCRIP','','','',0,'STRIKE'
*/  
  
CREATE PROC [dbo].[CLS_TURNOVER_RPT]
(  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @FROMPARTY VARCHAR(20),  
 @TOPARTY VARCHAR (20),   
 @FROMSCRIP VARCHAR(20),  
 @TOSCRIP VARCHAR (20),    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25),  
 @REPORTTYPE INT=1,  
 @REPORT_BY VARCHAR(10)='PARTY',  
 @INST_TYPE VARCHAR(7) ='',  
 @EXPIRYDATE VARCHAR(11) ='',  
 @OPTION_TYPE VARCHAR(2) ='',  
 @STRIKE_PRICE MONEY =0,
 @REPORTBY VARCHAR(10) = 'PRICE',
 @USERNAME VARCHAR(25) = ''  
 )  AS  
  
/*  
 @REPORTTYPE = 1 : PARTY / SCRIP WISE SUMMARY  
 @REPORTTYPE = 2 : PARTY + SCRIP / SCRIP + PARTY  
 @REPORTTYPE = 3 : PARTY + SCRIP + SAUDA_DATE / SCRIP + PARTY + SAUDA_DATE   
   
 @REPORT_BY : PARTY / SCRIP  
 EXEC MSAJAG..CLS_GET_CLIENTDETAILS '0','ZZ','BRANCH','HO','TEST1','CL_CODE,BRANCH_CD',''
  
*/  
CREATE TABLE #TEMP_FILTERED_PARTY
(
	PARTY_CD VARCHAR(10)
)


  
SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)  
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)  
  
  
IF @TOPARTY =''  
SET @TOPARTY ='ZZZZZZZ'  
  
IF @TOSCRIP =''  
SET @TOSCRIP ='ZZZZZZZ'  

INSERT INTO #TEMP_FILTERED_PARTY
EXEC MSAJAG..CLS_GET_CLIENTDETAILS @FROMPARTY,@TOPARTY,@STATUSID,@STATUSNAME,@USERNAME,'CL_CODE',''

  
SELECT   
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),  
	PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME,  
	SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,   
	FUTURESTRADEDVALUE = SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'EA'  THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END),
	OPTIONSTRADEDVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*STRIKE_PRICE)+(SQTY*STRIKE_PRICE))) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*(STRIKE_PRICE+PRATE))+(SQTY*(STRIKE_PRICE+SRATE)))) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
		ELSE SUM(CASE WHEN INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
	END), 
	EXCERCISEVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*SRATE) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*STRIKE_PRICE) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*(STRIKE_PRICE+SRATE)) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*STRIKE_PRICE) ELSE 0 END)
		ELSE SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*SRATE) ELSE 0 END)
	END),	
	ASSIGNMENTVALUE = 0,
	CLOSEOUTVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		ELSE SUM(CASE WHEN INST_TYPE LIKE '%FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
	END),
	TOTAL = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'STRIKE'	THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'BOTH'		THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'EXCHG'	THEN (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		ELSE (SUM(CASE WHEN (INST_TYPE LIKE '%FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
			+ (SUM(CASE WHEN (INST_TYPE LIKE '%OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END))
	END),
	BROKERAGE = SUM(PBROKAMT + SBROKAMT),  
	FUT_BROKERAGE = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'FUT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END),
	OPT_BROKERAGE = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'OPT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END),
	SERVICETAX = SUM(SERVICE_TAX-EXSER_TAX), 
	INS_CHRG = SUM(INS_CHRG), 
	TURNOVERTAX = SUM(TURN_TAX),  
	FUT_TURNOVERTAX = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'FUT' THEN (TURN_TAX) ELSE 0 END),  
	OPT_TURNOVERTAX = SUM(CASE WHEN RIGHT(INST_TYPE,3) = 'OPT' THEN (TURN_TAX) ELSE 0 END),  
	SEBITAX = SUM(SEBI_TAX),
	STAMPDUTY = SUM(BROKER_NOTE),
	OTHERCHARGES = SUM(OTHER_CHRG)  
INTO #TURNOVER  
FROM FOBILLVALAN A,#TEMP_FILTERED_PARTY B(NOLOCK)  
WHERE  
 SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'   
 AND A.PARTY_CODE = B.PARTY_CD
 AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP  
 AND INST_TYPE = CASE WHEN @INST_TYPE = '' THEN INST_TYPE ELSE @INST_TYPE END  
 AND EXPIRYDATE = CASE WHEN @EXPIRYDATE = '' THEN EXPIRYDATE ELSE LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11) + ' 23:59' END  
 AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '' THEN OPTION_TYPE ELSE @OPTION_TYPE END  
 AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END  
 AND TRADETYPE = 'BT'  
 
 
 
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE ,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE    
ALTER TABLE #TURNOVER  
ADD SRNO INT IDENTITY(1,1)  
IF @REPORTTYPE = 1  -- SUMMARY  
BEGIN  
 IF @REPORT_BY = 'PARTY'  
 BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE,PARTY_NAME,INST_TYPE='',SYMBOL='',EXPIRYDATE='',STRIKE_PRICE=0,OPTION_TYPE='',  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME  
  --ORDER BY 1,2,3,4,5  
  ORDER BY PARTY_CODE,PARTY_NAME  
 END  
 ELSE  
 BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE='',PARTY_NAME='',INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
  ORDER BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
 END  
END  
  
IF @REPORTTYPE = 2  -- DETAILS  
BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
  ORDER BY 3,4,5 ,6
  --ORDER BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE,PARTY_CODE,PARTY_NAME  
END  
  
IF @REPORTTYPE = 3  -- FURTHER DETAILS  
BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE,PARTY_CODE,PARTY_NAME,INST_TYPE = LTRIM(RTRIM(INST_TYPE)),SYMBOL = LTRIM(RTRIM(SYMBOL)),EXPIRYDATE=LTRIM(RTRIM(EXPIRYDATE)),STRIKE_PRICE=LTRIM(RTRIM(STRIKE_PRICE)),OPTION_TYPE=LTRIM(RTRIM(OPTION_TYPE)),  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE  
  --ORDER BY 1,2,3,4,5  
  ORDER BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE
END  
  
  
DROP TABLE #TURNOVER  
  
/*------------------------------------------ END OF THE PROC -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CONSOLE_LOG
-- --------------------------------------------------

CREATE PROC [DBO].[CONSOLE_LOG](  
           @PARTY_CODE           VARCHAR(10),  
           @NEW_PARTY_CODE       VARCHAR(10),  
           @SAUDA_DATE           VARCHAR(11),  
           @INST_TYPE            VARCHAR(6),  
           @SYMBOL               VARCHAR(12),  
           @EXPIRYDATE           VARCHAR(11),  
           @STRIKE_PRICE         MONEY,  
           @OPTION_TYPE          VARCHAR(2),  
           @ORDER_NO             VARCHAR(20),  
           @TRADE_NO             VARCHAR(20),  
           @SELL_BUY             VARCHAR(1),  
           @CONTRACT_NO          VARCHAR(20),  
           @NEW_CONTRACT_NO      VARCHAR(20),  
           @BROKERAGE            NUMERIC(36,12),  
           @NEW_BROKERAGE        NUMERIC(36,12),  
           @MARKET_RATE          NUMERIC(36,12),  
           @NEW_MARKET_RATE      NUMERIC(36,12),  
           @NET_RATE             NUMERIC(36,12),  
           @NEW_NET_RATE         NUMERIC(36,12),  
           @QTY                  BIGINT,  
           @NEW_QTY              BIGINT,  
           @ROUNDTO              INT,  
           @PARTICIPANT_CODE     VARCHAR(20),  
           @NEW_PARTICIPANT_CODE VARCHAR(20),  
           @USERNAME             VARCHAR(25),  
           @MODULE               VARCHAR(50),  
           @CALLED_FROM          VARCHAR(100))  
  AS  
  IF @SAUDA_DATE <> ''  
     AND PATINDEX('%/%',@SAUDA_DATE) > 0  
    BEGIN  
      SELECT @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)  
    END  
      
  IF @EXPIRYDATE <> ''  
     AND PATINDEX('%/%',@EXPIRYDATE) > 0  
    BEGIN  
      SELECT @EXPIRYDATE = LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11)  
    END  
    
  IF @EXPIRYDATE = '%'  
    SET @EXPIRYDATE = ''  
                        
  INSERT INTO INST_LOG  
  VALUES     (@PARTY_CODE,  
              @NEW_PARTY_CODE,  
              @SAUDA_DATE,  
              @INST_TYPE,  
              @SYMBOL,  
              @EXPIRYDATE,  
              @STRIKE_PRICE,  
              @OPTION_TYPE,  
              @ORDER_NO,  
              @TRADE_NO,  
              @SELL_BUY,  
              @CONTRACT_NO,  
              @NEW_CONTRACT_NO,  
              @BROKERAGE,  
              @NEW_BROKERAGE,  
              @MARKET_RATE,  
              @NEW_MARKET_RATE,  
              @NET_RATE,  
              @NEW_NET_RATE,  
              @QTY,  
              @NEW_QTY,  
              @ROUNDTO,  
              @PARTICIPANT_CODE,  
              @NEW_PARTICIPANT_CODE,  
              @USERNAME,  
              @MODULE,  
              @CALLED_FROM,  
              GETDATE(),  
              '',  
              '',  
              '')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CONSOLIDATETRANS
-- --------------------------------------------------
CREATE  PROC [DBO].[CONSOLIDATETRANS]
(
	@FORMDATA VARCHAR(8000),
	@AFTERBEFORE VARCHAR(1),
	@STATUSNAME VARCHAR(50),
	@MODULE VARCHAR(100)
)
AS

/*---------------------------------------------------------------------------
	PROC NAME   : CONSOLIDATETRANS
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CALLING FOR THE TRADE/FOSETTLEMENT BEFORE & AFTER CONTRACT
				  CONSOLIDATION
BEGIN TRAN
EXEC CONSOLIDATETRANS ',0000066,0A141,,ACC,FUTSTK,29/06/2006,0,,13/06/2006,0,2,1,698.7000,698.77,698.77,|,0000066,0A141,,ACC,FUTSTK,29/06/2006,0,,13/06/2006,0,2,2,710.6600,710.66,710.66,|', 'Y', 'ASHOOKE/BROKER', '/FC.INTERFACE/INNERREPORT.ASPX'
SELECT * FROM FOSETTLEMENT WHERE PARTY_CODE = '0A141' AND SAUDA_DATE LIKE 'JUN 13 2006%' AND SYMBOL = 'ACC'
AND INST_TYPE = 'FUTSTK' AND EXPIRYDATE LIKE 'JUN 29 2006%' AND RESERVED1 = 1 AND SELL_BUY = 1
BEGIN TRAN
UPDATE 	FOSETTLEMENT SET 	DUMMY1 = 1, PRICE = 1123 WHERE 	SAUDA_DATE LIKE 'JUN 13 2006%' 	AND PARTY_CODE = '0A141' 	AND SYMBOL = 'ACC' 	AND INST_TYPE = 'FUTSTK' 	AND EXPIRYDATE LIKE 'JUN 29 2006%' 	AND STRIKE_PRICE = 0.0000 	AND OPTION_TYPE = '' 	AND SELL_BUY = 2 	AND CONTRACTNO = '0000066' 	AND PARTICIPANTCODE =  CASE WHEN '' <> '' THEN '' ELSE PARTICIPANTCODE END 	AND USER_ID = CASE WHEN '' <> '' THEN '' ELSE USER_ID END 	AND ORDER_NO = CASE WHEN '' <> '' THEN '' ELSE ORDER_NO END 	AND TRADE_NO = CASE WHEN '' <> '' THEN '' ELSE TRADE_NO END 



UPDATE 	FOSETTLEMENT SET 	DUMMY1 = 1, PRICE = 123 
WHERE 	SAUDA_DATE LIKE 'JUN 13 2006%' 	
AND PARTY_CODE = '0A141' 	
AND SYMBOL = 'ACC' 	
AND INST_TYPE = 'FUTSTK' 	
AND EXPIRYDATE LIKE 'JUN 29 2006%' 	
AND STRIKE_PRICE = 0.0000 	
AND OPTION_TYPE = '' 	
AND SELL_BUY = 1 	
AND CONTRACTNO = '0000066' 	
AND PARTICIPANTCODE =  CASE WHEN '' <> '' THEN '' ELSE PARTICIPANTCODE END 	AND USER_ID = CASE WHEN '' <> '' THEN '' ELSE USER_ID END 	AND ORDER_NO = CASE WHEN '' <> '' THEN '' ELSE ORDER_NO END 	AND TRADE_NO = CASE WHEN '' <> '' THEN '' ELSE TRADE_NO END 
AND RESERVED1 = 1
BEGIN TRAN
EXEC CONSOLIDATETRANS ',0000001,0A143,,BSX22JUL10C15600,BSXOPT,22/07/2010,15600,C,11/01/2010,1,2,1,|,0000001,0A143,,BSX22JUL10C15600,BSXOPT,22/07/2010,15600,C,11/01/2010,1,2,2,|', 'Y', 'HEMANTT/BROKER', '/FC.INTERFACE/INNERREPORT.ASPX'
ROLLBACK

------------------------------------------------------------------------------*/

DECLARE
  @CONTRACTNO VARCHAR(7),
  @PARTYCODE VARCHAR(10),
  @PARTICIPANT VARCHAR(30),
  @TERMID VARCHAR(30),
  @SYMBOL VARCHAR(20),
  @OPTIONTYPE VARCHAR(3),
  @SAUDADATE VARCHAR(11),
  @EXPIRYDATE VARCHAR(11),
  @INSTYPE VARCHAR(6),
  @ORDERNO VARCHAR(16),
  @TRADENO VARCHAR(14),
  @STRIKEPRICE NUMERIC(18, 4),
  @SELLBUY VARCHAR(1),
  @MKTRATE NUMERIC(18, 4),
  @NEWNETRATE NUMERIC(18, 4),
  @OLDNETRATE NUMERIC(18, 4),
  @RECORD VARCHAR(2000),
  @RECNO INT,
  @OPTION VARCHAR(1), /*0 - TO CONSOLIDATION , 1 - UN CONSOLIDATION*/
  @LEVEL INT,
  @QUERY VARCHAR(8000)

SET @RECNO = 1

WHILE 1 = 1
  BEGIN
   SET @RECORD = .DBO.PIECE(@FORMDATA, '|', @RECNO)
   IF @RECORD IS NOT NULL AND @RECORD <> ''
	  BEGIN		
		SET @LEVEL = CONVERT(INT, LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 12))))
		SET @CONTRACTNO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 2)))
		SET @PARTYCODE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 3)))
		SET @TERMID = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 4)))
		IF @TERMID = '%' BEGIN SET @TERMID = '' END
		SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 5)))
		SET @INSTYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 6)))
		SET @EXPIRYDATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 7)))
		SET @EXPIRYDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EXPIRYDATE, 103), 109)
		SET @STRIKEPRICE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 8))))
		SET @OPTIONTYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 9)))
		SET @SAUDADATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 10)))
		SET @SAUDADATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDADATE, 103), 109)
		SET @OPTION = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 11)))
		SET @SELLBUY = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 13)))
		
		IF @LEVEL = 3 OR @LEVEL = 4
			BEGIN
				SET @ORDERNO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 8)))
				IF @ORDERNO = '%' BEGIN SET @ORDERNO = '' END
			END
		ELSE
			BEGIN
				SET @ORDERNO = ''
			END

		IF @LEVEL = 4
			BEGIN
				SET @TRADENO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 9)))
				IF @TRADENO = '%' BEGIN SET @TRADENO = '' END
			END
		ELSE
			BEGIN
				SET @TRADENO = ''
			END
 	  
		IF @OPTION = '0'
		BEGIN
			SET @MKTRATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 14)))
			SET @NEWNETRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 15))))
			SET @OLDNETRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 16))))
			SET @PARTICIPANT = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 17)))
		END
		IF @OPTION = '1'
		BEGIN
			SET @PARTICIPANT = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 14)))
		END 
		/*SELECT [LEVEL] = @LEVEL, CONTRACTNO = @CONTRACTNO, PARTYCODE = @PARTYCODE, TERMID = @TERMID,
				SYMBOL = @SYMBOL, INSTYPE = @INSTYPE, EXPIRYDATE = @EXPIRYDATE,
				STRIKEPRICE = @STRIKEPRICE, OPTIONTYPE = @OPTIONTYPE, SAUDADATE = @SAUDADATE,
				[OPTION] = @OPTION, SELLBUY = @SELLBUY, ORDERNO = @ORDERNO, TRADENO = @TRADENO, MKTRATE = @MKTRATE,
				NEWNETRATE = @NEWNETRATE, OLDNETRATE = @OLDNETRATE, PARTICIPANT = @PARTICIPANT
		RETURN*/

		IF @OPTION = '0'
		BEGIN
			IF @AFTERBEFORE = 'Y'
			BEGIN
				IF @NEWNETRATE <> @OLDNETRATE
					BEGIN
						EXEC CALCULATE_BROKERAGE  @RECORD
					END
				ELSE
				BEGIN
					PRINT 'CAME HERE'
					UPDATE
						FOSETTLEMENT
					SET
						DUMMY1 = 1, PRICE = @MKTRATE
					 WHERE
						SAUDA_DATE LIKE @SAUDADATE + '%'
						AND PARTY_CODE = @PARTYCODE
						AND SYMBOL = @SYMBOL
						AND INST_TYPE = @INSTYPE
						AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
						AND STRIKE_PRICE = @STRIKEPRICE
						AND OPTION_TYPE = @OPTIONTYPE
						AND SELL_BUY = @SELLBUY
						AND CONTRACTNO = @CONTRACTNO
						AND PARTICIPANTCODE = CASE WHEN @PARTICIPANT <> '' THEN @PARTICIPANT ELSE PARTICIPANTCODE END
						AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END
						AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END
						AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END
						AND RESERVED1 = 1
				END
				EXEC PROC_TRADE_TRANSFER_RECAL @SAUDADATE, @PARTYCODE, @INSTYPE, @SYMBOL, @EXPIRYDATE, @STRIKEPRICE, @OPTIONTYPE
				EXEC STT_CHARGES_FINAL @SAUDADATE, @PARTYCODE, @PARTYCODE, @STATUSNAME
			END
			ELSE
			BEGIN
				UPDATE
					FOTRADE
				SET
					PRICE = @MKTRATE
				WHERE
					PARTY_CODE = @PARTYCODE
					AND SYMBOL = @SYMBOL
					AND INST_TYPE = @INSTYPE
					AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
					AND STRIKE_PRICE = @STRIKEPRICE
					AND OPTION_TYPE = @OPTIONTYPE
					AND SELL_BUY =  @SELLBUY
					AND PARTICIPANTCODE = CASE WHEN @PARTICIPANT <> '' THEN @PARTICIPANT ELSE PARTICIPANTCODE END
					AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END
					AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END
					AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END
			END
		END
		ELSE
		BEGIN
			UPDATE
				FOSETTLEMENT
			SET
				DUMMY1 = 0, PRICE = DUMMY2, STATUS = 11
			WHERE
				SAUDA_DATE LIKE @SAUDADATE + '%'
				AND PARTY_CODE = @PARTYCODE
				AND SYMBOL = @SYMBOL
				AND INST_TYPE = @INSTYPE
				AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
				AND STRIKE_PRICE = @STRIKEPRICE
				AND OPTION_TYPE = @OPTIONTYPE
				AND SELL_BUY =  @SELLBUY
				AND CONTRACTNO =  @CONTRACTNO
				AND PARTICIPANTCODE = CASE WHEN @PARTICIPANT <> '' THEN @PARTICIPANT ELSE PARTICIPANTCODE END
				AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END
				AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END
				AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END
				AND RESERVED1 = 1
		END



		SET @RECNO = @RECNO + 1

		
		INSERT INTO INST_LOG
		(
			PARTY_CODE, NEW_PARTY_CODE, SAUDA_DATE,
			SYMBOL, ORDER_NO, TRADE_NO, SELL_BUY, CONTRACT_NO, NEW_CONTRACT_NO,
			BROKERAGE, NEW_BROKERAGE, MARKET_RATE, NEW_MARKET_RATE, NET_RATE,
			NEW_NET_RATE, QTY, NEW_QTY, PARTICIPANT_CODE, NEW_PARTICIPANT_CODE,
			USERNAME, MODULE, CALLED_FROM, TIMESTAMP, EXTRAFIELD3, EXTRAFIELD4,
			EXTRAFIELD5
		)
		SELECT
			PARTY_CODE = ISNULL(@PARTYCODE, ''),
			NEW_PARTY_CODE = ISNULL(@PARTYCODE, ''),
			SAUDA_DATE = @SAUDADATE,
			SYMBOL = ISNULL(@SYMBOL, ''),
			ORDER_NO = '',
			TRADE_NO = '',
			SELL_BUY = ISNULL(@SELLBUY, ''),
			CONTRACT_NO = ISNULL(@CONTRACTNO, ''),
			NEW_CONTRACT_NO = ISNULL(@CONTRACTNO, ''),
			BROKERAGE = 0,
			NEW_BROKERAGE = 0,
			MARKET_RATE = ISNULL(@MKTRATE, 0),
			NEW_MARKET_RATE = ISNULL(@MKTRATE, 0),
			NET_RATE = ISNULL(@OLDNETRATE, 0),
			NEW_NET_RATE = ISNULL(@NEWNETRATE, 0),
			QTY = 0,
			NEW_QTY = 0,
			PARTICIPANT_CODE = ISNULL(@PARTICIPANT, ''),
			NEW_PARTICIPANT_CODE = '',
			USERNAME = @STATUSNAME,
			MODULE = @MODULE,
			CALLED_FROM = 'CONSOLIDATETRANS_SP',
			TIMESTAMP = GETDATE(),
			EXTRAFIELD3 = '',
			EXTRAFIELD4 = '',
			EXTRAFIELD5 = ''
	END
   ELSE
    BEGIN
     BREAK
    END
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_CLASS_USER
-- --------------------------------------------------


CREATE PROC [dbo].[CREATE_CLASS_USER]  
(
 @FLDAUTO VARCHAR(50),	  
 @USERNAME VARCHAR(25),  
 @PASSWORD VARCHAR(50),  
 @FIRSTNAME VARCHAR(25),  
 @MIDDLENAME VARCHAR(25),  
 @LASTNAME VARCHAR(25),  
 @SEX  VARCHAR(8),  
 @ADD1  VARCHAR(100),  
 @MAILADD2 VARCHAR(100),  
 @PHONE1  VARCHAR(10),  
 @PHONE2  VARCHAR(10),   
 @CATEGORY VARCHAR(10),  
 @ADMIN_AUTO INT,  
 @STNAME  VARCHAR(50),  
 @ADMIN_NAME VARCHAR(30),  
 @IPADD  VARCHAR(20),  
 @PWDEXPIRYDAYS SMALLINT,  
 @USERSTATUS SMALLINT,  
 @ATTEMPTCOUNT SMALLINT,  
 @MAXATTEMPTCOUNT SMALLINT,  
 @ACCESSLEVEL CHAR(1),  
 @LOGINSTATUS SMALLINT,
 @FIRSTLOGIN CHAR(1),	
 @USERIPADDRESS VARCHAR(2000),
 @USERTYPE VARCHAR(25), 	
 @EXCHANGE VARCHAR(3),
 @SEGMENT VARCHAR(20),
 @CREATION_FLAG VARCHAR(3), --All or Single segment
 @ACTION_FLAG VARCHAR(20), -- EDIT OR REGISTER 
 @FLD_MAC_ID VARCHAR(200)
)  
  
AS
DECLARE   
 @@EDIT_FLAG  CHAR(1),  
 @@NEWDATE  VARCHAR(11), 
 @@EXPDATE  VARCHAR(11), 	 
 @@FLDLOG_DATA VARCHAR(8000),  
 @@FLDAUTO  INT,  
 @@FLDAUTO_NEW INT,
 @@FLDADMINAUTO INT,	
 @@ERROR_COUNT BIGINT,  
 @MESSAGE  VARCHAR(200),
 @MOB_ACCESS SMALLINT,
 @RESULT VARCHAR(MAX)


BEGIN TRAN   
/*SELECT top 1 FLDUSERNAME = '12',FLDFIRSTNAME = '54',RESULT = 'PRADNYA & USER CONTROL MASTER NOT POPULATED PROPERLY!',EXCHANGE = '54', SEGMENT = '54'
from tblpradnyausers
ROLLBACK 
RETURN	*/

SET @@NEWDATE = CONVERT(VARCHAR,GETDATE(),109)  
SET @@EXPDATE = CONVERT(VARCHAR,GETDATE() + @PWDEXPIRYDAYS,109)  
/*SELECT 
	@MOB_ACCESS = MOB_ACCESS 
FROM 
	PRADNYA.DBO.ADMIN_INFO*/

IF UPPER(@ACTION_FLAG) = 'EDIT' 
 BEGIN
	SET @@EDIT_FLAG = 'E' 
	SET @@FLDLOG_DATA = '' 
 END
ELSE
 IF UPPER(@ACTION_FLAG) = 'REGISTER' 
  BEGIN
	SET @@EDIT_FLAG = 'A' 
	SET @@FLDLOG_DATA = 'ADDENTRY' 
  END	
ELSE
 IF UPPER(@ACTION_FLAG) = 'DELETE'
  BEGIN
	SET @@EDIT_FLAG = 'D' 
	SET @@FLDLOG_DATA = ''   
  END 

--BEGIN TRY
	IF UPPER(@ACTION_FLAG) = 'EDIT' 
     BEGIN
		
		SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERNAME
	
		SELECT   
		 @@ERROR_COUNT = COUNT(FLDUSERNAME)
		FROM     
		 TBLPRADNYAUSERS (NOLOCK)   
		WHERE  
		 FLDUSERNAME = @USERNAME 
		
		IF @@ERROR_COUNT <> 0    
		BEGIN 
		
		SELECT 
			@@FLDLOG_DATA = FLDPASSWORD +'~'+ 
			CASE WHEN FLDFIRSTNAME = '' THEN '$' ELSE FLDFIRSTNAME END +'~'+
			CASE WHEN FLDMIDDLENAME = '' THEN '$' ELSE FLDMIDDLENAME END +'~'+
			CASE WHEN FLDLASTNAME = '' THEN '$' ELSE FLDLASTNAME END +'~'+
			CASE WHEN FLDSEX = '' THEN '$' ELSE FLDSEX END +'~'+
			CASE WHEN FLDADDRESS1 = '' THEN '$' ELSE FLDADDRESS1 END +'~'+
			CASE WHEN FLDADDRESS2 = '' THEN '$' ELSE FLDADDRESS2 END  +'~'+
			CASE WHEN FLDPHONE1 = '' THEN '$' ELSE FLDPHONE1 END +'~'+
			CASE WHEN FLDPHONE2 = '' THEN '$' ELSE FLDPHONE2 END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDCATEGORY) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDCATEGORY) END+'~'+
			CASE WHEN CONVERT(VARCHAR,PWD_EXPIRY_DATE) = '' THEN '$' ELSE CONVERT(VARCHAR,PWD_EXPIRY_DATE) END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDATTEMPTCNT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDATTEMPTCNT) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDSTATUS) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDSTATUS) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDLOGINFLAG) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDLOGINFLAG) END +'~'+
			CASE WHEN FLDACCESSLVL = '' THEN '$' ELSE FLDACCESSLVL END +'~'+
			CASE WHEN FLDIPADD  = '' THEN '$' ELSE FLDIPADD END+'~'+
			CASE WHEN CONVERT(VARCHAR,FLDTIMEOUT) = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+
			CASE WHEN FLDFIRSTLOGIN = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDFORCELOGOUT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDFORCELOGOUT) END +'~'+
			CASE WHEN FLD_MAC_ID = '' THEN '$' ELSE FLD_MAC_ID END
		FROM 
			TBLPRADNYAUSERS TP, TBLUSERCONTROLMASTER TU 
		WHERE 
			TP.FLDAUTO = FLDUSERID
			AND FLDUSERNAME = @USERNAME 
		
		-- CLASS USER LOG TABLE ------------------------------  
		INSERT INTO   
		TBLPRADNYAUSERS_LOG  
		(  
		FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  
		FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  
		)  
		SELECT  
			FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1,  
			FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, @@NEWDATE, @@EDIT_FLAG, @ADMIN_NAME, @@NEWDATE, @IPADD, @@FLDLOG_DATA  
		FROM   
			TBLPRADNYAUSERS  
		WHERE   
			FLDUSERNAME =@USERNAME  

		INSERT INTO   
			TBLUSERCONTROLMASTER_JRNL   
		SELECT   
			*,@@FLDADMINAUTO,@@NEWDATE   
		FROM   
			TBLUSERCONTROLMASTER  
		WHERE   
			FLDUSERID = @FLDAUTO  
		
		UPDATE 
			TBLPRADNYAUSERS 
		SET 
			FLDUSERNAME = @USERNAME, FLDPASSWORD = @PASSWORD, FLDFIRSTNAME = @FIRSTNAME, FLDMIDDLENAME = @MIDDLENAME,
			FLDLASTNAME = @LASTNAME, FLDSEX = @SEX,	FLDADDRESS1 = @ADD1, FLDADDRESS2 = @MAILADD2, FLDPHONE1 = @PHONE1,
			FLDPHONE2 = @PHONE2, FLDCATEGORY = @CATEGORY, FLDSTNAME = @STNAME, PWD_EXPIRY_DATE = @@EXPDATE, EDIT_FLAG = @@EDIT_FLAG 
		WHERE 
			FLDAUTO = @FLDAUTO
		
		
		UPDATE 
			TBLUSERCONTROLMASTER
		SET
			FLDPWDEXPIRY = @PWDEXPIRYDAYS, FLDMAXATTEMPT = @MAXATTEMPTCOUNT, FLDATTEMPTCNT = @ATTEMPTCOUNT, FLDSTATUS = @USERSTATUS,
			FLDLOGINFLAG = @LOGINSTATUS, FLDACCESSLVL = @ACCESSLEVEL, FLDIPADD = @USERIPADDRESS, FLDFIRSTLOGIN = @FIRSTLOGIN, FLD_MAC_ID = @FLD_MAC_ID
		WHERE 
			FLDUSERID = @FLDAUTO

		SET @RESULT = 'EDITED SUCCESSFULLY'
	  	
		IF @@ERROR = 0
		 BEGIN
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
			SELECT @USERNAME,@FIRSTNAME, @RESULT ,'',''
		 END
		END
 		ELSE
		 BEGIN
			SET @MESSAGE = 'USER DOST NOT EXIST IN SYSTEM!'    
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
			SELECT @USERNAME,@FIRSTNAME, @MESSAGE ,'','' 
		 END 
	 END
   	ELSE	
	 BEGIN
		SELECT   
		 @@ERROR_COUNT = COUNT(FLDUSERNAME)
		FROM     
		 TBLPRADNYAUSERS (NOLOCK)   
		WHERE  
		 FLDUSERNAME =@USERNAME 
		
		IF @@ERROR_COUNT = 0    
		 BEGIN   
				--MAIN CLASS USER TABLE------------------------------  
			INSERT INTO   
			 TBLPRADNYAUSERS  
			(  
			 FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, 
			 FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE,EDIT_FLAG, CREATED_BY, MODIFIED_BY  
			)  
			VALUES  
			(  
			 @USERNAME, @PASSWORD, @FIRSTNAME, @MIDDLENAME, @LASTNAME, @SEX, @ADD1, @MAILADD2, @PHONE1, @PHONE2, @CATEGORY,   
			 @ADMIN_AUTO, @STNAME, @@EXPDATE, @@EDIT_FLAG, @ADMIN_NAME, @ADMIN_NAME   
			)  
		  
			-- CLASS USER LOG TABLE ------------------------------  
			INSERT INTO   
			 TBLPRADNYAUSERS_LOG  
			(  
			 FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  
			 FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  
			)  
			SELECT  
			 FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1,  
			 FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, @@NEWDATE, @@EDIT_FLAG, @ADMIN_NAME, @@NEWDATE, @IPADD, @@FLDLOG_DATA  
			FROM   
			 TBLPRADNYAUSERS  
			WHERE   
			 FLDUSERNAME =@USERNAME  
		 
		 
			SELECT @@FLDAUTO_NEW = FLDAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERNAME
			
			-- USER CONTROL MASTER TABLE -----------------------------  
			INSERT INTO TBLUSERCONTROLMASTER 
				(
				FLDUSERID,
				FLDPWDEXPIRY,
				FLDMAXATTEMPT,
				FLDATTEMPTCNT,
				FLDSTATUS,
				FLDLOGINFLAG,
				FLDACCESSLVL,
				FLDIPADD,
				FLDTIMEOUT,
				FLDFIRSTLOGIN,
				FLDFORCELOGOUT,
				FLD_MAC_ID
				)  
			SELECT   
				A.FLDAUTO, 
				@PWDEXPIRYDAYS, 
				@MAXATTEMPTCOUNT,
				@ATTEMPTCOUNT, 
				@USERSTATUS, 
				0, 
				@ACCESSLEVEL, 
				@USERIPADDRESS, 
				B.FLDTIMEOUT,  
				B.FLDFIRSTLOGIN, 
				B.FLDFORCELOGOUT, 
				@FLD_MAC_ID  
			FROM   
				TBLPRADNYAUSERS A LEFT OUTER JOIN TBLUSERCONTROLMASTER X  
			ON   
				(A.FLDAUTO = X.FLDUSERID), TBLUSERCONTROLGLOBALS B  
			WHERE   
				B.FLDCATEGORYID = A.FLDCATEGORY  
				AND ISNULL(A.FLDAUTO,0) = @@FLDAUTO_NEW  
		   
			--LOG USER CONTROL MASTER TABLE -----------------------------  
			  
			INSERT INTO   
			 TBLUSERCONTROLMASTER_JRNL   
			SELECT   
			 *,@@FLDADMINAUTO,@@NEWDATE   
			FROM   
			 TBLUSERCONTROLMASTER  
			WHERE   
			 FLDUSERID = @FLDAUTO  
		  
			--FOR MOBILE USER 
			/*IF @MOB_ACCESS = 1 AND @USERTYPE = 'CLIENT'
			  BEGIN
				INSERT INTO PRADNYA.DBO.USER_INFO (CLIENTID,USERNAME,LASTNAME,MAILID,STATUS_FLAG,EXCHANGE,SEGMENT,LOGIN_FLAG)
				SELECT 
					FLDUSERNAME, FLDFIRSTNAME, FLDLASTNAME, FLDADDRESS2, 1, EXCHANGE = @EXCHANGE+'', SEGMENT = '|'+@SEGMENT, LOGIN_FLAG = 0 
				FROM 
					TBLPRADNYAUSERS 
				WHERE
					 FLDUSERNAME = @USERNAME  
			  END */  		
			
			SET @RESULT = 'CREATED SUCCESSFULLY..'
	  	
			IF @@ERROR = 0
			 BEGIN
				SELECT  
					FLDUSERNAME, FLDFIRSTNAME, RESULT = @RESULT, EXCHANGE='', SEGMENT = '' INTO #RES 
				FROM 
					TBLPRADNYAUSERS TP, TBLUSERCONTROLMASTER TU
				WHERE
					 FLDUSERNAME = @USERNAME 
					 AND TP.FLDAUTO = TU.FLDUSERID
				
				IF @@ROWCOUNT = 0 
				 BEGIN
					ROLLBACK TRAN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
					SELECT FLDUSERNAME = '',FLDFIRSTNAME = '',RESULT = 'PRADNYA & USER CONTROL MASTER NOT POPULATED PROPERLY!',EXCHANGE = '', SEGMENT = ''
					RETURN	
				 END
				ELSE
				 BEGIN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
					SELECT * FROM #RES
				 END	
			 END 
		  END
		ELSE 
		 BEGIN
			SET @MESSAGE = 'USER ALREADY EXIST IN SYSTEM!'
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)    
			SELECT @USERNAME,'', @MESSAGE ,'','' 
		 END 
	END			
/*END TRY
BEGIN CATCH
	SELECT 
        ERROR_MESSAGE() AS MESSAGE;
		ROLLBACK
END CATCH*/
IF @@ERROR = 0
 BEGIN
	COMMIT TRAN
 END
ELSE
 BEGIN
	ROLLBACK TRAN	
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_CLASS_USER_ALL
-- --------------------------------------------------



CREATE PROC [dbo].[CREATE_CLASS_USER_ALL]
(
	 @FLDAUTO		VARCHAR(50),	  
	 @USERNAME		VARCHAR(25),  
	 @PASSWORD		VARCHAR(50),  
	 @FIRSTNAME		VARCHAR(25),  
	 @MIDDLENAME	VARCHAR(25),  
	 @LASTNAME		VARCHAR(25),  
	 @SEX			VARCHAR(8),  
	 @ADD1			VARCHAR(100),  
	 @MAILADD2		VARCHAR(100),  
	 @PHONE1		VARCHAR(10),  
	 @PHONE2		VARCHAR(10),   
	 @CATEGORY		VARCHAR(10),  
	 @ADMIN_AUTO	INT,  
	 @STNAME		VARCHAR(50),  
	 @ADMIN_NAME	VARCHAR(30),  
	 @IPADD			VARCHAR(20),  
	 @PWDEXPIRYDAYS SMALLINT,  
	 @USERSTATUS	SMALLINT,  
	 @ATTEMPTCOUNT	SMALLINT,  
	 @MAXATTEMPTCOUNT SMALLINT,  
	 @ACCESSLEVEL	CHAR(1),  
	 @LOGINSTATUS	SMALLINT,
	 @FIRSTLOGIN	CHAR(1),	
	 @USERIPADDRESS VARCHAR(2000),
	 @USERTYPE		VARCHAR(25), 	
	 @EXCHANGE		VARCHAR(3),
	 @SEGMENT		VARCHAR(20),
	 @EXCSEG		VARCHAR(MAX),
	 @CREATION_FLAG VARCHAR(10), --All or Single segment
	 @ACTION_FLAG	VARCHAR(20), -- EDIT OR REGISTER 
	 @FLD_MAC_ID	VARCHAR(200)	
)

AS
/*
BEGIN TRAN
[CREATE_CLASS_USER_ALL]  '80662',  'AJAY',  'A8EE7FDD1FA67206',  'Ajay',  'n',  'Sengar',  'MALE',  'mumbai',  'a@c.c',  '46454',  '',  '400',  '2',  'Broker',  'Administrator',  '10.11.12.74',  '30',  2,  0,  6,  'F',  0,  'N',  '10.11.12.74',  'Broker',  
'NSE',  'CAPITAL',  '',  'MULTI',  'Edit',
'10.11.12.74'  

ROLLBACK	
SELECT FLDAUTO_ADMIN FROM [MTSRVR06\DEV].NSEFO.DBO.TBLADMIN WHERE FLDNAME = 'Broker' 
INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) 
select * from nsefo..tblpradnyausers where fldusername = 'ajay'
EXECUTE CREATE_CLASS_USER_ALL  '',  'All',  'B5A07E53E1EF805D',  'bhrt',  'bhrt',  'bhrt',  'MALE',  'mum',  'a@c.n',  '9898989898',  '9989889898',  '388',  '2',  'Broker',  'Administrator',  '10.11.12.74',  '31',  2,  0,  6,  'F',  0,  'Y',  '',  'Broker',  'NSE',  'CAPITAL',  'BSE~CAPITAL,NSE~CAPITAL,BSE~FUTURES,NSE~FUTURES,',  'Choose',  'Register',  '' 
*/
BEGIN TRY
 CREATE TABLE [DBO].[#DBNAME]  
 (  
	SHAREDB VARCHAR(50),
	SHARESERVER VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10)
 ) ON [PRIMARY]  

 CREATE TABLE [DBO].[#RESULT]  
 (  
	UNAME VARCHAR(50),
	FIRSTNAME VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10),
	RESULT VARCHAR(MAX)
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#ADMIN_AUTO
 (
	ADMIN_AUTO INT	
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#MKCK
 (
	MKCKFLAG INT	
 )

 CREATE TABLE [DBO].#CATNAME
 (
   CAT_NAME VARCHAR(50)	 
 )	
 CREATE TABLE [DBO].#CATEGORY
 (
	CATEGORY VARCHAR(50),
	CATEGORYCODE INT
 ) ON [PRIMARY]
 CREATE TABLE [DBO].#PRADNYA
 (
	FLDAUTO	INT,
	FLDADMINAUTO INT
 )

DECLARE  
 @@SHAREDB VARCHAR(20),	  
 @@SHARESVR VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@ORDERFLAG VARCHAR(1),  
 @@SQL VARCHAR(5000),
 @@DB VARCHAR(MAX),
 @@SEGORD TINYINT,
 @@FLDNAME VARCHAR(30),	
 @@CATFLAG INT,	  
 @@CATNAME VARCHAR(50),
 @@MKCKFLAG INT,
 @@FLDAUTO	INT,
 @@FLDADMINAUTO INT,	 	
 @@MAINREC AS CURSOR  
 

	SELECT @@FLDNAME = FLDNAME FROM TBLADMIN WHERE FLDAUTO_ADMIN = @ADMIN_AUTO
	IF UPPER(@CREATION_FLAG) <> 'SIN'
	 BEGIN	
			SELECT @@CATNAME = FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @CATEGORY
	 END
	
	SET @@DB = " INSERT INTO #DBNAME "   
	SET @@DB = @@DB + " SELECT "
	SET @@DB = @@DB + "		SHAREDB, SHARESERVER, EXCHANGE, SEGMENT "
	SET @@DB = @@DB + " FROM "
	SET @@DB = @@DB + "		PRADNYA.DBO.MULTICOMPANY_ALL (NOLOCK) "
	SET @@DB = @@DB + " WHERE "
	SET @@DB = @@DB + " 	PRIMARYSERVER = 1 "
	IF UPPER(@CREATION_FLAG) = 'CHOOSE'
	 BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ('" + REPLACE(@EXCSEG,',',''',''') + "')  "
	 END
	ELSE
	 IF UPPER(@CREATION_FLAG) = 'SIN'
	  BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ( '"+@EXCHANGE+"' +'~'+ '"+@SEGMENT+"' ) "
      END 
	 		
	SET @@DB = @@DB + " ORDER BY "
	SET @@DB = @@DB + "		EXCHANGE "  

	PRINT @@DB
	EXEC(@@DB)  

	SET @@MAINREC = CURSOR FOR  
	
	SELECT SHAREDB, SHARESERVER, EXCHANGE, SEGMENT FROM #DBNAME  
	SET @@SEGORD = 1  
	
	OPEN @@MAINREC  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT  
		WHILE @@FETCH_STATUS = 0  
		BEGIN 
			IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
					
					IF UPPER(@CREATION_FLAG) = 'SIN'
						BEGIN	
							SET @@SQL = " INSERT INTO #CATNAME SELECT FLDCATEGORYNAME FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYCODE = "+ @CATEGORY +" "
							EXEC(@@SQL)
							SELECT @@CATNAME = CAT_NAME FROM #CATNAME
						END

					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME + "' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
			 ELSE
				BEGIN	

					IF UPPER(@CREATION_FLAG) = 'SIN'
						BEGIN	
							SET @@SQL = " INSERT INTO #CATNAME SELECT FLDCATEGORYNAME FROM " + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYCODE = "+ @CATEGORY +" "
							EXEC(@@SQL)
							SELECT @@CATNAME = CAT_NAME FROM #CATNAME
						END
					
					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
		
			PRINT @@SQL	
			EXEC(@@SQL)

			SELECT @@MKCKFLAG = MKCKFLAG FROM #MKCK
			--SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM #PRADNYA	 				
			SELECT @CATEGORY = CATEGORYCODE FROM #CATEGORY 
			SELECT @ADMIN_AUTO = ADMIN_AUTO FROM #ADMIN_AUTO
			
						
			IF @@ROWCOUNT = 0 
			 BEGIN
				INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','<B><U>'+ @@FLDNAME +'</U></B> ADMIN USER IS NOT AVAILABLE IN THIS EXCH - SEG5','','')
			 END
			ELSE
			 IF (SELECT COUNT(1) FROM #CATEGORY ) = 0
				BEGIN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','USER CATEGORY IS NOT AVAILABLE IN THIS EXCH - SEG6','','')		
				END			
			ELSE
			 BEGIN	
			 --SET @@SQL = " INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) "
			 IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
					SET @@SQL = @@SQL + " EXEC " + @@SHARESVR + "." + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			 ELSE
				BEGIN	
					SET @@SQL = @@SQL + " EXEC " + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			SET @@SQL = @@SQL + "  '" + @FLDAUTO + "' "
			SET @@SQL = @@SQL + ", '" + @USERNAME + "' "
			SET @@SQL = @@SQL + ", '" + @PASSWORD + "' "
			SET @@SQL = @@SQL + ", '" + @FIRSTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @MIDDLENAME + "' "
			SET @@SQL = @@SQL + ", '" + @LASTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @SEX + "' "
			SET @@SQL = @@SQL + ", '" + @ADD1 + "' "
			SET @@SQL = @@SQL + ", '" + @MAILADD2 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE1 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE2 + "' "
			SET @@SQL = @@SQL + ", '" + @CATEGORY + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ADMIN_AUTO) + " "
			SET @@SQL = @@SQL + ", '" + @STNAME + "' "
			SET @@SQL = @@SQL + ", '" + @ADMIN_NAME + "' "
			SET @@SQL = @@SQL + ", '" + @IPADD + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@PWDEXPIRYDAYS) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,CASE WHEN @@MKCKFLAG = 0 THEN 0 ELSE @USERSTATUS END) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@MAXATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ", '" + @ACCESSLEVEL + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@LOGINSTATUS) + " "
			SET @@SQL = @@SQL + ", '" + @FIRSTLOGIN + "' "
			SET @@SQL = @@SQL + ", '" + @USERIPADDRESS + "' "
			SET @@SQL = @@SQL + ", '" + @USERTYPE + "' "
			SET @@SQL = @@SQL + ", '" + @EXCHANGE + "' " 
			SET @@SQL = @@SQL + ", '" + @SEGMENT + "' " 
			SET @@SQL = @@SQL + ", '" + @CREATION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @ACTION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @FLD_MAC_ID + "' " 
			PRINT (@@SQL)
			EXEC(@@SQL)
		   END	

			UPDATE 
				#RESULT
			SET 
				EXCHANGE = @@EXCHANGE,
				SEGMENT = @@SEGMENT
			WHERE 
				EXCHANGE = '' AND SEGMENT = ''
			
			TRUNCATE TABLE #ADMIN_AUTO
			TRUNCATE TABLE #MKCK
			TRUNCATE TABLE #CATEGORY		
	SET @@SEGORD = @@SEGORD + 1  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT
	END 

	SELECT * FROM #RESULT
	TRUNCATE TABLE #DBNAME  
	DROP TABLE #DBNAME
END TRY
BEGIN CATCH
	INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
	SELECT '','',
        ERROR_MESSAGE() AS MESSAGE,'','';
        
        SELECT * FROM #RESULT
--		ROLLBACK
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_CLASS_USER_ALL_BKUP_25Jul2023
-- --------------------------------------------------


CREATE PROC [dbo].[CREATE_CLASS_USER_ALL_BKUP_25Jul2023]
(
	 @FLDAUTO		VARCHAR(50),	  
	 @USERNAME		VARCHAR(25),  
	 @PASSWORD		VARCHAR(50),  
	 @FIRSTNAME		VARCHAR(25),  
	 @MIDDLENAME	VARCHAR(25),  
	 @LASTNAME		VARCHAR(25),  
	 @SEX			VARCHAR(8),  
	 @ADD1			VARCHAR(100),  
	 @MAILADD2		VARCHAR(100),  
	 @PHONE1		VARCHAR(10),  
	 @PHONE2		VARCHAR(10),   
	 @CATEGORY		VARCHAR(10),  
	 @ADMIN_AUTO	INT,  
	 @STNAME		VARCHAR(50),  
	 @ADMIN_NAME	VARCHAR(30),  
	 @IPADD			VARCHAR(20),  
	 @PWDEXPIRYDAYS SMALLINT,  
	 @USERSTATUS	SMALLINT,  
	 @ATTEMPTCOUNT	SMALLINT,  
	 @MAXATTEMPTCOUNT SMALLINT,  
	 @ACCESSLEVEL	CHAR(1),  
	 @LOGINSTATUS	SMALLINT,
	 @FIRSTLOGIN	CHAR(1),	
	 @USERIPADDRESS VARCHAR(2000),
	 @USERTYPE		VARCHAR(25), 	
	 @EXCHANGE		VARCHAR(3),
	 @SEGMENT		VARCHAR(20),
	 @EXCSEG		VARCHAR(MAX),
	 @CREATION_FLAG VARCHAR(10), --All or Single segment
	 @ACTION_FLAG	VARCHAR(20), -- EDIT OR REGISTER 
	 @FLD_MAC_ID	VARCHAR(200)	
)

AS
/*
BEGIN TRAN
[CREATE_CLASS_USER_ALL]  '80662',  'AJAY',  'A8EE7FDD1FA67206',  'Ajay',  'n',  'Sengar',  'MALE',  'mumbai',  'a@c.c',  '46454',  '',  '400',  '2',  'Broker',  'Administrator',  '10.11.12.74',  '30',  2,  0,  6,  'F',  0,  'N',  '10.11.12.74',  'Broker',  
'NSE',  'CAPITAL',  '',  'MULTI',  'Edit',
'10.11.12.74'  

ROLLBACK	
SELECT FLDAUTO_ADMIN FROM [MTSRVR06\DEV].NSEFO.DBO.TBLADMIN WHERE FLDNAME = 'Broker' 
INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) 
select * from nsefo..tblpradnyausers where fldusername = 'ajay'
EXECUTE CREATE_CLASS_USER_ALL  '',  'All',  'B5A07E53E1EF805D',  'bhrt',  'bhrt',  'bhrt',  'MALE',  'mum',  'a@c.n',  '9898989898',  '9989889898',  '388',  '2',  'Broker',  'Administrator',  '10.11.12.74',  '31',  2,  0,  6,  'F',  0,  'Y',  '',  'Broker',  'NSE',  'CAPITAL',  'BSE~CAPITAL,NSE~CAPITAL,BSE~FUTURES,NSE~FUTURES,',  'Choose',  'Register',  '' 
*/
BEGIN TRY
 CREATE TABLE [DBO].[#DBNAME]  
 (  
	SHAREDB VARCHAR(50),
	SHARESERVER VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10)
 ) ON [PRIMARY]  

 CREATE TABLE [DBO].[#RESULT]  
 (  
	UNAME VARCHAR(50),
	FIRSTNAME VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10),
	RESULT VARCHAR(MAX)
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#ADMIN_AUTO
 (
	ADMIN_AUTO INT	
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#MKCK
 (
	MKCKFLAG INT	
 )
	
 CREATE TABLE [DBO].#CATEGORY
 (
	CATEGORY VARCHAR(50),
	CATEGORYCODE INT
 ) ON [PRIMARY]
 CREATE TABLE [DBO].#PRADNYA
 (
	FLDAUTO	INT,
	FLDADMINAUTO INT
 )

DECLARE  
 @@SHAREDB VARCHAR(20),	  
 @@SHARESVR VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@ORDERFLAG VARCHAR(1),  
 @@SQL VARCHAR(5000),
 @@DB VARCHAR(MAX),
 @@SEGORD TINYINT,
 @@FLDNAME VARCHAR(30),	
 @@CATFLAG INT,	  
 @@CATNAME VARCHAR(50),
 @@MKCKFLAG INT,
 @@FLDAUTO	INT,
 @@FLDADMINAUTO INT,	 	
 @@MAINREC AS CURSOR  
 

	SELECT @@FLDNAME = FLDNAME FROM TBLADMIN WHERE FLDAUTO_ADMIN = @ADMIN_AUTO
	SELECT @@CATNAME = FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @CATEGORY
	
	SET @@DB = " INSERT INTO #DBNAME "   
	SET @@DB = @@DB + " SELECT "
	SET @@DB = @@DB + "		SHAREDB, SHARESERVER, EXCHANGE, SEGMENT "
	SET @@DB = @@DB + " FROM "
	SET @@DB = @@DB + "		PRADNYA.DBO.MULTICOMPANY (NOLOCK) "
	SET @@DB = @@DB + " WHERE "
	SET @@DB = @@DB + " 	PRIMARYSERVER = 1 "
	IF UPPER(@CREATION_FLAG) = 'CHOOSE'
	 BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ('" + REPLACE(@EXCSEG,',',''',''') + "')  "
	 END
	ELSE
	 IF UPPER(@CREATION_FLAG) = 'SIN'
	  BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ( '"+@EXCHANGE+"' +'~'+ '"+@SEGMENT+"' ) "
      END 
	 		
	SET @@DB = @@DB + " ORDER BY "
	SET @@DB = @@DB + "		EXCHANGE "  

	PRINT @@DB
	EXEC(@@DB)  

	SET @@MAINREC = CURSOR FOR  
	
	SELECT SHAREDB, SHARESERVER, EXCHANGE, SEGMENT FROM #DBNAME  
	SET @@SEGORD = 1  
	
	OPEN @@MAINREC  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT  
		WHILE @@FETCH_STATUS = 0  
		BEGIN 
			IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
					
					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME + "' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
			 ELSE
				BEGIN	
					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
		
			PRINT @@SQL	
			EXEC(@@SQL)

			SELECT @@MKCKFLAG = MKCKFLAG FROM #MKCK
			--SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM #PRADNYA	 				
			SELECT @CATEGORY = CATEGORYCODE FROM #CATEGORY 
			SELECT @ADMIN_AUTO = ADMIN_AUTO FROM #ADMIN_AUTO
			
						
			IF @@ROWCOUNT = 0 
			 BEGIN
				INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','ADMINISTRATOR IS NOT AVAILABLE IN THIS EXCH - SEG','','')
			 END
			ELSE
			 IF (SELECT COUNT(1) FROM #CATEGORY ) = 0
				BEGIN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','USER CATEGORY IS NOT AVAILABLE IN THIS EXCH - SEG','','')		
				END			
			ELSE
			 BEGIN	
			 --SET @@SQL = " INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) "
			 IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
					SET @@SQL = @@SQL + " EXEC " + @@SHARESVR + "." + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			 ELSE
				BEGIN	
					SET @@SQL = @@SQL + " EXEC " + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			SET @@SQL = @@SQL + "  '" + @FLDAUTO + "' "
			SET @@SQL = @@SQL + ", '" + @USERNAME + "' "
			SET @@SQL = @@SQL + ", '" + @PASSWORD + "' "
			SET @@SQL = @@SQL + ", '" + @FIRSTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @MIDDLENAME + "' "
			SET @@SQL = @@SQL + ", '" + @LASTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @SEX + "' "
			SET @@SQL = @@SQL + ", '" + @ADD1 + "' "
			SET @@SQL = @@SQL + ", '" + @MAILADD2 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE1 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE2 + "' "
			SET @@SQL = @@SQL + ", '" + @CATEGORY + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ADMIN_AUTO) + " "
			SET @@SQL = @@SQL + ", '" + @STNAME + "' "
			SET @@SQL = @@SQL + ", '" + @ADMIN_NAME + "' "
			SET @@SQL = @@SQL + ", '" + @IPADD + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@PWDEXPIRYDAYS) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,CASE WHEN @@MKCKFLAG = 0 THEN 0 ELSE @USERSTATUS END) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@MAXATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ", '" + @ACCESSLEVEL + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@LOGINSTATUS) + " "
			SET @@SQL = @@SQL + ", '" + @FIRSTLOGIN + "' "
			SET @@SQL = @@SQL + ", '" + @USERIPADDRESS + "' "
			SET @@SQL = @@SQL + ", '" + @USERTYPE + "' "
			SET @@SQL = @@SQL + ", '" + @EXCHANGE + "' " 
			SET @@SQL = @@SQL + ", '" + @SEGMENT + "' " 
			SET @@SQL = @@SQL + ", '" + @CREATION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @ACTION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @FLD_MAC_ID + "' " 
			PRINT (@@SQL)
			EXEC(@@SQL)
		   END	

			UPDATE 
				#RESULT
			SET 
				EXCHANGE = @@EXCHANGE,
				SEGMENT = @@SEGMENT
			WHERE 
				EXCHANGE = '' AND SEGMENT = ''
			
			TRUNCATE TABLE #ADMIN_AUTO
			TRUNCATE TABLE #MKCK
			TRUNCATE TABLE #CATEGORY		
	SET @@SEGORD = @@SEGORD + 1  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT
	END 

	SELECT * FROM #RESULT
	TRUNCATE TABLE #DBNAME  
	DROP TABLE #DBNAME
END TRY
BEGIN CATCH
	INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
	SELECT '','',
        ERROR_MESSAGE() AS MESSAGE,'','';
        
        SELECT * FROM #RESULT
		ROLLBACK
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEMENU
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[CREATEMENU]   
(  
 @FLDREPORTNAME VARCHAR (35),  
 @FLDPATH VARCHAR (500)  
)  AS
  
SET @FLDPATH = UPPER(REPLACE(@FLDPATH,'\','/'))  
   
IF (SELECT COUNT(1) FROM TBLREPORTS (NOLOCK) WHERE FLDPATH =@FLDPATH) = 0  
BEGIN  
 DECLARE @INTMNUGRP INT  
 DECLARE @INTREPORTGRP INT  
   
 SET @INTMNUGRP = 7  
 SET @INTREPORTGRP = 0  
   
 SELECT @INTMNUGRP = FLDMENUCODE FROM TBLMENUHEAD (NOLOCK) WHERE FLDMENUNAME ='UTILITIES'  
 SELECT @INTREPORTGRP = MAX(FLDREPORTGRP) FROM TBLREPORTGRP (NOLOCK) WHERE FLDMENUGRP = @INTMNUGRP  
 SELECT TOP 1 @INTREPORTGRP= FLDREPORTGRP FROM TBLREPORTGRP (NOLOCK) WHERE FLDMENUGRP = @INTMNUGRP AND FLDGRPNAME LIKE '%UTILITIES%'  
   
 INSERT INTO TBLREPORTS  
 SELECT   
  FLDREPORTNAME=@FLDREPORTNAME,  
  FLDPATH=@FLDPATH,  
  FLDTARGET= LOWER('FRA') +'T' + LOWER('OPIC'),  
  FLDDESC =@FLDREPORTNAME,  
  FLDREPORTGRP=@INTREPORTGRP,  
  FLDMENUGRP=@INTMNUGRP,  
  FLDSTATUS='A'+ LOWER('LL'),  
  FLDORDER=0  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELETE_CLASS_USER_ALL
-- --------------------------------------------------

CREATE PROC [dbo].[DELETE_CLASS_USER_ALL]
(
	@UNAME		VARCHAR(30),
	@EXCSEG		VARCHAR(MAX),
	@IPADD		VARCHAR(20),
	@ADMIN_NAME VARCHAR(50)    

)
AS
/*
SELECT * FROM TBLPRADNYAUSERS
select * from TBLUSERCONTROLMASTER_JRNL
MXM~FUTURES,NMC~FUTURES,NSE~CAPITAL,
EXEC DELETE_CLASS_USER_ALL 'ASASD', 'BCM~FUTURES,BSE~CAPITAL,NSE~CAPITAL,NXM~FUTURES,', '10.11.12.74', 'Administrator'
SP_HELPTEXT ADMIN_DELUSER
INSERT INTO #USER_AUTO 
SELECT FLDAUTO FROM [MTSRVR06\DEV].MCDXCDSPCM.DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DS' 
*/
DECLARE  
 @@SHAREDB VARCHAR(20),
 @@SHARESVR VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@SQL VARCHAR(MAX),
 @@DB VARCHAR(MAX),
 @@SEGORD TINYINT,
 @@FLDAUTO INT,
 @ADMINID INT,
 @GLOBALDATE DATETIME,  
 @@MAINREC AS CURSOR  

 CREATE TABLE [DBO].[#DBNAME]  
 (  
	SHAREDB VARCHAR(50),
	SHARESERVER VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10)
 ) ON [PRIMARY]  

 CREATE TABLE [DBO].#USER_AUTO
 (
	FLDAUTO INT	
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#RESULT
 (
	UNAME VARCHAR(30),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10),
	MSG VARCHAR(100)	
 )	
	SET @GLOBALDATE = GETDATE()  

	SET @@DB = " INSERT INTO #DBNAME "   
	SET @@DB = @@DB + " SELECT "
	SET @@DB = @@DB + "		SHAREDB, SHARESERVER, EXCHANGE, SEGMENT "
	SET @@DB = @@DB + " FROM "
	SET @@DB = @@DB + "		PRADNYA.DBO.MULTICOMPANY (NOLOCK) "
	SET @@DB = @@DB + " WHERE "
	SET @@DB = @@DB + " 	PRIMARYSERVER = 1 "
	SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ('" + REPLACE(@EXCSEG,',',''',''') + "')  "
	SET @@DB = @@DB + " ORDER BY "
	SET @@DB = @@DB + "		EXCHANGE "  
	PRINT @@DB
	EXEC(@@DB) 

	SET @@MAINREC = CURSOR FOR  
	SELECT SHAREDB, SHARESERVER, EXCHANGE, SEGMENT FROM #DBNAME  

	SET @@SEGORD = 1  
	
	OPEN @@MAINREC  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT  
		WHILE @@FETCH_STATUS = 0  
		BEGIN 
			IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
				
					SET @@SQL = " INSERT INTO #USER_AUTO SELECT FLDAUTO FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "
					EXEC(@@SQL)

					SELECT @@FLDAUTO = FLDAUTO FROM #USER_AUTO	
					
					SET @@SQL = " INSERT INTO " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG(FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA)  "
					SET @@SQL = @@SQL + " SELECT "
					SET @@SQL = @@SQL + " 	FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, 'D', '"+@ADMIN_NAME+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"', '"+@IPADD+"', 'DELETEENTRY' "
			  		SET @@SQL = @@SQL + " FROM "
					SET @@SQL = @@SQL + " 	" + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS  "
					SET @@SQL = @@SQL + "  WHERE  "
					SET @@SQL = @@SQL + " 	FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
					
					SET @@SQL = @@SQL + " INSERT INTO " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER_JRNL(FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, FLDUPDTBY, FLDUPDTDT)  "
					SET @@SQL = @@SQL + " SELECT   "
					SET @@SQL = @@SQL + " 	  FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, '"+@IPADD+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"' "
					SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + "   " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TBC  "
					SET @@SQL = @@SQL + " WHERE   "
					SET @@SQL = @@SQL + "   FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
    
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDAUTO = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER WHERE FLDUSERID = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
				END
			 ELSE
				BEGIN
					SET @@SQL = " INSERT INTO #USER_AUTO SELECT FLDAUTO FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "	
					EXEC(@@SQL)

					SELECT @@FLDAUTO = FLDAUTO FROM #USER_AUTO

					SET @@SQL = " INSERT INTO " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG(FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA)  "
					SET @@SQL = @@SQL + " SELECT "
					SET @@SQL = @@SQL + " 	FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, 'D', '"+@ADMIN_NAME+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"', '"+@IPADD+"', 'DELETEENTRY' "
			  		SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + " 	" + @@SHAREDB + ".DBO.TBLPRADNYAUSERS  "
					SET @@SQL = @@SQL + "  WHERE   "
					SET @@SQL = @@SQL + " 	FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "

					SET @@SQL = @@SQL + " INSERT INTO " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER_JRNL(FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, FLDUPDTBY, FLDUPDTDT)  "
					SET @@SQL = @@SQL + " SELECT   "
					SET @@SQL = @@SQL + " 	  FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, '"+@IPADD+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"' "
					SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + "   " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER   "
					SET @@SQL = @@SQL + " WHERE   "
					SET @@SQL = @@SQL + "   FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" "

					SET @@SQL = @@SQL + " DELETE FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDAUTO = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER WHERE FLDUSERID = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
				END
			--PRINT @@SQL	
			EXEC(@@SQL)
			IF @@ERROR = 0
			BEGIN
				INSERT INTO #RESULT VALUES (@UNAME,@@EXCHANGE,@@SEGMENT,'DELETED SUCCESSFULLY')
			END	

 SET @@SEGORD = @@SEGORD + 1  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT
	END 

IF @@ERROR = 0
 BEGIN
	SELECT * FROM #RESULT
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_BILL_REPORT
-- --------------------------------------------------

CREATE PROC DELIVERY_BILL_REPORT   
 (    
  @DATEFROM VARCHAR(11),     
  @DATETO VARCHAR(11),
  @PARTYFROM VARCHAR(10),     
  @PARTYTO VARCHAR(10), 
  @STATUSID VARCHAR(15),     
  @STATUSNAME VARCHAR(25),    
  @STRBRANCH VARCHAR(12),    
  @STRSUBBROKFROM VARCHAR(12),    
  @STRSUBBROKTO VARCHAR(12)    
 )    
    
AS    
    
IF @PARTYTO=''    
  BEGIN    
 SET @PARTYTO='ZZZZZZZZZZ'    
  END    
    
IF @STRSUBBROKTO=''    
  BEGIN    
      SET @STRSUBBROKTO='ZZZZZZZZZZ'    
  END    
    
SELECT    
 COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE,    
 F.PARTY_CODE, LONG_NAME, PAN_GIR_NO,     
 LEFT (CONVERT(VARCHAR, SAUDA_DATE, 103),13) SAUDA_DATE,     
 SEC_NAME=BSECODE,    
 LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,109),11) AS EXPIRYDATE,     
 TYPE = (CASE WHEN SELL_BUY = 1 THEN 'BUY'  ELSE 'SELL' END),     
 TRADEQTY = DEL_QTY,    
 PRICE = DEL_PRICE,    
 (DEL_QTY*DEL_PRICE) AMOUNT,F.SERVICE_TAX,FOGLOBALS.SERVICE_TAX SRTAXPER,    
 BROKAPPLIED=BROKERAGE,  
 SETT_TYPE,SETT_NO=SETT_NO   
FROM    
 FOOWNER (NOLOCK), 
 FOGLOBALS (NOLOCK), 
 CLIENT1 C1 (NOLOCK), 
 CLIENT2 C2 (NOLOCK),     
 DELIVERY_POSITION F  (NOLOCK) 
WHERE      
 F.PARTY_CODE = C2.PARTY_CODE AND     
 C1.CL_CODE = C2.CL_CODE AND     
 F.PARTY_CODE >= @PARTYFROM AND    
 F.PARTY_CODE <= @PARTYTO AND     
 F.SAUDA_DATE >= @DATEFROM AND     
 F.SAUDA_DATE <= @DATETO AND
 BRANCH_CD LIKE @STRBRANCH +'%' AND    
 SUB_BROKER BETWEEN  @STRSUBBROKFROM  AND  @STRSUBBROKTO AND    
 SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND            
   
 BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END) AND     
 SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END) AND     
 TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END) AND     
 C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)  AND     
 C1.CL_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)    
    
ORDER BY SETT_TYPE,SETT_NO ,SAUDA_DATE, F.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_VALANGENERATE
-- --------------------------------------------------

CREATE  PROC DELIVERY_VALANGENERATE
( 
	@SAUDA_DATE VARCHAR(11),
	@UNAME VARCHAR(20)
) AS      
      
DECLARE      
@@ACNAME VARCHAR(50),      
@@ACCODE VARCHAR(50),      
@@CLRHSGPARTY VARCHAR(10),      
@@RNDOFFPARTY VARCHAR(10),      
@@SERTAXPARTY VARCHAR(10),      
@@BRKRELPARTY VARCHAR(10),      
@@INSSERTAXPARTY VARCHAR(10),      
@@CESSTAXPARTY VARCHAR(10),      
@@CESSTAXPAYPARTY VARCHAR(10),      
@@EDUCESSTAXPARTY VARCHAR(10),      
@@EDUCESSTAXPAYPARTY VARCHAR(10),      
@@BRKNOTEPARTY VARCHAR(10),  
@@BRANCH_CD VARCHAR(10),              
@@SAUDA_DATE DATETIME,      
@@SELL_BUY INT ,      
@@MTOM NUMERIC(18,6),      
@@BROKAMT NUMERIC(18,6),         
@@SERTAX NUMERIC(18,6),      
@@EXSERTAX  NUMERIC(18,6),      
@@NETMTOM NUMERIC(18,6),      
@@NETBROKAMT NUMERIC(18,6),         
@@NETSERTAX NUMERIC(18,6),      
@@NETEXSERTAX  NUMERIC(18,6),      
@@TCESS_TAX NUMERIC(18,6),      
@@TEDUCESS_TAX NUMERIC(18,6),      
@@TEXSERVICE_TAX NUMERIC(18,6),      
@@TEXCESS_TAX NUMERIC(18,6),      
@@TEXEDUCESS_TAX NUMERIC(18,6),      
@@NETCESS_TAX NUMERIC(18,6),      
@@NETEDUCESS_TAX NUMERIC(18,6),      
@@NETEXCESS_TAX NUMERIC(18,6),      
@@NETEXEDUCESS_TAX NUMERIC(18,6),      
@@SERVICE_CHRG NUMERIC(18,6),      
@@CESS_CHRG NUMERIC(18,6),      
@@EDUCESS_CHRG NUMERIC(18,6),      
@@GROSSDIFFAMT NUMERIC(18,6),      
@@TSERVICE_TAX NUMERIC (18,9),      
@@DIFFAMT NUMERIC(18,6),      
@@EXPIRYDATE DATETIME,      
@@PAYINDATE DATETIME,      
@@PAYOUTDATE DATETIME,      
@@VALANACCCUR CURSOR,      
@@VALANAMTCUR CURSOR ,      
@@SETMSTCUR CURSOR,     
@@SETT_NO VARCHAR(12),
@@SETT_TYPE VARCHAR(3)


EXEC PR_DELIVERY_POSITION_POP @SAUDA_DATE, @UNAME

SET @@SETT_NO = ''      
      
SELECT TOP 1 @@SETT_NO= ISNULL(SETT_NO,''),@@SETT_TYPE = SETT_TYPE,
@@EXPIRYDATE=EXPIRYDATE,@@PAYINDATE=EXPIRYDATE,@@PAYOUTDATE=EXPIRYDATE 
FROM DELIVERY_POSITION
WHERE SAUDA_DATE = @SAUDA_DATE    

IF @@SETT_NO = ''
BEGIN
	RETURN
END

DELETE ACCBILL WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO   
      
  
SELECT @@SERVICE_CHRG= SERVICE_TAX, @@CESS_CHRG = CESS_TAX, @@EDUCESS_CHRG = EDUCESS_TAX 
FROM FOGLOBALS  
WHERE @SAUDA_DATE >= YEAR_START_DT AND @SAUDA_DATE <=  YEAR_END_DT                       
      
INSERT INTO ACCBILL 
 SELECT D.PARTY_CODE,BILLNO=0,      
 SELL_BUY = CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN ((DEL_PRICE*DEL_QTY)+SERVICE_TAX+BROKERAGE) 
				 ELSE -((DEL_PRICE*DEL_QTY)+SERVICE_TAX+BROKERAGE) END) > 0 THEN 1 ELSE 2 END,      
 @@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@SAUDA_DATE,@SAUDA_DATE,@SAUDA_DATE,      
 ABS(ROUND(SUM(CASE WHEN SELL_BUY=1 THEN ((DEL_PRICE*DEL_QTY)+SERVICE_TAX+BROKERAGE) 
					ELSE -((DEL_PRICE*DEL_QTY)+SERVICE_TAX+BROKERAGE) END),2)), 
 BRANCH_CD,'BILL POSTED' 
 FROM 
	DELIVERY_POSITION D (NOLOCK),
	CLIENT1 C1 (NOLOCK),
	CLIENT2 C2 (NOLOCK)
 WHERE 
	SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO   
	AND C1.CL_CODE = C2.CL_CODE
	AND D.PARTY_CODE = C2.PARTY_CODE   
 GROUP BY 
	D.PARTY_CODE,BRANCH_CD      
      
SET @@VALANACCCUR = CURSOR FOR SELECT ACNAME,ACCODE FROM VALANACCOUNT ORDER BY ACNAME      
OPEN @@VALANACCCUR      
FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE                
WHILE @@FETCH_STATUS = 0                 
 BEGIN      
   IF @@ACNAME = 'CLEARING HOUSE - DEL'      
    SELECT @@CLRHSGPARTY = @@ACCODE      
   IF @@ACNAME = 'ROUNDING OFF'      
     SELECT @@RNDOFFPARTY = @@ACCODE      
   IF @@ACNAME = 'SERVICE TAX'      
     SELECT @@SERTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'INCLUSIVE SERVICE TAX'      
     SELECT @@INSSERTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'BROKERAGE REALISED'            
     SELECT @@BRKRELPARTY = @@ACCODE      
   IF @@ACNAME = 'CESS TAX'      
     SELECT @@CESSTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'EDU CESS TAX'      
     SELECT @@EDUCESSTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'CESS TAX PAYABLE'       
      SELECT @@CESSTAXPAYPARTY = @@ACCODE      
   IF @@ACNAME = 'EDU CESS TAX PAYABLE'       
      SELECT @@EDUCESSTAXPAYPARTY = @@ACCODE      
      
   FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE                
 END      
CLOSE @@VALANACCCUR                
DEALLOCATE @@VALANACCCUR     
      
SELECT @@NETMTOM = 0      
SELECT @@NETBROKAMT = 0      
SELECT @@NETSERTAX = 0      
SELECT @@NETEXSERTAX = 0      
SELECT @@NETCESS_TAX = 0      
SELECT @@NETEDUCESS_TAX = 0      
SELECT @@TCESS_TAX = 0       
SELECT @@TEDUCESS_TAX = 0       
SELECT @@TEXCESS_TAX = 0      
SELECT @@TEXEDUCESS_TAX = 0      
SELECT @@NETEXCESS_TAX = 0       
SELECT @@NETEXEDUCESS_TAX = 0       
  
SET @@VALANAMTCUR = CURSOR FOR      
 SELECT SAUDA_DATE,BRANCH_CD,      
 SUM((CASE WHEN SELL_BUY=1 THEN DEL_QTY ELSE - DEL_QTY END)* DEL_PRICE ),      
 SUM(BROKERAGE),SUM(SERVICE_TAX)
 FROM DELIVERY_POSITION D (NOLOCK), CLIENT1 C1 (NOLOCK),CLIENT2 C2 (NOLOCK)       
 WHERE SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO
 AND C1.CL_CODE = C2.CL_CODE
 AND D.PARTY_CODE = C2.PARTY_CODE
 GROUP BY SAUDA_DATE,BRANCH_CD      
      
OPEN @@VALANAMTCUR      
      
FETCH NEXT FROM @@VALANAMTCUR INTO @@SAUDA_DATE,@@BRANCH_CD,@@MTOM,@@BROKAMT,@@SERTAX  
 WHILE @@FETCH_STATUS = 0               
 BEGIN      
   IF @@MTOM > 0               
     SELECT @@SELL_BUY = 2                
   ELSE              
	SELECT @@SELL_BUY = 1      

	SELECT @@NETMTOM = @@NETMTOM + @@MTOM      
	SELECT @@NETBROKAMT = @@BROKAMT + @@NETBROKAMT      
	
	
	
	SELECT @@TCESS_TAX = @@SERTAX - ROUND(( @@SERTAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG) ),2)          
	SELECT @@TEDUCESS_TAX = ROUND(@@TCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)          
	SELECT @@TCESS_TAX = @@TCESS_TAX - @@TEDUCESS_TAX         
	SELECT @@TSERVICE_TAX = @@SERTAX - @@TCESS_TAX - @@TEDUCESS_TAX       
	
	SELECT @@TEXCESS_TAX = 0
	SELECT @@TEXEDUCESS_TAX = 0
	SELECT @@TEXCESS_TAX = 0
	SELECT @@TEXSERVICE_TAX = 0
	
	SELECT @@NETCESS_TAX = @@NETCESS_TAX + @@TCESS_TAX          
	SELECT @@NETEDUCESS_TAX = @@NETEDUCESS_TAX + @@TEDUCESS_TAX          
	SELECT @@NETEXCESS_TAX = @@NETEXCESS_TAX + @@TEXCESS_TAX           
	SELECT @@NETEXEDUCESS_TAX = @@NETEXEDUCESS_TAX + @@TEXEDUCESS_TAX           
	
	
	SELECT @@NETSERTAX = @@TSERVICE_TAX + @@NETSERTAX      
	SELECT @@NETEXSERTAX = @@TEXSERVICE_TAX + @@NETEXSERTAX      

  
   INSERT INTO ACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@MTOM),2),@@BRANCH_CD,'BILL POSTED')                         
      
   INSERT INTO ACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@BROKAMT),2),@@BRANCH_CD,'BILL POSTED')                         
      
   INSERT INTO ACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@TSERVICE_TAX),2),@@BRANCH_CD,'BILL POSTED')                         
      
   INSERT INTO ACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@TEXSERVICE_TAX),2),@@BRANCH_CD,'BILL POSTED')      
      
  
   IF ROUND(@@TCESS_TAX,2) <> 0                 
   BEGIN          
    INSERT INTO ACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
   END      
   IF ROUND(@@TEXCESS_TAX,2) <> 0                
      BEGIN      
    INSERT INTO ACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TEXCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
      END      


   IF ROUND(@@TEDUCESS_TAX,2) <> 0                 
   BEGIN          
    INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TEDUCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
   END      
   IF ROUND(@@TEXEDUCESS_TAX,2) <> 0                
      BEGIN      
    INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TEXEDUCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
      END      


  FETCH NEXT FROM @@VALANAMTCUR INTO @@SAUDA_DATE,@@BRANCH_CD,@@MTOM,@@BROKAMT,@@SERTAX      
 END      
CLOSE @@VALANAMTCUR      
DEALLOCATE @@VALANAMTCUR      
      
 IF @@NETMTOM > 0               
  SELECT @@SELL_BUY = 2                
 ELSE              
  SELECT @@SELL_BUY = 1              
 INSERT INTO ACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
         ROUND(ABS(@@NETMTOM),2),'ZZZ','BILL POSTED')      
      
 INSERT INTO ACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
 ROUND(ABS(@@NETBROKAMT),2),'ZZZ','BILL POSTED')                         
      
 INSERT INTO ACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
 ROUND(ABS(@@NETSERTAX),2),'ZZZ','BILL POSTED')                         
      
 INSERT INTO ACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
 ROUND(ABS(@@NETEXSERTAX),2),'ZZZ','BILL POSTED')                         
      
 IF ROUND(@@NETCESS_TAX,2) <> 0                 
  BEGIN          
   INSERT INTO ACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@NETCESS_TAX),2),'ZZZ','BILL POSTED')      
  END      
 IF ROUND(@@NETEXCESS_TAX,2) <> 0                
 BEGIN      
   INSERT INTO ACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
   ROUND(ABS(@@NETEXCESS_TAX),2),'ZZZ','BILL POSTED')      
 END      

 IF ROUND(@@NETEDUCESS_TAX,2) <> 0                 
  BEGIN          
   INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@NETEDUCESS_TAX),2),'ZZZ','BILL POSTED')      
  END      
 IF ROUND(@@NETEXEDUCESS_TAX,2) <> 0                
 BEGIN      
   INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
   ROUND(ABS(@@NETEXEDUCESS_TAX),2),'ZZZ','BILL POSTED')      
 END      
      
      
SELECT @@GROSSDIFFAMT = 0      
SELECT @@DIFFAMT = 0      
        
SET @@VALANAMTCUR = CURSOR FOR      
      
SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),SELL_BUY FROM ACCBILL A,ACCOUNTBFO.DBO.ACMAST M               
WHERE SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO      
AND A.PARTY_CODE = M.CLTCODE AND (BRANCHCD = 'ZZZ' OR ACCAT = 4 )              
GROUP BY SELL_BUY      
      
OPEN @@VALANAMTCUR               
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY              
WHILE @@FETCH_STATUS = 0                
BEGIN              
 BEGIN              
  IF @@SELL_BUY = 1               
  BEGIN                
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT              
  END               
  ELSE              
  BEGIN                                  
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT                       
  END              
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY              
 END              
END              
CLOSE @@VALANAMTCUR              
DEALLOCATE @@VALANAMTCUR              
              
IF @@GROSSDIFFAMT > 0               
 INSERT INTO ACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,              
        ROUND(ABS(@@GROSSDIFFAMT),2),'ZZZ','BILL POSTED')      
ELSE               
 INSERT INTO ACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,              
        ROUND(ABS(@@GROSSDIFFAMT),2),'ZZZ','BILL POSTED')              
      
DELETE FROM ACCBILL WHERE AMOUNT = 0 AND SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DIRECTCONSOLIDATE
-- --------------------------------------------------
CREATE PROC [DBO].[DIRECTCONSOLIDATE]
(
	@SAUDADATE VARCHAR(11),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@FROMSCRIP VARCHAR(20),
	@TOSCRIP VARCHAR(20),
	@FROMTERM VARCHAR(10),
	@TOTERM VARCHAR(10),
	@CONSOLIDATE INT,
	@SELLBUY INT = 0,
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25)
)
AS


DECLARE
	@BRKCUR CURSOR,
	@INST_TYPE VARCHAR(6),
	@SYMBOL VARCHAR(20),
	@EXPIRYDATE DATETIME,
	@STRIKE_PRICE MONEY,
	@OPTION_TYPE VARCHAR(2)

/*
	BEGIN TRAN
	EXEC DIRECTCONSOLIDATE '01/09/2005', '0', 'ZZZZZZZZZZ', '', '', '', '', 0, 0, 'BROKER', 'BROKER' 
	ROLLBACK
*/
SET @SAUDADATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDADATE, 103), 109)
IF @CONSOLIDATE = 0		-- CONSOLIDATE THE RECORDS
	BEGIN
		SELECT
			I.PARTY_CODE,
			I.SYMBOL,
			I.INST_TYPE,
			I.EXPIRYDATE,
			I.STRIKE_PRICE,
			I.OPTION_TYPE,
			I.SELL_BUY,
			I.CONTRACTNO,
			I.PARTICIPANTCODE,
			MKTRATE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.MARKETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2) WHEN 4 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) ELSE ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END),
			NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END)
		INTO
			#FOSETTLEMENT
		FROM
			FOSETTLEMENT I,
			CLIENT1 C1,
			CLIENT2 C2
				LEFT JOIN INSTCLIENT_TBL R
				ON (C2.PARTY_CODE = R.PARTYCODE)
		WHERE SAUDA_DATE LIKE @SAUDADATE + '%'
			AND C1.CL_CODE = C2.CL_CODE
			AND C2.PARTY_CODE = I.PARTY_CODE
			AND I.RESERVED1 = 1
			AND C1.CL_TYPE = 'INS'
			AND I.TRADEQTY > 0
			AND I.DUMMY1 = 0
			AND AUCTIONPART <> 'CA'
			AND AUCTIONPART <> 'EA'
			AND PRICE > 0 
			AND I.SYMBOL BETWEEN (CASE WHEN @FROMSCRIP <> '' THEN @FROMSCRIP ELSE '0' END) AND (CASE WHEN @TOSCRIP <> '' THEN @TOSCRIP ELSE 'ZZZZZZZZ' END)
			AND I.PARTY_CODE BETWEEN (CASE WHEN @FROMPARTY <> '' THEN @FROMPARTY ELSE '0' END) AND (CASE WHEN @TOPARTY <> '' THEN @TOPARTY ELSE 'ZZZZZZZZ' END)
			AND I.SELL_BUY BETWEEN (CASE WHEN @SELLBUY = 0 THEN 1 ELSE @SELLBUY END) AND (CASE WHEN @SELLBUY = 0 THEN 2 ELSE @SELLBUY END)
			AND I.USER_ID BETWEEN (CASE WHEN @FROMTERM <> '' THEN @FROMTERM ELSE '0' END) AND (CASE WHEN @TOTERM <> '' THEN @TOTERM ELSE 'ZZZZZZZZ' END)
		GROUP BY
			I.PARTY_CODE,
			I.SYMBOL,
			I.INST_TYPE,
			I.EXPIRYDATE,
			I.STRIKE_PRICE,
			I.OPTION_TYPE,
			I.SELL_BUY,
			I.CONTRACTNO,
			I.PARTICIPANTCODE,
			R.MARKETRATE,
			R.NETRATE

		UPDATE
			FOSETTLEMENT
		SET
			DUMMY1 = 1,
			PRICE = H.MKTRATE
		FROM
			#FOSETTLEMENT H
		WHERE FOSETTLEMENT.SAUDA_DATE LIKE @SAUDADATE + '%'
			AND FOSETTLEMENT.PARTY_CODE = H.PARTY_CODE
			AND FOSETTLEMENT.SYMBOL = H.SYMBOL
			AND FOSETTLEMENT.INST_TYPE = H.INST_TYPE
			AND FOSETTLEMENT.EXPIRYDATE = H.EXPIRYDATE
			AND FOSETTLEMENT.STRIKE_PRICE = H.STRIKE_PRICE
			AND FOSETTLEMENT.OPTION_TYPE = H.OPTION_TYPE
			AND FOSETTLEMENT.SELL_BUY = H.SELL_BUY
			AND FOSETTLEMENT.CONTRACTNO = H.CONTRACTNO
			AND FOSETTLEMENT.PARTICIPANTCODE = H.PARTICIPANTCODE
			AND FOSETTLEMENT.RESERVED1 = 1
			AND FOSETTLEMENT.TRADEQTY > 0
			AND FOSETTLEMENT.DUMMY1 = 0
			AND FOSETTLEMENT.AUCTIONPART <> 'CA'
			AND FOSETTLEMENT.AUCTIONPART <> 'EA'
			AND FOSETTLEMENT.PRICE > 0 
			AND FOSETTLEMENT.SYMBOL BETWEEN (CASE WHEN @FROMSCRIP <> '' THEN @FROMSCRIP ELSE '0' END) AND (CASE WHEN @TOSCRIP <> '' THEN @TOSCRIP ELSE 'ZZZZZZZZ' END)
			AND FOSETTLEMENT.PARTY_CODE BETWEEN (CASE WHEN @FROMPARTY <> '' THEN @FROMPARTY ELSE '0' END) AND (CASE WHEN @TOPARTY <> '' THEN @TOPARTY ELSE 'ZZZZZZZZ' END)
			AND FOSETTLEMENT.SELL_BUY BETWEEN (CASE WHEN @SELLBUY = 0 THEN 1 ELSE @SELLBUY END) AND (CASE WHEN @SELLBUY = 0 THEN 2 ELSE @SELLBUY END)
			AND FOSETTLEMENT.USER_ID BETWEEN (CASE WHEN @FROMTERM <> '' THEN @FROMTERM ELSE '0' END) AND (CASE WHEN @TOTERM <> '' THEN @TOTERM ELSE 'ZZZZZZZZ' END)

		SET @BRKCUR = CURSOR FOR
		SELECT PARTY_CODE, SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE FROM #FOSETTLEMENT
		OPEN @BRKCUR
		FETCH NEXT FROM @BRKCUR INTO @FROMPARTY, @SYMBOL, @INST_TYPE, @EXPIRYDATE, @STRIKE_PRICE, @OPTION_TYPE
		WHILE @@FETCH_STATUS = 0
		BEGIN
			EXEC PROC_TRADE_TRANSFER_RECAL @SAUDADATE, @FROMPARTY, @INST_TYPE, @SYMBOL, @EXPIRYDATE, @STRIKE_PRICE, @OPTION_TYPE, '', ''
			FETCH NEXT FROM @BRKCUR INTO @FROMPARTY, @SYMBOL, @INST_TYPE, @EXPIRYDATE, @STRIKE_PRICE, @OPTION_TYPE
		END

		SELECT @FROMPARTY = MIN(PARTY_CODE), @TOPARTY = MAX(PARTY_CODE) FROM #FOSETTLEMENT

		EXEC STT_CHARGES_FINAL @SAUDADATE, @FROMPARTY, @TOPARTY, @STATUSNAME

	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DUPRECSETTCHECK
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[DUPRECSETTCHECK] AS

UPDATE BFOFTTRADE SET OPTION_TYPE  = '' WHERE OPTION_TYPE IS NULL
UPDATE BFOFTTRADE SET STRIKE_PRICE  = 0 WHERE STRIKE_PRICE IS NULL  
UPDATE BFOFTTRADE SET EXPIRYDATE  = LEFT(EXPIRYDATE,11) + ' 23:59'

INSERT INTO BFOTRADE 
SELECT 
	TRADE_NO,
	SAUDA_DATE,
	TRADESTATUS,
	SEGMENT,
	SETT_TYPE,
	PRODUCT_TYPE,
	PRODUCT_CODE,
	ASSET_CODE,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	SERIES_CODE='',
	SERIES_ID,
	LOT_SIZE =0,
	SELL_BUY=1,
	TRADEQTY ,
	SETTFLAG = 3,
	CA_LEVEL,
	BROKER_CD=BUY_BROKER,
	TRADE_PRICE,
	LOCATIONID=BUYER_LOCATIONID,
	CM_CODE=BUY_CM_CODE,
	PARTICIPANTCODE=BUY_PARTICIPANT,
	CP_CONFIRMATION=BUY_CONFIRMATION,
	OC_FLAG=BUY_OC_FLAG,
	OLD_CP_CODE=BUY_OLD_PARTICIPANT,
	OLD_CM_CODE=BUY_OLD_CM_CODE,
	TERMINALID=BUY_TERMINALID,
	ORDER_NO=BUY_ORDER_NO,
	PARTY_CODE=BUY_CLIENT_CODE,
	REMARKS=BUY_REMARKS,
	BUY_POSITION,
	SELL_POSITION,
	PRO_CLI=BUY_PRO_CLI,
	ORDER_TIMESTAMP=BUY_ORDER_TIMESTAMP,
	ORDER_ACTIVEFLAG=BUY_ORDER_ACTIVEFLAG,
	0,0,0,0,0,0,0
FROM BFOFTTRADE 
WHERE ISNULL(BUY_CLIENT_CODE,'') <> ''
AND NOT EXISTS
(
	SELECT TRADE_NO FROM BFOTRADE WHERE
	BFOTRADE.SAUDA_DATE = BFOFTTRADE.SAUDA_DATE
	AND BFOTRADE.PRODUCT_TYPE = BFOFTTRADE.PRODUCT_TYPE
	AND BFOTRADE.PRODUCT_CODE = BFOFTTRADE.PRODUCT_CODE
	AND BFOTRADE.ASSET_CODE = BFOFTTRADE.ASSET_CODE
	AND BFOTRADE.EXPIRYDATE = BFOFTTRADE.EXPIRYDATE
	AND BFOTRADE.TRADE_NO = BFOFTTRADE.TRADE_NO
	AND BFOTRADE.ORDER_NO = BFOFTTRADE.BUY_ORDER_NO
	AND SELL_BUY = 1
)

INSERT INTO BFOTRADE 
SELECT 
	TRADE_NO,
	SAUDA_DATE,
	TRADESTATUS,
	SEGMENT,
	SETT_TYPE,
	PRODUCT_TYPE,
	PRODUCT_CODE,
	ASSET_CODE,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	SERIES_CODE='',
	SERIES_ID,
	LOT_SIZE =0,
	SELL_BUY=2,
	TRADEQTY ,
	SETTFLAG =5,
	CA_LEVEL,
	BROKER_CD=SELL_BROKER,
	TRADE_PRICE,
	LOCATIONID=SELLER_LOCATIONID,
	CM_CODE=SELL_CM_CODE,
	PARTICIPANTCODE=SELL_PARTICIPANT,
	CP_CONFIRMATION=SELL_CONFIRMATION,
	OC_FLAG=SELL_OC_FLAG,
	OLD_CP_CODE=SELL_OLD_PARTICIPANT,
	OLD_CM_CODE=SELL_OLD_CM_CODE,
	TERMINALID=SELL_TERMINALID,
	ORDER_NO=SELL_ORDER_NO,
	PARTY_CODE=SELL_CLIENT_CODE,
	REMARKS=SELL_REMARKS,
	BUY_POSITION,
	SELL_POSITION,
	PRO_CLI=SELL_PRO_CLI,
	ORDER_TIMESTAMP=SELL_ORDER_TIMESTAMP,
	ORDER_ACTIVEFLAG=SELL_ORDER_ACTIVEFLAG,
	0,0,0,0,0,0,0
FROM BFOFTTRADE 
WHERE ISNULL(SELL_CLIENT_CODE,'') <> ''
AND NOT EXISTS
(
	SELECT TRADE_NO FROM BFOTRADE WHERE
	BFOTRADE.SAUDA_DATE = BFOFTTRADE.SAUDA_DATE
	AND BFOTRADE.PRODUCT_TYPE = BFOFTTRADE.PRODUCT_TYPE
	AND BFOTRADE.PRODUCT_CODE = BFOFTTRADE.PRODUCT_CODE
	AND BFOTRADE.ASSET_CODE = BFOFTTRADE.ASSET_CODE
	AND BFOTRADE.EXPIRYDATE = BFOFTTRADE.EXPIRYDATE
	AND BFOTRADE.TRADE_NO = BFOFTTRADE.TRADE_NO
	AND BFOTRADE.ORDER_NO = BFOFTTRADE.SELL_ORDER_NO
	AND SELL_BUY = 2
)

UPDATE BFOTRADE 
SET SERIES_CODE = CA_LEVEL
WHERE CA_LEVEL <> '0'

UPDATE BFOTRADE 
SET SERIES_CODE = BFOSCRIP2.SERIES_CODE,LOT_SIZE=BFOSCRIP2.LOT_SIZE_MULTIPLE
FROM BFOSCRIP2 (NOLOCK)
WHERE 
	BFOSCRIP2.PRODUCT_TYPE = BFOTRADE.PRODUCT_TYPE AND
	BFOSCRIP2.PRODUCT_CODE = BFOTRADE.PRODUCT_CODE AND
	BFOSCRIP2.EXPIRYDATE = BFOTRADE.EXPIRYDATE AND
	BFOSCRIP2.STRIKE_PRICE = BFOTRADE.STRIKE_PRICE AND
	BFOSCRIP2.OPTION_TYPE = BFOTRADE.OPTION_TYPE AND
	BFOSCRIP2.SERIES_ID = BFOTRADE.SERIES_ID AND
	BFOTRADE.CA_LEVEL = '0'

UPDATE BFOTRADE SET CA_LEVEL ='0' WHERE CA_LEVEL <> '0'

UPDATE BFOTRADE SET PARTICIPANTCODE = BROKER_CD WHERE ISNULL(PARTICIPANTCODE,'') =''


UPDATE BFOTRADE SET PARTY_CODE = NEWPARTY_CODE FROM PARTYMAPPING  
WHERE PARTY_CODE = OLDPARTY_CODE

IF (SELECT MEMBERTYPE FROM BFOOWNER) = 'CM'
BEGIN

	UPDATE BFOTRADE SET PARTY_CODE= BFOTMINFO.PARTY_CODE 
	FROM BFOTMINFO WHERE BFOTMINFO.TM_CODE=BFOTRADE.BROKER_CD

	UPDATE BFOTRADE SET PARTY_CODE= CLIENT2.PARTY_CODE
	FROM CLIENT2 WHERE CLIENT2.BANKID = BFOTRADE.PARTICIPANTCODE AND 
	BROKER_CD NOT IN (SELECT TM_CODE FROM BFOTMINFO)

END


DELETE BFOTRADE FROM BFOSETTLEMENT S WHERE 
BFOTRADE.SAUDA_DATE = S.SAUDA_DATE AND
BFOTRADE.TRADE_NO = PRADNYA.DBO.REPLACETRADENO(S.TRADE_NO) AND
BFOTRADE.ORDER_NO = S.ORDER_NO AND
BFOTRADE.SERIES_CODE = S.SERIES_CODE AND
BFOTRADE.SELL_BUY = S.SELL_BUY

TRUNCATE TABLE BFOFTTRADE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EDIT_PARTICIPANT
-- --------------------------------------------------
CREATE PROC [DBO].[EDIT_PARTICIPANT] 
( 
	 @FIXEDDATA VARCHAR(8000),  
	 @VARIABLEDATA VARCHAR(8000),  
	 @STATUSNAME VARCHAR(50),  
	 @FROMWHERE VARCHAR(100),  
	 @LEVEL VARCHAR(5)  
)
AS  


/*---------------------------------------------------------------------------
	PROC NAME   : EDIT_PARTICIPANT
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CP CODE UPDATE FOR SELECTED TRADES				  
------------------------------------------------------------------------------*/

 DECLARE  
  @TABLE VARCHAR(25),  
  @SAUDADATE VARCHAR(11),  
  @CONTRACTNO VARCHAR(7),  
  @PARTYCODE VARCHAR(10),  
  @SYMBOL VARCHAR(20),  
  @INST_TYPE VARCHAR(10),
  @EXPIRYDATE VARCHAR(11),
  @STRIKE_PRICE NUMERIC(18,2),
  @OPTION_TYPE VARCHAR(10),
  @SELLBUY INT,  
  @NEWINST VARCHAR(15),  
  @SQL VARCHAR(8000),  
  @RECORD VARCHAR(1000),  
  @RECNO INT  
  
IF CONVERT(NUMERIC(4), @LEVEL) = 501  
 BEGIN  
  SET @TABLE = LTRIM(RTRIM(.DBO.PIECE(@FIXEDDATA, ',', 1)))  
  SET @SAUDADATE = LTRIM(RTRIM(.DBO.PIECE(@FIXEDDATA, ',', 2)))  
  SET @RECNO = 1  

  WHILE 1 = 1  
   BEGIN  
    SET @RECORD = .DBO.PIECE(@VARIABLEDATA, '|', @RECNO)  
    IF @RECORD = '' OR @RECORD IS NULL  
     BEGIN  
      BREAK  
     END  
    SET @CONTRACTNO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 1)))  
    SET @PARTYCODE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 2)))  
    SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 3)))  
	SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 4))) 
	SET @EXPIRYDATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 5))) 
	SET @STRIKE_PRICE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 6))) 
	SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 7)))  
    SET @SELLBUY = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 10)))  
    SET @NEWINST = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 11)))  


  INSERT INTO INST_LOG   
    SELECT DISTINCT   
		@PARTYCODE ,
		@PARTYCODE ,
		CONVERT(DATETIME,  @SAUDADATE , 103), 
		@INST_TYPE ,
		@SYMBOL ,
		CONVERT(DATETIME, @EXPIRYDATE,103),
		@STRIKE_PRICE ,   
		@OPTION_TYPE ,
		ORDER_NO,   
		'%',   
		@SELLBUY ,
		@CONTRACTNO ,
		@CONTRACTNO ,
		0,0,0,0,0,0,0,0,0,  
		PARTICIPANTCODE,   
		@NEWINST ,
		@STATUSNAME ,
		@FROMWHERE ,
		'EDITPARTICIPANT', 
		GETDATE(), 
		'EDIT_PARTICIPANT', 
		'',  
		''   
	FROM
		FOSETTLEMENT 
	WHERE 
		CONVERT(VARCHAR(10), SAUDA_DATE, 103) = @SAUDADATE 
		AND PARTY_CODE =  @PARTYCODE 
		AND INST_TYPE = @INST_TYPE 
		AND SYMBOL = @SYMBOL 
		AND CONVERT(VARCHAR(11),EXPIRYDATE,103) =  @EXPIRYDATE 
		AND STRIKE_PRICE = @STRIKE_PRICE
		AND OPTION_TYPE = @OPTION_TYPE 
		AND SELL_BUY =  @SELLBUY
		AND CONTRACTNO =  @CONTRACTNO 

    UPDATE FOSETTLEMENT
    SET 
		PARTICIPANTCODE = @NEWINST
	WHERE 
		CONVERT(VARCHAR(10), SAUDA_DATE, 103) = @SAUDADATE 
		AND PARTY_CODE =  @PARTYCODE 
		AND INST_TYPE = @INST_TYPE 
		AND SYMBOL = @SYMBOL 
		AND CONVERT(VARCHAR(11),EXPIRYDATE,103) =  @EXPIRYDATE 
		AND STRIKE_PRICE = @STRIKE_PRICE
		AND OPTION_TYPE = @OPTION_TYPE 
		AND SELL_BUY =  @SELLBUY
		AND CONTRACTNO =  @CONTRACTNO 

    SET @RECNO = @RECNO + 1  
   END  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FETCH_GST_INVOICE
-- --------------------------------------------------


create  PROC [dbo].[FETCH_GST_INVOICE] 
(
	@FORTHEDAY	VARCHAR(11),
	@EXCHANGE	VARCHAR(3),
	@SEGMENT	VARCHAR(7)
)
AS

SELECT INVOICE_DATE = CONVERT(DATETIME, LEFT(SAUDA_DATE,11)),EXCHANGE=@EXCHANGE, SEGMENT=@SEGMENT, RECORDFOR='SETTLEMENT',
SUBRECORDFOR=CONVERT(VARCHAR(20),'CONTRACT'),INV_DESC = CONVERT(VARCHAR(500),'TOWORDS BROKERAGE AND CHARGES AGAINST THE TRADES EXECUTION'),
SETT_NO='', SETT_TYPE='', PARTY_CODE, CONTRACTNO, INT_REF_NO = CONVERT(VARCHAR(50), @EXCHANGE + '_' + @SEGMENT + '_' + CONTRACTNO),
TAXABLE_AMT = SUM(PBROKAMT+SBROKAMT)
			+ SUM(CASE WHEN TURNOVER_AC = 1 THEN TURN_TAX ELSE 0 END)
			+ SUM(CASE WHEN SEBI_TURN_AC = 1 THEN SEBI_TAX ELSE 0 END)
			+ SUM(CASE WHEN BROKER_NOTE_AC = 1 THEN BROKER_NOTE ELSE 0 END)
			+ SUM(CASE WHEN OTHER_CHRG_AC = 1 THEN OTHER_CHRG ELSE 0 END)
			+ SUM(CASE WHEN INSURANCE_CHRG_AC = 1 THEN INS_CHRG ELSE 0 END),
TAX_AMT = SUM(C.SERVICE_TAX),
INVOICE_TYPE = CONVERT(VARCHAR(20),'DEBIT'),
INVOICE_SUBTYPE = CONVERT(VARCHAR(20),''),
INVOICE_CATEGORY = CONVERT(VARCHAR(20),''),
REV_INT_REF_NO = CONVERT(VARCHAR(50),''),
LOCATION_CODE = CONVERT(VARCHAR(50),''),
SOURCESTATE=CONVERT(VARCHAR(50),''),
TARGETSTATE=CONVERT(VARCHAR(50),''),
STATE_CODE=CONVERT(VARCHAR(2),''),
INV_NO=CONVERT(VARCHAR(50),''),
SACCODE=CONVERT(VARCHAR(50),''),
SAC_DESC=CONVERT(VARCHAR(500),''),
BRANCH_CODE = CONVERT(VARCHAR(10),''),
IGST_RATE = CONVERT(NUMERIC(18,4),0),
IGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
CGST_RATE = CONVERT(NUMERIC(18,4),0),
CGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
SGST_RATE = CONVERT(NUMERIC(18,4),0),
SGST_AMOUNT = CONVERT(NUMERIC(18,4),0)
INTO #DATA 
FROM FOBILLVALAN C, FOGLOBALS G, FOOWNER O
WHERE  SAUDA_DATE BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
AND C.SERVICE_TAX > 0 AND TRADETYPE = 'BT'
GROUP BY PARTY_CODE, CONTRACTNO, LEFT(SAUDA_DATE,11)

SELECT * FROM #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FILELISTPROC
-- --------------------------------------------------
CREATE  PROC [DBO].[FILELISTPROC] (@FILEPATH VARCHAR(100) )        
AS         
      
DECLARE @NEWFILEPATH VARCHAR(100)      
      
SET @NEWFILEPATH = REPLACE(@FILEPATH, '*.TXT', '*.*')      
CREATE TABLE #FILELIST         
( FILENAMELIST VARCHAR(100))        
INSERT INTO #FILELIST         
EXEC MASTER.DBO.XP_CMDSHELL @NEWFILEPATH        
  
SELECT * FROM #FILELIST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FO_POST_EXERCISEALLOCATION_adhoc
-- --------------------------------------------------
CREATE  PROC [dbo].[FO_POST_EXERCISEALLOCATION_adhoc] 
(
	@BILLDATE VARCHAR(11),
	@USERNAME VARCHAR(20) =''
 )
AS 
 

 
UPDATE bfosettlement SET trade_Price = 0
WHERE sauda_date like @BILLDATE+'%' and SERIES_ID IN (SELECT SERIES_ID FROM BFOSCRIP2 S
	WHERE SAUDA_DATE >= @BILLDATE
	AND SAUDA_DATE <= @BILLDATE + ' 23:59'
	AND RESERVED1 <> 1 
	AND TRADEQTY > 0 
	AND MATURITYDATE  >= @BILLDATE
	AND MATURITYDATE <= @BILLDATE + ' 23:59'
	AND bfosettlement.PRODUCT_TYPE = S.PRODUCT_TYPE
	AND bfosettlement.PRODUCT_CODE = S.PRODUCT_CODE
	AND bfosettlement.EXPIRYDATE = S.EXPIRYDATE
	AND bfosettlement.STRIKE_PRICE = S.STRIKE_PRICE
	AND bfosettlement.OPTION_TYPE = S.OPTION_TYPE
	AND bfosettlement.SERIES_ID = S.SERIES_ID
	AND AUCTIONPART = 'EA' AND S.CA_LEVEL = 'D'
	AND S.CA_LEVEL IN (SELECT BSECODE FROM BSEDB.DBO.SCRIP2 ))
				 
/* -- ANIMESH JUL 26 2018 */
UPDATE bfosettlement SET Brokapplied = 0, Service_tax = 0, INS_CHRG = 0, turn_tax = 0, sebi_tax = 0, NETRATE = trade_Price 
WHERE SAUDA_DATE LIKE @BILLDATE + '%' AND PRODUCT_TYPE LIKE '%OPT' AND trade_Price = 0 AND AuctionPart = 'EA'
/* -- ANIMESH JUL 26 2018 */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOFUTMATDAILY
-- --------------------------------------------------
CREATE  PROC [DBO].[FOFUTMATDAILY]  
@SDATE VARCHAR(11),  
@PARTY VARCHAR(10),  
@SYMBOL VARCHAR(15)  
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
SELECT CHARGES=(CASE WHEN BILLFLAG > 3 THEN SUM(S.NBROKAPP*TRADEQTY)   
   + (CASE WHEN C2.SERVICE_CHRG <> 2   
    THEN SUM(S.NSERTAX)  
    ELSE 0   
             END)  
   ELSE 0 END),  
BROKERAGE=(CASE WHEN BILLFLAG > 3 THEN SUM(S.NBROKAPP*TRADEQTY) ELSE 0 END),  
SERVICE_TAX=(CASE WHEN BILLFLAG > 3 THEN (CASE WHEN C2.SERVICE_CHRG <> 2   
    THEN SUM(S.NSERTAX)  
    ELSE 0   
      END ) ELSE 0 END),  
BROKER_NOTE=0,  
TURN_TAX=0,  
SEBI_TAX=0  
FROM BFOSETTLEMENT S , CLIENT2 C2  
WHERE S.PARTY_CODE LIKE @PARTY + '%'  
AND S.PRODUCT_CODE LIKE 'FUT%'   
AND S.SERIES_CODE LIKE @SYMBOL + '%'  
AND S.PARTY_CODE = C2.PARTY_CODE  
AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @SDATE  
AND NBROKAPP <> 0  
GROUP BY S.BILLFLAG,C2.SERVICE_CHRG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOGENCONTRACT_EXALLOC
-- --------------------------------------------------


CREATE PROCEDURE [DBO].FOGENCONTRACT_EXALLOC 
AS     
DECLARE @@PARTY VARCHAR(12),    
 @@SETT_TYPE VARCHAR(2),      
 @@CONTNO VARCHAR(7),    
 @@CONTNOPARTIPANT VARCHAR(7),    
 @@PARTICIPANTCODE VARCHAR(15),    
 @@MEMBERCODE VARCHAR(15),    
 @@SAUDA_DATE VARCHAR(11),    
 @@ORDER_NO VARCHAR(20),    
 @@SCRIP_CD VARCHAR(12),    
 @@SERIES VARCHAR(2),    
 @@SELL_BUY INT,    
 @@STYLE INT,    
 @@STARTDATE VARCHAR(11),    
 @@ENDDATE VARCHAR(11),    
 @@FLAG INT,    
 @@CONT CURSOR  ,      
 @@PARTYCONT CURSOR    ,    
 @@CURSETTTYPE VARCHAR(2),    
 @@INSCONTNO VARCHAR(7),    
 @@EXPIRYDATE DATETIME,    
 @@STRIKEPRICE MONEY,    
 @@OPTIONTYPE VARCHAR(2),          
 @@PRODUCT_TYPE VARCHAR(6),    
 @@PRODUCT_CODE VARCHAR(12),    
 @@SERIES_CODE VARCHAR(12),    
 @@SERIES_ID INT,   
 @@MAXCONTNOS INT,    
 @@MAXCONNOI  INT,    
 @@BBGCONTCUR CURSOR,    
 @@GETMAXCONTNO CURSOR,    
 @@INSCONT   VARCHAR(4),    
 @@CL_RATE NUMERIC(36,12) ,
 @@TRDDELFLAG	INT   
    

BEGIN TRAN

SELECT TOP 1 @@SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) FROM BFOEXALLOCTRADE     

SET  @@TRDDELFLAG = 0
SELECT @@TRDDELFLAG = TRDDELFLAG FROM CONTGEN WHERE
@@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 


SELECT @@MEMBERCODE=MEMBERCODE,@@STYLE=ISNULL(STYLE,0) FROM BFOOWNER    

TRUNCATE TABLE BBGBFOSETTLEMENT    


INSERT INTO BBGBFOSETTLEMENT 
SELECT CONTRACTNO='0000000',TRADE_NO,SAUDA_DATE,'11','F','F',PRODUCT_TYPE,
PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE=1,
SELL_BUY,TRADEQTY,SETTFLAG,CA_LEVEL=0,BROKER_CD='',TRADE_PRICE=MARKETRATE,LOCATIONID=0,CM_CODE=TM_CODE,PARTICIPANTCODE,
CP_CONFIRMATION=0,OC_FLAG=0,OLD_CP_CODE=0,OLD_CM_CODE=0,TERMINALID=0,ORDER_NO,PARTY_CODE,REMARKS='',
BUY_POSITION=0,SELL_POSITION=0,PRO_CLI,ORDER_TIMESTAMP=SAUDA_DATE,ORDER_ACTIVEFLAG=0,TABLE_NO=0,LINE_NO,
VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG=0,ERRNUM=0,NOZERO=1,
ROUND_TO=2,TRADE_AMOUNT,BRANCH_CD=PARTY_CODE,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,
SEBI_TAX,BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART='EA',
RESERVED1 = CASE WHEN ISNULL(PARTICIPANTCODE,'') = MEMBERCODE OR ISNULL(PARTICIPANTCODE,'') ='' THEN 0 ELSE 1 END,
DUMMY1=0,DUMMY2=MARKETRATE,STATUS = '11'
FROM BFOEXALLOCCONFIRMVIEW, BFOOWNER      

IF (SELECT MEMBERTYPE FROM BFOOWNER) = 'CM'
BEGIN
	UPDATE BBGBFOSETTLEMENT SET RESERVED1 = 2
END

IF @@STYLE = 0    
BEGIN    
     SET @@BBGCONTCUR =  CURSOR FOR    
     SELECT ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM BFOSETTLEMENT    
     WHERE SAUDA_DATE BETWEEN  @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:9'   
     AND CONVERT(INT,CONTRACTNO) <> 0    
END    
    
IF @@STYLE = 1     
BEGIN    
	 IF @@TRDDELFLAG = 0
	 BEGIN     
		SELECT @@MAXCONTNOS = ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE         
     END
     ELSE
     BEGIN
		SELECT @@MAXCONTNOS = ISNULL(CONVERT(INT,OPTDELCONTRACTNO),0) FROM CONTGEN WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE         
     END
END     


	 IF @@TRDDELFLAG = 0
	 BEGIN     
		 SET @@PARTYCONT = CURSOR FOR    
		 SELECT DISTINCT I.PARTY_CODE,I.CONTRACTNO,I.ORDER_NO,SERIES_CODE,INSCONT     
		 FROM BFOSETTLEMENT I (NOLOCK),CLIENT2 C2 (NOLOCK)    
		 WHERE I.SAUDA_DATE BETWEEN  @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:9'       
		 AND I.PARTY_CODE = C2.PARTY_CODE     
		 AND CONVERT(INT,I.CONTRACTNO) <> 0    
		 ORDER BY I.PARTY_CODE,SERIES_CODE,I.CONTRACTNO    
		 OPEN @@PARTYCONT    
		 FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@CONTNO,@@ORDER_NO,@@SERIES_CODE,@@INSCONT    
		 WHILE @@FETCH_STATUS = 0    
		 BEGIN    
			  IF @@INSCONT = 'N' OR @@INSCONT IS NULL OR @@INSCONT = ''    
			  BEGIN    
				   UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = @@CONTNO     
				   WHERE    
				   PARTY_CODE = @@PARTY    
			  END    
			  IF @@INSCONT = 'O'  
				BEGIN
					UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = @@CONTNO     
					WHERE PARTY_CODE = @@PARTY AND    
					ORDER_NO = @@ORDER_NO    
				END    
				IF @@INSCONT = 'S'     
				BEGIN     
					UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = @@CONTNO     
					WHERE  
					PARTY_CODE = @@PARTY AND   
					SERIES_CODE = @@SERIES_CODE     
				END    
		 FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@CONTNO,@@ORDER_NO,@@SERIES_CODE,@@INSCONT      
		 END         
		 CLOSE @@PARTYCONT    
	 END
	     
     SET @@PARTY=''    
            
     SET @@PARTYCONT = CURSOR FOR     
     SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE  FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1     
     WHERE CONTRACTNO='0000000' AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE     
     AND INSCONT = 'N' AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'    
     ORDER BY BBGBFOSETTLEMENT.PARTY_CODE     
     OPEN @@PARTYCONT    
     FETCH NEXT  FROM @@PARTYCONT INTO   @@PARTY    
     WHILE @@FETCH_STATUS = 0    
     BEGIN    
          SET @@CONTNO =@@MAXCONTNOS +1    
          SET @@MAXCONTNOS = @@MAXCONTNOS + 1   
           
          UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = CASE WHEN @@TRDDELFLAG = 1 THEN 'E' ELSE '' END + 
					 STUFF(CASE WHEN @@TRDDELFLAG = 1 THEN '000000' ELSE '0000000' END, 
					 (CASE WHEN @@TRDDELFLAG = 1 THEN 7 ELSE 8 END) - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO)
		  WHERE    
          PARTY_CODE =@@PARTY     
          FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY    
     END    
     CLOSE @@PARTYCONT    
     SET @@PARTY=''    
    
     SET @@PARTYCONT = CURSOR FOR     
     SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.ORDER_NO FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1    
     WHERE CONTRACTNO='0000000'  AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE    
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'    
     AND INSCONT  =  'O'    
     ORDER BY BBGBFOSETTLEMENT.PARTY_CODE,BBGBFOSETTLEMENT.ORDER_NO      
     OPEN @@PARTYCONT    
     FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@ORDER_NO    
     WHILE @@FETCH_STATUS = 0    
     BEGIN    
          SET @@CONTNO = 0    
          SET @@CONTNO =@@MAXCONTNOS +1    
          SET @@MAXCONTNOS = @@MAXCONTNOS + 1    
          UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = CASE WHEN @@TRDDELFLAG = 1 THEN 'E' ELSE '' END + 
					 STUFF(CASE WHEN @@TRDDELFLAG = 1 THEN '000000' ELSE '0000000' END, 
					 (CASE WHEN @@TRDDELFLAG = 1 THEN 7 ELSE 8 END) - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO)
		  WHERE    
          PARTY_CODE =@@PARTY     
          AND ORDER_NO = @@ORDER_NO    
          FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@ORDER_NO    
     END    
    
     CLOSE @@PARTYCONT    
     SET @@PARTY=''    
     SET @@ORDER_NO = ''     
          
        SET @@PARTYCONT = CURSOR FOR     
		SELECT DISTINCT BBGBFOSETTLEMENT.PARTY_CODE,SERIES_CODE    
		FROM BBGBFOSETTLEMENT,CLIENT2,CLIENT1    
		WHERE CONTRACTNO='0000000'  AND BBGBFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'    
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'    
        ORDER BY BBGBFOSETTLEMENT.PARTY_CODE,SERIES_CODE   
        OPEN @@PARTYCONT    
        FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@SERIES_CODE
        WHILE @@FETCH_STATUS = 0    
        BEGIN    
		  SET @@CONTNO = 0    
		  SET @@CONTNO =@@MAXCONTNOS +1    
		  SET @@MAXCONTNOS = @@MAXCONTNOS + 1    
		  UPDATE BBGBFOSETTLEMENT SET CONTRACTNO = CASE WHEN @@TRDDELFLAG = 1 THEN 'E' ELSE '' END + 
					 STUFF(CASE WHEN @@TRDDELFLAG = 1 THEN '000000' ELSE '0000000' END, 
					 (CASE WHEN @@TRDDELFLAG = 1 THEN 7 ELSE 8 END) - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO)
		  WHERE    
		  PARTY_CODE = @@PARTY AND    
		  SERIES_CODE = @@SERIES_CODE     
 
        FETCH NEXT FROM @@PARTYCONT INTO @@PARTY,@@SERIES_CODE    
        END    
        CLOSE @@PARTYCONT    
 DEALLOCATE @@PARTYCONT    
 UPDATE BFOOWNER SET CONTNO = @@CONTNO     
  
IF @@STYLE = 1     
 BEGIN     
 	 IF @@TRDDELFLAG = 0
	 BEGIN 
		UPDATE CONTGEN SET CONTRACTNO = @@CONTNO WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE     
	 END
	 ELSE
	 BEGIN 
		UPDATE CONTGEN SET OPTDELCONTRACTNO = @@CONTNO WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE     
	 END
 END
 
INSERT INTO BFOSETTLEMENT SELECT * FROM BBGBFOSETTLEMENT    
    
TRUNCATE TABLE  BFOEXALLOCTRADE    

COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOREARRANGETRDFLAG
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[FOREARRANGETRDFLAG] AS

DECLARE  
	@@SAUDA_DATE VARCHAR(11),  
	@@FLAG CURSOR, 
	@@LOOP CURSOR,   
	@@TPARTY_CODE VARCHAR(10),
	@@SERIES_CODE VARCHAR(22),
	@@TPQTY INT,  
	@@TSQTY INT,
	@@PDIFF INT,
	@@LTRADE_NO VARCHAR(12),
	@@LQTY INT


SELECT TOP 1 @@SAUDA_DATE = LEFT(SAUDA_DATE,11) FROM BFOTRADE  
 
UPDATE BFOTRADE SET SETTFLAG = '1' FROM BFOTRADE , CLIENT2   WHERE     
CLIENT2.TRAN_CAT = 'DEL'   AND CLIENT2.PARTY_CODE = BFOTRADE.PARTY_CODE   
   
UPDATE BFOTRADE SET SETTFLAG =   
(CASE WHEN SELL_BUY=1 THEN '2' ELSE '3' END)   
FROM CLIENT2, BFOTRADE  WHERE     
BFOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND CLIENT2.TRAN_CAT = 'TRD'  
    
SELECT 
S.PARTY_CODE,S.SERIES_CODE ,  
PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),      
SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
INTO #TRADE  
FROM BFOTRADE S  ,CLIENT2 C WHERE S.PARTY_CODE = C.PARTY_CODE AND C.TRAN_CAT = 'TRD'     
GROUP BY S.PARTY_CODE, SERIES_CODE    
HAVING ( SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) = 0 AND SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0)      
OR (SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) = 0 AND SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 )  

UPDATE BFOTRADE SET SETTFLAG = (CASE WHEN PQTY = 0 THEN 5 ELSE 4 END)      
FROM BFOTRADE T, #TRADE T1       
WHERE T.PARTY_CODE = T1.PARTY_CODE      
AND T.SERIES_CODE = T1.SERIES_CODE  

SELECT S.PARTY_CODE,S.SERIES_CODE ,  
PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),      
SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
INTO #TRADENEW  
FROM BFOTRADE S WHERE SETTFLAG IN (2,3)  
GROUP BY S.PARTY_CODE, SERIES_CODE   
  
  
     
SET @@FLAG = CURSOR FOR   
SELECT S.PARTY_CODE,S.SERIES_CODE, PQTY, SQTY  
FROM #TRADENEW S  
ORDER BY S.PARTY_CODE,SERIES_CODE 

OPEN @@FLAG      
FETCH NEXT FROM @@FLAG INTO @@TPARTY_CODE,@@SERIES_CODE,@@TPQTY,@@TSQTY 

WHILE ( (@@FETCH_STATUS = 0)  )      
BEGIN  
      IF  @@TSQTY = 0      
      BEGIN
			UPDATE BFOTRADE SET SETTFLAG = 4      
			WHERE PARTY_CODE = @@TPARTY_CODE       
			AND SERIES_CODE = @@SERIES_CODE  		   
      END
      IF  @@TPQTY = 0      
      BEGIN
			UPDATE BFOTRADE SET SETTFLAG = 5     
			WHERE PARTY_CODE = @@TPARTY_CODE       
			AND SERIES_CODE = @@SERIES_CODE  		   
      END
      
     IF  ( (@@TPQTY > @@TSQTY) AND (@@TSQTY > 0 ))       
     BEGIN       
			 SELECT @@PDIFF = @@TPQTY - @@TSQTY 
          
              SET @@LOOP  = CURSOR FOR  
              SELECT TRADE_NO,TRADEQTY FROM BFOTRADE   
              WHERE PARTY_CODE = @@TPARTY_CODE       
              AND SERIES_CODE = @@SERIES_CODE  
              AND SELL_BUY = 2  
              ORDER BY TRADE_PRICE DESC        
              OPEN @@LOOP
              
              FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
              WHILE ( @@FETCH_STATUS = 0 ) AND (@@PDIFF > 0)       
              BEGIN      
                   IF @@PDIFF >= @@LQTY       
                   BEGIN  
						UPDATE BFOTRADE SET SETTFLAG = 4         
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND SERIES_CODE = @@SERIES_CODE  
						AND SELL_BUY = 1       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY       
   
                        SELECT @@PDIFF = @@PDIFF - @@LQTY      
                   END  
                   ELSE IF @@PDIFF < @@LQTY       
                   BEGIN      
						INSERT INTO BFOTRADE
						SELECT 'T'+TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,
						ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,@@PDIFF,
						SETTFLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,
						OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,
						SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,0,0,0,0,0,0,0
						FROM BFOTRADE (NOLOCK)
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND SERIES_CODE = @@SERIES_CODE  
						AND SELL_BUY = 1       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY                        

						UPDATE BFOTRADE SET SETTFLAG = 2,TRADEQTY = @@LQTY - @@PDIFF          
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND SERIES_CODE = @@SERIES_CODE  
						AND SELL_BUY = 1       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY      

						SELECT @@PDIFF = 0         
                  END      
                    IF @@PDIFF = 0       
                    BREAK      
                    FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
              END      
              CLOSE @@LOOP 
          END
          
 
          IF  ( (@@TPQTY < @@TSQTY) AND (@@TPQTY > 0 ))       
          BEGIN       
	      SELECT @@PDIFF = @@TSQTY - @@TPQTY      
  
              SET @@LOOP  = CURSOR FOR  
              SELECT TRADE_NO,TRADEQTY FROM BFOTRADE   
              WHERE PARTY_CODE = @@TPARTY_CODE       
              AND SERIES_CODE = @@SERIES_CODE 
              AND SELL_BUY = 2  
              ORDER BY TRADE_PRICE DESC        
              OPEN @@LOOP      
  
              FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
              WHILE ( @@FETCH_STATUS = 0 ) AND (@@PDIFF > 0)       
              BEGIN      
                   IF @@PDIFF >= @@LQTY       
                   BEGIN      
  
						UPDATE BFOTRADE SET SETTFLAG = 5  
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND SERIES_CODE = @@SERIES_CODE 
						AND SELL_BUY = 2  
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY        
  
                        SELECT @@PDIFF = @@PDIFF - @@LQTY      
                   END          
                   ELSE IF @@PDIFF < @@LQTY       
                   BEGIN      
  
                    INSERT INTO BFOTRADE 
						SELECT 'T'+TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,
						ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,@@PDIFF,
						SETTFLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,
						OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,
						SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,0,0,0,0,0,0,0
						FROM BFOTRADE  
                        WHERE PARTY_CODE = @@TPARTY_CODE       
						AND SERIES_CODE = @@SERIES_CODE
						AND SELL_BUY = 2       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY                        
  
						UPDATE BFOTRADE SET SETTFLAG = 3,TRADEQTY = @@LQTY - @@PDIFF          
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND SERIES_CODE = @@SERIES_CODE
						AND SELL_BUY = 2  
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY      
  
                        SELECT @@PDIFF = 0         
                    END      
                    IF @@PDIFF = 0       
                    BREAK      
                    FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
               END      
               CLOSE @@LOOP        
  
            END      

                        
                              
     
     
FETCH NEXT FROM @@FLAG INTO @@TPARTY_CODE,@@SERIES_CODE,@@TPQTY,@@TSQTY 
END      
CLOSE @@FLAG      
DEALLOCATE @@FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FORISKMGMTEXPOSURE_UPDATE
-- --------------------------------------------------
CREATE   PROC [DBO].[FORISKMGMTEXPOSURE_UPDATE] @EXPDATE VARCHAR(11)
AS  


TRUNCATE TABLE FORISKMGMTEXPOSURE_TBL   

INSERT INTO FORISKMGMTEXPOSURE_TBL  
SELECT @EXPDATE,PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,0 CL_RATE,0 PRICE,PQTY,SQTY,@EXPDATE
FROM  
(
      SELECT PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,
      PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ),
      SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END )
      FROM BFOSETTLEMENT 
      WHERE SAUDA_DATE <= @EXPDATE +' 23:59:00'  
      AND EXPIRYDATE >= @EXPDATE +' 23:59:00'  
      AND RESERVED1 NOT IN ('1','3')
      GROUP BY PARTY_CODE,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID
      HAVING SUM(CASE WHEN SELL_BUY= 1 THEN TRADEQTY ELSE -TRADEQTY END ) <> 0
) S


UPDATE FORISKMGMTEXPOSURE_TBL  
      SET CL_RATE = (SELECT ISNULL(MAX(F.CL_RATE),0)
                        FROM BFOCLOSING F  
                        WHERE FORISKMGMTEXPOSURE_TBL.PRODUCT_TYPE = F.PRODUCT_TYPE  
                        AND FORISKMGMTEXPOSURE_TBL.PRODUCT_CODE = F.PRODUCT_CODE  
                        AND FORISKMGMTEXPOSURE_TBL.SERIES_CODE = F.SERIES_CODE  
                        AND FORISKMGMTEXPOSURE_TBL.SERIES_ID = F.SERIES_ID
                        AND TRADE_DATE = (SELECT MAX(TRADE_DATE) FROM BFOCLOSING C1   
                                                      WHERE C1.PRODUCT_TYPE = F.PRODUCT_TYPE  
                                                      AND C1.PRODUCT_CODE = F.PRODUCT_CODE  
                                                      AND C1.SERIES_CODE = F.SERIES_CODE  
                                                      AND C1.SERIES_ID = F.SERIES_ID  
                                                      ) )  
WHERE  FORISKMGMTEXPOSURE_TBL.CL_RATE = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_IDUSER_LIST
-- --------------------------------------------------
CREATE PROC [dbo].[GET_IDUSER_LIST]  
(  
 @IDUSER VARCHAR(30)  
)  
  
AS  
  
SET @IDUSER = UPPER(@IDUSER)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
IF @IDUSER = 'BRANCH'  
 BEGIN  
  SELECT DISTINCT BRANCH_CODE, BRANCH = UPPER(BRANCH) FROM BRANCH (NOLOCK) ORDER BY BRANCH  
 END  
ELSE IF @IDUSER = 'SUBBROKER'  
 BEGIN   
  SELECT DISTINCT SUB_BROKER, NAME = UPPER(NAME) FROM SUBBROKERS (NOLOCK) WHERE SUB_BROKER <> '' AND NAME <> '' ORDER BY NAME   
 END  
ELSE IF @IDUSER = 'TRADER'  
 BEGIN  
 SELECT DISTINCT SHORT_NAME,LONG_NAME FROM BRANCHES (NOLOCK) WHERE SHORT_NAME <> '' AND LONG_NAME <> '' ORDER BY LONG_NAME   
 END  
ELSE IF @IDUSER = 'AREA'  
 BEGIN  
  SELECT DISTINCT AREACODE,DESCRIPTION FROM AREA (NOLOCK) ORDER BY DESCRIPTION  
 END   
ELSE IF @IDUSER = 'REGION'  
 BEGIN  
  SELECT DISTINCT REGIONCODE,DESCRIPTION FROM REGION (NOLOCK) ORDER BY DESCRIPTION  
 END  
ELSE IF @IDUSER = 'FAMILY'  
 BEGIN  
  SELECT DISTINCT FAMILY, FAMILY AS DESCRIPTION FROM MSAJAG.DBO.CLIENT_DETAILS (NOLOCK) WHERE FAMILY <> '' AND FAMILY <> CL_CODE ORDER BY DESCRIPTION  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_PWD_EXPIRY
-- --------------------------------------------------
--EXEC GET_PWD_EXPIRY 'PIYUSH'
CREATE PROC [DBO].[GET_PWD_EXPIRY]
(
  @UNAME VARCHAR(100)
)
AS
SELECT LTRIM(RTRIM(T.FLDFIRSTNAME)) AS FIRSTNAME,   
 CASE WHEN DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 2  THEN  'THE DAY AFTER TOMORROW'  
 ELSE  
 	CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 1  THEN  'TOMORROW'  
 ELSE  
	CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 0  THEN  '<U>TODAY</U>'  
 ELSE  
	'ON ' + LEFT(CONVERT(VARCHAR, T.PWD_EXPIRY_DATE, 109), 11)  
END 
END 
END  
 AS PWD_EXPIRY_DATE  
 FROM  
	TBLPRADNYAUSERS T, TBLADMIN A 
 WHERE  
	T.FLDADMINAUTO = A.FLDAUTO_ADMIN  
	AND T.FLDUSERNAME = @UNAME 
	AND GETDATE() <= T.PWD_EXPIRY_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_CATEGORY
-- --------------------------------------------------
--GET_USER_CATEGORY 400
CREATE PROC [DBO].[GET_USER_CATEGORY]
(
  @FLDCATEGORY INT
)
AS
SELECT FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @FLDCATEGORY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_EDIT
-- --------------------------------------------------
CREATE PROC [dbo].[GET_USER_EDIT]
(
	@UID	VARCHAR(25),
	@UNAME	VARCHAR(25),
	@CAT	VARCHAR(15),
	@ADMIN_ID INT 
)			
/*
	SELECT * FROM TBLPRADNYAUSERS WHERE FLDCATEGORY = 0
	EXEC GET_USER_EDIT '','', '','2' 
*/
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	(SELECT 
		UPPER(T.FLDUSERNAME) AS FLDUSERNAME, 
		UPPER(T.FLDFIRSTNAME) AS FLDFIRSTNAME, 
		UPPER(T.FLDLASTNAME) AS FLDLASTNAME, 
		T.FLDPHONE1, 
		T.FLDPHONE2, 
		T.FLDAUTO, 
		UPPER(C.FLDCATEGORYNAME) AS FLDCATEGORYNAME 
	FROM  
		TBLPRADNYAUSERS T,TBLCATEGORY C  
	WHERE 
		T.FLDCATEGORY = C.FLDCATEGORYCODE  
		AND  T.FLDADMINAUTO = @ADMIN_ID    
		AND T.FLDUSERNAME LIKE @UID + '%' 
		AND FLDUSERNAME LIKE @UNAME + '%' 
		AND FLDCATEGORY LIKE @CAT +'%' 
	)
	UNION ALL
	(
	SELECT 
		UPPER(FLDUSERNAME),
		UPPER(FLDFIRSTNAME),
		UPPER(FLDLASTNAME),
		FLDPHONE1,
		FLDPHONE2,
		FLDAUTO, 
		FLDCATEGORYNAME = '0'
	FROM 
		TBLPRADNYAUSERS T  
	WHERE 
		FLDADMINAUTO = @ADMIN_ID AND FLDCATEGORY = '0'  
		AND T.FLDUSERNAME LIKE  @UID + '%' 
		AND FLDUSERNAME LIKE @UNAME + '%' 
	)
	ORDER BY 7,1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_FOREDIT
-- --------------------------------------------------
CREATE PROC [dbo].[GET_USER_FOREDIT]
(
	@FLDAUTO INT
)
AS
/*
GET_USER_FOREDIT 81848
select * from TBLUSERCONTROLMASTER where flduserid = 81848
*/
SELECT 
	T.FLDAUTO,
	FLDUSERNAME,
	FLDPASSWORD,
	FLDFIRSTNAME,
	FLDMIDDLENAME,
	FLDLASTNAME,
	FLDSEX,
	FLDADDRESS1,
	FLDADDRESS2,
	FLDPHONE1,	
	FLDPHONE2,	
	FLDCATEGORY,
	FLDADMINAUTO,
	FLDSTNAME,
	PWD_EXPIRY_DATE,
	TB.FLDPWDEXPIRY,
	TB.FLDMAXATTEMPT,
	TB.FLDATTEMPTCNT,
	TB.FLDSTATUS,
	TB.FLDLOGINFLAG,
	TB.FLDACCESSLVL,
	TB.FLDIPADD,
	TB.FLDFIRSTLOGIN,
	TB.FLDFORCELOGOUT,
	FLD_MAC_ID
FROM 
	TBLPRADNYAUSERS T, TBLUSERCONTROLMASTER TB
WHERE
	T.FLDAUTO = @FLDAUTO  
	AND T.FLDAUTO = FLDUSERID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.INDEX_GETINDEXNAME
-- --------------------------------------------------
CREATE PROC [DBO].[INDEX_GETINDEXNAME] AS  
DECLARE @TABLENAME VARCHAR(100),  
@CURTBL CURSOR,  
@SQL VARCHAR(150)  
  
CREATE TABLE #TBL_INDEX  
(SNO INT IDENTITY (1, 1) NOT NULL,  
 INDEXNAME VARCHAR(100) NOT NULL,  
 TABLENAME VARCHAR(100) NOT NULL)  
  
SET @CURTBL = CURSOR FOR  
SELECT NAME FROM SYSOBJECTS   
WHERE XTYPE = 'U'  
ORDER BY NAME   
OPEN @CURTBL  
FETCH NEXT FROM  @CURTBL INTO @TABLENAME  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 INSERT INTO #TBL_INDEX  

      SELECT I.NAME, TABLENAME=@TABLENAME
      FROM (DBO.SYSINDEXES I INNER JOIN
         DBO.SYSFILEGROUPS S ON
         I.GROUPID = S.GROUPID )
      WHERE ID = OBJECT_ID(@TABLENAME) AND I.INDID > 0 AND I.INDID < 255 AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISSTATISTICS') <> 1) AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISAUTOSTATISTICS') <> 1) AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISHYPOTHETICAL') <> 1) 

   
 FETCH NEXT FROM  @CURTBL INTO @TABLENAME  
END  
CLOSE @CURTBL  
DEALLOCATE @CURTBL  
  
SELECT * FROM #TBL_INDEX  
ORDER BY TABLENAME, INDEXNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ins_FoFtTrade
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Ins_FoFtTrade] (@INTMODE INT) AS  
  
 IF @INTMODE = 1   
  BEGIN  
	  TRUNCATE TABLE BFOFTTRADE
      /*STANDARD FILE*/   

	    UPDATE A SET RPTDTXSTS = PROCESS_VALUE
		FROM FOTRADE_STANDARD_IMP A,MSAJAG..TBL_STANDARD_VALUES B
		WHERE A.RPTDTXSTS = B.FIELD_VALUE
		AND FIELD_DESC='TRADESTATUS'
		AND EXCHANGE='NSE'
		AND SEGMENT='CAPITAL'

 	  INSERT INTO BFOFTTRADE(TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,
	  STRIKE_PRICE,OPTION_TYPE,CA_LEVEL,BUY_BROKER,SELL_BROKER,TRADE_PRICE,TRADEQTY,SERIES_ID,
	  BUYER_LOCATIONID,BUY_CM_CODE,SELL_CM_CODE,SELLER_LOCATIONID,BUY_PARTICIPANT,BUY_CONFIRMATION,SELL_PARTICIPANT,SELL_CONFIRMATION,
	  BUY_OC_FLAG,SELL_OC_FLAG, BUY_OLD_PARTICIPANT,BUY_OLD_CM_CODE,SELL_OLD_PARTICIPANT,SELL_OLD_CM_CODE,
	  BUY_TERMINALID,SELL_TERMINALID,BUY_ORDER_NO,SELL_ORDER_NO,BUY_CLIENT_CODE,SELL_CLIENT_CODE,BUY_REMARKS,SELL_REMARKS,
	  BUY_POSITION,SELL_POSITION,BUY_PRO_CLI,SELL_PRO_CLI,BUY_ORDER_TIMESTAMP,SELL_ORDER_TIMESTAMP,BUY_ORDER_ACTIVEFLAG,SELL_ORDER_ACTIVEFLAG)  
	  SELECT
        TRADE_NO = UNQTRADIDR,--CONVERT(VARCHAR,convert(int,(RIGHT(UNQTRADIDR,LEN(UNQTRADIDR)-8)))),
		SAUDA_DATE = CONVERT(DATETIME,CAST(CONVERT(DATETIMEOFFSET,TRADDTTM,127) AS DATETIME),103),
		TRADESTATUS = RPTDTXSTS,
		SEGMENT = 'F',
		SETT_TYPE = 'F', 
		PRODUCT_TYPE = '', 
		PRODUCT_CODE = '',
		ASSET_CODE = '',
		EXPIRYDATE = XPRYDT, 
		STRIKE_PRICE = ISNULL(STRKPRIC,0),  
                OPTION_TYPE = CASE WHEN OPTNTP='XX' THEN '' ELSE OPTNTP END,
		CA_LEVEL = 0,
		BUY_BROKER = CASE WHEN BUYSELLIND='B' THEN BRKR ELSE '' END, 
		SELL_BROKER = CASE WHEN BUYSELLIND='S' THEN BRKR ELSE '' END,
		TRADE_PRICE = PRIC,
		TRADEQTY = TRADQTY,
		SERIES_ID = 0,
		BUYER_LOCATIONID = '', 
		BUY_CM_CODE = CASE WHEN BUYSELLIND='B' THEN CLRMMBID ELSE '' END , 
		SELL_CM_CODE = CASE WHEN BUYSELLIND='S' THEN CLRMMBID ELSE '' END,
		SELLER_LOCATIONID = '',
		BUY_PARTICIPANT = CASE WHEN BUYSELLIND='B' THEN CTDNPTCPTID ELSE '' END,
		BUY_CONFIRMATION = CASE WHEN BUYSELLIND='B' THEN FULLYEXCTDCONFSNT ELSE '' END,
		SELL_PARTICIPANT = CASE WHEN BUYSELLIND='S' THEN CTDNPTCPTID ELSE '' END,
		SELL_CONFIRMATION = CASE WHEN BUYSELLIND='S' THEN FULLYEXCTDCONFSNT ELSE '' END,
		BUY_OC_FLAG = '',
		SELL_OC_FLAG = '',
		BUY_OLD_PARTICIPANT = CASE WHEN BUYSELLIND='B' THEN CTDNPTCPTID ELSE '' END,
		BUY_OLD_CM_CODE = CASE WHEN BUYSELLIND='B' THEN CLRMMBID ELSE '' END  ,
		SELL_OLD_PARTICIPANT = CASE WHEN BUYSELLIND='S' THEN CTDNPTCPTID ELSE '' END,
		SELL_OLD_CM_CODE= CASE WHEN BUYSELLIND='B' THEN CLRMMBID ELSE '' END,
		BUY_TERMINALID = CASE WHEN BUYSELLIND='B' THEN INSTGUSR ELSE '' END ,
		SELL_TERMINALID = CASE WHEN BUYSELLIND='S' THEN INSTGUSR ELSE '' END,
		BUY_ORDER_NO = CASE WHEN BUYSELLIND='B' THEN ORDRREF ELSE '' END,
		SELL_ORDER_NO = CASE WHEN BUYSELLIND='S' THEN ORDRREF ELSE '' END,
		BUY_CLIENT_CODE = CASE WHEN BUYSELLIND='B' THEN CLNTID ELSE '' END,
		SELL_CLIENT_CODE = CASE WHEN BUYSELLIND='S' THEN CLNTID ELSE '' END,
		BUY_REMARKS = CASE WHEN BUYSELLIND='B' THEN RMKS ELSE '' END,
		SELL_REMARKS = CASE WHEN BUYSELLIND='S' THEN RMKS ELSE '' END,
		BUY_POSITION = '0',--CASE WHEN BUYSELLIND='B' THEN TRADQTY ELSE '' END,--?????
		SELL_POSITION = '0',--CASE WHEN BUYSELLIND='S' THEN TRADQTY ELSE '' END,--????
		BUY_PRO_CLI = CASE WHEN BUYSELLIND='B' THEN CLNTTP ELSE '' END,
		SELL_PRO_CLI = CASE WHEN BUYSELLIND='S' THEN CLNTTP ELSE '' END,
		BUY_ORDER_TIMESTAMP =  CASE WHEN BUYSELLIND='B' THEN CAST(CONVERT(DATETIMEOFFSET,TRADDTTM,127) AS DATETIME) ELSE '' END,
		SELL_ORDER_TIMESTAMP =  CASE WHEN BUYSELLIND='S' THEN CAST(CONVERT(DATETIMEOFFSET,TRADDTTM,127) AS DATETIME) ELSE '' END ,
		BUY_ORDER_ACTIVEFLAG = CASE WHEN BUYSELLIND='B' THEN CASE WHEN ORDRTP='P' THEN '0' ELSE '1' END END,
		SELL_ORDER_ACTIVEFLAG = CASE WHEN BUYSELLIND='S' THEN CASE WHEN ORDRTP='P' THEN '0' ELSE '1' END ELSE '' END
      FROM FOTRADE_STANDARD_IMP
	  WHERE XCHG='BSE'
	  AND SGMT='FO'

		UPDATE BFOFTTRADE_IMP 
		SET 
			EXPIRYDATE = F.EXPIRYDATE,
			ASSET_CODE = F.ASSET_CODE,
			STRIKE_PRICE = F.STRIKE_PRICE,
			OPTION_TYPE = F.OPTION_TYPE
		FROM BFOSCRIP2 F (NOLOCK)
		WHERE
			F.PRODUCT_TYPE = BFOFTTRADE_IMP.PRODUCT_TYPE
			AND F.PRODUCT_CODE = BFOFTTRADE_IMP.PRODUCT_CODE
			AND F.SERIES_ID = BFOFTTRADE_IMP.SERIES_ID

	  --TRUNCATE TABLE FOTRADE_CTCLID_TMP      
	  --INSERT INTO FOTRADE_CTCLID_TMP
   --   SELECT DISTINCT TRADDTTM,UNQTRADIDR,FinInstrmTp,TckrSymb,XpryDt,StrkPric,OptnTp,SRSCD,'B'
   --   FROM FOTRADE_STANDARD_IMP WHERE ISNULL(SRSCD,'') <> ''
	   
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MCX_CONTRACTPRINT_SUM_PS
-- --------------------------------------------------
/*    
PROC NAME : MCX_CONTRACTPRINT    
SEGMENT : MCDX FUT    
DESC : TO FETCH DATA FOR CONTRACT PRINTING (PRE PRINTED STATIONARY)    
DATE : 8 MAY 2004    
MODIFICATION LOG : 15 SEP 04    
*/    
      
CREATE  PROCEDURE [DBO].[MCX_CONTRACTPRINT_SUM_PS]    
@FPARTYCODE VARCHAR(16),    
@TPARTYCODE VARCHAR(16),    
@FDATEFROM  VARCHAR(11),    
@TDATEFROM  VARCHAR(11),    
@STATUSID VARCHAR(15),    
@STATUSNAME VARCHAR(25),    
@STRBRANCH VARCHAR(12)='',      
@STRSUBBROKFROM VARCHAR(12)='',      
@STRSUBBROKTO VARCHAR(12)=''          
    
AS    
    
IF @STRSUBBROKTO=''        
 BEGIN        
     SET @STRSUBBROKTO='ZZZZZZZZZZ'        
END   
  
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


	SELECT  ORDER_NO=MIN(ORDER_NO),TRADE_NO=MIN(TRADE_NO), TRADETIME=MIN(CONVERT(VARCHAR,SAUDA_DATE,108)),      
	TRADEQTY = SUM(TRADEQTY),ISNULL((SUM(PRICE *TRADEQTY)/SUM(TRADEQTY)),0) PRICE,      
	 ISNULL(SUM(TRADEQTY * PRICE*BOOKTYPE/INSTRUMENT),0) VALUE , 
	BROKAPPLIED = CONVERT(MONEY,SUM(ISNULL(BROKAPPLIED + 
               (CASE WHEN C2.SERVICE_CHRG = 1 THEN ISNULL( ((F.SERVICE_TAX*INSTRUMENT/BOOKTYPE )/TRADEQTY),0) ELSE 0 END),0))),

	TOTBROKAPPLIED = CONVERT(MONEY,SUM(ISNULL((BROKAPPLIED * TRADEQTY *  BOOKTYPE / INSTRUMENT) +
		(CASE WHEN C2.SERVICE_CHRG = 1 THEN ISNULL(F.SERVICE_TAX,0) ELSE 0 END),0))) ,

	CASE WHEN SELL_BUY = 1 THEN
	ISNULL(SUM(NETRATE +  (CASE WHEN C2.SERVICE_CHRG = 1 THEN ISNULL(((F.SERVICE_TAX*INSTRUMENT/BOOKTYPE )/TRADEQTY),0) ELSE 0 END) *TRADEQTY)/SUM(TRADEQTY),0)
	ELSE
	ISNULL(SUM(NETRATE -  (CASE WHEN C2.SERVICE_CHRG = 1 THEN ISNULL(((F.SERVICE_TAX*INSTRUMENT/BOOKTYPE )/TRADEQTY),0) ELSE 0 END) *TRADEQTY)/SUM(TRADEQTY),0)
	END NETRATE,

	F.INST_TYPE,F.SYMBOL,       
	LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,106),11) AS EXPIRYDATE,F.PARTY_CODE,SELL_BUY,CONTRACTNO,      
	CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, ISNULL(F.STRIKE_PRICE,0) STRIKE_PRICE, F.OPTION_TYPE,      
	
	AMT = (CASE WHEN SELL_BUY = 1 THEN (SUM(TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) +
        	(CASE WHEN C2.SERVICE_CHRG = 1 THEN ISNULL(SUM(F.SERVICE_TAX),0) ELSE
            	  (CASE WHEN C2.SERVICE_CHRG = 0 THEN 0 ELSE
                    (CASE WHEN C2.SERVICE_CHRG = 2 THEN 0 ELSE 0  END ) END) END ) )
         ELSE (SUM(TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) - 
	        (CASE WHEN C2.SERVICE_CHRG = 1 THEN ISNULL(SUM(F.SERVICE_TAX),0) ELSE
	            (CASE WHEN C2.SERVICE_CHRG = 0 THEN 0 ELSE
	                (CASE WHEN C2.SERVICE_CHRG = 2 THEN 0 ELSE  0 END ) END ) END)) END ),
	SERVICE_TAX =      
	(CASE WHEN C2.SERVICE_CHRG=0 THEN ISNULL(SUM(F.SERVICE_TAX),0)  ELSE      
	             (CASE WHEN C2.SERVICE_CHRG=1  THEN 0 ELSE      
	            (CASE WHEN C2.SERVICE_CHRG=2 THEN  0      
	          END) END) END) ,      
	YEAR (SAUDA_DATE), MONTH(SAUDA_DATE),DAY(SAUDA_DATE),      
	DFLAG = (CASE WHEN 'FEB 15 2002' + ' 23:59:59' <= 'DEC 15 2001 23:59:59' THEN 0 ELSE 1 END),      
	
 BROKER_CHRG= SUM(CASE WHEN BROKERNOTE = 1       
     THEN (BROKER_CHRG)      
     ELSE 0       
             END) ,      
 TURN_TAX=SUM(CASE WHEN TURNOVER_TAX = 1       
     THEN (TURN_TAX)        
     ELSE 0       
             END),      
 SEBI_TAX=SUM(CASE WHEN SEBI_TURN_TAX = 1       
     THEN (SEBI_TAX)        
     ELSE 0       
             END),    
 INSURANCE_CHRG = SUM(CASE WHEN INSURANCE_CHRG = 1    
   THEN (INS_CHRG)    
  ELSE 0    
  END ),     
    
 FOGLOBALS.SERVICE_TAX STAX      
      
 FROM FOSETTLEMENT F, CLIENT1 C1 , CLIENT2 C2, FOSCRIP2 FOS2,FOGLOBALS        
 WHERE F.SYMBOL = FOS2.SYMBOL AND F.INST_TYPE = FOS2.INST_TYPE AND       
 F.EXPIRYDATE = FOS2.EXPIRYDATE AND F.STRIKE_PRICE = FOS2.STRIKE_PRICE AND       
 F.OPTION_TYPE = FOS2.OPTION_TYPE AND       
 F.PARTY_CODE >= @FPARTYCODE AND F.PARTY_CODE <= @TPARTYCODE       
 AND SAUDA_DATE >= @FDATEFROM +' 00:00' AND SAUDA_DATE <=@TDATEFROM + ' 23:59'      
 AND TRADEQTY <> 0 AND F.AUCTIONPART NOT IN ('EA','CA','EX')      
 AND F.PARTY_CODE=C2.PARTY_CODE AND C1.CL_CODE = C2.CL_CODE AND F.AUCTIONPART<>'CA'      
 AND F.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT      
 AND BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE  '%' END)      
 AND SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE  '%' END)      
 AND TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE  '%' END)      
 AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE  '%' END)      
 AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE  '%' END)      
 AND C2.PRINTF IN( '2' ,'4')     
 AND BRANCH_CD LIKE @STRBRANCH +'%'         
 AND SUB_BROKER BETWEEN  @STRSUBBROKFROM  AND  @STRSUBBROKTO         
  
      
      
 GROUP BY  F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,F.OPTION_TYPE,F.STRIKE_PRICE,      
 F.SELL_BUY,C2.SERVICE_CHRG, CONVERT(VARCHAR,SAUDA_DATE,103),YEAR (SAUDA_DATE), MONTH(SAUDA_DATE),      
 DAY(SAUDA_DATE),CONTRACTNO,FOGLOBALS.SERVICE_TAX,F.SAUDA_DATE      

 ORDER BY YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),F.PARTY_CODE ,F.INST_TYPE, F.SYMBOL, YEAR(F.EXPIRYDATE),     
 MONTH(F.EXPIRYDATE),DAY(F.EXPIRYDATE),F.OPTION_TYPE, F.STRIKE_PRICE, SELL_BUY,SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MERGECONTRACT
-- --------------------------------------------------
CREATE PROC [DBO].[MERGECONTRACT]
	@PARTY_CODE VARCHAR(10),
	@SYMBOL VARCHAR(20),
	@STRSYMBOL VARCHAR(100),
	@SELLBUY INT,
	@SAUDA_DATE VARCHAR(11),
	@MKTRATE NUMERIC(18, 4),
	@NETRATE NUMERIC(18, 4),
	@BROKRGE NUMERIC(18, 4),
	@EDITNET BIT,
	@ROUNDING VARCHAR(5),
	@CONTRACTNOS VARCHAR(8000),
	@UNAME VARCHAR(50),
	@CALLEDFROM VARCHAR(100)

AS

/*---------------------------------------------------------------------------
	PROC NAME   : TRADE_CONSOLIDATION_PROC
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CALLING FOR MERGIN TWO CONTRACTS & CONSIDATION
------------------------------------------------------------------------------
EXEC MERGECONTRACT 'V008', 'ICICIBANK', 'ICICIBANK|FUTSTK|26/11/2009|0|', 2, '30/10/2009', 794.8794, 0, 0, 0, '4|4|4', '0007803,0007824', 'DEMO/BROKER/192.168.0.8', '/INSAPP_FO/CONTRACTMERGER.ASPX'
*/

	DECLARE
		@INNERCONTRACT VARCHAR(7),
		@CONTPOS INT,
		@CONTRACTNO VARCHAR(7),
		@INST_TYPE VARCHAR(10),
		@EXPIRYDATE VARCHAR(11),
		@STRIKE_PRICE NUMERIC(18,2),
		@OPTION_TYPE VARCHAR(10)

	SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@STRSYMBOL, '|', 2))) 
	SET @EXPIRYDATE = LTRIM(RTRIM(.DBO.PIECE(@STRSYMBOL, '|', 3))) 
	IF LEN(@EXPIRYDATE) = 10 AND CHARINDEX('/', @EXPIRYDATE) > 0
		BEGIN
			SET @EXPIRYDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EXPIRYDATE, 103), 109)
		END
	SET @STRIKE_PRICE = LTRIM(RTRIM(.DBO.PIECE(@STRSYMBOL, '|', 4))) 
	SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@STRSYMBOL, '|', 5)))

IF LEN(RTRIM(LTRIM(@SAUDA_DATE))) = 10
	BEGIN
		SET @SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
	END
SET @CONTPOS = 1
CREATE TABLE #CONTRACTS
(
	CONTRACTNO VARCHAR(7)
)
WHILE 1 = 1
	BEGIN
		SET @INNERCONTRACT = .DBO.PIECE(@CONTRACTNOS, ',', @CONTPOS)
		IF @INNERCONTRACT IS NOT NULL AND @INNERCONTRACT <> ''
			BEGIN
				INSERT INTO #CONTRACTS (CONTRACTNO) VALUES (@INNERCONTRACT)
			END
		ELSE
			BEGIN
				BREAK
			END
		SET @CONTPOS = @CONTPOS + 1
	END
SELECT @CONTRACTNO = MIN(CONTRACTNO) FROM #CONTRACTS
DELETE FROM #CONTRACTS WHERE CONTRACTNO = @CONTRACTNO

INSERT INTO INST_LOG
	(
		PARTY_CODE,
		NEW_PARTY_CODE,
		SAUDA_DATE,		
		SYMBOL,		
		ORDER_NO,
		TRADE_NO,
		SELL_BUY,
		CONTRACT_NO,
		NEW_CONTRACT_NO,
		BROKERAGE,
		NEW_BROKERAGE,
		MARKET_RATE,
		NEW_MARKET_RATE,
		NET_RATE,
		NEW_NET_RATE,
		QTY,
		NEW_QTY,
		PARTICIPANT_CODE,
		NEW_PARTICIPANT_CODE,
		USERNAME,
		MODULE,
		CALLED_FROM,
		TIMESTAMP,
		EXTRAFIELD3,
		EXTRAFIELD4,
		EXTRAFIELD5
	)
	SELECT
		I.PARTY_CODE,
		I.PARTY_CODE,
		SAUDA_DATE = @SAUDA_DATE,		
		I.SYMBOL,		
		ORDER_NO = '',
		TRADE_NO = '',
		SELL_BUY,
		I.CONTRACTNO,
		NEW_CONTRACTNO = @CONTRACTNO,
		BROKERAGE = 0,
		NEW_BROKERAGE = 0,
		MARKET_RATE = 0,
		NEW_MARKET_RATE = 0,
		NET_RATE = 0,
		NEW_NET_RATE = 0,
		QTY = 0,
		NEW_QTY = 0,
		PARTICIPANT_CODE = '',
		NEW_PARTICIPANT_CODE = '',
		USERNAME = @UNAME,
		MODULE_NAME = @CALLEDFROM,
		CALLED_FROM = 'CONTRACT MERGING',
		GETDATE(),
		EXTRAFIELD3 = '',
		EXTRAFIELD4 = '',
		EXTRAFIELD5 = ''
	FROM
		FOSETTLEMENT I,
		#CONTRACTS C
	WHERE
		I.SAUDA_DATE LIKE @SAUDA_DATE + '%'
		AND I.PARTY_CODE = @PARTY_CODE
		AND I.INST_TYPE = @INST_TYPE
		AND I.SYMBOL = @SYMBOL
		AND I.EXPIRYDATE LIKE @EXPIRYDATE + '%'
		AND I.STRIKE_PRICE = @STRIKE_PRICE
		AND I.OPTION_TYPE = @OPTION_TYPE		
		AND I.SELL_BUY = @SELLBUY
		AND I.CONTRACTNO = C.CONTRACTNO
	GROUP BY
		I.PARTY_CODE,
		I.SETT_NO,
		I.SETT_TYPE,
		I.SYMBOL,
		I.SERIES,
		I.CONTRACTNO,
		I.SELL_BUY
				
UPDATE
	FOSETTLEMENT
SET
	CONTRACTNO = @CONTRACTNO
FROM
	#CONTRACTS C ,FOSETTLEMENT I
WHERE
	SAUDA_DATE LIKE @SAUDA_DATE + '%'
	AND PARTY_CODE = @PARTY_CODE
	AND INST_TYPE = @INST_TYPE
	AND SYMBOL = @SYMBOL
	AND I.EXPIRYDATE LIKE @EXPIRYDATE + '%'
	AND STRIKE_PRICE = @STRIKE_PRICE
	AND OPTION_TYPE = @OPTION_TYPE
	AND SELL_BUY = @SELLBUY
	AND I.CONTRACTNO = C.CONTRACTNO
IF @EDITNET = 0
	BEGIN
		UPDATE
			FOSETTLEMENT
		SET
			DUMMY1 = 1,
			PRICE = @MKTRATE
		WHERE
			CONVERT(VARCHAR(11), SAUDA_DATE, 109) = @SAUDA_DATE
			AND PARTY_CODE = @PARTY_CODE
			AND INST_TYPE = @INST_TYPE
			AND SYMBOL = @SYMBOL
			AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
			AND STRIKE_PRICE = @STRIKE_PRICE
			AND OPTION_TYPE = @OPTION_TYPE			
			AND SELL_BUY = @SELLBUY
			AND CONTRACTNO = @CONTRACTNO
			EXEC PROC_TRADE_TRANSFER_RECAL  @SAUDA_DATE , @PARTY_CODE , @INST_TYPE , @SYMBOL , @EXPIRYDATE, @STRIKE_PRICE , @OPTION_TYPE,'',''

	END
ELSE
	BEGIN
		DECLARE
			@STMETHOD VARCHAR(10),
			@STVAL NUMERIC(18, 4),
			@GROSSVAL NUMERIC(18, 4),
			@STAX NUMERIC(18, 4)
		SELECT TOP 1
			@STMETHOD = LTRIM(RTRIM(CONVERT(VARCHAR, SERVICE_CHRG))) + '-' + LTRIM(RTRIM(CONVERT(VARCHAR, SERTAXMETHOD)))
		FROM
			CLIENT2
		WHERE
			CL_CODE = @PARTY_CODE
		SELECT
			@STVAL = SERVICE_TAX
		FROM
			FOGLOBALS
		WHERE
			@SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
		IF @STVAL IS NULL
			BEGIN
				SET @STVAL = 0
			END
		IF @STMETHOD = '1-1'
			BEGIN
				UPDATE
					FOSETTLEMENT
				SET
					DUMMY1 = 1,
					PRICE = @MKTRATE,
					NETRATE = @NETRATE,
					N_NETRATE = @NETRATE,
					BROKAPPLIED = @BROKRGE,
					NBROKAPP = @BROKRGE,
					SERVICE_TAX = 0,
					NSERTAX = 0,
					STATUS = 'E'
				WHERE
					PARTY_CODE = @PARTY_CODE
					AND SYMBOL = @SYMBOL
					AND INST_TYPE = @INST_TYPE
					AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
					AND STRIKE_PRICE = @STRIKE_PRICE
					AND OPTION_TYPE = @OPTION_TYPE					
					AND SELL_BUY = @SELLBUY
					AND CONTRACTNO = @CONTRACTNO
					AND CONVERT(VARCHAR(11), SAUDA_DATE, 109) = @SAUDA_DATE
			END
		ELSE IF @STMETHOD = '1-0'
			BEGIN
				SET @GROSSVAL = 100 + @STVAL
				SET @BROKRGE = ((@BROKRGE * 100) / @GROSSVAL)
				SET @NETRATE = @MKTRATE + CASE WHEN @SELLBUY = 1 THEN (@BROKRGE) ELSE (-@BROKRGE) END
				SET @NETRATE = ROUND(@NETRATE, CONVERT(INT, .DBO.PIECE(@ROUNDING, '|', 2)))
				UPDATE
					FOSETTLEMENT
				SET
					DUMMY1 = 1,
					PRICE = @MKTRATE,
					NETRATE = @NETRATE,
					N_NETRATE = @NETRATE,
					BROKAPPLIED = @BROKRGE,
					NBROKAPP = @BROKRGE,
					SERVICE_TAX = (TRADEQTY * ((@BROKRGE * @STVAL)/100)),
					NSERTAX = (TRADEQTY * ((@BROKRGE * @STVAL)/100)),
					STATUS = 'E'
				WHERE
					PARTY_CODE = @PARTY_CODE
					AND SYMBOL = @SYMBOL
					AND INST_TYPE = @INST_TYPE
					AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
					AND STRIKE_PRICE = @STRIKE_PRICE
					AND OPTION_TYPE = @OPTION_TYPE					
					AND SELL_BUY = @SELLBUY
					AND CONTRACTNO = @CONTRACTNO
					AND CONVERT(VARCHAR(11), SAUDA_DATE, 109) = @SAUDA_DATE
			END
		ELSE
			BEGIN
				SET @STAX = ((@BROKRGE * @STVAL) / 100)
				UPDATE
					FOSETTLEMENT
				SET
					DUMMY1 = 1,
					PRICE = @MKTRATE,
					NETRATE = @NETRATE,
					N_NETRATE = @NETRATE,
					BROKAPPLIED = @BROKRGE,
					NBROKAPP = @BROKRGE,
					SERVICE_TAX = (TRADEQTY * ((@BROKRGE * @STVAL)/100)),
					NSERTAX = (TRADEQTY * ((@BROKRGE * @STVAL)/100)),
					STATUS = 'E'
				WHERE
					PARTY_CODE = @PARTY_CODE
					AND SYMBOL = @SYMBOL
					AND INST_TYPE = @INST_TYPE
					AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
					AND STRIKE_PRICE = @STRIKE_PRICE
					AND OPTION_TYPE = @OPTION_TYPE					
					AND SELL_BUY = @SELLBUY
					AND CONTRACTNO = @CONTRACTNO
					AND CONVERT(VARCHAR(11), SAUDA_DATE, 109) = @SAUDA_DATE
			END
	END

EXEC STT_CHARGES_FINAL @SAUDA_DATE, @PARTY_CODE, @PARTY_CODE, @UNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWVALANSUMMARY_FO
-- --------------------------------------------------
CREATE PROC [DBO].[NEWVALANSUMMARY_FO]  
/*  
 EXEC NEWVALANSUMMARY '2006070', 'N', 'APR  1 2006', 'O', 'CLIENT', 'ME123'  
 L.CLTCODE  
 A.ACNAME  
 DRAMT  
 CRAMT  
 VDT  
 CLBAL  
*/  
 @BILLDATE VARCHAR(11),  
 @VDT VARCHAR(11),  
 @DISPOPT VARCHAR(1),  
 @STATUSID VARCHAR(10),  
 @STATUSNAME VARCHAR(30)  
  
AS  
--SELECT * FROM FOACCBILL  
IF @STATUSID <> 'BROKER'  
 BEGIN  
  SELECT   
   CLTCODE = C2.PARTY_CODE,   
   ACNAME = C1.LONG_NAME,   
   DRAMT = CASE WHEN A.SELL_BUY = 1 THEN AMOUNT ELSE 0 END,   
   CRAMT = CASE WHEN A.SELL_BUY = 2 THEN AMOUNT ELSE 0 END,  
   VDT = @VDT,   
   CLBAL = 0  
  FROM   
   BFOACCBILL A, CLIENT1 C1, CLIENT2 C2  
  WHERE   
   C1.CL_CODE = C2.CL_CODE   
   AND C2.PARTY_CODE = A.PARTY_CODE  
   AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE  
   AND @STATUSNAME =   
    (  
     CASE  
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
      WHEN @STATUSID = 'AREA' THEN C1.AREA  
      WHEN @STATUSID = 'REGION' THEN C1.REGION  
      WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
     ELSE  
      'BROKER'  
     END  
    )  
  ORDER BY  
   C2.PARTY_CODE  
 END  
ELSE  
 BEGIN  
  IF @DISPOPT = 'A'  
   BEGIN  
    SELECT   
     CLTCODE = A.PARTY_CODE,   
     ACNAME = M.LONGNAME,   
     DRAMT = SUM(CASE WHEN A.SELL_BUY = 1 THEN A.AMOUNT ELSE 0 END),   
     CRAMT = SUM(CASE WHEN A.SELL_BUY = 2 THEN A.AMOUNT ELSE 0 END),  
     VDT = @VDT,   
     CLBAL = 0  
    FROM   
     BFOACCBILL A, ACCOUNTBFO.DBO.ACMAST M  
    WHERE   
     A.PARTY_CODE = M.CLTCODE  
     AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE  
     AND A.BRANCHCD <> 'ZZZ'  
    GROUP BY  
     A.PARTY_CODE,  
     M.LONGNAME  
    ORDER BY  
     A.PARTY_CODE  
   END  
  ELSE IF @DISPOPT = 'P'  
   BEGIN  
    SELECT   
     CLTCODE = C2.PARTY_CODE,   
     ACNAME = C1.LONG_NAME,   
     DRAMT = CASE WHEN A.SELL_BUY = 1 THEN AMOUNT ELSE 0 END,   
     CRAMT = CASE WHEN A.SELL_BUY = 2 THEN AMOUNT ELSE 0 END,  
     VDT = @VDT,   
     CLBAL = 0  
    FROM   
     BFOACCBILL A, CLIENT1 C1, CLIENT2 C2  
    WHERE   
     C1.CL_CODE = C2.CL_CODE   
     AND C2.PARTY_CODE = A.PARTY_CODE  
     AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE  
    ORDER BY  
     C2.PARTY_CODE  
   END  
  ELSE  
   BEGIN  
    SELECT   
     CLTCODE = PARTY_CODE, ACNAME = LONG_NAME, DRAMT = SUM(DRAMT), CRAMT = SUM(CRAMT), VDT, CLBAL = SUM(CLBAL)  
    FROM  
     (  
      SELECT   
       A.PARTY_CODE,   
       LONG_NAME = M.LONGNAME,   
       DRAMT = SUM(CASE WHEN A.SELL_BUY = 1 THEN A.AMOUNT ELSE 0 END),   
       CRAMT = SUM(CASE WHEN A.SELL_BUY = 2 THEN A.AMOUNT ELSE 0 END),  
       VDT = @VDT,   
       CLBAL = 0  
      FROM   
       BFOACCBILL A, ACCOUNTBFO.DBO.ACMAST M  
      WHERE   
       A.PARTY_CODE = M.CLTCODE  
       AND M.ACCAT NOT IN (4, 14)  
       AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE  
       AND A.BRANCHCD <> 'ZZZ'  
      GROUP BY  
       A.PARTY_CODE,  
       M.LONGNAME  
      UNION ALL  
      SELECT   
       PARTY_CODE = '',  
       LONG_NAME = 'CLIENT SUMMARY',   
       DRAMT = CASE WHEN A.SELL_BUY = 1 THEN AMOUNT ELSE 0 END,   
       CRAMT = CASE WHEN A.SELL_BUY = 2 THEN AMOUNT ELSE 0 END,  
       VDT = @VDT,   
       CLBAL = 0  
      FROM   
       BFOACCBILL A, CLIENT1 C1, CLIENT2 C2  
      WHERE   
       C1.CL_CODE = C2.CL_CODE   
       AND C2.PARTY_CODE = A.PARTY_CODE  
       AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE  
     ) A  
    GROUP BY  
     PARTY_CODE, LONG_NAME, VDT  
   END  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NSE_SCRIPUPLOAD
-- --------------------------------------------------
CREATE  PROC [DBO].[NSE_SCRIPUPLOAD] (@FILEPATH VARCHAR(100)) AS

SELECT * INTO TEMPSCRIP2 FROM SCRIP2 

SELECT * INTO TEMPSCRIP1 FROM SCRIP1 

TRUNCATE TABLE SCRIP_IMP
TRUNCATE TABLE SCRIP1
TRUNCATE TABLE SCRIP2
TRUNCATE TABLE COMPANY

SELECT SCRIP_CD=CONVERT(VARCHAR(12),''),
SERIES=CONVERT(VARCHAR(3),''),
SCRIP_NAME=CONVERT(VARCHAR(50),''),
FILLER1=CONVERT(VARCHAR(12),''),
ISIN=CONVERT(VARCHAR(12),'')
INTO #SCRIP_IMP

--BULK INSERT #SCRIP_IMP FROM @FILEPATH WITH  ( FIELDTERMINATOR = ',', ROWTERMINATOR = '\N' ) 
EXEC PROC_BULK_INS '#SCRIP_IMP', @FILEPATH, ','

INSERT INTO SCRIP_IMP
SELECT * FROM #SCRIP_IMP

INSERT INTO SCRIP_IMP
SELECT DISTINCT SCRIP_CD, S2.SERIES, LONG_NAME, FILLER1='', ISIN  FROM TEMPSCRIP1 S1, TEMPSCRIP2 S2
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES
AND SCRIP_CD NOT IN ( SELECT SCRIP_CD FROM SCRIP_IMP 
WHERE SCRIP_IMP.SCRIP_CD = S2.SCRIP_CD AND SCRIP_IMP.SERIES = S2.SERIES )

INSERT INTO COMPANY 
SELECT SNO, LEFT(SCRIP_NAME,20),SCRIP_NAME,'','','','','','','','','','','','' 
FROM SCRIP_IMP

INSERT INTO SCRIP1 
SELECT SNO, SERIES,LEFT(SCRIP_NAME,20),SCRIP_NAME,1,10,'','','','','EQ','EQ','','','DEC 31 2049','','','','' 
FROM SCRIP_IMP

INSERT INTO SCRIP2 
SELECT SNO,SERIES,'NSE',SCRIP_CD,'HIG','','',0,0,0,'','','NRM','','','','','','','','','', '', '', '', '', '', '', 0, '', 0, 0, 0, '', 0 
FROM SCRIP_IMP
            
UPDATE SCRIP2 SET SECTOR = S2.SECTOR,TRACK = S2.TRACK, CDOL_NO = S2.CDOL_NO,
RES1 = S2.RES1, RES2= S2.RES2, RES3 = S2.RES3, RES4 = S2.RES4, GLOBALCUSTODIAN = S2.GLOBALCUSTODIAN, 
COMMON_CODE = ISNULL(S2.COMMON_CODE,''), INDEXNAME = S2.INDEXNAME, INDUSTRY = S2.INDUSTRY, 
BLOOMBERG = S2.BLOOMBERG, RICCODE = S2.RICCODE, REUTERS = S2.REUTERS, IES = S2.IES, 
NOOFISSUEDSHARES = S2.NOOFISSUEDSHARES, STATUS = S2.STATUS, ADRGDRRATIO = S2.ADRGDRRATIO, 
GEMULTIPLE = S2.GEMULTIPLE, GROUPFORGE = S2.GROUPFORGE, RBICEILINGINDICATORFLAG = S2.RBICEILINGINDICATORFLAG,
RBICEILINGINDICATORVALUE = S2.RBICEILINGINDICATORVALUE 
FROM TEMPSCRIP2 S2 WHERE S2.SCRIP_CD = SCRIP2.SCRIP_CD AND S2.SERIES = SCRIP2.SERIES

DROP TABLE TEMPSCRIP1
DROP TABLE TEMPSCRIP2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PCREATEBOUSERS
-- --------------------------------------------------
CREATE   PROC [DBO].[PCREATEBOUSERS]  
(  
	 @UPDTFLAG VARCHAR(1),  
	 @PARTICIPANT VARCHAR(10),  
	 @CATEGORYNAME VARCHAR(20),  
	 @USERID VARCHAR(20),  
	 @PASSWORD VARCHAR(15),  
	 @FIRSTNAME VARCHAR(50),  
	 @MIDDLENAME VARCHAR(25),  
	 @LASTNAME VARCHAR(25),
	 @EDITADDBY VARCHAR(25)  
)  
  
AS  
  
DECLARE @@ADMINCOUNT INT  
DECLARE @@CONTROLCOUNT INT  
DECLARE @@USERCOUNT INT  
DECLARE @@CATEGORYCODE INT  
DECLARE @@USERLOGINID INT  
DECLARE @@ADMINAUTO INT  
  
IF @UPDTFLAG = 'I'  
BEGIN  
  
 SELECT @@ADMINCOUNT = COUNT(1) FROM TBLADMIN WHERE FLDNAME = @PARTICIPANT   
   
 IF @@ADMINCOUNT >0  
 BEGIN  
  
	 SELECT @@ADMINCOUNT = COUNT(1) FROM TBLCATEGORY WHERE FLDCATEGORYNAME = @CATEGORYNAME     
	IF @@ADMINCOUNT >0  
	BEGIN  

		  SELECT @@USERCOUNT = COUNT(1) FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERID    
		  IF @@USERCOUNT = 0  
		  BEGIN    
		  
		   SELECT @@CATEGORYCODE = FLDCATEGORYCODE FROM TBLCATEGORY WHERE FLDCATEGORYNAME = @CATEGORYNAME  
		 
		   SELECT @@ADMINAUTO = FLDAUTO_ADMIN FROM TBLADMIN WHERE FLDNAME = @PARTICIPANT  
		  
		    
		   INSERT INTO TBLPRADNYAUSERS  
		   (FLDUSERNAME,FLDPASSWORD,FLDFIRSTNAME,FLDMIDDLENAME,FLDLASTNAME,FLDSEX,FLDADDRESS1,FLDADDRESS2,FLDPHONE1,FLDPHONE2,FLDCATEGORY,FLDADMINAUTO,FLDSTNAME,PWD_EXPIRY_DATE,EDIT_FLAG,CREATED_BY,MODIFIED_BY)  
		   VALUES  
		   (@USERID, @PASSWORD, LEFT(@FIRSTNAME,50), LEFT(@MIDDLENAME,25), LEFT(@LASTNAME, 50), 'MALE',  
		   '','','','', @@CATEGORYCODE, @@ADMINAUTO, @USERID, 'DEC 31 2049','A',@EDITADDBY,@EDITADDBY)  
		     
		   SELECT @@USERLOGINID = FLDAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERID  
		     
		   INSERT INTO TBLUSERCONTROLMASTER  
		   (FLDUSERID,FLDPWDEXPIRY,FLDMAXATTEMPT,FLDATTEMPTCNT,FLDSTATUS,FLDLOGINFLAG,FLDACCESSLVL,FLDIPADD,FLDTIMEOUT,FLDFIRSTLOGIN,FLDFORCELOGOUT)  
		   VALUES  
		   (@@USERLOGINID, 365, 100, 0, 0, 0, 'F', '', 30, 'N', 0)  
	END
  END  
 END  
   
END  
ELSE  
BEGIN  
 UPDATE TBLADMIN  
 SET FLDPASSWORD = @PASSWORD  
 WHERE FLDNAME = @PARTICIPANT  
  
 UPDATE TBLPRADNYAUSERS  
 SET FLDPASSWORD  = @PASSWORD  
 WHERE FLDUSERNAME = @USERID  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POP_CONTRACTDATA
-- --------------------------------------------------

--POP_CONTRACTDATA 'May 26 2023'
CREATE PROCEDURE [dbo].[POP_CONTRACTDATA]        
 (       
 @SAUDA_DATE VARCHAR(11),      
 @USERNAME VARCHAR(11)=''      
 )       
       
 AS       
 BEGIN    
--RESET THE TABLE VALUES FOR THE GIVEN PROCESS DATE    
    
   DELETE CONTRACT_DATA      
 WHERE      
 SAUDA_DATE >= @SAUDA_DATE AND       
 SAUDA_DATE <= @SAUDA_DATE +' 23:59'      
       
 DELETE CONTRACT_MASTER       
 WHERE      
 TRADE_DATE >= @SAUDA_DATE AND       
    TRADE_DATE <= @SAUDA_DATE +' 23:59'       
    
    
--COLLECT VALUES FROM BFOSETTLEMENT    
      
SELECT  CONTRACTNO,       
        TRADE_NO,       
        PARTY_CODE,       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        ORDER_NO,       
        SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
        VAL_PERC,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,       
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        SETT_TYPE,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_TIMESTAMP,    
        RESERVED1,    
  LOTSIZE = LOT_SIZE     
INTO #FOSETT      
FROM    BFOSETTLEMENT       
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'       
        AND AUCTIONPART NOT IN ('CA')       
        AND TRADEQTY <> 0       
        AND TRADE_PRICE > 0       
        AND RESERVED1 = 0       
  
      
CREATE  INDEX [DELPOS]       
        ON [DBO].[#FOSETT]       
        (       
                [PARTY_CODE]       
        )       
    

    
--COLLECT CLIENT MAST DETAILS FOR ONLY TRADED CLIENTS    
  
INSERT INTO  CONTRACT_MASTER      
SELECT        
 @SAUDA_DATE,      
 C2.PARTY_CODE,         
 C1.LONG_NAME,         
 C1.L_ADDRESS1,         
 C1.L_ADDRESS2,         
 C1.L_ADDRESS3,         
 C1.L_CITY,         
 C1.L_STATE,         
 C1.L_ZIP,         
 C1.BRANCH_CD ,         
 C1.SUB_BROKER,         
 C1.TRADER,        
 C1.AREA,        
 C1.REGION,        
 C1.FAMILY,         
 C1.PAN_GIR_NO,         
 C1.OFF_PHONE1,         
 C1.OFF_PHONE2,         
 PRINTF,         
 MAPIDID,         
 UCC_CODE,        
 C2.SERVICE_CHRG,         
 BROKERNOTE,         
 TURNOVER_TAX,         
 SEBI_TURN_TAX,         
 C2.OTHER_CHRG,         
 INSURANCE_CHRG,        
 SEBI_NO = FD_CODE     
FROM    CLIENT1 C1 WITH (NOLOCK), CLIENT2 C2 WITH(NOLOCK)       
LEFT OUTER JOIN UCC_CLIENT UC WITH(NOLOCK)       
        ON C2.PARTY_CODE = UC.PARTY_CODE       
  WHERE   C2.CL_CODE       = C1.CL_CODE       
        AND C2.PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM  #FOSETT)    
  
DECLARE   
@@ORDER_TIMESTAMP VARCHAR(20)  
SELECT TOP 1 @@ORDER_TIMESTAMP =ORDER_TIMESTAMP FROM #FOSETT WHERE TRADE_NO NOT LIKE 'EA%'  
  
UPDATE #FOSETT SET ORDER_TIMESTAMP=@@ORDER_TIMESTAMP   
WHERE  TRADE_NO LIKE 'EA%'  
  
  
SELECT  ORDER_NO,       
        ORDER_TIME = CONVERT(VARCHAR,CONVERT(DATETIME,ORDER_TIMESTAMP),108),       
        TRADE_NO,       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,       
        PQTY = (CASE       
                WHEN SELL_BUY = 1       
                THEN TRADEQTY       
                ELSE 0 END),		
        SQTY = (CASE       
                WHEN SELL_BUY = 2       
                THEN TRADEQTY       
                ELSE 0 END),       
        PRATE= (CASE       
                 WHEN SELL_BUY = 1       
                 THEN ISNULL(TRADE_PRICE,0)       
                 ELSE 0 END),       
        SRATE = (CASE       
                 WHEN SELL_BUY = 2       
                 THEN ISNULL(TRADE_PRICE,0)       
                 ELSE 0 END),       
        PBROK =(CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL((BROKAPPLIED + (CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
     ELSE 0 END )),0)       
      ELSE 0 END),       
        SBROK =(CASE       
                WHEN SELL_BUY = 2       
                THEN ISNULL((BROKAPPLIED + (CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
      ELSE 0 END),       
        PNETRATE = (CASE       
     WHEN SELL_BUY =1       
     THEN ISNULL(NETRATE + (CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
      ELSE 0 END),       
        SNETRATE = (CASE       
     WHEN SELL_BUY =2       
     THEN ISNULL(NETRATE - (CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
      ELSE 0 END),       
        ISNULL(TRADE_AMOUNT,0) AMOUNT ,       
        PRODUCT_TYPE= (CASE       
      WHEN F.AUCTIONPART = 'EA'       
      THEN STUFF(PRODUCT_TYPE,1,3,'EA-')       
      ELSE PRODUCT_TYPE END),       
  PRODUCT_CODE = (CASE       
      WHEN F.AUCTIONPART = 'EA'       
      THEN STUFF(PRODUCT_CODE,1,3,'EA-')       
      ELSE PRODUCT_CODE END),      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=(CASE       
              WHEN SELL_BUY = 1       
              THEN (TRADEQTY * NETRATE) + (CASE       
             WHEN C.SERVICE_CHRG = 1       
             THEN ISNULL((F.SERVICE_TAX),0)       
             ELSE (CASE       
             WHEN C.SERVICE_CHRG = 0       
             THEN 0       
             ELSE (CASE       
                WHEN C.SERVICE_CHRG = 2       
                THEN 0       
                ELSE 0 END)    
             END )    
             END )       
                ELSE 0 END),       
        SAMT=(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN(TRADEQTY * NETRATE) - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END ) END ) END)       
                ELSE 0 END),       
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,       
        F.PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,       
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,       
        PSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        SSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                   CASE       
                                WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        DFLAG       = 1 ,       
        BROKER_CHRG = (       
        CASE       
                WHEN BROKERNOTE = 1       
                THEN BROKER_CHRG       
                ELSE 0 END ),       
 TURN_TAX = (       
        CASE       
                WHEN TURNOVER_TAX = 1       
                THEN TURN_TAX       
      ELSE 0 END),       
        SEBI_TAX = (      
        CASE       
                WHEN SEBI_TURN_TAX = 1       
                THEN SEBI_TAX       
                ELSE 0 END),       
        OTHER_CHRG = (       
        CASE       
                WHEN C.OTHER_CHRG = 1       
                THEN F.OTHER_CHRG       
                ELSE 0 END) ,       
        INS_CHRG = (       
        CASE       
                WHEN INSURANCE_CHRG = 1       
                THEN INS_CHRG       
                ELSE 0 END ),       
        SERVICE_TAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX       
                ELSE 0 END ),       
        NSERTAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX      
                ELSE 0 END ),       
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0),    
  PRINTF,    
  C.SERVICE_CHRG,    
  LOTSIZE     
INTO    #CONTSETT       
FROM    #FOSETT F,       
        CONTRACT_MASTER C       
WHERE       
   F.PARTY_CODE=C.PARTY_CODE       
   AND LEFT(F.SAUDA_DATE,11) = LEFT(C.TRADE_DATE,11)       
  
  --select * into GK from #CONTSETT where PARTY_CODE='GKOSL2A484'
  
UPDATE         
 #CONTSETT        
SET        
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END        
   + (CASE WHEN SERVICE_CHRG = 1 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 SERVICE_TAX = SERVICE_TAX +(CASE WHEN SERVICE_CHRG = 0 THEN         
    CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
    ELSE 0 END),        
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
     CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE 0 END        
     ELSE 0 END),        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
     CASE WHEN SELL_BUY =1 THEN 0 ELSE CD_TOT_SELLSERTAX END        
     ELSE 0 END),        
 PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK         
   + (CASE WHEN SERVICE_CHRG = 1 THEN ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)        
         ELSE 0 END),         
 SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK         
   - (CASE WHEN SERVICE_CHRG = 1 THEN ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)        
      ELSE 0 END)        
         
FROM        
 CHARGES_DETAIL        
WHERE        
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)        
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE         
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE      
 AND CD_PRODUCT_CODE = PRODUCT_CODE      
 AND CD_SERIES_ID = SERIES_ID      
 AND CD_SERIES_CODE = SERIES_CODE      
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE        
 AND CD_TRADE_NO = TRADE_NO        
 AND CD_ORDER_NO = ORDER_NO        
    
     
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',         
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,         
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX        
  ELSE 0 END),        
 SSERVICE_TAX = 0,        
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX = 0,         
 SEBI_TAX = 0,         
 OTHER_CHRG = 0 ,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),    
 PRINTF,    
 C.SERVICE_CHRG,    
 LOTSIZE = 1    
FROM    CHARGES_DETAIL F,         
        CONTRACT_MASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'        
 AND LEFT(F.CD_SAUDA_DATE,11) = LEFT(C.TRADE_DATE,11)       
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN CD_PRODUCT_CODE LIKE 'OPT%'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_BUYBROK > 0        
        
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',         
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,         
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = 0 ,        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX        
  ELSE 0 END),        
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX =0,         
 SEBI_TAX =0,         
 OTHER_CHRG = 0,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_SELLBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),    
  PRINTF,    
 C.SERVICE_CHRG,    
LOTSIZE= 1         
FROM    CHARGES_DETAIL F,         
        CONTRACT_MASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'        
 AND LEFT(F.CD_SAUDA_DATE,11) = LEFT(C.TRADE_DATE,11)       
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN CD_PRODUCT_CODE LIKE 'OPT%'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_SELLBROK > 0          
      
    
--INSERT INTO MAIN TABLE      
INSERT INTO CONTRACT_DATA      
(ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE, AMOUNT,    
 PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,    
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,    
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME,LOTSIZE      
 )    
SELECT  ORDER_NO=REPLICATE('0',20),       
        ORDER_TIME      = '          ',       
        TRADE_NO        ='00000000000000',       
        TRADETIME       ='0000000000000',       
        PQTY            =SUM(PQTY),       
        SQTY            =SUM(SQTY),       
        PRATE           =(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END),       
        SRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PBROK=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(BROKERAGE)/SUM(PQTY)       
                ELSE 0 END ),       
        SBROK=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(BROKERAGE)/SUM(SQTY)       
                ELSE 0 END ),       
		
		
		/*PBROK=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PBROK*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SBROK=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SBROK*SQTY)/SUM(SQTY)       
                ELSE 0 END ),  
				*/     
        PNETRATE=(       
        CASE       
                WHEN SUM(PQTY) > 0       
            THEN SUM(PNETRATE*PQTY)/SUM(PQTY)       
  ELSE 0 END ),       
        SNETRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        AMOUNT=SUM(AMOUNT),       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=SUM(PAMT),       
        SAMT=SUM(SAMT),       
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),       
        STRIKE_PRICE,       
        PSERVICE_TAX=SUM(PSERVICE_TAX),       
        SSERVICE_TAX=SUM(SSERVICE_TAX),       
        DFLAG,       
        BROKER_CHRG = SUM(BROKER_CHRG),       
        TURN_TAX    = SUM(TURN_TAX),       
        SEBI_TAX    = SUM(SEBI_TAX),       
        OTHER_CHRG  = SUM(OTHER_CHRG) ,       
        INS_CHRG    = SUM(INS_CHRG),       
        SERVICE_TAX = SUM(SERVICE_TAX),       
        NSERTAX     = SUM(NSERTAX),       
        BROKERAGE   = SUM(BROKERAGE),    
  PRINTF,       
        SERVICE_CHRG,         
        @USERNAME,    
  LOTSIZE      
    
FROM    #CONTSETT       
WHERE   PRINTF = '3'       
GROUP BY PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        STRIKE_PRICE,       
        CONVERT(DATETIME,SAUDA_DATE,103),       
        DFLAG,    
  PRINTF,       
        SERVICE_CHRG,LOTSIZE     
    
--SELECT * INTO ##SEN FROM #CONTSETT    
INSERT       
INTO    CONTRACT_DATA (ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE,    
 AMOUNT, PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,    
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,    
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME,LOTSIZE      
 )    
    
SELECT ORDER_NO,ORDER_TIME,TRADE_NO,TRADETIME,PQTY,SQTY,PRATE,SRATE,
PBROK=(       
        CASE       
                WHEN PQTY > 0       
                THEN BROKERAGE/PQTY       
                ELSE 0 END ),       
SBROK=(       
CASE       
        WHEN SQTY > 0       
        THEN BROKERAGE/SQTY       
        ELSE 0 END ), 

--PBROK,
--SBROK,
PNETRATE,SNETRATE,    
AMOUNT,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,PAMT,SAMT,EXPIRYDATE=CONVERT(SMALLDATETIME,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)),PARTY_CODE,SELL_BUY,CONTRACTNO,    
SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),STRIKE_PRICE,PSERVICE_TAX,SSERVICE_TAX,DFLAG,BROKER_CHRG,TURN_TAX,SEBI_TAX,    
OTHER_CHRG,INS_CHRG,SERVICE_TAX,NSERTAX,BROKERAGE,PRINTF,SERVICE_CHRG,@USERNAME,LOTSIZE     
FROM    #CONTSETT WITH (NOLOCK)       
WHERE   PRINTF <> '3'       
    
UPDATE CONTRACT_DATA       
        SET ORDER_NO = S.ORDER_NO,       
        ORDER_TIME   = S.ORDER_TIME,       
        TRADETIME    = S.TRADETIME,       
        TRADE_NO     = S.TRADE_NO       
FROM    #CONTSETT S WITH(NOLOCK)       
WHERE   S.PRINTF           = CONTRACT_DATA.PRINTF       
        AND S.PRINTF       = '3'       
        AND S.PARTY_CODE   = CONTRACT_DATA.PARTY_CODE       
  AND S.PRODUCT_TYPE = CONTRACT_DATA.PRODUCT_TYPE      
  AND S.PRODUCT_CODE = CONTRACT_DATA.PRODUCT_CODE      
  AND S.SERIES_CODE  = CONTRACT_DATA.SERIES_CODE      
  AND S.SERIES_ID    = CONTRACT_DATA.SERIES_ID      
        AND S.EXPIRYDATE   = CONTRACT_DATA.EXPIRYDATE       
        AND S.STRIKE_PRICE = CONTRACT_DATA.STRIKE_PRICE       
        AND S.SELL_BUY     = CONTRACT_DATA.SELL_BUY       
        AND S.SAUDA_DATE   =       
        (SELECT MIN(SAUDA_DATE)       
        FROM    #CONTSETT ISETT       
        WITH(NOLOCK)       
        WHERE   PRINTF             = '3'       
                AND S.PARTY_CODE   = ISETT.PARTY_CODE       
    AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE      
    AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE      
    AND S.SERIES_CODE  = ISETT.SERIES_CODE      
    AND S.SERIES_ID    = ISETT.SERIES_ID      
    AND S.EXPIRYDATE   = ISETT.EXPIRYDATE       
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE       
                AND S.SELL_BUY     = ISETT.SELL_BUY     
        )       
    
    
--INSERT DETAIL RECORDS FOR SUMMARISED ENTRIES    
    
INSERT       
INTO    CONTRACT_DATA_DET (ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE,    
 AMOUNT, PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,    
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,    
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME, LOTSIZE      
 )    
    
SELECT ORDER_NO,ORDER_TIME,TRADE_NO,TRADETIME,PQTY,SQTY,PRATE,SRATE,PBROK,SBROK,PNETRATE,SNETRATE,    
AMOUNT,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,PAMT,SAMT,EXPIRYDATE=CONVERT(SMALLDATETIME,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)),PARTY_CODE,SELL_BUY,CONTRACTNO,    
SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),STRIKE_PRICE,PSERVICE_TAX,SSERVICE_TAX,DFLAG,BROKER_CHRG,TURN_TAX,SEBI_TAX,    
OTHER_CHRG,INS_CHRG,SERVICE_TAX,NSERTAX,BROKERAGE,PRINTF,SERVICE_CHRG,@USERNAME, LOTSIZE     
FROM    #CONTSETT WITH (NOLOCK)       
WHERE   PRINTF = '3'      
    
    
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CONTRACT','',@USERNAME,''    
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POP_CONTRACTDATA_24012012
-- --------------------------------------------------
    
    
CREATE PROCEDURE [DBO].[POP_CONTRACTDATA_24012012]        
 (       
 @SAUDA_DATE VARCHAR(11),      
 @USERNAME VARCHAR(11)=''      
 )       
       
 AS       
 BEGIN    
--RESET THE TABLE VALUES FOR THE GIVEN PROCESS DATE    
    
   DELETE CONTRACT_DATA      
 WHERE      
 SAUDA_DATE >= @SAUDA_DATE AND       
 SAUDA_DATE <= @SAUDA_DATE +' 23:59'      
       
 DELETE CONTRACT_MASTER       
 WHERE      
 TRADE_DATE >= @SAUDA_DATE AND       
    TRADE_DATE <= @SAUDA_DATE +' 23:59'       
    
    
--COLLECT VALUES FROM BFOSETTLEMENT    
      
SELECT  CONTRACTNO,       
        TRADE_NO,       
        PARTY_CODE,       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        ORDER_NO,       
        SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
        VAL_PERC,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,       
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        SETT_TYPE,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_TIMESTAMP,    
        RESERVED1       
INTO #FOSETT      
FROM    BFOSETTLEMENT       
WHERE   SAUDA_DATE LIKE @SAUDA_DATE + '%'       
        AND AUCTIONPART NOT IN ('CA')       
        AND TRADEQTY <> 0       
        AND TRADE_PRICE > 0       
        AND RESERVED1 = 0       
      
CREATE  INDEX [DELPOS]       
        ON [DBO].[#FOSETT]       
        (       
                [PARTY_CODE]       
        )       
    
    
--COLLECT CLIENT MAST DETAILS FOR ONLY TRADED CLIENTS    
INSERT INTO  CONTRACT_MASTER      
SELECT        
 @SAUDA_DATE,      
 C2.PARTY_CODE,         
 C1.LONG_NAME,         
 C1.L_ADDRESS1,         
 C1.L_ADDRESS2,         
 C1.L_ADDRESS3,         
 C1.L_CITY,         
 C1.L_STATE,         
 C1.L_ZIP,         
 C1.BRANCH_CD ,         
 C1.SUB_BROKER,         
 C1.TRADER,        
 C1.AREA,        
 C1.REGION,        
 C1.FAMILY,         
 C1.PAN_GIR_NO,         
 C1.OFF_PHONE1,         
 C1.OFF_PHONE2,         
 PRINTF,         
 MAPIDID,         
 UCC_CODE,        
 C2.SERVICE_CHRG,         
 BROKERNOTE,         
 TURNOVER_TAX,         
 SEBI_TURN_TAX,         
 C2.OTHER_CHRG,         
 INSURANCE_CHRG,        
 SEBI_NO = FD_CODE     
FROM    CLIENT1 C1 WITH (NOLOCK), CLIENT2 C2 WITH(NOLOCK)       
LEFT OUTER JOIN UCC_CLIENT UC WITH(NOLOCK)       
        ON C2.PARTY_CODE = UC.PARTY_CODE       
  WHERE   C2.CL_CODE       = C1.CL_CODE       
        AND C2.PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM  #FOSETT)    
      
SELECT  ORDER_NO,       
        --ORDER_TIME = CONVERT(VARCHAR,CONVERT(DATETIME,ORDER_TIMESTAMP),108),       
ORDER_TIME =right(ORDER_TIMESTAMP,8),          
TRADE_NO,       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,       
        PQTY = (CASE       
                WHEN SELL_BUY = 1       
                THEN TRADEQTY       
                ELSE 0 END),       
        SQTY = (CASE       
                WHEN SELL_BUY = 2       
                THEN TRADEQTY       
                ELSE 0 END),       
        PRATE= (CASE       
                 WHEN SELL_BUY = 1       
                 THEN ISNULL(TRADE_PRICE,0)       
                 ELSE 0 END),       
        SRATE = (CASE       
                 WHEN SELL_BUY = 2       
                 THEN ISNULL(TRADE_PRICE,0)       
                 ELSE 0 END),       
        PBROK =(CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL((BROKAPPLIED + (CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
     ELSE 0 END )),0)       
      ELSE 0 END),       
        SBROK =(CASE       
        WHEN SELL_BUY = 2       
                THEN ISNULL((BROKAPPLIED + (CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
      ELSE 0 END),       
        PNETRATE = (CASE       
     WHEN SELL_BUY =1       
     THEN ISNULL(NETRATE + (CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
      ELSE 0 END),       
        SNETRATE = (CASE       
     WHEN SELL_BUY =2       
     THEN ISNULL(NETRATE - (CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
      ELSE 0 END),       
        ISNULL(TRADE_AMOUNT,0) AMOUNT ,       
        PRODUCT_TYPE= (CASE       
      WHEN F.AUCTIONPART = 'EA'       
      THEN STUFF(PRODUCT_TYPE,1,3,'EA-')       
      ELSE PRODUCT_TYPE END),       
  PRODUCT_CODE = (CASE       
      WHEN F.AUCTIONPART = 'EA'       
      THEN STUFF(PRODUCT_CODE,1,3,'EA-')       
      ELSE PRODUCT_CODE END),      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=(CASE       
              WHEN SELL_BUY = 1       
              THEN (TRADEQTY * NETRATE) + (CASE       
             WHEN C.SERVICE_CHRG = 1       
             THEN ISNULL((F.SERVICE_TAX),0)       
             ELSE (CASE       
             WHEN C.SERVICE_CHRG = 0       
             THEN 0       
             ELSE (CASE       
                WHEN C.SERVICE_CHRG = 2       
                THEN 0       
                ELSE 0 END)    
             END )    
             END )       
                ELSE 0 END),       
        SAMT=(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN(TRADEQTY * NETRATE) - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END ) END ) END)       
                ELSE 0 END),       
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,       
        F.PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,       
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,       
        PSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        SSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE    
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        DFLAG       = 1 ,       
        BROKER_CHRG = (       
        CASE       
                WHEN BROKERNOTE = 1       
                THEN BROKER_CHRG       
                ELSE 0 END ),       
        TURN_TAX = (       
        CASE       
                WHEN TURNOVER_TAX = 1       
                THEN TURN_TAX       
                ELSE 0 END),       
        SEBI_TAX = (      
        CASE       
                WHEN SEBI_TURN_TAX = 1       
                THEN SEBI_TAX       
                ELSE 0 END),       
        OTHER_CHRG = (       
        CASE       
                WHEN C.OTHER_CHRG = 1       
                THEN F.OTHER_CHRG       
                ELSE 0 END) ,       
        INS_CHRG = (       
        CASE       
                WHEN INSURANCE_CHRG = 1       
                THEN INS_CHRG       
                ELSE 0 END ),       
        SERVICE_TAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX       
                ELSE 0 END ),       
        NSERTAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX      
                ELSE 0 END ),       
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0),    
  PRINTF,    
  C.SERVICE_CHRG     
INTO    #CONTSETT       
FROM    #FOSETT F,       
        CONTRACT_MASTER C       
WHERE       
   F.PARTY_CODE=C.PARTY_CODE       
      
     
UPDATE         
 #CONTSETT        
SET        
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END        
   + (CASE WHEN SERVICE_CHRG = 1 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
    CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
    ELSE 0 END),        
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
     CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE 0 END        
     ELSE 0 END),        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
     CASE WHEN SELL_BUY =1 THEN 0 ELSE CD_TOT_SELLSERTAX END        
     ELSE 0 END),        
 PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK         
   + (CASE WHEN SERVICE_CHRG = 1 THEN ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)        
         ELSE 0 END),         
 SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK         
   - (CASE WHEN SERVICE_CHRG = 1 THEN ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)        
      ELSE 0 END)        
         
FROM        
 CHARGES_DETAIL        
WHERE        
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)        
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE         
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE      
 AND CD_PRODUCT_CODE = PRODUCT_CODE      
 AND CD_SERIES_ID = SERIES_ID      
 AND CD_SERIES_CODE = SERIES_CODE      
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE        
 AND CD_TRADE_NO = TRADE_NO        
 AND CD_ORDER_NO = ORDER_NO        
    
     
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',         
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,         
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX        
  ELSE 0 END),        
 SSERVICE_TAX = 0,        
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX = 0,         
 SEBI_TAX = 0,         
 OTHER_CHRG = 0 ,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),    
 PRINTF,    
 C.SERVICE_CHRG       
FROM    CHARGES_DETAIL F,         
        CONTRACT_MASTER C         
WHERE   CD_SAUDA_DATE LIKE @SAUDA_DATE + '%'        
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN CD_PRODUCT_CODE LIKE 'OPT%'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_BUYBROK > 0        
        
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',         
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,         
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = 0 ,        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX        
  ELSE 0 END),        
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX =0,         
 SEBI_TAX =0,         
 OTHER_CHRG = 0,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_SELLBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),    
  PRINTF,    
 C.SERVICE_CHRG        
FROM    CHARGES_DETAIL F,         
        CONTRACT_MASTER C         
WHERE   CD_SAUDA_DATE LIKE @SAUDA_DATE + '%'        
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN CD_PRODUCT_CODE LIKE 'OPT%'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_SELLBROK > 0          
      
    
--INSERT INTO MAIN TABLE      
INSERT INTO CONTRACT_DATA      
(ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE, AMOUNT,    
 PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,    
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,    
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME     
 )    
SELECT  ORDER_NO='0000000000000000',       
        ORDER_TIME      = '          ',       
        TRADE_NO        ='00000000000000',       
        TRADETIME       ='0000000000000',       
        PQTY            =SUM(PQTY),       
        SQTY            =SUM(SQTY),       
        PRATE           =(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END),       
        SRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PBROK=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PBROK*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SBROK=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SBROK*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PNETRATE=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SNETRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        AMOUNT=SUM(AMOUNT),       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=SUM(PAMT),       
        SAMT=SUM(SAMT),       
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),       
        STRIKE_PRICE,       
        PSERVICE_TAX=SUM(PSERVICE_TAX),       
        SSERVICE_TAX=SUM(SSERVICE_TAX),       
        DFLAG,       
        BROKER_CHRG = SUM(BROKER_CHRG),       
        TURN_TAX    = SUM(TURN_TAX),       
        SEBI_TAX    = SUM(SEBI_TAX),       
        OTHER_CHRG  = SUM(OTHER_CHRG) ,       
        INS_CHRG    = SUM(INS_CHRG),       
        SERVICE_TAX = SUM(SERVICE_TAX),       
        NSERTAX     = SUM(NSERTAX),       
        BROKERAGE   = SUM(BROKERAGE),    
  PRINTF,       
        SERVICE_CHRG,         
        @USERNAME     
    
FROM    #CONTSETT       
WHERE   PRINTF = '3'       
GROUP BY PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        STRIKE_PRICE,       
        CONVERT(DATETIME,SAUDA_DATE,103),       
        DFLAG,    
  PRINTF,       
        SERVICE_CHRG         
    
--SELECT * INTO ##SEN FROM #CONTSETT    
INSERT       
INTO    CONTRACT_DATA (ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE,    
 AMOUNT, PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,    
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,    
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME     
 )    
    
SELECT ORDER_NO,ORDER_TIME,TRADE_NO,TRADETIME,PQTY,SQTY,PRATE,SRATE,PBROK,SBROK,PNETRATE,SNETRATE,    
AMOUNT,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,PAMT,SAMT,EXPIRYDATE=CONVERT(SMALLDATETIME,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)),PARTY_CODE,SELL_BUY,CONTRACTNO,    
SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),STRIKE_PRICE,PSERVICE_TAX,SSERVICE_TAX,DFLAG,BROKER_CHRG,TURN_TAX,SEBI_TAX,    
OTHER_CHRG,INS_CHRG,SERVICE_TAX,NSERTAX,BROKERAGE,PRINTF,SERVICE_CHRG,@USERNAME    
FROM    #CONTSETT WITH (NOLOCK)       
WHERE   PRINTF <> '3'       
    
UPDATE CONTRACT_DATA       
        SET ORDER_NO = S.ORDER_NO,       
        ORDER_TIME   = S.ORDER_TIME,       
        TRADETIME    = S.TRADETIME,       
        TRADE_NO     = S.TRADE_NO       
FROM    #CONTSETT S WITH(NOLOCK)       
WHERE   S.PRINTF           = CONTRACT_DATA.PRINTF       
        AND S.PRINTF       = '3'       
        AND S.PARTY_CODE   = CONTRACT_DATA.PARTY_CODE       
  AND S.PRODUCT_TYPE = CONTRACT_DATA.PRODUCT_TYPE      
  AND S.PRODUCT_CODE = CONTRACT_DATA.PRODUCT_CODE      
  AND S.SERIES_CODE  = CONTRACT_DATA.SERIES_CODE      
  AND S.SERIES_ID    = CONTRACT_DATA.SERIES_ID      
        AND S.EXPIRYDATE   = CONTRACT_DATA.EXPIRYDATE       
        AND S.STRIKE_PRICE = CONTRACT_DATA.STRIKE_PRICE       
        AND S.SELL_BUY     = CONTRACT_DATA.SELL_BUY       
        AND S.SAUDA_DATE   =       
        (SELECT MIN(SAUDA_DATE)       
        FROM    #CONTSETT ISETT       
        WITH(NOLOCK)       
        WHERE   PRINTF             = '3'       
                AND S.PARTY_CODE   = ISETT.PARTY_CODE       
    AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE      
    AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE      
    AND S.SERIES_CODE  = ISETT.SERIES_CODE      
    AND S.SERIES_ID    = ISETT.SERIES_ID      
    AND S.EXPIRYDATE   = ISETT.EXPIRYDATE       
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE       
                AND S.SELL_BUY     = ISETT.SELL_BUY       
        )       
    
    
--INSERT DETAIL RECORDS FOR SUMMARISED ENTRIES    
INSERT       
INTO    CONTRACT_DATA_DET (ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE,    
 AMOUNT, PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,    
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,    
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME     
 )    
    
SELECT ORDER_NO,ORDER_TIME,TRADE_NO,TRADETIME,PQTY,SQTY,PRATE,SRATE,PBROK,SBROK,PNETRATE,SNETRATE,    
AMOUNT,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,PAMT,SAMT,EXPIRYDATE=CONVERT(SMALLDATETIME,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)),PARTY_CODE,SELL_BUY,CONTRACTNO,    
SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),STRIKE_PRICE,PSERVICE_TAX,SSERVICE_TAX,DFLAG,BROKER_CHRG,TURN_TAX,SEBI_TAX,    
OTHER_CHRG,INS_CHRG,SERVICE_TAX,NSERTAX,BROKERAGE,PRINTF,SERVICE_CHRG,@USERNAME    
FROM    #CONTSETT WITH (NOLOCK)       
WHERE   PRINTF = '3'      
    
    
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CONTRACT','',@USERNAME,''    
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POP_CONTRACTDATA_BKUP_10Aug2023
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[POP_CONTRACTDATA_BKUP_10Aug2023]    
 (   
 @SAUDA_DATE VARCHAR(11),  
 @USERNAME VARCHAR(11)=''  
 )   
   
 AS   
 BEGIN
--RESET THE TABLE VALUES FOR THE GIVEN PROCESS DATE

  	DELETE CONTRACT_DATA  
	WHERE  
	SAUDA_DATE >= @SAUDA_DATE AND   
	SAUDA_DATE <= @SAUDA_DATE +' 23:59'  
	  
	DELETE CONTRACT_MASTER   
	WHERE  
	TRADE_DATE >= @SAUDA_DATE AND   
    TRADE_DATE <= @SAUDA_DATE +' 23:59'   


--COLLECT VALUES FROM BFOSETTLEMENT
  
SELECT  CONTRACTNO,   
        TRADE_NO,   
        PARTY_CODE,   
		PRODUCT_TYPE,  
		PRODUCT_CODE,  
		SERIES_CODE,  
		SERIES_ID,  
		TRADE_PRICE,   
        EXPIRYDATE,   
        STRIKE_PRICE,   
        PRO_CLI,   
        TRADEQTY,   
        AUCTIONPART,   
        ORDER_NO,   
        SAUDA_DATE,   
        TABLE_NO,   
        LINE_NO,   
        VAL_PERC,   
        DAY_PUC,   
        DAY_SALES,   
        SETT_PURCH,   
        SETT_SALES,   
        SELL_BUY,   
        SETTFLAG,   
        BROKAPPLIED,   
        NETRATE,   
        INS_CHRG,   
        TURN_TAX,   
        OTHER_CHRG,   
        SEBI_TAX,   
        BROKER_CHRG,   
        SERVICE_TAX,   
        TRADE_AMOUNT,   
        SETT_TYPE,   
        PARTICIPANTCODE,   
        STATUS,   
        ORDER_TIMESTAMP,
        RESERVED1,
		LOTSIZE = LOT_SIZE 
INTO	#FOSETT  
FROM    BFOSETTLEMENT   
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        AND AUCTIONPART NOT IN ('CA')   
        AND TRADEQTY <> 0   
        AND TRADE_PRICE > 0   
        AND RESERVED1 = 0   
  
CREATE  INDEX [DELPOS]   
        ON [DBO].[#FOSETT]   
        (   
                [PARTY_CODE]   
        )   


--COLLECT CLIENT MAST DETAILS FOR ONLY TRADED CLIENTS
INSERT INTO  CONTRACT_MASTER  
SELECT    
 @SAUDA_DATE,  
 C2.PARTY_CODE,     
 C1.LONG_NAME,     
 C1.L_ADDRESS1,     
 C1.L_ADDRESS2,     
 C1.L_ADDRESS3,     
 C1.L_CITY,     
 C1.L_STATE,     
 C1.L_ZIP,     
 C1.BRANCH_CD ,     
 C1.SUB_BROKER,     
 C1.TRADER,    
 C1.AREA,    
 C1.REGION,    
 C1.FAMILY,     
 C1.PAN_GIR_NO,     
 C1.OFF_PHONE1,     
 C1.OFF_PHONE2,     
 PRINTF,     
 MAPIDID,     
 UCC_CODE,    
 C2.SERVICE_CHRG,     
 BROKERNOTE,     
 TURNOVER_TAX,     
 SEBI_TURN_TAX,     
 C2.OTHER_CHRG,     
 INSURANCE_CHRG,    
 SEBI_NO = FD_CODE 
FROM    CLIENT1 C1 WITH (NOLOCK), CLIENT2 C2 WITH(NOLOCK)   
LEFT OUTER JOIN UCC_CLIENT UC WITH(NOLOCK)   
        ON C2.PARTY_CODE = UC.PARTY_CODE   
		WHERE   C2.CL_CODE       = C1.CL_CODE   
        AND C2.PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM  #FOSETT)
  
SELECT  ORDER_NO,   
        ORDER_TIME = CONVERT(VARCHAR,CONVERT(DATETIME,ORDER_TIMESTAMP),108),   
        TRADE_NO,   
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,   
        PQTY = (CASE   
                WHEN SELL_BUY = 1   
                THEN TRADEQTY   
                ELSE 0 END),   
        SQTY = (CASE   
                WHEN SELL_BUY = 2   
                THEN TRADEQTY   
                ELSE 0 END),   
        PRATE= (CASE   
                 WHEN SELL_BUY = 1   
                 THEN ISNULL(TRADE_PRICE,0)   
                 ELSE 0 END),   
        SRATE = (CASE   
                 WHEN SELL_BUY = 2   
                 THEN ISNULL(TRADE_PRICE,0)   
                 ELSE 0 END),   
        PBROK =(CASE   
                WHEN SELL_BUY = 1   
                THEN ISNULL((BROKAPPLIED + (CASE   
                        WHEN C.SERVICE_CHRG=1   
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)   
     ELSE 0 END )),0)   
						ELSE 0 END),   
        SBROK =(CASE   
                WHEN SELL_BUY = 2   
                THEN ISNULL((BROKAPPLIED + (CASE   
                        WHEN C.SERVICE_CHRG=1   
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)   
                        ELSE 0 END )),0)   
						ELSE 0 END),   
        PNETRATE = (CASE   
					WHEN SELL_BUY =1   
					THEN ISNULL(NETRATE + (CASE   
                        WHEN C.SERVICE_CHRG = 1   
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)   
                        ELSE 0 END),0)   
						ELSE 0 END),   
        SNETRATE = (CASE   
					WHEN SELL_BUY =2   
					THEN ISNULL(NETRATE - (CASE   
                        WHEN C.SERVICE_CHRG = 1   
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)   
                        ELSE 0 END),0)   
						ELSE 0 END),   
        ISNULL(TRADE_AMOUNT,0) AMOUNT ,   
        PRODUCT_TYPE= (CASE   
						WHEN F.AUCTIONPART = 'EA'   
						THEN STUFF(PRODUCT_TYPE,1,3,'EA-')   
						ELSE PRODUCT_TYPE END),   
		PRODUCT_CODE = (CASE   
						WHEN F.AUCTIONPART = 'EA'   
						THEN STUFF(PRODUCT_CODE,1,3,'EA-')   
						ELSE PRODUCT_CODE END),  
		SERIES_CODE,  
		SERIES_ID,  
        PAMT=(CASE   
              WHEN SELL_BUY = 1   
              THEN (TRADEQTY * NETRATE) + (CASE   
										   WHEN C.SERVICE_CHRG = 1   
										   THEN ISNULL((F.SERVICE_TAX),0)   
										   ELSE (CASE   
												 WHEN C.SERVICE_CHRG = 0   
												 THEN 0   
												 ELSE (CASE   
													   WHEN C.SERVICE_CHRG = 2   
													   THEN 0   
													   ELSE 0 END)
												 END )
										   END )   
                ELSE 0 END),   
        SAMT=(   
        CASE   
                WHEN SELL_BUY = 2   
                THEN(TRADEQTY * NETRATE) - (   
                CASE   
                        WHEN C.SERVICE_CHRG = 1   
                        THEN ISNULL((F.SERVICE_TAX),0)   
                        ELSE (   
                        CASE   
                                WHEN C.SERVICE_CHRG = 0   
                                THEN 0   
                                ELSE (   
                                CASE   
                                        WHEN C.SERVICE_CHRG = 2   
                                        THEN 0   
                                        ELSE 0 END ) END ) END)   
                ELSE 0 END),   
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,   
        F.PARTY_CODE,   
        SELL_BUY,   
        CONTRACTNO,   
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,   
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,   
        PSERVICE_TAX= (   
        CASE   
                WHEN SELL_BUY = 1   
                THEN (   
                CASE   
                        WHEN C.SERVICE_CHRG=0   
                        THEN (F.SERVICE_TAX)   
                        ELSE (   
                        CASE   
                                WHEN C.SERVICE_CHRG=1   
                                THEN 0   
                                ELSE (   
                                CASE   
                                        WHEN C.SERVICE_CHRG=2   
                                        THEN 0 END) END) END)   
                ELSE 0 END),   
        SSERVICE_TAX= (   
        CASE   
                WHEN SELL_BUY = 2   
                THEN (   
                CASE   
                        WHEN C.SERVICE_CHRG=0   
                        THEN (F.SERVICE_TAX)   
                        ELSE (   
                        CASE   
                                WHEN C.SERVICE_CHRG=1   
                                THEN 0   
                                ELSE (   
                                CASE   
                                        WHEN C.SERVICE_CHRG=2   
                                        THEN 0 END) END) END)   
                ELSE 0 END),   
        DFLAG       = 1 ,   
        BROKER_CHRG = (   
        CASE   
                WHEN BROKERNOTE = 1   
                THEN BROKER_CHRG   
                ELSE 0 END ),   
        TURN_TAX = (   
        CASE   
                WHEN TURNOVER_TAX = 1   
                THEN TURN_TAX   
                ELSE 0 END),   
        SEBI_TAX = (  
        CASE   
                WHEN SEBI_TURN_TAX = 1   
                THEN SEBI_TAX   
                ELSE 0 END),   
        OTHER_CHRG = (   
        CASE   
                WHEN C.OTHER_CHRG = 1   
                THEN F.OTHER_CHRG   
                ELSE 0 END) ,   
        INS_CHRG = (   
        CASE   
                WHEN INSURANCE_CHRG = 1   
                THEN INS_CHRG   
                ELSE 0 END ),   
        SERVICE_TAX = (   
        CASE   
                WHEN SERVICE_CHRG = 0   
                THEN SERVICE_TAX   
                ELSE 0 END ),   
        NSERTAX = (   
        CASE   
                WHEN SERVICE_CHRG = 0   
                THEN SERVICE_TAX  
                ELSE 0 END ),   
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0),
		PRINTF,
		C.SERVICE_CHRG,
		LOTSIZE 
INTO    #CONTSETT   
FROM    #FOSETT F,   
        CONTRACT_MASTER C   
WHERE   
   F.PARTY_CODE=C.PARTY_CODE   
   AND LEFT(F.SAUDA_DATE,11) = LEFT(C.TRADE_DATE,11)	  
 
UPDATE     
 #CONTSETT    
SET    
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END    
			+ (CASE WHEN SERVICE_CHRG = 1 THEN     
			CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END    
			ELSE 0 END),    
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
				CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END    
				ELSE 0 END),    
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
			CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END    
			ELSE 0 END),    
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
				 CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE 0 END    
				 ELSE 0 END),    
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
				 CASE WHEN SELL_BUY =1 THEN 0 ELSE CD_TOT_SELLSERTAX END    
				 ELSE 0 END),    
 PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK     
	  + (CASE WHEN SERVICE_CHRG = 1 THEN ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)    
         ELSE 0 END),     
 SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK     
	  - (CASE WHEN SERVICE_CHRG = 1 THEN ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)    
      ELSE 0 END)    
     
FROM    
 CHARGES_DETAIL    
WHERE    
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)    
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE     
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE  
 AND CD_PRODUCT_CODE = PRODUCT_CODE  
 AND CD_SERIES_ID = SERIES_ID  
 AND CD_SERIES_CODE = SERIES_CODE  
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE    
 AND CD_TRADE_NO = TRADE_NO    
 AND CD_ORDER_NO = ORDER_NO    

 
INSERT INTO #CONTSETT    
SELECT  CD_ORDER_NO,     
 ORDER_TIME = '',     
 CD_TRADE_NO,     
 TRADETIME='',     
 PQTY = 0,     
 SQTY = 0,     
 PRATE = 0,     
 SRATE = 0,     
 PBROK =0,     
 SBROK =0,     
 PNETRATE = 0,     
 SNETRATE = 0,     
 AMOUNT =0,     
 CD_PRODUCT_TYPE,     
 CD_PRODUCT_CODE,  
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),     
 CD_SERIES_ID,  
 PAMT=0,     
 SAMT=0,     
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE   
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,     
 CD_PARTY_CODE,    
 SELL_BUY = 1,     
 CD_CONTRACT_NO,     
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,     
 STRIKE_PRICE = 0 ,  
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
  CD_TOT_BUYSERTAX    
  ELSE 0 END),    
 SSERVICE_TAX = 0,    
 DFLAG       = 1 ,     
 BROKER_CHRG = 0,     
 TURN_TAX = 0,     
 SEBI_TAX = 0,     
 OTHER_CHRG = 0 ,     
 INS_CHRG = 0,     
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
  CD_TOT_BUYSERTAX     
  ELSE 0 END),    
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN     
  CD_TOT_BUYSERTAX     
  ELSE 0 END),    
 BROKERAGE = CD_TOT_BUYBROK     
  + (CASE WHEN SERVICE_CHRG = 1 THEN     
  CD_TOT_BUYSERTAX     
  ELSE 0 END),
 PRINTF,
 C.SERVICE_CHRG,
 LOTSIZE = 1
FROM    CHARGES_DETAIL F,     
        CONTRACT_MASTER C     
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'    
 AND LEFT(F.CD_SAUDA_DATE,11) = LEFT(C.TRADE_DATE,11)	  
 AND CD_PARTY_CODE     >= '0'     
 AND CD_PARTY_CODE <= 'ZZ'     
 AND CD_CONTRACT_NO BETWEEN (     
 CASE     
         WHEN CD_PRODUCT_CODE LIKE 'OPT%'     
         AND CD_AUCTIONPART ='EA'     
         THEN 0     
         ELSE '0' END)     
 AND '9999'     
 AND CD_PARTY_CODE=C.PARTY_CODE    
 AND CD_TRADE_NO = ''    
 AND CD_TOT_BUYBROK > 0    
    
INSERT INTO #CONTSETT    
SELECT  CD_ORDER_NO,     
 ORDER_TIME = '',     
 CD_TRADE_NO,     
 TRADETIME='',     
 PQTY = 0,     
 SQTY = 0,     
 PRATE = 0,     
 SRATE = 0,     
 PBROK =0,     
 SBROK =0,     
 PNETRATE = 0,     
 SNETRATE = 0,     
 AMOUNT =0,     
 CD_PRODUCT_TYPE,     
 CD_PRODUCT_CODE,  
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),     
 CD_SERIES_ID,  
 PAMT=0,     
 SAMT=0,     
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE   
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,     
 CD_PARTY_CODE,    
 SELL_BUY = 1,     
 CD_CONTRACT_NO,     
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,     
 STRIKE_PRICE = 0 ,  
 PSERVICE_TAX = 0 ,    
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
  CD_TOT_SELLSERTAX    
  ELSE 0 END),    
 DFLAG       = 1 ,     
 BROKER_CHRG = 0,     
 TURN_TAX =0,     
 SEBI_TAX =0,     
 OTHER_CHRG = 0,     
 INS_CHRG = 0,     
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
  CD_TOT_SELLSERTAX     
  ELSE 0 END),    
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN     
  CD_TOT_SELLSERTAX     
  ELSE 0 END),    
 BROKERAGE = CD_TOT_SELLBROK     
  + (CASE WHEN SERVICE_CHRG = 1 THEN     
  CD_TOT_SELLSERTAX     
  ELSE 0 END),
  PRINTF,
 C.SERVICE_CHRG,
LOTSIZE= 1     
FROM    CHARGES_DETAIL F,     
        CONTRACT_MASTER C     
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'    
 AND LEFT(F.CD_SAUDA_DATE,11) = LEFT(C.TRADE_DATE,11)	  
 AND CD_PARTY_CODE     >= '0'     
 AND CD_PARTY_CODE <= 'ZZ'     
 AND CD_CONTRACT_NO BETWEEN (     
 CASE     
         WHEN CD_PRODUCT_CODE LIKE 'OPT%'     
         AND CD_AUCTIONPART ='EA'     
         THEN 0     
         ELSE '0' END)     
 AND '9999'     
 AND CD_PARTY_CODE=C.PARTY_CODE    
 AND CD_TRADE_NO = ''    
 AND CD_TOT_SELLBROK > 0      
  

--INSERT INTO MAIN TABLE  
INSERT INTO CONTRACT_DATA  
(ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE, AMOUNT,
 PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME,LOTSIZE  
 )
SELECT  ORDER_NO=REPLICATE('0',20),   
        ORDER_TIME      = '          ',   
        TRADE_NO        ='00000000000000',   
        TRADETIME       ='0000000000000',   
        PQTY            =SUM(PQTY),   
        SQTY            =SUM(SQTY),   
        PRATE           =(   
        CASE   
                WHEN SUM(PQTY) > 0   
                THEN SUM(PRATE*PQTY)/SUM(PQTY)   
                ELSE 0 END),   
        SRATE=(   
        CASE   
                WHEN SUM(SQTY) > 0   
                THEN SUM(SRATE*SQTY)/SUM(SQTY)   
                ELSE 0 END ),   
        PBROK=(   
        CASE   
                WHEN SUM(PQTY) > 0   
                THEN SUM(PBROK*PQTY)/SUM(PQTY)   
                ELSE 0 END ),   
        SBROK=(   
        CASE   
                WHEN SUM(SQTY) > 0   
                THEN SUM(SBROK*SQTY)/SUM(SQTY)   
                ELSE 0 END ),   
        PNETRATE=(   
        CASE   
                WHEN SUM(PQTY) > 0   
            THEN SUM(PNETRATE*PQTY)/SUM(PQTY)   
  ELSE 0 END ),   
        SNETRATE=(   
        CASE   
                WHEN SUM(SQTY) > 0   
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)   
                ELSE 0 END ),   
        AMOUNT=SUM(AMOUNT),   
		PRODUCT_TYPE,  
		PRODUCT_CODE,  
		SERIES_CODE,  
		SERIES_ID,  
        PAMT=SUM(PAMT),   
        SAMT=SUM(SAMT),   
        EXPIRYDATE,   
        PARTY_CODE,   
        SELL_BUY,   
        CONTRACTNO,   
        SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),   
        STRIKE_PRICE,   
        PSERVICE_TAX=SUM(PSERVICE_TAX),   
        SSERVICE_TAX=SUM(SSERVICE_TAX),   
        DFLAG,   
        BROKER_CHRG = SUM(BROKER_CHRG),   
        TURN_TAX    = SUM(TURN_TAX),   
        SEBI_TAX    = SUM(SEBI_TAX),   
        OTHER_CHRG  = SUM(OTHER_CHRG) ,   
        INS_CHRG    = SUM(INS_CHRG),   
        SERVICE_TAX = SUM(SERVICE_TAX),   
        NSERTAX     = SUM(NSERTAX),   
        BROKERAGE   = SUM(BROKERAGE),
		PRINTF,   
        SERVICE_CHRG,     
        @USERNAME,
		LOTSIZE  

FROM    #CONTSETT   
WHERE   PRINTF = '3'   
GROUP BY PRODUCT_TYPE,  
		PRODUCT_CODE,  
		SERIES_CODE,  
		SERIES_ID,  
        EXPIRYDATE,   
        PARTY_CODE,   
        SELL_BUY,   
        CONTRACTNO,   
        STRIKE_PRICE,   
        CONVERT(DATETIME,SAUDA_DATE,103),   
        DFLAG,
		PRINTF,   
        SERVICE_CHRG,LOTSIZE 

--SELECT * INTO ##SEN FROM #CONTSETT
INSERT   
INTO    CONTRACT_DATA (ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE,
 AMOUNT, PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME,LOTSIZE  
 )

SELECT ORDER_NO,ORDER_TIME,TRADE_NO,TRADETIME,PQTY,SQTY,PRATE,SRATE,PBROK,SBROK,PNETRATE,SNETRATE,
AMOUNT,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,PAMT,SAMT,EXPIRYDATE=CONVERT(SMALLDATETIME,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)),PARTY_CODE,SELL_BUY,CONTRACTNO,
SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),STRIKE_PRICE,PSERVICE_TAX,SSERVICE_TAX,DFLAG,BROKER_CHRG,TURN_TAX,SEBI_TAX,
OTHER_CHRG,INS_CHRG,SERVICE_TAX,NSERTAX,BROKERAGE,PRINTF,SERVICE_CHRG,@USERNAME,LOTSIZE 
FROM    #CONTSETT WITH (NOLOCK)   
WHERE   PRINTF <> '3'   

UPDATE CONTRACT_DATA   
        SET ORDER_NO = S.ORDER_NO,   
        ORDER_TIME   = S.ORDER_TIME,   
        TRADETIME    = S.TRADETIME,   
        TRADE_NO     = S.TRADE_NO   
FROM    #CONTSETT S WITH(NOLOCK)   
WHERE   S.PRINTF           = CONTRACT_DATA.PRINTF   
        AND S.PRINTF       = '3'   
        AND S.PARTY_CODE   = CONTRACT_DATA.PARTY_CODE   
		AND S.PRODUCT_TYPE = CONTRACT_DATA.PRODUCT_TYPE  
		AND S.PRODUCT_CODE = CONTRACT_DATA.PRODUCT_CODE  
		AND S.SERIES_CODE  = CONTRACT_DATA.SERIES_CODE  
		AND S.SERIES_ID    = CONTRACT_DATA.SERIES_ID  
        AND S.EXPIRYDATE   = CONTRACT_DATA.EXPIRYDATE   
        AND S.STRIKE_PRICE = CONTRACT_DATA.STRIKE_PRICE   
        AND S.SELL_BUY     = CONTRACT_DATA.SELL_BUY   
        AND S.SAUDA_DATE   =   
        (SELECT MIN(SAUDA_DATE)   
        FROM    #CONTSETT ISETT   
        WITH(NOLOCK)   
        WHERE   PRINTF             = '3'   
                AND S.PARTY_CODE   = ISETT.PARTY_CODE   
				AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE  
				AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE  
				AND S.SERIES_CODE  = ISETT.SERIES_CODE  
				AND S.SERIES_ID    = ISETT.SERIES_ID  
				AND S.EXPIRYDATE   = ISETT.EXPIRYDATE   
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE   
                AND S.SELL_BUY     = ISETT.SELL_BUY   
        )   


--INSERT DETAIL RECORDS FOR SUMMARISED ENTRIES
INSERT   
INTO    CONTRACT_DATA_DET (ORDER_NO, ORDER_TIME, TRADE_NO,TRADETIME, PQTY, SQTY, PRATE, SRATE, PBROK, SBROK, PNETRATE, SNETRATE,
 AMOUNT, PRODUCT_TYPE, PRODUCT_CODE, SERIES_CODE, SERIES_ID, PAMT, SAMT, EXPIRYDATE, PARTY_CODE, SELL_BUY, CONTRACTNO,
 SAUDA_DATE, STRIKE_PRICE, PSERVICE_TAX, SSERVICE_TAX, DFLAG, BROKER_CHRG, TURN_TAX, SEBI_TAX, OTHER_CHRG,
 INS_CHRG, SERVICE_TAX, NSERTAX, BROKERAGE,PRINTF, SERVICE_CHRG, CREATERNAME, LOTSIZE  
 )

SELECT ORDER_NO,ORDER_TIME,TRADE_NO,TRADETIME,PQTY,SQTY,PRATE,SRATE,PBROK,SBROK,PNETRATE,SNETRATE,
AMOUNT,PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,PAMT,SAMT,EXPIRYDATE=CONVERT(SMALLDATETIME,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)),PARTY_CODE,SELL_BUY,CONTRACTNO,
SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE,103),STRIKE_PRICE,PSERVICE_TAX,SSERVICE_TAX,DFLAG,BROKER_CHRG,TURN_TAX,SEBI_TAX,
OTHER_CHRG,INS_CHRG,SERVICE_TAX,NSERTAX,BROKERAGE,PRINTF,SERVICE_CHRG,@USERNAME, LOTSIZE 
FROM    #CONTSETT WITH (NOLOCK)   
WHERE   PRINTF = '3'  


EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CONTRACT','',@USERNAME,''

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_BFOMARGINCOLL_EXCH
-- --------------------------------------------------

CREATE  PROC PR_BFOMARGINCOLL_EXCH  
(  
 @MARGINDATE VARCHAR(11),  
 @MARGINTYPE VARCHAR(10)   -- ADDITIONAL / NORMAL  
)AS  
  
IF @MARGINTYPE = 'NORMAL'  
BEGIN  
 /*=============================  NORMAL MARGIN STARTS HERE ======================================*/  
  
  
  /*-------------------------MAINTAIN ORGINAL MARGINS AT EXCH TABLES--------------------------------*/  
    
  DELETE FROM BFOMARGIN_EXCH WHERE MARGIN_DATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
    
  INSERT INTO BFOMARGIN_EXCH   
  SELECT MARGIN_DATE,PARTY_CODE,SPAN_MARGIN,EXTREME_LOSS_MARGIN,NET_PREMIUM,DAILY_MTM_SETTLEMENT_VALUE,
  FINAL_SETTLEMENT_MARGIN,TOTAL_MARGIN,ACCOUNT_TYPE
  FROM BFOMARGIN_IMP    
  
  
  /*------APPLYING MARKUPS FOR ALL PARTIES BASED ON CLIENT PROFILE (WITH OUT EXCEPTIONS)-----------*/  
  UPDATE  
   BFOMARGIN_IMP  
  SET  
   SPAN_MARGIN = CASE  
      WHEN SPAN_MARGIN_MARKUP > 0  
      THEN SPAN_MARGIN * SPAN_MARGIN_MARKUP / 100  
      ELSE SPAN_MARGIN   
     END ,  
   EXTREME_LOSS_MARGIN = CASE  
     WHEN EXPOSURE_MARGIN_MARKUP > 0  
     THEN EXTREME_LOSS_MARGIN * EXPOSURE_MARGIN_MARKUP / 100  
     ELSE EXTREME_LOSS_MARGIN  
    END  
  FROM  
   (  
    SELECT   
     SPAN_MARGIN_MARKUP,  
     EXPOSURE_MARGIN_MARKUP  
    FROM  
     ACCOUNTBFO.DBO.V2_CLIENTPROFILES_FA  
    WHERE  
     @MARGINDATE BETWEEN FROMDATE AND TODATE  
     AND CLTCODE  = 'ALL'  
   ) FOMARKUP  
  WHERE  
   PARTY_CODE NOT IN   
   (  
   SELECT  
    CLTCODE  
   FROM  
    ACCOUNTBFO.DBO.V2_CLIENTPROFILES_FA  
   WHERE  
    @MARGINDATE BETWEEN FROMDATE AND TODATE  
   )  
    
    
  /*----------APPLYING MARKUPS FOR EXCEPTION PARTIES BASED ON CLIENT PROFILE ---------------*/  
    
  UPDATE  
   BFOMARGIN_IMP  
  SET  
   SPAN_MARGIN = CASE  
      WHEN SPAN_MARGIN_MARKUP > 0  
      THEN SPAN_MARGIN * SPAN_MARGIN_MARKUP / 100  
      ELSE SPAN_MARGIN   
     END ,  
   EXTREME_LOSS_MARGIN = CASE  
     WHEN EXPOSURE_MARGIN_MARKUP > 0  
     THEN EXTREME_LOSS_MARGIN * EXPOSURE_MARGIN_MARKUP / 100  
     ELSE EXTREME_LOSS_MARGIN  
    END  
  FROM  
   (  
    SELECT   
     CLTCODE,  
     SPAN_MARGIN_MARKUP,  
     EXPOSURE_MARGIN_MARKUP  
    FROM  
     ACCOUNTBFO.DBO.V2_CLIENTPROFILES_FA  
    WHERE  
     @MARGINDATE BETWEEN FROMDATE AND TODATE  
   ) FOMARKUP  
  WHERE  
   BFOMARGIN_IMP.PARTY_CODE = FOMARKUP.CLTCODE  
  
   UPDATE BFOMARGIN_IMP SET TOTAL_MARGIN = SPAN_MARGIN+EXTREME_LOSS_MARGIN+NET_PREMIUM+DAILY_MTM_SETTLEMENT_VALUE+ FINAL_SETTLEMENT_MARGIN

 /*=============================  NORMAL MARGIN END HERE ======================================*/  
    
END  
ELSE  
BEGIN  
 /*=============================  ADDITIONAL MARGIN STARTS HERE ======================================*/  
  
  
  /*-------------------------MAINTAIN ORGINAL MARGINS AT EXCH TABLES--------------------------------*/  
    
  DELETE FROM BFOADHOCMARGIN_EXCH WHERE LEFT(SAUDA_DATE,11) = @MARGINDATE  
    
  INSERT INTO BFOADHOCMARGIN_EXCH SELECT *,GETDATE() FROM BFOADHOCMARGIN_IMP  
    
  /*------APPLYING MARKUPS FOR ALL PARTIES BASED ON CLIENT PROFILE (WITH OUT EXCEPTIONS)-----------*/  
  UPDATE  
   BFOADHOCMARGIN_IMP  
  SET  
   ADDMARGIN = CASE  
     WHEN ADHOC_MARGIN_MARKUP > 0  
     THEN ADDMARGIN * ADHOC_MARGIN_MARKUP / 100  
     ELSE ADDMARGIN   
    END   
  FROM  
   (  
    SELECT   
     ADHOC_MARGIN_MARKUP  
    FROM  
     ACCOUNTBFO.DBO.V2_CLIENTPROFILES_FA  
    WHERE  
     @MARGINDATE BETWEEN FROMDATE AND TODATE  
     AND CLTCODE  = 'ALL'  
   ) FOMARKUP  
  WHERE  
   PARTY_CODE NOT IN   
   (  
   SELECT  
    CLTCODE  
   FROM  
    ACCOUNTBFO.DBO.V2_CLIENTPROFILES_FA  
   WHERE  
    @MARGINDATE BETWEEN FROMDATE AND TODATE  
   )  
    
    
  /*----------APPLYING MARKUPS FOR EXCEPTION PARTIES BASED ON CLIENT PROFILE ---------------*/  
    
  UPDATE  
   BFOADHOCMARGIN_IMP  
  SET  
   ADDMARGIN = CASE  
     WHEN ADHOC_MARGIN_MARKUP > 0  
     THEN ADDMARGIN * ADHOC_MARGIN_MARKUP / 100  
     ELSE ADDMARGIN   
    END   
  FROM  
   (  
    SELECT   
     CLTCODE,  
     ADHOC_MARGIN_MARKUP  
    FROM  
     ACCOUNTBFO.DBO.V2_CLIENTPROFILES_FA  
    WHERE  
     @MARGINDATE BETWEEN FROMDATE AND TODATE  
   ) FOMARKUP  
  WHERE  
   BFOADHOCMARGIN_IMP.PARTY_CODE = FOMARKUP.CLTCODE  
  
 /*=============================  ADDITIONAL MARGIN END HERE ======================================*/  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CHARGES_DETAIL
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[PR_Charges_Detail]         
(        
 @SAUDA_DATE_FROM VARCHAR(11),        
 @SAUDA_DATE_TO VARCHAR(11) = @SAUDA_DATE_FROM ,        
 @PARTY_FROM VARCHAR(10) ='',        
 @PARTY_TO VARCHAR(10) ='ZZZZZZZZZZZ' ,
 @USERNAME VARCHAR(20) =''       
) AS         

  
    
/*    
 PROCEDURE NAME  : CALCULATE_VOLUMNBROK    
 DESCRIPTION : COMPUTE VOLUMN (VALUE/QUANTITY/LOT SIZE)    
 TABLES USING  :     
 1. SCHEME_MASTER - SCHEME DEFINITION MASTER TABLE     
 2. SCHEME_MAPPING - SCHEME MAPPING TO END CLIENT     
 3. CONTRACT_ROUNDING - CLIENT'S CONTRACT LEVEL ROUNDINGS    
 4. CHARGES_DETAIL - KEEPING COMPUTED BROKERAGE    
*/    
    
/*---------------------------------------------------------------------------------------------------------------    
    CREATING TEMP TABLE FOR PROCESS    
----------------------------------------------------------------------------------------------------------------*/    
    
CREATE TABLE [DBO].[#CHARGES_DETAIL_TEMP]    
(    
	[CD_PARTY_CODE] [VARCHAR](10) NULL,
	[CD_SAUDA_DATE] [DATETIME] NOT NULL,
	[CD_CONTRACT_NO] [VARCHAR](14) NULL,
	[CD_TRADE_NO] [VARCHAR](15) NULL,
	[CD_ORDER_NO] [VARCHAR](20) NULL,
	[CD_PRODUCT_TYPE] [VARCHAR](3) NULL,
	[CD_PRODUCT_CODE] [VARCHAR](7) NULL,
	[CD_ASSET_CODE] [VARCHAR](8) NULL,
	[CD_EXPIRYDATE] [DATETIME] NULL,
	[CD_STRIKE_PRICE] [NUMERIC](12, 4) NULL,
	[CD_OPTION_TYPE] [VARCHAR](2) NULL,
	[CD_SERIES_CODE] [VARCHAR](25) NULL,
	[CD_SERIES_ID] [NUMERIC](9, 0) NULL,
	[CD_LOT_SIZE] [NUMERIC](9, 0) NULL,
	[CD_AUCTIONPART] [VARCHAR](2) NULL,
	[CD_MARKETLOT] [INT] NOT NULL,
	[CD_SCHEME_ID] [INT] NOT NULL,
	[CD_COMPUTATIONLEVEL] [CHAR](1) NULL,
	[CD_COMPUTATIONON] [CHAR](1) NULL,
	[CD_COMPUTATIONTYPE] [CHAR](1) NULL,
	[CD_BUYRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_SELLRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_BUYQTY] [INT] NOT NULL,
	[CD_TOT_SELLQTY] [INT] NOT NULL,
	[CD_TOT_BUYTURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SELLTURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_BUYTURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SELLTURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_TURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_TURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_LOT] [INT] NOT NULL,
	[CD_TOT_RES_TURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_RES_TURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_RES_LOT] [INT] NOT NULL,
	[CD_TOT_BUYBROK] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SELLBROK] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_BROK] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SERTAX] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_STT] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_TURN_TAX] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_OTHER_CHRG] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SEBI_TAX] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_STAMPDUTY] [NUMERIC](36, 12) NOT NULL,
	[CD_EXCH_BUYRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_EXCH_SELLRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_MIN_BROKAMT] [NUMERIC](36, 12) NOT NULL,
	[CD_MAX_BROKAMT] [NUMERIC](36, 12) NOT NULL,
	[CD_MIN_SCRIPAMT] [NUMERIC](36, 12) NOT NULL,
	[CD_MAX_SCRIPAMT] [NUMERIC](36, 12) NOT NULL	
)    
    
SELECT * INTO #CHARGES_DETAIL_TEMP1 FROM #CHARGES_DETAIL_TEMP WHERE 1 = 2    
    
SELECT * INTO #CHARGES_DETAIL_FINAL FROM #CHARGES_DETAIL_TEMP WHERE 1 = 2    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_TEMP]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_PRODUCT_CODE], [CD_SERIES_CODE]    
)    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_TEMP1]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_PRODUCT_CODE], [CD_SERIES_CODE]    
)    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_FINAL]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_PRODUCT_CODE], [CD_SERIES_CODE]    
)    
    
/*---------------------------------------------------------------------------------------------------------------    
    FETCHING DATA FOR FLAT VALUE BASED BROKERAGE    
----------------------------------------------------------------------------------------------------------------*/    
  
IF @PARTY_TO='' BEGIN SET @PARTY_TO ='ZZZZZ' END    

SELECT     
 TRADE_NO=PRADNYA.dbo.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,    
 PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
 SERIES_CODE,SERIES_ID,LOT_SIZE,   
 TRADEQTY,LOTSIZE = CONVERT(BIGINT,LOT_SIZE),SAUDA_DATE=LEFT(SAUDA_DATE,11),TRADE_PRICE,       
 SP_PARTY_CODE,SP_COMPUTATION_LEVEL,SP_SCHEME_ID,SP_TRD_TYPE,    
 SP_SCHEME_TYPE,SP_MULTIPLIER,SP_BUY_BROK,SP_SELL_BROK,SP_RES_MULTIPLIER,    
 SP_RES_BUY_BROK,SP_RES_SELL_BROK,SP_VALUE_FROM,SP_VALUE_TO,SP_BROK_COMPUTEON,    
 SP_BROK_COMPUTETYPE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
 SP_BUY_BROK_TYPE,SP_SELL_BROK_TYPE,AUCTIONPART,    
 INS_CHRG = (INS_CHRG),    
 TURN_TAX = (TURN_TAX),     
 OTHER_CHRG = (F.OTHER_CHRG),    
 SEBI_TAX = (SEBI_TAX),    
 BROKER_CHRG = (BROKER_CHRG),    
 BUY_TURNOVER =     
  CASE WHEN SELL_BUY = 1 THEN     
    CASE WHEN SP_BROK_COMPUTEON = 'T'     
    THEN TRADEQTY * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
      CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
      WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
      ELSE TRADE_PRICE + STRIKE_PRICE END END)    
    WHEN SP_BROK_COMPUTEON = 'Q'    
     THEN TRADEQTY    
    WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
    ELSE TRADE_PRICE*TRADEQTY*CONVERT(BIGINT,LOT_SIZE)    
    END    
  ELSE 0 END,    
 SELL_TURNOVER =    
  CASE WHEN SELL_BUY = 2 THEN    
   CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN TRADEQTY * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
      CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
      WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
      ELSE TRADE_PRICE + STRIKE_PRICE END END)    
   WHEN SP_BROK_COMPUTEON = 'Q'    
    THEN TRADEQTY    
   WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
    ELSE TRADE_PRICE*TRADEQTY*CONVERT(BIGINT,LOT_SIZE)    
   END    
  ELSE 0 END,    
 TOTAL_TURNOVER =    
  CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN TRADEQTY * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
      CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
      WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
      ELSE TRADE_PRICE + STRIKE_PRICE END END)    
   WHEN SP_BROK_COMPUTEON = 'Q'    
    THEN TRADEQTY    
   WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
    ELSE TRADE_PRICE*TRADEQTY*CONVERT(BIGINT,LOT_SIZE)    
  END   
   INTO #BFOSETTLEMENT1
 FROM    
  BFOSETTLEMENT F (NOLOCK),    
  SCHEME_MAPPING S (NOLOCK),    
  CLIENT1 C1 (NOLOCK),    
  CLIENT2 C2 (NOLOCK)   
 WHERE    
  SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59'    
  AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
  AND SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
  AND F.PARTY_CODE = SP_PARTY_CODE    
  AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
  AND F.PRODUCT_CODE =  CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN F.PRODUCT_CODE  ELSE SP_PRODUCT_CODE END    
  AND  1 = CASE    
    WHEN SP_PRODUCT_CODE = 'ALL' AND PRODUCT_CODE NOT IN     
    (     
    SELECT SP_PRODUCT_CODE FROM SCHEME_MAPPING S    
    WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
    AND F.PARTY_CODE = SP_PARTY_CODE    
    AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
    )     
   THEN 1       
   ELSE CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN 0 ELSE 1  END END    
  AND SP_TRD_TYPE = CASE WHEN AUCTIONPART <> 'EA'    
    THEN 'TRD' ELSE 'DEL' END    
 AND AUCTIONPART <> 'CA'    
 AND TRADEQTY > 0     
 AND SP_BROK_COMPUTETYPE = 'V'    
 AND C1.CL_CODE = C2.CL_CODE     
 AND C2.PARTY_CODE = F.PARTY_CODE    
 --AND C1.CL_TYPE <> 'INS' AND RESERVED1 = 0      
 AND TRADESTATUS <> 'E'   
 
 
 
    
 SELECT     
	T_SAUDADATE = LEFT(SAUDA_DATE,11),    
	T_PARTY_CODE = PARTY_CODE,    
	T_PRODUCT_TYPE = PRODUCT_TYPE,
	T_PRODUCT_CODE = PRODUCT_CODE,
	T_EXPIRYDATE = EXPIRYDATE,
	T_STRIKE_PRICE = STRIKE_PRICE,
	T_OPTION_TYPE = OPTION_TYPE,
	T_SERIES_CODE = SERIES_CODE,
	T_SERIES_ID = SERIES_ID,
    TOT_BUYQTY = SUM(CASE WHEN SELL_BUY = 1     
				   THEN    
					(TRADEQTY )    
				   ELSE    
					0    
				   END),    
    TOT_SELLQTY = SUM(CASE WHEN SELL_BUY = 2    
				   THEN    
					(TRADEQTY )    
				   ELSE    
					0    
				   END),
	TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY = 1     
						THEN    
						(TRADEQTY * TRADE_PRICE )    
						ELSE    
						0    
						END),    
	TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY = 2    
						THEN    
						(TRADEQTY * TRADE_PRICE)    
						ELSE    
						0    
						END) ,
	T_AUCTIONPART = AUCTIONPART
					   
INTO #TRD_BFOSETTLEMENT  

FROM    
	BFOSETTLEMENT  (NOLOCK)  
WHERE    
	SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59'     
	AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO  
GROUP BY    
	LEFT(SAUDA_DATE,11),PARTY_CODE,	PRODUCT_TYPE,
	PRODUCT_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,AUCTIONPART



    
    
   
SELECT     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO ,    
 TRADE_NO = (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 ORDER_NO = (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 PRODUCT_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
 PRODUCT_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE '' END),  
 ASSET_CODE =   (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN ASSET_CODE ELSE '' END),  
 EXPIRYDATE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),  
 STRIKE_PRICE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),  
 OPTION_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),
 SERIES_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
 SERIES_ID = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END), 
 LOT_SIZE,   
 AUCTIONPART ,    
 MARKETLOT = SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY),    
 SP_COMPUTATION_LEVEL,    
 SP_BROK_COMPUTEON,    
 SP_BROK_COMPUTETYPE,    
 SP_SCHEME_TYPE,    
 SP_SCHEME_ID,    
 BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
     THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
      SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
     ELSE 0     
     END),    
 SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
     THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
     ELSE 0     
     END),    
 BUY_QTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),    
 SELL_QTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),    
 TOTALQTY = SUM(TRADEQTY),    
 TOTALTURNOVER = SUM(TOTAL_TURNOVER),    
 BUY_TURNOVER = SUM(BUY_TURNOVER),    
 RND_BUY_TURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(SUM(BUY_TURNOVER),SP_MULTIPLIER) ,    
 SELL_TURNOVER = SUM(SELL_TURNOVER),    
 RND_SELL_TURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(SUM(SELL_TURNOVER),SP_MULTIPLIER) ,    
 RND_TURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TOTAL_TURNOVER),SP_MULTIPLIER) ,     
 TOTALLOT = (CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN CONVERT(BIGINT,PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TOTAL_TURNOVER), SP_MULTIPLIER) / CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END)    
   WHEN SP_BROK_COMPUTEON = 'Q'      
   THEN CONVERT(BIGINT,PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TRADEQTY), SP_MULTIPLIER) / CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END)    
   WHEN SP_BROK_COMPUTEON = 'L'    
   THEN CONVERT(BIGINT,PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TRADEQTY),     
    (CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END*SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY))) /     
    (CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END*SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY)))    
   ELSE    
    SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY)    
   END),    
 TOTALTURNOVER_RES = 0,    
 RND_TURNOVER_RES = 0,    
 TOTALLOT_RES = 0,    
BUYBROKERAGE = CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END) > 0 THEN	
	(((((CASE 
		WHEN SP_SCHEME_TYPE = 0 
			THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
				THEN (CASE 
					WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
					THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
					ELSE 0 
					END) 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
				THEN 1 
				ELSE SUM(BUY_TURNOVER) 
				END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE	WHEN SP_BUY_BROK_TYPE = 'P' 
										THEN SP_BUY_BROK / 100 
										ELSE SP_BUY_BROK 
										END)
			) 
				WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
			) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
			) AND SP_SCHEME_TYPE = 1) 
				 OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
			) < SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
			) AND SP_SCHEME_TYPE = 3)
			THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
				THEN (CASE 
					WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
					THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
					ELSE 0	END) 
				WHEN SP_BROK_COMPUTEON = 'V'AND SP_BUY_BROK_TYPE = 'V' 
				THEN 1 
			ELSE SUM(BUY_TURNOVER) 
			END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE WHEN SP_BUY_BROK_TYPE = 'P' THEN SP_BUY_BROK / 100 ELSE SP_BUY_BROK END)) 
                         
		ELSE (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
			THEN (CASE 
				WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
				THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
				ELSE 0 
				END) 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
			THEN 1 
			ELSE SUM(BUY_TURNOVER) 
			END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
									WHEN SP_SELL_BROK_TYPE = 'P' 
									THEN SP_SELL_BROK / 100 
									ELSE SP_SELL_BROK 
									END)
			) 
           				END) ) ) )) ELSE 0 END, 

SELLBROKERAGE = CASE WHEN SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END) > 0 THEN
	(((((CASE 
		WHEN SP_SCHEME_TYPE = 0 
		THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
			THEN (CASE 
				WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
				THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
				ELSE 0 
				END) 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
			THEN 1 
			ELSE SUM(SELL_TURNOVER) 
			END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
									WHEN SP_SELL_BROK_TYPE = 'P' 
									THEN SP_SELL_BROK / 100 
									ELSE SP_SELL_BROK 
									END)
			) 

			 WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
		) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
		) AND SP_SCHEME_TYPE = 1)     
			  OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
		) > SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
		) AND SP_SCHEME_TYPE = 3) 
			THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
				THEN (CASE 
					WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
					THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
					ELSE 0 
					END) 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
				THEN 1 
				ELSE SUM(SELL_TURNOVER) 
				END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
										WHEN SP_SELL_BROK_TYPE = 'P' 
										THEN SP_SELL_BROK / 100 
										ELSE SP_SELL_BROK 
										END)
				) 
				
				ELSE (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
					WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
					THEN (CASE 
						WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
						THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
						ELSE 0 
						END) 
					WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
					THEN 1 
					ELSE SUM(SELL_TURNOVER) 
					END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
											WHEN SP_BUY_BROK_TYPE = 'P' 
											THEN SP_BUY_BROK / 100 
											ELSE SP_BUY_BROK 
											END)
					) 
             					END) ) )) ) ELSE 0 END, 
TOTALBROKERAGE = 0,     
 CD_TOT_SERTAX = 0 ,    
 CD_TOT_STT = SUM(INS_CHRG),    
 CD_TOT_TURN_TAX = SUM(TURN_TAX),    
 CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,    
 CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,    
 CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,    
 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),    
 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
    ELSE 0     
    END),    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT  
 INTO #BFOSETTLEMENT2  
 FROM     
 #BFOSETTLEMENT1 FOSETT  ,
 #TRD_BFOSETTLEMENT   
 WHERE
	T_SAUDADATE = LEFT(SAUDA_DATE,11) AND
	T_PARTY_CODE = PARTY_CODE AND
	T_PRODUCT_TYPE = PRODUCT_TYPE AND
	T_PRODUCT_CODE = PRODUCT_CODE AND
	T_EXPIRYDATE = EXPIRYDATE AND
	T_STRIKE_PRICE = STRIKE_PRICE AND
	T_OPTION_TYPE = OPTION_TYPE AND
	T_SERIES_CODE = SERIES_CODE AND
	T_SERIES_ID = SERIES_ID AND 
	T_AUCTIONPART = AUCTIONPART

GROUP BY     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO,    
(CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE '' END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN ASSET_CODE ELSE '' END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END),    
 SP_MULTIPLIER,SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_SCHEME_TYPE,    
 SP_BROK_COMPUTETYPE,SP_VALUE_FROM,SP_VALUE_TO,SP_SCHEME_ID,    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,        
 SP_SELL_BROK, SP_BUY_BROK, SP_BUY_BROK_TYPE, SP_SELL_BROK_TYPE,    
 AUCTIONPART,PRODUCT_CODE,LOT_SIZE
 HAVING     
 (CASE     
  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*TRADE_PRICE)       
  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
  ELSE (SUM(TRADEQTY*TRADE_PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
 END) > SP_VALUE_FROM       
 AND       
 (CASE    
  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*TRADE_PRICE)       
  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)      
  ELSE (SUM(TRADEQTY*TRADE_PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
 END)    
  <=     
    (CASE WHEN SP_VALUE_TO = -1     
     THEN (CASE WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*TRADE_PRICE)       
      WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
      WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
      ELSE (SUM(TRADEQTY*TRADE_PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
     END)    
    ELSE SP_VALUE_TO    
    END)  
       
INSERT INTO #CHARGES_DETAIL_TEMP    
(    
	CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,  
	CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_ASSET_CODE,CD_EXPIRYDATE,
	CD_STRIKE_PRICE,CD_OPTION_TYPE,CD_SERIES_CODE,CD_SERIES_ID,
	CD_LOT_SIZE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,    
	CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
	CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,    
	CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
	CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
	CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,    
	CD_TOT_SERTAX,CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,    
	CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
)    
    
SELECT    
 PARTY_CODE,SAUDA_DATE,CONTRACTNO,TRADE_NO,ORDER_NO,    
 PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,
STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,
AUCTIONPART,MARKETLOT,SP_SCHEME_ID,    
 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_BROK_COMPUTETYPE,    
 BUYRATE,SELLRATE,    
 BUY_QTY, SELL_QTY,     
 BUY_TURNOVER, SELL_TURNOVER,    
 RND_BUY_TURNOVER, RND_SELL_TURNOVER,     
 TOTALTURNOVER, RND_TURNOVER,    
 TOTALLOT=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN (BUY_QTY+SELL_QTY)/TOTALLOT ELSE TOTALLOT END),    
 TOTALTURNOVER_RES,RND_TURNOVER_RES,TOTALLOT_RES,    
 BUYBROKERAGE = (CASE WHEN SP_BROK_COMPUTEON = 'V'    
        THEN (CASE WHEN BUYBROKERAGE > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,BUYBROKERAGE)     
      ELSE BUYBROKERAGE    
      END)    
     ELSE PRADNYA.dbo.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,BUYBROKERAGE)     
      ELSE BUYBROKERAGE    
      END))    
     END)    
    ELSE 0     
    END)* BUY_QTY/TOTALLOT    
    ELSE BUYBROKERAGE END),    
        SELLBROKERAGE = (CASE WHEN SP_BROK_COMPUTEON = 'V'    
        THEN (CASE WHEN SELLBROKERAGE > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
     THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,SELLBROKERAGE)     
      ELSE SELLBROKERAGE    
      END)    
     ELSE PRADNYA.dbo.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,SELLBROKERAGE)     
      ELSE SELLBROKERAGE    
      END))    
     END)    
    ELSE 0     
    END) * SELL_QTY/TOTALLOT    
    ELSE SELLBROKERAGE END),    
 TOTALBROKERAGE = CASE WHEN SP_BROK_COMPUTEON = 'V' THEN 0 ELSE      
   (CASE WHEN (BUYBROKERAGE+SELLBROKERAGE) > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
     THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,(BUYBROKERAGE+SELLBROKERAGE))     
      ELSE (BUYBROKERAGE+SELLBROKERAGE)    
      END)    
     ELSE PRADNYA.dbo.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,(BUYBROKERAGE+SELLBROKERAGE))     
      ELSE (BUYBROKERAGE+SELLBROKERAGE)    
      END))    
     END)    
    ELSE 0     
    END) END,    
 CD_TOT_SERTAX = 0,CD_TOT_STT,CD_TOT_TURN_TAX,    
 CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,    
 CD_EXCH_SELLRATE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT    
FROM    
#BFOSETTLEMENT2 FOSETTCHRG    
    
    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK    
  AND CD_TOT_SELLBROK > CD_TOT_BUYBROK    
  AND CD_COMPUTATIONON <> 'V'    
    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK    
  AND CD_TOT_BUYBROK > CD_TOT_SELLBROK     
  AND CD_COMPUTATIONON <> 'V'    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_BROK =CD_TOT_SELLBROK+ CD_TOT_BUYBROK    
WHERE    CD_COMPUTATIONON = 'V'    
    
/*---------------------------------------------------------------------------------------------------------------    
    FETCHING DATA FOR INCREMENTAL VALUE BASED BROKERAGE    
----------------------------------------------------------------------------------------------------------------*/    
    
DECLARE @SETTCUR CURSOR,    
 @PARTY_CODE VARCHAR(10),    
 @SAUDA_DATE VARCHAR(11),    
 @CONTRACTNO VARCHAR(14),    
 @TRADE_NO VARCHAR(15),    
 @ORDER_NO VARCHAR(20),    
 @PRODUCT_TYPE VARCHAR(5),    
 @PRODUCT_CODE VARCHAR(10),    
 @SERIES_CODE VARCHAR(20),    
 @SERIES_ID INT,    
 @EXPIRYDATE DATETIME,    
 @AUCTIONPART VARCHAR(2),    
 @BUY_TURNOVER NUMERIC(36,12),    
 @SELL_TURNOVER NUMERIC(36,12),    
 @LOTSIZE BIGINT,    
 @BUYRATE NUMERIC(36,12),    
 @SELLRATE NUMERIC(36,12),    
 @BUYQTY BIGINT,    
 @SELLQTY BIGINT,    
 @TOT_STT NUMERIC(36,12),    
 @TOT_TURN_TAX NUMERIC(36,12),    
 @TOT_OTHER_CHRG NUMERIC(36,12),    
 @TOT_SEBI_TAX NUMERIC(36,12),    
 @TOT_STAMPDUTY NUMERIC(36,12),    
 @EXCH_BUYRATE NUMERIC(36,12),    
 @EXCH_SELLRATE NUMERIC(36,12),    
 @MIN_BROKAMT NUMERIC(36,12),    
 @MAX_BROKAMT NUMERIC(36,12),    
 @MIN_SCRIPAMT NUMERIC(36,12),    
 @MAX_SCRIPAMT NUMERIC(36,12),    
 @SP_COMPUTATIONLEVEL CHAR(1),    
 @SP_COMPUTATIONON CHAR(1),    
 @SP_COMPUTATIONTYPE CHAR(1),    
 @SCHEMEID INT    
    
DECLARE @SCHEMECUR CURSOR,    
@SP_COMPUTATION_LEVEL CHAR(1),    
 @SP_MULTIPLIER MONEY,    
 @SP_BUY_BROK_TYPE CHAR(1),    
 @SP_SELL_BROK_TYPE CHAR(1),    
 @SP_BUY_BROK NUMERIC(36,12),    
 @SP_SELL_BROK NUMERIC(36,12), 
 @SP_VALUE_FROM NUMERIC(36,12),    
 @SP_VALUE_TO NUMERIC(36,12),    
 @BUYFLAG BIGINT,    
 @SELLFLAG BIGINT,    
 @SP_SCHEME_TYPE INT    
    
DECLARE     
 @NEWBUYTURNOVER NUMERIC(36,12),    
 @NEWBUYTURNOVERORG NUMERIC(36,12),    
 @NEWSELLTURNOVER NUMERIC(36,12),    
 @NEWSELLTURNOVERORG NUMERIC(36,12),    
 @BUYBROKERAGE NUMERIC(36,12),    
 @SELLBROKERAGE NUMERIC(36,12)    
    
SET @SETTCUR = CURSOR FOR    
 SELECT     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO,    
 TRADE_NO = (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 ORDER_NO = (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 PRODUCT_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
 PRODUCT_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE PRODUCT_TYPE END),    
 SERIES_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
 SERIES_ID = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END),    
 EXPIRYDATE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
 AUCTIONPART,    
 BUY_TURNOVER = SUM(BUY_TURNOVER),    
 SELL_TURNOVER = SUM(SELL_TURNOVER),    
 LOTSIZE=SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY),    
 BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
  END),    
 SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
  END),    
 BUYQTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),    
 SELLQTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),    
 CD_TOT_STT = SUM(INS_CHRG),    
 CD_TOT_TURN_TAX = SUM(TURN_TAX),    
 CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,    
 CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,    
 CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,    
 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
    ELSE 0     
    END),    
 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
     ELSE 0    
    END),    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID    
 FROM     
 (    
 SELECT     
  TRADE_NO=PRADNYA.dbo.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,    
  PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,    
  TRADEQTY,LOTSIZE = CONVERT(BIGINT,LOT_SIZE),SAUDA_DATE=LEFT(SAUDA_DATE,11),TRADE_PRICE,    
  BUY_TURNOVER = CASE WHEN SELL_BUY = 1 THEN    
     CASE WHEN SP_BROK_COMPUTEON = 'T'     
      THEN TRADEQTY *     
       (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
       CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
       WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
       ELSE TRADE_PRICE + STRIKE_PRICE END END)    
     WHEN SP_BROK_COMPUTEON = 'Q'    
      THEN TRADEQTY    
     ELSE TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
     END    
    ELSE 0 END,    
  SELL_TURNOVER = CASE WHEN SELL_BUY = 2 THEN    
     CASE WHEN SP_BROK_COMPUTEON = 'T'     
      THEN TRADEQTY*    
       (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
       CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
       WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
       ELSE TRADE_PRICE + STRIKE_PRICE END END)    
     WHEN SP_BROK_COMPUTEON = 'Q'    
      THEN TRADEQTY    
     ELSE TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
     END    
    ELSE 0 END,    
  SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,    
  SP_COMPUTATIONTYPE = SP_BROK_COMPUTETYPE,SP_SCHEME_ID,    
  SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
  SP_MULTIPLIER,AUCTIONPART,    
  INS_CHRG = (INS_CHRG),    
  TURN_TAX = (TURN_TAX),     
  OTHER_CHRG = (F.OTHER_CHRG),    
  SEBI_TAX = (SEBI_TAX),    
  BROKER_CHRG = (BROKER_CHRG)        
 FROM    
  BFOSETTLEMENT F,    
  SCHEME_MAPPING S,    
  CLIENT1 C1,    
  CLIENT2 C2    
 WHERE    
  SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO + ' 23:59:59'    
  AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
  AND SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
  AND F.PARTY_CODE = SP_PARTY_CODE    
  AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
  AND F.PRODUCT_CODE =  CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN F.PRODUCT_CODE ELSE SP_PRODUCT_CODE END    
  AND  1 = CASE    
   WHEN SP_PRODUCT_CODE = 'ALL' AND SERIES_ID NOT IN  
   (     
    SELECT SP_PRODUCT_CODE FROM SCHEME_MAPPING S    
    WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
    AND F.PARTY_CODE = SP_PARTY_CODE    
    AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
   )     
   THEN 1       
   ELSE CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN 0 ELSE 1  END END    
 AND SP_TRD_TYPE = CASE WHEN AUCTIONPART <> 'EA'    
    THEN 'TRD' ELSE 'DEL' END    
 AND AUCTIONPART <> 'CA'    
 AND TRADEQTY > 0     
 AND SP_BROK_COMPUTETYPE = 'I'    
 AND SP_VALUE_FROM = (SELECT MIN(SP_VALUE_FROM) FROM     
    SCHEME_MAPPING S    
    WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
    AND F.PARTY_CODE = SP_PARTY_CODE    
    AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE)    
 AND C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = F.PARTY_CODE    
 --AND C1.CL_TYPE <> 'INS' AND RESERVED1 = 0      
 AND TRADESTATUS <> 'E'    
 ) FOSETT    
     
 GROUP BY     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO,    
 (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE PRODUCT_TYPE END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
 AUCTIONPART,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID    
    
OPEN @SETTCUR    
    
    
 FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,    
 @PRODUCT_TYPE,@PRODUCT_CODE,@SERIES_CODE,@SERIES_ID,@EXPIRYDATE,    
 @AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,    
 @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,    
 @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,    
 @SP_COMPUTATIONTYPE,@SCHEMEID    
    
 WHILE @@FETCH_STATUS = 0     
 BEGIN       
  SELECT @BUYFLAG = 0     
  SELECT @SELLFLAG = 0     
    
  /*-----------------------------------------------------------------------------------------------------------*/    
  SET @SCHEMECUR = CURSOR FOR    
  SELECT    
   SP_COMPUTATION_LEVEL,    
   SP_MULTIPLIER,    
   SP_BUY_BROK_TYPE,    
   SP_SELL_BROK_TYPE,    
   SP_BUY_BROK,    
   SP_SELL_BROK,    
   SP_VALUE_FROM,    
   SP_VALUE_TO,    
   SP_SCHEME_TYPE    
  FROM    
   SCHEME_MAPPING    
  WHERE    
   @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
   AND SP_PARTY_CODE = @PARTY_CODE      
   AND SP_PRODUCT_TYPE = RIGHT(@PRODUCT_CODE,3)    
   AND SP_PRODUCT_CODE =  CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN SP_PRODUCT_CODE ELSE SP_PRODUCT_CODE END    
   AND  1 = CASE    
    WHEN SP_PRODUCT_CODE = 'ALL' AND @SERIES_ID NOT IN     
    (     
     SELECT SP_PRODUCT_CODE FROM SCHEME_MAPPING S    
     WHERE @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
     AND SP_PARTY_CODE = @PARTY_CODE      
     AND SP_PRODUCT_TYPE = RIGHT(@PRODUCT_CODE,3)      
    )     
    THEN 1       
    ELSE CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN 0 ELSE 1  END END      
   AND SP_TRD_TYPE = CASE WHEN @AUCTIONPART <> 'EA'    
     THEN 'TRD' ELSE 'DEL' END    
   AND SP_BROK_COMPUTETYPE = 'I'    
  ORDER BY SP_VALUE_FROM    
    
  OPEN @SCHEMECUR    
  FETCH NEXT FROM  
   @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,    
   @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE    
    
   SET @NEWBUYTURNOVER = @BUY_TURNOVER     
   SET @NEWSELLTURNOVER = @SELL_TURNOVER     
   SET @NEWBUYTURNOVERORG = 0     
   SET @NEWSELLTURNOVERORG = 0     
   SET @BUYBROKERAGE = 0    
   SET @SELLBROKERAGE = 0    
    
  WHILE @@FETCH_STATUS = 0 AND (@NEWBUYTURNOVER > 0 OR @NEWSELLTURNOVER > 0)         
BEGIN    
    
  /*--------------------------------------------------------------------*/    
  SET @BUYBROKERAGE = 0    
  SET @SELLBROKERAGE = 0    
  IF @NEWBUYTURNOVER > 0     
  BEGIN    
   IF @BUY_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1    
   BEGIN     
    SET @NEWBUYTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
    SET @NEWBUYTURNOVERORG = @NEWBUYTURNOVER * CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
   END    
   ELSE     
   BEGIN    
    SET @NEWBUYTURNOVER = @BUY_TURNOVER - @SP_VALUE_FROM    
    IF @NEWBUYTURNOVER < 0  SET @NEWBUYTURNOVER = 0     
    SET @NEWBUYTURNOVERORG  = @NEWBUYTURNOVER      
    SELECT @NEWBUYTURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(@NEWBUYTURNOVER,@SP_MULTIPLIER)    
    SELECT @NEWBUYTURNOVER = @NEWBUYTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
    SELECT @BUYFLAG = 1   
   END    
   IF @NEWBUYTURNOVER > 0     
   BEGIN     
    SELECT @BUYBROKERAGE =     
     CASE WHEN @SP_SCHEME_TYPE = 0 THEN    
     CASE WHEN @SP_BUY_BROK_TYPE ='P'    
     THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100    
     ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END    
     ELSE    
      CASE WHEN (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=1)    
       OR   (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=3)    
      THEN    
       CASE WHEN @SP_BUY_BROK_TYPE ='P'       
       THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100    
       ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END    
      ELSE    
       CASE WHEN @SP_SELL_BROK_TYPE ='P'    
       THEN @NEWBUYTURNOVER * @SP_SELL_BROK  /100    
       ELSE @NEWBUYTURNOVER * @SP_SELL_BROK END    
      END    
     END    
   END      
   ELSE       
    SELECT @BUYBROKERAGE = 0       
   END    
    
   IF @NEWSELLTURNOVER > 0     
   BEGIN    
    IF @SELL_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1    
    BEGIN     
     SET @NEWSELLTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
     SET @NEWSELLTURNOVERORG = @NEWSELLTURNOVER * CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
    END    
    ELSE     
    BEGIN    
     SET @NEWSELLTURNOVER = @SELL_TURNOVER - @SP_VALUE_FROM    
     IF @NEWSELLTURNOVER < 0 SET @NEWSELLTURNOVER = 0      
     SET @NEWSELLTURNOVERORG  = @NEWSELLTURNOVER       
     SELECT @NEWSELLTURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(@NEWSELLTURNOVER,@SP_MULTIPLIER)    
     SELECT @NEWSELLTURNOVER = @NEWSELLTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
     SELECT @SELLFLAG = 1    
  END    
    IF @NEWSELLTURNOVER > 0    
    BEGIN      
     SELECT @SELLBROKERAGE =     
      CASE WHEN @SP_SCHEME_TYPE = 0 THEN    
       CASE WHEN @SP_SELL_BROK_TYPE ='P'    
       THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100    
       ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END    
      ELSE    
       CASE WHEN (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=1)    
       OR   (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=3)    
       THEN    
        CASE WHEN @SP_SELL_BROK_TYPE ='P'    
        THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100    
        ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END    
       ELSE    
        CASE WHEN @SP_BUY_BROK_TYPE ='P'    
        THEN @NEWSELLTURNOVER * @SP_BUY_BROK  /100    
        ELSE @NEWSELLTURNOVER * @SP_BUY_BROK END    
       END    
      END    
    END    
   ELSE    
    SELECT @SELLBROKERAGE = 0       
   END    
    
    
  INSERT INTO #CHARGES_DETAIL_TEMP1     
  (    
   CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
   CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,    
   CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,    
   CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
   CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,    
   CD_TOT_BUYTURNOVER_ROUNDED,CD_TOT_SELLTURNOVER_ROUNDED,    
   CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
   CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
   CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,CD_TOT_SERTAX,    
   CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,    
   CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
   CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
  )    
  VALUES     
  (    
   @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,    
   @PRODUCT_TYPE,@PRODUCT_CODE,@SERIES_CODE,@SERIES_ID,@EXPIRYDATE,    
   @AUCTIONPART,@LOTSIZE,@SCHEMEID,    
   @SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,@SP_COMPUTATIONTYPE,@BUYRATE,@SELLRATE,    
   @BUYQTY,@SELLQTY,@NEWBUYTURNOVERORG,@NEWSELLTURNOVERORG,    
   (@NEWBUYTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),    
   (@NEWSELLTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),0,0,    
   (@BUYQTY+@SELLQTY)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END ,    
   0,0,0,@BUYBROKERAGE,@SELLBROKERAGE,0,0,    
   @TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,    
   @EXCH_BUYRATE,@EXCH_SELLRATE,    
   @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT    
  )     
      
  IF @SP_VALUE_TO = -1       
  BEGIN      
   SELECT @NEWBUYTURNOVER = 0       
   SELECT @NEWSELLTURNOVER = 0      
  END       
  /*--------------------------------------------------------------------*/    
  FETCH NEXT FROM     
  @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,    
  @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE    
 END    
 CLOSE @SCHEMECUR    
 DEALLOCATE @SCHEMECUR    
  /*-----------------------------------------------------------------------------------------------------------*/    
 FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,    
 @PRODUCT_TYPE,@PRODUCT_CODE,@SERIES_CODE,@SERIES_ID,@EXPIRYDATE,    
 @AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,    
 @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,    
 @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,    
@SP_COMPUTATIONTYPE,@SCHEMEID    
    
END    
CLOSE @SETTCUR    
DEALLOCATE @SETTCUR    
    
INSERT INTO #CHARGES_DETAIL_TEMP    
 (    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,    
 CD_EXPIRYDATE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,    
 CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
 CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,    
 CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
 CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
 CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,    
 CD_TOT_SERTAX,    
 CD_TOT_STT,CD_TOT_TURN_TAX,    
 CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,    
 CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
 )    
SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,    
 CD_EXPIRYDATE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_BUYRATE,CD_SELLRATE,CD_TOT_BUYQTY,CD_TOT_SELLQTY,    
 CD_TOT_BUYTURNOVER,    
 CD_TOT_SELLTURNOVER,    
 CD_TOT_BUYTURNOVER_ROUNDED,    
 CD_TOT_SELLTURNOVER_ROUNDED,    
 CD_TOT_TURNOVER=CD_TOT_BUYTURNOVER+CD_TOT_SELLTURNOVER,    
 CD_TOT_TURNOVER_ROUNDED=CD_TOT_BUYTURNOVER_ROUNDED+CD_TOT_SELLTURNOVER_ROUNDED,    
 CD_TOT_LOT,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT,    
 CD_TOT_BUYBROK=(CASE WHEN CD_TOT_BUYBROK > 0     
    THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
    THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)     
     ELSE CD_TOT_BUYBROK    
     END)    
    ELSE PRADNYA.dbo.FNMIN(CD_MAX_BROKAMT,    
     (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)     
     ELSE CD_TOT_BUYBROK    
     END))    
    END)    
   ELSE 0     
   END),    
 CD_TOT_SELLBROK=(CASE WHEN CD_TOT_SELLBROK > 0     
    THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
    THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)     
     ELSE CD_TOT_SELLBROK    
     END)    
    ELSE PRADNYA.dbo.FNMIN(CD_MAX_BROKAMT,    
     (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)     
     ELSE CD_TOT_SELLBROK    
     END))    
    END)    
   ELSE 0     
   END),    
 CD_TOT_BROK=(CASE WHEN CD_TOT_BROK > 0     
   THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
   THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)     
    ELSE CD_TOT_BROK    
    END)    
   ELSE PRADNYA.dbo.FNMIN(CD_MAX_BROKAMT,    
    (CASE WHEN CD_MIN_BROKAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)     
    ELSE CD_TOT_BROK    
    END))    
   END)    
  ELSE 0     
  END),         
 CD_TOT_SERTAX=0,    
 CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,    
 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,    
 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
FROM    
(    
 SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,    
 CD_AUCTIONPART,CD_MARKETLOT,    
 CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
 CD_TOT_BUYQTY= CD_TOT_BUYQTY,    
 CD_TOT_SELLQTY= CD_TOT_SELLQTY,    
 CD_TOT_BUYTURNOVER=SUM(CD_TOT_BUYTURNOVER),    
 CD_TOT_BUYTURNOVER_ROUNDED=SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
 CD_TOT_SELLTURNOVER=SUM(CD_TOT_SELLTURNOVER),    
 CD_TOT_SELLTURNOVER_ROUNDED=SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
 CD_TOT_LOT,    
 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
 CD_TOT_RES_LOT,    
 CD_TOT_BUYBROK=SUM(CD_TOT_BUYBROK),    
 CD_TOT_SELLBROK=SUM(CD_TOT_SELLBROK),    
 CD_TOT_BROK=SUM(CD_TOT_BUYBROK+CD_TOT_SELLBROK),    
 CD_TOT_SERTAX = 0 ,    
 CD_TOT_STT=(CD_TOT_STT),    
 CD_TOT_TURN_TAX=(CD_TOT_TURN_TAX),    
 CD_TOT_OTHER_CHRG=(CD_TOT_OTHER_CHRG),    
 CD_TOT_SEBI_TAX=(CD_TOT_SEBI_TAX),    
 CD_TOT_STAMPDUTY=(CD_TOT_STAMPDUTY),    
 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
 CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
 FROM     
 #CHARGES_DETAIL_TEMP1    
 GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,    
 CD_EXPIRYDATE,CD_AUCTIONPART,CD_MARKETLOT,    
 CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
 CD_TOT_LOT,CD_TOT_RES_LOT,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
 CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT, CD_TOT_BUYQTY, CD_TOT_SELLQTY,    
 CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY    
)FOSETTCHRG    
    
UPDATE     
 #CHARGES_DETAIL_TEMP    
SET    
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)    
    
UPDATE     
 #CHARGES_DETAIL_TEMP    
SET    
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK     
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)    
    
/*---------------------------------------------------------------------------------------------------------------    
    TAKING DATA FOR SCRIP LEVEL + CONTRACT LEVEL ROUNDING    
----------------------------------------------------------------------------------------------------------------*/    
    
 /*SCRIP LEVEL ROUNDING*/    
 INSERT INTO #CHARGES_DETAIL_FINAL    
 SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
 CD_TRADE_NO='',    
 CD_ORDER_NO='',    
 CD_PRODUCT_TYPE, CD_PRODUCT_CODE,CD_ASSET_CODE,
 CD_EXPIRYDATE,CD_STRIKE_PRICE,CD_OPTION_TYPE,
 CD_SERIES_CODE,CD_SERIES_ID,CD_LOT_SIZE,
 CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,    
 CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,    
 CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),    
 CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),    
 CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),    
 CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),    
 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
 CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),    
 CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),     CD_TOT_LOT=SUM(CD_TOT_LOT),    
 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
 CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),    
 CD_TOT_BUYBROK = SUM(CD_TOT_BUYBROK),    
 CD_TOT_SELLBROK =SUM(CD_TOT_SELLBROK),    
 CD_TOT_BROK = (CASE WHEN SUM(CD_TOT_BROK) > 0     
    THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1     
     THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
     ELSE SUM(CD_TOT_BROK)    
     END)    
    ELSE PRADNYA.dbo.FNMIN(CD_MAX_SCRIPAMT,    
     (CASE WHEN CD_MIN_SCRIPAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
     ELSE SUM(CD_TOT_BROK)    
     END))    
    END)    
   ELSE 0     
   END),    
 CD_TOT_SERTAX=0,    
 CD_TOT_STT=SUM(CD_TOT_STT),    
 CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),    
 CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),    
 CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),    
 CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),    
 CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,    
 CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END ,    
 0,0,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
 FROM     
  #CHARGES_DETAIL_TEMP    
 WHERE    
  CD_COMPUTATIONLEVEL NOT IN ('C','S')    
 GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT,CD_ASSET_CODE,CD_STRIKE_PRICE,CD_OPTION_TYPE,CD_LOT_SIZE  
 HAVING      
 SUM(CD_TOT_BROK) <> (CASE WHEN SUM(CD_TOT_BROK) > 0     
    THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1     
     THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
      ELSE SUM(CD_TOT_BROK)    
      END)    
     ELSE PRADNYA.dbo.FNMIN(CD_MAX_SCRIPAMT,    
      (CASE WHEN CD_MIN_SCRIPAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
      ELSE SUM(CD_TOT_BROK)    
    END))    
     END)    
    ELSE 0     
    END)    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK     
    
    
DELETE     
 #CHARGES_DETAIL_TEMP     
FROM     
 #CHARGES_DETAIL_FINAL    
WHERE    
 CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_SAUDA_DATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_SAUDA_DATE,103)    
 AND #CHARGES_DETAIL_TEMP.CD_PARTY_CODE = #CHARGES_DETAIL_FINAL.CD_PARTY_CODE    
 AND #CHARGES_DETAIL_TEMP.CD_CONTRACT_NO = #CHARGES_DETAIL_FINAL.CD_CONTRACT_NO    
 AND #CHARGES_DETAIL_TEMP.CD_PRODUCT_TYPE = #CHARGES_DETAIL_FINAL.CD_PRODUCT_TYPE    
 AND #CHARGES_DETAIL_TEMP.CD_PRODUCT_CODE = #CHARGES_DETAIL_FINAL.CD_PRODUCT_CODE    
 AND #CHARGES_DETAIL_TEMP.CD_SERIES_CODE = #CHARGES_DETAIL_FINAL.CD_SERIES_CODE    
 AND #CHARGES_DETAIL_TEMP.CD_SERIES_ID = #CHARGES_DETAIL_FINAL.CD_SERIES_ID    
 AND CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_EXPIRYDATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_EXPIRYDATE,103)    
 AND  #CHARGES_DETAIL_TEMP.CD_AUCTIONPART = #CHARGES_DETAIL_FINAL.CD_AUCTIONPART    
    
    
 INSERT INTO #CHARGES_DETAIL_TEMP SELECT * FROM #CHARGES_DETAIL_FINAL    
    
    
  
IF (SELECT COUNT(1) FROM CONTRACT_ROUNDING    
 WHERE @SAUDA_DATE_FROM BETWEEN CR_DATE_FROM AND CR_DATE_TO 
AND CR_PARTY_CODE  BETWEEN @PARTY_FROM AND @PARTY_TO) > 0
BEGIN

 /*CONTRACT LEVEL ROUNDING*/    
 TRUNCATE TABLE #CHARGES_DETAIL_FINAL    
    
 INSERT INTO #CHARGES_DETAIL_TEMP    
 SELECT    
 CD_PARTY_CODE=F.PARTY_CODE,    
 CD_SAUDA_DATE=LEFT(SAUDA_DATE,11),    
 CD_CONTRACT_NO=CONTRACTNO,    
 CD_TRADE_NO=TRADE_NO,    
 CD_ORDER_NO=ORDER_NO,    
 CD_PRODUCT_TYPE=PRODUCT_TYPE, 
 CD_PRODUCT_CODE=PRODUCT_CODE,
 CD_ASSET_CODE=ASSET_CODE,
 CD_EXPIRYDATE=EXPIRYDATE,
 CD_STRIKE_PRICE=STRIKE_PRICE,
 CD_OPTION_TYPE=OPTION_TYPE,
 CD_SERIES_CODE=SERIES_CODE,
 CD_SERIES_ID=SERIES_ID,
 CD_LOT_SIZE=LOT_SIZE,    
 CD_AUCTIONPART=AUCTIONPART,    
 CD_MARKETLOT=CONVERT(BIGINT,LOT_SIZE),    
 CD_SCHEME_ID=0,    
 CD_COMPUTATIONLEVEL='',    
 CD_COMPUTATIONON='',    
 CD_COMPUTATIONTYPE='',    
 CD_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0    
   END),    
 CD_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),  
 CD_TOT_BUYQTY = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END),    
 CD_TOT_SELLQTY = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END),    
 CD_TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_TURNOVER=SUM(TRADEQTY*TRADE_PRICE),    
 CD_TOT_TURNOVER_ROUNDED=SUM(TRADEQTY*TRADE_PRICE),    
 CD_TOT_LOT=0,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT=0,    
 CD_TOT_BUYBROK =  SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY * BROKAPPLIED ELSE 0 END ),    
 CD_TOT_SELLBROK = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY * BROKAPPLIED ELSE 0 END ),    
 CD_TOT_BROK = SUM(TRADEQTY*BROKAPPLIED),    
 CD_TOT_SERTAX=SUM(SERVICE_TAX),    
 CD_TOT_STT=SUM(INS_CHRG),    
 CD_TOT_TURN_TAX=SUM(TURN_TAX),    
 CD_TOT_OTHER_CHRG=SUM(F.OTHER_CHRG),   
 CD_TOT_SEBI_TAX=SUM(SEBI_TAX),    
 CD_TOT_STAMPDUTY=SUM(BROKER_CHRG),     
 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),    
 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),    
 0,0,0,0    
 FROM    
 BFOSETTLEMENT F    
 WHERE     
 SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO + ' 23:59:59'    
 AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
 AND F.PARTY_CODE IN (SELECT CR_PARTY_CODE FROM CONTRACT_ROUNDING    
 WHERE SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)    
 AND F.PARTY_CODE NOT IN    
 (    
 SELECT F.PARTY_CODE FROM #CHARGES_DETAIL_TEMP    
 WHERE        
  CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)     
  AND CD_PARTY_CODE = F.PARTY_CODE    
  AND CD_PRODUCT_TYPE = PRODUCT_TYPE    
  AND CD_PRODUCT_CODE = PRODUCT_CODE    
  AND CD_SERIES_CODE = SERIES_CODE    
  AND CD_SERIES_ID = SERIES_ID    
  AND CONVERT(VARCHAR,CD_EXPIRYDATE,103) = CONVERT(VARCHAR,EXPIRYDATE,103)    
  AND CD_AUCTIONPART = AUCTIONPART    
 )     
 GROUP BY    
 LEFT(SAUDA_DATE,11),         
 F.PARTY_CODE,    
 PRODUCT_TYPE, 
 ASSET_CODE,   
 PRODUCT_CODE,    
 SERIES_CODE,    
 SERIES_ID,    
 EXPIRYDATE,  
 OPTION_TYPE,
 STRIKE_PRICE, 
 AUCTIONPART,    
 CONTRACTNO,    
 ORDER_NO,    
 TRADE_NO,    
 LOT_SIZE
    
 INSERT INTO #CHARGES_DETAIL_FINAL     
 SELECT    
 CD_PARTY_CODE,CD_SAUDA_DATE,    
 CD_CONTRACT_NO=0,    
 CD_TRADE_NO='',CD_ORDER_NO='', 
 CD_PRODUCT_TYPE='', 
 CD_PRODUCT_CODE='FUTOPT',
 CD_ASSET_CODE='',
 CD_EXPIRYDATE='DEC 31 2049 23:59',
 CD_STRIKE_PRICE=0,
 CD_OPTION_TYPE='',
 CD_SERIES_CODE='BROKERAGE',
 CD_SERIES_ID=0,
 CD_LOT_SIZE=1,  
 CD_AUCTIONPART='0',CD_MARKETLOT=0,    
 CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',    
 CD_BUYRATE = 0,    
 CD_SELLRATE = 0,    
 CD_TOT_BUYQTY = 0,    
 CD_TOT_SELLQTY = 0,    
 CD_TOT_BUYTURNOVER = 0,    
 CD_TOT_SELLTURNOVER = 0,    
 CD_TOT_BUYTURNOVER_ROUNDED = 0,    
 CD_TOT_SELLTURNOVER_ROUNDED = 0,    
 CD_TOT_TURNOVER=0,    
 CD_TOT_TURNOVER_ROUNDED=0,    
 CD_TOT_LOT=0,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT=0,    
 CD_TOT_BUYBROK = 0,    
 CD_TOT_SELLBROK =0,    
 CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1     
   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
  ELSE SUM(CD_TOT_BROK)    
    END)    
   ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
    (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
    ELSE SUM(CD_TOT_BROK)    
    END))    
   END,    
 CD_TOT_SERTAX=0,    
 CD_TOT_STT=0,    
 CD_TOT_TURN_TAX=0,    
 CD_TOT_OTHER_CHRG=0,    
 CD_TOT_SEBI_TAX=0,    
 CD_TOT_STAMPDUTY=0,    
 CD_EXCH_BUYRATE=0 ,    
 CD_EXCH_SELLRATE =0,    
 0,0,0,0    
FROM    
 #CHARGES_DETAIL_TEMP  LEFT OUTER JOIN CONTRACT_ROUNDING     
 ON (CR_PARTY_CODE = CD_PARTY_CODE     
  AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)      
GROUP BY    
 CD_PARTY_CODE,CR_MIN_CONTRACTAMT,    
 CR_MAX_CONTRACTAMT,CD_SAUDA_DATE    
HAVING     
 SUM(CD_TOT_BROK) > CASE WHEN CR_MAX_CONTRACTAMT = - 1     
  THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END)    
  ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
   (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END))    
  END     
    
UPDATE     
 #CHARGES_DETAIL_TEMP SET CD_TOT_BUYBROK = 0, CD_TOT_SELLBROK =0, CD_TOT_BROK = 0     
FROM     
 #CHARGES_DETAIL_FINAL    
WHERE    
 CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_SAUDA_DATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_SAUDA_DATE,103)    
 AND #CHARGES_DETAIL_TEMP.CD_PARTY_CODE = #CHARGES_DETAIL_FINAL.CD_PARTY_CODE      
    
INSERT INTO #CHARGES_DETAIL_FINAL     
SELECT    
 CD_PARTY_CODE,CD_SAUDA_DATE,    
 CD_CONTRACT_NO=0,    
 CD_TRADE_NO='',CD_ORDER_NO='',    
 CD_PRODUCT_TYPE='', 
 CD_PRODUCT_CODE='FUTOPT',
 CD_ASSET_CODE='',
 CD_EXPIRYDATE='DEC 31 2049 23:59',
 CD_STRIKE_PRICE=0,
 CD_OPTION_TYPE='',
 CD_SERIES_CODE='BROKERAGE',
 CD_SERIES_ID=0,
 CD_LOT_SIZE=1,     
 CD_AUCTIONPART='0',CD_MARKETLOT=0,    
 CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='C',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',    
 CD_BUYRATE = 0,    
 CD_SELLRATE = 0,    
 CD_TOT_BUYQTY = 0,    
 CD_TOT_SELLQTY = 0,    
 CD_TOT_BUYTURNOVER = 0,    
 CD_TOT_SELLTURNOVER = 0,    
 CD_TOT_BUYTURNOVER_ROUNDED = 0,    
 CD_TOT_SELLTURNOVER_ROUNDED = 0,    
 CD_TOT_TURNOVER=0,    
 CD_TOT_TURNOVER_ROUNDED=0,    
 CD_TOT_LOT=0,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT=0,    
 CD_TOT_BUYBROK =  0,    
 CD_TOT_SELLBROK = 0,    
 CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1     
   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
    ELSE SUM(CD_TOT_BROK)    
    END)    
   ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
    (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
    ELSE SUM(CD_TOT_BROK)    
    END))    
   END,    
 CD_TOT_SERTAX=0,    
 CD_TOT_STT=0,    
 CD_TOT_TURN_TAX=0,    
 CD_TOT_OTHER_CHRG=0,    
 CD_TOT_SEBI_TAX=0,    
 CD_TOT_STAMPDUTY=0,    
 CD_EXCH_BUYRATE=0 ,    
 CD_EXCH_SELLRATE =0,    
 0,0,0,0    
 FROM    
 #CHARGES_DETAIL_TEMP  LEFT OUTER JOIN CONTRACT_ROUNDING     
 ON (CR_PARTY_CODE = CD_PARTY_CODE     
  AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)    
  AND CD_PARTY_CODE NOT IN (SELECT CD_PARTY_CODE FROM #CHARGES_DETAIL_FINAL )    
GROUP BY       
 CD_PARTY_CODE,CR_MIN_CONTRACTAMT,    
 CR_MAX_CONTRACTAMT,CD_SAUDA_DATE    
HAVING     
 SUM(CD_TOT_BROK) < CASE WHEN CR_MAX_CONTRACTAMT = - 1     
  THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END)    
  ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
   (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END))    
  END    
    
UPDATE    
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_BROK = CD_TOT_BROK - (CD_TOT_SELLBROK + CD_TOT_BUYBROK)    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK    
    
 DELETE FROM #CHARGES_DETAIL_TEMP    
 WHERE CD_PARTY_CODE IN (SELECT CD_PARTY_CODE FROM #CHARGES_DETAIL_FINAL)    
    
 INSERT INTO #CHARGES_DETAIL_TEMP SELECT * FROM #CHARGES_DETAIL_FINAL    
END    
 /*FINAL OUTPUT*/    
DELETE FROM CHARGES_DETAIL     
WHERE    
 CD_SAUDA_DATE >= @SAUDA_DATE_FROM      
 AND CD_SAUDA_DATE <= @SAUDA_DATE_TO + ' 23:59:59'    
 AND CD_PARTY_CODE >= @PARTY_FROM    
 AND CD_PARTY_CODE <= @PARTY_TO    

   
INSERT INTO CHARGES_DETAIL     
SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,
 CD_PRODUCT_TYPE, 
 CD_PRODUCT_CODE=(CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_PRODUCT_CODE ELSE '' END),
 CD_ASSET_CODE,
CD_EXPIRYDATE,
 CD_STRIKE_PRICE,
 CD_OPTION_TYPE,
 CD_SERIES_CODE,
 CD_SERIES_ID,
 CD_LOT_SIZE,   
 CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,    
 CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,    
 CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),    
 CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),    
 CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),    
 CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),    
 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
 CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),    
 CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),    
 CD_TOT_LOT=SUM(CD_TOT_LOT),    
 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
 CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),    
 CD_TOT_BUYBROK =  ROUND(SUM(CD_TOT_BUYBROK),2),
 CD_TOT_SELLBROK = ROUND(SUM(CD_TOT_SELLBROK),2),
 CD_TOT_BROK = ROUND(SUM(CD_TOT_BROK),2),
 CD_TOT_BUYSERTAX= ROUND(SUM(CD_TOT_BUYBROK * SERVICE_TAX/100 ),2),
 CD_TOT_SELLSERTAX= ROUND(SUM(CD_TOT_SELLBROK * SERVICE_TAX/100 ),2),   
 CD_TOT_SERTAX= ROUND(SUM(CD_TOT_BROK * SERVICE_TAX/100 ),2),
 CD_TOT_STT=SUM(CD_TOT_STT),    
 CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),    
 CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),    
 CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),    
 CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),    
 CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,    
 CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END ,    
 GETDATE()    
FROM     
 #CHARGES_DETAIL_TEMP , BFOGLOBALS    
WHERE     
 CD_SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,    
 (CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_PRODUCT_CODE ELSE '' END),        
 CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT,CD_ASSET_CODE,CD_STRIKE_PRICE,CD_OPTION_TYPE,CD_LOT_SIZE    
    
    
/*---------------------------------------------------------------------------------------------------------------    
   CLEANING TEMPORARY TABLES    
----------------------------------------------------------------------------------------------------------------*/    
    
DROP TABLE #CHARGES_DETAIL_TEMP    
DROP TABLE #CHARGES_DETAIL_TEMP1    
DROP TABLE #CHARGES_DETAIL_FINAL    
   
    
/*---------------------------------------------------------------------------------------------------------------    
   KEEPING DUMMY CONTRACT DESCRIPTOR AT THE MASTER    
----------------------------------------------------------------------------------------------------------------*/    
IF (SELECT COUNT(1) FROM BFOSCRIP2 WHERE PRODUCT_CODE ='FUTOPT' AND SERIES_CODE ='BROKERAGE'    
 AND EXPIRYDATE =  'DEC 31 2049 23:59') =0     
BEGIN    
	INSERT INTO BFOSCRIP2   
	SELECT SERIES_ID=0,PRODUCT_TYPE='CF',PRODUCT_CODE='FUTOPT',ASSET_CODE='',EXPIRYDATE='DEC 31 2049 23:59',STRIKE_PRICE=0,OPTION_TYPE='',
	SERIES_CODE='BROKERAGE',UNDERLYING_ASSET='',CA_LEVEL=0,BASE_PRICE=0,
	STARTDATE='DEC 31 2049 23:59',MATURITYDATE='DEC 31 2049 23:59',EXERCISE_STARTDATE='DEC 31 2049 23:59',
	EXERCISE_ENDDATE='DEC 31 2049 23:59',MINIMUM_LOT_SIZE=1,LOT_SIZE_MULTIPLE=1,
	PRICE_TICK=0,MARGIN_INDICATOR=0,INITAIL_MARGIN_PERC=0,STATUS_FLAG=0,ISIN='',TRADE_DATE='DEC 31 2049 23:59',
	UPDATED_BY='VBB_PROC',UPDATED_ON=GETDATE()
END    
    
/*--------------------------------------------------------------------------------------------------------------    
   UPDATING BFOSETTLEMENT BROK APPLED & SERVICE CHRG TO ZERO FOR THE GIVEN CRITERIA    
----------------------------------------------------------------------------------------------------------------*/    
    
UPDATE     
 BFOSETTLEMENT    
SET    
 BROKAPPLIED = 0,    
 SERVICE_TAX = 0    
FROM    
 CHARGES_DETAIL     
WHERE    
 CONVERT(VARCHAR,CD_SAUDA_DATE,11) = CONVERT(VARCHAR,SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE    
 AND CD_PRODUCT_CODE = PRODUCT_CODE    
 AND CD_SERIES_CODE = SERIES_CODE    
 AND CD_SERIES_ID = SERIES_ID    
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,103) = CONVERT(VARCHAR,EXPIRYDATE,103)    
 AND CD_AUCTIONPART = AUCTIONPART    
 AND TRADESTATUS <> 'E'    
 AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'    
 AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
    
    
UPDATE     
 BFOSETTLEMENT    
SET    
 BROKAPPLIED = 0,    
 SERVICE_TAX = 0,    
 NETRATE = TRADE_PRICE    
FROM    
 CHARGES_DETAIL     
WHERE    
 CONVERT(VARCHAR,CD_SAUDA_DATE,11) = CONVERT(VARCHAR,SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND TRADESTATUS <> 'E'    
 AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'    
 AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
 AND CD_COMPUTATIONLEVEL ='C'    
 AND BROKAPPLIED <> 0    
  
  
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE_FROM,'VBB','',@USERNAME,''


/*---------------------------------------------------------------------------------------------------------------    
     END OF PROCEDURE    
----------------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CHARGES_DETAIL_BKUP_10Aug2023
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[PR_CHARGES_DETAIL_BKUP_10Aug2023]         
(        
 @SAUDA_DATE_FROM VARCHAR(11),        
 @SAUDA_DATE_TO VARCHAR(11) = @SAUDA_DATE_FROM ,        
 @PARTY_FROM VARCHAR(10) ='',        
 @PARTY_TO VARCHAR(10) ='ZZZZZZZZZZZ' ,
 @USERNAME VARCHAR(20) =''       
) AS         

  
    
/*    
 PROCEDURE NAME  : CALCULATE_VOLUMNBROK    
 DESCRIPTION : COMPUTE VOLUMN (VALUE/QUANTITY/LOT SIZE)    
 TABLES USING  :     
 1. SCHEME_MASTER - SCHEME DEFINITION MASTER TABLE     
 2. SCHEME_MAPPING - SCHEME MAPPING TO END CLIENT     
 3. CONTRACT_ROUNDING - CLIENT'S CONTRACT LEVEL ROUNDINGS    
 4. CHARGES_DETAIL - KEEPING COMPUTED BROKERAGE    
*/    
    
/*---------------------------------------------------------------------------------------------------------------    
    CREATING TEMP TABLE FOR PROCESS    
----------------------------------------------------------------------------------------------------------------*/    
    
CREATE TABLE [DBO].[#CHARGES_DETAIL_TEMP]    
(    
	[CD_PARTY_CODE] [VARCHAR](10) NULL,
	[CD_SAUDA_DATE] [DATETIME] NOT NULL,
	[CD_CONTRACT_NO] [VARCHAR](14) NULL,
	[CD_TRADE_NO] [VARCHAR](15) NULL,
	[CD_ORDER_NO] [VARCHAR](20) NULL,
	[CD_PRODUCT_TYPE] [VARCHAR](3) NULL,
	[CD_PRODUCT_CODE] [VARCHAR](7) NULL,
	[CD_ASSET_CODE] [VARCHAR](8) NULL,
	[CD_EXPIRYDATE] [DATETIME] NULL,
	[CD_STRIKE_PRICE] [NUMERIC](12, 4) NULL,
	[CD_OPTION_TYPE] [VARCHAR](2) NULL,
	[CD_SERIES_CODE] [VARCHAR](22) NULL,
	[CD_SERIES_ID] [NUMERIC](9, 0) NULL,
	[CD_LOT_SIZE] [NUMERIC](9, 0) NULL,
	[CD_AUCTIONPART] [VARCHAR](2) NULL,
	[CD_MARKETLOT] [INT] NOT NULL,
	[CD_SCHEME_ID] [INT] NOT NULL,
	[CD_COMPUTATIONLEVEL] [CHAR](1) NULL,
	[CD_COMPUTATIONON] [CHAR](1) NULL,
	[CD_COMPUTATIONTYPE] [CHAR](1) NULL,
	[CD_BUYRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_SELLRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_BUYQTY] [INT] NOT NULL,
	[CD_TOT_SELLQTY] [INT] NOT NULL,
	[CD_TOT_BUYTURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SELLTURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_BUYTURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SELLTURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_TURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_TURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_LOT] [INT] NOT NULL,
	[CD_TOT_RES_TURNOVER] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_RES_TURNOVER_ROUNDED] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_RES_LOT] [INT] NOT NULL,
	[CD_TOT_BUYBROK] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SELLBROK] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_BROK] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SERTAX] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_STT] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_TURN_TAX] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_OTHER_CHRG] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_SEBI_TAX] [NUMERIC](36, 12) NOT NULL,
	[CD_TOT_STAMPDUTY] [NUMERIC](36, 12) NOT NULL,
	[CD_EXCH_BUYRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_EXCH_SELLRATE] [NUMERIC](36, 12) NOT NULL,
	[CD_MIN_BROKAMT] [NUMERIC](36, 12) NOT NULL,
	[CD_MAX_BROKAMT] [NUMERIC](36, 12) NOT NULL,
	[CD_MIN_SCRIPAMT] [NUMERIC](36, 12) NOT NULL,
	[CD_MAX_SCRIPAMT] [NUMERIC](36, 12) NOT NULL	
)    
    
SELECT * INTO #CHARGES_DETAIL_TEMP1 FROM #CHARGES_DETAIL_TEMP WHERE 1 = 2    
    
SELECT * INTO #CHARGES_DETAIL_FINAL FROM #CHARGES_DETAIL_TEMP WHERE 1 = 2    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_TEMP]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_PRODUCT_CODE], [CD_SERIES_CODE]    
)    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_TEMP1]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_PRODUCT_CODE], [CD_SERIES_CODE]    
)    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_FINAL]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_PRODUCT_CODE], [CD_SERIES_CODE]    
)    
    
/*---------------------------------------------------------------------------------------------------------------    
    FETCHING DATA FOR FLAT VALUE BASED BROKERAGE    
----------------------------------------------------------------------------------------------------------------*/    
  
IF @PARTY_TO='' BEGIN SET @PARTY_TO ='ZZZZZ' END    

SELECT     
 TRADE_NO=PRADNYA.dbo.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,    
 PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
 SERIES_CODE,SERIES_ID,LOT_SIZE,   
 TRADEQTY,LOTSIZE = CONVERT(BIGINT,LOT_SIZE),SAUDA_DATE=LEFT(SAUDA_DATE,11),TRADE_PRICE,       
 SP_PARTY_CODE,SP_COMPUTATION_LEVEL,SP_SCHEME_ID,SP_TRD_TYPE,    
 SP_SCHEME_TYPE,SP_MULTIPLIER,SP_BUY_BROK,SP_SELL_BROK,SP_RES_MULTIPLIER,    
 SP_RES_BUY_BROK,SP_RES_SELL_BROK,SP_VALUE_FROM,SP_VALUE_TO,SP_BROK_COMPUTEON,    
 SP_BROK_COMPUTETYPE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
 SP_BUY_BROK_TYPE,SP_SELL_BROK_TYPE,AUCTIONPART,    
 INS_CHRG = (INS_CHRG),    
 TURN_TAX = (TURN_TAX),     
 OTHER_CHRG = (F.OTHER_CHRG),    
 SEBI_TAX = (SEBI_TAX),    
 BROKER_CHRG = (BROKER_CHRG),    
 BUY_TURNOVER =     
  CASE WHEN SELL_BUY = 1 THEN     
    CASE WHEN SP_BROK_COMPUTEON = 'T'     
    THEN TRADEQTY * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
      CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
      WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
      ELSE TRADE_PRICE + STRIKE_PRICE END END)    
    WHEN SP_BROK_COMPUTEON = 'Q'    
     THEN TRADEQTY    
    WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
    ELSE TRADE_PRICE*TRADEQTY*CONVERT(BIGINT,LOT_SIZE)    
    END    
  ELSE 0 END,    
 SELL_TURNOVER =    
  CASE WHEN SELL_BUY = 2 THEN    
   CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN TRADEQTY * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
      CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
      WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
      ELSE TRADE_PRICE + STRIKE_PRICE END END)    
   WHEN SP_BROK_COMPUTEON = 'Q'    
    THEN TRADEQTY    
   WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
    ELSE TRADE_PRICE*TRADEQTY*CONVERT(BIGINT,LOT_SIZE)    
   END    
  ELSE 0 END,    
 TOTAL_TURNOVER =    
  CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN TRADEQTY * (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
      CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
      WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
      ELSE TRADE_PRICE + STRIKE_PRICE END END)    
   WHEN SP_BROK_COMPUTEON = 'Q'    
    THEN TRADEQTY    
   WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
    ELSE TRADE_PRICE*TRADEQTY*CONVERT(BIGINT,LOT_SIZE)    
  END   
   INTO #BFOSETTLEMENT1
 FROM    
  BFOSETTLEMENT F (NOLOCK),    
  SCHEME_MAPPING S (NOLOCK),    
  CLIENT1 C1 (NOLOCK),    
  CLIENT2 C2 (NOLOCK)   
 WHERE    
  SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59'    
  AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
  AND SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
  AND F.PARTY_CODE = SP_PARTY_CODE    
  AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
  AND F.PRODUCT_CODE =  CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN F.PRODUCT_CODE  ELSE SP_PRODUCT_CODE END    
  AND  1 = CASE    
    WHEN SP_PRODUCT_CODE = 'ALL' AND PRODUCT_CODE NOT IN     
    (     
    SELECT SP_PRODUCT_CODE FROM SCHEME_MAPPING S    
    WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
    AND F.PARTY_CODE = SP_PARTY_CODE    
    AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
    )     
   THEN 1       
   ELSE CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN 0 ELSE 1  END END    
  AND SP_TRD_TYPE = CASE WHEN AUCTIONPART <> 'EA'    
    THEN 'TRD' ELSE 'DEL' END    
 AND AUCTIONPART <> 'CA'    
 AND TRADEQTY > 0     
 AND SP_BROK_COMPUTETYPE = 'V'    
 AND C1.CL_CODE = C2.CL_CODE     
 AND C2.PARTY_CODE = F.PARTY_CODE    
 --AND C1.CL_TYPE <> 'INS' AND RESERVED1 = 0      
 AND TRADESTATUS <> 'E'   
 
 
 
    
 SELECT     
	T_SAUDADATE = LEFT(SAUDA_DATE,11),    
	T_PARTY_CODE = PARTY_CODE,    
	T_PRODUCT_TYPE = PRODUCT_TYPE,
	T_PRODUCT_CODE = PRODUCT_CODE,
	T_EXPIRYDATE = EXPIRYDATE,
	T_STRIKE_PRICE = STRIKE_PRICE,
	T_OPTION_TYPE = OPTION_TYPE,
	T_SERIES_CODE = SERIES_CODE,
	T_SERIES_ID = SERIES_ID,
    TOT_BUYQTY = SUM(CASE WHEN SELL_BUY = 1     
				   THEN    
					(TRADEQTY )    
				   ELSE    
					0    
				   END),    
    TOT_SELLQTY = SUM(CASE WHEN SELL_BUY = 2    
				   THEN    
					(TRADEQTY )    
				   ELSE    
					0    
				   END),
	TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY = 1     
						THEN    
						(TRADEQTY * TRADE_PRICE )    
						ELSE    
						0    
						END),    
	TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY = 2    
						THEN    
						(TRADEQTY * TRADE_PRICE)    
						ELSE    
						0    
						END) ,
	T_AUCTIONPART = AUCTIONPART
					   
INTO #TRD_BFOSETTLEMENT  

FROM    
	BFOSETTLEMENT  (NOLOCK)  
WHERE    
	SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59'     
	AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO  
GROUP BY    
	LEFT(SAUDA_DATE,11),PARTY_CODE,	PRODUCT_TYPE,
	PRODUCT_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,AUCTIONPART



    
    
   
SELECT     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO ,    
 TRADE_NO = (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 ORDER_NO = (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 PRODUCT_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
 PRODUCT_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE '' END),  
 ASSET_CODE =   (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN ASSET_CODE ELSE '' END),  
 EXPIRYDATE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),  
 STRIKE_PRICE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),  
 OPTION_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),
 SERIES_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
 SERIES_ID = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END), 
 LOT_SIZE,   
 AUCTIONPART ,    
 MARKETLOT = SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY),    
 SP_COMPUTATION_LEVEL,    
 SP_BROK_COMPUTEON,    
 SP_BROK_COMPUTETYPE,    
 SP_SCHEME_TYPE,    
 SP_SCHEME_ID,    
 BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
     THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
      SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
     ELSE 0     
     END),    
 SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
     THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
     ELSE 0     
     END),    
 BUY_QTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),    
 SELL_QTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),    
 TOTALQTY = SUM(TRADEQTY),    
 TOTALTURNOVER = SUM(TOTAL_TURNOVER),    
 BUY_TURNOVER = SUM(BUY_TURNOVER),    
 RND_BUY_TURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(SUM(BUY_TURNOVER),SP_MULTIPLIER) ,    
 SELL_TURNOVER = SUM(SELL_TURNOVER),    
 RND_SELL_TURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(SUM(SELL_TURNOVER),SP_MULTIPLIER) ,    
 RND_TURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TOTAL_TURNOVER),SP_MULTIPLIER) ,     
 TOTALLOT = (CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN CONVERT(BIGINT,PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TOTAL_TURNOVER), SP_MULTIPLIER) / CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END)    
   WHEN SP_BROK_COMPUTEON = 'Q'      
   THEN CONVERT(BIGINT,PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TRADEQTY), SP_MULTIPLIER) / CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END)    
   WHEN SP_BROK_COMPUTEON = 'L'    
   THEN CONVERT(BIGINT,PRADNYA.dbo.ROUNDEDTURNOVER(SUM(TRADEQTY),     
    (CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END*SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY))) /     
    (CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END*SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY)))    
   ELSE    
    SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY)    
   END),    
 TOTALTURNOVER_RES = 0,    
 RND_TURNOVER_RES = 0,    
 TOTALLOT_RES = 0,    
BUYBROKERAGE = CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END) > 0 THEN	
	(((((CASE 
		WHEN SP_SCHEME_TYPE = 0 
			THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
				THEN (CASE 
					WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
					THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
					ELSE 0 
					END) 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
				THEN 1 
				ELSE SUM(BUY_TURNOVER) 
				END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE	WHEN SP_BUY_BROK_TYPE = 'P' 
										THEN SP_BUY_BROK / 100 
										ELSE SP_BUY_BROK 
										END)
			) 
				WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
			) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
			) AND SP_SCHEME_TYPE = 1) 
				 OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
			) < SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
			) AND SP_SCHEME_TYPE = 3)
			THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
				THEN (CASE 
					WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
					THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
					ELSE 0	END) 
				WHEN SP_BROK_COMPUTEON = 'V'AND SP_BUY_BROK_TYPE = 'V' 
				THEN 1 
			ELSE SUM(BUY_TURNOVER) 
			END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE WHEN SP_BUY_BROK_TYPE = 'P' THEN SP_BUY_BROK / 100 ELSE SP_BUY_BROK END)) 
                         
		ELSE (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
			THEN (CASE 
				WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
				THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
				ELSE 0 
				END) 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
			THEN 1 
			ELSE SUM(BUY_TURNOVER) 
			END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
									WHEN SP_SELL_BROK_TYPE = 'P' 
									THEN SP_SELL_BROK / 100 
									ELSE SP_SELL_BROK 
									END)
			) 
           				END) ) ) )) ELSE 0 END, 

SELLBROKERAGE = CASE WHEN SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END) > 0 THEN
	(((((CASE 
		WHEN SP_SCHEME_TYPE = 0 
		THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
			THEN (CASE 
				WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
				THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
				ELSE 0 
				END) 
			WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
			THEN 1 
			ELSE SUM(SELL_TURNOVER) 
			END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
									WHEN SP_SELL_BROK_TYPE = 'P' 
									THEN SP_SELL_BROK / 100 
									ELSE SP_SELL_BROK 
									END)
			) 

			 WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
		) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
		) AND SP_SCHEME_TYPE = 1)     
			  OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
		) > SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
		) AND SP_SCHEME_TYPE = 3) 
			THEN (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
				THEN (CASE 
					WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
					THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
					ELSE 0 
					END) 
				WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
				THEN 1 
				ELSE SUM(SELL_TURNOVER) 
				END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
										WHEN SP_SELL_BROK_TYPE = 'P' 
										THEN SP_SELL_BROK / 100 
										ELSE SP_SELL_BROK 
										END)
				) 
				
				ELSE (PRADNYA.dbo.ROUNDEDTURNOVER_NEW((CASE 
					WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
					THEN (CASE 
						WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
						THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
						ELSE 0 
						END) 
					WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
					THEN 1 
					ELSE SUM(SELL_TURNOVER) 
					END),SP_MULTIPLIER,'N') / SP_MULTIPLIER * (CASE 
											WHEN SP_BUY_BROK_TYPE = 'P' 
											THEN SP_BUY_BROK / 100 
											ELSE SP_BUY_BROK 
											END)
					) 
             					END) ) )) ) ELSE 0 END, 
TOTALBROKERAGE = 0,     
 CD_TOT_SERTAX = 0 ,    
 CD_TOT_STT = SUM(INS_CHRG),    
 CD_TOT_TURN_TAX = SUM(TURN_TAX),    
 CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,    
 CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,    
 CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,    
 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),    
 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
    ELSE 0     
    END),    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT  
 INTO #BFOSETTLEMENT2  
 FROM     
 #BFOSETTLEMENT1 FOSETT  ,
 #TRD_BFOSETTLEMENT   
 WHERE
	T_SAUDADATE = LEFT(SAUDA_DATE,11) AND
	T_PARTY_CODE = PARTY_CODE AND
	T_PRODUCT_TYPE = PRODUCT_TYPE AND
	T_PRODUCT_CODE = PRODUCT_CODE AND
	T_EXPIRYDATE = EXPIRYDATE AND
	T_STRIKE_PRICE = STRIKE_PRICE AND
	T_OPTION_TYPE = OPTION_TYPE AND
	T_SERIES_CODE = SERIES_CODE AND
	T_SERIES_ID = SERIES_ID AND 
	T_AUCTIONPART = AUCTIONPART

GROUP BY     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO,    
(CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE '' END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN ASSET_CODE ELSE '' END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END),    
 SP_MULTIPLIER,SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_SCHEME_TYPE,    
 SP_BROK_COMPUTETYPE,SP_VALUE_FROM,SP_VALUE_TO,SP_SCHEME_ID,    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,        
 SP_SELL_BROK, SP_BUY_BROK, SP_BUY_BROK_TYPE, SP_SELL_BROK_TYPE,    
 AUCTIONPART,PRODUCT_CODE,LOT_SIZE
 HAVING     
 (CASE     
  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*TRADE_PRICE)       
  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
  ELSE (SUM(TRADEQTY*TRADE_PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
 END) > SP_VALUE_FROM       
 AND       
 (CASE    
  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*TRADE_PRICE)       
  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)      
  ELSE (SUM(TRADEQTY*TRADE_PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
 END)    
  <=     
    (CASE WHEN SP_VALUE_TO = -1     
     THEN (CASE WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*TRADE_PRICE)       
      WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
      WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
      ELSE (SUM(TRADEQTY*TRADE_PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
     END)    
    ELSE SP_VALUE_TO    
    END)  
       
INSERT INTO #CHARGES_DETAIL_TEMP    
(    
	CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,  
	CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_ASSET_CODE,CD_EXPIRYDATE,
	CD_STRIKE_PRICE,CD_OPTION_TYPE,CD_SERIES_CODE,CD_SERIES_ID,
	CD_LOT_SIZE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,    
	CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
	CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,    
	CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
	CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
	CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,    
	CD_TOT_SERTAX,CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,    
	CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
)    
    
SELECT    
 PARTY_CODE,SAUDA_DATE,CONTRACTNO,TRADE_NO,ORDER_NO,    
 PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,
STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,
AUCTIONPART,MARKETLOT,SP_SCHEME_ID,    
 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_BROK_COMPUTETYPE,    
 BUYRATE,SELLRATE,    
 BUY_QTY, SELL_QTY,     
 BUY_TURNOVER, SELL_TURNOVER,    
 RND_BUY_TURNOVER, RND_SELL_TURNOVER,     
 TOTALTURNOVER, RND_TURNOVER,    
 TOTALLOT=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN (BUY_QTY+SELL_QTY)/TOTALLOT ELSE TOTALLOT END),    
 TOTALTURNOVER_RES,RND_TURNOVER_RES,TOTALLOT_RES,    
 BUYBROKERAGE = (CASE WHEN SP_BROK_COMPUTEON = 'V'    
        THEN (CASE WHEN BUYBROKERAGE > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,BUYBROKERAGE)     
      ELSE BUYBROKERAGE    
      END)    
     ELSE PRADNYA.dbo.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,BUYBROKERAGE)     
      ELSE BUYBROKERAGE    
      END))    
     END)    
    ELSE 0     
    END)* BUY_QTY/TOTALLOT    
    ELSE BUYBROKERAGE END),    
        SELLBROKERAGE = (CASE WHEN SP_BROK_COMPUTEON = 'V'    
        THEN (CASE WHEN SELLBROKERAGE > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
     THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,SELLBROKERAGE)     
      ELSE SELLBROKERAGE    
      END)    
     ELSE PRADNYA.dbo.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,SELLBROKERAGE)     
      ELSE SELLBROKERAGE    
      END))    
     END)    
    ELSE 0     
    END) * SELL_QTY/TOTALLOT    
    ELSE SELLBROKERAGE END),    
 TOTALBROKERAGE = CASE WHEN SP_BROK_COMPUTEON = 'V' THEN 0 ELSE      
   (CASE WHEN (BUYBROKERAGE+SELLBROKERAGE) > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
     THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,(BUYBROKERAGE+SELLBROKERAGE))     
      ELSE (BUYBROKERAGE+SELLBROKERAGE)    
      END)    
     ELSE PRADNYA.dbo.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(SP_MIN_BROKAMT,(BUYBROKERAGE+SELLBROKERAGE))     
      ELSE (BUYBROKERAGE+SELLBROKERAGE)    
      END))    
     END)    
    ELSE 0     
    END) END,    
 CD_TOT_SERTAX = 0,CD_TOT_STT,CD_TOT_TURN_TAX,    
 CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,    
 CD_EXCH_SELLRATE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT    
FROM    
#BFOSETTLEMENT2 FOSETTCHRG    
    
    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK    
  AND CD_TOT_SELLBROK > CD_TOT_BUYBROK    
  AND CD_COMPUTATIONON <> 'V'    
    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK    
  AND CD_TOT_BUYBROK > CD_TOT_SELLBROK     
  AND CD_COMPUTATIONON <> 'V'    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_BROK =CD_TOT_SELLBROK+ CD_TOT_BUYBROK    
WHERE    CD_COMPUTATIONON = 'V'    
    
/*---------------------------------------------------------------------------------------------------------------    
    FETCHING DATA FOR INCREMENTAL VALUE BASED BROKERAGE    
----------------------------------------------------------------------------------------------------------------*/    
    
DECLARE @SETTCUR CURSOR,    
 @PARTY_CODE VARCHAR(10),    
 @SAUDA_DATE VARCHAR(11),    
 @CONTRACTNO VARCHAR(14),    
 @TRADE_NO VARCHAR(15),    
 @ORDER_NO VARCHAR(20),    
 @PRODUCT_TYPE VARCHAR(5),    
 @PRODUCT_CODE VARCHAR(10),    
 @SERIES_CODE VARCHAR(20),    
 @SERIES_ID INT,    
 @EXPIRYDATE DATETIME,    
 @AUCTIONPART VARCHAR(2),    
 @BUY_TURNOVER NUMERIC(36,12),    
 @SELL_TURNOVER NUMERIC(36,12),    
 @LOTSIZE BIGINT,    
 @BUYRATE NUMERIC(36,12),    
 @SELLRATE NUMERIC(36,12),    
 @BUYQTY BIGINT,    
 @SELLQTY BIGINT,    
 @TOT_STT NUMERIC(36,12),    
 @TOT_TURN_TAX NUMERIC(36,12),    
 @TOT_OTHER_CHRG NUMERIC(36,12),    
 @TOT_SEBI_TAX NUMERIC(36,12),    
 @TOT_STAMPDUTY NUMERIC(36,12),    
 @EXCH_BUYRATE NUMERIC(36,12),    
 @EXCH_SELLRATE NUMERIC(36,12),    
 @MIN_BROKAMT NUMERIC(36,12),    
 @MAX_BROKAMT NUMERIC(36,12),    
 @MIN_SCRIPAMT NUMERIC(36,12),    
 @MAX_SCRIPAMT NUMERIC(36,12),    
 @SP_COMPUTATIONLEVEL CHAR(1),    
 @SP_COMPUTATIONON CHAR(1),    
 @SP_COMPUTATIONTYPE CHAR(1),    
 @SCHEMEID INT    
    
DECLARE @SCHEMECUR CURSOR,    
@SP_COMPUTATION_LEVEL CHAR(1),    
 @SP_MULTIPLIER MONEY,    
 @SP_BUY_BROK_TYPE CHAR(1),    
 @SP_SELL_BROK_TYPE CHAR(1),    
 @SP_BUY_BROK NUMERIC(36,12),    
 @SP_SELL_BROK NUMERIC(36,12), 
 @SP_VALUE_FROM NUMERIC(36,12),    
 @SP_VALUE_TO NUMERIC(36,12),    
 @BUYFLAG BIGINT,    
 @SELLFLAG BIGINT,    
 @SP_SCHEME_TYPE INT    
    
DECLARE     
 @NEWBUYTURNOVER NUMERIC(36,12),    
 @NEWBUYTURNOVERORG NUMERIC(36,12),    
 @NEWSELLTURNOVER NUMERIC(36,12),    
 @NEWSELLTURNOVERORG NUMERIC(36,12),    
 @BUYBROKERAGE NUMERIC(36,12),    
 @SELLBROKERAGE NUMERIC(36,12)    
    
SET @SETTCUR = CURSOR FOR    
 SELECT     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO,    
 TRADE_NO = (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 ORDER_NO = (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 PRODUCT_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
 PRODUCT_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE PRODUCT_TYPE END),    
 SERIES_CODE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
 SERIES_ID = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END),    
 EXPIRYDATE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
 AUCTIONPART,    
 BUY_TURNOVER = SUM(BUY_TURNOVER),    
 SELL_TURNOVER = SUM(SELL_TURNOVER),    
 LOTSIZE=SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY),    
 BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
  END),    
 SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
  END),    
 BUYQTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),    
 SELLQTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),    
 CD_TOT_STT = SUM(INS_CHRG),    
 CD_TOT_TURN_TAX = SUM(TURN_TAX),    
 CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,    
 CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,    
 CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,    
 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
    ELSE 0     
    END),    
 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
     ELSE 0    
    END),    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID    
 FROM     
 (    
 SELECT     
  TRADE_NO=PRADNYA.dbo.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,    
  PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,    
  TRADEQTY,LOTSIZE = CONVERT(BIGINT,LOT_SIZE),SAUDA_DATE=LEFT(SAUDA_DATE,11),TRADE_PRICE,    
  BUY_TURNOVER = CASE WHEN SELL_BUY = 1 THEN    
     CASE WHEN SP_BROK_COMPUTEON = 'T'     
      THEN TRADEQTY *     
       (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
       CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
       WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
       ELSE TRADE_PRICE + STRIKE_PRICE END END)    
     WHEN SP_BROK_COMPUTEON = 'Q'    
      THEN TRADEQTY    
     ELSE TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
     END    
    ELSE 0 END,    
  SELL_TURNOVER = CASE WHEN SELL_BUY = 2 THEN    
     CASE WHEN SP_BROK_COMPUTEON = 'T'     
      THEN TRADEQTY*    
       (CASE WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE ELSE    
       CASE WHEN SP_TURNOVERON = 'PRICE' THEN TRADE_PRICE     
       WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
       ELSE TRADE_PRICE + STRIKE_PRICE END END)    
     WHEN SP_BROK_COMPUTEON = 'Q'    
      THEN TRADEQTY    
     ELSE TRADEQTY / CONVERT(BIGINT,LOT_SIZE)    
     END    
    ELSE 0 END,    
  SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,    
  SP_COMPUTATIONTYPE = SP_BROK_COMPUTETYPE,SP_SCHEME_ID,    
  SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
  SP_MULTIPLIER,AUCTIONPART,    
  INS_CHRG = (INS_CHRG),    
  TURN_TAX = (TURN_TAX),     
  OTHER_CHRG = (F.OTHER_CHRG),    
  SEBI_TAX = (SEBI_TAX),    
  BROKER_CHRG = (BROKER_CHRG)        
 FROM    
  BFOSETTLEMENT F,    
  SCHEME_MAPPING S,    
  CLIENT1 C1,    
  CLIENT2 C2    
 WHERE    
  SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO + ' 23:59:59'    
  AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
  AND SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
  AND F.PARTY_CODE = SP_PARTY_CODE    
  AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
  AND F.PRODUCT_CODE =  CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN F.PRODUCT_CODE ELSE SP_PRODUCT_CODE END    
  AND  1 = CASE    
   WHEN SP_PRODUCT_CODE = 'ALL' AND SERIES_ID NOT IN  
   (     
    SELECT SP_PRODUCT_CODE FROM SCHEME_MAPPING S    
    WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
    AND F.PARTY_CODE = SP_PARTY_CODE    
    AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE    
   )     
   THEN 1       
   ELSE CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN 0 ELSE 1  END END    
 AND SP_TRD_TYPE = CASE WHEN AUCTIONPART <> 'EA'    
    THEN 'TRD' ELSE 'DEL' END    
 AND AUCTIONPART <> 'CA'    
 AND TRADEQTY > 0     
 AND SP_BROK_COMPUTETYPE = 'I'    
 AND SP_VALUE_FROM = (SELECT MIN(SP_VALUE_FROM) FROM     
    SCHEME_MAPPING S    
    WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
    AND F.PARTY_CODE = SP_PARTY_CODE    
    AND RIGHT(PRODUCT_CODE,3) = SP_PRODUCT_TYPE)    
 AND C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = F.PARTY_CODE    
 --AND C1.CL_TYPE <> 'INS' AND RESERVED1 = 0      
 AND TRADESTATUS <> 'E'    
 ) FOSETT    
     
 GROUP BY     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO,    
 (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_TYPE ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN PRODUCT_CODE ELSE PRODUCT_TYPE END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_CODE ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SERIES_ID ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
 AUCTIONPART,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID    
    
OPEN @SETTCUR    
    
    
 FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,    
 @PRODUCT_TYPE,@PRODUCT_CODE,@SERIES_CODE,@SERIES_ID,@EXPIRYDATE,    
 @AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,    
 @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,    
 @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,    
 @SP_COMPUTATIONTYPE,@SCHEMEID    
    
 WHILE @@FETCH_STATUS = 0     
 BEGIN       
  SELECT @BUYFLAG = 0     
  SELECT @SELLFLAG = 0     
    
  /*-----------------------------------------------------------------------------------------------------------*/    
  SET @SCHEMECUR = CURSOR FOR    
  SELECT    
   SP_COMPUTATION_LEVEL,    
   SP_MULTIPLIER,    
   SP_BUY_BROK_TYPE,    
   SP_SELL_BROK_TYPE,    
   SP_BUY_BROK,    
   SP_SELL_BROK,    
   SP_VALUE_FROM,    
   SP_VALUE_TO,    
   SP_SCHEME_TYPE    
  FROM    
   SCHEME_MAPPING    
  WHERE    
   @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
   AND SP_PARTY_CODE = @PARTY_CODE      
   AND SP_PRODUCT_TYPE = RIGHT(@PRODUCT_CODE,3)    
   AND SP_PRODUCT_CODE =  CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN SP_PRODUCT_CODE ELSE SP_PRODUCT_CODE END    
   AND  1 = CASE    
    WHEN SP_PRODUCT_CODE = 'ALL' AND @SERIES_ID NOT IN     
    (     
     SELECT SP_PRODUCT_CODE FROM SCHEME_MAPPING S    
     WHERE @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
     AND SP_PARTY_CODE = @PARTY_CODE      
     AND SP_PRODUCT_TYPE = RIGHT(@PRODUCT_CODE,3)      
    )     
    THEN 1       
    ELSE CASE WHEN SP_PRODUCT_CODE = 'ALL' THEN 0 ELSE 1  END END      
   AND SP_TRD_TYPE = CASE WHEN @AUCTIONPART <> 'EA'    
     THEN 'TRD' ELSE 'DEL' END    
   AND SP_BROK_COMPUTETYPE = 'I'    
  ORDER BY SP_VALUE_FROM    
    
  OPEN @SCHEMECUR    
  FETCH NEXT FROM  
   @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,    
   @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE    
    
   SET @NEWBUYTURNOVER = @BUY_TURNOVER     
   SET @NEWSELLTURNOVER = @SELL_TURNOVER     
   SET @NEWBUYTURNOVERORG = 0     
   SET @NEWSELLTURNOVERORG = 0     
   SET @BUYBROKERAGE = 0    
   SET @SELLBROKERAGE = 0    
    
  WHILE @@FETCH_STATUS = 0 AND (@NEWBUYTURNOVER > 0 OR @NEWSELLTURNOVER > 0)         
BEGIN    
    
  /*--------------------------------------------------------------------*/    
  SET @BUYBROKERAGE = 0    
  SET @SELLBROKERAGE = 0    
  IF @NEWBUYTURNOVER > 0     
  BEGIN    
   IF @BUY_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1    
   BEGIN     
    SET @NEWBUYTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
    SET @NEWBUYTURNOVERORG = @NEWBUYTURNOVER * CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
   END    
   ELSE     
   BEGIN    
    SET @NEWBUYTURNOVER = @BUY_TURNOVER - @SP_VALUE_FROM    
    IF @NEWBUYTURNOVER < 0  SET @NEWBUYTURNOVER = 0     
    SET @NEWBUYTURNOVERORG  = @NEWBUYTURNOVER      
    SELECT @NEWBUYTURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(@NEWBUYTURNOVER,@SP_MULTIPLIER)    
    SELECT @NEWBUYTURNOVER = @NEWBUYTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
    SELECT @BUYFLAG = 1   
   END    
   IF @NEWBUYTURNOVER > 0     
   BEGIN     
    SELECT @BUYBROKERAGE =     
     CASE WHEN @SP_SCHEME_TYPE = 0 THEN    
     CASE WHEN @SP_BUY_BROK_TYPE ='P'    
     THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100    
     ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END    
     ELSE    
      CASE WHEN (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=1)    
       OR   (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=3)    
      THEN    
       CASE WHEN @SP_BUY_BROK_TYPE ='P'       
       THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100    
       ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END    
      ELSE    
       CASE WHEN @SP_SELL_BROK_TYPE ='P'    
       THEN @NEWBUYTURNOVER * @SP_SELL_BROK  /100    
       ELSE @NEWBUYTURNOVER * @SP_SELL_BROK END    
      END    
     END    
   END      
   ELSE       
    SELECT @BUYBROKERAGE = 0       
   END    
    
   IF @NEWSELLTURNOVER > 0     
   BEGIN    
    IF @SELL_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1    
    BEGIN     
     SET @NEWSELLTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
     SET @NEWSELLTURNOVERORG = @NEWSELLTURNOVER * CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
    END    
    ELSE     
    BEGIN    
     SET @NEWSELLTURNOVER = @SELL_TURNOVER - @SP_VALUE_FROM    
     IF @NEWSELLTURNOVER < 0 SET @NEWSELLTURNOVER = 0      
     SET @NEWSELLTURNOVERORG  = @NEWSELLTURNOVER       
     SELECT @NEWSELLTURNOVER = PRADNYA.dbo.ROUNDEDTURNOVER(@NEWSELLTURNOVER,@SP_MULTIPLIER)    
     SELECT @NEWSELLTURNOVER = @NEWSELLTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
     SELECT @SELLFLAG = 1    
  END    
    IF @NEWSELLTURNOVER > 0    
    BEGIN      
     SELECT @SELLBROKERAGE =     
      CASE WHEN @SP_SCHEME_TYPE = 0 THEN    
       CASE WHEN @SP_SELL_BROK_TYPE ='P'    
       THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100    
       ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END    
      ELSE    
       CASE WHEN (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=1)    
       OR   (@NEWBUYTURNOVER >= @NEWSELLTURNOVER AND @SP_SCHEME_TYPE=3)    
       THEN    
        CASE WHEN @SP_SELL_BROK_TYPE ='P'    
        THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100    
        ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END    
       ELSE    
        CASE WHEN @SP_BUY_BROK_TYPE ='P'    
        THEN @NEWSELLTURNOVER * @SP_BUY_BROK  /100    
        ELSE @NEWSELLTURNOVER * @SP_BUY_BROK END    
       END    
      END    
    END    
   ELSE    
    SELECT @SELLBROKERAGE = 0       
   END    
    
    
  INSERT INTO #CHARGES_DETAIL_TEMP1     
  (    
   CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
   CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,    
   CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,    
   CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
   CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,    
   CD_TOT_BUYTURNOVER_ROUNDED,CD_TOT_SELLTURNOVER_ROUNDED,    
   CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
   CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
   CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,CD_TOT_SERTAX,    
   CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,    
   CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
   CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
  )    
  VALUES     
  (    
   @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,    
   @PRODUCT_TYPE,@PRODUCT_CODE,@SERIES_CODE,@SERIES_ID,@EXPIRYDATE,    
   @AUCTIONPART,@LOTSIZE,@SCHEMEID,    
   @SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,@SP_COMPUTATIONTYPE,@BUYRATE,@SELLRATE,    
   @BUYQTY,@SELLQTY,@NEWBUYTURNOVERORG,@NEWSELLTURNOVERORG,    
   (@NEWBUYTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),    
   (@NEWSELLTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),0,0,    
   (@BUYQTY+@SELLQTY)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END ,    
   0,0,0,@BUYBROKERAGE,@SELLBROKERAGE,0,0,    
   @TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,    
   @EXCH_BUYRATE,@EXCH_SELLRATE,    
   @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT    
  )     
      
  IF @SP_VALUE_TO = -1       
  BEGIN      
   SELECT @NEWBUYTURNOVER = 0       
   SELECT @NEWSELLTURNOVER = 0      
  END       
  /*--------------------------------------------------------------------*/    
  FETCH NEXT FROM     
  @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,    
  @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE    
 END    
 CLOSE @SCHEMECUR    
 DEALLOCATE @SCHEMECUR    
  /*-----------------------------------------------------------------------------------------------------------*/    
 FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,    
 @PRODUCT_TYPE,@PRODUCT_CODE,@SERIES_CODE,@SERIES_ID,@EXPIRYDATE,    
 @AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,    
 @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,    
 @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,    
@SP_COMPUTATIONTYPE,@SCHEMEID    
    
END    
CLOSE @SETTCUR    
DEALLOCATE @SETTCUR    
    
INSERT INTO #CHARGES_DETAIL_TEMP    
 (    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,    
 CD_EXPIRYDATE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,    
 CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
 CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,    
 CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
 CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
 CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,    
 CD_TOT_SERTAX,    
 CD_TOT_STT,CD_TOT_TURN_TAX,    
 CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,    
 CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
 )    
SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,    
 CD_EXPIRYDATE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_BUYRATE,CD_SELLRATE,CD_TOT_BUYQTY,CD_TOT_SELLQTY,    
 CD_TOT_BUYTURNOVER,    
 CD_TOT_SELLTURNOVER,    
 CD_TOT_BUYTURNOVER_ROUNDED,    
 CD_TOT_SELLTURNOVER_ROUNDED,    
 CD_TOT_TURNOVER=CD_TOT_BUYTURNOVER+CD_TOT_SELLTURNOVER,    
 CD_TOT_TURNOVER_ROUNDED=CD_TOT_BUYTURNOVER_ROUNDED+CD_TOT_SELLTURNOVER_ROUNDED,    
 CD_TOT_LOT,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT,    
 CD_TOT_BUYBROK=(CASE WHEN CD_TOT_BUYBROK > 0     
    THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
    THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)     
     ELSE CD_TOT_BUYBROK    
     END)    
    ELSE PRADNYA.dbo.FNMIN(CD_MAX_BROKAMT,    
     (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)     
     ELSE CD_TOT_BUYBROK    
     END))    
    END)    
   ELSE 0     
   END),    
 CD_TOT_SELLBROK=(CASE WHEN CD_TOT_SELLBROK > 0     
    THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
    THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)     
     ELSE CD_TOT_SELLBROK    
     END)    
    ELSE PRADNYA.dbo.FNMIN(CD_MAX_BROKAMT,    
     (CASE WHEN CD_MIN_BROKAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)     
     ELSE CD_TOT_SELLBROK    
     END))    
    END)    
   ELSE 0     
   END),    
 CD_TOT_BROK=(CASE WHEN CD_TOT_BROK > 0     
   THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
   THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)     
    ELSE CD_TOT_BROK    
    END)    
   ELSE PRADNYA.dbo.FNMIN(CD_MAX_BROKAMT,    
    (CASE WHEN CD_MIN_BROKAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)     
    ELSE CD_TOT_BROK    
    END))    
   END)    
  ELSE 0     
  END),         
 CD_TOT_SERTAX=0,    
 CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,    
 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,    
 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
FROM    
(    
 SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,    
 CD_AUCTIONPART,CD_MARKETLOT,    
 CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
 CD_TOT_BUYQTY= CD_TOT_BUYQTY,    
 CD_TOT_SELLQTY= CD_TOT_SELLQTY,    
 CD_TOT_BUYTURNOVER=SUM(CD_TOT_BUYTURNOVER),    
 CD_TOT_BUYTURNOVER_ROUNDED=SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
 CD_TOT_SELLTURNOVER=SUM(CD_TOT_SELLTURNOVER),    
 CD_TOT_SELLTURNOVER_ROUNDED=SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
 CD_TOT_LOT,    
 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
 CD_TOT_RES_LOT,    
 CD_TOT_BUYBROK=SUM(CD_TOT_BUYBROK),    
 CD_TOT_SELLBROK=SUM(CD_TOT_SELLBROK),    
 CD_TOT_BROK=SUM(CD_TOT_BUYBROK+CD_TOT_SELLBROK),    
 CD_TOT_SERTAX = 0 ,    
 CD_TOT_STT=(CD_TOT_STT),    
 CD_TOT_TURN_TAX=(CD_TOT_TURN_TAX),    
 CD_TOT_OTHER_CHRG=(CD_TOT_OTHER_CHRG),    
 CD_TOT_SEBI_TAX=(CD_TOT_SEBI_TAX),    
 CD_TOT_STAMPDUTY=(CD_TOT_STAMPDUTY),    
 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
 CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
 FROM     
 #CHARGES_DETAIL_TEMP1    
 GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,    
 CD_EXPIRYDATE,CD_AUCTIONPART,CD_MARKETLOT,    
 CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
 CD_TOT_LOT,CD_TOT_RES_LOT,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
 CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT, CD_TOT_BUYQTY, CD_TOT_SELLQTY,    
 CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY    
)FOSETTCHRG    
    
UPDATE     
 #CHARGES_DETAIL_TEMP    
SET    
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)    
    
UPDATE     
 #CHARGES_DETAIL_TEMP    
SET    
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK     
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)    
    
/*---------------------------------------------------------------------------------------------------------------    
    TAKING DATA FOR SCRIP LEVEL + CONTRACT LEVEL ROUNDING    
----------------------------------------------------------------------------------------------------------------*/    
    
 /*SCRIP LEVEL ROUNDING*/    
 INSERT INTO #CHARGES_DETAIL_FINAL    
 SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
 CD_TRADE_NO='',    
 CD_ORDER_NO='',    
 CD_PRODUCT_TYPE, CD_PRODUCT_CODE,CD_ASSET_CODE,
 CD_EXPIRYDATE,CD_STRIKE_PRICE,CD_OPTION_TYPE,
 CD_SERIES_CODE,CD_SERIES_ID,CD_LOT_SIZE,
 CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,    
 CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,    
 CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),    
 CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),    
 CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),    
 CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),    
 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
 CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),    
 CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),     CD_TOT_LOT=SUM(CD_TOT_LOT),    
 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
 CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),    
 CD_TOT_BUYBROK = SUM(CD_TOT_BUYBROK),    
 CD_TOT_SELLBROK =SUM(CD_TOT_SELLBROK),    
 CD_TOT_BROK = (CASE WHEN SUM(CD_TOT_BROK) > 0     
    THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1     
     THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
     ELSE SUM(CD_TOT_BROK)    
     END)    
    ELSE PRADNYA.dbo.FNMIN(CD_MAX_SCRIPAMT,    
     (CASE WHEN CD_MIN_SCRIPAMT <> 0     
     THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
     ELSE SUM(CD_TOT_BROK)    
     END))    
    END)    
   ELSE 0     
   END),    
 CD_TOT_SERTAX=0,    
 CD_TOT_STT=SUM(CD_TOT_STT),    
 CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),    
 CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),    
 CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),    
 CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),    
 CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,    
 CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END ,    
 0,0,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
 FROM     
  #CHARGES_DETAIL_TEMP    
 WHERE    
  CD_COMPUTATIONLEVEL NOT IN ('C','S')    
 GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
 CD_PRODUCT_TYPE,CD_PRODUCT_CODE,CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT,CD_ASSET_CODE,CD_STRIKE_PRICE,CD_OPTION_TYPE,CD_LOT_SIZE  
 HAVING      
 SUM(CD_TOT_BROK) <> (CASE WHEN SUM(CD_TOT_BROK) > 0     
    THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1     
     THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
      ELSE SUM(CD_TOT_BROK)    
      END)    
     ELSE PRADNYA.dbo.FNMIN(CD_MAX_SCRIPAMT,    
      (CASE WHEN CD_MIN_SCRIPAMT <> 0     
      THEN PRADNYA.dbo.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
      ELSE SUM(CD_TOT_BROK)    
    END))    
     END)    
    ELSE 0     
    END)    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK     
    
    
DELETE     
 #CHARGES_DETAIL_TEMP     
FROM     
 #CHARGES_DETAIL_FINAL    
WHERE    
 CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_SAUDA_DATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_SAUDA_DATE,103)    
 AND #CHARGES_DETAIL_TEMP.CD_PARTY_CODE = #CHARGES_DETAIL_FINAL.CD_PARTY_CODE    
 AND #CHARGES_DETAIL_TEMP.CD_CONTRACT_NO = #CHARGES_DETAIL_FINAL.CD_CONTRACT_NO    
 AND #CHARGES_DETAIL_TEMP.CD_PRODUCT_TYPE = #CHARGES_DETAIL_FINAL.CD_PRODUCT_TYPE    
 AND #CHARGES_DETAIL_TEMP.CD_PRODUCT_CODE = #CHARGES_DETAIL_FINAL.CD_PRODUCT_CODE    
 AND #CHARGES_DETAIL_TEMP.CD_SERIES_CODE = #CHARGES_DETAIL_FINAL.CD_SERIES_CODE    
 AND #CHARGES_DETAIL_TEMP.CD_SERIES_ID = #CHARGES_DETAIL_FINAL.CD_SERIES_ID    
 AND CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_EXPIRYDATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_EXPIRYDATE,103)    
 AND  #CHARGES_DETAIL_TEMP.CD_AUCTIONPART = #CHARGES_DETAIL_FINAL.CD_AUCTIONPART    
    
    
 INSERT INTO #CHARGES_DETAIL_TEMP SELECT * FROM #CHARGES_DETAIL_FINAL    
    
    
  
IF (SELECT COUNT(1) FROM CONTRACT_ROUNDING    
 WHERE @SAUDA_DATE_FROM BETWEEN CR_DATE_FROM AND CR_DATE_TO 
AND CR_PARTY_CODE  BETWEEN @PARTY_FROM AND @PARTY_TO) > 0
BEGIN

 /*CONTRACT LEVEL ROUNDING*/    
 TRUNCATE TABLE #CHARGES_DETAIL_FINAL    
    
 INSERT INTO #CHARGES_DETAIL_TEMP    
 SELECT    
 CD_PARTY_CODE=F.PARTY_CODE,    
 CD_SAUDA_DATE=LEFT(SAUDA_DATE,11),    
 CD_CONTRACT_NO=CONTRACTNO,    
 CD_TRADE_NO=TRADE_NO,    
 CD_ORDER_NO=ORDER_NO,    
 CD_PRODUCT_TYPE=PRODUCT_TYPE, 
 CD_PRODUCT_CODE=PRODUCT_CODE,
 CD_ASSET_CODE=ASSET_CODE,
 CD_EXPIRYDATE=EXPIRYDATE,
 CD_STRIKE_PRICE=STRIKE_PRICE,
 CD_OPTION_TYPE=OPTION_TYPE,
 CD_SERIES_CODE=SERIES_CODE,
 CD_SERIES_ID=SERIES_ID,
 CD_LOT_SIZE=LOT_SIZE,    
 CD_AUCTIONPART=AUCTIONPART,    
 CD_MARKETLOT=CONVERT(BIGINT,LOT_SIZE),    
 CD_SCHEME_ID=0,    
 CD_COMPUTATIONLEVEL='',    
 CD_COMPUTATIONON='',    
 CD_COMPUTATIONTYPE='',    
 CD_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0    
   END),    
 CD_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),  
 CD_TOT_BUYQTY = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END),    
 CD_TOT_SELLQTY = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END),    
 CD_TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END),    
 CD_TOT_TURNOVER=SUM(TRADEQTY*TRADE_PRICE),    
 CD_TOT_TURNOVER_ROUNDED=SUM(TRADEQTY*TRADE_PRICE),    
 CD_TOT_LOT=0,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT=0,    
 CD_TOT_BUYBROK =  SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY * BROKAPPLIED ELSE 0 END ),    
 CD_TOT_SELLBROK = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY * BROKAPPLIED ELSE 0 END ),    
 CD_TOT_BROK = SUM(TRADEQTY*BROKAPPLIED),    
 CD_TOT_SERTAX=SUM(SERVICE_TAX),    
 CD_TOT_STT=SUM(INS_CHRG),    
 CD_TOT_TURN_TAX=SUM(TURN_TAX),    
 CD_TOT_OTHER_CHRG=SUM(F.OTHER_CHRG),   
 CD_TOT_SEBI_TAX=SUM(SEBI_TAX),    
 CD_TOT_STAMPDUTY=SUM(BROKER_CHRG),     
 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),    
 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /     
    SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),    
 0,0,0,0    
 FROM    
 BFOSETTLEMENT F    
 WHERE     
 SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO + ' 23:59:59'    
 AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
 AND F.PARTY_CODE IN (SELECT CR_PARTY_CODE FROM CONTRACT_ROUNDING    
 WHERE SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)    
 AND F.PARTY_CODE NOT IN    
 (    
 SELECT F.PARTY_CODE FROM #CHARGES_DETAIL_TEMP    
 WHERE        
  CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)     
  AND CD_PARTY_CODE = F.PARTY_CODE    
  AND CD_PRODUCT_TYPE = PRODUCT_TYPE    
  AND CD_PRODUCT_CODE = PRODUCT_CODE    
  AND CD_SERIES_CODE = SERIES_CODE    
  AND CD_SERIES_ID = SERIES_ID    
  AND CONVERT(VARCHAR,CD_EXPIRYDATE,103) = CONVERT(VARCHAR,EXPIRYDATE,103)    
  AND CD_AUCTIONPART = AUCTIONPART    
 )     
 GROUP BY    
 LEFT(SAUDA_DATE,11),         
 F.PARTY_CODE,    
 PRODUCT_TYPE, 
 ASSET_CODE,   
 PRODUCT_CODE,    
 SERIES_CODE,    
 SERIES_ID,    
 EXPIRYDATE,  
 OPTION_TYPE,
 STRIKE_PRICE, 
 AUCTIONPART,    
 CONTRACTNO,    
 ORDER_NO,    
 TRADE_NO,    
 LOT_SIZE
    
 INSERT INTO #CHARGES_DETAIL_FINAL     
 SELECT    
 CD_PARTY_CODE,CD_SAUDA_DATE,    
 CD_CONTRACT_NO=0,    
 CD_TRADE_NO='',CD_ORDER_NO='', 
 CD_PRODUCT_TYPE='', 
 CD_PRODUCT_CODE='FUTOPT',
 CD_ASSET_CODE='',
 CD_EXPIRYDATE='DEC 31 2049 23:59',
 CD_STRIKE_PRICE=0,
 CD_OPTION_TYPE='',
 CD_SERIES_CODE='BROKERAGE',
 CD_SERIES_ID=0,
 CD_LOT_SIZE=1,  
 CD_AUCTIONPART='0',CD_MARKETLOT=0,    
 CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',    
 CD_BUYRATE = 0,    
 CD_SELLRATE = 0,    
 CD_TOT_BUYQTY = 0,    
 CD_TOT_SELLQTY = 0,    
 CD_TOT_BUYTURNOVER = 0,    
 CD_TOT_SELLTURNOVER = 0,    
 CD_TOT_BUYTURNOVER_ROUNDED = 0,    
 CD_TOT_SELLTURNOVER_ROUNDED = 0,    
 CD_TOT_TURNOVER=0,    
 CD_TOT_TURNOVER_ROUNDED=0,    
 CD_TOT_LOT=0,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT=0,    
 CD_TOT_BUYBROK = 0,    
 CD_TOT_SELLBROK =0,    
 CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1     
   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
  ELSE SUM(CD_TOT_BROK)    
    END)    
   ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
    (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
    ELSE SUM(CD_TOT_BROK)    
    END))    
   END,    
 CD_TOT_SERTAX=0,    
 CD_TOT_STT=0,    
 CD_TOT_TURN_TAX=0,    
 CD_TOT_OTHER_CHRG=0,    
 CD_TOT_SEBI_TAX=0,    
 CD_TOT_STAMPDUTY=0,    
 CD_EXCH_BUYRATE=0 ,    
 CD_EXCH_SELLRATE =0,    
 0,0,0,0    
FROM    
 #CHARGES_DETAIL_TEMP  LEFT OUTER JOIN CONTRACT_ROUNDING     
 ON (CR_PARTY_CODE = CD_PARTY_CODE     
  AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)      
GROUP BY    
 CD_PARTY_CODE,CR_MIN_CONTRACTAMT,    
 CR_MAX_CONTRACTAMT,CD_SAUDA_DATE    
HAVING     
 SUM(CD_TOT_BROK) > CASE WHEN CR_MAX_CONTRACTAMT = - 1     
  THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END)    
  ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
   (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END))    
  END     
    
UPDATE     
 #CHARGES_DETAIL_TEMP SET CD_TOT_BUYBROK = 0, CD_TOT_SELLBROK =0, CD_TOT_BROK = 0     
FROM     
 #CHARGES_DETAIL_FINAL    
WHERE    
 CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_SAUDA_DATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_SAUDA_DATE,103)    
 AND #CHARGES_DETAIL_TEMP.CD_PARTY_CODE = #CHARGES_DETAIL_FINAL.CD_PARTY_CODE      
    
INSERT INTO #CHARGES_DETAIL_FINAL     
SELECT    
 CD_PARTY_CODE,CD_SAUDA_DATE,    
 CD_CONTRACT_NO=0,    
 CD_TRADE_NO='',CD_ORDER_NO='',    
 CD_PRODUCT_TYPE='', 
 CD_PRODUCT_CODE='FUTOPT',
 CD_ASSET_CODE='',
 CD_EXPIRYDATE='DEC 31 2049 23:59',
 CD_STRIKE_PRICE=0,
 CD_OPTION_TYPE='',
 CD_SERIES_CODE='BROKERAGE',
 CD_SERIES_ID=0,
 CD_LOT_SIZE=1,     
 CD_AUCTIONPART='0',CD_MARKETLOT=0,    
 CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='C',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',    
 CD_BUYRATE = 0,    
 CD_SELLRATE = 0,    
 CD_TOT_BUYQTY = 0,    
 CD_TOT_SELLQTY = 0,    
 CD_TOT_BUYTURNOVER = 0,    
 CD_TOT_SELLTURNOVER = 0,    
 CD_TOT_BUYTURNOVER_ROUNDED = 0,    
 CD_TOT_SELLTURNOVER_ROUNDED = 0,    
 CD_TOT_TURNOVER=0,    
 CD_TOT_TURNOVER_ROUNDED=0,    
 CD_TOT_LOT=0,    
 CD_TOT_RES_TURNOVER=0,    
 CD_TOT_RES_TURNOVER_ROUNDED=0,    
 CD_TOT_RES_LOT=0,    
 CD_TOT_BUYBROK =  0,    
 CD_TOT_SELLBROK = 0,    
 CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1     
   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
    ELSE SUM(CD_TOT_BROK)    
    END)    
   ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
    (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
    THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
    ELSE SUM(CD_TOT_BROK)    
    END))    
   END,    
 CD_TOT_SERTAX=0,    
 CD_TOT_STT=0,    
 CD_TOT_TURN_TAX=0,    
 CD_TOT_OTHER_CHRG=0,    
 CD_TOT_SEBI_TAX=0,    
 CD_TOT_STAMPDUTY=0,    
 CD_EXCH_BUYRATE=0 ,    
 CD_EXCH_SELLRATE =0,    
 0,0,0,0    
 FROM    
 #CHARGES_DETAIL_TEMP  LEFT OUTER JOIN CONTRACT_ROUNDING     
 ON (CR_PARTY_CODE = CD_PARTY_CODE     
  AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)    
  AND CD_PARTY_CODE NOT IN (SELECT CD_PARTY_CODE FROM #CHARGES_DETAIL_FINAL )    
GROUP BY       
 CD_PARTY_CODE,CR_MIN_CONTRACTAMT,    
 CR_MAX_CONTRACTAMT,CD_SAUDA_DATE    
HAVING     
 SUM(CD_TOT_BROK) < CASE WHEN CR_MAX_CONTRACTAMT = - 1     
  THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END)    
  ELSE PRADNYA.dbo.FNMIN(CR_MAX_CONTRACTAMT,    
   (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
   THEN PRADNYA.dbo.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
   ELSE SUM(CD_TOT_BROK)    
   END))    
  END    
    
UPDATE    
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_BROK = CD_TOT_BROK - (CD_TOT_SELLBROK + CD_TOT_BUYBROK)    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
    
UPDATE     
 #CHARGES_DETAIL_FINAL    
SET    
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK    
    
 DELETE FROM #CHARGES_DETAIL_TEMP    
 WHERE CD_PARTY_CODE IN (SELECT CD_PARTY_CODE FROM #CHARGES_DETAIL_FINAL)    
    
 INSERT INTO #CHARGES_DETAIL_TEMP SELECT * FROM #CHARGES_DETAIL_FINAL    
END    
 /*FINAL OUTPUT*/    
DELETE FROM CHARGES_DETAIL     
WHERE    
 CD_SAUDA_DATE >= @SAUDA_DATE_FROM      
 AND CD_SAUDA_DATE <= @SAUDA_DATE_TO + ' 23:59:59'    
 AND CD_PARTY_CODE >= @PARTY_FROM    
 AND CD_PARTY_CODE <= @PARTY_TO    
    
INSERT INTO CHARGES_DETAIL     
SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,
 CD_PRODUCT_TYPE, 
 CD_PRODUCT_CODE=(CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_PRODUCT_CODE ELSE '' END),
 CD_ASSET_CODE,
CD_EXPIRYDATE,
 CD_STRIKE_PRICE,
 CD_OPTION_TYPE,
 CD_SERIES_CODE,
 CD_SERIES_ID,
 CD_LOT_SIZE,   
 CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,    
 CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,    
 CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),    
 CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),    
 CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),    
 CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),    
 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
 CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),    
 CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),    
 CD_TOT_LOT=SUM(CD_TOT_LOT),    
 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
 CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),    
 CD_TOT_BUYBROK =  ROUND(SUM(CD_TOT_BUYBROK),2),
 CD_TOT_SELLBROK = ROUND(SUM(CD_TOT_SELLBROK),2),
 CD_TOT_BROK = ROUND(SUM(CD_TOT_BROK),2),
 CD_TOT_BUYSERTAX= ROUND(SUM(CD_TOT_BUYBROK * SERVICE_TAX/100 ),2),
 CD_TOT_SELLSERTAX= ROUND(SUM(CD_TOT_SELLBROK * SERVICE_TAX/100 ),2),   
 CD_TOT_SERTAX= ROUND(SUM(CD_TOT_BROK * SERVICE_TAX/100 ),2),
 CD_TOT_STT=SUM(CD_TOT_STT),    
 CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),    
 CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),    
 CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),    
 CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),    
 CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,    
 CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END ,    
 GETDATE()    
FROM     
 #CHARGES_DETAIL_TEMP , BFOGLOBALS    
WHERE     
 CD_SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_PRODUCT_TYPE,    
 (CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_PRODUCT_CODE ELSE '' END),        
 CD_SERIES_CODE,CD_SERIES_ID,CD_EXPIRYDATE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT,CD_ASSET_CODE,CD_STRIKE_PRICE,CD_OPTION_TYPE,CD_LOT_SIZE    
    
    
/*---------------------------------------------------------------------------------------------------------------    
   CLEANING TEMPORARY TABLES    
----------------------------------------------------------------------------------------------------------------*/    
    
DROP TABLE #CHARGES_DETAIL_TEMP    
DROP TABLE #CHARGES_DETAIL_TEMP1    
DROP TABLE #CHARGES_DETAIL_FINAL    
   
    
/*---------------------------------------------------------------------------------------------------------------    
   KEEPING DUMMY CONTRACT DESCRIPTOR AT THE MASTER    
----------------------------------------------------------------------------------------------------------------*/    
IF (SELECT COUNT(1) FROM BFOSCRIP2 WHERE PRODUCT_CODE ='FUTOPT' AND SERIES_CODE ='BROKERAGE'    
 AND EXPIRYDATE =  'DEC 31 2049 23:59') =0     
BEGIN    
	INSERT INTO BFOSCRIP2   
	SELECT SERIES_ID=0,PRODUCT_TYPE='CF',PRODUCT_CODE='FUTOPT',ASSET_CODE='',EXPIRYDATE='DEC 31 2049 23:59',STRIKE_PRICE=0,OPTION_TYPE='',
	SERIES_CODE='BROKERAGE',UNDERLYING_ASSET='',CA_LEVEL=0,BASE_PRICE=0,
	STARTDATE='DEC 31 2049 23:59',MATURITYDATE='DEC 31 2049 23:59',EXERCISE_STARTDATE='DEC 31 2049 23:59',
	EXERCISE_ENDDATE='DEC 31 2049 23:59',MINIMUM_LOT_SIZE=1,LOT_SIZE_MULTIPLE=1,
	PRICE_TICK=0,MARGIN_INDICATOR=0,INITAIL_MARGIN_PERC=0,STATUS_FLAG=0,ISIN='',TRADE_DATE='DEC 31 2049 23:59',
	UPDATED_BY='VBB_PROC',UPDATED_ON=GETDATE()
END    
    
/*--------------------------------------------------------------------------------------------------------------    
   UPDATING BFOSETTLEMENT BROK APPLED & SERVICE CHRG TO ZERO FOR THE GIVEN CRITERIA    
----------------------------------------------------------------------------------------------------------------*/    
    
UPDATE     
 BFOSETTLEMENT    
SET    
 BROKAPPLIED = 0,    
 SERVICE_TAX = 0    
FROM    
 CHARGES_DETAIL     
WHERE    
 CONVERT(VARCHAR,CD_SAUDA_DATE,11) = CONVERT(VARCHAR,SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE    
 AND CD_PRODUCT_CODE = PRODUCT_CODE    
 AND CD_SERIES_CODE = SERIES_CODE    
 AND CD_SERIES_ID = SERIES_ID    
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,103) = CONVERT(VARCHAR,EXPIRYDATE,103)    
 AND CD_AUCTIONPART = AUCTIONPART    
 AND TRADESTATUS <> 'E'    
 AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'    
 AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
    
    
UPDATE     
 BFOSETTLEMENT    
SET    
 BROKAPPLIED = 0,    
 SERVICE_TAX = 0,    
 NETRATE = TRADE_PRICE    
FROM    
 CHARGES_DETAIL     
WHERE    
 CONVERT(VARCHAR,CD_SAUDA_DATE,11) = CONVERT(VARCHAR,SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND TRADESTATUS <> 'E'    
 AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'    
 AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
 AND CD_COMPUTATIONLEVEL ='C'    
 AND BROKAPPLIED <> 0    
  
  
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE_FROM,'VBB','',@USERNAME,''


/*---------------------------------------------------------------------------------------------------------------    
     END OF PROCEDURE    
----------------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_DELIVERY_POSITION_POP
-- --------------------------------------------------
  
CREATE PROC [dbo].[PR_DELIVERY_POSITION_POP]  
(  
 @SAUDA_DATE VARCHAR(11),  
 @USERID VARCHAR(30)  
) AS  
  
DECLARE @SETT_TYPE VARCHAR(2)  
DECLARE @SETT_NO VARCHAR(7)  
DECLARE @SYSTEMDATE DATETIME  
  
SET @SETT_TYPE = 'F'  
  
SELECT @SETT_NO = SETT_NO FROM BSEDB_AB.DBO.SETT_MST (NOLOCK) WHERE   
SETT_TYPE = @SETT_TYPE AND @SAUDA_DATE BETWEEN START_DATE AND END_DATE  
  
IF ISNULL(@SETT_NO,'') =''  
BEGIN  
 RETURN  
END  
  
CREATE TABLE #DELIVERY_POSITION  
(  
 PARTY_CODE  VARCHAR (10),  
 BSECODE   VARCHAR(12),  
 DEL_QTY   INT,  
 DEL_PRICE  NUMERIC(12,4),  
 BROKERAGE  NUMERIC(12,4),  
 SERVICE_TAX  NUMERIC(12,4)   
)  
  
INSERT INTO #DELIVERY_POSITION  
SELECT  
 PARTY_CODE,  
 BSECODE = CASE WHEN S.CA_LEVEL ='0' THEN S.UNDERLYING_ASSET ELSE S.CA_LEVEL END,  
 DEL_QTY = SUM(CASE WHEN LEFT(F.OPTION_TYPE,1) = 'P'   
        THEN (CASE WHEN SELL_BUY = 1   
          THEN TRADEQTY   
          ELSE -TRADEQTY   
        END)  
        ELSE (CASE WHEN SELL_BUY = 2   
          THEN TRADEQTY   
          ELSE -TRADEQTY   
        END)  
      END),  
 DEL_PRICE = 0,0,0  
FROM  
 BFOSETTLEMENT F (NOLOCK),  
 BFOSCRIP2 S (NOLOCK)   
WHERE  
 SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
 AND F.EXPIRYDATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
 AND AUCTIONPART = 'EA'  
 AND F.SERIES_ID = S.SERIES_ID  
 AND S.ASSET_CODE <> 'BSX'  
GROUP BY    
 PARTY_CODE,CASE WHEN S.CA_LEVEL ='0' THEN S.UNDERLYING_ASSET ELSE S.CA_LEVEL END  
HAVING SUM(CASE WHEN SELL_BUY =1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0  
  
IF (SELECT COUNT(1) FROM #DELIVERY_POSITION) = 0  
BEGIN  
 DROP TABLE #DELIVERY_POSITION  
 RETURN  
END  
  
/*UPDATE #DELIVERY_POSITION   
SET DEL_PRICE = CLOSE_PRICE  
FROM  
(  
 SELECT   
  ASSET_CODE,CLOSE_PRICE  
 FROM   
  BFOCLOSING (NOLOCK)  
 WHERE   
  TRADE_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
  AND EXPIRYDATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
  AND RIGHT(PRODUCT_CODE,3) = 'FUT'  
) C  
WHERE ASSET_CODE = BSECODE*/  
  
UPDATE #DELIVERY_POSITION     
SET DEL_PRICE = CL_RATE  
FROM BSEDB_AB.DBO.CLOSING (NOLOCK)    
WHERE SYSDATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'      
AND SCRIP_CD = BSECODE    
  
SET @SYSTEMDATE = GETDATE()  
  
/*UPDATE #DELIVERY_POSITION SET      
BROKERAGE= (CASE WHEN DEL_QTY > 0 THEN            
    ((FLOOR(( ((B.DAY_SALES * DEL_PRICE*DEL_QTY)/100) *            
    POWER(10,B.ROUND_TO)+B.ROFIG + B.ERRNUM ) /                  
   (B.ROFIG + B.NOZERO )) * (B.ROFIG +B.NOZERO ) )  /                 
   POWER(10,B.ROUND_TO))              
   ELSE            
   ((FLOOR(( ((B.DAY_PUC * DEL_PRICE*ABS(DEL_QTY))/100) *            
   POWER(10,B.ROUND_TO)+B.ROFIG + B.ERRNUM ) /                  
   (B.ROFIG + B.NOZERO )) * (B.ROFIG +B.NOZERO ) )  /                 
     POWER(10,B.ROUND_TO))              
  END)  
FROM   
 BROKTABLE B (NOLOCK),   
 CLIENT1 C1 (NOLOCK),   
 CLIENT2  C2 (NOLOCK),   
 FOCLIENTBROKSCHEME (NOLOCK)  
WHERE  
 C1.CL_CODE=C2.CL_CODE AND   
 C2.PARTY_CODE = #DELIVERY_POSITION.PARTY_CODE AND      
 @SAUDA_DATE BETWEEN  DATE_FROM AND DATE_TO AND     
 #DELIVERY_POSITION.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND     
 B.TABLE_NO = COMM_DEL_BROKTABLE AND            
 B.LINE_NO  =     
 (    
  SELECT MIN(LINE_NO) FROM BROKTABLE (NOLOCK)            
  WHERE TRD_DEL NOT IN ('F','S')    
  AND TABLE_NO = COMM_DEL_BROKTABLE    
  AND DEL_PRICE <= BROKTABLE.UPPER_LIM    
 )    
  
UPDATE #DELIVERY_POSITION SET      
SERVICE_TAX = BROKERAGE  * FOGLOBALS.SERVICE_TAX /100  
FROM FOGLOBALS (NOLOCK)  
WHERE @SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
*/  
     
/*------------- POPULATING THE RECORDS INTO DEL POSITION TABLE-------------*/  
  
DELETE DELIVERY_POSITION  
WHERE SAUDA_DATE = @SAUDA_DATE  
  
INSERT INTO DELIVERY_POSITION  
SELECT   
 @SAUDA_DATE,@SETT_TYPE,@SETT_NO,  
 PARTY_CODE,  
 SELL_BUY = CASE WHEN DEL_QTY > 0 THEN 1 ELSE 2 END,  
 EXPIRYDATE=@SAUDA_DATE +' 23:59',  
 BSECODE,  
 DEL_QTY=ABS(DEL_QTY),DEL_PRICE,  
 BROKERAGE,SERVICE_TAX,  
 UPDATED_BY=@USERID,  
 UPDATED_ON=@SYSTEMDATE  
FROM #DELIVERY_POSITION  
  
/*------------- POPULATING THE RECORDS INTO BSE CM DEL TABLES -------------*/  
DECLARE @MEMBERCODE VARCHAR(10)  
SELECT @MEMBERCODE = MEMBERCODE FROM BSEDB_AB.DBO.OWNER (NOLOCK)  
  
DELETE BSEDB_AB.DBO.DELIVERYCLT WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
DELETE BSEDB_AB.DBO.DELNET WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
  
INSERT INTO BSEDB_AB.DBO.DELIVERYCLT  
SELECT   
 @SETT_NO,@SETT_TYPE,  
 BSECODE, SERIES ='BSE',  
 D.PARTY_CODE,DEL_QTY=ABS(DEL_QTY),  
 INOUT = CASE WHEN DEL_QTY > 0 THEN 'O' ELSE 'I' END,  
 BRANCH_CD,@MEMBERCODE  
FROM   
 #DELIVERY_POSITION D,  
 CLIENT1 C1 (NOLOCK),  
 CLIENT2 C2 (NOLOCK)  
WHERE   
 C1.CL_CODE = C2.CL_CODE  
 AND C2.PARTY_CODE = D.PARTY_CODE  
    
INSERT INTO BSEDB_AB.DBO.DELNET  
SELECT   
 @SETT_NO,@SETT_TYPE,  
 BSECODE,SERIES ='BSE',  
 DEL_QTY = ABS(SUM(DEL_QTY)),  
 INOUT = CASE WHEN SUM(DEL_QTY) > 0 THEN 'O' ELSE 'I' END  
FROM  
 #DELIVERY_POSITION   
GROUP BY  
 BSECODE  
HAVING SUM(DEL_QTY) <> 0   
  
DROP TABLE #DELIVERY_POSITION  
  
/*------------------------------- END OF THE PROC --------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_DASDATAGEN
-- --------------------------------------------------
--EXEC PR_FO_DASDATAGEN 'MAR  9 2007','00','ZZ','BACK-END'  
  
CREATE PROCEDURE [DBO].[PR_FO_DASDATAGEN]  
(  
@FDATE DATETIME,  
@FPARTY VARCHAR(50),  
@TPARTY VARCHAR(50),  
@STATUSNAME VARCHAR(20)  
)  

AS  

DECLARE 
@STARTTIME VARCHAR(20), 
@ENDTIME VARCHAR(20) 

SELECT @STARTTIME = CONVERT(VARCHAR,GETDATE(),109)

EXEC PR_FO_TRADE_DETAILS_DAS_UP @FDATE,@FPARTY,@TPARTY,@STATUSNAME   
  
EXEC PR_FO_OPEN_POSITION_DAS_UP @FDATE,@FPARTY,@TPARTY,@STATUSNAME   
  
EXEC PR_LEDGER_DETAILS_DAS_GET @FDATE,@FPARTY,@TPARTY,@STATUSNAME   

SELECT @ENDTIME = CONVERT(VARCHAR,GETDATE(),109)

SELECT @STARTTIME, @ENDTIME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_LEDGER_DETAILS_DAS_UP
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[PR_FO_LEDGER_DETAILS_DAS_UP]             
(            
    @FDATE VARCHAR(11),             
    @FPARTY VARCHAR(10),             
    @TPARTY VARCHAR(10)             
)            
            
/*==========================================================    
EXEC PR_FO_LEDGER_DETAILS_DAS_UP             
    @SDATE  = 'MAY 27 2005',             
    @FPARTY = 'AHAM001',     
    @TPARTY = 'AHAM001'     
==========================================================*/    
    
    
AS            
            
SELECT                   
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                  
 LEDDD_SAUDA_DATE = @FDATE,                
 LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),                  
 LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),                  
 LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),                  
 LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),                  
 LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),                  
 LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),                  
 LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),                  
 LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),                  
 LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),                  
 LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),                  
 LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),                  
 LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),                  
 LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),                
 LEDDD_CREATED_BY = 'BACK-END',                
 LEDDD_CREATED_DT = GETDATE()                  
 FROM                 
 LEDGER_DETAILS_DAS                  
 WHERE             
    LEDDD_SAUDA_DATE LIKE @FDATE +'%'             
    AND LEDDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
    GROUP BY LEDDD_PARTY_CODE           
    ORDER BY LEDDD_PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_OPEN_POSITION_DAS_GET
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[PR_FO_OPEN_POSITION_DAS_GET]           
(          
    @SDATE VARCHAR(11),           
    @FPARTY VARCHAR(10),           
    @TPARTY VARCHAR(10)           
)          
          
AS          


          
SELECT           
    FOPDD_PARTY_CODE,           
    FOPDD_INST_TYPE,           
    FOPDD_SYMBOL,           
    FOPDD_STRIKE_PRICE,           
    FOPDD_OPTION_TYPE,   
    FOPDD_INTFLAG,          
    FOPDD_EXPIRYDATE = LEFT(FOPDD_EXPIRYDATE,11),           
    FOPDD_SEC_NAME,           
    FOPDD_OPENING_PQTY, 
    FOPDD_OPENING_SQTY, 
		FOPDD_TODAY_PQTY , 
		FOPDD_TODAY_SQTY , 
		FOPDD_EXERCISEDQTY , 
		FOPDD_ASSIGNEDQTY , 
		FOPDD_INS_PQTY , 
		FOPDD_INS_SQTY , 
		FOPDD_CLOSING_PQTY , 
		FOPDD_CLOSING_SQTY , 
	FOPDD_EXPQTY, 
		FOPDD_AUTOCORPQTY , 
		FOPDD_LONGVALUE , 
		FOPDD_SHORTVALUE , 
    FOPDD_CLOSINGPRICE ,         
    FOPDD_STLMNTPRICE  ,          
    FOPDD_FLAG         ,        
    FOPDD_SAUDA_DATE   ,     FOPDD_CREATED_BY   ,        
    FOPDD_CREATED_DT = LEFT(FOPDD_CREATED_DT,11)           
FROM           
FO_POS_DETAILS_DAS           
WHERE           
    FOPDD_SAUDA_DATE LIKE @SDATE +'%'           
    AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY             
ORDER BY           
    FOPDD_PARTY_CODE,           
    FOPDD_FLAG,             
    FOPDD_INST_TYPE,           
    FOPDD_SYMBOL,           
    FOPDD_STRIKE_PRICE,           
    FOPDD_OPTION_TYPE ,         
    FOPDD_EXPIRYDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_OPEN_POSITION_DAS_UP
-- --------------------------------------------------

/*-------------------------------------------------------*/

CREATE PROCEDURE PR_FO_OPEN_POSITION_DAS_UP                             
(                              
    @SDATE VARCHAR(11),                               
    @FPARTY VARCHAR(10),                               
    @TPARTY VARCHAR(10),                               
    @UNAME VARCHAR(10)                               
)                              
                              
AS                              
                              
/*=========================================================================================================                              
PROCEDURE NAME: PR_FO_TRADE_DETAILS_DAS_UP                              
PROCEDURE DESC: PROCEDURE TO POPULATE NSEFO TRADE DETAILS TO BE DISPLAYED IN DAS REPORT.                              
  OPEN POS SP'S ARE                          
  01--SP_HELPTEXT FODAILYOPENPOSITION                          
  02--SP_HELPTEXT FODAILYCFPOSITION                          
  03--SP_HELPTEXT FODAILYOPENPOSITION                          
  04--SP_HELPTEXT FODAILYCFPOSITION                          
  
/*  
EXEC DKM_PR_FO_OPEN_POSITION_DAS_UP_INI 'MAR 28 2007','1851732','1851732',''       
*/  
=========================================================================================================*/                              
                              
SET NOCOUNT ON                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                              
    DELETE                               
    FROM                               
       FO_POS_DETAILS_DAS                               
    WHERE                               
        FOPDD_SAUDA_DATE  BETWEEN @SDATE AND @SDATE + ' 23:59'                               
        AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY                                 
                              
                              
/*=========================================================================================================                              
    01 - FODAILYOPENPOSITION - FUT                          
=========================================================================================================*/                              
                                 
INSERT                               
INTO                               
FO_POS_DETAILS_DAS                               
SELECT                               
 FOPDD_PARTY_CODE = PARTY_CODE,   
 FOPDD_INST_TYPE  = PRODUCT_CODE,   
 FOPDD_SYMBOL  = SERIES_CODE,   
 FOPDD_STRIKE_PRICE = STRIKE_PRICE,   
 FOPDD_OPTION_TYPE = PRODUCT_TYPE,   
 FOPDD_INTFLAG    = '',                            
 FOPDD_EXPIRYDATE = LEFT(EXPIRYDATE,11),   
 FOPDD_SEC_NAME      = LTRIM(RTRIM(SERIES_CODE)) + LTRIM(RTRIM(PRODUCT_CODE)) + LEFT(EXPIRYDATE,11),                          
 FOPDD_OPENING_PQTY = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'   
     THEN PQTY-SQTY ELSE 0 END)) > 0 THEN   
     (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_OPENING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) < 0 THEN   
     ABS(SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_TODAY_PQTY = (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)),  
 FOPDD_TODAY_SQTY = (SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)),  
 FOPDD_EXERCISEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND RIGHT(PRODUCT_CODE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN SQTY ELSE 0 END)),  
 FOPDD_ASSIGNEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND RIGHT(PRODUCT_CODE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN SQTY ELSE 0 END)),  
 FOPDD_CLOSING_PQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END,   
 FOPDD_CLOSING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END,   
 FOPDD_EXPQTY  = SUM(CASE WHEN TRADETYPE = 'BT' AND RIGHT(PRODUCT_CODE,3)='FUT'   
     AND AUCTIONPART ='EA' THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_AUTOCORPQTY = SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART ='EA'    
     AND LEFT(EXPIRYDATE,11) <> @SDATE THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_LONGVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END) * CL_RATE,  
 FOPDD_SHORTVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END) * CL_RATE,   
/*  
 FOPDD_LONGVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END),  
 FOPDD_SHORTVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END),   
*/  
 FOPDD_CLOSINGPRICE  = CL_RATE,  
 FOPDD_STLMNTPRICE  = CL_RATE,   
/* FOPDD_STLMNTPRICE  = ABS((CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -   
     SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 THEN   
     ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) -   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) /   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -   
     SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)), */  
 FOPDD_FLAG         = '01' ,                          
 FOPDD_SAUDA_DATE   = @SDATE ,                  
 FOPDD_CREATED_BY   = @UNAME,                  
 FOPDD_CREATED_DT   = GETDATE()                             
FROM  
 BFOBILLVALAN (NOLOCK)  
WHERE   
 LEFT(SAUDA_DATE,11) = @SDATE   
 AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 AND RIGHT(PRODUCT_CODE,3) = 'FUT'  
GROUP BY  
 PARTY_CODE,   
 PRODUCT_CODE,   
 SERIES_CODE,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 PRODUCT_TYPE,  
 CL_RATE  
ORDER BY   
 PARTY_CODE,   
 PRODUCT_CODE,   
 SERIES_CODE,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 PRODUCT_TYPE  
  
                             
/*=========================================================================================================                              
    03 - FODAILYOPENPOSITION - OPT                           
=========================================================================================================*/                              
                              
INSERT                               
INTO                   
FO_POS_DETAILS_DAS                               
SELECT                               
 FOPDD_PARTY_CODE = PARTY_CODE,   
 FOPDD_INST_TYPE  = PRODUCT_CODE,   
 FOPDD_SYMBOL  = SERIES_CODE,   
 FOPDD_STRIKE_PRICE = STRIKE_PRICE,   
 FOPDD_OPTION_TYPE = PRODUCT_TYPE,   
 FLAG=(CASE WHEN RIGHT(OPTION_TYPE,1) = 'C'  AND SUM(PQTY) - SUM(SQTY) > 0 THEN                                  
  (CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CL_RATE) THEN                                  
   'OUT'                                  
  ELSE                                  
   CASE WHEN MAX(CL_RATE)+STRIKE_PRICE > MAX(CL_RATE) THEN                                  
    'IN'                                  
   ELSE                                  
    'AT'                                  
   END                                  
                                    
  END)                                  
 ELSE                                  
  CASE WHEN RIGHT(OPTION_TYPE,1) = 'C'   AND SUM(PQTY) - SUM(SQTY) < 0 THEN                                  
   (CASE WHEN MAX(CL_RATE)+ STRIKE_PRICE > MAX(CL_RATE) THEN                                  
    'OUT'                                  
   ELSE                                  
    CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CL_RATE) THEN                                  
  'IN'                                  
    ELSE                                  
  'AT'                                  
    END                                   
   END)                                   
  ELSE                                  
   CASE WHEN  RIGHT(OPTION_TYPE,1) = 'P'  AND SUM(PQTY) - SUM(SQTY) > 0 THEN                                  
    (CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CL_RATE) THEN               
  'OUT'                                  
    ELSE                                  
  CASE WHEN MAX(CL_RATE)+STRIKE_PRICE > MAX(CL_RATE) THEN                                  
   'IN'                                  
  ELSE                                  
   'AT'                                  
  END                                  
    END)                                   
   ELSE                                  
    CASE WHEN RIGHT(OPTION_TYPE,1) = 'P'   AND SUM(PQTY) - SUM(SQTY) < 0 THEN                                  
  (CASE WHEN MAX(CL_RATE)+STRIKE_PRICE > MAX(CL_RATE) THEN                           
   'OUT'                                  
   ELSE                                  
    CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CL_RATE) THEN                                  
     'IN'                                  
    ELSE                                  
     'AT'                                  
    END                                   
  END)                                  
    END                                  
   END                                    
  END                                   
 END),   
 FOPDD_EXPIRYDATE = LEFT(EXPIRYDATE,11),   
 FOPDD_SEC_NAME      = LTRIM(RTRIM(SERIES_CODE)) + LTRIM(RTRIM(PRODUCT_CODE)) + LEFT(EXPIRYDATE,11),                          
 FOPDD_OPENING_PQTY = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'   
     THEN PQTY-SQTY ELSE 0 END)) > 0 THEN   
     (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_OPENING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) < 0 THEN   
     ABS(SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_TODAY_PQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = '' THEN PQTY ELSE 0 END)),  
 FOPDD_TODAY_SQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = '' THEN SQTY ELSE 0 END)),  
 FOPDD_EXERCISEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND RIGHT(PRODUCT_CODE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN SQTY ELSE 0 END)),  
 FOPDD_ASSIGNEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND RIGHT(PRODUCT_CODE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN SQTY ELSE 0 END)),  
 FOPDD_CLOSING_PQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END,   
 FOPDD_CLOSING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END,   
 FOPDD_EXPQTY  = SUM(CASE WHEN TRADETYPE = 'BT' AND RIGHT(PRODUCT_CODE,3)='FUT'   
     AND AUCTIONPART ='EA' THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_AUTOCORPQTY = SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = 'CA'    
     AND LEFT(EXPIRYDATE,11) <> @SDATE + '%' THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_LONGVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END) * CL_RATE,   
 FOPDD_SHORTVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END) * CL_RATE,   
/*  
 FOPDD_LONGVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END),  
 FOPDD_SHORTVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END),  
*/   
 FOPDD_CLOSINGPRICE  = CL_RATE,  
 FOPDD_STLMNTPRICE  = CL_RATE,   
/* FOPDD_STLMNTPRICE  = ABS((CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -   
     SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 THEN   
     ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) -   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) /   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -   
     SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)), */  
 FOPDD_FLAG         = '03' ,                          
 FOPDD_SAUDA_DATE   = @SDATE ,                  
 FOPDD_CREATED_BY   = @UNAME,                  
 FOPDD_CREATED_DT   = GETDATE()                             
FROM  
 BFOBILLVALAN (NOLOCK)  
WHERE   
 LEFT(SAUDA_DATE,11) = @SDATE   
 AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 AND RIGHT(PRODUCT_CODE,3) = 'OPT'  
GROUP BY  
 PARTY_CODE,   
 PRODUCT_CODE,   
 SERIES_CODE,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 PRODUCT_TYPE,   
 CL_RATE   ,
 OPTION_TYPE
ORDER BY   
 PARTY_CODE,   
 PRODUCT_CODE,   
 SERIES_CODE,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 PRODUCT_TYPE  
                                  
 
    
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_TRADE_DETAILS_DAS_GET
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[PR_FO_TRADE_DETAILS_DAS_GET]           
(          
    @SDATE VARCHAR(11),           
    @FPARTY VARCHAR(10),           
    @TPARTY VARCHAR(10)           
)          
          
/*==========================================================  
EXEC PR_FO_TRADE_DETAILS_DAS_GET           
    @SDATE = 'MAY 27 2005',           
    @FPARTY = 'AHAM001',   
    @TPARTY = 'AHAM001'   
==========================================================*/  
  
  
AS          
          
SELECT           
    FOTDD_PARTY_CODE,           
    FOTDD_INST_TYPE,           
    FOTDD_SYMBOL,           
    FOTDD_STRIKE_PRICE,           
    FOTDD_OPTION_TYPE,           
    FOTDD_EXPIRY_DATE = LEFT(FOTDD_EXPIRY_DATE,11),           
    FOTDD_SEC_NAME,           
    FOTDD_TRADEQTY,           
    FOTDD_VALUE,           
    FOTDD_PRICE,           
    FOTDD_PQTY,           
    FOTDD_SQTY,           
    FOTDD_PAMT,           
    FOTDD_SAMT,           
    FOTDD_NETRATE,           
    FOTDD_CFPPRICE,           
    FOTDD_CFSPRICE,           
    FOTDD_SETTPRICE,           
    FOTDD_SAUDA_DATE = LEFT(FOTDD_SAUDA_DATE,11),           
    FOTDD_PNETRATE,           
    FOTDD_SNETRATE,           
    FOTDD_CHARGES,           
    FOTDD_BROKERAGE,           
    FOTDD_SERVICE_TAX,           
    FOTDD_BROKER_NOTE,           
    FOTDD_TURN_TAX,           
    FOTDD_SEBI_TAX,           
    FOTDD_CONTRACTNO,           
    FOTDD_PCOMM,           
    FOTDD_SCOMM,           
    FOTDD_INS_CHRG,           
    FOTDD_FLAG = LEFT(FOTDD_FLAG,2),   
    TRADE_TYPE = RIGHT(FOTDD_FLAG,2),   
    FOTDD_O_C_FLAG,           
    FOTDD_AUCTIONPART,           
    FOTDD_CREATED_BY,           
    FOTDD_CREATED_DT = LEFT(FOTDD_CREATED_DT,11)           
FROM           
    FO_TRADE_DETAILS_DAS           
WHERE           
    FOTDD_SAUDA_DATE LIKE @SDATE +'%'           
    AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY             
ORDER BY           
    FOTDD_PARTY_CODE,         
    LEFT(FOTDD_FLAG,2),         
--    FOTDD_O_C_FLAG,         
    FOTDD_INST_TYPE,         
    FOTDD_SYMBOL,         
    FOTDD_STRIKE_PRICE,         
    FOTDD_OPTION_TYPE,         
    FOTDD_EXPIRY_DATE,   
    TRADE_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_TRADE_DETAILS_DAS_UP
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[PR_FO_TRADE_DETAILS_DAS_UP]             
(            
    @SDATE VARCHAR(11),             
    @FPARTY VARCHAR(10),             
    @TPARTY VARCHAR(10),             
    @UNAME VARCHAR(10)             
)            
            
AS            
            
/*=========================================================================================================            
PROCEDURE NAME: PR_FO_TRADE_DETAILS_DAS_UP            
PROCEDURE DESC: PROCEDURE TO POPULATE NSEFO TRADE DETAILS TO BE DISPLAYED IN DAS REPORT.            
PROCEDURE SUMMARY:             
    01-TRADES CONFIRMATION - FUTURES            
    02-TRADES CONFIRMATION - OPTIONS            
    03-EXERCISE/ASSIGNMENT OF POSITIONS            
    MARK TO MARKET STATEMENT            
        04-TRADETYPE       = 'BF'            
        05-TRADETYPE       = 'BT'            
        06-CARRY FORWARD RECORDS            
    07-CORPORATE ACTION ADJUSTMENTS OF POSITIONS            
      
EXEC PR_FO_TRADE_DETAILS_DAS_UP             
    @SDATE = 'MAY 27 2005',             
    @FPARTY = '0',             
    @TPARTY = 'ZZZ',             
    @UNAME = 'BACKEND'      
=========================================================================================================*/            
            
DECLARE             
    @MEMBERCODE AS VARCHAR(12)              
            
SET NOCOUNT ON            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
            
    DELETE             
    FROM             
        FO_TRADE_DETAILS_DAS             
    WHERE             
        FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'       
        AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
            
            
/*=========================================================================================================            
    01-TRADES CONFIRMATION - FUTURES            
=========================================================================================================*/            
            
SELECT             
    PARTY_CODE,             
    PRODUCT_CODE,             
    SERIES_CODE,             
    EXPDATE,             
    PQTY,             
    SQTY,             
    PAMT,             
    SAMT,             
    PNETRATE,             
    SNETRATE,             
    CHARGES,             
    BROKERAGE,             
    SERVICE_TAX,             
    BROKER_NOTE,             
    TURN_TAX,             
    SEBI_TAX,             
    CONTRACTNO,             
    PCOMM,             
    SCOMM,             
    INS_CHRG             
INTO             
    #FODAILYCONFIRM             
FROM             
    (             
    SELECT             
        S.PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE = LEFT(EXPIRYDATE, 11),             
        PQTY,             
        SQTY,             
        PAMT     = PAMT-PBROKAMT,             
        SAMT     = SAMT+SBROKAMT,             
        PNETRATE = PRATE,             
        SNETRATE = SRATE,             
        PCOMM    =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (PBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT) END             
                ELSE PBROKAMT END               
        )            
        ,             
        SCOMM =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (SBROKAMT) + SERVICE_TAX             
                    ELSE (SBROKAMT) END             
                ELSE SBROKAMT END               
)        
        ,             
        CHARGES = (PBROKAMT+SBROKAMT) +             
(         
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN (SERVICE_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN (TURN_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
               WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        BROKERAGE =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (PBROKAMT+SBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT+SBROKAMT) END             
              ELSE PBROKAMT+SBROKAMT END               
        )            
        ,             
        SERVICE_TAX =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 0             
                THEN (SERVICE_TAX)             
                ELSE 0 END             
        )            
        ,             
        BROKER_NOTE =             
       (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        TURN_TAX =             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN ( TURN_TAX)             
                ELSE 0 END               
        )            
        ,             
        SEBI_TAX =             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )            
        ,             
        CONTRACTNO,             
        INS_CHRG =             
        (               
            CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN INS_CHRG             
                ELSE 0 END             
        )             
    FROM             
        BFOBILLVALAN S WITH(NOLOCK)            
        ,             
        CLIENT2 C2 WITH(NOLOCK)             
    WHERE             
        SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'       
        AND C2.PARTY_CODE = S.PARTY_CODE             
        AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
        AND RIGHT(PRODUCT_CODE, 3) = 'FUT'             
        AND TRADETYPE          = 'BT'             
    ) S               
              
              
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = PRODUCT_CODE,             
        FOTDD_SYMBOL = SERIES_CODE,             
        FOTDD_STRIKE_PRICE = 0,             
        FOTDD_OPTION_TYPE = '',             
        FOTDD_EXPIRY_DATE = EXPDATE,             
        FOTDD_SEC_NAME = '',             
        FOTDD_TRADEQTY = 0,             
        FOTDD_VALUE = 0,             
        FOTDD_PRICE = 0,             
        FOTDD_PQTY = SUM(PQTY),             
        FOTDD_SQTY = SUM(SQTY),             
        FOTDD_PAMT = SUM(PAMT),        
    FOTDD_SAMT = SUM(SAMT),             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = 0,            
        FOTDD_CFSPRICE = 0,             
        FOTDD_SETTPRICE = 0,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE =             
        (            
            CASE             
            WHEN SUM(PQTY) > 0             
            THEN SUM(PAMT)/SUM(PQTY)             
            ELSE 0 END             
        ),             
        FOTDD_SNETRATE =             
        (            
            CASE             
            WHEN SUM(SQTY) > 0             
            THEN SUM(SAMT)/SUM(SQTY)             
            ELSE 0 END             
        ),             
        FOTDD_CHARGES = SUM(CHARGES),             
        FOTDD_BROKERAGE = SUM(BROKERAGE),             
        FOTDD_SERVICE_TAX = SUM(SERVICE_TAX),             
        FOTDD_BROKER_NOTE = SUM(BROKER_NOTE),             
        FOTDD_TURN_TAX = SUM(TURN_TAX),             
        FOTDD_SEBI_TAX = SUM(SEBI_TAX),             
        FOTDD_CONTRACTNO = CONTRACTNO,             
        FOTDD_PCOMM = SUM(PCOMM),             
        FOTDD_SCOMM = SUM(SCOMM),             
        FOTDD_INS_CHRG = SUM(INS_CHRG),             
        FOTDD_FLAG = '01',             
        FOTDD_O_C_FLAG = '',             
        FOTDD_AUCTIONPART = '',             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM             
        #FODAILYCONFIRM WITH(NOLOCK)             
    GROUP BY             
        PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE,             
        CONTRACTNO             
--    ORDER BY PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, SAUDA_DATE               
              
            
/*=========================================================================================================            
    02-TRADES CONFIRMATION - OPTIONS            
=========================================================================================================*/            
            
SELECT             
    PARTY_CODE,             
    PRODUCT_CODE,             
    SERIES_CODE,             
    EXPDATE,             
    PQTY,             
    SQTY,             
    PAMT,             
    SAMT,             
    PNETRATE,             
    SNETRATE,             
    CHARGES,             
    BROKERAGE,             
    SERVICE_TAX,             
    BROKER_NOTE,             
    TURN_TAX,             
    SEBI_TAX,           
    STRIKE_PRICE,             
    PRODUCT_TYPE,             
    CONTRACTNO,             
    PCOMM,             
    SCOMM,             
    INS_CHRG             
INTO             
    #FODAILYCONFIRM_OPT             
FROM             
    (             
    SELECT             
        S.PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE = LEFT(EXPIRYDATE, 11),             
        PQTY,             
        SQTY,             
        PAMT     = PQTY* PRATE,             
        SAMT     = SQTY* SRATE,             
        PNETRATE = PRATE,             
        SNETRATE = SRATE,             
        PCOMM    =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
    THEN (PBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT) END             
                ELSE PBROKAMT END               
        )            
        ,             
        SCOMM =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (SBROKAMT) + SERVICE_TAX             
             ELSE (SBROKAMT) END             
                ELSE SBROKAMT END               
        )     
        ,            
        CHARGES = (PBROKAMT+SBROKAMT) +             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN (SERVICE_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN (TURN_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        BROKERAGE =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (PBROKAMT+SBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT+SBROKAMT) END             
                ELSE PBROKAMT+SBROKAMT END               
        )            
        ,             
        SERVICE_TAX =                   
 (               
            CASE             
                WHEN C2.SERVICE_CHRG = 0             
                THEN (SERVICE_TAX)             
                ELSE 0 END             
        )            
        ,             
        BROKER_NOTE =             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        TURN_TAX =             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN ( TURN_TAX)             
                ELSE 0 END               
        )            
        ,             
        SEBI_TAX =             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )            
        ,             
        INS_CHRG =             
        (               
     CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN INS_CHRG             
                ELSE 0 END             
        )            
        ,             
        CONTRACTNO,             
        STRIKE_PRICE,             
        PRODUCT_TYPE             
    FROM             
        BFOBILLVALAN S WITH(NOLOCK),             
        CLIENT2 C2 WITH(NOLOCK)             
    WHERE             
        SAUDA_DATE  BETWEEN @SDATE AND @SDATE + ' 23:59'            
        AND C2.PARTY_CODE = S.PARTY_CODE             
        AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
        AND RIGHT(PRODUCT_CODE, 3) = 'OPT'             
        AND S.AUCTIONPART NOT IN ('EA', 'CA')             
        AND TRADETYPE = 'BT'             
    ) F              
            
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = PRODUCT_CODE,             
        FOTDD_SYMBOL = SERIES_CODE,             
        FOTDD_STRIKE_PRICE = STRIKE_PRICE,             
        FOTDD_OPTION_TYPE = PRODUCT_TYPE,             
        FOTDD_EXPIRY_DATE = EXPDATE,             
        FOTDD_SEC_NAME = '',             
        FOTDD_TRADEQTY = 0,             
        FOTDD_VALUE = 0,             
        FOTDD_PRICE = 0,             
        FOTDD_PQTY = SUM(PQTY),             
        FOTDD_SQTY = SUM(SQTY),             
        FOTDD_PAMT = SUM(PAMT),             
        FOTDD_SAMT = SUM(SAMT),             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = 0,            
        FOTDD_CFSPRICE = 0,             
        FOTDD_SETTPRICE = 0,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE =             
        (            
            CASE             
            WHEN SUM(PQTY) > 0             
            THEN SUM(PAMT)/SUM(PQTY)             
            ELSE 0 END             
        ),             
        FOTDD_SNETRATE =             
        (            
            CASE             
            WHEN SUM(SQTY) > 0             
            THEN SUM(SAMT)/SUM(SQTY)             
            ELSE 0 END             
        ),             
        FOTDD_CHARGES = SUM(CHARGES),             
        FOTDD_BROKERAGE = SUM(BROKERAGE),             
        FOTDD_SERVICE_TAX = SUM(SERVICE_TAX),             
        FOTDD_BROKER_NOTE = SUM(BROKER_NOTE),             
        FOTDD_TURN_TAX = SUM(TURN_TAX),             
        FOTDD_SEBI_TAX = SUM(SEBI_TAX),             
        FOTDD_CONTRACTNO = CONTRACTNO,             
        FOTDD_PCOMM = SUM(PCOMM),             
        FOTDD_SCOMM = SUM(SCOMM),             
        FOTDD_INS_CHRG = SUM(INS_CHRG),             
        FOTDD_FLAG = '02',             
        FOTDD_O_C_FLAG = '',             
        FOTDD_AUCTIONPART = '',             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM             
        #FODAILYCONFIRM_OPT             
    GROUP BY             
        PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE,             
        CONTRACTNO,             
        PRODUCT_TYPE,             
        STRIKE_PRICE             
--    ORDER BY PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, SAUDA_DATE              
            
            
/*=========================================================================================================            
    03-EXERCISE/ASSIGNMENT OF POSITIONS            
=========================================================================================================*/            
            
INSERT             
INTO             
    FO_TRADE_DETAILS_DAS             
SELECT             
    FOTDD_PARTY_CODE   = PARTY_CODE,             
    FOTDD_INST_TYPE    = PRODUCT_CODE,             
    FOTDD_SYMBOL       = SERIES_CODE,             
    FOTDD_STRIKE_PRICE = STRIKE_PRICE,             
    FOTDD_OPTION_TYPE  = PRODUCT_TYPE,             
    FOTDD_EXPIRY_DATE  = EXPDATE,             
    FOTDD_SEC_NAME     = '',             
    FOTDD_TRADEQTY     = 0,             
    FOTDD_VALUE        = 0,             
    FOTDD_PRICE        = TRADE_PRICE,             
    FOTDD_PQTY         = PQTY,             
    FOTDD_SQTY         = SQTY,             
    FOTDD_PAMT         = PAMT,             
    FOTDD_SAMT         = SAMT,             
    FOTDD_NETRATE      = NETRATE,             
    FOTDD_CFPPRICE     = 0,             
    FOTDD_CFSPRICE     = 0,             
    FOTDD_SETTPRICE    = SETTPRICE,             
    FOTDD_SAUDA_DATE   = @SDATE,             
    FOTDD_PNETRATE     = 0,             
    FOTDD_SNETRATE     = 0,             
    FOTDD_CHARGES      = CHARGES,             
    FOTDD_BROKERAGE    = BROKERAGE,             
    FOTDD_SERVICE_TAX  = SERVICE_TAX,             
    FOTDD_BROKER_NOTE  = BROKER_NOTE,             
    FOTDD_TURN_TAX     = TURN_TAX,             
    FOTDD_SEBI_TAX     = SEBI_TAX,             
    FOTDD_CONTRACTNO   = '',             
    FOTDD_PCOMM        = 0,             
    FOTDD_SCOMM        = 0,             
    FOTDD_INS_CHRG     = INS_CHRG,             
    FOTDD_FLAG         = '03',             
    FOTDD_O_C_FLAG     = '',             
 FOTDD_AUCTIONPART  = '',             
    FOTDD_CREATED_BY   = @UNAME,             
    FOTDD_CREATED_DT   = GETDATE()             
FROM             
    (             
    SELECT             
        S.PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE = LEFT(EXPIRYDATE, 11),             
        STRIKE_PRICE,             
        PRODUCT_TYPE,             
        PQTY =             
        (               
            CASE             
                WHEN SELL_BUY = 1             
                THEN SUM(TRADEQTY)             
                ELSE 0 END               
        )            
        ,             
        PAMT =             
        (               
            CASE             
                WHEN SELL_BUY = 1             
                THEN SUM(TRADEQTY*TRADE_PRICE)             
                ELSE 0 END               
        )            
        ,             
        SQTY =             
        (               
            CASE             
                WHEN SELL_BUY = 2             
                THEN SUM(TRADEQTY)             
                ELSE 0 END               
        )            
        ,             
        SAMT =             
        (               
            CASE     
                WHEN SELL_BUY = 2             
                THEN SUM(TRADEQTY*TRADE_PRICE)             
                ELSE 0 END               
        )            
        ,             
        NETRATE   = TRADE_PRICE,             
        SETTPRICE = TRADE_PRICE,             
        CHARGES   = SUM(BROKAPPLIED*TRADEQTY) +             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN SUM(SERVICE_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN SUM(TURN_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN SUM(SEBI_TAX)             
                ELSE 0 END               
        )             
        +             
        (              
            CASE             
                WHEN BROKERNOTE = 1             
                THEN SUM(BROKER_CHRG)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN SUM(INS_CHRG)             
                ELSE 0 END             
        )            
        ,             
        BROKERAGE   = SUM(BROKAPPLIED*TRADEQTY),             
        SERVICE_TAX =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN SUM(SERVICE_TAX)             
                ELSE 0 END             
        )            
        ,             
        BROKER_NOTE =             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN SUM(BROKER_CHRG)             
                ELSE 0 END               
        )            
        ,             
        TURN_TAX =             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN SUM(TURN_TAX)             
                ELSE 0 END               
        )            
        ,             
        SEBI_TAX =             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN SUM(SEBI_TAX)             
                ELSE 0 END               
        )            
        ,             
        INS_CHRG =             
        (               
  CASE             
       WHEN INSURANCE_CHRG = 1             
                THEN SUM(INS_CHRG)             
   ELSE 0 END             
      )            
        ,             
        TRADE_PRICE             
    FROM             
        BFOSETTLEMENT S WITH(NOLOCK),             
        CLIENT2 C2 WITH(NOLOCK)             
    WHERE             
        SAUDA_DATE  BETWEEN @SDATE AND @SDATE + ' 23:59'             
        AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
        AND S.PARTY_CODE       = C2.PARTY_CODE             
        AND RIGHT(PRODUCT_CODE, 3) = 'OPT'             
        AND AUCTIONPART        = 'EA'             
    GROUP BY             
        S.PARTY_CODE,             
        S.PRODUCT_CODE,             
        S.SERIES_CODE,             
        S.EXPIRYDATE,             
        S.STRIKE_PRICE,             
        S.PRODUCT_TYPE,             
        S.SELL_BUY,             
        TRADE_PRICE,             
        C2.SERVICE_CHRG,             
        TURNOVER_TAX,             
        SEBI_TURN_TAX,             
        INSURANCE_CHRG,             
        BROKERNOTE               
    ) F              
--    ORDER BY PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE               
            
            
/*=========================================================================================================            
    MARK TO MARKET STATEMENT            
    04-TRADETYPE       = 'BF'            
    05-TRADETYPE       = 'BT'            
    06-CARRY FORWARD RECORDS          =========================================================================================================*/            
            
SET @MEMBERCODE = (SELECT MEMBERCODE FROM BFOOWNER)              
              
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = PRODUCT_CODE,            
        FOTDD_SYMBOL = SERIES_CODE,             
        FOTDD_STRIKE_PRICE = 0,             
        FOTDD_OPTION_TYPE = '',             
        FOTDD_EXPIRY_DATE = EXPDATE,             
        FOTDD_SEC_NAME = '',             
        FOTDD_TRADEQTY = 0,             
        FOTDD_VALUE = 0,             
        FOTDD_PRICE = 0,             
        FOTDD_PQTY = PQTY,             
        FOTDD_SQTY = SQTY,             
        FOTDD_PAMT = PAMT,             
        FOTDD_SAMT = SAMT,             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = CFPPRICE,            
        FOTDD_CFSPRICE = CFSPRICE,             
        FOTDD_SETTPRICE = SETTPRICE,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE = 0,      
        FOTDD_SNETRATE = 0,             
        FOTDD_CHARGES = CHARGES,             
        FOTDD_BROKERAGE = 0,             
        FOTDD_SERVICE_TAX = 0,             
        FOTDD_BROKER_NOTE = 0,             
        FOTDD_TURN_TAX = 0,             
        FOTDD_SEBI_TAX = 0,             
        FOTDD_CONTRACTNO = '',             
        FOTDD_PCOMM = 0,             
        FOTDD_SCOMM = 0,             
        FOTDD_INS_CHRG = 0,             
        FOTDD_FLAG = LEFT(FLAG,4),             
        FOTDD_O_C_FLAG = '',             
        FOTDD_AUCTIONPART = '',             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM             
    (             
    SELECT             
        PQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN SUM(PQTY-SQTY)             
            ELSE 0 END            
        )            
        ,             
        SQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
THEN ABS(SUM(PQTY-SQTY))             
            ELSE 0 END            
        )            
        ,             
        PAMT =             
        (            
       CASE             
       WHEN SUM(PQTY-SQTY) > 0             
            THEN SUM(PAMT-SAMT)             
            ELSE 0 END            
        )           
        ,             
        SAMT =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM(PAMT-SAMT))             
            ELSE 0 END            
        )            
        ,             
        CHARGES = (SUM(SERVICE_TAX) - SUM(EXSER_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),             
        PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE    = LEFT(EXPIRYDATE, 11),             
        FLAG       = '04' + TRADETYPE,             
        CFPPRICE =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN SUM(PAMT-SAMT)/ABS(SUM(PQTY-SQTY))  
            ELSE 0 END             
        )            
        ,             
        CFSPRICE =             
  (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM(PAMT-SAMT))/ABS(SUM(PQTY-SQTY))             
            ELSE 0 END             
        )            
        ,             
        SETTPRICE = MAX(CL_RATE)              
    FROM             
        BFOBILLVALAN             
    WHERE             
        PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND SAUDA_DATE  BETWEEN @SDATE AND @SDATE + ' 23:59'             
        AND RIGHT(PRODUCT_CODE,3) = 'FUT'             
        AND TRADETYPE       = 'BF'             
        AND PARTICIPANTCODE = @MEMBERCODE             
    GROUP BY             
        PARTY_CODE,             
        PRODUCT_CODE,      
        SERIES_CODE,             
        LEFT(EXPIRYDATE, 11),             
        TRADETYPE             
                
    UNION ALL             
                
    SELECT             
        PQTY    = SUM(PQTY),             
        SQTY    = SUM(SQTY),             
        PAMT    = SUM(PAMT-PBROKAMT),             
        SAMT    = SUM(SAMT+SBROKAMT),             
        CHARGES = (SUM(SERVICE_TAX) - SUM(EXSER_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),             
        PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE    = LEFT(EXPIRYDATE, 11),             
        FLAG       = '04'+ TRADETYPE,                  
        CFPPRICE = MAX(PRATE),             
        CFSPRICE = MAX(SRATE),             
        SETTPRICE = MAX(CL_RATE)              
    FROM             
        BFOBILLVALAN             
    WHERE             
        PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND SAUDA_DATE  BETWEEN @SDATE AND @SDATE + ' 23:59'             
        AND RIGHT(PRODUCT_CODE,3) = 'FUT'             
        AND TRADETYPE       = 'BT'             
        AND PARTICIPANTCODE = @MEMBERCODE             
    GROUP BY             
        PARTY_CODE,             
    PRODUCT_CODE,             
        SERIES_CODE,             
        LEFT(EXPIRYDATE, 11),             
        TRADETYPE             
                
    UNION ALL             
                
    SELECT             
        PQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM(PQTY-SQTY))             
            ELSE 0 END            
        )            
        ,             
        SQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN ABS(SUM(PQTY-SQTY))             
            ELSE 0 END            
        )            
        ,             
        PAMT =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM((PQTY-SQTY)*CL_RATE))             
            ELSE 0 END            
        )            
        ,             
        SAMT =           
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
         THEN ABS(SUM(((PQTY)-(SQTY))*CL_RATE))             
            ELSE 0 END            
        )            
        ,             
        CHARGES = 0,             
        PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        EXPDATE    = LEFT(EXPIRYDATE, 11),             
        FLAG       = '04' + 'CF',             
        CFPPRICE  = 0,             
        CFSPRICE  = 0,             
        SETTPRICE = MAX(CL_RATE)             
    FROM             
        BFOBILLVALAN             
    WHERE             
        PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND SAUDA_DATE  BETWEEN @SDATE AND @SDATE + ' 23:59'             
        AND RIGHT(PRODUCT_CODE,3) = 'FUT'             
        AND PARTICIPANTCODE = @MEMBERCODE             
    GROUP BY             
        PARTY_CODE,             
        PRODUCT_CODE,             
        SERIES_CODE,             
        LEFT(EXPIRYDATE, 11)             
    HAVING             
        SUM(PQTY-SQTY) <> 0             
    ) T             
    WHERE             
    PQTY+SQTY > 0             
    --ORDER BY PRODUCT_CODE, PARTY_CODE, SERIES_CODE, EXPIRYDATE, FLAG                
            
            
/*=========================================================================================================            
    07-CORPORATE ACTION ADJUSTMENTS OF POSITIONS            
=========================================================================================================*/            
  
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = INST_TYPE,             
        FOTDD_SYMBOL = SYMBOL,             
        FOTDD_STRIKE_PRICE = STRIKE_PRICE,             
        FOTDD_OPTION_TYPE = OPTION_TYPE,             
        FOTDD_EXPIRY_DATE = EXPIRYDATE,             
        FOTDD_SEC_NAME = SYMBOL + '-' + INST_TYPE,             
        FOTDD_TRADEQTY = TRADEQTY,             
        FOTDD_VALUE = NETRATE*TRADEQTY,             
        FOTDD_PRICE = PRICE,             
        FOTDD_PQTY = 0,             
        FOTDD_SQTY = 0,             
        FOTDD_PAMT = 0,             
        FOTDD_SAMT = 0,             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = 0,            
        FOTDD_CFSPRICE = 0,             
        FOTDD_SETTPRICE = 0,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE = 0,             
        FOTDD_SNETRATE = 0,             
        FOTDD_CHARGES = 0,             
        FOTDD_BROKERAGE = 0,             
        FOTDD_SERVICE_TAX = 0,             
        FOTDD_BROKER_NOTE = 0,             
        FOTDD_TURN_TAX = 0,             
        FOTDD_SEBI_TAX = 0,             
        FOTDD_CONTRACTNO = 0,             
        FOTDD_PCOMM = 0,             
        FOTDD_SCOMM = 0,             
        FOTDD_INS_CHRG = 0,             
        FOTDD_FLAG = '07',             
        FOTDD_O_C_FLAG = O_C_FLAG,             
        FOTDD_AUCTIONPART = AUCTIONPART,             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM             
        FOSETTCORPACT WITH(NOLOCK)            
    WHERE             
        SAUDA_DATE  BETWEEN @SDATE AND @SDATE + ' 23:59'             
        AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND AUCTIONPART = 'CA'             
--    ORDER BY O_C_FLAG, SERIES_CODE, EXPIRYDATE, PRODUCT_TYPE              
            
    DROP TABLE #FODAILYCONFIRM            
    DROP TABLE #FODAILYCONFIRM_OPT            
            
      
    
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FOCORPACTADJUSTMENT
-- --------------------------------------------------



/*------------------------------------------------------------------------------------------------------------  
PROGRAM NAME : PR_FOCORPACTADJUSTMENT  
DESCRIPTION  : SQL SCRIPTS FOR NSEFO CORPORATE ACTION ADJUSTMENTS  
 @MODE  = 'UPDATE2' - POPULATING THE FINAL RECORDS AT FOSETTLEMENT - RATIO METHOD  
--------------------------------------------------------------------------------------------------------------*/  

CREATE PROC [dbo].[PR_FOCORPACTADJUSTMENT]   
(  
 @FILEDATE VARCHAR(11),  
 @TRADETYPE VARCHAR(2),  
 @MODE VARCHAR(10),  
 @ASSET_CODE VARCHAR(12),  
 @OLDLOTSIZE INT = 1,  
 @NEWLOTSIZE INT = 1,  
 @ADJFACTOR1 NUMERIC(18,8) = 1,  
 @ADJFACTOR2 NUMERIC(18,8) = 1,  
 @ROUNDING INT = 1,  
 @SAUDA_DATE VARCHAR(11) ='',  
 @ASSET_CODENEW VARCHAR(12) ='',
 @DumpInMyTable Varchar(1) = ''
) AS  
  
   
  
DECLARE @INTVBBSTAT BIGINT  
DECLARE @INTBFQTY BIGINT  -- EXISTING POSITION  
DECLARE @INTBTQTY BIGINT  -- ADJUSTED POSITION  
DECLARE @INTBFVAL MONEY  -- EXISTING VALUE  
DECLARE @INTBTVAL MONEY  -- ADJUSTED VALUE  
DECLARE @1ADJFACTOR NUMERIC (18,8)  
DECLARE @2ADJFACTOR NUMERIC (18,8)   
DECLARE @CORPACTTYPE VARCHAR(20)  
DECLARE @C_REGULAR_LOT INT   
DECLARE @MEMBERTYPE VARCHAR(15)  
DECLARE @MEMBERCODE VARCHAR(10)
DECLARE @STRRETURNFLAG INT  
DECLARE @STRRETURNMSG VARCHAR(200)  
     
    /*RATIO BASED METHOD*/  
    INSERT INTO FOSETTCORPACT  
    SELECT   
		CONTRACTNO = '0',
		TRADE_NO = '0',
		SAUDA_DATE = @SAUDA_DATE + ' 8:00 PM',
		TRADESTATUS = 'E',
		SEGMENT,
		SETT_TYPE,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		ASSET_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		SERIES_CODE,
		SERIES_ID,
		LOT_SIZE = @OLDLOTSIZE,
		SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 2 ELSE 1 END),
		TRADEQTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)),
		SETT_FLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),
		CA_LEVEL = 1,
		BROKER_CD,
		TRADE_PRICE = 0,
		LOCATIONID ='',
		CM_CODE,
		PARTICIPANTCODE,
		CP_CONFIRMATION=0,
		OC_FLAG =0,
		OLD_CP_CODE='',
		OLD_CM_CODE='',
		TERMINALID=0,
		ORDER_NO='',
		PARTY_CODE,
		REMARKS='OLD POS',
		BUY_POSITION=0,
		SELL_POSITION=0,
		PRO_CLI='',
		ORDER_TIMESTAMP='',
		ORDER_ACTIVEFLAG='',
		TABLE_NO=0,
		LINE_NO=0,
		VAL_PERC='P',
		NORMAL=0,
		DAY_PUC=0,
		DAY_SALES=0,
		SETT_PURCH=0,
		SETT_SALES=0,
		SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),
		ROFIG = 0,
		ERRNUM0 = 0,
		NOZERO = 0,
		ROUND_TO = 0,
		TRADE_AMOUNT = 0,
		BRANCH_CD='',
		BROKAPPLIED = 0,
		INS_CHRG = 0,
		TURN_TAX = 0,
		OTHER_CHRG = 0,
		SEBI_TAX = 0,
		BROKER_CHRG = 0,
		NETRATE = 0,
		SERVICE_TAX = 0,
		AUCTIONPART = 'CA',
		RESERVED1 = 0,
		DUMMY1 = 0,
		DUMMY2 = 0,
		STATUS = 'E'         
    FROM  
		BFOSETTLEMENT 
    WHERE  
		SAUDA_DATE <= @FILEDATE + ' 23:59'  
		AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'  
		AND ASSET_CODE = @ASSET_CODE  
		AND RESERVED1 <> 1  
    GROUP BY  
     	SEGMENT,
		SETT_TYPE,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		ASSET_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		SERIES_CODE,
		SERIES_ID,BROKER_CD,CM_CODE,
		PARTICIPANTCODE,PARTY_CODE
    HAVING   
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0  

    INSERT INTO FOSETTCORPACT  
    SELECT   
		CONTRACTNO = '0',
		TRADE_NO = '0',
		SAUDA_DATE = @SAUDA_DATE + ' 8:00 PM',
		TRADESTATUS = 'E',
		SEGMENT,
		SETT_TYPE,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		ASSET_CODE,
		EXPIRYDATE,
		STRIKE_PRICE=((FLOOR(((STRIKE_PRICE * @ADJFACTOR2/@ADJFACTOR1)*POWER(10,2) + 5 + -2.5 )/(5 + 0))*(5+0))/POWER(10,2)),
		OPTION_TYPE,
		SERIES_CODE,
		SERIES_ID,
		LOT_SIZE = @OLDLOTSIZE,
		SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 1 ELSE 2 END),
		TRADEQTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)* @NEWLOTSIZE/@OLDLOTSIZE),
		SETT_FLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),
		CA_LEVEL = 1,
		BROKER_CD,
		TRADE_PRICE = 0,
		LOCATIONID ='',
		CM_CODE,
		PARTICIPANTCODE,
		CP_CONFIRMATION=0,
		OC_FLAG =0,
		OLD_CP_CODE='',
		OLD_CM_CODE='',
		TERMINALID=0,
		ORDER_NO='',
		PARTY_CODE,
		REMARKS='NEW POS',
		BUY_POSITION=0,
		SELL_POSITION=0,
		PRO_CLI='',
		ORDER_TIMESTAMP='',
		ORDER_ACTIVEFLAG='',
		TABLE_NO=0,
		LINE_NO=0,
		VAL_PERC='P',
		NORMAL=0,
		DAY_PUC=0,
		DAY_SALES=0,
		SETT_PURCH=0,
		SETT_SALES=0,
		SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),
		ROFIG = 0,
		ERRNUM0 = 0,
		NOZERO = 0,
		ROUND_TO = 0,
		TRADE_AMOUNT = 0,
		BRANCH_CD='',
		BROKAPPLIED = 0,
		INS_CHRG = 0,
		TURN_TAX = 0,
		OTHER_CHRG = 0,
		SEBI_TAX = 0,
		BROKER_CHRG = 0,
		NETRATE = 0,
		SERVICE_TAX = 0,
		AUCTIONPART = 'CA',
		RESERVED1 = 0,
		DUMMY1 = 0,
		DUMMY2 = 0,
		STATUS = 'E'         
    FROM  
		BFOSETTLEMENT 
    WHERE  
		SAUDA_DATE <= @FILEDATE + ' 23:59'  
		AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'  
		AND ASSET_CODE = @ASSET_CODE  
		AND RESERVED1 <> 1  
    GROUP BY  
     	SEGMENT,
		SETT_TYPE,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		ASSET_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		SERIES_CODE,
		SERIES_ID,BROKER_CD,CM_CODE,
		PARTICIPANTCODE,PARTY_CODE
    HAVING   
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0  
    
    UPDATE  
     FOSETTCORPACT   
    SET   
     TRADE_PRICE = (CASE WHEN REMARKS='OLD POS' THEN CL.CLOSE_PRICE ELSE ROUND(CL.CLOSE_PRICE*1/1.5,4) END),    
     DUMMY2= (CASE WHEN REMARKS='OLD POS' THEN CL.CLOSE_PRICE ELSE ROUND(CL.CLOSE_PRICE*1/1.5,4) END),    
     NETRATE=(CASE WHEN REMARKS='OLD POS' THEN CL.CLOSE_PRICE ELSE ROUND(CL.CLOSE_PRICE*1/1.5,4) END)  
    FROM  
     BFOCLOSING CL  
    WHERE  
		CL.TRADE_DATE LIKE @FILEDATE + '%'  
		AND CL.SERIES_CODE = FOSETTCORPACT.SERIES_CODE
		AND CL.PRODUCT_TYPE = FOSETTCORPACT.PRODUCT_TYPE
		AND CL.PRODUCT_CODE = FOSETTCORPACT.PRODUCT_CODE
		AND CL.ASSET_CODE = FOSETTCORPACT.ASSET_CODE
		AND CL.EXPIRYDATE = FOSETTCORPACT.EXPIRYDATE
		AND CL.STRIKE_PRICE = FOSETTCORPACT.STRIKE_PRICE
		AND CL.OPTION_TYPE = FOSETTCORPACT.OPTION_TYPE
		AND RIGHT(CL.PRODUCT_CODE,3) = 'FUT'  
		AND SAUDA_DATE LIKE @SAUDA_DATE + '%'  
		AND FOSETTCORPACT.ASSET_CODE = @ASSET_CODE

    UPDATE  
     FOSETTCORPACT   
    SET   
     TRADE_AMOUNT = (TRADEQTY*TRADE_PRICE)
    WHERE  
     SAUDA_DATE LIKE @SAUDA_DATE + '%'  
     AND RIGHT(PRODUCT_CODE,3) = 'FUT'  
     AND ASSET_CODE = @ASSET_CODE
  
  /*------------------------------------------------------------------------  
     TAKING THE RECORDS TO FOSETTLEMENT  
  --------------------------------------------------------------------------*/  
  
  
  UPDATE   
   FOSETTCORPACT  
  SET  
   TRADEQTY = ABS(TRADEQTY)  
  WHERE  
   SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND ASSET_CODE = @ASSET_CODE  
   AND TRADEQTY < 0  
  
  
  DECLARE @AMTMATCH  NUMERIC (18,4)  
  DECLARE @TOTALLOT NUMERIC (18,4)    
  
  SELECT   
	@AMTMATCH = SUM(CASE WHEN REMARKS='NEW POS' THEN TRADE_AMOUNT ELSE 0 END) - 
				SUM(CASE WHEN REMARKS<>'NEW POS' THEN TRADE_AMOUNT ELSE 0 END),  
	@TOTALLOT = SUM(CASE WHEN REMARKS='NEW POS' THEN TRADEQTY ELSE 0 END) / @NEWLOTSIZE  
  FROM  
   FOSETTCORPACT  
  WHERE  
   SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND ASSET_CODE = @ASSET_CODE  
    
  SET @STRRETURNFLAG = 0    /*DEFAULT OUTPUT*/  
  SET @STRRETURNMSG = 'UPDATED SUCCESSFULLY'  
  
  IF @TOTALLOT <> ROUND(@TOTALLOT,0) /*NEW QTY CHECK*/  
   BEGIN  
    SET @STRRETURNFLAG = 1  
    SET @STRRETURNMSG = 'CANNOT PROCEED. POST CORP. ACT. NO. OF LOT IS NOT PROPER ' + CONVERT(VARCHAR,@TOTALLOT)  
   END  
  
  IF @STRRETURNFLAG=0  /*CROSS CHECK NEW VALUE WITH OLD VALUE. NOT TO PROCEED*/  
   BEGIN  
    IF @AMTMATCH > 100  
    BEGIN  
     SET @STRRETURNFLAG = 1  
     SET @STRRETURNMSG = 'CANNOT PROCEED. DIFFERENCE IN CORP. ACT. PREVIOUS & POST VALUE AS ' + CONVERT(VARCHAR,@AMTMATCH)  
    END  
   END  
   
  IF @STRRETURNFLAG=0  /*CROSS CHECK NEW VALUE WITH OLD VALUE. CAN PROCEED*/  
   BEGIN  
    IF @AMTMATCH > 0  
    BEGIN  
     SET @STRRETURNFLAG = 0  
     SET @STRRETURNMSG = 'DIFFERENCE IN CORP. ACT. PREVIOUS & POST VALUE AS ' + CONVERT(VARCHAR,@AMTMATCH)  
    END  
   END  
     
  
  
  IF @STRRETURNFLAG=0 /*IF PROCEEDING*/    
   BEGIN  
    
    INSERT INTO  
     BFOSETTLEMENT  
    SELECT * FROM  
     FOSETTCORPACT  
    WHERE  
     ASSET_CODE = @ASSET_CODE  
     AND AUCTIONPART = 'CA'  
     AND SAUDA_DATE LIKE @SAUDA_DATE + '%'    
   END  
  
  INSERT INTO FOCORPACTADJUSTMENT_LOG   
  (  
   FILE_DATE,SAUDA_DATE,ASSET_CODE,METHOD,ADJFACTORQTY,ADJFACTORPRICE,  
   OLDLOTSIZE,NEWLOTSIZE,ROUNDING,CREATEDBY,CREATEDON,NEW_ASSET_CODE  
  )  
  VALUES  
  (  
   @FILEDATE,@SAUDA_DATE, @ASSET_CODE,  
    CASE WHEN @MODE  = 'UPDATE1' THEN 'POS' ELSE 'RATIO' END  
    + CASE WHEN @STRRETURNFLAG = 1 THEN '-ERR' ELSE '' END,  
   @ADJFACTOR1,@ADJFACTOR2,@OLDLOTSIZE,@NEWLOTSIZE,@ROUNDING,HOST_NAME( ),GETDATE(),''  
  )   
    
  SELECT @STRRETURNFLAG,@STRRETURNMSG  
  
    
  /*------------------------------------------------------------------------  
     COMMITTING THE CHANGES  
  --------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FOCORPACTADJUSTMENT_12072013
-- --------------------------------------------------
  
  
  
/*------------------------------------------------------------------------------------------------------------    
PROGRAM NAME : PR_FOCORPACTADJUSTMENT    
DESCRIPTION  : SQL SCRIPTS FOR NSEFO CORPORATE ACTION ADJUSTMENTS    
 @MODE  = 'UPDATE2' - POPULATING THE FINAL RECORDS AT FOSETTLEMENT - RATIO METHOD    
--------------------------------------------------------------------------------------------------------------*/    
  
CREATE PROC [dbo].[PR_FOCORPACTADJUSTMENT_12072013]     
(    
 @FILEDATE VARCHAR(11),    
 @TRADETYPE VARCHAR(2),    
 @MODE VARCHAR(10),    
 @ASSET_CODE VARCHAR(12),    
 @OLDLOTSIZE INT = 1,    
 @NEWLOTSIZE INT = 1,    
 @ADJFACTOR1 NUMERIC(18,8) = 1,    
 @ADJFACTOR2 NUMERIC(18,8) = 1,    
 @ROUNDING INT = 1,    
 @SAUDA_DATE VARCHAR(11) ='',    
 @ASSET_CODENEW VARCHAR(12) ='',  
 @DumpInMyTable Varchar(1) = ''  
) AS    
    
     
    
DECLARE @INTVBBSTAT BIGINT    
DECLARE @INTBFQTY BIGINT  -- EXISTING POSITION    
DECLARE @INTBTQTY BIGINT  -- ADJUSTED POSITION    
DECLARE @INTBFVAL MONEY  -- EXISTING VALUE    
DECLARE @INTBTVAL MONEY  -- ADJUSTED VALUE    
DECLARE @1ADJFACTOR NUMERIC (18,8)    
DECLARE @2ADJFACTOR NUMERIC (18,8)     
DECLARE @CORPACTTYPE VARCHAR(20)    
DECLARE @C_REGULAR_LOT INT     
DECLARE @MEMBERTYPE VARCHAR(15)    
DECLARE @MEMBERCODE VARCHAR(10)  
DECLARE @STRRETURNFLAG INT    
DECLARE @STRRETURNMSG VARCHAR(200)    
       
    /*RATIO BASED METHOD*/    
    INSERT INTO FOSETTCORPACT    
    SELECT     
  CONTRACTNO = '0',  
  TRADE_NO = '0',  
  SAUDA_DATE = @SAUDA_DATE + ' 8:00 PM',  
  TRADESTATUS = 'E',  
  SEGMENT,  
  SETT_TYPE,  
  PRODUCT_TYPE,  
  PRODUCT_CODE,  
  ASSET_CODE,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  SERIES_CODE,  
  SERIES_ID,  
  LOT_SIZE = @OLDLOTSIZE,  
  SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 2 ELSE 1 END),  
  TRADEQTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)),  
  SETT_FLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),  
  CA_LEVEL = 1,  
  BROKER_CD,  
  TRADE_PRICE = 0,  
  LOCATIONID ='',  
  CM_CODE,  
  PARTICIPANTCODE,  
  CP_CONFIRMATION=0,  
  OC_FLAG =0,  
  OLD_CP_CODE='',  
  OLD_CM_CODE='',  
  TERMINALID=0,  
  ORDER_NO='',  
  PARTY_CODE,  
  REMARKS='OLD POS',  
  BUY_POSITION=0,  
  SELL_POSITION=0,  
  PRO_CLI='',  
  ORDER_TIMESTAMP='',  
  ORDER_ACTIVEFLAG='',  
  TABLE_NO=0,  
  LINE_NO=0,  
  VAL_PERC='P',  
  NORMAL=0,  
  DAY_PUC=0,  
  DAY_SALES=0,  
  SETT_PURCH=0,  
  SETT_SALES=0,  
  SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),  
  ROFIG = 0,  
  ERRNUM0 = 0,  
  NOZERO = 0,  
  ROUND_TO = 0,  
  TRADE_AMOUNT = 0,  
  BRANCH_CD='',  
  BROKAPPLIED = 0,  
  INS_CHRG = 0,  
  TURN_TAX = 0,  
  OTHER_CHRG = 0,  
  SEBI_TAX = 0,  
  BROKER_CHRG = 0,  
  NETRATE = 0,  
  SERVICE_TAX = 0,  
  AUCTIONPART = 'CA',  
  RESERVED1 = 0,  
  DUMMY1 = 0,  
  DUMMY2 = 0,  
  STATUS = 'E'           
    FROM    
  BFOSETTLEMENT   
    WHERE    
  SAUDA_DATE <= @FILEDATE + ' 23:59'    
  AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'    
  AND ASSET_CODE = @ASSET_CODE    
  AND RESERVED1 <> 1    
    GROUP BY    
      SEGMENT,  
  SETT_TYPE,  
  PRODUCT_TYPE,  
  PRODUCT_CODE,  
  ASSET_CODE,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  SERIES_CODE,  
  SERIES_ID,BROKER_CD,CM_CODE,  
  PARTICIPANTCODE,PARTY_CODE  
    HAVING     
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0    
  
    INSERT INTO FOSETTCORPACT    
    SELECT     
  CONTRACTNO = '0',  
  TRADE_NO = '0',  
  SAUDA_DATE = @SAUDA_DATE + ' 8:00 PM',  
  TRADESTATUS = 'E',  
  SEGMENT,  
  SETT_TYPE,  
  PRODUCT_TYPE,  
  PRODUCT_CODE,  
  ASSET_CODE,  
  EXPIRYDATE,  
  STRIKE_PRICE=((FLOOR(((STRIKE_PRICE * @ADJFACTOR2/@ADJFACTOR1)*POWER(10,2) + 5 + -2.5 )/(5 + 0))*(5+0))/POWER(10,2)),  
  OPTION_TYPE,  
  SERIES_CODE,  
  SERIES_ID,  
  LOT_SIZE = @OLDLOTSIZE,  
  SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 1 ELSE 2 END),  
  TRADEQTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)* @NEWLOTSIZE/@OLDLOTSIZE),  
  SETT_FLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),  
  CA_LEVEL = 1,  
  BROKER_CD,  
  TRADE_PRICE = 0,  
  LOCATIONID ='',  
  CM_CODE,  
  PARTICIPANTCODE,  
  CP_CONFIRMATION=0,  
  OC_FLAG =0,  
  OLD_CP_CODE='',  
  OLD_CM_CODE='',  
  TERMINALID=0,  
  ORDER_NO='',  
  PARTY_CODE,  
  REMARKS='NEW POS',  
  BUY_POSITION=0,  
  SELL_POSITION=0,  
  PRO_CLI='',  
  ORDER_TIMESTAMP='',  
  ORDER_ACTIVEFLAG='',  
  TABLE_NO=0,  
  LINE_NO=0,  
  VAL_PERC='P',  
  NORMAL=0,  
  DAY_PUC=0,  
  DAY_SALES=0,  
  SETT_PURCH=0,  
  SETT_SALES=0,  
  SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),  
  ROFIG = 0,  
  ERRNUM0 = 0,  
  NOZERO = 0,  
  ROUND_TO = 0,  
  TRADE_AMOUNT = 0,  
  BRANCH_CD='',  
  BROKAPPLIED = 0,  
  INS_CHRG = 0,  
  TURN_TAX = 0,  
  OTHER_CHRG = 0,  
  SEBI_TAX = 0,  
  BROKER_CHRG = 0,  
  NETRATE = 0,  
  SERVICE_TAX = 0,  
  AUCTIONPART = 'CA',  
  RESERVED1 = 0,  
  DUMMY1 = 0,  
  DUMMY2 = 0,  
  STATUS = 'E'           
    FROM    
  BFOSETTLEMENT   
    WHERE    
  SAUDA_DATE <= @FILEDATE + ' 23:59'    
  AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'    
  AND ASSET_CODE = @ASSET_CODE    
  AND RESERVED1 <> 1    
    GROUP BY    
      SEGMENT,  
  SETT_TYPE,  
  PRODUCT_TYPE,  
  PRODUCT_CODE,  
  ASSET_CODE,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  SERIES_CODE,  
  SERIES_ID,BROKER_CD,CM_CODE,  
  PARTICIPANTCODE,PARTY_CODE  
    HAVING     
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0    
      
    UPDATE    
     FOSETTCORPACT     
    SET     
     TRADE_PRICE = (CASE WHEN REMARKS='OLD POS' THEN CL.CLOSE_PRICE ELSE ROUND(CL.CLOSE_PRICE*1/1.5,4) END),      
     DUMMY2= (CASE WHEN REMARKS='OLD POS' THEN CL.CLOSE_PRICE ELSE ROUND(CL.CLOSE_PRICE*1/1.5,4) END),      
     NETRATE=(CASE WHEN REMARKS='OLD POS' THEN CL.CLOSE_PRICE ELSE ROUND(CL.CLOSE_PRICE*1/1.5,4) END)    
    FROM    
     BFOCLOSING CL    
    WHERE    
  CL.TRADE_DATE LIKE @FILEDATE + '%'    
  AND CL.SERIES_CODE = FOSETTCORPACT.SERIES_CODE  
  AND CL.PRODUCT_TYPE = FOSETTCORPACT.PRODUCT_TYPE  
  AND CL.PRODUCT_CODE = FOSETTCORPACT.PRODUCT_CODE  
  AND CL.ASSET_CODE = FOSETTCORPACT.ASSET_CODE  
  AND CL.EXPIRYDATE = FOSETTCORPACT.EXPIRYDATE  
  AND CL.STRIKE_PRICE = FOSETTCORPACT.STRIKE_PRICE  
  AND CL.OPTION_TYPE = FOSETTCORPACT.OPTION_TYPE  
  AND RIGHT(CL.PRODUCT_CODE,3) = 'FUT'    
  AND SAUDA_DATE LIKE @SAUDA_DATE + '%'    
  AND FOSETTCORPACT.ASSET_CODE = @ASSET_CODE  
  
    UPDATE    
     FOSETTCORPACT     
    SET     
     TRADE_AMOUNT = (TRADEQTY*TRADE_PRICE)  
    WHERE    
     SAUDA_DATE LIKE @SAUDA_DATE + '%'    
     AND RIGHT(PRODUCT_CODE,3) = 'FUT'    
     AND ASSET_CODE = @ASSET_CODE  
    
  /*------------------------------------------------------------------------    
     TAKING THE RECORDS TO FOSETTLEMENT    
  --------------------------------------------------------------------------*/    
    
    
  UPDATE     
   FOSETTCORPACT    
  SET    
   TRADEQTY = ABS(TRADEQTY)    
  WHERE    
   SAUDA_DATE LIKE @SAUDA_DATE + '%'    
   AND ASSET_CODE = @ASSET_CODE    
   AND TRADEQTY < 0    
    
    
  DECLARE @AMTMATCH  NUMERIC (18,4)    
  DECLARE @TOTALLOT NUMERIC (18,4)      
    
  SELECT     
 @AMTMATCH = SUM(CASE WHEN REMARKS='NEW POS' THEN TRADE_AMOUNT ELSE 0 END) -   
    SUM(CASE WHEN REMARKS<>'NEW POS' THEN TRADE_AMOUNT ELSE 0 END),    
 @TOTALLOT = SUM(CASE WHEN REMARKS='NEW POS' THEN TRADEQTY ELSE 0 END) / @NEWLOTSIZE    
  FROM    
   FOSETTCORPACT    
  WHERE    
   SAUDA_DATE LIKE @SAUDA_DATE + '%'    
   AND ASSET_CODE = @ASSET_CODE    
      
  SET @STRRETURNFLAG = 0    /*DEFAULT OUTPUT*/    
  SET @STRRETURNMSG = 'UPDATED SUCCESSFULLY'    
    
  IF @TOTALLOT <> ROUND(@TOTALLOT,0) /*NEW QTY CHECK*/    
   BEGIN    
    SET @STRRETURNFLAG = 1    
    SET @STRRETURNMSG = 'CANNOT PROCEED. POST CORP. ACT. NO. OF LOT IS NOT PROPER ' + CONVERT(VARCHAR,@TOTALLOT)    
   END    
    
  IF @STRRETURNFLAG=0  /*CROSS CHECK NEW VALUE WITH OLD VALUE. NOT TO PROCEED*/    
   BEGIN    
    IF @AMTMATCH > 100    
    BEGIN    
     SET @STRRETURNFLAG = 1    
     SET @STRRETURNMSG = 'CANNOT PROCEED. DIFFERENCE IN CORP. ACT. PREVIOUS & POST VALUE AS ' + CONVERT(VARCHAR,@AMTMATCH)    
    END    
   END    
     
  IF @STRRETURNFLAG=0  /*CROSS CHECK NEW VALUE WITH OLD VALUE. CAN PROCEED*/    
   BEGIN    
    IF @AMTMATCH > 0    
    BEGIN    
     SET @STRRETURNFLAG = 0    
     SET @STRRETURNMSG = 'DIFFERENCE IN CORP. ACT. PREVIOUS & POST VALUE AS ' + CONVERT(VARCHAR,@AMTMATCH)    
    END    
   END    
       
    
    
  IF @STRRETURNFLAG=0 /*IF PROCEEDING*/      
   BEGIN    
      
    INSERT INTO    
     BFOSETTLEMENT    
    SELECT * FROM    
     FOSETTCORPACT    
    WHERE    
     ASSET_CODE = @ASSET_CODE    
     AND AUCTIONPART = 'CA'    
     AND SAUDA_DATE LIKE @SAUDA_DATE + '%'      
   END    
    
  INSERT INTO FOCORPACTADJUSTMENT_LOG     
  (    
   FILE_DATE,SAUDA_DATE,ASSET_CODE,METHOD,ADJFACTORQTY,ADJFACTORPRICE,    
   OLDLOTSIZE,NEWLOTSIZE,ROUNDING,CREATEDBY,CREATEDON,NEW_ASSET_CODE    
  )    
  VALUES    
  (    
   @FILEDATE,@SAUDA_DATE, @ASSET_CODE,    
    CASE WHEN @MODE  = 'UPDATE1' THEN 'POS' ELSE 'RATIO' END    
    + CASE WHEN @STRRETURNFLAG = 1 THEN '-ERR' ELSE '' END,    
   @ADJFACTOR1,@ADJFACTOR2,@OLDLOTSIZE,@NEWLOTSIZE,@ROUNDING,HOST_NAME( ),GETDATE(),''    
  )     
      
  SELECT @STRRETURNFLAG,@STRRETURNMSG    
    
      
  /*------------------------------------------------------------------------    
     COMMITTING THE CHANGES    
  --------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_STATUS
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[PR_GET_STATUS]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7)
)

AS

IF @DATEFROM <> '' AND @DATETO <> '' AND @EXCHANGE <> '' AND @SEGMENT <> ''
BEGIN
	DECLARE @COMPANYNAME VARCHAR(200)
	
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	
	IF (@EXCHANGE ='NSE' OR @EXCHANGE='BSE') AND @SEGMENT ='CAPITAL'
	BEGIN 
		SELECT @COMPANYNAME = COMPANY FROM OWNER
	
		SELECT 
			@COMPANYNAME,
			@EXCHANGE,
			@SEGMENT,
			REC_DESCRIPTION = 
					CASE 
						WHEN REC_DESC= 1 THEN 'LAST TRADE DATE'
						WHEN REC_DESC= 2 THEN 'LAST INST TRADE DATE'
						WHEN REC_DESC= 3 THEN 'TOTAL NUMBER OF RETAIL TRADES'
						WHEN REC_DESC= 4 THEN 'TOTAL NUMBER OF RETAIL CONTRACTS'
						WHEN REC_DESC= 5 THEN 'TOTAL RETAIL TURNOVER'
						WHEN REC_DESC= 6 THEN 'TOTAL NUMBER OF INST TRADES'
						WHEN REC_DESC= 7 THEN 'TOTAL NUMBER OF INST CONTRACTS'
						WHEN REC_DESC= 8 THEN 'TOTAL INST TURNOVER'
						WHEN REC_DESC= 9 THEN 'NUMBER OF TRADING DAYS'
						WHEN REC_DESC= 10 THEN 'AVRG RETAIL CONTRACTS PER DAY'
						WHEN REC_DESC= 11 THEN 'AVRG RETAIL TURNOVER PER DAY'
						WHEN REC_DESC= 12 THEN 'AVRG INST CONTRACTS PER DAY'
						WHEN REC_DESC= 13 THEN 'AVRG INST TURNOVER PER DAY'
					END,
			REC_VALUE
		FROM
			(
			SELECT REC_DESC=1,
			       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			    
			UNION ALL
			
			SELECT REC_DESC=2,
			       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			                                                    
			UNION ALL
			
			SELECT 
				REC_DESC=3, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(1))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT 
				REC_DESC=4, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT 
				REC_DESC=5, 
				REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT   
				REC_DESC=6, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(1))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT  
				REC_DESC=7, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT  
				REC_DESC=8 ,
				REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
	
			UNION ALL
		
			
			SELECT 
				REC_DESC= 9, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
	
			SELECT 
				REC_DESC= 10, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
	
			SELECT 
				REC_DESC= 11, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
	
			SELECT 
				REC_DESC= 12, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
			
			SELECT 
				REC_DESC= 13, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
		) REC_DATA
	
	END
	ELSE
		IF (SELECT PATINDEX('%'+ @EXCHANGE + '%','|BCM|BSX|BXM|NMC|BSE|'))>0 AND @SEGMENT ='FUTURES'
			BEGIN
	
			SELECT @COMPANYNAME = COMPANY FROM BFOOWNER
	
			SELECT 
				@COMPANYNAME,
				@EXCHANGE,
				@SEGMENT,
				REC_DESCRIPTION = 
						CASE 
							WHEN REC_DESC= 1 THEN 'LAST TRADE DATE'
							WHEN REC_DESC= 2 THEN 'LAST INST TRADE DATE'
							WHEN REC_DESC= 3 THEN 'TOTAL NUMBER OF RETAIL TRADES'
							WHEN REC_DESC= 4 THEN 'TOTAL NUMBER OF RETAIL CONTRACTS'
							WHEN REC_DESC= 5 THEN 'TOTAL RETAIL TURNOVER'
							WHEN REC_DESC= 6 THEN 'TOTAL NUMBER OF INST TRADES'
							WHEN REC_DESC= 7 THEN 'TOTAL NUMBER OF INST CONTRACTS'
							WHEN REC_DESC= 8 THEN 'TOTAL INST TURNOVER'
							WHEN REC_DESC= 9 THEN 'NUMBER OF TRADING DAYS'
							WHEN REC_DESC= 10 THEN 'AVRG RETAIL CONTRACTS PER DAY'
							WHEN REC_DESC= 11 THEN 'AVRG RETAIL TURNOVER PER DAY'
							WHEN REC_DESC= 12 THEN 'AVRG INST CONTRACTS PER DAY'
							WHEN REC_DESC= 13 THEN 'AVRG INST TURNOVER PER DAY'
						END,
				REC_VALUE
			FROM
				(
					SELECT REC_DESC= 1,
					       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					    
					UNION ALL
					
					SELECT REC_DESC= 2,
					       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					                                                    
					UNION ALL
		
					SELECT 
						REC_DESC= 3, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(1))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					UNION ALL
					
					SELECT 
						REC_DESC= 4, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					UNION ALL
					
					SELECT 
						REC_DESC= 5, 
						REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					UNION ALL
		
					SELECT 
						REC_DESC= 6, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(1))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					UNION ALL
					
					SELECT 
						REC_DESC= 7, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					UNION ALL
					
					SELECT 
						REC_DESC= 8, 
						REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
	
					UNION ALL
				
					
					SELECT 
						REC_DESC= 9, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
		
					UNION ALL
		
					SELECT 
						REC_DESC= 10, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
					UNION ALL
		
					SELECT 
						REC_DESC= 11, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
					UNION ALL
		
					SELECT 
						REC_DESC= 12, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
		
					UNION ALL
					
					SELECT 
						REC_DESC= 13, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
	
				) TRDDATA
			END
		ELSE
			BEGIN
			SELECT @COMPANYNAME = COMPANY FROM FOOWNER
	
			SELECT 
				@COMPANYNAME,
				@EXCHANGE,
				@SEGMENT,
				REC_DESCRIPTION = 
						CASE 
							WHEN REC_DESC= 1 THEN 'LAST TRADE DATE'
							WHEN REC_DESC= 2 THEN 'LAST INST TRADE DATE'
							WHEN REC_DESC= 3 THEN 'TOTAL NUMBER OF RETAIL TRADES'
							WHEN REC_DESC= 4 THEN 'TOTAL NUMBER OF RETAIL CONTRACTS'
							WHEN REC_DESC= 5 THEN 'TOTAL RETAIL TURNOVER'
							WHEN REC_DESC= 6 THEN 'TOTAL NUMBER OF INST TRADES'
							WHEN REC_DESC= 7 THEN 'TOTAL NUMBER OF INST CONTRACTS'
							WHEN REC_DESC= 8 THEN 'TOTAL INST TURNOVER'
							WHEN REC_DESC= 9 THEN 'NUMBER OF TRADING DAYS'
							WHEN REC_DESC= 10 THEN 'AVRG RETAIL CONTRACTS PER DAY'
							WHEN REC_DESC= 11 THEN 'AVRG RETAIL TURNOVER PER DAY'
							WHEN REC_DESC= 12 THEN 'AVRG INST CONTRACTS PER DAY'
							WHEN REC_DESC= 13 THEN 'AVRG INST TURNOVER PER DAY'
						END,
				REC_VALUE
			FROM
				(
				SELECT REC_DESC= 1,
				       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				    
				UNION ALL
				
				SELECT REC_DESC= 2,
				       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				                                                    
				UNION ALL
	
				SELECT 
					REC_DESC= 3, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(1))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				UNION ALL
				
				SELECT 
					REC_DESC= 4, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				UNION ALL
				
				SELECT 
					REC_DESC= 5, 
					REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				UNION ALL
	
				SELECT 
					REC_DESC= 6, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(1))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				UNION ALL
				
				SELECT 
					REC_DESC= 7, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				UNION ALL
				
				SELECT 
					REC_DESC= 8, 
					REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
	
				UNION ALL
			
				
				SELECT 
					REC_DESC= 9, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
	
				UNION ALL
	
				SELECT 
					REC_DESC= 10, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
				UNION ALL
	
				SELECT 
					REC_DESC= 11, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
				UNION ALL
	
				SELECT 
					REC_DESC= 12, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
	
				UNION ALL
				
				SELECT 
					REC_DESC= 13, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
	
	
				) TRDDATA
			END
	
	  SELECT @COMPANYNAME,@EXCHANGE,@SEGMENT,
		 ENT_TYPE = A.ENT_TYPE,   
	         NO_OF_UNITS = ISNULL(NO_OF_UNITS,0),   
	         NO_OF_LOGIN = ISNULL(NO_OF_LOGIN,0),   
	         NO_OF_USERS = ISNULL(NO_OF_USERS,0)   
	  FROM   (SELECT ENT_TYPE,   
	                 NO_OF_UNITS = COUNT(1),   
	                 ORDER_BY  
	          FROM   V2_CLASS_VW_ENTITYMASTER (NOLOCK)   
	          GROUP BY ENT_TYPE,ORDER_BY) A   
	            LEFT OUTER JOIN   
	            (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
	                    NO_OF_LOGIN = SUM(NO_OF_LOGIN)   
	             FROM   (SELECT FLDADMINAUTO,   
	                            NO_OF_LOGIN = COUNT(DISTINCT FLDSTNAME)   
	                     FROM   TBLPRADNYAUSERS (NOLOCK) 
	                     GROUP BY FLDADMINAUTO) U,   
	                     TBLADMIN A   
	             WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
	             GROUP BY FLDSTATUS) B  
	             ON A.ENT_TYPE = B.ENT_TYPE    
	              LEFT OUTER JOIN   
	                (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
	                        NO_OF_USERS = SUM(NO_OF_USERS)   
	                 FROM   (SELECT FLDADMINAUTO,   
	                                FLDSTNAME,   
	                                NO_OF_USERS = COUNT(1)   
	                         FROM TBLPRADNYAUSERS  (NOLOCK)  
	                         GROUP BY FLDADMINAUTO,   
	                          FLDSTNAME) U, TBLADMIN A   
	                 WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
	                 GROUP BY FLDSTATUS) C   
	                 ON A.ENT_TYPE = C.ENT_TYPE   
	  ORDER BY ORDER_BY  
END
/*------------------------------------------------- END OF THE PROCEDURE ---------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_STATUS_DATA
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[PR_GET_STATUS_DATA]
(
	@DATEFROM VARCHAR(11)='',
	@DATETO VARCHAR(11)='',
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7)
)
AS


IF @EXCHANGE <> '' AND @SEGMENT <> ''
BEGIN

/*-----------------------------------------------------------------------------------------------------------------------
						FETCHING THE TRANSACTRION DETAILS
-------------------------------------------------------------------------------------------------------------------------*/
	DECLARE @SR_RPT_PERIOD VARCHAR(30)
	DECLARE @SR_SEGMENT VARCHAR(12)
	DECLARE @SR_VALUE VARCHAR(2000)
	DECLARE @COMPANYNAME VARCHAR(200)			  
	DECLARE @SR_VALUE2 VARCHAR(2000)
	DECLARE @DATAVAL VARCHAR(100)
	DECLARE @DATACUR AS CURSOR

	IF @DATEFROM = '' BEGIN SET @DATEFROM = LEFT(GETDATE(),11) END
	IF @DATETO = '' BEGIN SET @DATETO = LEFT(GETDATE(),11) END	

	SET @SR_RPT_PERIOD =  CONVERT(VARCHAR,CONVERT(DATETIME, @DATEFROM),103) + '-' + CONVERT(VARCHAR,CONVERT(DATETIME, @DATETO),103)
	SET @SR_SEGMENT = @EXCHANGE +'-'+@SEGMENT
	SET @SR_VALUE = ''
	
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	
	IF (@EXCHANGE ='NSE' OR @EXCHANGE='BSE') AND @SEGMENT ='CAPITAL'
	BEGIN 
		SELECT @COMPANYNAME = COMPANY FROM OWNER
			
			SELECT
			       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11) + '|'
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			    
					
			SELECT 
			       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'			                                                  
		
			
			SELECT 				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			SELECT 
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')			
		
			SELECT 
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			SELECT   
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
					
			SELECT  
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
					
			SELECT  
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
				
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
	END
	ELSE
		IF (SELECT PATINDEX('%'+ @EXCHANGE + '%','|BCM|BSX|BXM|NMC|BSE|'))>0 AND @SEGMENT ='FUTURES'
			BEGIN
	
			SELECT @COMPANYNAME = COMPANY FROM BFOOWNER	

					SELECT 
					       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					SELECT 
					       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1                          
	
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					

					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0					

		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1	
			
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
		
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1

					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
	
			END
		ELSE
			BEGIN
			SELECT @COMPANYNAME = COMPANY FROM FOOWNER
	

				SELECT 
				       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				    
				
				SELECT 
				       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				                                                    
		
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
	
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1

				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1

			END
	
	/*-----------------------------------------------------------------------------------------------------------------------
						FETCHING THE LOGIN DETAILS
	-------------------------------------------------------------------------------------------------------------------------*/
	
	SET @SR_VALUE2 = ''
	SET @DATACUR =  CURSOR FOR SELECT 
			CONVERT(VARCHAR,ISNULL(NO_OF_UNITS,0))+'-'+CONVERT(VARCHAR,ISNULL(NO_OF_LOGIN,0))+'-'+CONVERT(VARCHAR,ISNULL(NO_OF_USERS,0))
			FROM   (SELECT ENT_TYPE,   
		                 NO_OF_UNITS = COUNT(1),   
		                 ORDER_BY  
		          FROM   V2_CLASS_VW_ENTITYMASTER (NOLOCK)   
		          GROUP BY ENT_TYPE,ORDER_BY) A   
		            LEFT OUTER JOIN   
		            (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
		                    NO_OF_LOGIN = SUM(NO_OF_LOGIN)   
		             FROM   (SELECT FLDADMINAUTO,   
		                            NO_OF_LOGIN = COUNT(DISTINCT FLDSTNAME)   
		                     FROM   TBLPRADNYAUSERS (NOLOCK) 
		                     GROUP BY FLDADMINAUTO) U,   
		                     TBLADMIN A   
		             WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
		             GROUP BY FLDSTATUS) B  
		             ON A.ENT_TYPE = B.ENT_TYPE    
		              LEFT OUTER JOIN   
		                (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
		                        NO_OF_USERS = SUM(NO_OF_USERS)   
		                 FROM   (SELECT FLDADMINAUTO,   
		                                FLDSTNAME,   
		                                NO_OF_USERS = COUNT(1)   
		                         FROM TBLPRADNYAUSERS  (NOLOCK)  
		                         GROUP BY FLDADMINAUTO,   
		                          FLDSTNAME) U, TBLADMIN A   
		                 WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
		                 GROUP BY FLDSTATUS) C   
		                 ON A.ENT_TYPE = C.ENT_TYPE   
		  ORDER BY ORDER_BY 
	
	OPEN @DATACUR
	FETCH NEXT FROM @DATACUR INTO @DATAVAL
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @SR_VALUE2 = @SR_VALUE2 + @DATAVAL + '|' 
	
	FETCH NEXT FROM @DATACUR INTO @DATAVAL
	END
	CLOSE @DATACUR
	DEALLOCATE @DATACUR
	
	/*-----------------------------------------------------------------------------------------------------------------------
					POPULATING FINAL DATA INTO PRDNYA STATUS REPORT TABLE
	-------------------------------------------------------------------------------------------------------------------------*/
	
	IF ISNULL(@SR_VALUE,'') <>''
	BEGIN
		DELETE PRADNYA.DBO.STATUS_REPORT WHERE SR_RPT_PERIOD =@SR_RPT_PERIOD AND SR_SEGMENT = @SR_SEGMENT AND SR_TYPE = 1
		INSERT INTO PRADNYA.DBO.STATUS_REPORT SELECT @SR_RPT_PERIOD,@SR_SEGMENT,1,@SR_VALUE,GETDATE()
	END
	IF ISNULL(@SR_VALUE2,'') <>''
	BEGIN
		DELETE PRADNYA.DBO.STATUS_REPORT WHERE SR_RPT_PERIOD =@SR_RPT_PERIOD AND SR_SEGMENT = @SR_SEGMENT AND SR_TYPE = 2
		INSERT INTO PRADNYA.DBO.STATUS_REPORT SELECT @SR_RPT_PERIOD,@SR_SEGMENT,2,@SR_VALUE2,GETDATE()
	END
END

/*------------------------------------------------- END OF THE PROCEDURE ---------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_LEDGER_DETAILS_DAS_GET
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[PR_LEDGER_DETAILS_DAS_GET]
(                        
 @FDATE VARCHAR(12),                      
 @FPARTY VARCHAR(10),                         
 @TPARTY VARCHAR(10),                      
 @UNAME  VARCHAR(10)                       
)                        
                        
AS                        
                        
SET NOCOUNT ON                                     
            
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                              
    DELETE                               
    FROM                               
       LEDGER_DETAILS_DAS                               
    WHERE                               
        LEDDD_SAUDA_DATE LIKE @FDATE + '%'                               
        AND LEDDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY                                 
        
                        
CREATE TABLE [DBO].[#LEDGER_DETAILS_DAS](                        
 [LEDDD_PARTY_CODE] [VARCHAR](10) NOT NULL,                      
 [LEDDD_SAUDA_DATE] DATETIME ,                      
 [LEDDD_OPENING_BAL] [MONEY] NULL,                        
 [LEDDD_CHQ_REC] [MONEY] NULL,                        
 [LEDDD_CHQ_PAY] [MONEY] NULL,                        
 [LEDDD_JV_ENTRY] [MONEY] NULL,                        
 [LEDDD_CLOSING_BAL] [MONEY] NULL,                        
 [LEDDD_CASH_MARGIN] [MONEY] NULL,                        
 [LEDDD_OPENING_INIT_MARGIN] [MONEY] NULL,                        
 [LEDDD_MRG_REC] [MONEY] NULL,                        
 [LEDDD_MRG_REPAY] [MONEY] NULL,                        
 [LEDDD_MRG_JV_ENTRY] [MONEY] NULL,                        
 [LEDDD_CLOSING_INIT_MARGIN] [MONEY] NULL,                        
 [LEDDD_NONCASH_COLL_HC] [MONEY] NULL,                        
 [LEDDD_INIT_EXPO_MARGIN] [MONEY] NULL,                      
 [LEDDD_CREATED_BY] [VARCHAR] (10) NOT NULL,                      
 [LEDDD_CREATED_DT]  DATETIME                      
) ON [PRIMARY]                        
                        
/*====================================================================================                        
 OPENING BALANCE - CLIENT CONTROL A/C                        
====================================================================================*/                        
INSERT INTO #LEDGER_DETAILS_DAS                         
SELECT                         
 LEDDD_PARTY_CODE = CLTCODE,                       
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),0),                        
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN = 0,                        
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                        
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                        
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = GETDATE()                        
FROM                         
 ACCOUNTBFO..LEDGER L,                         
 ACCOUNTBFO..PARAMETER P                         
WHERE                         
 CLTCODE BETWEEN @FPARTY AND @TPARTY                        
 AND VDT < @FDATE              
 AND @FDATE BETWEEN SDTCUR AND LDTCUR                         
 AND VDT >= SDTCUR                         
 AND VDT <= LDTCUR                         
GROUP BY                         
 CLTCODE              
                        
/*====================================================================================                        
 CHEQUE RECEIPTS DURING THE DAY                      
 CHEQUE PAYMENTS DURING THE DAY                        
 JOURNAL ENTRIES FOR THE DAY                        
 MARGIN RECEIPTS DURING THE DAY                        
 MARGIN REPAYMENT DURING THE DAY                        
 MARGIN JOURNAL ENTRIES FOR THE DAY                        
====================================================================================*/                        
INSERT INTO #LEDGER_DETAILS_DAS                       
SELECT                       
 LEDDD_PARTY_CODE = CLTCODE,                      
 LEDDD_SAUDA_DATE = @FDATE,                    
 LEDDD_OPENING_BAL = 0,                      
 ISNULL(SUM(LEDDD_CHQ_REC),0),
 ISNULL(SUM(LEDDD_CHQ_PAY),0),
 ISNULL(SUM(LEDDD_JV_ENTRY),0),
 LEDDD_CLOSING_BAL = 0,                      
 LEDDD_CASH_MARGIN = 0,                      
 LEDDD_OPENING_INIT_MARGIN = 0,                      
 ISNULL(SUM(ML.LEDDD_MRG_REC),0),                      
 ISNULL(SUM(ML.LEDDD_MRG_REPAY),0),                      
 ISNULL(SUM(ML.LEDDD_MRG_JV_ENTRY),0),                      
 LEDDD_CLOSING_INIT_MARGIN = ISNULL(SUM(ML.LEDDD_MRG_REC),0) + ISNULL(SUM(ML.LEDDD_MRG_REPAY),0) + ISNULL(SUM(ML.LEDDD_MRG_JV_ENTRY),0),                      
 LEDDD_NONCASH_COLL_HC = 0,                      
 LEDDD_INIT_EXPO_MARGIN = 0,                      
 LEDDD_CREATED_BY = @UNAME,                    
 LEDDD_CREATED_DT = GETDATE()                      
 FROM                       
 (
 SELECT 
	 LEDDD_CHQ_REC = ISNULL(SUM(CASE WHEN VTYP = '2' THEN (CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),0) ,                      
	 LEDDD_CHQ_PAY = ISNULL(SUM(CASE WHEN VTYP = '3' THEN (CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),0),                      
	 LEDDD_JV_ENTRY = ISNULL(SUM(CASE WHEN VTYP = '8' THEN (CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),0),         
	 CLTCODE 
 FROM 
	 ACCOUNTBFO..LEDGER (NOLOCK)     
 WHERE                       
	 CLTCODE BETWEEN @FPARTY AND @TPARTY 
	 AND VDT LIKE @FDATE+ '%'                      
 GROUP BY CLTCODE 
 ) L 
 LEFT OUTER JOIN      
(                      
         SELECT     
  LEDDD_MRG_REC = ISNULL(SUM(CASE WHEN VTYP = 19 THEN AMOUNT ELSE 0 END),0),     
  LEDDD_MRG_REPAY = ISNULL(SUM(CASE WHEN VTYP = 20 THEN AMOUNT ELSE 0 END),0),     
  LEDDD_MRG_JV_ENTRY = ISNULL(SUM(CASE WHEN VTYP = 24 THEN AMOUNT ELSE 0 END),0),     
     PARTY_CODE     
    FROM ACCOUNTBFO..MARGINLEDGER (NOLOCK) WHERE PARTY_CODE BETWEEN @FPARTY AND @TPARTY 
          AND VDT LIKE @FDATE+ '%'                      
  GROUP BY PARTY_CODE  
) ML     
ON    
(    
 CLTCODE = PARTY_CODE     
)    
GROUP BY CLTCODE
                        
                        
/*====================================================================================                        
 CLOSING BALANCE - CLIENT CONTROL A/C (A)                        
====================================================================================*/                        
INSERT INTO #LEDGER_DETAILS_DAS                         
SELECT                         
 LEDDD_PARTY_CODE = CLTCODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                        
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),0),                        
 LEDDD_CASH_MARGIN = 0,                        
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                        
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                        
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = GETDATE()                        
FROM                         
 ACCOUNTBFO..LEDGER L,                         
 ACCOUNTBFO..PARAMETER P                         
WHERE                         
 CLTCODE BETWEEN @FPARTY AND @TPARTY                        
 AND VDT <=  @FDATE  + ' 23:59:59'                         
--- AND VDT <= @FDATE  + '23:59:59'            
 AND @FDATE BETWEEN SDTCUR AND LDTCUR                         
 AND VDT >= SDTCUR                         
 AND VDT <= LDTCUR                         
GROUP BY                         
 CLTCODE      
                        
/*====================================================================================                        
 CASH MARGIN                        
 NON-CASH COLLATERAL VALUE (AFTER HAIR-CUT) (C)                        
====================================================================================*/         
                        
INSERT INTO #LEDGER_DETAILS_DAS                         
SELECT                         
 LEDDD_PARTY_CODE = PARTY_CODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                        
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN,                        
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                        
 LEDDD_NONCASH_COLL_HC,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                        
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = GETDATE()                        
 FROM                         
 (                        
      SELECT       
  LEDDD_CASH_MARGIN = ISNULL(SUM(ACTUALCASH),0),       
  LEDDD_NONCASH_COLL_HC = ISNULL(SUM(EFFECTIVECOLL-ACTUALCASH),0),       
  PARTY_CODE       
  FROM MSAJAG.DBO.COLLATERAL (NOLOCK)       
  WHERE TRANS_DATE >= @FDATE                        
       AND TRANS_DATE LIKE @FDATE + '%'                 
       AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY                         
       AND EXCHANGE = 'BSE' AND SEGMENT = 'FUTURES'                         
  GROUP BY PARTY_CODE       
 ) C       
                        
                        
/*====================================================================================                        
 CLOSING BALANCE - CLIENT CASH INITIAL MARGIN A/C (B)            
 OPENING BALANCE - CLIENT CASH INITIAL MARGIN A/C                        
====================================================================================*/                        
                        
INSERT INTO #LEDGER_DETAILS_DAS                         
SELECT                         
 LEDDD_PARTY_CODE = PARTY_CODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                         
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN = 0,                        
 SUM(LEDDD_OPENING_INIT_MARGIN),                       
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),                        
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                       
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = GETDATE()                        
FROM                         
 (       
 SELECT LEDDD_OPENING_INIT_MARGIN = SUM(T.AMOUNT), PARTY_CODE       
 FROM       
 (      
  SELECT PARTY_CODE, ISNULL(CASE WHEN DRCR='D' THEN SUM(-AMOUNT) ELSE SUM(AMOUNT) END,0) AS AMOUNT       
  FROM ACCOUNTBFO..MARGINLEDGER L (NOLOCK),                       
  ACCOUNTBFO..PARAMETER P (NOLOCK)      
  WHERE PARTY_CODE BETWEEN @FPARTY AND @TPARTY AND VDT <= @FDATE      
  AND  @FDATE BETWEEN SDTCUR AND LDTCUR AND VDT >= SDTCUR AND VDT <= LDTCUR                           
  GROUP BY PARTY_CODE,DRCR                    
 )T       
                GROUP BY T.PARTY_CODE      
) F                       
GROUP BY                         
 PARTY_CODE       
                        
/*====================================================================================                        
        INITIAL AND EXPOSURE MARGIN FOR TODAY (D)                        
====================================================================================*/                        
INSERT INTO #LEDGER_DETAILS_DAS                         
SELECT                         
 LEDDD_PARTY_CODE = PARTY_CODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                         
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN = 0,                   
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                         
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN,       
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = GETDATE()                        
FROM                         
    (                        
     SELECT LEDDD_INIT_EXPO_MARGIN = ISNULL(SUM(ABS(MTM_MARGIN)+ABS(INIT_MARGIN)),0), PARTY_CODE       
 FROM BFOMARGINCOLL (NOLOCK) WHERE PARTY_CODE BETWEEN @FPARTY AND @TPARTY AND FILE_DATE LIKE @FDATE + '%'                        
      GROUP BY PARTY_CODE       
    ) F      
                        
/*====================================================================================                        
 FINAL SELECT                        
====================================================================================*/                        
/*  
SELECT                         
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),                        
 LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),                        
 LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),                        
 LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),                        
 LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),                        
 LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),                        
 LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),                        
 LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),                        
 LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),                        
 LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),                        
 LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),                        
 LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),                        
 LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),                      
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = GETDATE()                        
 FROM                       
 #LEDGER_DETAILS_DAS              
 GROUP BY LEDDD_PARTY_CODE              
*/  
                       
 INSERT INTO LEDGER_DETAILS_DAS --SELECT * FROM #LEDGER_DETAILS_DAS                      
SELECT                         
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),                        
 LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),                        
 LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),                        
 LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),                        
 LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),                        
 LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),                        
 LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),                        
 LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),                        
 LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),                        
 LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),                        
 LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),                        
 LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),                        
 LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),                      
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = GETDATE()                        
 FROM                       
 #LEDGER_DETAILS_DAS                        
 GROUP BY LEDDD_PARTY_CODE              
                      
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_SQLTABLEREINDEX
-- --------------------------------------------------
CREATE  PROC [DBO].[PR_SQLTABLEREINDEX] (@TABLE_NAME AS VARCHAR(254) = '') AS
/*--------------------------------------------------------------------------------------------------------------------
PROGRAM NAME 	: PR_SQLTABLEREINDEX
DESC 		: SQL SCRIPTS TO 
				1. RE INDEX ALL THE TRANSACTION ORIENTED TABLES
				2. CHECKING INDEX KEY DUPLICATION 
TABLES USING 	: 1. SQLTABLEINDEX  - KEEPING THE FOLLOWING DETAILS
			A. TABLENAME
			B. INDEXNAME
			C. INDEXCOLUMN
		  2.  SQLTABLEREINDEX_LOG - KEEPING RE INDEX LOG 
					    AND INDEX DUPLICATION RECORD
LOGIC 		: 
			CHECKING THE AVAILABILITY OF THE REQUIRED INDEX 
				IF FOUND  --  RE INDEX & LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'REINDEX'
				ELSE   - CREATE & LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'NEWINDEX'
				
			CHECKING THE INDEX KEY DUPLICATION
				IF FOUND  -- LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'DUPLICATE'
PROGRAM BENEFIT : 
			1. STANDARD TABLE INDEX TO MAINTAIN
			2. RE CREATION OF INDEX FOR PERFORMANCE

----------------------------------------------------------------------------------------------------------------------*/



DECLARE 
	@TABLECUR CURSOR,
	@TABLENAME VARCHAR(20),
	@INDEXNAME VARCHAR(10),
	@INDEXCOLUMN VARCHAR(100),
	@INDEXCOLUMNCHK VARCHAR(100)
DECLARE 
	@TINDEXNAME VARCHAR(20),
	@TINDEXCOLUM VARCHAR(100),
	@STRSQL VARCHAR(200),
	@INDEXCURSOR CURSOR,
	@INDEXFLAG INT,
	@INDEXPRV VARCHAR(20),
	@INDEXCOLUMNPRV VARCHAR(100),
 	@INDEXTYPE VARCHAR(20)

SET NOCOUNT ON

SET @TABLECUR = CURSOR FOR
SELECT
	TABLENAME,
	INDEXNAME,
	INDEXCOLUMN,
	INDEXCOLUMNCHK = LTRIM(RTRIM(UPPER(REPLACE(INDEXCOLUMN,',',''))))
FROM
	SQLTABLEINDEX
WHERE
	1 = 1
	AND TABLENAME = (CASE WHEN ISNULL(@TABLE_NAME,'') <> '' THEN @TABLE_NAME ELSE TABLENAME END) 


OPEN @TABLECUR
FETCH NEXT FROM @TABLECUR INTO 	@TABLENAME,@INDEXNAME,@INDEXCOLUMN,@INDEXCOLUMNCHK
WHILE @@FETCH_STATUS = 0       
BEGIN      
	SET @INDEXFLAG  = 0
	SET @INDEXCOLUMNPRV = ''
	SET @INDEXPRV = ''
	SET @INDEXCURSOR = CURSOR FOR SELECT * FROM 
	(
		SELECT 
			I.NAME AS INDEXNAME,
			CASE WHEN (I.STATUS & 16)<> 0 THEN 'CLUSTERED' 
			ELSE 'NONCLUSTERED' END AS INDEXTYPE,
			UPPER(ISNULL(INDEX_COL(@TABLENAME, I.INDID,1 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,2 ),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,3 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,4 ),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,5 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,6),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,7 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,8),'') ) AS INDEXCOLUMNS
		FROM 
			(DBO.SYSINDEXES I INNER JOIN DBO.SYSFILEGROUPS S ON I.GROUPID = S.GROUPID )
		WHERE 
			ID = OBJECT_ID(@TABLENAME) AND I.INDID > 0 AND I.INDID < 255 AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISSTATISTICS') <> 1) AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISAUTOSTATISTICS') <> 1) AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISHYPOTHETICAL') <> 1)
		 
	)TBLIDX  ORDER BY INDEXCOLUMNS
	OPEN @INDEXCURSOR
	FETCH NEXT FROM @INDEXCURSOR INTO @TINDEXNAME,@INDEXTYPE,@TINDEXCOLUM
	WHILE @@FETCH_STATUS = 0       
	BEGIN     
		IF @INDEXCOLUMNPRV = @TINDEXCOLUM
			BEGIN
				INSERT INTO SQLTABLEREINDEX_LOG VALUES 
				(@TABLENAME,@INDEXPRV,@TINDEXCOLUM,'DUPLICATE',@@SPID,GETDATE())	
			END 
		IF (@TINDEXCOLUM = @INDEXCOLUMNCHK OR @INDEXNAME = @TINDEXNAME) AND @INDEXFLAG =0
			BEGIN
				SET @INDEXFLAG  = 1
				SET @STRSQL = 'CREATE ' + @INDEXTYPE + ' INDEX ['+ @TINDEXNAME +'] ON [DBO].['+@TABLENAME+']('
				SET @STRSQL = @STRSQL + @INDEXCOLUMN + ')'
				SET @STRSQL = @STRSQL + ' WITH  DROP_EXISTING ON [PRIMARY]'
				EXEC (@STRSQL)
				INSERT INTO SQLTABLEREINDEX_LOG VALUES 
				(@TABLENAME,@TINDEXNAME,@INDEXCOLUMN,'REINDEX',@@SPID,GETDATE())
			END
		SET @INDEXPRV = @TINDEXNAME
		SET @INDEXCOLUMNPRV = @TINDEXCOLUM
		FETCH NEXT FROM @INDEXCURSOR INTO @TINDEXNAME,@INDEXTYPE,@TINDEXCOLUM
	END      
	CLOSE @INDEXCURSOR      
	DEALLOCATE @INDEXCURSOR
	IF @INDEXFLAG =0
		BEGIN
			SET @STRSQL = 'CREATE INDEX ['+ @INDEXNAME +'] ON [DBO].['+@TABLENAME+']('
			SET @STRSQL = @STRSQL + @INDEXCOLUMN + ')'
			EXEC (@STRSQL)
			INSERT INTO SQLTABLEREINDEX_LOG VALUES 
			(@TABLENAME,@INDEXNAME,@INDEXCOLUMN,'NEWINDEX',@@SPID,GETDATE())
		END
	FETCH NEXT FROM @TABLECUR INTO 	@TABLENAME,@INDEXNAME,@INDEXCOLUMN,@INDEXCOLUMNCHK
END
CLOSE @TABLECUR      
DEALLOCATE @TABLECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_VALIDATEFILE
-- --------------------------------------------------
CREATE PROC [dbo].[PR_VALIDATEFILE]
(
	@FILETYPE VARCHAR(20),
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11)
) AS

SET @FILENAME = REPLACE(@FILENAME,'-01.CSV','.CSV')

DECLARE @INTRESULT INT
DECLARE @FILEDATE VARCHAR(10)
IF LEN(@TRADEDATE) = 10 AND CHARINDEX('/',@TRADEDATE) > 0
	SET @TRADEDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @TRADEDATE,103),109)

SET @INTRESULT = 1
IF @FILETYPE = 'CONTRACT'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'CO' AND LEFT(@FILENAME,6) <> 'EQD_CO' AND LEFT(@FILENAME,10) <> 'EQD_SPD_CO' AND LEFT(@FILENAME,9) <> 'EQD_CC_CO'
	BEGIN
		SET @INTRESULT = 0	
	END
END

IF @FILETYPE = 'TRADE'
BEGIN  
	IF LEFT(@FILENAME,12) <> 'Trade_BSE_FO'
	BEGIN
		SET @INTRESULT =0	
	END
END


IF @FILETYPE = 'RATE'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'MS'
	BEGIN
		SET @INTRESULT = 0	
	END
END

IF @FILETYPE = 'POSITION'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'PO'
	BEGIN
		SET @INTRESULT = 0	
	END
	
END

IF @FILETYPE = 'MARGIN'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'MG'
	BEGIN
		SET @INTRESULT = 0	
	END
END
IF @FILETYPE <> 'CONTRACT'
BEGIN
	
	IF @INTRESULT = 1
	BEGIN
		IF @FILETYPE = 'TRADE'
		BEGIN
			SET @FILEDATE = LTRIM(RTRIM(.dbo.PIECE(@FILENAME, '_', 7)))
		END
		ELSE
		BEGIN
			SET @FILEDATE = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
		END
		 
		IF LEFT(CONVERT(DATETIME,@FILEDATE),11) <> LEFT(CONVERT(DATETIME,@TRADEDATE),11)
		BEGIN
			SET @INTRESULT = 0	
		END
	END	
END

SELECT @INTRESULT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_VALIDATEFILE_BKUP_27Jul2023
-- --------------------------------------------------
CREATE PROC [dbo].[PR_VALIDATEFILE_BKUP_27Jul2023]
(
	@FILETYPE VARCHAR(20),
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11)
) AS

SET @FILENAME = REPLACE(@FILENAME,'-01.CSV','.CSV')

DECLARE @INTRESULT INT
DECLARE @FILEDATE VARCHAR(10)
IF LEN(@TRADEDATE) = 10 AND CHARINDEX('/',@TRADEDATE) > 0
	SET @TRADEDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @TRADEDATE,103),109)

SET @INTRESULT = 1
IF @FILETYPE = 'CONTRACT'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'CO' AND LEFT(@FILENAME,6) <> 'EQD_CO' AND LEFT(@FILENAME,10) <> 'EQD_SPD_CO' AND LEFT(@FILENAME,9) <> 'EQD_CC_CO'
	BEGIN
		SET @INTRESULT = 0	
	END
END

IF @FILETYPE = 'TRADE'
BEGIN
	
	IF LEFT(@FILENAME,3) <> 'EQD'
	BEGIN
		SET @INTRESULT =0	
	END
END


IF @FILETYPE = 'RATE'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'MS'
	BEGIN
		SET @INTRESULT = 0	
	END
END

IF @FILETYPE = 'POSITION'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'PO'
	BEGIN
		SET @INTRESULT = 0	
	END
	
END

IF @FILETYPE = 'MARGIN'
BEGIN
	
	IF LEFT(@FILENAME,2) <> 'MG'
	BEGIN
		SET @INTRESULT = 0	
	END
END
IF @FILETYPE <> 'CONTRACT'
BEGIN
	
	IF @INTRESULT = 1
	BEGIN
		SET @FILEDATE = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
		
		IF LEFT(CONVERT(DATETIME,@FILEDATE),11) <> LEFT(CONVERT(DATETIME,@TRADEDATE),11)
		BEGIN
			SET @INTRESULT = 0	
		END
	END	
END

SELECT @INTRESULT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_ALLOCATIONMAPPING
-- --------------------------------------------------

CREATE PROCEDURE PROC_ALLOCATIONMAPPING AS

UPDATE FOEXERCISEALLOCATION_TEMP SET PARTY_CODE = A.NEWPARTY_CODE FROM  PARTYMAPPING A WHERE A.OLDPARTY_CODE = FOEXERCISEALLOCATION_TEMP.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_BULK_INS
-- --------------------------------------------------
CREATE PROC [DBO].[PROC_BULK_INS] (@TABLENAME VARCHAR(100), @FILENAME VARCHAR(200), @PARSESTRING VARCHAR(2) = ',') AS 

DECLARE @STRSQL VARCHAR(500)

SET @STRSQL = 'TRUNCATE TABLE ' + @TABLENAME
EXEC(@STRSQL)

SET @STRSQL = 'BULK INSERT  ' + @TABLENAME + ' FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = ''' + @PARSESTRING + ''', ROWTERMINATOR = ''\N'' )'
EXEC(@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CALCULATE_CHARGES
-- --------------------------------------------------
CREATE PROC [DBO].[PROC_CALCULATE_CHARGES]   
(
	@SAUDA_DATE VARCHAR(11),  
	@FROMPARTY VARCHAR(10)='',  
	@TOPARTY VARCHAR(10)='ZZZZZZZZ'  
)  
AS  

/*
===============================================================================================
PROC NAME		: PROC_CALCULATE_CHARGES
DESCRIPTION		: COMPUTING CHARGES AS PER DEFINED IN TBL_CHARGES_DETAILS
DATE			: 21 JUN 2008
MODIFICATION LOG	:
===============================================================================================
*/  

DECLARE 
	@SQL VARCHAR(2000),  
	@RULECURSOR CURSOR,  
	@RULE_CODE VARCHAR(10),   
	@RULE_TYPE VARCHAR(20),   
	@RULE_DEFINATION VARCHAR(2000),  
	@CHARGE_CODE VARCHAR(10)  
  
IF (SELECT COUNT(1)    
 FROM   (SELECT TOP 1 PARTY_CODE    
   FROM   BFOSETTLEMENT (NOLOCK)
   WHERE  SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND BFOSETTLEMENT.TRADEQTY > 0   
	AND AUCTIONPART <> 'CA') A) = 0   
    BEGIN    
      RETURN    
    END    


/*-----------------------------------------------------------------------------------------------------
				CREATING TEMP TABLES
------------------------------------------------------------------------------------------------------*/
CREATE TABLE #CLIENT
(
	PARTY_CODE VARCHAR(10)
)  

INSERT INTO #CLIENT 
SELECT 
	PARTY_CODE 
FROM
	CLIENT1 (NOLOCK), CLIENT2 (NOLOCK)
WHERE
	CLIENT1.CL_CODE = CLIENT2.CL_CODE
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
	AND CL_TYPE <> 'INS'

CREATE CLUSTERED INDEX IDXPARTY ON #CLIENT (PARTY_CODE)

CREATE TABLE #TBL_CHARGES_DATA
(
	[PARTY_CODE] [VARCHAR] (50)  ,
	[CHARGE_CODE] [VARCHAR] (10)  ,
	[CHARGE_AMOUNT] [NUMERIC](18, 4)  ,
	[RULE_CODE] [VARCHAR] (10) 
) 


CREATE CLUSTERED INDEX IDXPARTY ON #TBL_CHARGES_DATA (PARTY_CODE)

CREATE TABLE #BFOSETTLEMENT
(
	PARTY_CODE VARCHAR(10),
	AUCTIONPART VARCHAR(2),
	SELL_BUY INT,
	TRADEQTY INT,
	MARKETRATE MONEY,
	BROKAPPLIED MONEY
)

CREATE CLUSTERED INDEX IDXPARTY ON #BFOSETTLEMENT (PARTY_CODE)

/*-----------------------------------------------------------------------------------------------------
			RE CALCULATING OTHER CHARGES ACTUAL CHARGES
------------------------------------------------------------------------------------------------------*/

UPDATE BFOSETTLEMENT  
SET   OTHER_CHRG =   
 ((FLOOR((((FOCLIENTTAXES.FUT_OTHER_CHRG * (MARKETRATE) * TRADEQTY) / 100) *  
 POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /   
 (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /   
 POWER(10,FOCLIENTTAXES.ROUND_TO))  
FROM   BFOTAXES (NOLOCK),FOCLIENTTAXES (NOLOCK)   
WHERE  
 SAUDA_DATE >= @SAUDA_DATE  
 AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
 AND BFOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE  
 AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO 
 AND BFOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
 AND TRADEQTY > 0  
 AND AUCTIONPART <> 'CA'  


/*-----------------------------------------------------------------------------------------------------
				FECHING DATA TO TEMP TABLES
------------------------------------------------------------------------------------------------------*/

INSERT INTO #BFOSETTLEMENT
SELECT 
	PARTY_CODE,AUCTIONPART,SELL_BUY,
	TRADEQTY=SUM(TRADEQTY),
	MARKETRATE = SUM(MARKETRATE* TRADEQTY) / SUM(TRADEQTY),
	BROKAPPLIED = SUM(BROKAPPLIED*TRADEQTY)/SUM(TRADEQTY)
FROM BFOSETTLEMENT (NOLOCK)
WHERE
	SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND AUCTIONPART <> 'CA'
	AND TRADEQTY > 0
	--AND STATUS <> 'E'   
GROUP BY
	PARTY_CODE,AUCTIONPART,SELL_BUY

  
INSERT INTO #TBL_CHARGES_DATA  
SELECT 
	PARTY_CODE, CHARGE_CODE = '0',   
	TOTALCHARGE = SUM(OTHER_CHRG), RULE_CODE = ''
FROM 
	BFOSETTLEMENT  (NOLOCK)
WHERE 
	SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
GROUP BY
	PARTY_CODE  
HAVING SUM(OTHER_CHRG) <> 0   
  
/*-----------------------------------------------------------------------------------------------------
				COMPUTING COMMON CHARGES
------------------------------------------------------------------------------------------------------*/

INSERT INTO #TBL_CHARGES_DATA  
SELECT
	PARTY_CODE, CHARGE_CODE,    
	TOTALCHARGE = PRADNYA.DBO.FNMINMAX(SUM(TOTALAMT+TRDAMT+DELAMT+TRDBUYAMT+TRDSELLAMT  
        		 +DELBUYAMT+DELSELLAMT+TOTALBUY+TOTALSELL),MIN_CHARGE, MAX_CHARGE)+FIX_CHARGE, 
	CHARGE_RULE 
FROM (  
	SELECT S.PARTY_CODE, CHARGE_CODE, CHARGE_RULE, MIN_CHARGE, MAX_CHARGE, FIX_CHARGE,   
	TOTALAMT = (CASE WHEN CHARGE_BY = 'FLAT'   
	     THEN (CASE WHEN VAL_PER = 'V'  
	       THEN (CASE WHEN CHARGE_ON = 'NOTRAN'   
	            THEN CEILING(CONVERT(NUMERIC(18,4),COUNT(1))/  
	            (CASE WHEN ISNULL(UNIT,0) = 0   
	               THEN 1   
	               ELSE UNIT   
	             END)) * RATE  
	            ELSE RATE  
	          END)  
	       ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	            THEN SUM(TRADEQTY*MARKETRATE)*RATE/100  
	            WHEN CHARGE_ON = 'BROK'   
	            THEN SUM(TRADEQTY*BROKAPPLIED)*RATE/100   
	            ELSE 0  
	          END)  
	        END)  
	     ELSE 0  
	   END),  
	TRDAMT = (CASE WHEN CHARGE_BY = 'TRD'   
	     THEN SUM(CASE WHEN AUCTIONPART =''
	          THEN (CASE WHEN VAL_PER = 'V'  
	               THEN RATE  
	            ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)           
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	DELAMT = (CASE WHEN CHARGE_BY = 'DEL'   
	     THEN SUM(CASE WHEN AUCTIONPART = 'EA'
	          THEN (CASE WHEN VAL_PER = 'V'  
	               THEN RATE  
	            ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
			 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	TRDBUYAMT = (CASE WHEN CHARGE_BY = 'TRD_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART='' AND SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TRDSELLAMT = (CASE WHEN CHARGE_BY = 'TRD_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART='' AND SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELBUYAMT = (CASE WHEN CHARGE_BY = 'DEL_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART='EA' AND SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELSELLAMT = (CASE WHEN CHARGE_BY = 'DEL_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART='EA' AND SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALBUY = (CASE WHEN CHARGE_BY = 'BUY'   
	      THEN SUM(CASE WHEN SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALSELL = (CASE WHEN CHARGE_BY = 'SELL'   
	      THEN SUM(CASE WHEN SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)           
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END)  
	FROM 
		#BFOSETTLEMENT S (NOLOCK), TBL_CHARGE_DETAIL T (NOLOCK), #CLIENT C1 (NOLOCK)
	WHERE 
		C1.PARTY_CODE = S.PARTY_CODE  
		AND T.PARTY_CODE = 'ALL'  
		AND S.PARTY_CODE NOT IN (  
			    SELECT PARTY_CODE FROM TBL_CHARGE_DETAIL T1  
			       WHERE T.CHARGE_CODE = T1.CHARGE_CODE  
			    AND @SAUDA_DATE BETWEEN T1.FROMDATE AND T1.TODATE  
			    AND T1.PARTY_CODE <> 'ALL' )  
	GROUP BY 
		S.PARTY_CODE, CHARGE_CODE, CHARGE_RULE,   
		CHARGE_BY, RATE, VAL_PER, CHARGE_ON, UNIT, MIN_CHARGE, MAX_CHARGE, FIX_CHARGE
	) A  
GROUP BY 
	PARTY_CODE, CHARGE_CODE, CHARGE_RULE, MIN_CHARGE, MAX_CHARGE, FIX_CHARGE    

/*-----------------------------------------------------------------------------------------------------
			COMPUTING PARTY SEPECIFIC CHARGES
------------------------------------------------------------------------------------------------------*/

INSERT INTO #TBL_CHARGES_DATA  
SELECT 
	PARTY_CODE, CHARGE_CODE,   
	TOTALCHARGE = PRADNYA.DBO.FNMINMAX(SUM(TOTALAMT+TRDAMT+DELAMT+TRDBUYAMT+TRDSELLAMT  
        		 +DELBUYAMT+DELSELLAMT+TOTALBUY+TOTALSELL),MIN_CHARGE, MAX_CHARGE)+FIX_CHARGE,  
	CHARGE_RULE
FROM (  
	SELECT S.PARTY_CODE, CHARGE_CODE, CHARGE_RULE, MIN_CHARGE, MAX_CHARGE, FIX_CHARGE,   
	TOTALAMT = (CASE WHEN CHARGE_BY = 'FLAT'   
	     THEN (CASE WHEN VAL_PER = 'V'  
	       THEN (CASE WHEN CHARGE_ON = 'NOTRAN'   
	            THEN CEILING(CONVERT(NUMERIC(18,4),COUNT(1))/  
	            (CASE WHEN ISNULL(UNIT,0) = 0   
	               THEN 1   
	               ELSE UNIT   
	             END)) * RATE  
	            ELSE RATE  
	          END)  
	       ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	            THEN SUM(TRADEQTY*MARKETRATE)*RATE/100  
	            WHEN CHARGE_ON = 'BROK'   
	            THEN SUM(TRADEQTY*BROKAPPLIED)*RATE/100   
	            ELSE 0  
	          END)  
	        END)  
	     ELSE 0  
	   END),  
	TRDAMT = (CASE WHEN CHARGE_BY = 'TRD'   
	     THEN SUM(CASE WHEN AUCTIONPART =''   
	          THEN (CASE WHEN VAL_PER = 'V'  
	               THEN RATE  
	            ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)           
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	DELAMT = (CASE WHEN CHARGE_BY = 'DEL'   
	     THEN SUM(CASE WHEN AUCTIONPART ='EA' 
	          THEN (CASE WHEN VAL_PER = 'V'  
	               THEN RATE  
	            ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	TRDBUYAMT = (CASE WHEN CHARGE_BY = 'TRD_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART ='' AND SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TRDSELLAMT = (CASE WHEN CHARGE_BY = 'TRD_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART ='' AND SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELBUYAMT = (CASE WHEN CHARGE_BY = 'DEL_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART ='EA' AND SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELSELLAMT = (CASE WHEN CHARGE_BY = 'DEL_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART ='EA' AND SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALBUY = (CASE WHEN CHARGE_BY = 'BUY'   
	      THEN SUM(CASE WHEN SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALSELL = (CASE WHEN CHARGE_BY = 'SELL'   
	      THEN SUM(CASE WHEN SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*MARKETRATE)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED)*RATE/100   
	                 ELSE 0  
	               END)           
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END)  
	FROM 
		#BFOSETTLEMENT S (NOLOCK), TBL_CHARGE_DETAIL T (NOLOCK),  #CLIENT C1 (NOLOCK)
	WHERE 
		C1.PARTY_CODE = S.PARTY_CODE  
		AND S.PARTY_CODE = T.PARTY_CODE  
	GROUP BY 
		S.PARTY_CODE, CHARGE_CODE, CHARGE_RULE,   
		CHARGE_BY, RATE, VAL_PER, CHARGE_ON, UNIT, MIN_CHARGE, MAX_CHARGE, FIX_CHARGE
	) A  
GROUP BY
	PARTY_CODE, CHARGE_CODE, CHARGE_RULE, MIN_CHARGE, MAX_CHARGE, FIX_CHARGE  
  
DELETE FROM #TBL_CHARGES_DATA  
WHERE SAUDA_DATE >= @SAUDA_DATE  
      AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'   
   AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_CHARGE_PARTY_EXCEPTION  
             WHERE @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO)

/*-----------------------------------------------------------------------------------------------------
					APPLYING RULES 
------------------------------------------------------------------------------------------------------*/

SET @RULECURSOR = CURSOR FOR  
SELECT 
	DISTINCT R.RULE_CODE, RULE_TYPE, RULE_DEFINITION, CHARGE_CODE   
FROM 
	#TBL_CHARGES_DATA T, TBL_RULE_MASTER R  
WHERE 
	R.RULE_CODE = T.RULE_CODE  
	AND T.RULE_CODE <> ''  
ORDER BY
	R.RULE_CODE  

OPEN @RULECURSOR  
FETCH NEXT FROM @RULECURSOR INTO @RULE_CODE, @RULE_TYPE, @RULE_DEFINATION, @CHARGE_CODE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
	SET @SQL = "DELETE FROM #TBL_CHARGES_DATA "  
	SET @SQL = @SQL + " WHERE "
	SET @SQL = @SQL + " CHARGE_CODE = '" + @CHARGE_CODE + "'"   
	IF @RULE_TYPE = 'NOT APPLICABLE'   
	BEGIN   
		SET @SQL = @SQL + " AND PARTY_CODE IN "  
	END   
	ELSE  
	BEGIN  
		SET @SQL = @SQL + " AND PARTY_CODE NOT IN "  
	END   
	SET @SQL = @SQL + " (SELECT PARTY_CODE FROM CLIENT1 C1, CLIENT2 C2 "  
	SET @SQL = @SQL + " WHERE C1.CL_CODE = C2.CL_CODE AND "  
	SET @SQL = @SQL + " PARTY_CODE BETWEEN '" + @FROMPARTY + "' AND '" + @TOPARTY + "' AND "  
	SET @SQL = @SQL + @RULE_DEFINATION + ")"  
	EXEC (@SQL)  
 FETCH NEXT FROM @RULECURSOR INTO @RULE_CODE, @RULE_TYPE, @RULE_DEFINATION, @CHARGE_CODE  
END  
CLOSE @RULECURSOR  
DEALLOCATE @RULECURSOR  

/*-----------------------------------------------------------------------------------------------------
			UPDATING FINAL CHARGES TO FO SETTLEMENT OTHER CHARGES
------------------------------------------------------------------------------------------------------*/

SELECT   PARTY_CODE,
         TOTALCHRG = SUM(CHARGE_AMOUNT)
INTO     #CHARGES
FROM     #TBL_CHARGES_DATA
WHERE    
         CHARGE_CODE <> '0'
GROUP BY PARTY_CODE
         
SELECT   PARTY_CODE,
         TRADEORDERSELL = MIN(RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY))
INTO     #SETTCHARGE
FROM     BFOSETTLEMENT
WHERE    SAUDA_DATE >= @SAUDA_DATE
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
         AND EXISTS (SELECT PARTY_CODE
                     FROM   #CHARGES
                     WHERE  #CHARGES.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE)
	AND AUCTIONPART <> 'CA'
	--AND STATUS <> 'E'
	AND TRADEQTY > 0
GROUP BY PARTY_CODE
         
UPDATE BFOSETTLEMENT
SET    OTHER_CHRG = OTHER_CHRG + TOTALCHRG
FROM   #CHARGES,
       #SETTCHARGE
WHERE  SAUDA_DATE >= @SAUDA_DATE
       AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
       AND #CHARGES.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE
       AND #SETTCHARGE.PARTY_CODE = BFOSETTLEMENT.PARTY_CODE
       AND #SETTCHARGE.TRADEORDERSELL = RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY)

/*-----------------------------------------------------------------------------------------------------
			POPULATING COMPUTED CHARGES TO CHARGES DATA 
------------------------------------------------------------------------------------------------------*/
DELETE FROM 
	TBL_CHARGES_DATA  
WHERE 
	SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  

INSERT INTO TBL_CHARGES_DATA
SELECT @SAUDA_DATE,PARTY_CODE,CHARGE_CODE,CHARGE_AMOUNT,RULE_CODE,GETDATE() FROM #TBL_CHARGES_DATA


/*--------------------------------------------  END OF THE PROCEDURE -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CLIENT_FO_LEVIESRPT
-- --------------------------------------------------
--SP_HELPTEXT PROC_CLIENT_FO_LEVIESRPT          
--CREATED BY JITENDRA GUPTA DATED 09 MAY 2008          
--MODIFIED BY JITENDRA GUPTA DATED 10 MAY 2008/06 SEP 2008/08 OCT 2008 /12 MAR 2009         
CREATE PROC [DBO].[PROC_CLIENT_FO_LEVIESRPT]            
@FROMDATE VARCHAR(11),                
@TODATE VARCHAR(11),                
@PARTY VARCHAR(20),              
@REPORTBY VARCHAR(5)--,            
--@EXCHANGE VARCHAR(15)            
AS            
/*            
 IF @EXCHANGE='NSE_FUTURES'               
    BEGIN             
   IF  @FROMDATE<GETDATE()           
    BEGIN          
     EXEC NSEFO.DBO.PROC_CLIENT_LEVIESRPT_HIST @FROMDATE,@TODATE,@PARTY,@REPORTBY            
    END          
   ELSE          
    BEGIN          
     EXEC NSEFO.DBO.PROC_CLIENT_LEVIESRPT @PARTY,@REPORTBY            
    END          
    END            
 ELSE IF  @EXCHANGE='BSE_FUTURES'           
  BEGIN    */          
   IF  @FROMDATE<GETDATE()           
    BEGIN          
     EXEC BSEFO.DBO.PROC_CLIENT_LEVIESRPT_HIST @FROMDATE,@TODATE,@PARTY,@REPORTBY            
    END            
   ELSE          
    BEGIN          
     EXEC BSEFO.DBO.PROC_CLIENT_LEVIESRPT @PARTY,@REPORTBY            
    END          
/*  END       
ELSE IF  @EXCHANGE='NSX_FUTURES'           
  BEGIN              
   IF  @FROMDATE<GETDATE()           
    BEGIN          
     EXEC NSECURFO.DBO.PROC_CLIENT_LEVIESRPT_HIST @FROMDATE,@TODATE,@PARTY,@REPORTBY            
    END            
   ELSE          
    BEGIN          
     EXEC NSECURFO.DBO.PROC_CLIENT_LEVIESRPT @PARTY,@REPORTBY            
    END     
  END               
ELSE IF  @EXCHANGE='BSX_FUTURES'           
  BEGIN              
   IF  @FROMDATE<GETDATE()           
    BEGIN          
     EXEC BSECURFO.DBO.PROC_CLIENT_LEVIESRPT_HIST @FROMDATE,@TODATE,@PARTY,@REPORTBY            
    END            
   ELSE          
    BEGIN          
     EXEC BSECURFO.DBO.PROC_CLIENT_LEVIESRPT @PARTY,@REPORTBY            
    END          
  END           */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CLIENT_LEVIESRPT
-- --------------------------------------------------
--SP_HELPTEXT PROC_CLIENT_LEVIESRPT  
--CREATED BY JITENDRA GUPTA DATED 09 MAY 2008  
CREATE PROC [DBO].[PROC_CLIENT_LEVIESRPT]          
--@FROMDATE VARCHAR(11),        MODIFIED BY JITENDRA GUPTA DATED 10 MAY 2008  
--@TODATE VARCHAR(11),          
@PARTY VARCHAR(20),        
@REPORTBY VARCHAR(5)         
AS                          
 IF @REPORTBY='SC'        
    BEGIN        
   SELECT       
   PRODUCT_CODE AS "SCRIP",      
   SERIES_CODE AS "SERIES",                             
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'    
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),GETDATE(),109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),GETDATE(),109)+' 23:59:59.000'                         
   --AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY PRODUCT_CODE,SERIES_CODE       
   ORDER BY PRODUCT_CODE       
   OPTION (FAST 1 )      
  END      
 ELSE IF @REPORTBY='CL'         
  BEGIN      
   SELECT       
   PARTY_CODE AS "CLIENT CODE",                             
   LEFT(PARTY_NAME,25) AS "CLIENT NAME",                             
   CLIENT_TYPE AS "CLIENT TYPE",      
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'       
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),GETDATE(),109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),GETDATE(),109)+' 23:59:59.000'                         
   --AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY PARTY_CODE,PARTY_NAME,CLIENT_TYPE      
   ORDER BY PARTY_CODE       
   OPTION (FAST 1 )      
  END      
 ELSE IF @REPORTBY='DT'       
    BEGIN        
   SELECT       
   SAUDA_DATE AS "DATE",    
   'SETTNO' AS "SETT. NO",--FOR MAPPING THE NO OF COLUMNS WITH CASH PROC    
   'SETTTYPE' AS "SETT. TYPE",--FOR MAPPING THE NO OF COLUMNS WITH CASH PROC      
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'       
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),GETDATE(),109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),GETDATE(),109)+' 23:59:59.000'                         
   --AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY SAUDA_DATE      
   ORDER BY SAUDA_DATE       
   OPTION (FAST 1 )      
  END      
 ELSE      
  BEGIN      
   SELECT       
   SAUDA_DATE AS "DATE",      
   PARTY_CODE AS "CLIENT CODE",           
   LEFT(PARTY_NAME,25) AS "CLIENT NAME",                             
   CLIENT_TYPE AS "CLIENT TYPE",      
   /*SUM(PRATE*PQTY + SRATE*SQTY) "TURNOVER",                            
   SUM(PBROKAMT + SBROKAMT) AS "BROKRAGE",         
   SUM(SERVICE_TAX) AS "SERVICE TAX" ,      
   SUM(TURN_TAX) AS "TRANS. CHARGE",         
   SUM(BROKER_NOTE) AS "STAMP DUTY",          
   SUM(INS_CHRG) AS "STT",                             
   SUM(OTHER_CHRG) AS "OTHER CHARGE",                               
   SUM(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG) AS "TOTAL CHARGE",*/      
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE",      
   PRODUCT_CODE AS "SCRIP",      
   SERIES_CODE AS "SERIES"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'       
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),GETDATE(),109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),GETDATE(),109)+' 23:59:59.000'                         
   --AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY SAUDA_DATE,PARTY_CODE,PARTY_NAME,CLIENT_TYPE,PRODUCT_CODE,SERIES_CODE       
   ORDER BY SAUDA_DATE       
   OPTION (FAST 1 )      
  END      
    
  
--EXEC PROC_CLIENT_LEVIESRPT '00000026','DT'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CLIENT_LEVIESRPT_HIST
-- --------------------------------------------------
--SP_HELPTEXT PROC_CLIENT_LEVIESRPT  
--CREATED BY JITENDRA GUPTA DATED 10 MAY 2008  
CREATE PROC [DBO].[PROC_CLIENT_LEVIESRPT_HIST]          
@FROMDATE VARCHAR(11),          
@TODATE VARCHAR(11),          
@PARTY VARCHAR(20),        
@REPORTBY VARCHAR(5)         
AS                          
 IF @REPORTBY='SC'        
    BEGIN        
   SELECT       
   PRODUCT_CODE AS "SCRIP",      
   SERIES_CODE AS "SERIES",                             
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'       
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY PRODUCT_CODE,SERIES_CODE       
   ORDER BY PRODUCT_CODE       
   OPTION (FAST 1 )      
  END      
 ELSE IF @REPORTBY='CL'         
  BEGIN      
   SELECT       
   PARTY_CODE AS "CLIENT CODE",                             
   LEFT(PARTY_NAME,25) AS "CLIENT NAME",                             
   CLIENT_TYPE AS "CLIENT TYPE",      
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'       
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY PARTY_CODE,PARTY_NAME,CLIENT_TYPE      
   ORDER BY PARTY_CODE       
   OPTION (FAST 1 )      
  END      
 ELSE IF @REPORTBY='DT'       
    BEGIN        
   SELECT       
   SAUDA_DATE AS "DATE",    
   'SETTNO' AS "SETT. NO",--FOR MAPPING THE NO OF COLUMNS WITH CASH PROC    
   'SETTTYPE' AS "SETT. TYPE",--FOR MAPPING THE NO OF COLUMNS WITH CASH PROC      
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'       
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY SAUDA_DATE      
   ORDER BY SAUDA_DATE       
   OPTION (FAST 1 )      
  END      
 ELSE      
  BEGIN      
   SELECT       
   SAUDA_DATE AS "DATE",      
   PARTY_CODE AS "CLIENT CODE",           
   LEFT(PARTY_NAME,25) AS "CLIENT NAME",                             
   CLIENT_TYPE AS "CLIENT TYPE",      
   /*SUM(PRATE*PQTY + SRATE*SQTY) "TURNOVER",                            
   SUM(PBROKAMT + SBROKAMT) AS "BROKRAGE",         
   SUM(SERVICE_TAX) AS "SERVICE TAX" ,      
   SUM(TURN_TAX) AS "TRANS. CHARGE",         
   SUM(BROKER_NOTE) AS "STAMP DUTY",          
   SUM(INS_CHRG) AS "STT",                             
   SUM(OTHER_CHRG) AS "OTHER CHARGE",                               
   SUM(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG) AS "TOTAL CHARGE",*/      
   SUM(CAST(ROUND(PRATE*PQTY + SRATE*SQTY,2,0) AS DECIMAL (10,2))) "TURNOVER",                            
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT,2,0) AS DECIMAL (10,2))) AS "BROKERAGE",         
   SUM(CAST(ROUND(SERVICE_TAX,2,0) AS DECIMAL (10,2))) AS "SERVICE TAX" ,      
   SUM(CAST(ROUND(TURN_TAX,2,0) AS DECIMAL (10,2))) AS "TRANS. CHARGE",         
   SUM(CAST(ROUND(BROKER_NOTE,2,0) AS DECIMAL (10,2))) AS "STAMP DUTY",          
   SUM(CAST(ROUND(INS_CHRG,2,0) AS DECIMAL (10,2))) AS "STT",                             
   SUM(CAST(ROUND(OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "OTHER CHARGE",                               
   SUM(CAST(ROUND(PBROKAMT + SBROKAMT+SERVICE_TAX+TURN_TAX+BROKER_NOTE+INS_CHRG+OTHER_CHRG,2,0) AS DECIMAL (10,2))) AS "TOTAL CHARGE",      
   PRODUCT_CODE AS "SCRIP",      
   SERIES_CODE AS "SERIES"      
   FROM BFOBILLVALAN S (NOLOCK)       
   WHERE                             
   TRADETYPE = 'BT'       
   AND S.SAUDA_DATE BETWEEN CONVERT(VARCHAR(12),@FROMDATE,109)+' 00:00:00.000' AND CONVERT(VARCHAR(12),@TODATE,109)+' 23:59:59.000'                        
   AND PARTY_CODE=@PARTY                         
   GROUP BY SAUDA_DATE,PARTY_CODE,PARTY_NAME,CLIENT_TYPE,PRODUCT_CODE,SERIES_CODE       
   ORDER BY SAUDA_DATE       
   OPTION (FAST 1 )      
  END      
    
  
--EXEC PROC_CLIENT_LEVIESRPT_HIST 'MAY 8 2008','MAY 8 2008','00000026','DT'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CLIENT_TRADES
-- --------------------------------------------------
--CREATED BY JITENDRA GUPTA DATED 31ST JULY 2008 FOR CLIENT TRADE REPORTS                    
--EXEC PROC_CLIENT_TRADES 'JUL 29 2008','00000003'      
--THIS PROCEDURE CAN BE MODIFIED AS PER REQUIREMENT B'COZ NO DATA AVAILABLE FOR TESTING.          
CREATE PROC [DBO].[PROC_CLIENT_TRADES]                              
(                              
 @SAUDA_DATE VARCHAR(11),                               
 @PARTY_CODE VARCHAR(10)                    
 )                               
AS                               
                    
              
CREATE TABLE [DBO].[#CLIENT_TRADE_NEW](              
        [ORDER_NO] [VARCHAR](16) NOT NULL,      
 [ORDER_TIME] [VARCHAR](10) NOT NULL,      
 [TRADE_NO] [VARCHAR](14) NOT NULL,      
 [TM] [VARCHAR](13) NOT NULL,      
 [QTY] [INT] NULL,      
 
 [BUYSELL] [VARCHAR](4) NOT NULL,      
 [PQTY] [INT] NULL,      
 [SQTY] [INT] NULL,      
 [RATE] [MONEY] NULL,      
 [PRATE] [MONEY] NULL,      
 [SRATE] [MONEY] NULL,      
 [BROK] [MONEY] NULL,      
 [PBROK] [MONEY] NULL,      
 [SBROK] [MONEY] NULL,      
 [NETRATE] [DECIMAL](38, 7) NULL,      
 [PNETRATE] [DECIMAL](38, 7) NULL,      
 [SNETRATE] [DECIMAL](38, 7) NULL,      
 [AMOUNT] [MONEY] NULL,      
 [PRODUCT_TYPE] [VARCHAR](5) NULL,      
 [PRODUCT_CODE] [VARCHAR](10) NULL,      
 [SERIES_CODE] [VARCHAR](20) NULL,   
 [SERIES_ID] [INT] NULL,    
[SERIESCODE] [VARCHAR](20) NULL,      
 [CONTRACTDESC] [VARCHAR](50),  
 [NOOFCONTRACT] [INT],
[LOTSIZE][NUMERIC](18,0),    
 [AMT] [DECIMAL](38, 7) NULL,      
 [PAMT] [DECIMAL](38, 7) NULL,      
 [SAMT] [DECIMAL](38, 7) NULL,      
 [AMTSTT] [DECIMAL](38, 7) NULL,      
 [PAMTSTT] [DECIMAL](38, 7) NULL,      
 [SAMTSTT] [DECIMAL](38, 7) NULL,      
 [EXPIRYDATE] [VARCHAR](11) NULL,      
 [PARTY_CODE] [VARCHAR](10) NOT NULL,      
 [SELL_BUY] [INT] NOT NULL,      
 [CONTRACTNO] [VARCHAR](14) NOT NULL,      
 [SAUDA_DATE] [VARCHAR](11) NULL,      
 [SDT] [VARCHAR](11) NULL,      
 [STRIKE_PRICE] [MONEY] NOT NULL,      
 [PSERVICE_TAX] [MONEY] NULL,      
 [SSERVICE_TAX] [MONEY] NULL,      
 [YY] [INT] NULL,      
 [MM] [INT] NULL,      
 [DD] [INT] NULL,      
 [DFLAG] [INT] NOT NULL,      
 [BROKER_CHRG] [MONEY] NULL,      
 [TURN_TAX] [MONEY] NULL,      
 [SEBI_TAX] [MONEY] NULL,      
 [OTHER_CHRG] [MONEY] NULL,      
 [PINS_CHRG] [MONEY] NULL,      
 [SINS_CHRG] [MONEY] NULL,      
 [INS_CHRG] [MONEY] NULL,      
 [SERVICE_TAX] [MONEY] NULL,      
 [NSERTAX] [MONEY] NULL,      
 [BROKERAGE] [MONEY] NULL,      
 [PBROKERAGE] [MONEY] NULL,      
 [SBROKERAGE] [MONEY] NULL,      
 [BRANCH_CD] [VARCHAR](10) NULL,      
 [SUB_BROKER] [VARCHAR](10) NOT NULL,      
 [TRADER] [VARCHAR](20) NULL,      
 [PRINTF] [TINYINT] NOT NULL,      
 [SERVICE_CHRG] [TINYINT] NOT NULL,      
 [PARTYNAME] [VARCHAR](100) NULL,      
 [L_ADDRESS1] [VARCHAR](40) NOT NULL,      
 [L_ADDRESS2] [VARCHAR](40) NULL,      
 [L_ADDRESS3] [VARCHAR](40) NULL,      
 [L_CITY] [VARCHAR](40) NULL,      
 [L_STATE] [VARCHAR](50) NULL,      
 [L_ZIP] [VARCHAR](10) NULL,      
 [SEBI_NO] [VARCHAR](25) NULL,      
 [PAN_GIR_NO] [VARCHAR](50) NULL,      
 [OFF_PHONE1] [VARCHAR](15) NULL,      
 [OFF_PHONE2] [VARCHAR](15) NULL,      
 [MAPIDID] [VARCHAR](12) NULL,      
 [MARKETAMT] [MONEY] NULL,      
 [PMARKETAMT] [MONEY] NULL,      
 [SMARKETAMT] [MONEY] NULL,      
 [SERIES] [VARCHAR](1) NOT NULL,      
 [TMARK] [VARCHAR](1) NOT NULL,      
 [SCRIPNAME] [VARCHAR](62) NULL,      
 [PSCRIPNAME] [VARCHAR](62) NULL,      
 [SSCRIPNAME] [VARCHAR](62) NULL      
) ON [PRIMARY]             
              
                    
INSERT INTO #CLIENT_TRADE_NEW        
--THIS QUERY IS REFFERED FROM NSEFO'S QUERY. MODIFICATIONS CAN BE DONE AS PER REQUIREMENT.      
       
EXEC V2_CONTSECTION 'BROKER','BROKER',@SAUDA_DATE,@PARTY_CODE,@PARTY_CODE,'','','000','ZZZ',''                  
--REFERENCE QUERY    'JUL 29 2008','00000003'  
--EXEC V2_CONTSECTION 'BROKER','BROKER', 'NOV 13 2006','ALWIND0001','ALWIND0001','','','000','ZZZZZZZZZ',''  
                    
SELECT 'BFO' AS EXCHANGE,SAUDA_DATE,            
SCRIP_CD=PRODUCT_CODE,SERIES=SERIES_CODE,--SCRIP_CD/SERIES CAN BE MODIFIED AS PER REQUIREMENT                  
SELL_BUY,            
SUM(QTY) AS QTY,RATE,            
SUM(BROKERAGE) AS BROK,            
SUM(SERVICE_TAX) AS SERTAX,            
SUM(INS_CHRG) AS STT,             
SUM(BROKER_CHRG) AS STAMPDUTY,                
SUM(TURN_TAX) AS TRANSCHRG,                  
SUM(BROKERAGE+SERVICE_TAX+BROKER_CHRG+TURN_TAX) AS BROKERAGE,            
SUM(MARKETAMT) AS AMT,                  
'SETT_NO' AS SETT_NO,'SETT_TYPE' AS SETT_TYPE,ORDER_NO, TMARK ,     
NETRATE=(      
 CASE      
  WHEN SUM(QTY)<>0       
  THEN    
 CASE   
  WHEN SELL_BUY=1  
  THEN SUM((MARKETAMT+BROKERAGE+SERVICE_TAX+BROKER_CHRG+TURN_TAX))/SUM(QTY)      
  WHEN SELL_BUY=2  
  THEN SUM((MARKETAMT-(BROKERAGE+SERVICE_TAX+BROKER_CHRG+TURN_TAX)))/SUM(QTY)      
 END  
  ELSE 0.00      
  END       
 )      
,    
--COMMENTED BY JITENDRA GUPTA DATED 2ND AUG 2008 IN ORDER TO HANDEL DIVIDE BY ZERO ERROR    
      
--SUM((MARKETAMT+BROKERAGE+SERVICE_TAX+BROKER_CHRG+TURN_TAX))/SUM(QTY) AS NETRATE,                
           
  NETAMT=(  
CASE  
WHEN SELL_BUY=1  
THEN SUM((MARKETAMT+BROKERAGE+SERVICE_TAX+BROKER_CHRG+TURN_TAX))  
  
WHEN SELL_BUY=2  
THEN SUM((MARKETAMT-(BROKERAGE+SERVICE_TAX+BROKER_CHRG+TURN_TAX)))  
  
END  
)  
--SUM((MARKETAMT+BROKERAGE+SERVICE_TAX+BROKER_CHRG+TURN_TAX)) AS NETAMT                      
FROM #CLIENT_TRADE_NEW                    
GROUP BY PRODUCT_CODE,SERIES_CODE,ORDER_NO,SAUDA_DATE,SELL_BUY,RATE,TMARK

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CLOSINGRATE
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[PROC_CLOSINGRATE] 
(
@SCRIPCDFROM VARCHAR(12),      
@SCRIPCDTO VARCHAR(12),       
@SDATE VARCHAR(14),
@MARKET VARCHAR(12)    
)  
AS  
SELECT  
--DISTINCT LEFT(CONVERT(VARCHAR,TRADE_DATE,106),11) AS TRADE_DATE,  
PRODUCT_TYPE AS "PRODUCT TYPE",PRODUCT_CODE AS "PRODUCT CODE",
SERIES_CODE "SERIES CODE",SERIES_ID AS "SERIES ID",CL_RATE AS "CLOSING RATE"
--LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) AS EXPDATE,  
--YEAR(TRADE_DATE), MONTH(TRADE_DATE), DAY(TRADE_DATE)  
FROM BFOCLOSING  
WHERE   
SERIES_CODE LIKE  @SCRIPCDFROM  + '%'  
AND TRADE_DATE >= (CONVERT(DATETIME,@SDATE,105))  
AND TRADE_DATE <= (CONVERT(DATETIME,@SDATE,105)+1)  
ORDER BY SERIES_CODE,DAY(TRADE_DATE), MONTH(TRADE_DATE), YEAR(TRADE_DATE)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_DEL_TRADE
-- --------------------------------------------------
CREATE PROC [DBO].[PROC_DEL_TRADE]
(
	@PARTYCODE VARCHAR(10),
	@SYMBOL VARCHAR(20),
	@INSTTYPE VARCHAR(6),
	@EXPIRYDATE VARCHAR(11),
	@STRIKEPRICE MONEY,
	@OPTIONTYPE VARCHAR(2),
	@USERID VARCHAR(10),
	@CPCODE VARCHAR(15),
	@SAUDA_DATE VARCHAR(11),
	@PROCESSON VARCHAR(20) = 'FOTRADE',
	@LOGINFO VARCHAR(50),
	@PAGEADDR VARCHAR(100)
)
AS
/*
	FOTRADE
	BEGIN TRAN
	EXEC TRADE_CONSOLIDATION_INS @SAUDA_DATE='01/09/2005',@FROM_PARTY='0',@TO_PARTY='ZZZZZZZZZZ',@FROM_SYMBOL='',@TO_SYMBOL='',@FROM_TERM='',@TO_TERM='',@SCRIPT='',@CONSOLIDATE=0,@CONTRACTNO='',@AFTERCONTRACT='',@GROUPON='',@SELL_BUY=0,@LEVEL=601,@PARTICIPANT='',@ORDER_NO='',@SHOW=0,@TRFTABLE='FOTRADE'
	EXEC PROC_DEL_TRADE 'B00034460', 'NAGARFERT', 'FUTSTK', '29/09/2005', 0, '', '146', '10412', '01/09/2005', 'FOTRADE', 'HEMANTT/BROKER', '/FC.INTERFACE/INNERREPORT.ASPX'
	EXEC PROC_DEL_TRADE 'C000000001', 'NAGARFERT', 'FUTSTK', '29/09/2005', 0, '', '146', '10412', '01/09/2005', 'FOTRADE', 'HEMANTT/BROKER', '/FC.INTERFACE/INNERREPORT.ASPX'
	EXEC PROC_DEL_TRADE 'C00031958', 'NAGARFERT', 'FUTSTK', '29/09/2005', 0, '', '146', '10412', '01/09/2005', 'FOTRADE', 'HEMANTT/BROKER', '/FC.INTERFACE/INNERREPORT.ASPX'
	SELECT * FROM INST_LOG ORDER BY TIMESTAMP DESC
	SELECT * FROM FOTRADE_DELLOG
	SELECT * FROM FOTRADE WHERE PARTY_CODE = 'B00034460'
	SELECT * FROM FOTRADE WHERE PARTY_CODE = 'C000000001'
	SELECT * FROM FOTRADE WHERE PARTY_CODE = 'C00031958'
	ROLLBACK
*/
IF LEN(@SAUDA_DATE) = 10 AND CHARINDEX('/', @SAUDA_DATE) > 0
	BEGIN
		SET @SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
	END
IF LEN(@EXPIRYDATE) = 10 AND CHARINDEX('/', @EXPIRYDATE) > 0
	BEGIN
		SET @EXPIRYDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EXPIRYDATE, 103), 109)
	END
IF @PROCESSON = 'FOTRADE'
	BEGIN
		INSERT INTO INST_LOG
		(PARTY_CODE, NEW_PARTY_CODE, SAUDA_DATE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,
		ORDER_NO, TRADE_NO, SELL_BUY, CONTRACT_NO, NEW_CONTRACT_NO, BROKERAGE, NEW_BROKERAGE, MARKET_RATE,
		NEW_MARKET_RATE, NET_RATE, NEW_NET_RATE, QTY, NEW_QTY, ROUNDTO, PARTICIPANT_CODE, NEW_PARTICIPANT_CODE,
		USERNAME, MODULE, CALLED_FROM, TIMESTAMP, EXTRAFIELD3, EXTRAFIELD4, EXTRAFIELD5)
		VALUES (@PARTYCODE, '', @SAUDA_DATE, @INSTTYPE, @SYMBOL, @EXPIRYDATE, @STRIKEPRICE, @OPTIONTYPE,
				'', '', 0, '', '', 0, 0, 0, 0, 0, 0, 0, 0, 0, @CPCODE, '',
				@LOGINFO, @PAGEADDR, 'PROC_DEL_TRADE', GETDATE(), 'TRADE DELETION', '', '')

		INSERT INTO FOTRADE_DELLOG
		(
			TRADE_NO,
			STATUS,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			SEC_NAME,
			BOOKTYPE,
			BOOKTYPENAME,
			MARKETTYPE,
			USER_ID,
			BRANCH_ID,
			SELL_BUY,
			TRADEQTY,
			PRICE,
			PRO_CLI,
			PARTY_CODE,
			PARTICIPANTCODE,
			O_C_FLAG,
			C_U_FLAG,
			ACTIVITYTIME,
			LAST_MOD_TIME,
			ORDER_NO,
			OPP_BROKER_ID,
			SETTFLAG,
			MEMBERCODE,
			TMPARTYCODE,
			RESERVED1,
			RESERVED2,
			RESERVED3,
			RESERVED4,
			RESERVED5,
			DEL_ON,
			DEL_IP
		)
		SELECT
			TRADE_NO,
			STATUS,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			SEC_NAME,
			BOOKTYPE,
			BOOKTYPENAME,
			MARKETTYPE,
			USER_ID,
			BRANCH_ID,
			SELL_BUY,
			TRADEQTY,
			PRICE,
			PRO_CLI,
			PARTY_CODE,
			PARTICIPANTCODE,
			O_C_FLAG,
			C_U_FLAG,
			ACTIVITYTIME,
			LAST_MOD_TIME,
			ORDER_NO,
			OPP_BROKER_ID,
			SETTFLAG,
			MEMBERCODE,
			TMPARTYCODE,
			RESERVED1,
			RESERVED2,
			RESERVED3,
			RESERVED4,
			RESERVED5,
			DEL_ON = GETDATE(),
			DEL_IP = @LOGINFO
		FROM
			FOTRADE
		WHERE
			ACTIVITYTIME LIKE @SAUDA_DATE + '%'
			AND PARTY_CODE = @PARTYCODE
			AND SYMBOL = @SYMBOL
			AND INST_TYPE = @INSTTYPE
			AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
			AND STRIKE_PRICE = @STRIKEPRICE
			AND OPTION_TYPE = @OPTIONTYPE
			AND USER_ID = @USERID
			AND PARTICIPANTCODE = @CPCODE

		DELETE
		FROM
			FOTRADE
		WHERE
			ACTIVITYTIME LIKE @SAUDA_DATE + '%'
			AND PARTY_CODE = @PARTYCODE
			AND SYMBOL = @SYMBOL
			AND INST_TYPE = @INSTTYPE
			AND EXPIRYDATE LIKE @EXPIRYDATE + '%'
			AND STRIKE_PRICE = @STRIKEPRICE
			AND OPTION_TYPE = @OPTIONTYPE
			AND USER_ID = @USERID
			AND PARTICIPANTCODE = @CPCODE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_FO_INTEROP
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_FO_INTEROP]
(
	@SAUDA_DATE VARCHAR(11),
	@SETT_NO	VARCHAR(7),
	@SETT_TYPE	VARCHAR(2) 
)
AS
/*
ALTER TABLE TBL_INTEROP_SETTING
ADD MERGE_DELIVERY INT
GO
ALTER TABLE TBL_INTEROP_SETTING
ADD MERGE_DATE DATETIME
GO

UPDATE TBL_INTEROP_SETTING SET MERGE_DELIVERY = 1, MERGE_DATE ='MAR  1 2023'
*/
DECLARE @CLEARINGCODE		VARCHAR(10),
		@OTHER_SETT_NO		VARCHAR(7),
		@OTHER_SETT_TYPE	VARCHAR(2),
		@MERGE_DELIVERY		INT,
		@MERGE_DATE			DATETIME

SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,''), @MERGE_DELIVERY = ISNULL(MERGE_DELIVERY,0), @MERGE_DATE = ISNULL(MERGE_DATE,'DEC 31 2049') 
FROM TBL_INTEROP_SETTING
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

IF @MERGE_DELIVERY > 0 AND CONVERT(DATETIME,@SAUDA_DATE) >= @MERGE_DATE 
BEGIN
	IF @CLEARINGCODE = 'NSCCL'
	BEGIN
		SELECT @OTHER_SETT_NO = SETT_NO, @OTHER_SETT_TYPE = SETT_TYPE FROM MSAJAG.DBO.SETT_MST 
		WHERE START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE='M'
		
		DELETE FROM ACCBILL_ORG WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		INSERT INTO ACCBILL_ORG
		SELECT * FROM ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		DELETE FROM ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		EXEC MSAJAG.DBO.VALAN_INTEROP @OTHER_SETT_NO, @OTHER_SETT_TYPE, @SETT_NO, @SETT_TYPE, 'FO'
		
		DELETE FROM MSAJAG.DBO.DELIVERYCLT_ORG WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE

		INSERT INTO MSAJAG.DBO.DELIVERYCLT_ORG
		SELECT * FROM MSAJAG.DBO.DELIVERYCLT WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		DELETE FROM MSAJAG.DBO.DELIVERYCLT WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		DELETE FROM MSAJAG.DBO.DELNET WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE

		EXEC MSAJAG.DBO.DELIVERY_INTEROP @OTHER_SETT_NO, @OTHER_SETT_TYPE, @SETT_NO, @SETT_TYPE, 'FO'
	END
	 
	IF @CLEARINGCODE = 'ICCL'
	BEGIN
		SELECT @OTHER_SETT_NO = SETT_NO, @OTHER_SETT_TYPE = SETT_TYPE FROM BSEDB.DBO.SETT_MST 
		WHERE START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE='RD'
		
		DELETE FROM ACCBILL_ORG WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		INSERT INTO ACCBILL_ORG
		SELECT * FROM ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		DELETE FROM ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		EXEC BSEDB.DBO.VALAN_INTEROP @OTHER_SETT_NO, @OTHER_SETT_TYPE, @SETT_NO, @SETT_TYPE, 'FO'
		
		DELETE FROM BSEDB.DBO.DELIVERYCLT_ORG WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE

		INSERT INTO BSEDB.DBO.DELIVERYCLT_ORG
		SELECT * FROM BSEDB.DBO.DELIVERYCLT WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		
		DELETE FROM BSEDB.DBO.DELIVERYCLT WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
		DELETE FROM BSEDB.DBO.DELNET WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE

		EXEC BSEDB.DBO.DELIVERY_INTEROP @OTHER_SETT_NO, @OTHER_SETT_TYPE, @SETT_NO, @SETT_TYPE, 'FO'
	END 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_REPORTING
-- --------------------------------------------------
CREATE PROC [DBO].[PROC_MARGIN_REPORTING]
(
           @SAUDA_DATE VARCHAR(11),
           @FROMPARTY  VARCHAR(10),
           @TOPARTY    VARCHAR(10)
)
AS

  DECLARE  @PREVDATE VARCHAR(11)
  DECLARE  @SDTCUR VARCHAR(11)
  DECLARE  @LDTCUR VARCHAR(11)
                     
  SELECT @PREVDATE = LEFT(MAX(TRADE_DATE),11)
  FROM   BFOCLOSING
  WHERE  TRADE_DATE < @SAUDA_DATE

SELECT	@SDTCUR = LEFT(SDTCUR,11) ,
	@LDTCUR = LEFT(LDTCUR,11)
FROM	ACCOUNTBFO.DBO.PARAMETER P
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR 

CREATE TABLE #MARGINREPORTING
(
	PARTY_CODE 	VARCHAR(12),
	PREV_CASH  	NUMERIC(18,4),
	PREV_FD  	NUMERIC(18,4),
	PREV_BG 	NUMERIC(18,4),
	PREV_SEC  	NUMERIC(18,4),
	PREV_VAR  	NUMERIC(18,4),
	CURR_CASH  	NUMERIC(18,4),
	CURR_FD  	NUMERIC(18,4),
	CURR_BG  	NUMERIC(18,4),
	CURR_SEC  	NUMERIC(18,4),
	MAR_ADJUST  	NUMERIC(18,4),
	MAR_STATUS  	NUMERIC(18,4)
)
 
 CREATE  INDEX [MINDX] ON [DBO].[#MARGINREPORTING] ( [PARTY_CODE])

  INSERT INTO   #MARGINREPORTING                     
  SELECT DISTINCT PARTY_CODE,
                  PREV_CASH = 0,
                  PREV_FD = 0,
                  PREV_BG = 0,
                  PREV_SEC = 0,
                  PREV_VAR = 0,
                  CURR_CASH = 0,
                  CURR_FD = 0,
                  CURR_BG = 0,
                  CURR_SEC = 0,
                  MAR_ADJUST = 0,
                  MAR_STATUS = 0
  FROM   BFOMARGINCOLL
  WHERE  FILE_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
         AND CL_TYPE <> 'F'


                        
  UPDATE #MARGINREPORTING
  SET    PREV_CASH = C.CASH,
         PREV_FD = C.FD,
         PREV_BG = C.BG,
         PREV_SEC = C.SEC
  FROM   (SELECT   PARTY_CODE,
                   FD = SUM(CASE 
                              WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT
                              ELSE 0
                            END),
                   BG = SUM(CASE 
                              WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT
                              ELSE 0
                            END),
                   SEC = SUM(CASE 
                               WHEN COLL_TYPE = 'SEC' THEN FINALAMOUNT
                               ELSE 0
                             END),
                   CASH = SUM(CASE 
                                WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT
                                ELSE 0
                              END)
          FROM     MSAJAG.DBO.COLLATERALDETAILS
          WHERE    EFFDATE BETWEEN @PREVDATE  AND @PREVDATE + ' 23:59'
                   AND EXCHANGE = 'BSE'
                   AND SEGMENT = 'FUTURES'
          GROUP BY PARTY_CODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE
                                       
  UPDATE #MARGINREPORTING
  SET    PREV_VAR = MARGIN
  FROM   (SELECT   PARTY_CODE,
                   MARGIN = SUM(ABS(INIT_MARGIN)+ABS(MTM_MARGIN))
       	  FROM     BFOMARGINCOLL
          WHERE    FILE_DATE BETWEEN @PREVDATE  AND  @PREVDATE + ' 23:59'
                   AND CL_TYPE <> 'F'
                   AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
          GROUP BY PARTY_CODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE
                                       
  UPDATE #MARGINREPORTING
  SET    CURR_CASH = C.CASH - PREV_CASH,
         CURR_FD = C.FD - PREV_FD,
         CURR_BG = C.BG - PREV_BG,
         CURR_SEC = C.SEC - PREV_SEC
  FROM   (SELECT   PARTY_CODE,
                   FD = SUM(CASE 
                              WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT
                              ELSE 0
                            END),
                   BG = SUM(CASE 
                              WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT
                              ELSE 0
                            END),
                   SEC = SUM(CASE 
                               WHEN COLL_TYPE = 'SEC' THEN FINALAMOUNT
                               ELSE 0
                             END),
                   CASH = SUM(CASE 
                                WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT
                                ELSE 0
                              END)
          FROM     MSAJAG.DBO.COLLATERALDETAILS
          WHERE    EFFDATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
                   AND EXCHANGE = 'BSE'
                   AND SEGMENT = 'FUTURES'
          GROUP BY PARTY_CODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE
                                       
  UPDATE #MARGINREPORTING
SET    PREV_CASH = PREV_CASH + LEDBAL
FROM   (SELECT   CLTCODE,
                 LEDBAL = SUM(CASE 
                                WHEN DRCR = 'C' THEN VAMT
                                ELSE -VAMT
                              END)
        FROM     ACCOUNTBFO.DBO.LEDGER L (NOLOCK)
        WHERE    VDT >= @SDTCUR
                 AND VDT <= @LDTCUR
                 AND EDT < @SAUDA_DATE
                 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
        GROUP BY CLTCODE) L
WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE
                   
UPDATE #MARGINREPORTING
SET    PREV_CASH = PREV_CASH + LEDBAL
FROM   (SELECT   CLTCODE,
                 LEDBAL = SUM(CASE 
                                WHEN DRCR = 'C' THEN -VAMT
                                ELSE VAMT
                              END)
        FROM     ACCOUNTBFO.DBO.LEDGER L (NOLOCK)
        WHERE    VDT < @SAUDA_DATE
                 AND VDT < @SDTCUR
                 AND EDT >= @SDTCUR
                 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
        GROUP BY CLTCODE) L
WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE
                   
UPDATE #MARGINREPORTING
SET    CURR_CASH = CURR_CASH + LEDBAL
FROM   (SELECT   CLTCODE,
                 LEDBAL = SUM(CASE 
                                WHEN DRCR = 'C' THEN VAMT
                                ELSE -VAMT
                              END)
        FROM     ACCOUNTBFO.DBO.LEDGER L (NOLOCK)
        WHERE    VDT >= @SDTCUR
                 AND VDT <= @LDTCUR
                 AND EDT LIKE @SAUDA_DATE + '%'
                 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
        GROUP BY CLTCODE) L
WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE
                   
UPDATE #MARGINREPORTING
SET    CURR_CASH = CURR_CASH + LEDBAL
FROM   (SELECT   CLTCODE,
                 LEDBAL = SUM(CASE 
                                WHEN DRCR = 'C' THEN -VAMT
                                ELSE VAMT
                              END)
        FROM     ACCOUNTBFO.DBO.LEDGER L (NOLOCK)
        WHERE    VDT LIKE @SAUDA_DATE + '%'
                 AND VDT < @SDTCUR
                 AND EDT >= @SDTCUR
                 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
        GROUP BY CLTCODE) L
WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE
                     
  UPDATE #MARGINREPORTING
  SET    MAR_ADJUST = MARGIN
  FROM   (SELECT   PARTY_CODE,
                   MARGIN = SUM(ABS(INIT_MARGIN)+ABS(MTM_MARGIN))
          FROM     BFOMARGINCOLL
          WHERE    FILE_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
                   AND CL_TYPE <> 'F'
                   AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
          GROUP BY PARTY_CODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE
                                       
  UPDATE #MARGINREPORTING
  SET    MAR_STATUS = PREV_CASH + PREV_FD + PREV_BG + PREV_SEC - PREV_VAR + 
	 CURR_CASH + CURR_FD + CURR_BG + CURR_SEC - MAR_ADJUST
                                                                                                                       
  DELETE FROM MARGIN_REPORTING
  WHERE       SAUDA_DATE = @SAUDA_DATE
              AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
                                                    
  INSERT INTO MARGIN_REPORTING
  SELECT @SAUDA_DATE,
         *,
         GETDATE()
  FROM   #MARGINREPORTING

  DROP TABLE #MARGINREPORTING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TOTTAX_SLAB_SCRIP
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_TOTTAX_SLAB_SCRIP] 
	(
	@SAUDA_DATE VARCHAR(11)
	)

AS

DECLARE @TOTCUR CURSOR 
DECLARE @FROM_TOT NUMERIC(18, 4) 
DECLARE @TO_TOT NUMERIC(18, 4) 
DECLARE @CHARGE_PER NUMERIC(18,6)
DECLARE @PARTY_CODE VARCHAR(10) 
DECLARE @DIFF NUMERIC(18, 4) 
DECLARE @TURN_TAX NUMERIC(18, 4) 
DECLARE @SRNO NUMERIC(18, 0) 
DECLARE @SETTCUR CURSOR DECLARE @INST_tYPE VARCHAR(3) 
DECLARE @TRADE_TYPE VARCHAR(3) 
DECLARE @CHARGE_ON INT 
DECLARE	@EXPIRYDATE VARCHAR(11)
DECLARE	@SYMBOL VARCHAR(50)

/*
SELECT	@EXPIRYDATE = 'DEC 28 2023'
DECLARE @SAUDA_DATE VARCHAR(11)
SET		@SAUDA_DATE = 'DEC 29 2023'
*/

SELECT	INST_TYPE=B_INST_TYPE,SYMBOL=B_SYMBOL,EXPIRYDATE= MIN(B_EXPIRYDATE) --,STRIKE_PRICE=B_STRIKE_PRICE,OPTION_TYPE=B_OPTION_TYPE 
INTO	#SCRIP
FROM	TBL_FOSCRIPMAP(NOLOCK) 
WHERE	B_EXPIRYDATE >= @SAUDA_DATE + ' 23:59'
		AND EXISTS (SELECT DISTINCT SYMBOL FROM TBL_TURNOVER_SLAB_SYMBOL S(NOLOCK)
					WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE
					AND S.INST_TYPE = RIGHT(B_INST_TYPE,3)
					AND S.SYMBOL = N_SYMBOL
					)
GROUP BY
		B_INST_TYPE,B_SYMBOL --,B_STRIKE_PRICE,B_OPTION_TYPE 


CREATE NONCLUSTERED INDEX [IDXTAXSCRIP] ON [dbo].[#SCRIP]
(
	[INST_TYPE] ASC,
	[SYMBOL] ASC,
	[EXPIRYDATE] ASC
)

/*
SELECT	SYMBOL,
		EXPIRYDATE = MIN(EXPIRYDATE)
--INTO	#SCRIP
FROM	BFOSCRIP2 BS (NOLOCK)
WHERE	EXPIRYDATE >= @SAUDA_DATE + ' 23:59'
		AND EXISTS (SELECT DISTINCT SYMBOL FROM TBL_TURNOVER_SLAB_SYMBOL S(NOLOCK)
					WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE
					AND S.INST_TYPE = RIGHT(BS.INST_TYPE,3)
					AND S.SYMBOL = BS.SYMBOL
					)
		--AND SERIES_CODE LIKE 'SENSEX%'
GROUP BY
		SYMBOL
*/


UPDATE	FOSETTLEMENT 
SET		TURN_TAX = 0 
WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
		AND TURN_TAX <> 0 
		AND EXISTS (SELECT SYMBOL FROM #SCRIP S 
					WHERE S.SYMBOL = FOSETTLEMENT.SYMBOL 
					AND S.INST_TYPE = FOSETTLEMENT.INST_TYPE 
					AND S.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE 
					--AND S.STRIKE_PRICE = FOSETTLEMENT.STRIKE_PRICE 
					--AND S.OPTION_TYPE = FOSETTLEMENT.OPTION_TYPE 
					)
	

SELECT	PARTY_CODE
		,TURNOVER_P = SUM(TRADEQTY * PRICE)
		,TURNOVER_S = SUM(CASE 
				WHEN RIGHT(INST_TYPE,3) = 'FUT'
					THEN TRADEQTY * PRICE
				ELSE TRADEQTY * STRIKE_PRICE
				END)
		,TURNOVER_SP = SUM(TRADEQTY * (PRICE + STRIKE_PRICE))
		,TRADE_TYPE = (
			CASE 
				WHEN AUCTIONPART = ''
					THEN 'NRM'
				ELSE 'DEL'
				END
			)
		,INST_TYPE = RIGHT(INST_TYPE, 3)
		,SYMBOL
		,EXPIRYDATE
		,STRIKE_PRICE 
		,OPTION_TYPE 
		,CHARGE_ON = 0
		,TOTCHARG = CONVERT(NUMERIC(18, 6), 0)
		,ACTCHARG = CONVERT(NUMERIC(18, 6), 0) 
INTO	#SETT 
FROM	FOSETTLEMENT 
WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
		--AND AUCTIONPART <> 'CA'
		AND AUCTIONPART NOT IN  ('CA','EA')
		AND TRADEQTY > 0
		AND EXISTS (SELECT SYMBOL FROM #SCRIP S 
					WHERE S.SYMBOL = FOSETTLEMENT.SYMBOL 
					AND S.INST_TYPE = FOSETTLEMENT.INST_TYPE 
					AND S.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE 
					--AND S.STRIKE_PRICE = FOSETTLEMENT.STRIKE_PRICE 
					--AND S.OPTION_TYPE = FOSETTLEMENT.OPTION_TYPE 
					)
GROUP BY PARTY_CODE
		,(
			CASE 
				WHEN AUCTIONPART = ''
					THEN 'NRM'
				ELSE 'DEL'
			END )
		,LEFT(INST_TYPE, 3)
		,INST_TYPE
		,SYMBOL
		,EXPIRYDATE 
		,STRIKE_PRICE 
		,OPTION_TYPE

CREATE NONCLUSTERED INDEX [IDXFOSETT] ON [dbo].[#SETT]
(
	[PARTY_CODE] ASC,
	[INST_TYPE] ASC,
	[SYMBOL] ASC,
	[EXPIRYDATE] ASC,
	[STRIKE_PRICE] ASC,
	[OPTION_TYPE] ASC
)
	
--SELECT * FROM #SETT
--RETURN

	
SET @TOTCUR = CURSOR
FOR
SELECT	INST_TYPE
		,SYMBOL
		,TRADE_TYPE
		,CHARGE_ON
		,FROM_TOT
		,TO_TOT
		,CHARGE_PER
FROM	TBL_TURNOVER_SLAB_SYMBOL
WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE
ORDER BY 
		INST_TYPE
		,SYMBOL
		,TRADE_TYPE
		,CHARGE_ON
		,FROM_TOT
		,TO_TOT
	
OPEN @TOTCUR FETCH NEXT FROM @TOTCUR INTO @INST_TYPE
	,@SYMBOL
	,@TRADE_TYPE
	,@CHARGE_ON
	,@FROM_TOT
	,@TO_TOT
	,@CHARGE_PER WHILE @@FETCH_STATUS = 0

	BEGIN
	UPDATE	#SETT
	SET		TOTCHARG = TOTCHARG + (
			CASE 
				WHEN (
						(	
							CASE 
								WHEN @CHARGE_ON = 0	THEN TURNOVER_P
								WHEN @CHARGE_ON = 1	THEN TURNOVER_S
								WHEN @CHARGE_ON = 2	THEN TURNOVER_SP
								ELSE TURNOVER_P
							END
							) - @FROM_TOT
						) > (
						CASE 
							WHEN @TO_TOT <> - 1	THEN @TO_TOT
							ELSE (
									(
										CASE 
											WHEN @CHARGE_ON = 0	THEN TURNOVER_P
											WHEN @CHARGE_ON = 1	THEN TURNOVER_S
											WHEN @CHARGE_ON = 2	THEN TURNOVER_SP
											ELSE TURNOVER_P
										END
									) - @FROM_TOT
								)
						END
						)
					THEN @TO_TOT
				ELSE (
						(
							CASE 
								WHEN @CHARGE_ON = 0	THEN TURNOVER_P
								WHEN @CHARGE_ON = 1	THEN TURNOVER_S
								WHEN @CHARGE_ON = 2	THEN TURNOVER_SP
								ELSE TURNOVER_P
							END
						) - @FROM_TOT
					)
				END
			) * @CHARGE_PER / 100
			,CHARGE_ON = @CHARGE_ON
	WHERE	(
			CASE 
				WHEN @CHARGE_ON = 0	THEN TURNOVER_P
				WHEN @CHARGE_ON = 1	THEN TURNOVER_S
				WHEN @CHARGE_ON = 2	THEN TURNOVER_SP
				ELSE TURNOVER_P
			END
			) > @FROM_TOT
			AND INST_TYPE = @INST_TYPE
			AND SYMBOL LIKE @SYMBOL+'%'
			AND TRADE_TYPE = @TRADE_TYPE

	/*
	SELECT @FROM_TOT,@INST_TYPE,@SYMBOL,@TRADE_TYPE,@CHARGE_ON,@CHARGE_PER
	SELECT * FROM #SETT
	WHERE	(
			CASE 
				WHEN @CHARGE_ON = 0	THEN TURNOVER_P
				WHEN @CHARGE_ON = 1	THEN TURNOVER_S
				WHEN @CHARGE_ON = 2	THEN TURNOVER_SP
				ELSE TURNOVER_P
			END
			) > @FROM_TOT
			AND INST_TYPE = @INST_TYPE
			AND SYMBOL LIKE @SYMBOL+'%'
			AND TRADE_TYPE = @TRADE_TYPE
	*/

	FETCH NEXT
	FROM @TOTCUR
	INTO @INST_TYPE
		,@SYMBOL
		,@TRADE_TYPE
		,@CHARGE_ON
		,@FROM_TOT
		,@TO_TOT
		,@CHARGE_PER
END
CLOSE @TOTCUR 
DEALLOCATE @TOTCUR 



--UPDATE	#SETT 
--SET		TOTCHARG = ROUND(TOTCHARG, 2) 

UPDATE	FOSETTLEMENT 
SET		TURN_TAX = TRADEQTY * PRICE * TOTCHARG / (
		CASE 
			WHEN CHARGE_ON = 0	THEN TURNOVER_P
			WHEN CHARGE_ON = 1	THEN TURNOVER_S
			WHEN CHARGE_ON = 2	THEN TURNOVER_SP
			ELSE TURNOVER_P
		END
		) 
FROM	#SETT 
WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
		AND AUCTIONPART <> 'CA'
		AND TRADEQTY > 0
		AND FOSETTLEMENT.PARTY_CODE = #SETT.PARTY_CODE
		AND #SETT.INST_TYPE = RIGHT(FOSETTLEMENT.INST_TYPE, 3)
		AND #SETT.SYMBOL = FOSETTLEMENT.SYMBOL
		AND #SETT.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE 
		AND #SETT.STRIKE_PRICE = FOSETTLEMENT.STRIKE_PRICE 
		AND #SETT.OPTION_TYPE = FOSETTLEMENT.OPTION_TYPE   
		AND #SETT.TRADE_TYPE = (
			CASE 
				WHEN FOSETTLEMENT.AUCTIONPART = ''	THEN 'NRM'
				ELSE 'DEL'
			END
			) 
		
UPDATE	#SETT 
SET		ACTCHARG = TURN_TAX 
FROM	(
		SELECT	PARTY_CODE
				,TRADE_TYPE = (
					CASE 
						WHEN AUCTIONPART = ''
							THEN 'NRM'
						ELSE 'DEL'
					END
					)
				,INST_TYPE = RIGHT(INST_TYPE, 3)
				,SYMBOL
				,EXPIRYDATE 
				,STRIKE_PRICE 
				,OPTION_TYPE 
				,TURN_TAX = SUM(TURN_TAX)
		FROM	FOSETTLEMENT
		WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
				AND AUCTIONPART <> 'CA'
				AND TRADEQTY > 0
		GROUP BY 
				PARTY_CODE,
				(
				CASE 
					WHEN AUCTIONPART = ''
						THEN 'NRM'
					ELSE 'DEL'
				END	),
				RIGHT(INST_TYPE, 3)
				,SYMBOL
				,EXPIRYDATE 
				,STRIKE_PRICE 
				,OPTION_TYPE				
		) A 
WHERE	A.PARTY_CODE = #SETT.PARTY_CODE
		AND A.INST_TYPE = #SETT.INST_TYPE
		AND A.SYMBOL = #SETT.SYMBOL
		AND A.EXPIRYDATE = #SETT.EXPIRYDATE 
		AND A.STRIKE_PRICE = #SETT.STRIKE_PRICE  
		AND A.OPTION_TYPE = #SETT.OPTION_TYPE
		AND A.TRADE_TYPE = #SETT.TRADE_TYPE 
	
SET @TOTCUR = CURSOR
FOR
SELECT	PARTY_CODE
		,INST_TYPE
		,SYMBOL
		,TRADE_TYPE
		,DIFF = TOTCHARG - ACTCHARG
FROM	#SETT
WHERE	ACTCHARG <> TOTCHARG
ORDER BY PARTY_CODE

OPEN @TOTCUR

FETCH NEXT
FROM @TOTCUR
INTO @PARTY_CODE
	,@INST_TYPE
	,@SYMBOL
	,@TRADE_TYPE
	,@DIFF

WHILE @@FETCH_STATUS = 0
BEGIN
	SET @SETTCUR = CURSOR
	FOR

	SELECT	SRNO
			,TURN_TAX
	FROM	FOSETTLEMENT
	WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
			AND AUCTIONPART <> 'CA'
			AND TRADEQTY > 0
			AND RIGHT(INST_TYPE,3) = @INST_TYPE
			AND SYMBOL = @SYMBOL
			AND @TRADE_TYPE = (
				CASE 
					WHEN AUCTIONPART = ''
						THEN 'NRM'
					ELSE 'DEL'
					END
				)
			AND PARTY_CODE = @PARTY_CODE
			AND TURN_TAX > 0
	ORDER BY SRNO

	OPEN @SETTCUR

	FETCH NEXT
	FROM @SETTCUR
	INTO @SRNO
		,@TURN_TAX

	WHILE @@FETCH_STATUS = 0 AND @DIFF <> 0
	BEGIN
		IF @DIFF > 0
		BEGIN
			UPDATE FOSETTLEMENT
			SET TURN_TAX = TURN_TAX + @DIFF
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
				AND AUCTIONPART <> 'CA'
				AND TRADEQTY > 0
				AND RIGHT(INST_TYPE,3) = @INST_TYPE
				AND SYMBOL = @SYMBOL
				AND @TRADE_TYPE = (
					CASE 
						WHEN AUCTIONPART = ''
							THEN 'NRM'
						ELSE 'DEL'
						END
					)
				AND PARTY_CODE = @PARTY_CODE
				AND TURN_TAX > 0
				AND SRNO = @SRNO

			SET @DIFF = 0
		END
		ELSE
			IF @DIFF < 0 AND ABS(@DIFF) >= @TURN_TAX
			BEGIN
				UPDATE FOSETTLEMENT
				SET TURN_TAX = 0
				WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
					AND AUCTIONPART <> 'CA'
					AND TRADEQTY > 0
					AND RIGHT(INST_TYPE,3) = @INST_TYPE
					AND SYMBOL = @SYMBOL
					AND @TRADE_TYPE = (
						CASE 
							WHEN AUCTIONPART = ''
								THEN 'NRM'
							ELSE 'DEL'
							END
						)
					AND PARTY_CODE = @PARTY_CODE
					AND TURN_TAX > 0
					AND SRNO = @SRNO

				SET @DIFF = @DIFF + @TURN_TAX
			END
			ELSE
				IF @DIFF < 0 AND ABS(@DIFF) < @TURN_TAX
				BEGIN
					UPDATE FOSETTLEMENT
					SET TURN_TAX = TURN_TAX + @DIFF
					WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
						AND AUCTIONPART <> 'CA'
						AND TRADEQTY > 0
						AND RIGHT(INST_TYPE,3) = @INST_TYPE
						AND SYMBOL = @SYMBOL
						AND @TRADE_TYPE = (
							CASE 
								WHEN AUCTIONPART = ''
									THEN 'NRM'
								ELSE 'DEL'
								END
							)
						AND PARTY_CODE = @PARTY_CODE
						AND TURN_TAX > 0
						AND SRNO = @SRNO

					SET @DIFF = 0
				END

		FETCH NEXT
		FROM @SETTCUR
		INTO @SRNO
			,@TURN_TAX
	END

	CLOSE @SETTCUR

	DEALLOCATE @SETTCUR

	FETCH NEXT
	FROM @TOTCUR
	INTO @PARTY_CODE
		,@INST_TYPE
		,@SYMBOL
		,@TRADE_TYPE
		,@DIFF
END

CLOSE @TOTCUR

DEALLOCATE @TOTCUR

DROP TABLE #SETT
DROP TABLE #SCRIP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_ISETL
-- --------------------------------------------------

CREATE   PROC [dbo].[PROC_TRADE_TRANSFER_ISETL]
(
	@SAUDA_DATE      VARCHAR(11),
	@PARTYFROM       VARCHAR(10),
	@PARTYTO         VARCHAR(10),
	@PRODUCT_CODE       VARCHAR(6) ,
	@SERIES_CODE          VARCHAR(12),
	@EXPIRY_DATE     VARCHAR(11),
	@STRIKE_PRICE    MONEY      ,
	@OPTION_TYPE     VARCHAR(2) ,
	@SELL_BUY       INT        ,
	@PARTICIPANTCODE VARCHAR(15),
	@CONTRACTNO      VARCHAR(7) ,
	@ORDER_NO    VARCHAR(16),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY       INT        ,
	@QTYTOTRANSFER   INT   ,
	@STATUSID	 VARCHAR(50) ='BROKER',
	@STRMODULE       VARCHAR(50) ='',
	@USERID 	VARCHAR(15) ='',
	@CONTRACTNONEW 	VARCHAR(7)=''
) AS



DECLARE
@TRADECURSOR     CURSOR     ,
@CONTRACTNOCUR   CURSOR     ,
@QTYINTRADE      INT        ,
@NEW_TRADE_NO    VARCHAR(14),
@NEW_CONTRACTNO  VARCHAR(7) ,
@BILLNO			 INT        ,
@STYLE           INT    ,
@CLTYPE			 VARCHAR(3) ,
@CONTSTYLE       CHAR(1) ,
@PARTICIPANTCODENEW VARCHAR(15),
@KEEPINST		TINYINT,
@NEW_CONTRACTNO_INT		INT ,
@@NRMSERIESPREFIX		VARCHAR(2),
@@NRMSERIESPREFIX_NEW	VARCHAR(2),
@@SERIESFLAG	INT

SELECT @KEEPINST = KEEPINST FROM FOOWNER

SELECT @NEW_CONTRACTNO = 0

IF @STRMODULE <> ''
BEGIN
	EXEC CONSOLE_LOG  @PARTYFROM,@PARTYTO,@SAUDA_DATE,@PRODUCT_CODE,@SERIES_CODE,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
	@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACTNO,'',0,0,0,0,0,0,@ACTUALQTY,@QTYTOTRANSFER,0,@PARTICIPANTCODE,'',@STATUSID,@STRMODULE,'PROC_TRADE_TRANSFER_ISETL'
END

SELECT @CLTYPE = CL_TYPE,@CONTSTYLE=C2.INSCONT,@PARTICIPANTCODENEW=BANKID FROM CLIENT1 C1, CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = @PARTYTO

IF @CONTRACTNONEW <> ''
BEGIN
	SET @NEW_CONTRACTNO = @CONTRACTNONEW
END
ELSE
  BEGIN
  IF @CLTYPE <> 'PRO'
  BEGIN
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'S'
	BEGIN
	  SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT
			WHERE SAUDA_DATE LIKE @SAUDA_DATE  + '%'
			AND PARTY_CODE = @PARTYTO
			AND DUMMY1 = 0
			AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
			AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
			AND EXPIRYDATE LIKE  @EXPIRY_DATE +'%'
			AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
			AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
			AND RESERVED1 = 1
			AND TRADEQTY <> 0
			AND CONTRACTNO <> 0
	END
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'O'
	BEGIN
	  SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT
			WHERE SAUDA_DATE LIKE @SAUDA_DATE  + '%'
			AND PARTY_CODE = @PARTYTO
			AND DUMMY1 = 0
			AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
			AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
			AND EXPIRYDATE LIKE  @EXPIRY_DATE +'%'
			AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
			AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
			AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
			AND RESERVED1 = 1
			AND TRADEQTY <> 0
			AND CONTRACTNO <> 0
	END
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'N'
	BEGIN
	    SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT WHERE PARTY_CODE = @PARTYTO
		AND DUMMY1 = 0 AND RESERVED1 = 1 AND TRADEQTY <> 0  AND CONTRACTNO <> 0
		AND SAUDA_DATE LIKE @SAUDA_DATE  + '%'
	END


	IF LEN(@NEW_CONTRACTNO) = 1
	BEGIN
	
		SELECT 
			 @@SERIESFLAG = SERIESFLAG ,
			 @NEW_CONTRACTNO_INT = CASE WHEN SERIESFLAG = 0
										THEN
											CONVERT(INT,RIGHT(CONTRACTNO,LEN(CONTRACTNO)-LEN(RTRIM(NRMSERIESPREFIX))))
										ELSE
											CONVERT(INT,RIGHT(INSTCONTRACTNO,LEN(INSTCONTRACTNO)-LEN(RTRIM(INSSERIESPREFIX))))
										END,
			 @@NRMSERIESPREFIX = CASE WHEN SERIESFLAG = 0 THEN RTRIM(NRMSERIESPREFIX) ELSE RTRIM(INSSERIESPREFIX) END
		FROM CONTGEN 
		WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
				
		IF @@SERIESFLAG = 0
		BEGIN
		
			SET @NEW_CONTRACTNO = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
									 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = 'I'
												THEN 'AA' + 
													 RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 5)
												ELSE 
													(CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
														  THEN 'A' +  
															  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 6)		
														  ELSE 
															  (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																	THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																	ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
															   END) 
																+ RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 
																7 - LEN((CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																			  THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																			  ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																		  END)))	
													 END)
												END)
									 ELSE RTRIM(@@NRMSERIESPREFIX) + 
										  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 7-LEN(RTRIM(@@NRMSERIESPREFIX)))
								END)
								
				SET @@NRMSERIESPREFIX_NEW = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
									 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = 'I'
												THEN 'AA' 
												ELSE (CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
														   THEN 'A'
														   ELSE (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																	THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																	ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
															   END)
													  END)
												END)
									 ELSE RTRIM(@@NRMSERIESPREFIX) 
								END)
		
				UPDATE CONTGEN SET CONTRACTNO = @NEW_CONTRACTNO ,NRMSERIESPREFIX = @@NRMSERIESPREFIX_NEW
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
		END
		ELSE
		BEGIN
			   SET @NEW_CONTRACTNO = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
										 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = '['
													THEN 'IA' + 
														 RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 5)
													ELSE 
														(CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
															  THEN 'I' +  
																  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 6)		
															  ELSE 
																  (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																		THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																		ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																   END) 
																	+ RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 
																	7 - LEN((CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																				  THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																				  ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																			  END)))	
														 END)
													END)
										 ELSE RTRIM(@@NRMSERIESPREFIX) + 
											  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 7-LEN(RTRIM(@@NRMSERIESPREFIX)))
									END)
									
					SET @@NRMSERIESPREFIX_NEW = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
										 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = '['
													THEN 'IA' 
													ELSE (CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
															   THEN 'I'
															   ELSE (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																		THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																		ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																   END)
														  END)
													END)
										 ELSE RTRIM(@@NRMSERIESPREFIX) 
									END)
		
				UPDATE CONTGEN SET INSTCONTRACTNO = @NEW_CONTRACTNO ,INSSERIESPREFIX = @@NRMSERIESPREFIX_NEW
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
		END
	END
	ELSE
	BEGIN
	  SELECT @NEW_CONTRACTNO = STUFF('0000000', 8 - LEN(@NEW_CONTRACTNO), LEN(@NEW_CONTRACTNO), @NEW_CONTRACTNO)
	END
 END
END

SELECT
	CONTRACTNO,TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,
	OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,
	PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,
	SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,
	SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
	BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
INTO #BFOSETTLEMENT FROM BFOSETTLEMENT WHERE 1 = 2

SELECT @BILLNO = 0

IF @ACTUALQTY = @QTYTOTRANSFER
BEGIN
 INSERT INTO #BFOSETTLEMENT
 SELECT @NEW_CONTRACTNO,LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,
	CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE=CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' 
	AND @KEEPINST = 1 THEN 'INST' ELSE @PARTICIPANTCODENEW END ELSE PARTICIPANTCODE END,CP_CONFIRMATION,OC_FLAG,
	OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,
	PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
	BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
 FROM BFOSETTLEMENT
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
        AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
        AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
        AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
        AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
        AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO
		AND PARTICIPANTCODE LIKE CASE WHEN @USERID <> '' THEN @USERID ELSE '%' END

 UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,
 SERVICE_TAX = 0, TRADE_AMOUNT = 0,
 INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
		AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
		AND ORDER_NO LIKE @ORDER_NO
		AND TRADE_NO LIKE @TRADE_NO
		AND PARTICIPANTCODE LIKE CASE WHEN @USERID <> '' THEN @USERID ELSE '%' END

   INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
   TRUNCATE TABLE #BFOSETTLEMENT

END
ELSE
BEGIN
    SET @TRADECURSOR = CURSOR FOR
        SELECT TRADEQTY, TRADE_NO FROM BFOSETTLEMENT
        WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
		AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
		AND ORDER_NO LIKE @ORDER_NO
		AND TRADE_NO LIKE @TRADE_NO
		AND LOCATIONID LIKE CASE WHEN @USERID <> '' THEN @USERID ELSE '%' END
 ORDER BY TRADEQTY DESC

        OPEN @TRADECURSOR
        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO
 WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0
 BEGIN
  IF @QTYTOTRANSFER >= @QTYINTRADE
  BEGIN
   INSERT INTO #BFOSETTLEMENT
	SELECT @NEW_CONTRACTNO,LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,
	CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE=CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' 
	AND @KEEPINST = 1 THEN 'INST' ELSE @PARTICIPANTCODENEW END ELSE PARTICIPANTCODE END,CP_CONFIRMATION,OC_FLAG,
	OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,
	PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
	BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS   
   FROM BFOSETTLEMENT
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
		AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
		AND ORDER_NO LIKE @ORDER_NO
		AND TRADE_NO LIKE @NEW_TRADE_NO
		AND TRADEQTY = @QTYINTRADE
		AND LOCATIONID LIKE CASE WHEN @USERID <> '' THEN @USERID ELSE '%' END

   UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,
   SERVICE_TAX = 0, TRADE_AMOUNT = 0,
   INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
		AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
		AND ORDER_NO LIKE @ORDER_NO
		AND TRADE_NO LIKE @NEW_TRADE_NO
		AND TRADEQTY = @QTYINTRADE
	  AND LOCATIONID LIKE CASE WHEN @USERID <> '' THEN @USERID ELSE '%' END

   INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
   TRUNCATE TABLE #BFOSETTLEMENT

   SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINTRADE
  END
  ELSE
  BEGIN
   INSERT INTO #BFOSETTLEMENT
 	SELECT @NEW_CONTRACTNO,LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY=@QTYTOTRANSFER,SETT_FLAG,
	CA_LEVEL,BROKER_CD,TRADE_PRICE=@QTYTOTRANSFER*TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE=CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' 
	AND @KEEPINST = 1 THEN 'INST' ELSE @PARTICIPANTCODENEW END ELSE PARTICIPANTCODE END,CP_CONFIRMATION,OC_FLAG,
	OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,
	PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
	BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
   FROM BFOSETTLEMENT
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
		AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
		AND ORDER_NO LIKE @ORDER_NO
		AND TRADE_NO LIKE @NEW_TRADE_NO
		AND TRADEQTY = @QTYINTRADE
		AND LOCATIONID LIKE CASE WHEN @USERID <> '' THEN @USERID ELSE '%' END

   UPDATE BFOSETTLEMENT SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER, TRADE_AMOUNT = (TRADEQTY - @QTYTOTRANSFER)*TRADE_PRICE
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE = CASE WHEN @PRODUCT_CODE = '%' THEN PRODUCT_CODE ELSE @PRODUCT_CODE END
		AND SERIES_CODE = CASE WHEN @SERIES_CODE = '%' THEN SERIES_CODE ELSE @SERIES_CODE END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
		AND ORDER_NO LIKE @ORDER_NO
		AND TRADE_NO LIKE @NEW_TRADE_NO
		AND LOCATIONID LIKE CASE WHEN @USERID <> '' THEN @USERID ELSE '%' END

	INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
	TRUNCATE TABLE #BFOSETTLEMENT

	SELECT @QTYTOTRANSFER = 0
  END
         FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO
 END
 CLOSE @TRADECURSOR
 DEALLOCATE @TRADECURSOR
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_RECAL
-- --------------------------------------------------

CREATE  PROCEDURE [DBO].[PROC_TRADE_TRANSFER_RECAL] 
                @SAUDA_DATE   VARCHAR(11), 
                @PARTY_CODE   VARCHAR(10), 
                @PRODUCT_TYPE VARCHAR(6), 
                @PRODUCT_CODE VARCHAR(12), 
                @EXPIRY_DATE  VARCHAR(11), 
                @SERIESID     MONEY, 
                @SERIESCODE   VARCHAR(20) 
                 
AS 

  UPDATE BFOSETTLEMENT 
  SET    TABLE_NO = BROKTABLE.TABLE_NO, 
         LINE_NO = BROKTABLE.LINE_NO, 
         VAL_PERC = BROKTABLE.VAL_PERC, 
         NORMAL = BROKTABLE.NORMAL, 
         DAY_PUC = BROKTABLE.DAY_PUC, 
         DAY_SALES = BROKTABLE.DAY_SALES, 
         SETT_PURCH = BROKTABLE.SETT_PURCH, 
         SETT_SALES = BROKTABLE.SETT_SALES, 
         BROKAPPLIED = (CASE 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((BROKTABLE.NORMAL * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((BROKTABLE.NORMAL * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((((BROKTABLE.NORMAL *
						F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((((BROKTABLE.NORMAL *
						F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER))
						* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN 
						((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO) 
						+ FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.DAY_SALES * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN 
						((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER / 100) * F.MPRICE) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_PURCH * F.MULTIPLIER * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') 
						THEN ((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER / 100) * F.MPRICE) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_SALES * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') 
						THEN ((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER / 100) * F.MPRICE) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  ELSE 0 
					END), 
          
         NETRATE = (CASE 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.TRADE_PRICE) +
						((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.TRADE_PRICE) -
						((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.TRADE_PRICE) + 
						((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.TRADE_PRICE) - 
						((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) + 
						((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) +
						((FLOOR(((((BROKTABLE.DAY_PUC * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) - 
						((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG 
						+ FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) - 
						((FLOOR(((((BROKTABLE.DAY_SALES * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) + 
						((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) + 
						((FLOOR(((((BROKTABLE.SETT_PURCH * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.TRADE_PRICE) - 
						((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.TRADE_PRICE) - 
						((FLOOR(((((BROKTABLE.SETT_SALES * F.MULTIPLIER / 100) * F.MPRICE)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      ELSE 0 
                    END), 

         INS_CHRG = 0, 
         TURN_TAX = CASE WHEN BFOTAXES.TURNOVER_TAX > 0  THEN
					CASE WHEN TURNOVER_TAX_ON = 'ACTIVE_TRD'  AND ORDER_ACTIVEFLAG <> 0 THEN 0 ELSE
						((FLOOR((((CASE 
						WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_TURNOVER_TAX 
						ELSE OPT_TURNOVER_TAX 
						END * (F.TRADE_PRICE) * BFOSETTLEMENT.TRADEQTY) / 100) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					END
					ELSE 0 END, 
         OTHER_CHRG = CASE WHEN BFOTAXES.OTHER_CHRG > 0 THEN 
					((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_OTHER_CHRG 
					ELSE OPT_OTHER_CHRG 
					END * (F.TRADE_PRICE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END, 
         SEBI_TAX = CASE WHEN BFOTAXES.SEBITURN_TAX > 0 THEN
					((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_SEBITURN_TAX 
					ELSE OPT_SEBITURN_TAX 
					END * (F.TRADE_PRICE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END, 
         BROKER_CHRG = CASE WHEN BFOTAXES.BROKER_NOTE > 0 THEN
					((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKER_NOTE 
					ELSE OPT_BROKER_NOTE 
					END * (F.TRADE_PRICE) * BFOSETTLEMENT.TRADEQTY) / 100) * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END, 
         SERVICE_TAX = CASE 
					 WHEN CLIENT2.SERVICE_CHRG = 1 
						  AND CLIENT2.SERTAXMETHOD = 1 THEN 0 
					 ELSE (CASE 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						   AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.NORMAL * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 1 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 2 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.DAY_PUC * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 2 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER / 100) * F.MPRICE) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 3 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.DAY_SALES * F.MULTIPLIER) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 3 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER / 100) * F.MPRICE) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 4 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.SETT_PURCH * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 4 
							AND BROKTABLE.VAL_PERC = 'P') THEN
							((FLOOR(((((((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER / 100) * F.MPRICE) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 5 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.SETT_SALES * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) *
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 5 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER / 100) * F.MPRICE) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 ELSE 0 
						 END) 
				   END, 
         TRADE_AMOUNT = BFOSETTLEMENT.TRADEQTY * BFOSETTLEMENT.TRADE_PRICE 
  FROM   BROKTABLE, 
         (SELECT SDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
                 F.TRADE_NO, 
                 F.PRODUCT_CODE, 
                 F.PRODUCT_TYPE, 
                 F.PARTY_CODE, 
                 F.SERIES_CODE, 
                 F.SERIES_ID, 
                 S2.EXPIRYDATE,
                 F.SELL_BUY, 
                 F.TRADEQTY, 
                 F.TRADE_PRICE, 
                 S2.STRIKE_PRICE, 
                 F.SAUDA_DATE, 
                 F.ORDER_NO, 
                 F.SETTFLAG, 
                 TRAN_CAT, 
                 OFF_PHONE1, 
                 MPRICE = (CASE 
                         WHEN C2.DUMMY1 = 0 THEN TRADE_PRICE 
                         ELSE (
							CASE 
                             WHEN C2.DUMMY1 = 1 THEN (
								CASE 
                                WHEN S2.STRIKE_PRICE = 0 THEN F.TRADE_PRICE 
                                ELSE S2.STRIKE_PRICE 
                                END) 
                             ELSE S2.STRIKE_PRICE + TRADE_PRICE 
                           END) 
                       END), 
                 MULTIPLIER = 1, 
                 MARKETLOT=1 
          FROM   BFOSETTLEMENT F, 
                 CLIENT2 C2, 
                 BFOSCRIP2 S2, 
                 CLIENT1 C1 
          WHERE  C2.PARTY_CODE = F.PARTY_CODE 
                 AND C1.CL_CODE = C2.CL_CODE 
                 AND F.PRODUCT_TYPE = S2.PRODUCT_TYPE 
                 AND F.PRODUCT_CODE = S2.PRODUCT_CODE 
                 AND F.SERIES_CODE = S2.SERIES_CODE 
                 AND F.SERIES_ID = S2.SERIES_ID 
                                    
                 AND F.SAUDA_DATE LIKE @SAUDA_DATE + '%' 
                 AND F.STATUS <> 'E' 
                 AND F.PARTY_CODE LIKE @PARTY_CODE 
                 AND F.PRODUCT_TYPE LIKE @PRODUCT_TYPE 
                 AND F.PRODUCT_CODE LIKE @PRODUCT_CODE 
                 AND F.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
                 AND F.SERIES_ID = (CASE 
                                      WHEN @SERIESID = 0 THEN F.SERIES_ID 
                                      ELSE @SERIESID 
                                    END) 
                 AND F.SERIES_CODE LIKE @SERIESCODE) F, 
         BFOGLOBALS, 
         CLIENT1, 
         CLIENT2, 
    (SELECT   SDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
                   T1.PARTY_CODE, 
                   T1.PRODUCT_TYPE, 
                   T1.PRODUCT_CODE, 
                   T1.SERIES_CODE, 
                   T1.SERIES_ID, 
                   PQTY = SUM(CASE 
                                WHEN SELL_BUY = 1 THEN TRADEQTY 
                                ELSE 0 
                              END), 
                   SQTY = SUM(CASE 
                                WHEN SELL_BUY = 2 THEN TRADEQTY 
                                ELSE 0 
                              END), 
                   STRIKE_PRICE = ISNULL((SELECT DISTINCT BS.STRIKE_PRICE 
                                         FROM   BFOSCRIP2 BS 
                                         WHERE  BS.PRODUCT_CODE = T1.PRODUCT_CODE 
                                                AND BS.PRODUCT_TYPE = T1.PRODUCT_TYPE 
                                                AND BS.SERIES_CODE = T1.SERIES_CODE 
                                                AND BS.SERIES_ID = T1.SERIES_ID), 
                                        0), 
                   PRATE = (CASE 
                              WHEN SUM(CASE 
                                         WHEN SELL_BUY = 1 THEN TRADEQTY 
                                         ELSE 0 
                                       END) > 0 THEN SUM(CASE 
                                                           WHEN SELL_BUY = 1 THEN TRADEQTY * TRADE_PRICE 
                                                           ELSE 0 
                                                         END) / SUM(CASE 
                                                                      WHEN SELL_BUY = 1 THEN TRADEQTY 
                                                                      ELSE 0 
                                                                    END) 
                              ELSE 0 
                            END), 
                   SRATE = (CASE 
                              WHEN SUM(CASE 
                                         WHEN SELL_BUY = 2 THEN TRADEQTY 
                                         ELSE 0 
                                       END) > 0 THEN SUM(CASE 
                                                           WHEN SELL_BUY = 2 THEN TRADEQTY * TRADE_PRICE 
                                                           ELSE 0 
                                                         END) / SUM(CASE 
                                                                      WHEN SELL_BUY = 2 THEN TRADEQTY 
                                                                      ELSE 0 
                                                                    END) 
                              ELSE 0 
                            END) 
          FROM     BFOSETTLEMENT T1 
          WHERE    T1.SAUDA_DATE LIKE @SAUDA_DATE + '%' 
                   AND T1.STATUS <> 'E' 
                   AND T1.PARTY_CODE LIKE @PARTY_CODE 
                   AND T1.PRODUCT_TYPE LIKE @PRODUCT_TYPE 
                   AND T1.PRODUCT_CODE LIKE @PRODUCT_CODE 
                   AND T1.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
                   AND T1.SERIES_ID = (CASE 
                                         WHEN @SERIESID = 0 THEN T1.SERIES_ID 
                                         ELSE @SERIESID 
                                       END) 
                   AND T1.SERIES_CODE LIKE @SERIESCODE 
          GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),T1.PARTY_CODE,T1.PRODUCT_TYPE,T1.PRODUCT_CODE, 
                   T1.SERIES_CODE,T1.SERIES_ID) S, 
         FOCLIENTTAXES (NOLOCK), 
         FOCLIENTBROKSCHEME (NOLOCK),
         BFOTAXES (NOLOCK)
  WHERE  BFOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO 
         AND BFOSETTLEMENT.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO 
         AND 
          
          F.PARTY_CODE = CLIENT2.PARTY_CODE 
         AND CLIENT1.CL_CODE = CLIENT2.CL_CODE 
         AND F.PARTY_CODE = S.PARTY_CODE 
         AND F.PRODUCT_TYPE = S.PRODUCT_TYPE 
         AND F.PRODUCT_CODE = S.PRODUCT_CODE 
         AND F.SERIES_CODE = S.SERIES_CODE 
         AND F.SERIES_ID = S.SERIES_ID 
         AND BROKTABLE.TABLE_NO = (CASE 
                                     WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
                                     ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
                                   END) 
         AND BROKTABLE.LINE_NO = (CASE 
                                    WHEN (FOCLIENTBROKSCHEME.BROK_SCHEME = 1 
		                            OR FOCLIENTBROKSCHEME.BROK_SCHEME = 5) THEN 
									(SELECT MIN(BROKTABLE.LINE_NO) 
									FROM   BROKTABLE 
									WHERE  BROKTABLE.TABLE_NO = (CASE 
									WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE -- F.STD_RATE       
									ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
									END) 
									AND TRD_DEL = (CASE 
													WHEN S.PQTY >= S.SQTY THEN (CASE 
														  WHEN (F.SELL_BUY = 1) THEN 'F' 
														  ELSE 'S' 
														END) 
													ELSE (CASE 
															WHEN (F.SELL_BUY = 2) THEN 'F' 
															ELSE 'S' 
														  END) 
												  END) 
									AND F.PARTY_CODE = S.PARTY_CODE 
                                                   AND F.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN (FOCLIENTBROKSCHEME.BROK_SCHEME = 3 
                                           OR FOCLIENTBROKSCHEME.BROK_SCHEME = 6) THEN 
										(SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = (CASE 
										WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
										ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
										END) 
										AND TRD_DEL = (CASE 
										WHEN S.PQTY > S.SQTY THEN (CASE 
													 WHEN (F.SELL_BUY = 1) THEN 'F' 
													 ELSE 'S' 
												   END) 
										ELSE (CASE 
										WHEN (F.SELL_BUY = 2) THEN 'F' 
										ELSE 'S' 
										END) 
										END) 
										AND F.PARTY_CODE = S.PARTY_CODE 
										AND F.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 2 THEN 
										(SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = (CASE 
											 WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE 
											 ELSE OPT_BROKTABLE 
										   END)-- F.STD_RATE                                                         
										AND TRD_DEL = (CASE 
										WHEN S.PQTY = S.SQTY THEN (CASE 
										   WHEN S.PRATE >= S.SRATE THEN (CASE 
													   WHEN (F.SELL_BUY = 1) THEN 'F' 
													   ELSE 'S' 
													 END) 
										   ELSE (CASE 
												   WHEN (F.SELL_BUY = 2) THEN 'F' 
												   ELSE 'S' 
												 END) 
										 END) 
										ELSE (CASE 
											  WHEN S.PQTY >= S.SQTY THEN (
													CASE 
													WHEN (F.SELL_BUY = 1) THEN 'F' 
													ELSE 'S' 
												  END) 
											  ELSE (CASE 
													  WHEN (F.SELL_BUY = 2) THEN 'F' 
													  ELSE 'S' 
													END) 
											END) 
										END) 
										AND F.PARTY_CODE = S.PARTY_CODE 
										AND F.TRADE_PRICE <= BROKTABLE.UPPER_LIM) 
                                    ELSE (SELECT MIN(LINE_NO) 
                                          FROM   BROKTABLE 
                                          WHERE  F.MPRICE <= BROKTABLE.UPPER_LIM 
                                                 AND BROKTABLE.TABLE_NO = (
												CASE 
                                                 WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
                                                 ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
                                               END)) 
                              END) 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
         AND BFOSETTLEMENT.SAUDA_DATE LIKE F.SDATE + '%' 
         AND BFOSETTLEMENT.SAUDA_DATE LIKE S.SDATE + '%' 
         AND BFOSETTLEMENT.TRADE_NO = F.TRADE_NO 
         AND BFOSETTLEMENT.ORDER_NO = F.ORDER_NO 
         AND BFOSETTLEMENT.SELL_BUY = F.SELL_BUY 
         AND BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE 
         AND BFOSETTLEMENT.PRODUCT_TYPE = F.PRODUCT_TYPE 
         AND BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE 
         AND BFOSETTLEMENT.SERIES_ID = F.SERIES_ID 
         AND BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE LIKE @SAUDA_DATE + '%' 
         AND BFOSETTLEMENT.STATUS <> 'E' 
         AND BFOSETTLEMENT.PARTY_CODE LIKE @PARTY_CODE 
         AND BFOSETTLEMENT.PRODUCT_TYPE LIKE @PRODUCT_TYPE 
         AND BFOSETTLEMENT.PRODUCT_CODE LIKE @PRODUCT_CODE 
         AND BFOSETTLEMENT.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
         AND BFOSETTLEMENT.SERIES_ID = (CASE 
                                          WHEN @SERIESID = 0 THEN F.SERIES_ID 
                                          ELSE @SERIESID 
                                        END) 
		AND BFOSETTLEMENT.SERIES_CODE LIKE @SERIESCODE 
		AND BFOSETTLEMENT.Auctionpart <> 'EA'
		AND BFOTAXES.TRANS_CAT = CASE WHEN CLIENT2.TRAN_CAT = 'PRO' THEN 'PRO' ELSE 'TRD' END AND
		BFOSETTLEMENT.SAUDA_DATE BETWEEN BFOTAXES.FROM_DATE AND BFOTAXES.TO_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_SETL
-- --------------------------------------------------
CREATE  PROC [dbo].[Proc_Trade_Transfer_Setl] 
(
	@SAUDA_DATE      VARCHAR(11),
	@PARTYFROM       VARCHAR(10), 
	@PARTYTO         VARCHAR(10),
	@PRODUCT_TYPE    VARCHAR(6) ,
	@PRODUCT_CODE    VARCHAR(12),
	@SERIESCODE  	 VARCHAR(20)      ,
	@EXPIRY_DATE     VARCHAR(11),
	@SELL_BUY   	 INT        ,
	@PARTICIPANTCODE VARCHAR(15), 
	@CONTRACTNO      VARCHAR(7) , 
	@ORDER_NO		 VARCHAR(20),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY       INT        ,
	@QTYTOTRANSFER   INT        
) AS

DECLARE 
	@TRADECURSOR     CURSOR     ,
	@CONTRACTNOCUR   CURSOR     ,
	@QTYINTRADE      INT        ,
	@NEW_TRADE_NO    VARCHAR(14),
	@NEW_CONTRACTNO  VARCHAR(7) ,
	@BILLNO			 INT        ,
	@STYLE           INT

SELECT @NEW_CONTRACTNO = 0 
SET @CONTRACTNOCUR = CURSOR FOR
SELECT CONTRACTNO FROM BFOSETTLEMENT 
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
AND PARTY_CODE = @PARTYTO AND RESERVED1 = 0 
OPEN @CONTRACTNOCUR
FETCH NEXT FROM @CONTRACTNOCUR INTO @NEW_CONTRACTNO
CLOSE @CONTRACTNOCUR
DEALLOCATE @CONTRACTNOCUR
IF @@FETCH_STATUS <> 0 
BEGIN
	SELECT @NEW_CONTRACTNO = CONVERT(INT,CONTRACTNO) + 1  FROM CONTGEN 
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
	UPDATE CONTGEN SET CONTRACTNO = @NEW_CONTRACTNO 
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
	SELECT @NEW_CONTRACTNO = STUFF('0000000', 8 - LEN(@NEW_CONTRACTNO), LEN(@NEW_CONTRACTNO), @NEW_CONTRACTNO)		
END
SELECT @BILLNO = 0 
IF @ACTUALQTY = @QTYTOTRANSFER 
BEGIN
	INSERT INTO BFOSETTLEMENT
	SELECT @NEW_CONTRACTNO,LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,
	CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,
	OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,
	PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
	BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
	FROM BFOSETTLEMENT 
	WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_TYPE = @PRODUCT_TYPE
        --AND PRODUCT_CODE = @PRODUCT_CODE
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND SERIES_ID = @SERIESCODE
		AND RESERVED1 = 0 
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
        AND CONTRACTNO = @CONTRACTNO
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO
	UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0, 
	SERVICE_TAX = 0, TRADE_AMOUNT = 0,
	INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0 
	WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_TYPE = @PRODUCT_TYPE
        --AND PRODUCT_CODE = @PRODUCT_CODE
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND SERIES_ID = @SERIESCODE
		AND RESERVED1 = 0 
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
        AND CONTRACTNO = @CONTRACTNO
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO
END
ELSE
BEGIN
        SET @TRADECURSOR = CURSOR FOR
        SELECT TRADEQTY, TRADE_NO FROM BFOSETTLEMENT
        WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_TYPE = @PRODUCT_TYPE
        --AND PRODUCT_CODE = @PRODUCT_CODE
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND SERIES_ID = @SERIESCODE
		AND RESERVED1 = 0 
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
        AND CONTRACTNO = @CONTRACTNO
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO
	ORDER BY TRADEQTY DESC 
        OPEN @TRADECURSOR 
        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO
	WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0 
	BEGIN
		IF @QTYTOTRANSFER >= @QTYINTRADE
		BEGIN
			INSERT INTO BFOSETTLEMENT 
			SELECT @NEW_CONTRACTNO,LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
			EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,
			CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,
			OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,
			PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
			SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
			BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
			FROM BFOSETTLEMENT 
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		        AND PARTY_CODE = @PARTYFROM
		        AND PRODUCT_TYPE = @PRODUCT_TYPE
		        --AND PRODUCT_CODE = @PRODUCT_CODE
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND SERIES_ID = @SERIESCODE
				AND RESERVED1 = 0 
		        AND SELL_BUY = @SELL_BUY
		        AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND CONTRACTNO = @CONTRACTNO
		        AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO
				AND TRADEQTY = @QTYINTRADE
				
			UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0, 
			SERVICE_TAX = 0,  TRADE_AMOUNT = 0,
			INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0 
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		        AND PARTY_CODE = @PARTYFROM
		        AND PRODUCT_TYPE = @PRODUCT_TYPE
		        --AND PRODUCT_CODE = @PRODUCT_CODE
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND SERIES_ID = @SERIESCODE
			AND RESERVED1 = 0 
		        AND SELL_BUY = @SELL_BUY
	        	AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND CONTRACTNO = @CONTRACTNO
	        	AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO
			AND TRADEQTY = @QTYINTRADE
			SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINTRADE
		END
		ELSE
		BEGIN
			INSERT INTO BFOSETTLEMENT 
			SELECT @NEW_CONTRACTNO,LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
			EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,
			CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,
			OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,
			PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
			SETTFLAG,ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
			BROKER_CHRG,NETRATE,SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
			FROM BFOSETTLEMENT 
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND PRODUCT_TYPE = @PRODUCT_TYPE
			--AND PRODUCT_CODE = @PRODUCT_CODE
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND SERIES_ID = @SERIESCODE
			AND RESERVED1 = 0 
			AND SELL_BUY = @SELL_BUY
			AND PARTICIPANTCODE = @PARTICIPANTCODE
			AND CONTRACTNO = @CONTRACTNO
			AND ORDER_NO LIKE @ORDER_NO
			AND TRADE_NO LIKE @NEW_TRADE_NO
			AND TRADEQTY = @QTYINTRADE
			
			UPDATE BFOSETTLEMENT SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER, TRADE_AMOUNT = (TRADEQTY - @QTYTOTRANSFER)*TRADE_PRICE
			
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND PRODUCT_TYPE = @PRODUCT_TYPE
			--AND PRODUCT_CODE = @PRODUCT_CODE
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND SERIES_ID = @SERIESCODE
			AND RESERVED1 = 0 
			AND SELL_BUY = @SELL_BUY
			AND PARTICIPANTCODE = @PARTICIPANTCODE
			AND CONTRACTNO = @CONTRACTNO
			AND ORDER_NO LIKE @ORDER_NO
			AND TRADE_NO LIKE @NEW_TRADE_NO
			SELECT @QTYTOTRANSFER = 0
		END
	        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO	
	END
	CLOSE @TRADECURSOR
	DEALLOCATE @TRADECURSOR
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_TRADE
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_TRADE_TRANSFER_TRADE]
(
	@SAUDA_DATE      VARCHAR(11),
	@PARTYFROM       VARCHAR(10), 
	@PARTYTO         VARCHAR(10),
	@PRODUCT_TYPE    VARCHAR(6) ,
	@PRODUCT_CODE    VARCHAR(12),
	@SERIES_CODE  	 VARCHAR(20)      ,
	@EXPIRY_DATE     VARCHAR(11),
	@SELL_BUY   	 INT        ,
	@PARTICIPANTCODE VARCHAR(15), 
	@CONTRACTNO      VARCHAR(7) , 
	@ORDER_NO		 VARCHAR(20),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY       INT        ,
	@QTYTOTRANSFER   INT		,
	@STATUSID		 VARCHAR(20)='',
	@STRMODULE	     VARCHAR(20)='' 
) AS
/*

BEGIN TRAN
EXEC Proc_Trade_Transfer_Trade 'May 24 2011','0A143','0104','SF','','825907','Jun 16 2011',1,'%','%','%','%',60,60,'HEMANTT/Broker','FC.Consolidation .NET Module(/FC.Interface/TranDetails.aspx)'

*/
DECLARE
	@QTYINBFOTRADE      INT        ,
	@NEW_TRADE_NO    VARCHAR(14),
	@BANKID VARCHAR(16),
	@KEEPINST TINYINT

SELECT @KEEPINST = KEEPINST FROM FOOWNER
If Len(@EXPIRY_DATE) = 10 And CharIndex('/', @EXPIRY_DATE) > 0
	Begin
		Set @EXPIRY_DATE = Convert(Varchar(11), Convert(DateTime, @EXPIRY_DATE, 103), 109)
	End
If Len(@SAUDA_DATE) = 10 And CharIndex('/', @SAUDA_DATE) > 0
	Begin
		Set @SAUDA_DATE = Convert(Varchar(11), Convert(DateTime, @SAUDA_DATE, 103), 109)
	End

SELECT @BANKID=CASE WHEN CL_TYPE ='INS' THEN BANKID ELSE MEMBERCODE END FROM CLIENT1 C1, CLIENT2 C2, FOOWNER WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = @PARTYTO

IF @ACTUALQTY = @QTYTOTRANSFER
	BEGIN

	
		INSERT INTO INST_LOG
		SELECT DISTINCT
			@PARTYFROM,
			@PARTYTO,
			CASE WHEN @SAUDA_DATE = '%' THEN GETDATE() ELSE @SAUDA_DATE END,
			PRODUCT_TYPE,
			SERIES_ID,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			'%',
			'%',
			@SELL_BUY,
			CONTRACTNO = '',
			'',
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			PARTICIPANTCODE,
			CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END,
			@STATUSID,
			@STRMODULE,
			'EDIT_PARTICIPANT',
			GETDATE(),
			'EDITPARTICIPANT',
			'',
			''
		FROM BFOTRADE
		WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
			AND SERIES_ID LIKE @SERIES_CODE + '%'
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
			AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
			AND ORDER_NO LIKE @ORDER_NO + '%'
			AND TRADE_NO LIKE @TRADE_NO + '%'


			
		UPDATE BFOTRADE SET PARTY_CODE = @PARTYTO,
			PARTICIPANTCODE = CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END ELSE PARTICIPANTCODE END
		WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
			AND SERIES_ID LIKE @SERIES_CODE + '%'
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
			AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
			AND ORDER_NO LIKE @ORDER_NO + '%'
			AND TRADE_NO LIKE @TRADE_NO + '%'
	END
ELSE
	BEGIN
		DECLARE @BFOTRADECURSOR CURSOR, @NEW_ORDER_NO VARCHAR(20)
		SELECT * INTO #INST_LOG FROM INST_LOG WHERE 1 = 0
		SET @BFOTRADECURSOR = CURSOR FOR
		SELECT TRADEQTY, TRADE_NO, ORDER_NO FROM BFOTRADE
		WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
			AND SERIES_ID LIKE @SERIES_CODE + '%'
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
			AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
			AND ORDER_NO LIKE @ORDER_NO + '%'
			AND TRADE_NO LIKE @TRADE_NO + '%'
		ORDER BY TRADEQTY DESC
        OPEN @BFOTRADECURSOR
        FETCH NEXT FROM @BFOTRADECURSOR INTO @QTYINBFOTRADE, @NEW_TRADE_NO, @NEW_ORDER_NO
		WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0
			BEGIN
				IF @QTYTOTRANSFER >= @QTYINBFOTRADE
					BEGIN
						INSERT INTO #INST_LOG
						SELECT
							@PARTYFROM,
							@PARTYTO,
							@SAUDA_DATE,
							PRODUCT_TYPE,
							SERIES_ID,
							EXPIRYDATE,
							STRIKE_PRICE,
							OPTION_TYPE,
							'%',
							'%',
							SELL_BUY,
							CONTRACTNO='',
							'',
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							PARTICIPANTCODE,
							CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END,
							@STATUSID,
							@STRMODULE,
							'EDIT_PARTICIPANT',
							GETDATE(),
							'EDITPARTICIPANT',
							'',
							''
						FROM
							BFOTRADE
						WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
							AND SERIES_ID LIKE @SERIES_CODE + '%'
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
							AND ORDER_NO = @NEW_ORDER_NO
							AND TRADE_NO = @NEW_TRADE_NO

						UPDATE BFOTRADE SET PARTY_CODE = @PARTYTO,
							PARTICIPANTCODE = CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END ELSE PARTICIPANTCODE END
						WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
							AND SERIES_ID LIKE @SERIES_CODE + '%'
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
							AND ORDER_NO = @NEW_ORDER_NO
							AND TRADE_NO = @NEW_TRADE_NO

						SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINBFOTRADE
					END
				ELSE
					BEGIN
						INSERT INTO #INST_LOG
						SELECT
							@PARTYFROM,
							@PARTYTO,
							@SAUDA_DATE,
							PRODUCT_TYPE,
							SERIES_CODE,
							EXPIRYDATE,
							STRIKE_PRICE,
							OPTION_TYPE,
							'%',
							'%',
							SELL_BUY,
							CONTRACTNO='',
							'',
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							PARTICIPANTCODE,
							CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END,
							@STATUSID,
							@STRMODULE,
							'EDIT_PARTICIPANT',
							GETDATE(),
							'EDITPARTICIPANT',
							'',
							''
						FROM
							BFOTRADE
						WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
							AND SERIES_ID LIKE @SERIES_CODE + '%'
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
							AND ORDER_NO = @NEW_ORDER_NO
							AND TRADE_NO = @NEW_TRADE_NO

						INSERT INTO BFOTRADE
						SELECT 'T'+TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,EXPIRYDATE,
						STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,@QTYTOTRANSFER,SETTFLAG,CA_LEVEL,BROKER_CD,
						TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE= CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE 
						WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END ELSE PARTICIPANTCODE END,
						CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,
						ORDER_NO,@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,RESERVED1,
						RESERVED2,RESERVED3,RESERVED4,RESERVED5,DUMMY1,DUMMY2
						FROM BFOTRADE
						WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
							AND SERIES_ID LIKE @SERIES_CODE + '%'
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
							AND ORDER_NO = @NEW_ORDER_NO
							AND TRADE_NO = @NEW_TRADE_NO

						UPDATE BFOTRADE SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER
						WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND PRODUCT_TYPE LIKE @PRODUCT_TYPE + '%'
							AND SERIES_ID LIKE @SERIES_CODE + '%'
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE LIKE @PARTICIPANTCODE + '%'
							AND ORDER_NO = @NEW_ORDER_NO
							AND TRADE_NO = @NEW_TRADE_NO

						SELECT @QTYTOTRANSFER = 0
					END
				FETCH NEXT FROM @BFOTRADECURSOR INTO @QTYINBFOTRADE, @NEW_TRADE_NO, @NEW_ORDER_NO
			END
		CLOSE @BFOTRADECURSOR
		DEALLOCATE @BFOTRADECURSOR
		INSERT INTO INST_LOG
		SELECT
			PARTY_CODE,
			NEW_PARTY_CODE,
			SAUDA_DATE,
			PRODUCT_TYPE,
			SERIES_CODE,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			ORDER_NO,
			TRADE_NO = '',
			SELL_BUY,
			CONTRACT_NO,
			NEW_CONTRACT_NO,
			BROKERAGE = SUM(BROKERAGE),
			NEW_BROKERAGE = SUM(NEW_BROKERAGE),
			MARKET_RATE = SUM(MARKET_RATE),
			NEW_MARKET_RATE = SUM(NEW_MARKET_RATE),
			NET_RATE = SUM(NET_RATE),
			NEW_NET_RATE = SUM(NEW_NET_RATE),
			QTY = SUM(QTY),
			NEW_QTY = SUM(NEW_QTY),
			ROUNDTO = 0,
			PARTICIPANT_CODE,
			NEW_PARTICIPANT_CODE,
			USERNAME = @STATUSID,
			MODULE = @STRMODULE,
			CALLED_FROM = 'EDIT PARTICIPANT',
			GETDATE(),
			EXTRAFIELD3 = 'EDIT PARTICIPANT-TRF',
			EXTRAFIELD4 = '',
			EXTRAFIELD5 = ''
		FROM
			#INST_LOG
		GROUP BY
			PARTY_CODE,
			NEW_PARTY_CODE,
			SAUDA_DATE,
			PRODUCT_TYPE,
			SERIES_CODE,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			ORDER_NO,
			SELL_BUY,
			CONTRACT_NO,
			NEW_CONTRACT_NO,
			PARTICIPANT_CODE,
			NEW_PARTICIPANT_CODE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TURN_TAX_UPDATE_ADNL
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_TURN_TAX_UPDATE_ADNL]
(                             
 @SAUDA_DATE VARCHAR(11),                 
 @FROMPARTY VARCHAR(10),                 
 @TOPARTY VARCHAR(10)                
)  

AS

-- EXEC PROC_TURN_TAX_UPDATE_ADNL 'D', 'OCT 16 2016', '0', 'ZZZZZZ'

SELECT SAUDA_DATE, PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO, SRNO = MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO), TOTFLAG = 1,
TOTSRNO = 0, CHRGSRNO = 0
INTO #TOTTRADE
FROM (
		SELECT SAUDA_DATE=LEFT(SAUDA_DATE,11), 
				PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO), SRNO = MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO)
		FROM BFOSETTLEMENT
		WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND TRADEQTY > 0 AND TRADE_PRICE > 0
		AND AUCTIONPART <> 'CA'
		GROUP BY LEFT(SAUDA_DATE,11), PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO,TRADE_NO 
		) A 
GROUP BY SAUDA_DATE, PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO
 
SELECT TRADE_NO_CNT = 1, T.SNO, FROM_LIMIT, TO_LIMIT INTO #TOT FROM TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG'
AND FROM_LIMIT = (SELECT MIN(FROM_LIMIT) FROM  TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG')

CREATE TABLE #CLTAX 
(
	PARTY_CODE	VARCHAR(10)
)

INSERT INTO #CLTAX
SELECT PARTY_CODE 
FROM FOCLIENTTAXES 
WHERE @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
AND FUT_TURNOVER_TAX <= 0 
AND EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
			WHERE #TOTTRADE.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE)

UPDATE #TOTTRADE SET TOTFLAG = 0
FROM #CLTAX C
WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

TRUNCATE TABLE #CLTAX

INSERT INTO #CLTAX
SELECT PARTY_CODE 
FROM CLIENT2 WHERE EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
				           WHERE #TOTTRADE.PARTY_CODE = CLIENT2.CL_CODE)
AND TURNOVER_TAX <= 0

UPDATE #TOTTRADE SET TOTFLAG = 0
FROM #CLTAX C
WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

UPDATE #TOTTRADE SET CHRGSRNO = #TOT.SNO
FROM #TOT

UPDATE BFOSETTLEMENT SET TURN_TAX = TURN_TAX + CHARGE_TAX
FROM #TOT T, #TOTTRADE T1, TBL_TURNOVER_TAX B
WHERE BFOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND BFOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND T.SNO = B.SNO
AND BFOSETTLEMENT.SRNO = T1.SRNO 
AND TOTFLAG = 1

DROP TABLE #TOT
DROP TABLE #TOTTRADE
DROP TABLE #CLTAX

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROCS
-- --------------------------------------------------
CREATE PROCEDURE PROCS     
(@NAME VARCHAR(40))    
AS      
SELECT * FROM SYS.PROCEDURES WHERE NAME LIKE '%' + @NAME + '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECALCBROK
-- --------------------------------------------------
CREATE  PROC  [DBO].[RECALCBROK] 
(
	@SAUDA_DATE 	VARCHAR (11),
	@PARTYCODE  	VARCHAR(12)
)
AS    


IF @PARTYCODE=''
	BEGIN
		SET @PARTYCODE = '%'
	END

EXEC PROC_TRADE_TRANSFER_RECAL  @SAUDA_DATE,@PARTYCODE,'%','%','%',0,'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RMSPROC_RISKUPDATE
-- --------------------------------------------------
CREATE PROC [DBO].[RMSPROC_RISKUPDATE]  
(  
      @MARGINDATE VARCHAR(11) 
)  
  
AS  
  
/*  
EXEC  RMSPROC_RISKUPDATE 'AUG 23 2005'  
*/  
  
  
  
---------------------------------------  
-- FETCHING CLIENT MASTER  
---------------------------------------  
  
  
CREATE TABLE #MARGINCLIENTS  
(  
      PARTY_CODE VARCHAR(10),  
      CL_CODE VARCHAR(10),  
      SHORT_NAME VARCHAR(64),  
      LONG_NAME VARCHAR(100),  
      BRANCH_CD VARCHAR(10),  
      FAMILY VARCHAR(10),  
      SUB_BROKER VARCHAR(10),  
      TRADER VARCHAR(20),  
      APPROVER VARCHAR(30)  
)  
  
  
      SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
      INSERT INTO #MARGINCLIENTS  
      SELECT   
            PARTY_CODE = ISNULL(C2.PARTY_CODE,''),   
            CL_CODE = ISNULL(C1.CL_CODE,''),  
            SHORT_NAME = ISNULL(C1.SHORT_NAME,''),  
            LONG_NAME = ISNULL(C1.LONG_NAME,''),   
            BRANCH_CD = ISNULL(C1.BRANCH_CD,''),   
            FAMILY = ISNULL(C1.FAMILY,''),   
            SUB_BROKER=ISNULL(C1.SUB_BROKER,''),  
            TRADER=ISNULL(C1.TRADER,''),  
            APPROVER=ISNULL(C5.APPROVER,'')  
      FROM  
            CLIENT1 C1 (NOLOCK),  
            CLIENT2 C2 (NOLOCK),  
            CLIENT5 C5 (NOLOCK)  
      WHERE  
            C1.CL_CODE = C2.CL_CODE  
            AND C5.CL_CODE = C1.CL_CODE  
  
  
---------------------------------------  
-- FETCHING CLIENT COLLATERAL  
---------------------------------------  
  
  
CREATE TABLE #MARGINCOLLATERAL  
(  
      PARTY_CODE VARCHAR(10),  
      CASH MONEY,  
      NONCASH MONEY,  
      ACTCASH MONEY,  
      ACTNONCASH MONEY,  
      EFFECTIVECOLL MONEY,  
      TOTALFD MONEY,  
      TOTALBG MONEY,  
      TOTALSEC MONEY  
)  
  
  
            SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
            INSERT INTO #MARGINCOLLATERAL    
            SELECT   
            A.PARTY_CODE,  
            CASH = ISNULL(A.ORGCASH,0),   
            NONCASH=ISNULL(A.ORGNONCASH,0),    
            ACTCASH = ISNULL(A.CASH,0),   
            ACTNONCASH=ISNULL(A.NONCASH,0),    
            EFFECTIVECOLL = ISNULL(A.EFFECTIVECOLL,0),  
            TOTALFD = ISNULL(A.TOTALFD,0),  
            TOTALBG = ISNULL(A.TOTALBG,0),  
            TOTALSEC = ISNULL(A.TOTALSEC,0)    
            FROM   
            MSAJAG.DBO.COLLATERAL A,   
            #MARGINCLIENTS MC (NOLOCK)   
            WHERE A.EXCHANGE = 'BSE'    
            AND A.SEGMENT LIKE 'FUT%'    
            AND A.PARTY_CODE = MC.PARTY_CODE  
            AND A.TRANS_DATE LIKE @MARGINDATE + '%'    
                
  
  
---------------------------------------  
-- FETCHING CLIENT BILL  
---------------------------------------  
  
  
CREATE TABLE #MARGINBILL  
(  
      PARTY_CODE VARCHAR(10),  
      BILLAMOUNT MONEY  
)  
  
                    
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  INSERT INTO #MARGINBILL  
  SELECT   
        A.PARTY_CODE,  
        AMOUNT=ISNULL(SUM((CASE WHEN A.SELL_BUY=2 THEN ISNULL(A.AMOUNT,0) ELSE (0-ISNULL(A.AMOUNT,0)) END)),0)    
  FROM   
        BFOACCBILL A (NOLOCK),  
        #MARGINCLIENTS MC (NOLOCK)  
  WHERE 
        BILLDATE LIKE @MARGINDATE + '%'      
        AND A.PARTY_CODE = MC.PARTY_CODE  
  GROUP BY 
        A.PARTY_CODE      
    
  
  
---------------------------------------  
-- FETCHING CLIENT LEDGER  
---------------------------------------  
  
DECLARE @YRSTARTDATE DATETIME  
  
	SELECT   
		@YRSTARTDATE = SDTCUR   
	FROM   
		ACCOUNTBFO.DBO.PARAMETER  
	WHERE   
		@MARGINDATE BETWEEN SDTCUR AND LDTCUR  
	

  
  
CREATE TABLE #MARGINLEDGER  
(  
      PARTY_CODE VARCHAR(10),  
      LEDGERAMOUNT MONEY  
)  
  
                  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
                  INSERT INTO #MARGINLEDGER  
                  SELECT CLTCODE, LEDGERAMOUNT = ISNULL(SUM( CASE WHEN UPPER(LED.DRCR) = 'C' THEN LED.VAMT ELSE -LED.VAMT END), 0)    
                  FROM  
                  (  
                              SELECT             
                                    A.CLTCODE, A.DRCR, SUM(A.VAMT) VAMT  
                              FROM             
                                    ACCOUNTBFO.DBO.LEDGER A  (NOLOCK),  
                                    #MARGINCLIENTS LC                       
                              WHERE             
                                    A.CLTCODE = LC.PARTY_CODE  
                                    AND A.VDT <= @MARGINDATE +' 23:59:59'     
                                    AND A.VDT >= @YRSTARTDATE  
                              GROUP BY             
                                    A.CLTCODE,A.DRCR    
                  ) LED  
                  GROUP BY LED.CLTCODE  
  
  
  
---------------------------------------  
-- FETCHING SPAN MARGINS  
---------------------------------------  
  
   
CREATE TABLE #MARGINSPAN  
(  
      PARTY_CODE VARCHAR(10),  
      MARGINAMOUNT MONEY,  
      MTMMARGIN MONEY,  
      SPANREQ MONEY,  
      NETOPTVALUE MONEY  
)  
  
            SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
            INSERT INTO #MARGINSPAN  
            SELECT   
	            MC.PARTY_CODE,  
	            MARGINAMOUNT = ISNULL(B.MARGINAMOUNT,0),  
	            MTMMARGIN = ISNULL(B.MTMMARGIN,0),  
	            SPANREQ = ISNULL(B.MARGINAMOUNT,0),  
	            NETOPTVALUE = 0  
	            FROM  
            #MARGINCLIENTS MC (NOLOCK)  
            LEFT OUTER JOIN  
                  (  
                        SELECT   
                              A.PARTY_CODE,   
                              MARGINAMOUNT = SUM(ISNULL(A.INIT_MARGIN,0)),  
                              MTMMARGIN = SUM(ISNULL(A.MTM_MARGIN,0))  
                        FROM   
                              BFOMARGINCOLL A (NOLOCK),  
                              #MARGINCLIENTS LC (NOLOCK)  
                        WHERE   
                              A.CL_TYPE LIKE  'CL%'  
                              AND A.PARTY_CODE = LC.PARTY_CODE  
                              AND FILE_DATE LIKE @MARGINDATE + '%'  
                        GROUP BY   
                              A.PARTY_CODE  
                  ) B  
                        ON   
                              (  
                                    B.PARTY_CODE = MC.PARTY_CODE  
                              )  
      
              
---------------------------------------  
-- FETCHING TURNOVER  
---------------------------------------  
  
   
CREATE TABLE #MARGINTURNOVER  
(  
      PARTY_CODE VARCHAR(10),  
      FUTURESTURNOVER MONEY,  
      OPTIONTURNOVER MONEY,  
      EXERCISETURNOVER MONEY  
)  
  
  
  
                  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
                  INSERT INTO #MARGINTURNOVER  
                  SELECT   
	                  PARTY_CODE,  
        	          FUTURESTURNOVER = SUM(FUTVALUE),  
                	  OPTIONTURNOVER =  0,  
	                  EXERCISETURNOVER = 0                    
                  FROM        
                        (  
                              SELECT   
                                    A.PARTY_CODE,    
                                    FUTVALUE = SUM(CASE WHEN RIGHT(A.PRODUCT_CODE,3) = 'FUT' THEN (CASE WHEN AUCTIONPART <> 'CA'  THEN (MARKETRATE* TRADEQTY) ELSE 0 END) ELSE 0 END)
                              FROM  
                                   BFOSETTLEMENT A (NOLOCK),   
                                    #MARGINCLIENTS MC (NOLOCK)  
                              WHERE   
                                    A.SAUDA_DATE LIKE @MARGINDATE + '%'  
                                    AND A.PARTY_CODE = MC.PARTY_CODE  
                              GROUP BY A.PARTY_CODE
                        )      TURN  
                  GROUP BY TURN.PARTY_CODE  
  
  
  
  
---------------------------------------  
-- FETCHING BILLDETAILS  
---------------------------------------  
CREATE TABLE #MARGINBILLDETAILS  
(  
      PARTY_CODE VARCHAR(10),   
      MTMAMOUNT MONEY,  
      EXPIRYMTMAMOUNT MONEY,   
      PREMIUMAMOUNT MONEY,   
      EXALLOCAMOUNT MONEY,   
      BROKERAGE MONEY,    
      SERVICE_TAX MONEY,  
      TURN_TAX MONEY,    
      SEBI_TAX MONEY,  
      STAMPDUTY MONEY,  
      INSURANCE_CHARGE MONEY,   
      OTHER_CHARGE MONEY,  
      EXPIRYBROK MONEY,  
      EXPIRYSERVICE_TAX MONEY,   
      CFBROK MONEY,   
      CFSERTAX MONEY,  
      CFCHARGE MONEY,  
      CLEARINGCHARGE MONEY   
)  
  
  
            SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
            INSERT INTO #MARGINBILLDETAILS  
            SELECT   
                  PARTY_CODE,   
                  SUM(MTMAMOUNT),  
                  SUM(EXPIRYMTMAMOUNT),   
                  SUM(PREMIUMAMOUNT),   
                  SUM(EXALLOCAMOUNT),   
                  SUM(BROKERAGE),    
                  SUM(SERVICE_TAX),  
                  SUM(TURN_TAX),    
                  SUM(SEBI_TAX),  
                  SUM(STAMPDUTY),  
                  SUM(INSURANCE_CHARGE),   
                  SUM(OTHER_CHARGE),  
                  SUM(EXPIRYBROK),  
                  SUM(EXPIRYSERVICE_TAX),   
                  SUM(CFBROK),   
                  SUM(CFSERTAX),  
                  SUM(CFCHARGE),  
                  SUM(CLEARINGCHARGE)    
            FROM  
            (       
                  SELECT   
                        A.PARTY_CODE,   
                        MTMAMOUNT =  (CASE WHEN A.EXPIRYDATE NOT LIKE @MARGINDATE + '%' AND RIGHT(A.PRODUCT_CODE,3) = 'FUT' THEN SUM(( ISNULL(A.PQTY,0) - ISNULL(A.SQTY,0) ) * ( ISNULL(A.CL_RATE,0) -ISNULL(A.NETRATE,0)) ) ELSE 0 END),  
                        EXPIRYMTMAMOUNT =  (CASE WHEN A.EXPIRYDATE LIKE @MARGINDATE + '%' AND RIGHT(A.PRODUCT_CODE,3) = 'FUT' THEN SUM(( ISNULL(A.PQTY,0) - ISNULL(A.SQTY,0) ) * ( ISNULL(A.CL_RATE,0) -ISNULL(A.NETRATE,0)) ) ELSE 0 END),   
                        PREMIUMAMOUNT = (CASE WHEN ISNULL(A.AUCTIONPART,'') <> 'EA' AND RIGHT(A.PRODUCT_CODE,3) = 'OPT' THEN SUM(( ISNULL(A.PQTY,0) - ISNULL(A.SQTY,0) ) * ( /*ISNULL(A.CL_RATE,0)*/ 0 -ISNULL(A.NETRATE,0)) ) ELSE 0 END),   
                        EXALLOCAMOUNT = (CASE WHEN ISNULL(A.AUCTIONPART,'') = 'EA' AND RIGHT(A.PRODUCT_CODE,3) = 'OPT' THEN SUM(( ISNULL(A.PQTY,0) - ISNULL(A.SQTY,0) ) * ( /*ISNULL(A.CL_RATE,0)*/ 0 -ISNULL(A.NETRATE,0)) ) ELSE 0 END),   
                        BROKERAGE = SUM(A.NONEXPIRYBROK),    
                        SERVICE_TAX = SUM(A.NONEXPIRYSERVICE_TAX),  
                        TURN_TAX = SUM(A.TURN_TAX),    
                        SEBI_TAX = SUM(A.SEBI_TAX),  
                        STAMPDUTY = SUM(A.STAMPDUTY),  
                        INSURANCE_CHARGE = SUM(A.INSURANCE_CHRG),   
                        OTHER_CHARGE = SUM(A.OTHER_CHRG),  
                        EXPIRYBROK = SUM(A.EXPIRYBROK),  
                        EXPIRYSERVICE_TAX = SUM(A.EXPIRYSERVICE_TAX),   
                        CFBROK = 0,--SUM(CFBROK),   
                        CFSERTAX = 0,-- SUM(CFSERTAX),  
                        CFCHARGE = 0,--SUM(CFCHARGE),  
                        CLEARINGCHARGE = 0--SUM(CLEARINGCHARGE)    
                  FROM   
                        TBL_MTOMPREMIUMBILL A (NOLOCK),   
                        #MARGINCLIENTS MC (NOLOCK)        
                  WHERE BILLDATE LIKE @MARGINDATE + '%'  
                  AND A.PARTY_CODE = MC.PARTY_CODE  
                  GROUP BY A.PARTY_CODE, A.EXPIRYDATE, A.PRODUCT_CODE, A.AUCTIONPART  
            ) BILLDET  
            GROUP BY PARTY_CODE  
  
  


---------------------------------------  
-- FETCHING EXPOSURE VALUES
---------------------------------------  


EXEC FORISKMGMTEXPOSURE_UPDATE @MARGINDATE


CREATE TABLE #TMPEXPOSURE
(
      PARTY_CODE VARCHAR(10),
      SYMBOL VARCHAR(12),
      LONGFUT MONEY,
      SHORTFUT MONEY,
      SHORTOPT MONEY,
      LONGOPT MONEY,
      CALLOPT MONEY,
      PUTOPT MONEY      
)



            SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
            INSERT INTO #TMPEXPOSURE
            SELECT A.PARTY_CODE,A.SERIES_CODE,     
                  LONGFUT =  ISNULL(SUM( CASE WHEN POSTYPE = '+' AND PRODUCT_CODE LIKE '%FUT'    
                                   THEN (EXPOSUREVALUE) ELSE 0 END), 0),   
                  SHORTFUT = ISNULL(SUM( CASE WHEN POSTYPE = '-' AND PRODUCT_CODE LIKE '%FUT'     
                                    THEN (EXPOSUREVALUE) ELSE 0 END), 0),  
                  SHORTOPT = 0,   
                  LONGOPT =  0,  
                  CALLOPT =  0,    
                  PUTOPT =   0   
            FROM 
                  (
                        SELECT 
				T.PARTY_CODE,
				T.PRODUCT_TYPE,
				T.PRODUCT_CODE,
				T.SERIES_CODE,
				T.SERIES_ID,
				EXPOSUREVALUE=SUM(T.PQTY*T.CL_RATE-T.SQTY*T.CL_RATE),  
				NET_QTY = SUM(T.PQTY-T.SQTY),  
				POSTYPE = (CASE WHEN SUM(T.PQTY-T.SQTY) > 0   
				          THEN '+'   
				          ELSE '-'  
				            END)  
                        FROM 
                              FORISKMGMTEXPOSURE_TBL  T (NOLOCK),
                              #MARGINCLIENTS MC (NOLOCK)
                        WHERE 
                              T.PARTY_CODE = MC.PARTY_CODE
                        GROUP BY 
				T.PARTY_CODE,
				T.PRODUCT_TYPE,
				T.PRODUCT_CODE,
				T.SERIES_CODE,
				T.SERIES_ID
                        HAVING SUM(T.PQTY-T.SQTY) <> 0  
                  ) A  
            GROUP BY 
            A.PARTY_CODE, 
            A.SERIES_CODE    




DECLARE @@PARTYCUR CURSOR
DECLARE @@EXPCUR CURSOR
DECLARE @@UNIQPARTY VARCHAR(10)
DECLARE @@PARTYCODE VARCHAR(10)
DECLARE @@SYMBOL VARCHAR(12)
DECLARE @@LONGFUT MONEY
DECLARE @@SHORTFUT MONEY
DECLARE @@LONGOPT MONEY
DECLARE @@SHORTOPT MONEY
DECLARE @@CALLOPT MONEY
DECLARE @@PUTOPT MONEY

DECLARE @@EXPLONGFUT MONEY
DECLARE @@EXPSHORTFUT MONEY
DECLARE @@EXPLONGOPT MONEY
DECLARE @@EXPSHORTOPT MONEY
DECLARE @@HEDGEEXPOSURE MONEY
DECLARE @@NETFUTURESEXPOSURE MONEY
DECLARE @@NETCALLEXPOSURE MONEY
DECLARE @@NETPUTEXPOSURE MONEY

CREATE TABLE #MARGINEXPOSURE
(  
      PARTY_CODE VARCHAR(10),   
      LONG_FUTURESEXPOSURE MONEY, 
      SHORT_FUTURESEXPOSURE MONEY,
      SHORT_OPTIONSEXPOSURE MONEY,
      LONG_OPTIONSEXPOSURE MONEY,
      HEDGE_OPTIONSEXPOSURE MONEY
)  


SET @@PARTYCUR = CURSOR FOR

      SELECT 
            DISTINCT PARTY_CODE 
      FROM 
            #TMPEXPOSURE
      WHERE 
            LONGFUT <> 0
            OR SHORTFUT <> 0
            OR SHORTOPT <> 0
            OR LONGOPT <> 0
            OR CALLOPT <> 0
            OR PUTOPT <> 0

OPEN @@PARTYCUR
FETCH NEXT FROM @@PARTYCUR INTO @@UNIQPARTY
 
WHILE @@FETCH_STATUS = 0
BEGIN

      SET @@EXPLONGFUT = 0
      SET @@EXPSHORTFUT = 0
      SET @@EXPLONGOPT = 0
      SET @@EXPSHORTOPT = 0
      SET @@HEDGEEXPOSURE = 0
      SET @@NETFUTURESEXPOSURE  = 0
      SET @@NETCALLEXPOSURE = 0
      SET @@NETPUTEXPOSURE = 0

            SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
            SET @@EXPCUR = CURSOR FOR                      
                  SELECT * FROM #TMPEXPOSURE WHERE PARTY_CODE = @@UNIQPARTY
            OPEN @@EXPCUR
                  FETCH NEXT FROM @@EXPCUR INTO @@PARTYCODE, @@SYMBOL, @@LONGFUT, @@SHORTFUT, @@LONGOPT,
 @@SHORTOPT, @@CALLOPT, @@PUTOPT
                                  
            WHILE @@FETCH_STATUS = 0                      
            BEGIN                      
                              

                  SET @@EXPLONGFUT = @@EXPLONGFUT + @@LONGFUT
                  SET @@EXPSHORTFUT = @@EXPSHORTFUT + @@SHORTFUT
                  SET @@EXPLONGOPT = @@EXPLONGOPT + @@LONGOPT
                  SET @@EXPSHORTOPT = @@EXPSHORTOPT + @@SHORTOPT




                    
                        IF @@PUTOPT < 0
                        BEGIN
                              IF ABS(@@LONGFUT) > @@PUTOPT
                              BEGIN
                                      SET @@NETFUTURESEXPOSURE = @@NETFUTURESEXPOSURE + @@LONGFUT + @@PUTOPT
                              END
                              ELSE
                              BEGIN
                                      SET @@NETFUTURESEXPOSURE = @@NETFUTURESEXPOSURE
                              END
                        END



                    
                        IF @@CALLOPT > 0
                        BEGIN
                              IF ABS(@@SHORTFUT) > @@CALLOPT
                              BEGIN
                                      SET @@NETFUTURESEXPOSURE = @@NETFUTURESEXPOSURE + @@SHORTFUT + @@CALLOPT
                              END
                              ELSE
                              BEGIN
                                      SET @@NETFUTURESEXPOSURE = @@NETFUTURESEXPOSURE
                              END
                        END
                        
                        
                        IF @@NETFUTURESEXPOSURE > 0
                        BEGIN
                              IF @@CALLOPT < 0
                              BEGIN
                                    IF ABS(@@CALLOPT) > @@NETFUTURESEXPOSURE
                                    BEGIN
                                          SET @@NETCALLEXPOSURE = @@NETCALLEXPOSURE + @@NETFUTURESEXPOSURE + @@CALLOPT
                                    END
                                    ELSE
                                    BEGIN
                                          SET @@NETCALLEXPOSURE = @@NETCALLEXPOSURE
                                    END
                              END
                        END
                        ELSE
                        BEGIN
                              IF @@NETFUTURESEXPOSURE < 0
                              BEGIN
                                    IF @@CALLOPT < 0
                                    BEGIN
                                          SET @@NETCALLEXPOSURE = @@NETCALLEXPOSURE + @@CALLOPT
                                    END
                              END
                        END

                          
                        IF @@CALLOPT = 0
                        BEGIN
                              SET @@NETCALLEXPOSURE = @@NETCALLEXPOSURE
                        END
                                                
                                                
                        IF @@NETFUTURESEXPOSURE < 0
                        BEGIN
                              IF @@PUTOPT > 0
                              BEGIN
                                    IF ABS(@@PUTOPT) > ABS(@@NETFUTURESEXPOSURE)
                                    BEGIN
                                          SET @@NETPUTEXPOSURE = @@NETPUTEXPOSURE + @@NETFUTURESEXPOSURE + @@PUTOPT
                                    END
                                    ELSE
                                    BEGIN
                                          SET @@NETPUTEXPOSURE = @@NETPUTEXPOSURE
                                    END
                              END
                        END
                        ELSE
                        BEGIN
                              IF @@NETFUTURESEXPOSURE > 0
                              BEGIN
                                    IF @@PUTOPT > 0
                                    BEGIN
                                          SET @@NETPUTEXPOSURE = @@NETPUTEXPOSURE + @@PUTOPT
                                    END
                              END
                        END
                        
                        
                        IF @@PUTOPT = 0 
                        BEGIN
                            SET @@NETPUTEXPOSURE = @@NETPUTEXPOSURE
                        END
                        

                                  
                  FETCH NEXT FROM @@EXPCUR INTO @@PARTYCODE, @@SYMBOL, @@LONGFUT, @@SHORTFUT, @@LONGOPT, @@SHORTOPT, @@CALLOPT, @@PUTOPT
            END                   
            CLOSE @@EXPCUR                      
            DEALLOCATE @@EXPCUR     



                        SET @@HEDGEEXPOSURE = @@NETFUTURESEXPOSURE + @@NETCALLEXPOSURE + @@NETPUTEXPOSURE



                        INSERT INTO #MARGINEXPOSURE 
                        VALUES
                        (
                              @@PARTYCODE,
                              @@EXPLONGFUT,
                              @@EXPSHORTFUT,
                              @@EXPSHORTOPT,
                              @@EXPLONGOPT,
                              @@HEDGEEXPOSURE
                        )
      

      FETCH NEXT FROM @@PARTYCUR INTO @@UNIQPARTY
END
CLOSE @@PARTYCUR
DEALLOCATE @@PARTYCUR
---------------------------------------  
-- AND FINALLY  
---------------------------------------  
  
  
/****** OBJECT:  INDEX CLTCODE ON TABLE [DBO].[ACMAST]    SCRIPT DATE: 08/23/2005 22:08:09 ******/  
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINCLIENTS]([PARTY_CODE])   
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINBILLDETAILS]([PARTY_CODE])   
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINBILL]([PARTY_CODE])   
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINLEDGER]([PARTY_CODE])   
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINCOLLATERAL]([PARTY_CODE])   
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINSPAN]([PARTY_CODE])   
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINTURNOVER]([PARTY_CODE])   
 CREATE  INDEX [CLTCODE] ON [DBO].[#MARGINEXPOSURE]([PARTY_CODE])     
  
                        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
                        SELECT   
                              PARTY_CODE = A.PARTY_CODE,  
                              SHORT_NAME = A.SHORT_NAME,  
                              LONG_NAME = A.LONG_NAME,  
                              BRANCH_CD = A.BRANCH_CD,  
                              FAMILY = A.FAMILY,  
                              SUB_BROKER = A.SUB_BROKER,  
                              TRADER = A.TRADER,  
                              CUSTOMEREXEC = A.APPROVER,  
                              MARGINDATE = @MARGINDATE,  
                                
                              DAILYMTMAMT = ISNULL(B.MTMAMOUNT,0),  
                              FINALDAYMTMAMT = ISNULL(B.EXPIRYMTMAMOUNT,0),  
                              PREMIUMAMT = ISNULL(B.PREMIUMAMOUNT,0),  
                              EXALLOCAMT = ISNULL(B.EXALLOCAMOUNT,0),  
                              BROKERAGE = ISNULL(B.BROKERAGE,0),  
                              SERVICETAX = ISNULL(B.SERVICE_TAX,0),  
                              TURNTAX = ISNULL(B.TURN_TAX,0),  
                              SEBITAX = ISNULL(B.SEBI_TAX,0),  
                              INSURANCECHARGE = ISNULL(B.INSURANCE_CHARGE,0),  
                              STAMPDUTY = ISNULL(B.STAMPDUTY,0),  
            			OTHERCHARGES = ISNULL(B.OTHER_CHARGE,0),  
                              EXPIRYBROKERAGE = ISNULL(B.EXPIRYBROK,0),  
                              EXPIRYSERVICETAX = ISNULL(B.EXPIRYSERVICE_TAX,0),  
                              CFBROKERAGE = ISNULL(B.CFBROK,0),  
                              CFSERVICETAX = ISNULL(B.CFSERTAX,0),  
                              CFCHARGES = ISNULL(B.CFCHARGE,0),  
                              CLEARINGCHARGES = ISNULL(B.CLEARINGCHARGE,0),  
                                
                              BILLAMOUNT = ISNULL(C.BILLAMOUNT,0),  
                                
                              LEDGERAMOUNT = ISNULL(D.LEDGERAMOUNT,0),  
                                
                              CASH_COLL = ISNULL(E.CASH,0),  
                              NONCASH_COLL = ISNULL(E.NONCASH,0),  
                              EFFECTIVECOLL = ISNULL(E.EFFECTIVECOLL,0),  
                              HAIRCUTCASH_COLL = ISNULL(E.ACTCASH,0),  
                              HAIRCUTNONCASH_COLL = ISNULL(E.ACTNONCASH,0),  
                              TOTALFD = ISNULL(E.TOTALFD,0),  
                              TOTALBG = ISNULL(E.TOTALBG,0),  
                              TOTALSECURITIES = ISNULL(E.TOTALSEC,0),  
                                
                              INITIALMARGIN_MG13 = ISNULL(F.MARGINAMOUNT,0),  
                              MTOMMARGIN_MG13 = ISNULL(F.MTMMARGIN,0),  
                              SPANMARGIN = ISNULL(F.SPANREQ,0),  
                                
                              LONG_FUTURESEXPOSURE = ISNULL(H.LONG_FUTURESEXPOSURE,0),  
                              SHORT_FUTURESEXPOSURE = ISNULL(H.SHORT_FUTURESEXPOSURE,0),  
                              FUTURESEXPOSURE = 0,  
                              LONG_OPTIONSEXPOSURE = ISNULL(H.LONG_OPTIONSEXPOSURE,0),  
                              SHORT_OPTIONSEXPOSURE = ISNULL(H.SHORT_OPTIONSEXPOSURE,0),  
                              OPTIONSEXPOSURE = 0,  
                              HEDGEEXPOSURE = ISNULL(H.HEDGE_OPTIONSEXPOSURE,0),  
                              OPTIONSMTOM = ISNULL(F.NETOPTVALUE,0),  
                                
                              FUTURESTURNOVER = ISNULL(G.FUTURESTURNOVER,0),  
                              OPTIONSTURNOVER = ISNULL(G.OPTIONTURNOVER,0),  
                              EXALLOCTURNOVER = ISNULL(G.EXERCISETURNOVER,0),  
                                
                              BSECM_EXPOSURE = 0,  
                              NSECM_EXPOSURE = 0,  
                              DUMMY1 = 0,  
                              DUMMY2= 0,  
                              LST_UPDATE_DT = GETDATE()  
                                    INTO #RMS_MARGINFINAL                    
                        FROM   
                        #MARGINCLIENTS A (NOLOCK)  
                        LEFT OUTER JOIN   
                              #MARGINBILLDETAILS B (NOLOCK)  
                                    ON (A.PARTY_CODE = B.PARTY_CODE)  
                        LEFT OUTER JOIN   
                              #MARGINBILL C (NOLOCK)  
                                    ON (A.PARTY_CODE = C.PARTY_CODE)  
                        LEFT OUTER JOIN   
                              #MARGINLEDGER D (NOLOCK)  
                                    ON (A.PARTY_CODE = D.PARTY_CODE)  
                        LEFT OUTER JOIN   
                              #MARGINCOLLATERAL E (NOLOCK)  
                                    ON (A.PARTY_CODE = E.PARTY_CODE)  
                        LEFT OUTER JOIN   
                              #MARGINSPAN F (NOLOCK)  
                                    ON (A.PARTY_CODE = F.PARTY_CODE)  
                        LEFT OUTER JOIN   
                              #MARGINTURNOVER G (NOLOCK)  
                                    ON (A.PARTY_CODE = G.PARTY_CODE)  
                       LEFT OUTER JOIN   
                              #MARGINEXPOSURE H (NOLOCK)  
                                    ON (A.PARTY_CODE = H.PARTY_CODE)  
                          
  
  
DROP TABLE #MARGINCLIENTS   
DROP TABLE #MARGINBILLDETAILS  
DROP TABLE #MARGINBILL   
DROP TABLE #MARGINLEDGER  
DROP TABLE #MARGINCOLLATERAL  
DROP TABLE #MARGINSPAN  
DROP TABLE #MARGINTURNOVER  
DROP TABLE #MARGINEXPOSURE
DROP TABLE #TMPEXPOSURE  
  


      DELETE FROM FORISKMANAGEMENT_TBL WHERE MARGINDATE LIKE @MARGINDATE + '%'  
      INSERT INTO FORISKMANAGEMENT_TBL  
      SELECT 
            * 
      FROM 
            #RMS_MARGINFINAL  
      WHERE
            BILLAMOUNT <> 0
            OR BROKERAGE <> 0
            OR BSECM_EXPOSURE <> 0
            OR CASH_COLL <> 0
            OR CFBROKERAGE <> 0
            OR CFCHARGES <> 0
            OR CFSERVICETAX <> 0
            OR CLEARINGCHARGES <> 0
            OR DAILYMTMAMT <> 0
            OR EFFECTIVECOLL <> 0
            OR EXALLOCAMT <> 0
            OR EXALLOCTURNOVER <> 0
            OR EXPIRYBROKERAGE <> 0
            OR EXPIRYSERVICETAX <> 0
            OR FINALDAYMTMAMT <> 0
            OR FUTURESEXPOSURE <> 0
            OR FUTURESTURNOVER <> 0
            OR HAIRCUTCASH_COLL <> 0
            OR HAIRCUTNONCASH_COLL <> 0
            OR HEDGEEXPOSURE <> 0
            OR INITIALMARGIN_MG13 <> 0
            OR INSURANCECHARGE <> 0
            OR LEDGERAMOUNT <> 0
            OR LONG_FUTURESEXPOSURE <> 0
            OR LONG_OPTIONSEXPOSURE <> 0
            OR MTOMMARGIN_MG13 <> 0
            OR NONCASH_COLL <> 0
            OR NSECM_EXPOSURE <> 0
            OR OPTIONSEXPOSURE <> 0
            OR OPTIONSMTOM <> 0
            OR OPTIONSTURNOVER <> 0
            OR OTHERCHARGES <> 0
            OR PREMIUMAMT <> 0
            OR SEBITAX <> 0
            OR SERVICETAX <> 0
            OR SHORT_FUTURESEXPOSURE <> 0
            OR SHORT_OPTIONSEXPOSURE <> 0
            OR SPANMARGIN <> 0
            OR STAMPDUTY <> 0
            OR TOTALBG <> 0
            OR TOTALFD <> 0
            OR TOTALSECURITIES <> 0
            OR TURNTAX <> 0


DROP TABLE #RMS_MARGINFINAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCALLPARTYLEDVOUCHERDISP
-- --------------------------------------------------
/* REPORT : ALLPARTYLEDGER           
    FILENAME :  VOUCHERDISP.ASP          
*/          
/* DISPLAYS DETAILS OF A VOUCHER FOR A PARTY FOR A DATE */          
--EXEC RPT_ACCALLPARTYLEDVOUCHERDISP '3', '200400001901', 'MAY  5 2004', '41', '', '10100063'        
CREATE PROCEDURE [DBO].[RPT_ACCALLPARTYLEDVOUCHERDISP]          
@VTYP SMALLINT ,          
@VNO VARCHAR (12),          
@VDT VARCHAR(12) ,          
@BOOKTYPE VARCHAR(2),          
@BRANCH VARCHAR(10),          
@CLTCODE VARCHAR(10)          
          
AS          
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'          
BEGIN          
 SELECT  VAMT , L.VTYP , L.VNO , L.VDT , L.DRCR , CLTCODE, ACNAME,  L.LNO , DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,           
 NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,           
 DDDT  =  CONVERT(VARCHAR, DDDT, 103)            
 FROM ACCOUNTBFO.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTBFO.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO       
--AND L.LNO = L1.LNO          
 WHERE L.VTYP = @VTYP          
 AND L.VNO = @VNO            
 AND L.VDT LIKE  LTRIM(VDT) + '%'          
 AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE          
 ORDER BY L.DRCR DESC , L.LNO           
END          
ELSE          
BEGIN          
 SELECT  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,           
 DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),           
 NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,           
 DDDT  =  CONVERT(VARCHAR, DDDT, 103)            
 FROM ACCOUNTBFO.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTBFO.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO,       
--AND L.LNO = L1.LNO,          
 ACCOUNTBFO.DBO.LEDGER2 L2 LEFT OUTER JOIN ACCOUNTBFO.DBO.ACMAST A ON L2.CLTCODE = A.CLTCODE          
 WHERE L.VTYP = @VTYP          
 AND L.VNO = @VNO            
 AND L.VDT LIKE  LTRIM(VDT) + '%'          
 AND L.BOOKTYPE = @BOOKTYPE AND L.CLTCODE = @CLTCODE          
 AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO          
        AND COSTCODE = (SELECT COSTCODE FROM ACCOUNTBFO.DBO.COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))          
 ORDER BY L2.DRCR DESC , L2.LNO           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCBALSHEETCHKRECORDS
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCBALSHEETCHKRECORDS    SCRIPT DATE: 01/15/2005 1:25:32 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCBALSHEETCHKRECORDS    SCRIPT DATE: 12/16/2003 2:31:40 PM ******/
CREATE  PROCEDURE [DBO].[RPT_ACCBALSHEETCHKRECORDS]

@INCOMEOREXP CHAR(1),
@STATUSID CHAR(15),
@STATUNAME CHAR(15)



AS


SELECT COUNT(*) FROM ACCOUNTBFO.DBO.ACMAST A, ACCOUNTBFO.DBO.LEDGER L 
WHERE A.CLTCODE=L.CLTCODE AND A.GRPCODE LIKE @INCOMEOREXP+ '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCCOMPANYNAME
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_ACCCOMPANYNAME]
@SHAREDB VARCHAR(15)
AS
SELECT COMPANYNAME FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = @SHAREDB

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPANDL
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCPANDL    SCRIPT DATE: 01/15/2005 1:26:21 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCPANDL    SCRIPT DATE: 12/16/2003 2:31:41 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCPANDL    SCRIPT DATE: 06/26/2002 6:15:44 PM ******/  
/* CH BY MOUSAMI ON 15 APR 2002   
     ADDED BRANCH LOGIN EFFECT */  
  
  
CREATE  PROCEDURE  [DBO].[RPT_ACCPANDL]  
  
@FROMDT VARCHAR(11),  
@TODT VARCHAR(11),  
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(25)  
  
  
AS  
  
IF @STATUSID='BROKER'  
BEGIN  
 SELECT G1.GRPNAME,G1.GRPCODE,   
 VAMT=ISNULL(( SELECT SUM(CASE WHEN DRCR ='C' THEN VAMT*-1 ELSE VAMT END )FROM ACCOUNTBFO.DBO.LEDGER L ,ACCOUNTBFO.DBO.ACMAST A ,ACCOUNTBFO.DBO.GRPMAST G   
       WHERE L.CLTCODE = A.CLTCODE AND G.GRPCODE =G1.GRPCODE AND L.VDT >= @FROMDT + ' 00:00:00'  
       AND L.VDT <=@TODT + ' 23:59:59' AND SUBSTRING(A.GRPCODE,1,1) = SUBSTRING(G.GRPCODE,1,1)),0)   
 FROM ACCOUNTBFO.DBO.GRPMAST G1   
 WHERE G1.GRPCODE='N0000000000' OR  G1.GRPCODE='X0000000000'   
 ORDER BY G1.GRPCODE  
END  
ELSE  
BEGIN  
 SELECT G1.GRPNAME,G1.GRPCODE,   
 VAMT=ISNULL(( SELECT SUM(CASE WHEN L.DRCR ='C' THEN VAMT*-1 ELSE VAMT END )FROM  
  ACCOUNTBFO.DBO.LEDGER L ,ACCOUNTBFO.DBO.ACMAST A ,ACCOUNTBFO.DBO.GRPMAST G ,  ACCOUNTBFO.DBO.LEDGER2_REPORT L2 ,  ACCOUNTBFO.DBO.COSTMAST C , ACCOUNTBFO.DBO.CATEGORY C1  
   WHERE L.CLTCODE = A.CLTCODE AND G.GRPCODE =G1.GRPCODE AND L.VDT >= @FROMDT + ' 00:00:00'  
     AND L.VDT <=@TODT  + ' 23:59:59'   
     AND L.VNO=L2.VNO AND L.VTYP=L2.VTYPE AND L.LNO=L2.LNO AND L.DRCR=L2.DRCR  
 AND C.COSTCODE=L2.COSTCODE  
 AND C.CATCODE=C1.CATCODE  
 AND L.BOOKTYPE=L2.BOOKTYPE  
 AND C1.CATEGORY='BRANCH'  
    AND C.COSTNAME=@STATUSNAME  
  AND SUBSTRING(A.GRPCODE,1,1) = SUBSTRING(G.GRPCODE,1,1)),0)   
  FROM ACCOUNTBFO.DBO.GRPMAST G1   
  WHERE G1.GRPCODE='N0000000000' OR  G1.GRPCODE='X0000000000'   
  ORDER BY G1.GRPCODE  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCVDESC
-- --------------------------------------------------
CREATE PROCEDURE   
[DBO].[RPT_ACCVDESC]   
@VTYPE SMALLINT  
AS  
SELECT VDESC FROM ACCOUNTBFO.DBO.VMAST WHERE   
VTYPE = @VTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ADMIN_LOG
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_ADMIN_LOG]  
(  
 @LOGTYPE VARCHAR(20),  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @REPORTORDER INT,  
 @TXTNAME VARCHAR(25)  
)  
AS  
  
/*  
POSSIBLE VALUES OF @LOGTYPE   
   
 MENURIGHTS  
 CATEGORY  
 ADMIN_USER  
 USERLOG  
  
*/  
  
IF @LOGTYPE ='MENURIGHTS'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - REPORT NAME + DATE  
  2 - CATEGORY + DATE  
 */  	
 SELECT   
  REPORTORDER =   
   CASE WHEN @REPORTORDER = 1 THEN REPORTNAME ELSE RIGHT(CATEGORYNAME,LEN(CATEGORYNAME)-1) END  
   + CONVERT(VARCHAR,YEAR(CREATEDON)) + CONVERT(VARCHAR,MONTH(CREATEDON)) + CONVERT(VARCHAR,DAY(CREATEDON)) +  CONVERT(VARCHAR,CREATEDON,108),  
  REPORTNAME,  
  LOGINCATEGORY,  
  CATEGORYNAME,  
  EDITFLAG =  ISNULL(CASE   
    WHEN EDIT_FLAG ='D' THEN 'CATEGORY DELETED'   
    WHEN EDIT_FLAG ='A' THEN 'CATEGORY ADDEDED'  
    WHEN EDIT_FLAG ='E' THEN  
    CASE WHEN LEFT(CATEGORYNAME,1) ='-'   
     THEN 'RIGHTS REMOVED'  
     ELSE 'RIGHTS ADDED'  
     END  
       END,'') ,  
  CREATEDBY,  
  CREATEDON =  CONVERT(VARCHAR,CREATEDON,109),  
  MACHINEIP  
 FROM  
 (  
  SELECT   
   REPORTNAME = TBLREPORTS.FLDREPORTNAME,  
   LOGINCATEGORY = TBLADMIN.FLDNAME,  
   CATEGORYNAME = LTRIM(RTRIM(DBO.FUN_GET_TBLREPORT (FLDCATEGORYCODE_OLD,FLDCATEGORYCODE_NEW))),  
   EDIT_FLAG,  
   CREATEDBY = CREATED_BY,  
   CREATEDON = CREATED_ON,  
   MACHINEIP = MACHINE_IP  
  FROM  
   TBLCATMENU_LOG (NOLOCK),  
   TBLREPORTS (NOLOCK),  
   TBLADMIN (NOLOCK)  
  WHERE  
   TBLADMIN.FLDAUTO_ADMIN = FLDADMINAUTO  
   AND TBLCATMENU_LOG.FLDREPORTCODE = TBLREPORTS.FLDREPORTCODE  
   AND TBLCATMENU_LOG.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
 ) TBLLOG  
 ORDER BY 1  
  
END  
  
IF @LOGTYPE ='CATEGORY'  
BEGIN  
 SELECT    
  REPORTORDER = FLDCATEGORYNAME +  
  + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) + CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) ,  
  FLDCATEGORYNAME,  
  FLDDESC ,  
  EDIT_FLAG = CASE WHEN EDIT_FLAG ='A' THEN 'ADDED' ELSE 'DELETED' END,  
  CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109),   
  CREATED_BY   
 FROM   
  TBLCATEGORY_LOG (NOLOCK)   
 WHERE   
  CREATED_ON  BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDCATEGORYNAME LIKE @TXTNAME+'%'  
 ORDER BY 1  
END  
  
IF @LOGTYPE ='REPORTLOG'  
BEGIN  
 SELECT   
  FLDREPORTNAME,FLDPATH,FLDTARGET,TB.FLDDESC,FLDGRPNAME,  
  FLDSTATUS,  
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109),   
  CREATED_BY   
 FROM   
  TBLREPORTS_LOG TB, TBLREPORTGRP TG  
 WHERE   
  TB.FLDREPORTGRP =TG.FLDREPORTGRP  
  AND TB.FLDMENUGRP = TG.FLDMENUGRP  
  AND CREATED_ON  BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDREPORTNAME LIKE @TXTNAME + '%'  
 ORDER BY 1  
END  
  
IF @LOGTYPE ='ADMIN_USER'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - USER NAME+ DATE  
  2 - EDIT FLAG  + DATE  
 */  
 SELECT   
	REPORTORDER = FLDNAME + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) +   
    CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) +   
    CASE WHEN @REPORTORDER =1 THEN FLDNAME ELSE EDIT_FLAG END , 
	
  USERNAME=FLDNAME,FLDPASSWORD,COMPANY=FLDCOMPANY,  
  LOGINCATEGORY=FLDSTATUS,DESCRIPTION=FLDDESC,PASSWORD_EXP_DT = LEFT(PWD_EXPIRY_DATE,11),  
  MAXWRONGATTEMP_ALLOWD = FLDMAXATTEMPT,  
  USERSTATUS=CASE WHEN FLDUSERSTATUS =0 THEN 'ENABLED' ELSE 'DISABLED' END ,  
  ACCESSLVL= CASE WHEN FLDACCESSLVL ='F' THEN 'FREE ACCESS' ELSE 'LIMITED' END ,  
  IP_FILTER = FLDIPADD,  
  FIRST_LOGIN_FLAG= FLDFIRSTLOGIN,  
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_BY,CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109), MACHINEIP = ISNULL(MACHINEIP,'') , FLDLOG_DATA = ISNULL(FLDLOG_DATA,'')  
 FROM   
  TBLADMIN_LOG (NOLOCK)   
 WHERE  
   TBLADMIN_LOG.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDNAME LIKE @TXTNAME+'%'  
 ORDER BY 1  
  
END  
  
IF @LOGTYPE ='USERLOG'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - USER NAME+ DATE  
  2 - EDIT FLAG  + DATE  
  
 */  
 SELECT   
  REPORTORDER = FLDUSERNAME + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) +   
    CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) +   
    CASE WHEN @REPORTORDER =1 THEN FLDUSERNAME ELSE EDIT_FLAG END ,  
  USERNAME=FLDUSERNAME,FLDPASSWORD,FLDFIRSTNAME,FLDMIDDLENAME,  
  FLDLASTNAME,FLDSEX,FLDADDRESS1,FLDADDRESS2, FLDPHONE1, FLDPHONE2,
  FLDCATEGORY,	
  PWDEXPIRYDAYS = ISNULL(B.FLDPWDEXPIRY,''),  
  PWDEXPIRY = ISNULL(B.FLDPWDEXPIRY,''),  
  MAXATTEMPT = ISNULL(B.FLDMAXATTEMPT,0),  
  USERSTATUSDB = CASE WHEN ISNULL(B.FLDSTATUS,0) =0 THEN 'ENABLED' WHEN B.FLDSTATUS = 1 THEN 'DISABLED' ELSE 'UNAUTHORISED' END ,   
  ATTEMPTCNT = ISNULL(B.FLDATTEMPTCNT,0),   
  LOGINFLAG = CASE WHEN ISNULL(B.FLDLOGINFLAG,0) = 0 THEN 'LOGGED OUT' ELSE 'LOGGED IN' END,   
  ACCESSLVL = CASE WHEN ISNULL(B.FLDACCESSLVL,'F') = 'F' THEN 'FREE ACCESS' ELSE 'LIMITED' END,   
  IPADD = ISNULL(B.FLDIPADD,''),   
  TIMEOUT = ISNULL(B.FLDTIMEOUT,0),   
  FIRSTLOGIN = CASE WHEN ISNULL(B.FLDFIRSTLOGIN,'N') = 'N' THEN 'NO' ELSE 'YES' END,   
  FORCELOGOUT = CASE WHEN ISNULL(B.FLDFORCELOGOUT,0) = 0 THEN 'ALLOW ACCESS' ELSE 'DO NOT ALLOW' END,   
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_BY,CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109), MACHINEIP = ISNULL(MACHINEIP,'') , FLDLOG_DATA = ISNULL(FLDLOG_DATA,'')   
 FROM   
  TBLPRADNYAUSERS_LOG A (NOLOCK)   
  LEFT OUTER JOIN TBLUSERCONTROLMASTER_JRNL B (NOLOCK) 
 ON   
  (B.FLDUSERID = A.FLDAUTO AND B.FLDUPDTDT = A.CREATED_ON)     
 WHERE  
   A.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDUSERNAME LIKE @TXTNAME+'%'   
 ORDER BY 1  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_AREALISTING
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_AREALISTING]
	(
    @FROMAREACODE VARCHAR(15),
	@TOAREACODE VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15)
	)
	
AS
    IF @FROMAREACODE = '' BEGIN SET @FROMAREACODE = '0'  END
    IF @TOAREACODE = '' BEGIN SET @TOAREACODE = 'ZZZZZZ' END
    IF @FROMBRANCH = '' BEGIN SET @FROMBRANCH = '0'  END
    IF @TOBRANCH = '' BEGIN SET @TOBRANCH = 'ZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
			AREACODE = UPPER(AREACODE),
			DESCRIPTION = UPPER(DESCRIPTION),
			BRANCH_CODE = UPPER(BRANCH_CODE)

FROM 
    AREA

WHERE
    AREACODE BETWEEN @FROMAREACODE AND @TOAREACODE
    AND BRANCH_CODE BETWEEN @FROMBRANCH AND @TOBRANCH
    

ORDER BY
		AREACODE,DESCRIPTION,BRANCH_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BANKDETAILS
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_BANKDETAILS]   
 (   
 @PARTYCODE VARCHAR(10)   
 )  
  
 --EXEC RPT_BANKDETAILS 'O123'  
   
 AS  
   
 SET NOCOUNT ON   
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 SELECT   
  BANKNAME = ISNULL(P.BANK_NAME,''),  
  BRANCH = ISNULL(P.BRANCH_NAME,''),  
  ACNUM = ISNULL(C.CLTDPID,''),  
  ACTYPE = ISNULL(C.DEPOSITORY,'')  
 FROM  
  CLIENT4 C (NOLOCK)  
   JOIN POBANK P (NOLOCK)  
   ON (P.BANKID = C.BANKID)  
 WHERE  
  C.DEPOSITORY NOT IN ('CDSL','NSDL')  
  AND C.PARTY_CODE = @PARTYCODE  
  
------  
UNION  
------  
    
 SELECT   
  BANKNAME = ISNULL(P.BANK_NAME,''),  
  BRANCH = ISNULL(P.BRANCH_NAME,''),  
  ACNUM = ISNULL(C.ACCNO,''),  
  ACTYPE = (CASE WHEN ISNULL(C.ACCTYPE,'')  = 'SB' THEN 'SAVING' 
                           WHEN ISNULL(C.ACCTYPE,'')  = 'CA' THEN 'CURRENT' 
                           WHEN ISNULL(C.ACCTYPE,'')  = 'OD' THEN 'OVER DRAFT' 
                           ELSE 'OTHER'
                  END)  
 FROM  
  ACCOUNTFO.DBO.MULTIBANKID C (NOLOCK)  
   JOIN POBANK P (NOLOCK)  
   ON (P.BANKID = C.BANKID)  
 WHERE  
  C.CLTCODE = @PARTYCODE
  AND  ACCNO NOT IN (SELECT CLTDPID FROM CLIENT4 
  WHERE DEPOSITORY NOT IN ('CDSL','NSDL')  
  AND PARTY_CODE = @PARTYCODE  AND CLIENT4.BANKID = C.BANKID)
  
 ORDER BY   
  BANKNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BFOLISTCLIENT
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_BFOLISTCLIENT] (@STATUSID VARCHAR(20), @STAUSNAME VARCHAR(25))
AS
SELECT PARTY_CODE FROM CLIENT2 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BFOLISTCLIENTDESC
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_BFOLISTCLIENTDESC] (@STATUSID VARCHAR(20), @STAUSNAME VARCHAR(25))
AS
SELECT PARTY_CODE FROM CLIENT2 
ORDER BY PARTY_CODE DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BRANCHLISTING
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_BRANCHLISTING]
	(
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15),
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25)
	)
	
 AS

    IF @FROMBRANCH = '' BEGIN SET @FROMBRANCH = '0'  END
    IF @TOBRANCH = '' BEGIN SET @TOBRANCH = 'ZZZZZZ' END

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

 SELECT 
		BRANCHCODE 	= UPPER(B.BRANCH_CODE),
		BRANCHNAME 	= UPPER(ISNULL(B.BRANCH,'')),
		SUBBROKERCODE 	= UPPER(ISNULL(S.SUB_BROKER,'')),
		SUBBROKERNAME 	= UPPER(ISNULL(S.NAME,'')),
		TRADERCODE 	= UPPER(ISNULL(B2.BRANCH_CD,'')),
		TRADERNAME 	= UPPER(ISNULL(B2.LONG_NAME,''))

 FROM
		BRANCH B (NOLOCK)
			LEFT OUTER JOIN SUBBROKERS S (NOLOCK)
			ON (B.BRANCH_CODE = S.BRANCH_CODE)
			
			LEFT OUTER JOIN BRANCHES B2 (NOLOCK)
			ON (B2.BRANCH_CD = B.BRANCH_CODE)

 WHERE
		B.BRANCH_CODE >= @FROMBRANCH	
		AND B.BRANCH_CODE <= @TOBRANCH
                AND @STATUSNAME = (   
                	CASE 
                        WHEN @STATUSID = 'BRANCH' 
                        THEN B.BRANCH_CODE 
                        ELSE 'BROKER' END) 

 ORDER BY
		B.BRANCH_CODE,
		S.SUB_BROKER,
		B2.BRANCH_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BRANCHLOGINCLIENTLIST_NEW1
-- --------------------------------------------------
CREATE PROCEDURE  [DBO].[RPT_BRANCHLOGINCLIENTLIST_NEW1]                 
@FROMDATE AS VARCHAR(11),  
@TODATE AS VARCHAR(11),  
@ORDER_BY AS VARCHAR(80),  
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(25),  
@FILTERVALUE VARCHAR(10),  
@FROMPARTY VARCHAR(15),  
@TOPARTY VARCHAR(15)  
  
AS  
  
DECLARE @BRANCHCODE VARCHAR(15)                  
  
IF ISNULL(@FILTERVALUE,'') = ''                   
BEGIN                  
 SELECT @BRANCHCODE = '%'                  
END                  
ELSE                  
BEGIN                  
 SELECT @BRANCHCODE = @FILTERVALUE                  
END                  
                  
IF @FROMPARTY = ''                  
BEGIN                  
 SET @FROMPARTY ='00000000'                  
END                  
                  
IF @TOPARTY = ''                  
BEGIN                  
 SET @TOPARTY = 'ZZZZZZZZ'                  
END                  
                   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
    
SELECT     
    C1.SHORT_NAME,     
    C1.LONG_NAME,     
    ISNULL(C1.RES_PHONE1,'-') AS RES_PHONE1,     
    ISNULL(C1.OFF_PHONE1,'-') AS OFF_PHONE1,     
    C1.CL_CODE,     
    ISNULL(C1.EMAIL,'-') AS EMAIL,     
    ISNULL(C1.BRANCH_CD,'-') AS BRANCH_CD,     
    ISNULL(C1.FAMILY,'-') AS FAMILY,     
    ISNULL(C1.SUB_BROKER,'-') AS SUB_BROKER,     
    ISNULL(C1.TRADER,'-') AS TRADER,     
    C2.PARTY_CODE,     
    C2.TURNOVER_TAX,     
    C2.SEBI_TURN_TAX,     
    INSURANCE_CHRG,    
    BROKERNOTE,     
    OTHER_CHRG,     
    ISNULL(C3.BRANCH,'-') AS BRANCH,     
    C4.SHORT_NAME AS TRADER_NAME,     
    C5.NAME,    
    C5.COM_PERC,     
    ISNULL(C1.PAN_GIR_NO,'-') AS PAN_GIR_NO,     
    ISNULL(CONVERT(VARCHAR(11),ACTIVEFROM),'-') AS ACTIVEFROM,     
    ISNULL(CONVERT(VARCHAR(11),INACTIVEFROM),'-') AS INACTIVEFROM,     
    INTRODUCER = ISNULL(CL5.INTRODUCER,'-'),     
    APPROVER = ISNULL(CL5.APPROVER,'-'),     
    ISNULL(C1.L_ADDRESS1,'-') AS L_ADDRESS1,     
    ISNULL(C1.L_ADDRESS2,'-') AS L_ADDRESS2,     
    ISNULL(CL41.CLTDPID,'-') AS ACCNO,     
    ISNULL(POBANKCODE,'-') AS POBANKCODE,     
    ISNULL(POBANKNAME,'-') AS POBANKNAME,     
    ISNULL(PAYMODE,'-') AS PAYMODE,     
    BANKID = ISNULL(CL4.BANKID,'-'),     
    CLIENTDPID=ISNULL(CL4.CLTDPID,'-'),     
    ISNULL(C1.L_ADDRESS3,'-') AS L_ADDRESS3,     
    ISNULL(C1.L_CITY,'-') AS L_CITY,     
    ISNULL(C1.L_STATE,'-') AS L_STATE,     
    ISNULL(C1.L_NATION,'-') AS L_NATION,     
    ISNULL(C1.L_ZIP,'-') AS L_ZIP,     
    ISNULL(C1.FAX,'-') AS FAX,     
    ISNULL(C1.MOBILE_PAGER,'-') AS MOBILE_PAGER,     
    CLBANKID=ISNULL(CL41.BANKID,'-'),     
    BANKNAME = ISNULL(B.BANK_NAME,'-')     
FROM CLIENT1 C1,     
    CLIENT5 CL5,  
    /*ON     
    (     
        CL5.CL_CODE = C1.CL_CODE     
 AND CL5.SYSTUMDATE BETWEEN   
    CASE   
    WHEN LEN(@FROMDATE) > 1  
    THEN @FROMDATE ELSE 'JAN  1 1900'   
    END  
 AND  
    CASE   
    WHEN LEN(@TODATE) > 1  
    THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59'   
           END  
    )*/    
    CLIENT2 C2     
LEFT OUTER JOIN     
    CLIENT4 CL4     
    ON     
    (     
        CL4.PARTY_CODE = C2.PARTY_CODE     
        AND CL4.DEFDP = 1     
        AND CL4.DEPOSITORY IN ('CDSL','NSDL')    
    )     
LEFT OUTER JOIN     
    CLIENT4 CL41     
    ON     
    (     
        CL41.CL_CODE = C2.CL_CODE     
        AND CL41.DEPOSITORY NOT IN ('CDSL','NSDL')    
    )     
LEFT OUTER JOIN     
    POBANK B     
    ON     
    (    
        CONVERT(VARCHAR,B.BANKID)=CL41.BANKID    
    )    
    ,     
    BRANCH C3,     
    BRANCHES C4,     
    SUBBROKERS C5,     
    ACCOUNTBFO.DBO.ACMAST AM     
WHERE C1.CL_CODE=C2.CL_CODE     
    AND C1.BRANCH_CD=C3.BRANCH_CODE     
    AND C1.TRADER=C4.SHORT_NAME     
    AND C1.SUB_BROKER=C5.SUB_BROKER     
    AND C3.BRANCH_CODE=C4.BRANCH_CD     
    AND C3.BRANCH_CODE LIKE @BRANCHCODE     
    AND C2.PARTY_CODE >= @FROMPARTY     
    AND C2.PARTY_CODE <= @TOPARTY  
    AND AM.CLTCODE = C2.PARTY_CODE     
    AND CL5.CL_CODE = C1.CL_CODE     
    AND CL5.SYSTUMDATE BETWEEN   
    CASE   
 WHEN LEN(@FROMDATE) > 1  
 THEN @FROMDATE ELSE 'JAN  1 1900'   
 END  
    AND  
    CASE   
 WHEN LEN(@TODATE) > 1  
 THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59'   
        END  
    AND C1.BRANCH_CD LIKE (    
    CASE     
        WHEN @STATUSID = 'BRANCH'     
        THEN @STATUSNAME     
        ELSE '%'     
    END    
    )     
    AND C1.SUB_BROKER LIKE (    
    CASE     
        WHEN @STATUSID = 'SUBBROKER'     
        THEN @STATUSNAME     
        ELSE '%'     
    END    
    )     
    AND TRADER LIKE (    
    CASE     
        WHEN @STATUSID = 'TRADER'     
        THEN @STATUSNAME     
        ELSE '%'     
    END    
    )     
    AND FAMILY LIKE (    
    CASE     
        WHEN @STATUSID = 'FAMILY'     
        THEN @STATUSNAME     
        ELSE '%'     
    END    
    )     
    AND C2.PARTY_CODE LIKE (    
    CASE     
        WHEN @STATUSID = 'CLIENT'     
        THEN @STATUSNAME     
        ELSE '%'     
    END    
    )                                
                  
 ORDER BY (      
    CASE       
        WHEN @ORDER_BY = 'BRANCH'       
        THEN C1.BRANCH_CD       
        ELSE       
        CASE       
            WHEN @ORDER_BY = 'SUBBROKER'       
            THEN C1.SUB_BROKER       
            ELSE       
            CASE       
                WHEN @ORDER_BY = 'PARTYCODE'       
                THEN C2.PARTY_CODE       
                ELSE       
                CASE       
                    WHEN @ORDER_BY = 'CLIENT'       
                    THEN C1.SHORT_NAME       
                    ELSE       
                    CASE       
                        WHEN @ORDER_BY = 'FAMILY'       
                        THEN C1.FAMILY       
                        ELSE       
                        CASE       
                            WHEN @ORDER_BY = 'ACTIVE'       
                            THEN CONVERT(VARCHAR(11),ACTIVEFROM)       
                            ELSE       
                            CASE       
                                WHEN @ORDER_BY = 'INACTIVE'       
                                THEN CONVERT(VARCHAR(11),INACTIVEFROM)       
                            END       
                        END       
                    END       
                END       
            END       
        END       
    END       
    )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BROKTABLEDETAILS
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_BROKTABLEDETAILS]
@TABNO AS INT

AS

SELECT TABLE_NO,UPPER_LIM,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,TRD_DEL,VAL_PERC,LINE_NO,TABLE_NAME,ROUND_TO,
ROFIG,ERRNUM,NOZERO,

RT = ( CASE WHEN ( ROFIG =0  AND  ERRNUM=0.5 AND  NOZERO=1) THEN 'ACTUAL'  ELSE 
      		( CASE WHEN ( ROFIG =1  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
      			( CASE WHEN ( ROFIG =5  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 5P' ELSE
				( CASE WHEN ( ROFIG =-1  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 1P' ELSE
					( CASE WHEN ( ROFIG =-5  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
						( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'
	
						END )END )END )END )END )END )
FROM BROKTABLE
WHERE TABLE_NO = @TABNO
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTLIST_REPORT
-- --------------------------------------------------
CREATE  PROCEDURE  [DBO].[RPT_CLIENTLIST_REPORT]
(              
	@FROMDATE AS VARCHAR(11),
	@TODATE AS VARCHAR(11),
	@ORDER_BY AS VARCHAR(16),
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@FILTERVALUE VARCHAR(10),
	@FROMCODE VARCHAR(10),
	@TOCODE VARCHAR(10)
)
AS

DECLARE 
	@REGIONCODEFROM VARCHAR(10) ,
	@REGIONCODETO VARCHAR(10) ,
	@AREACODEFROM VARCHAR(10) ,
	@AREACODETO VARCHAR(10) ,
	@BRANCHFROM VARCHAR(10) ,
	@BRANCHTO VARCHAR(10) ,
	@SUBBROKERFROM VARCHAR(10) ,
	@SUBBROKERTO VARCHAR(10) ,
	@TRADERFROM VARCHAR(10) ,
	@TRADERTO VARCHAR(10) 

SET @REGIONCODEFROM =''
SET @AREACODEFROM =''
SET @BRANCHFROM =''
SET @SUBBROKERFROM =''
SET @TRADERFROM =''

SET @REGIONCODETO =  'ZZZZZZZZZZZZ'
SET @AREACODETO = 'ZZZZZZZZZZZZZ'
SET @BRANCHTO = 'ZZZZZZZZZZZZZ'
SET @SUBBROKERTO = 'ZZZZZZZZZZZZZ'
SET @TRADERTO = 'ZZZZZZZZZZZZZ'

IF @FILTERVALUE = 'REGION' AND @TOCODE <> ''                
	BEGIN                
		SET @REGIONCODEFROM = @FROMCODE
		SET @REGIONCODETO = @TOCODE               
	END                
IF @FILTERVALUE = 'AREA'    AND @TOCODE <> ''                 
	BEGIN                
		SET @AREACODEFROM = @FROMCODE
		SET @AREACODETO = @TOCODE               
	END 
IF @FILTERVALUE = 'SUBBROKER'  AND @TOCODE <> ''                   
	BEGIN                
		SET @SUBBROKERFROM = @FROMCODE
		SET @SUBBROKERTO = @TOCODE               
	END             
IF @FILTERVALUE = 'BRANCH'  AND @TOCODE <> ''                   
	BEGIN                
		SET @BRANCHFROM = @FROMCODE
		SET @BRANCHTO = @TOCODE               
	END            
IF @FILTERVALUE = 'TRADER'   AND @TOCODE <> ''                  
	BEGIN                
		SET @TRADERFROM = @FROMCODE
		SET @TRADERTO = @TOCODE               
	END         
        
IF @TOPARTY = ''                
BEGIN                
 SET @TOPARTY = 'ZZZZZZZZZZZZZ'                
END                
                 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
  
SELECT   

ORDERBY = (    
    CASE     
        WHEN @ORDER_BY = 'BRANCH'     
        THEN C1.BRANCH_CD     
        ELSE     
        CASE     
            WHEN @ORDER_BY = 'SUBBROKER'     
            THEN C1.SUB_BROKER     
            ELSE     
            CASE     
                WHEN @ORDER_BY = 'PARTYCODE'     
                THEN C2.PARTY_CODE     
                ELSE     
                CASE     
                    WHEN @ORDER_BY = 'CLIENT'     
                    THEN C1.SHORT_NAME     
                    ELSE     
                    CASE     
                        WHEN @ORDER_BY = 'FAMILY'     
                        THEN C1.FAMILY     
                        ELSE     
                        CASE     
                            WHEN @ORDER_BY = 'ACTIVE'     
                            THEN CONVERT(VARCHAR(11),ACTIVEFROM)     
                            ELSE     
                            CASE     
                                WHEN @ORDER_BY = 'INACTIVE'     
                                THEN CONVERT(VARCHAR(11),INACTIVEFROM)     
                            END     
                        END     
                    END     
                END     
            END     
        END     
    END     
    )    ,
    C1.SHORT_NAME,   
    C1.LONG_NAME,   
    ISNULL(C1.RES_PHONE1,'-') AS RES_PHONE1,   
    ISNULL(C1.OFF_PHONE1,'-') AS OFF_PHONE1,   
    C1.CL_CODE,   
    ISNULL(C1.EMAIL,'-') AS EMAIL,   
    ISNULL(C1.BRANCH_CD,'-') AS BRANCH_CD,   
    ISNULL(C1.FAMILY,'-') AS FAMILY,   
    ISNULL(C1.SUB_BROKER,'-') AS SUB_BROKER,   
    ISNULL(C1.TRADER,'-') AS TRADER,   
    C2.PARTY_CODE,   
    C2.TURNOVER_TAX,   
    C2.SEBI_TURN_TAX,   
    INSURANCE_CHRG,  
    BROKERNOTE,   
    OTHER_CHRG,   
    ISNULL(C3.BRANCH,'-') AS BRANCH,   
    C4.SHORT_NAME AS TRADER_NAME,   
    C5.NAME,  
    C5.COM_PERC,   
  ISNULL(C1.PAN_GIR_NO,'-') AS PAN_GIR_NO,   
    ISNULL(CONVERT(VARCHAR(11),ACTIVEFROM),'-') AS ACTIVEFROM,   
    ISNULL(CONVERT(VARCHAR(11),INACTIVEFROM),'-') AS INACTIVEFROM,   
    INTRODUCER = ISNULL(CL5.INTRODUCER,'-'),   
    APPROVER = ISNULL(CL5.APPROVER,'-'),   
    ISNULL(C1.L_ADDRESS1,'-') AS L_ADDRESS1,   
    ISNULL(C1.L_ADDRESS2,'-') AS L_ADDRESS2,   
    ISNULL(CL41.CLTDPID,'-') AS ACCNO,   
    ISNULL(POBANKCODE,'-') AS POBANKCODE,   
    ISNULL(POBANKNAME,'-') AS POBANKNAME,   
    ISNULL(PAYMODE,'-') AS PAYMODE,   
    BANKID = ISNULL(CL4.BANKID,'-'),   
    CLIENTDPID=ISNULL(CL4.CLTDPID,'-'),   
    ISNULL(C1.L_ADDRESS3,'-') AS L_ADDRESS3,   
    ISNULL(C1.L_CITY,'-') AS L_CITY,   
    ISNULL(C1.L_STATE,'-') AS L_STATE,   
    ISNULL(C1.L_NATION,'-') AS L_NATION,   
    ISNULL(C1.L_ZIP,'-') AS L_ZIP,   
    ISNULL(C1.FAX,'-') AS FAX,   
    ISNULL(C1.MOBILE_PAGER,'-') AS MOBILE_PAGER,   
    CLBANKID=ISNULL(CL41.BANKID,'-'),   
    BANKNAME = ISNULL(B.BANK_NAME,'-')   
FROM CLIENT1 C1 (NOLOCK),   
    CLIENT5 CL5 (NOLOCK), 
    CLIENT2 C2 (NOLOCK)   
LEFT OUTER JOIN   
    CLIENT4 CL4   
    ON   
    (   
        CL4.PARTY_CODE = C2.PARTY_CODE   
        AND CL4.DEFDP = 1   
        AND CL4.DEPOSITORY IN ('CDSL','NSDL')  
    )   
LEFT OUTER JOIN   
    CLIENT4 CL41   
    ON   
    (   
        CL41.CL_CODE = C2.CL_CODE   
        AND CL41.DEPOSITORY NOT IN ('CDSL','NSDL')  
    )   
LEFT OUTER JOIN   
    POBANK B   
    ON   
    (  
        CONVERT(VARCHAR,B.BANKID)=CL41.BANKID  
    )  
    ,   
    BRANCH C3 (NOLOCK),   
    BRANCHES C4 (NOLOCK),   
    SUBBROKERS C5 (NOLOCK),   
    ACCOUNTBSEFO.DBO.ACMAST AM (NOLOCK)  
WHERE C1.CL_CODE=C2.CL_CODE   
    AND C1.BRANCH_CD=C3.BRANCH_CODE   
    AND C1.TRADER=C4.SHORT_NAME   
    AND C1.SUB_BROKER=C5.SUB_BROKER   
    AND C3.BRANCH_CODE=C4.BRANCH_CD   
    AND C2.PARTY_CODE >= @FROMPARTY   
    AND C2.PARTY_CODE <= @TOPARTY
    AND AM.CLTCODE = C2.PARTY_CODE   
    AND CL5.CL_CODE = C1.CL_CODE   
   AND CL5.SYSTUMDATE BETWEEN 
    CASE 
	WHEN LEN(@FROMDATE) > 1
	THEN @FROMDATE ELSE 'JAN  1 1900' 
	END
    AND
    CASE 
	WHEN LEN(@TODATE) > 1
	THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' 
        END
    AND @STATUSNAME = (   
        CASE   
                WHEN @STATUSID = 'BRANCH'   
                THEN C1.BRANCH_CD   
                WHEN @STATUSID = 'SUBBROKER'   
                THEN C1.SUB_BROKER   
                WHEN @STATUSID = 'TRADER'   
                THEN C1.TRADER   
                WHEN @STATUSID = 'FAMILY'   
                THEN C1.FAMILY   
                WHEN @STATUSID = 'AREA'   
                THEN C1.AREA   
                WHEN @STATUSID = 'REGION'   
                THEN C1.REGION   
                WHEN @STATUSID = 'CLIENT'   
          THEN C2.PARTY_CODE   
                ELSE 'BROKER' END) 
	AND  C1.REGION BETWEEN @REGIONCODEFROM AND @REGIONCODETO
	AND  C1.AREA BETWEEN @AREACODEFROM AND @AREACODETO
	AND  C1.BRANCH_CD BETWEEN @BRANCHFROM AND @BRANCHTO
	AND  C1.SUB_BROKER BETWEEN @SUBBROKERFROM AND @SUBBROKERTO
	AND  C1.TRADER BETWEEN @TRADERFROM AND @TRADERTO

ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTMARGINREPORT
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_CLIENTMARGINREPORT]    
 (    
 @MDATE VARCHAR(11),    
 @FROMBRANCH VARCHAR(15),    
 @TOBRANCH VARCHAR(15),    
 @FROMPARTY VARCHAR(15),    
 @TOPARTY VARCHAR(15),    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25),    
 @FROMSUBBROKER VARCHAR(15) = '',  
 @TOSUBBROKER VARCHAR(15) ='ZZZZZZZZ'  
 )    
     
 AS    
    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 SELECT  
  EXCHANGE = 'BSE',  
  SEGMENT = 'FUTURES',     
  MDT_FD = SUM(PREV_FD),     
  MDT_BG = SUM(PREV_BG),     
  MDT_SEC = SUM(PREV_SEC),     
  MDT_CASH= SUM(PREV_CASH),     
  MDT_TOTAL = SUM((PREV_FD+PREV_BG+PREV_SEC+PREV_CASH)),    
  MAR_UTILISED = SUM(PREV_VAR),    
  MDT1_FD = SUM(CURR_FD),    
  MDT1_BG = SUM(CURR_BG),    
  MDT1_SEC= SUM(CURR_SEC),    
  MDT1_CASH = SUM(CURR_CASH),    
  MDT1_TOTAL= SUM((CURR_FD+CURR_BG+CURR_SEC+CURR_CASH)),    
  MAR_ADJUSTMENT = SUM(MAR_ADJUST),    
  MAR_STATUS = SUM(MAR_STATUS),    
     
  M.PARTY_CODE,    
  C1.LONG_NAME,    
  C1.L_ADDRESS1,    
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_ZIP,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.EMAIL,    
  C1.PAN_GIR_NO,    
  C1.BRANCH_CD,    
  C1.SUB_BROKER    
 FROM    
  MARGIN_REPORTING M (NOLOCK),    
  CLIENT1 C1 (NOLOCK)    
 WHERE    
  M.PARTY_CODE = C1.CL_CODE    
  AND SAUDA_DATE LIKE @MDATE + '%'    
  AND PARTY_CODE >= @FROMPARTY    
  AND PARTY_CODE <= @TOPARTY    
  AND BRANCH_CD  >= @FROMBRANCH    
  AND BRANCH_CD  <= @TOBRANCH    
  AND SUB_BROKER >= @FROMSUBBROKER  
  AND SUB_BROKER <= @TOSUBBROKER  
  AND @STATUSNAME = (     
 CASE   
         WHEN @STATUSID = 'BRANCH'   
         THEN C1.BRANCH_CD   
         WHEN @STATUSID = 'SUBBROKER'   
         THEN C1.SUB_BROKER   
         WHEN @STATUSID = 'TRADER'   
         THEN C1.TRADER   
         WHEN @STATUSID = 'FAMILY'   
         THEN C1.FAMILY   
         WHEN @STATUSID = 'AREA'   
         THEN C1.AREA   
         WHEN @STATUSID = 'REGION'   
         THEN C1.REGION   
         WHEN @STATUSID = 'CLIENT'   
         THEN M.PARTY_CODE   
         ELSE 'BROKER' END)   
    
 GROUP BY    
  M.PARTY_CODE,    
  C1.LONG_NAME,    
  C1.L_ADDRESS1,    
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_ZIP,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.EMAIL,    
  C1.PAN_GIR_NO,    
  C1.BRANCH_CD,    
  C1.SUB_BROKER    
    
 ORDER BY    
  PARTY_CODE,    
  BRANCH_CD,    
  SUB_BROKER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTPERIOD_NEW
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_CLIENTPERIOD_NEW]    
@FROMDT DATETIME,     
@TODT DATETIME,    
@CLTCODE VARCHAR(10),    
@SORTBY VARCHAR(3),    
@STATUSNAME VARCHAR(25),    
@REPORTPARA VARCHAR(5)    
    
AS    
    
--*** RPT_CLIENTOPENBAL ***--    
IF @REPORTPARA='1' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER     
  WHERE  VDT < @TODT     
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END     
ELSE IF @REPORTPARA='1'    
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER     
  WHERE  EDT < @TODT     
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END    
    
    
    
--*** RPT_CLIENTPERIODDRCR ***--    
IF @REPORTPARA='2' AND @SORTBY = 'VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER     
  WHERE (VDT >=@FROMDT AND VDT <=@TODT + ' 23:59:59')    
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END     
ELSE IF @REPORTPARA='2'   
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER     
  WHERE (EDT >=@FROMDT AND EDT <=@TODT + ' 23:59:59')    
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END    
    
    
--*** RPT_CLIENTPERIODDRCRBR ***--    
IF @REPORTPARA='3' AND @SORTBY = 'VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L2.DRCR WHEN 'D' THEN SUM(CAMT) END),0),     
  CRTOT=ISNULL((CASE L2.DRCR WHEN 'C' THEN SUM(CAMT) END),0)     
  FROM  ACCOUNTBFO.DBO.LEDGER L,  ACCOUNTBFO.DBO.LEDGER2 L2,  ACCOUNTBFO.DBO.COSTMAST C ,  ACCOUNTBFO.DBO.CATEGORY CT    
  WHERE (VDT >=@FROMDT AND VDT <=@TODT + ' 23:59:59')    
  AND L2.CLTCODE=@CLTCODE    
   AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND  CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L2.DRCR     
 END     
ELSE IF @REPORTPARA='3'   
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L2.DRCR WHEN 'D' THEN SUM(CAMT) END),0),     
  CRTOT=ISNULL((CASE L2.DRCR WHEN 'C' THEN SUM(CAMT) END),0)     
  FROM  ACCOUNTBFO.DBO.LEDGER L,  ACCOUNTBFO.DBO.LEDGER2 L2,  ACCOUNTBFO.DBO.COSTMAST C ,  ACCOUNTBFO.DBO.CATEGORY CT    
  WHERE (EDT >=@FROMDT AND EDT <=@TODT + ' 23:59:59')    
  AND L2.CLTCODE=@CLTCODE    
   AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L2.DRCR     
 END    
    
    
--- *** RPT_DETAILPERIODLEDGER *** ---    
IF @REPORTPARA='4' AND @SORTBY='VDT'     
 BEGIN    
  SELECT  LEFT(CONVERT(VARCHAR,VDT,103),11), L.VTYP,VNO,LNO,DRCR,    
  DRAMT=ISNULL((CASE DRCR WHEN 'D' THEN VAMT END),0),     
  CRAMT=ISNULL((CASE DRCR WHEN 'C' THEN VAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL(L.NARRATION,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() ) ,DISPLAYVDT = LEFT(CONVERT(VARCHAR,VDT,109),11) ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTBFO.DBO. LEDGER L, ACCOUNTBFO.DBO.VMAST V , ACCOUNTBFO.DBO. BOOKTYPE BT     
  WHERE  L.VDT >= @FROMDT AND L.VDT<=@TODT + ' 23:59:59'    
  AND CLTCODE = @CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  ORDER BY L.VDT, DRCR,L.VTYP    
 END    
ELSE IF @REPORTPARA='4'    
 BEGIN    
  SELECT LEFT( CONVERT(VARCHAR,EDT,103),11),L.VTYP,VNO,LNO,DRCR,    
  DRAMT=ISNULL((CASE DRCR WHEN 'D' THEN VAMT END),0),     
  CRAMT=ISNULL((CASE DRCR WHEN 'C' THEN VAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL(L.NARRATION,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )  ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTBFO.DBO. LEDGER L, ACCOUNTBFO.DBO.VMAST V , ACCOUNTBFO.DBO. BOOKTYPE BT    
  WHERE EDT >= @FROMDT AND EDT<=@TODT + ' 23:59:59'    
  AND CLTCODE=@CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  ORDER BY EDT, DRCR,L.VTYP    
    
END    
    
    
    
--- *** RPT_DETAILPERIODLEDGERBR *** ---    
IF @REPORTPARA='5' AND @SORTBY='VDT'     
 BEGIN    
  SELECT  LEFT(CONVERT(VARCHAR,VDT,103),11), L.VTYP,L.VNO,L.LNO,L.DRCR,    
  DRAMT=ISNULL((CASE L2.DRCR WHEN 'D' THEN CAMT END),0),     
  CRAMT=ISNULL((CASE L2.DRCR WHEN 'C' THEN CAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL((SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=1) ,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() ) ,DISPLAYVDT = LEFT(CONVERT(VARCHAR,VDT,109),11) ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.VMAST V , ACCOUNTBFO.DBO.BOOKTYPE BT ,ACCOUNTBFO.DBO.LEDGER2 L2, ACCOUNTBFO.DBO.COSTMAST C , ACCOUNTBFO.DBO.CATEGORY CT    
  WHERE  L.VDT >= @FROMDT AND L.VDT<=@TODT + ' 23:59:59'    
  AND L2.CLTCODE = @CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  ORDER BY L.VDT, L2.DRCR,L.VTYP    
 END    
ELSE IF @REPORTPARA='5'   
 BEGIN    
  SELECT LEFT( CONVERT(VARCHAR,EDT,103),11),L.VTYP,L.VNO,L.LNO,L.DRCR,    
  DRAMT=ISNULL((CASE L2.DRCR WHEN 'D' THEN CAMT END),0),     
  CRAMT=ISNULL((CASE L2.DRCR WHEN 'C' THEN CAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL((SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=1) ,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )  ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTBFO.DBO. LEDGER L, ACCOUNTBFO.DBO.VMAST V , ACCOUNTBFO.DBO. BOOKTYPE BT ,ACCOUNTBFO.DBO.LEDGER2 L2, ACCOUNTBFO.DBO.COSTMAST C , ACCOUNTBFO.DBO.CATEGORY CT    
  WHERE EDT >= @FROMDT AND EDT<=@TODT + ' 23:59:59'    
  AND L2.CLTCODE=@CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  ORDER BY EDT, L2.DRCR,L.VTYP    
 END    
    
    
--- *** RPT_OPENBAL *** ---    
IF @REPORTPARA='6' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER     
  WHERE VDT >= @FROMDT  AND VDT <=  @TODT  AND CLTCODE= @CLTCODE     
  GROUP BY DRCR     
 END     
ELSE IF @REPORTPARA='6'   
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER     
  WHERE EDT >= @FROMDT  AND EDT <= @TODT AND CLTCODE= @CLTCODE     
  GROUP BY DRCR     
 END     
    
    
--- *** RPT_OPENBALBR *** ---    
IF @REPORTPARA='7' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.LEDGER2 L2, ACCOUNTBFO.DBO.COSTMAST C , ACCOUNTBFO.DBO.CATEGORY CT     
  WHERE VDT >= @FROMDT  AND VDT <=  @TODT  AND L.CLTCODE= @CLTCODE     
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END     
ELSE IF @REPORTPARA='7'   
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.LEDGER2 L2, ACCOUNTBFO.DBO.COSTMAST C , ACCOUNTBFO.DBO.CATEGORY CT     
  WHERE EDT >= @FROMDT  AND EDT <= @TODT AND L.CLTCODE= @CLTCODE     
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END     
    
    
    
--*** RPT_CLIENTOPENBALBR ***--    
IF @REPORTPARA='8' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.LEDGER2 L2, ACCOUNTBFO.DBO.COSTMAST C , ACCOUNTBFO.DBO.CATEGORY CT      
  WHERE L.VDT < @TODT     
  AND L.CLTCODE=@CLTCODE    
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END     
ELSE IF @REPORTPARA='8'   
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.LEDGER2 L2, ACCOUNTBFO.DBO.COSTMAST C , ACCOUNTBFO.DBO.CATEGORY CT     
  WHERE  L.EDT < @TODT     
  AND L.CLTCODE=@CLTCODE    
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLOSINGRATE
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_CLOSINGRATE] (@SERIESCODE VARCHAR(50), @FROMDATE VARCHAR(10), @TODATE VARCHAR(10))  AS
SELECT
DISTINCT LEFT(CONVERT(VARCHAR,TRADE_DATE,106),11),
PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,CL_RATE,SERIES_ID,
LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) AS EXPDATE,
YEAR(TRADE_DATE), MONTH(TRADE_DATE), DAY(TRADE_DATE)
FROM BFOCLOSING
WHERE 
SERIES_CODE LIKE  @SERIESCODE  + '%'
AND TRADE_DATE >= (CONVERT(DATETIME,@FROMDATE,105))
AND TRADE_DATE <= (CONVERT(DATETIME,@TODATE,105)+1)
ORDER BY  SERIES_CODE,DAY(TRADE_DATE), MONTH(TRADE_DATE), YEAR(TRADE_DATE)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CONPATH
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_CONPATH]  
  
@EXCH VARCHAR(3),  
@SEGMENT VARCHAR(20)  
  
AS  
  
SELECT CONPATH FROM ACCOUNTBFO.DBO.OWNER WHERE EXCHANGE=@EXCH AND SEGMENT LIKE LTRIM(@SEGMENT)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_DAILYMARGINSTATEMENT
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_DAILYMARGINSTATEMENT]
	(    
	@MDATE VARCHAR(11),    
	@FROMPARTY VARCHAR(15),    
	@TOPARTY VARCHAR(15),    
	@FROMBRANCH VARCHAR(15)		= '',
	@TOBRANCH VARCHAR(15)		= 'zzzzzzzz',
	@FROMSUBBROKER VARCHAR(15)	= '',
	@TOSUBBROKER VARCHAR(15)	= 'zzzzzzzz',
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WITHCOLL INT = 0,
	@DCNFLAG INT = 0
	)    
	
	AS    

	--EXEC RPT_DAILYMARGINSTATEMENT 'FEB  2 2009', '','ZZZZZZZZZZ','','ZZZZZZZZZ','','ZZZZZZZZZ','BROKER','BROKER'

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
	
	SELECT DISTINCT PARTY_CODE 
	INTO #MCLIENT
	FROM TBL_CLIENTMARGIN
	WHERE MARGINDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY

	SELECT 
		PARTY_CODE = CL_CODE,
		PARTYNAME = LONG_NAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_ZIP,
		L_STATE,
		L_NATION,
		RES_PHONE = RES_PHONE1 + RES_PHONE2,
		OFF_PHONE = OFF_PHONE1 + OFF_PHONE2,
		EMAIL,
		PAN_GIR_NO,
		BRANCH_CD,
		SUB_BROKER,
		EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK)),
		SEGMENT	 = 'FUTURES'
	INTO
		#CLIENTMASTER
	FROM
		CLIENT1 C1 (NOLOCK)
	WHERE
		CL_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
		AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER
		AND CL_CODE IN (SELECT PARTY_CODE FROM #MCLIENT)
		AND @STATUSNAME = (
		CASE   
			WHEN @STATUSID = 'BRANCH'   
			THEN C1.BRANCH_CD   
			WHEN @STATUSID = 'SUBBROKER'   
			THEN C1.SUB_BROKER   
			WHEN @STATUSID = 'TRADER'   
			THEN C1.TRADER   
			WHEN @STATUSID = 'FAMILY'   
			THEN C1.FAMILY   
			WHEN @STATUSID = 'AREA'   
			THEN C1.AREA   
			WHEN @STATUSID = 'REGION'   
			THEN C1.REGION   
			WHEN @STATUSID = 'CLIENT'   
			THEN CL_CODE   
			ELSE 'BROKER' 
		END)   	

	CREATE TABLE #MARGIN_DETAIL
		(
		PARTY_CODE			VARCHAR(15),
		MARGINDATE			DATETIME,
		LED_MARGIN_AMT		MONEY,
		NONCASH_AMT			MONEY,
		BGFD_AMT			MONEY,
		OTHER_MARGIN		MONEY,
		TOTAL_MARGIN_AVL	MONEY,
		INITIALMARGIN		MONEY,
		EXPOSURE_MARGIN		MONEY,
		TOTAL_MARGIN		MONEY,
		EXCESS_SHORTFALL	MONEY,
		ADD_MARGIN			MONEY,
		MARGIN_STATUS		MONEY,
		)


	INSERT INTO #MARGIN_DETAIL
	SELECT 
		PARTY_CODE		= T.PARTY_CODE,
		MARGINDATE		= LEFT(MARGINDATE,11),
		LED_MARGIN_AMT	= SUM(LEDGERAMOUNT),
		NONCASH_AMT		= SUM(NONCASH_COLL),
		BGFD_AMT		= 0,
		OTHER_MARGIN	= 0,
		TOTAL_MARGIN_AVL= 0,
		INITIALMARGIN	= SUM(INITIALMARGIN),
		EXPOSURE_MARGIN	= SUM(MTMMARGIN),
		TOTAL_MARGIN	= 0,
		EXCESS_SHORTFALL= 0,
		ADD_MARGIN		= SUM(ADDMARGIN),
		MARGIN_STATUS	= 0
	FROM
		TBL_CLIENTMARGIN T (NOLOCK),
		#CLIENTMASTER	 C (NOLOCK)
	WHERE 
		MARGINDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
		AND T.PARTY_CODE = C.PARTY_CODE
	GROUP BY
		T.PARTY_CODE,
		LEFT(MARGINDATE,11)

	
	UPDATE 
		#MARGIN_DETAIL
	SET
		LED_MARGIN_AMT	= (LED_MARGIN_AMT + MARGIN),
		BGFD_AMT		= (FD + BG)
	FROM
		(
		SELECT 
			PARTY_CODE,
			MARGIN	= SUM(
					CASE 
						WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT
						ELSE 0
					END),
			FD		= SUM(
					CASE 
						WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT
						ELSE 0
					END),
			BG		= SUM(
					CASE 
						WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT
						ELSE 0
					END)
		FROM 
			MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK)
		WHERE 
			PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #CLIENTMASTER)
			AND EFFDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
			AND C.EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
			AND C.SEGMENT = 'FUTURES'
		GROUP BY
			PARTY_CODE
		) COLL
	WHERE
		#MARGIN_DETAIL.PARTY_CODE = COLL.PARTY_CODE


	SELECT 
		PARTY_CODE		= M.PARTY_CODE,
		MARGINDATE		= CONVERT(VARCHAR,MARGINDATE,103),
		EXCHANGE,
		SEGMENT			= 'F&O',
		LED_MARGIN_AMT	= SUM(LED_MARGIN_AMT),
		NONCASH_AMT		= SUM(NONCASH_AMT),
		BGFD_AMT		= SUM(BGFD_AMT),
		OTHER_MARGIN	= 0,
		TOTAL_MARGIN_AVL= SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT),
		INITIALMARGIN	= SUM(INITIALMARGIN),
		EXPOSURE_MARGIN	= SUM(EXPOSURE_MARGIN),
		TOTAL_MARGIN	= SUM(INITIALMARGIN + EXPOSURE_MARGIN),
		EXCESS_SHORTFALL= (SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT) - SUM(INITIALMARGIN + EXPOSURE_MARGIN)),
		ADD_MARGIN		= SUM(ADD_MARGIN),
		MARGIN_STATUS	= (SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT) - SUM(INITIALMARGIN + EXPOSURE_MARGIN)) - SUM(ADD_MARGIN),
		PARTYNAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_ZIP,
		L_STATE,
		L_NATION,
		RES_PHONE,
		OFF_PHONE,
		EMAIL,
		PAN_GIR_NO,
		BRANCH_CD,
		SUB_BROKER,
		RPT_ORD	= '1DET',
		SCRIP_CD= CONVERT(VARCHAR(20),''),
		QTY	= CONVERT(NUMERIC(18,4),0),
		SEC_AMOUNT = CONVERT(NUMERIC(18,4),0),
		BGNO = CONVERT(VARCHAR(20),''),
		BG_AMOUNT = CONVERT(NUMERIC(18,4),0),
		BG_EXPIRYDATE = CONVERT(VARCHAR(11),''),
		FDRNO = CONVERT(VARCHAR(20),''),
		FDR_AMOUNT = CONVERT(NUMERIC(18,4),0),
		FDR_EXPIRYDATE = CONVERT(VARCHAR(11),'')
	INTO
		#FINAL_REPORT
	FROM 
		#MARGIN_DETAIL M (NOLOCK),
		#CLIENTMASTER  C (NOLOCK)
	WHERE
		M.PARTY_CODE = C.PARTY_CODE
	GROUP BY
		M.PARTY_CODE,
		CONVERT(VARCHAR,MARGINDATE,103),
		EXCHANGE,
		SEGMENT,
		PARTYNAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_ZIP,
		L_STATE,
		L_NATION,
		RES_PHONE,
		OFF_PHONE,
		EMAIL,
		PAN_GIR_NO,
		BRANCH_CD,
		SUB_BROKER
	HAVING 
		SUM(INITIALMARGIN + EXPOSURE_MARGIN) <> 0
	ORDER BY
		PARTY_CODE


	IF (@WITHCOLL = 1)
	BEGIN
		SELECT 
			PARTY_CODE,
			MARGINDATE,
			SCRIP_CD,
			QTY	= SUM(QTY),
			SEC_AMOUNT = SUM(SEC_AMOUNT),
			BGNO,
			BG_AMOUNT = SUM(BG_AMOUNT),
			BG_EXPIRYDATE,
			FDRNO,
			FDR_AMOUNT = SUM(FDR_AMOUNT),
			FDR_EXPIRYDATE,
			COLL_TYPE = '2' + UPPER(COLL_TYPE)
		INTO
			#COLL_DETAIL
		FROM
			(
			SELECT 
				PARTY_CODE,
				MARGINDATE = CONVERT(VARCHAR,EFFDATE,103),
				SCRIP_CD =(
				CASE 
					WHEN COLL_TYPE = 'SEC' 
					THEN SCRIP_CD ELSE '' 
				END),
				QTY	=(
				CASE 
					WHEN COLL_TYPE = 'SEC' 
					THEN QTY ELSE 0 
				END),
				SEC_AMOUNT =(
				CASE 
					WHEN COLL_TYPE = 'SEC' 
					THEN FINALAMOUNT ELSE 0 
				END),
				BGNO =(
				CASE 
					WHEN COLL_TYPE = 'BG' 
					THEN FD_BG_NO ELSE '' 
				END),
				BG_AMOUNT =(
				CASE 
					WHEN COLL_TYPE = 'BG' 
					THEN FINALAMOUNT ELSE 0 
				END),
				BG_EXPIRYDATE = (
				CASE 
					WHEN COLL_TYPE = 'BG' 
					THEN CONVERT(VARCHAR,MATURITY_DATE,103) ELSE '' 
				END),
				FDRNO =(
				CASE 
					WHEN COLL_TYPE = 'FD' 
					THEN FD_BG_NO ELSE '' 
				END),
				FDR_AMOUNT =(
				CASE 
					WHEN COLL_TYPE = 'FD' 
					THEN FINALAMOUNT ELSE 0 
				END),
				FDR_EXPIRYDATE = (
				CASE 
					WHEN COLL_TYPE = 'FD' 
					THEN CONVERT(VARCHAR,MATURITY_DATE,103) ELSE '' 
				END),
				COLL_TYPE
			FROM 
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK)
			WHERE
				PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #CLIENTMASTER)
				AND EFFDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
				AND C.EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
				AND C.SEGMENT = 'FUTURES'
			) COLL
		GROUP BY
			PARTY_CODE,
			MARGINDATE,
			SCRIP_CD,
			BGNO,
			BG_EXPIRYDATE,
			FDRNO,
			FDR_EXPIRYDATE,
			UPPER(COLL_TYPE)

		INSERT INTO #FINAL_REPORT
		SELECT
			PARTY_CODE		= M.PARTY_CODE,
			MARGINDATE,
			EXCHANGE,
			SEGMENT			= 'F&O',
			LED_MARGIN_AMT	= 0,
			NONCASH_AMT		= 0,
			BGFD_AMT		= 0,
			OTHER_MARGIN	= 0,
			TOTAL_MARGIN_AVL= 0,
			INITIALMARGIN	= 0,
			EXPOSURE_MARGIN	= 0,
			TOTAL_MARGIN	= 0,
			EXCESS_SHORTFALL= 0,
			ADD_MARGIN		= 0,
			MARGIN_STATUS	= 0,
			PARTYNAME,
			L_ADDRESS1,
			L_ADDRESS2,
			L_ADDRESS3,
			L_CITY,
			L_ZIP,
			L_STATE,
			L_NATION,
			RES_PHONE,
			OFF_PHONE,
			EMAIL,
			PAN_GIR_NO,
			BRANCH_CD,
			SUB_BROKER,
			RPT_ORD	= UPPER(COLL_TYPE),
			SCRIP_CD,
			QTY,
			SEC_AMOUNT,
			BGNO,
			BG_AMOUNT,
			BG_EXPIRYDATE,
			FDRNO,
			FDR_AMOUNT,
			FDR_EXPIRYDATE
		FROM
			#COLL_DETAIL   M (NOLOCK),
			#CLIENTMASTER  C (NOLOCK)
		WHERE
			M.PARTY_CODE = C.PARTY_CODE
			AND M.PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #FINAL_REPORT)
	END

	SELECT * FROM #FINAL_REPORT
	ORDER BY PARTY_CODE,RPT_ORD 	

	DROP TABLE #MARGIN_DETAIL
	DROP TABLE #MCLIENT
	DROP TABLE #CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ERRORLOG
-- --------------------------------------------------
CREATE  PROCEDURE  [DBO].[RPT_ERRORLOG]          
@FROMDATE AS VARCHAR(11),
@TODATE AS VARCHAR(11)


AS    
SET @FROMDATE = CONVERT(VARCHAR,@FROMDATE,109)             
SET @TODATE = CONVERT(VARCHAR,@TODATE,109)     
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
  
SELECT   
	CNAME,
	MNAME,
	SNAME,
	ERRSTR,   
	ERRDATE = CONVERT(VARCHAR,ERRDATE,109) 
	    
FROM ERRORLOG(NOLOCK)  

WHERE  
	ERRDATE >= @FROMDATE  
   	AND ERRDATE <= @TODATE + ' 23:59:59'  
ORDER BY ERRDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FINYEARLIST
-- --------------------------------------------------
CREATE PROCEDURE  [DBO].[RPT_FINYEARLIST]  
AS  
SELECT DISTINCT  SMONTH = DATENAME(MONTH, SDTCUR), SYEAR = DATENAME(YEAR, SDTCUR), EMONTH = DATENAME(MONTH, LDTCUR),   
 LYEAR = DATENAME(YEAR, LDTCUR) , SDT = CONVERT(VARCHAR, SDTCUR, 103),   
LDT = CONVERT(VARCHAR, LDTCUR, 103), CURYEAR FROM ACCOUNTBFO.DBO.PARAMETER  
ORDER BY CURYEAR DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FODETAIL_NEW
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[RPT_FODETAIL_NEW]
(
	@CODE VARCHAR(10),    
	@SDATE VARCHAR(12),    
	@CASHFLAG VARCHAR(1),    
	@REPORTPARA VARCHAR(5),
	@CLTYPE VARCHAR (3) =''
)    

AS    

DECLARE @EXCHANGE VARCHAR(3)
SELECT @EXCHANGE = EXCHANGE FROM BFOGLOBALS
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

--*** RPT_FOBANKDETAIL ***--    
IF @REPORTPARA = '1'    
 BEGIN    
  SELECT 
	PARTY_CODE, BANK_CODE,BK_GUARANTEE_NO=FD_BG_NO,
	RECEIVE_DATE =CONVERT(VARCHAR,RECEIVE_DATE,106),
	CONVERT(VARCHAR,MATURITY_DATE,106) AS MATURITYDATE, 
	BK_GUARANTEE_AMT=FINALAMOUNT    
  FROM
	MSAJAG.DBO.COLLATERALDETAILS     
  WHERE
	PARTY_CODE = @CODE    
	AND EXCHANGE = @EXCHANGE
	AND SEGMENT LIKE 'FUTURES'    
	AND COLL_TYPE = 'BG'    
	AND EFFDATE LIKE @SDATE + '%'    
  ORDER BY PARTY_CODE,SCRIP_CD,SERIES    
 END     
    
    
--*** RPT_FOCOLMARGIN ***--    
IF @REPORTPARA = '2'    
 BEGIN    
  SELECT
	PARTY_CODE,
	AMOUNT=SUM(FINALAMOUNT)    
  FROM
	MSAJAG.DBO.COLLATERALDETAILS    
  WHERE
	PARTY_CODE = @CODE    
	AND EXCHANGE = @EXCHANGE      
	AND SEGMENT LIKE 'FUTURES'    
	AND EFFDATE LIKE @SDATE + '%'    
	AND COLL_TYPE = 'MARGIN'    
	AND CASH_NCASH = @CASHFLAG    
  GROUP BY PARTY_CODE    
 END    
    
    
--*** RPT_FOFD ***--    
IF @REPORTPARA = '3'    
 BEGIN    
  SELECT 
	PARTY_CODE,
	FD_NAME=BANK_CODE,
	FDR_NO=FD_BG_NO, 
	FD_AMT=FINALAMOUNT,     
	CONVERT(VARCHAR,MATURITY_DATE,106) AS MATURITYDATE,    
	CONVERT(VARCHAR,RECEIVE_DATE,106) AS RECEIVE_DATE    
  FROM 
	MSAJAG.DBO.COLLATERALDETAILS     
  WHERE 
	EXCHANGE = @EXCHANGE    
	AND SEGMENT LIKE 'FUTURES'    
	AND PARTY_CODE = @CODE    
	AND COLL_TYPE = 'FD'    
	AND EFFDATE LIKE @SDATE + '%'    
 END     
    
    
    
--*** RPT_FOMODBANKGUARANTEE ***--    
IF @REPORTPARA = '4'    
 BEGIN    
  SELECT 
	PARTY_CODE,
	BK_GUARANTEE_AMT=SUM(FINALAMOUNT)    
  FROM
	MSAJAG.DBO.COLLATERALDETAILS     
  WHERE
	PARTY_CODE = @CODE    
	AND EXCHANGE = @EXCHANGE     
	AND SEGMENT LIKE 'FUTURES'     
	AND COLL_TYPE = 'BG'    
	AND EFFDATE LIKE  @SDATE + '%'    
	AND CASH_NCASH = @CASHFLAG    
  GROUP BY PARTY_CODE     
 END    
    
    
    
--*** RPT_FOMODFIXEDDEPOSITS ***--    
IF @REPORTPARA = '5'    
 BEGIN    
  SELECT
	PARTY_CODE,
	FD_AMT=SUM(FINALAMOUNT )    
  FROM
	MSAJAG.DBO.COLLATERALDETAILS     
  WHERE 
	PARTY_CODE =@CODE     
	AND EXCHANGE = @EXCHANGE     
	AND SEGMENT LIKE 'FUTURES'     
	AND COLL_TYPE = 'FD'    
	AND EFFDATE LIKE  @SDATE + '%'    
	AND CASH_NCASH = @CASHFLAG    
  GROUP BY PARTY_CODE    
 END    
    
    
--*** RPT_FOSECURITIES_NEW ***--    
IF @REPORTPARA = '6'    
 BEGIN    
  SELECT 
	PARTY_CODE,
	SCRIP_CD,
	SERIES, 
	QTY, 
	CL_RATE, 
	AMOUNT = FINALAMOUNT    
  FROM
	MSAJAG.DBO.COLLATERALDETAILS     
  WHERE
	PARTY_CODE = @CODE    
	AND EXCHANGE = @EXCHANGE     
	AND SEGMENT LIKE 'FUTURES'    
	AND COLL_TYPE = 'SEC'    
	AND EFFDATE LIKE @SDATE + '%'    
	AND CASH_NCASH = @CASHFLAG    
  ORDER BY PARTY_CODE,SCRIP_CD,SERIES    
 END    
    
    
  
IF @REPORTPARA = '7' AND @CLTYPE = 'EXC'     
 BEGIN    
  SELECT 
	C.PARTY_CODE, 
	COLL_DATE= TRANS_DATE, 
	CASH, 
	NONCASH, 
	CL_TYPE    
  FROM 
	MSAJAG.DBO.COLLATERAL C, CLIENT1 C1, CLIENT2 C2    
  WHERE 
	C.PARTY_CODE LIKE LTRIM(@CODE)+'%'     
	AND C.EXCHANGE = @EXCHANGE    
	AND C.SEGMENT = 'FUTURES'    
	AND C1.CL_TYPE = @CLTYPE    
	AND C1.CL_CODE = C2.CL_CODE    
	AND C.PARTY_CODE = C2.PARTY_CODE    
	AND LEFT(CONVERT(VARCHAR,TRANS_DATE,109),11) = @SDATE    
 END     
ELSE IF @REPORTPARA = '7'   
 BEGIN    
  SELECT 
	C.PARTY_CODE, 
	COLL_DATE= TRANS_DATE , 
	CASH, 
	NONCASH , 
	CL_TYPE    
  FROM 
	MSAJAG.DBO.COLLATERAL C, CLIENT1 C1, CLIENT2 C2    
  WHERE 
	C.PARTY_CODE LIKE LTRIM(@CODE)+'%'     
	AND C.EXCHANGE = @EXCHANGE   
	AND C.SEGMENT = 'FUTURES'    
	AND C1.CL_TYPE LIKE LTRIM(@CLTYPE)+'%'    
	AND C1.CL_TYPE <> 'EXC'    
	AND C1.CL_CODE = C2.CL_CODE    
	AND C.PARTY_CODE = C2.PARTY_CODE    
	AND LEFT(CONVERT(VARCHAR,TRANS_DATE,109),11) = @SDATE  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FORMS_REPORT
-- --------------------------------------------------
CREATE  PROC  [DBO].[RPT_FORMS_REPORT] (@MARGINDATEFROM VARCHAR(11),@MARGINDATETO VARCHAR(11),
@INTMARTYPE VARCHAR(20),@BRANCHCD VARCHAR(10), @SUBBROKER VARCHAR(10),@PARTYFROM VARCHAR(10),@PARTYTO VARCHAR(10),
@STATUSNAME VARCHAR(25),@STATUSID VARCHAR(10), @RISKSHORTAGE VARCHAR(10)
)
AS

DELETE FORMS_TBL WHERE SRNO = @@SPID

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

INSERT INTO FORMS_TBL

SELECT FORISKMANAGEMENT_TBL.*,
	LEFT(CONVERT(VARCHAR,MARGINDATE,109),11) AS MMARGINDATE,
	SPANMARGIN , 0, INITIALMARGIN_MG13, 50, INITIALMARGIN_MG13, @@SPID

FROM 
	FORISKMANAGEMENT_TBL
WHERE
	MARGINDATE BETWEEN @MARGINDATEFROM AND @MARGINDATETO
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
	AND BRANCH_CD LIKE CASE WHEN @BRANCHCD <> 'ALL' THEN @BRANCHCD ELSE '%' END
	AND SUB_BROKER LIKE CASE WHEN @SUBBROKER <> 'ALL' THEN @SUBBROKER ELSE '%' END
	AND @STATUSNAME = 
          (CASE 
                WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                WHEN @STATUSID = 'TRADER' THEN TRADER
                WHEN @STATUSID = 'FAMILY' THEN FAMILY
                WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
          ELSE 
                'BROKER'
          END)
	AND
	
	(
		(@RISKSHORTAGE = 'EXCESS' AND EFFECTIVECOLL + LEDGERAMOUNT - INITIALMARGIN_MG13 > 1 )
	
		OR
	
		(@RISKSHORTAGE = 'SHORT' AND EFFECTIVECOLL + LEDGERAMOUNT - INITIALMARGIN_MG13 <= 1)
	
		OR
	
		(@RISKSHORTAGE = 'BOTH' AND  1= 1)
	
	)

	
IF @INTMARTYPE <> 'MGIMAR'
	BEGIN

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

		UPDATE FORMS_TBL
			SET FINALIMARGIN = FINALIMARGIN *(1+PMARGINRATE/100),
				TOTMARGINFORREPORTING = TOTMARGINFORREPORTING *(1+PMARGINRATE/100),
				FINALSPAMARGIN = FINALSPAMARGIN *(1+PMARGINRATE/100)
		FROM 
			CLIENT3 
		WHERE
			SRNO = @@SPID
			AND CLIENT3.PARTY_CODE = FORMS_TBL.PARTY_CODE
			

	END

UPDATE FORMS_TBL SET FINALTOTAL = FINALIMARGIN - OPTIONSMTOM WHERE SRNO = @@SPID

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

UPDATE FORMS_TBL
		SET TOTMARGINFORREPORTING = -TOTMARGINFORREPORTING - ISNULL(INIT_MARGIN,0) - ISNULL(MTM_MARGIN,0)
FROM  BFOMARGINCOLL 
WHERE
	SRNO = @@SPID 
	AND FORMS_TBL.PARTY_CODE = BFOMARGINCOLL.PARTY_CODE
	AND LEFT(FILE_DATE,11) = LEFT(FORMS_TBL.MMARGINDATE,11) 
	

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
	SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) PAYMENT, 
	CLTCODE 
INTO #PAYMENT
FROM 
	ACCOUNTFO.DBO.LEDGER ,  FORMS_TBL 
WHERE 
	VDT LIKE LEFT(FORMS_TBL.MMARGINDATE,11) + '%'
	AND CLTCODE = PARTY_CODE
	AND VTYP IN (1,2,3,4,24) 
	AND SRNO = @@SPID
	
GROUP BY CLTCODE


SELECT 
	F.LONG_FUTURESEXPOSURE PRV_LONG_FUTURESEXPOSURE,
	F.SHORT_FUTURESEXPOSURE PRV_SHORT_FUTURESEXPOSURE,
	F.LONG_OPTIONSEXPOSURE PRV_LONG_OPTIONSEXPOSURE ,
	F.SHORT_OPTIONSEXPOSURE PRV_SHORT_OPTIONSEXPOSURE,
	F.PARTY_CODE PRV_PARTY_CODE,
	F.MARGINDATE
INTO #PRVFORMS
FROM 
	FORISKMANAGEMENT_TBL F  , FORMS_TBL 
WHERE 
	F.MARGINDATE IN
		(SELECT TOP 1 MARGINDATE 
		FROM FORISKMANAGEMENT_TBL 
		WHERE MARGINDATE < FORMS_TBL.MMARGINDATE
		AND PARTY_CODE = FORMS_TBL.PARTY_CODE ORDER BY 1 DESC) 
	AND SRNO = @@SPID
	AND F.PARTY_CODE = FORMS_TBL.PARTY_CODE





SELECT FORMS_TBL.*,
	ISNULL(#PAYMENT.PAYMENT,0) PAYMENT, 
	ISNULL(PRV_LONG_FUTURESEXPOSURE,0)  PRV_LONG_FUTURESEXPOSURE,
	ISNULL(PRV_SHORT_FUTURESEXPOSURE,0) PRV_SHORT_FUTURESEXPOSURE,
	ISNULL(PRV_LONG_OPTIONSEXPOSURE,0)  PRV_LONG_OPTIONSEXPOSURE,
	ISNULL(PRV_SHORT_OPTIONSEXPOSURE,0) PRV_SHORT_OPTIONSEXPOSURE,
	ISNULL(MTM_MARGIN,0) EXPOSUREMTOM ,-ISNULL(INIT_MARGIN,0)OPTBUYPREM
 FROM 	
	FORMS_TBL 
		LEFT OUTER JOIN  #PAYMENT ON (FORMS_TBL.PARTY_CODE = CLTCODE)
		LEFT OUTER JOIN  #PRVFORMS ON (LEFT(#PRVFORMS.MARGINDATE,11) = LEFT(FORMS_TBL.MMARGINDATE,11)
						AND PRV_PARTY_CODE = FORMS_TBL.PARTY_CODE)
		LEFT OUTER JOIN  
			(
			SELECT FILE_DATE,PARTY_CODE,
			MTM_MARGIN=SUM(MTM_MARGIN),INIT_MARGIN=SUM(INIT_MARGIN)
			FROM BFOMARGINCOLL GROUP BY FILE_DATE,PARTY_CODE
			) F  
						ON ( F.PARTY_CODE = FORMS_TBL.PARTY_CODE
						AND LEFT(F.FILE_DATE,11) = LEFT(FORMS_TBL.MMARGINDATE,11) )
WHERE SRNO = @@SPID
ORDER BY MMARGINDATE,FORMS_TBL.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FORMS_REPORT_COMBINE
-- --------------------------------------------------
CREATE  PROC  [DBO].[RPT_FORMS_REPORT_COMBINE] 
(
	@MARGINDATEFROM VARCHAR(11),@MARGINDATETO VARCHAR(11),
	@INTMARTYPE VARCHAR(20),@BRANCHCD VARCHAR(10), @SUBBROKER VARCHAR(10),
	@PARTYFROM VARCHAR(10),@PARTYTO VARCHAR(10),
	@STATUSNAME VARCHAR(25),@STATUSID VARCHAR(10), @RISKSHORTAGE VARCHAR(10),
	@STREXCHANGE VARCHAR(4), @STRORDER  VARCHAR(10)
)
AS


CREATE TABLE [#FORMS_TBL_COMBINE]
 (
	[PARTY_CODE] [VARCHAR] (15)   ,
	[SHORT_NAME] [VARCHAR] (100)   ,
	[LONG_NAME] [VARCHAR] (100)   ,
	[BRANCH_CD] [VARCHAR] (20)   ,
	[FAMILY] [VARCHAR] (20)   ,
	[SUB_BROKER] [VARCHAR] (20)   ,
	[TRADER] [VARCHAR] (20)   ,
	[CUSTOMEREXEC] [VARCHAR] (100)   ,
	[MARGINDATE] [DATETIME]  ,
	[DAILYMTMAMT] [MONEY]  ,
	[FINALDAYMTMAMT] [MONEY]  ,
	[PREMIUMAMT] [MONEY]  ,
	[EXALLOCAMT] [MONEY]  ,
	[BROKERAGE] [MONEY]  ,
	[SERVICETAX] [MONEY]  ,
	[TURNTAX] [MONEY]  ,
	[SEBITAX] [MONEY]  ,
	[INSURANCECHARGE] [MONEY]  ,
	[STAMPDUTY] [MONEY]  ,
	[OTHERCHARGES] [MONEY]  ,
	[EXPIRYBROKERAGE] [MONEY]  ,
	[EXPIRYSERVICETAX] [MONEY]  ,
	[CFBROKERAGE] [MONEY]  ,
	[CFSERVICETAX] [MONEY]  ,
	[CFCHARGES] [MONEY]  ,
	[CLEARINGCHARGES] [MONEY]  ,
	[BILLAMOUNT] [MONEY]  ,
	[LEDGERAMOUNT] [MONEY]  ,
	[CASH_COLL] [MONEY]  ,
	[NONCASH_COLL] [MONEY]  ,
	[EFFECTIVECOLL] [MONEY]  ,
	[HAIRCUTCASH_COLL] [MONEY]  ,
	[HAIRCUTNONCASH_COLL] [MONEY]  ,
	[TOTALFD] [MONEY]  ,
	[TOTALBG] [MONEY]  ,
	[TOTALSECURITIES] [MONEY]  ,
	[INITIALMARGIN_MG13] [MONEY]  ,
	[MTOMMARGIN_MG13] [MONEY]  ,
	[SPANMARGIN] [MONEY]  ,
	[LONG_FUTURESEXPOSURE] [MONEY]  ,
	[SHORT_FUTURESEXPOSURE] [MONEY]  ,
	[FUTURESEXPOSURE] [MONEY]  ,
	[LONG_OPTIONSEXPOSURE] [MONEY]  ,
	[SHORT_OPTIONSEXPOSURE] [MONEY]  ,
	[OPTIONSEXPOSURE] [MONEY]  ,
	[HEDGEEXPOSURE] [MONEY]  ,
	[OPTIONSMTOM] [MONEY]  ,
	[FUTURESTURNOVER] [MONEY]  ,
	[OPTIONSTURNOVER] [MONEY]  ,
	[EXALLOCTURNOVER] [MONEY]  ,
	[BSECM_EXPOSURE] [MONEY]  ,
	[NSECM_EXPOSURE] [MONEY]  ,
	[DUMMY1] [MONEY]  ,
	[DUMMY2] [VARCHAR] (20)   ,
	[LST_UPDATE_DT] [DATETIME]  ,
	[MMARGINDATE] [VARCHAR] (11)   ,
	[FINALIMARGIN] [MONEY]  ,
	[FINALTOTAL] [MONEY]  ,
	[TOTMARGINFORREPORTING] [MONEY]  ,
	[MARGINPER] [MONEY]  ,
	[FINALSPAMARGIN] [MONEY]  ,
	[SRNO] [INT]  ,
	PAYMENT [MONEY] ,
	PRV_LONG_FUTURESEXPOSURE [MONEY] ,
	PRV_SHORT_FUTURESEXPOSURE [MONEY] ,
	PRV_LONG_OPTIONSEXPOSURE [MONEY] ,
	PRV_SHORT_OPTIONSEXPOSURE [MONEY] ,
	EXPOSUREMTOM [MONEY] ,
	OPTBUYPREM [MONEY] ,
	EXCHANGE VARCHAR(6)
)


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @STREXCHANGE = 'NSE' OR @STREXCHANGE ='BOTH' 
BEGIN
	INSERT INTO #FORMS_TBL_COMBINE 
	(
			PARTY_CODE,SHORT_NAME,LONG_NAME,BRANCH_CD,FAMILY,SUB_BROKER,TRADER,CUSTOMEREXEC,MARGINDATE,
			DAILYMTMAMT,FINALDAYMTMAMT,PREMIUMAMT,EXALLOCAMT,BROKERAGE,SERVICETAX,TURNTAX,SEBITAX,
			INSURANCECHARGE,STAMPDUTY,OTHERCHARGES,EXPIRYBROKERAGE,EXPIRYSERVICETAX,CFBROKERAGE,
			CFSERVICETAX,CFCHARGES,CLEARINGCHARGES,BILLAMOUNT,LEDGERAMOUNT,CASH_COLL,NONCASH_COLL,
			EFFECTIVECOLL,HAIRCUTCASH_COLL,HAIRCUTNONCASH_COLL,TOTALFD,TOTALBG,TOTALSECURITIES,
			INITIALMARGIN_MG13,MTOMMARGIN_MG13,SPANMARGIN,LONG_FUTURESEXPOSURE,SHORT_FUTURESEXPOSURE,
			FUTURESEXPOSURE,LONG_OPTIONSEXPOSURE,SHORT_OPTIONSEXPOSURE,OPTIONSEXPOSURE,HEDGEEXPOSURE,
			OPTIONSMTOM,FUTURESTURNOVER,OPTIONSTURNOVER,EXALLOCTURNOVER,BSECM_EXPOSURE,NSECM_EXPOSURE,
			DUMMY1,DUMMY2,LST_UPDATE_DT,MMARGINDATE,FINALIMARGIN,FINALTOTAL,TOTMARGINFORREPORTING,
			MARGINPER,FINALSPAMARGIN,SRNO,PAYMENT,PRV_LONG_FUTURESEXPOSURE,PRV_SHORT_FUTURESEXPOSURE,
			PRV_LONG_OPTIONSEXPOSURE,PRV_SHORT_OPTIONSEXPOSURE,EXPOSUREMTOM,OPTBUYPREM
	)
	EXEC NSEFO.DBO.RPT_FORMS_REPORT @MARGINDATEFROM,@MARGINDATETO,@INTMARTYPE ,@BRANCHCD , @SUBBROKER ,@PARTYFROM ,@PARTYTO ,@STATUSNAME ,@STATUSID , @RISKSHORTAGE 
	
	UPDATE #FORMS_TBL_COMBINE SET EXCHANGE ='NSE FO' WHERE EXCHANGE IS NULL
END

IF @STREXCHANGE = 'BSE' OR @STREXCHANGE ='BOTH' 
BEGIN
	INSERT INTO #FORMS_TBL_COMBINE 
	(
			PARTY_CODE,SHORT_NAME,LONG_NAME,BRANCH_CD,FAMILY,SUB_BROKER,TRADER,CUSTOMEREXEC,MARGINDATE,
			DAILYMTMAMT,FINALDAYMTMAMT,PREMIUMAMT,EXALLOCAMT,BROKERAGE,SERVICETAX,TURNTAX,SEBITAX,
			INSURANCECHARGE,STAMPDUTY,OTHERCHARGES,EXPIRYBROKERAGE,EXPIRYSERVICETAX,CFBROKERAGE,
			CFSERVICETAX,CFCHARGES,CLEARINGCHARGES,BILLAMOUNT,LEDGERAMOUNT,CASH_COLL,NONCASH_COLL,
			EFFECTIVECOLL,HAIRCUTCASH_COLL,HAIRCUTNONCASH_COLL,TOTALFD,TOTALBG,TOTALSECURITIES,
			INITIALMARGIN_MG13,MTOMMARGIN_MG13,SPANMARGIN,LONG_FUTURESEXPOSURE,SHORT_FUTURESEXPOSURE,
			FUTURESEXPOSURE,LONG_OPTIONSEXPOSURE,SHORT_OPTIONSEXPOSURE,OPTIONSEXPOSURE,HEDGEEXPOSURE,
			OPTIONSMTOM,FUTURESTURNOVER,OPTIONSTURNOVER,EXALLOCTURNOVER,BSECM_EXPOSURE,NSECM_EXPOSURE,
			DUMMY1,DUMMY2,LST_UPDATE_DT,MMARGINDATE,FINALIMARGIN,FINALTOTAL,TOTMARGINFORREPORTING,
			MARGINPER,FINALSPAMARGIN,SRNO,PAYMENT,PRV_LONG_FUTURESEXPOSURE,PRV_SHORT_FUTURESEXPOSURE,
			PRV_LONG_OPTIONSEXPOSURE,PRV_SHORT_OPTIONSEXPOSURE,EXPOSUREMTOM,OPTBUYPREM
	)
	EXEC BSEFO.DBO.RPT_FORMS_REPORT @MARGINDATEFROM,@MARGINDATETO,@INTMARTYPE ,@BRANCHCD , @SUBBROKER ,@PARTYFROM ,@PARTYTO ,@STATUSNAME ,@STATUSID , @RISKSHORTAGE 
	
	UPDATE #FORMS_TBL_COMBINE SET EXCHANGE ='BSE FO' WHERE EXCHANGE IS NULL
END

	IF @STRORDER = 'PARTY' --PARTY - EXCHANGE WISE
	BEGIN
		SELECT * FROM #FORMS_TBL_COMBINE ORDER BY MMARGINDATE,PARTY_CODE, EXCHANGE
	END
ELSE
	BEGIN
		SELECT * FROM #FORMS_TBL_COMBINE ORDER BY MMARGINDATE,EXCHANGE,PARTY_CODE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANMARGIN
-- --------------------------------------------------
CREATE  PROC [DBO].[RPT_FOSPANMARGIN]
	(
		@SAUDA_DATE VARCHAR(11),
		@STATUSID VARCHAR(15),
		@STATUSNAME VARCHAR(25),
		@PARTYFROM VARCHAR(10),
		@PARTYTO VARCHAR(10)
	)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @PARTYTO ='' BEGIN SET @PARTYTO = 'ZZZZZZZZZZ' END

	SELECT
		PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE,
		PARTYNAME = LONG_NAME,
		SYMBOL = FOMARGIN_SPAN.SYMBOL,
		S_SPANMARGIN = SPANMARGIN,
		S_PREMIUM = PREMIUM,
		S_ADDMARGINPERC = PMARGINRATE,
		S_TOTALMARGIN = TOTALMARGIN
	FROM
		FOMARGIN_SPAN,CLIENT1 , CLIENT2
	WHERE
		CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE	
		AND FOMARGIN_SPAN.CL_TYPE ='CL'
		AND MDATE LIKE @SAUDA_DATE +'%'
		AND CLIENT2.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND @STATUSNAME = 
		(CASE 
			WHEN @STATUSID = 'BRANCH' THEN CLIENT1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER' THEN CLIENT1.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN CLIENT1.TRADER
			WHEN @STATUSID = 'FAMILY' THEN CLIENT1.FAMILY
			WHEN @STATUSID = 'AREA' THEN CLIENT1.AREA
			WHEN @STATUSID = 'REGION' THEN CLIENT1.REGION
			WHEN @STATUSID = 'CLIENT' THEN CLIENT2.PARTY_CODE
			ELSE 
		'BROKER'
		END)

ORDER BY 1,3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FTPARTYDETAILS
-- --------------------------------------------------
CREATE    PROCEDURE [DBO].[RPT_FTPARTYDETAILS]       
        
@PARTYCODE AS VARCHAR(20)      
      
          
AS       
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
SELECT CL2.CL_CODE,CL2.PARTY_CODE,CL2.DUMMY1,        
TURNOVER_TAX =  (CASE WHEN CL2.TURNOVER_TAX=0 THEN 'N'        
   WHEN CL2.TURNOVER_TAX=1 THEN 'Y'        
  END),        
SEBI_TURN_TAX =  (CASE WHEN CL2.SEBI_TURN_TAX=0 THEN 'N'        
   WHEN CL2.SEBI_TURN_TAX=1 THEN 'Y'        
  END),        
SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'        
   WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'        
   WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'        
  END),        
INSURANCE_CHRG = (CASE WHEN CL2.INSURANCE_CHRG=0 THEN 'N'        
   WHEN CL2.INSURANCE_CHRG =1 THEN 'Y'        
  END),        
OTHER_CHRG =(CASE WHEN CL2.OTHER_CHRG=0 THEN 'N'        
   WHEN CL2.OTHER_CHRG=1 THEN 'Y'        
  END),        
CL2.TABLE_NO,CL2.SUB_TABLENO,CL2.DEMAT_TABLENO,CL2.P_TO_P      
,CL2.STD_RATE,CL2.DEMAT_TABLENO,CL2.ALBMDELCHRG,CL2.ALBMDELIVERY,CL2.ALBMCF_TABLENO,CL2.MF_TABLENO,CL2.SB_TABLENO,       
CL2.BROK1_TABLENO,CL2.BROK2_TABLENO,      
BROK3_TABLE_NO= (CASE WHEN CL2.BROK3_TABLENO=0 THEN 'TREAT AS BROKERAGE'      
WHEN CL2.BROK3_TABLENO=1 THEN 'TREAT AS CHARGES' ELSE 'NOT SELECTED' END),      
DUMMY1= (CASE WHEN CL2.DUMMY1=0 THEN 'PREMIUM' WHEN CL2.DUMMY1=1 THEN 'STRIKE'      
 WHEN CL2.DUMMY1=2 THEN 'STRIKE + PREMIUM'       
ELSE   'NOT SELECTED' END), CL2.DUMMY2 ,      
      
BROKERNOTE= (CASE WHEN CL2.BROKERNOTE=0 THEN 'N'        
   WHEN CL2.BROKERNOTE=1 THEN 'Y'        
  END),        
BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'        
   WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'        
  /* WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'  */      
   WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'        
   WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'        
   WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'        
   WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'        
  END),        
BROK3_TABLE_NO= (CASE WHEN CL2.BROK3_TABLENO=0 THEN 'TREAT AS BROKERAGE'        
   WHEN CL2.BROK3_TABLENO=1 THEN 'TREAT AS CHARGES'        
  ELSE        
   'NOT SELECTED'        
  END),        
DUMMY1= (CASE WHEN CL2.DUMMY1=0 THEN 'PREMIUM'        
   WHEN CL2.DUMMY1=1 THEN 'STRIKE'        
   WHEN CL2.DUMMY1=2 THEN 'STRIKE + PREMIUM'        
  ELSE        
   'NOT SELECTED'        
  END),        
CL2.DUMMY2,        
CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,       
CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX, RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,        
CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,        
S1.NAME,B1.BRANCH  ,      
CONTTYPE= (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'        
   WHEN CL2.INSCONT='O' THEN 'ORDERWISE'        
   WHEN CL2.INSCONT='N' THEN 'NORMAL'        
  ELSE        
   'NOT AVAILABLE'        
  END),      
PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID      
   ELSE  ''       
                            END) ,       
      
CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO      
   ELSE  ''       
                            END) ,       
      
PRINTF = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT'        
   ELSE        
                'DONT PRINT'        
              END) ,      
      
CONTPRT = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'        
   WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'        
   WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'        
   WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'        
   WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'        
  END) ,      
CONVERT(VARCHAR(11),C5.ACTIVEFROM) AS ACTIVEFROM ,        
INACTIVEFROM = (CASE WHEN CONVERT(VARCHAR(11),C5.INACTIVEFROM) ='JAN  1 1900' THEN 'N.A.'        
   ELSE        
               CONVERT(VARCHAR(11),C5.INACTIVEFROM)      
              END),      
/*CONVERT(VARCHAR(11),C5.INACTIVEFROM)   AS INACTIVEFROM,*/      
C5.INTRODUCER,C5.APPROVER ,      
      
ISNULL(C5.PASSPORTDTL,'') AS PASSPORTDTL, ISNULL(C5.PASSPORTDATEOFISSUE,'') AS PASSPORTDATEOFISSUE,  ISNULL(C5.PASSPORTPLACEOFISSUE,'') AS PASSPORTPLACEOFISSUE,  ISNULL(C5.PASSPORTEXPDATE,'') AS PASSPORTEXPDATE,      
ISNULL(C5.DRIVELICENDTL,'') AS DRIVELICENDTL, ISNULL(C5.LICENCENODATEOFISSUE,'') AS LICENCENODATEOFISSUE, ISNULL(C5.LICENCENOPLACEOFISSUE,'') AS LICENCENOPLACEOFISSUE, ISNULL(C5.DRIVEEXPDATE,'') AS DRIVEEXPDATE,      
ISNULL(C5.RATIONCARDDTL,'') AS RATIONCARDDTL, ISNULL(C5.RATIONCARDDATEOFISSUE,'') AS RATIONCARDDATEOFISSUE, ISNULL(C5.RATIONCARDPLACEOFISSUE,'') AS RATIONCARDPLACEOFISSUE,      
ISNULL(C5.VOTERSIDDTL,'') AS VOTERSIDDTL, ISNULL(C5.VOTERIDDATEOFISSUE,'') AS VOTERIDDATEOFISSUE, ISNULL(C5.VOTERIDPLACEOFISSUE,'') AS VOTERIDPLACEOFISSUE,  
PAYLOCATION=CL1.GL_CODE  
      
FROM CLIENT2 CL2, CLIENT1 CL1 LEFT OUTER JOIN CLIENT5 C5 ON ( C5.CL_CODE = CL1.CL_CODE ) ,      
SUBBROKERS S1,BRANCH B1      
WHERE CL1.CL_CODE = CL2.CL_CODE        
AND S1.SUB_BROKER = CL1.SUB_BROKER        
AND CL2.PARTY_CODE =@PARTYCODE      
AND B1.BRANCH_CODE = CL1.BRANCH_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FTPARTYDETAILSMKT
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_FTPARTYDETAILSMKT]     
@PARTYCODE AS VARCHAR(20)    
        
AS     
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
SELECT CL2.CL_CODE,CL2.PARTY_CODE,CL2.DUMMY1,      
TURNOVER_TAX =  (CASE WHEN CL2.TURNOVER_TAX=0 THEN 'N'      
   WHEN CL2.TURNOVER_TAX=1 THEN 'Y'      
  END),      
SEBI_TURN_TAX =  (CASE WHEN CL2.SEBI_TURN_TAX=0 THEN 'N'      
   WHEN CL2.SEBI_TURN_TAX=1 THEN 'Y'      
  END),      
SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'      
   WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'      
   WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'      
  END),      
INSURANCE_CHRG = (CASE WHEN CL2.INSURANCE_CHRG=0 THEN 'N'      
   WHEN CL2.INSURANCE_CHRG =1 THEN 'Y'      
  END),      
OTHER_CHRG =(CASE WHEN CL2.OTHER_CHRG=0 THEN 'N'      
   WHEN CL2.OTHER_CHRG=1 THEN 'Y'      
  END),      
CL2.TABLE_NO,CL2.SUB_TABLENO,CL2.DEMAT_TABLENO,CL2.P_TO_P    
,CL2.STD_RATE,CL2.DEMAT_TABLENO,CL2.ALBMDELCHRG,CL2.ALBMDELIVERY,CL2.ALBMCF_TABLENO,CL2.MF_TABLENO,CL2.SB_TABLENO,     
CL2.BROK1_TABLENO,CL2.BROK2_TABLENO,    
BROK3_TABLE_NO= (CASE WHEN CL2.BROK3_TABLENO=0 THEN 'TREAT AS BROKERAGE'    
WHEN CL2.BROK3_TABLENO=1 THEN 'TREAT AS CHARGES' ELSE 'NOT SELECTED' END),    
DUMMY1= (CASE WHEN CL2.DUMMY1=0 THEN 'PREMIUM' WHEN CL2.DUMMY1=1 THEN 'STRIKE'    
 WHEN CL2.DUMMY1=2 THEN 'STRIKE + PREMIUM'     
ELSE   'NOT SELECTED' END), CL2.DUMMY2 ,    
    
BROKERNOTE= (CASE WHEN CL2.BROKERNOTE=0 THEN 'N'      
   WHEN CL2.BROKERNOTE=1 THEN 'Y'      
  END),      
BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'      
   WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'      
   WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'    
   WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'      
   WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'      
   WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'      
   WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'      
  END),      
BROK3_TABLE_NO= (CASE WHEN CL2.BROK3_TABLENO=0 THEN 'TREAT AS BROKERAGE'      
   WHEN CL2.BROK3_TABLENO=1 THEN 'TREAT AS CHARGES'      
  ELSE      
   'NOT SELECTED'      
  END),      
DUMMY1= (CASE WHEN CL2.DUMMY1=0 THEN 'PREMIUM'      
   WHEN CL2.DUMMY1=1 THEN 'STRIKE'      
   WHEN CL2.DUMMY1=2 THEN 'STRIKE + PREMIUM'      
  ELSE      
   'NOT SELECTED'      
  END),      
CL2.DUMMY2,      
CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,     
CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX,CL1.RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,      
CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,      
S1.NAME,B1.BRANCH  ,    
CONTTYPE= (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'      
   WHEN CL2.INSCONT='O' THEN 'ORDERWISE'      
   WHEN CL2.INSCONT='N' THEN 'NORMAL'      
  ELSE      
   'NOT AVAILABLE'      
  END),    
PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID    
   ELSE  ''     
                            END) ,     
    
CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO    
   ELSE  ''     
                            END) ,     
    
PRINTF = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT'      
   ELSE      
                'DONT PRINT'      
              END) ,    
    
CONTPRT = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'      
   WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'      
   WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'      
   WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'      
   WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'      
  END) ,    
CONVERT(VARCHAR(11),C5.ACTIVEFROM) AS ACTIVEFROM ,      
INACTIVEFROM = (CASE WHEN CONVERT(VARCHAR(11),C5.INACTIVEFROM) ='JAN  1 1900' THEN 'N.A.'      
   ELSE      
               CONVERT(VARCHAR(11),C5.INACTIVEFROM)    
              END),    
/*CONVERT(VARCHAR(11),C5.INACTIVEFROM)   AS INACTIVEFROM,*/    
C5.INTRODUCER,C5.APPROVER ,     
ISNULL(C5.PASSPORTDTL,'') AS PASSPORTDTL, ISNULL(C5.PASSPORTDATEOFISSUE,'') AS PASSPORTDATEOFISSUE,  ISNULL(C5.PASSPORTPLACEOFISSUE,'') AS PASSPORTPLACEOFISSUE,  ISNULL(C5.PASSPORTEXPDATE,'') AS PASSPORTEXPDATE,    
ISNULL(C5.DRIVELICENDTL,'') AS DRIVELICENDTL, ISNULL(C5.LICENCENODATEOFISSUE,'') AS LICENCENODATEOFISSUE, ISNULL(C5.LICENCENOPLACEOFISSUE,'') AS LICENCENOPLACEOFISSUE, ISNULL(C5.DRIVEEXPDATE,'') AS DRIVEEXPDATE,    
ISNULL(C5.RATIONCARDDTL,'') AS RATIONCARDDTL, ISNULL(C5.RATIONCARDDATEOFISSUE,'') AS RATIONCARDDATEOFISSUE, ISNULL(C5.RATIONCARDPLACEOFISSUE,'') AS RATIONCARDPLACEOFISSUE,    
ISNULL(C5.VOTERSIDDTL,'') AS VOTERSIDDTL, ISNULL(C5.VOTERIDDATEOFISSUE,'') AS VOTERIDDATEOFISSUE, ISNULL(C5.VOTERIDPLACEOFISSUE,'') AS VOTERIDPLACEOFISSUE    
    
FROM CLIENT2 CL2, CLIENT1 CL1 LEFT OUTER JOIN CLIENT5 C5 ON ( C5.CL_CODE = CL1.CL_CODE ) ,    
SUBBROKERS S1,BRANCH B1    
WHERE CL1.CL_CODE = CL2.CL_CODE      
AND S1.SUB_BROKER = CL1.SUB_BROKER      
AND CL2.PARTY_CODE =@PARTYCODE    
AND B1.BRANCH_CODE = CL1.BRANCH_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LEDGERBILLENTRY
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 01/15/2005 5:25:55 PM ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 12/16/2003 2:37:02 PM ******/    
    
    
    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 2/17/01 5:19:50 PM ******/    
    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 04/27/2001 4:32:44 PM ******/    
    
    
/*CHANGED BY MOUSAMI ON 12 DEC 2001     
    NOW SETTNOETC IS TAKEN FROM LEDGER3     
     INSTEAD OF LEDGER1 SO REMOVED BNKNAME COLUMN    
  */    
/*CHANGED BY MOUSAMI  ON 16 OCT  2001     
    ADDED HARDCODING AS L3.NARATNO=0    
    IN ELSE PART OF NARRATION.    
    IF LINE NO OF LEDGER AND LEDGER3 DOES NOT MATCH THEN  TAKE MAIN NARRATION     
    FOR MAIN NARRATION LINE NUMBER IS 0    
*/     
    
/*CHANGED BY MOUSAMI ON  AUG 2 2001     
    ADDED LEDGER3 JOIN SO THAT WE CAN GET NARRATION FROM LEDGER3 WHICH GIVES DETAILS ABOUT TO WHICH EXCHANGE A PARTICULAR BILL BELONGS TO     
*/    
    
/*SELECTS DETAILS OF BILL ENTRY FOR A CLIENT CODE FROM LEDGER */    
/*    
CHANGED BY MOUSAMI ON 01/03/2001    
ADDED HARDCODING FOR ACCOUNT DATABSE */    
     
CREATE PROCEDURE [DBO].[RPT_LEDGERBILLENTRY]    
@VTYP SMALLINT,     
@VNO VARCHAR(12),    
@LNO NUMERIC,    
@DRCR VARCHAR(1),    
@CLTCODE VARCHAR(10)    
AS    
    
    
SELECT   NARR=ISNULL((CASE WHEN (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.NARATNO = L3.NARATNO) IS  NOT NULL    
                 THEN (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.NARATNO = L3.NARATNO)     
                 ELSE (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND  L3.NARATNO = 0 )     
                 END),'')    
FROM ACCOUNTBFO.DBO.LEDGER3 L3    
WHERE L3.VTYP = @VTYP  AND L3.VNO = @VNO    
AND L3.NARATNO = @LNO      
    
/* OLD    
SELECT BNKNAME, L.VTYP,L.VNO,L.LNO,L.DRCR, L.CLTCODE ,    
 NARR=ISNULL((CASE WHEN (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.LNO = L3.NARATNO) IS  NOT NULL    
                 THEN (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.LNO = L3.NARATNO)     
                 ELSE (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND  L3.NARATNO = 0 )     
                 END),'')    
FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.LEDGER1 L1    
WHERE L1.VTYP = @VTYP  AND L1.VNO = @VNO    
AND L1.LNO = @LNO  AND L1.DRCR = @DRCR    
AND L.VTYP='15' AND CLTCODE= @CLTCODE    
AND L.VTYP=L1.VTYP AND L.VNO = L1.VNO    
AND L.LNO = L1.LNO AND L.DRCR = L1.DRCR    
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LISTCLIENT
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_LISTCLIENT] 
(      
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),      
	@PARTYCODE VARCHAR(15),      
	@TOPARTYCODE VARCHAR(15)      
) AS      

	SELECT
		PARTY_CODE
	FROM
		CLIENT1 (NOLOCK),
		CLIENT2 (NOLOCK)
	WHERE
		CLIENT1.CL_CODE = CLIENT2.CL_CODE
	        AND @STATUSNAME = (       
	        CASE       
	                WHEN @STATUSID = 'BRANCH'       
	                THEN BRANCH_CD       
	                WHEN @STATUSID = 'SUBBROKER'       
	                THEN SUB_BROKER       
	                WHEN @STATUSID = 'TRADER'       
	                THEN TRADER       
	                WHEN @STATUSID = 'FAMILY'       
	                THEN FAMILY       
	                WHEN @STATUSID = 'AREA'       
	                THEN AREA       
	                WHEN @STATUSID = 'REGION'       
	                THEN REGION       
	                WHEN @STATUSID = 'CLIENT'       
	  		THEN PARTY_CODE       
	                ELSE 'BROKER' END) 
		AND PARTY_CODE BETWEEN  @PARTYCODE AND @TOPARTYCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LISTCLIENTMKT
-- --------------------------------------------------
CREATE   PROCEDURE [DBO].[RPT_LISTCLIENTMKT] 
--RPT_LISTCLIENT 'BROKER','BROKER','00000','ZZZZZ','','','','' 
	 (        
		@STATUSID VARCHAR(15),          
		@STATUSNAME VARCHAR(25),
		@PARTYCODE VARCHAR(15),          
		@TOPARTYCODE VARCHAR(15),        
		@BRANCH_FRM VARCHAR(15),
		@BRANCH_TO  VARCHAR(15),
		@SUBBROKER_FRM VARCHAR(20),
		@SUBBROKER_TO  VARCHAR(20)
         )        
	  AS 

	    IF @BRANCH_FRM = '' BEGIN SET @BRANCH_FRM = '0'  END  
	    IF @BRANCH_TO = '' BEGIN SET @BRANCH_TO = 'ZZZZZZ' END  
	    IF @SUBBROKER_FRM = '' BEGIN SET @SUBBROKER_FRM = '0'  END  
	    IF @SUBBROKER_TO = '' BEGIN SET @SUBBROKER_TO = 'ZZZZZZ' END         
	    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
	  SELECT         
	 
		  C2.PARTY_CODE        
	  FROM                 
		  CLIENT1 C1 WITH(NOLOCK),           
		  CLIENT2 C2 WITH(NOLOCK)           
	  WHERE         
	         C2.CL_CODE = C1.CL_CODE
		AND BRANCH_CD  >=  @BRANCH_FRM
		AND BRANCH_CD  <=  @BRANCH_TO	           
		AND SUB_BROKER  >= @SUBBROKER_FRM
		AND SUB_BROKER  <= @SUBBROKER_TO
                AND  PARTY_CODE >= @PARTYCODE
		AND  PARTY_CODE <= @TOPARTYCODE

	        AND @STATUSNAME =           
	       (
		CASE           
	             WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD          
	             WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER          
	             WHEN @STATUSID = 'TRADER' THEN C1.TRADER          
	             WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY          
	             WHEN @STATUSID = 'AREA' THEN C1.AREA          
	             WHEN @STATUSID = 'REGION' THEN C1.REGION          
	             WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE          
	         ELSE           
		     'BROKER'          
	        END
	       )          
	   /*AND (CASE @PARTYCODE         
		    WHEN 'PARTYCODE' THEN PARTY_CODE        
		    WHEN '' THEN   PARTY_CODE     
           END
          ) BETWEEN @PARTYCODE AND @TOPARTYCODE */       
         
            ORDER BY         
              1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LISTCLIENTNAME
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[RPT_LISTCLIENTNAME]
@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(25),
@PARTYNAME VARCHAR(50),
@TOPARTYNAME VARCHAR(50)
AS

  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

  SELECT DISTINCT C2.PARTY_CODE, C1.LONG_NAME
  FROM CLIENT1 C1 WITH(NOLOCK), 
       CLIENT2 C2 WITH(NOLOCK) 
  WHERE C2.CL_CODE = C1.CL_CODE 
        AND @STATUSNAME = 
                  (CASE 
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                        WHEN @STATUSID = 'AREA' THEN C1.AREA
                        WHEN @STATUSID = 'REGION' THEN C1.REGION
                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                  ELSE 
                        'BROKER'
                END)
    AND C1.LONG_NAME BETWEEN LTRIM(RTRIM(@PARTYNAME))  AND LTRIM(RTRIM(@TOPARTYNAME))
    ORDER BY C1.LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LOGINACCESS
-- --------------------------------------------------
CREATE  PROCEDURE  [DBO].[RPT_LOGINACCESS]             
@FROMDATE AS VARCHAR(11),
@TODATE AS VARCHAR(11),
@REPORTTYPE VARCHAR(10),
@SEARCHBY VARCHAR(10)


AS    
SET @FROMDATE = CONVERT(VARCHAR,@FROMDATE,109)             
SET @TODATE = CONVERT(VARCHAR,@TODATE,109)     
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
  
IF @REPORTTYPE = 'SUCCESS'
BEGIN	
	SELECT   
		   
		L.USERID,   
		L.USERNAME,
		C.FLDCATEGORYNAME,
		L.STATUSNAME,
		L.STATUSID,
		L.IPADD,
		L.ACTION,
		ADDDT = CONVERT(VARCHAR,L.ADDDT,109) 
	    	
	    
	FROM V2_LOGIN_LOG L(NOLOCK)  
		
		   
	LEFT OUTER JOIN   
	    TBLCATEGORY C(NOLOCK)     
	    ON   
	    (   
	        L.CATEGORY = C.FLDCATEGORYCODE   
	     ) 
	WHERE  
		ADDDT >= @FROMDATE  
	   	AND ADDDT <= @TODATE + ' 23:59:59'  
		AND STATUSNAME = CASE WHEN @SEARCHBY ='ADMIN' THEN 'ADMIN' ELSE STATUSNAME END
	ORDER BY ADDDT  
END
ELSE
BEGIN
	SELECT LOGIN_ID,LOGIN_PWD,IPADD,ERR_TYPE,LOGIN_DT 
	FROM V2_LOGIN_ERR_LOG
	WHERE LOGIN_DT BETWEEN @FROMDATE AND @TODATE + ' 23:59'
	AND LOGIN_TYPE = @SEARCHBY
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LOGINCLIENT
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_LOGINCLIENT]   
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(25)  

AS  

IF @STATUSID='BROKER'  
  BEGIN  
    SELECT DISTINCT  PARTY_CODE  
    FROM CLIENT2  
    ORDER BY PARTY_CODE  
  END  
IF @STATUSID='BRANCH'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1, BRANCHES B  
    WHERE LTRIM(RTRIM(B.SHORT_NAME)) = LTRIM(RTRIM(C1.TRADER)) AND  
   C1.CL_CODE = C2.CL_CODE AND  
   LTRIM(RTRIM(B.BRANCH_CD)) = LTRIM(RTRIM(@STATUSNAME))   
    ORDER BY C2.PARTY_CODE  
  END    
IF @STATUSID='SUBBROKER'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE  
    FROM CLIENT2 C2,CLIENT1 C1,SUBBROKERS SB  
    WHERE C1.CL_CODE = C2.CL_CODE AND  
   LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(@STATUSNAME)) AND  
   LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(C1.SUB_BROKER))    
   ORDER BY C2.PARTY_CODE  
  END   
IF @STATUSID='TRADER'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1  
    WHERE C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.TRADER))  = LTRIM(RTRIM(@STATUSNAME))    
    ORDER BY C2.PARTY_CODE  
  END   
IF @STATUSID='CLIENT'  
  BEGIN  
    SELECT DISTINCT C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1   
    WHERE C1.CL_CODE=C2.CL_CODE AND  
  C2.PARTY_CODE=@STATUSNAME   
 ORDER BY C2.PARTY_CODE  
  END  
IF @STATUSID='FAMILY'  
  BEGIN  
    SELECT DISTINCT C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1  
    WHERE C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.FAMILY))  = LTRIM(RTRIM(@STATUSNAME))  
    ORDER BY C2.PARTY_CODE  
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LOGINCLIENTNAME
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_LOGINCLIENTNAME]  
@STATUSID VARCHAR(15),   
@STATUSNAME VARCHAR(25)  
  
AS  
IF @STATUSID = 'BROKER'  
  BEGIN  
    SELECT DISTINCT C2.PARTY_CODE, C1.LONG_NAME  
    FROM CLIENT1 C1, CLIENT2 C2  
    WHERE C1.CL_CODE = C2.CL_CODE  
    ORDER BY C1.LONG_NAME  
  END  
IF @STATUSID = 'BRANCH'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE, C1.LONG_NAME  
    FROM CLIENT2 C2, CLIENT1 C1, BRANCHES B  
    WHERE LTRIM(RTRIM(B.SHORT_NAME)) = LTRIM(RTRIM(C1.TRADER)) AND  
    C1.CL_CODE = C2.CL_CODE AND  
    LTRIM(RTRIM(B.BRANCH_CD)) = LTRIM(RTRIM(@STATUSNAME))   
    ORDER BY C1.LONG_NAME  
  END    
IF @STATUSID = 'SUBBROKER'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE, C1.LONG_NAME  
    FROM CLIENT2 C2, CLIENT1 C1, SUBBROKERS SB  
    WHERE C1.CL_CODE = C2.CL_CODE AND  
   LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(@STATUSNAME)) AND  
   LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(C1.SUB_BROKER))    
   ORDER BY C1.LONG_NAME  
  END   
IF @STATUSID = 'TRADER'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE, C1.LONG_NAME  
    FROM CLIENT2 C2, CLIENT1 C1  
    WHERE C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.TRADER))  = LTRIM(RTRIM(@STATUSNAME))    
    ORDER BY C1.LONG_NAME  
  END   
IF @STATUSID = 'CLIENT'  
  BEGIN  
    SELECT DISTINCT C2.PARTY_CODE, C1.LONG_NAME  
    FROM CLIENT2 C2, CLIENT1 C1   
    WHERE C1.CL_CODE = C2.CL_CODE AND  
  C2.PARTY_CODE = @STATUSNAME   
 ORDER BY C1.LONG_NAME  
  END  
IF @STATUSID = 'FAMILY'  
  BEGIN  
    SELECT DISTINCT C2.PARTY_CODE, C1.LONG_NAME  
    FROM CLIENT2 C2, CLIENT1 C1  
    WHERE C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.FAMILY))  = LTRIM(RTRIM(@STATUSNAME))  
    ORDER BY C1.LONG_NAME  
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MISSINGCLIENTINVBB
-- --------------------------------------------------
CREATE  PROC [DBO].[RPT_MISSINGCLIENTINVBB]
	(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMDATE VARCHAR(11),
	@FROMPARTY VARCHAR(15),
	@TOPARTY VARCHAR(15),
	@CLIENTTYPE VARCHAR(3),
	@FUTNRM INT,
	@FUTFINAL INT,
	@OPTNRM INT,
	@OPTFINAL INT
	)

	AS

	-- EXEC RPT_MISSINGCLIENTINVBB 'BROKER','BROKER','DEC 28 2007','','ZZZZZZ','A',0,0,0,0

	IF @CLIENTTYPE = 'T'
	   BEGIN

		SET NOCOUNT ON
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT 
			DISTINCT
			C2.PARTY_CODE,
			C1.LONG_NAME
		FROM
			CLIENT1 C1,
			CLIENT2 C2,
			CLIENT5 C5
		WHERE
			C1.CL_CODE = C2.CL_CODE
			AND C1.CL_CODE = C5.CL_CODE
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'
				THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'
				THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'
				THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'
				THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'
				THEN C1.AREA
				WHEN @STATUSID = 'REGION'
				THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'
				THEN C2.PARTY_CODE
				ELSE 'BROKER' END)

			AND C2.PARTY_CODE 
				NOT IN 
				(SELECT SP_PARTY_CODE 
					FROM SCHEME_MAPPING
					WHERE @FROMDATE BETWEEN 
					SP_DATE_FROM AND SP_DATE_TO
					
					)

		
		ORDER BY
			C2.PARTY_CODE
	   END
	ELSE
	   BEGIN

		SET NOCOUNT ON
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT 
			DISTINCT
			C2.PARTY_CODE,
			C1.LONG_NAME
		FROM
			CLIENT1 C1,
			CLIENT2 C2,
			CLIENT5 C5
		WHERE
			C1.CL_CODE = C2.CL_CODE
			AND C1.CL_CODE = C5.CL_CODE
			AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'
				THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'
				THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'
				THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'
				THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'
				THEN C1.AREA
				WHEN @STATUSID = 'REGION'
				THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'
				THEN C2.PARTY_CODE
				ELSE 'BROKER' END)

			AND C2.PARTY_CODE 
				NOT IN 
				(SELECT SP_PARTY_CODE 
					FROM SCHEME_MAPPING
					WHERE @FROMDATE BETWEEN 
					SP_DATE_FROM AND SP_DATE_TO)

			AND C5.ACTIVEFROM >=
				(CASE WHEN @CLIENTTYPE = 'A' 
					THEN @FROMDATE
					ELSE 'JAN  1 1900 23:59:59'
					END)

			AND C5.INACTIVEFROM <=
				(CASE WHEN @CLIENTTYPE = 'I' 
					THEN @FROMDATE
					ELSE 'DEC 31 2049 23:59:59'
					END)

		ORDER BY
			C2.PARTY_CODE
	   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NETBALANCESBS
-- --------------------------------------------------
--SP_HELPTEXT RPT_NETBALANCESBS      
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_NETBALANCESBS    SCRIPT DATE: 01/15/2005 1:42:25 PM ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_NETBALANCESBS    SCRIPT DATE: 12/16/2003 2:31:55 PM ******/    
--RPT_NETBALANCESBS 'APR 1 2005','MAY 31 2005','A0314020000','BROKER','BROKER'  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_NETBALANCESBS    SCRIPT DATE: 06/26/2002 6:15:44 PM ******/    
/* QUERY TO GET NET INCOME AND EXPENSES FOR THE GIVEN PERIOD */    
/* WRITTEN ON 13-06-2002 BY VNS */    
/* FLAG CAN HAVE VALUES 'A' - FOR INCOME */    
/*                      'L' - FOR EXPENSES */    
--RPT_NETBALANCESBS_2 'APR  1 2005','MAY 31 2005','A0307000000','BROKER','BROKER'    
CREATE PROC [DBO].[RPT_NETBALANCESBS]  
@FROMDT VARCHAR(11),    
@TODT VARCHAR(11),    
@GRPCODE VARCHAR(11),    
@STATUSID VARCHAR(15),    
@STATUSNAME VARCHAR(25)    
  
AS    
--PRINT LEN(RTRIM(@GRPCODE))  
IF LEN(@GRPCODE) < 11  
 BEGIN  
  SELECT TYPE='G', GRP=SUBSTRING(A.GRPCODE,1,LEN(RTRIM(@GRPCODE))), GRPNAME=GRPNAME, BAL= ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)    
  FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.ACMAST A, ACCOUNTBFO.DBO.GRPMAST G    
  WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,LEN(RTRIM(@GRPCODE))) = RTRIM(@GRPCODE)     
  AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'    
  AND G.GRPCODE = SUBSTRING(A.GRPCODE, 1, LEN(RTRIM(@GRPCODE)))        --+ )   RTRIM(@GRPCODE) + RIGHT('0000000000', 11-(LEN(RTRIM(@GRPCODE))+2))  
  GROUP BY SUBSTRING(A.GRPCODE,1,LEN(RTRIM(@GRPCODE))), GRPNAME    
  HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0    
      
  UNION ALL    
      
  SELECT TYPE = 'D', GRP=L.CLTCODE, GRPNAME=L.ACNAME, BAL= ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)    
  FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.ACMAST A    
  WHERE VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'    
  AND L.CLTCODE = A.CLTCODE AND A.GRPCODE = @GRPCODE  +RTRIM(RIGHT('0000000000',11-LEN(RTRIM(@GRPCODE))))     
  GROUP BY L.CLTCODE, L.ACNAME    
  HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0    
      
  ORDER BY TYPE,GRP, GRPNAME  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NETBS01
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_NETBS01    SCRIPT DATE: 01/15/2005 1:42:24 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_NETBS01    SCRIPT DATE: 12/16/2003 2:31:55 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_NETBS01    SCRIPT DATE: 06/26/2002 6:15:44 PM ******/  
/* QUERY TO GET NET INCOME AND EXPENSES FOR THE GIVEN PERIOD */  
/* WRITTEN ON 22-06-2002 BY VNS */  
/* FLAG CAN HAVE VALUES 'A' - FOR ASSETS */  
/*                      'L' - FOR LIABILITIES */  
  
CREATE  PROC [DBO].[RPT_NETBS01]  
@FROMDT VARCHAR(11),  
@TODT VARCHAR(11),  
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(25)  
  
AS  
  
SELECT TYPE='G', GRP=SUBSTRING(A.GRPCODE,1,3), GRPNAME=GRPNAME, BAL=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)  
FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.ACMAST A, ACCOUNTBFO.DBO.GRPMAST G  
WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN ('A','L')  
AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'  
AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,3)+ '00000000' AND A.CLTCODE <> '99999'  
GROUP BY SUBSTRING(A.GRPCODE,1,3), GRPNAME  
HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0  
  
UNION ALL  
  
SELECT TYPE = 'D', GRP=L.CLTCODE, GRPNAME=L.ACNAME, BAL=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)  
FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.ACMAST A  
WHERE VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'  
AND L.CLTCODE = A.CLTCODE AND A.GRPCODE IN ('A0000000000', 'L0000000000')   
GROUP BY L.CLTCODE, L.ACNAME  
HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0  
ORDER BY GRP, GRPNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_OPENINGBAL_NEW
-- --------------------------------------------------
CREATE  PROCEDURE  [DBO].[RPT_OPENINGBAL_NEW]  
@VDT VARCHAR(12),  
@PARTYCODE VARCHAR(10),  
@CLTYPE VARCHAR(3),  
@REPORTPARA VARCHAR(5)  
  
AS  
  
  
--*** RPT_OPENINGBAL ***--  
IF @REPORTPARA = '1'  
 BEGIN  
  SELECT VDT , VTYP,VNO,LNO,DRCR,  
  VAMT, BALAMT,VDESC,  
  NAR=ISNULL((CASE WHEN (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.LNO = L3.NARATNO) IS  NOT NULL  
                 THEN (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.LNO = L3.NARATNO)   
                 ELSE (SELECT L3.NARR FROM ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=0 )   
                 END),''),  
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )   
  FROM ACCOUNTBFO.DBO. LEDGER L, ACCOUNTBFO.DBO.VMAST V  
  WHERE  VDT  LIKE  LTRIM(@VDT) + '%'  AND   VTYP='18'  
  AND CLTCODE = @PARTYCODE AND L.VTYP=V.VTYPE   
  ORDER BY VDT, DRCR,VTYP  
 END   
  
  
  
--*** RPT_OPENINGBALBR ***--  
IF @REPORTPARA = '2'  
 BEGIN  
  SELECT VDT , L.VTYP,L.VNO,L.LNO,L2.DRCR,  
  VAMT=CAMT, BALAMT,VDESC,  
  NAR=ISNULL((CASE WHEN (SELECT L3.NARR FROM  ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.LNO = L3.NARATNO) IS  NOT NULL  
                 THEN (SELECT L3.NARR FROM  ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.LNO = L3.NARATNO)   
                 ELSE (SELECT L3.NARR FROM  ACCOUNTBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=0 )   
                 END),''),  
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )   
  FROM  ACCOUNTBFO.DBO.LEDGER L,  ACCOUNTBFO.DBO.VMAST V,   ACCOUNTBFO.DBO.LEDGER2 L2,  ACCOUNTBFO.DBO.COSTMAST C ,  ACCOUNTBFO.DBO.CATEGORY CT  
  WHERE  VDT  LIKE  LTRIM(@VDT) + '%'  AND   VTYP='18'  
  AND L.CLTCODE = @PARTYCODE AND L.VTYP=V.VTYPE   
  AND L.VTYP=V.VTYPE AND  
  L2.VTYPE=L.VTYP AND  
  L2.VNO=L.VNO AND  
  L2.LNO=L.LNO AND  
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'  
  AND C.COSTCODE=L2.COSTCODE   
  ORDER BY VDT, L2.DRCR,L.VTYP  
 END  
  
  
  
--*** RPT_FOMODCOLLATERAL2 ***--  
IF @REPORTPARA = '3' AND @CLTYPE = 'EXC'   
 BEGIN  
  SELECT C.PARTY_CODE, COLL_DATE= TRANS_DATE, CASH, NONCASH , CL_TYPE  
  FROM MSAJAG.DBO.COLLATERAL C, CLIENT1 C1, CLIENT2 C2  
  WHERE C.PARTY_CODE LIKE LTRIM(@PARTYCODE)+'%'   
  AND C.EXCHANGE = 'BSE'  
  AND C.SEGMENT = 'FUTURES'  
  AND C1.CL_TYPE = @CLTYPE  
  AND C1.CL_CODE = C2.CL_CODE  
  AND C.PARTY_CODE = C2.PARTY_CODE  
  AND LEFT(CONVERT(VARCHAR,TRANS_DATE,109),11) = @VDT  
 END   
ELSE IF @REPORTPARA = '3' 
 BEGIN  
  SELECT C.PARTY_CODE, COLL_DATE= TRANS_DATE , CASH, NONCASH , CL_TYPE  
  FROM MSAJAG.DBO.COLLATERAL C, CLIENT1 C1, CLIENT2 C2  
  WHERE C.PARTY_CODE LIKE LTRIM(@PARTYCODE)+'%'   
  AND C.EXCHANGE = 'BSE'  
  AND C.SEGMENT = 'FUTURES'  
  AND C1.CL_TYPE LIKE LTRIM(@CLTYPE)+'%'  
  AND C1.CL_TYPE <> 'EXC'  
  AND C1.CL_CODE = C2.CL_CODE  
  AND C.PARTY_CODE = C2.PARTY_CODE  
  AND LEFT(CONVERT(VARCHAR,TRANS_DATE,109),11) = @VDT  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYDETDAILYNEW
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[RPT_PARTYDETDAILYNEW]
(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@SAUDA VARCHAR(11),
	@BRANCHCD VARCHAR(10) ='%'
)
AS

IF @BRANCHCD ='' BEGIN SET @BRANCHCD ='%' END
IF @TPARTY ='' BEGIN SET @TPARTY ='ZZZZZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
	C2.PARTY_CODE,
	C2.CL_CODE,
	C2.EXCHANGE,
	C2.TRAN_CAT,
	C1.EMAIL,
	C1.RES_PHONE1,
	C1.SHORT_NAME,
	C1.L_ADDRESS1,
	C1.L_ADDRESS2,
	C1.L_ADDRESS3,
	C1.L_CITY,
	C1.L_ZIP,
	C1.FAMILY,
	C1.LONG_NAME,
	TRADER = ISNULL(C1.TRADER,'')
FROM
	CLIENT1 C1 (NOLOCK),
	CLIENT2 C2 (NOLOCK),
	(
		SELECT
			DISTINCT FOPDD_PARTY_CODE FROM FO_POS_DETAILS_DAS (NOLOCK)
		WHERE 
			FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'
			AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		
		UNION 
		
		SELECT
			DISTINCT FOTDD_PARTY_CODE FROM FO_TRADE_DETAILS_DAS  (NOLOCK)
		WHERE 
			FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'
			AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		UNION 
		
		SELECT
			DISTINCT LEDDD_PARTY_CODE FROM LEDGER_DETAILS_DAS  (NOLOCK)
		WHERE 
			LEDDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'
			AND LEDDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
	) F 
WHERE
	F.FOPDD_PARTY_CODE = C2.PARTY_CODE     
	AND C1.CL_CODE = C2.CL_CODE
	AND C1.BRANCH_CD LIKE @BRANCHCD
	AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
        AND @STATUSNAME = 
	( 
        CASE 
                WHEN @STATUSID = 'BRANCH' 
                THEN C1.BRANCH_CD 
                WHEN @STATUSID = 'SUBBROKER' 
                THEN C1.SUB_BROKER 
                WHEN @STATUSID = 'TRADER' 
                THEN C1.TRADER 
                WHEN @STATUSID = 'FAMILY' 
                THEN C1.FAMILY 
                WHEN @STATUSID = 'AREA' 
                THEN C1.AREA 
                WHEN @STATUSID = 'REGION' 
                THEN C1.REGION 
                WHEN @STATUSID = 'CLIENT' 
                THEN C2.PARTY_CODE 
                ELSE 'BROKER' END
	) 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYMAPPING
-- --------------------------------------------------
CREATE     PROCEDURE [DBO].[RPT_PARTYMAPPING]
	@DATE VARCHAR(11),
	@ORDERTYPE VARCHAR(10),
	@RPTTYPE VARCHAR(10)

	AS
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF (@RPTTYPE = 'SUMMARY')
BEGIN
	SELECT
		RPTORDER = (CASE WHEN @ORDERTYPE = 'PARTY' 
				THEN PARTY_CODE
				ELSE CONTRACTNO
				END),	
		PARTY_CODE,
		CONTRACTNO,
		USER_ID,
		BRANCH_ID,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		SERIES_CODE,
		SERIES_ID,
		SELL_BUY,
		TRADEQTY = SUM(TRADEQTY),
		AVGRATE = SUM(MARKETRATE * TRADEQTY)/SUM(TRADEQTY),
		EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) 
	
	FROM
		BFOSETTLEMENT S (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE 
		S.PARTY_CODE = C1.CL_CODE
		AND SAUDA_DATE LIKE @DATE +'%'
		AND TRADEQTY > 0
	
	GROUP BY
		PARTY_CODE,
		USER_ID,
		BRANCH_ID,
		CONTRACTNO,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		SERIES_CODE,
		SERIES_ID,
		SELL_BUY,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) 

	ORDER BY 
		CONTRACTNO, 
		PARTY_CODE,
		RPTORDER
	
END
ELSE
BEGIN
	SELECT
		RPTORDER = (CASE WHEN @ORDERTYPE = 'PARTY' 
				THEN PARTY_CODE
				ELSE CONTRACTNO
				END),	
		PARTY_CODE,
		CONTRACTNO,
		USER_ID,
		BRANCH_ID,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		SERIES_CODE,
		SERIES_ID,
		SELL_BUY,
		TRADEQTY = TRADEQTY,
		AVGRATE = MARKETRATE,
		EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) 
	
	FROM
		BFOSETTLEMENT  S (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE 
		S.PARTY_CODE = C1.CL_CODE
		AND SAUDA_DATE LIKE @DATE +'%'
		AND TRADEQTY > 0
	
	ORDER BY 
		CONTRACTNO, 
		PARTY_CODE,
		RPTORDER

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PODPBANK_DETAILS
-- --------------------------------------------------
CREATE  PROC [DBO].[RPT_PODPBANK_DETAILS]
	(
	@BANKTYPE VARCHAR(5)
	)

	AS

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF (@BANKTYPE = 'PO')
	BEGIN
		SELECT 
			DISTINCT 
			BANKID, 
			BANK_NAME, 
			BRANCH_NAME 
		FROM 
			POBANK (NOLOCK)
	END
	ELSE
	BEGIN
		SELECT 
			DISTINCT 
			BANKID, 
			BANKNAME, 
			BANKTYPE 
		FROM 
			BANK (NOLOCK)
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_ADDCLIENT_LOG
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_ADDCLIENT_LOG    SCRIPT DATE: 01/15/2005 1:44:06 PM ******/  
  
CREATE  PROCEDURE [DBO].[RPT_PROC_ADDCLIENT_LOG]  
  
 @PARTYCODE VARCHAR(10),  
 @VIEWTYPE VARCHAR(20),  
 @DATEFROM DATETIME,  
 @DATETO DATETIME  
  
AS  
  
 PRINT @DATEFROM  
 PRINT @DATETO  
  
 DECLARE @RECCOUNT INT  
  
-- SET @VIEWTYPE = 'MOST_RECENT_CHANGE'  
-- SET @PARTYCODE = 'TEST10'  
-- SET @PARTYCODE = 'TEST18'  
  
 IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'MOST_RECENT_CHANGE'  
  BEGIN  /*IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'MOST_RECENT_CHANGE'*/  
   SELECT @RECCOUNT = COUNT(PARTY_CODE) FROM CLIENT2_LOG WHERE PARTY_CODE = @PARTYCODE  
   PRINT @RECCOUNT  
   
   IF @RECCOUNT > 1  
    BEGIN  /*IF @RECCOUNT > 1*/  
     SELECT  
      TOP 2  
       TRAN_CAT AS TRANSACTION_CATEGORY,   
       SCRIP_CAT AS AUCTION,   
       PARTY_CODE AS PARTY_CODE,   
       TABLE_NO AS TRADING_TABLE_NO,   
       SUB_TABLENO AS DEL_TABLE_NO,   
       MARGIN AS MARGIN,   
       TURNOVER_TAX AS TRANSACTION_CHARGES_FLAG,   
       SEBI_TURN_TAX AS SEBI_FEES_FLAG,   
       INSURANCE_CHRG AS INSURANCE_CHARGES_FLAG,   
       SERVICE_CHRG AS SERVICE_TAX_FLAG,   
       STD_RATE AS FUTUREBROKERAGE,   
       /*P_TO_P AS 0 ,*/  
       /*EXPOSURE_LIM AS 0 ,*/  
       DEMAT_TABLENO AS DEMAT_TABLE_NO,   
       BANKID AS PARTICIPANT_CODE,   
       CLTDPNO AS CUSTODIAN_CODE,   
       PRINTF AS PRINT_OPTION,   
       /*ALBMDELCHRG AS 0 ,*/  
       ALBMDELIVERY AS OPTION_CARRY_FORWARD,   
       /*ALBMCF_TABLENO AS 0 ,*/  
       MF_TABLENO AS FUTURE_CARRY_FORWARD,   
       /*SB_TABLENO AS 0 ,*/  
       BROK1_TABLENO AS FUTURE_FINAL_DAY_BROKERAGE,   
       BROK2_TABLENO AS OPTION_BROKERAGE,   
       BROK3_TABLENO AS CARRY_FORWARD_FLAG,   
       BROKERNOTE AS STAMP_DUTY_FLAG,   
       OTHER_CHRG AS OTHER_CHARGES_FLAG,   
       BROK_SCHEME AS BROK_SCHEME,   
       CONTCHARGE AS CONT_CHARGE_FLAG,   
       MINCONTAMT AS MIN_CONT_AMT,   
       /*ADDLEDGERBAL AS 0 ,*/  
       DUMMY1 AS BROKERAGE_APPLICABLE,   
       DUMMY2 AS OPTION_EXCERCISE,   
       INSCONT AS INST_CONTRACT,   
       SERTAXMETHOD AS SERVICE_TAX_METHOD,   
       DUMMY6 AS CLEARING,   
       DUMMY7 AS REPORTING_STYLE,   
       DUMMY8 AS SBU,   
       DUMMY9 AS RELMGR,   
       DUMMY10 AS GROUP_CODE,   
       CONVERT(VARCHAR, ACTIVEFROM, 109) AS ACTIVE_FROM,   
       CONVERT(VARCHAR, INACTIVEFROM, 109) AS INACTIVE_FROM,   
       DEBITBALFLAG AS DEBITBAL_FLAG,   
       INTERSETTFLAG AS INTERSETT_FLAG,   
       LOGFLD_STATUSNAME AS LOGFLD_STATUSNAME,  
       LOGFLD_USERNAME AS LOGFLD_USERNAME,   
       LOGFLD_WHEN_109,   
       LOGFLD_ACTION  
     FROM  
      CLIENT2_LOG  
     WHERE  
      PARTY_CODE = @PARTYCODE  
     ORDER BY  
      LOGFLD_WHEN_109 DESC  
    END /*IF @RECCOUNT > 1*/  
   
   ELSE /*IF @RECCOUNT > 1*/  
   
    BEGIN  /*ELSE OF  IF @RECCOUNT > 1*/  
     SELECT  
      TOP 1  
       TRAN_CAT AS TRANSACTION_CATEGORY,   
       SCRIP_CAT AS AUCTION,   
       PARTY_CODE AS PARTY_CODE,   
       TABLE_NO AS TRADING_TABLE_NO,   
       SUB_TABLENO AS DEL_TABLE_NO,   
       MARGIN AS MARGIN,   
       TURNOVER_TAX AS TRANSACTION_CHARGES_FLAG,   
       SEBI_TURN_TAX AS SEBI_FEES_FLAG,   
       INSURANCE_CHRG AS INSURANCE_CHARGES_FLAG,   
       SERVICE_CHRG AS SERVICE_TAX_FLAG,   
       STD_RATE AS FUTUREBROKERAGE,   
       /*P_TO_P AS 0 ,*/  
       /*EXPOSURE_LIM AS 0 ,*/  
       DEMAT_TABLENO AS DEMAT_TABLE_NO,   
       BANKID AS PARTICIPANT_CODE,   
       CLTDPNO AS CUSTODIAN_CODE,   
       PRINTF AS PRINT_OPTION,   
       /*ALBMDELCHRG AS 0 ,*/  
       ALBMDELIVERY AS OPTION_CARRY_FORWARD,   
       /*ALBMCF_TABLENO AS 0 ,*/  
       MF_TABLENO AS FUTURE_CARRY_FORWARD,   
       /*SB_TABLENO AS 0 ,*/  
       BROK1_TABLENO AS FUTURE_FINAL_DAY_BROKERAGE,   
       BROK2_TABLENO AS OPTION_BROKERAGE,   
       BROK3_TABLENO AS CARRY_FORWARD_FLAG,   
       BROKERNOTE AS STAMP_DUTY_FLAG,   
       OTHER_CHRG AS OTHER_CHARGES_FLAG,   
       BROK_SCHEME AS BROK_SCHEME,   
       CONTCHARGE AS CONT_CHARGE_FLAG,   
       MINCONTAMT AS MIN_CONT_AMT,   
       /*ADDLEDGERBAL AS 0 ,*/  
       DUMMY1 AS BROKERAGE_APPLICABLE,   
       DUMMY2 AS OPTION_EXCERCISE,   
       INSCONT AS INST_CONTRACT,   
       SERTAXMETHOD AS SERVICE_TAX_METHOD,   
       DUMMY6 AS CLEARING,   
       DUMMY7 AS REPORTING_STYLE,   
       DUMMY8 AS SBU,   
       DUMMY9 AS RELMGR,   
       DUMMY10 AS GROUP_CODE,   
       CONVERT(VARCHAR, ACTIVEFROM, 109) AS ACTIVE_FROM,   
       CONVERT(VARCHAR, INACTIVEFROM, 109) AS INACTIVE_FROM,   
       DEBITBALFLAG AS DEBITBAL_FLAG,   
       INTERSETTFLAG AS INTERSETT_FLAG,   
       LOGFLD_STATUSNAME AS LOGFLD_STATUSNAME,  
       LOGFLD_USERNAME AS LOGFLD_USERNAME,   
       LOGFLD_WHEN_109,   
       LOGFLD_ACTION   
     FROM  
      CLIENT2_LOG  
     WHERE  
      PARTY_CODE = @PARTYCODE  
     ORDER BY  
      LOGFLD_WHEN_109 DESC  
    END  /*ELSE OF  IF @RECCOUNT > 1*/  
  END  /*IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'MOST_RECENT_CHANGE'*/  
  
 IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'FOR_A_DATE'  
  BEGIN  /*IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'FOR_A_DATE'*/  
   SELECT  
    TRAN_CAT AS TRANSACTION_CATEGORY,   
    SCRIP_CAT AS AUCTION,   
    PARTY_CODE AS PARTY_CODE,   
    TABLE_NO AS TRADING_TABLE_NO,   
    SUB_TABLENO AS DEL_TABLE_NO,   
    MARGIN AS MARGIN,   
    TURNOVER_TAX AS TRANSACTION_CHARGES_FLAG,   
    SEBI_TURN_TAX AS SEBI_FEES_FLAG,   
    INSURANCE_CHRG AS INSURANCE_CHARGES_FLAG,   
    SERVICE_CHRG AS SERVICE_TAX_FLAG,   
    STD_RATE AS FUTUREBROKERAGE,   
    /*P_TO_P AS 0 ,*/  
    /*EXPOSURE_LIM AS 0 ,*/  
    DEMAT_TABLENO AS DEMAT_TABLE_NO,   
    BANKID AS PARTICIPANT_CODE,   
    CLTDPNO AS CUSTODIAN_CODE,   
    PRINTF AS PRINT_OPTION,   
    /*ALBMDELCHRG AS 0 ,*/  
    ALBMDELIVERY AS OPTION_CARRY_FORWARD,   
    /*ALBMCF_TABLENO AS 0 ,*/  
    MF_TABLENO AS FUTURE_CARRY_FORWARD,   
    /*SB_TABLENO AS 0 ,*/  
    BROK1_TABLENO AS FUTURE_FINAL_DAY_BROKERAGE,   
    BROK2_TABLENO AS OPTION_BROKERAGE,   
    BROK3_TABLENO AS CARRY_FORWARD_FLAG,   
    BROKERNOTE AS STAMP_DUTY_FLAG,   
    OTHER_CHRG AS OTHER_CHARGES_FLAG,   
    BROK_SCHEME AS BROK_SCHEME,   
    CONTCHARGE AS CONT_CHARGE_FLAG,   
    MINCONTAMT AS MIN_CONT_AMT,   
    /*ADDLEDGERBAL AS 0 ,*/  
    DUMMY1 AS BROKERAGE_APPLICABLE,   
    DUMMY2 AS OPTION_EXCERCISE,   
    INSCONT AS INST_CONTRACT,   
    SERTAXMETHOD AS SERVICE_TAX_METHOD,   
    DUMMY6 AS CLEARING,   
    DUMMY7 AS REPORTING_STYLE,   
    DUMMY8 AS SBU,   
    DUMMY9 AS RELMGR,   
    DUMMY10 AS GROUP_CODE,   
    CONVERT(VARCHAR, ACTIVEFROM, 109) AS ACTIVE_FROM,   
    CONVERT(VARCHAR, INACTIVEFROM, 109) AS INACTIVE_FROM,   
    DEBITBALFLAG AS DEBITBAL_FLAG,   
    INTERSETTFLAG AS INTERSETT_FLAG,   
    LOGFLD_STATUSNAME AS LOGFLD_STATUSNAME,  
    LOGFLD_USERNAME AS LOGFLD_USERNAME,   
    LOGFLD_WHEN_109,   
    LOGFLD_ACTION   
   FROM  
    CLIENT2_LOG  
   WHERE  
    PARTY_CODE = @PARTYCODE  AND  
    LOGFLD_WHEN_109 LIKE LEFT(CONVERT(VARCHAR, @DATEFROM, 109), 11) + '%'  
   ORDER BY  
    LOGFLD_WHEN_109 DESC  
  END  /*IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'FOR_A_DATE'*/  
  
 IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'FOR_A_PERIOD'  
  BEGIN  /*IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'FOR_A_PERIOD'*/  
   SELECT  
    TRAN_CAT AS TRANSACTION_CATEGORY,   
    SCRIP_CAT AS AUCTION,   
    PARTY_CODE AS PARTY_CODE,   
    TABLE_NO AS TRADING_TABLE_NO,   
    SUB_TABLENO AS DEL_TABLE_NO,   
    MARGIN AS MARGIN,   
    TURNOVER_TAX AS TRANSACTION_CHARGES_FLAG,   
    SEBI_TURN_TAX AS SEBI_FEES_FLAG,   
    INSURANCE_CHRG AS INSURANCE_CHARGES_FLAG,   
    SERVICE_CHRG AS SERVICE_TAX_FLAG,   
    STD_RATE AS FUTUREBROKERAGE,   
    /*P_TO_P AS 0 ,*/  
    /*EXPOSURE_LIM AS 0 ,*/  
    DEMAT_TABLENO AS DEMAT_TABLE_NO,   
    BANKID AS PARTICIPANT_CODE,   
    CLTDPNO AS CUSTODIAN_CODE,   
    PRINTF AS PRINT_OPTION,   
    /*ALBMDELCHRG AS 0 ,*/  
    ALBMDELIVERY AS OPTION_CARRY_FORWARD,   
    /*ALBMCF_TABLENO AS 0 ,*/  
    MF_TABLENO AS FUTURE_CARRY_FORWARD,   
    /*SB_TABLENO AS 0 ,*/  
    BROK1_TABLENO AS FUTURE_FINAL_DAY_BROKERAGE,   
    BROK2_TABLENO AS OPTION_BROKERAGE,   
    BROK3_TABLENO AS CARRY_FORWARD_FLAG,   
    BROKERNOTE AS STAMP_DUTY_FLAG,   
    OTHER_CHRG AS OTHER_CHARGES_FLAG,   
    BROK_SCHEME AS BROK_SCHEME,   
    CONTCHARGE AS CONT_CHARGE_FLAG,   
    MINCONTAMT AS MIN_CONT_AMT,   
    /*ADDLEDGERBAL AS 0 ,*/  
    DUMMY1 AS BROKERAGE_APPLICABLE,   
    DUMMY2 AS OPTION_EXCERCISE,   
    INSCONT AS INST_CONTRACT,   
    SERTAXMETHOD AS SERVICE_TAX_METHOD,   
    DUMMY6 AS CLEARING,   
    DUMMY7 AS REPORTING_STYLE,   
    DUMMY8 AS SBU,   
    DUMMY9 AS RELMGR,   
    DUMMY10 AS GROUP_CODE,   
    CONVERT(VARCHAR, ACTIVEFROM, 109) AS ACTIVE_FROM,   
    CONVERT(VARCHAR, INACTIVEFROM, 109) AS INACTIVE_FROM,   
    DEBITBALFLAG AS DEBITBAL_FLAG,   
    INTERSETTFLAG AS INTERSETT_FLAG,   
    LOGFLD_STATUSNAME AS LOGFLD_STATUSNAME,  
    LOGFLD_USERNAME AS LOGFLD_USERNAME,   
    LOGFLD_WHEN_109,   
    LOGFLD_ACTION   
   FROM  
    CLIENT2_LOG  
   WHERE  
    PARTY_CODE = @PARTYCODE  AND  
    LOGFLD_WHEN_109 >= @DATEFROM AND  
    LOGFLD_WHEN_109 <= @DATETO + ' 23:59:59'  
   ORDER BY  
    LOGFLD_WHEN_109 DESC  
  END  /*IF UPPER(LTRIM(RTRIM(@VIEWTYPE))) = 'FOR_A_PERIOD'*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILL
-- --------------------------------------------------

CREATE       PROC    [dbo].[rpt_proc_FO_NewBill]    
    
 @ReportName VarChar(50),    
 @StatusID VarChar(20),    
 @StatusName VarChar(50),    
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT    
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS    
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
    
 @FromDate VarChar(11),    
 @ToDate VarChar(11),    
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
 @FromCode VarChar(20),    
 @ToCode VarChar(20),    
    
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES    
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
    
 @OneOrMany VarChar(20),    
    
 @ProductCode VarChar(20),  --]    
 @ProductType VarChar(20), --]    
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.    
 @ExpiryDate VarChar(11), --]    
 @Symbol VarChar(20),  --]    
    
 --REPORT SPECIFIC SEARCH FEILDS    
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)        
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]    
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]    
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]    
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]    
 --END REPORT SPECIFIC SEARCH FEILDS    
    
 @WithNetPos VarChar(50),    
 @Dummy002 VarChar(50),    
 @Dummy003 VarChar(50),    
 @Dummy004 VarChar(50),    
 @Dummy005 VarChar(50),    
 @Dummy006 VarChar(50),    
 @Dummy007 VarChar(50),    
 @Dummy008 VarChar(50),    
 @Dummy009 VarChar(50),    
 @Dummy010 VarChar(50)    
AS    
    
Declare    
    
 @strSelect VarChar(8000),    
 @strSelectTemp VarChar(8000),    
 @strFrom VarChar(8000),    
 @strWhere VarChar(8000),    
 @strGroupBy VarChar(8000),    
 @strOrderBy VarChar(8000),    
 @strCompute VarChar(8000),    
 @strComputeSub VarChar(8000),    
    
 @IsSubLevel VarChar(3),    
 @CodeID VarChar(20),    
 @Comma VarChar(1)    
    
 Set @ProductCode = @ProductCode+"%"     
 If @ProductType = '' Begin Set @ProductType = "%" End    
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE    
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End    
 If @Symbol = '' Begin Set @Symbol = "%" End    
     
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End    
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End    
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End    
    
 Set @strSelect = ''    
 Set @strSelectTemp = ''    
 Set @strFrom = ''     
 Set @strWhere = ''    
 Set @strGroupBy = ''    
 Set @strOrderBy = ''    
 Set @strCompute = ''    
 Set @strCompute = ''    
 Set @strComputeSub = ''    
 Set @IsSubLevel = 'YES'    
    
 If (@ReportName = 'BILL')    
 Begin    
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End    
      
  Set @strSelect = @strSelect + "SELECT "    
  Set @strCompute = @strCompute + "COMPUTE "    
    
  --@WhatCode WILL ALWAYS BE 'CLIENT', AS THESE ARE THE DEFAULTS    
  --PASSES FRM THE ASP PAGE.    
  --THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP    
  --STRUCTURE FOR ALL REPORTS    
  If ((@WhatCode = 'CLIENT') AND (@OneOrMany = 'SUMMARY'))    
  Begin    
   Set @strSelectTemp = ''    
   --@GroupLevel/@SubGroupLevel WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS    
   --PASSES FRM THE ASP PAGE.    
   --THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP    
   --STRUCTURE FOR ALL REPORTS    
   --THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.    
   If (@GroupLevel = 'PARTY')    
   Begin    
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name, 25) AS party_name, client_type, Convert(VarChar,sauda_date,103) AS sauda_date, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date), "    
    Set @strComputeSub = @strComputeSub + "party_code "    
   End    
    
   Set @strSelect = @strSelect + @strSelectTemp    
   Set @strSelectTemp = ''    
    
  End /*If (@WhatCode = 'CLIENT')*/    
    
  --@Ex_Rate AND @Ex_ReportBy WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS    
  --PASSES FRM THE ASP PAGE.    
  --THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP    
  --STRUCTURE FOR ALL REPORTS    
  If (@Ex_Rate = 'MKTRATE')    
  Begin    
   If (@Ex_ReportBy = 'PRICE')    
   Begin    
    --AMT    
    /*Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum((SBillAmt - PBillAmt) - ((service_tax) + (turn_tax) + (sebi_tax) + (broker_note) + "    
    Set @strSelectTemp = @strSelectTemp + " (ins_chrg) + (other_chrg) + (cl_chrg-excl_chrg))) "    
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* AMT */ " --FOR THE SUB TOTAL    
    Set @strSelectTemp = @strSelectTemp + "AS billamt "    
    Set @strSelect = @strSelect + @strSelectTemp*/   

	Set @strSelectTemp = ''
	Set @strSelectTemp = @strSelectTemp + " Case When Participantcode = MemberCode Then "
	Set @strSelectTemp = @strSelectTemp + " SUM((PBILLAMT) + ((SERVICE_TAX- EXSER_TAX) + (TURN_TAX) + (SEBI_TAX) + (BROKER_NOTE) +  (INS_CHRG) + (OTHER_CHRG) + (CL_CHRG-EXCL_CHRG)) ) - SUM((SBILLAMT)  ) "
	Set @strSelectTemp = @strSelectTemp + " Else "
	Set @strSelectTemp = @strSelectTemp + " SUM((PBILLAMT) + ((SERVICE_TAX- EXSER_TAX) + (TURN_TAX) + (SEBI_TAX) + (BROKER_NOTE) +  (INS_CHRG) + (OTHER_CHRG) + (CL_CHRG-EXCL_CHRG)) ) + SUM((SBILLAMT)  ) "
	Set @strSelectTemp = @strSelectTemp + " End "
	Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* AMT */ "	--FOR THE SUB TOTAL
	Set @strSelectTemp = @strSelectTemp + "AS billamt "
	Set @strSelect = @strSelect + @strSelectTemp

   End    
  End /*If (@Ex_Rate = 'NETRATE')*/    
    
  Set @strFrom = @strFrom + "FROM "    
  Set @strFrom = @strFrom + "BFoBillValan, BFOOWNER "    
     
  Set @strWhere = @strWhere + "WHERE "    
    
    
  If (@FromCode = '' AND @ToCode = '')    
  Begin    
   Set @strWhere = @strWhere + @CodeID + " LIKE '%' AND "    
  End    
  Else     
  Begin    
   Set @strWhere = @strWhere + @CodeID + " >= '" + @FromCode + "' AND "    
   Set @strWhere = @strWhere + @CodeID + " <= '" + @ToCode + "' AND "    
  End    
    
  If (@FromDate = '' AND @ToDate = '')    
  Begin    
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "    
  End    
  Else    
  Begin    
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "    
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "    
  End    
    
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))    
  Begin    
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "    
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "    
  End    
    
 /*LOGIN CONDITIONS*/      	
	
	Set @strWhere = @strWhere + "'" + @STATUSNAME + "' = "
	Set @strWhere = @strWhere + "		(CASE "
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	Set @strWhere = @strWhere + "			ELSE "
	Set @strWhere = @strWhere + "		'BROKER'"
	Set @strWhere = @strWhere + "		END)    "

/*END - LOGIN CONDITIONS*/
    
  Set @Comma = ''    
    
    
  Set @strGroupBy = @strGroupBy + @Comma    
    
  --AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))    
  Begin    
   --AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
   If (@GroupLevel = 'PARTY')    
   Begin    
    Set @strGroupBy = @strGroupBy + "party_code, Left(party_name, 25), client_type, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date,participantcode, membercode "    
   End    
  End /*If (@OneOrMany = 'DETAIL')*/    
    
  Set @strOrderBy = @strGroupBy    
  Set @strGroupBy = "GROUP BY " + @strGroupBy    
  Set @strOrderBy = "ORDER BY " + @strOrderBy    
    
 End/*If (@ReportName = "NETPOSITION")*/    
    
    
 
    
 If @strComputeSub <> ''     
 Begin     
  Set @strComputeSub = "BY " + @strComputeSub     
  Set @strComputeSub = @strCompute + @strComputeSub    
 End    
    
 If (@IsSubLevel = 'YES')    
 Begin    
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)    
 End    
 Else    
 Begin    
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)    
 End    
    
 Print @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILLDETAIL
-- --------------------------------------------------
CREATE PROC    
[DBO].[RPT_PROC_FO_NEWBILLDETAIL]    
 @STATUSID VARCHAR(20),    
 @STATUSNAME VARCHAR(50),    
 @FROMDATE VARCHAR(11),    
 @TODATE VARCHAR(11),    
 @FROMPARTYCODE VARCHAR(20),    
 @TOPARTYCODE VARCHAR(20),    
 @CLIENTTYPE VARCHAR (20),    
 @DUMMY001 VARCHAR(50),    
 @DUMMY002 VARCHAR(50),    
 @DUMMY003 VARCHAR(50),    
 @DUMMY004 VARCHAR(50),    
 @DUMMY005 VARCHAR(50),    
 @DUMMY006 VARCHAR(50),    
 @DUMMY007 VARCHAR(50),    
 @DUMMY008 VARCHAR(50),    
 @DUMMY009 VARCHAR(50),    
 @DUMMY010 VARCHAR(50)    
AS    
    
IF @CLIENTTYPE = '' BEGIN SET @CLIENTTYPE = '%' END    
IF @FROMPARTYCODE = '' BEGIN SET @FROMPARTYCODE = '%' END    
IF @TOPARTYCODE = '' BEGIN SET @TOPARTYCODE = '%' END    
    
IF (@FROMDATE = '' OR @TODATE = '')    
BEGIN     
 SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM BFOBILLVALAN     
END    
    
IF (@FROMPARTYCODE = '' OR @TOPARTYCODE = '' OR @FROMPARTYCODE = '%' OR @TOPARTYCODE = '%')    
BEGIN     
 SELECT @FROMPARTYCODE = MIN(PARTY_CODE), @TOPARTYCODE = MAX(PARTY_CODE) FROM BFOBILLVALAN     
END     
    
SELECT    
	LEFT(F.PARTY_NAME, 25) AS PARTY_NAME,    
	F.PARTY_CODE,     
	F.CLIENT_TYPE,     
	C1.L_ADDRESS1,     
	C1.L_ADDRESS2,    
	C1.L_ADDRESS3,      
	C1.L_CITY,    
	C1.L_STATE,    
	C1.L_NATION,    
	C1.L_ZIP,    
	C1.RES_PHONE1,    
	CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,    
	F.PRODUCT_CODE,     
	F.SERIES_CODE,    
	CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,    
	F.STRIKE_PRICE,     
	CASE WHEN F.PRODUCT_TYPE = '' THEN '' ELSE F.PRODUCT_TYPE END AS PRODUCT_TYPE,    
	CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,    
	CL_RATE AS CLOSINGRATE,     
	CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END END AS PRATE,    
	CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END END AS SRATE,    
	CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,    
	CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,    
	CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
	CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END 
	ELSE
	SUM(F.PBILLAMT+F.SBILLAMT)
	END
	AS PBILLAMT,
	CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
	CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END 
	ELSE
	0
	END
	AS SBILLAMT,
	/*   
	CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,    
	CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,
	*/    
	SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,    
	SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) ) AS CHRG_TOTAL,    

	--SUM((F.PBILLAMT) + ((F.SERVICE_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,    
	CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
		SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )
	ELSE
		SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + SUM((F.SBILLAMT)  )
	END
	 AS FINALFIGURE,

	SUM(((F.CL_CHRG - F.EXCL_CHRG)) ), /* CLEARING CHARGES */    
	SUM(((F.SERVICE_TAX - F.EXSER_TAX)) ), /* SERVICE TAX */    
	SUM(((F.SEBI_TAX)) ), /* SEBI TAX */    
	SUM(((F.TURN_TAX)) ), /* TURNOVER TAX */    
	SUM(((F.BROKER_NOTE)) ), /* STAMP DUTY */    
	SUM(((F.INS_CHRG)) ), /* INS CHARGES */    
	SUM(((F.OTHER_CHRG)) ), /* OTHERCHARGES */    

	CASE WHEN F.TRADETYPE = 'BF' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.TRADETYPE + '</FONT>'     
			   ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'FUT%'     
								  THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'     
		ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'OPT%'     
								 THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'     
						   ELSE F.TRADETYPE     
				 END     
								  END     
			   END AS TRADETYPE,    
	CASE WHEN F.TRADETYPE = 'BF' THEN F.TRADETYPE    
			   ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'FUT%'     
								  THEN  'FF'     
		ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'OPT%'     
													 THEN  'EA'     
						   ELSE F.TRADETYPE     
				 END     
								  END     
			   END AS TRADETYPEPRINT    
FROM    
	BFOBILLVALAN F,     
	CLIENT1 C1,     
	CLIENT2 C2,
	BFOOWNER O    
WHERE    
	C1.CL_CODE = C2.CL_CODE AND    
	C2.PARTY_CODE = F.PARTY_CODE AND    
	F.CLIENT_TYPE LIKE @CLIENTTYPE AND    
	F.PARTY_CODE >= @FROMPARTYCODE AND    
	F.PARTY_CODE <= @TOPARTYCODE AND    
	F.SAUDA_DATE >= @FROMDATE + ' 00:00:00' AND    
	F.SAUDA_DATE <= @TODATE + ' 23:59:59' AND    
	F.TRADETYPE LIKE (CASE WHEN PRODUCT_CODE LIKE 'OPT%' THEN 'BT' ELSE '%' END ) AND    
	@STATUSNAME = (CASE 	
				WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')
				WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')
				WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')
				WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')
				WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')
				WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')
				WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
			END)
GROUP BY     
	F.PARTY_CODE,     
	F.PARTY_NAME,     
	F.CLIENT_TYPE,     
	F.SERIES_CODE,     
	F.PRODUCT_CODE,     
	F.EXPIRYDATE,     
	F.STRIKE_PRICE,     
	F.PRODUCT_TYPE,    
	C1.L_ADDRESS1,     
	C1.L_ADDRESS2,     
	F.TRADETYPE,     
	C1.RES_PHONE1,    
	F.SAUDA_DATE,    
	C1.EMAIL,    
	CL_RATE,    
	AUCTIONPART,    
	C1.L_ADDRESS3,      
	C1.L_CITY,    
	C1.L_STATE,    
	C1.L_NATION,    
	C1.L_ZIP,    
	PARTICIPANTCODE,
	MEMBERCODE
    
ORDER BY     
	F.PARTY_CODE,     
	F.PARTY_NAME,     
	F.CLIENT_TYPE,     
	F.SERIES_CODE,     
	F.PRODUCT_CODE,     
	F.EXPIRYDATE,     
	F.STRIKE_PRICE,     
	F.PRODUCT_TYPE,     
	F.TRADETYPE,     
	F.SAUDA_DATE    
    
COMPUTE    
	--SUM(CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END), /* PAMT */     
	--SUM(CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END), /* SAMT */    
	SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
	CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END 
	ELSE
	SUM(F.PBILLAMT+F.SBILLAMT)
	END), /* PAMT */ 
	SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
	CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END 
	ELSE
	0
	END), /* SAMT */
	SUM(SUM((F.PBILLAMT) ) - SUM((F.SBILLAMT) )),  /*DIFF = PAMT-SAMT*/    
	SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) )), /* TOTAL OF CHARGES */    
	--SUM(SUM((F.PBILLAMT) + ((F.SERVICE_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )), /* DIFF - TOTAL OF CHARGES */    
	SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
		SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )
	ELSE
		SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + SUM((F.SBILLAMT)  )
	END), /* DIFF - TOTAL OF CHARGES */
	SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG)) )), /* TOTAL OF CLEARING CHARGES */    
	SUM(SUM(((F.SERVICE_TAX - F.EXSER_TAX)) )), /* TOTAL OF SERVICE TAX */    
	SUM(SUM(((F.SEBI_TAX)) )), /* TOTAL OF SEBI TAX */    
	SUM(SUM(((F.TURN_TAX)) )), /* TOTAL OF TURNOVER TAX */    
	SUM(SUM(((F.BROKER_NOTE)) )), /* TOTAL OF STAMP DUTY */    
	SUM(SUM(((F.INS_CHRG)) )), /* TOTAL OF INS CHARGES */    
	SUM(SUM(((F.OTHER_CHRG)) )) /* TOTAL OF OTHERCHARGES */    

BY F.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILLDETAIL_NEW
-- --------------------------------------------------
CREATE   PROC      
[DBO].[RPT_PROC_FO_NEWBILLDETAIL_NEW]      
      
 @STATUSID VARCHAR(20),      
 @STATUSNAME VARCHAR(50),      
      
 @FROMDATE VARCHAR(11),      
 @TODATE VARCHAR(11),      
      
 @FROMPARTYCODE VARCHAR(20),      
 @TOPARTYCODE VARCHAR(20),      
      
 @CLIENTTYPE VARCHAR (20),      
      
 @DUMMY001 VARCHAR(50),      
 @DUMMY002 VARCHAR(50),      
 @DUMMY003 VARCHAR(50),      
 @DUMMY004 VARCHAR(50),      
 @DUMMY005 VARCHAR(50),      
 @DUMMY006 VARCHAR(50),      
 @DUMMY007 VARCHAR(50),      
 @DUMMY008 VARCHAR(50),      
 @DUMMY009 VARCHAR(50),      
 @DUMMY010 VARCHAR(50)      
AS      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

      
IF @CLIENTTYPE = '' BEGIN SET @CLIENTTYPE = '%' END      
IF @FROMPARTYCODE = '' BEGIN SET @FROMPARTYCODE = '%' END      
IF @TOPARTYCODE = '' BEGIN SET @TOPARTYCODE = '%' END      
      
IF (@FROMDATE = '' OR @TODATE = '')      
BEGIN       
 SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), 
	@TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM BFOBILLVALAN       
END      
      
IF (@FROMPARTYCODE = '' OR @TOPARTYCODE = '' OR @FROMPARTYCODE = '%' OR @TOPARTYCODE = '%')      
BEGIN       
 SELECT @FROMPARTYCODE = MIN(PARTY_CODE), @TOPARTYCODE = MAX(PARTY_CODE) FROM BFOBILLVALAN       
END       
      
SELECT      
 LEFT(C1.LONG_NAME, 25) AS PARTY_NAME,      
 F.PARTY_CODE,       
 C1.CL_TYPE,       
 C1.L_ADDRESS1,       
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,    
 C1.L_STATE,    
 C1.L_NATION,    
 C1.L_ZIP,    
 C1.RES_PHONE1,      
 CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,      
 F.PRODUCT_CODE,       
 F.SERIES_CODE,      
 CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,      
 F.STRIKE_PRICE,       
 CASE WHEN F.PRODUCT_TYPE = '' THEN '' ELSE F.PRODUCT_TYPE END AS PRODUCT_TYPE,      
 CONVERT(VARCHAR, F.BILLDATE, 103) AS SAUDADATE,      
 F.CL_RATE AS CLOSINGRATE,      
 CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN (NETWITHBROK) ELSE 0 END AS PRATE,      
 CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN (NETWITHBROK) ELSE 0 END AS SRATE,      
 (CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(PQTY)-SUM(SQTY) ELSE 0 END) AS PQTY,      
 (CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN ABS(SUM(PQTY)-SUM(SQTY)) ELSE 0 END) AS SQTY,          
 CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) > 0     
      THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))    
      ELSE 0     
 END      
 AS SBILLAMT,      
 CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) < 0     
      THEN ABS(SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)))    
      ELSE 0     
 END      
 AS PBILLAMT ,    
 SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) AS DIFF,    
   SUM((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) AS CHRG_TOTAL,      
   SUM((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) AS FINALFIGURE,        
   0 CLCHRG, /* CLEARING CHARGES */      
   SUM(SERVICE_TAX), /* SERVICE TAX */      
   SUM(F.SEBI_TAX), /* SEBI TAX */      
   SUM(F.TURN_TAX), /* TURNOVER TAX */      
   SUM(F.STAMPDUTY), /* STAMP DUTY */      
   SUM(F.INSURANCE_CHRG), /* INS CHARGES */      
   SUM(F.OTHER_CHRG), /* OTHERCHARGES */            
 CASE WHEN F.BFDAYFLAG = 'B-F' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.BFDAYFLAG + '</FONT>'       
        ELSE CASE WHEN AUCTIONPART = 'EA' AND F.PRODUCT_CODE LIKE 'FUT%'       
            THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'       
        ELSE CASE WHEN AUCTIONPART = 'EA' AND F.PRODUCT_CODE LIKE 'OPT%'       
            THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'       
                  ELSE F.BFDAYFLAG       
             END       
       END       
        END AS TRADETYPE,      
 CASE WHEN F.BFDAYFLAG = 'B-F' THEN  F.BFDAYFLAG 
        ELSE CASE WHEN AUCTIONPART = 'EA' AND F.PRODUCT_CODE LIKE 'FUT%'       
	     THEN  'FF' 
        ELSE CASE WHEN AUCTIONPART = 'EA' AND F.PRODUCT_CODE LIKE 'OPT%'       
                THEN  'EA'
        ELSE F.BFDAYFLAG       
                END       
        END       
        END AS TRADETYPEPRINT     
FROM      
	TBL_MTOMPREMIUMBILL F (NOLOCK),       
	CLIENT1 C1 (NOLOCK),       
	CLIENT2 C2 (NOLOCK)      
WHERE      
	C1.CL_CODE = C2.CL_CODE AND      
	C2.PARTY_CODE = F.PARTY_CODE AND       
	F.PARTY_CODE >= @FROMPARTYCODE AND      
	F.PARTY_CODE <= @TOPARTYCODE AND      
	F.BILLDATE >= @FROMDATE + ' 00:00:00' AND      
	F.BILLDATE <= @TODATE + ' 23:59:59' AND    
	@STATUSNAME = (CASE 	WHEN @STATUSID = 'BRANCH' THEN ISNULL(C1.BRANCH_CD,'')
				WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(C1.SUB_BROKER,'')
				WHEN @STATUSID = 'TRADER' THEN ISNULL(C1.TRADER,'')
				WHEN @STATUSID = 'FAMILY' THEN ISNULL(C1.FAMILY,'')
				WHEN @STATUSID = 'AREA' THEN ISNULL(C1.AREA,'')
				WHEN @STATUSID = 'REGION' THEN ISNULL(C1.REGION,'')
				WHEN @STATUSID = 'CLIENT' THEN ISNULL(C2.PARTY_CODE,'')
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
			END)
	
GROUP BY      
	F.PARTY_CODE,       
	C1.LONG_NAME,       
	C1.CL_TYPE,       
	F.SERIES_CODE,       
	F.PRODUCT_CODE,       
	F.EXPIRYDATE,       
	F.STRIKE_PRICE,       
	F.PRODUCT_TYPE,       
	F.BFDAYFLAG,       
	F.BILLDATE,    
	C1.EMAIL,    
	F.AUCTIONPART,    
	C1.L_ADDRESS1,    
	C1.L_ADDRESS2,    
	C1.L_ADDRESS3,    
	C1.L_CITY,    
	C1.L_STATE,    
	C1.L_NATION,    
	C1.L_ZIP,    
	C1.RES_PHONE1,    
	CL_RATE,    
	NETWITHBROK  ,
 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN PQTY ELSE '' END,
 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN SQTY ELSE '' END

    
HAVING CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))  ELSE 1 END <> 0
OR
CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM(SQTY-PQTY)  ELSE 1 END <> 0
    
ORDER BY       
	F.PARTY_CODE,       
	C1.LONG_NAME,       
	C1.CL_TYPE,       
	F.SERIES_CODE,       
	F.PRODUCT_CODE,       
	F.EXPIRYDATE,       
	F.STRIKE_PRICE,       
	F.PRODUCT_TYPE,       
	F.BFDAYFLAG DESC,       
	F.BILLDATE       
    
COMPUTE      
 SUM(CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) < 0     
      THEN ABS(SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)))    
      ELSE 0     
 END), /* PAMT */      
 SUM(CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) > 0     
      THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))    
      ELSE 0     
 END), /* SAMT */       

 SUM(SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))),  /*DIFF = PAMT-SAMT*/      
    
 SUM(SUM(SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)), /* TOTAL OF CHARGES */      
 SUM(SUM(SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG) - SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))), /* DIFF - TOTAL OF CHARGES */      
 SUM(0), /* TOTAL OF CLEARING CHARGES */      
 SUM(SUM(SERVICE_TAX)), /* TOTAL OF SERVICE TAX */      
 SUM(SUM(F.SEBI_TAX)), /* TOTAL OF SEBI TAX */      
 SUM(SUM(F.TURN_TAX)), /* TOTAL OF TURNOVER TAX */      
 SUM(SUM(F.STAMPDUTY)), /* TOTAL OF STAMP DUTY */      
 SUM(SUM(F.INSURANCE_CHRG)),/* TOTAL OF INS CHARGES */      
 SUM(SUM(F.OTHER_CHRG)) /* TOTAL OF OTHERCHARGES */       
   
 BY F.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY
-- --------------------------------------------------
CREATE PROC    
[DBO].[RPT_PROC_FO_NEWCLIENTSUMMARY]    
 @REPORTNAME VARCHAR(50),    
 @STATUSID VARCHAR(20),    
 @STATUSNAME VARCHAR(50),    
 @GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT    
 @GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS    
 @ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @FROMDATE VARCHAR(11),    
 @TODATE VARCHAR(11),    
 @WHATCODE VARCHAR(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
 @FROMCODE VARCHAR(20),    
 @TOCODE VARCHAR(20),    
 @FROMPARTYCODE VARCHAR(20), --]--> FOR THE FROM AND TO PARTY CODES    
 @TOPARTYCODE VARCHAR(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
 @ONEORMANY VARCHAR(20),    
 @PRODUCTCODE VARCHAR(20),  --]    
 @PRODUCTTYPE VARCHAR(20), --]    
 @STRIKEPRICE MONEY,  --]--> PRIMARY SEARCH FIELDS.    
 @EXPIRYDATE VARCHAR(11), --]    
 @SERIES_CODE VARCHAR(20),  --]    
 --REPORT SPECIFIC SEARCH FEILDS    
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)        
 @EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]    
 @EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]    
 @EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
 @EX_RATE VARCHAR(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
 @EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]    
 @EX_POSITION VARCHAR (1), --(LONG/SHORT) - IN THE MONEY     ]    
 --END REPORT SPECIFIC SEARCH FEILDS    
 @WITHNETPOS VARCHAR(50),    
 @DUMMY002 VARCHAR(50),    
 @DUMMY003 VARCHAR(50),    
 @DUMMY004 VARCHAR(50),    
 @DUMMY005 VARCHAR(50),    
 @DUMMY006 VARCHAR(50),    
 @DUMMY007 VARCHAR(50),    
 @DUMMY008 VARCHAR(50),    
 @DUMMY009 VARCHAR(50),    
 @DUMMY010 VARCHAR(50)    
AS    
DECLARE    
 @STRSELECT VARCHAR(8000),    
 @STRSELECTTEMP VARCHAR(8000),    
 @STRFROM VARCHAR(8000),    
 @STRWHERE VARCHAR(8000),    
 @STRGROUPBY VARCHAR(8000),    
 @STRORDERBY VARCHAR(8000),    
 @STRCOMPUTE VARCHAR(8000),    
 @STRCOMPUTESUB VARCHAR(8000),    
 @ISSUBLEVEL VARCHAR(3),    
 @CODEID VARCHAR(20),    
 @COMMA VARCHAR(1)    
 SET @PRODUCTCODE = @PRODUCTCODE+"%"     
 IF @PRODUCTTYPE = '' BEGIN SET @PRODUCTTYPE = "%" END    
 --IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE    
 IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END    
 IF @SERIES_CODE = '' BEGIN SET @SERIES_CODE = "%" END    
     
 IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END    
 IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END    
 IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END    
 SET @STRSELECT = ''    
 SET @STRSELECTTEMP = ''    
 SET @STRFROM = ''    
 SET @STRWHERE = ''    
 SET @STRGROUPBY = ''    
 SET @STRORDERBY = ''    
 SET @STRCOMPUTE = ''    
 SET @STRCOMPUTE = ''    
 SET @STRCOMPUTESUB = ''    
 SET @ISSUBLEVEL = 'NO'    
 IF (@REPORTNAME = 'CLIENTSUMMARY')    
 BEGIN   
  IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END    
      
  SET @STRSELECT = @STRSELECT + "SELECT "    
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))    
  BEGIN    
   SET @STRSELECTTEMP = ''    
   IF (@GROUPLEVEL = 'PARTY')    
   BEGIN    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, PARTY_NAME AS PARTY_NAME, CLIENT_TYPE, EMAIL, "    
   END    
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   SET @STRSELECTTEMP = ''    
  END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))*/    
  --@EX_RATE AND @EX_REPORTBY WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS    
  --PASSES FRM THE ASP PAGE.    
  --THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP    
  --STRUCTURE FOR ALL REPORTS    
  IF (@EX_RATE = 'MKTRATE')    
  BEGIN    
   IF (@EX_REPORTBY = 'PRICE')    
   BEGIN    
    --DAILY MARK TO MARKET SETTLEMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND PRODUCT_CODE LIKE '%FUT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS DAILYMTOMSETTLEMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --FINAL FUTURES SETTLEMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE '%FUT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FINALFUTURESSETTLEMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --PREMIUM SETTLEMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND PRODUCT_CODE LIKE '%OPT' AND TRADETYPE = 'BT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PREMIUMSETTLEMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --OPTIONS EXERCISE/ASSIGNMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE '%OPT' AND TRADETYPE = 'BT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSEXERCISEASSIGNMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --BROKERAGE + ALL CHARGES EXCEPT CLEARING    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "+ SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKANDMISC, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --CLEARING CHARGES    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(CL_CHRG) - SUM(EXCL_CHRG)) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   END    
  END /*IF (@EX_RATE = 'NETRATE')*/    
  IF (@EX_RATE = 'NETRATE')    
  BEGIN    
   IF (@EX_REPORTBY = 'PRICE')    
   BEGIN    
    --DAILY MARK TO MARKET SETTLEMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND PRODUCT_CODE LIKE '%FUT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS DAILYMTOMSETTLEMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --FINAL FUTURES SETTLEMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE '%FUT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FINALFUTURESSETTLEMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --PREMIUM SETTLEMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND PRODUCT_CODE LIKE '%OPT' AND TRADETYPE = 'BT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PREMIUMSETTLEMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --OPTIONS EXERCISE/ASSIGNMENT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE '%OPT' AND TRADETYPE = 'BT') THEN "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSEXERCISEASSIGNMENT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --BROKERAGE + ALL CHARGES EXCEPT CLEARING    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "+ SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKANDMISC, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --CLEARING CHARGES    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(CL_CHRG) - SUM(EXCL_CHRG)) "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   END    
  END /*IF (@EX_RATE = 'NETRATE')*/    
  SET @STRFROM = @STRFROM + "FROM "    
  SET @STRFROM = @STRFROM + "BFOBILLVALAN  "    
     
  SET @STRWHERE = @STRWHERE + "WHERE "    
  IF (@FROMCODE = '' AND @TOCODE = '')    
  BEGIN    
   SET @STRWHERE = @STRWHERE + @CODEID + " LIKE '%' AND "    
  END    
  ELSE    
  BEGIN    
   SET @STRWHERE = @STRWHERE + @CODEID + " >= '" + @FROMCODE + "' AND "    
   SET @STRWHERE = @STRWHERE + @CODEID + " <= '" + @TOCODE + "' AND "    
  END    
  IF (@FROMDATE = '' AND @TODATE = '')    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "    
  END    
  ELSE    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "    
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "    
  END    
  IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "    
   SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "    
  END    
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/
  SET @COMMA = ''    
  SET @STRGROUPBY = @STRGROUPBY + @COMMA    
  --AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))    
  BEGIN    
   --AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
   IF (@GROUPLEVEL = 'PARTY')    
   BEGIN    
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "    
    SET @COMMA = ', '    
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END    
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END    
    IF (@GROUPSUBLEVEL = 'PRODUCTCODE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END    
   END    
  END /*IF (@ONEORMANY = 'DETAIL')*/    
  SET @STRORDERBY = @STRGROUPBY    
  SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY    
  SET @STRORDERBY = "ORDER BY " + @STRORDERBY    
 END/*IF (@REPORTNAME = "NETPOSITION")*/    
 IF @STRCOMPUTESUB <> ''     
 BEGIN     
  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB     
  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB    
 END    
 IF (@ISSUBLEVEL = 'YES')    
 BEGIN    
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)    
 END    
 ELSE    
 BEGIN    
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)    
 END    
 PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY_LEDGER
-- --------------------------------------------------
CREATE  PROC [DBO].[RPT_PROC_FO_NEWCLIENTSUMMARY_LEDGER]  
@PARTY_CODE VARCHAR(10),@RPTDATE VARCHAR(11),@EXCHANGE VARCHAR(3),@SEGMENT VARCHAR(10)      
AS      
      
DECLARE       
@OPENBALANCE  MONEY,      
@LEDBALANCE   MONEY,      
@PAYREC       MONEY,      
@MINLEDBAL   MONEY,      
@MINMARGIN   MONEY,      
@MARGIN           MONEY,      
@AVLCOLL      MONEY,      
@SPANMAR      MONEY,      
@VARMARGIN     MONEY,      
@TOTCASH     MONEY,      
@TOTNONCASH   MONEY,      
@TOTCOLL  MONEY,      
@EFFCOLL    MONEY,      
@SPREADMARGIN MONEY,      
@NONSPREADMARGIN MONEY,      
@MARGINPER MONEY,      
@DATACUR   CURSOR      
      
      
SET @LEDBALANCE   = 0       
SET @PAYREC       = 0       
SET @MINLEDBAL   = 0      
SET @AVLCOLL      = 0       
SET @SPANMAR      = 0       
SET @VARMARGIN       = 0       
SET @TOTCASH     = 0       
SET @TOTNONCASH      = 0       
SET @TOTCOLL    = 0       
SET @EFFCOLL      = 0       
SET @MINMARGIN = 0      
SET @SPREADMARGIN =0    
SET @NONSPREADMARGIN =0  
     
/* LEDGER BALANCE */      
SELECT @LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.PARAMETER P      
WHERE VDT < @RPTDATE AND VDT >= SDTCUR AND VDT<= LDTCUR      
AND CLTCODE = @PARTY_CODE AND @RPTDATE BETWEEN SDTCUR AND LDTCUR       
      
/* OPEN BALANCE */      
SELECT @OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTBFO.DBO.LEDGER L      
WHERE VDT LIKE @RPTDATE + '%' AND VTYP = 18 AND CLTCODE = @PARTY_CODE       
      
SELECT @LEDBALANCE = @LEDBALANCE + @OPENBALANCE      
      
/* PAYMENT RECEIVED FOR THE DAY */      
SELECT @PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTBFO.DBO.LEDGER L WHERE VDT LIKE @RPTDATE + '%' AND CLTCODE = @PARTY_CODE       
AND VTYP NOT IN (15,18)      
      
/* MARGIN AMOUNT */      
SELECT @MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)      
FROM ACCOUNTBFO.DBO.MARGINLEDGER L, ACCOUNTBFO.DBO.PARAMETER P  WHERE VDT <= @RPTDATE + ' 23:59' AND PARTY_CODE = @PARTY_CODE       
AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VDT < @RPTDATE AND VDT >= SDTCUR AND CURYEAR = 1       
      
      
/* COLLATERAL DETAILS */      
SELECT @TOTCASH = ISNULL(SUM(CASH),0), @TOTNONCASH = ISNULL(SUM(NONCASH),0), @TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),       
@EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), @AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0) FROM MSAJAG.DBO.COLLATERAL       
WHERE PARTY_CODE = @PARTY_CODE AND TRANS_DATE LIKE @RPTDATE + '%' AND EXCHANGE = @EXCHANGE      
AND SEGMENT = @SEGMENT       
SELECT @MARGINPER = 0       

/* SPAN AND VAR MARGIN */    
SELECT 
@SPANMAR = 0, 
@VARMARGIN = ISNULL(SUM(INIT_MARGIN),0) , 
@SPREADMARGIN = 0, 
@NONSPREADMARGIN = 0,
@MARGIN = ISNULL(SUM(INIT_MARGIN),0)
 FROM BFOMARGINCOLL
WHERE FILE_DATE LIKE @RPTDATE + '%' AND PARTY_CODE = @PARTY_CODE AND CL_TYPE LIKE 'N%'   

          
IF @MARGINPER = 0 OR @MARGINPER IS NULL      
 SELECT @MARGINPER = 100      
      
SELECT       
PARTY_CODE              = @PARTY_CODE,      
MARGINDATE                = @RPTDATE,       
LEDBALANCE  = @LEDBALANCE,      
PAYREC   = @PAYREC,      
MINLEDBAL         = @MINLEDBAL,      
MINMARGIN        = @SPREADMARGIN + @NONSPREADMARGIN + @VARMARGIN,      
MARGIN              = @MARGIN,      
AVLCOLL  = @AVLCOLL,      
SPANMAR  = @SPANMAR,      
VARMARGIN   = @VARMARGIN,      
TOTCASH  = @TOTCASH,      
TOTCOLLNONCASH        = @TOTNONCASH,      
TOTNONCASH  = CASE WHEN @LEDBALANCE + @PAYREC + @TOTCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
    THEN CASE WHEN @TOTNONCASH > @LEDBALANCE + @PAYREC + @TOTCASH      
          THEN @LEDBALANCE + @TOTCASH      
          ELSE @TOTNONCASH       
             END      
    ELSE                CASE WHEN @TOTNONCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)          
                     THEN ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
          ELSE @TOTNONCASH       
             END       
        END,      
TOTCOLL  = @TOTCOLL,      
EFFCOLL  = CASE WHEN @LEDBALANCE + @PAYREC + @TOTCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
    THEN CASE WHEN @TOTNONCASH > @LEDBALANCE + @PAYREC + @TOTCASH      
          THEN @LEDBALANCE + @TOTCASH      
          ELSE @TOTNONCASH       
             END      
    ELSE      
            CASE WHEN @TOTNONCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
                     THEN ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
          ELSE @TOTNONCASH       
             END       
        END + @TOTCASH ,      
SPREADMARGIN  = @SPREADMARGIN+ @VARMARGIN,      
NONSPREADMARGIN = @NONSPREADMARGIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY_NETPOS
-- --------------------------------------------------
CREATE PROC  
[DBO].[RPT_PROC_FO_NEWCLIENTSUMMARY_NETPOS]  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @SAUDADATE VARCHAR(11),  
 @PARTYCODE VARCHAR(20),  
 @DUMMY001 VARCHAR(50),  
 @DUMMY002 VARCHAR(50),  
 @DUMMY003 VARCHAR(50),  
 @DUMMY004 VARCHAR(50),  
 @DUMMY005 VARCHAR(50)  
AS  
 SELECT  
  PRODUCT_CODE, SERIES_CODE,   
  LEFT(EXPIRYDATE,11) AS EXPIRYDATE,   
  STRIKE_PRICE,   
  PRODUCT_TYPE,   
  SUM(PQTY-SQTY) AS OPENPOSITION,  
  SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))  AS PROFITORLOSS  
 FROM  
  BFOBILLVALAN  
 WHERE  
  PARTY_CODE = @PARTYCODE AND  
  SAUDA_DATE LIKE @SAUDADATE + '%'  
 GROUP BY  
  PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE     
 HAVING SUM(PQTY-SQTY) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWINTHEMONEY
-- --------------------------------------------------
CREATE     PROC        
[DBO].[RPT_PROC_FO_NEWINTHEMONEY]        
 @REPORTNAME VARCHAR(50),        
 @STATUSID VARCHAR(20),        
 @STATUSNAME VARCHAR(50),        
 @GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT        
 @GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FROMDATE VARCHAR(11),        
 @TODATE VARCHAR(11),        
 @WHATCODE VARCHAR(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FROMCODE VARCHAR(20),        
 @TOCODE VARCHAR(20),        
 @FROMPARTYCODE VARCHAR(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @TOPARTYCODE VARCHAR(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @ONEORMANY VARCHAR(20),        
 @PRODUCTCODE VARCHAR(20),  --]        
 @PRODUCTTYPE VARCHAR(20), --]        
 @STRIKEPRICE MONEY,  --]--> PRIMARY SEARCH FIELDS.        
 @EXPIRYDATE VARCHAR(11), --]        
 @SERIESCODE VARCHAR(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]        
 @EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @EX_RATE VARCHAR(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @EX_POSITION VARCHAR (1), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @DUMMY001 VARCHAR(50),        
 @DUMMY002 VARCHAR(50),        
 @DUMMY003 VARCHAR(50),        
 @DUMMY004 VARCHAR(50),        
 @DUMMY005 VARCHAR(50),        
 @DUMMY006 VARCHAR(50),        
 @DUMMY007 VARCHAR(50),        
 @DUMMY008 VARCHAR(50),        
 @DUMMY009 VARCHAR(50),        
 @DUMMY010 VARCHAR(50)        
AS        
DECLARE        
 @STRSELECT VARCHAR(8000),        
 @STRSELECTTEMP VARCHAR(8000),        
 @STRFROM VARCHAR(8000),        
 @STRWHERE VARCHAR(8000),        
 @STRGROUPBY VARCHAR(8000),        
 @STRORDERBY VARCHAR(8000),        
 @STRCOMPUTE VARCHAR(8000),        
 @STRCOMPUTESUB VARCHAR(8000),        
 @ISSUBLEVEL VARCHAR(3),        
 @CODEID VARCHAR(20),        
 @COMMA VARCHAR(1)        
 SET @PRODUCTCODE = @PRODUCTCODE+"%"         
 IF @PRODUCTTYPE = '' BEGIN SET @PRODUCTTYPE = "%" END        
 --IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE        
 IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END        
 IF @SERIESCODE = '' BEGIN SET @SERIESCODE = "%" END        
         
 IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END        
 IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END        
 IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END        
 SET @STRSELECT = ''        
 SET @STRSELECTTEMP = ''        
 SET @STRFROM = ''        
 SET @STRWHERE = ''        
 SET @STRGROUPBY = ''        
 SET @STRORDERBY = ''        
 SET @STRCOMPUTE = ''        
 SET @STRCOMPUTE = ''        
 SET @STRCOMPUTESUB = ''        
 SET @ISSUBLEVEL = 'NO'        
 IF (@FROMDATE = '' AND @TODATE = '')        
 BEGIN         
  SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM BFOBILLVALAN         
 END         
 IF (@REPORTNAME = 'INTHEMONEY')        
 BEGIN        
  IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END        
  IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END        
  IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END        
  IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END        
  IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END        
  IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END        
  IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END        
          
  SET @STRSELECT = @STRSELECT + "SELECT "        
  SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "        
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   SET @STRSELECTTEMP = ''        
   IF (@GROUPLEVEL = 'PARTY')        
  BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
            
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "        
    END        
   END        
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PRODUCT_CODE, "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
    SET @ISSUBLEVEL = 'YES'        
   END        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   SET @STRSELECTTEMP = ''        
  END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
   IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END        
  END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
          
  IF (@EX_RATE = 'MKTRATE')        
  BEGIN        
   --IF (@EX_REPORTBY = 'BOTH') ARE OMITED        
   IF (@EX_REPORTBY = 'PRICE')        
   BEGIN        
    --PQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* P.QTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
          
    --SQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SQTY) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* S.QTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --CLOSING RATE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CMCLOSING) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* CLOSING RATE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSINGRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (ABS(SUM((CMCLOSING-STRIKE_PRICE)))) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET RATE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP     
    --SETTLEMENT AMT.        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (ABS(SUM((CMCLOSING-STRIKE_PRICE))) * (SUM(PQTY) - SUM(SQTY))) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* SETTLEMENT AMT. */ " --FOR THE SUB TOTAL - LAST ONE W/O THE COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SETTLEMENTAMT "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
  END /*IF (@EX_RATE = 'NETRATE')*/         
  SET @STRSELECTTEMP = ""        
          
  SET @STRFROM = @STRFROM + "FROM "        
  SET @STRFROM = @STRFROM + "BFOBILLVALAN "        
         
  SET @STRWHERE = @STRWHERE + "WHERE "        
         
  /* MONEY TYPE OPTIONS */        
  IF (@EX_MONEYTYPE = "I")        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) > CONVERT(MONEY, STRIKE_PRICE) AND "        
  END        
  IF (@EX_MONEYTYPE = "O")        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) < CONVERT(MONEY, STRIKE_PRICE) AND "        
  END        
  IF (@EX_MONEYTYPE = "A")        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) = CONVERT(MONEY, STRIKE_PRICE) AND "        
  END        
  IF (@EX_POSITION = "L")        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "PQTY > 0 AND SQTY = 0 AND "        
  END        
  IF (@EX_POSITION = "S")        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SQTY > 0 AND PQTY = 0 AND "        
  END        
  /* END POSITION TYPE OPTIONS */        
  SET @STRWHERE = @STRWHERE + "LTRIM(RIGHT(PRODUCT_CODE,3)) LIKE '" + @PRODUCTCODE + "' AND "        
  SET @STRWHERE = @STRWHERE + "PRODUCT_TYPE LIKE '" + @PRODUCTTYPE + "' AND "        
  IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END        
  SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "        
  SET @STRWHERE = @STRWHERE + "SERIES_CODE LIKE '" + @SERIESCODE + "' AND /*EXPIRYDATE >= GETDATE() AND*/ "        
  IF (@FROMCODE = '' AND @TOCODE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " >= '" + @FROMCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + @CODEID + " <= '" + @TOCODE + "' AND "        
  END        
  IF (@FROMDATE = '' AND @TODATE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "        
  END        
  IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "        
  END        
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/
  SET @COMMA = ''        
  SET @STRGROUPBY = @STRGROUPBY + @COMMA        
          
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   IF (@GROUPLEVEL = 'PARTY')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
           
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "PRODUCT_CODE "*/ END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PRODUCT_CODE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL, SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, "        
    SET @STRGROUPBY = @STRGROUPBY + "PRODUCT_TYPE ,SAUDA_DATE "        
   END        
  END /*IF (@ONEORMANY = 'DETAIL')*/        
  ELSE /*IF (@ONEORMANY = 'DETAIL')*/        
  BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
   IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME " END        
  END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
  SET @STRORDERBY = @STRGROUPBY        
  SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY + " HAVING SUM(PQTY) - SUM(SQTY) <> 0 "        
  SET @STRORDERBY = "ORDER BY " + @STRORDERBY        
 END/*IF (@REPORTNAME = "NETPOSITION")*/        
 IF @STRCOMPUTESUB <> ''         
 BEGIN         
  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB         
  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB        
 END        
 IF (@ISSUBLEVEL = 'YES')        
 BEGIN        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)        
 END        
 ELSE        
 BEGIN        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)        
 END        
 PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWM2M
-- --------------------------------------------------
CREATE  PROC [dbo].[rpt_proc_FO_NewM2M]
	@ReportName VarChar(50),
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@GroupLevel VarChar(10),	--FOR TOP LEVEL REPORT
	@GroupSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@OrderLevel VarChar(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@OrderSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FromDate VarChar(11),
	@ToDate VarChar(11),
	@WhatCode varChar(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FromCode VarChar(20),
	@ToCode VarChar(20),
	@FromPartyCode VarChar(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@ToPartyCode VarChar(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@DispDiffOnly VarChar(10),
	@InstType VarChar(20),		--]
	@OptionType VarChar(20),	--]
	@StrikePrice Money,		--]-->	PRIMARY SEARCH FIELDS.
	@ExpiryDate VarChar(11),	--]
	@Series_code VarChar(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@Ex_BillType VarChar(1),	--(SINGLE/MULTIPLE) - BILL						]
	@Ex_AuctionPart VarChar(20),	--SAUDASUMMARY							]
	@Ex_ReportBy VarChar(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@Ex_Rate VarChar(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@Ex_MoneyType VarChar(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@Ex_Position VarChar (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@M2MType VarChar(50),
	@M2MFor VarChar(50),
	@Dummy003 VarChar(50),
	@Dummy004 VarChar(50),
	@Dummy005 VarChar(50),
	@Dummy006 VarChar(50),
	@Dummy007 VarChar(50),
	@Dummy008 VarChar(50),
	@Dummy009 VarChar(50),
	@Dummy010 VarChar(50)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


Declare
        @MemberCode Varchar(15)
	Select @MemberCode = MemberCode From FoOwner 
	if @ToCode='' Set @ToCode = 'zzz'

	If @M2MFor = 'SCRIP'
	Begin
		Select 
			inst_type ,
			symbol,
			Expiry_Date,
			Option_Type,
			Strike_Price,	
			Email='', 
			Sauda_date = @FromDate ,
			m_exe ,
			m_prem ,
			m_daily ,
			f_exe ,
			f_prem ,
			f_daily ,
			diff_exe ,
			diff_prem ,
			diff_daily
		From
			(
			Select
				inst_type = isnull(Product_code,foea_inst_type) ,
				symbol = isnull(Series_code, foea_symbol),
				Expiry_Date = isnull(expirydate,foea_expirydate),
				Option_Type = isnull(option_type,foea_option_type),
				Strike_Price = isnull(strike_price,foea_strike_price),	
				m_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE') then isnull(m_exe,0) else 0 end ,
				m_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(m_prem,0) else 0 end ,
				m_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(m_daily,0) else 0 end,
				f_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE' )then isnull(f_exe,0) else 0 end ,
				f_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(f_prem,0) else 0 end ,
				f_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(f_daily,0) else 0 end ,
				diff_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE') Then isnull(m_exe,0) - isnull(f_exe,0) else 0 end,
				diff_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(m_prem,0) - isnull(f_prem,0) else 0 end,
				diff_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(m_daily,0) - isnull(f_daily,0) else 0 end
			From
				(
				Select 
					Product_code ,
					Series_code,
					ExpiryDate = Convert(varchar,ExpiryDate,103),
					Option_Type,
					Strike_Price,	
					Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_exe,
					Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_prem, 
					Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_daily
				From
					BFoBillValan
				Where	
					left(convert(varchar,sauda_date,109),11)=  @FromDate  AND
					party_code Between @FromCode AND @ToCode AND
					@StatusName = 
					  (case 
					        when @StatusId = 'BRANCH' then branch_code
					        when @StatusId = 'SUBBROKER' then sub_broker
					        when @StatusId = 'Trader' then Trader
					        when @StatusId = 'Family' then Family
					        when @StatusId = 'Client' then party_code
					  else 
					        'BROKER'
					  End) And 
					Product_code Like (Case When @M2MType = 'M2M'  
						        Then '%FUT' 
						        Else (Case When @M2MType = 'ALL'  
							             Then '%' 
								Else '%OPT' 
							   End )
					            End ) And
					AuctionPart Like (Case When @M2MType = 'EXE'  
						        Then 'EA' 
						        Else '%'
					            End )
					And ParticipantCode = @MemberCode
				Group By
					Product_code , Series_code, Convert(varchar,ExpiryDate,103),
					Option_Type, Strike_Price
				) Bill
				Full Outer Join
				(
				Select
					foea_inst_type ,
					foea_symbol,
					foea_ExpiryDate = Convert(varchar,foea_ExpiryDate,103),
					foea_Option_Type = Case when foea_option_type ='FF' then '' else foea_Option_Type End,
					foea_Strike_Price,	
					m_prem=Sum(FoEa_Netpremium),
					m_daily = Sum(FoEa_Daily_Mtm_Settlement_Value+FoEa_Futures_Final_Settlement_Value),
					m_exe = Sum(FoEa_Exercised_Assigned_Value)
				From
					FoExerciseallocation
				where
					foea_party_code Between @FromCode AND  @ToCode 
					and left(convert(varchar,foea_position_date,109),11) = @FromDate  
					and foea_inst_type Like (Case When @M2MType = 'M2M'  
						        Then '%FUT' 
						        Else (Case When @M2MType = 'ALL'  
							             Then '%' 
								Else '%OPT' 
							   End )
					            End ) 
				Group By 
					foea_inst_type ,
					foea_symbol,
					Convert(varchar,foea_ExpiryDate,103),
					Case when foea_option_type ='FF' then '' else foea_Option_Type End,
					foea_Strike_Price
				) FoEa
				
				On ( 
					foea_inst_type = Product_code and 
					foea_symbol = Series_code and
					foea_expirydate = expirydate and
					foea_option_type = option_type and
					foea_strike_price = strike_price
				 )
			
			) rpt
		
		Where
			abs(m_exe) + abs(m_prem) + abs(m_daily) + abs(f_exe) + abs(f_prem) + abs(f_daily) > 0 
			And Case When @DispDiffOnly ='DIFF' then 
				abs(diff_exe)+abs(diff_prem)+abs(diff_daily)
			else
				1
			end
			<> 0
		
		Order By 
			inst_type ,symbol ,Expiry_Date,Option_Type,	Strike_Price
		Compute
			sum (m_exe),
			sum (m_prem),
			sum (m_daily),
			sum (f_exe),
			sum (f_prem),
			sum (f_daily),
			sum (diff_exe),
			sum (diff_prem),
			sum (diff_daily)
	End	/*If @M2MFor = 'SCRIP'*/

	If @M2MFor = 'PARTY'
	Begin
		Select 
			Party_Code,
			Party_Name,
			Email='', 
			Sauda_date = @FromDate ,
			m_exe ,
			m_prem ,
			m_daily ,
			f_exe ,
			f_prem ,
			f_daily ,
			diff_exe ,
			diff_prem ,
			diff_daily
		From
			(
			Select
				Party_Code = isnull(Party_Code,foea_party_code),
				Party_Name = isnull(Party_Name,''),
				m_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE') then isnull(m_exe,0) else 0 end ,
				m_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(m_prem,0) else 0 end ,
				m_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(m_daily,0) else 0 end,
				f_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE' )then isnull(f_exe,0) else 0 end ,
				f_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(f_prem,0) else 0 end ,
				f_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(f_daily,0) else 0 end ,
				diff_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE') Then isnull(m_exe,0) - isnull(f_exe,0) else 0 end,
				diff_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(m_prem,0) - isnull(f_prem,0) else 0 end,
				diff_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(m_daily,0) - isnull(f_daily,0) else 0 end
			From
				(
				Select 
					party_code,
					Party_Name,
					Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_exe,
					Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_prem, 
					Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_daily
				From
					BFoBillValan
				Where	
					left(convert(varchar,sauda_date,109),11)=  @FromDate  AND
					party_code Between @FromCode AND @ToCode AND
					@StatusName = 
					  (case 
					        when @StatusId = 'BRANCH' then branch_code
					        when @StatusId = 'SUBBROKER' then sub_broker
					        when @StatusId = 'Trader' then Trader
					        when @StatusId = 'Family' then Family
					        when @StatusId = 'Client' then party_code
					  else 
					        'BROKER'
					  End) And 
					Product_code Like (Case When @M2MType = 'M2M'  
						        Then '%FUT' 
						        Else (Case When @M2MType = 'ALL'  
							             Then '%' 
								Else '%OPT' 
							   End )
					            End ) And
					AuctionPart Like (Case When @M2MType = 'EXE'  
						        Then 'EA' 
						        Else '%'
					            End )
					And ParticipantCode = @MemberCode
				Group By
					Party_Code,Party_Name
				) Bill
				Full Outer Join
				(
				Select
					foEa_Party_Code,
					m_prem=Sum(FoEa_Netpremium),
					m_daily = Sum(FoEa_Daily_Mtm_Settlement_Value+FoEa_Futures_Final_Settlement_Value),
					m_exe = Sum(FoEa_Exercised_Assigned_Value)
				From
					FoExerciseallocation
				where
					foea_party_code Between @FromCode AND  @ToCode 
					and left(convert(varchar,foea_position_date,109),11) = @FromDate  
					and foea_inst_type Like (Case When @M2MType = 'M2M'  
						        Then '%FUT' 
						        Else (Case When @M2MType = 'ALL'  
							             Then '%' 
								Else '%OPT' 
							   End )
					            End ) 
				Group By foEa_Party_Code
				) FoEa
				
				On ( foea_party_code = Party_code )
			
			) rpt
		
		Where
			abs(m_exe) + abs(m_prem) + abs(m_daily) + abs(f_exe) + abs(f_prem) + abs(f_daily) > 0
			And Case When @DispDiffOnly ='DIFF' then 
				abs(diff_exe)+abs(diff_prem)+abs(diff_daily)
			else
				1
			end
			<> 0
		
		Order By 
			Party_Code,Party_Name
		Compute
			sum (m_exe),
			sum (m_prem),
			sum (m_daily),
			sum (f_exe),
			sum (f_prem),
			sum (f_daily),
			sum (diff_exe),
			sum (diff_prem),
			sum (diff_daily)

	End	/*If @M2MFor = 'PARTY'*/
	If @M2MFor = 'BOTH'
	Begin
		Select 
			Party_Code,
			Party_Name,
			inst_type ,
			symbol,
			Expiry_Date,
			Option_Type,
			Strike_Price,	
			Email='', 
			Sauda_date = @FromDate ,
			m_exe ,
			m_prem ,
			m_daily ,
			f_exe ,
			f_prem ,
			f_daily ,
			diff_exe ,
			diff_prem ,
			diff_daily
		From
			(
			Select
				Party_Code = isnull(Party_Code,foea_party_code),
				Party_Name = isnull(Party_Name,''),
				inst_type = isnull(Product_code,foea_inst_type) ,
				symbol = isnull(Series_code, foea_symbol),
				Expiry_Date = isnull(expirydate,foea_expirydate),
				Option_Type = isnull(option_type,foea_option_type),
				Strike_Price = isnull(strike_price,foea_strike_price),	
				m_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE') then isnull(m_exe,0) else 0 end ,
				m_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(m_prem,0) else 0 end ,
				m_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(m_daily,0) else 0 end,
				f_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE' )then isnull(f_exe,0) else 0 end ,
				f_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(f_prem,0) else 0 end ,
				f_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(f_daily,0) else 0 end ,
				diff_exe = Case When (@M2MType = 'ALL' or @M2MType = 'EXE') Then isnull(m_exe,0) - isnull(f_exe,0) else 0 end,
				diff_prem = Case When (@M2MType = 'ALL' or @M2MType = 'PRE') Then isnull(m_prem,0) - isnull(f_prem,0) else 0 end,
				diff_daily = Case When (@M2MType = 'ALL' or @M2MType = 'M2M') Then isnull(m_daily,0) - isnull(f_daily,0) else 0 end
			From
				(
				Select 
					party_code,
					Party_Name,
					Product_code ,
					Series_code,
					ExpiryDate = Convert(varchar,ExpiryDate,103),
					Option_Type,
					Strike_Price,	
					Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_exe,
					Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_prem, 
					Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_daily
				From
					BFoBillValan
				Where	
					left(convert(varchar,sauda_date,109),11)=  @FromDate  AND
					party_code Between @FromCode AND @ToCode AND
					@StatusName = 
					  (case 
					        when @StatusId = 'BRANCH' then branch_code
					        when @StatusId = 'SUBBROKER' then sub_broker
					        when @StatusId = 'Trader' then Trader
					        when @StatusId = 'Family' then Family
					        when @StatusId = 'Client' then party_code
					  else 
					        'BROKER'
					  End) And 
					Product_code Like (Case When @M2MType = 'M2M'  
						        Then '%FUT' 
						        Else (Case When @M2MType = 'ALL'  
							             Then '%' 
								Else '%OPT' 
							   End )
					            End ) And
					AuctionPart Like (Case When @M2MType = 'EXE'  
						        Then 'EA' 
						        Else '%'
					            End )
					And ParticipantCode = @MemberCode
				Group By
					Party_Code,Party_Name,
					Product_code , Series_code, Convert(varchar,ExpiryDate,103),
					Option_Type, Strike_Price
				) Bill
				Full Outer Join
				(
				Select
					foEa_Party_Code,
					foea_inst_type ,
					foea_symbol,
					foea_ExpiryDate = Convert(varchar,foea_ExpiryDate,103),
					foea_Option_Type = Case when foea_option_type ='FF' then '' else foea_Option_Type End,
					foea_Strike_Price,	
					m_prem=Sum(FoEa_Netpremium),
					m_daily = Sum(FoEa_Daily_Mtm_Settlement_Value+FoEa_Futures_Final_Settlement_Value),
					m_exe = Sum(FoEa_Exercised_Assigned_Value)
				From
					FoExerciseallocation
				where
					foea_party_code Between @FromCode AND  @ToCode 
					and left(convert(varchar,foea_position_date,109),11) = @FromDate  
					and foea_inst_type Like (Case When @M2MType = 'M2M'  
						        Then '%FUT' 
						        Else (Case When @M2MType = 'ALL'  
							             Then '%' 
								Else '%OPT' 
							   End )
					            End ) 
				Group By foEa_Party_Code,
					foea_inst_type ,
					foea_symbol,
					Convert(varchar,foea_ExpiryDate,103),
					Case when foea_option_type ='FF' then '' else foea_Option_Type End,
					foea_Strike_Price
				) FoEa
				
				On ( 
					foea_party_code = Party_code and 
					foea_inst_type = Product_code and 
					foea_symbol = Series_code and
					foea_expirydate = expirydate and
					foea_option_type = option_type and
					foea_strike_price = strike_price
				 )
			
			) rpt
		
		Where
			abs(m_exe) + abs(m_prem) + abs(m_daily) + abs(f_exe) + abs(f_prem) + abs(f_daily) > 0 
			And Case When @DispDiffOnly ='DIFF' then 
				abs(diff_exe)+abs(diff_prem)+abs(diff_daily)
			else
				1
			end
			<> 0
		
		Order By 
			Party_Code,Party_Name,inst_type ,symbol,Expiry_Date,Option_Type,	Strike_Price
		Compute
			sum (m_exe),
			sum (m_prem),
			sum (m_daily),
			sum (f_exe),
			sum (f_prem),
			sum (f_daily),
			sum (diff_exe),
			sum (diff_prem),
			sum (diff_daily)

	End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWNETPOSITION
-- --------------------------------------------------
CREATE PROC        
 [DBO].[RPT_PROC_FO_NEWNETPOSITION]        
 @REPORTNAME VARCHAR(50),        
 @STATUSID VARCHAR(20),        
 @STATUSNAME VARCHAR(50),        
 @GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT        
 @GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FROMDATE VARCHAR(11),        
 @TODATE VARCHAR(11),        
 @WHATCODE VARCHAR(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FROMCODE VARCHAR(20),        
 @TOCODE VARCHAR(20),        
 @FROMPARTYCODE VARCHAR(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @TOPARTYCODE VARCHAR(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @ONEORMANY VARCHAR(20),        
 @PRODUCT_CODE VARCHAR(20),  --]        
 @PRODUCT_TYPE VARCHAR(20), --]        
 @STRIKEPRICE MONEY,  --]--> PRIMARY SEARCH FIELDS.        
 @EXPIRYDATE VARCHAR(11), --]        
 @SERIES_CODE VARCHAR(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]        
 @EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @EX_RATE VARCHAR(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @EX_POSITION VARCHAR (1), --(LONG/SHORT) - IN THE MONEY     ]        
 @CMCLOSING VARCHAR (2), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @DUMMY001 VARCHAR(50),        
 @DUMMY002 VARCHAR(50),        
 @DUMMY003 VARCHAR(50),        
 @DUMMY004 VARCHAR(50),        
 @DUMMY005 VARCHAR(50),        
 @DUMMY006 VARCHAR(50),        
 @DUMMY007 VARCHAR(50),        
 @DUMMY008 VARCHAR(50),        
 @DUMMY009 VARCHAR(50),        
 @DUMMY010 VARCHAR(50)        
AS        
DECLARE        
 @STRSELECT VARCHAR(8000),        
 @STRSELECTTEMP VARCHAR(8000),        
 @STRFROM VARCHAR(8000),        
 @STRWHERE VARCHAR(8000),        
 @STRGROUPBY VARCHAR(8000),        
 @STRORDERBY VARCHAR(8000),        
 @STRCOMPUTE VARCHAR(8000),        
 @STRCOMPUTESUB VARCHAR(8000),        
 @ISSUBLEVEL VARCHAR(3),        
 @CODEID VARCHAR(20),        
 @COMMA VARCHAR(1)        
 SET @PRODUCT_CODE = @PRODUCT_CODE+"%"         
 IF @PRODUCT_TYPE = '' BEGIN SET @PRODUCT_TYPE = "%" END        
 --IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE        
 IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END        
 IF @SERIES_CODE = '' BEGIN SET @SERIES_CODE = "%" END        
         
 IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END        
 IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END        
 IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END        
 SET @STRSELECT = ''        
 SET @STRSELECTTEMP = ''        
 SET @STRFROM = ''        
 SET @STRWHERE = ''        
 SET @STRGROUPBY = ''        
 SET @STRORDERBY = ''        
 SET @STRCOMPUTE = ''        
 SET @STRCOMPUTE = ''        
 SET @STRCOMPUTESUB = ''        
 SET @ISSUBLEVEL = 'NO'        
 IF (@FROMDATE = '' AND @TODATE = '')        
 BEGIN         
  SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM BFOBILLVALAN         
 END         
 IF (@REPORTNAME = 'NETPOSITION')        
 BEGIN        
  IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END        
  IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END        
  IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END        
  IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END        
  IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END        
  IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END        
  IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END        
         
  IF @CMCLOSING <> ''         
   BEGIN        
    SET @STRSELECT = @STRSELECT + "SELECT CMCLOSING, "         
   END        
  ELSE        
   BEGIN        
    SET @STRSELECT = @STRSELECT + "SELECT "         
   END        
  SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "        
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   SET @STRSELECTTEMP = ''        
 IF (@GROUPLEVEL = 'PARTY')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
            
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "        
    END        
   END        
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PRODUCT_CODE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME,CLIENT_TYPE, EMAIL,SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
    SET @ISSUBLEVEL = 'YES'        
   END        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   SET @STRSELECTTEMP = ''        
  END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
   IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END        
  END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  --PQTY        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* P.QTY */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --SQTY        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SQTY) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* S.QTY */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --EX_REPORTBY IS ALYAYS 'PRICE' FOR THIS REPORT, SO THE CODE BLOCS FOR 'IF (@EX_REPORTBY = 'PRICE')' AND        
  IF (@EX_REPORTBY = 'STRIKE')        
  BEGIN        
   --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE 'OPT%' THEN "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(PQTY*STRIKE_PRICE) "           
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (PQTY*PRATE) END)) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE 'OPT%' THEN "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SQTY*STRIKE_PRICE) "           
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (SQTY*SRATE) END)) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   --NETQTY - FOR THE NET POS REPORT        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   --NET VALUE- FOR THE NET POS REPORT        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE 'OPT%' THEN "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(PQTY*STRIKE_PRICE) "           
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (PQTY*PRATE) END)) - "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE 'OPT%' THEN "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SQTY*STRIKE_PRICE) "           
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (SQTY*SRATE) END)) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   --AVG. PRICE - FOR THE NET POS REPORT        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN PRODUCT_CODE LIKE 'OPT%' THEN "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(PQTY*STRIKE_PRICE) "           
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (PQTY*PRATE) END)) - "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE 'OPT%' THEN "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SQTY*STRIKE_PRICE) "           
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (SQTY*SRATE) END)) ) /  "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  END        
          
  IF (@EX_RATE = 'MKTRATE')        
  BEGIN        
   --IF (@EX_REPORTBY = 'BOTH') ARE OMITED        
   IF (@EX_REPORTBY = 'PRICE')        
   BEGIN        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PRATE*PQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(SRATE*SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        

    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NET VALUE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PRATE*PQTY) - SUM(SRATE*SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(PRATE*PQTY) - SUM(SRATE*SQTY))/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'BOTH')        
   BEGIN        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE+PRATE) *PQTY) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE+SRATE) *SQTY) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NET VALUE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM((STRIKE_PRICE+PRATE) *PQTY) - SUM((STRIKE_PRICE+SRATE) *SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM((STRIKE_PRICE+PRATE) *PQTY) - SUM((STRIKE_PRICE+SRATE) *SQTY))/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
  END /*IF (@EX_RATE = 'NETRATE')*/        
  /*EX_RATE IS ALYAYS 'NETRATE' IN THIS REPORT, SO THE CODE BLOC FOR 'IF (@EX_RATE = 'NETRATE') IS OMITTED*/        
  IF (@EX_RATE = 'NETRATE')        
  BEGIN        
   --IF (@EX_REPORTBY = 'BOTH') ARE OMITED        
   IF (@EX_REPORTBY = 'PRICE')        
   BEGIN        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PAMT)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(SAMT)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
            
    --NETQTY - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NET VALUE- FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PAMT) - SUM(SAMT)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(PAMT) - SUM(SAMT))/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'BOTH')        
   BEGIN        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE*PQTY)+PAMT) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE*SQTY)+SAMT) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NET VALUE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM((STRIKE_PRICE*PQTY)+PAMT) - SUM((STRIKE_PRICE*SQTY)+SAMT)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE - FOR THE NET POS REPORT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM((STRIKE_PRICE*PQTY)+PAMT) - SUM((STRIKE_PRICE*SQTY)+SAMT))/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
  END /*IF (@EX_RATE = 'NETRATE')*/     
  --NET OPEN VALUE (CL. PRICE)        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM((PQTY - SQTY)*CL_RATE)  "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET OPEN VALUE (CL. PRICE) */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETOPENVALUE, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --CL. PRICE        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "  (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END )"        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* CL. PRICE */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEPRICE "          
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  SET @STRSELECTTEMP = ''        
  SET @STRFROM = @STRFROM + "FROM "        
 SET @STRFROM = @STRFROM + "BFOBILLVALAN "        
         
  SET @STRWHERE = @STRWHERE + "WHERE "        
         
  SET @STRWHERE = @STRWHERE + "PRODUCT_CODE LIKE '" + @PRODUCT_CODE + "' AND "        
  SET @STRWHERE = @STRWHERE + "PRODUCT_TYPE LIKE '" + @PRODUCT_TYPE + "' AND "        
  IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END        
  SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "        
  SET @STRWHERE = @STRWHERE + "SERIES_CODE LIKE '" + @SERIES_CODE + "' AND "        
  IF (@FROMCODE = '' AND @TOCODE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " >= '" + @FROMCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + @CODEID + " <= '" + @TOCODE + "' AND "        
  END        
  IF (@FROMDATE = '' AND @TODATE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "        
  END        
  IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "        
  END        
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/
  SET @COMMA = ''        
  SET @STRGROUPBY = @STRGROUPBY + @COMMA        
          
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   IF (@GROUPLEVEL = 'PARTY')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
          
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "PRODUCT_CODE "*/ END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PRODUCT_CODE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL, SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, "        
    SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "        
   END        
  END /*IF (@ONEORMANY = 'DETAIL')*/        
  ELSE /*IF (@ONEORMANY = 'DETAIL')*/        
  BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
   IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME " END        
  END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
  SET @STRORDERBY = @STRGROUPBY         
  IF @CMCLOSING <> ''         
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY  + ",CMCLOSING "        
   END        
  SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY  + " HAVING SUM(PQTY - SQTY) <> 0 "        
  SET @STRORDERBY = "ORDER BY " + @STRORDERBY        
 END/*IF (@REPORTNAME = "NETPOSITION")*/        
 IF @STRCOMPUTESUB <> ''         
 BEGIN         
  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB         
  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB        
 END        
        
 IF (@ISSUBLEVEL = 'YES')        
 BEGIN        
  PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)        
 END        
 ELSE        
 BEGIN        
  PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)        
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWREPORTS
-- --------------------------------------------------
CREATE PROC        
[DBO].[RPT_PROC_FO_NEWREPORTS]        
 @REPORTNAME VARCHAR(50),        
 @STATUSID VARCHAR(20),        
 @STATUSNAME VARCHAR(50),        
 @GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT        
 @GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FROMDATE VARCHAR(11),        
 @TODATE VARCHAR(11),        
 @WHATCODE VARCHAR(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FROMCODE VARCHAR(20),        
 @TOCODE VARCHAR(20),        
 @FROMPARTYCODE VARCHAR(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @TOPARTYCODE VARCHAR(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @ONEORMANY VARCHAR(20),        
 @PRODUCTCODE VARCHAR(20),  --]        
 @SERIESCODE VARCHAR(20), --]        
 @STRIKEPRICE MONEY,  --]--> PRIMARY SEARCH FIELDS.        
 @EXPIRYDATE VARCHAR(11), --]        
 @PRODUCTTYPE VARCHAR(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]        
 @EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @EX_RATE VARCHAR(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @EX_POSITION VARCHAR (1), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @DUMMY001 VARCHAR(50),        
 @DUMMY002 VARCHAR(50),        
 @DUMMY003 VARCHAR(50),    
 @DUMMY004 VARCHAR(50),        
 @DUMMY005 VARCHAR(50),        
 @DUMMY006 VARCHAR(50),        
 @DUMMY007 VARCHAR(50),        
 @DUMMY008 VARCHAR(50),        
 @DUMMY009 VARCHAR(50),        
 @DUMMY010 VARCHAR(50)        
AS        
DECLARE        
 @STRSELECT VARCHAR(8000),        
 @STRSELECTTEMP VARCHAR(8000),        
 @STRFROM VARCHAR(8000),        
 @STRWHERE VARCHAR(8000),        
 @STRGROUPBY VARCHAR(8000),        
 @STRORDERBY VARCHAR(8000),        
 @STRCOMPUTE VARCHAR(8000),        
 @STRCOMPUTESUB VARCHAR(8000),        
 @STRHAVING VARCHAR(2000),        
 @ISSUBLEVEL VARCHAR(3),        
 @CODEID VARCHAR(20),        
 @COMMA VARCHAR(1)        
 SET @PRODUCTCODE = @PRODUCTCODE+"%"         
 IF @SERIESCODE = '' BEGIN SET @SERIESCODE = "%" END        
 --IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE        
 IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END        
 IF @PRODUCTTYPE = '' BEGIN SET @PRODUCTTYPE = "%" END        
 IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END        
 IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END        
 IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END        
 SET @STRSELECT = ''        
 SET @STRSELECTTEMP = ''        
 SET @STRFROM = ''        
 SET @STRWHERE = ''        
 SET @STRGROUPBY = ''        
 SET @STRORDERBY = ''        
 SET @STRCOMPUTE = ''        
 SET @STRCOMPUTESUB = ''        
 SET @ISSUBLEVEL = 'NO'        
         
 IF (@FROMDATE = '' AND @TODATE = '')        
 BEGIN         
  SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM BFOBILLVALAN         
 END         
 IF (@REPORTNAME = 'SAUDASUMMARY')        
 BEGIN        
  IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END        
  IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END        
  IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END        
  IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END        
  IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END        
  IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END        
  IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END        
          
  SET @STRSELECT = @STRSELECT + "SELECT "        
  SET @STRCOMPUTE = @STRCOMPUTE + " COMPUTE "        
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   SET @STRSELECTTEMP = ''        
   IF (@GROUPLEVEL = 'PARTY')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,20) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
            
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "        
    END        
   END        
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,20) AS PARTY_NAME, CLIENT_TYPE,  EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     --SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "        
IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,20) AS PARTY_NAME, CLIENT_TYPE,  EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + " YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,20) AS PARTY_NAME, CLIENT_TYPE,  EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     --SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PRODUCT_CODE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,20) AS PARTY_NAME, CLIENT_TYPE, EMAIL, SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "        
    SET @ISSUBLEVEL = 'YES'        
   END        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   SET @STRSELECTTEMP = ''        
  END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
   IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, LEFT(PARTY_NAME,20) AS PARTY_NAME, CLIENT_TYPE, EMAIL, " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END        
  END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  --OPENQTY        
  SET @STRSELECTTEMP = ''        
  IF @GROUPSUBLEVEL = 'DATE'         
  BEGIN        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN /*SAUDA_DATE LIKE '" + @FROMDATE + "%' AND*/ TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "         
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPEN QTY */ " --FOR THE SUB TOTAL        
  END        
  ELSE        
  BEGIN        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "         
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPEN QTY */ " --FOR THE SUB TOTAL        
  END        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPENQTY, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --PQTY        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* P.QTY */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --SQTY        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* S.QTY */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  IF (@EX_RATE = 'MKTRATE')        
  BEGIN        
   IF (@EX_REPORTBY = 'STRIKE')        
   BEGIN        
    --PAMT - MKTRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
          
    --PRATE - MKTRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PRATE - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SAMT - MKTRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --SRATE - MKTRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SRATE - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETAMT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'PRICE')        
   BEGIN        
    --PAMT - MKTRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --PRATE - MKTRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PRATE - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SAMT - MKTRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SRATE - MKTRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SRATE - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETAMT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'BOTH')        
   BEGIN        
    --PAMT - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --PRATE - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SAMT - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --SRATE - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETAMT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) )/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
  END /*IF (@EX_RATE = 'MKTRATE')*/        
  IF (@EX_RATE = 'NETRATE')        
  BEGIN        
   IF (@EX_REPORTBY = 'STRIKE')        
   BEGIN        
    --PAMT - NETRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --PRATE - NETRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PRATE - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SAMT - NETRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SRATE - NETRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SRATE - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETAMT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'PRICE')        
   BEGIN        
    --PAMT - NETRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --PRATE - NETRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"        
SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PRATE - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --SAMT - NETRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --SRATE - NETRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SQTY - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETAMT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END))) / "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'BOTH')        
   BEGIN        
    --PAMT - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --PRATE - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
    --SAMT - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --SRATE - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETQTY        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --NETAMT        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --AVG. PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END))) / "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
  END /*IF (@EX_RATE = 'NETRATE')*/        
  --CLOSEQTY        
  SET @STRSELECTTEMP = ''        
  IF @GROUPSUBLEVEL = 'DATE'         
  BEGIN        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN /*SAUDA_DATE LIKE '" + @FROMDATE + "%' AND*/ TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "         
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "         
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* CLOSEQTY */ " --FOR THE SUB TOTAL        
  END        
  ELSE        
  BEGIN        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "         
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "         
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* CLOSEQTY */ " --FOR THE SUB TOTAL        
  END        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEQTY, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --PROFIT/LOSS        
  IF (@EX_RATE = 'NETRATE')        
  BEGIN        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT)  - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* PROFIT/LOSS */ "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "        
   IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP') 
     BEGIN      
        SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ) "       
     END      
  ELSE      
   BEGIN      
       SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = 0 "       
   END      
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  END        
  ELSE        
  BEGIN        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT + PBROKAMT + SBROKAMT) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* PROFIT/LOSS */ "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "        
     IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')  
     BEGIN      
          SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ) "       
     END      
     ELSE      
     BEGIN      
          SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = 0 "       
     END      
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  END        
  SET @STRSELECTTEMP = ""        
  SET @STRFROM = @STRFROM + "FROM "        
  SET @STRFROM = @STRFROM + "BFOBILLVALAN "        
         
  SET @STRWHERE = @STRWHERE + "WHERE "         
  SET @STRWHERE = @STRWHERE + "PRODUCT_CODE LIKE '" + @PRODUCTCODE + "' AND "        
  SET @STRWHERE = @STRWHERE + "PRODUCT_TYPE LIKE '" + @SERIESCODE + "' AND "        
  IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END        
  SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "        
  SET @STRWHERE = @STRWHERE + "SERIES_CODE LIKE '" + @PRODUCTTYPE + "' AND "        
  SET @STRWHERE = @STRWHERE + "AUCTIONPART LIKE '" + @EX_AUCTIONPART + "' AND  "        
  IF (@FROMCODE = '' AND @TOCODE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " >= '" + @FROMCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + @CODEID + " <= '" + @TOCODE + "' AND "        
  END        
  IF (@FROMDATE = '' AND @TODATE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "        
  END        
  IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "        
  END        
          
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/
  SET @COMMA = ''        
  SET @STRGROUPBY = @STRGROUPBY + @COMMA        
          
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   IF (@GROUPLEVEL = 'PARTY')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
           
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "PRODUCT_CODE "*/ END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PRODUCT_CODE"        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL, SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, "        
    SET @STRGROUPBY = @STRGROUPBY + "PRODUCT_TYPE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) ,SAUDA_DATE "        
   END        
  END /*IF (@ONEORMANY = 'DETAIL')*/        
  ELSE /*IF (@ONEORMANY = 'DETAIL')*/        
  BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
   IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY,FAMILYNAME " END        
  END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
  SET @STRORDERBY = @STRGROUPBY        
  SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY        
  SET @STRORDERBY = " ORDER BY  " + @STRORDERBY        
         
  SET @STRHAVING = ' HAVING '         
  IF (@EX_RATE = 'NETRATE')        
  BEGIN        
   SET @STRHAVING = @STRHAVING +" SUM(SBILLAMT - PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) <> 0 "        
  END        
  ELSE        
  BEGIN        
   SET @STRHAVING = @STRHAVING + " SUM(SBILLAMT - PBILLAMT + PBROKAMT + SBROKAMT) <> 0 "        
  END         
 END/*IF (@REPORTNAME = "SAUDASUMMARY")*/        
 IF @STRCOMPUTESUB <> ''         
 BEGIN         
  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB         
  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB        
 END        
 IF (@ISSUBLEVEL = 'YES')        
 BEGIN        
  PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY  + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY  + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)        
 END        
 ELSE        
 BEGIN        
  PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY  + @STRORDERBY + @STRCOMPUTE)        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY  + @STRORDERBY + @STRCOMPUTE)        
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWREPORTSSEARCH
-- --------------------------------------------------
--EXEC RPT_PROC_FO_NEWREPORTSSEARCH 'BROKER', 'BROKER', 'PRODUCTCODE', '', 'CLIENT', '0', 'ZZZ', '', '', 'FEB 16 2006', 'FEB 16 2006', '', '', '', '', -1, '', '', '', '', '', '', '', '', '', '', 'FALSE'
CREATE     PROC
[DBO].[RPT_PROC_FO_NEWREPORTSSEARCH]
@STRSTATUSID VARCHAR (20),
@STRSTATUSNAME VARCHAR (20),
@STRIDENTIFIER VARCHAR(20),
@STRSEARCHSTRING VARCHAR(50),
@STRREPORTFOR VARCHAR(25),
@STRFROMCODE VARCHAR(25),
@STRTOCODE VARCHAR(25),
@STRFROMPARTYCODE VARCHAR(25),
@STRTOPARTYCODE VARCHAR(25),
@STRFROMDATE VARCHAR(25),
@STRTODATE VARCHAR(25),
@STRPRODUCTCODE VARCHAR(25),
@STRSERIESCODE VARCHAR(25),
@STREXPIRYDATE VARCHAR(25),
@STRPRODUCTTYPE VARCHAR(25),
@STRSTRIKEPRICE MONEY,
@STRAUCTIONPART VARCHAR(25),
@STRDUMMY001 VARCHAR(25),
@STRDUMMY002 VARCHAR(25),
@STRDUMMY003 VARCHAR(25),
@STRDUMMY004 VARCHAR(25),
@STRDUMMY005 VARCHAR(25),
@STRDUMMY006 VARCHAR(25),
@STRDUMMY007 VARCHAR(25),
@STRDUMMY008 VARCHAR(25),
@STRDUMMY009 VARCHAR(25),
@BLNFROMUPDATEPAGE VARCHAR(25)
AS
--EXEC RPT_PROC_FO_NEWREPORTSSEARCH 'BROKER', 'BROKER', 'PRODUCTCODE', '', 'CLIENT', '0', 'ZZZ', '', '', 'FEB 16 2006', 'FEB 16 2006', '', '', '', '', -1, '', '', '', '', '', '', '', '', '', '', 'FALSE'
DECLARE
	@STRSQL VARCHAR(8000),
	@STRWHATTOLIST VARCHAR(50)
	SET @STRPRODUCTCODE = @STRPRODUCTCODE+"%" 
	IF (@STRREPORTFOR = 'AREA')  BEGIN SET @STRWHATTOLIST = "AREA" END
	IF (@STRREPORTFOR = 'REGION')  BEGIN SET @STRWHATTOLIST = "REGION" END
	IF (@STRREPORTFOR = 'BRANCH')  BEGIN SET @STRWHATTOLIST = "BRANCH_CODE" END
	IF (@STRREPORTFOR = 'SUBBROKER')  BEGIN SET @STRWHATTOLIST = "SUB_BROKER" END
	IF (@STRREPORTFOR = 'TRADER')  BEGIN SET @STRWHATTOLIST = "TRADER" END
	IF (@STRREPORTFOR = 'FAMILY')  BEGIN SET @STRWHATTOLIST = "FAMILY" END
	IF (@STRREPORTFOR = 'CLIENT')  BEGIN SET @STRWHATTOLIST = "PARTY_CODE" END
	IF (@BLNFROMUPDATEPAGE = 'FALSE')
	BEGIN
		--FROM CODE
		IF (@STRIDENTIFIER = 'FROMCODE')
		BEGIN
			IF (@STRREPORTFOR = 'CLIENT')
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE, PARTY_NAME FROM BFOBILLVALAN WHERE "
			END
			ELSE
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM BFOBILLVALAN WHERE "
			END
			--SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM BFOBILLVALAN WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRTOCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		--TO CODE
		IF (@STRIDENTIFIER = 'TOCODE')
		BEGIN
			IF (@STRREPORTFOR = 'CLIENT')
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE, PARTY_NAME FROM BFOBILLVALAN WHERE "
			END
			ELSE
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM BFOBILLVALAN WHERE "
			END
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		--FROM DATE
		IF (@STRIDENTIFIER = 'FROMDATE')
		BEGIN
			--SET @STRWHATTOLIST = 'SAUDA_DATE'
			SET @STRSQL = "SELECT DISTINCT SAUDA_DATE, CONVERT(VARCHAR, SAUDA_DATE, 103) AS FROM_CODE FROM BFOBILLVALAN WHERE "
			SET @STRSQL = @STRSQL + "SAUDA_DATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRTODATE <> '' BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
		
			IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
		
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--TO DATE
		IF (@STRIDENTIFIER = 'TODATE')
		BEGIN
			--SET @STRWHATTOLIST = 'SAUDA_DATE'
			SET @STRSQL = "SELECT DISTINCT SAUDA_DATE, CONVERT(VARCHAR, SAUDA_DATE, 103) AS FROM_CODE FROM BFOBILLVALAN  WHERE "
			SET @STRSQL = @STRSQL + "SAUDA_DATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRFROMDATE <> '' BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
	
			IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
	
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + "' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + "' " END
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--INSTTYPE
		IF (@STRIDENTIFIER = 'PRODUCTCODE')
		BEGIN
			--SET @STRWHATTOLIST = 'PRODUCT_CODE'
			SET @STRSQL = "SELECT DISTINCT F2.PRODUCT_CODE AS FROM_CODE FROM BFOSCRIP2 F2  WHERE "
			SET @STRSQL = @STRSQL + "F2.PRODUCT_CODE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			--IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--SERIES_CODE
		IF (@STRIDENTIFIER = 'SERIESCODE')
		BEGIN
			--SET @STRWHATTOLIST = 'SERIES_CODE'
			SET @STRSQL = "SELECT DISTINCT F2.SERIES_CODE AS FROM_CODE FROM BFOSCRIP2 F2  WHERE "
			SET @STRSQL = @STRSQL + "F2.SERIES_CODE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			--IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--EXPIRY DATE
		IF (@STRIDENTIFIER = 'EXPIRYDATE')
		BEGIN
			--SET @STRWHATTOLIST = 'EXPIRYDATE'
			SET @STRSQL = "SELECT DISTINCT CONVERT(VARCHAR, F2.EXPIRYDATE, 103) AS FROM_CODE FROM BFOSCRIP2 F2  WHERE "
			SET @STRSQL = @STRSQL + "F2.EXPIRYDATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			--IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE = '" + @STREXPIRYDATE + "' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--OPTION TYPE
		IF (@STRIDENTIFIER = 'PRODUCTTYPE')
		BEGIN
			--SET @STRWHATTOLIST = 'PRODUCT_CODE'
			SET @STRSQL = "SELECT DISTINCT F2.PRODUCT_TYPE AS FROM_CODE FROM BFOSCRIP2 F2  WHERE "
			SET @STRSQL = @STRSQL + "F2.PRODUCT_TYPE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			--IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--STRIKE PRICE
		IF (@STRIDENTIFIER = 'STRIKEPRICE')
		BEGIN
			--SET @STRWHATTOLIST = 'STRIKE_PRICE'
			SET @STRSQL = "SELECT DISTINCT F2.STRIKE_PRICE AS FROM_CODE FROM BFOSCRIP2 F2  WHERE "
			SET @STRSQL = @STRSQL + "CONVERT(VARCHAR, F2.STRIKE_PRICE) LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRPRODUCTCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE LIKE  '" + @STRPRODUCTCODE + "' " END
			IF (@STRSERIESCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SERIES_CODE = '" + @STRSERIESCODE + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STRPRODUCTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND PRODUCT_CODE = '" + @STRPRODUCTTYPE + "' " END
			--IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		IF @STRSTATUSID = 'BROKER'
		BEGIN
		  SET @STRSQL = @STRSQL + " AND 1=1 "
		END
		ELSE
		BEGIN
		SET @STRSQL = @STRSQL + "AND AREA LIKE (CASE WHEN '" + @STRSTATUSID + "' = 'AREA' THEN '" + @STRSTATUSNAME + "' ELSE '%' END) "
		SET @STRSQL = @STRSQL + "AND REGION LIKE (CASE WHEN '" + @STRSTATUSID + "' = 'REGION' THEN '" + @STRSTATUSNAME + "' ELSE '%' END) "
		SET @STRSQL = @STRSQL + "AND BRANCH_CODE LIKE (CASE WHEN '" + @STRSTATUSID + "' = 'BRANCH' THEN '" + @STRSTATUSNAME + "' ELSE '%' END) "
		SET @STRSQL = @STRSQL + "AND SUB_BROKER LIKE (CASE WHEN '" + @STRSTATUSID + "' = 'SUBBROKER' THEN '" + @STRSTATUSNAME + "' ELSE '%' END) "
		SET @STRSQL = @STRSQL + "AND TRADER LIKE (CASE WHEN '" + @STRSTATUSID + "' = 'TRADER' THEN '" + @STRSTATUSNAME + "' ELSE '%' END) "
		SET @STRSQL = @STRSQL + "AND FAMILY LIKE (CASE WHEN '" + @STRSTATUSID + "' = 'FAMILY' THEN '" + @STRSTATUSNAME + "' ELSE '%' END) "
		SET @STRSQL = @STRSQL + "AND PARTY_CODE LIKE (CASE WHEN '" + @STRSTATUSID + "' = 'CLIENT' THEN '" + @STRSTATUSNAME + "' ELSE '%' END) "
		END
		/*END - LOGIN CONDITIONS*/
	END --IF (@BLNFROMUPDATEPAGE = 'FALSE')
	ELSE --IF (@BLNFROMUPDATEPAGE = 'FALSE')
	BEGIN
		IF (@STRIDENTIFIER = 'FROMCODE')
		BEGIN
			SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM CLIENT2 WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRTOCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
		END
		IF (@STRIDENTIFIER = 'TOCODE')
		BEGIN
			SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM CLIENT2 WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
		END
	END --ELSE OF IF (@BLNFROMUPDATEPAGE = 'FALSE')
	SET @STRSQL = @STRSQL + "ORDER BY (1)"
	PRINT @STRSQL
	EXEC(@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWTURNOVER
-- --------------------------------------------------
CREATE       PROC        
[DBO].[RPT_PROC_FO_NEWTURNOVER]        
 @REPORTNAME VARCHAR(50),        
 @STATUSID VARCHAR(20),        
 @STATUSNAME VARCHAR(50),        
 @GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT        
 @GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FROMDATE VARCHAR(11),        
 @TODATE VARCHAR(11),        
 @WHATCODE VARCHAR(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FROMCODE VARCHAR(20),        
 @TOCODE VARCHAR(20),        
 @FROMPARTYCODE VARCHAR(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @TOPARTYCODE VARCHAR(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @ONEORMANY VARCHAR(20),        
 @PRODUCTCODE VARCHAR(20),  --]        
 @PRODUCTTYPE VARCHAR(20), --]        
 @STRIKEPRICE MONEY,  --]--> PRIMARY SEARCH FIELDS.        
 @EXPIRYDATE VARCHAR(11), --]        
 @SERIESCODE VARCHAR(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]        
 @EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @EX_RATE VARCHAR(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @EX_POSITION VARCHAR (1), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @ULCLRATE VARCHAR(50),        
 @CLTRANSACTIONS VARCHAR(50),        
 @DUMMY003 VARCHAR(50),        
 @DUMMY004 VARCHAR(50),        
 @DUMMY005 VARCHAR(50),        
 @DUMMY006 VARCHAR(50),        
 @DUMMY007 VARCHAR(50),        
 @DUMMY008 VARCHAR(50),        
 @DUMMY009 VARCHAR(50),        
 @DUMMY010 VARCHAR(50)        
AS        

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE        
 @STRSELECT VARCHAR(8000),        
 @STRSELECTTEMP VARCHAR(8000),        
 @STRFROM VARCHAR(8000),        
 @STRWHERE VARCHAR(8000),        
 @STRGROUPBY VARCHAR(8000),        
 @STRORDERBY VARCHAR(8000),        
 @STRCOMPUTE VARCHAR(8000),        
 @STRCOMPUTESUB VARCHAR(8000),        
 @ISSUBLEVEL VARCHAR(3),        
 @CODEID VARCHAR(20),        
 @COMMA VARCHAR(1)        
 SET @PRODUCTCODE = @PRODUCTCODE+"%"         
 IF @PRODUCTTYPE = '' BEGIN SET @PRODUCTTYPE = "%" END        
 --IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE        
 IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END        
 IF @SERIESCODE = '' BEGIN SET @SERIESCODE = "%" END        
         
 IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END        
 IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END        
 IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END        
 SET @STRSELECT = ''        
 SET @STRSELECTTEMP = ''        
 SET @STRFROM = ''        
 SET @STRWHERE = ''        
 SET @STRGROUPBY = ''        
 SET @STRORDERBY = ''        
 SET @STRCOMPUTE = ''        
 SET @STRCOMPUTE = ''        
 SET @STRCOMPUTESUB = ''        
 SET @ISSUBLEVEL = 'NO'        
 IF (@FROMDATE = '' AND @TODATE = '')        
 BEGIN    
  SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM BFOBILLVALAN         
 END         
 IF (@REPORTNAME = 'TURNOVER')        
 BEGIN        
  IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END        
  IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END        
  IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END        
  IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END        
  IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END        
  IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END        
  IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END        
          
  SET @STRSELECT = @STRSELECT + "SELECT "        
  SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "        
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   SET @STRSELECTTEMP = ''        
   IF (@GROUPLEVEL = 'PARTY')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
            
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "        
    END        
   END        
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'PRODUCT')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_CODE, "        
    IF (@GROUPSUBLEVEL = 'PARTY')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'SCRIP')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@GROUPSUBLEVEL = 'DATE')        
    BEGIN        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
     SET @ISSUBLEVEL = 'YES'        
    END        
    IF (@ISSUBLEVEL = 'YES')        
    BEGIN        
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PRODUCT_CODE "        
    END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, SERIES_CODE, PRODUCT_CODE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PRODUCT_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "        
    SET @ISSUBLEVEL = 'YES'        
   END        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   SET @STRSELECTTEMP = ''        
  END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
  BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
   IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END        
  END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/        
          
  IF (@EX_RATE = 'MKTRATE')        
  BEGIN        
   --FUTURES TRADED VALUE - MKTRATE - COMMON        
   SET @STRSELECTTEMP = ''        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART <> 'EA'  /*AND AUCTIONPART <> 'CA'*/ "        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) "        
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FUTURESTRADEDVALUE, "        
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   IF (@EX_REPORTBY = 'STRIKE')        
   BEGIN        
    --OPTIONS TRADED AMT - MKTRATE + STRIKE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((PQTY+SQTY)*STRIKE_PRICE ) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE        
    IF (@ULCLRATE = 'EX')        
    BEGIN        
     SET @STRSELECTTEMP = ''        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE ) ELSE 0 END)) "        
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     SET @STRSELECTTEMP = '0 '        
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    END        
    ELSE /*OF IF (@ULCLRATE = 'EX')*/        
    BEGIN        
     --ASSIGNED AMT - ASG/BOTH + STRIKE        
     IF (@ULCLRATE = 'ASG')        
     BEGIN        
      SET @STRSELECTTEMP = '0 '        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END        
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE        
         
     BEGIN        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/        
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART <> 'CA' ) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) + "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' ) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PQTY+SQTY)*STRIKE_PRICE ,0) ELSE 0 END))  "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'PRICE')        
   BEGIN        
    --OPTIONS TRADED AMT - MKTRATE + PRICE        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY*PRATE )+(SQTY*SRATE ))) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + PRICE        
    IF (@ULCLRATE = 'EX')        
    BEGIN        
     SET @STRSELECTTEMP = ''        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE ) ELSE 0 END)) "        
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     SET @STRSELECTTEMP = '0 '        
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    END        
    ELSE /*OF IF (@ULCLRATE = 'EX')*/        
    BEGIN        
     --ASSIGNED AMT - ASG/BOTH + PRICE        
     IF (@ULCLRATE = 'ASG')        
     BEGIN        
      SET @STRSELECTTEMP = '0 '        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END        
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE        
         
     BEGIN        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/        
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART <> 'CA' ) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) + "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' ) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END))  "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'BOTH')        
   BEGIN        
    --OPTIONS TRADED AMT - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY+SQTY)*STRIKE_PRICE ) + (PQTY*PRATE )+(SQTY*SRATE )) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH        
    IF (@ULCLRATE = 'EX')        
    BEGIN        
     SET @STRSELECTTEMP = ''        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE) ) ELSE 0 END)) "        
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     SET @STRSELECTTEMP = '0 '        
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    END        
    ELSE /*OF IF (@ULCLRATE = 'EX')*/        
    BEGIN        
     --ASSIGNED AMT - ASG/BOTH + BOTH        
     IF (@ULCLRATE = 'ASG')        
     BEGIN        
      SET @STRSELECTTEMP = '0 '        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE) ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END        
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE        
         
     BEGIN        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE) ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE) ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/        
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART <> 'CA' ) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) + "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' ) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PRATE+STRIKE_PRICE)*PQTY + (SRATE+STRIKE_PRICE)*SQTY,0) ELSE 0 END))  "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
   IF (@EX_REPORTBY = 'EXCHG')        
   BEGIN        
    --OPTIONS TRADED AMT - MKTRATE + BOTH        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY*PRATE )+(SQTY*SRATE ))) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH        
    IF (@ULCLRATE = 'EX')        
    BEGIN        
     SET @STRSELECTTEMP = ''        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE ) ELSE 0 END)) "         
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     SET @STRSELECTTEMP = '0 '        
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    END        
    ELSE /*OF IF (@ULCLRATE = 'EX')*/        
    BEGIN        
     --ASSIGNED AMT - ASG/BOTH + BOTH        
     IF (@ULCLRATE = 'ASG')        
     BEGIN        
      SET @STRSELECTTEMP = '0 '        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
         
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END        
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE        
         
     BEGIN        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
      SET @STRSELECTTEMP = ''        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE ) ELSE 0 END)) "        
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "        
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/        
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
    SET @STRSELECTTEMP = ''        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%FUT' AND AUCTIONPART <> 'CA' ) "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) + "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA') "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY  + SRATE*SQTY ,0) ELSE 0 END)) + "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(STRIKE_PRICE*PQTY  + STRIKE_PRICE*SQTY ,0) ELSE 0 END))  "        
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "        
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   END        
  END /*IF (@EX_RATE = 'NETRATE')*/        
  --BROKERAGE        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "ISNULL(SUM(PBROKAMT + SBROKAMT),0) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* BROKERAGE */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKERAGE, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --SERVICE TAX        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "ISNULL(SUM(SERVICE_TAX- EXSER_TAX),0) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SERVICE TAX */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SERVICETAX, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    
   --INS_CHRG       
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(INS_CHRG) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SERVICE TAX */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS INS_CHRG, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
   
  --TURNOVER TAX        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(TURN_TAX) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* TURNOVER TAX */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TURNOVERTAX, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --SEBI TAX        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SEBI_TAX) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SEBI TAX */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SEBITAX, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --STAMP DUTY        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(BROKER_NOTE) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* STAMP DUTY */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS STAMPDUTY, "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  --CLEARING CHARGES        
  SET @STRSELECTTEMP = ''        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(OTHER_CHRG) "        
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* CLEARING CHARGES */ " --FOR THE SUB TOTAL        
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "        
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
  SET @STRFROM = @STRFROM + "FROM "        
  SET @STRFROM = @STRFROM + "BFOBILLVALAN "        
         
  SET @STRWHERE = @STRWHERE + "WHERE "        
  SET @STRWHERE = @STRWHERE + "TRADETYPE = 'BT' AND "        
         
  SET @STRWHERE = @STRWHERE + "PRODUCT_CODE LIKE '" + @PRODUCTCODE + "' AND "        
  SET @STRWHERE = @STRWHERE + "PRODUCT_TYPE LIKE '" + @PRODUCTTYPE + "' AND "        
  IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END        
  SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "        
  SET @STRWHERE = @STRWHERE + "SERIES_CODE LIKE '" + @SERIESCODE + "' AND "        
  IF (@FROMCODE = '' AND @TOCODE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + @CODEID + " >= '" + @FROMCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + @CODEID + " <= '" + @TOCODE + "' AND "        
  END        
  IF (@FROMDATE = '' AND @TODATE = '')        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "        
  END        
  ELSE        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "        
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "        
  END        
  IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))        
  BEGIN        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "        
   SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "        
  END        
  /*LOGIN CONDITIONS*/        
  SET @STRWHERE = @STRWHERE + "AREA LIKE (CASE WHEN '" + @STATUSID + "' = 'AREA' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "        
  SET @STRWHERE = @STRWHERE + "REGION LIKE (CASE WHEN '" + @STATUSID + "' = 'REGION' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "        
  SET @STRWHERE = @STRWHERE + "BRANCH_CODE LIKE (CASE WHEN '" + @STATUSID + "' = 'BRANCH' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "        
  SET @STRWHERE = @STRWHERE + "SUB_BROKER LIKE (CASE WHEN '" + @STATUSID + "' = 'SUBBROKER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "        
  SET @STRWHERE = @STRWHERE + "TRADER LIKE (CASE WHEN '" + @STATUSID + "' = 'TRADER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "        
  SET @STRWHERE = @STRWHERE + "FAMILY LIKE (CASE WHEN '" + @STATUSID + "' = 'FAMILY' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "        
  SET @STRWHERE = @STRWHERE + "PARTY_CODE LIKE (CASE WHEN '" + @STATUSID + "' = 'CLIENT' THEN '" + @STATUSNAME + "' ELSE '%' END) "        
  /*END - LOGIN CONDITIONS*/        
  SET @COMMA = ''        
  SET @STRGROUPBY = @STRGROUPBY + @COMMA        
          
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))        
  BEGIN        
   IF (@GROUPLEVEL = 'PARTY')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
           
   IF (@GROUPLEVEL = 'SCRIP')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "PRODUCT_CODE "*/ END        
   END        
         
   IF (@GROUPLEVEL = 'DATE')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'PRODUCT') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PRODUCT_CODE " END        
   END        
         
   IF (@GROUPLEVEL = 'PRODUCT')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PRODUCT_CODE "        
    SET @COMMA = ', '        
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, PRODUCT_TYPE " END        
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END        
   END        
         
   IF (@GROUPLEVEL = 'PSD')        
   BEGIN        
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL, SERIES_CODE, PRODUCT_CODE, EXPIRYDATE, STRIKE_PRICE, "        
    SET @STRGROUPBY = @STRGROUPBY + "PRODUCT_TYPE, SAUDA_DATE "        
   END        
  END /*IF (@ONEORMANY = 'DETAIL')*/        
  ELSE /*IF (@ONEORMANY = 'DETAIL')*/        
  BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
   IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END        
   IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END        
   IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END        
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END        
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END        
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END        
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME " END        
  END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/        
  SET @STRORDERBY = @STRGROUPBY        
  SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY        
  SET @STRORDERBY = "ORDER BY " + @STRORDERBY        
 END/*IF (@REPORTNAME = "NETPOSITION")*/        
 IF @STRCOMPUTESUB <> ''         
 BEGIN         
  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB         
  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB        
 END        
 IF (@ISSUBLEVEL = 'YES')        
 BEGIN        
  PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)        
 END        
 ELSE        
 BEGIN        
  PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)        
  EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)        
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_REGIONLISTING
-- --------------------------------------------------
CREATE  PROC [DBO].[RPT_REGIONLISTING]
	(
    	@FROMREGION VARCHAR(15),
	@TOREGION VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15)
	)
	
AS
    IF @FROMREGION = '' BEGIN SET @FROMREGION = '0'  END
    IF @TOREGION = '' BEGIN SET @TOREGION = 'ZZZZZZ' END
    IF @FROMBRANCH = '' BEGIN SET @FROMBRANCH = '0'  END
    IF @TOBRANCH = '' BEGIN SET @TOBRANCH = 'ZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
			REGIONCODE = UPPER(REGIONCODE),
			DESCRIPTION = UPPER(DESCRIPTION),
			BRANCH_CODE = UPPER(BRANCH_CODE)

FROM 
    REGION

WHERE
    REGIONCODE BETWEEN @FROMREGION AND @TOREGION
    AND BRANCH_CODE BETWEEN @FROMBRANCH AND @TOBRANCH
    

ORDER BY
		REGIONCODE,DESCRIPTION,BRANCH_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_SBUMASTER
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_SBUMASTER] 
(
	@SBU_CODEFROM VARCHAR(10),
	@SBU_CODETO   VARCHAR(10)
	
)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @SBU_CODEFROM = '' BEGIN SET @SBU_CODEFROM = '0' END
IF @SBU_CODETO = '' BEGIN SET @SBU_CODETO = 'ZZZ' END

BEGIN
	SELECT 
		SBU_CODE,SBU_NAME,SBU_ADDR1,SBU_ADDR2,SBU_ADDR3,SBU_STATE,SBU_CITY,SBU_ZIP,SBU_PHONE1,SBU_PHONE2,SBU_TYPE,SBU_PARTY_CODE  
	FROM 
		SBU_MASTER (NOLOCK)
	WHERE 
		SBU_CODE >= @SBU_CODEFROM
		AND SBU_CODE <= @SBU_CODETO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STAMPDUTY_NEW
-- --------------------------------------------------



CREATE PROC [DBO].[RPT_STAMPDUTY_NEW] (@START_DATE VARCHAR(11), @END_DATE VARCHAR(11))    
 
  
AS    
SELECT    
 TOTAMT = SUM(TRADEQTY * TRADE_PRICE),
 CLIENT1.CL_TYPE,     
 L_STATE       
INTO  
 #STAMPDUTY    
FROM    
 BFOSETTLEMENT, CLIENT2, CLIENT1       
WHERE    
 SAUDA_DATE >= @START_DATE AND SAUDA_DATE <= @END_DATE + ' 23:59'      
 AND BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE           
 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE           
 AND AUCTIONPART NOT LIKE 'C%'    
 AND TRADEQTY > 0          
GROUP BY    
 CLIENT1.CL_TYPE, L_STATE        
  
    
SELECT       
	TOTALAMT = CONVERT(NUMERIC(18,4), SUM(TOTAMT)),    
	CL_TYPE, L_STATE    
INTO
	#STAMPDUTY_REPORT    
FROM   
	#STAMPDUTY   
WHERE
	L_STATE = 'MAHARASHTRA'    
GROUP BY  
	CL_TYPE, L_STATE    
INSERT INTO #STAMPDUTY_REPORT    
SELECT       
	TOTALAMT = SUM(TOTAMT),    
	CL_TYPE,  
	L_STATE = BFOOWNER.STATE    
FROM   
	#STAMPDUTY, BFOOWNER
WHERE
	NOT EXISTS (SELECT STATE FROM STATE_MASTER WHERE STATE = L_STATE )    
GROUP BY   
	CL_TYPE, BFOOWNER.STATE    
INSERT INTO #STAMPDUTY_REPORT    
SELECT       
	TOTALAMT = SUM(TOTAMT),    
	CL_TYPE,  
	L_STATE = 'OTHER'    
FROM
	#STAMPDUTY  
WHERE
	EXISTS (SELECT STATE_MASTER.STATE FROM STATE_MASTER, BFOOWNER 
		WHERE STATE_MASTER.STATE = L_STATE AND STATE_MASTER.STATE <> BFOOWNER.STATE)    
GROUP BY
	CL_TYPE, L_STATE    
    
SELECT     
	TOTTURN              = ISNULL(SUM(TOTALAMT),0),    
	TOTTURNOTHERSTATE    = ISNULL(SUM(CASE WHEN L_STATE <> 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0),    
	TOTTURNMAHSTATE      = ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0),    
	  
	TOTTURNMAHPRO        = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE = 'PRO' THEN TOTALAMT ELSE 0 END),0)),    
	TOTTURNMAHPROSTAMP   = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE = 'PRO' THEN TOTALAMT ELSE 0 END),0))*.001/100,    
	  
	TOTTURNMAHTRD        = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE <> 'PRO' THEN TOTALAMT ELSE 0 END),0)),    
	TOTTURNMAHTRDSTAMP   = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE <> 'PRO' THEN TOTALAMT ELSE 0 END),0))*.002/100,    
	  
	  
	TOTALMAHSTAMP        = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE = 'PRO' THEN TOTALAMT ELSE 0 END),0))*.001/100    
	                     + PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE <> 'PRO' THEN TOTALAMT ELSE 0 END),0))*.002/100,    
	  
	TOTTURNOTHTRD        = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE <> 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0)),    
	TOTTURNOTHTRDSTAMP   = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE <> 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0))*.002/100,    
	  
	TOTALOTHSTAMP        = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE <> 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0))*.002/100,    
	  
	TOTALSTAMP           = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE = 'PRO' THEN TOTALAMT ELSE 0 END),0))*.001/100    
	                     + PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' AND CL_TYPE <> 'PRO' THEN TOTALAMT ELSE 0 END),0))*.002/100    
	                     + PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE <> 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0))*.002/100 ,   
	  
	TOTTURNMAHTRD_B      = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0)),    
	TOTTURNMAHTRDSTAMP_B = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0))*.002/100,    
	TOTALMAHSTAMP_B      = PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0))*.001/100    
	                     + PRADNYA.DBO.ROUNDEDTOTHOUSAND(ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0))*.002/100    
FROM
	#STAMPDUTY_REPORT    
    
DROP TABLE #STAMPDUTY_REPORT    
DROP TABLE #STAMPDUTY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STAMPDUTY_NEW_REPORT
-- --------------------------------------------------
-- EXEC RPT_STAMPDUTY_NEW_REPORT 'MAY 15 2000','MAY 15 2009','%'



CREATE PROC [DBO].[RPT_STAMPDUTY_NEW_REPORT] (@START_DATE VARCHAR(11), @END_DATE VARCHAR(11), @STATE VARCHAR(50))      
 
	AS        

	SELECT        
	 TOTAMT = SUM(CASE  
	   WHEN AUCTIONPART = 'EA'   
	   THEN  
	   (CASE  
	   WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE
	   ELSE  
		TRADEQTY * MARKETRATE  
	   END)   
	  ELSE 0  
	  END),   
	 TOTALAMT = SUM(CASE  
	   WHEN AUCTIONPART = ''   
	   THEN  
	   (CASE  
	   WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE    
	   ELSE  
		TRADEQTY * MARKETRATE  
	   END)   
	  ELSE 0  
	  END),  
	 BROKCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = 'EA'   
		THEN  
			(CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)
		ELSE  
		0  
		END),   
	 BROKERCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = ''   
		THEN  
			(CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)     
		ELSE  
		0  
		END),  
	 ATSTAMP = CONVERT(NUMERIC(18,4),0),                
	 ADSTAMP = CONVERT(NUMERIC(18,4),0),  
	 CL_TYPE=CLIENT1.CL_TYPE,         
	 L_STATE           
	INTO      
	 #STAMPDUTY        
	FROM        
	 BFOSETTLEMENT, CLIENT2, CLIENT1           
	WHERE        
	 SAUDA_DATE >= @START_DATE AND SAUDA_DATE <= @END_DATE + ' 23:59'          
	 AND BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE               
	 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE               
	 AND TRADEQTY > 0 AND MARKETRATE > 0         
	 AND L_STATE LIKE @STATE 
	GROUP BY        
	 CLIENT1.CL_TYPE, L_STATE            
		
	/*	     
	INSERT INTO #STAMPDUTY          
	SELECT        
	 TOTAMT = SUM(CASE  
	   WHEN AUCTIONPART = 'EA'   
	   THEN  
	   (CASE  
	   WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE    
	   ELSE  
		TRADEQTY * MARKETRATE  
	   END)   
	  ELSE 0  
	  END),   
	 TOTALAMT = SUM(CASE  
	   WHEN AUCTIONPART = ''   
	   THEN  
	   (CASE  
	   WHEN PRODUCT_CODE LIKE '%OPT' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE    
	   ELSE  
		TRADEQTY * MARKETRATE  
	   END)   
	  ELSE 0  
	  END),   
	 BROKCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = 'EA'   
		THEN  
			 (CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)     
		ELSE  
		0  
		END),   
	   
	 BROKERCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = ''   
		THEN  
			(CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)      
		ELSE  
		0  
		END),  
	 ATSTAMP = CONVERT(NUMERIC(18,4),0),                
	 ADSTAMP = CONVERT(NUMERIC(18,4),0),  
	 CL_TYPE=CLIENT1.CL_TYPE,        
	 L_STATE           
	FROM         
	 PRADNYA.DBO.HISTORY_BFOSETTLEMENT_NSEFO, CLIENT2, CLIENT1         
	WHERE      
	 SAUDA_DATE >= @START_DATE AND SAUDA_DATE <= @END_DATE + ' 23:59'          
	 AND PRADNYA.DBO.HISTORY_BFOSETTLEMENT_NSEFO.PARTY_CODE = CLIENT2.PARTY_CODE               
	 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE               
	 AND TRADEQTY > 0 AND MARKETRATE > 0                  
	 AND L_STATE LIKE @STATE  
	 AND BROKERNOTE = 1
	GROUP BY        
	 CLIENT1.CL_TYPE, L_STATE     
	*/	  


	  
	UPDATE #STAMPDUTY SET   
	ATSTAMP = (TOTALAMT * TRDSTAMPDUTY / 100),  
	ADSTAMP = (TOTAMT * DELSTAMPDUTY / 100)  
	FROM STATE_MASTER  
	WHERE L_STATE = STATE  
	  
	UPDATE #STAMPDUTY SET   
	ATSTAMP = (TOTALAMT * TRDSTAMPDUTY / 100),  
	ADSTAMP = (TOTAMT * DELSTAMPDUTY / 100)  
	FROM STATE_MASTER  
	WHERE STATE = 'MAHARASHTRA'  
	AND L_STATE NOT IN (SELECT STATE FROM STATE_MASTER)  
	    
	SELECT   
	L_STATE,    
	PRODELAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'   
		 THEN TOTAMT  
		 ELSE 0  
		   END)),  
	PROTRDAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'   
		 THEN TOTALAMT  
		 ELSE 0  
		   END)),  
	NRMTRDAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN TOTALAMT  
		 ELSE 0  
		   END)),  
	NRMDELAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN TOTAMT  
		 ELSE 0  
		   END)),  
	PROTRD = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'  
		 THEN BROKERCHRG  
		 ELSE 0  
		   END)),  
	PRODEL = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'   
		 THEN BROKCHRG  
		 ELSE 0  
		   END)),  
	NRMTRD = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN BROKERCHRG  
		 ELSE 0  
		   END)),  
	NRMDEL = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN BROKCHRG  
		 ELSE 0  
		   END)),  
	PROTRD1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'    
				 THEN ATSTAMP    
				 ELSE 0  
				END)),  
	PRODEL1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'     
					   THEN ADSTAMP  
					  ELSE 0  
				 END)),      
	  
	NRMTRD1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'     
					  THEN 0    
					  ELSE ATSTAMP  
				END)),  
	  
	NRMDEL1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'     
					  THEN 0           
					  ELSE ADSTAMP       
				 END)),   
	TOTALAMT = CONVERT(NUMERIC(18,4), SUM(TOTAMT + TOTALAMT))    
	  
	INTO #STAMPDUTY_REPORT            
	FROM #STAMPDUTY      
	GROUP BY L_STATE   
	  
	SELECT EXCHANGE='BSE', SEGMENT='FUTURES',*,TOTALSTAMPDUTY = (PROTRD1+PRODEL1+NRMTRD1+NRMDEL1) FROM #STAMPDUTY_REPORT            
	ORDER BY L_STATE  
	  
	DROP TABLE #STAMPDUTY_REPORT        
	DROP TABLE #STAMPDUTY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STT_ANNEXURE
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_STT_ANNEXURE]    
    
 @DATEFROM VARCHAR(11),    
 @DATETO VARCHAR(20),    
 @PARTYFROM VARCHAR(10),    
 @PARTYTO VARCHAR(10),    
 @CONTNOFROM VARCHAR(15),    
 @CONTNOTO VARCHAR(15),      
 @STATUSID VARCHAR(15),      
 @STATUSNAME VARCHAR(25),    
 @STRBRANCH VARCHAR(12),      
 @STRBRANCHTO VARCHAR(12),      
 @STRSUBBROKFROM VARCHAR(12),      
 @STRSUBBROKTO VARCHAR(12)         
    
AS    
SET @DATEFROM = LTRIM(RTRIM(@DATEFROM)) + ' 00:00:00'      
SET @DATETO = LTRIM(RTRIM(@DATETO)) + ' 23:59:59'      
SET @PARTYFROM = LTRIM(RTRIM(@PARTYFROM))      
SET @PARTYTO = LTRIM(RTRIM(@PARTYTO))      
SET @CONTNOFROM = LTRIM(RTRIM(@CONTNOFROM))      
SET @CONTNOTO = LTRIM(RTRIM(@CONTNOTO))      
SET @STATUSID = LTRIM(RTRIM(@STATUSID))      
SET @STATUSNAME = LTRIM(RTRIM(@STATUSNAME))      
SET @STRBRANCH   = LTRIM(RTRIM(@STRBRANCH))      
SET @STRBRANCHTO   = LTRIM(RTRIM(@STRBRANCHTO))      
SET @STRSUBBROKFROM = LTRIM(RTRIM(@STRSUBBROKFROM))      
SET @STRSUBBROKTO = LTRIM(RTRIM(@STRSUBBROKTO))      
    
IF @PARTYTO =''  
        BEGIN  
                SET @PARTYTO = 'ZZZZZZZZZZZ'  
        END   
IF @CONTNOTO = ''  
        BEGIN  
                SET @CONTNOTO = '0'  
        END  
IF @CONTNOTO=''  
        BEGIN  
                SET @CONTNOTO = '99999999999'  
        END      
      
IF LEN(LTRIM(RTRIM(@STRBRANCHTO))) = ''       
BEGIN       
 SET @STRBRANCHTO = 'ZZZZZZZZZZZZ'       
       
END      
      
IF LEN(LTRIM(RTRIM(@STRSUBBROKTO))) = ''      
BEGIN       
 SET @STRSUBBROKTO = 'ZZZZZZZZZZZZ'       
       
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
      
SELECT    
	COMPANY,ADDR1,ADDR2,CITY,ZIP,PHONE,'BSE FO' EXCHANGECODE,MEMBERCODE,        
	ST.PARTY_CODE,    
	C1.LONG_NAME,    
	C1.PAN_GIR_NO,    
	LEFT(ST.SAUDA_DATE,11) SAUDA_DATE,    
	ST.CONTRACTNO,    
	ISNULL(UC.MAPIDID,'') MAPIDID,    
	ST.PRODUCT_TYPE,    
	ST.PRODUCT_CODE,    
	ST.SERIES_CODE,    
	ST.SERIES_ID,
	LEFT(ST.EXPIRYDATE,11) EXPIRYDATE,    
	ST.SAMTTRD,    
	ST.SSTTTRD,    
	ST.TOTALSTT,    
	BRANCH_CD,    
	SUB_BROKER,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_NATION,
	L_ZIP    
FROM 
	BFOOWNER,STT_CLIENTDETAIL ST, CLIENT1 C1,    
	CLIENT2 C2 LEFT OUTER JOIN UCC_CLIENT UC ON C2.PARTY_CODE = UC.PARTY_CODE    
WHERE     
	ST.PARTY_CODE = C2.PARTY_CODE     
	AND C1.CL_CODE = C2.CL_CODE    
	AND ST.SAUDA_DATE >= @DATEFROM     
	AND ST.SAUDA_DATE <= @DATETO     
	AND ST.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO     
	AND ST.CONTRACTNO >= @CONTNOFROM     
	AND ST.CONTRACTNO <= @CONTNOTO    
	AND C2.INSURANCE_CHRG = 1     
	
	AND BRANCH_CD >= @STRBRANCH AND  BRANCH_CD <= @STRBRANCHTO         
	AND SUB_BROKER >= @STRSUBBROKFROM  AND SUB_BROKER <= @STRSUBBROKTO              
	AND @STATUSNAME =   
		(CASE   
		WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
		WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
		WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
		WHEN @STATUSID = 'AREA' THEN C1.AREA  
		WHEN @STATUSID = 'REGION' THEN C1.REGION  
		WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
		ELSE   
			'BROKER'  
		END)   
	AND ST.TOTALSTT > 0    
	AND RECTYPE = 30    
	
ORDER BY ST.SAUDA_DATE,BRANCH_CD,SUB_BROKER,ST.PARTY_CODE,ST.CONTRACTNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STT_CERTIFICATE
-- --------------------------------------------------
CREATE  PROC [DBO].[RPT_STT_CERTIFICATE]   (@DATEFROM VARCHAR(11),@DATETO VARCHAR(11), @PARTYFROM VARCHAR(10),    
  @PARTYTO VARCHAR(10), @STATUSID VARCHAR(15), @STATUSNAME VARCHAR(25),  @STRBRANCH VARCHAR(12),     
  @STRBRANCHTO VARCHAR(12),  @STRSUBBROKFROM VARCHAR(12),  @STRSUBBROKTO VARCHAR(12) )            
  AS    
           
IF LEN(LTRIM(RTRIM(@PARTYTO))) = 0     
 BEGIN            
  SET @PARTYTO = 'ZZZZZZZZ'        
 END    
            
IF LEN(LTRIM(RTRIM(@STRBRANCHTO))) = ''             
 BEGIN             
  SET @STRBRANCHTO = 'ZZZZZZZ'  
 END            
            
IF LEN(LTRIM(RTRIM(@STRSUBBROKTO))) = ''            
 BEGIN             
  SET @STRSUBBROKTO = 'ZZZZZZZZZ'                  
 END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
       
    
SELECT PARTY_CODE,  TRANSACTIONCODE = '04', TURNOVER = SUM(SAMTTRD), STT = SUM(SSTTTRD)        
INTO #STT04 FROM STT_CLIENTDETAIL    
WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND  SAUDA_DATE BETWEEN @DATEFROM AND  @DATETO +' 23:59'     
AND  RECTYPE = 30 
AND  RIGHT(PRODUCT_CODE,3) = 'OPT'    
GROUP BY PARTY_CODE ORDER BY PARTY_CODE          
    
SELECT PARTY_CODE,  TRANSACTIONCODE = '05', TURNOVER = SUM(SAMTTRD), STT = SUM(SSTTTRD)        
INTO #STT05 FROM STT_CLIENTDETAIL    
WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND  SAUDA_DATE BETWEEN @DATEFROM AND  @DATETO +' 23:59'     
AND  RECTYPE = 30 
AND  RIGHT(PRODUCT_CODE,3) = 'FUT'    
GROUP BY PARTY_CODE ORDER BY PARTY_CODE          
    


SELECT       
	COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, 'BSE F&O' EXCHANGECODE,       
	MEMBERCODE,C2.PARTY_CODE, LONG_NAME,      
	L_ADDRESS1,      
	L_ADDRESS2,     
	L_ADDRESS3,     
	L_CITY ,    
	BRANCH_CD,
	PAN_GIR_NO,' ' MAPIDID            

INTO #CLIENT      
      
FROM       
CLIENT1 C1,CLIENT2 C2,BFOOWNER      
WHERE       
 C1.CL_CODE =C2.CL_CODE AND       
 PARTY_CODE >= @PARTYFROM AND PARTY_CODE <= @PARTYTO  AND           
 BRANCH_CD >= @STRBRANCH AND  BRANCH_CD <= @STRBRANCHTO  AND           
 @STATUSNAME =   
  (CASE   
   WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
   WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
   WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
   WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
   WHEN @STATUSID = 'AREA' THEN C1.AREA  
   WHEN @STATUSID = 'REGION' THEN C1.REGION  
   WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
   ELSE   
  'BROKER'  
  END)
    
CREATE INDEX [PARTYCD] ON [DBO].[#CLIENT] ([PARTY_CODE])


SELECT PARTY_CODE,'01' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT01  FROM #CLIENT        
SELECT PARTY_CODE,'02' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT02  FROM #CLIENT        
SELECT PARTY_CODE,'03' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT03  FROM #CLIENT        


CREATE INDEX [PARTYCD] ON [DBO].[#STT04] ([PARTY_CODE])

CREATE INDEX [PARTYCD] ON [DBO].[#STT05] ([PARTY_CODE])


INSERT INTO #STT04 SELECT PARTY_CODE,'04',0,0 FROM #CLIENT WHERE PARTY_CODE         
NOT IN (SELECT PARTY_CODE FROM #STT04)        
        
INSERT INTO #STT05 SELECT PARTY_CODE,'05',0,0 FROM #CLIENT WHERE PARTY_CODE         
NOT IN (SELECT PARTY_CODE FROM #STT05)        
        
    
SELECT S.PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT           
INTO #STT00        
        
FROM        
        
(         
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER, STT  FROM #STT01            
  UNION        
  SELECT PARTY_CODE,TRANSACTIONCODE,TURNOVER, STT   FROM #STT02        
  UNION         
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT03        
  UNION         
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT04        
  UNION         
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT05        
        
) S        
        
ORDER BY S.PARTY_CODE,TRANSACTIONCODE        
    
DROP TABLE #STT01
DROP TABLE #STT02
DROP TABLE #STT03
DROP TABLE #STT04
DROP TABLE #STT05

CREATE INDEX [PARTYCD] ON [DBO].[#STT00] ([PARTY_CODE])

SELECT COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, EXCHANGECODE,       
 MEMBERCODE,LONG_NAME, L_ADDRESS1,L_ADDRESS2,L_ADDRESS3, L_CITY,BRANCH_CD, PAN_GIR_NO, ISNULL(U.MAPIDID, '') MAPINID,       
 S.PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT, CONVERT(VARCHAR, GETDATE(), 103) CURDATE        
FROM  #CLIENT C  , #STT00 S LEFT OUTER JOIN UCC_CLIENT U ON (U.PARTY_CODE = S.PARTY_CODE)      
WHERE S.PARTY_CODE = C.PARTY_CODE        
AND S.PARTY_CODE IN ( SELECT PARTY_CODE FROM #STT00 GROUP BY PARTY_CODE HAVING SUM(STT) > 0)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TODAYDATE
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[RPT_TODAYDATE]
AS
SELECT CONVERT(VARCHAR, GETDATE(), 103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_UCCFILEGENERATION_NEW
-- --------------------------------------------------
CREATE  PROC [DBO].[RPT_UCCFILEGENERATION_NEW]    
    (    
    @FROMDATE VARCHAR(11),    
    @TODATE VARCHAR(11),    
    @PARTYFROM VARCHAR(10),    
    @PARTYTO VARCHAR(10),    
    @OPTIONVAL VARCHAR(2)    
    )    
    
    AS    
    
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
    IF @PARTYTO='' BEGIN SET @PARTYTO = 'ZZZZZZ' END    
    
    
    CREATE TABLE #CLIENTLIST    
    (PARTY_CODE VARCHAR(10))    
    
    CREATE INDEX [INDXCL2] ON #CLIENTLIST ([PARTY_CODE])    
    
    /*-----------------------------------------------------------------------------    
      FETCHING TRADED CLIENT LIST TO #CLIENTLIS    
    -----------------------------------------------------------------------------*/
    
    IF @OPTIONVAL = 'T'    
        BEGIN    
            INSERT INTO #CLIENTLIST    
            SELECT    
                DISTINCT PARTY_CODE    
            FROM    
                SETTLEMENT (NOLOCK)    
            WHERE    
                SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'    
                AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO    
        
            INSERT INTO #CLIENTLIST    
            SELECT    
                DISTINCT PARTY_CODE    
            FROM    
                HISTORY (NOLOCK)    
            WHERE    
                SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'    
                AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO    

            INSERT INTO #CLIENTLIST    
            SELECT    
                DISTINCT PARTY_CODE    
            FROM    
                ISETTLEMENT (NOLOCK)    
            WHERE    
                SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'    
                AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO    

            INSERT INTO #CLIENTLIST    
            SELECT    
                DISTINCT PARTY_CODE    
            FROM    
                IHISTORY (NOLOCK)    
            WHERE    
                SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'    
                AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO    
        END     
    ELSE    
     BEGIN    
      INSERT INTO #CLIENTLIST    
      SELECT    
        PARTY_CODE    
      FROM    
       CLIENT2    
      WHERE    
       PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO    
     END    

    /*-----------------------------------------------------------------------------    
       FETCHING DATA TO #UCC_NSE    
    -----------------------------------------------------------------------------*/    
    
    SELECT     
         DISTINCT     
         SEGMENT = '20',    
	 CLIENTCODE = C2.PARTY_CODE,
	 LONGNAME = LEFT(ISNULL(C1.LONG_NAME, ''),60),  
	 STATUS = (CASE WHEN ISNULL(C1.CL_STATUS,'') IN ('NOR','NRI','ROR','PRO','IND') THEN 'IND' ELSE ISNULL(C1.CL_STATUS, '') END),
	 CATEGORY = ISNULL(C1.CL_TYPE, ''),
	 FULLADDRESS = ISNULL(RTRIM(C1.L_ADDRESS1), '') + ' ' + ISNULL(RTRIM(C1.L_ADDRESS2), '') + ' ' + ISNULL(RTRIM(C1.L_ADDRESS3), '') + ' ' + ISNULL(RTRIM(C1.L_CITY), '') + ' ' + ISNULL(RTRIM(C1.L_STATE), ''),  
	 ADDRESS1 = ISNULL(RTRIM(C1.L_ADDRESS1), ''),  
	 ADDRESS2 = ISNULL(RTRIM(C1.L_ADDRESS2), ''),  
	 ADDRESS3 = ISNULL(RTRIM(C1.L_ADDRESS3), ''),  
	 CITY = ISNULL(RTRIM(C1.L_CITY), ''),  
	 NATION = ISNULL(RTRIM(C1.L_NATION), ''),  
	 STATE = (CASE WHEN ISNULL(C1.L_STATE,'') = '' THEN 'XXXXXX' ELSE C1.L_STATE END),  
	 ZIP = (CASE WHEN ISNULL(C1.L_ZIP,'') = '' THEN '999999' ELSE C1.L_ZIP END),  
	 STDCODE = ' ',  
	 -- PHONE1 = (CASE WHEN ISNULL(C1.RES_PHONE1,'') = '' THEN '9999999' ELSE C1.RES_PHONE1 END),  
	 PHONE1 = (CASE WHEN ISNULL(C1.RES_PHONE1,'') <> '' 
			THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.RES_PHONE1,'/',''),'(',''),')',''),'-',''),':',''),';','')
			WHEN ISNULL(C1.RES_PHONE2,'') <> '' 
			THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.RES_PHONE2,'/',''),'(',''),')',''),'-',''),':',''),';','')
			WHEN ISNULL(C1.OFF_PHONE1,'') <> '' 
			THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.OFF_PHONE1,'/',''),'(',''),')',''),'-',''),':',''),';','')
			WHEN ISNULL(C1.OFF_PHONE2,'') <> '' 
			THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.OFF_PHONE2,'/',''),'(',''),')',''),'-',''),':',''),';','')
			WHEN ISNULL(C1.MOBILE_PAGER,'') <> ''
			THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.MOBILE_PAGER,'/',''),'(',''),')',''),'-',''),':',''),';','')
			ELSE '9999999'
		   END),  
         EMAIL = ' ', -- ISNULL(C1.EMAIL,''),    
         SUBBROKER = ' ', ---ISNULL(SB.NAME,''),    
         AGGREMENTDATE = (CASE WHEN C1.CL_STATUS NOT IN ('FII','HUF','CC','PSF','NRI','IC','DFI','OCB','TS','BC','SB','MF') THEN '' ELSE 
          (CASE WHEN C5.BIRTHDATE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE CONVERT(VARCHAR,BIRTHDATE,103)
           END END) END),
         DOB = (CASE WHEN C1.CL_STATUS IN ('FII','HUF','CC','PSF','NRI','IC','DFI','OCB','TS','BC','SB','MF') THEN '' ELSE 
          (CASE WHEN C5.BIRTHDATE IS NULL     
           THEN '01/01/1900'     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) ='JAN  1 1900')     
           THEN '01/01/1900'     
           ELSE CONVERT(VARCHAR,BIRTHDATE,103)
           END END) END),
	 PAN = (CASE WHEN ISNULL(C1.PAN_GIR_NO,'') = '' THEN '' ELSE C1.PAN_GIR_NO END),  
         WARD = ISNULL(C1.WARD_NO, ''),    
         PASSPORTNO = ' ',--ISNULL(C5.PASSPORTDTL, ''),    
         PASSPORTPLACE = ' ', --ISNULL(C5.PASSPORTPLACEOFISSUE, ''),    
         PASSPORTDATE = ' ',    
          /*(CASE WHEN C5.PASSPORTDATEOFISSUE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.PASSPORTDATEOFISSUE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE REPLACE(CONVERT(VARCHAR,PASSPORTDATEOFISSUE,103),'/','')     
           END END),*/
         PASSPORTEXPDATE = ' ',    
          /*(CASE WHEN C5.PASSPORTEXPDATE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.PASSPORTEXPDATE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE REPLACE(CONVERT(VARCHAR,PASSPORTEXPDATE,103),'/','')     
           END END),    */
         DRIVINGLICNO = ' ', --ISNULL(C5.DRIVELICENDTL, ''),    
         DRIVINGLICPLACE = ' ', --ISNULL(C5.LICENCENOPLACEOFISSUE, ''),    
         DRIVINGLICDATE = ' ',    
          /*(CASE WHEN C5.LICENCENODATEOFISSUE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.LICENCENODATEOFISSUE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE REPLACE(CONVERT(VARCHAR,LICENCENODATEOFISSUE,103),'/','')     
           END END),    */
         VOTERID = ' ', --ISNULL(C5.VOTERSIDDTL, ''),    
         VOTERIDPLACE =' ', -- ISNULL(C5.VOTERIDPLACEOFISSUE, ''),    
         VOTERIDDATE = ' ',     
          /*(CASE WHEN C5.VOTERIDDATEOFISSUE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.VOTERIDDATEOFISSUE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE REPLACE(CONVERT(VARCHAR,VOTERIDDATEOFISSUE,103),'/','')     
           END END),*/    
         RATIONCARDID = ' ', ---ISNULL(C5.RATIONCARDDTL, ''),    
         RATIONCARDIDPLACE = ' ',  --ISNULL(C5.RATIONCARDPLACEOFISSUE, ''),    
         RATIONCARDIDDATE = ' ',    
          /*(CASE WHEN C5.RATIONCARDDATEOFISSUE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.RATIONCARDDATEOFISSUE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE REPLACE(CONVERT(VARCHAR,RATIONCARDDATEOFISSUE,103),'/','')     
           END END),    */
         REGNO = ISNULL(C5.REGR_NO, ''),    
         REGAUTHORITY = ISNULL(C5.REGR_AUTH, ''),    
       REGPALCE = ISNULL(C5.REGR_PLACE, ''),    
         REGDATE =     
          /*(CASE WHEN C5.REGR_DATE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.REGR_DATE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE CONVERT(VARCHAR,REGR_DATE,103)    
           END END),*/

	(CASE WHEN C1.CL_STATUS NOT IN ('FII','HUF','CC','PSF','NRI','IC','DFI','OCB','TS','BC','SB','MF') THEN '' ELSE 
          (CASE WHEN C5.BIRTHDATE IS NULL     
           THEN ''     
           ELSE CASE WHEN (LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) ='JAN  1 1900')     
           THEN ''     
           ELSE CONVERT(VARCHAR,BIRTHDATE,103)
           END END) END),    
         INTRODUCER = ' ', --ISNULL(C1.TRADER, ''),    
         INTRORELATION = ISNULL(C5.INTROD_RELATION, ''),    
         INTROCLID = ISNULL(C5.INTROD_CLIENT_ID, ''),    
         OTHERACCNO = ' ', --ISNULL(C5.ANY_OTHER_ACC, ''),    
         SETTMODE = ISNULL(C5.SETT_MODE, ''),    
         OTHERTMCLIENT = ISNULL(C5.DEALING_WITH_OTHRER_TM, ''),    
         UCCCLIENTCODE = ISNULL(UC.PARTY_CODE, ''),    
         MAPINID = ' ',    
         ENDOFRECDFLAG = ISNULL('E', ''),    
         BANKACCTYPE = SPACE(8),     
         BANKACCOUNT = SPACE(16),     
         BENFACCOUNT = SPACE(16),     
         BANKNAME = SPACE(50),    
         BANKFULLADDRESS = SPACE(50),     
         DPBANKNAME = SPACE(50),    
         NSDL_DEPOSITORYNAME = SPACE(4),     
         NSDL_DEPOSITORYPARTICIPANTID = SPACE(8),    
         NSDL_DEPOSITORYPARTICIPANTNAME = SPACE(25),     
         NSDL_BENEFICIARYACCOUNTID = SPACE(8),    
         CDSL_DEPOSITORYNAME = SPACE(4),     
         CDSL_DEPOSITORYPARTICIPANTID = SPACE(8),    
         CDSL_DEPOSITORYPARTICIPANTNAME = SPACE(25),     
         CDSL_BENEFICIARYACCOUNTID = SPACE(16),    
         CL_ACCOUNTNO = SPACE(25),     
         DPID = SPACE(16),     
         DEPOSITORY = SPACE(8),    
         INACTIVEFROM = C5.INACTIVEFROM,    
         ACTIVE = (CASE WHEN C5.INACTIVEFROM > GETDATE() THEN 'Y' ELSE 'N' END),
	 BSECMFLAG = 'N',
	 SLBSFLAG = 'N'    
        
    INTO   #UCC_NSE    
    FROM     
         CLIENT1 C1 (NOLOCK)
         LEFT OUTER JOIN SUBBROKERS SB (NOLOCK) ON (SB.SUB_BROKER = C1.SUB_BROKER),    
         CLIENT2 C2 (NOLOCK),     
         CLIENT5 C5 (NOLOCK),    
         #CLIENTLIST LEFT OUTER JOIN UCC_CLIENT UC (NOLOCK) ON (UC.PARTY_CODE = #CLIENTLIST.PARTY_CODE)    
    WHERE     
         C1.CL_CODE = C2.CL_CODE     
         AND C1.CL_CODE = C5.CL_CODE     
         AND #CLIENTLIST.PARTY_CODE = C2.PARTY_CODE    
         AND C1.CL_TYPE <> 'REM'    
         AND C5.SYSTUMDATE BETWEEN     
           CASE WHEN @OPTIONVAL = 'A' THEN @FROMDATE ELSE 'JAN  1 1900' END    
            AND    
           CASE WHEN @OPTIONVAL = 'A' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END    
         AND C5.ACTIVEFROM BETWEEN    
           CASE WHEN @OPTIONVAL = 'S' THEN @FROMDATE ELSE 'JAN  1 1900' END    
            AND    
           CASE WHEN @OPTIONVAL = 'S' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END    
         AND C5.INACTIVEFROM BETWEEN    
           CASE WHEN @OPTIONVAL = 'I' THEN @FROMDATE ELSE 'JAN  1 1900' END    
            AND    
           CASE WHEN @OPTIONVAL = 'I' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END    
        
    /*-----------------------------------------------------------------------------    
      UPDATING #UCC_NSE FOR ACCOUNT DETAILS    
    -----------------------------------------------------------------------------*/    
    /*
    UPDATE     
         #UCC_NSE     
	 	SET BANKACCTYPE = (CASE WHEN C4.DEPOSITORY IN ('SAVING','CURRENT')
		THEN C4.DEPOSITORY
		ELSE 'OTHERS'
		END),
         --SET BANKACCTYPE =     
         -- (CASE WHEN LEFT(C4.DEPOSITORY,6) = 'SAVING'     
         --  THEN '10' ELSE CASE WHEN LEFT(C4.DEPOSITORY,7) = 'CURRENT'     
         --  THEN '11' ELSE '99' END     
         --  END),    
         BANKACCOUNT =     
          (CASE WHEN LEFT(C4.DEPOSITORY,7) IN ('SAVING','CURRENT','NRE','NRO')     
           THEN CLTDPID ELSE ' '     
           END),    
         CL_ACCOUNTNO=CLTDPID    
        FROM     
             CLIENT4 C4     
        WHERE     
         C4.DEPOSITORY NOT IN ('CDSL', 'NSDL')    
         AND C4.PARTY_CODE = CLIENTCODE    
    */	
    /*-----------------------------------------------------------------------------    
      UPDATING #UCC_NSE FOR DP DETAILS    
    -----------------------------------------------------------------------------*/    
    /*	
    UPDATE     
         #UCC_NSE     
         SET BENFACCOUNT =  ISNULL(CLTDPID,' '),     
         DPID = ISNULL(C4.BANKID,''),     
         DEPOSITORY = ISNULL(C4.DEPOSITORY,'')    
    FROM     
         CLIENT4 C4    
    WHERE     
         C4.DEPOSITORY IN ('CDSL', 'NSDL')     
         AND C4.PARTY_CODE = CLIENTCODE     
         AND DEFDP = 1    
    */
    /*-----------------------------------------------------------------------------    
      UPDATING #UCC_NSE FOR BANK NAME    
    -----------------------------------------------------------------------------*/    
    /*
    UPDATE     
         #UCC_NSE     
         SET BANKNAME = ISNULL(LEFT(BANK_NAME,50), ' '),     
         BANKFULLADDRESS = ISNULL(LEFT(BRANCH_NAME,50), ' ')    
    FROM     
         (SELECT     
          PARTY_CODE,    
          BANK_NAME,     
          BRANCH_NAME     
         FROM     
          CLIENT4 C4,     
          POBANK P    
         WHERE     
          CONVERT(VARCHAR, P.BANKID) = C4.BANKID    
          AND DEPOSITORY NOT IN ('CDSL', 'NSDL')) A    
    WHERE     
         PARTY_CODE = CLIENTCODE    
    */
    /*-----------------------------------------------------------------------------    
      UPDATING #UCC_NSE MULTIPLE DP DETAILS    
    -----------------------------------------------------------------------------*/    
    /*
    UPDATE     
         #UCC_NSE     
         SET NSDL_DEPOSITORYNAME = LEFT(M.DPTYPE,4),     
         NSDL_DEPOSITORYPARTICIPANTID = CASE WHEN M.DPTYPE ='NSDL' THEN LEFT(M.DPID,8) ELSE '' END ,    
         NSDL_DEPOSITORYPARTICIPANTNAME = CASE WHEN M.DPTYPE ='NSDL' THEN LEFT(M.INTRODUCER,25) ELSE '' END ,     
         NSDL_BENEFICIARYACCOUNTID = CASE WHEN M.DPTYPE ='NSDL' THEN LEFT(M.CLTDPNO,8) ELSE '' END,    
         CDSL_DEPOSITORYNAME = CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.DPTYPE,4) ELSE '' END,     
         CDSL_DEPOSITORYPARTICIPANTID = CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.DPID,8) ELSE '' END ,    
         CDSL_DEPOSITORYPARTICIPANTNAME = CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.INTRODUCER,25) ELSE '' END ,     
         CDSL_BENEFICIARYACCOUNTID = CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.CLTDPNO,8) ELSE '' END    
    FROM     
         MULTICLTID M    
    WHERE     
         M.DEF=1     
         AND M.PARTY_CODE = CLIENTCODE   

    UPDATE     
         #UCC_NSE SET DPBANKNAME = ISNULL(LEFT(A.BANKNAME,50),'')    
     FROM(     
          SELECT PARTY_CODE,BANKNAME     
          FROM CLIENT4 C4, BANK P    
          WHERE CONVERT(VARCHAR,  P.BANKID) = C4.BANKID    
          AND DEPOSITORY IN ('CDSL', 'NSDL')    
          ) A    
     WHERE PARTY_CODE = CLIENTCODE 
    */
    /*-----------------------------------------------------------------------------    
       FETCHING FINAL OUTPUT    
    -----------------------------------------------------------------------------*/    

    UPDATE #UCC_NSE SET BSECMFLAG = 'Y'
    FROM MSAJAG.DBO.CLIENT_BROK_DETAILS C
    WHERE CLIENTCODE = CL_CODE
    AND C.EXCHANGE = 'BSE' AND C.SEGMENT = 'CAPITAL'


    UPDATE #UCC_NSE SET SLBSFLAG = 'Y'
    FROM MSAJAG.DBO.CLIENT_BROK_DETAILS C
    WHERE CLIENTCODE = CL_CODE
    AND C.EXCHANGE = 'BSE' AND C.SEGMENT = 'SLBS'


    SELECT * 
    FROM 
        #UCC_NSE 
    ORDER BY 
        CLIENTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VBB_BROKTABLEDETAILS
-- --------------------------------------------------
CREATE PROC [DBO].[RPT_VBB_BROKTABLEDETAILS]
	(
	@PARTYCODE VARCHAR(15)
	)

	AS

	IF (SELECT COUNT(1) FROM SYSOBJECTS WHERE NAME ='SCHEME_MAPPING') > 0
	BEGIN

		SET NOCOUNT ON
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
		SELECT  
		SCHEMEDT = LEFT(SP_DATE_FROM,11) + ' -  ' + LEFT(SP_DATE_TO,11),
		SCHEMETYPE = CASE 
				WHEN SP_TRD_TYPE='TRD' THEN 'NORMAL TRADE' 
				WHEN SP_TRD_TYPE='DEL' THEN 'DELIVERY TRADE' 
				ELSE '' END,
		SYMBOL = SP_SCRIP , 
		COMPUTATIONTYPE = CASE SP_BROK_COMPUTETYPE WHEN  'I' THEN 'INCREMENTAL' ELSE 'VARIABLE' END,
		BROKCOMPUTEON = CASE WHEN SP_BROK_COMPUTEON ='T' THEN 'TURNOVER' ELSE
					CASE WHEN SP_BROK_COMPUTEON ='Q' THEN 'QUANTITY' ELSE
					CASE WHEN SP_BROK_COMPUTEON ='L' THEN 'LOT SIZE' ELSE
					'VALUE OF LOT' END END END ,
		COMPUTATIONLEVEL = CASE WHEN SP_COMPUTATION_LEVEL ='T' THEN 'TRADES' ELSE
					CASE WHEN SP_COMPUTATION_LEVEL ='O' THEN 'ORDER' ELSE
					CASE WHEN SP_COMPUTATION_LEVEL ='S' THEN 'SCRIP' ELSE
						'CONTRACT' END END END,
		SCHEME = CASE WHEN SP_SCHEME_TYPE=0 THEN 'DEFAULT' ELSE
				 CASE WHEN SP_SCHEME_TYPE=1 THEN 'MAX LOGIC BS FL' ELSE 
				'MAX LOGIC SS FL' END END,
		VALUERANGE = CONVERT(VARCHAR,SP_VALUE_FROM) + ' - ' + CASE WHEN SP_VALUE_TO = -1 THEN 'UN LIMIT' ELSE
			CONVERT(VARCHAR,SP_VALUE_TO) END,
		BROK = 'BUY ' + CONVERT(VARCHAR,SP_BUY_BROK) + CASE WHEN SP_BUY_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END  +
			' SELL ' + CONVERT(VARCHAR,SP_SELL_BROK) + CASE WHEN SP_SELL_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END,
	
		 SCRORD = CASE WHEN SP_SCRIP='ALL' THEN 1 ELSE 2 END,
		RCOUNT = 1
		FROM SCHEME_MAPPING 
		WHERE SP_PARTY_CODE = @PARTYCODE
		ORDER BY 1,3,SCRORD
	
	END
	ELSE
	BEGIN
		SELECT
		RCOUNT = 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VBB_SCHEME_LISTING
-- --------------------------------------------------
CREATE PROCEDURE  [DBO].[RPT_VBB_SCHEME_LISTING]

   @SCHEME_TYPE VARCHAR(3),
   @COMPUTATION_TYPE VARCHAR(3)

AS
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 

     SM_SCHEME_ID,
     SM_SCHEME_DESC, 
     SM_COMPUTATIONON = CASE WHEN SM_COMPUTATIONON = 'V' THEN 'VALUE OF LOT' 
                             WHEN SM_COMPUTATIONON = 'T' THEN 'TURNOVER'
                             WHEN SM_COMPUTATIONON = 'Q' THEN 'QUANTITY'
                             WHEN SM_COMPUTATIONON = 'L' THEN 'LOT SIZE'
                             END,
     SM_COMPUTATIONTYPE = CASE WHEN SM_COMPUTATIONTYPE = 'V' THEN 'VARIABLE'
                               WHEN SM_COMPUTATIONTYPE = 'I' THEN 'INCREMENTAL'
                               END,
     SM_TRD_TYPE,
     SM_TURNOVERON,
     SM_VALUE_FROM,
     SM_VALUE_TO,
     SM_RES_MULTIPLIER,
     SM_BUY_BROK_TYPE,
     SM_SELL_BROK_TYPE,
     SM_BUY_BROK,
     SM_SELL_BROK 

FROM 
     SCHEME_MASTER 

WHERE
	1 = CASE 
		WHEN @SCHEME_TYPE = 'ALL' 
		THEN 1
		ELSE 
			CASE WHEN SM_TRD_TYPE = @SCHEME_TYPE THEN 1 ELSE 2 END
		END AND					
	1 = CASE 
		WHEN @COMPUTATION_TYPE = 'ALL' 
		THEN 1
		ELSE 
			CASE WHEN SM_COMPUTATIONTYPE = @COMPUTATION_TYPE THEN 1 ELSE 2 END
		END

  ORDER BY 
         SM_SCHEME_ID,
         SM_VALUE_FROM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VBB_SCHEME_MAPPING
-- --------------------------------------------------
CREATE PROCEDURE  [DBO].[RPT_VBB_SCHEME_MAPPING]

   @DATE_FRM VARCHAR(12),
   @DATE_TO VARCHAR(12),
   @PARTY_FRM VARCHAR(20),
   @PARTY_TO VARCHAR(20),
   @INSTRU_TYPE VARCHAR(5),
   @SP_SCRIP VARCHAR(10),
   @SCHEME_TYPE VARCHAR(8)


AS

	IF @PARTY_TO = '' BEGIN SET @PARTY_TO = 'ZZZZZ' END
	IF @SP_SCRIP = '' BEGIN SET @SP_SCRIP = 'ALL' END

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 

   SP_PARTY_CODE,
   LONG_NAME,
   SP_COMPUTATION_LEVEL = CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN 'TRADE' 
                               WHEN SP_COMPUTATION_LEVEL = 'O' THEN 'ORDER'
                               WHEN SP_COMPUTATION_LEVEL = 'S' THEN 'SCRIP'
                               WHEN SP_COMPUTATION_LEVEL = 'C' THEN 'CONTRACT'
                             END, 
   SP_PRODUCT_TYPE,
   SP_SCRIP,
   SP_SCHEME_ID,
   SP_TRD_TYPE,
   SP_SCHEME_TYPE = CASE WHEN SP_SCHEME_TYPE = '0' THEN 'DEFAULT'
                         WHEN SP_SCHEME_TYPE = '1' THEN 'MAX BUYFL'
                         WHEN SP_SCHEME_TYPE = '3' THEN 'MAX SELLFL'
                        END,
   SP_MULTIPLIER,
   SP_BUY_BROK_TYPE = CASE WHEN SP_BUY_BROK_TYPE='P' THEN '%' ELSE 'V' END,
   SP_SELL_BROK_TYPE  = CASE WHEN SP_SELL_BROK_TYPE='P' THEN '%' ELSE 'V' END,
   SP_BUY_BROK,
   SP_SELL_BROK,
   SP_VALUE_FROM,
   SP_VALUE_TO,
   SP_TURNOVERON,
   SP_BROK_COMPUTEON = CASE WHEN SP_BROK_COMPUTEON = 'V' THEN 'VALUE OF LOT' 
                           WHEN SP_BROK_COMPUTEON = 'L' THEN 'LOT SIZE'
                           WHEN SP_BROK_COMPUTEON = 'Q' THEN 'QUANTITY'
                           WHEN SP_BROK_COMPUTEON = 'T' THEN 'TURN OVER'
                        END,
   SP_BROK_COMPUTETYPE = CASE WHEN SP_BROK_COMPUTETYPE = 'V' THEN 'VARIABLE' 
                             WHEN SP_BROK_COMPUTETYPE = 'I' THEN 'INCREMENTAL' 
                        END,
   SP_MIN_BROKAMT,
   SP_MAX_BROKAMT,
   SP_MIN_SCRIPAMT,
   SP_MAX_SCRIPAMT,
   SP_DATE_FROM = CONVERT(VARCHAR,SP_DATE_FROM,106),
   SP_DATE_TO   = CONVERT(VARCHAR,SP_DATE_TO,106)

  FROM 
        SCHEME_MAPPING(NOLOCK) , CLIENT1(NOLOCK) , CLIENT2(NOLOCK)
 
 WHERE
      CLIENT1.CL_CODE= CLIENT2.CL_CODE AND CLIENT2.PARTY_CODE = SP_PARTY_CODE 
      AND ((SP_DATE_FROM BETWEEN @DATE_FRM AND @DATE_TO)
	  OR (SP_DATE_TO   BETWEEN @DATE_FRM AND @DATE_TO))
      --AND @DATE_FRM BETWEEN  SP_DATE_FROM AND SP_DATE_TO + ' 23:29'
      AND SP_PARTY_CODE BETWEEN @PARTY_FRM AND @PARTY_TO
      AND  1 = CASE 
					WHEN @INSTRU_TYPE = 'BOTH' 
					THEN
						1
					ELSE 
						CASE WHEN SP_PRODUCT_TYPE = @INSTRU_TYPE THEN 1 ELSE 2 END
					END 
      AND 1 = CASE 
					WHEN @SCHEME_TYPE = 'ALL' 
					THEN
						1
					ELSE 
						CASE WHEN SP_TRD_TYPE = @SCHEME_TYPE THEN 1 ELSE 2 END
					END 

      AND SP_SCRIP = @SP_SCRIP

  ORDER BY

        SP_PARTY_CODE,
        SP_DATE_FROM,
        SP_DATE_TO,
        SP_PRODUCT_TYPE,
        SP_TRD_TYPE, 
        SP_SCRIP,
        SP_VALUE_FROM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
  
CREATE PROC SP @spName VARCHAR(25)AS               
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDBRANCH_EXECUTE
-- --------------------------------------------------
--INSERT INTO DELSEGMENT SELECT * FROM GUNAVATTA.MSAJAG.DBO.DELSEGMENT
  /****** OBJECT:  STORED PROCEDURE DBO.SP_ADDBRANCH_EXECUTE    SCRIPT DATE: 01/15/2005 4:39:22 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.SP_ADDBRANCH_EXECUTE    SCRIPT DATE: 12/16/2003 2:21:39 PM ******/  
  
  
CREATE PROC [DBO].[SP_ADDBRANCH_EXECUTE]  
@STRSQL VARCHAR(8000)  
AS  
 PRINT @STRSQL  
 EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDCLIENT_EXECUTE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.SP_ADDCLIENT_EXECUTE    SCRIPT DATE: 01/15/2005 5:31:32 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.SP_ADDCLIENT_EXECUTE    SCRIPT DATE: 12/16/2003 2:37:13 PM ******/

CREATE  PROC [DBO].[SP_ADDCLIENT_EXECUTE]
@STRSQL VARCHAR(8000)
AS
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDEDITSCRIP_EXECUTE
-- --------------------------------------------------
CREATE PROC [DBO].[SP_ADDEDITSCRIP_EXECUTE]
@STRSQL VARCHAR(8000)
AS
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_AUTHORIZED_USER
-- --------------------------------------------------
CREATE PROC [dbo].[SP_AUTHORIZED_USER]
(
	@VALUE VARCHAR(MAX),
	@FLAG VARCHAR(10), --R = REJECT / A=APPROVE  
	@USERIPADD VARCHAR(15),
	@ADMIN_NAME VARCHAR(15),
	@IPADD VARCHAR(15) 
)


AS
SET NOCOUNT ON
DECLARE 
	@@NEWDATE  VARCHAR(11),
	@@MAXCOUNT TINYINT,
    @@MAXCNT   TINYINT,
	@@MAX_EDIT TINYINT,
	@@FLDAUTO INT,	
	@@FLDADMINAUTO INT,
	@REMARK VARCHAR(100),
	@UNAME VARCHAR(100),
	@DATA VARCHAR(MAX),  
	@EXCHSEG VARCHAR(500), 
	@@EXCHSEG VARCHAR(500),
	@@EXCHANGE VARCHAR(3),
	@@SEGMENT VARCHAR(25),
	@@SHAREDB VARCHAR(25), 
	@@SHARESERVER VARCHAR(25),
	@STREXCHSEG	 VARCHAR(50), 
	@@DB VARCHAR(MAX),  
	@@LOG VARCHAR(MAX),
	@@FLDLOG_DATA VARCHAR(MAX),
	@LOOPID INT, 
	@LOOP_ID INT,
	
	@@SEGORD TINYINT,
	@@MAINREC AS CURSOR
	
	CREATE TABLE #TEMP
	(
		UNAME VARCHAR(50),
		REMARK VARCHAR(500),
		EXCHSEG VARCHAR(500),
		FLAG CHAR(1),
		MAX_EDIT TINYINT 
	)
	CREATE TABLE #FLDAUTO
	(
		FLDAUTO INT,
		FLDADMINAUTO INT
	)
	CREATE TABLE #FLDLOG_DATA
	(
		FLDLOG_DATA VARCHAR(MAX)	
	) 	 

BEGIN TRAN
	SELECT @@NEWDATE = CONVERT(VARCHAR,GETDATE(),109)
	SELECT @@MAXCNT = ISNULL(MAX_REJECTION_ALLOW,0) FROM TBLGLOBALPARAMS
	
	SET @LOOPID = 1
	 WHILE 1 = 1
		BEGIN
			SET @DATA = .DBO.PIECE(@VALUE, '', @LOOPID)
			
			SET @UNAME = .DBO.PIECE(@DATA, '', 1)
			SET @REMARK = .DBO.PIECE(@DATA, '', 2)
			SET @EXCHSEG = .DBO.PIECE(@DATA, '', 3)
			 
			IF PATINDEX('%,%',@EXCHSEG) > 0 
			 BEGIN
				SET @LOOP_ID = 1
				 WHILE 1 = 1
					BEGIN
						SET @STREXCHSEG = .DBO.PIECE(@EXCHSEG,',',@LOOP_ID)
						PRINT @STREXCHSEG
						IF @STREXCHSEG = '' OR @STREXCHSEG IS NULL
						 BEGIN
							BREAK
						 END
				
						SELECT @@MAX_EDIT = ISNULL(MAX_EDIT,0) FROM TBLUSERS TU, TBLPRADNYAUSERS TP WHERE FLDUSERNAME = @UNAME AND TU.PRADNYAAUTO = TP.FLDAUTO 
						INSERT INTO #TEMP(UNAME, REMARK, EXCHSEG, FLAG, MAX_EDIT) VALUES (UPPER(@UNAME), UPPER(@REMARK), UPPER(@STREXCHSEG), UPPER(@FLAG), @@MAX_EDIT)
					SET @LOOP_ID = @LOOP_ID + 1		
					END
			 END
			ELSE
			 BEGIN
				IF @DATA = '' OR @DATA IS NULL
				 BEGIN
					BREAK
				 END
				SELECT @@MAX_EDIT = ISNULL(MAX_EDIT,0) FROM TBLUSERS TU, TBLPRADNYAUSERS TP WHERE FLDUSERNAME = @UNAME AND TU.PRADNYAAUTO = TP.FLDAUTO 
				INSERT INTO #TEMP(UNAME, REMARK, EXCHSEG, FLAG, MAX_EDIT) VALUES (UPPER(@UNAME), UPPER(@REMARK), UPPER(@EXCHSEG), UPPER(@FLAG), @@MAX_EDIT)				
			 END  		
			 
			
			SET @LOOPID = @LOOPID + 1 
		END


	SET @@MAINREC = CURSOR FOR 
		SELECT 
			EXCHANGE, SEGMENT, SHAREDB, SHARESERVER, UNAME, REMARK, FLAG, MAX_EDIT 
		FROM 
			PRADNYA.DBO.MULTICOMPANY MC (NOLOCK), #TEMP TP
		WHERE 
			PRIMARYSERVER = 1 
			AND MC.EXCHANGE +'~'+ MC.SEGMENT = TP.EXCHSEG 

	OPEN @@MAINREC
	 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESERVER, @UNAME, @REMARK, @FLAG, @@MAX_EDIT 

	SET @@SEGORD = 1
	WHILE @@FETCH_STATUS = 0
	 BEGIN 

		IF @@SHARESERVER <> @@SERVERNAME  
		 BEGIN
			SET @@DB = " INSERT INTO #FLDAUTO "
			SET @@DB = @@DB + "	SELECT FLDAUTO, FLDADMINAUTO INT FROM " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@UNAME+"' "
		 END	
		ELSE
		 BEGIN
			SET @@DB = " INSERT INTO #FLDAUTO "
			SET @@DB = @@DB + "	SELECT FLDAUTO, FLDADMINAUTO INT FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@UNAME+"' "
		 END
		
		EXEC(@@DB) 
		SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM #FLDAUTO
	
		IF @@MAX_EDIT = '' OR @@MAX_EDIT IS NULL
		 BEGIN
			SET @@DB = " INSERT INTO TBLUSERS (PRADNYAAUTO,REMARK,MAX_EDIT,BLOCK) VALUES ( "+CONVERT(VARCHAR,@@FLDAUTO)+" ,'"+ @REMARK +"',1,'N') "
			SET @@MAX_EDIT = 0 
		 END
		ELSE
		 BEGIN	 	
			SET @@DB = " INSERT INTO "
			IF @@SHARESERVER <> @@SERVERNAME  
			 BEGIN
				SET @@DB = @@DB + "	" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERS_LOG "
			 END
			ELSE
			 BEGIN
				SET @@DB = @@DB + "	" + @@SHAREDB + ".DBO.TBLUSERS_LOG "
			 END	
			SET @@DB = @@DB + "SELECT "
			SET @@DB = @@DB + "	TU.FLDAUTO,PRADNYAAUTO,'"+@REMARK+"',TU.MAX_EDIT,BLOCK,'"+@ADMIN_NAME+"','"+@@NEWDATE+"','"+@USERIPADD+"' "
			SET @@DB = @@DB + "FROM "
			IF @@SHARESERVER <> @@SERVERNAME  
			 BEGIN
				SET @@DB = @@DB + "	" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERS TU "
			 END
			ELSE
			 BEGIN
				SET @@DB = @@DB + "	" + @@SHAREDB + ".DBO.TBLUSERS TU "
			 END
			SET @@DB = @@DB + " WHERE "
			SET @@DB = @@DB + "	PRADNYAAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
			--SET @@DB = @@DB + "	AND '"+@FLAG+"' = 'R' "		
		 END	 	
	
		SET @@DB = @@DB + "	UPDATE " --****if records is exist already then update count + 1 *****
		SET @@DB = @@DB + "		TU "
		SET @@DB = @@DB + "	SET "
		SET @@DB = @@DB + "		REMARK		= '"+@REMARK+"', "
		SET @@DB = @@DB + "		MAX_EDIT	= (CASE WHEN "+CONVERT(VARCHAR,@@MAX_EDIT)+" < "+CONVERT(VARCHAR,@@MAXCNT)+" THEN "+CONVERT(VARCHAR,@@MAX_EDIT+1)+" ELSE "+CONVERT(VARCHAR,@@MAXCNT)+" END), "
		SET @@DB = @@DB + "		BLOCK		= (CASE WHEN "+CONVERT(VARCHAR,@@MAX_EDIT)+" = "+CONVERT(VARCHAR,@@MAXCNT)+" THEN 'Y' ELSE 'N' END) "
		SET @@DB = @@DB + "	FROM "
		IF @@SHARESERVER <> @@SERVERNAME  
		 BEGIN
			SET @@DB = @@DB + "		" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERS TU "
		 END
		ELSE
		 BEGIN
			SET @@DB = @@DB + "		" + @@SHAREDB + ".DBO.TBLUSERS TU "
		 END
		SET @@DB = @@DB + "	WHERE "
		SET @@DB = @@DB + "	PRADNYAAUTO = '"+CONVERT(VARCHAR,@@FLDAUTO)+"' "
		SET @@DB = @@DB + "		AND BLOCK = 'N' "
		SET @@DB = @@DB + "		AND '"+@FLAG+"' = 'R' "	

		SET @@DB = @@DB + "	UPDATE "
		SET @@DB = @@DB + "		TU "
		SET @@DB = @@DB + "	SET "
		SET @@DB = @@DB + "		FLDSTATUS = CASE WHEN UPPER('"+@FLAG+"') = 'R' THEN 3 ELSE 0 END "
		SET @@DB = @@DB + "	FROM "
		IF @@SHARESERVER <> @@SERVERNAME  
		 BEGIN
			SET @@DB = @@DB + "		" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "
			SET @@DB = @@DB + "		" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "
		 END
		ELSE
		 BEGIN
			SET @@DB = @@DB + "		" + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "
			SET @@DB = @@DB + "		" + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "
		 END	
		SET @@DB = @@DB + "	WHERE "
		SET @@DB = @@DB + "		FLDSTATUS IN ('1','2','3') "
		SET @@DB = @@DB + "		AND TU.FLDUSERID = TP.FLDAUTO "
		SET @@DB = @@DB + "		AND TP.FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "

		--*****Start Authorization for Disabling user******
		SET @@DB = @@DB + "	UPDATE "
		SET @@DB = @@DB + "		TU "
		SET @@DB = @@DB + "	SET "	
		SET @@DB = @@DB + "		FLDSTATUS = CASE WHEN UPPER('"+@FLAG+"') = 'R' THEN 0 ELSE 1 END "
		SET @@DB = @@DB + "	FROM "
		IF @@SHARESERVER <> @@SERVERNAME  
		 BEGIN
			SET @@DB = @@DB + "		" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "
			SET @@DB = @@DB + "		" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU, "
			SET @@DB = @@DB + "		" + @@SHARESERVER + "." + @@SHAREDB + ".DBO.USERDISABLED_LIST TD"
		 END
		ELSE
		 BEGIN
			SET @@DB = @@DB + "		" + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "
			SET @@DB = @@DB + "		" + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU, "
			SET @@DB = @@DB + "		" + @@SHAREDB + ".DBO.USERDISABLED_LIST TD "
		 END
		SET @@DB = @@DB + "	WHERE "
		SET @@DB = @@DB + "		TD.USERSTATUS = '1' "
		SET @@DB = @@DB + "		AND TU.FLDUSERID = TP.FLDAUTO "
		SET @@DB = @@DB + "		AND TP.FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
		SET @@DB = @@DB + "		AND TU.FLDUSERID = TD.USERID "

		SET @@DB = @@DB + "	DELETE "
			SET @@DB = @@DB + "	USERDISABLED_LIST WHERE USERID = "+CONVERT(VARCHAR,@@FLDAUTO)+"  "
		--****End Start Authorization for Disabling user****	

		--****Start Log of Pradnyatable updation****
		SET @@LOG = "INSERT INTO #FLDLOG_DATA SELECT 
			FLDPASSWORD +'~'+ 
			CASE WHEN FLDFIRSTNAME = '' THEN '$' ELSE FLDFIRSTNAME END +'~'+
			CASE WHEN FLDMIDDLENAME = '' THEN '$' ELSE FLDMIDDLENAME END +'~'+
			CASE WHEN FLDLASTNAME = '' THEN '$' ELSE FLDLASTNAME END +'~'+
			CASE WHEN FLDSEX = '' THEN '$' ELSE FLDSEX END +'~'+
			CASE WHEN FLDADDRESS1 = '' THEN '$' ELSE FLDADDRESS1 END +'~'+
			CASE WHEN FLDADDRESS2 = '' THEN '$' ELSE FLDADDRESS2 END  +'~'+
			CASE WHEN FLDPHONE1 = '' THEN '$' ELSE FLDPHONE1 END +'~'+
			CASE WHEN FLDPHONE2 = '' THEN '$' ELSE FLDPHONE2 END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDCATEGORY) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDCATEGORY) END+'~'+
			CASE WHEN CONVERT(VARCHAR,PWD_EXPIRY_DATE) = '' THEN '$' ELSE CONVERT(VARCHAR,PWD_EXPIRY_DATE) END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDATTEMPTCNT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDATTEMPTCNT) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDSTATUS) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDSTATUS) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDLOGINFLAG) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDLOGINFLAG) END +'~'+
			CASE WHEN FLDACCESSLVL = '' THEN '$' ELSE FLDACCESSLVL END +'~'+
			CASE WHEN FLDIPADD  = '' THEN '$' ELSE FLDIPADD END+'~'+
			CASE WHEN CONVERT(VARCHAR,FLDTIMEOUT) = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+
			CASE WHEN FLDFIRSTLOGIN = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDFORCELOGOUT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDFORCELOGOUT) END +'~'+
			CASE WHEN FLD_MAC_ID = '' THEN '$' ELSE FLD_MAC_ID END "
		SET @@LOG = @@LOG + " FROM "
		IF @@SHARESERVER <> @@SERVERNAME  
		 BEGIN
			SET @@LOG = @@LOG + " " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "
		 END
		ELSE
		 BEGIN
			SET @@LOG = @@LOG + " " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "				
		 END
		SET @@LOG = @@LOG + " WHERE "
		SET @@LOG = @@LOG + " 	TP.FLDAUTO = FLDUSERID "
		SET @@LOG = @@LOG + " 	AND FLDUSERNAME = '"+ @UNAME +"' "
		EXEC(@@LOG)
		SELECT @@FLDLOG_DATA = FLDLOG_DATA FROM #FLDLOG_DATA 	   
		
		SET @@LOG = " "
		SET @@LOG = @@LOG + " INSERT INTO "--******CLASS USER LOG TABLE ********
		IF @@SHARESERVER <> @@SERVERNAME  
		 BEGIN
			SET @@LOG = @@LOG + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG  "
		 END
		ELSE
		 BEGIN
			SET @@LOG = @@LOG + "  " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG  "
		 END
		SET @@LOG = @@LOG + " (  "
		SET @@LOG = @@LOG + " FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  "
		SET @@LOG = @@LOG + " FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  "
		SET @@LOG = @@LOG + " ) "
		SET @@LOG = @@LOG + " SELECT "
		SET @@LOG = @@LOG + " 	FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, "
		SET @@LOG = @@LOG + " 	FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, '"+@FLAG+"', '"+@ADMIN_NAME+"', '"+@@NEWDATE+"', '"+@IPADD+"', '"+@@FLDLOG_DATA +"' "
		SET @@LOG = @@LOG + " FROM "
		IF @@SHARESERVER <> @@SERVERNAME  
		 BEGIN
			SET @@LOG = @@LOG + " " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS "
		 END
		ELSE
		 BEGIN
			SET @@LOG = @@LOG + " " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS "
		 END
		SET @@LOG = @@LOG + " WHERE "
		SET @@LOG = @@LOG + " 	FLDUSERNAME = '"+ @UNAME +"' "

		SET @@LOG = @@LOG + " 	INSERT INTO "
		SET @@LOG = @@LOG + " 		TBLUSERCONTROLMASTER_JRNL "
		SET @@LOG = @@LOG + " 	SELECT "
		SET @@LOG = @@LOG + " 		*,"+CONVERT(VARCHAR,@@FLDADMINAUTO)+",'"+@@NEWDATE+"' "
		SET @@LOG = @@LOG + " 	FROM "
		SET @@LOG = @@LOG + " 		TBLUSERCONTROLMASTER "
		SET @@LOG = @@LOG + " 	WHERE "
		SET @@LOG = @@LOG + " 		FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" " --****End Log of Pradnyatable updation****
		
	--PRINT(@@LOG)
	EXEC(@@DB)

		SET @@SEGORD = @@SEGORD + 1 
		FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESERVER, @UNAME, @REMARK, @FLAG, @@MAX_EDIT 	
	 END  

	DROP TABLE #TEMP
	DROP TABLE #FLDAUTO	
COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CLIENTDETAILS
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[SP_CLIENTDETAILS]     
(
	@FROMDATE   VARCHAR(11) ,     
	@TODATE     VARCHAR(11) ,
	@FROMPARTY  VARCHAR(10) ,     
	@TOPARTY    VARCHAR(10) ,
	@BRCODE     VARCHAR(10) ,
	@CLIENTTYPE   VARCHAR(3) ,
	@STATUSID   VARCHAR(15) ,     
	@STATUSNAME VARCHAR(25) ,    
	@CLSTATUS     VARCHAR(20) ,    
	@DPSTATUS     VARCHAR(20) ,    
	@WITHTRANDT VARCHAR(10)
)
AS    


IF  (LEN(@TOPARTY)=0)
SET @TOPARTY = 'ZZZZZZZZZZ'

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT
	C2.PARTY_CODE, C1.LONG_NAME, C1.BRANCH_CD, C1.SUB_BROKER, C1.TRADER, 
	STATUS = (CASE WHEN INACTIVEFROM <= GETDATE() THEN 'INACTIVE' ELSE 'ACTIVE  ' END),     
	CONVERT(VARCHAR(10),ACTIVEFROM,103) AS ACTIVEFROM ,     
	CONVERT(VARCHAR(10),INACTIVEFROM,103) AS INACTIVEFROM, 
	APPROVER, DPID = ISNULL(C4.BANKID,''),     
	CLTDPID = ISNULL(CLTDPID,''), 
	DEPOSITORY = ISNULL(C4.DEPOSITORY,''),    
	FIRSTDATE = GETDATE(), LASTDATE = GETDATE()
	INTO
		#CLTREPORT 
	FROM
		CLIENT1 C1, CLIENT5 C5, CLIENT2 C2 LEFT OUTER JOIN CLIENT4 C4     
	ON ( C4.PARTY_CODE = C2.PARTY_CODE AND C4.DEFDP = 1 AND C4.DEPOSITORY IN('NSDL','CDSL'))     
	WHERE C1.CL_CODE = C2.CL_CODE AND C1.CL_CODE = C5.CL_CODE     
		AND C1.BRANCH_CD LIKE (CASE WHEN @BRCODE = '' THEN '%' ELSE @BRCODE END)    
		AND C1.CL_STATUS LIKE (CASE WHEN @CLIENTTYPE ='' THEN '%' ELSE @CLIENTTYPE END)
		AND INACTIVEFROM >= (CASE WHEN @CLSTATUS='ACTIVE' THEN GETDATE()+1 ELSE INACTIVEFROM END)    
		AND INACTIVEFROM <= (CASE WHEN @CLSTATUS='INACTIVE' THEN GETDATE() ELSE INACTIVEFROM END)    
		AND ACTIVEFROM >= @FROMDATE AND ACTIVEFROM <= @TODATE + ' 23:59'    
		AND LEN(ISNULL(C4.BANKID,'')) >= (CASE WHEN @DPSTATUS='WITH' THEN 1 ELSE 0 END)    
		AND LEN(ISNULL(C4.BANKID,'')) <= (CASE WHEN @DPSTATUS='WITHOUT' THEN 0 ELSE 16 END)
		AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	        AND @STATUSNAME =   
		  (CASE   
		   WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		   WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
		   WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
		   WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
		   WHEN @STATUSID = 'AREA' THEN C1.AREA  
		   WHEN @STATUSID = 'REGION' THEN C1.REGION  
		   WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
		   ELSE   
		  'BROKER'  
		  END)

	IF @WITHTRANDT ='WITHTRANDT'
	BEGIN
    
		CREATE TABLE #CLIENTLIST
		(
			PARTY_CODE VARCHAR(10),
			MINTRANDATE DATETIME,
			MAXTRANDATE DATETIME
		)

		INSERT INTO #CLIENTLIST
		SELECT 	PARTY_CODE,
			MINTRANDATE=MIN(SAUDA_DATE),
			MAXTRANDATE=MAX(SAUDA_DATE) 
		FROM BFOBILLVALAN 
		WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #CLTREPORT)
		GROUP BY PARTY_CODE

		UPDATE
			#CLTREPORT SET FIRSTDATE = MINTRANDATE,LASTDATE=MAXTRANDATE
		FROM  
			#CLIENTLIST
		WHERE
			#CLTREPORT.PARTY_CODE = #CLTREPORT.PARTY_CODE

		DROP TABLE #CLIENTLIST
	
	END
		    
	SELECT 
		PARTY_CODE,
		LONG_NAME, 
		BRANCH_CD, 
		SUB_BROKER,
		TRADER, 
		STATUS,    
		ACTIVEFROM,
		INACTIVEFROM, 
		APPROVER,
		DPID = CASE WHEN @DPSTATUS='WITH' THEN DPID ELSE '' END, 
		CLTDPID = CASE WHEN @DPSTATUS='WITH' THEN CLTDPID ELSE '' END, 
		DEPOSITORY = CASE WHEN @DPSTATUS='WITH' THEN DEPOSITORY ELSE '' END,    
		FIRSTDATE  = CASE WHEN @WITHTRANDT ='WITHTRANDT' THEN CONVERT(VARCHAR,FIRSTDATE,103) ELSE '' END,     
		LASTDATE = CASE WHEN @WITHTRANDT ='WITHTRANDT' THEN CONVERT(VARCHAR,FIRSTDATE,103) ELSE '' END  
	FROM
		#CLTREPORT    
	ORDER BY
		BRANCH_CD, LONG_NAME     
	
	DROP TABLE #CLTREPORT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CLIENTMARGINDETAILS
-- --------------------------------------------------
CREATE   PROC [DBO].[SP_CLIENTMARGINDETAILS]   
( 
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),      
	@FROMPARTY VARCHAR(20),      
	@TOPARTY VARCHAR(20),      
	@FROMDATE VARCHAR(11),      
	@TODATE VARCHAR(11),      
	@BRANCH VARCHAR(10),      
	@TRADER VARCHAR (10),    
	@ORDERBY INT,
	@INTBRANCHWISE INT      
)
AS

  
IF @TOPARTY = ''  
      BEGIN  
            SET @TOPARTY = 'ZZZZZZZ'  
      END     

    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET NOCOUNT ON

SELECT
	STRREPROTORDER = CASE 
				WHEN @ORDERBY = 2 
				THEN 
					FO.PARTY_CODE + CONVERT(VARCHAR,MARGINDATE,112)
				ELSE
					CONVERT(VARCHAR,MARGINDATE,112) + FO.PARTY_CODE
				END ,

	INTREPORTORDER2 = CASE WHEN @INTBRANCHWISE = 1 THEN FO.BRANCH_CD ELSE '' END,

	MARGINDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,109),11),BILLDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,103),11),FO.PARTY_CODE,      
	FO.BRANCH_CD,FO.SUB_BROKER,FO.TRADER,FO.SHORT_NAME,BILLAMOUNT = ISNULL(BILLAMOUNT,0),LEDGERAMOUNT = ISNULL(LEDGERAMOUNT,0),      
	CASH_COLL = ISNULL(CASH_COLL,0),NONCASH_COLL=ISNULL(NONCASH_COLL,0),      
	INITIALMARGIN = ISNULL(INITIALMARGIN,0), MTMMARGIN = ISNULL(MTMMARGIN,0),
	ADDMARGIN = ISNULL(ADDMARGIN,0),
	YEAR(MARGINDATE),MONTH(MARGINDATE),DAY(MARGINDATE)      
FROM
	TBL_CLIENTMARGIN FO (NOLOCK),
	CLIENT1 , CLIENT2
WHERE
	MARGINDATE >= @FROMDATE      
	AND MARGINDATE <= @TODATE + ' 23:59:00'      
	AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
	AND FO.PARTY_CODE >= @FROMPARTY      
	AND FO.PARTY_CODE <= @TOPARTY      
	AND FO.BRANCH_CD LIKE @BRANCH    
	AND FO.TRADER LIKE @TRADER    
	AND @STATUSNAME = 
		(CASE 
			WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN FO.TRADER
			WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
			WHEN @STATUSID = 'AREA' THEN AREA
			WHEN @STATUSID = 'REGION' THEN REGION
			WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
			ELSE 
		'BROKER'
		END)      
	AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
  ORDER BY  2,1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CONTRACTMASTER_BLK_POP
-- --------------------------------------------------
CREATE  PROC SP_CONTRACTMASTER_BLK_POP (@INTMODE INT)  --EXEC SP_CONTRACTMASTER_BLK_POP '2'
AS      
   
 --IF @INTMODE=1   
 --BEGIN  
  DECLARE @FILEDATA CURSOR    
  DECLARE @ROWDATA VARCHAR(2000),    
  @SQL VARCHAR(2000)    
    
  TRUNCATE TABLE BFOSCRIP1_IMP  
   
  SET @FILEDATA = CURSOR FOR  SELECT  ''''+REPLACE(TEXTDATA,'|',''',''')+ '''' FROM FILE_DATA (NOLOCK) WHERE LEN(TEXTDATA) > 20    
  OPEN @FILEDATA      
    
   FETCH NEXT FROM @FILEDATA INTO @ROWDATA    
   WHILE @@FETCH_STATUS = 0           
    BEGIN          
     SELECT @SQL =  'INSERT INTO BFOSCRIP1_IMP VALUES ('+@ROWDATA+')'    
     EXEC (@SQL)     
   FETCH NEXT FROM @FILEDATA INTO @ROWDATA    
  END          
  CLOSE @FILEDATA          
  DEALLOCATE @FILEDATA    
--END  
   
 TRUNCATE TABLE BFOSCRIP2_IMP  
   
 INSERT INTO BFOSCRIP2_IMP  
 SELECT   
 PRODUCTTYPE,PRODUCTCODE,SERIESCODE,CONVERT(INT,SERIESID),SERIESTYPE,SERIESNAME,LEFT(CONVERT(DATETIME,ENDTIMESTAMP,103),11) + ' 23:59',  
 LEFT(CONVERT(DATETIME,ENDTIMESTAMP,103),11) + ' 23:59',  
 LEFT(CONVERT(DATETIME,STARTTIMESTAMP,103),11) ,LIFETIME=0,ISIN_CODE=0,BASE_PRICE=0,  
 CONVERT(NUMERIC,MULTIPLIER),'',CONVERT(INT,MARKETLOT),CONVERT(NUMERIC,CEILINGDEPTH),CALLPUT,OPTIONSTYLE,CONVERT(NUMERIC,STRIKEPRICE),  
 CONVERT(NUMERIC,NEARSERIESID),CONVERT(NUMERIC,FARSERIESID),0,RESERVED1,RESERVED2,0,0,0  
 FROM BFOSCRIP1_IMP  
   
   
  DELETE             
    BFOSCRIP2              
  FROM            
    BFOSCRIP2_IMP            
  WHERE             
    BFOSCRIP2.PRODUCT_TYPE = BFOSCRIP2_IMP.PRODUCT_TYPE            
    AND BFOSCRIP2.PRODUCT_CODE = BFOSCRIP2_IMP.PRODUCT_CODE    
    AND BFOSCRIP2.SERIES_ID = BFOSCRIP2_IMP.SERIES_ID     
    AND BFOSCRIP2.SERIES_CODE = BFOSCRIP2_IMP.SERIES_CODE     
    AND BFOSCRIP2.SERIES_TYPE = BFOSCRIP2_IMP.SERIES_TYPE            
   
   
  INSERT INTO BFOSCRIP2    
  SELECT   
  PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,SERIES_TYPE,SEC_NAME,EXPIRYDATE,MATURITYDATE,  
  OPENINGDAY,LIFETIME,ISIN_CODE,BASE_PRICE,MULTIPLIER,MARKETSEGMENT,MARKETLOT,CEILINGDEPTH,CALLPUT,OPTIONSTYLE,  
  STRIKEPRICE,NEARSERIESID,FARSERIESID,COR_ACT_LEVEL,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5  
  FROM BFOSCRIP2_IMP (NOLOCK)    
      
  INSERT INTO BFOSCRIP1   
  SELECT TOP 10 '','',PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,'',0,0  
  FROM BFOSCRIP2_IMP (NOLOCK)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CONTRACTMASTER_UPD
-- --------------------------------------------------

CREATE PROC SP_CONTRACTMASTER_UPD AS      
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
    
BEGIN TRAN      
      
 TRUNCATE TABLE BFOSCRIP2_IMP  
   
 INSERT INTO BFOSCRIP2_IMP  
 SELECT   
 PRODUCTTYPE,PRODUCTCODE,SERIESCODE,CONVERT(INT,SERIESID),SERIESTYPE,SERIESNAME,LEFT(CONVERT(DATETIME,ENDTIMESTAMP,103),11) + ' 23:59',  
 LEFT(CONVERT(DATETIME,ENDTIMESTAMP,103),11) + ' 23:59',  
 LEFT(CONVERT(DATETIME,STARTTIMESTAMP,103),11) ,LIFETIME=0,ISIN_CODE=0,BASE_PRICE=0,  
 CONVERT(NUMERIC,MULTIPLIER),'',CONVERT(INT,MARKETLOT),CONVERT(NUMERIC,CEILINGDEPTH),CALLPUT,OPTIONSTYLE,CONVERT(NUMERIC,STRIKEPRICE),  
 CONVERT(NUMERIC,NEARSERIESID),CONVERT(NUMERIC,FARSERIESID),0,RESERVED1,RESERVED2,0,0,0  
 FROM BFOSCRIP1_IMP  
   
   
  DELETE             
    BFOSCRIP2              
  FROM            
    BFOSCRIP2_IMP            
  WHERE             
    BFOSCRIP2.PRODUCT_TYPE = BFOSCRIP2_IMP.PRODUCT_TYPE            
    AND BFOSCRIP2.PRODUCT_CODE = BFOSCRIP2_IMP.PRODUCT_CODE    
    AND BFOSCRIP2.SERIES_ID = BFOSCRIP2_IMP.SERIES_ID     
    AND BFOSCRIP2.SERIES_CODE = BFOSCRIP2_IMP.SERIES_CODE     
    AND BFOSCRIP2.SERIES_TYPE = BFOSCRIP2_IMP.SERIES_TYPE            
   
   
  INSERT INTO BFOSCRIP2    
  SELECT   
  PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,SERIES_TYPE,SEC_NAME,EXPIRYDATE,MATURITYDATE,  
  OPENINGDAY,LIFETIME,ISIN_CODE,BASE_PRICE,MULTIPLIER,MARKETSEGMENT,MARKETLOT,CEILINGDEPTH,CALLPUT,OPTIONSTYLE,  
  STRIKEPRICE,NEARSERIESID,FARSERIESID,COR_ACT_LEVEL,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5  
  FROM BFOSCRIP2_IMP (NOLOCK)    
      
  INSERT INTO BFOSCRIP1   
  SELECT  '','',PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,'',0,0  
  FROM BFOSCRIP2_IMP (NOLOCK)  
     
      
COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FOSPANMARGIN_UPD
-- --------------------------------------------------

CREATE PROC SP_FOSPANMARGIN_UPD (@SAUDA_DATE VARCHAR(11)) AS

CREATE TABLE [#FOSPANMARGINNEW] 
(
	[PARTY_CODE] [VARCHAR] (10)  ,
	[SYMBOL] [VARCHAR] (12),
	[SPANMARGIN] [MONEY]  ,
	[PREMIUM] [MONEY]  ,
	[TOTALMARGIN] [MONEY]  ,
	[PMARGINRATE] [DECIMAL](18, 0)  ,
	[NEWSPANMARGIN] [MONEY]  ,
	[FINALTOTALMARGIN] [MONEY]  ,
	[MTOM] [MONEY]  
)

INSERT INTO #FOSPANMARGINNEW
SELECT 
	PARTY_CODE = ACCT,
	SYMBOL = REPLACE(CC,'&amp;','&'),
	SPANMARGIN = (SPANREQ - ANOV),
	PREMIUM = 0,
	TOTALMARGIN = 0,
	PMARGINRATE = 0,
	NEWSPANMARGIN = 0,
	TOTALMARGIN= 0,
	MTOM = 0
FROM 
	SPANMARGIN_INTRADAY (NOLOCK)
WHERE
	NODE='DREQ'
	AND INTRADATE LIKE @SAUDA_DATE +'%'


UPDATE 
	#FOSPANMARGINNEW
SET
	PMARGINRATE = CLIENT3.PMARGINRATE
FROM
	CLIENT3 (NOLOCK)
WHERE 
	CLIENT3.PARTY_CODE = #FOSPANMARGINNEW.PARTY_CODE


UPDATE
	#FOSPANMARGINNEW
SET
	NEWSPANMARGIN = SPANMARGIN + (SPANMARGIN * PMARGINRATE /100)



UPDATE #FOSPANMARGINNEW
SET    SPANMARGIN = 0 
FROM 
(
SELECT PARTY_CODE
	  ,SPAN = SUM(SPANMARGIN)
FROM   #FOSPANMARGINNEW
GROUP BY PARTY_CODE
HAVING SUM(SPANMARGIN) < 0
) S 
WHERE #FOSPANMARGINNEW.PARTY_CODE = S.PARTY_CODE

UPDATE
	#FOSPANMARGINNEW
SET
	TOTALMARGIN = SPANMARGIN + PREMIUM,
	FINALTOTALMARGIN = (SPANMARGIN + PREMIUM) + NEWSPANMARGIN


DELETE FOMARGIN_SPAN WHERE MDATE LIKE @SAUDA_DATE + '%'

INSERT INTO FOMARGIN_SPAN
SELECT
	PARTY_CODE,
	SYMBOL,
	SPANMARGIN,
	PREMIUM,
	TOTALMARGIN,
	PMARGINRATE,
	MDATE=@SAUDA_DATE,
	NEWSPANMARGIN,
	FINALTOTALMARGIN,
	CL_TYPE='CL'
FROM
	#FOSPANMARGINNEW


INSERT INTO FOMARGIN_SPAN
SELECT
	PARTY_CODE=(SELECT MEMBERCODE FROM FOOWNER),
	SYMBOL ='',
	SPANMARGIN= SUM(SPANMARGIN),
	PREMIUM = SUM(PREMIUM),
	TOTALMARGIN = SUM(TOTALMARGIN),
	PMARGINRATE=0,
	MDATE=@SAUDA_DATE,
	NEWSPANMARGIN=SUM(NEWSPANMARGIN),
	FINALTOTALMARGIN=SUM(FINALTOTALMARGIN),
	CL_TYPE='TM'
FROM
	#FOSPANMARGINNEW


DROP TABLE #FOSPANMARGINNEW

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_GETPOSITIONSPAN
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[SP_GETPOSITIONSPAN]  
  (  
 @SDATE VARCHAR(11),    
 @PARTYFROM VARCHAR(10),  
 @PARTYTO VARCHAR(10),  
 @MODE VARCHAR(10)  
  
  )  
AS    
  
DECLARE @INTMONTH INT,  
 @INTYEAR INT  
  
SELECT @INTMONTH=MONTH(CONVERT(DATETIME,@SDATE)),@INTYEAR=YEAR(CONVERT(DATETIME,@SDATE))  
  
IF @PARTYTO ='' BEGIN SET @PARTYTO = 'ZZZZZZ' END  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
IF @MODE ='NORMAL'  
BEGIN  
 SELECT   
  PARTY_CODE,  
  INST_TYPE=PRODUCT_CODE,  
  SYMBOL=PRODUCT_CODE,  
  EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),  
  OPTION_TYPE=PRODUCT_TYPE,  
  STRIKE_PRICE,   
  PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ),  
  SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END )  
 FROM  
  BFOSETTLEMENT   
 WHERE   
  RESERVED1 <> 1  
  AND EXPIRYDATE > @SDATE + ' 23:59'    
  AND SAUDA_DATE <= @SDATE + ' 23:59'    
  AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
 GROUP BY   
  PARTY_CODE,  
  PRODUCT_CODE,  
  LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),  
  PRODUCT_TYPE,  
  STRIKE_PRICE  
 HAVING SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ) - SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END ) <> 0    
END  
ELSE IF @MODE ='3DAYS1'  
BEGIN  
 SELECT   
  PARTY_CODE,  
  INST_TYPE=PRODUCT_CODE,  
  SYMBOL=PRODUCT_CODE,  
  EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),  
  OPTION_TYPE=PRODUCT_TYPE,  
  STRIKE_PRICE,   
  PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ),  
  SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END )  
 FROM  
  BFOSETTLEMENT   
 WHERE   
  RESERVED1 <> 1  
  AND EXPIRYDATE > @SDATE + ' 23:59'    
  AND SAUDA_DATE <= @SDATE + ' 23:59'    
  AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
  AND MONTH(EXPIRYDATE) = @INTMONTH  
  AND YEAR(EXPIRYDATE) = @INTYEAR  
 GROUP BY   
  PARTY_CODE,  
  PRODUCT_CODE,  
  LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),  
  PRODUCT_TYPE,  
  STRIKE_PRICE  
 HAVING SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ) - SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END ) <> 0    
END  
ELSE IF @MODE ='3DAYS2'  
BEGIN  
 SELECT   
  PARTY_CODE,  
  INST_TYPE=PRODUCT_CODE,  
  SYMBOL=PRODUCT_CODE,  
  EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),  
  OPTION_TYPE=PRODUCT_TYPE,  
  STRIKE_PRICE,   
  PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ),  
  SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END )  
 FROM  
  BFOSETTLEMENT   
 WHERE   
  RESERVED1 <> 1  
  AND EXPIRYDATE > @SDATE + ' 23:59'    
  AND SAUDA_DATE <= @SDATE + ' 23:59'    
  AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
  AND   
  (  
   MONTH(EXPIRYDATE) > @INTMONTH  
   OR  
   YEAR(EXPIRYDATE) > @INTYEAR  
  )  
 GROUP BY   
  PARTY_CODE,  
  PRODUCT_CODE,  
  LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),  
  PRODUCT_TYPE,  
  STRIKE_PRICE  
 HAVING SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ) - SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END ) <> 0    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MENU_RIGHTS
-- --------------------------------------------------
CREATE PROC [DBO].[SP_MENU_RIGHTS]   
(  
 @NOPT INT,   
 @VALIDDATE VARCHAR(20)='',  
 @NALERT INT=0  
)  
AS   
  
CREATE TABLE #VERSION  
(  
  ERRCODE1 VARCHAR(100),    
  ERRCODE2 VARCHAR(100),    
  ERRCODE3 VARCHAR(10),    
  ERRCODE4 VARCHAR(50),    
  ERRCODE5 VARCHAR(50),    
  ERRCODE6 VARCHAR(50),    
  ERRCODE7 VARCHAR(50),
  ERRCODE8 VARCHAR(100),        
  ERRCODE9 VARCHAR(100),        
  ERRCODE10 VARCHAR(10),        
  ERRCODE11 VARCHAR(100),       
  ERRCODE12 VARCHAR(100),      
  ERRCODE13 VARCHAR(100),        
  ERRCODE14 VARCHAR(100)   
)  
  
INSERT INTO #VERSION EXEC CHECKVERSION  
  
IF @NOPT =1  
BEGIN  
 SELECT ERRCODE2,ERRCODE3 FROM #VERSION  
END  
ELSE  
BEGIN  
  
 SELECT CASE  
  WHEN DATEDIFF(D,GETDATE(),@VALIDDATE)- @NALERT < 0  
  THEN ERRCODE7 + ' ' + @VALIDDATE  
  WHEN  CONVERT(VARCHAR,GETDATE(),112) >= CONVERT(VARCHAR,CONVERT(DATETIME,@VALIDDATE,112),112)  
  THEN ERRCODE6  
  ELSE ''   
 END AS USERMSG  
 FROM #VERSION   
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MENU_RIGHTS_23022012
-- --------------------------------------------------
CREATE PROC [DBO].[SP_MENU_RIGHTS_23022012]   
(  
 @NOPT INT,   
 @VALIDDATE VARCHAR(20)='',  
 @NALERT INT=0  
)  
AS   
  
CREATE TABLE #VERSION  
(  
  ERRCODE1 VARCHAR(100),    
  ERRCODE2 VARCHAR(100),    
  ERRCODE3 VARCHAR(10),    
  ERRCODE4 VARCHAR(50),    
  ERRCODE5 VARCHAR(50),    
  ERRCODE6 VARCHAR(50),    
  ERRCODE7 VARCHAR(50)  
)  
  
INSERT INTO #VERSION EXEC CHECKVERSION  
  
IF @NOPT =1  
BEGIN  
 SELECT ERRCODE2,ERRCODE3 FROM #VERSION  
END  
ELSE  
BEGIN  
  
 SELECT CASE  
  WHEN DATEDIFF(D,GETDATE(),@VALIDDATE)- @NALERT < 0  
  THEN ERRCODE7 + ' ' + @VALIDDATE  
  WHEN  CONVERT(VARCHAR,GETDATE(),112) >= CONVERT(VARCHAR,CONVERT(DATETIME,@VALIDDATE,112),112)  
  THEN ERRCODE6  
  ELSE ''   
 END AS USERMSG  
 FROM #VERSION   
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MTOMCHECK
-- --------------------------------------------------
CREATE  PROC SP_MTOMCHECK (@SAUDA_DATE VARCHAR(11)) AS    
    
DECLARE @EXALLOCAMT NUMERIC (18,4)    
DECLARE @PREMIUM NUMERIC (18,4)    
DECLARE @MTM NUMERIC (18,4)    
DECLARE @ERRFLAG INT    
DECLARE @INTCOUNT INT  
    
SET NOCOUNT OFF    
    
SET @ERRFLAG = 0    
SELECT     
 @EXALLOCAMT = ABS(ISNULL(SUM(ISNULL(EXERCISED_ASSIGNED_VALUE,0)),0)),    
 @PREMIUM = ABS(ISNULL(SUM(ISNULL(NET_PREMIUM,0)),0)),    
 @MTM = ABS(ISNULL(SUM(ISNULL(DAILY_MTM_SETTLEMENT_VALUE,0)+ISNULL(FINAL_SETTLEMENT_VALUE,0)),0)),  
 @INTCOUNT = COUNT(1)  
FROM     
 BFOEXERCISEALLOCATION (NOLOCK)    
WHERE     
 POSITION_DATE LIKE @SAUDA_DATE  + '%'    
    
IF (ABS(@EXALLOCAMT) + ABS(@PREMIUM) + ABS(@MTM)) + @INTCOUNT = 0     
BEGIN    
 SELECT 'ERROR','POSITION FILE IS NOT IMPORTED. PLEASE CHECK.'    
 SET @ERRFLAG = 1    
END    
    
IF @MTM <> 0     
BEGIN    
 IF NOT EXISTS (SELECT * FROM BFOACCBILL (NOLOCK)  WHERE BILLDATE LIKE @SAUDA_DATE + '%'    
     AND PARTY_CODE = (SELECT ACCODE FROM VALANACCOUNT    
        WHERE ACNAME = 'CLEARING HOUSE')      
     AND BRANCHCD = 'ZZZ'     
     AND ABS(AMOUNT) = @MTM)    
 BEGIN    
  SELECT 'ERROR','MTOM IS NOT MATCHING. PLEASE CHECK.'    
  SET @ERRFLAG = 1    
 END    
END    
    
IF @PREMIUM  <> 0  AND @ERRFLAG = 0  
BEGIN    
 IF NOT EXISTS (SELECT * FROM BFOACCBILL (NOLOCK)  WHERE BILLDATE LIKE @SAUDA_DATE + '%'    
     AND PARTY_CODE = (SELECT ACCODE FROM VALANACCOUNT    
        WHERE ACNAME = 'CLEARING PREMIUM ACCOUNT')      
     AND BRANCHCD = 'ZZZ'     
     AND ABS(AMOUNT) = @PREMIUM)    
 BEGIN    
  SELECT 'ERROR','PREMIUM IS NOT MATCHING. PLEASE CHECK.'    
  SET @ERRFLAG = 1    
 END    
END    
    
IF @EXALLOCAMT <>0   AND @ERRFLAG = 0  
BEGIN    
 IF NOT EXISTS (SELECT * FROM BFOACCBILL (NOLOCK)  WHERE BILLDATE LIKE @SAUDA_DATE + '%'    
     AND PARTY_CODE = (SELECT ACCODE FROM VALANACCOUNT    
        WHERE ACNAME = 'OPTION EXERCISE')      
     AND BRANCHCD = 'ZZZ'     
     AND ABS(AMOUNT) = @EXALLOCAMT)    
 BEGIN    
  SELECT 'ERROR','EXCECISE ALLOCATION IS NOT MATCHING. PLEASE CHECK.'    
  SET @ERRFLAG = 1    
 END    
END     
IF @ERRFLAG = 0    
BEGIN    
 SELECT 'SUCCESS',''    
END    
    
SET NOCOUNT ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_STAMPDUTYDETAILS
-- --------------------------------------------------

CREATE PROCEDURE  [DBO].[SP_STAMPDUTYDETAILS] (@FROMDATE VARCHAR(11),  @TODATE VARCHAR(11),@LSTCLTYPE VARCHAR(10))      
      
AS      
      
      
SELECT       
    SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,103),11),       
    TOTAMOUNT = ISNULL(ROUND(SUM( trade_price * TRADEQTY ),2),0) ,       
      
    BROKER_CHRG = CEILING(SUM(TRADEQTY* CASE WHEN AUCTIONPART <> 'EA'  THEN trade_price ELSE STRIKE_PRICE END * CAST(BFOTAXES.BROKER_NOTE AS MONEY) /100)),      
      
    OPTIONPAMT= ISNULL(ROUND(SUM(      
    CASE       
        WHEN BFOSETTLEMENT.PRODUCT_CODE LIKE '%OPT'       
        AND AUCTIONPART =''       
        THEN TRADEQTY*trade_price       
        ELSE 0       
    END      
    ),2),0),       
    FUTAMT= ISNULL(ROUND(SUM(      
    CASE       
        WHEN BFOSETTLEMENT.PRODUCT_CODE LIKE '%FUT'       
        AND AUCTIONPART ='0'       
        THEN TRADEQTY*trade_price       
        ELSE 0       
    END      
    ),2),0),       
    EAAMT= CEILING(ISNULL(SUM(      
    CASE       
        WHEN BFOSETTLEMENT.PRODUCT_CODE LIKE '%OPT'       
        AND AUCTIONPART ='EA'       
        THEN TRADEQTY*STRIKE_PRICE       
        ELSE 0       
    END      
    ),0))      
FROM BFOSETTLEMENT (NOLOCK),       
 CLIENT1 (NOLOCK),       
 CLIENT2 (NOLOCK),       
 BFOOWNER (NOLOCK),      
 BFOTAXES  (NOLOCK)     
WHERE BFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE       
    AND CLIENT1.CL_CODE = CLIENT2.CL_CODE       
    AND AUCTIONPART <> 'CA'       
    AND SAUDA_DATE BETWEEN @FROMDATE AND @TODATE  + ' 23:59'      
    AND CLIENT1.CL_TYPE LIKE       
    CASE       
        WHEN @LSTCLTYPE <>'ALL'       
        THEN @LSTCLTYPE       
        ELSE '%'       
    END       
AND BFOTAXES.TRANS_CAT ='TRD'
AND SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 
      
GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,103),11)      
ORDER BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,103),11)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_STT_Annexure_Cum
-- --------------------------------------------------
CREATE   proc [dbo].[sp_STT_Annexure_Cum]   (@datefrom varchar(11),@dateto varchar(11), @partyfrom varchar(10),      
  @partyto varchar(10), @statusid varchar(15), @statusname varchar(25),  @strbranch varchar(12),       
  @strbranchto varchar(12),  @strsubbrokfrom varchar(12),  @strsubbrokto varchar(12) )              
  AS      
             
if len(ltrim(rtrim(@partyto))) = 0       
  begin              
     Set @partyto = 'ZZZZZZZZZ'          
  end      
              
if len(ltrim(rtrim(@strbranchto))) = ''               
begin               
 set @strbranchto = 'ZZZZZZZZZZZZZZ'               
               
end              
              
if len(ltrim(rtrim(@strsubbrokto))) = ''              
begin               
 set @strsubbrokto = 'ZZZZZZZZZZZ'                    
end              
              
Set transaction isolation level read uncommitted               
    
Select Party_code,  TransactionCode = '04', TurnOver = sum(TurnOver), Stt = sum(Stt)          
into #Stt04 from       
(    
 Select Sauda_date =left(Sauda_date,11), Party_Code, TurnOver = sum(SAmtTrd), Stt = round(sum(SSTTTrd),0)    
 From STT_ClientDetail   (nolock)    
 where party_code between @partyfrom and @partyto and  sauda_date between @datefrom and  @dateto +' 23:59'       
 and  left(Inst_type,3) = 'OPT'    
 group by left(Sauda_date,11),Party_Code    
) SttDetail    
Group By Party_code Order By Party_code            
    
    
    
Select Party_code,  TransactionCode = '05', TurnOver = sum(TurnOver), Stt = sum(Stt)          
into #Stt05 from       
(    
 Select Sauda_date =left(Sauda_date,11),Party_Code,  TurnOver = sum(SAmtTrd), Stt = round(sum(SSTTTrd),0)    
 From STT_ClientDetail  (nolock)    
 where party_code between @partyfrom and @partyto and  sauda_date between @datefrom and  @dateto +' 23:59'       
 and  left(Inst_type,3) = 'FUT'    
 group by left(Sauda_date,11),Party_Code    
) SttDetail    
Group By Party_code Order By Party_code        
    
    
Select         
 Company, addr1, addr2, city, zip, phone, 'NSE F&O' exchangecode,         
 membercode,C2.Party_code, long_name,        
 L_address1+' '+ L_address2 + ' '+ L_address3+ ' '+ C1.L_City L_address1,        
 pan_gir_no, mapidid = convert(varchar(15), '')   
        
into #Client        
        
From         
Client1 C1,Client2 C2,FoOwner        
Where         
 C1.Cl_Code =c2.Cl_Code and         
 party_code >= @partyfrom and party_code <= @partyto  and             
 branch_cd >= @strbranch and  branch_cd <= @strbranchto  and             
 sub_broker >= @strsubbrokfrom  and sub_broker <= @strsubbrokto and                   
 branch_cd like (case when @statusid = 'branch' then @statusname else '%' end) and             
 sub_broker like (case when @statusid = 'subbroker' then @statusname else '%' end) and             
 trader like (case when @statusid = 'trader' then @statusname else '%' end) and             
 c1.family like (case when @statusid = 'family' then @statusname else '%' end)  and             
 c1.cl_code like (case when @statusid = 'client' then @statusname else '%' end)            
      
Select Party_Code,'01' TransactionCode ,0 TurnOver,0 STT into #Stt01  From #Client          
Select Party_Code,'02' TransactionCode ,0 TurnOver,0 STT into #Stt02  From #Client          
Select Party_Code,'03' TransactionCode ,0 TurnOver,0 STT into #Stt03  From #Client          
      
         
Insert into #Stt04 Select Party_Code,'04',0,0 From #Client Where Party_Code           
not in (Select Party_Code from #Stt04)          
          
Insert into #Stt05 Select Party_Code,'05',0,0 From #Client Where Party_Code           
not in (Select Party_Code from #Stt05)          
          
      
Select s.Party_code,TransactionCode, TurnOver,  STT             
into #Stt00          
          
From          
          
(           
  Select Party_code,TransactionCode, TurnOver, STT  From #Stt01              
  Union          
  Select Party_code,TransactionCode,TurnOver, STT   From #Stt02          
  Union           
  Select Party_code,TransactionCode, TurnOver,  STT  From #Stt03          
  Union           
  Select Party_code,TransactionCode, TurnOver,  STT  From #Stt04          
  Union           
  Select Party_code,TransactionCode, TurnOver,  STT  From #Stt05          
          
) S      
          
Order By s.Party_code,TransactionCode          
  
update #client set mapidid = UCC_Client.mapidid  
from UCC_Client  
Where UCC_Client.party_code = #client.party_code  
      
Select Company, addr1, addr2, city, zip, phone, exchangecode,         
 membercode,long_name, L_address1, pan_gir_no, isnull(mapidid, '') mapinid,         
 s.Party_code,TransactionCode, TurnOver,  STT, convert(varchar, getdate(), 103) CurDate          
From  #Client C  , #Stt00 S   
where S.Party_Code = C.Party_Code          
and S.party_code in ( Select party_code from #Stt00 group by party_code having sum(stt) > 0 )      
      
Drop Table #Stt00    
Drop Table #Stt01    
Drop Table #Stt02    
Drop Table #Stt03    
Drop Table #Stt04    
Drop Table #Stt05

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPUPDATEPROCESSCONTROLER
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[SPUPDATEPROCESSCONTROLER] (  
 @SVBUSINESS_DATE AS VARCHAR(11),  
 @SVPROCESS_ID AS VARCHAR(30),  
    @SVFILENAME AS VARCHAR(50)= '',  
    @SVPROCESSBY AS VARCHAR(50)='',  
    @SVMACHINEIP   AS VARCHAR(20)=''  
)  
  
AS  
BEGIN  
  
  
DECLARE @_DVBUSSINESS_DATE  AS SMALLDATETIME,  
     @_SVPROCESSCOLNAME  AS VARCHAR(30),  
  @_SVPROCESS_NAME    AS VARCHAR(50),  
        @_SVSQL             AS VARCHAR(2000),  
  @_SVSEGMENT         AS VARCHAR(6)  
  
  
 --SELECT * FROM V2_BUSINESS_PROCESS  
 SET @_SVSEGMENT ='FUTURES'  
  
 IF @SVPROCESS_ID='IMPTRD'            --TRADE IMPORT   
 BEGIN  
  SET @_SVPROCESSCOLNAME='IMPORT_TRADE'  
  SET @_SVPROCESS_NAME  ='IMPORT TRADE'  
 END  
 ELSE IF @SVPROCESS_ID='STTIMP'       --STT FILE IMPORT  
 BEGIN  
  SET @_SVPROCESSCOLNAME='EXCHANGESTT'  
  SET @_SVPROCESS_NAME  ='IMPORT STT'  
 END   
 ELSE IF @SVPROCESS_ID='OPEXALL'       --OPTION EXERCISE ALLOCATION  
 BEGIN  
  SET @_SVPROCESSCOLNAME='EXERCISEALLOCATION'  
  SET @_SVPROCESS_NAME  ='EXERCISE ALLOCATION'  
 END   
  
 ELSE IF @SVPROCESS_ID='STT'       --CALCULATE STT  
 BEGIN  
  SET @_SVPROCESSCOLNAME='STT'  
  SET @_SVPROCESS_NAME  ='STT COMPUTATION'  
 END   
 ELSE IF @SVPROCESS_ID='BILLGEN'       --BILL GENERATION  
 BEGIN  
  SET @_SVPROCESSCOLNAME='BILLING'  
  SET @_SVPROCESS_NAME  ='BILL GENERATION'  
 END   
 ELSE IF @SVPROCESS_ID='POSTING'       --BILL POSTING  
 BEGIN  
  SET @_SVPROCESSCOLNAME='POSTING'  
  SET @_SVPROCESS_NAME  ='BILL POSTING'  
 END   
 ELSE IF @SVPROCESS_ID='CONTRACT'       --CONTRACT GENERATION  
 BEGIN  
  SET @_SVPROCESSCOLNAME='CONTRACT'  
  SET @_SVPROCESS_NAME  ='CONTRACT POPUP'  
 END   
  
 ELSE IF @SVPROCESS_ID='COLLCOMP'       --COLLATERAL COMPUTATION  
 BEGIN  
  SET @_SVPROCESSCOLNAME='COLLATERALCOMPUTATION'  
  SET @_SVPROCESS_NAME  ='COLLATERAL COMPUTATION'  
 END   
 ELSE IF @SVPROCESS_ID='MRGIMP'       --IMPORT MARGIN FILE  
 BEGIN  
  SET @_SVPROCESSCOLNAME='MARGINFILE'  
  SET @_SVPROCESS_NAME  ='MARGIN FILE IMPORT'  
 END   
 ELSE IF @SVPROCESS_ID='MRGPOP'       --MARGIN VALIDATE  
 BEGIN  
  SET @_SVPROCESSCOLNAME='CLIENTMARGINPOP'  
  SET @_SVPROCESS_NAME  ='CLIENT MARGIN POP'  
 END   
 ELSE IF @SVPROCESS_ID='CLPIMP'       --CLOSING RATE 
 BEGIN  
  SET @_SVPROCESSCOLNAME='CLOSINGPRICE'  
  SET @_SVPROCESS_NAME  ='CLOSING RATE'  
 END    
  
  
 --CONVERT VARCHAR TO DATETIME  
 SET @_DVBUSSINESS_DATE=@SVBUSINESS_DATE  
  
 --FIRST TRADE UPLOAD  
 IF NOT EXISTS (SELECT 1 FROM V2_BUSINESS_PROCESS WHERE  BUSINESS_DATE = @_DVBUSSINESS_DATE)   
 BEGIN        
    
   INSERT INTO V2_BUSINESS_PROCESS     
    (    
     BUSINESS_DATE,IMPORT_TRADE,VBB,STT,BILLING,CONTRACT,    
     POSTING,POSITIONFILE,MARGINFILE,MARGINRETURNFILE,    
     CLIENTMARGINPOP,EXCHANGESTT,EXERCISEALLOCATION,OPEN_CLOSE,    
     PROCESSDATE,PROCESSBY,LASTUPDATEDATE,LASTUPDATEBY,MACHINEIP    
    )    
   SELECT      
    @_DVBUSSINESS_DATE, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, GETDATE(), '', GETDATE(), '', ''     
  END    
  
 ELSE IF @SVPROCESS_ID='IMPTRD'        ---IF TRADE UPLOAD ALREADY DONE  
 BEGIN    
   UPDATE     
   V2_BUSINESS_PROCESS     
   SET     
    VBB = 0 ,    
    STT = 0,    
    BILLING = 0,    
    POSTING = 0,    
    LASTUPDATEDATE = GETDATE()     
   WHERE     
   BUSINESS_DATE = @_DVBUSSINESS_DATE    
 END  
 ELSE        ---OTHER PROCESS UPDATE THE STATUS  
 BEGIN  
  SET @_SVSQL ='UPDATE V2_BUSINESS_PROCESS  SET ' + @_SVPROCESSCOLNAME + ' = ' + @_SVPROCESSCOLNAME + '+ 1,  
       LASTUPDATEDATE = GETDATE() WHERE CONVERT(VARCHAR,BUSINESS_DATE) =''' + CONVERT(VARCHAR,@_DVBUSSINESS_DATE) + ''''  
  
  EXEC(@_SVSQL)      
 END  
     
  
--TO MAINTAIN THE LOG  
 INSERT INTO V2_PROCESS_STATUS_LOG     
 (     
  EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,    
  FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP    
 )    
 SELECT    
  EXCHANGE=(SELECT TOP 1 EXCHANGE FROM BFOTAXES),    
  SEGMENT=@_SVSEGMENT,    
  BUSINESSDATE=@_DVBUSSINESS_DATE,    
  PROCESSID =@SVPROCESS_ID,    
  PROCESSNAME=@_SVPROCESS_NAME,    
  FILENAME=@SVFILENAME,    
  START_END_FLAG=1,    
  PROCESSDATE=GETDATE(),    
  PROCESSBY='',    
  MACHINEIP=''    
  
END  
  
/*---------EXECUTION ----------------  
  
 DECLARE @SVBUSINESS_DATE AS VARCHAR(11),  
   @SVPROCESS_ID AS VARCHAR(30)  
 SET @SVBUSINESS_DATE='25 JAN 2007'  
 SET @SVPROCESS_ID='COLLCOMP'  
 EXEC SPUPDATEPROCESSCONTROLER  @SVBUSINESS_DATE,@SVPROCESS_ID  
  
SELECT * FROM V2_BUSINESS_PROCESS  
  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_CHARGES_FINAL
-- --------------------------------------------------

CREATE PROC [dbo].[STT_CHARGES_FINAL]  
(  
           @SAUDA_DATE VARCHAR(11),  
           @PARTYFROM  VARCHAR(10)  = '',  
           @PARTYTO    VARCHAR(11)  = 'ZZZZZZZZ',  
           @USERNAME   VARCHAR(50)  = ''  
)  
AS  
  
  DECLARE  @TRDSELLTRANS    NUMERIC(18,4),  
           @OPTTRDSELLTRANS NUMERIC(18,4),  
           @OPTDELSELLTRANS NUMERIC(18,4),  
           @STT_ON          VARCHAR(7)  
                              
  SET @TRDSELLTRANS = 0  
                        
  SET @OPTTRDSELLTRANS = 0  
                           
  SET @OPTDELSELLTRANS = 0  
                           
  SELECT @TRDSELLTRANS = TRDSELLTRANS,  
         @OPTTRDSELLTRANS = OPTTRDSELLTRANS,  
         @OPTDELSELLTRANS = OPTDELSELLTRANS,  
         @STT_ON = STT_ON  
  FROM   BFOGLOBALS  
  WHERE  YEAR_START_DT <= @SAUDA_DATE  
         AND YEAR_END_DT >= @SAUDA_DATE  
                              
  IF (@TRDSELLTRANS > 0  
       OR @OPTTRDSELLTRANS > 0  
       OR @OPTDELSELLTRANS > 0)   
         
BEGIN  
  
UPDATE BFOSETTLEMENT  
SET    INS_CHRG = 0  
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
       AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  

--Added ON 25-08-2023 FOR BSEFO                  
exec FO_POST_EXERCISEALLOCATION_adhoc   @SAUDA_DATE 

UPDATE BFOSETTLEMENT    
SET    INS_CHRG = ROUND((TRADEQTY * (CASE     
                       WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE    
                       ELSE CASE     
                               WHEN @STT_ON = 'PRICE' THEN 
                                        /* TRADE_PRICE +      
                                        CASE WHEN AUCTIONPART = 'EA' THEN STRIKE_PRICE
                                        ELSE 0 */
                                        CASE WHEN AUCTIONPART = 'EA' THEN STRIKE_PRICE - TRADE_PRICE  
                                      ELSE TRADE_PRICE    
                                    END  
                             
                              WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE    
                              WHEN @STT_ON = 'SSPRICE' THEN TRADE_PRICE + STRIKE_PRICE    
                            END    
                     END) * (CASE     
                               WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN @TRDSELLTRANS    
                               ELSE CASE     
                                      WHEN AUCTIONPART = '' THEN @OPTTRDSELLTRANS    
                                      ELSE @OPTDELSELLTRANS    
                                    END    
                             END) / 100),4)    
WHERE  SAUDA_DATE >= @SAUDA_DATE    
       AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'    
       AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO    
       AND SELL_BUY = 2    
       AND AUCTIONPART <> 'CA'    
       AND TRADEQTY > 0  AND TRADE_PRICE > 0
--Added ON 25-08-2023 FOR BSEFO
UPDATE BFOSETTLEMENT  
      SET    INS_CHRG = ROUND((TRADEQTY * ABS(CASE   
                             WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN (CASE WHEN AUCTIONPART = 'EA' THEN 0 ELSE TRADE_PRICE END)
                             ELSE CASE   
                                  WHEN @STT_ON = 'PRICE' THEN TRADE_PRICE + CASE WHEN AUCTIONPART= 'EA'   
       THEN   
        CASE WHEN LEFT(OPTION_TYPE,1) ='P'   
        THEN -STRIKE_PRICE ELSE STRIKE_PRICE END ELSE 0 END  
                                    WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE  
                                    WHEN @STT_ON = 'SSPRICE' THEN TRADE_PRICE + STRIKE_PRICE  
                                  END  
                           END) * (CASE   
                                     WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN @TRDSELLTRANS  
                                     ELSE CASE   
                                            WHEN AUCTIONPART = '' THEN @OPTTRDSELLTRANS  
                                            ELSE @OPTDELSELLTRANS  
                                          END  
                                   END) / 100),4)  
WHERE  SAUDA_DATE >= @SAUDA_DATE  
       AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
       AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
       AND SELL_BUY = 2  
       AND AUCTIONPART <> 'CA'  
       AND TRADEQTY > 0  
                        
/*INSERTING STT CHARGES (DETAIL) FOR REPORTING*/  
EXEC STT_INSERTDATA_DETAIL @SAUDA_DATE , @PARTYFROM , @PARTYTO, @STT_ON  
    
/* ROUNDING FOR 1 RS. START */  
SELECT CONTRACTNO,  
       PARTY_CODE,  
       ACTCHRG = SUM(INS_CHRG),  
       TOBECHRG = ROUND(SUM(INS_CHRG),0)  
INTO     #SETTROUND  
FROM     BFOSETTLEMENT  
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
         AND TRADEQTY > 0 
	 AND TRADE_PRICE > 0  --Added ON 25-08-2023 FOR BSEFO
         AND AUCTIONPART = '0'  
         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
GROUP BY CONTRACTNO,PARTY_CODE  
           
SELECT   S.CONTRACTNO,  
         S.PARTY_CODE,  
         TRADE_NO = MIN(TRADE_NO)  
INTO     #SETTSTTPARTY  
FROM     BFOSETTLEMENT S,  
         #SETTROUND A  
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
         AND TRADEQTY > 0  
	 AND TRADE_PRICE > 0 --Added ON 25-08-2023 FOR BSEFO
         AND AUCTIONPART = '0'  
         AND A.PARTY_CODE = S.PARTY_CODE  
         AND INS_CHRG >= (CASE   
                            WHEN TOBECHRG - ACTCHRG < 0 THEN ABS(TOBECHRG - ACTCHRG)  
                            ELSE 0  
                          END)  
         AND INS_CHRG > 0  
         AND S.CONTRACTNO = A.CONTRACTNO  
GROUP BY S.CONTRACTNO,S.PARTY_CODE  
           
UPDATE BFOSETTLEMENT  
SET    INS_CHRG = INS_CHRG + (TOBECHRG - ACTCHRG)  
FROM   #SETTSTTPARTY A,  
       #SETTROUND S  
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
       AND TRADEQTY > 0  --Added ON 25-08-2023 FOR BSEFO
       AND TRADE_PRICE > 0 
       AND BFOSETTLEMENT.PARTY_CODE = A.PARTY_CODE  
       AND BFOSETTLEMENT.PARTY_CODE = S.PARTY_CODE  
       AND AUCTIONPART = '0'  
       AND BFOSETTLEMENT.TRADE_NO = A.TRADE_NO  
       AND BFOSETTLEMENT.CONTRACTNO = A.CONTRACTNO  
       AND S.CONTRACTNO = A.CONTRACTNO  
       AND BFOSETTLEMENT.INS_CHRG > 0  
                                      
EXEC STT_ROUNDING_FURTHER @SAUDA_DATE , @PARTYFROM ,@PARTYTO  
  
/*INSERTING STT CHARGES (SUMMARY) FOR REPORTING*/  
EXEC STT_INSERTDATA_SUMMARY @SAUDA_DATE , @PARTYFROM , @PARTYTO, @STT_ON  
    
UPDATE BFOSETTLEMENT  
SET    INS_CHRG = 0  
FROM   CLIENT2 C  
WHERE  BFOSETTLEMENT.PARTY_CODE = C.PARTY_CODE  
       AND INSURANCE_CHRG = 0  
       AND SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
       AND BFOSETTLEMENT.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
  
  
UPDATE BFOSETTLEMENT      
SET    INS_CHRG = 0      
FROM   FOCLIENTTAXES C      
WHERE  BFOSETTLEMENT.PARTY_CODE = C.PARTY_CODE      
     AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO      
     AND C.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO      
     AND FUT_INSURANCE_CHRG = 0      
     AND SAUDA_DATE >= @SAUDA_DATE      
     AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'    
  
  
END  
          
  
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'STT','',@USERNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_CHARGES_FINAL_BKUP_10Aug2023
-- --------------------------------------------------

CREATE PROC [dbo].[STT_CHARGES_FINAL_BKUP_10Aug2023]  
(  
           @SAUDA_DATE VARCHAR(11),  
           @PARTYFROM  VARCHAR(10)  = '',  
           @PARTYTO    VARCHAR(11)  = 'ZZZZZZZZ',  
           @USERNAME   VARCHAR(50)  = ''  
)  
AS  
  
  DECLARE  @TRDSELLTRANS    NUMERIC(18,4),  
           @OPTTRDSELLTRANS NUMERIC(18,4),  
           @OPTDELSELLTRANS NUMERIC(18,4),  
           @STT_ON          VARCHAR(7)  
                              
  SET @TRDSELLTRANS = 0  
                        
  SET @OPTTRDSELLTRANS = 0  
                           
  SET @OPTDELSELLTRANS = 0  
                           
  SELECT @TRDSELLTRANS = TRDSELLTRANS,  
         @OPTTRDSELLTRANS = OPTTRDSELLTRANS,  
         @OPTDELSELLTRANS = OPTDELSELLTRANS,  
         @STT_ON = STT_ON  
  FROM   BFOGLOBALS  
  WHERE  YEAR_START_DT <= @SAUDA_DATE  
         AND YEAR_END_DT >= @SAUDA_DATE  
                              
  IF (@TRDSELLTRANS > 0  
       OR @OPTTRDSELLTRANS > 0  
       OR @OPTDELSELLTRANS > 0)   
         
BEGIN  
  
UPDATE BFOSETTLEMENT  
SET    INS_CHRG = 0  
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
       AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
                                               
UPDATE BFOSETTLEMENT  
      SET    INS_CHRG = ROUND((TRADEQTY * ABS(CASE   
                             WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN (CASE WHEN AUCTIONPART = 'EA' THEN 0 ELSE TRADE_PRICE END)
                             ELSE CASE   
                                  WHEN @STT_ON = 'PRICE' THEN TRADE_PRICE + CASE WHEN AUCTIONPART= 'EA'   
       THEN   
        CASE WHEN LEFT(OPTION_TYPE,1) ='P'   
        THEN -STRIKE_PRICE ELSE STRIKE_PRICE END ELSE 0 END  
                                    WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE  
                                    WHEN @STT_ON = 'SSPRICE' THEN TRADE_PRICE + STRIKE_PRICE  
                                  END  
                           END) * (CASE   
                                     WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN @TRDSELLTRANS  
                                     ELSE CASE   
                                            WHEN AUCTIONPART = '' THEN @OPTTRDSELLTRANS  
                                            ELSE @OPTDELSELLTRANS  
                                          END  
                                   END) / 100),4)  
WHERE  SAUDA_DATE >= @SAUDA_DATE  
       AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
       AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
       AND SELL_BUY = 2  
       AND AUCTIONPART <> 'CA'  
       AND TRADEQTY > 0  
                        
/*INSERTING STT CHARGES (DETAIL) FOR REPORTING*/  
EXEC STT_INSERTDATA_DETAIL @SAUDA_DATE , @PARTYFROM , @PARTYTO, @STT_ON  
    
/* ROUNDING FOR 1 RS. START */  
SELECT CONTRACTNO,  
       PARTY_CODE,  
       ACTCHRG = SUM(INS_CHRG),  
       TOBECHRG = ROUND(SUM(INS_CHRG),0)  
INTO     #SETTROUND  
FROM     BFOSETTLEMENT  
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
         AND TRADEQTY > 0  
         AND AUCTIONPART = '0'  
         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
GROUP BY CONTRACTNO,PARTY_CODE  
           
SELECT   S.CONTRACTNO,  
         S.PARTY_CODE,  
         TRADE_NO = MIN(TRADE_NO)  
INTO     #SETTSTTPARTY  
FROM     BFOSETTLEMENT S,  
         #SETTROUND A  
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
         AND TRADEQTY > 0  
         AND AUCTIONPART = '0'  
         AND A.PARTY_CODE = S.PARTY_CODE  
         AND INS_CHRG >= (CASE   
                            WHEN TOBECHRG - ACTCHRG < 0 THEN ABS(TOBECHRG - ACTCHRG)  
                            ELSE 0  
                          END)  
         AND INS_CHRG > 0  
         AND S.CONTRACTNO = A.CONTRACTNO  
GROUP BY S.CONTRACTNO,S.PARTY_CODE  
           
UPDATE BFOSETTLEMENT  
SET    INS_CHRG = INS_CHRG + (TOBECHRG - ACTCHRG)  
FROM   #SETTSTTPARTY A,  
       #SETTROUND S  
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
       AND TRADEQTY > 0  
       AND BFOSETTLEMENT.PARTY_CODE = A.PARTY_CODE  
       AND BFOSETTLEMENT.PARTY_CODE = S.PARTY_CODE  
       AND AUCTIONPART = '0'  
       AND BFOSETTLEMENT.TRADE_NO = A.TRADE_NO  
       AND BFOSETTLEMENT.CONTRACTNO = A.CONTRACTNO  
       AND S.CONTRACTNO = A.CONTRACTNO  
       AND BFOSETTLEMENT.INS_CHRG > 0  
                                      
EXEC STT_ROUNDING_FURTHER @SAUDA_DATE , @PARTYFROM ,@PARTYTO  
  
/*INSERTING STT CHARGES (SUMMARY) FOR REPORTING*/  
EXEC STT_INSERTDATA_SUMMARY @SAUDA_DATE , @PARTYFROM , @PARTYTO, @STT_ON  
    
UPDATE BFOSETTLEMENT  
SET    INS_CHRG = 0  
FROM   CLIENT2 C  
WHERE  BFOSETTLEMENT.PARTY_CODE = C.PARTY_CODE  
       AND INSURANCE_CHRG = 0  
       AND SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
       AND BFOSETTLEMENT.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
  
  
UPDATE BFOSETTLEMENT      
SET    INS_CHRG = 0      
FROM   FOCLIENTTAXES C      
WHERE  BFOSETTLEMENT.PARTY_CODE = C.PARTY_CODE      
     AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO      
     AND C.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO      
     AND FUT_INSURANCE_CHRG = 0      
     AND SAUDA_DATE >= @SAUDA_DATE      
     AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'    
  
  
END  
          
  
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'STT','',@USERNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_INSERTDATA_DETAIL
-- --------------------------------------------------

CREATE PROC [dbo].[STT_INSERTDATA_DETAIL] 
(
	@SAUDA_DATE VARCHAR(11),
	@PARTYFROM VARCHAR(10)='',
	@PARTYTO VARCHAR(11)='ZZZZZZZZ',
	@STT_ON VARCHAR(7)
) AS        
     

DECLARE @MEMBERTYPE VARCHAR (2), @RECTYPE1 INT ,@RECTYPE2 INT

SET @RECTYPE1 = 30
SET @RECTYPE2 = 40

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER
IF @MEMBERTYPE = 'CM' 
	BEGIN
		SET @RECTYPE1 = 40
		SET @RECTYPE2 = 50
	END
  

DELETE FROM STT_CLIENTDETAIL WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59' AND RECTYPE = @RECTYPE1
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO

DELETE FROM STT_CLIENTDETAIL WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59' AND RECTYPE = @RECTYPE2
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO


INSERT INTO STT_CLIENTDETAIL   
	(RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,
	PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,
	TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT)

SELECT @RECTYPE1,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),CONTRACTNO,PARTY_CODE,
	PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,TRADE_PRICE,
	0,
	0,
	0,
	SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END),
	SUM(CASE WHEN SELL_BUY=2 THEN (TRADEQTY * (CASE 
		WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE
		ELSE CASE 
		      WHEN @STT_ON = 'PRICE' THEN TRADE_PRICE +
			 CASE 
		              WHEN AUCTIONPART = 'EA' THEN STRIKE_PRICE
		              ELSE 0
		            END
		      WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE
		      WHEN @STT_ON = 'SSPRICE' THEN TRADE_PRICE + STRIKE_PRICE
		    END
		END)) ELSE 0 END),
	SUM(CASE WHEN SELL_BUY=2 THEN INS_CHRG ELSE 0 END),
	SUM(INS_CHRG) FROM BFOSETTLEMENT WHERE 
	SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59' AND AUCTIONPART = '0' AND TRADEQTY > 0
	AND SELL_BUY = 2 
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),CONTRACTNO,PARTY_CODE,
	PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,TRADE_PRICE

INSERT INTO STT_CLIENTDETAIL   
	(RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,
	PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,
	TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT)

SELECT @RECTYPE2,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),CONTRACTNO,PARTY_CODE,
	PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,TRADE_PRICE,
	0,
	0,
	0,
	SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END),
	SUM(CASE WHEN SELL_BUY=2 THEN (TRADEQTY * (CASE 
		WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE
		ELSE CASE 
		      WHEN @STT_ON = 'PRICE' THEN TRADE_PRICE +
			 CASE 
		              WHEN AUCTIONPART = 'EA' THEN STRIKE_PRICE
		              ELSE 0
		            END
		      WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE
		      WHEN @STT_ON = 'SSPRICE' THEN TRADE_PRICE + STRIKE_PRICE
		    END
		END)) ELSE 0 END),
	SUM(CASE WHEN SELL_BUY=2 THEN INS_CHRG ELSE 0 END),
	SUM(INS_CHRG) FROM BFOSETTLEMENT WHERE 
	SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59' AND AUCTIONPART = '0' AND TRADEQTY > 0
	AND SELL_BUY = 2 
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),CONTRACTNO,PARTY_CODE,
	PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,EXPIRYDATE,TRADE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_INSERTDATA_SUMMARY
-- --------------------------------------------------


CREATE PROC [dbo].[STT_INSERTDATA_SUMMARY]
(
	@SAUDA_DATE VARCHAR(11),
	@PARTYFROM VARCHAR(10)='',
	@PARTYTO VARCHAR(11)='ZZZZZZZZ',
	@STT_ON VARCHAR(7)
) AS        
     

DELETE FROM STT_CLIENTDETAIL WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  AND RECTYPE = 20
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO

	--select top 1 * from STT_CLIENTDETAIL

INSERT INTO STT_CLIENTDETAIL   
	(RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,
	--PRODUCT_TYPE,PRODUCT_CODE,SERIES_CODE,SERIES_ID,
	EXPIRYDATE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT)

SELECT 20,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),'',PARTY_CODE,
	--'','','','',
	'',	0,0,0,0,0,
	SUM(CASE WHEN SELL_BUY=2 THEN (TRADEQTY * (CASE 
		WHEN RIGHT(PRODUCT_CODE,3) = 'FUT' THEN TRADE_PRICE
		ELSE CASE 
		      WHEN @STT_ON = 'PRICE' THEN TRADE_PRICE +
			 CASE 
		              WHEN AUCTIONPART = 'EA' THEN STRIKE_PRICE
		              ELSE 0
		            END
		      WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE
		      WHEN @STT_ON = 'SSPRICE' THEN TRADE_PRICE + STRIKE_PRICE
		    END
		END)) ELSE 0 END),
		0,SUM(INS_CHRG) 
FROM BFOSETTLEMENT WHERE 
	SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59' AND AUCTIONPART = '0' AND TRADEQTY > 0
	AND SELL_BUY = 2 
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MATCHING
-- --------------------------------------------------
CREATE PROC STT_MATCHING 
	(
		@SAUDA_DATE_FROM VARCHAR(11),
		@SAUDA_DATE_TO VARCHAR(11),
		@PARTY_FROM VARCHAR(10),
		@PARTY_TO VARCHAR(10),
		@SHOW VARCHAR(4)
	) AS

IF @PARTY_TO = '' BEGIN SET @PARTY_TO = 'ZZZZZZZ' END
SELECT 
	BO_SAUDA_DATE = ISNULL(BO_SAUDA_DATE,''),
	BO_PARTY_CODE = ISNULL(BO_PARTY_CODE,''),
	BO_TOTTURNOVER = ISNULL(BO_TOTTURNOVER,0),
	BO_TOTSTT = ISNULL(BO_TOTSTT,0),
	EX_STT_DATE = ISNULL(EX_STT_DATE,''),
	EX_PARTY_CODE = ISNULL(EX_PARTY_CODE,''),
	EX_TOTTURNOVER = ISNULL(EX_TOTTURNOVER,0),
	EX_TOTSTT = ISNULL(EX_TOTSTT,0),
	STT_DIFF = ISNULL(BO_TOTSTT,0)- ISNULL(EX_TOTSTT,0)
FROM

(
	SELECT	
		BO_SAUDA_DATE = CONVERT(VARCHAR,SAUDA_DATE,103),		
		BO_PARTY_CODE = PARTY_CODE,
		BO_TOTTURNOVER = SAMTTRD,  
		BO_TOTSTT = TOTALSTT
	FROM 
		STT_CLIENTDETAIL 
	WHERE 
		SAUDA_DATE BETWEEN @SAUDA_DATE_FROM  AND @SAUDA_DATE_TO + ' 23:59'
		AND PARTY_CODE BETWEEN @PARTY_FROM  AND @PARTY_TO
		AND RECTYPE ='20'
) BOSTT

FULL OUTER JOIN

(
	SELECT 
		EX_STT_DATE = CONVERT(VARCHAR,STT_DATE,103),
		EX_PARTY_CODE = PARTY_CODE,
		EX_TOTTURNOVER = TOT_TURNOVER,
		EX_TOTSTT = ABS(TOT_STT)
	FROM 
		STT_EXCHG
	WHERE 
		STT_DATE BETWEEN @SAUDA_DATE_FROM  AND @SAUDA_DATE_TO + ' 23:59'
		AND PARTY_CODE BETWEEN @PARTY_FROM  AND @PARTY_TO
		AND ASSET_CODE <> ''
) EXSTT
ON
	(
		EX_STT_DATE = BO_SAUDA_DATE
		AND BO_PARTY_CODE = EX_PARTY_CODE
	)


WHERE 1 = CASE WHEN @SHOW ='' THEN 1 ELSE  CASE WHEN BO_TOTSTT-EX_TOTSTT > 0 THEN 2 ELSE 1 END END 
ORDER BY 
	ISNULL(BO_SAUDA_DATE,''), ISNULL(EX_STT_DATE,''),ISNULL(BO_PARTY_CODE,''),ISNULL(EX_PARTY_CODE,'')





CREATE NONCLUSTERED INDEX [IDXDT] ON [DBO].[STT_EXCHG] 
(
	[STT_DATE] ASC,
	[PARTY_CODE] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_ROUNDING_FURTHER
-- --------------------------------------------------
CREATE PROC [DBO].[STT_ROUNDING_FURTHER] 
(@SAUDA_DATE VARCHAR(11), @FROMPARTY VARCHAR(10), @TOPARTY VARCHAR(10))  
AS  
  
DECLARE @STTCUR CURSOR,  
@DIFF NUMERIC(18,4),  
@PARTY_CODE VARCHAR(10),  
@CONTRACTNO VARCHAR(7)  
  
DECLARE @SETTCUR CURSOR,  
@ORDER_NO VARCHAR(16),  
@TRADE_NO VARCHAR(20),  
@SERIES_CODE VARCHAR(12),  
@INS_CHRG NUMERIC(18,4)  
  
SELECT PARTY_CODE, CONTRACTNO, TOTAL = SUM(INS_CHRG), ACTUAL = ROUND(SUM(INS_CHRG),0)   
INTO #SETT FROM BFOSETTLEMENT 
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
GROUP BY PARTY_CODE, CONTRACTNO  
HAVING SUM(INS_CHRG) <> ROUND(SUM(INS_CHRG),0)  
  
SET @STTCUR = CURSOR FOR  
SELECT PARTY_CODE, CONTRACTNO, DIFF = TOTAL - ACTUAL FROM #SETT  
ORDER BY PARTY_CODE, CONTRACTNO  
OPEN @STTCUR  
FETCH NEXT FROM @STTCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF  
WHILE @@FETCH_STATUS = 0 --1  
BEGIN  
 SET @SETTCUR = CURSOR FOR  
 SELECT SERIES_CODE, ORDER_NO, TRADE_NO, INS_CHRG FROM BFOSETTLEMENT    
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
 AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
 AND INS_CHRG > 0   
 ORDER BY INS_CHRG DESC  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SERIES_CODE, @ORDER_NO, @TRADE_NO, @INS_CHRG  
 WHILE @@FETCH_STATUS = 0 AND @DIFF <> 0 --2  
 BEGIN  
  IF @DIFF < 0   
  BEGIN  
   UPDATE BFOSETTLEMENT SET INS_CHRG = INS_CHRG + ABS(@DIFF)  
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
   AND INS_CHRG > 0 AND SERIES_CODE = @SERIES_CODE AND ORDER_NO = @ORDER_NO   
   AND TRADE_NO = @TRADE_NO  
   SELECT @DIFF = 0   
  END  
 ELSE  
   BEGIN  
   IF @DIFF >= @INS_CHRG   
   BEGIN  
    UPDATE BFOSETTLEMENT SET INS_CHRG = 0  
    WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
    AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
     AND INS_CHRG > 0 AND SERIES_CODE = @SERIES_CODE AND ORDER_NO = @ORDER_NO   
     AND TRADE_NO = @TRADE_NO  

    SELECT @DIFF = @DIFF - @INS_CHRG   
   END   
    ELSE  
   BEGIN  
    UPDATE BFOSETTLEMENT SET INS_CHRG = @INS_CHRG - @DIFF  
    WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
    AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
     AND INS_CHRG > 0 AND SERIES_CODE = @SERIES_CODE AND ORDER_NO = @ORDER_NO   
     AND TRADE_NO = @TRADE_NO  
    SELECT @DIFF = 0  
   END      
   END   
   FETCH NEXT FROM @SETTCUR INTO @SERIES_CODE, @ORDER_NO, @TRADE_NO, @INS_CHRG   
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 FETCH NEXT FROM @STTCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF  
END  
CLOSE @STTCUR  
DEALLOCATE @STTCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TABLES
-- --------------------------------------------------
CREATE PROCEDURE TABLES    
(@NAME VARCHAR(40))    
AS      
SELECT * FROM SYS.TABLES WHERE NAME LIKE '%' + @NAME + '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------
  

  
CREATE PROC Tbl @TblName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TBL_COLLATERAL_MARGIN_UPD
-- --------------------------------------------------
   
CREATE PROCEDURE TBL_COLLATERAL_MARGIN_UPD ( @EFFDATE VARCHAR(11) ) AS    
    
    
DECLARE @PRV_DATE VARCHAR(11)    
    
CREATE TABLE [#TBL_COLLATERAL_MARGIN]     
(    
 [EXCHANGE] [VARCHAR] (3)  ,    
 [SEGMENT] [VARCHAR] (7)  ,    
 [PARTY_CODE] [VARCHAR] (10)  ,    
 [CASH] [MONEY]  ,    
 [NONCASH] [MONEY]  ,    
 [CL_TYPE] [VARCHAR](3),    
 [GROUP_CODE] [VARCHAR](15),    
 [SCRIP_CD] [VARCHAR] (12)  ,    
 [SERIES] [VARCHAR] (3)  ,    
 [ISIN] [VARCHAR] (20)  ,    
 [CL_RATE] [MONEY]  ,    
 [AMOUNT] [MONEY]  ,    
 [QTY] [NUMERIC](18, 4)  ,    
 [HAIRCUT] [MONEY]  ,    
 [FINALAMOUNT] [MONEY]  ,    
 [PERCENTAGECASH] [NUMERIC](18, 2)  ,    
 [PERECNTAGENONCASH] [NUMERIC](18, 2)  ,    
 [COLL_TYPE] [VARCHAR] (6)  ,    
 [CASH_NCASH] [VARCHAR] (2)  ,    
 [FD_BG_NO] [VARCHAR] (20)  ,    
 [BANK_CODE] [VARCHAR] (15)  ,    
 [FD_TYPE] [VARCHAR] (1)      
)    
    
CREATE CLUSTERED  INDEX [IDXDT] ON [DBO].[#TBL_COLLATERAL_MARGIN] ([PARTY_CODE])    
    
    
INSERT INTO #TBL_COLLATERAL_MARGIN    
SELECT     
 EXCHANGE,SEGMENT,PARTY_CODE,0,0,CLIENTTYPE,    
 GROUP_CODE,SCRIP_CD,SERIES,ISIN,CL_RATE=0,    
 AMOUNT=CASE WHEN COLL_TYPE='SEC' THEN 100 ELSE AMOUNT END,QTY,    
 HAIRCUT=CASE WHEN COLL_TYPE='SEC' THEN 100 ELSE HAIRCUT END,    
 FINALAMOUNT=CASE WHEN COLL_TYPE='SEC' THEN 100 ELSE FINALAMOUNT END,    
 PERCENTAGECASH,PERECNTAGENONCASH,    
 COLL_TYPE,CASH_NCASH,FD_BG_NO,BANK_CODE,FD_TYPE    
FROM    
 MSAJAG..COLLATERALDETAILS (NOLOCK)    
WHERE     
 EFFDATE BETWEEN @EFFDATE AND @EFFDATE + ' 23:59'    
 AND EXCHANGE =(SELECT TOP 1 EXCHANGE FROM FOTAXES (NOLOCK))     
 AND SEGMENT ='FUTURES'    
    
     
    
SELECT @PRV_DATE = MAX(EFFDATE) FROM MSAJAG.DBO.COLLATERALDETAILS (NOLOCK)    
WHERE EFFDATE < @EFFDATE    
    
/*UPDATING PREV DAYS CLOSING DATE*/    
UPDATE #TBL_COLLATERAL_MARGIN    
SET CL_RATE =  CLOSING.CL_RATE    
FROM MSAJAG.DBO.CLOSING  CLOSING(NOLOCK)    
WHERE     
 CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM MSAJAG.DBO.CLOSING WHERE SYSDATE < @EFFDATE )    
 AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
 AND CLOSING.SERIES = #TBL_COLLATERAL_MARGIN.SERIES    
     
UPDATE #TBL_COLLATERAL_MARGIN    
SET CL_RATE =  CLOSING.CL_RATE    
FROM MSAJAG.DBO.CLOSING CLOSING (NOLOCK)     
WHERE     
 CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM MSAJAG.DBO.CLOSING WHERE SYSDATE < @EFFDATE )    
 AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
 AND CLOSING.SERIES = #TBL_COLLATERAL_MARGIN.SERIES      
 AND #TBL_COLLATERAL_MARGIN.CL_RATE = 0    
     
UPDATE #TBL_COLLATERAL_MARGIN        
SET CL_RATE =  CLOSING.CL_RATE        
FROM MSAJAG.DBO.CLOSING CLOSING (NOLOCK)         
WHERE         
 CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM MSAJAG.DBO.CLOSING WHERE SYSDATE < @EFFDATE )        
 AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD        
 AND CLOSING.SERIES = 'EQ'        
 AND #TBL_COLLATERAL_MARGIN.CL_RATE = 0      
 AND #TBL_COLLATERAL_MARGIN.SERIES <> 'EQ'     
    
UPDATE #TBL_COLLATERAL_MARGIN        
SET CL_RATE =  CLOSING.CL_RATE        
FROM ANAND.BSEDB_AB.DBO.CLOSING CLOSING (NOLOCK)      
WHERE         
 CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM ANAND.BSEDB_AB.DBO.CLOSING WHERE SYSDATE < @EFFDATE )        
 AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD        
 AND #TBL_COLLATERAL_MARGIN.CL_RATE = 0       
    
UPDATE #TBL_COLLATERAL_MARGIN    
SET CL_RATE =  CLOSING.CL_RATE    
FROM MSAJAG.DBO.C_VALUATION CLOSING (NOLOCK)    
WHERE     
 CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM MSAJAG.DBO.C_VALUATION     
    WHERE SYSDATE < @EFFDATE      
     AND EXCHANGE =(SELECT TOP 1 EXCHANGE FROM FOTAXES (NOLOCK))     
     AND SEGMENT ='FUTURES')    
 AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
 AND CLOSING.SERIES = #TBL_COLLATERAL_MARGIN.SERIES    
 AND CLOSING.EXCHANGE = #TBL_COLLATERAL_MARGIN.EXCHANGE    
 AND CLOSING.SEGMENT = #TBL_COLLATERAL_MARGIN.SEGMENT    
    
/*UPDATING SECURITY HAITCUTS AND PREV DAYS VAR MARGINS*/    
    
   UPDATE #TBL_COLLATERAL_MARGIN    
    SET     HAIRCUT = S.HAIRCUT    
    FROM    
            (SELECT #TBL_COLLATERAL_MARGIN.PARTY_CODE,    
  #TBL_COLLATERAL_MARGIN.SCRIP_CD  ,    
  HAIRCUT = ISNULL(MAX(SECURITYHAIRCUT.HAIRCUT),0)    
            FROM    #TBL_COLLATERAL_MARGIN,    
  MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
            WHERE   SECURITYHAIRCUT.PARTY_CODE  = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
                AND SECURITYHAIRCUT.SCRIP_CD    = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
                AND SECURITYHAIRCUT.SERIES     IN ('EQ', 'BE')    
                AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
                AND ACTIVE    = 1    
                AND EFFDATE   =    
  (SELECT MAX(EFFDATE)    
  FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
  WHERE   EFFDATE  <= @PRV_DATE+ ' 23:59'    
      AND SECURITYHAIRCUT.PARTY_CODE  = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
      AND SECURITYHAIRCUT.SCRIP_CD    = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
      AND SECURITYHAIRCUT.SERIES     IN ('EQ', 'BE')    
      AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')    
      AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
      AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
      AND ACTIVE    = 1    
  )    
            GROUP BY #TBL_COLLATERAL_MARGIN.PARTY_CODE,    
  #TBL_COLLATERAL_MARGIN.SCRIP_CD    
            ) S    
    WHERE   S.PARTY_CODE                = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
        AND S.SCRIP_CD= #TBL_COLLATERAL_MARGIN.SCRIP_CD    
        AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')    
 AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
    
    
    
    UPDATE #TBL_COLLATERAL_MARGIN    
    SET     HAIRCUT = SECURITYHAIRCUT.HAIRCUT    
    FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
    WHERE   SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
        AND SECURITYHAIRCUT.SCRIP_CD   = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
        AND SECURITYHAIRCUT.SERIES     = #TBL_COLLATERAL_MARGIN.SERIES    
        AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
        AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
        AND ACTIVE   = 1    
        AND EFFDATE  =    
            (SELECT MAX(EFFDATE)    
            FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
            WHERE   EFFDATE <= @PRV_DATE + ' 23:59'    
                AND SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
                AND SECURITYHAIRCUT.SCRIP_CD   = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
                AND SECURITYHAIRCUT.SERIES     = #TBL_COLLATERAL_MARGIN.SERIES    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
                AND ACTIVE   = 1    
            )    
        AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100    
  AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
    
    UPDATE #TBL_COLLATERAL_MARGIN    
    SET     HAIRCUT = SECURITYHAIRCUT.HAIRCUT    
    FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
    WHERE   SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
        AND SECURITYHAIRCUT.SCRIP_CD   = ''    
        AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
        AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
        AND ACTIVE   = 1    
        AND EFFDATE  =    
            (SELECT MAX(EFFDATE)    
            FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
            WHERE   EFFDATE <= @PRV_DATE + ' 23:59'    
                AND SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
                AND SECURITYHAIRCUT.SCRIP_CD   = ''    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT                    AND ACTIVE   = 1    
            )    
        AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100    
  AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
    
    
     UPDATE #TBL_COLLATERAL_MARGIN    
     SET HAIRCUT = S.HAIRCUT    
     FROM (    
      SELECT #TBL_COLLATERAL_MARGIN.SCRIP_CD, HAIRCUT = ISNULL(MAX(SECURITYHAIRCUT.HAIRCUT),0)    
      FROM #TBL_COLLATERAL_MARGIN, MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
      WHERE SECURITYHAIRCUT.PARTY_CODE = ''    
       AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
       AND SECURITYHAIRCUT.SERIES IN ('EQ', 'BE')    
       AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')    
                 AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                 AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
       AND ACTIVE = 1    
       AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
      WHERE EFFDATE <= @PRV_DATE  + ' 23:59'    
       AND SECURITYHAIRCUT.PARTY_CODE = ''    
       AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
       AND SECURITYHAIRCUT.SERIES IN ('EQ', 'BE')    
       AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
       AND ACTIVE = 1)    
      GROUP BY #TBL_COLLATERAL_MARGIN.SCRIP_CD    
     ) S    
     WHERE S.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
     AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')    
     AND #TBL_COLLATERAL_MARGIN.HAIRCUT = 100    
  AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
    
     UPDATE #TBL_COLLATERAL_MARGIN    
     SET HAIRCUT = SECURITYHAIRCUT.HAIRCUT    
     FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
     WHERE SECURITYHAIRCUT.PARTY_CODE = ''    
     AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
     AND SECURITYHAIRCUT.SERIES = #TBL_COLLATERAL_MARGIN.SERIES      
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
     AND ACTIVE = 1    
     AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
     WHERE EFFDATE <= @PRV_DATE  + ' 23:59'    
     AND SECURITYHAIRCUT.PARTY_CODE = ''    
     AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
     AND SECURITYHAIRCUT.SERIES =  #TBL_COLLATERAL_MARGIN.SERIES     
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
     AND ACTIVE = 1)    
     AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100    
  AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
    
    
     UPDATE #TBL_COLLATERAL_MARGIN    
     SET HAIRCUT = SECURITYHAIRCUT.HAIRCUT    
     FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
     WHERE SECURITYHAIRCUT.PARTY_CODE = ''    
     AND SECURITYHAIRCUT.SCRIP_CD = ''    
     AND GROUP_CODE = #TBL_COLLATERAL_MARGIN.GROUP_CODE    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
     AND ACTIVE = 1    
     AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
     WHERE EFFDATE <= @PRV_DATE + ' 23:59'    
     AND SECURITYHAIRCUT.PARTY_CODE = ''    
     AND SECURITYHAIRCUT.SCRIP_CD = ''    
     AND GROUP_CODE = #TBL_COLLATERAL_MARGIN.GROUP_CODE    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
     AND ACTIVE = 1)    
     AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100    
  AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
     
  UPDATE #TBL_COLLATERAL_MARGIN    
     SET HAIRCUT = SECURITYHAIRCUT.HAIRCUT    
     FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
     WHERE #TBL_COLLATERAL_MARGIN.PARTY_CODE = ''    
     AND SECURITYHAIRCUT.SCRIP_CD = ''    
     AND CLIENT_TYPE = CL_TYPE    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
     AND ACTIVE = 1    
     AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)     
     WHERE EFFDATE <= @PRV_DATE + ' 23:59'    
     AND #TBL_COLLATERAL_MARGIN.PARTY_CODE = ''    
     AND SECURITYHAIRCUT.SCRIP_CD = ''    
     AND CLIENT_TYPE = CL_TYPE    
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
     AND ACTIVE = 1)    
     AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100    
  AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
    
DECLARE @SECHAIRCUTTYPE INT    
SET @SECHAIRCUTTYPE = 0    
SELECT @SECHAIRCUTTYPE = CM_VALUE FROM MSAJAG..COLLATERAL_MASTER (NOLOCK) WHERE CM_CODE ='S_HRCUT_TYPE'    
    
DECLARE @VARMARGINTYPE INT    
SET @VARMARGINTYPE = 2    
SELECT @VARMARGINTYPE = CM_VALUE FROM MSAJAG..COLLATERAL_MASTER (NOLOCK) WHERE CM_CODE ='S_VAR_TYPE'    
    
IF @SECHAIRCUTTYPE = 1 OR @SECHAIRCUTTYPE = 2    
 BEGIN    
    
     SELECT  V.*    
     INTO    #VAR    
     FROM    MSAJAG..VARDETAIL V (NOLOCK),    
             MSAJAG..VARCONTROL C (NOLOCK)    
     WHERE   V.DETAILKEY = C.DETAILKEY    
         AND C.RECDATE   =    
             (SELECT MAX(C1.RECDATE)    
             FROM    MSAJAG..VARDETAIL V1 (NOLOCK),    
   MSAJAG..VARCONTROL C1 (NOLOCK)    
             WHERE   V1.DETAILKEY = C1.DETAILKEY    
                 AND V.SCRIP_CD   = V1.SCRIP_CD    
                 AND V.SERIES               IN ('EQ', 'BE')    
                 AND V1.SERIES              IN ('EQ', 'BE')    
                 AND C1.RECDATE  <= @PRV_DATE + ' 23:59'    
             )    
    
     INSERT    
     INTO    #VAR    
     SELECT  V.*    
     FROM    MSAJAG..VARDETAIL V (NOLOCK),    
             MSAJAG..VARCONTROL C (NOLOCK)    
     WHERE   V.DETAILKEY = C.DETAILKEY    
         AND C.RECDATE   =    
             (SELECT MAX(C1.RECDATE)    
      FROM    MSAJAG..VARDETAIL V1 (NOLOCK),    
              MSAJAG..VARCONTROL C1 (NOLOCK)    
             WHERE   V1.DETAILKEY   = C1.DETAILKEY    
                 AND V.SCRIP_CD     = V1.SCRIP_CD    
                 AND V.SERIES NOT  IN ('EQ', 'BE')    
                 AND V1.SERIES NOT IN ('EQ', 'BE')    
                 AND V.SERIES       = V1.SERIES    
                AND C1.RECDATE    <= @PRV_DATE + ' 23:59'    
             )    
    
  /*    
  IF (SELECT COUNT(1) FROM MSAJAG..SCRIP_UNAPPROVED (NOLOCK)) > 0    
  BEGIN    
   UPDATE  #VAR SET SECVAR = 100, APPVAR = 100, VARMARGINRATE = 100    
   WHERE SCRIP_CD  EXISTS ( SELECT SCRIP_CD FROM MSAJAG..SCRIP_UNAPPROVED S (NOLOCK)    
   WHERE S.SCRIP_CD = #VAR.SCRIP_CD AND S.SERIES = #VAR.SERIES)    
  END     
  */    
      
  /*    
   IF (SELECT COUNT(1) FROM MSAJAG.DBO.SCRIP_APPROVED (NOLOCK)) > 0          
   BEGIN          
     UPDATE  #VAR SET SECVAR = 100, APPVAR = 100, VARMARGINRATE = 100          
     WHERE NOT EXISTS  (SELECT SCRIP_CD FROM MSAJAG.DBO.SCRIP_APPROVED S (NOLOCK)     
     WHERE S.SCRIP_CD = #VAR.SCRIP_CD AND S.SERIES = #VAR.SERIES)          
   END      
  */    
    
     UPDATE #TBL_COLLATERAL_MARGIN    
     SET     HAIRCUT = CASE     
     WHEN @VARMARGINTYPE = 0     
     THEN SECVAR    
     WHEN @VARMARGINTYPE = 1     
     THEN APPVAR    
     WHEN @VARMARGINTYPE = 2     
     THEN VARMARGINRATE    
    END    
     FROM    
             (SELECT SCRIP_CD,    
     VARMARGINRATE = MAX(VARMARGINRATE),    
   SECVAR,APPVAR    
             FROM    #VAR    
             WHERE   SERIES IN ('EQ', 'BE')    
             GROUP BY SCRIP_CD,SECVAR,APPVAR    
             ) A    
     WHERE   #TBL_COLLATERAL_MARGIN.SCRIP_CD = A.SCRIP_CD    
         AND SERIES    IN ('EQ', 'BE')    
   AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
     
     UPDATE #TBL_COLLATERAL_MARGIN    
     SET     HAIRCUT = CASE     
     WHEN @VARMARGINTYPE = 0     
     THEN SECVAR    
     WHEN @VARMARGINTYPE = 1     
     THEN APPVAR    
     WHEN @VARMARGINTYPE = 2     
     THEN VARMARGINRATE    
    END    
     FROM    
             (SELECT SCRIP_CD,    
   SERIES  ,    
   VARMARGINRATE = MAX(VARMARGINRATE),    
   SECVAR,APPVAR    
             FROM    #VAR    
             WHERE   SERIES NOT IN ('EQ', 'BE')    
             GROUP BY SCRIP_CD,    
   SERIES,SECVAR,APPVAR    
  ) A    
     WHERE   #TBL_COLLATERAL_MARGIN.SCRIP_CD = A.SCRIP_CD    
         AND #TBL_COLLATERAL_MARGIN.SERIES   = A.SERIES    
   AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
     
     /* APPLYING VAR HAIRCUT ACROSS ALL AND IF HAIRCUT NOT AVAILABLE THEN TAKING THE GLOBAL HAIRCUT */    
     IF @SECHAIRCUTTYPE = 2    
     BEGIN    
      UPDATE #TBL_COLLATERAL_MARGIN    
      SET     HAIRCUT = SECURITYHAIRCUT.HAIRCUT    
      FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
      WHERE   SECURITYHAIRCUT.PARTY_CODE = ''    
          AND SECURITYHAIRCUT.SCRIP_CD   = ''    
          AND CLIENT_TYPE                = ''    
                 AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                 AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
          AND ACTIVE   = 1    
          AND EFFDATE  =    
              (SELECT MAX(EFFDATE)    
              FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)    
              WHERE   EFFDATE <= @PRV_DATE + ' 23:59'    
                  AND SECURITYHAIRCUT.PARTY_CODE = ''    
                  AND SECURITYHAIRCUT.SCRIP_CD   = ''    
                  AND CLIENT_TYPE                = ''    
                  AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE    
                  AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT    
                  AND ACTIVE   = 1    
              )    
          AND #TBL_COLLATERAL_MARGIN.HAIRCUT  < SECURITYHAIRCUT.HAIRCUT  /*MAX OF GLOBAL AND VAR*/    
    AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
  END    
    
    END    
    
/* RECOMPUTING THE NON CASH*/    
    
UPDATE #TBL_COLLATERAL_MARGIN     
SET AMOUNT = QTY * CL_RATE,    
FINALAMOUNT = (( QTY * CL_RATE) - (( QTY * CL_RATE) * HAIRCUT / 100))    
WHERE  #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'    
    
/*APPLYING CASH COMPOSITION*/    
    
   CREATE TABLE #COLLATERALDATA_FINAL    
            (    
                    PARTY_CODE VARCHAR(10)  ,    
                    CASHCOMPO  NUMERIC(18,2),    
                    TOTALCASH MONEY         ,    
                    TOTALNONCASH MONEY      ,    
                    ACTUALCASH MONEY        ,    
                    ACTUALNONCASH MONEY     ,    
                    EFFECTIVECOLL MONEY    
            )    
    
    
    
    
    INSERT    
    INTO    #COLLATERALDATA_FINAL    
    SELECT  PARTY_CODE         ,    
            PERCENTAGECASH   =MAX(PERCENTAGECASH)      ,    
     SUM(CASE WHEN CASH_NCASH = 'C' THEN FINALAMOUNT ELSE 0 END),    
     SUM(CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END),    
     SUM(CASE WHEN CASH_NCASH = 'C' THEN AMOUNT ELSE 0 END),    
     SUM(CASE WHEN CASH_NCASH = 'N' THEN AMOUNT ELSE 0 END),    
     0    
    FROM    #TBL_COLLATERAL_MARGIN    
    GROUP BY PARTY_CODE    
    /*=======================================================================    
    APPLY THE CASH COMPOSITION RATIO    
    =======================================================================*/    
    UPDATE #COLLATERALDATA_FINAL    
    SET     ACTUALCASH =    
            CASE    
                    WHEN CASHCOMPO > 0    
                    THEN TOTALCASH    
                    ELSE 0    
            END ,    
            ACTUALNONCASH =    
            CASE    
                    WHEN CASHCOMPO > 0    
                    THEN    
                            CASE    
                                    WHEN TOTALCASH < TOTALNONCASH    
                      THEN    
                                            CASE    
                                                    WHEN CASHCOMPO >0    
                                                    THEN (TOTALCASH * 100)/CASHCOMPO    
                                                    ELSE 0    
                END    
              ELSE TOTALNONCASH    
                            END    
                    ELSE 0    
            END    
    UPDATE #COLLATERALDATA_FINAL    
    SET     ACTUALCASH =    
            CASE    
                    WHEN CASHCOMPO > 0    
                    THEN TOTALCASH    
                    ELSE 0    
            END ,    
            ACTUALNONCASH =    
            CASE    
        WHEN CASHCOMPO > 0    
                    THEN    
                            CASE    
                                    WHEN TOTALCASH < TOTALNONCASH    
                                    THEN    
                                            CASE    
                                                    WHEN CASHCOMPO >0    
                                                    THEN (TOTALCASH * 100)/CASHCOMPO    
                                                    ELSE 0    
                                            END    
                                    ELSE TOTALNONCASH    
                            END    
                    ELSE 0    
            END    
    UPDATE #COLLATERALDATA_FINAL    
    SET     EFFECTIVECOLL =    
            CASE    
                    WHEN CASHCOMPO > 0    
                    THEN    
                            CASE    
                                    WHEN TOTALCASH < TOTALNONCASH    
                                    THEN    
                                            CASE    
    WHEN ACTUALNONCASH < TOTALCASH+ TOTALNONCASH    
                                                    THEN ACTUALNONCASH    
                                                    ELSE TOTALCASH + TOTALNONCASH    
                                            END    
                                    ELSE TOTALCASH+ TOTALNONCASH    
                            END    
                    ELSE TOTALCASH+ TOTALNONCASH    
            END    
    UPDATE #COLLATERALDATA_FINAL    
    SET     ACTUALNONCASH = EFFECTIVECOLL - ACTUALCASH    
    
    
    
    
UPDATE #TBL_COLLATERAL_MARGIN     
SET CASH = TOTALCASH,NONCASH = TOTALNONCASH    
FROM #COLLATERALDATA_FINAL    
WHERE #COLLATERALDATA_FINAL.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE    
    
/*TAKING FINAL OUTPUT*/    
DELETE FROM TBL_COLLATERAL_MARGIN WHERE EFFDATE BETWEEN @EFFDATE AND @EFFDATE + ' 23:59'    
    
INSERT INTO TBL_COLLATERAL_MARGIN    
SELECT     
 EFFDATE =@EFFDATE, PARTY_CODE,CASH,NONCASH,SCRIP_CD,SERIES,ISIN,CL_RATE,AMOUNT,QTY,HAIRCUT,FINALAMOUNT,PERCENTAGECASH,    
 PERECNTAGENONCASH,COLL_TYPE,CASH_NCASH,FD_BG_NO,BANK_CODE,FD_TYPE,UPDATEDON=GETDATE()    
FROM #TBL_COLLATERAL_MARGIN    
    
DROP TABLE #TBL_COLLATERAL_MARGIN    
DROP TABLE #COLLATERALDATA_FINAL    
    
/*===========================================  END OF PROCEDURE =======================================*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TBL_COLLATERAL_MARGIN_UPD_13012012
-- --------------------------------------------------

CREATE   PROCEDURE TBL_COLLATERAL_MARGIN_UPD ( @EFFDATE VARCHAR(11) ) AS


DECLARE @PRV_DATE VARCHAR(11)

CREATE TABLE [#TBL_COLLATERAL_MARGIN] 
(
	[EXCHANGE] [VARCHAR] (3)  ,
	[SEGMENT] [VARCHAR] (7)  ,
	[PARTY_CODE] [VARCHAR] (10)  ,
	[CASH] [MONEY]  ,
	[NONCASH] [MONEY]  ,
	[CL_TYPE] [VARCHAR](3),
	[GROUP_CODE] [VARCHAR](15),
	[SCRIP_CD] [VARCHAR] (12)  ,
	[SERIES] [VARCHAR] (3)  ,
	[ISIN] [VARCHAR] (20)  ,
	[CL_RATE] [MONEY]  ,
	[AMOUNT] [MONEY]  ,
	[QTY] [NUMERIC](18, 4)  ,
	[HAIRCUT] [MONEY]  ,
	[FINALAMOUNT] [MONEY]  ,
	[PERCENTAGECASH] [NUMERIC](18, 2)  ,
	[PERECNTAGENONCASH] [NUMERIC](18, 2)  ,
	[COLL_TYPE] [VARCHAR] (6)  ,
	[CASH_NCASH] [VARCHAR] (2)  ,
	[FD_BG_NO] [VARCHAR] (20)  ,
	[BANK_CODE] [VARCHAR] (15)  ,
	[FD_TYPE] [VARCHAR] (1)  
)

CREATE CLUSTERED  INDEX [IDXDT] ON [DBO].[#TBL_COLLATERAL_MARGIN] ([PARTY_CODE])


INSERT INTO #TBL_COLLATERAL_MARGIN
SELECT 
	EXCHANGE,SEGMENT,PARTY_CODE,0,0,CLIENTTYPE,
	GROUP_CODE,SCRIP_CD,SERIES,ISIN,CL_RATE=0,
	AMOUNT=CASE WHEN COLL_TYPE='SEC' THEN 100 ELSE AMOUNT END,QTY,
	HAIRCUT=CASE WHEN COLL_TYPE='SEC' THEN 100 ELSE HAIRCUT END,
	FINALAMOUNT=CASE WHEN COLL_TYPE='SEC' THEN 100 ELSE FINALAMOUNT END,
	PERCENTAGECASH,PERECNTAGENONCASH,
	COLL_TYPE,CASH_NCASH,FD_BG_NO,BANK_CODE,FD_TYPE
FROM
	MSAJAG..COLLATERALDETAILS (NOLOCK)
WHERE 
	EFFDATE BETWEEN @EFFDATE AND @EFFDATE + ' 23:59'
	AND EXCHANGE =(SELECT TOP 1 EXCHANGE FROM FOTAXES (NOLOCK)) 
	AND SEGMENT ='FUTURES'

 

SELECT @PRV_DATE = MAX(EFFDATE) FROM MSAJAG..COLLATERALDETAILS (NOLOCK)
WHERE EFFDATE < @EFFDATE

/*UPDATING PREV DAYS CLOSING DATE*/
UPDATE #TBL_COLLATERAL_MARGIN
SET CL_RATE =  CLOSING.CL_RATE
FROM CLOSING (NOLOCK)
WHERE 
	CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM CLOSING WHERE SYSDATE < @EFFDATE )
	AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
	AND CLOSING.SERIES = #TBL_COLLATERAL_MARGIN.SERIES
	
UPDATE #TBL_COLLATERAL_MARGIN
SET CL_RATE =  CLOSING.CL_RATE
FROM MSAJAG.DBO.CLOSING CLOSING (NOLOCK) 
WHERE 
	CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM MSAJAG.DBO.CLOSING WHERE SYSDATE < @EFFDATE )
	AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
	AND CLOSING.SERIES = #TBL_COLLATERAL_MARGIN.SERIES  
	AND #TBL_COLLATERAL_MARGIN.CL_RATE = 0
	
UPDATE #TBL_COLLATERAL_MARGIN    
SET CL_RATE =  CLOSING.CL_RATE    
FROM MSAJAG.DBO.CLOSING CLOSING (NOLOCK)     
WHERE     
 CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM MSAJAG.DBO.CLOSING WHERE SYSDATE < @EFFDATE )    
 AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
 AND CLOSING.SERIES = 'EQ'    
 AND #TBL_COLLATERAL_MARGIN.CL_RATE = 0  
 AND #TBL_COLLATERAL_MARGIN.SERIES <> 'EQ'	

UPDATE #TBL_COLLATERAL_MARGIN    
SET CL_RATE =  CLOSING.CL_RATE    
FROM BSEDB.DBO.CLOSING CLOSING (NOLOCK)  
WHERE     
 CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM BSEDB.DBO.CLOSING WHERE SYSDATE < @EFFDATE )    
 AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD    
 AND #TBL_COLLATERAL_MARGIN.CL_RATE = 0   

UPDATE #TBL_COLLATERAL_MARGIN
SET CL_RATE =  CLOSING.CL_RATE
FROM MSAJAG.DBO.C_VALUATION CLOSING (NOLOCK)
WHERE 
	CLOSING.SYSDATE = (SELECT MAX(SYSDATE) FROM MSAJAG.DBO.C_VALUATION 
				WHERE SYSDATE < @EFFDATE 	
					AND EXCHANGE =(SELECT TOP 1 EXCHANGE FROM FOTAXES (NOLOCK)) 
					AND SEGMENT ='FUTURES')
	AND CLOSING.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
	AND CLOSING.SERIES = #TBL_COLLATERAL_MARGIN.SERIES
	AND CLOSING.EXCHANGE = #TBL_COLLATERAL_MARGIN.EXCHANGE
	AND CLOSING.SEGMENT = #TBL_COLLATERAL_MARGIN.SEGMENT

/*UPDATING SECURITY HAITCUTS AND PREV DAYS VAR MARGINS*/

   UPDATE #TBL_COLLATERAL_MARGIN
    SET     HAIRCUT = S.HAIRCUT
    FROM
            (SELECT #TBL_COLLATERAL_MARGIN.PARTY_CODE,
  #TBL_COLLATERAL_MARGIN.SCRIP_CD  ,
  HAIRCUT = ISNULL(MAX(SECURITYHAIRCUT.HAIRCUT),0)
            FROM    #TBL_COLLATERAL_MARGIN,
  MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
            WHERE   SECURITYHAIRCUT.PARTY_CODE  = #TBL_COLLATERAL_MARGIN.PARTY_CODE
                AND SECURITYHAIRCUT.SCRIP_CD    = #TBL_COLLATERAL_MARGIN.SCRIP_CD
                AND SECURITYHAIRCUT.SERIES     IN ('EQ', 'BE')
                AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
                AND ACTIVE    = 1
                AND EFFDATE   =
  (SELECT MAX(EFFDATE)
  FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
  WHERE   EFFDATE  <= @PRV_DATE+ ' 23:59'
      AND SECURITYHAIRCUT.PARTY_CODE  = #TBL_COLLATERAL_MARGIN.PARTY_CODE
      AND SECURITYHAIRCUT.SCRIP_CD    = #TBL_COLLATERAL_MARGIN.SCRIP_CD
      AND SECURITYHAIRCUT.SERIES     IN ('EQ', 'BE')
      AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')
      AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
      AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
      AND ACTIVE    = 1
  )
            GROUP BY #TBL_COLLATERAL_MARGIN.PARTY_CODE,
  #TBL_COLLATERAL_MARGIN.SCRIP_CD
            ) S
    WHERE   S.PARTY_CODE                = #TBL_COLLATERAL_MARGIN.PARTY_CODE
        AND S.SCRIP_CD= #TBL_COLLATERAL_MARGIN.SCRIP_CD
        AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')
	AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'




    UPDATE #TBL_COLLATERAL_MARGIN
    SET     HAIRCUT = SECURITYHAIRCUT.HAIRCUT
    FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
    WHERE   SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE
        AND SECURITYHAIRCUT.SCRIP_CD   = #TBL_COLLATERAL_MARGIN.SCRIP_CD
        AND SECURITYHAIRCUT.SERIES     = #TBL_COLLATERAL_MARGIN.SERIES
        AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
        AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
        AND ACTIVE   = 1
        AND EFFDATE  =
            (SELECT MAX(EFFDATE)
            FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
            WHERE   EFFDATE <= @PRV_DATE + ' 23:59'
                AND SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE
                AND SECURITYHAIRCUT.SCRIP_CD   = #TBL_COLLATERAL_MARGIN.SCRIP_CD
                AND SECURITYHAIRCUT.SERIES     = #TBL_COLLATERAL_MARGIN.SERIES
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
                AND ACTIVE   = 1
            )
        AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100
		AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'


    UPDATE #TBL_COLLATERAL_MARGIN
    SET     HAIRCUT = SECURITYHAIRCUT.HAIRCUT
    FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
    WHERE   SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE
        AND SECURITYHAIRCUT.SCRIP_CD   = ''
        AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
        AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
        AND ACTIVE   = 1
        AND EFFDATE  =
            (SELECT MAX(EFFDATE)
            FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
            WHERE   EFFDATE <= @PRV_DATE + ' 23:59'
                AND SECURITYHAIRCUT.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE
                AND SECURITYHAIRCUT.SCRIP_CD   = ''
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
                AND ACTIVE   = 1
            )
        AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100
		AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'



	    UPDATE #TBL_COLLATERAL_MARGIN
	    SET HAIRCUT = S.HAIRCUT
	    FROM (
		    SELECT #TBL_COLLATERAL_MARGIN.SCRIP_CD, HAIRCUT = ISNULL(MAX(SECURITYHAIRCUT.HAIRCUT),0)
		    FROM #TBL_COLLATERAL_MARGIN, MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
		    WHERE SECURITYHAIRCUT.PARTY_CODE = ''
			    AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
			    AND SECURITYHAIRCUT.SERIES IN ('EQ', 'BE')
			    AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')
	                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
	                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
			    AND ACTIVE = 1
			    AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
		    WHERE EFFDATE <= @PRV_DATE  + ' 23:59'
			    AND SECURITYHAIRCUT.PARTY_CODE = ''
			    AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
			    AND SECURITYHAIRCUT.SERIES IN ('EQ', 'BE')
			    AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
			    AND ACTIVE = 1)
		    GROUP BY #TBL_COLLATERAL_MARGIN.SCRIP_CD
	    ) S
	    WHERE S.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
	    AND #TBL_COLLATERAL_MARGIN.SERIES IN ('EQ', 'BE')
	    AND #TBL_COLLATERAL_MARGIN.HAIRCUT = 100
		AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'


	    UPDATE #TBL_COLLATERAL_MARGIN
	    SET HAIRCUT = SECURITYHAIRCUT.HAIRCUT
	    FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
	    WHERE SECURITYHAIRCUT.PARTY_CODE = ''
	    AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
	    AND SECURITYHAIRCUT.SERIES = #TBL_COLLATERAL_MARGIN.SERIES  
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
	    AND ACTIVE = 1
	    AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
	    WHERE EFFDATE <= @PRV_DATE  + ' 23:59'
	    AND SECURITYHAIRCUT.PARTY_CODE = ''
	    AND SECURITYHAIRCUT.SCRIP_CD = #TBL_COLLATERAL_MARGIN.SCRIP_CD
	    AND SECURITYHAIRCUT.SERIES =  #TBL_COLLATERAL_MARGIN.SERIES 
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
	    AND ACTIVE = 1)
	    AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100
		AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'



	    UPDATE #TBL_COLLATERAL_MARGIN
	    SET HAIRCUT = SECURITYHAIRCUT.HAIRCUT
	    FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
	    WHERE SECURITYHAIRCUT.PARTY_CODE = ''
	    AND SECURITYHAIRCUT.SCRIP_CD = ''
	    AND GROUP_CODE = #TBL_COLLATERAL_MARGIN.GROUP_CODE
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
	    AND ACTIVE = 1
	    AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
	    WHERE EFFDATE <= @PRV_DATE + ' 23:59'
	    AND SECURITYHAIRCUT.PARTY_CODE = ''
	    AND SECURITYHAIRCUT.SCRIP_CD = ''
	    AND GROUP_CODE = #TBL_COLLATERAL_MARGIN.GROUP_CODE
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
	    AND ACTIVE = 1)
	    AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100
		AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'

	
	 UPDATE #TBL_COLLATERAL_MARGIN
	    SET HAIRCUT = SECURITYHAIRCUT.HAIRCUT
	    FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
	    WHERE #TBL_COLLATERAL_MARGIN.PARTY_CODE = ''
	    AND SECURITYHAIRCUT.SCRIP_CD = ''
	    AND CLIENT_TYPE = CL_TYPE
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
	    AND ACTIVE = 1
	    AND EFFDATE = (SELECT MAX(EFFDATE) FROM MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK) 
	    WHERE EFFDATE <= @PRV_DATE + ' 23:59'
	    AND #TBL_COLLATERAL_MARGIN.PARTY_CODE = ''
	    AND SECURITYHAIRCUT.SCRIP_CD = ''
	    AND CLIENT_TYPE = CL_TYPE
                AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
	    AND ACTIVE = 1)
	    AND #TBL_COLLATERAL_MARGIN.HAIRCUT =100
		AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'


DECLARE @SECHAIRCUTTYPE INT
SET @SECHAIRCUTTYPE = 0
SELECT @SECHAIRCUTTYPE = CM_VALUE FROM MSAJAG..COLLATERAL_MASTER (NOLOCK) WHERE CM_CODE ='S_HRCUT_TYPE'

DECLARE @VARMARGINTYPE INT
SET @VARMARGINTYPE = 2
SELECT @VARMARGINTYPE = CM_VALUE FROM MSAJAG..COLLATERAL_MASTER (NOLOCK) WHERE CM_CODE ='S_VAR_TYPE'

IF @SECHAIRCUTTYPE = 1 OR @SECHAIRCUTTYPE = 2
	BEGIN

	    SELECT  V.*
	    INTO    #VAR
	    FROM    MSAJAG..VARDETAIL V (NOLOCK),
	            MSAJAG..VARCONTROL C (NOLOCK)
	    WHERE   V.DETAILKEY = C.DETAILKEY
	        AND C.RECDATE   =
	            (SELECT MAX(C1.RECDATE)
	            FROM    MSAJAG..VARDETAIL V1 (NOLOCK),
	  MSAJAG..VARCONTROL C1 (NOLOCK)
	            WHERE   V1.DETAILKEY = C1.DETAILKEY
	                AND V.SCRIP_CD   = V1.SCRIP_CD
	                AND V.SERIES               IN ('EQ', 'BE')
	                AND V1.SERIES              IN ('EQ', 'BE')
	                AND C1.RECDATE  <= @PRV_DATE + ' 23:59'
	            )

	    INSERT
	    INTO    #VAR
	    SELECT  V.*
	    FROM    MSAJAG..VARDETAIL V (NOLOCK),
	            MSAJAG..VARCONTROL C (NOLOCK)
	    WHERE   V.DETAILKEY = C.DETAILKEY
	        AND C.RECDATE   =
	            (SELECT MAX(C1.RECDATE)
		    FROM    MSAJAG..VARDETAIL V1 (NOLOCK),
		            MSAJAG..VARCONTROL C1 (NOLOCK)
	            WHERE   V1.DETAILKEY   = C1.DETAILKEY
	                AND V.SCRIP_CD     = V1.SCRIP_CD
	                AND V.SERIES NOT  IN ('EQ', 'BE')
	                AND V1.SERIES NOT IN ('EQ', 'BE')
	                AND V.SERIES       = V1.SERIES
	               AND C1.RECDATE    <= @PRV_DATE + ' 23:59'
	            )

		/*
		IF (SELECT COUNT(1) FROM MSAJAG..SCRIP_UNAPPROVED (NOLOCK)) > 0
		BEGIN
			UPDATE  #VAR SET SECVAR = 100, APPVAR = 100, VARMARGINRATE = 100
			WHERE SCRIP_CD  EXISTS ( SELECT SCRIP_CD FROM MSAJAG..SCRIP_UNAPPROVED S (NOLOCK)
			WHERE S.SCRIP_CD = #VAR.SCRIP_CD AND S.SERIES = #VAR.SERIES)
		END 
		*/
		
		/*
		 IF (SELECT COUNT(1) FROM MSAJAG.DBO.SCRIP_APPROVED (NOLOCK)) > 0      
		 BEGIN      
			  UPDATE  #VAR SET SECVAR = 100, APPVAR = 100, VARMARGINRATE = 100      
			  WHERE NOT EXISTS  (SELECT SCRIP_CD FROM MSAJAG.DBO.SCRIP_APPROVED S (NOLOCK) 
			  WHERE S.SCRIP_CD = #VAR.SCRIP_CD AND S.SERIES = #VAR.SERIES)      
		 END 	
		*/

	    UPDATE #TBL_COLLATERAL_MARGIN
	    SET     HAIRCUT = CASE 
					WHEN @VARMARGINTYPE = 0 
					THEN SECVAR
					WHEN @VARMARGINTYPE = 1 
					THEN APPVAR
					WHEN @VARMARGINTYPE = 2 
					THEN VARMARGINRATE
				END
	    FROM
	            (SELECT SCRIP_CD,
	  		VARMARGINRATE = MAX(VARMARGINRATE),
			SECVAR,APPVAR
	            FROM    #VAR
	            WHERE   SERIES IN ('EQ', 'BE')
	            GROUP BY SCRIP_CD,SECVAR,APPVAR
	            ) A
	    WHERE   #TBL_COLLATERAL_MARGIN.SCRIP_CD = A.SCRIP_CD
	        AND SERIES    IN ('EQ', 'BE')
			AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'

	
	    UPDATE #TBL_COLLATERAL_MARGIN
	    SET     HAIRCUT = CASE 
					WHEN @VARMARGINTYPE = 0 
					THEN SECVAR
					WHEN @VARMARGINTYPE = 1 
					THEN APPVAR
					WHEN @VARMARGINTYPE = 2 
					THEN VARMARGINRATE
				END
	    FROM
	            (SELECT SCRIP_CD,
	  SERIES  ,
	  VARMARGINRATE = MAX(VARMARGINRATE),
			SECVAR,APPVAR
	            FROM    #VAR
	            WHERE   SERIES NOT IN ('EQ', 'BE')
	            GROUP BY SCRIP_CD,
	  SERIES,SECVAR,APPVAR
	 ) A
	    WHERE   #TBL_COLLATERAL_MARGIN.SCRIP_CD = A.SCRIP_CD
	        AND #TBL_COLLATERAL_MARGIN.SERIES   = A.SERIES
			AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'

	
	    /* APPLYING VAR HAIRCUT ACROSS ALL AND IF HAIRCUT NOT AVAILABLE THEN TAKING THE GLOBAL HAIRCUT */
	    IF @SECHAIRCUTTYPE = 2
	    BEGIN
		    UPDATE #TBL_COLLATERAL_MARGIN
		    SET     HAIRCUT = SECURITYHAIRCUT.HAIRCUT
		    FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
		    WHERE   SECURITYHAIRCUT.PARTY_CODE = ''
		        AND SECURITYHAIRCUT.SCRIP_CD   = ''
		        AND CLIENT_TYPE                = ''
               		AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                	AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
		        AND ACTIVE   = 1
		        AND EFFDATE  =
		            (SELECT MAX(EFFDATE)
		            FROM    MSAJAG..SECURITYHAIRCUT SECURITYHAIRCUT (NOLOCK)
		            WHERE   EFFDATE <= @PRV_DATE + ' 23:59'
		                AND SECURITYHAIRCUT.PARTY_CODE = ''
		                AND SECURITYHAIRCUT.SCRIP_CD   = ''
		                AND CLIENT_TYPE                = ''
                		AND #TBL_COLLATERAL_MARGIN.EXCHANGE  = SECURITYHAIRCUT.EXCHANGE
                		AND #TBL_COLLATERAL_MARGIN.SEGMENT   = SECURITYHAIRCUT.SEGMENT
		                AND ACTIVE   = 1
		            )
		        AND #TBL_COLLATERAL_MARGIN.HAIRCUT  < SECURITYHAIRCUT.HAIRCUT  /*MAX OF GLOBAL AND VAR*/
				AND #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'
		END

    END

/* RECOMPUTING THE NON CASH*/

UPDATE #TBL_COLLATERAL_MARGIN 
SET AMOUNT = QTY * CL_RATE,
FINALAMOUNT = (( QTY * CL_RATE) - (( QTY * CL_RATE) * HAIRCUT / 100))
WHERE  #TBL_COLLATERAL_MARGIN.COLL_TYPE ='SEC'

/*APPLYING CASH COMPOSITION*/

   CREATE TABLE #COLLATERALDATA_FINAL
            (
                    PARTY_CODE VARCHAR(10)  ,
                    CASHCOMPO  NUMERIC(18,2),
                    TOTALCASH MONEY         ,
                    TOTALNONCASH MONEY      ,
                    ACTUALCASH MONEY        ,
                    ACTUALNONCASH MONEY     ,
                    EFFECTIVECOLL MONEY
            )




    INSERT
    INTO    #COLLATERALDATA_FINAL
    SELECT  PARTY_CODE         ,
            PERCENTAGECASH   =MAX(PERCENTAGECASH)      ,
	    SUM(CASE WHEN CASH_NCASH = 'C' THEN FINALAMOUNT ELSE 0 END),
	    SUM(CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END),
	    SUM(CASE WHEN CASH_NCASH = 'C' THEN AMOUNT ELSE 0 END),
	    SUM(CASE WHEN CASH_NCASH = 'N' THEN AMOUNT ELSE 0 END),
	    0
    FROM    #TBL_COLLATERAL_MARGIN
    GROUP BY PARTY_CODE
    /*=======================================================================
    APPLY THE CASH COMPOSITION RATIO
    =======================================================================*/
    UPDATE #COLLATERALDATA_FINAL
    SET     ACTUALCASH =
            CASE
                    WHEN CASHCOMPO > 0
                    THEN TOTALCASH
                    ELSE 0
            END ,
            ACTUALNONCASH =
            CASE
                    WHEN CASHCOMPO > 0
                    THEN
                            CASE
                                    WHEN TOTALCASH < TOTALNONCASH
                      THEN
                                            CASE
                                                    WHEN CASHCOMPO >0
                                                    THEN (TOTALCASH * 100)/CASHCOMPO
                                                    ELSE 0
                END
              ELSE TOTALNONCASH
                            END
                    ELSE 0
            END
    UPDATE #COLLATERALDATA_FINAL
    SET     ACTUALCASH =
            CASE
                    WHEN CASHCOMPO > 0
                    THEN TOTALCASH
                    ELSE 0
            END ,
            ACTUALNONCASH =
            CASE
        WHEN CASHCOMPO > 0
                    THEN
                            CASE
                                    WHEN TOTALCASH < TOTALNONCASH
                                    THEN
                                            CASE
                                                    WHEN CASHCOMPO >0
                                                    THEN (TOTALCASH * 100)/CASHCOMPO
                                                    ELSE 0
                                            END
                                    ELSE TOTALNONCASH
                            END
                    ELSE 0
            END
    UPDATE #COLLATERALDATA_FINAL
    SET     EFFECTIVECOLL =
            CASE
                    WHEN CASHCOMPO > 0
                    THEN
                            CASE
                                    WHEN TOTALCASH < TOTALNONCASH
                                    THEN
                                            CASE
    WHEN ACTUALNONCASH < TOTALCASH+ TOTALNONCASH
                                                    THEN ACTUALNONCASH
                                                    ELSE TOTALCASH + TOTALNONCASH
                                            END
                                    ELSE TOTALCASH+ TOTALNONCASH
                            END
                    ELSE TOTALCASH+ TOTALNONCASH
            END
    UPDATE #COLLATERALDATA_FINAL
    SET     ACTUALNONCASH = EFFECTIVECOLL - ACTUALCASH




UPDATE #TBL_COLLATERAL_MARGIN 
SET CASH = TOTALCASH,NONCASH = TOTALNONCASH
FROM #COLLATERALDATA_FINAL
WHERE #COLLATERALDATA_FINAL.PARTY_CODE = #TBL_COLLATERAL_MARGIN.PARTY_CODE

/*TAKING FINAL OUTPUT*/
DELETE FROM TBL_COLLATERAL_MARGIN WHERE EFFDATE BETWEEN @EFFDATE AND @EFFDATE + ' 23:59'

INSERT INTO TBL_COLLATERAL_MARGIN
SELECT 
	EFFDATE =@EFFDATE, PARTY_CODE,CASH,NONCASH,SCRIP_CD,SERIES,ISIN,CL_RATE,AMOUNT,QTY,HAIRCUT,FINALAMOUNT,PERCENTAGECASH,
	PERECNTAGENONCASH,COLL_TYPE,CASH_NCASH,FD_BG_NO,BANK_CODE,FD_TYPE,UPDATEDON=GETDATE()
FROM #TBL_COLLATERAL_MARGIN

DROP TABLE #TBL_COLLATERAL_MARGIN
DROP TABLE #COLLATERALDATA_FINAL

/*===========================================  END OF PROCEDURE =======================================*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRADE_CONSOLIDATION_INS
-- --------------------------------------------------
CREATE PROC [DBO].[TRADE_CONSOLIDATION_INS]	
	@SAUDA_DATE VARCHAR(10),
	@FROM_PARTY VARCHAR(10),
	@TO_PARTY VARCHAR(10),
	@FROM_SYMBOL VARCHAR(20),
	@TO_SYMBOL VARCHAR(20),
	@FROM_TERM VARCHAR(10),
	@TO_TERM VARCHAR(10),
	@SCRIPT VARCHAR(250),--='|||',--INST_TYPE|EXPIRYDATE|STRIKE_PRICE|OPTION_TYPE
	@CONSOLIDATE INT,	
	@CONTRACTNO VARCHAR(7),
	@AFTERCONTRACT VARCHAR(1) = 'Y',
	@SELL_BUY INT = 0,
	@GROUPON VARCHAR(10),
	@LEVEL INT,
	@PARTICIPANT VARCHAR(20) = '',
	@ORDER_NO VARCHAR(16) = '',
	@SHOW INT = 0,
	@TRFTABLE VARCHAR(20) = 'FOTRADE'
AS


/*---------------------------------------------------------------------------
	PROC NAME   : TRADE_CONSOLIDATION_PROC
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : AVAILABLE DATA FETCHING FOR CONSOLIDATES / NON CSONSOLIDATES
	EXEC TRADE_CONSOLIDATION_INS @SAUDA_DATE = '01/09/2005', @FROM_PARTY = '0', @TO_PARTY = 'ZZZZZZZZZZ', @FROM_SYMBOL = '', @TO_SYMBOL = '', @FROM_TERM = '', @TO_TERM = '', @SCRIPT = '||0|', @CONSOLIDATE = 0, @CONTRACTNO = '', @AFTERCONTRACT = '', @GROUPON = '', @SELL_BUY = 0, @LEVEL = 501, @PARTICIPANT = '', @ORDER_NO = '', @SHOW = 0, @TRFTABLE = 'FOSETTLEMENT'
	EXEC TRADE_CONSOLIDATION_INS @SAUDA_DATE='13/11/2006',@FROM_PARTY='0',@TO_PARTY='ZZZZZZZZZZ',@FROM_SYMBOL='',@TO_SYMBOL='',@FROM_TERM='',@TO_TERM='',@SCRIPT='||0|',@CONSOLIDATE=0,@CONTRACTNO='',@AFTERCONTRACT='Y',@GROUPON='0',@SELL_BUY=0,@LEVEL=1,@SHOW=0
	EXEC TRADE_CONSOLIDATION_INS  '13/11/2006', 'ALWIND0001', 'ALWIND0001', 'BSXNOV2006', 'BSXNOV2006', '', '','FUTIDX|30/11/2006|0|L',0, '', '', 2,'',102, '', '', 0, 'FOSETTLEMENT'
------------------------------------------------------------------------------*/
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	DECLARE @TDATE VARCHAR(11)
	SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
	DECLARE @SQL AS VARCHAR(8000)	
	DECLARE @INST_TYPE VARCHAR(10)
	DECLARE @EXPIRYDATE VARCHAR(11)
	DECLARE @STRIKE_PRICE NUMERIC(18,4)
	DECLARE @OPTION_TYPE VARCHAR(10)
	DECLARE @MEMBER VARCHAR(15)
	SET @MEMBER = ''
	SELECT @MEMBER = ISNULL(MEMBERCODE, '') FROM OWNER
	SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SCRIPT, '|', 1))) 
	SET @EXPIRYDATE = LTRIM(RTRIM(.DBO.PIECE(@SCRIPT, '|', 2))) 
	SET @STRIKE_PRICE = CONVERT(NUMERIC(18,4),LTRIM(RTRIM(.DBO.PIECE(@SCRIPT, '|', 3))))
	SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SCRIPT, '|', 4))) 
	
	IF @LEVEL = 1
		BEGIN
			IF @AFTERCONTRACT = 'Y'
				BEGIN
					SET @SQL = "	SELECT"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.CONTRACTNO,"
					SET @SQL = @SQL + "		I.SYMBOL,"
					SET @SQL = @SQL + "		I.INST_TYPE,"
					SET @SQL = @SQL + "		I.EXPIRYDATE,"
					SET @SQL = @SQL + "		I.STRIKE_PRICE,"
					SET @SQL = @SQL + "		I.OPTION_TYPE,"
					SET @SQL = @SQL + "		I.SERIES,"					
					SET @SQL = @SQL + "		I.SELL_BUY,"
					SET @SQL = @SQL + "		PARTICIPANTCODE = ' ',"
					SET @SQL = @SQL + "		TRADE_NO = ' ',"
					SET @SQL = @SQL + "		ORDER_NO = ' ',"
/*					SET @SQL = @SQL + "		I.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		I.TRADE_NO,"
					SET @SQL = @SQL + "		I.ORDER_NO,"*/
					SET @SQL = @SQL + "		I.DUMMY1,"
					SET @SQL = @SQL + "		QTY = SUM(I.TRADEQTY),"
					SET @SQL = @SQL + "		AMOUNT = SUM((I.TRADEQTY * I.PRICE)),"
					SET @SQL = @SQL + "		NETAMOUNT = SUM((I.TRADEQTY * I.NETRATE)),"
					SET @SQL = @SQL + "		MKTRATE = CONVERT(NUMERIC(18,4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4)),"
					SET @SQL = @SQL + "		NETRATE = CONVERT(NUMERIC(18,4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4)),"
					SET @SQL = @SQL + "		PARTY_NAME = ISNULL(C1.LONG_NAME, 'NOT FOUND')"
					SET @SQL = @SQL + "	FROM"
					SET @SQL = @SQL + "		FOSETTLEMENT I WITH (NOLOCK), "
					SET @SQL = @SQL + "		CLIENT2 C2 WITH (NOLOCK),"
					SET @SQL = @SQL + "		CLIENT1 C1 WITH (NOLOCK)"
					SET @SQL = @SQL + "	WHERE"
					SET @SQL = @SQL + "		C1.CL_CODE = C2.CL_CODE"
					SET @SQL = @SQL + "		AND I.PARTY_CODE = C2.PARTY_CODE"
					SET @SQL = @SQL + "		AND SAUDA_DATE LIKE '" + @TDATE + "%'"
					SET @SQL = @SQL + "		AND I.TRADEQTY > 0"
					SET @SQL = @SQL + "		AND I.RESERVED1 = 1"
					SET @SQL = @SQL + "		AND ISNULL(C1.CL_TYPE,'') = 'INS'"
					IF @SELL_BUY <> 0
						BEGIN
							SET @SQL = @SQL + "		AND I.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "
						END
					
					IF @CONSOLIDATE = 0
						BEGIN
							SET @SQL = @SQL + "		AND I.DUMMY1 = 0"
						END
					ELSE IF @CONSOLIDATE = 1
						BEGIN
							SET @SQL = @SQL + "		AND I.DUMMY1 = 1"
						END
					
					IF @FROM_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.PARTY_CODE >= '" + @FROM_PARTY + "'"
						END

					IF @TO_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.PARTY_CODE <= '" + @TO_PARTY + "'"
						END

					IF @FROM_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.SYMBOL >= '" + @FROM_SYMBOL + "'"
						END

					IF @TO_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.SYMBOL <= '" + @TO_SYMBOL + "'"
						END

					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.USER_ID >= '" + @FROM_TERM + "'"
						END

					IF @TO_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.USER_ID <= '" + @TO_TERM + "'"
						END

					SET @SQL = @SQL + "	GROUP BY"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.CONTRACTNO, "
					SET @SQL = @SQL + "		I.SYMBOL,"
					SET @SQL = @SQL + "		I.INST_TYPE,"
					SET @SQL = @SQL + "		I.EXPIRYDATE,"
					SET @SQL = @SQL + "		I.STRIKE_PRICE,"
					SET @SQL = @SQL + "		I.OPTION_TYPE,"
					SET @SQL = @SQL + "		I.SERIES,"
					SET @SQL = @SQL + "		I.SELL_BUY,"
/*					SET @SQL = @SQL + "		I.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		I.TRADE_NO,"
					SET @SQL = @SQL + "		I.ORDER_NO,"*/
					SET @SQL = @SQL + "		C1.LONG_NAME,"
					SET @SQL = @SQL + "		I.DUMMY1"
					SET @SQL = @SQL + "	ORDER BY"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.SYMBOL,"
					SET @SQL = @SQL + "		I.SERIES,"
					SET @SQL = @SQL + "		I.SELL_BUY"
				END
			ELSE
				BEGIN
					SET @SQL = "	SELECT"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.SYMBOL,"
					SET @SQL = @SQL + "		T.INST_TYPE,"
					SET @SQL = @SQL + "		T.EXPIRYDATE,"
					SET @SQL = @SQL + "		T.STRIKE_PRICE,"
					SET @SQL = @SQL + "		T.OPTION_TYPE,"
					SET @SQL = @SQL + "		T.SELL_BUY,"
					SET @SQL = @SQL + "		SERIES = '',"
					SET @SQL = @SQL + "		PARTICIPANTCODE = ' ',"
					SET @SQL = @SQL + "		TRADE_NO = ' ',"
					SET @SQL = @SQL + "		ORDER_NO = ' ',"
/*					SET @SQL = @SQL + "		T.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		T.TRADE_NO,"
					SET @SQL = @SQL + "		T.ORDER_NO,"*/
					SET @SQL = @SQL + "		QTY = SUM(T.TRADEQTY),"
					SET @SQL = @SQL + "		AMOUNT = SUM((T.TRADEQTY * T.PRICE)),"
					SET @SQL = @SQL + "		MKTRATE = CONVERT(NUMERIC(18,4), ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4)),"
					SET @SQL = @SQL + "		PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND')"
					SET @SQL = @SQL + "	FROM"
					SET @SQL = @SQL + "		FOTRADE T WITH (NOLOCK)"
					SET @SQL = @SQL + "		LEFT OUTER JOIN (SELECT PARTY_CODE, LONG_NAME, CL_TYPE FROM CLIENT2 C2 WITH (NOLOCK) "
					SET @SQL = @SQL + "		INNER JOIN CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)) C"
					SET @SQL = @SQL + "		ON (T.PARTY_CODE = C.PARTY_CODE)"
					SET @SQL = @SQL + "	WHERE"
--					SET @SQL = @SQL + "		SAUDA_DATE LIKE '" + @TDATE + "%'"
					SET @SQL = @SQL + "		T.TRADEQTY > 0"
					SET @SQL = @SQL + "		AND T.BOOKTYPE <> '99' "
					SET @SQL = @SQL + "		AND T.RESERVED1 = 1"			
					SET @SQL = @SQL + "		AND (ISNULL(C.CL_TYPE,'') = 'INS' OR T.PARTICIPANTCODE <> '" + @MEMBER + "')"
					IF @SELL_BUY <> 0
						BEGIN
							SET @SQL = @SQL + "		AND T.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "
						END


					IF @FROM_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.PARTY_CODE >= '" + @FROM_PARTY + "'"
						END

					IF @TO_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.PARTY_CODE <= '" + @TO_PARTY + "'"
						END

					IF @FROM_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.SYMBOL >= '" + @FROM_SYMBOL + "'"
						END

					IF @TO_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.SYMBOL <= '" + @TO_SYMBOL + "'"
						END

					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.USER_ID >= '" + @FROM_TERM + "'"
						END

					IF @TO_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.USER_ID <= '" + @TO_TERM + "'"
						END


					SET @SQL = @SQL + "	GROUP BY"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.SYMBOL,"
					SET @SQL = @SQL + "		T.INST_TYPE,"
					SET @SQL = @SQL + "		T.EXPIRYDATE,"
					SET @SQL = @SQL + "		T.STRIKE_PRICE,"
					SET @SQL = @SQL + "		T.OPTION_TYPE,"
					SET @SQL = @SQL + "		T.SELL_BUY,"
/*					SET @SQL = @SQL + "		T.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		T.TRADE_NO,"
					SET @SQL = @SQL + "		T.ORDER_NO,"*/
					SET @SQL = @SQL + "		ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND')"
					SET @SQL = @SQL + "	ORDER BY"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.SYMBOL,"
					SET @SQL = @SQL + "		T.SELL_BUY"					

				END
		END
		ELSE IF @LEVEL = 2  
			BEGIN  
				IF @AFTERCONTRACT = 'Y'  
					BEGIN  
						SET @SQL = " SELECT"  
						SET @SQL = @SQL + "  I.PARTY_CODE,"  				 
						SET @SQL = @SQL + "  I.CONTRACTNO,"  
						SET @SQL = @SQL + "  I.SYMBOL," 
						SET @SQL = @SQL + "  I.INST_TYPE,"
						SET @SQL = @SQL + "  I.EXPIRYDATE,"
						SET @SQL = @SQL + "  I.STRIKE_PRICE,"
						SET @SQL = @SQL + "  I.OPTION_TYPE,"
						SET @SQL = @SQL + "  PARTICIPANTCODE = ' '," 
--						SET @SQL = @SQL + "  I.PARTICIPANTCODE," 
						IF @SHOW = 2 OR @SHOW = 3
							BEGIN
								SET @SQL = @SQL + "		I.USER_ID,"
							END
						ELSE
							BEGIN
								SET @SQL = @SQL + "		USER_ID = '',"
							END
--						SET @SQL = @SQL + "  I.USER_ID, "
						SET @SQL = @SQL + "  I.SERIES," 
						SET @SQL = @SQL + "  TRADE_NO = '',"
						SET @SQL = @SQL + "  ORDER_NO = '',"
/*						SET @SQL = @SQL + "  I.TRADE_NO,"
						SET @SQL = @SQL + "  I.ORDER_NO,"	 */
						SET @SQL = @SQL + "  PARTY_NAME = ISNULL(C1.LONG_NAME, 'CLIENT CODE NOT FOUND'),"  
						SET @SQL = @SQL + "  I.DUMMY1, "
						SET @SQL = @SQL + "  SELL_BUY = CASE WHEN I.SELL_BUY = 1 THEN 'BUY' ELSE 'SALE' END,"  
						SET @SQL = @SQL + "  QTY = SUM(I.TRADEQTY),"  
						SET @SQL = @SQL + "  MKTRATE = ((SUM(I.DUMMY2*I.TRADEQTY)) / (SUM(I.TRADEQTY))),"  
						SET @SQL = @SQL + "  NETRATE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
						SET @SQL = @SQL + "  ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END),"  
						SET @SQL = @SQL + "  AMOUNT = SUM(I.TRADEQTY * I.PRICE),"  
						SET @SQL = @SQL + "  DEALTICKETPRICE = .DBO.MKT_ROUNDING(CONVERT(NUMERIC(18,4), SUM(I.PRICE*I.TRADEQTY))/SUM(I.TRADEQTY), ISNULL(R.RES1, 7)),"  
--						SET @SQL = @SQL + "  DEALTICKETPRICE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.MARKETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.PRICE * I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) ELSE ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END),"  
--						SET @SQL = @SQL + "  DEALTICKETPRICE = ((SUM(I.TRADEQTY * I.MARKETRATE)) / (SUM(I.TRADEQTY))),"  
						SET @SQL = @SQL + "  NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) END),"
--						SET @SQL = @SQL + "  NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
--						SET @SQL = @SQL + " ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END),"  
						SET @SQL = @SQL + "  PARTY_NAME = C1.LONG_NAME,"  
						SET @SQL = @SQL + "  R_MKTRATE = ISNULL(R.MARKETRATE, 4),"  
						SET @SQL = @SQL + "  R_BROKERAGE = ISNULL(R.BROKERAGE, 4),"  
						SET @SQL = @SQL + "  R_NETRATE = ISNULL(R.NETRATE, 4),"
						SET @SQL = @SQL + "  I.BILLNO"
						SET @SQL = @SQL + " FROM"  
						SET @SQL = @SQL + "  FOSETTLEMENT I, "  
						SET @SQL = @SQL + "  CLIENT2 C2"  
						SET @SQL = @SQL + "  LEFT JOIN INSTCLIENT_TBL R"  
						SET @SQL = @SQL + "  ON (C2.PARTY_CODE = R.PARTYCODE),"  
						SET @SQL = @SQL + "  CLIENT1 C1 "  
				   
						SET @SQL = @SQL + " WHERE"  
						SET @SQL = @SQL + "  C1.CL_CODE = C2.CL_CODE"  
						SET @SQL = @SQL + "  AND I.PARTY_CODE = C2.PARTY_CODE"  
						SET @SQL = @SQL + "		AND ISNULL(C1.CL_TYPE,'') = 'INS'"
						--SET @SQL = @SQL + "  AND I.SYMBOL = S.BSECODE"  
						SET @SQL = @SQL + "  AND CONVERT(VARCHAR(10), SAUDA_DATE, 103) = '" + @SAUDA_DATE + "'"  
						SET @SQL = @SQL + "  AND I.TRADEQTY > 0 AND I.RESERVED1 = 1"  
						IF @FROM_SYMBOL <> '' AND @TO_SYMBOL <> ''  
							BEGIN  
								SET @SQL = @SQL + "  AND I.SYMBOL >= '" + @FROM_SYMBOL + "'"  
								SET @SQL = @SQL + "  AND I.SYMBOL <= '" + @TO_SYMBOL + "'"  
							END     
						IF @SELL_BUY <> 0  
							BEGIN  
								SET @SQL = @SQL + "  AND I.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "  
							END  
				      
						IF @CONTRACTNO <> ''  
							BEGIN  
								SET @SQL = @SQL + "  AND I.CONTRACTNO = '" + @CONTRACTNO + "'"  
							END  
						IF @CONSOLIDATE = 0  
							BEGIN  
								SET @SQL = @SQL + "  AND I.DUMMY1 = 0"  
							END  
						ELSE IF @CONSOLIDATE = 1  
							BEGIN  
								SET @SQL = @SQL + "  AND I.DUMMY1 = 1"  
							END  
						IF @FROM_PARTY <> '' AND @TO_PARTY = ''  
							BEGIN  
								SET @SQL = @SQL + "  AND I.PARTY_CODE = '" + @FROM_PARTY + "'"  
							END  
						ELSE IF @FROM_PARTY <> '' AND @TO_PARTY <> ''  
							BEGIN  
								SET @SQL = @SQL + "  AND I.PARTY_CODE >= '" + @FROM_PARTY + "'"  
								SET @SQL = @SQL + "  AND I.PARTY_CODE <= '" + @TO_PARTY + "'"  
							END  				     
				  
						IF @FROM_TERM <> ''  
							BEGIN  
								SET @SQL = @SQL + "  AND I.USER_ID >= '" + @FROM_TERM + "'"  
							END  
						
						IF @TO_TERM <> ''  
							BEGIN  
								SET @SQL = @SQL + "  AND I.USER_ID <= '" + @TO_TERM + "'"  
							END  
						IF @INST_TYPE <> ''
							BEGIN
								SET @SQL = @SQL + "  AND I.INST_TYPE = '" + @INST_TYPE + "'"
							END
						IF @EXPIRYDATE <>''
							BEGIN
								SET @SQL = @SQL + "  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
							END
						IF @STRIKE_PRICE <>0
							BEGIN
								SET @SQL = @SQL + "  AND I.STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKE_PRICE) + ""
							END
						IF @OPTION_TYPE <>''
							BEGIN
								SET @SQL = @SQL + "  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
							END

						SET @SQL = @SQL + " GROUP BY"  
						SET @SQL = @SQL + "  I.PARTY_CODE,"  
--						SET @SQL = @SQL + "  I.PARTICIPANTCODE," 
						IF @SHOW = 2 OR @SHOW = 3
							BEGIN
								SET @SQL = @SQL + "		I.USER_ID,"
							END
--						SET @SQL = @SQL + "  I.USER_ID, "				      
						SET @SQL = @SQL + "  I.CONTRACTNO,"  
						SET @SQL = @SQL + "  I.SYMBOL," 
						SET @SQL = @SQL + "  I.INST_TYPE,"
						SET @SQL = @SQL + "  I.EXPIRYDATE,"
						SET @SQL = @SQL + "  I.STRIKE_PRICE,"
						SET @SQL = @SQL + "  I.OPTION_TYPE, "
						SET @SQL = @SQL + "  I.SERIES,"
/*						SET @SQL = @SQL + "  I.TRADE_NO,"
						SET @SQL = @SQL + "  I.ORDER_NO,"*/
						SET @SQL = @SQL + "  C1.LONG_NAME,"  
						SET @SQL = @SQL + "  I.SELL_BUY,"  				    
						SET @SQL = @SQL + "  I.DUMMY1,"  
						SET @SQL = @SQL + "  R.MARKETRATE,"  
						SET @SQL = @SQL + "  R.BROKERAGE,"  
						SET @SQL = @SQL + "  R.NETRATE,"
						SET @SQL = @SQL + "  R.RES1,"
						SET @SQL = @SQL + "  I.BILLNO"
						SET @SQL = @SQL + " ORDER BY"  
						SET @SQL = @SQL + "  I.PARTY_CODE,"  
						SET @SQL = @SQL + "  I.SYMBOL,"  
						--SET @SQL = @SQL + "  I.SERIES,"  
						SET @SQL = @SQL + "  C1.LONG_NAME,"  
						SET @SQL = @SQL + "  I.CONTRACTNO,"  
						SET @SQL = @SQL + "  I.SELL_BUY"  
				
				    END  
				ELSE  
				    BEGIN  
				     SET @SQL = " SELECT"  				  
				     SET @SQL = @SQL + "  T.PARTY_CODE,"  				      
				     SET @SQL = @SQL + "  PARTICIPANTCODE = ' ',"
--				     SET @SQL = @SQL + "  T.PARTICIPANTCODE,"
						IF @SHOW = 2 OR @SHOW = 3
							BEGIN
								SET @SQL = @SQL + "		T.USER_ID,"
							END
					 --SET @SQL = @SQL + "  T.USER_ID, "  				       
				     SET @SQL = @SQL + "  T.SYMBOL," 
					 SET @SQL = @SQL + "  T.INST_TYPE,"
					 SET @SQL = @SQL + "  T.EXPIRYDATE,"
					 SET @SQL = @SQL + "  T.STRIKE_PRICE,"
					 SET @SQL = @SQL + "  T.OPTION_TYPE,"
					 SET @SQL = @SQL + "	SERIES = '',"
					 SET @SQL = @SQL + "  TRADE_NO = ' ',"
					 SET @SQL = @SQL + "  ORDER_NO = ' ',"
/*					 SET @SQL = @SQL + "  T.TRADE_NO,"
					 SET @SQL = @SQL + "  T.ORDER_NO,"*/
				     SET @SQL = @SQL + "  PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),"
				     SET @SQL = @SQL + "  SELL_BUY = CASE WHEN T.SELL_BUY = 1 THEN 'BUY' ELSE 'SALE' END,"  
				     SET @SQL = @SQL + "  QTY = SUM(T.TRADEQTY),"  
				     SET @SQL = @SQL + "  MKTRATE = ((SUM(T.DUMMY2*T.TRADEQTY)) / (SUM(T.TRADEQTY))),"  
				     SET @SQL = @SQL + "  AMOUNT = SUM(T.TRADEQTY * T.MARKETRATE),"  
				     SET @SQL = @SQL + "  DEALTICKETPRICE = .DBO.MKT_ROUNDING(CONVERT(NUMERIC(18,4), SUM(T.PRICE*T.TRADEQTY))/SUM(T.TRADEQTY), ISNULL(C.RES1, 7)),"  
--				     SET @SQL = @SQL + "  DEALTICKETPRICE = CONVERT(NUMERIC(12, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND(((SUM(T.MARKETRATE*T.TRADEQTY)) / (SUM(T.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(T.MARKETRATE*T.TRADEQTY)) / (SUM(T.TRADEQTY))), 4, 1) ELSE ROUND(((SUM(T.MARKETRATE*T.TRADEQTY)) / (SUM(T.TRADEQTY))), 4, 1) END),"  
				--     SET @SQL = @SQL + "  DEALTICKETPRICE = ((SUM(T.TRADEQTY * T.MARKETRATE)) / (SUM(T.TRADEQTY))),"  
				     SET @SQL = @SQL + "  PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),"  
				     SET @SQL = @SQL + "  R_MKTRATE = ISNULL(C.MARKETRATE, 4),"  
				     SET @SQL = @SQL + "  R_BROKERAGE = ISNULL(C.BROKERAGE, 4),"  
				     SET @SQL = @SQL + "  R_NETRATE = ISNULL(C.NETRATE, 4)"  
				     SET @SQL = @SQL + " FROM"  
				     SET @SQL = @SQL + "  FOTRADE T"  
				     SET @SQL = @SQL + "  LEFT OUTER JOIN ( SELECT PARTY_CODE, LONG_NAME, CL_TYPE, MARKETRATE = ISNULL(MARKETRATE, 4), BROKERAGE = ISNULL(BROKERAGE, 4), NETRATE = ISNULL(NETRATE, 4), RES1 = ISNULL(RES1, 7)  FROM CLIENT1 C1 INNER JOIN CLIENT2 C2"  
				     SET @SQL = @SQL + "  ON (C1.CL_CODE = C2.CL_CODE ) LEFT JOIN  INSTCLIENT_TBL R ON (C2.PARTY_CODE = R.PARTYCODE)) C"  
				     SET @SQL = @SQL + "  ON (T.PARTY_CODE = C.PARTY_CODE)"  
				     SET @SQL = @SQL + "  INNER JOIN"  
				     SET @SQL = @SQL + "  (SELECT INST_TYPE, SYMBOL, SEC_NAME, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, C_REGULAR_LOT FROM FOSCRIP2 WHERE 1 = 1 "
 				     IF @FROM_SYMBOL <> ''
					BEGIN
						SET @SQL  = @SQL + " AND SYMBOL >= '" + @FROM_SYMBOL + "' "
					END
 				     IF @TO_SYMBOL <> ''
					BEGIN
						SET @SQL  = @SQL + " AND SYMBOL <= '" + @TO_SYMBOL + "' "
					END
				     SET @SQL = @SQL + ") S ON S.INST_TYPE = T.INST_TYPE AND S.SYMBOL = T.SYMBOL AND S.SEC_NAME = T.SEC_NAME AND S.EXPIRYDATE = T.EXPIRYDATE AND S.STRIKE_PRICE = T.STRIKE_PRICE AND S.OPTION_TYPE = T.OPTION_TYPE "
				     SET @SQL = @SQL + " WHERE"  
				     SET @SQL = @SQL + "  CONVERT(VARCHAR(10), T.SAUDA_DATE, 103) = '" + @SAUDA_DATE + "'"  
				     SET @SQL = @SQL + "  AND T.TRADEQTY > 0"
					 SET @SQL = @SQL + "  AND T.BOOKTYPE <> '99' "
				     SET @SQL = @SQL + "  AND (ISNULL(C.CL_TYPE,'') = 'INS' OR T.PARTICIPANTCODE <> '" + @MEMBER + "')"  
				     IF @SELL_BUY <> 0  
				      BEGIN  
				       SET @SQL = @SQL + "  AND T.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "  
				      END  
				      			  
				  
				     IF @FROM_PARTY <> '' AND @TO_PARTY = ''  
				      BEGIN  
				       SET @SQL = @SQL + "  AND T.PARTY_CODE = '" + @FROM_PARTY + "'"  
				      END  
				     ELSE IF @FROM_PARTY <> '' AND @TO_PARTY <> ''  
				      BEGIN  
				       SET @SQL = @SQL + "  AND T.PARTY_CODE >= '" + @FROM_PARTY + "'"  
				       SET @SQL = @SQL + "  AND T.PARTY_CODE <= '" + @TO_PARTY + "'"  
				      END  
				  
				     IF @FROM_SYMBOL <> ''  
				      BEGIN  
				       SET @SQL = @SQL + "  AND T.SYMBOL = '" + @FROM_SYMBOL + "'"  
				      END  
				  
				     IF @FROM_TERM <> ''  
				      BEGIN  
				       SET @SQL = @SQL + "  AND T.USER_ID >= '" + @FROM_TERM + "'"  
				      END  
				  
				     IF @TO_TERM <> ''  
				      BEGIN  
				       SET @SQL = @SQL + "  AND T.USER_ID <= '" + @TO_TERM + "'"  
				      END  
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND T.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, T.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND T.STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKE_PRICE) + ""
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND T.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END
				  
				     SET @SQL = @SQL + " GROUP BY"  
				     SET @SQL = @SQL + "  T.PARTY_CODE,"  
--				     SET @SQL = @SQL + "  T.PARTICIPANTCODE,"
						IF @SHOW = 2 OR @SHOW = 3
							BEGIN
								SET @SQL = @SQL + "		T.USER_ID,"
							END
--					 SET @SQL = @SQL + "  T.USER_ID, "  				     
				     SET @SQL = @SQL + "  T.SYMBOL,"
					 SET @SQL = @SQL + "  T.INST_TYPE,"
					 SET @SQL = @SQL + "  T.EXPIRYDATE,"
					 SET @SQL = @SQL + "  T.STRIKE_PRICE,"
					 SET @SQL = @SQL + "  T.OPTION_TYPE,"
/*					 SET @SQL = @SQL + "  T.TRADE_NO,"
					 SET @SQL = @SQL + "  T.ORDER_NO,"*/
				     SET @SQL = @SQL + "  C1.LONG_NAME,"  
				     SET @SQL = @SQL + "  T.SELL_BUY,"  
				     SET @SQL = @SQL + "  ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),"  
				     SET @SQL = @SQL + "  C.MARKETRATE,"  
				     SET @SQL = @SQL + "  C.BROKERAGE,"  
				     SET @SQL = @SQL + "  C.NETRATE,"  
					 SET @SQL = @SQL + "  C.RES1"
				     SET @SQL = @SQL + " ORDER BY"  
				     SET @SQL = @SQL + "  T.PARTY_CODE,"  
				     SET @SQL = @SQL + "  T.SYMBOL,"  				     
				     SET @SQL = @SQL + "  T.SELL_BUY"
				 
				    END  
			END
		ELSE IF @LEVEL = 3
		BEGIN
			IF @AFTERCONTRACT = 'Y'
				BEGIN
					SET @SQL = "	SELECT"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		I.ORDER_NO,"
					SET @SQL = @SQL + "		QTY = SUM(I.TRADEQTY),"
					SET @SQL = @SQL + "		I.SYMBOL,"
					SET @SQL = @SQL + "		I.INST_TYPE,"
					SET @SQL = @SQL + "		I.EXPIRYDATE,"
					SET @SQL = @SQL + "		I.STRIKE_PRICE,"
					SET @SQL = @SQL + "		I.OPTION_TYPE,"
					SET @SQL = @SQL + "		I.DUMMY1,"
					SET @SQL = @SQL + "		I.USER_ID,"
					SET @SQL = @SQL + "		I.BRANCH_ID,"
					SET @SQL = @SQL + "		AMOUNT = SUM((I.TRADEQTY * I.PRICE)),"
--					SET @SQL = @SQL + "		DEALTICKETPRICE = ((SUM(I.TRADEQTY * I.MARKETRATE)) / (SUM(I.TRADEQTY))),"
					SET @SQL = @SQL + "		DEALTICKETPRICE = .DBO.MKT_ROUNDING(CONVERT(NUMERIC(18,4), SUM(I.PRICE*I.TRADEQTY))/SUM(I.TRADEQTY), ISNULL(R.RES1, 7)),"
					SET @SQL = @SQL + "		NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) END),"
					SET @SQL = @SQL + "		MKTRATE = ((SUM(I.DUMMY2*I.TRADEQTY)) / (SUM(I.TRADEQTY))),"
					SET @SQL = @SQL + "		NETRATE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) END),"
					SET @SQL = @SQL + "		I.CONTRACTNO,"
					SET @SQL = @SQL + "		PARTY_NAME = C1.LONG_NAME,"
--					SET @SQL = @SQL + "		PARTY_NAME = ISNULL(C1.LONG_NAME, 'NOT FOUND'),"
					SET @SQL = @SQL + "		R_MKTRATE = ISNULL(R.MARKETRATE, 4),"
					SET @SQL = @SQL + "		R_BROKERAGE = ISNULL(R.BROKERAGE, 4),"
					SET @SQL = @SQL + "		R_NETRATE = ISNULL(R.NETRATE, 4),"
					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		I.USER_ID,"
						END
					SET @SQL = @SQL + "		I.SELL_BUY"
					SET @SQL = @SQL + "	FROM"
					SET @SQL = @SQL + "		FOSETTLEMENT I WITH (NOLOCK), "
					SET @SQL = @SQL + "		CLIENT2 C2 WITH (NOLOCK)"
					SET @SQL = @SQL + "			LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK)"
					SET @SQL = @SQL + "				ON (C2.PARTY_CODE = R.PARTYCODE),"
					SET @SQL = @SQL + "		CLIENT1 C1 WITH (NOLOCK)"
					SET @SQL = @SQL + "	WHERE"
					SET @SQL = @SQL + "		C1.CL_CODE = C2.CL_CODE"
					SET @SQL = @SQL + "		AND I.PARTY_CODE = C2.PARTY_CODE"
					SET @SQL = @SQL + "		AND SAUDA_DATE LIKE '" + @TDATE + "%'"
					SET @SQL = @SQL + "		AND SELL_BUY = " + LTRIM(RTRIM(CONVERT(VARCHAR, @SELL_BUY)))
					SET @SQL = @SQL + "		AND I.CONTRACTNO = '" + @CONTRACTNO + "'"
					SET @SQL = @SQL + "		AND I.TRADEQTY > 0"
					
					IF @CONSOLIDATE = 0
						BEGIN
							SET @SQL = @SQL + "		AND I.DUMMY1 = 0"
						END
					ELSE IF @CONSOLIDATE = 1
						BEGIN
							SET @SQL = @SQL + "		AND I.DUMMY1 = 1"
						END
					IF @FROM_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.PARTY_CODE = '" + @FROM_PARTY + "'"
						END

					IF @FROM_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.SYMBOL = '" + @FROM_SYMBOL + "'"
						END

					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.USER_ID = '" + @FROM_TERM + "'"
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND I.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND I.STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKE_PRICE) + ""
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END

					SET @SQL = @SQL + "	GROUP BY"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		I.ORDER_NO,"
					SET @SQL = @SQL + "		I.SYMBOL,"
					SET @SQL = @SQL + "		I.INST_TYPE,"
					SET @SQL = @SQL + "		I.EXPIRYDATE,"
					SET @SQL = @SQL + "		I.STRIKE_PRICE,"
					SET @SQL = @SQL + "		I.OPTION_TYPE,"				
					SET @SQL = @SQL + "		I.CONTRACTNO,"
					SET @SQL = @SQL + "		C1.LONG_NAME,"
					SET @SQL = @SQL + "		I.DUMMY1,"
					SET @SQL = @SQL + "		I.USER_ID,"
					SET @SQL = @SQL + "		I.BRANCH_ID,"
					SET @SQL = @SQL + "		ISNULL(R.MARKETRATE, 4),"
					SET @SQL = @SQL + "		ISNULL(R.BROKERAGE, 4),"
					SET @SQL = @SQL + "		ISNULL(R.NETRATE, 4),"
					SET @SQL = @SQL + "		ISNULL(R.RES1, 7),"
					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		I.USER_ID,"
						END
					SET @SQL = @SQL + "		I.SELL_BUY"
					SET @SQL = @SQL + "	ORDER BY"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.ORDER_NO,"
					SET @SQL = @SQL + "		I.BRANCH_ID"
				END
			ELSE
				BEGIN
					SET @SQL = "	SELECT"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		T.ORDER_NO,"
					SET @SQL = @SQL + "		QTY = SUM(T.TRADEQTY),"
					SET @SQL = @SQL + "		T.SYMBOL,"
					SET @SQL = @SQL + "		T.INST_TYPE,"
					SET @SQL = @SQL + "		T.EXPIRYDATE,"
					SET @SQL = @SQL + "		T.STRIKE_PRICE,"
					SET @SQL = @SQL + "		T.OPTION_TYPE,"
					SET @SQL = @SQL + "		T.DUMMY1,"
					SET @SQL = @SQL + "		T.USER_ID,"
					SET @SQL = @SQL + "		T.BRANCH_ID,"
					SET @SQL = @SQL + "		AMOUNT = SUM((T.TRADEQTY * T.MARKETRATE)),"
					SET @SQL = @SQL + "		DEALTICKETPRICE = .DBO.MKT_ROUNDING(CONVERT(NUMERIC(18,4), SUM(T.PRICE*T.TRADEQTY))/SUM(T.TRADEQTY), ISNULL(C.RES1, 7)),"
--					SET @SQL = @SQL + "		DEALTICKETPRICE = ((SUM(I.TRADEQTY * I.MARKETRATE)) / (SUM(I.TRADEQTY))),"
					SET @SQL = @SQL + "		MKTRATE = ((SUM(T.DUMMY2*T.TRADEQTY)) / (SUM(T.TRADEQTY))),"
					SET @SQL = @SQL + "		PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),"
					SET @SQL = @SQL + "		R_MKTRATE = ISNULL(C.MARKETRATE, 4),"
					SET @SQL = @SQL + "		R_BROKERAGE = ISNULL(C.BROKERAGE, 4),"
					SET @SQL = @SQL + "		R_NETRATE = ISNULL(C.NETRATE, 4),"
					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		T.USER_ID,"
						END
					SET @SQL = @SQL + "		T.SELL_BUY"
					SET @SQL = @SQL + "	FROM"
					SET @SQL = @SQL + "		FOTRADE T WITH (NOLOCK)"

					SET @SQL = @SQL + "		LEFT OUTER JOIN ( SELECT PARTY_CODE, LONG_NAME, CL_TYPE, MARKETRATE = ISNULL(MARKETRATE, 4), BROKERAGE = ISNULL(BROKERAGE, 4), NETRATE = ISNULL(NETRATE, 4), RES1 = ISNULL(RES1, 7) FROM CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK)"
					SET @SQL = @SQL + "		ON (C1.CL_CODE = C2.CL_CODE ) LEFT JOIN  INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)) C"
					SET @SQL = @SQL + "		ON (T.PARTY_CODE = C.PARTY_CODE)"

					SET @SQL = @SQL + "	WHERE"
					SET @SQL = @SQL + "		SAUDA_DATE LIKE '" + @TDATE + "%'"
					SET @SQL = @SQL + "		AND SELL_BUY = " + LTRIM(RTRIM(CONVERT(VARCHAR, @SELL_BUY)))
					SET @SQL = @SQL + "		AND T.TRADEQTY > 0"
					SET @SQL = @SQL + "		AND T.BOOKTYPE <> '99' "
					SET @SQL = @SQL + "		AND (ISNULL(C.CL_TYPE,'') = 'INS' OR T.PARTIPANTCODE <> '" + @MEMBER + "')"
					IF @CONSOLIDATE = 0
						BEGIN
							SET @SQL = @SQL + "		AND T.DUMMY1 = 0"
						END
					ELSE IF @CONSOLIDATE = 1
						BEGIN
							SET @SQL = @SQL + "		AND T.DUMMY1 = 1"
						END


					IF @FROM_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.PARTY_CODE = '" + @FROM_PARTY + "'"
						END

					IF @FROM_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.SYMBOL = '" + @FROM_SYMBOL + "'"
						END

					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.USER_ID = '" + @FROM_TERM + "'"
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND T.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, T.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND T.STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKE_PRICE) + ""
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND T.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END

					SET @SQL = @SQL + "	GROUP BY"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		T.ORDER_NO,"
					SET @SQL = @SQL + "		T.SYMBOL,"
					SET @SQL = @SQL + "		T.INST_TYPE,"
					SET @SQL = @SQL + "		T.EXPIRYDATE,"
					SET @SQL = @SQL + "		T.STRIKE_PRICE,"
					SET @SQL = @SQL + "		T.OPTION_TYPE,"
					SET @SQL = @SQL + "		T.DUMMY1,"
					SET @SQL = @SQL + "		T.USER_ID,"
					SET @SQL = @SQL + "		T.BRANCH_ID,"
					SET @SQL = @SQL + "		ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),"
					SET @SQL = @SQL + "		C.MARKETRATE,"
					SET @SQL = @SQL + "		ISNULL(C.BROKERAGE, 4),"
					SET @SQL = @SQL + "		ISNULL(C.NETRATE, 4),"
					SET @SQL = @SQL + "		C.RES1,"
					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		T.USER_ID,"
						END
					SET @SQL = @SQL + "		T.SELL_BUY"
					SET @SQL = @SQL + "	ORDER BY"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.ORDER_NO"
					SET @SQL = @SQL + "		T.BRANCH_ID"
				END
		END
	ELSE IF @LEVEL = 4
		BEGIN
			IF @AFTERCONTRACT = 'Y'
				BEGIN
					SET @SQL = "	SELECT"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.TRADE_NO,"
					SET @SQL = @SQL + "		I.SYMBOL,"
					SET @SQL = @SQL + "		I.INST_TYPE,"
					SET @SQL = @SQL + "		I.EXPIRYDATE,"
					SET @SQL = @SQL + "		I.STRIKE_PRICE,"
					SET @SQL = @SQL + "		I.OPTION_TYPE,"
					SET @SQL = @SQL + "		I.DUMMY1,"
					SET @SQL = @SQL + "		QTY = SUM(I.TRADEQTY),"
					SET @SQL = @SQL + "		AMOUNT = SUM((I.TRADEQTY * I.PRICE)),"
--					SET @SQL = @SQL + "		DEALTICKETPRICE = ((SUM(I.TRADEQTY * I.MARKETRATE)) / (SUM(I.TRADEQTY))),"
					SET @SQL = @SQL + "		DEALTICKETPRICE = .DBO.MKT_ROUNDING(CONVERT(NUMERIC(18,4), SUM(I.PRICE*I.TRADEQTY))/SUM(I.TRADEQTY), ISNULL(R.RES1, 7)),"
					SET @SQL = @SQL + "		NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4) END),"
					SET @SQL = @SQL + "		MKTRATE = ((SUM(I.DUMMY2*I.TRADEQTY)) / (SUM(I.TRADEQTY))),"
					SET @SQL = @SQL + "		NETRATE = ((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))),"
					SET @SQL = @SQL + "		I.CONTRACTNO,"
					SET @SQL = @SQL + "		I.ORDER_NO,"
					SET @SQL = @SQL + "		PARTIPANTCODE = I.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		I.USER_ID,"
					SET @SQL = @SQL + "		I.BRANCH_ID,"
					SET @SQL = @SQL + "		PARTY_NAME = C1.LONG_NAME,"
					SET @SQL = @SQL + "		R_MARKETRATE = ISNULL(R.MARKETRATE, 4),"
					SET @SQL = @SQL + "		R_BROKERAGE = ISNULL(R.BROKERAGE, 4),"
					SET @SQL = @SQL + "		R_NETRATE = ISNULL(R.NETRATE, 4)"
					SET @SQL = @SQL + "	FROM"
					SET @SQL = @SQL + "		FOSETTLEMENT I WITH (NOLOCK), "
					SET @SQL = @SQL + "		CLIENT2 C2 WITH (NOLOCK) "
					SET @SQL = @SQL + "			LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK)"
					SET @SQL = @SQL + "				ON (C2.PARTY_CODE = R.PARTYCODE),"
					SET @SQL = @SQL + "		CLIENT1 C1 WITH (NOLOCK)"
					SET @SQL = @SQL + "	WHERE"
					SET @SQL = @SQL + "		C1.CL_CODE = C2.CL_CODE"
					SET @SQL = @SQL + "		AND I.PARTY_CODE = C2.PARTY_CODE"
					SET @SQL = @SQL + "		AND SAUDA_DATE LIKE '" + @TDATE + "%'"
					SET @SQL = @SQL + "		AND SELL_BUY = " + LTRIM(RTRIM(CONVERT(VARCHAR, @SELL_BUY)))
					SET @SQL = @SQL + "		AND I.TRADEQTY > 0"
					
					IF @CONTRACTNO <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.CONTRACTNO = '" + @CONTRACTNO + "'"
						END
					IF @CONSOLIDATE = 0
						BEGIN
							SET @SQL = @SQL + "		AND I.DUMMY1 = 0"
						END
					ELSE IF @CONSOLIDATE = 1
						BEGIN
							SET @SQL = @SQL + "		AND I.DUMMY1 = 1"
						END
					IF @FROM_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.PARTY_CODE = '" + @FROM_PARTY + "'"
						END

					IF @FROM_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.SYMBOL = '" + @FROM_SYMBOL + "'"
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND I.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND I.STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKE_PRICE) + ""
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END
					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.USER_ID = '" + @FROM_TERM + "'"
						END

					IF @PARTICIPANT <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.PARTICIPANTCODE = '" + @PARTICIPANT + "'"
						END

					IF @ORDER_NO <> ''
						BEGIN
							SET @SQL = @SQL + "		AND I.ORDER_NO = '" + @ORDER_NO + "'"
						END

					SET @SQL = @SQL + "	GROUP BY"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.TRADE_NO,"
					SET @SQL = @SQL + "		I.SYMBOL,"
					SET @SQL = @SQL + "		I.INST_TYPE,"
					SET @SQL = @SQL + "		I.EXPIRYDATE,"
					SET @SQL = @SQL + "		I.STRIKE_PRICE,"
					SET @SQL = @SQL + "		I.OPTION_TYPE,"
					SET @SQL = @SQL + "		C1.LONG_NAME,"
					SET @SQL = @SQL + "		I.CONTRACTNO,"
					SET @SQL = @SQL + "		I.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		I.USER_ID,"
					SET @SQL = @SQL + "		I.BRANCH_ID,"
					SET @SQL = @SQL + "		I.DUMMY1,"
					SET @SQL = @SQL + "		I.ORDER_NO,"
					SET @SQL = @SQL + "		ISNULL(R.MARKETRATE, 4),"
					SET @SQL = @SQL + "		ISNULL(R.BROKERAGE, 4),"
					SET @SQL = @SQL + "		ISNULL(R.NETRATE, 4),"
					SET @SQL = @SQL + "		ISNULL(R.RES1, 7)"
					SET @SQL = @SQL + "	ORDER BY"
					SET @SQL = @SQL + "		I.PARTY_CODE,"
					SET @SQL = @SQL + "		I.TRADE_NO,"
					SET @SQL = @SQL + "		I.BRANCH_ID"
				END
			ELSE
				BEGIN
					SET @SQL = "	SELECT"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.TRADE_NO,"
					SET @SQL = @SQL + "		T.SYMBOL,"
					SET @SQL = @SQL + "		T.INST_TYPE,"
					SET @SQL = @SQL + "		T.EXPIRYDATE,"
					SET @SQL = @SQL + "		T.STRIKE_PRICE,"
					SET @SQL = @SQL + "		T.OPTION_TYPE,"
					SET @SQL = @SQL + "		T.DUMMY,"
					SET @SQL = @SQL + "		QTY = SUM(T.TRADEQTY),"
					SET @SQL = @SQL + "		AMOUNT = SUM((T.TRADEQTY * T.MARKETRATE)),"
--					SET @SQL = @SQL + "		DEALTICKETPRICE = ((SUM(I.TRADEQTY * I.MARKETRATE)) / (SUM(I.TRADEQTY))),"
					SET @SQL = @SQL + "		DEALTICKETPRICE = .DBO.MKT_ROUNDING(CONVERT(NUMERIC(18,4), SUM(T.PRICE*T.TRADEQTY))/SUM(T.TRADEQTY), ISNULL(C.RES1, 7)),"
					SET @SQL = @SQL + "		MKTRATE = ((SUM(T.DUMMY1*T.TRADEQTY)) / (SUM(T.TRADEQTY))),"
					SET @SQL = @SQL + "		T.ORDER_NO,"
					SET @SQL = @SQL + "		PARTIPANTCODE = T.PARTIPANTCODE,"
					SET @SQL = @SQL + "		T.USER_ID,"
					SET @SQL = @SQL + "		T.BRANCH_ID,"
					SET @SQL = @SQL + "		PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),"
					SET @SQL = @SQL + "		R_MKTRATE = ISNULL(C.MARKETRATE, 4),"
					SET @SQL = @SQL + "		R_BROKERAGE = ISNULL(C.BROKERAGE, 4),"
					SET @SQL = @SQL + "		R_NETRATE = ISNULL(C.NETRATE, 4)"
					SET @SQL = @SQL + "	FROM"
					SET @SQL = @SQL + "		FOTRADE T WITH (NOLOCK)"
					SET @SQL = @SQL + "		LEFT OUTER JOIN ( SELECT PARTY_CODE, LONG_NAME, CL_TYPE, MARKETRATE = ISNULL(MARKETRATE, 4), BROKERAGE = ISNULL(BROKERAGE, 4), NETRATE = ISNULL(NETRATE, 4), RES1 = ISNULL(RES1, 7) FROM CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK)"
					SET @SQL = @SQL + "		ON (C1.CL_CODE = C2.CL_CODE ) INNER JOIN  INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)) C"
					SET @SQL = @SQL + "		ON (T.PARTY_CODE = C.PARTY_CODE)"
					SET @SQL = @SQL + "	WHERE"
					SET @SQL = @SQL + "		SAUDA_DATE LIKE '" + @TDATE + "%'"
					SET @SQL = @SQL + "		AND SELL_BUY = " + LTRIM(RTRIM(CONVERT(VARCHAR, @SELL_BUY)))
					SET @SQL = @SQL + "		AND T.TRADEQTY > 0"
					SET @SQL = @SQL + "		AND T.BOOKTYPE <> '99' "
					SET @SQL = @SQL + "		AND (ISNULL(C.CL_TYPE,'') = 'INS' OR T.PARTIPANTCODE <> '" + @MEMBER + "')"
					IF @CONSOLIDATE = 0
						BEGIN
							SET @SQL = @SQL + "		AND T.DUMMY1 = 0"
						END
					ELSE IF @CONSOLIDATE = 1
						BEGIN
							SET @SQL = @SQL + "		AND T.DUMMY1 = 1"
						END


					IF @FROM_PARTY <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.PARTY_CODE = '" + @FROM_PARTY + "'"
						END

					IF @FROM_SYMBOL <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.SYMBOL = '" + @FROM_SYMBOL + "'"
						END

					IF @FROM_TERM <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.USER_ID = '" + @FROM_TERM + "'"
						END

					IF @PARTICIPANT <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.PARTICIPANTCODE = '" + @PARTICIPANT + "'"
						END

					IF @ORDER_NO <> ''
						BEGIN
							SET @SQL = @SQL + "		AND T.ORDER_NO = '" + @ORDER_NO + "'"
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND T.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, T.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND T.STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKE_PRICE) + ""
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND T.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END

					SET @SQL = @SQL + "	GROUP BY"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.TRADE_NO,"
					SET @SQL = @SQL + "		T.SYMBOL,"
					SET @SQL = @SQL + "		T.INST_TYPE,"
					SET @SQL = @SQL + "		T.EXPIRYDATE,"
					SET @SQL = @SQL + "		T.STRIKE_PRICE,"
					SET @SQL = @SQL + "		T.OPTION_TYPE,"
					SET @SQL = @SQL + "		T.DUMMY1,"
					SET @SQL = @SQL + "		T.ORDER_NO,"
					SET @SQL = @SQL + "		T.PARTICIPANTCODE,"
					SET @SQL = @SQL + "		T.USER_ID,"
					SET @SQL = @SQL + "		T.BRANCH_ID,"
					SET @SQL = @SQL + "		ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),"
					SET @SQL = @SQL + "		C.MARKETRATE,"
					SET @SQL = @SQL + "		ISNULL(C.BROKERAGE, 4),"
					SET @SQL = @SQL + "		ISNULL(C.NETRATE, 4),"
					SET @SQL = @SQL + "		C.RES1"
					SET @SQL = @SQL + "	ORDER BY"
					SET @SQL = @SQL + "		T.PARTY_CODE,"
					SET @SQL = @SQL + "		T.TRADE_NO,"
					SET @SQL = @SQL + "		T.BRANCH_ID"
				END
		END
		ELSE IF @LEVEL = 101
		BEGIN
			IF @TRFTABLE = 'FOTRADE'
				BEGIN
					SET @SQL = ""
					SET @SQL = @SQL + "SELECT "
					SET @SQL = @SQL + "	T.PARTY_CODE, "
					SET @SQL = @SQL + "	PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'), "
					SET @SQL = @SQL + "	T.SYMBOL, "	
					SET @SQL = @SQL + "	T.INST_TYPE,"
					SET @SQL = @SQL + "	T.EXPIRYDATE,"
					SET @SQL = @SQL + "	T.STRIKE_PRICE,"
					SET @SQL = @SQL + "	T.OPTION_TYPE,"				
					SET @SQL = @SQL + "	T.SELL_BUY, "
					SET @SQL = @SQL + "	CONTRACTNO = '', "
					SET @SQL = @SQL + " PARTICIPANTCODE = ''," 
					IF @SHOW = 2 OR @SHOW = 3
						BEGIN
							SET @SQL = @SQL + " T.USER_ID, "
						END
					ELSE
						BEGIN
							SET @SQL = @SQL + " USER_ID = '', "
						END
					SET @SQL = @SQL + " TRADE_NO = '',"
					SET @SQL = @SQL + " ORDER_NO = '',"
					SET @SQL = @SQL + "	MKTAMOUNT = SUM(T.TRADEQTY * T.PRICE), "
					SET @SQL = @SQL + "	NETAMOUNT = CONVERT(NUMERIC(18,4), 0), "
					SET @SQL = @SQL + "	MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) ELSE ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) END), "
					SET @SQL = @SQL + "	NETRATE = CONVERT(NUMERIC(18,4), 0), "
					SET @SQL = @SQL + "	QTY = SUM(T.TRADEQTY), "
					SET @SQL = @SQL + "	MKTRND = ISNULL(C.MARKETRATE, 4), "
					SET @SQL = @SQL + "	NETRND = ISNULL(C.NETRATE, 4), "
					SET @SQL = @SQL + "	BRKRND = ISNULL(C.BROKERAGE, 4), "
					SET @SQL = @SQL + " BILLNO = 0 "
					SET @SQL = @SQL + "FROM "
					SET @SQL = @SQL + "	FOTRADE T WITH (NOLOCK) "
					SET @SQL = @SQL + "		LEFT OUTER JOIN "
					SET @SQL = @SQL + "			(SELECT "
					SET @SQL = @SQL + "				C1.LONG_NAME, "
					SET @SQL = @SQL + "				C2.PARTY_CODE, "
					SET @SQL = @SQL + "				MARKETRATE = ISNULL(R.MARKETRATE, 4), "
					SET @SQL = @SQL + "				NETRATE = ISNULL(R.NETRATE, 4), "
					SET @SQL = @SQL + "				BROKERAGE = ISNULL(R.BROKERAGE, 4) "
					SET @SQL = @SQL + "			FROM "
					SET @SQL = @SQL + "				CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE) "
					SET @SQL = @SQL + "				LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE) "
					SET @SQL = @SQL + "			WHERE "
					SET @SQL = @SQL + "				C2.PARTY_CODE >= '" + @FROM_PARTY + "' "
					SET @SQL = @SQL + "				AND C2.PARTY_CODE <= '" + @TO_PARTY + "' "
					SET @SQL = @SQL + "				AND (C1.CL_TYPE = 'INS' OR C1.CL_TYPE <> (SELECT MEMBERCODE FROM OWNER)) "
					SET @SQL = @SQL + "			) C "
					SET @SQL = @SQL + "	ON (T.PARTY_CODE = C.PARTY_CODE) "
					SET @SQL = @SQL + "WHERE "
--					SET @SQL = @SQL + "	CONVERT(VARCHAR(10), T.SAUDA_DATE LIKE, 103) '" + @TDATE + "%' "
					SET @SQL = @SQL + "	T.TRADEQTY > 0 "
					SET @SQL = @SQL + "	AND T.BOOKTYPE <> '99' "
					SET @SQL = @SQL + "	AND T.PARTY_CODE >= '" + @FROM_PARTY + "' "
					SET @SQL = @SQL + "	AND T.PARTY_CODE <= '" + @TO_PARTY + "' "
					SET @SQL = @SQL + "	AND T.SELL_BUY BETWEEN " + CASE WHEN @SELL_BUY = 0 THEN '1' ELSE CONVERT(VARCHAR(1), @SELL_BUY) END + " AND " + CASE WHEN @SELL_BUY = 0 THEN '2' ELSE CONVERT(VARCHAR(1), @SELL_BUY) END + " "
					IF LTRIM(RTRIM(@FROM_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND T.SYMBOL >= '" + @FROM_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@TO_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND T.SYMBOL <= '" + @TO_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@FROM_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND T.USER_ID >= '" + @FROM_TERM + "' "
						END
					IF LTRIM(RTRIM(@TO_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND T.USER_ID <= '" + @TO_TERM + "' "
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND T.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, T.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND T.STRIKE_PRICE = '" + @STRIKE_PRICE + "'"
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND T.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END
					SET @SQL = @SQL + "GROUP BY "
					SET @SQL = @SQL + "	T.PARTY_CODE, "
					SET @SQL = @SQL + "	ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'), "
					SET @SQL = @SQL + "	T.SYMBOL, "
					SET @SQL = @SQL + "	T.INST_TYPE,"
					SET @SQL = @SQL + "	T.EXPIRYDATE,"
					SET @SQL = @SQL + "	T.STRIKE_PRICE,"
					SET @SQL = @SQL + "	T.OPTION_TYPE,"
					SET @SQL = @SQL + "	T.SELL_BUY, "
					IF @SHOW = 2 OR @SHOW = 3
						BEGIN
							SET @SQL = @SQL + " T.USER_ID, "
						END
/*					SET @SQL = @SQL + " T.PARTICIPANTCODE,"
					SET @SQL = @SQL + " T.USER_ID, "
					SET @SQL = @SQL + " T.TRADE_NO,"
					SET @SQL = @SQL + " T.ORDER_NO," */
					SET @SQL = @SQL + "	C.MARKETRATE, "
					SET @SQL = @SQL + "	ISNULL(C.NETRATE, 4), "
					SET @SQL = @SQL + "	ISNULL(C.BROKERAGE, 4) "
					SET @SQL = @SQL + " ORDER BY "
					SET @SQL = @SQL + "	T.PARTY_CODE, "
					SET @SQL = @SQL + "	T.SYMBOL, "
					SET @SQL = @SQL + "	T.SELL_BUY "
				END
			ELSE IF @TRFTABLE = 'FOSETTLEMENT'
				BEGIN
					SET @SQL = ""
					SET @SQL = @SQL + "SELECT "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'), "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.INST_TYPE,"
					SET @SQL = @SQL + "	I.EXPIRYDATE,"
					SET @SQL = @SQL + "	I.STRIKE_PRICE,"
					SET @SQL = @SQL + "	I.OPTION_TYPE,"
					SET @SQL = @SQL + "	I.SELL_BUY, "
					SET @SQL = @SQL + " TRADE_NO = '',"
					SET @SQL = @SQL + " ORDER_NO = '',"
					SET @SQL = @SQL + " PARTICIPANTCODE = ''," 
					IF @SHOW = 2 OR @SHOW = 3
						BEGIN
							SET @SQL = @SQL + " I.USER_ID, "
						END
					ELSE
						BEGIN
							SET @SQL = @SQL + " USER_ID = '', "
						END
					SET @SQL = @SQL + "	I.CONTRACTNO, "
					SET @SQL = @SQL + "	MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)), "
					SET @SQL = @SQL + "	NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)), "
					SET @SQL = @SQL + "	MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END), "
					SET @SQL = @SQL + "	NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END), "
					SET @SQL = @SQL + "	QTY = SUM(I.TRADEQTY), "
					SET @SQL = @SQL + "	MKTRND = C.MARKETRATE, "
					SET @SQL = @SQL + "	NETRND = C.NETRATE, "
					SET @SQL = @SQL + "	BRKRND = C.BROKERAGE, "
					SET @SQL = @SQL + "	I.BILLNO "
					SET @SQL = @SQL + " FROM "
					SET @SQL = @SQL + "	FOSETTLEMENT I WITH (NOLOCK) "
					SET @SQL = @SQL + "		INNER JOIN "
					SET @SQL = @SQL + "			(SELECT "
					SET @SQL = @SQL + "				C1.LONG_NAME, "
					SET @SQL = @SQL + "				C2.PARTY_CODE, "
					SET @SQL = @SQL + "				MARKETRATE = ISNULL(R.MARKETRATE, 4), "
					SET @SQL = @SQL + "				NETRATE = ISNULL(R.NETRATE, 4), "
					SET @SQL = @SQL + "				BROKERAGE = ISNULL(R.BROKERAGE, 4) "
					SET @SQL = @SQL + "			FROM "
					SET @SQL = @SQL + "				CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE) "
					SET @SQL = @SQL + "				LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE) "
					SET @SQL = @SQL + "			WHERE "
					SET @SQL = @SQL + "				C2.PARTY_CODE >= '" + @FROM_PARTY + "' "
					SET @SQL = @SQL + "				AND C2.PARTY_CODE <= '" + @TO_PARTY + "' "
					SET @SQL = @SQL + "			) C "
					SET @SQL = @SQL + "	ON (I.PARTY_CODE = C.PARTY_CODE) "
					SET @SQL = @SQL + "WHERE "
					SET @SQL = @SQL + "	I.SAUDA_DATE LIKE '" + @TDATE + "%' "
					SET @SQL = @SQL + "	AND I.TRADEQTY > 0 AND I.RESERVED1 = 1"
					SET @SQL = @SQL + "	AND I.DUMMY1 = 0"
					SET @SQL = @SQL + "	AND I.SELL_BUY BETWEEN " + CASE WHEN @SELL_BUY = 0 THEN '1' ELSE CONVERT(VARCHAR(1), @SELL_BUY) END + " AND " + CASE WHEN @SELL_BUY = 0 THEN '2' ELSE CONVERT(VARCHAR(1), @SELL_BUY) END + " "
					IF LTRIM(RTRIM(@FROM_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.SYMBOL >= '" + @FROM_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@TO_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.SYMBOL <= '" + @TO_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@FROM_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.USER_ID >= '" + @FROM_TERM + "' "
						END
					IF LTRIM(RTRIM(@TO_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.USER_ID <= '" + @TO_TERM + "' "
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND I.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND I.STRIKE_PRICE = '" + @STRIKE_PRICE + "'"
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END
					SET @SQL = @SQL + "GROUP BY "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	C.LONG_NAME, "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.INST_TYPE,"
					SET @SQL = @SQL + "	I.EXPIRYDATE,"
					SET @SQL = @SQL + "	I.STRIKE_PRICE,"
					SET @SQL = @SQL + "	I.OPTION_TYPE,"
					SET @SQL = @SQL + "	I.SELL_BUY, "
					IF @SHOW = 2 OR @SHOW = 3
						BEGIN
							SET @SQL = @SQL + " I.USER_ID, "
						END
/*					SET @SQL = @SQL + " I.TRADE_NO,"
					SET @SQL = @SQL + " I.ORDER_NO,"
					SET @SQL = @SQL + " I.PARTICIPANTCODE," 
					SET @SQL = @SQL + " I.USER_ID, "*/
					SET @SQL = @SQL + "	I.CONTRACTNO, "
					SET @SQL = @SQL + "	C.MARKETRATE, "
					SET @SQL = @SQL + "	C.NETRATE, "
					SET @SQL = @SQL + "	C.BROKERAGE, "
					SET @SQL = @SQL + "	I.BILLNO "
					SET @SQL = @SQL + "ORDER BY "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.SELL_BUY "
				END
		ELSE IF @TRFTABLE = 'SETTLEMENT'
				BEGIN
					SET @SQL = ""
					SET @SQL = @SQL + "SELECT "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'), "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.INST_TYPE,"
					SET @SQL = @SQL + "	I.EXPIRYDATE,"
					SET @SQL = @SQL + "	I.STRIKE_PRICE,"
					SET @SQL = @SQL + "	I.OPTION_TYPE,"
					SET @SQL = @SQL + "	I.SELL_BUY, "
					SET @SQL = @SQL + " I.TRADE_NO,"
					SET @SQL = @SQL + " I.ORDER_NO,"
					SET @SQL = @SQL + " I.PARTICIPANTCODE," 
					IF @SHOW = 2 OR @SHOW = 3
						BEGIN
							SET @SQL = @SQL + " I.USER_ID, "
						END
					ELSE
						BEGIN
							SET @SQL = @SQL + " USER_ID = '', "
						END
					SET @SQL = @SQL + "	I.CONTRACTNO, "
					SET @SQL = @SQL + "	MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)), "
					SET @SQL = @SQL + "	NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)), "
					SET @SQL = @SQL + "	MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END), "
					SET @SQL = @SQL + "	NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END), "
					SET @SQL = @SQL + "	QTY = SUM(I.TRADEQTY), "
					SET @SQL = @SQL + "	MKTRND = C.MARKETRATE, "
					SET @SQL = @SQL + "	NETRND = C.NETRATE, "
					SET @SQL = @SQL + "	BRKRND = C.BROKERAGE, "
					SET @SQL = @SQL + "	BILLNO = I.BILLNO "
					SET @SQL = @SQL + "FROM "
					SET @SQL = @SQL + "	FOSETTLEMENT I WITH (NOLOCK) "
					SET @SQL = @SQL + "		INNER JOIN "
					SET @SQL = @SQL + "			(SELECT "
					SET @SQL = @SQL + "				C1.LONG_NAME, "
					SET @SQL = @SQL + "				C2.PARTY_CODE, "
					SET @SQL = @SQL + "				MARKETRATE = ISNULL(R.MARKETRATE, 4), "
					SET @SQL = @SQL + "				NETRATE = ISNULL(R.NETRATE, 4), "
					SET @SQL = @SQL + "				BROKERAGE = ISNULL(R.BROKERAGE, 4) "
					SET @SQL = @SQL + "			FROM "
					SET @SQL = @SQL + "				CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE) "
					SET @SQL = @SQL + "				LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE) "
					SET @SQL = @SQL + "			WHERE "
					SET @SQL = @SQL + "				C2.PARTY_CODE >= '" + @FROM_PARTY + "' "
					SET @SQL = @SQL + "				AND C2.PARTY_CODE <= '" + @TO_PARTY + "' "
					SET @SQL = @SQL + "			) C "
					SET @SQL = @SQL + "	ON (I.PARTY_CODE = C.PARTY_CODE) "
					SET @SQL = @SQL + "WHERE "
					SET @SQL = @SQL + "	I.SAUDA_DATE LIKE '" + @TDATE + "%' "
					SET @SQL = @SQL + "	AND I.TRADEQTY > 0 AND I.RESERVED1 = 0"
					SET @SQL = @SQL + "	AND I.DUMMY1 = 0"
					SET @SQL = @SQL + "	AND I.SELL_BUY BETWEEN " + CASE WHEN @SELL_BUY = 0 THEN '1' ELSE CONVERT(VARCHAR(1), @SELL_BUY) END + " AND " + CASE WHEN @SELL_BUY = 0 THEN '2' ELSE CONVERT(VARCHAR(1), @SELL_BUY) END + " "
					IF LTRIM(RTRIM(@FROM_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.SYMBOL >= '" + @FROM_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@TO_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.SYMBOL <= '" + @TO_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@FROM_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.USER_ID >= '" + @FROM_TERM + "' "
						END
					IF LTRIM(RTRIM(@TO_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "	AND I.USER_ID <= '" + @TO_TERM + "' "
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND I.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND I.STRIKE_PRICE = '" + @STRIKE_PRICE + "'"
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END
					SET @SQL = @SQL + "GROUP BY "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	C.LONG_NAME, "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.INST_TYPE,"
					SET @SQL = @SQL + "	I.EXPIRYDATE,"
					SET @SQL = @SQL + "	I.STRIKE_PRICE,"
					SET @SQL = @SQL + "	I.OPTION_TYPE,"
					SET @SQL = @SQL + "	I.SELL_BUY, "
					SET @SQL = @SQL + " I.TRADE_NO,"
					SET @SQL = @SQL + " I.ORDER_NO,"
					SET @SQL = @SQL + " I.PARTICIPANTCODE,"
					IF @SHOW = 2 OR @SHOW = 3
						BEGIN
							SET @SQL = @SQL + " I.USER_ID, "
						END
					SET @SQL = @SQL + "	I.CONTRACTNO, "
					SET @SQL = @SQL + "	C.MARKETRATE, "
					SET @SQL = @SQL + "	C.NETRATE, "
					SET @SQL = @SQL + "	C.BROKERAGE, "
					SET @SQL = @SQL + " I.BILLNO "
					SET @SQL = @SQL + "ORDER BY "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.SELL_BUY "
				END
		END		
		ELSE IF @LEVEL = 102
		BEGIN
			IF @TRFTABLE = 'FOTRADE'
				BEGIN
					SELECT
						T.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						T.SYMBOL,
						T.INST_TYPE,
						T.EXPIRYDATE,
						T.STRIKE_PRICE,
						T.OPTION_TYPE,						
						T.SELL_BUY,
						T.TRADE_NO,
						T.ORDER_NO,
						T.PARTICIPANTCODE,
						T.USER_ID,
						T.BRANCH_ID,
						MKTAMOUNT = SUM(T.TRADEQTY * T.PRICE),
						NETAMOUNT = CONVERT(NUMERIC(18,4), 0),
						MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) ELSE ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) END),
						NETRATE = CONVERT(NUMERIC(18,4), 0),
						QTY = SUM(T.TRADEQTY),
						MKTRND = ISNULL(C.MARKETRATE, 4),
						NETRND = ISNULL(C.NETRATE, 4),
						BRKRND = ISNULL(C.BROKERAGE, 4)
					FROM
						FOTRADE T WITH (NOLOCK)
							LEFT OUTER JOIN
								(SELECT
									C1.LONG_NAME,
									C2.PARTY_CODE,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
									LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE >= @FROM_PARTY
									AND C2.PARTY_CODE <= @TO_PARTY
									AND (C1.CL_TYPE = 'INS' OR C1.CL_TYPE <> (SELECT MEMBERCODE FROM OWNER))
								) C
						ON (T.PARTY_CODE = C.PARTY_CODE)
					WHERE
						--T.SAUDA_DATE LIKE @TDATE + '%'
						T.TRADEQTY > 0
						AND T.BOOKTYPE <> '99'
						AND T.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
						AND T.PARTY_CODE >= @FROM_PARTY
						AND T.PARTY_CODE <= @TO_PARTY
						AND T.SYMBOL >= @FROM_SYMBOL
						AND T.SYMBOL <= @TO_SYMBOL
						AND T.INST_TYPE = @INST_TYPE
						AND CONVERT(VARCHAR(10), T.EXPIRYDATE, 103) = @EXPIRYDATE
						AND T.STRIKE_PRICE = @STRIKE_PRICE
						AND T.OPTION_TYPE = @OPTION_TYPE
						AND T.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
					GROUP BY
						T.PARTY_CODE,
						ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						T.SYMBOL,
						T.INST_TYPE,
						T.EXPIRYDATE,
						T.STRIKE_PRICE,
						T.OPTION_TYPE,					
						T.SELL_BUY,
						T.TRADE_NO,
						T.ORDER_NO,
						T.BRANCH_ID,
						C.MARKETRATE,
						T.PARTICIPANTCODE,
						T.USER_ID,
						ISNULL(C.NETRATE, 4),
						ISNULL(C.BROKERAGE, 4)
					ORDER BY
						T.PARTY_CODE,
						T.SYMBOL,						
						T.SELL_BUY,
						T.ORDER_NO,
						T.BRANCH_ID
				END
			ELSE IF @TRFTABLE = 'FOSETTLEMENT'
				BEGIN
					--PRINT 'CAME HERE'
					SELECT
						I.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),--C.LONG_NAME,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE, 
--						I.SERIES,
						I.SELL_BUY,
						I.TRADE_NO,
						I.ORDER_NO,			
						I.PARTICIPANTCODE,
						I.USER_ID,
						I.BRANCH_ID,
						MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)),
						NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)),
						MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END),
						NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END),
						QTY = SUM(I.TRADEQTY),
						MKTRND = ISNULL(C.MARKETRATE, 4),
						NETRND = ISNULL(C.NETRATE, 4),
						BRKRND = ISNULL(C.BROKERAGE, 4)
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
								(SELECT
									C1.LONG_NAME,
									C2.PARTY_CODE,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
									LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE >= @FROM_PARTY
									AND C2.PARTY_CODE <= @TO_PARTY
								) C
						ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
						AND I.SYMBOL >= @FROM_SYMBOL
						AND I.SYMBOL <= @TO_SYMBOL
						AND I.INST_TYPE = @INST_TYPE
						AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = @EXPIRYDATE
						AND I.STRIKE_PRICE = @STRIKE_PRICE
						AND I.OPTION_TYPE = @OPTION_TYPE
						AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
						AND I.RESERVED1 = 1
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.TRADE_NO,
						I.ORDER_NO,
						I.PARTICIPANTCODE,
						I.USER_ID,
						I.BRANCH_ID,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						I.SYMBOL,
--						I.SERIES,
						I.SELL_BUY,
						I.ORDER_NO,
						I.BRANCH_ID
				END
			ELSE IF @TRFTABLE = 'SETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
--						I.SERIES,
						I.SELL_BUY,
						I.TRADE_NO,
						I.ORDER_NO,
						I.PARTICIPANTCODE,
						I.USER_ID,
						I.BRANCH_ID,
						MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)),
						NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)),
						MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END),
						NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END),
						QTY = SUM(I.TRADEQTY),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
								(SELECT
									C1.LONG_NAME,
									C2.PARTY_CODE,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
									LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE >= @FROM_PARTY
									AND C2.PARTY_CODE <= @TO_PARTY
								) C
						ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
						AND I.SYMBOL >= @FROM_SYMBOL
						AND I.SYMBOL <= @TO_SYMBOL
						AND I.INST_TYPE = @INST_TYPE
						AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = @EXPIRYDATE
						AND I.STRIKE_PRICE = @STRIKE_PRICE
						AND I.OPTION_TYPE = @OPTION_TYPE
						AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
						AND I.RESERVED1 = 0
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.TRADE_NO,
						I.ORDER_NO,
						I.PARTICIPANTCODE,
						I.USER_ID,
						I.BRANCH_ID,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						I.SYMBOL,
						I.SELL_BUY,
						I.ORDER_NO,
						I.BRANCH_ID
				END
			END
	ELSE IF @LEVEL = 103
		BEGIN
			IF @TRFTABLE = 'FOTRADE'
				BEGIN
					IF @ORDER_NO <> ''
						BEGIN
							SELECT
								T.PARTY_CODE,
								PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								T.SYMBOL,
								T.INST_TYPE,
								T.EXPIRYDATE,
								T.STRIKE_PRICE,
								T.OPTION_TYPE,								
								T.SELL_BUY,
								T.ORDER_NO,
								T.TRADE_NO,
								T.USER_ID,
								T.PARTICIPANTCODE,
								T.BRANCH_ID,
								MKTAMOUNT = SUM(T.TRADEQTY * T.PRICE),
								NETAMOUNT = CONVERT(NUMERIC(18,4), 0),
								MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) ELSE ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) END),
								NETRATE = CONVERT(NUMERIC(18,4), 0),
								QTY = SUM(T.TRADEQTY),
								MKTRND = ISNULL(C.MARKETRATE, 4),
								NETRND = ISNULL(C.NETRATE, 4),
								BRKRND = ISNULL(C.BROKERAGE, 4)
							FROM
								FOTRADE T WITH (NOLOCK)
									LEFT OUTER JOIN
										(SELECT
											C1.LONG_NAME,
											C2.PARTY_CODE,
											MARKETRATE = ISNULL(R.MARKETRATE, 4),
											NETRATE = ISNULL(R.NETRATE, 4),
											BROKERAGE = ISNULL(R.BROKERAGE, 4)
										FROM
											CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
										WHERE
											C2.PARTY_CODE >= @FROM_PARTY
											AND C2.PARTY_CODE <= @TO_PARTY
											AND (C1.CL_TYPE = 'INS' OR C1.CL_TYPE <> (SELECT MEMBERCODE FROM OWNER))
										) C
								ON (T.PARTY_CODE = C.PARTY_CODE)
							WHERE
								--T.SAUDA_DATE LIKE @TDATE + '%'
								T.TRADEQTY > 0
								AND T.BOOKTYPE <> '99'
								AND T.PARTY_CODE >= @FROM_PARTY
								AND T.PARTY_CODE <= @TO_PARTY
								AND T.SYMBOL >= @FROM_SYMBOL
								AND T.SYMBOL <= @TO_SYMBOL
								AND T.ORDER_NO = @ORDER_NO
								AND T.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
--								AND T.PARTIPANTCODE = @PARTICIPANT
							GROUP BY
								T.PARTY_CODE,
								ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								T.SYMBOL,
								T.INST_TYPE,
								T.EXPIRYDATE,
								T.STRIKE_PRICE,
								T.OPTION_TYPE,								
								T.SELL_BUY,
								T.ORDER_NO,
								T.TRADE_NO,
								T.USER_ID,
								T.PARTICIPANTCODE,
								T.BRANCH_ID,
								C.MARKETRATE,
								ISNULL(C.NETRATE, 4),
								ISNULL(C.BROKERAGE, 4)
							ORDER BY
								T.PARTY_CODE,
								T.SYMBOL,								
								T.SELL_BUY,
								T.ORDER_NO,
								T.TRADE_NO,
								T.BRANCH_ID
						END
					ELSE
						BEGIN
							SELECT
								T.PARTY_CODE,
								PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								T.SYMBOL,
								T.INST_TYPE,
								T.EXPIRYDATE,
								T.STRIKE_PRICE,
								T.OPTION_TYPE,
								T.SELL_BUY,
								T.TRADE_NO,
								T.USER_ID,
								T.PARTICIPANTCODE,
								T.BRANCH_ID,
								MKTAMOUNT = SUM(T.TRADEQTY * T.PRICE),
								NETAMOUNT = CONVERT(NUMERIC(18,4), 0),
								MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) ELSE ROUND((SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY)), 4, 1) END),
								NETRATE = CONVERT(NUMERIC(18,4), 0),
								QTY = SUM(T.TRADEQTY),
								MKTRND = ISNULL(C.MARKETRATE, 4),
								NETRND = ISNULL(C.NETRATE, 4),
								BRKRND = ISNULL(C.BROKERAGE, 4)
							FROM
								FOTRADE T WITH (NOLOCK)
									LEFT OUTER JOIN
										(SELECT
											C1.LONG_NAME,
											C2.PARTY_CODE,
											MARKETRATE = ISNULL(R.MARKETRATE, 4),
											NETRATE = ISNULL(R.NETRATE, 4),
											BROKERAGE = ISNULL(R.BROKERAGE, 4)
										FROM
											CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
										WHERE
											C2.PARTY_CODE >= @FROM_PARTY
											AND C2.PARTY_CODE <= @TO_PARTY
											AND (C1.CL_TYPE = 'INS' OR C1.CL_TYPE <> (SELECT MEMBERCODE FROM OWNER))
										) C
								ON (T.PARTY_CODE = C.PARTY_CODE)
							WHERE
								T.TRADEQTY > 0
								AND T.BOOKTYPE <> '99'
								AND T.PARTY_CODE >= @FROM_PARTY
								AND T.PARTY_CODE <= @TO_PARTY
								AND T.SYMBOL >= @FROM_SYMBOL
								AND T.SYMBOL <= @TO_SYMBOL
								AND T.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
--								AND T.PARTIPANTCODE = @PARTICIPANT
							GROUP BY
								T.PARTY_CODE,
								ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								T.SYMBOL,
								T.INST_TYPE,
								T.EXPIRYDATE,
								T.STRIKE_PRICE,
								T.OPTION_TYPE,
								T.SELL_BUY,
								T.TRADE_NO,
								T.USER_ID,
								T.PARTICIPANTCODE,
								T.BRANCH_ID,
								C.MARKETRATE,
								ISNULL(C.NETRATE, 4),
								ISNULL(C.BROKERAGE, 4)
							ORDER BY
								T.PARTY_CODE,
								T.SYMBOL,								
								T.SELL_BUY,
								T.TRADE_NO,
								T.BRANCH_ID
						END
				END
			ELSE IF @TRFTABLE = 'FOSETTLEMENT'
				BEGIN
					IF @ORDER_NO <> ''
						BEGIN
							SELECT
								I.PARTY_CODE,
								PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.ORDER_NO,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)),
								NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)),
								MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END),
								NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END),
								QTY = SUM(I.TRADEQTY),
								MKTRND = C.MARKETRATE,
								NETRND = C.NETRATE,
								BRKRND = C.BROKERAGE
							FROM
								FOSETTLEMENT I WITH (NOLOCK)
									INNER JOIN
										(SELECT
											C1.LONG_NAME,
											C2.PARTY_CODE,
											MARKETRATE = ISNULL(R.MARKETRATE, 4),
											NETRATE = ISNULL(R.NETRATE, 4),
											BROKERAGE = ISNULL(R.BROKERAGE, 4)
										FROM
											CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
										WHERE
											C2.PARTY_CODE >= @FROM_PARTY
											AND C2.PARTY_CODE <= @TO_PARTY
										) C
								ON (I.PARTY_CODE = C.PARTY_CODE)
							WHERE
								I.SAUDA_DATE LIKE @TDATE + '%'
								AND I.TRADEQTY > 0
								AND I.SYMBOL >= @FROM_SYMBOL
								AND I.SYMBOL <= @TO_SYMBOL
								AND I.ORDER_NO = @ORDER_NO
								AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
--								AND I.PARTIPANTCODE = @PARTICIPANT
							GROUP BY
								I.PARTY_CODE,
								C.LONG_NAME,
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.ORDER_NO,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								C.MARKETRATE,
								C.NETRATE,
								C.BROKERAGE
							ORDER BY
								I.PARTY_CODE,
								I.SYMBOL,								
								I.SELL_BUY,
								I.ORDER_NO,
								I.TRADE_NO,
								I.BRANCH_ID
						END
					ELSE
						BEGIN
							SELECT
								I.PARTY_CODE,
								PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)),
								NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)),
								MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END),
								NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END),
								QTY = SUM(I.TRADEQTY),
								MKTRND = C.MARKETRATE,
								NETRND = C.NETRATE,
								BRKRND = C.BROKERAGE
							FROM
								FOSETTLEMENT I WITH (NOLOCK)
									INNER JOIN
										(SELECT
											C1.LONG_NAME,
											C2.PARTY_CODE,
											MARKETRATE = ISNULL(R.MARKETRATE, 4),
											NETRATE = ISNULL(R.NETRATE, 4),
											BROKERAGE = ISNULL(R.BROKERAGE, 4)
										FROM
											CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
										WHERE
											C2.PARTY_CODE >= @FROM_PARTY
											AND C2.PARTY_CODE <= @TO_PARTY
										) C
								ON (I.PARTY_CODE = C.PARTY_CODE)
							WHERE
								I.SAUDA_DATE LIKE @TDATE + '%'
								AND I.TRADEQTY > 0
								AND I.SYMBOL >= @FROM_SYMBOL
								AND I.SYMBOL <= @TO_SYMBOL
								AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
--								AND I.PARTIPANTCODE = @PARTICIPANT								
							GROUP BY
								I.PARTY_CODE,
								C.LONG_NAME,
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								C.MARKETRATE,
								C.NETRATE,
								C.BROKERAGE
							ORDER BY
								I.PARTY_CODE,
								I.SYMBOL,
								I.SELL_BUY,
								I.TRADE_NO,
								I.BRANCH_ID
						END
				END
			ELSE IF @TRFTABLE = 'SETTLEMENT'
				BEGIN
					IF @ORDER_NO <> ''
						BEGIN
							SELECT
								I.PARTY_CODE,
								PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.ORDER_NO,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)),
								NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)),
								MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END),
								NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END),
								QTY = SUM(I.TRADEQTY),
								MKTRND = C.MARKETRATE,
								NETRND = C.NETRATE,
								BRKRND = C.BROKERAGE
							FROM
								FOSETTLEMENT I WITH (NOLOCK)
									INNER JOIN
										(SELECT
											C1.LONG_NAME,
											C2.PARTY_CODE,
											MARKETRATE = ISNULL(R.MARKETRATE, 4),
											NETRATE = ISNULL(R.NETRATE, 4),
											BROKERAGE = ISNULL(R.BROKERAGE, 4)
										FROM
											CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
										WHERE
											C2.PARTY_CODE >= @FROM_PARTY
											AND C2.PARTY_CODE <= @TO_PARTY
										) C
								ON (I.PARTY_CODE = C.PARTY_CODE)
							WHERE
								I.SAUDA_DATE LIKE @TDATE + '%'
								AND I.TRADEQTY > 0
								AND I.SYMBOL >= @FROM_SYMBOL
								AND I.SYMBOL <= @TO_SYMBOL
								AND I.ORDER_NO = @ORDER_NO
								AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
--								AND I.PARTIPANTCODE = @PARTICIPANT								
							GROUP BY
								I.PARTY_CODE,
								C.LONG_NAME,
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.ORDER_NO,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								C.MARKETRATE,
								C.NETRATE,
								C.BROKERAGE
							ORDER BY
								I.PARTY_CODE,
								I.SYMBOL,								
								I.SELL_BUY,
								I.ORDER_NO,
								I.TRADE_NO,
								I.BRANCH_ID
						END
					ELSE
						BEGIN
							SELECT
								I.PARTY_CODE,
								PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								MKTAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.PRICE)),
								NETAMOUNT = CONVERT(NUMERIC(18, 4), SUM(I.TRADEQTY * I.NETRATE)),
								MKTRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.MARKETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), 4, 1) END),
								NETRATE = CONVERT(NUMERIC(18, 4), CASE ISNULL(C.NETRATE, 4) WHEN 2 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 2, 1) WHEN 4 THEN ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) ELSE ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), 4, 1) END),
								QTY = SUM(I.TRADEQTY),
								MKTRND = C.MARKETRATE,
								NETRND = C.NETRATE,
								BRKRND = C.BROKERAGE
							FROM
								FOSETTLEMENT I WITH (NOLOCK)
									INNER JOIN
										(SELECT
											C1.LONG_NAME,
											C2.PARTY_CODE,
											MARKETRATE = ISNULL(R.MARKETRATE, 4),
											NETRATE = ISNULL(R.NETRATE, 4),
											BROKERAGE = ISNULL(R.BROKERAGE, 4)
										FROM
											CLIENT1 C1 WITH (NOLOCK) INNER JOIN CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
										WHERE
											C2.PARTY_CODE >= @FROM_PARTY
											AND C2.PARTY_CODE <= @TO_PARTY
										) C
								ON (I.PARTY_CODE = C.PARTY_CODE)
							WHERE
								I.SAUDA_DATE LIKE @TDATE + '%'
								AND I.TRADEQTY > 0
								AND I.SYMBOL >= @FROM_SYMBOL
								AND I.SYMBOL <= @TO_SYMBOL
								AND I.SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 0 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 0 THEN 2 ELSE @SELL_BUY END
--								AND I.PARTIPANTCODE = @PARTICIPANT								
							GROUP BY
								I.PARTY_CODE,
								C.LONG_NAME,
								I.SYMBOL,
								I.INST_TYPE,
								I.EXPIRYDATE,
								I.STRIKE_PRICE,
								I.OPTION_TYPE,
								I.SELL_BUY,
								I.TRADE_NO,
								I.USER_ID,
								I.PARTICIPANTCODE,
								I.BRANCH_ID,								
								C.MARKETRATE,
								C.NETRATE,
								C.BROKERAGE
							ORDER BY
								I.PARTY_CODE,
								I.SYMBOL,								
								I.SELL_BUY,
								I.TRADE_NO,
								I.BRANCH_ID
						END
				END
		END	
	ELSE IF @LEVEL = 201		-- FOR REJECTION I.E. FROM ISETTLEMENT TO SETTLEMENT
		BEGIN			
			SELECT 
			I.PARTY_CODE, 
			PARTY_NAME = C.LONG_NAME, 
			I.INST_TYPE,I.SYMBOL,I.SEC_NAME,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,
			I.SETT_NO ,
			I.SETT_TYPE,
			I.CONTRACTNO, 
			I.SELL_BUY, 
			PARTICIPANTCODE = I.PARTICIPANTCODE, 
			QTY = SUM(I.TRADEQTY),
			MARKETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (4)), 1)),
			R_MKTRATE = 4 
			FROM 
			FOSETTLEMENT I WITH (NOLOCK)
			INNER JOIN 
			(	SELECT C1.LONG_NAME, C2.PARTY_CODE
				FROM CLIENT2 C2 WITH (NOLOCK)
				INNER JOIN CLIENT1 C1 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
				WHERE 
				C2.PARTY_CODE >=  @FROM_PARTY 
				AND C2.PARTY_CODE <=  @TO_PARTY 
				)C 
				ON I.PARTY_CODE = C.PARTY_CODE 
			WHERE 
				I.SAUDA_DATE LIKE  @TDATE + '%'
				AND RESERVED1 = 0
				AND I.TRADEQTY > 0 
				AND I.SYMBOL >= (CASE WHEN @FROM_SYMBOL <> '%' AND LEN(@FROM_SYMBOL) > 0 THEN @FROM_SYMBOL ELSE '0' END)
				AND I.SYMBOL <= (CASE WHEN @TO_SYMBOL <> '%' AND LEN(@TO_SYMBOL) > 0 THEN @TO_SYMBOL ELSE 'ZZZZZZZZZZ' END)
				AND I.USER_ID >= (CASE WHEN @FROM_TERM <> '%' AND LEN(@FROM_TERM) > 0 THEN @FROM_TERM ELSE '' END)
				AND I.USER_ID <= (CASE WHEN @TO_TERM <> '%' AND LEN(@TO_TERM) > 0 THEN @TO_TERM ELSE 'ZZZZZZZZZZ' END)
			/* CASE @FROM_SYMBOL WHEN '' THEN   ELSE (AND I.SYMBOL >=  @FROM_SYMBOL )END*/

			/*IF LTRIM(RTRIM(@FROM_SYMBOL)) <> ''
				 AND I.SYMBOL >=  @FROM_SYMBOL 

			IF LTRIM(RTRIM(@TO_SYMBOL)) <> ''
				 AND I.SYMBOL <=  @TO_SYMBOL 

			IF LTRIM(RTRIM(@FROM_TERM)) <> ''
				 AND I.USER_ID >=  @FROM_TERM 
				
			IF LTRIM(RTRIM(@TO_TERM)) <> ''
				AND I.USER_ID <=  @TO_TERM */
					
				GROUP BY 
				I.PARTY_CODE, 
				C.LONG_NAME,
				I.SETT_NO,
				I.SETT_TYPE,
				I.CONTRACTNO,
				I.SELL_BUY,
				I.PARTICIPANTCODE,
				I.INST_TYPE,I.SYMBOL,I.SEC_NAME,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE
		END
	ELSE IF @LEVEL = 301		-- FOR REJECTION I.E. FROM ISETTLEMENT TO SETTLEMENT
		BEGIN			
			SELECT 
			I.PARTY_CODE, 
			PARTY_NAME = C.LONG_NAME, 
			I.INST_TYPE,I.SYMBOL,I.SEC_NAME,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,
			I.SETT_NO ,
			I.SETT_TYPE,
			I.CONTRACTNO, 
			I.SELL_BUY, 
			PARTICIPANTCODE = I.PARTICIPANTCODE, 
			QTY = SUM(I.TRADEQTY),
			MARKETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (4)), 1)),
			R_MKTRATE = 4 
			FROM 
			FOSETTLEMENT I WITH (NOLOCK)
			INNER JOIN 
			(	SELECT C1.LONG_NAME, C2.PARTY_CODE
				FROM CLIENT2 C2 WITH (NOLOCK)
				INNER JOIN CLIENT1 C1 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
				WHERE 
				C2.PARTY_CODE >=  @FROM_PARTY 
				AND C2.PARTY_CODE <=  @TO_PARTY 
				)C 
				ON I.PARTY_CODE = C.PARTY_CODE 
			WHERE 
				I.SAUDA_DATE LIKE  @TDATE + '%'
				AND RESERVED1 = 1
				AND I.TRADEQTY > 0 
				AND I.SYMBOL >= (CASE WHEN @FROM_SYMBOL <> '%' AND LEN(@FROM_SYMBOL) > 0 THEN @FROM_SYMBOL ELSE '0' END)
				AND I.SYMBOL <= (CASE WHEN @TO_SYMBOL <> '%' AND LEN(@TO_SYMBOL) > 0 THEN @TO_SYMBOL ELSE 'ZZZZZZZZZZ' END)
				AND I.USER_ID >= (CASE WHEN @FROM_TERM <> '%' AND LEN(@FROM_TERM) > 0 THEN @FROM_TERM ELSE '' END)
				AND I.USER_ID <= (CASE WHEN @TO_TERM <> '%' AND LEN(@TO_TERM) > 0 THEN @TO_TERM ELSE 'ZZZZZZZZZZ' END)
			/* CASE @FROM_SYMBOL WHEN '' THEN   ELSE (AND I.SYMBOL >=  @FROM_SYMBOL )END*/

			/*IF LTRIM(RTRIM(@FROM_SYMBOL)) <> ''
				 AND I.SYMBOL >=  @FROM_SYMBOL 

			IF LTRIM(RTRIM(@TO_SYMBOL)) <> ''
				 AND I.SYMBOL <=  @TO_SYMBOL 

			IF LTRIM(RTRIM(@FROM_TERM)) <> ''
				 AND I.USER_ID >=  @FROM_TERM 
				
			IF LTRIM(RTRIM(@TO_TERM)) <> ''
				AND I.USER_ID <=  @TO_TERM */
					
				GROUP BY 
				I.PARTY_CODE, 
				C.LONG_NAME,
				I.SETT_NO,
				I.SETT_TYPE,
				I.CONTRACTNO,
				I.SELL_BUY,
				I.PARTICIPANTCODE,
				I.INST_TYPE,I.SYMBOL,I.SEC_NAME,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE
		END		
		ELSE IF @LEVEL = 401
		BEGIN
			IF @TRFTABLE = 'FOSETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						PARTICIPANTCODE = '',
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.CONTRACTNO,
						TRADE_NO = '',
						ORDER_NO = '',
						QTY = SUM(I.TRADEQTY),
						MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE
					 FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
							(
								SELECT
									C2.PARTY_CODE,
									C1.LONG_NAME,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK)
										INNER JOIN
									CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN
									INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
									--AND C1.CL_TYPE = 'INS'
							) C ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.RESERVED1 = 1
						AND I.DUMMY1 = 1
						AND I.SYMBOL >= CASE WHEN (@FROM_SYMBOL = '' OR @FROM_SYMBOL = '%') THEN '0' ELSE @FROM_SYMBOL END
						AND I.SYMBOL <= CASE WHEN (@TO_SYMBOL = '' OR @TO_SYMBOL = '%') THEN 'ZZZZZZZZZZ' ELSE @TO_SYMBOL END
						AND I.USER_ID >= CASE WHEN (@FROM_TERM = '' OR @FROM_TERM = '%') THEN '' ELSE @FROM_TERM END
						AND I.USER_ID <= CASE WHEN (@TO_TERM = '' OR @TO_TERM = '%') THEN 'ZZZZZZZZZZ' ELSE @TO_TERM END
/*					IF @INST_TYPE <> ''
						BEGIN
							  AND I.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							  AND I.STRIKE_PRICE = '" + @STRIKE_PRICE + "'"
						END
					IF @OPTION_TYPE <>''
						BEGIN
							  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END*/
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
--						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,			
						I.SELL_BUY,			
						I.CONTRACTNO,
--						I.TRADE_NO,
--						I.ORDER_NO,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						C.LONG_NAME,			
						I.CONTRACTNO,
						I.SYMBOL,			
						I.SELL_BUY
				END
			ELSE IF @TRFTABLE = 'SETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						PARTICIPANTCODE = '',
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.CONTRACTNO,
						TRADE_NO = '',
						ORDER_NO = '',
						QTY = SUM(I.TRADEQTY),
						MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
							(
								SELECT
									C2.PARTY_CODE,
									C1.LONG_NAME,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK)
										INNER JOIN
										CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN
											INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
							) C ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.RESERVED1 = 0
						AND I.SYMBOL >= CASE WHEN (@FROM_SYMBOL = '' OR @FROM_SYMBOL = '%') THEN '0' ELSE @FROM_SYMBOL END
						AND I.SYMBOL <= CASE WHEN (@TO_SYMBOL = '' OR @TO_SYMBOL = '%') THEN 'ZZZZZZZZZZ' ELSE @TO_SYMBOL END
						AND I.USER_ID >= CASE WHEN (@FROM_TERM = '' OR @FROM_TERM = '%') THEN '' ELSE @FROM_TERM END
						AND I.USER_ID <= CASE WHEN (@TO_TERM = '' OR @TO_TERM = '%') THEN 'ZZZZZZZZZZ' ELSE @TO_TERM END
/*					IF @INST_TYPE <> ''
						BEGIN
							  AND I.INST_TYPE = ' + @INST_TYPE +'
						END
					IF @EXPIRYDATE <>''
						BEGIN
							  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = ' + @EXPIRYDATE +'
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							  AND I.STRIKE_PRICE = ' + @STRIKE_PRICE +'
						END
					IF @OPTION_TYPE <>''
						BEGIN
							  AND I.OPTION_TYPE = ' + @OPTION_TYPE +'
						END*/
						--AND I.DUMMY1 = 1
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
--						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,		
						I.SELL_BUY,
						I.CONTRACTNO,
--						I.TRADE_NO,
--						I.ORDER_NO,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						C.LONG_NAME,		
						I.CONTRACTNO,
						I.SYMBOL,
						I.SELL_BUY
				END
		END
	ELSE IF @LEVEL = 501
		BEGIN
			IF @TRFTABLE = 'FOSETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.CONTRACTNO,
						TRADE_NO = '',
						ORDER_NO = '',
						QTY = SUM(I.TRADEQTY),
						MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE,
						C.BANKID
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
							(
								SELECT
									C2.PARTY_CODE,
									C1.LONG_NAME,
									R.MARKETRATE,
									R.NETRATE,
									R.BROKERAGE,
									C2.BANKID
								FROM
									CLIENT1 C1 WITH (NOLOCK)
										INNER JOIN
										CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											INNER JOIN
											INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
							) C ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.RESERVED1 = 1
						AND I.SYMBOL >= CASE WHEN (@FROM_SYMBOL = '' OR @FROM_SYMBOL = '%') THEN '0' ELSE @FROM_SYMBOL END
						AND I.SYMBOL <= CASE WHEN (@TO_SYMBOL = '' OR @TO_SYMBOL = '%') THEN 'ZZZZZZZZZ' ELSE @TO_SYMBOL END
						AND I.USER_ID >= CASE WHEN (@FROM_TERM = '' OR @FROM_TERM = '%') THEN '' ELSE @FROM_TERM END
						AND I.USER_ID <= CASE WHEN (@TO_TERM = '' OR @TO_TERM = '%') THEN 'ZZZZZZZZZ' ELSE @TO_TERM END
/*					IF @INST_TYPE <> ''
						BEGIN
							  AND I.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							  AND I.STRIKE_PRICE = '" + @STRIKE_PRICE + "'"
						END
					IF @OPTION_TYPE <>''
						BEGIN
							  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END*/
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.CONTRACTNO,
/*						I.TRADE_NO,
						I.ORDER_NO,*/
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE,
						C.BANKID
					ORDER BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.CONTRACTNO,
						I.SYMBOL,
						I.SELL_BUY
				END
			ELSE IF @TRFTABLE = 'SETTLEMENT'
				BEGIN
					SET @SQL = ""
					SET @SQL = @SQL + "SELECT "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'), "
					SET @SQL = @SQL + "	I.PARTICIPANTCODE, "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.INST_TYPE,"
					SET @SQL = @SQL + "	I.EXPIRYDATE,"
					SET @SQL = @SQL + "	I.STRIKE_PRICE,"
					SET @SQL = @SQL + "	I.OPTION_TYPE,"
					SET @SQL = @SQL + "	I.SELL_BUY, "
					SET @SQL = @SQL + "	I.CONTRACTNO, "
					SET @SQL = @SQL + " I.TRADE_NO,"
					SET @SQL = @SQL + " I.ORDER_NO,"
					SET @SQL = @SQL + "	QTY = SUM(I.TRADEQTY), "
					SET @SQL = @SQL +"	MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)), "
					SET @SQL = @SQL + "	AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)), "
					SET @SQL = @SQL + "	NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)), "
					SET @SQL = @SQL + "	MKTRND = C.MARKETRATE, "
					SET @SQL = @SQL + "	NETRND = C.NETRATE, "
					SET @SQL = @SQL + "	BRKRND = C.BROKERAGE, "
					SET @SQL = @SQL + "	C.BANKID "
					SET @SQL = @SQL + "FROM "
					SET @SQL = @SQL + "	FOSETTLEMENT I WITH (NOLOCK) "
					SET @SQL = @SQL + "		INNER JOIN "
					SET @SQL = @SQL + "		( "
					SET @SQL = @SQL + "			SELECT "
					SET @SQL = @SQL + "				C2.PARTY_CODE, "
					SET @SQL = @SQL + "				C1.LONG_NAME, "
					SET @SQL = @SQL + "				C2.BANKID, "
					SET @SQL = @SQL + "				MARKETRATE = ISNULL(R.MARKETRATE, 4), "
					SET @SQL = @SQL + "				NETRATE = ISNULL(R.NETRATE, 4), "
					SET @SQL = @SQL + "				BROKERAGE = ISNULL(R.BROKERAGE, 4) "
					SET @SQL = @SQL + "			FROM "
					SET @SQL = @SQL + "				CLIENT1 C1 WITH (NOLOCK) "
					SET @SQL = @SQL + "					INNER JOIN "
					SET @SQL = @SQL + "					CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE) "
					SET @SQL = @SQL + "						LEFT JOIN "
					SET @SQL = @SQL + "						INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE) "
					SET @SQL = @SQL + "			WHERE "
					SET @SQL = @SQL + "				C2.PARTY_CODE BETWEEN '" + @FROM_PARTY + "' AND '" + @TO_PARTY + "' "
					SET @SQL = @SQL + "		) C ON (I.PARTY_CODE = C.PARTY_CODE) "
					SET @SQL = @SQL + "WHERE "
					SET @SQL = @SQL + "	I.SAUDA_DATE LIKE '" + @TDATE + "%' "
					SET @SQL = @SQL + "	AND I.TRADEQTY > 0 AND I.RESERVED1 = 0"
					IF LTRIM(RTRIM(@FROM_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "AND I.SYMBOL >= '" + @FROM_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@TO_SYMBOL)) <> ''
						BEGIN
							SET @SQL = @SQL + "AND I.SYMBOL <= '" + @TO_SYMBOL + "' "
						END
					IF LTRIM(RTRIM(@FROM_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "AND I.USER_ID >= '" + @FROM_TERM + "' "
						END
					IF LTRIM(RTRIM(@TO_TERM)) <> ''
						BEGIN
							SET @SQL = @SQL + "AND I.USER_ID <= '" + @TO_TERM + "' "
						END
					IF @INST_TYPE <> ''
						BEGIN
							SET @SQL = @SQL + "  AND I.INST_TYPE = '" + @INST_TYPE + "'"
						END
					IF @EXPIRYDATE <>''
						BEGIN
							SET @SQL = @SQL + "  AND CONVERT(VARCHAR, I.EXPIRYDATE, 103) = '" + @EXPIRYDATE + "'"
						END
					IF @STRIKE_PRICE <>0
						BEGIN
							SET @SQL = @SQL + "  AND I.STRIKE_PRICE = '" + @STRIKE_PRICE + "'"
						END
					IF @OPTION_TYPE <>''
						BEGIN
							SET @SQL = @SQL + "  AND I.OPTION_TYPE = '" + @OPTION_TYPE + "'"
						END
						
					SET @SQL = @SQL + "GROUP BY "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	C.LONG_NAME, "
					SET @SQL = @SQL + "	I.PARTICIPANTCODE, "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.INST_TYPE,"
					SET @SQL = @SQL + "	I.EXPIRYDATE,"
					SET @SQL = @SQL + "	I.STRIKE_PRICE,"
					SET @SQL = @SQL + "	I.OPTION_TYPE,"
					SET @SQL = @SQL + "	I.SELL_BUY, "
					SET @SQL = @SQL + "	I.CONTRACTNO, "
					SET @SQL = @SQL + " I.TRADE_NO,"
					SET @SQL = @SQL + " I.ORDER_NO,"
					SET @SQL = @SQL + "	C.MARKETRATE, "
					SET @SQL = @SQL + "	C.NETRATE, "
					SET @SQL = @SQL + "	C.BROKERAGE, "
					SET @SQL = @SQL + "	C.BANKID "
					SET @SQL = @SQL + "ORDER BY "
					SET @SQL = @SQL + "	I.PARTY_CODE, "
					SET @SQL = @SQL + "	C.LONG_NAME, "
					SET @SQL = @SQL + "	I.CONTRACTNO, "
					SET @SQL = @SQL + "	I.SYMBOL, "
					SET @SQL = @SQL + "	I.SELL_BUY "
				END
		END
	ELSE IF @LEVEL = 502
		BEGIN
			IF @TRFTABLE = 'FOSETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.CONTRACTNO,
						I.ORDER_NO,
						QTY = SUM(I.TRADEQTY),
						MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
							(
								SELECT
									C2.PARTY_CODE,
									C1.LONG_NAME,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK)
										INNER JOIN
										CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN
											INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
							) C ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.CONTRACTNO = @CONTRACTNO
						AND I.SYMBOL >= @FROM_SYMBOL
						AND I.SYMBOL <= @TO_SYMBOL
						AND I.SELL_BUY = @SELL_BUY
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.CONTRACTNO,
						I.ORDER_NO,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.CONTRACTNO,
						I.ORDER_NO,
						I.SYMBOL,
						I.SELL_BUY
				END
			ELSE IF @TRFTABLE = 'SETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						PARTY_NAME = ISNULL(C.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,
						I.CONTRACTNO,
						I.ORDER_NO,
						QTY = SUM(I.TRADEQTY),
						MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
							(
								SELECT
									C2.PARTY_CODE,
									C1.LONG_NAME,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK)
										INNER JOIN
										CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN
											INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
							) C ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.CONTRACTNO = @CONTRACTNO
						AND I.SYMBOL >= @FROM_SYMBOL
						AND I.SYMBOL <= @TO_SYMBOL
						AND I.SELL_BUY = @SELL_BUY
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,						
						I.CONTRACTNO,
						I.ORDER_NO,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						C.LONG_NAME,						
						I.CONTRACTNO,
						I.ORDER_NO,
						I.SYMBOL,						
						I.SELL_BUY
				END
		END
	ELSE IF @LEVEL = 503
		BEGIN
			IF @TRFTABLE = 'FOSETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						C.LONG_NAME,
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,						
						I.SELL_BUY,						
						I.CONTRACTNO,
						I.ORDER_NO,
						I.TRADE_NO,
						QTY = SUM(I.TRADEQTY),
						MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
							(
								SELECT
									C2.PARTY_CODE,
									C1.LONG_NAME,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK)
										INNER JOIN
										CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN
											INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
							) C ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						AND I.CONTRACTNO = @CONTRACTNO
						AND I.ORDER_NO = @ORDER_NO
						AND I.SYMBOL >= @FROM_SYMBOL
						AND I.SYMBOL <= @TO_SYMBOL
						AND I.SELL_BUY = @SELL_BUY
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,
						I.SELL_BUY,						
						I.CONTRACTNO,
						I.ORDER_NO,
						I.TRADE_NO,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						C.LONG_NAME,						
						I.CONTRACTNO,
						I.ORDER_NO,
						I.TRADE_NO,
						I.SYMBOL,						
						I.SELL_BUY
				END
			ELSE IF @TRFTABLE = 'SETTLEMENT'
				BEGIN
					SELECT
						I.PARTY_CODE,
						C.LONG_NAME,
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,						
						I.SELL_BUY,						
						I.CONTRACTNO,
						I.ORDER_NO,
						I.TRADE_NO,
						QTY = SUM(I.TRADEQTY),
						MKTRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.PRICE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						AVGRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.DUMMY1) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.MARKETRATE, 4))), 1)),
						NETRATE = CONVERT(NUMERIC(18, 4), ROUND((SUM(I.TRADEQTY * I.NETRATE) / SUM(I.TRADEQTY)), CONVERT(NUMERIC(4), (ISNULL(C.NETRATE, 4))), 1)),
						MKTRND = C.MARKETRATE,
						NETRND = C.NETRATE,
						BRKRND = C.BROKERAGE
					FROM
						FOSETTLEMENT I WITH (NOLOCK)
							INNER JOIN
							(
								SELECT
									C2.PARTY_CODE,
									C1.LONG_NAME,
									MARKETRATE = ISNULL(R.MARKETRATE, 4),
									NETRATE = ISNULL(R.NETRATE, 4),
									BROKERAGE = ISNULL(R.BROKERAGE, 4)
								FROM
									CLIENT1 C1 WITH (NOLOCK)
										INNER JOIN
										CLIENT2 C2 WITH (NOLOCK) ON (C1.CL_CODE = C2.CL_CODE)
											LEFT JOIN
											INSTCLIENT_TBL R WITH (NOLOCK) ON (C2.PARTY_CODE = R.PARTYCODE)
								WHERE
									C2.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
							) C ON (I.PARTY_CODE = C.PARTY_CODE)
					WHERE
						I.SAUDA_DATE LIKE @TDATE + '%'
						AND I.TRADEQTY > 0
						--AND I.DUMMY2 = 1						
						AND I.CONTRACTNO = @CONTRACTNO
						AND I.ORDER_NO = @ORDER_NO
						AND I.SYMBOL >= @FROM_SYMBOL
						AND I.SYMBOL <= @TO_SYMBOL
						AND I.SELL_BUY = @SELL_BUY
					GROUP BY
						I.PARTY_CODE,
						C.LONG_NAME,
						I.PARTICIPANTCODE,
						I.SYMBOL,
						I.INST_TYPE,
						I.EXPIRYDATE,
						I.STRIKE_PRICE,
						I.OPTION_TYPE,						
						I.SELL_BUY,						
						I.CONTRACTNO,
						I.ORDER_NO,
						I.TRADE_NO,
						C.MARKETRATE,
						C.NETRATE,
						C.BROKERAGE
					ORDER BY
						I.PARTY_CODE,
						C.LONG_NAME,						
						I.CONTRACTNO,
						I.ORDER_NO,
						I.TRADE_NO,
						I.SYMBOL,						
						I.SELL_BUY
				END
		END
	ELSE IF @LEVEL = 601
		BEGIN
			IF @TRFTABLE = 'FOTRADE'
				BEGIN
					SELECT
						T.PARTY_CODE,
						LONG_NAME = ISNULL(C1.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						SCRIP_CD = '',
						SERIES = '',
						SCRIP_NAME = T.SEC_NAME,
						T.USER_ID,
						T.PARTICIPANTCODE,
						T.SYMBOL,
						T.INST_TYPE,
						EXPIRYDATE = CONVERT(VARCHAR(10), T.EXPIRYDATE, 103),
						T.STRIKE_PRICE,
						T.OPTION_TYPE,
						TRADEQTY = SUM(T.TRADEQTY),
						TRADEVALUE = SUM(T.TRADEQTY * T.PRICE),
						TRADERATE = SUM(T.TRADEQTY * T.PRICE) / SUM(T.TRADEQTY),
						CONSOLIDATED = '0',
						MARKETVALUE = SUM(T.TRADEQTY * T.PRICE),
						ORDERS = COUNT(DISTINCT T.ORDER_NO),
						TRADES = COUNT(T.TRADE_NO)
					FROM
						FOTRADE T LEFT JOIN
							(SELECT C.LONG_NAME, C2.PARTY_CODE FROM
							CLIENT2 C2 INNER JOIN CLIENT1 C ON C.CL_CODE = C2.CL_CODE) C1
							ON T.PARTY_CODE = C1.PARTY_CODE
					WHERE
						ACTIVITYTIME LIKE @TDATE + '%'
						AND T.PARTY_CODE BETWEEN @FROM_PARTY AND @TO_PARTY
						AND T.SYMBOL BETWEEN CASE WHEN @FROM_SYMBOL = '' THEN '' ELSE @FROM_SYMBOL END AND CASE WHEN @TO_SYMBOL = '' THEN 'Z' ELSE @TO_SYMBOL END
						AND T.USER_ID BETWEEN CASE WHEN @FROM_TERM = '' THEN '' ELSE @FROM_TERM END AND CASE WHEN @TO_TERM = '' THEN '999999' ELSE @TO_TERM END
					GROUP BY
						T.PARTY_CODE,
						ISNULL(C1.LONG_NAME, 'CLIENT CODE NOT FOUND'),
						T.SYMBOL,
						T.INST_TYPE,
						CONVERT(VARCHAR(10), T.EXPIRYDATE, 103),
						T.STRIKE_PRICE,
						T.OPTION_TYPE,
						T.SEC_NAME,
						T.USER_ID,
						T.PARTICIPANTCODE
					ORDER BY
						T.PARTY_CODE,
						T.SYMBOL,
						T.INST_TYPE
				END
			ELSE
				BEGIN
					SELECT
						PARTY_CODE,
						LONG_NAME = '',
						SCRIP_CD = '',
						SERIES = '',
						SCRIP_NAME = '',
						USER_ID,
						PARTICIPANTCODE,
						SYMBOL,
						INST_TYPE,
						EXPIRYDATE = CONVERT(VARCHAR(10), EXPIRYDATE, 103),
						STRIKE_PRICE,
						OPTION_TYPE,
						TRADEQTY = 0,
						TRADEVALUE = 0,
						TRADERATE = 0,
						CONSOLIDATED = '0',
						MARKETVALUE = 0,
						ORDERS = 0,
						TRADES = 0
					FROM
						FOTRADE
					WHERE
						1 = 0
				END
		END
PRINT @SQL
EXEC (@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRADE_CONSOLIDATION_INS_ALL
-- --------------------------------------------------
CREATE PROC [DBO].[TRADE_CONSOLIDATION_INS_ALL]  

 @SAUDADATE VARCHAR(10),  
 @FROMPARTY VARCHAR(10),  
 @TOPARTY VARCHAR(10),  
 @FROMSYMBOL VARCHAR(10),  
 @TOSYMBOL VARCHAR(10),  
 @FROMTERM VARCHAR(10),  
 @TOTERM VARCHAR(10),  
 @CONSOLIDATE INT,     
 @CONTRACTNO VARCHAR(7),  
 @AFTERCONTRACT VARCHAR(1) = 'Y',  
 @SELL_BUY INT = 0,
 @LEVEL INT,
 @PARTICIPANT VARCHAR(20) = '',  
 @ORDER_NO VARCHAR(16) = '',  
 @SHOW INT = 0,  
 @TRFTABLE VARCHAR(20) = 'FOTRADE'  
AS  

/*---------------------------------------------------------------------------
	PROC NAME   : TRADE_CONSOLIDATION_PROC
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : AVAILABLE DATA FETCHING FOR CONSOLIDATES & NON CSONSOLIDATES
------------------------------------------------------------------------------*/
 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

 DECLARE @SQL AS VARCHAR(8000)  
 DECLARE @MEMBER VARCHAR(15)  
 SET @MEMBER = ''  
 SELECT @MEMBER = ISNULL(MEMBERCODE, '') FROM OWNER  
 CREATE TABLE #TRADE_CONSOLIDATION  
 (  
  PARTY_CODE VARCHAR(10),  
  ORGPARTY VARCHAR(10),  
  PARTIPANTCODE VARCHAR(15),  
  USER_ID VARCHAR(10),  
  CONTRACTNO VARCHAR(14),  
  SYMBOL VARCHAR(20),
  INST_TYPE VARCHAR(10),
  EXPIRYDATE VARCHAR(10),
  STRIKE_PRICE NUMERIC(18,4),
  OPTION_TYPE VARCHAR(10),	  
  
  LONG_NAME VARCHAR(100),  
  
  DUMMY1 VARCHAR(15),  
  SELL_BUY VARCHAR(4),  
  QTY INT,  
  MKTRATE MONEY,  
  NETRATE MONEY,  
  AMOUNT MONEY,  
  DEALTICKETPRICE MONEY,  
  NETAMOUNT MONEY,  
  PARTY_NAME VARCHAR(100),  
  R_MKTRATE INT,  
  R_BROKERAGE INT,  
  R_NETRATE INT,  
  STP_TYPE VARCHAR(5),  
  STP_FLAG BIT,  
  CL_TYPE VARCHAR(3)  
 )  
 IF @CONSOLIDATE = 2  
  BEGIN  
   SET @SQL = "INSERT INTO #TRADE_CONSOLIDATION "  
   SET @SQL = @SQL + "( "  
   SET @SQL = @SQL + " PARTY_CODE, "  
   SET @SQL = @SQL + " ORGPARTY, "  
   SET @SQL = @SQL + " PARTIPANTCODE, "  
   SET @SQL = @SQL + " USER_ID, "  
   SET @SQL = @SQL + " CONTRACTNO, "  
   SET @SQL = @SQL + " SYMBOL, "
   SET @SQL = @SQL + " INST_TYPE,"
   SET @SQL = @SQL + " EXPIRYDATE,"
   SET @SQL = @SQL + " STRIKE_PRICE,"
   SET @SQL = @SQL + " OPTION_TYPE,"  
   
   SET @SQL = @SQL + " LONG_NAME, "  
   
   SET @SQL = @SQL + " DUMMY1, "  
   SET @SQL = @SQL + " SELL_BUY, "  
   SET @SQL = @SQL + " QTY, "  
   SET @SQL = @SQL + " MKTRATE, "  
   SET @SQL = @SQL + " NETRATE, "  
   SET @SQL = @SQL + " AMOUNT, "  
   SET @SQL = @SQL + " DEALTICKETPRICE, "  
   SET @SQL = @SQL + " NETAMOUNT, "  
   SET @SQL = @SQL + " PARTY_NAME, "  
   SET @SQL = @SQL + " R_MKTRATE, "  
   SET @SQL = @SQL + " R_BROKERAGE, "  
   SET @SQL = @SQL + " R_NETRATE, "  
   SET @SQL = @SQL + " STP_TYPE, "  
   SET @SQL = @SQL + " STP_FLAG, "  
   SET @SQL = @SQL + " CL_TYPE "  
   SET @SQL = @SQL + ") "  
   SET @SQL = @SQL + " SELECT "  
   SET @SQL = @SQL + "  I.PARTY_CODE, "  
   SET @SQL = @SQL + "  ORGPARTY = I.PARTY_CODE, "  
   SET @SQL = @SQL + "  I.PARTICIPANTCODE, "  
   SET @SQL = @SQL + "  I.USER_ID, "  
   SET @SQL = @SQL + "  I.CONTRACTNO, "  
   SET @SQL = @SQL + "  I.SYMBOL, "
   SET @SQL = @SQL + "	I.INST_TYPE,"
   SET @SQL = @SQL + "	I.EXPIRYDATE,"
   SET @SQL = @SQL + "	I.STRIKE_PRICE,"
   SET @SQL = @SQL + "	I.OPTION_TYPE,"  
   
   SET @SQL = @SQL + "  C1.LONG_NAME, "  
 
  SET @SQL = @SQL + "  I.DUMMY1, "  
   SET @SQL = @SQL + "  SELL_BUY = CASE WHEN I.SELL_BUY = 1 THEN 'BUY' ELSE 'SALE' END, "  
   SET @SQL = @SQL + "  QTY = SUM(I.TRADEQTY), "  
   SET @SQL = @SQL + "  MKTRATE = ((SUM(I.DUMMY2*I.TRADEQTY)) / (SUM(I.TRADEQTY))), "  
   SET @SQL = @SQL + "  NETRATE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
   SET @SQL = @SQL + "	ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "  
   SET @SQL = @SQL + "  AMOUNT = SUM(I.TRADEQTY * I.PRICE), "  
   SET @SQL = @SQL + "  DEALTICKETPRICE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.MARKETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
   SET @SQL = @SQL + "	ELSE ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "  
   SET @SQL = @SQL + "  NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
   SET @SQL = @SQL + "	ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "  
   SET @SQL = @SQL + "  PARTY_NAME = C1.LONG_NAME, "  
   SET @SQL = @SQL + "  R_MKTRATE = ISNULL(R.MARKETRATE, 4), "  
   SET @SQL = @SQL + "  R_BROKERAGE = ISNULL(R.BROKERAGE, 4), "  
   SET @SQL = @SQL + "  R_NETRATE = ISNULL(R.NETRATE, 4), "  
   SET @SQL = @SQL + "  STP_TYPE = C2.DUMMY6, "  
   SET @SQL = @SQL + "  STP_FLAG = 0,"  
   SET @SQL = @SQL + "  CL_TYPE = C1.CL_TYPE "  
   SET @SQL = @SQL + "  FROM"  
   SET @SQL = @SQL + "  FOSETTLEMENT I, "  
   SET @SQL = @SQL + "  CLIENT2 C2"  
   SET @SQL = @SQL + "  LEFT JOIN INSTCLIENT_TBL R"  
   SET @SQL = @SQL + "  ON (C2.PARTY_CODE = R.PARTYCODE),"  
   SET @SQL = @SQL + "  CLIENT1 C1 "  
   
   SET @SQL = @SQL + " WHERE"  
   SET @SQL = @SQL + "  C1.CL_CODE = C2.CL_CODE"  
   SET @SQL = @SQL + "  AND I.PARTY_CODE = C2.PARTY_CODE"  
   SET @SQL = @SQL + "  AND CONVERT(VARCHAR(10), SAUDA_DATE, 103) = '" + @SAUDADATE + "'"  
   SET @SQL = @SQL + "  AND I.TRADEQTY > 0"  
   IF @FROMSYMBOL <> '' AND @TOSYMBOL <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.SYMBOL >= '" + @FROMSYMBOL + "'"  
     SET @SQL = @SQL + "  AND I.SYMBOL <= '" + @TOSYMBOL + "'"  
    END     
   IF @SELL_BUY <> 0  
    BEGIN  
     SET @SQL = @SQL + "  AND I.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "  
    END  
 
   IF @CONTRACTNO <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.CONTRACTNO = '" + @CONTRACTNO + "'"  
    END  
   IF @CONSOLIDATE = 0  
    BEGIN  
     SET @SQL = @SQL + "  AND I.DUMMY1 = 0"  
    END  
   ELSE IF @CONSOLIDATE = 1  
    BEGIN  
     SET @SQL = @SQL + "  AND I.DUMMY1 = 1"  
    END  
   IF @FROMPARTY <> '' AND @TOPARTY = ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.PARTY_CODE = '" + @FROMPARTY + "'"  
    END  
   ELSE IF @FROMPARTY <> '' AND @TOPARTY <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.PARTY_CODE >= '" + @FROMPARTY + "'"  
     SET @SQL = @SQL + "  AND I.PARTY_CODE <= '" + @TOPARTY + "'"  
    END  
   IF @FROMTERM <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.USER_ID >= '" + @FROMTERM + "'"  
    END  
   IF @TOTERM <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.USER_ID <= '" + @TOTERM + "'"  
    END  
   SET @SQL = @SQL + " GROUP BY"  
   SET @SQL = @SQL + "  I.PARTY_CODE,"  
   SET @SQL = @SQL + "  I.PARTICIPANTCODE,"  
   SET @SQL = @SQL + "  I.USER_ID,"  
   SET @SQL = @SQL + "  I.CONTRACTNO,"  
   SET @SQL = @SQL + "  I.SYMBOL,"
   SET @SQL = @SQL + "	I.INST_TYPE,"
   SET @SQL = @SQL + "	I.EXPIRYDATE,"
   SET @SQL = @SQL + "	I.STRIKE_PRICE,"
   SET @SQL = @SQL + "	I.OPTION_TYPE,"  
 
   SET @SQL = @SQL + "  C1.LONG_NAME,"  
   SET @SQL = @SQL + "  I.SELL_BUY,"  
 
   SET @SQL = @SQL + "  C1.LONG_NAME,"  
   SET @SQL = @SQL + "  I.DUMMY1,"  
   SET @SQL = @SQL + "  R.MARKETRATE,"  
   SET @SQL = @SQL + "  R.BROKERAGE,"  
   SET @SQL = @SQL + "  R.NETRATE,"  
   SET @SQL = @SQL + "  C2.DUMMY6,"  
   SET @SQL = @SQL + "  C1.CL_TYPE "  
   SET @SQL = @SQL + " ORDER BY"  
   SET @SQL = @SQL + "  I.PARTY_CODE,"  
   SET @SQL = @SQL + "  I.SYMBOL,"  
   
   SET @SQL = @SQL + "  I.CONTRACTNO,"  
   SET @SQL = @SQL + "  I.SELL_BUY"  
   PRINT @SQL  
 EXEC(@SQL)  

   SELECT *, SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDADATE, 103), 109) FROM #TRADE_CONSOLIDATION  
 END  

 ELSE IF @CONSOLIDATE = 3  
  BEGIN  
   SET @SQL = "INSERT INTO #TRADE_CONSOLIDATION "  
   SET @SQL = @SQL + "( "  
   SET @SQL = @SQL + " PARTY_CODE, "  
   SET @SQL = @SQL + " ORGPARTY, "  
   SET @SQL = @SQL + " PARTIPANTCODE, "  
   SET @SQL = @SQL + " USER_ID, "  
   SET @SQL = @SQL + " CONTRACTNO, "  
   SET @SQL = @SQL + " SYMBOL, "  
   SET @SQL = @SQL + " INST_TYPE,"
   SET @SQL = @SQL + " EXPIRYDATE,"
   SET @SQL = @SQL + " STRIKE_PRICE,"
   SET @SQL = @SQL + " OPTION_TYPE," 
   SET @SQL = @SQL + " LONG_NAME,"  
  
   SET @SQL = @SQL + " DUMMY1, "  
   SET @SQL = @SQL + " SELL_BUY, "  
   SET @SQL = @SQL + " QTY, "  
   SET @SQL = @SQL + " MKTRATE, "  
   SET @SQL = @SQL + " NETRATE, "  
   SET @SQL = @SQL + " AMOUNT, "  
   SET @SQL = @SQL + " DEALTICKETPRICE, "  
   SET @SQL = @SQL + " NETAMOUNT, "  
   SET @SQL = @SQL + " PARTY_NAME, "  
   SET @SQL = @SQL + " R_MKTRATE, "  
   SET @SQL = @SQL + " R_BROKERAGE, "  
   SET @SQL = @SQL + " R_NETRATE, "  
   SET @SQL = @SQL + " STP_TYPE, "  
   SET @SQL = @SQL + " STP_FLAG, "  
   SET @SQL = @SQL + " CL_TYPE "  
   SET @SQL = @SQL + ") "  
   SET @SQL = @SQL + " SELECT "  
   SET @SQL = @SQL + "  I.PARTY_CODE, "  
   SET @SQL = @SQL + "  ORGPARTY = I.PARTY_CODE, "  
   SET @SQL = @SQL + "  I.PARTICIPANTCODE, "  
   SET @SQL = @SQL + "  I.USER_ID, "  
   SET @SQL = @SQL + "  I.CONTRACTNO, "  
   SET @SQL = @SQL + "  I.SYMBOL, "  
   SET @SQL = @SQL + "	I.INST_TYPE,"
   SET @SQL = @SQL + "	I.EXPIRYDATE,"
   SET @SQL = @SQL + "	I.STRIKE_PRICE,"
   SET @SQL = @SQL + "	I.OPTION_TYPE," 
   SET @SQL = @SQL + "  S.LONG_NAME, "  
   SET @SQL = @SQL + "  I.DUMMY1, "  
   SET @SQL = @SQL + "  SELL_BUY = CASE WHEN I.SELL_BUY = 1 THEN 'BUY' ELSE 'SALE' END, "  
   SET @SQL = @SQL + "  QTY = SUM(I.TRADEQTY), "  
   SET @SQL = @SQL + "  MKTRATE = ((SUM(I.DUMMY2*I.TRADEQTY)) / (SUM(I.TRADEQTY))), "  
   SET @SQL = @SQL + "  NETRATE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
   SET @SQL = @SQL + "	ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "  
   SET @SQL = @SQL + "  AMOUNT = SUM(I.TRADEQTY * I.PRICE), "  
   SET @SQL = @SQL + "  DEALTICKETPRICE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.MARKETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
   SET @SQL = @SQL + "	ELSE ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "  
   SET @SQL = @SQL + "  NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "
   SET @SQL = @SQL + "	ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "  
   SET @SQL = @SQL + "  PARTY_NAME = C1.LONG_NAME, "  
   SET @SQL = @SQL + "  R_MKTRATE = ISNULL(R.MARKETRATE, 4), "  
   SET @SQL = @SQL + "  R_BROKERAGE = ISNULL(R.BROKERAGE, 4), "  
   SET @SQL = @SQL + "  R_NETRATE = ISNULL(R.NETRATE, 4), "  
   SET @SQL = @SQL + "  STP_TYPE = C2.DUMMY6, "  
   SET @SQL = @SQL + "  STP_FLAG = 0,"  
   SET @SQL = @SQL + "  CL_TYPE = C1.CL_TYPE "  
   SET @SQL = @SQL + " FROM"  
   SET @SQL = @SQL + "  FOSETTLEMENT I, "  
   SET @SQL = @SQL + "  CLIENT2 C2"  
   SET @SQL = @SQL + "   LEFT JOIN INSTCLIENT_TBL R"  
   SET @SQL = @SQL + "    ON (C2.PARTY_CODE = R.PARTYCODE),"  
   SET @SQL = @SQL + "  CLIENT1 C1,"  
   SET @SQL = @SQL + "  (SELECT S1.CO_CODE, LONG_NAME = S1.LONG_NAME, S2.BSECODE"  
   SET @SQL = @SQL + "  FROM SCRIP1 S1 INNER JOIN SCRIP2 S2"  
   SET @SQL = @SQL + "  ON S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES"  
   IF @FROMSYMBOL <> '' AND @TOSYMBOL <> ''  
    BEGIN  
     SET @SQL = @SQL + "  WHERE S2.BSECODE >= '" + @FROMSYMBOL + "'"  
     SET @SQL = @SQL + "  AND S2.BSECODE <= '" + @TOSYMBOL + "'"  
    END  
   SET @SQL = @SQL + "  ) S"  
   SET @SQL = @SQL + " WHERE"  
   SET @SQL = @SQL + "  C1.CL_CODE = C2.CL_CODE"  
   SET @SQL = @SQL + "  AND I.SYMBOL = S.BSECODE"  
   --SET @SQL = @SQL + "  AND C1.CL_TYPE = 'INS'"  
   SET @SQL = @SQL + "  AND I.PARTY_CODE = C2.PARTY_CODE"  
   SET @SQL = @SQL + "  AND CONVERT(VARCHAR(10), SAUDA_DATE, 103) = '" + @SAUDADATE + "'"  
   SET @SQL = @SQL + "  AND I.TRADEQTY > 0"  
   IF @SELL_BUY <> 0  
    BEGIN  
     SET @SQL = @SQL + "  AND I.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "  
    END  

   IF @CONTRACTNO <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.CONTRACTNO = '" + @CONTRACTNO + "'"  
    END  
   IF @CONSOLIDATE = 0  
    BEGIN  
     SET @SQL = @SQL + "  AND I.DUMMY1 = 0"  
    END  
   ELSE IF @CONSOLIDATE = 1  
    BEGIN  
     SET @SQL = @SQL + "  AND I.DUMMY1 = 1"  
    END  
   IF @FROMPARTY <> '' AND @TOPARTY = ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.PARTY_CODE = '" + @FROMPARTY + "'"  
    END  
   ELSE IF @FROMPARTY <> '' AND @TOPARTY <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.PARTY_CODE >= '" + @FROMPARTY + "'"  
     SET @SQL = @SQL + "  AND I.PARTY_CODE <= '" + @TOPARTY + "'"  
    END  
   IF @FROMTERM <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.USER_ID >= '" + @FROMTERM + "'"  
    END  
   IF @TOTERM <> ''  
    BEGIN  
     SET @SQL = @SQL + "  AND I.USER_ID <= '" + @TOTERM + "'"  
    END  
   SET @SQL = @SQL + " GROUP BY"  
   SET @SQL = @SQL + "  I.PARTY_CODE,"  
   SET @SQL = @SQL + "  I.PARTICIPANTCODE,"  
   SET @SQL = @SQL + "  I.USER_ID,"  
   SET @SQL = @SQL + "  I.CONTRACTNO,"  
   SET @SQL = @SQL + "  I.SYMBOL,"  
   SET @SQL = @SQL + "	I.INST_TYPE,"
   SET @SQL = @SQL + "	I.EXPIRYDATE,"
   SET @SQL = @SQL + "	I.STRIKE_PRICE,"
   SET @SQL = @SQL + "	I.OPTION_TYPE," 
   SET @SQL = @SQL + "  S.LONG_NAME,"  
   SET @SQL = @SQL + "  I.SELL_BUY,"  
 
   SET @SQL = @SQL + "  C1.LONG_NAME,"  
   SET @SQL = @SQL + "  I.DUMMY1,"  
   SET @SQL = @SQL + "  R.MARKETRATE,"  
   SET @SQL = @SQL + "  R.BROKERAGE,"  
   SET @SQL = @SQL + "  R.NETRATE,"  
   SET @SQL = @SQL + "  C2.DUMMY6,"  
   SET @SQL = @SQL + "  C1.CL_TYPE "  
   SET @SQL = @SQL + " ORDER BY"  
   SET @SQL = @SQL + "  I.PARTY_CODE,"  
   SET @SQL = @SQL + "  I.SYMBOL,"    
   SET @SQL = @SQL + "  I.CONTRACTNO,"  
   SET @SQL = @SQL + "  I.SELL_BUY"  
   EXEC(@SQL)  
 SELECT *, SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDADATE, 103), 109) FROM #TRADE_CONSOLIDATION  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRADE_CONSOLIDATION_PROC
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[TRADE_CONSOLIDATION_PROC]
(
	@SAUDA_DATE VARCHAR(11),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@SYMBOLSTR VARCHAR(8000),--COMBINING- SYMBOL|INSTYPE|EXPIRYDATE|STRIKEPRICE|OPTIONTYPE|DEALPRICE	
	@SELL_BUY INT,
	@ORGCONTRACTNO VARCHAR(7),
	@MARKETRATE NUMERIC(18,4),
	@PARTIPANTCODE VARCHAR(15),
	@TERMINALID VARCHAR(10),
	@BRANCH_ID VARCHAR(10),
	@ORDER_NO VARCHAR(16),
	@LEVEL INT,
	@SPLITDATA VARCHAR(8000),
	@STATUSNAME VARCHAR(50),
	@FROMWHERE VARCHAR(100),
	@XMLDATA VARCHAR(8000),
	@SEL_POS INT,
	@EDITNETRATE INT = 0,
	@CONSOLFLAG SMALLINT = 0,
	@PROCESSON VARCHAR(20) = 'FOSETTLEMENT'
)
AS


/*---------------------------------------------------------------------------
	PROC NAME   : TRADE_CONSOLIDATION_PROC
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CALLING FOR THE TRADE/FOSETTLEMENT AFTER CONTRACT
				  SPLIT AND CONSOLIDATION

EXEC TRADE_CONSOLIDATION_PROC '13/06/2006', '0A141', 'ALWC000001', 'ACC|FUTSTK|29/06/2006|0| |698.7|750','1', '0000066', 698.7, '', '', '', '', 2, '', 'ASHOOKE/BROKER', 'FC.CONSOLIDATION .NET MODULE(/FC.INTERFACE/TRANDETAILS.ASPX)', '0A141,ALWC000001,750,698.7,699,1,|', '0', 0, 1 
EXEC PROC_TRADE_TRANSFER_ISETL 'JUN 13 2006', '0A141' , 'ALWC000001' , 'FUTSTK' , 'ACC' , 'JUN 29 2006' , 0.00 , '' , '1' , '' , '0000066' , '%' , '%', 750 , 750
------------------------------------------------------------------------------*/

	SET NOCOUNT OFF
	DECLARE
		@CHK_POS INT,
		@CHK_DATA VARCHAR(50),
		@XMLRECORD VARCHAR(100),
		@TOTALQTY INT,
		@ROWCOUNT INT,
		@STARTROW INT,
		@OUTER CURSOR,
		@INNER CURSOR,
		@CONT CURSOR,
		@CONT_PARTY VARCHAR(10),
		@CONT_SNO INT,
		@CONT_CLTYPE VARCHAR(3),
		@NEWCONTNO VARCHAR(7),
		@FPARTY VARCHAR(10),
		@TPARTY VARCHAR(10),
		@TRFQTY INT,
		@MKTRATE NUMERIC(18,4),
		@NETRATE NUMERIC(18,4),
		@F1 VARCHAR(50),
		@F2 VARCHAR(50),
		@QTY INT,
		@ORGQTY INT,
		@TQTY INT,
		@LQTY INT,
		@OUTERVAL VARCHAR(50),
		@SQL VARCHAR(2000),
		@BRKSQL VARCHAR(2000),
		@STTSQL VARCHAR(2000),
		@C1_STATUS INT,
		@C2_STATUS INT,
		@INNER_SPLIT VARCHAR(100),
		@SYMBOL VARCHAR(20),
		@INST_TYPE	VARCHAR(6) ,
		@EXPIRY_DATE VARCHAR(11),
		@STRIKE_PRICE MONEY,  
		@OPTION_TYPE VARCHAR(2) ,
		@DEALRATE NUMERIC(18,2),
		@TRADE_NO	VARCHAR(14),
		@ACTUALQTY	INT, 
		@BROK NUMERIC(18,8),
		@VAL_PERC VARCHAR(1),
		@FLAG INT,
		@CALCBROK VARCHAR(8000),
		@SQLC VARCHAR(8000)	,
		@SAUDA_DATE_11 VARCHAR(11),
		@EXPIRY_DATE_11 VARCHAR(11),
		@@FROMPARTY VARCHAR(10),
		@@TOPARTY VARCHAR(10),
		@@ORGQTY INT,
		@@TRFQTY INT,
		@@MKTRATE NUMERIC(18,4),
		@@NETRATE NUMERIC(18,4),
		@@CONTRACTNO VARCHAR(7),
		@@ORDER_NO VARCHAR(16),
		@@TRADE_NO VARCHAR(14),
		@CONSPARAM VARCHAR(8000)

	SET @CHK_POS = 1
	SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 1)))
	SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 2)))
	SET @EXPIRY_DATE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 3)))
	SET @STRIKE_PRICE = CONVERT(MONEY,LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 4))))
	SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 5)))
	SET @DEALRATE = CONVERT(NUMERIC(18, 2),LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 6))))
	SET @ACTUALQTY = CONVERT(INT,LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 7))))
	SET @TRADE_NO = ''
	SET @BROK = 0
	SET @VAL_PERC = ''
	SET @FLAG = 1

IF LEN(LTRIM(RTRIM(@XMLDATA))) > 0
	BEGIN
		CREATE TABLE #XMLDATA
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			GENCONT TINYINT,
			CONTRACTNO VARCHAR(7),
			SNO INT IDENTITY(1,1)
		)
		CREATE TABLE #XMLDATA_ARR
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			GENCONT TINYINT,
			CONTRACTNO VARCHAR(7),
			SNO INT IDENTITY(1,1)
		)
		WHILE 1 = 1
			BEGIN
				SET @XMLRECORD = .DBO.PIECE(@XMLDATA, '|', @CHK_POS)
				IF @XMLRECORD IS NOT NULL AND @XMLRECORD <> ''
					BEGIN
						INSERT INTO #XMLDATA (FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT)
						VALUES (.DBO.PIECE(@XMLRECORD, ',', 1), .DBO.PIECE(@XMLRECORD, ',', 2), .DBO.PIECE(@XMLRECORD, ',', 3), .DBO.PIECE(@XMLRECORD, ',', 4), .DBO.PIECE(@XMLRECORD, ',', 5), .DBO.PIECE(@XMLRECORD, ',', 6))
						SET @CHK_POS = @CHK_POS + 1
					END
				ELSE
					BEGIN
						BREAK
					END
			END
			SET @CONT = CURSOR FOR
				SELECT SNO, TOPARTY FROM #XMLDATA WHERE GENCONT = 1
			OPEN @CONT
			FETCH NEXT FROM @CONT INTO @CONT_SNO, @CONT_PARTY
			WHILE @@FETCH_STATUS = 0
				BEGIN
					SELECT
						@CONT_CLTYPE = CL_TYPE
					FROM
						CLIENT1 C1,
						CLIENT2 C2
					WHERE
						C1.CL_CODE = C2.CL_CODE
						AND C2.PARTY_CODE = @CONT_PARTY
					IF @CONT_CLTYPE = 'PRO'
						BEGIN
							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = '0000000'
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO = @CONT_SNO
							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = '0000000'
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO <> @CONT_SNO
								AND GENCONT = 0
						END
					ELSE
						BEGIN
							SELECT
								@NEWCONTNO = CONVERT(VARCHAR(7), CONVERT(NUMERIC, CONTRACTNO) + 1)
							FROM
								CONTGEN
							WHERE
								CONVERT(DATETIME, @SAUDA_DATE, 103) BETWEEN START_DATE AND END_DATE

							UPDATE
								CONTGEN WITH (ROWLOCK)
							SET
								CONTRACTNO = @NEWCONTNO
							WHERE
								CONVERT(DATETIME, @SAUDA_DATE, 103) BETWEEN START_DATE AND END_DATE

							SELECT
								@NEWCONTNO = STUFF('0000000', 8 - LEN(@NEWCONTNO), LEN(@NEWCONTNO), @NEWCONTNO)

							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = @NEWCONTNO
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO = @CONT_SNO

							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = @NEWCONTNO
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO <> @CONT_SNO
								AND GENCONT = 0
								AND FROMPARTY = TOPARTY
						END
					FETCH NEXT FROM @CONT INTO @CONT_SNO, @CONT_PARTY
				END
			UPDATE
				#XMLDATA
			SET
				CONTRACTNO = ''
			WHERE
				CONTRACTNO IS NULL
			INSERT INTO #XMLDATA_ARR
				(FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO)
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO FROM #XMLDATA WHERE FROMPARTY = TOPARTY ORDER BY SNO
			INSERT INTO #XMLDATA_ARR
				(FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO)
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO FROM #XMLDATA WHERE FROMPARTY <> TOPARTY ORDER BY SNO

			TRUNCATE TABLE #XMLDATA
			INSERT INTO #XMLDATA (FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO) SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO FROM #XMLDATA_ARR ORDER BY SNO
			DROP TABLE #XMLDATA_ARR

					UPDATE
						#XMLDATA
					SET
						CONTRACTNO =(	SELECT
											ISNULL(MIN(CONTRACTNO), '')
										FROM
											FOSETTLEMENT I
										WHERE
											I.PARTY_CODE = #XMLDATA.TOPARTY
											AND I.SAUDA_DATE	BETWEEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
											AND CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109) + ' 23:59:59'
											AND I.SYMBOL = @SYMBOL
											AND I.INST_TYPE = @INST_TYPE
											AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
											AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
											AND I.OPTION_TYPE =	@OPTION_TYPE
											AND I.SELL_BUY = @SELL_BUY
											AND I.DUMMY1 = 0
											AND I.TRADEQTY > 0
									)
					WHERE
						GENCONT = 0
						AND (CONTRACTNO = '' OR CONTRACTNO IS NULL)

				UPDATE
					#XMLDATA
				SET
					GENCONT = 1
				WHERE
					GENCONT = 0
					AND (CONTRACTNO = '' OR CONTRACTNO IS NULL)
	END
ELSE
	BEGIN
		SELECT 'NO RECORDS TO SPLIT'
		RETURN
	END
SELECT @TOTALQTY = SUM(TRFQTY) FROM #XMLDATA
SET @CHK_POS = 1
IF @SEL_POS > 0
	BEGIN
		CREATE TABLE #SELECTED (F1 VARCHAR(50), F2 VARCHAR(50), AVAILQTY INT)
		WHILE @CHK_POS <= @SEL_POS
			BEGIN
				SET @INNER_SPLIT = .DBO.PIECE(@SPLITDATA, '#', @CHK_POS)
				INSERT INTO #SELECTED SELECT .DBO.PIECE(@INNER_SPLIT, ',', 1), .DBO.PIECE(@INNER_SPLIT, ',', 2), 0
				SET @CHK_POS = @CHK_POS + 1
			END
		CREATE TABLE #SELECTED_A (F1 VARCHAR(50), F2 VARCHAR(50), QTY INT, ORGQTY INT)
		IF @LEVEL = 2
			BEGIN
				INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
				SELECT I.CONTRACTNO, '%', SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
				WHERE
					I.CONTRACTNO = S.F1
					AND I.PARTY_CODE = @FROMPARTY
					AND I.SYMBOL = @SYMBOL
					AND I.INST_TYPE = @INST_TYPE
					AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
					AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
					AND I.OPTION_TYPE =	@OPTION_TYPE
					AND I.SELL_BUY = @SELL_BUY
				GROUP BY
					I.CONTRACTNO
			END
		ELSE IF @LEVEL = 3
			BEGIN
				INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
				SELECT I.ORDER_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
				WHERE
					I.ORDER_NO = S.F1
					AND I.BRANCH_ID = S.F2
					AND I.PARTY_CODE = @FROMPARTY
					AND I.SYMBOL = @SYMBOL
					AND I.INST_TYPE = @INST_TYPE
					AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
					AND I.STRIKE_PRICE = @STRIKE_PRICE
					AND I.OPTION_TYPE =	@OPTION_TYPE
					AND I.CONTRACTNO = @ORGCONTRACTNO
					AND I.SELL_BUY = @SELL_BUY
				GROUP BY
					I.ORDER_NO,
					I.BRANCH_ID
			END
		ELSE IF @LEVEL = 102			-- FOR ORDER NOS. BUT TRADE TRANSFER
			BEGIN
						INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
						SELECT I.ORDER_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
						WHERE
							I.ORDER_NO = S.F1
							AND I.BRANCH_ID = S.F2
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.SELL_BUY = @SELL_BUY
						GROUP BY
							I.ORDER_NO,
							I.BRANCH_ID

			END
		ELSE IF @LEVEL = 4			-- FOR TRADE NOS
			BEGIN
				IF @ORDER_NO = ''
					BEGIN
						INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
						SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.BRANCH_ID = S.F2
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND I.STRIKE_PRICE = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.CONTRACTNO = @ORGCONTRACTNO
							AND I.SELL_BUY = @SELL_BUY
						GROUP BY
							I.TRADE_NO,
							I.BRANCH_ID
					END
				ELSE
					BEGIN
						INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
						SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.BRANCH_ID = S.F2
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND I.STRIKE_PRICE = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.CONTRACTNO = @ORGCONTRACTNO
							AND I.SELL_BUY = @SELL_BUY
							AND I.ORDER_NO = @ORDER_NO
						GROUP BY
							I.TRADE_NO,
							I.BRANCH_ID
					END
			END
		ELSE IF @LEVEL = 103			-- FOR TRADE NOS BUT TRADE TRANSFER
			BEGIN
						IF @ORDER_NO = ''
							BEGIN
								INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
								SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
								WHERE
									I.TRADE_NO = S.F1
									AND I.BRANCH_ID = S.F2
									AND I.PARTY_CODE = @FROMPARTY
									AND I.SYMBOL = @SYMBOL
									AND I.INST_TYPE = @INST_TYPE
									AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
									AND I.STRIKE_PRICE = @STRIKE_PRICE
									AND I.OPTION_TYPE =	@OPTION_TYPE
									AND I.SELL_BUY = @SELL_BUY
								GROUP BY
									I.TRADE_NO,
									I.BRANCH_ID
							END
						ELSE
							BEGIN
								INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
								SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
								WHERE
									I.TRADE_NO = S.F1
									AND I.BRANCH_ID = S.F2
									AND I.PARTY_CODE = @FROMPARTY
									AND I.SYMBOL = @SYMBOL
									AND I.INST_TYPE = @INST_TYPE
									AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
									AND I.STRIKE_PRICE = @STRIKE_PRICE
									AND I.OPTION_TYPE =	@OPTION_TYPE
									AND I.SELL_BUY = @SELL_BUY
									AND I.ORDER_NO = @ORDER_NO
								GROUP BY
									I.TRADE_NO,
									I.BRANCH_ID
							END

			END


		SELECT @ROWCOUNT = COUNT(1) FROM #SELECTED_A
		SET @STARTROW = 1
		SET @OUTER = CURSOR FOR
			SELECT F1, F2, QTY FROM #SELECTED_A
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY
		WHILE @STARTROW <= @ROWCOUNT
			BEGIN
				IF @TOTALQTY < @QTY
					BEGIN
						UPDATE #SELECTED_A SET QTY = @TOTALQTY WHERE F1 = @F1 AND F2 = @F2
						BREAK
					END
				ELSE
					BEGIN
						SET @TOTALQTY = @TOTALQTY - @QTY
					END
				FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY
				SET @STARTROW = @STARTROW + 1
			END
		CLOSE @OUTER
		CREATE TABLE #DISTRIBUTED
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			ORGQTY INT,
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			CONTRACTNO VARCHAR(7),
			ORDER_NO VARCHAR(16),
			TRADE_NO VARCHAR(14),
			BRANCH_ID VARCHAR(10),
			NEWCONTRACTNO VARCHAR(7)
		)


		SET @OUTER = CURSOR FOR
			SELECT F1, F2, QTY, ORGQTY FROM #SELECTED_A
		SET @INNER = CURSOR FOR
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, ISNULL(CONTRACTNO, '') FROM #XMLDATA
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY, @ORGQTY
		SET @C1_STATUS = @@FETCH_STATUS

		OPEN @INNER
		FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE, @NETRATE, @NEWCONTNO
		SET @C2_STATUS = @@FETCH_STATUS

		SET @LQTY = @QTY
		WHILE @C1_STATUS = 0 AND @C2_STATUS = 0
			BEGIN
				IF @LQTY > @TRFQTY
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @F1, '%', '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						SET @LQTY = @LQTY - @TRFQTY
						FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE, @NETRATE, @NEWCONTNO
						SET @C2_STATUS = @@FETCH_STATUS
					END
				ELSE IF @LQTY < @TRFQTY AND @LQTY > 0
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @F1, '%', '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						SET @TRFQTY = @TRFQTY - @LQTY
						FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY, @ORGQTY
						SET @C1_STATUS = @@FETCH_STATUS
						SET @LQTY = @QTY
					END
				ELSE IF @LQTY = @TRFQTY
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @F1, '%', '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY, @ORGQTY
						SET @C1_STATUS = @@FETCH_STATUS
						SET @LQTY = @QTY
						
						FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE, @NETRATE, @NEWCONTNO
						SET @C2_STATUS = @@FETCH_STATUS
					END
			END
		CLOSE @OUTER
		CLOSE @INNER

		PRINT 'CAME'
		DEALLOCATE @INNER
		SET @OUTER = CURSOR FOR
			SELECT LTRIM(RTRIM(FROMPARTY)), LTRIM(RTRIM(TOPARTY)), ORGQTY, TRFQTY, MKTRATE, NETRATE, LTRIM(RTRIM(CONTRACTNO)), LTRIM(RTRIM(ORDER_NO)), LTRIM(RTRIM(TRADE_NO)), LTRIM(RTRIM(BRANCH_ID)), LTRIM(RTRIM(NEWCONTRACTNO)) FROM #DISTRIBUTED
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @@FROMPARTY, @@TOPARTY, @@ORGQTY, @@TRFQTY, @@MKTRATE, @@NETRATE, @@CONTRACTNO, @@ORDER_NO, @@TRADE_NO, @BRANCH_ID, @NEWCONTNO
		
		WHILE @@FETCH_STATUS = 0
			BEGIN
				
				IF @ORDER_NO='' BEGIN SET @ORDER_NO ='%'END
				IF @TRADE_NO ='' BEGIN SET @TRADE_NO = '%' END 		
		
				SELECT @SAUDA_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
				SELECT @EXPIRY_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 109)

				IF @LEVEL = 101 OR @LEVEL = 102 OR @LEVEL = 103
					BEGIN						

						EXEC V2_PROC_TRADE_TRANSFER_ISETL @SAUDA_DATE_11 , @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @ORDER_NO , @TRADE_NO ,  @ACTUALQTY , @@TRFQTY
						
						EXEC V2_PROC_TRADE_TRANSFER_RECAL  @SAUDA_DATE_11 , @FROMPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE,'',''

						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 

					END
				ELSE
					BEGIN

						EXEC V2_PROC_TRADE_TRANSFER_ISETL  @SAUDA_DATE_11, @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @ORDER_NO , @TRADE_NO ,  @ACTUALQTY , @@TRFQTY
						--SET @CONSPARAM = ','+ @@CONTRACTNO + ',' +  @FPARTY + ','+ @SYMBOL + ','+ @OPTION_TYPE + ','+ @SAUDA_DATE_11 + ','+ CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 103) + ','+ @INST_TYPE + ',0,' + CONVERT(VARCHAR,@LEVEL) + ','+ CONVERT(VARCHAR,@SELL_BUY) + ','+ CONVERT(VARCHAR,@DEALRATE) + ','+ CONVERT(VARCHAR,@MARKETRATE) + ',0,'+ CONVERT(VARCHAR,@STRIKE_PRICE) + ','+ @PARTIPANTCODE 
						SET @CONSPARAM = ','+ @@CONTRACTNO + ',' +  @FPARTY + ',,'+ @SYMBOL + ','+ @INST_TYPE + ','+ CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 103) + ','+ CONVERT(VARCHAR,@STRIKE_PRICE) + ','+ @OPTION_TYPE + ','+ @SAUDA_DATE_11 + ',0,' + CONVERT(VARCHAR,@LEVEL) + ','+ CONVERT(VARCHAR,@SELL_BUY) + ','+ CONVERT(VARCHAR,@MARKETRATE) + ','+ CONVERT(VARCHAR,@DEALRATE) + ','+ .DBO.PIECE(@XMLRECORD, ',', 5) +','+ @PARTIPANTCODE
						
						EXEC CONSOLIDATETRANS  @CONSPARAM ,'Y', @STATUSNAME ,@FROMWHERE

						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 					
					END
			
				FETCH NEXT FROM @OUTER INTO @@FROMPARTY, @@TOPARTY, @@ORGQTY, @@TRFQTY, @@MKTRATE, @@NETRATE, @@CONTRACTNO, @@ORDER_NO, @@TRADE_NO, @BRANCH_ID, @NEWCONTNO
			END
	END
ELSE
	BEGIN
		CREATE TABLE #XMLDATA_A
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			CONTRACTNO VARCHAR(7),
			NEWCONTRACT VARCHAR(7)
		)
		INSERT INTO #XMLDATA_A (FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, NEWCONTRACT)
		SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, @ORGCONTRACTNO, CONTRACTNO FROM #XMLDATA
		DECLARE
			@@XMLCURSOR CURSOR,
			@@MKRATE NUMERIC(18, 4),
			@@NTRATE NUMERIC(18, 4)
		SET @@XMLCURSOR = CURSOR FOR
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ISNULL(NEWCONTRACT, '') FROM #XMLDATA_A
		OPEN @@XMLCURSOR
		FETCH NEXT FROM @@XMLCURSOR INTO @FPARTY, @TPARTY, @TRFQTY, @@MKRATE, @@NTRATE, @@CONTRACTNO, @NEWCONTNO
		WHILE @@FETCH_STATUS = 0
			BEGIN
				IF @ORDER_NO='' BEGIN SET @ORDER_NO ='%'END
				IF @TRADE_NO ='' BEGIN SET @TRADE_NO = '%' END 
				SELECT @SAUDA_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
				SELECT @EXPIRY_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 109)

				IF @LEVEL = 101 OR @LEVEL = 102 OR @LEVEL = 103
					BEGIN

						EXEC V2_PROC_TRADE_TRANSFER_ISETL  @SAUDA_DATE_11, @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @ORDER_NO , @TRADE_NO ,  @ACTUALQTY , @@TRFQTY						
						
						EXEC V2_PROC_TRADE_TRANSFER_RECAL  @SAUDA_DATE_11 , @FROMPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE,'',''
						
						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 
						
					END
				ELSE
					BEGIN
						--PRINT 'CAME'
						--SELECT @SAUDA_DATE_11, @FPARTY, @TPARTY, @INST_TYPE, @SYMBOL, @EXPIRY_DATE_11, @STRIKE_PRICE, @OPTION_TYPE, @SELL_BUY, @PARTIPANTCODE, @@CONTRACTNO, @ORDER_NO, @TRADE_NO, @ACTUALQTY, @TRFQTY
						EXEC V2_PROC_TRADE_TRANSFER_ISETL @SAUDA_DATE_11, @FPARTY, @TPARTY, @INST_TYPE, @SYMBOL, @EXPIRY_DATE_11, @STRIKE_PRICE, @OPTION_TYPE, @SELL_BUY, @PARTIPANTCODE, @@CONTRACTNO, @ORDER_NO, @TRADE_NO, @ACTUALQTY, @TRFQTY
						--SELECT @@CONTRACTNO, @FPARTY ,@SYMBOL , @INST_TYPE , CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 103) , CONVERT(VARCHAR,@STRIKE_PRICE) , @OPTION_TYPE , @SAUDA_DATE_11 ,0,CONVERT(VARCHAR,@LEVEL) , CONVERT(VARCHAR,@SELL_BUY) , CONVERT(VARCHAR,@MARKETRATE) , CONVERT(VARCHAR,@DEALRATE) ,.DBO.PIECE(@XMLRECORD, ',', 5) , @PARTIPANTCODE
						SET @CONSPARAM = ','+ @@CONTRACTNO + ',' +  @FPARTY + ',,'+ @SYMBOL + ','+ @INST_TYPE + ','+ CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 103) + ','+ CONVERT(VARCHAR,@STRIKE_PRICE) + ','+ @OPTION_TYPE + ','+ @SAUDA_DATE_11 + ',0,' + CONVERT(VARCHAR,@LEVEL) + ','+ CONVERT(VARCHAR,@SELL_BUY) + ','+ CONVERT(VARCHAR,@MARKETRATE) + ','+ CONVERT(VARCHAR,@DEALRATE) + ','+ ISNULL(.DBO.PIECE(@XMLRECORD, ',', 5),CONVERT(VARCHAR,@DEALRATE)) +','+ @PARTIPANTCODE
						--SELECT @CONSPARAM
						EXEC CONSOLIDATETRANS  @CONSPARAM ,'Y', @STATUSNAME ,@FROMWHERE
					
						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 
					END
				
				FETCH NEXT FROM @@XMLCURSOR INTO @FPARTY, @TPARTY, @TRFQTY, @@MKRATE, @@NTRATE, @@CONTRACTNO, @NEWCONTNO
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRADE_CONSOLIDATION_PROC_TRADE
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[TRADE_CONSOLIDATION_PROC_TRADE]
	@SAUDA_DATE VARCHAR(10),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@SYMBOLSTR VARCHAR(8000),--COMBINING- SYMBOL|INSTYPE|EXPIRYDATE|STRIKEPRICE|OPTIONTYPE|DEALPRICE	
	@SELL_BUY INT,
	@MARKETRATE NUMERIC(18,4),
	@PARTIPANTCODE VARCHAR(15),
	@TERMINALID VARCHAR(10),
	@BRANCH_ID VARCHAR(10),
	@ORDER_NO VARCHAR(16),
	@LEVEL INT,
	@SPLITDATA VARCHAR(500),
	@STATUSNAME VARCHAR(50),
	@FROMWHERE VARCHAR(100),
	@XMLDATA VARCHAR(2000),
	@SEL_POS INT,
	@INSTFLAG INT = 0

AS

/*---------------------------------------------------------------------------
	EXEC TRADE_CONSOLIDATION_PROC_TRADE '01/09/2005', 'B00034460', 'C000000001', 'NAGARFERT|FUTSTK|29/09/2005|0| |0|14000','2', 17.5, '', '', '', '', 102, '', 'HEMANTT/BROKER', 'FC.CONSOLIDATION .NET MODULE(/FC.INTERFACE/TRANDETAILS.ASPX)', 'C000000001,B00034460,10000,17.5,|', '0', 0 
	PROC NAME   : TRADE_CONSOLIDATION_PROC
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CALLING FOR THE TRADE/FOSETTLEMENT BEFORE CONTRACT
				  SPLIT AND CONSOLIDATION
------------------------------------------------------------------------------*/
/*
	EXEC TRADE_CONSOLIDATION_PROC_TRADE '01/09/2005', 'B00034559', 'C00031958', 'NAGARFERT|FUTSTK|29/09/2005|0| |0|14000','1', 17.75, '', '', '', '', 102, '', 'HEMANTT/BROKER', 'FC.CONSOLIDATION .NET MODULE(/FC.INTERFACE/TRANDETAILS.ASPX)', 'B00034559,C00031958,14000,17.75,|', '0', 0 
	PROC_TRADE_TRANSFER_TRADE 'SEP  1 2005','B00034559','C00031958','FUTSTK','NAGARFERT','SEP 29 2005','0.00','%','1','%','%','%','14000','14000','HEMANTT/BROKER','FC.CONSOLIDATION .NET MODULE(/FC.INTERFACE/TRANDETAILS.ASPX)','0'

*/
	SET NOCOUNT OFF
	DECLARE
		@CHK_POS INT,
		@CHK_DATA VARCHAR(50),
		@XMLRECORD VARCHAR(100),
		@TOTALQTY INT,
		@ROWCOUNT INT,
		@STARTROW INT,
		@OUTER CURSOR,
		@INNER CURSOR,
		@CONT CURSOR,
		@CONT_PARTY VARCHAR(10),
		@CONT_SNO INT,
		@CONT_CLTYPE VARCHAR(3),
		@NEWCONTNO VARCHAR(7),
		@FPARTY VARCHAR(10),
		@TPARTY VARCHAR(10),
		@TRFQTY INT,
		@MKTRATE NUMERIC(18,4),
		@NETRATE NUMERIC(18,4),
		@F1 VARCHAR(50),
		@QTY INT,
		@ORGQTY INT,
		@TQTY INT,
		@LQTY INT,
		@OUTERVAL VARCHAR(50),
		@SQL VARCHAR(2000),
		@C1_STATUS INT,
		@C2_STATUS INT,		
		@SYMBOL VARCHAR(20),
		@INST_TYPE	VARCHAR(6) ,
		@EXPIRY_DATE VARCHAR(11),
		@STRIKE_PRICE MONEY,
		@OPTION_TYPE VARCHAR(2) ,
		@DEALRATE NUMERIC(18,2),
		@TRADE_NO	VARCHAR(14),
		@ACTUALQTY	INT, 
		@BROK NUMERIC(18,8),
		@VAL_PERC VARCHAR(1),
		@FLAG INT,
		@@FROMPARTY VARCHAR(10),
		@@TOPARTY VARCHAR(10),
		@@ORGQTY INT,
		@@TRFQTY INT,
		@@MKTRATE NUMERIC(18,4),
		@@NETRATE NUMERIC(18,4),
		@@CONTRACTNO VARCHAR(7),
		@@ORDER_NO VARCHAR(16),
		@@TRADE_NO VARCHAR(14),
		@SAUDA_DATE_11  VARCHAR(14),
		@EXPIRY_DATE_11  VARCHAR(14)

		SET @CHK_POS = 1
		SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 1)))
		SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 2)))
		SET @EXPIRY_DATE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 3)))
		SET @STRIKE_PRICE = CONVERT(MONEY,LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 4))))
		SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 5)))
		SET @DEALRATE = CONVERT(NUMERIC(18, 2),LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 6))))
		SET @ACTUALQTY = CONVERT(INT,LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 7))))
		SET @TRADE_NO = ''
		SET @BROK = 0
		SET @VAL_PERC = ''
		SET @FLAG = 1

IF LEN(LTRIM(RTRIM(@XMLDATA))) > 0
	BEGIN
		CREATE TABLE #XMLDATA
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			SNO INT IDENTITY(1,1)
		)
		CREATE TABLE #XMLDATA_ARR
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			SNO INT IDENTITY(1,1)
		)
		WHILE 1 = 1
			BEGIN
				SET @XMLRECORD = .DBO.PIECE(@XMLDATA, '|', @CHK_POS)
				IF @XMLRECORD IS NOT NULL AND @XMLRECORD <> ''
					BEGIN
						INSERT INTO #XMLDATA (FROMPARTY, TOPARTY, TRFQTY, MKTRATE)
						VALUES (LTRIM(RTRIM(.DBO.PIECE(@XMLRECORD, ',', 1))), LTRIM(RTRIM(.DBO.PIECE(@XMLRECORD, ',', 2))), LTRIM(RTRIM(.DBO.PIECE(@XMLRECORD, ',', 3))), LTRIM(RTRIM(.DBO.PIECE(@XMLRECORD, ',', 4))))
						SET @CHK_POS = @CHK_POS + 1
					END
				ELSE
					BEGIN
						BREAK
					END
			END
	END
ELSE
	BEGIN
		SELECT 'NO RECORDS TO SPLIT'
		RETURN
	END
SELECT @TOTALQTY = SUM(TRFQTY) FROM #XMLDATA
SET @CHK_POS = 1

IF @SEL_POS > 0
	BEGIN
		CREATE TABLE #SELECTED (F1 VARCHAR(50), AVAILQTY INT)
		WHILE @CHK_POS <= @SEL_POS
			BEGIN
				INSERT INTO #SELECTED SELECT .DBO.PIECE(@SPLITDATA, '#', @CHK_POS), 0
				SET @CHK_POS = @CHK_POS + 1
			END
		CREATE TABLE #SELECTED_A (F1 VARCHAR(50), QTY INT, ORGQTY INT)
		IF @LEVEL = 3			-- FOR ORDER NOS.
			BEGIN
				PRINT 'ORDER'
				INSERT INTO #SELECTED_A (F1, QTY, ORGQTY)
				SELECT I.ORDER_NO, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOTRADE I, #SELECTED S
				WHERE
					I.ORDER_NO = S.F1
					AND I.PARTY_CODE = @FROMPARTY
					AND I.SYMBOL = @SYMBOL
					AND I.INST_TYPE = @INST_TYPE
					AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
					AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
					AND I.OPTION_TYPE =	@OPTION_TYPE
					AND I.SELL_BUY = @SELL_BUY
				GROUP BY
					I.ORDER_NO
			END
		ELSE IF @LEVEL = 102			-- FOR ORDER NOS BUT TRADE TRANSFER.
			BEGIN
				PRINT 'ORDER'
				INSERT INTO #SELECTED_A (F1, QTY, ORGQTY)
				SELECT I.ORDER_NO, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOTRADE I, #SELECTED S
				WHERE
					I.ORDER_NO = S.F1
					AND I.PARTY_CODE = @FROMPARTY
					AND I.SYMBOL = @SYMBOL
					AND I.INST_TYPE = @INST_TYPE
					AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
					AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
					AND I.OPTION_TYPE =	@OPTION_TYPE
					AND I.SELL_BUY = @SELL_BUY
				GROUP BY
					I.ORDER_NO
			END

		ELSE IF @LEVEL = 4			-- FOR TRADE NOS
			BEGIN
				PRINT 'FOTRADES'
				IF @ORDER_NO = ''
					BEGIN
						INSERT INTO #SELECTED_A (F1, QTY, ORGQTY)
						SELECT I.TRADE_NO, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOTRADE I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.SELL_BUY = @SELL_BUY
						GROUP BY
							I.TRADE_NO
					END
				ELSE
					BEGIN
						INSERT INTO #SELECTED_A (F1, QTY, ORGQTY)
						SELECT I.TRADE_NO, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOTRADE I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.SELL_BUY = @SELL_BUY
							AND I.ORDER_NO = @ORDER_NO
						GROUP BY
							I.TRADE_NO
					END
			END
		ELSE IF @LEVEL = 103			-- FOR TRADE NOS BUT TRADE TRANSFER
			BEGIN
				PRINT 'FOTRADES'
				IF @ORDER_NO = ''
					BEGIN
						INSERT INTO #SELECTED_A (F1, QTY, ORGQTY)
						SELECT I.TRADE_NO, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOTRADE I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.SELL_BUY = @SELL_BUY
						GROUP BY
							I.TRADE_NO
					END
				ELSE
					BEGIN
						INSERT INTO #SELECTED_A (F1, QTY, ORGQTY)
						SELECT I.TRADE_NO, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOTRADE I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.SELL_BUY = @SELL_BUY
							AND I.ORDER_NO = @ORDER_NO
						GROUP BY
							I.TRADE_NO
					END
			END
		SELECT @ROWCOUNT = COUNT(1) FROM #SELECTED_A
		SET @STARTROW = 1
		SET @OUTER = CURSOR FOR
			SELECT F1, QTY FROM #SELECTED_A
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @F1, @QTY
		WHILE @STARTROW <= @ROWCOUNT
			BEGIN
				IF @TOTALQTY < @QTY
					BEGIN
						UPDATE #SELECTED_A SET QTY = @TOTALQTY WHERE F1 = @F1
						BREAK
					END
				ELSE
					BEGIN
						SET @TOTALQTY = @TOTALQTY - @QTY
					END
				FETCH NEXT FROM @OUTER INTO @F1, @QTY
				SET @STARTROW = @STARTROW + 1
			END
		CLOSE @OUTER
		--SELECT * FROM #SELECTED_A
		CREATE TABLE #DISTRIBUTED
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			ORGQTY INT,
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			ORDER_NO VARCHAR(16),
			TRADE_NO VARCHAR(14)
		)
		SET @OUTER = CURSOR FOR
			SELECT F1, QTY, ORGQTY FROM #SELECTED_A
		SET @INNER = CURSOR FOR
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE FROM #XMLDATA
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @F1, @QTY, @ORGQTY
		SET @C1_STATUS = @@FETCH_STATUS

		OPEN @INNER
		FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE
		SET @C2_STATUS = @@FETCH_STATUS

		SET @LQTY = @QTY
		WHILE @C1_STATUS = 0 AND @C2_STATUS = 0
			BEGIN
				IF @LQTY > @TRFQTY
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, '%', '%'
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @F1, '%'
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @F1, '%'
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, '%', @F1
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @ORDER_NO, @F1
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, '%', @F1
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @ORDER_NO, @F1
								END
						SET @LQTY = @LQTY - @TRFQTY
						FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE
						SET @C2_STATUS = @@FETCH_STATUS
					END
				ELSE IF @LQTY < @TRFQTY AND @LQTY > 0
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, '%', '%'
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @F1, '%'
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @F1, '%'
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, '%', @F1
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @ORDER_NO, @F1
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, '%', @F1
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @ORDER_NO, @F1
								END
						SET @TRFQTY = @TRFQTY - @LQTY
						FETCH NEXT FROM @OUTER INTO @F1, @QTY, @ORGQTY
						SET @C1_STATUS = @@FETCH_STATUS
						SET @LQTY = @QTY
					END
				ELSE IF @LQTY = @TRFQTY
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, '%', '%'
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @F1, '%'
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @F1, '%'
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, '%', @F1
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @ORDER_NO, @F1
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, '%', @F1
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, ORDER_NO, TRADE_NO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @ORDER_NO, @F1
								END
						FETCH NEXT FROM @OUTER INTO @F1, @QTY, @ORGQTY
						SET @C1_STATUS = @@FETCH_STATUS
						SET @LQTY = @QTY
						
						FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE
						SET @C2_STATUS = @@FETCH_STATUS
					END
			END
		--SELECT * FROM #DISTRIBUTED
		--RETURN
		CLOSE @OUTER
		CLOSE @INNER
		DEALLOCATE @INNER
		SET @OUTER = CURSOR FOR
			SELECT LTRIM(RTRIM(FROMPARTY)), LTRIM(RTRIM(TOPARTY)), ORGQTY, TRFQTY, MKTRATE, LTRIM(RTRIM(ORDER_NO)), LTRIM(RTRIM(TRADE_NO)) FROM #DISTRIBUTED
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @@FROMPARTY, @@TOPARTY, @@ORGQTY, @@TRFQTY, @@MKTRATE, @@ORDER_NO, @@TRADE_NO
		WHILE @@FETCH_STATUS = 0
			BEGIN

				SELECT @SAUDA_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
				SELECT @EXPIRY_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 109)

				EXEC PROC_TRADE_TRANSFER_TRADE @SAUDA_DATE_11,@FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY, @PARTIPANTCODE , @@ORDER_NO , @@TRADE_NO , @ACTUALQTY , @@TRFQTY ,@STATUSNAME , @FROMWHERE

				FETCH NEXT FROM @OUTER INTO @@FROMPARTY, @@TOPARTY, @@ORGQTY, @@TRFQTY, @@MKTRATE, @@ORDER_NO, @@TRADE_NO
			END
	END
ELSE
	BEGIN
		CREATE TABLE #XMLDATA_A
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4)
		)
		INSERT INTO #XMLDATA_A (FROMPARTY, TOPARTY, TRFQTY, MKTRATE)
		SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE FROM #XMLDATA
		DECLARE
			@@XMLCURSOR CURSOR,
			@@MKRATE NUMERIC(18, 4)
		SET @@XMLCURSOR = CURSOR FOR
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE FROM #XMLDATA_A
		OPEN @@XMLCURSOR
		FETCH NEXT FROM @@XMLCURSOR INTO @FPARTY, @TPARTY, @TRFQTY, @@MKRATE
		WHILE @@FETCH_STATUS = 0
			BEGIN
				SELECT @SAUDA_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
				SELECT @EXPIRY_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 109)
				IF @OPTION_TYPE IS NULL OR @OPTION_TYPE = ''
					BEGIN
						SET @OPTION_TYPE = '%'
					END
				IF @PARTIPANTCODE IS NULL OR @PARTIPANTCODE = ''
					BEGIN
						SET @PARTIPANTCODE = '%'
					END
				IF @@ORDER_NO IS NULL OR @@ORDER_NO = ''
					BEGIN
						SET @@ORDER_NO = '%'
					END
				IF @@TRADE_NO IS NULL OR @@TRADE_NO = ''
					BEGIN
						SET @@TRADE_NO = '%'
					END
				IF @TRFQTY IS NULL OR @TRFQTY = 0
					BEGIN
						SET @TRFQTY = @ACTUALQTY
					END
				EXEC PROC_TRADE_TRANSFER_TRADE @SAUDA_DATE_11,@FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY, @PARTIPANTCODE , @@ORDER_NO , @@TRADE_NO , @ACTUALQTY , @TRFQTY ,@STATUSNAME , @FROMWHERE
				FETCH NEXT FROM @@XMLCURSOR INTO @FPARTY, @TPARTY, @TRFQTY, @@MKRATE
			END
	END
SELECT RESULT = '0,NO ERROR'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRADE_REJECT_CONFIRM_INS
-- --------------------------------------------------
CREATE    PROCEDURE [DBO].[TRADE_REJECT_CONFIRM_INS]
	@FIXEDITEMS VARCHAR(8000),
	@VARIABLEITEMS VARCHAR(8000),
	@STATUSNAME VARCHAR(100),
	@FROMWHERE VARCHAR(200),
	@LEVEL VARCHAR(5)

AS

/*---------------------------------------------------------------------------
	PROC NAME   : TRADE_REJECT_CONFIRM_INS
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CALLING FOR THE FOSETTLEMENT TRADE REJECTION/CONFIRMATION
------------------------------------------------------------------------------*/

	SET NOCOUNT ON

	DECLARE
		@CONTRACTNO VARCHAR(7),
		@PARTY_CODE VARCHAR(10),
		@INST_TYPE VARCHAR(6),
		@SYMBOL VARCHAR(20),
		@SEC_NAME VARCHAR(25),
		@EXPIRYDATE VARCHAR(20),
		@STRIKE_PRICE MONEY,
		@OPTION_TYPE VARCHAR(2),
		@SELLBUY INT,
		@PARTICIPANTCODE VARCHAR(15),
		@MKTRATE NUMERIC(18, 4),
		@LOOP INT,
		@RECORD VARCHAR(300),
		@TRFQUERY VARCHAR(8000),
		@MEMBERCODE VARCHAR(15),
		@ORIG_PARTICIPANT VARCHAR(15),
		@TRANDATE VARCHAR(11) 
	
	
	SELECT @MEMBERCODE = MEMBERCODE FROM OWNER
	SET @LOOP = 1
	IF CONVERT(NUMERIC(5), @LEVEL) = 201 
		BEGIN
			SET @TRANDATE = LTRIM(RTRIM(.DBO.PIECE(@FIXEDITEMS, ',', 3)))
			WHILE 1 = 1
				BEGIN
					SET @RECORD = LTRIM(RTRIM(.DBO.PIECE(@VARIABLEITEMS, '|', @LOOP)))
					IF @RECORD = '' OR @RECORD IS NULL
						BEGIN
							BREAK
						END
					ELSE
				
					BEGIN	
							SET @CONTRACTNO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 1)))
							SET @PARTY_CODE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 2)))
							SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 3)))
							SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 4)))
							SET @SEC_NAME = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 5)))
							SET @EXPIRYDATE = CONVERT(VARCHAR,(LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 6)))),103)
							SET @STRIKE_PRICE = CONVERT(MONEY ,LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 7))))
							SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 8)))
							--SET @TRANDATE =LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 9)))
							SET @PARTICIPANTCODE=LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',',13)))
							SET @SELLBUY = CONVERT(INT, LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 14))))
							SET @MKTRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',',15))))
							SET @LOOP = @LOOP + 1
							
							INSERT INTO INST_LOG	
							SELECT
								PARTY_CODE,
								PARTY_CODE,
								SAUDA_DATE,
								INST_TYPE,
								SYMBOL,
								EXPIRYDATE,
								STRIKE_PRICE,
								OPTION_TYPE,
								ORDER_NO,
								TRADE_NO,
								SELL_BUY,
								CONTRACTNO,
								CONTRACTNO,
								0,0,
								PRICE,
								@MKTRATE,
								0,0, 
								TRADEQTY,
								TRADEQTY,
								0, 
								PARTICIPANTCODE,
 								PARTICIPANTCODE,
 								@STATUSNAME,
 								@FROMWHERE,
 								'CONFIRMATION',
 						  		 GETDATE(),  
 								'TRADE_REJECT_CONFIRM', '', '' 
 							FROM FOSETTLEMENT
 							WHERE
								CONVERT(VARCHAR(11), SAUDA_DATE, 103) =@TRANDATE
 								AND PARTY_CODE=@PARTY_CODE 
 								AND INST_TYPE=@INST_TYPE 
 								AND SYMBOL=@SYMBOL
 								AND SEC_NAME=@SEC_NAME
								AND CONVERT(VARCHAR(11),EXPIRYDATE,103) = @EXPIRYDATE
								AND STRIKE_PRICE = @STRIKE_PRICE
 								AND OPTION_TYPE = @OPTION_TYPE
 								AND PARTICIPANTCODE = @PARTICIPANTCODE
 								AND SELL_BUY = @SELLBUY
 								AND CONTRACTNO = @CONTRACTNO

							UPDATE
								FOSETTLEMENT 
							SET 
								RESERVED1=1 ,PRICE=@MKTRATE							
							WHERE
								CONVERT(VARCHAR(11), SAUDA_DATE, 103)=@TRANDATE
								AND PARTY_CODE=@PARTY_CODE
								AND INST_TYPE=@INST_TYPE 
								AND SYMBOL=@SYMBOL
								AND SEC_NAME=@SEC_NAME
								AND CONVERT(VARCHAR,EXPIRYDATE,103) = @EXPIRYDATE
								AND STRIKE_PRICE = @STRIKE_PRICE	
								AND OPTION_TYPE=@OPTION_TYPE
								AND PARTICIPANTCODE=@PARTICIPANTCODE
								AND SELL_BUY=@SELLBUY
								AND RESERVED1=0
								AND CONTRACTNO=@CONTRACTNO								
						END
				END
		END


IF CONVERT(NUMERIC(5), @LEVEL) = 301 
		BEGIN
			
			SET @TRANDATE = LTRIM(RTRIM(.DBO.PIECE(@FIXEDITEMS, ',', 3)))
			WHILE 1 = 1
				BEGIN
					SET @RECORD = LTRIM(RTRIM(.DBO.PIECE(@VARIABLEITEMS, '|', @LOOP)))
					IF @RECORD = '' OR @RECORD IS NULL
						BEGIN
							BREAK
						END
					ELSE
						BEGIN	
							SET @CONTRACTNO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 1)))
							SET @PARTY_CODE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 2)))
							SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 3)))
							SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 4)))
							SET @SEC_NAME = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 5)))
							SET @EXPIRYDATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 6)))
							SET @STRIKE_PRICE = CONVERT(MONEY ,LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 7))))
							SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 8)))
							--SET @TRANDATE =LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 9)))
							SET @PARTICIPANTCODE=LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',',13)))
							SET @SELLBUY = CONVERT(INT, LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 14))))
							SET @MKTRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',',15))))													
							SET @LOOP = @LOOP + 1
                             				
							INSERT INTO INST_LOG	
								SELECT
									PARTY_CODE,
									PARTY_CODE,
									SAUDA_DATE,
									INST_TYPE,
									SYMBOL,
									EXPIRYDATE,
									STRIKE_PRICE,
									OPTION_TYPE,
									ORDER_NO,
									TRADE_NO,
									SELL_BUY,
									CONTRACTNO,
									CONTRACTNO,
									0,0,
									PRICE,
									@MKTRATE,
									0,0, 
									TRADEQTY,
									TRADEQTY,
									0, 
									PARTICIPANTCODE,
									PARTICIPANTCODE,
									@STATUSNAME,
									@FROMWHERE,
									'REJECTION',
							  		 GETDATE(),  
									'TRADE_REJECT_CONFIRM', '', '' 
								FROM 
									FOSETTLEMENT
								WHERE
									CONVERT(VARCHAR(11), SAUDA_DATE, 103) = @TRANDATE
									AND PARTY_CODE=@PARTY_CODE 
									AND INST_TYPE = @INST_TYPE 
									AND SYMBOL = @SYMBOL
									AND SEC_NAME = @SEC_NAME
									AND CONVERT(VARCHAR(11), EXPIRYDATE, 103) = @EXPIRYDATE
									AND STRIKE_PRICE = @STRIKE_PRICE
									AND OPTION_TYPE = @OPTION_TYPE
									AND PARTICIPANTCODE = @PARTICIPANTCODE
									AND SELL_BUY = @SELLBUY
									AND CONTRACTNO = @CONTRACTNO
		

							UPDATE 
								FOSETTLEMENT 
							SET 
								RESERVED1=0 ,PRICE=@MKTRATE
							WHERE
								CONVERT(VARCHAR(11), SAUDA_DATE, 103) = @TRANDATE
							    AND PARTY_CODE = @PARTY_CODE
								AND INST_TYPE = @INST_TYPE 
								AND SYMBOL = @SYMBOL
								AND SEC_NAME = @SEC_NAME
								AND CONVERT(VARCHAR,EXPIRYDATE,103) = @EXPIRYDATE
								AND STRIKE_PRICE = @STRIKE_PRICE
								AND OPTION_TYPE = @OPTION_TYPE
								AND PARTICIPANTCODE = @PARTICIPANTCODE
								AND SELL_BUY = @SELLBUY
								AND CONTRACTNO = @CONTRACTNO
								
						END
				END
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_BFOEXERCISEALLOCATION
-- --------------------------------------------------

CREATE  PROCEDURE [DBO].[UPDATE_BFOEXERCISEALLOCATION]        
@BILLDATE AS VARCHAR(11)        
AS  
  
CREATE TABLE #FOEXALLOC
(
	PARTY_CODE VARCHAR(10),
	CL_TYPE VARCHAR(2),
	PRODUCT_TYPE VARCHAR(3),    
	PRODUCT_CODE VARCHAR(7), 
	ASSET_CODE VARCHAR(8),   
	SERIES_CODE VARCHAR(22),    
	SERIES_ID INT,    
	EXPIRYDATE DATETIME,
	EXPDT  VARCHAR(11),
	STRIKE_PRICE MONEY,   
	OPTION_TYPE VARCHAR(2),
	SETTLEMENT_PRICE MONEY,
	TRADEQTY INT,
	SELL_BUY INT
)

INSERT INTO #FOEXALLOC
SELECT  
	PARTY_CODE,    
	CL_TYPE = ACCOUNT_TYPE,    
	PRODUCT_TYPE,    
	PRODUCT_CODE,
	ASSET_CODE ='',    
	SERIES_CODE,    
	SERIES_ID=0,    
	EXPIRYDATE,
	EXPDT = LEFT(EXPIRYDATE,11),
	STRIKE_PRICE,   
	OPTION_TYPE,
	PRICE = SETTLEMENT_PRICE,    
	TRADEQTY = EXERCISED_QTY,    
	SELL_BUY = 2  
FROM BFOEXERCISEALLOCATION    
WHERE POSITION_DATE BETWEEN  @BILLDATE AND @BILLDATE + ' 23:59'
AND EXERCISED_QTY <> 0    

UNION ALL   
 SELECT  
	PARTY_CODE,    
	CL_TYPE = ACCOUNT_TYPE,    
	PRODUCT_TYPE,    
	PRODUCT_CODE,    
	ASSET_CODE ='',
	SERIES_CODE,    
	SERIES_ID=0,    
	EXPIRYDATE,
	EXPDT = LEFT(EXPIRYDATE,11),
	STRIKE_PRICE,   
	OPTION_TYPE,
	PRICE = SETTLEMENT_PRICE,    
	TRADEQTY = ASSIGNED_QTY,    
	SELL_BUY = 1  
FROM BFOEXERCISEALLOCATION    
WHERE POSITION_DATE BETWEEN  @BILLDATE AND @BILLDATE + ' 23:59'
AND ASSIGNED_QTY <> 0    

UPDATE #FOEXALLOC 
SET SERIES_ID = BFOSCRIP2.SERIES_ID, ASSET_CODE = BFOSCRIP2.ASSET_CODE
FROM BFOSCRIP2
WHERE #FOEXALLOC.PRODUCT_CODE = BFOSCRIP2.PRODUCT_CODE
	AND #FOEXALLOC.SERIES_CODE =  BFOSCRIP2.SERIES_CODE
	AND #FOEXALLOC.EXPIRYDATE = BFOSCRIP2.EXPIRYDATE
	AND #FOEXALLOC.STRIKE_PRICE = BFOSCRIP2.STRIKE_PRICE
	AND #FOEXALLOC.OPTION_TYPE = BFOSCRIP2.OPTION_TYPE


SELECT * FROM #FOEXALLOC
ORDER BY 1,2,3,4,5

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CHECKPASSWORD
-- --------------------------------------------------


CREATE PROC [dbo].[USP_CHECKPASSWORD]
(
	@PWD VARCHAR(512) 
)
/*
SELECT * FROM TBLGLOBALPARAMS
SELECT * FROM TBLPRADNYAUSERS
update TBLGLOBALPARAMS set FLDPWDMINLENGTH = 2
USP_CHECKPASSWORD ''
*/
AS

DECLARE 
@FLAG AS VARCHAR(1),
@SPCL AS VARCHAR(1),
@MAXL AS VARCHAR(2),
@MINL AS VARCHAR(2),
@ANUM AS VARCHAR(1),
@MSG AS VARCHAR(100),
@NFLAG AS VARCHAR(1)
SET @FLAG = 'N'
SET @NFLAG = 'N'
SET @MSG = 'OK'

CREATE TABLE #TEMP
(
	MSG VARCHAR(100)
) 

SELECT @SPCL = FLDSPCLCHAR, @MINL = FLDPWDMINLENGTH ,@MAXL = FLDPWDMAXLENGTH, @ANUM = FLDPWDALPHANUMONLY FROM TBLGLOBALPARAMS

IF LEN(@PWD) = 0 
 BEGIN
	SET @MSG = ' ** Password Can Not be Blank.'
	INSERT INTO #TEMP VALUES(@MSG)
	SELECT * FROM #TEMP
	RETURN
 END

IF LEN(@PWD) < @MINL
 BEGIN
	SET @MSG = ' ** Password Should be Minimum '+ @MINL + ' in Length.'
	INSERT INTO #TEMP VALUES(@MSG)
 END
 
 IF LEN(@PWD) > @MAXL
 BEGIN
	SET @MSG = ' ** Password Should be Maximum '+ @MAXL + ' in Length.'
	INSERT INTO #TEMP VALUES(@MSG)
 END
 
IF @ANUM = '1'
BEGIN 
	IF (PATINDEX('%['+CHAR(48)+'-'+CHAR(57)+']%',@PWD) > 0 )
	 BEGIN 
		SET @NFLAG = 'Y'
	 END
	 IF (PATINDEX('%['+CHAR(65)+'-'+CHAR(90)+']%',@PWD) > 0 )
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 IF (PATINDEX('%['+CHAR(97)+'-'+CHAR(122)+']%',@PWD) > 0 )
	 BEGIN 
		SET @FLAG = 'Y'
	 END
END
IF (@FLAG = 'N' or @NFLAG = 'N') AND @ANUM = '1'
 BEGIN 
	SET @MSG = ' ** Password Should be Alpha-Numeric.'
	INSERT INTO #TEMP VALUES(@MSG)
 END
 
SET @FLAG = 'N' 
IF @SPCL = 'Y'
BEGIN
	IF (PATINDEX('%['+CHAR(0)+'-'+CHAR(47)+']%',@PWD) > 0 )
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(58)+'-'+CHAR(64)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(58)+'-'+CHAR(64)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(91)+'-'+CHAR(96)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(123)+'-'+CHAR(126)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
END	 
 
IF @FLAG = 'N' AND @SPCL = 'Y'
 BEGIN 
	SET @MSG = ' ** Password Should have Atleast One Special Character.'
	INSERT INTO #TEMP VALUES(@MSG)
 END 	


  
IF ((SELECT COUNT(*) FROM #TEMP) = 0)
 BEGIN
	INSERT INTO #TEMP VALUES(@MSG)
 END 
SELECT * FROM #TEMP
DROP TABLE #TEMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_RTB_Bsefo_master_sync
-- --------------------------------------------------
CREATE PROC [dbo].[usp_RTB_Bsefo_master_sync]  
(@sauda_date AS DATETIME)  
AS BEGIN  
 
DELETE FROM BFOSETTLEMENT WHERE SAUDA_DATE >= @sauda_date AND SAUDA_DATE <= @sauda_date +' 23:59'  
   
 
INSERT INTO  BFOSETTLEMENT  
 SELECT  CONTRACTNO = CONTRACTNO,TRADE_NO = TRADE_NO,SAUDA_DATE	= SAUDA_DATE, TRADESTATUS = TRADESTATUS,SEGMENT = SEGMENT,SETT_TYPE = SETT_TYPE,
 PRODUCT_TYPE =	PRODUCT_TYPE,PRODUCT_CODE =	PRODUCT_CODE,ASSET_CODE = ASSET_CODE, EXPIRYDATE =	EXPIRYDATE,STRIKE_PRICE = STRIKE_PRICE,
 OPTION_TYPE = OPTION_TYPE,SERIES_CODE = SERIES_CODE,SERIES_ID = SERIES_ID, LOT_SIZE = LOT_SIZE,SELL_BUY =	SELL_BUY,TRADEQTY = TRADEQTY, 
 SETT_FLAG = SETT_FLAG,CA_LEVEL = CA_LEVEL,BROKER_CD = BROKER_CD,TRADE_PRICE = TRADE_PRICE,LOCATIONID =	LOCATIONID,CM_CODE = CM_CODE,
 PARTICIPANTCODE = 	PARTICIPANTCODE,CP_CONFIRMATION = CP_CONFIRMATION, OC_FLAG = OC_FLAG, OLD_CP_CODE =	OLD_CP_CODE,OLD_CM_CODE =	OLD_CM_CODE,
 TERMINALID	= TERMINALID,ORDER_NO =	ORDER_NO,PARTY_CODE = PARTY_CODE,REMARKS = REMARKS, BUY_POSITION = BUY_POSITION, SELL_POSITION = SELL_POSITION,
PRO_CLI = PRO_CLI, ORDER_TIMESTAMP = ORDER_TIMESTAMP, ORDER_ACTIVEFLAG =	ORDER_ACTIVEFLAG,TABLE_NO = TABLE_NO, LINE_NO =	LINE_NO, VAL_PERC =	VAL_PERC,
NORMAL = NORMAL,DAY_PUC = DAY_PUC,DAY_SALES = DAY_SALES,SETT_PURCH = SETT_PURCH,SETT_SALES = SETT_SALES,SETTFLAG = SETTFLAG,ROFIG = ROFIG,ERRNUM = ERRNUM,
NOZERO = NOZERO,ROUND_TO = ROUND_TO,TRADE_AMOUNT = TRADE_AMOUNT,BRANCH_CD = BRANCH_CD, BROKAPPLIED = BROKAPPLIED,INS_CHRG =  INS_CHRG,TURN_TAX = TURN_TAX,
OTHER_CHRG = OTHER_CHRG,SEBI_TAX = SEBI_TAX,BROKER_CHRG = BROKER_CHRG,NETRATE = NETRATE,SERVICE_TAX = SERVICE_TAX,AUCTIONPART =	AUCTIONPART,
RESERVED1 =	RESERVED1,DUMMY1 = DUMMY1,DUMMY2 = DUMMY2,[STATUS] = [STATUS]
		FROM BFOSETTLEMENT_RTB WITH (NOLOCK) WHERE SAUDA_DATE = @sauda_date 

		-------

  SELECT * INTO #BFOSETT 
	FROM BFOSETTLEMENT_RTB WITH (NOLOCK) WHERE SAUDA_DATE = @SAUDA_DATE


   ------

DELETE TBL_STAMP_DATA WHERE  SAUDA_DATE= @sauda_date

INSERT INTO TBL_STAMP_DATA
Select SAUDA_DATE = SAUDA_DATE,CONTRACTNO = CONTRACTNO,PARTY_CODE = PARTY_CODE,INST_TYPE = INST_TYPE,SYMBOL = SYMBOL,EXPIRYDATE = EXPIRYDATE,
STRIKE_PRICE = STRIKE_PRICE,OPTION_TYPE = OPTION_TYPE,BUYQTY = BUYQTY,SELLQTY = SELLQTY,BUYAVGRATE = BUYAVGRATE,SELLAVGRATE = SELLAVGRATE,
BUYSTAMP= BUYSTAMP,SELLSTAMP = SELLSTAMP,TOTALSTAMP = TOTALSTAMP,L_STATE = L_STATE,LASTRUNDATE = Getdate() 
from TBL_STAMP_DATA_RTB where sauda_date = @sauda_date   
 
 -----

DELETE STT_CLIENTDETAIL WHERE SAUDA_DATE = @sauda_date  

INSERT INTO STT_CLIENTDETAIL
SELECT RecType = RecType,Sauda_Date = Sauda_Date,ContractNo = ContractNo,Party_Code = Party_Code,product_type = product_type,product_code = product_code,
Series_code = Series_code,Series_id = Series_id,Expirydate = Expirydate,TrdPrice = TrdPrice,PQtyTrd = PQtyTrd,PAmtTrd = PAmtTrd,PSTTTrd = PSTTTrd,
SQtyTrd = SQtyTrd,SAmtTrd = SAmtTrd,SSTTTrd = SSTTTrd,TotalSTT = TotalSTT 
from STT_ClientDetail_RTB where  SAUDA_DATE= @sauda_date

---  
   
DELETE FROM CHARGES_DETAIL WHERE CD_SAUDA_DATE = @sauda_date  
 
INSERT INTO CHARGES_DETAIL  
SELECT  CD_PARTY_CODE = CD_PARTY_CODE,CD_SAUDA_DATE = CD_SAUDA_DATE,CD_CONTRACT_NO = CD_CONTRACT_NO,CD_TRADE_NO = CD_TRADE_NO,CD_ORDER_NO = CD_ORDER_NO,
CD_PRODUCT_TYPE = CD_PRODUCT_TYPE,CD_PRODUCT_CODE = CD_PRODUCT_CODE,CD_ASSET_CODE = CD_ASSET_CODE,CD_EXPIRYDATE = CD_EXPIRYDATE,
CD_STRIKE_PRICE = CD_STRIKE_PRICE,CD_OPTION_TYPE = (CASE WHEN CD_OPTION_TYPE = 'XX' THEN '' ELSE CD_OPTION_TYPE END),
CD_SERIES_CODE = CD_SERIES_CODE,CD_SERIES_ID = CD_SERIES_ID,CD_LOT_SIZE = CD_LOT_SIZE,CD_AUCTIONPART = CD_AUCTIONPART,CD_MARKETLOT = CD_MARKETLOT,
CD_SCHEME_ID = CD_SCHEME_ID,CD_COMPUTATIONLEVEL = CD_COMPUTATIONLEVEL,CD_COMPUTATIONON = CD_COMPUTATIONON,CD_COMPUTATIONTYPE = CD_COMPUTATIONTYPE,
CD_BUYRATE = CD_BUYRATE,CD_SELLRATE = CD_SELLRATE,CD_TOT_BUYQTY = CD_TOT_BUYQTY,CD_TOT_SELLQTY = CD_TOT_SELLQTY,
CD_TOT_BUYTURNOVER = CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER = CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED = CD_TOT_BUYTURNOVER_ROUNDED,
CD_TOT_SELLTURNOVER_ROUNDED = CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER = CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED = CD_TOT_TURNOVER_ROUNDED,
CD_TOT_LOT = CD_TOT_LOT,CD_TOT_RES_TURNOVER = CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED = CD_TOT_RES_TURNOVER_ROUNDED,CD_TOT_RES_LOT = CD_TOT_RES_LOT,
CD_TOT_BUYBROK = CD_TOT_BUYBROK,CD_TOT_SELLBROK = CD_TOT_SELLBROK,CD_TOT_BROK = CD_TOT_BROK,CD_TOT_BUYSERTAX = CD_TOT_BUYSERTAX,
CD_TOT_SELLSERTAX = CD_TOT_SELLSERTAX,CD_TOT_SERTAX = CD_TOT_SERTAX,CD_TOT_STT = CD_TOT_STT,CD_TOT_TURN_TAX = CD_TOT_TURN_TAX,
CD_TOT_OTHER_CHRG = CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX = CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY = CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE = CD_EXCH_BUYRATE,
CD_EXCH_SELLRATE = CD_EXCH_SELLRATE,CD_TIMESTAMP =GETDATE() 
FROM ORDERWISEDETAIL_RTB WHERE CD_SAUDA_DATE = @sauda_date AND CD_SERIES_CODE NOT LIKE '%Brok%'  
  
 
INSERT INTO CHARGES_DETAIL  
SELECT  CD_PARTY_CODE = CD_PARTY_CODE,CD_SAUDA_DATE = CD_SAUDA_DATE,CD_CONTRACT_NO = CD_CONTRACT_NO,CD_TRADE_NO = CD_TRADE_NO,CD_ORDER_NO = CD_ORDER_NO,
CD_PRODUCT_TYPE = CD_PRODUCT_TYPE,CD_PRODUCT_CODE = CD_PRODUCT_CODE,CD_ASSET_CODE = CD_ASSET_CODE,CD_EXPIRYDATE = CD_EXPIRYDATE,
CD_STRIKE_PRICE = CD_STRIKE_PRICE,CD_OPTION_TYPE = CD_OPTION_TYPE,CD_SERIES_CODE = 'BROKERAGE',CD_SERIES_ID = CD_SERIES_ID,CD_LOT_SIZE = CD_LOT_SIZE,
CD_AUCTIONPART = CD_AUCTIONPART,CD_MARKETLOT = CD_MARKETLOT,CD_SCHEME_ID = CD_SCHEME_ID,CD_COMPUTATIONLEVEL = CD_COMPUTATIONLEVEL,
CD_COMPUTATIONON = CD_COMPUTATIONON,CD_COMPUTATIONTYPE = CD_COMPUTATIONTYPE,CD_BUYRATE = CD_BUYRATE,CD_SELLRATE = CD_SELLRATE,CD_TOT_BUYQTY = CD_TOT_BUYQTY,
CD_TOT_SELLQTY = CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER = CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER = CD_TOT_SELLTURNOVER,
CD_TOT_BUYTURNOVER_ROUNDED = CD_TOT_BUYTURNOVER_ROUNDED,CD_TOT_SELLTURNOVER_ROUNDED = CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER = CD_TOT_TURNOVER,
CD_TOT_TURNOVER_ROUNDED = CD_TOT_TURNOVER,CD_TOT_LOT = CD_TOT_LOT,CD_TOT_RES_TURNOVER = CD_TOT_RES_TURNOVER,
CD_TOT_RES_TURNOVER_ROUNDED = CD_TOT_RES_TURNOVER_ROUNDED,CD_TOT_RES_LOT= CD_TOT_RES_LOT,CD_TOT_BUYBROK = CD_TOT_BUYBROK,CD_TOT_SELLBROK = CD_TOT_SELLBROK,
CD_TOT_BROK = CD_TOT_BROK,CD_TOT_BUYSERTAX = CD_TOT_BUYSERTAX,CD_TOT_SELLSERTAX = CD_TOT_SELLSERTAX,CD_TOT_SERTAX = CD_TOT_SERTAX,CD_TOT_STT = CD_TOT_STT,
CD_TOT_TURN_TAX = CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG = CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX = CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY = CD_TOT_STAMPDUTY,
CD_EXCH_BUYRATE = CD_EXCH_BUYRATE,CD_EXCH_SELLRATE = CD_EXCH_SELLRATE,CD_TIMESTAMP = GETDATE()  
 FROM ORDERWISEDETAIL_RTB  WHERE CD_SAUDA_DATE = @sauda_date   AND CD_SERIES_CODE LIKE '%Brok%'  
  

 --------------------
 
 
DECLARE @CONTNO VARCHAR(10)
SELECT @CONTNO= MAX(CONVERT(BIGINT,CONTRACTNO_SEG)) FROM #BFOSETT (NOLOCK)
  
IF ISNULL(@CONTNO,0) <> 0 
 BEGIN 

UPDATE CONTGEN SET CONTRACTNO = @CONTNO 
	WHERE @SAUDA_DATE BETWEEN START_DATE AND END_DATE 
	 
	 END
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_APPLICATION_LOG
-- --------------------------------------------------
CREATE  PROC [DBO].[V2_APPLICATION_LOG]  
(  
          @FROMDATE VARCHAR(11),              
          @TODATE VARCHAR(11),              
          @LOGINNAME  VARCHAR(10),  
          @REPORTTYPE VARCHAR(10)  
)              
  
AS              
              
/*              
  SET @FROMDATE = LEFT(CONVERT(DATETIME,REPLACE(REPLACE(@FROMDATE,'/',''),'-',''),112),11)              
  SET @TODATE = LEFT(CONVERT(DATETIME,REPLACE(REPLACE(@TODATE,'/',''),'-',''),112),11)              
*/  
  SET @FROMDATE = LEFT(CONVERT(DATETIME,@FROMDATE,105),11)              
  SET @TODATE = LEFT(CONVERT(DATETIME,@TODATE,105),11)

           
  
  
IF @REPORTTYPE = 'LOGIN LOG'  
BEGIN  
 IF @LOGINNAME = ''  
 BEGIN  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
	   USERNAME [USER NAME],   
	   STATUSNAME [STATUS NAME],   
	   STATUSID [STATUS ID],   
	   IPADD [IP ADDRESS],   
	   [ACTION],   
	   ADDDT AS [ACTIVITY TIME]  
  FROM  
	   V2_LOGIN_LOG (NOLOCK)  
  WHERE  
	   ADDDT >= @FROMDATE  
	   AND ADDDT <= @TODATE + ' 23:59:59'  
	  ORDER BY ADDDT  
 END  
 ELSE  
 BEGIN  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
	   USERNAME [USER NAME],   
	   STATUSNAME [STATUS NAME],   
	   STATUSID [STATUS ID],   
	   IPADD [IP ADDRESS],   
	   [ACTION],   
	   ADDDT AS [ACTIVITY TIME]  
  FROM  
	   V2_LOGIN_LOG (NOLOCK)  
  WHERE 
	   ADDDT >= @FROMDATE  
	   AND ADDDT <= @TODATE + ' 23:59:59'  
	   AND USERNAME LIKE @LOGINNAME   
  ORDER BY ADDDT  
 END  
END  
  
IF @REPORTTYPE = 'ACCESS LOG'  
BEGIN  
 IF @LOGINNAME = ''  
 BEGIN  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT
		   USERNAME [USER NAME],   
		   STATUSNAME [STATUS NAME],   
		   STATUSID [STATUS ID],   
		   IPADD [IP ADDRESS],
		   TR.FLDREPORTNAME [REPORT NAME], 
		   TM.FLDMENUNAME[MENU NAME],    
		   REPPATH [REPORT PATH],   
		   ADDDT AS [ACTIVITY TIME]  
	FROM   V2_REPORT_ACCESS_LOG V2  
		   LEFT OUTER JOIN TBLREPORTS TR
	ON    
            REPLACE(V2.REPPATH,'`','')=TR.FLDPATH
	        LEFT OUTER JOIN TBLMENUHEAD TM
            ON TR.FLDMENUGRP=TM.FLDMENUCODE 
	WHERE 
			REPLACE(V2.REPPATH,'`','')=TR.FLDPATH 
			AND TR.FLDMENUGRP=TM.FLDMENUCODE  
			AND ADDDT >= @FROMDATE  
			AND ADDDT <= @TODATE + ' 23:59:59'  
  ORDER BY ADDDT  
 END  
 ELSE  
 BEGIN  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT
		   USERNAME [USER NAME],   
		   STATUSNAME [STATUS NAME],   
		   STATUSID [STATUS ID],   
		   IPADD [IP ADDRESS],
		   TR.FLDREPORTNAME [REPORT NAME],
		   TM.FLDMENUNAME[MENU NAME],    
		   REPPATH [REPORT PATH],   
		   ADDDT AS [ACTIVITY TIME]  
  FROM  
			V2_REPORT_ACCESS_LOG V2  
			LEFT OUTER JOIN TBLREPORTS TR
			ON    REPLACE(V2.REPPATH,'`','')=TR.FLDPATH 
			LEFT OUTER JOIN TBLMENUHEAD TM
			ON TR.FLDMENUGRP=TM.FLDMENUCODE  
  WHERE
			REPLACE(V2.REPPATH,'`','')=TR.FLDPATH 
			AND TR.FLDMENUGRP=TM.FLDMENUCODE  
			AND ADDDT >= @FROMDATE  
			AND ADDDT <= @TODATE + ' 23:59:59'  
			AND USERNAME LIKE @LOGINNAME   
		    ORDER BY ADDDT
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKBLOCKEDREPORTS
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[V2_CHECKBLOCKEDREPORTS]
                @RPTPATH VARCHAR(100)
                
AS

  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SET NOCOUNT ON
        
  IF (SELECT COUNT(1)
      FROM   TBLREPORTS_BLOCKED WITH (NOLOCK)
      WHERE  BLOCK_FLAG = 1
             AND LTRIM(RTRIM(FLDPATH)) = LEFT(LTRIM(RTRIM(@RPTPATH)),LEN(FLDPATH))) > 0 
  BEGIN 
    SELECT '<FONT COLOR = RED><B>THIS OPTION HAS BEEN DISABLED TEMPORARILY!! PLEASE CONTACT SYSTEM ADMINISTRATOR!!</B></FONT>'
  END 
  ELSE 
  BEGIN 
    SELECT '' 
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKPROCESSFORTODAY
-- --------------------------------------------------
CREATE PROC [DBO].[V2_CHECKPROCESSFORTODAY]    
(    
    @PROCESSFLAG VARCHAR(15),    
    @PROCESSDATE VARCHAR(11)    
)    
AS    
  
DECLARE @VBBFLAG INT  
  
SELECT @VBBFLAG = 0  
IF (SELECT ISNULL(COUNT(1),0) FROM (SELECT TOP 1 SP_PARTY_CODE FROM SCHEME_MAPPING (NOLOCK)) A) > 0   
 SELECT @VBBFLAG = 1  
  
 SELECT FLAG = (CASE     
                   WHEN @PROCESSFLAG = 'VBB'    
                        AND IMPORT_TRADE > 0 THEN 1    
                   WHEN @PROCESSFLAG = 'STT'  
                        AND IMPORT_TRADE > 0 THEN 1    
                   WHEN @PROCESSFLAG = 'BILLGEN' OR @PROCESSFLAG = 'VALANGEN'  
                        AND POSITIONFILE > 0 THEN 1    
                   WHEN @PROCESSFLAG = 'CONTRACT'    
                        AND IMPORT_TRADE > 0 AND VBB >= @VBBFLAG THEN 1    
                   WHEN @PROCESSFLAG = 'POSTING'    
                        AND BILLING > 0 THEN 1    
                   WHEN @PROCESSFLAG = 'CLOSE'    
                        AND POSTING > 0 THEN 1    
                   ELSE 0    
                 END),    
         PROCESSNAME = (CASE     
                          WHEN @PROCESSFLAG = 'VBB' THEN 'IMPORT_TRADE'    
                          WHEN @PROCESSFLAG = 'STT' THEN 'IMPORT_TRADE'    
                          WHEN @PROCESSFLAG = 'BILLGEN' THEN 'POSITION FILE'     
                          WHEN @PROCESSFLAG = 'CONTRACT' THEN  
        (CASE WHEN VBB < @VBBFLAG   
          THEN 'VBB PROCESS'  
          ELSE 'BILLGEN'    
           END)    
                          WHEN @PROCESSFLAG = 'POSTING' THEN 'CONTRACT'    
                          WHEN @PROCESSFLAG = 'CLOSE' THEN 'POSTING'    
                          ELSE 'SOME PROCESS'    
                        END)    
  FROM       
 V2_BUSINESS_PROCESS  (NOLOCK)  
  WHERE      
 LEFT(BUSINESS_DATE,11) = @PROCESSDATE    
 AND OPEN_CLOSE = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_CONTSECTION] (
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@SAUDA_DATE VARCHAR(11),
	@FROMPARTY_CODE VARCHAR(10),
	@TOPARTY_CODE VARCHAR(10),
	@BRANCH VARCHAR(10),
	@SUB_BROKER VARCHAR(10),
	@FROMCONTRACTNO VARCHAR(12),
	@TOCONTRACTNO VARCHAR(12),
	@CONTFLAG VARCHAR(10),
	@TOSAUDA_DATE VARCHAR(11) = '',
	@BOUNCEDFLAG INT = 0
	)
AS
--EXEC V2_CONTSECTION 'BROKER','BROKER','MAY 24 2011','','ZZZZZZZZZZZ','%','%','0','99999999999','CONTRACT','',0  
DECLARE @_STATUS CHAR(1)
SET @_STATUS='0'

IF @SUB_BROKER = 'ALL'
	OR @SUB_BROKER = ''
BEGIN
	SET @SUB_BROKER = '%'
END

IF @BRANCH = 'ALL'
	OR @BRANCH = ''
BEGIN
	SET @BRANCH = '%'
END

IF @FROMCONTRACTNO = ''
BEGIN
	SET @FROMCONTRACTNO = 000000
END

IF @TOCONTRACTNO = ''
BEGIN
	SET @TOCONTRACTNO = 99999999
END

IF @TOSAUDA_DATE = ''
BEGIN
	SET @TOSAUDA_DATE = @SAUDA_DATE
END

/*------------------  CANNED CONTRACT PLUG IN ------------------------*/
/*IF EXISTS (SELECT TOP 1 PARTY_CODE FROM CONTRACT_DATA(NOLOCK) WHERE SAUDA_DATE >= @SAUDA_DATE)
BEGIN
    --PRINT 'V2_CONTSECTION_DETAIL' @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@BRANCH,@SUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@TOSAUDA_DATE,@BOUNCEDFLAG,@_STATUS OUTPUT
	EXEC V2_CONTSECTION_DETAIL @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@BRANCH,@SUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@TOSAUDA_DATE,@BOUNCEDFLAG,@_STATUS OUTPUT
	IF @_STATUS = 1
	RETURN
END
*/

/*---------------------------------------------------------------------*/
CREATE TABLE #BPARTY (PARTY_CODE VARCHAR(15))

IF @BOUNCEDFLAG <> 0
BEGIN
	INSERT INTO #BPARTY
	SELECT DISTINCT PARTY_CODE
	FROM TBL_ECNBOUNCED(NOLOCK)
	WHERE SAUDA_DATE BETWEEN @SAUDA_DATE
			AND @TOSAUDA_DATE + ' 23:59:59'
END
ELSE
BEGIN
	INSERT INTO #BPARTY
	SELECT DISTINCT PARTY_CODE
	FROM CLIENT2(NOLOCK)
	WHERE PARTY_CODE BETWEEN @FROMPARTY_CODE
			AND @TOPARTY_CODE
END

SELECT C2.PARTY_CODE,
	C1.LONG_NAME,
	C1.L_ADDRESS1,
	C1.L_ADDRESS2,
	C1.L_ADDRESS3,
	C1.L_CITY,
	C1.L_STATE,
	C1.L_ZIP,
	C1.BRANCH_CD,
	C1.SUB_BROKER,
	C1.TRADER,
	C1.PAN_GIR_NO,
	C1.OFF_PHONE1,
	C1.OFF_PHONE2,
	PRINTF,
	MAPIDID,
	C2.SERVICE_CHRG,
	BROKERNOTE,
	TURNOVER_TAX,
	SEBI_TURN_TAX,
	C2.OTHER_CHRG,
	INSURANCE_CHRG,
	SEBI_NO = FD_CODE,
	PARENTCODE
INTO #CLIENTMASTER
FROM CLIENT1 C1 WITH (NOLOCK),
	CLIENT2 C2 WITH (NOLOCK)
LEFT JOIN UCC_CLIENT UC WITH (NOLOCK)
	ON C2.PARTY_CODE = UC.PARTY_CODE
--CLIENT_PRINT_SETTINGS  CP (NOLOCK) ,  
WHERE C2.CL_CODE = C1.CL_CODE
	AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE
		AND @TOPARTY_CODE
	AND @STATUSNAME = (
		CASE 
			WHEN @STATUSID = 'BRANCH'
				THEN C1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'
				THEN C1.SUB_BROKER
			WHEN @STATUSID = 'TRADER'
				THEN C1.TRADER
			WHEN @STATUSID = 'FAMILY'
				THEN C1.FAMILY
			WHEN @STATUSID = 'AREA'
				THEN C1.AREA
			WHEN @STATUSID = 'REGION'
				THEN C1.REGION
			WHEN @STATUSID = 'CLIENT'
				THEN C2.PARTY_CODE
			ELSE 'BROKER'
			END
		)
	AND BRANCH_CD = CASE 
		WHEN @BRANCH = '%'
			THEN BRANCH_CD
		ELSE @BRANCH
		END
	AND SUB_BROKER = CASE 
		WHEN @SUB_BROKER = '%'
			THEN SUB_BROKER
		ELSE @SUB_BROKER
		END
	--AND PRINTF =  CP.PRINT_FLAG  
	--AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'  
	AND C2.PARTY_CODE IN (
		SELECT PARTY_CODE
		FROM #BPARTY(NOLOCK)
		)

UPDATE #CLIENTMASTER
SET LONG_NAME = C1.LONG_NAME,
	L_ADDRESS1 = C1.L_ADDRESS1,
	L_ADDRESS2 = C1.L_ADDRESS2,
	L_ADDRESS3 = C1.L_ADDRESS3,
	L_CITY = C1.L_CITY,
	L_STATE = C1.L_STATE,
	L_ZIP = C1.L_ZIP,
	BRANCH_CD = C1.BRANCH_CD,
	SUB_BROKER = C1.SUB_BROKER,
	TRADER = C1.TRADER,
	PAN_GIR_NO = C1.PAN_GIR_NO,
	OFF_PHONE1 = C1.OFF_PHONE1,
	OFF_PHONE2 = C1.OFF_PHONE2
FROM CLIENT1 C1
WHERE C1.CL_CODE = #CLIENTMASTER.PARENTCODE

SELECT CONTRACTNO,
	BILLNO = LOT_SIZE,
	TRADE_NO,
	PARTY_CODE,
	PRODUCT_TYPE,
	PRODUCT_CODE,
	SERIES_CODE,
	SERIES_ID,
	MARKETRATE = TRADE_PRICE,
	EXPIRYDATE,
	STRIKE_PRICE,
	USER_ID = TERMINALID,
	PRO_CLI,
	TRADEQTY,
	AUCTIONPART,
	MARKETTYPE = OPTION_TYPE,
	ORDER_NO,
	SAUDA_DATE,
	TABLE_NO,
	LINE_NO,
	VAL_PERC,
	NORMAL,
	DAY_PUC,
	DAY_SALES,
	SETT_PURCH,
	SETT_SALES,
	SELL_BUY,
	SETTFLAG,
	BROKAPPLIED,
	NETRATE,
	AMOUNT = TRADE_AMOUNT,
	INS_CHRG,
	TURN_TAX,
	OTHER_CHRG,
	SEBI_TAX,
	BROKER_CHRG,
	SERVICE_TAX,
	TRADE_AMOUNT,
	PARTICIPANTCODE,
	STATUS,
	ORDER_DATE = ORDER_TIMESTAMP,
	DUMMY1,
	DUMMY2,
	RESERVED1
INTO #FOSETT
FROM BFOSETTLEMENT
WHERE 1 = 2

INSERT INTO #FOSETT
SELECT CONTRACTNO,
	BILLNO = LOT_SIZE,
	TRADE_NO,
	PARTY_CODE,
	PRODUCT_TYPE,
	PRODUCT_CODE,
	SERIES_CODE,
	SERIES_ID,
	MARKETRATE = TRADE_PRICE,
	EXPIRYDATE,
	STRIKE_PRICE,
	USER_ID = TERMINALID,
	PRO_CLI,
	TRADEQTY,
	AUCTIONPART,
	MARKETTYPE = OPTION_TYPE,
	ORDER_NO,
	SAUDA_DATE,
	TABLE_NO,
	LINE_NO,
	VAL_PERC,
	NORMAL,
	DAY_PUC,
	DAY_SALES,
	SETT_PURCH,
	SETT_SALES,
	SELL_BUY,
	SETTFLAG,
	BROKAPPLIED,
	NETRATE,
	AMOUNT = TRADE_AMOUNT,
	INS_CHRG,
	TURN_TAX,
	OTHER_CHRG,
	SEBI_TAX,
	BROKER_CHRG,
	SERVICE_TAX,
	TRADE_AMOUNT,
	PARTICIPANTCODE,
	STATUS,
	ORDER_DATE = ORDER_TIMESTAMP,
	DUMMY1,
	DUMMY2,
	RESERVED1
FROM BFOSETTLEMENT
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE
		AND @TOSAUDA_DATE + ' 23:59:59'
	AND PARTY_CODE >= @FROMPARTY_CODE
	AND PARTY_CODE <= @TOPARTY_CODE
	AND AUCTIONPART NOT IN ('CA')
	AND TRADEQTY <> 0
	AND TRADE_PRICE > 0
	AND RESERVED1 = 0

CREATE INDEX [DELPOS] ON [DBO].[#FOSETT] ([PARTY_CODE])

SELECT ORDER_NO,
	ORDER_TIME = RIGHT(ORDER_DATE, 8),
	TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
	LEFT(CONVERT(VARCHAR, SAUDA_DATE, 108), 11) AS TRADETIME,
	BILLNO,
	PQTY = (
		CASE 
			WHEN SELL_BUY = 1
				THEN TRADEQTY
			ELSE 0
			END
		),
	SQTY = (
		CASE 
			WHEN SELL_BUY = 2
				THEN TRADEQTY
			ELSE 0
			END
		),
	PRATE = (
		CASE 
			WHEN SELL_BUY = 1
				THEN ISNULL(MARKETRATE, 0)
			ELSE 0
			END
		),
	SRATE = (
		CASE 
			WHEN SELL_BUY = 2
				THEN ISNULL(MARKETRATE, 0)
			ELSE 0
			END
		),
	PBROK = (
		CASE 
			WHEN SELL_BUY = 1
				THEN ISNULL((
							BROKAPPLIED + (
								CASE 
									WHEN C.SERVICE_CHRG = 1
										THEN ISNULL(F.SERVICE_TAX / TRADEQTY, 0)
									ELSE 0
									END
								)
							), 0)
			ELSE 0
			END
		),
	SBROK = (
		CASE 
			WHEN SELL_BUY = 2
				THEN ISNULL((
							BROKAPPLIED + (
								CASE 
									WHEN C.SERVICE_CHRG = 1
										THEN ISNULL(F.SERVICE_TAX / TRADEQTY, 0)
									ELSE 0
									END
								)
							), 0)
			ELSE 0
			END
		),
	PNETRATE = (
		CASE 
			WHEN SELL_BUY = 1
				THEN ISNULL(NETRATE + (
							CASE 
								WHEN C.SERVICE_CHRG = 1
									THEN ISNULL((F.SERVICE_TAX / TRADEQTY), 0)
								ELSE 0
								END
							), 0)
			ELSE 0
			END
		),
	SNETRATE = (
		CASE 
			WHEN SELL_BUY = 2
				THEN ISNULL(NETRATE - (
							CASE 
								WHEN C.SERVICE_CHRG = 1
									THEN ISNULL((F.SERVICE_TAX / TRADEQTY), 0)
								ELSE 0
								END
							), 0)
			ELSE 0
			END
		),
	ISNULL(AMOUNT, 0) AMOUNT,
	PRODUCT_TYPE = (
		CASE 
			WHEN F.AUCTIONPART = 'EA'
				THEN STUFF(PRODUCT_TYPE, 1, 3, 'EA-')
			ELSE PRODUCT_TYPE
			END
		),
	PRODUCT_CODE = (
		CASE 
			WHEN F.AUCTIONPART = 'EA'
				THEN STUFF(PRODUCT_CODE, 1, 3, 'EA-')
			ELSE PRODUCT_CODE
			END
		),
	SERIES_CODE,
	SERIES_ID,
	PAMT = (
		CASE 
			WHEN SELL_BUY = 1
				THEN (TRADEQTY * NETRATE) + (
						CASE 
							WHEN C.SERVICE_CHRG = 1
								THEN ISNULL((F.SERVICE_TAX), 0)
							ELSE (
									CASE 
										WHEN C.SERVICE_CHRG = 0
											THEN 0
										ELSE (
												CASE 
													WHEN C.SERVICE_CHRG = 2
														THEN 0
													ELSE 0
													END
												)
										END
									)
							END
						)
			ELSE 0
			END
		),
	SAMT = (
		CASE 
			WHEN SELL_BUY = 2
				THEN (TRADEQTY * NETRATE) - (
						CASE 
							WHEN C.SERVICE_CHRG = 1
								THEN ISNULL((F.SERVICE_TAX), 0)
							ELSE (
									CASE 
										WHEN C.SERVICE_CHRG = 0
											THEN 0
										ELSE (
												CASE 
													WHEN C.SERVICE_CHRG = 2
														THEN 0
													ELSE 0
													END
												)
										END
									)
							END
						)
			ELSE 0
			END
		),
	LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 11) AS EXPIRYDATE,
	F.PARTY_CODE,
	SELL_BUY,
	CONTRACTNO,
	CONVERT(VARCHAR, SAUDA_DATE, 103) AS SAUDA_DATE,
	ISNULL(STRIKE_PRICE, 0) STRIKE_PRICE,
	PSERVICE_TAX = (
		CASE 
			WHEN SELL_BUY = 1
				THEN (
						CASE 
							WHEN C.SERVICE_CHRG = 0
								THEN (F.SERVICE_TAX)
							ELSE (
									CASE 
										WHEN C.SERVICE_CHRG = 1
											THEN 0
										ELSE (
												CASE 
													WHEN C.SERVICE_CHRG = 2
														THEN 0
													END
												)
										END
									)
							END
						)
			ELSE 0
			END
		),
	SSERVICE_TAX = (
		CASE 
			WHEN SELL_BUY = 2
				THEN (
						CASE 
							WHEN C.SERVICE_CHRG = 0
								THEN (F.SERVICE_TAX)
							ELSE (
									CASE 
										WHEN C.SERVICE_CHRG = 1
											THEN 0
										ELSE (
												CASE 
													WHEN C.SERVICE_CHRG = 2
														THEN 0
													END
												)
										END
									)
							END
						)
			ELSE 0
			END
		),
	YY = YEAR(SAUDA_DATE),
	MM = MONTH(SAUDA_DATE),
	DD = DAY(SAUDA_DATE),
	DFLAG = 1,
	BROKER_CHRG = (
		CASE 
			WHEN BROKERNOTE = 1
				THEN BROKER_CHRG
			ELSE 0
			END
		),
	TURN_TAX = (
		CASE 
			WHEN TURNOVER_TAX = 1
				THEN TURN_TAX
			ELSE 0
			END
		),
	SEBI_TAX = (
		CASE 
			WHEN SEBI_TURN_TAX = 1
				THEN SEBI_TAX
			ELSE 0
			END
		),
	OTHER_CHRG = (
		CASE 
			WHEN C.OTHER_CHRG = 1
				THEN F.OTHER_CHRG
			ELSE 0
			END
		),
	INS_CHRG = (
		CASE 
			WHEN INSURANCE_CHRG = 1
				THEN INS_CHRG
			ELSE 0
			END
		),
	SERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN SERVICE_TAX
			ELSE 0
			END
		),
	NSERTAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN SERVICE_TAX
			ELSE 0
			END
		),
	BROKERAGE = ISNULL(TRADEQTY * BROKAPPLIED, 0) + (
		CASE 
			WHEN SERVICE_CHRG = 1
				THEN SERVICE_TAX
			ELSE 0
			END
		),
	C.BRANCH_CD,
	C.SUB_BROKER,
	C.TRADER,
	PRINTF,
	C.SERVICE_CHRG,
	PARTYNAME = LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	PAN_GIR_NO,
	OFF_PHONE1,
	OFF_PHONE2,
	MAPIDID,
	SEBI_NO
INTO #CONTSETT
FROM #FOSETT F,
	#CLIENTMASTER C
WHERE F.PARTY_CODE >= @FROMPARTY_CODE
	AND F.PARTY_CODE <= @TOPARTY_CODE
	AND CONTRACTNO BETWEEN @FROMCONTRACTNO
		AND @TOCONTRACTNO
	AND F.PARTY_CODE = C.PARTY_CODE

UPDATE #CONTSETT
SET BROKERAGE = CASE 
		WHEN SELL_BUY = 1
			THEN CD_TOT_BUYBROK
		ELSE CD_TOT_SELLBROK
		END + (
		CASE 
			WHEN SERVICE_CHRG = 1
				THEN CASE 
						WHEN SELL_BUY = 1
							THEN CD_TOT_BUYSERTAX
						ELSE CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	SERVICE_TAX = SERVICE_TAX + (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CASE 
						WHEN SELL_BUY = 1
							THEN CD_TOT_BUYSERTAX
						ELSE CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	NSERTAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CASE 
						WHEN SELL_BUY = 1
							THEN CD_TOT_BUYSERTAX
						ELSE CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	PSERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CASE 
						WHEN SELL_BUY = 1
							THEN SERVICE_TAX + CD_TOT_BUYSERTAX
						ELSE 0
						END
			ELSE 0
			END
		),
	SSERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CASE 
						WHEN SELL_BUY = 1
							THEN 0
						ELSE SERVICE_TAX + CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	PAMT = (
		CASE 
			WHEN SELL_BUY = 1
				THEN (PQTY * PRATE) + CD_TOT_BUYBROK + (
						CASE 
							WHEN SERVICE_CHRG = 1
								THEN SERVICE_TAX + ISNULL((CD_TOT_BUYSERTAX), 0)
							ELSE 0
							END
						)
			ELSE 0
			END
		),
	SAMT = (
		CASE 
			WHEN SELL_BUY = 2
				THEN (SQTY * SRATE) - CD_TOT_SELLBROK - (
						CASE 
							WHEN SERVICE_CHRG = 1
								THEN SERVICE_TAX + ISNULL((CD_TOT_SELLSERTAX), 0)
							ELSE 0
							END
						)
			ELSE 0
			END
		)
FROM CHARGES_DETAIL
WHERE CONVERT(VARCHAR, CD_SAUDA_DATE, 103) = CONVERT(VARCHAR, SAUDA_DATE, 103)
	AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE
	AND CD_PRODUCT_TYPE = PRODUCT_TYPE
	AND CD_PRODUCT_CODE = PRODUCT_CODE
	AND CD_SERIES_ID = SERIES_ID
	AND CD_SERIES_CODE = SERIES_CODE
	AND CONVERT(VARCHAR, CD_EXPIRYDATE, 106) = EXPIRYDATE
	AND PRADNYA.DBO.REPLACETRADENO(CD_TRADE_NO) = TRADE_NO
	AND CD_ORDER_NO = ORDER_NO

INSERT INTO #CONTSETT
SELECT CD_ORDER_NO,
	ORDER_TIME = '',
	CD_TRADE_NO,
	TRADETIME = '',
	BILLNO = 1,
	PQTY = 0,
	SQTY = 0,
	PRATE = 0,
	SRATE = 0,
	PBROK = 0,
	SBROK = 0,
	PNETRATE = 0,
	SNETRATE = 0,
	AMOUNT = 0,
	CD_PRODUCT_TYPE,
	CD_PRODUCT_CODE,
	CD_SERIES_CODE = (
		CASE 
			WHEN CD_SERIES_CODE = ''
				THEN 'CONT BROK'
			ELSE CD_SERIES_CODE
			END
		),
	CD_SERIES_ID,
	PAMT = 0,
	SAMT = 0,
	(
		CASE 
			WHEN CD_SERIES_CODE = ''
				THEN ''
			ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRYDATE, 106), 11)
			END
		) AS EXPIRYDATE,
	CD_PARTY_CODE,
	SELL_BUY = 1,
	CD_CONTRACT_NO,
	CONVERT(VARCHAR, CD_SAUDA_DATE, 103) AS SAUDA_DATE,
	STRIKE_PRICE = 0,
	PSERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_BUYSERTAX
			ELSE 0
			END
		),
	SSERVICE_TAX = 0,
	YY = YEAR(CD_SAUDA_DATE),
	MM = MONTH(CD_SAUDA_DATE),
	DD = DAY(CD_SAUDA_DATE),
	DFLAG = 1,
	BROKER_CHRG = 0,
	TURN_TAX = 0,
	SEBI_TAX = 0,
	OTHER_CHRG = 0,
	INS_CHRG = 0,
	SERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_BUYSERTAX
			ELSE 0
			END
		),
	NSERTAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_BUYSERTAX
			ELSE 0
			END
		),
	BROKERAGE = CD_TOT_BUYBROK + (
		CASE 
			WHEN SERVICE_CHRG = 1
				THEN CD_TOT_BUYSERTAX
			ELSE 0
			END
		),
	C.BRANCH_CD,
	C.SUB_BROKER,
	C.TRADER,
	PRINTF,
	C.SERVICE_CHRG,
	PARTYNAME = LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	PAN_GIR_NO,
	OFF_PHONE1,
	OFF_PHONE2,
	MAPIDID,
	SEBI_NO
FROM CHARGES_DETAIL F,
	#CLIENTMASTER C
WHERE CD_SAUDA_DATE BETWEEN @SAUDA_DATE
		AND @TOSAUDA_DATE + ' 23:59:59'
	AND CD_PARTY_CODE >= '0'
	AND CD_PARTY_CODE <= 'ZZ'
	AND CD_CONTRACT_NO BETWEEN (
				CASE 
					WHEN RIGHT(CD_PRODUCT_CODE, 3) = 'OPT'
						AND CD_AUCTIONPART = 'EA'
						THEN 0
					ELSE '0'
					END
				)
		AND '9999'
	AND CD_PARTY_CODE = C.PARTY_CODE
	AND CD_TRADE_NO = ''
	AND CD_TOT_BUYBROK > 0

INSERT INTO #CONTSETT
SELECT CD_ORDER_NO,
	ORDER_TIME = '',
	CD_TRADE_NO,
	TRADETIME = '',
	BILLNO = 1,
	PQTY = 0,
	SQTY = 0,
	PRATE = 0,
	SRATE = 0,
	PBROK = 0,
	SBROK = 0,
	PNETRATE = 0,
	SNETRATE = 0,
	AMOUNT = 0,
	CD_PRODUCT_TYPE,
	CD_PRODUCT_CODE,
	CD_SERIES_CODE = (
		CASE 
			WHEN CD_SERIES_CODE = ''
				THEN 'CONT BROK'
			ELSE CD_SERIES_CODE
			END
		),
	CD_SERIES_ID,
	PAMT = 0,
	SAMT = 0,
	(
		CASE 
			WHEN CD_SERIES_CODE = ''
				THEN ''
			ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRYDATE, 106), 11)
			END
		) AS EXPIRYDATE,
	CD_PARTY_CODE,
	SELL_BUY = 1,
	CD_CONTRACT_NO,
	CONVERT(VARCHAR, CD_SAUDA_DATE, 103) AS SAUDA_DATE,
	STRIKE_PRICE = 0,
	PSERVICE_TAX = 0,
	SSERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_SELLSERTAX
			ELSE 0
			END
		),
	YY = YEAR(CD_SAUDA_DATE),
	MM = MONTH(CD_SAUDA_DATE),
	DD = DAY(CD_SAUDA_DATE),
	DFLAG = 1,
	BROKER_CHRG = 0,
	TURN_TAX = 0,
	SEBI_TAX = 0,
	OTHER_CHRG = 0,
	INS_CHRG = 0,
	SERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_SELLSERTAX
			ELSE 0
			END
		),
	NSERTAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_SELLSERTAX
			ELSE 0
			END
		),
	BROKERAGE = CD_TOT_SELLBROK + (
		CASE 
			WHEN SERVICE_CHRG = 1
				THEN CD_TOT_SELLSERTAX
			ELSE 0
			END
		),
	C.BRANCH_CD,
	C.SUB_BROKER,
	C.TRADER,
	PRINTF,
	C.SERVICE_CHRG,
	PARTYNAME = LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	PAN_GIR_NO,
	OFF_PHONE1,
	OFF_PHONE2,
	MAPIDID,
	SEBI_NO
FROM CHARGES_DETAIL F,
	#CLIENTMASTER C
WHERE CD_SAUDA_DATE BETWEEN @SAUDA_DATE
		AND @TOSAUDA_DATE + ' 23:59:59'
	AND CD_PARTY_CODE >= '0'
	AND CD_PARTY_CODE <= 'ZZ'
	AND CD_CONTRACT_NO BETWEEN (
				CASE 
					WHEN RIGHT(CD_PRODUCT_CODE, 3) = 'OPT'
						AND CD_AUCTIONPART = 'EA'
						THEN 0
					ELSE '0'
					END
				)
		AND '9999'
	AND CD_PARTY_CODE = C.PARTY_CODE
	AND CD_TRADE_NO = ''
	AND CD_TOT_SELLBROK > 0

UPDATE #CONTSETT
SET PARTY_CODE = ISNULL(C.PARENTCODE, C.PARTY_CODE)
FROM #CLIENTMASTER C
WHERE C.PARTY_CODE = #CONTSETT.PARTY_CODE

SELECT ORDER_NO = REPLICATE('0',20),
	ORDER_TIME = '                ',
	TRADE_NO = '0000000000000000',
	TRADETIME = '0000000000000000',
	BILLNO,
	PQTY = SUM(PQTY),
	SQTY = SUM(SQTY),
	PRATE = (
		CASE 
			WHEN SUM(PQTY) > 0
				THEN SUM(PRATE * PQTY) / SUM(PQTY)
			ELSE 0
			END
		),
	SRATE = (
		CASE 
			WHEN SUM(SQTY) > 0
				THEN SUM(SRATE * SQTY) / SUM(SQTY)
			ELSE 0
			END
		),
	PBROK = (
		CASE 
			WHEN SUM(PQTY) > 0
				THEN SUM(PBROK * PQTY) / SUM(PQTY)
			ELSE 0
			END
		),
	SBROK = (
		CASE 
			WHEN SUM(SQTY) > 0
				THEN SUM(SBROK * SQTY) / SUM(SQTY)
			ELSE 0
			END
		),
	PNETRATE = (
		CASE 
			WHEN SUM(PQTY) > 0
				THEN SUM(PNETRATE * PQTY) / SUM(PQTY)
			ELSE 0
			END
		),
	SNETRATE = (
		CASE 
			WHEN SUM(SQTY) > 0
				THEN SUM(SNETRATE * SQTY) / SUM(SQTY)
			ELSE 0
			END
		),
	AMOUNT = SUM(AMOUNT),
	PRODUCT_TYPE,
	PRODUCT_CODE,
	SERIES_CODE,
	SERIES_ID,
	PAMT = SUM(PAMT),
	SAMT = SUM(SAMT),
	EXPIRYDATE,
	PARTY_CODE,
	SELL_BUY,
	CONTRACTNO,
	SAUDA_DATE = LEFT(CONVERT(VARCHAR, SAUDA_DATE, 109), 11),
	STRIKE_PRICE,
	PSERVICE_TAX = SUM(PSERVICE_TAX),
	SSERVICE_TAX = SUM(SSERVICE_TAX),
	YY,
	MM,
	DD,
	DFLAG,
	BROKER_CHRG = SUM(BROKER_CHRG),
	TURN_TAX = SUM(TURN_TAX),
	SEBI_TAX = SUM(SEBI_TAX),
	OTHER_CHRG = SUM(OTHER_CHRG),
	INS_CHRG = SUM(INS_CHRG),
	SERVICE_TAX = SUM(SERVICE_TAX),
	NSERTAX = SUM(NSERTAX),
	BROKERAGE = SUM(BROKERAGE),
	BRANCH_CD,
	SUB_BROKER,
	TRADER,
	PRINTF,
	SERVICE_CHRG,
	PARTYNAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	PAN_GIR_NO,
	OFF_PHONE1,
	OFF_PHONE2,
	MAPIDID,
	SEBI_NO,
	 NETAMOUNT = CONVERT(NUMERIC(18,4),0)
INTO #CONTSETTNEW
FROM #CONTSETT
WHERE PRINTF IN (
		'3',
		'4',
		'6'
		)
GROUP BY PRODUCT_TYPE,
	PRODUCT_CODE,
	SERIES_CODE,
	SERIES_ID,
	EXPIRYDATE,
	PARTY_CODE,
	SELL_BUY,
	CONTRACTNO,
	STRIKE_PRICE,
	LEFT(CONVERT(VARCHAR, SAUDA_DATE, 109), 11),
	YY,
	MM,
	DD,
	DFLAG,
	BRANCH_CD,
	SUB_BROKER,
	TRADER,
	PRINTF,
	SERVICE_CHRG,
	PARTYNAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	PAN_GIR_NO,
	OFF_PHONE1,
	OFF_PHONE2,
	MAPIDID,
	SEBI_NO,
	BILLNO

INSERT INTO #CONTSETTNEW
SELECT *,
NETAMOUNT = CONVERT(NUMERIC(18,4),0)
FROM #CONTSETT WITH (NOLOCK)
WHERE PRINTF NOT IN (
		'3',
		'4',
		'6'
		)

UPDATE #CONTSETTNEW
SET ORDER_NO = S.ORDER_NO,
	ORDER_TIME = S.ORDER_TIME,
	TRADETIME = S.TRADETIME,
	TRADE_NO = S.TRADE_NO
FROM #CONTSETT S WITH (NOLOCK)
WHERE S.PRINTF = #CONTSETTNEW.PRINTF
	AND S.PRINTF IN (
		'3',
		'4',
		'6'
		)
	AND S.PARTY_CODE = #CONTSETTNEW.PARTY_CODE
	AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE
	AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE
	AND S.SERIES_CODE = #CONTSETTNEW.SERIES_CODE
	AND S.SERIES_ID = #CONTSETTNEW.SERIES_ID
	AND S.EXPIRYDATE = #CONTSETTNEW.EXPIRYDATE
	AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE
	AND S.SELL_BUY = #CONTSETTNEW.SELL_BUY
	AND S.SAUDA_DATE = (
		SELECT MIN(SAUDA_DATE)
		FROM #CONTSETT ISETT WITH (NOLOCK)
		WHERE PRINTF IN (
				'3',
				'4',
				'6'
				)
			AND S.PARTY_CODE = ISETT.PARTY_CODE
			AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE
			AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE
			AND S.SERIES_CODE = ISETT.SERIES_CODE
			AND S.SERIES_ID = ISETT.SERIES_ID
			AND S.EXPIRYDATE = ISETT.EXPIRYDATE
			AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE
			AND S.SELL_BUY = ISETT.SELL_BUY
		)
		
		
UPDATE #CONTSETTNEW 
SET NETAMOUNT = ISNULL(A.NETAMOUNT1,0)
FROM	
	(
	SELECT
		SAUDA_DATE = LEFT(SAUDA_DATE,11),
		PARTY_CODE,
		--SETT_TYPE,
		NETAMOUNT =	SUM(
		CASE
			WHEN SELL_BUY = 1 THEN PAMT+(NSERTAX+INS_CHRG+BROKER_CHRG+TURN_TAX+SEBI_TAX+OTHER_CHRG)
			ELSE SAMT-(NSERTAX+INS_CHRG+BROKER_CHRG+TURN_TAX+SEBI_TAX+OTHER_CHRG)
		END),
		NETAMOUNT1 = SUM(PAMT-SAMT)+SUM(NSERTAX+INS_CHRG+BROKER_CHRG+TURN_TAX+SEBI_TAX+OTHER_CHRG)		
	FROM
		#CONTSETTNEW			
	GROUP BY
		LEFT(SAUDA_DATE,11),
		PARTY_CODE
		--SETT_TYPE
	) A	
WHERE
	A.PARTY_CODE =	#CONTSETTNEW.PARTY_CODE
	AND LEFT(A.SAUDA_DATE,11) =	LEFT(#CONTSETTNEW.SAUDA_DATE,11)
	--AND A.SETT_TYPE = #CONTSETTNEW.SETT_TYPE

 
		
DECLARE @CHARGES INT
SET @CHARGES = 0     


IF (@CONTFLAG = 'CONTRACT')
BEGIN
	SELECT ORDER_NO,
		ORDER_TIME,
		TRADE_NO,
		TM = TRADETIME,
		QTY = PQTY + SQTY,
		LOTSIZE = BILLNO,
		BUYSELL = CASE 
			WHEN PQTY > 0
				THEN 'BUY'
			ELSE 'SELL'
			END,
		PQTY,
		SQTY,
		RATE = PRATE + SRATE,
		PRATE,
		SRATE,
		BROK = PBROK + SBROK,
		PBROK,
		SBROK,
		NETRATE = PNETRATE + SNETRATE,
		PNETRATE,
		SNETRATE,
		AMOUNT,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		SERIESCODE = SERIES_CODE,
		SERIES_CODE,
		SERIES_ID,
		CONTRACTDESC = PRODUCT_TYPE + ' ' + PRODUCT_CODE + ' ' + SERIES_CODE + ' ' + CONVERT(VARCHAR, SERIES_ID),
		NOOFCONTRACT = (PQTY + SQTY) / (
			CASE 
				WHEN BILLNO = 0
					THEN 1
				ELSE BILLNO
				END
			),
		AMT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - PAMT
				ELSE SAMT
				END
			),
		PAMT,
		SAMT,
		AMTSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - (PAMT + INS_CHRG)
				ELSE (SAMT - INS_CHRG)
				END
			),
		PAMTSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN PAMT + INS_CHRG
				ELSE 0
				END
			),
		SAMTSTT = (
			CASE 
				WHEN SELL_BUY = 2
					THEN SAMT - INS_CHRG
				ELSE 0
				END
			),
		AMTSERSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - (PAMT + INS_CHRG + SERVICE_TAX)
				ELSE (SAMT - INS_CHRG - SERVICE_TAX)
				END
			),
		PAMTSERSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN (PAMT + INS_CHRG + SERVICE_TAX)
				ELSE 0
				END
			),
		SAMTSERSTT = (
			CASE 
				WHEN SELL_BUY = 2
					THEN (SAMT - INS_CHRG - SERVICE_TAX)
				ELSE 0
				END
			),
		EXPIRYDATE,
		PARTY_CODE,
		SELL_BUY,
		CONTRACTNO,
		SAUDA_DATE,
		SDT = SAUDA_DATE,
		STRIKE_PRICE,
		PSERVICE_TAX,
		SSERVICE_TAX,
		YY,
		MM,
		DD,
		DFLAG,
		BROKER_CHRG,
		TURN_TAX,
		SEBI_TAX,
		OTHER_CHRG,
		PINS_CHRG = (
			CASE 
				WHEN SELL_BUY = 1
					THEN INS_CHRG
				ELSE 0
				END
			),
		SINS_CHRG = (
			CASE 
				WHEN SELL_BUY = 2
					THEN INS_CHRG
				ELSE 0
				END
			),
		INS_CHRG,
		SERVICE_TAX,
		NSERTAX,
		BROKERAGE,
		PBROKERAGE = (
			CASE 
				WHEN SELL_BUY = 1
					THEN BROKERAGE
				ELSE 0
				END
			),
		SBROKERAGE = (
			CASE 
				WHEN SELL_BUY = 2
					THEN BROKERAGE
				ELSE 0
				END
			),
		BRANCH_CD,
		SUB_BROKER,
		TRADER,
		PRINTF,
		SERVICE_CHRG,
		PARTYNAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_STATE,
		L_ZIP,
		SEBI_NO,
		PAN_GIR_NO,
		OFF_PHONE1,
		OFF_PHONE2,
		MAPIDID,
		MARKETAMT = (PRATE + SRATE) * (PQTY + SQTY),
		PMARKETAMT = PRATE * PQTY,
		SMARKETAMT = SRATE * SQTY,
		SERIES = '',
		TMARK = '',
		SCRIPNAME = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108),
		PSCRIPNAME = (
			CASE 
				WHEN SELL_BUY = 1
					THEN RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108)
				ELSE ''
				END
			),
		SSCRIPNAME = (
			CASE 
				WHEN SELL_BUY = 2
					THEN RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108)
				ELSE ''
				END
			),
		SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108),
		NETAMOUNT, 
		AMOUNTINWORD = DBO.CONVERTINTOINDIANCURENG(ROUND(ABS(NETAMOUNT),2)) ,
		ROW_P_COUNT = CONVERT(NUMERIC(18,0),0),      
		ROW_S_COUNT = CONVERT(NUMERIC(18,0),0)
		 
	INTO    #CONTRACT               
	FROM #CONTSETTNEW WITH (NOLOCK)
	WHERE PRINTF <> 1
	ORDER BY BRANCH_CD,
		SUB_BROKER,
		TRADER,
		PARTY_CODE,
		CONTRACTNO DESC,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		SERIES_CODE,
		SERIES_ID,
		EXPIRYDATE,
		STRIKE_PRICE,
		ORDER_NO,
		TRADE_NO
		
		SELECT     
  PARTY_CODE,    
  PARTY_COUNT = COUNT(PARTY_CODE),    
  SCRIP_COUNT = COUNT(DISTINCT(SCRIPNAME)) + @CHARGES + (CASE WHEN SUM(SERVICE_TAX) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(INS_CHRG) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(TURN_TAX) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(SEBI_TAX) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(OTHER_CHRG) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(BROKER_CHRG)> 0 THEN 1 ELSE 0 END)
					+ 3
 INTO				
  #ROWCOUNT    
 FROM    
  #CONTRACT    
 GROUP BY    
  PARTY_CODE    
 ORDER BY    
  1  

 

  
UPDATE #CONTRACT SET    
  ROW_P_COUNT = PARTY_COUNT,      
  ROW_S_COUNT = SCRIP_COUNT     
 FROM    
  #ROWCOUNT     
 WHERE    
  #ROWCOUNT.PARTY_CODE = #CONTRACT.PARTY_CODE     
   
  
SELECT  *  FROM #CONTRACT 
ORDER BY BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        STRIKE_PRICE,       
        ORDER_NO,       
        TRADE_NO   

END
ELSE
BEGIN
	SELECT ORDER_NO,
		ORDER_TIME,
		TRADE_NO,
		TM = TRADETIME,
		QTY = PQTY + SQTY,
		LOTSIZE = BILLNO,
		BUYSELL = CASE 
			WHEN PQTY > 0
				THEN 'BUY'
			ELSE 'SELL'
			END,
		PQTY,
		SQTY,
		RATE = PRATE + SRATE,
		PRATE,
		SRATE,
		BROK = PBROK + SBROK,
		PBROK,
		SBROK,
		NETRATE = PNETRATE + SNETRATE,
		PNETRATE,
		SNETRATE,
		AMOUNT,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		SERIESCODE = SERIES_CODE,
		SERIES_CODE,
		SERIES_ID,
		CONTRACTDESC = PRODUCT_TYPE + ' ' + PRODUCT_CODE + ' ' + SERIES_CODE + ' ' + CONVERT(VARCHAR, SERIES_ID),
		NOOFCONTRACT = (PQTY + SQTY) / (
			CASE 
				WHEN BILLNO = 0
					THEN 1
				ELSE BILLNO
				END
			),
		AMT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - PAMT
				ELSE SAMT
				END
			),
		PAMT,
		SAMT,
		AMTSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - (PAMT + INS_CHRG)
				ELSE (SAMT - INS_CHRG)
				END
			),
		PAMTSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN PAMT + INS_CHRG
				ELSE 0
				END
			),
		SAMTSTT = (
			CASE 
				WHEN SELL_BUY = 2
					THEN SAMT - INS_CHRG
				ELSE 0
				END
			),
		AMTSERSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - (PAMT + INS_CHRG + SERVICE_TAX)
				ELSE (SAMT - INS_CHRG - SERVICE_TAX)
				END
			),
		PAMTSERSTT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN (PAMT + INS_CHRG + SERVICE_TAX)
				ELSE 0
				END
			),
		SAMTSERSTT = (
			CASE 
				WHEN SELL_BUY = 2
					THEN (SAMT - INS_CHRG - SERVICE_TAX)
				ELSE 0
				END
			),
		EXPIRYDATE,
		PARTY_CODE,
		SELL_BUY,
		CONTRACTNO,
		SAUDA_DATE,
		SDT = SAUDA_DATE,
		STRIKE_PRICE,
		PSERVICE_TAX,
		SSERVICE_TAX,
		YY,
		MM,
		DD,
		DFLAG,
		BROKER_CHRG,
		TURN_TAX,
		SEBI_TAX,
		OTHER_CHRG,
		PINS_CHRG = (
			CASE 
				WHEN SELL_BUY = 1
					THEN INS_CHRG
				ELSE 0
				END
			),
		SINS_CHRG = (
			CASE 
				WHEN SELL_BUY = 2
					THEN INS_CHRG
				ELSE 0
				END
			),
		INS_CHRG,
		SERVICE_TAX,
		NSERTAX,
		BROKERAGE,
		PBROKERAGE = (
			CASE 
				WHEN SELL_BUY = 1
					THEN BROKERAGE
				ELSE 0
				END
			),
		SBROKERAGE = (
			CASE 
				WHEN SELL_BUY = 2
					THEN BROKERAGE
				ELSE 0
				END
			),
		BRANCH_CD,
		SUB_BROKER,
		TRADER,
		PRINTF,
		SERVICE_CHRG,
		PARTYNAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_STATE,
		L_ZIP,
		SEBI_NO,
		PAN_GIR_NO,
		OFF_PHONE1,
		OFF_PHONE2,
		MAPIDID,
		MARKETAMT = (PRATE + SRATE) * (PQTY + SQTY),
		PMARKETAMT = PRATE * PQTY,
		SMARKETAMT = SRATE * SQTY,
		SERIES = '',
		TMARK = '',
		SCRIPNAME = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108),
		PSCRIPNAME = (
			CASE 
				WHEN SELL_BUY = 1
					THEN RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108)
				ELSE ''
				END
			),
		SSCRIPNAME = (
			CASE 
				WHEN SELL_BUY = 2
					THEN RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108)
				ELSE ''
				END
			),
		SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR, SERIES_ID, 108),
		NETAMOUNT, 
		AMOUNTINWORD = DBO.CONVERTINTOINDIANCURENG(ROUND(ABS(NETAMOUNT),2)) ,
ROW_P_COUNT = CONVERT(NUMERIC(18,0),0),      
ROW_S_COUNT = CONVERT(NUMERIC(18,0),0)
INTO    #CONTRACT1          
	FROM #CONTSETTNEW WITH (NOLOCK)
	ORDER BY BRANCH_CD,
		SUB_BROKER,
		TRADER,
		PARTY_CODE,
		CONTRACTNO DESC,
		PRODUCT_TYPE,
		PRODUCT_CODE,
		SERIES_CODE,
		SERIES_ID,
		EXPIRYDATE,
		STRIKE_PRICE,
		ORDER_NO,
		TRADE_NO
		
		SELECT     
  PARTY_CODE,    
  PARTY_COUNT = COUNT(PARTY_CODE),    
  SCRIP_COUNT = COUNT(DISTINCT(SCRIPNAME)) + @CHARGES + (CASE WHEN SUM(SERVICE_TAX) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(INS_CHRG) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(TURN_TAX) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(SEBI_TAX) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(OTHER_CHRG) > 0 THEN 1 ELSE 0 END)
					+ (CASE WHEN SUM(BROKER_CHRG)> 0 THEN 1 ELSE 0 END)
					+ 3
 INTO				
  #ROWCOUNT1    
 FROM    
  #CONTRACT1    
 GROUP BY    
  PARTY_CODE    
 ORDER BY    
  1  

 

  
UPDATE #CONTRACT1 SET    
  ROW_P_COUNT = PARTY_COUNT,      
  ROW_S_COUNT = SCRIP_COUNT     
 FROM    
  #ROWCOUNT1     
 WHERE    
  #ROWCOUNT1.PARTY_CODE = #CONTRACT1.PARTY_CODE     
   
  
SELECT  *  FROM #CONTRACT1
ORDER BY BRANCH_CD,       
  SUB_BROKER,       
  TRADER,       
  PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  EXPIRYDATE,       
  STRIKE_PRICE,  
  ORDER_NO,  
  TRADE_NO   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_06122012
-- --------------------------------------------------
    
CREATE PROCEDURE  [dbo].[V2_CONTSECTION_06122012]         
 (         
   @STATUSID VARCHAR(15),         
   @STATUSNAME VARCHAR(25),         
   @SAUDA_DATE VARCHAR(11),         
   @FROMPARTY_CODE VARCHAR(10),         
   @TOPARTY_CODE VARCHAR(10),         
   @BRANCH VARCHAR(10),         
   @SUB_BROKER VARCHAR(10),         
   @FROMCONTRACTNO VARCHAR(12),         
   @TOCONTRACTNO VARCHAR(12),         
   @CONTFLAG VARCHAR(10),    
   @TOSAUDA_DATE VARCHAR(11) = '',    
   @BOUNCEDFLAG INT = 0    
 )         
         
 AS         
     
 --EXEC V2_CONTSECTION 'BROKER','BROKER','MAY 24 2005','','ZZZZZZZZZZZ','%','%','0','99999999999','CONTRACT','MAY 24 2012',0    
     
 DECLARE @_STATUS CHAR(1)    
    
 IF @SUB_BROKER = 'ALL' OR @SUB_BROKER = ''         
 BEGIN         
  SET @SUB_BROKER = '%'         
 END         
 IF @BRANCH = 'ALL' OR @BRANCH = ''         
 BEGIN         
         SET @BRANCH = '%'         
 END         
 IF @FROMCONTRACTNO = ''        
 BEGIN        
  SET @FROMCONTRACTNO = 000000        
 END        
         
 IF @TOCONTRACTNO = ''        
 BEGIN        
  SET @TOCONTRACTNO = 99999999        
 END     
     
 IF @TOSAUDA_DATE = ''    
 BEGIN    
 SET @TOSAUDA_DATE = @SAUDA_DATE    
 END      
      
/*------------------  CANNED CONTRACT PLUG IN ------------------------*/        
IF EXISTS (SELECT TOP 1 PARTY_CODE FROM CONTRACT_DATA (NOLOCK) WHERE SAUDA_DATE >= @SAUDA_DATE)    
BEGIN        
 EXEC V2_CONTSECTION_DETAIL @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@BRANCH,@SUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@TOSAUDA_DATE,@BOUNCEDFLAG,@_STATUS OUTPUT        
 IF  @_STATUS =1        
 RETURN        
END    
    
    
    
/*---------------------------------------------------------------------*/        
      
    
 CREATE TABLE #BPARTY    
 (     
 PARTY_CODE VARCHAR(15)     
 )    
    
 IF @BOUNCEDFLAG <> 0    
 BEGIN    
  INSERT INTO #BPARTY    
  SELECT     
   DISTINCT PARTY_CODE     
  FROM     
   TBL_ECNBOUNCED(NOLOCK)     
  WHERE     
   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'    
 END    
 ELSE    
 BEGIN    
  INSERT INTO #BPARTY    
  SELECT     
   DISTINCT PARTY_CODE     
  FROM     
   CLIENT2 (NOLOCK)     
  WHERE     
   PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE    
 END    
      
SELECT  C2.PARTY_CODE,         
        C1.LONG_NAME,         
        C1.L_ADDRESS1,         
        C1.L_ADDRESS2,         
        C1.L_ADDRESS3,         
        C1.L_CITY,         
        C1.L_STATE,         
        C1.L_ZIP,         
        C1.BRANCH_CD ,         
        C1.SUB_BROKER,         
        C1.TRADER,         
        C1.PAN_GIR_NO,         
        C1.OFF_PHONE1,         
        C1.OFF_PHONE2,         
        PRINTF,         
        MAPIDID,         
        C2.SERVICE_CHRG,         
        BROKERNOTE,         
        TURNOVER_TAX,         
        SEBI_TURN_TAX,         
        C2.OTHER_CHRG,         
        INSURANCE_CHRG,        
  SEBI_NO = FD_CODE        
INTO    #CLIENTMASTER         
FROM        
  CLIENT1 C1         
WITH         
        (         
                NOLOCK         
        )         
        ,         
        CLIENT2 C2         
WITH         
        (         
                NOLOCK         
        )         
  LEFT OUTER JOIN UCC_CLIENT UC         
WITH         
        (         
                NOLOCK         
        )         
        ON C2.PARTY_CODE = UC.PARTY_CODE         
  --CLIENT_PRINT_SETTINGS  CP (NOLOCK) ,    
WHERE   C2.CL_CODE       = C1.CL_CODE         
        AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE    
        AND Cl_Type <> 'INS'                 
        AND @STATUSNAME = (         
        CASE         
                WHEN @STATUSID = 'BRANCH'         
                THEN C1.BRANCH_CD         
                WHEN @STATUSID = 'SUBBROKER'         
                THEN C1.SUB_BROKER         
                WHEN @STATUSID = 'TRADER'         
                THEN C1.TRADER         
                WHEN @STATUSID = 'FAMILY'         
                THEN C1.FAMILY         
     WHEN @STATUSID = 'AREA'         
                THEN C1.AREA         
                WHEN @STATUSID = 'REGION'         
                THEN C1.REGION         
                WHEN @STATUSID = 'CLIENT'         
                THEN C2.PARTY_CODE         
                ELSE 'BROKER' END)      
        AND BRANCH_CD = CASE WHEN @BRANCH  ='%' THEN BRANCH_CD ELSE @BRANCH END    
        AND SUB_BROKER = CASE WHEN @SUB_BROKER  ='%' THEN SUB_BROKER ELSE @SUB_BROKER END          
        --AND PRINTF =  CP.PRINT_FLAG    
  --AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'    
  AND C2.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))    
     
    
SELECT  CONTRACTNO,         
        BILLNO=LOT_SIZE,         
        TRADE_NO,         
        PARTY_CODE,        
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
  MARKETRATE=TRADE_PRICE,         
        EXPIRYDATE,         
        STRIKE_PRICE,         
        USER_ID=TERMINALID,         
        PRO_CLI,         
        TRADEQTY,         
        AUCTIONPART,         
        MARKETTYPE=OPTION_TYPE,         
        ORDER_NO,         
        SAUDA_DATE,         
        TABLE_NO,         
        LINE_NO,         
  VAL_PERC,         
        NORMAL,         
        DAY_PUC,         
        DAY_SALES,         
        SETT_PURCH,         
        SETT_SALES,     
        SELL_BUY,         
        SETTFLAG,         
        BROKAPPLIED,         
        NETRATE,         
        AMOUNT=TRADE_AMOUNT,         
        INS_CHRG,         
        TURN_TAX,         
        OTHER_CHRG,         
        SEBI_TAX,         
        BROKER_CHRG,         
        SERVICE_TAX,         
        TRADE_AMOUNT,         
        PARTICIPANTCODE,         
        STATUS,         
        ORDER_DATE=ORDER_TIMESTAMP,         
        DUMMY1,         
        DUMMY2,         
        RESERVED1         
INTO    #FOSETT         
FROM    BFOSETTLEMENT         
WHERE   1 = 2         
INSERT         
INTO    #FOSETT         
SELECT  CONTRACTNO,         
        BILLNO=LOT_SIZE,         
        TRADE_NO,         
        PARTY_CODE,         
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
  MARKETRATE=TRADE_PRICE,         
        EXPIRYDATE,         
        STRIKE_PRICE,         
        USER_ID=TERMINALID,         
        PRO_CLI,         
        TRADEQTY,         
        AUCTIONPART,         
        MARKETTYPE=OPTION_TYPE,         
        ORDER_NO,         
  SAUDA_DATE,         
        TABLE_NO,         
        LINE_NO,         
        VAL_PERC,         
        NORMAL,         
        DAY_PUC,         
        DAY_SALES,         
        SETT_PURCH,         
        SETT_SALES,         
        SELL_BUY,         
        SETTFLAG,         
        BROKAPPLIED,         
        NETRATE,         
        AMOUNT=TRADE_AMOUNT,         
        INS_CHRG,         
        TURN_TAX,         
        OTHER_CHRG,         
        SEBI_TAX,         
        BROKER_CHRG,         
        SERVICE_TAX,         
        TRADE_AMOUNT,         
        PARTICIPANTCODE,         
        STATUS,         
        ORDER_DATE=ORDER_TIMESTAMP,         
        DUMMY1,         
        DUMMY2,         
        RESERVED1    
FROM    BFOSETTLEMENT         
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'    
        AND PARTY_CODE >= @FROMPARTY_CODE         
        AND PARTY_CODE <= @TOPARTY_CODE         
        AND AUCTIONPART NOT IN ('CA')         
        AND TRADEQTY <> 0         
        AND TRADE_PRICE > 0         
        AND RESERVED1 = 0         
        
CREATE  INDEX [DELPOS]         
        ON [DBO].[#FOSETT]         
        (         
                [PARTY_CODE]         
        )         
        
SELECT  ORDER_NO,         
        ORDER_TIME = RIGHT(ORDER_DATE,8),         
        TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),         
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,         
  BILLNO,    
        PQTY = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN TRADEQTY         
                ELSE 0 END),         
        SQTY = (         
        CASE         
                WHEN SELL_BUY = 2         
                THEN TRADEQTY         
                ELSE 0 END),         
        PRATE = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN ISNULL(MARKETRATE,0)         
                ELSE 0 END),         
        SRATE = (         
        CASE         
                WHEN SELL_BUY = 2         
                THEN ISNULL(MARKETRATE,0)         
             ELSE 0 END),         
        PBROK =(         
    CASE         
                WHEN SELL_BUY = 1         
                THEN ISNULL((BROKAPPLIED + (         
                CASE         
                        WHEN C.SERVICE_CHRG=1         
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)         
                        ELSE 0 END )),0)         
    ELSE 0 END),         
        SBROK =(         
        CASE         
                WHEN SELL_BUY = 2         
                THEN ISNULL((BROKAPPLIED + (         
                CASE         
                        WHEN C.SERVICE_CHRG=1         
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)         
                        ELSE 0 END )),0)         
                ELSE 0 END),         
        PNETRATE = (         
        CASE         
                WHEN SELL_BUY =1         
                THEN ISNULL(NETRATE + (         
                CASE         
                        WHEN C.SERVICE_CHRG = 1         
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)         
                        ELSE 0 END),0)         
                ELSE 0 END),         
        SNETRATE = (         
        CASE         
                WHEN SELL_BUY =2         
                THEN ISNULL(NETRATE - (         
                CASE         
                        WHEN C.SERVICE_CHRG = 1         
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)         
                        ELSE 0 END),0)         
                ELSE 0 END),         
        ISNULL(AMOUNT,0) AMOUNT ,         
        PRODUCT_TYPE= (         
        CASE         
                WHEN F.AUCTIONPART = 'EA'         
                THEN STUFF(PRODUCT_TYPE,1,3,'EA-')         
                ELSE PRODUCT_TYPE END),         
  PRODUCT_CODE = (         
        CASE         
                WHEN F.AUCTIONPART = 'EA'         
                THEN STUFF(PRODUCT_CODE,1,3,'EA-')         
                ELSE PRODUCT_CODE END),        
  SERIES_CODE,        
  SERIES_ID,        
        PAMT=(         
        CASE         
                WHEN SELL_BUY = 1         
                THEN (TRADEQTY * NETRATE) + (         
                CASE         
                        WHEN C.SERVICE_CHRG = 1         
                        THEN ISNULL((F.SERVICE_TAX),0)         
                        ELSE (         
                        CASE         
                                WHEN C.SERVICE_CHRG = 0         
                                THEN 0         
                                ELSE (         
                                CASE         
                                        WHEN C.SERVICE_CHRG = 2         
                                        THEN 0         
                                        ELSE 0 END) END ) END )         
                ELSE 0 END),         
        SAMT=(         
        CASE         
                WHEN SELL_BUY = 2         
                THEN(TRADEQTY * NETRATE) - (         
                CASE         
                        WHEN C.SERVICE_CHRG = 1         
                        THEN ISNULL((F.SERVICE_TAX),0)         
                        ELSE (         
                        CASE         
                                WHEN C.SERVICE_CHRG = 0         
                                THEN 0         
                                ELSE (         
                                CASE         
             WHEN C.SERVICE_CHRG = 2         
                                        THEN 0         
                                        ELSE 0 END ) END ) END)         
                ELSE 0 END),         
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,         
        F.PARTY_CODE,         
        SELL_BUY,         
        CONTRACTNO,         
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,         
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,         
        PSERVICE_TAX= (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN (         
                CASE         
                        WHEN C.SERVICE_CHRG=0         
                        THEN (F.SERVICE_TAX)         
     ELSE (         
                        CASE         
                              WHEN C.SERVICE_CHRG=1         
                                THEN 0         
                                ELSE (         
                                CASE         
                                        WHEN C.SERVICE_CHRG=2         
                                        THEN 0 END) END) END)         
                ELSE 0 END),         
        SSERVICE_TAX= (         
        CASE         
                WHEN SELL_BUY = 2         
                THEN (         
                CASE         
                        WHEN C.SERVICE_CHRG=0         
                        THEN (F.SERVICE_TAX)         
                        ELSE (         
                        CASE         
                                WHEN C.SERVICE_CHRG=1         
                                THEN 0         
                                ELSE (         
                                CASE         
                                        WHEN C.SERVICE_CHRG=2         
                                        THEN 0 END) END) END)         
                ELSE 0 END),         
        YY          =YEAR(SAUDA_DATE),         
        MM          =MONTH(SAUDA_DATE),         
        DD          =DAY(SAUDA_DATE),         
        DFLAG       = 1 ,         
        BROKER_CHRG = (         
        CASE         
                WHEN BROKERNOTE = 1         
                THEN BROKER_CHRG         
                ELSE 0 END ),         
        TURN_TAX = (         
        CASE         
                WHEN TURNOVER_TAX = 1         
                THEN TURN_TAX         
                ELSE 0 END),         
        SEBI_TAX = (         
        CASE         
                WHEN SEBI_TURN_TAX = 1         
                THEN SEBI_TAX         
                ELSE 0 END),         
        OTHER_CHRG = (         
        CASE         
                WHEN C.OTHER_CHRG = 1         
                THEN F.OTHER_CHRG         
                ELSE 0 END) ,         
        INS_CHRG = (         
        CASE         
                WHEN INSURANCE_CHRG = 1         
                THEN INS_CHRG         
                ELSE 0 END ),         
        SERVICE_TAX = (         
        CASE         
                WHEN SERVICE_CHRG = 0         
                THEN SERVICE_TAX         
                ELSE 0 END ),         
        NSERTAX = (         
        CASE         
                WHEN SERVICE_CHRG = 0         
                THEN SERVICE_TAX        
                ELSE 0 END ),         
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0) + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),    
        C.BRANCH_CD ,         
        C.SUB_BROKER,         
        C.TRADER,         
        PRINTF,           
        C.SERVICE_CHRG,           
        PARTYNAME=LONG_NAME,         
        L_ADDRESS1,         
        L_ADDRESS2,         
        L_ADDRESS3,         
        L_CITY,         
        L_STATE,         
        L_ZIP,         
        PAN_GIR_NO,         
        OFF_PHONE1,               
  OFF_PHONE2,           
        MAPIDID,        
  SEBI_NO        
INTO    #CONTSETT         
FROM    #FOSETT F,         
        #CLIENTMASTER C         
WHERE   F.PARTY_CODE     >= @FROMPARTY_CODE       
        AND F.PARTY_CODE <= @TOPARTY_CODE         
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO        
        AND F.PARTY_CODE=C.PARTY_CODE         
        
        
UPDATE           
 #CONTSETT          
SET          
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END          
      + (CASE WHEN SERVICE_CHRG = 1 THEN           
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END          
        ELSE 0 END),          
 SERVICE_TAX = SERVICE_TAX+(CASE WHEN SERVICE_CHRG = 0 THEN           
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END          
   ELSE 0 END),          
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN           
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END          
   ELSE 0 END),          
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN           
   CASE WHEN SELL_BUY =1 THEN SERVICE_TAX+CD_TOT_BUYSERTAX ELSE 0 END          
   ELSE 0 END),          
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN           
   CASE WHEN SELL_BUY =1 THEN 0 ELSE SERVICE_TAX+CD_TOT_SELLSERTAX END          
   ELSE 0 END),          
        PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK           
  + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)          
              ELSE 0 END),           
        SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK           
  - (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)          
              ELSE 0 END)          
FROM          
 CHARGES_DETAIL          
WHERE          
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)          
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE           
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE        
 AND CD_PRODUCT_CODE = PRODUCT_CODE        
 AND CD_SERIES_ID = SERIES_ID        
 AND CD_SERIES_CODE = SERIES_CODE        
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE          
 AND PRADNYA.DBO.REPLACETRADENO(CD_TRADE_NO) = TRADE_NO          
 AND CD_ORDER_NO = ORDER_NO          
          
        
INSERT INTO #CONTSETT          
SELECT  CD_ORDER_NO,           
 ORDER_TIME = '',           
 CD_TRADE_NO,           
 TRADETIME='',           
 BILLNO=1,    
 PQTY = 0,           
 SQTY = 0,           
 PRATE = 0,           
 SRATE = 0,           
 PBROK =0,           
 SBROK =0,           
 PNETRATE = 0,           
 SNETRATE = 0,           
 AMOUNT =0,           
 CD_PRODUCT_TYPE,           
 CD_PRODUCT_CODE,        
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),           
 CD_SERIES_ID,        
 PAMT=0,          
 SAMT=0,           
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE         
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,           
 CD_PARTY_CODE,          
 SELL_BUY = 1,           
 CD_CONTRACT_NO,           
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,           
 STRIKE_PRICE = 0 ,        
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN           
  CD_TOT_BUYSERTAX          
  ELSE 0 END),          
 SSERVICE_TAX = 0,          
 YY          =YEAR(CD_SAUDA_DATE),           
 MM          =MONTH(CD_SAUDA_DATE),           
 DD          =DAY(CD_SAUDA_DATE),           
 DFLAG       = 1 ,           
 BROKER_CHRG = 0,           
 TURN_TAX = 0,           
 SEBI_TAX = 0,           
 OTHER_CHRG = 0 ,           
 INS_CHRG = 0,           
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN           
  CD_TOT_BUYSERTAX           
  ELSE 0 END),          
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN           
  CD_TOT_BUYSERTAX           
  ELSE 0 END),          
 BROKERAGE = CD_TOT_BUYBROK           
  + (CASE WHEN SERVICE_CHRG = 1 THEN           
  CD_TOT_BUYSERTAX           
  ELSE 0 END),          
 C.BRANCH_CD ,           
 C.SUB_BROKER,           
 C.TRADER,           
 PRINTF,             
 C.SERVICE_CHRG,             
 PARTYNAME=LONG_NAME,           
 L_ADDRESS1,           
 L_ADDRESS2,           
 L_ADDRESS3,           
 L_CITY,           
 L_STATE,           
 L_ZIP,           
 PAN_GIR_NO,           
 OFF_PHONE1,           
 OFF_PHONE2,             
 MAPIDID,          
 SEBI_NO        
FROM    CHARGES_DETAIL F,           
        #CLIENTMASTER C           
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE +' 23:59:59'    
 AND CD_PARTY_CODE     >= '0'           
 AND CD_PARTY_CODE <= 'ZZ'           
 AND CD_CONTRACT_NO BETWEEN (           
 CASE           
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'           
         AND CD_AUCTIONPART ='EA'           
         THEN 0           
         ELSE '0' END)           
 AND '9999'           
 AND CD_PARTY_CODE=C.PARTY_CODE          
 AND CD_TRADE_NO = ''          
 AND CD_TOT_BUYBROK > 0          
          
INSERT INTO #CONTSETT          
SELECT  CD_ORDER_NO,           
 ORDER_TIME = '',           
 CD_TRADE_NO,           
 TRADETIME='',     
 BILLNO =1,     
 PQTY = 0,           
 SQTY = 0,           
 PRATE = 0,           
 SRATE = 0,           
 PBROK =0,           
 SBROK =0,           
 PNETRATE = 0,           
 SNETRATE = 0,           
 AMOUNT =0,           
 CD_PRODUCT_TYPE,           
 CD_PRODUCT_CODE,        
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),           
 CD_SERIES_ID,        
 PAMT=0,           
 SAMT=0,           
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE         
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,           
 CD_PARTY_CODE,          
 SELL_BUY = 1,           
 CD_CONTRACT_NO,           
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,           
 STRIKE_PRICE = 0 ,        
 PSERVICE_TAX = 0 ,          
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN           
  CD_TOT_SELLSERTAX          
  ELSE 0 END),          
 YY          =YEAR(CD_SAUDA_DATE),           
 MM          =MONTH(CD_SAUDA_DATE),           
 DD       =DAY(CD_SAUDA_DATE),           
 DFLAG       = 1 ,           
 BROKER_CHRG = 0,           
 TURN_TAX =0,           
 SEBI_TAX =0,           
 OTHER_CHRG = 0,           
 INS_CHRG = 0,           
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN           
  CD_TOT_SELLSERTAX           
  ELSE 0 END),          
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN           
  CD_TOT_SELLSERTAX           
  ELSE 0 END),          
 BROKERAGE = CD_TOT_SELLBROK           
  + (CASE WHEN SERVICE_CHRG = 1 THEN           
  CD_TOT_SELLSERTAX           
  ELSE 0 END),          
 C.BRANCH_CD ,           
 C.SUB_BROKER,           
 C.TRADER,           
 PRINTF,             
 C.SERVICE_CHRG,             
 PARTYNAME=LONG_NAME,           
 L_ADDRESS1,           
 L_ADDRESS2,           
 L_ADDRESS3,           
 L_CITY,           
 L_STATE,           
 L_ZIP,           
 PAN_GIR_NO,           
 OFF_PHONE1,           
 OFF_PHONE2,             
 MAPIDID,          
 SEBI_NO        
FROM    CHARGES_DETAIL F,           
        #CLIENTMASTER C           
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'    
 AND CD_PARTY_CODE     >= '0'           
 AND CD_PARTY_CODE <= 'ZZ'           
 AND CD_CONTRACT_NO BETWEEN (           
 CASE           
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'           
         AND CD_AUCTIONPART ='EA'           
         THEN 0           
         ELSE '0' END)           
 AND '9999'           
 AND CD_PARTY_CODE=C.PARTY_CODE          
 AND CD_TRADE_NO = ''          
 AND CD_TOT_SELLBROK > 0            
        
        
        
        
        
SELECT  ORDER_NO  ='0000000000000000',         
        ORDER_TIME      ='                ',         
        TRADE_NO        ='0000000000000000',         
        TRADETIME       ='0000000000000000',         
  BILLNO,    
        PQTY            =SUM(PQTY),         
        SQTY            =SUM(SQTY),         
        PRATE           =(         
        CASE         
                WHEN SUM(PQTY) > 0         
                THEN SUM(PRATE*PQTY)/SUM(PQTY)         
                ELSE 0 END),         
        SRATE=(         
        CASE         
                WHEN SUM(SQTY) > 0         
                THEN SUM(SRATE*SQTY)/SUM(SQTY)         
                ELSE 0 END ),         
        PBROK=(         
        CASE         
                WHEN SUM(PQTY) > 0         
                THEN SUM(PBROK*PQTY)/SUM(PQTY)         
                ELSE 0 END ),         
        SBROK=(         
        CASE         
                WHEN SUM(SQTY) > 0         
                THEN SUM(SBROK*SQTY)/SUM(SQTY)         
                ELSE 0 END ),         
        PNETRATE=(         
        CASE         
                WHEN SUM(PQTY) > 0         
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)         
                ELSE 0 END ),         
        SNETRATE=(         
        CASE         
                WHEN SUM(SQTY) > 0         
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)         
                ELSE 0 END ),         
        AMOUNT=SUM(AMOUNT),         
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
        PAMT=SUM(PAMT),         
        SAMT=SUM(SAMT),         
        EXPIRYDATE,         
        PARTY_CODE,         
        SELL_BUY,         
        CONTRACTNO,         
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),     
        STRIKE_PRICE,         
        PSERVICE_TAX=SUM(PSERVICE_TAX),         
        SSERVICE_TAX=SUM(SSERVICE_TAX),         
        YY,         
        MM,         
        DD,         
        DFLAG,         
        BROKER_CHRG = SUM(BROKER_CHRG),         
        TURN_TAX    = SUM(TURN_TAX),         
   SEBI_TAX    = SUM(SEBI_TAX),         
        OTHER_CHRG  = SUM(OTHER_CHRG) ,         
        INS_CHRG    = SUM(INS_CHRG),         
        SERVICE_TAX = SUM(SERVICE_TAX),         
        NSERTAX     = SUM(NSERTAX),         
        BROKERAGE   = SUM(BROKERAGE),         
        BRANCH_CD,         
        SUB_BROKER,         
        TRADER,         
        PRINTF,           
        SERVICE_CHRG,           
        PARTYNAME,         
        L_ADDRESS1,         
        L_ADDRESS2,         
        L_ADDRESS3,         
        L_CITY,         
        L_STATE,         
        L_ZIP,         
        PAN_GIR_NO,         
        OFF_PHONE1,         
        OFF_PHONE2,          
        MAPIDID,        
  SEBI_NO        
INTO    #CONTSETTNEW         
FROM    #CONTSETT         
WHERE   PRINTF = '3'         
GROUP BY PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
        EXPIRYDATE,         
        PARTY_CODE,         
        SELL_BUY,         
        CONTRACTNO,         
        STRIKE_PRICE,         
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),         
        YY,         
        MM,         
        DD,         
        DFLAG,         
        BRANCH_CD,         
        SUB_BROKER,         
        TRADER,         
        PRINTF,           
        SERVICE_CHRG,           
        PARTYNAME,         
        L_ADDRESS1,         
        L_ADDRESS2,         
        L_ADDRESS3,         
        L_CITY,         
        L_STATE,         
        L_ZIP,         
        PAN_GIR_NO,         
        OFF_PHONE1,         
        OFF_PHONE2,           
        MAPIDID,        
  SEBI_NO,BILLNO        
    
INSERT         
INTO    #CONTSETTNEW SELECT  *         
FROM    #CONTSETT         
WITH         
        (         
                NOLOCK         
        )         
WHERE   PRINTF <> '3'         
UPDATE #CONTSETTNEW         
        SET ORDER_NO = S.ORDER_NO,         
        ORDER_TIME   = S.ORDER_TIME,         
        TRADETIME    = S.TRADETIME,         
        TRADE_NO     = S.TRADE_NO         
FROM    #CONTSETT S         
WITH         
        (         
                NOLOCK         
        )         
WHERE   S.PRINTF           = #CONTSETTNEW.PRINTF         
        AND S.PRINTF       = '3'         
        AND S.PARTY_CODE   = #CONTSETTNEW.PARTY_CODE         
  AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE        
  AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE        
  AND S.SERIES_CODE  = #CONTSETTNEW.SERIES_CODE        
  AND S.SERIES_ID    = #CONTSETTNEW.SERIES_ID        
        AND S.EXPIRYDATE   = #CONTSETTNEW.EXPIRYDATE         
        AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE         
        AND S.SELL_BUY     = #CONTSETTNEW.SELL_BUY         
        AND S.SAUDA_DATE   =         
        (SELECT MIN(SAUDA_DATE)         
        FROM    #CONTSETT ISETT         
        WITH         
                (         
                        NOLOCK         
                )         
        WHERE   PRINTF             = '3'         
                AND S.PARTY_CODE   = ISETT.PARTY_CODE         
    AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE        
    AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE        
    AND S.SERIES_CODE  = ISETT.SERIES_CODE        
    AND S.SERIES_ID    = ISETT.SERIES_ID        
    AND S.EXPIRYDATE   = ISETT.EXPIRYDATE         
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE         
                AND S.SELL_BUY     = ISETT.SELL_BUY         
        )         
        
IF (@CONTFLAG = 'CONTRACT')        
BEGIN         
SELECT  ORDER_NO,        
        ORDER_TIME,        
        TRADE_NO,        
        TM=TRADETIME,          
  QTY = PQTY + SQTY,      
  LOTSIZE = BILLNO,      
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,        
        PQTY,        
        SQTY,          
        RATE = PRATE + SRATE,          
        PRATE,        
        SRATE,          
        BROK=PBROK+SBROK,          
        PBROK,        
        SBROK,          
        NETRATE = PNETRATE + SNETRATE,          
        PNETRATE,        
        SNETRATE,          
        AMOUNT,        
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIESCODE = SERIES_CODE,    
  SERIES_CODE,        
  SERIES_ID,        
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),    
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),    
        AMT = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN -PAMT         
                ELSE SAMT END),         
        PAMT,         
        SAMT,         
        AMTSTT = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN -(PAMT+INS_CHRG)         
                ELSE (SAMT-INS_CHRG) END),         
        PAMTSTT = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN PAMT+INS_CHRG         
                ELSE 0 END),         
        SAMTSTT = (         
        CASE         
                WHEN SELL_BUY = 2         
                THEN SAMT-INS_CHRG         
                ELSE 0 END),         
  AMTSERSTT = (    
        CASE         
                WHEN SELL_BUY = 1         
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)         
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),    
  PAMTSERSTT = (    
        CASE         
                WHEN SELL_BUY = 1         
                THEN (PAMT+INS_CHRG+SERVICE_TAX)         
                ELSE 0 END),    
  SAMTSERSTT = (    
        CASE         
                WHEN SELL_BUY = 2         
                THEN (SAMT-INS_CHRG-SERVICE_TAX)         
                ELSE 0 END),    
        EXPIRYDATE,        
        PARTY_CODE,        
        SELL_BUY,        
        CONTRACTNO,        
        SAUDA_DATE,        
        SDT=SAUDA_DATE,        
        STRIKE_PRICE,          
        PSERVICE_TAX,        
        SSERVICE_TAX,        
        YY,        
        MM,        
        DD,        
        DFLAG,        
  BROKER_CHRG,        
        TURN_TAX,        
        SEBI_TAX,        
        OTHER_CHRG,          
        PINS_CHRG=(        
        CASE         
                WHEN SELL_BUY = 1         
                THEN INS_CHRG         
                ELSE 0 END),          
        SINS_CHRG=(        
        CASE         
                WHEN SELL_BUY = 2         
                THEN INS_CHRG         
                ELSE 0 END),          
        INS_CHRG,        
        SERVICE_TAX,        
        NSERTAX,        
        BROKERAGE,        
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),        
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),        
        BRANCH_CD,        
        SUB_BROKER,        
        TRADER,        
        PRINTF,        
        SERVICE_CHRG,           
        PARTYNAME,         
        L_ADDRESS1,         
        L_ADDRESS2,         
        L_ADDRESS3,         
        L_CITY,         
        L_STATE,         
        L_ZIP,         
  SEBI_NO,        
        PAN_GIR_NO,         
        OFF_PHONE1,         
        OFF_PHONE2,           
        MAPIDID,          
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),         
        PMARKETAMT = PRATE * PQTY ,         
        SMARKETAMT = SRATE * SQTY ,         
        SERIES     = '',        
        TMARK      ='',          
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,        
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN         
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
       ELSE '' END),           
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN        
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
       ELSE '' END),           
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)    
FROM    #CONTSETTNEW         
WITH         
        (         
                NOLOCK         
        )         
WHERE   PRINTF <> 1         
ORDER BY BRANCH_CD,         
        SUB_BROKER,         
        TRADER,         
        PARTY_CODE,         
  CONTRACTNO DESC,    
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
        EXPIRYDATE,         
        STRIKE_PRICE,         
        ORDER_NO,         
        TRADE_NO         
END         
ELSE BEGIN         
SELECT  ORDER_NO,        
        ORDER_TIME,        
        TRADE_NO,        
        TM=TRADETIME,         
  QTY = PQTY + SQTY,        
  LOTSIZE = BILLNO,      
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,        
        PQTY,        
        SQTY,          
        RATE = PRATE + SRATE,          
        PRATE,        
        SRATE,          
        BROK=PBROK+SBROK,          
        PBROK,        
        SBROK,          
        NETRATE = PNETRATE + SNETRATE,          
        PNETRATE,        
        SNETRATE,          
        AMOUNT,        
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIESCODE =  SERIES_CODE,        
  SERIES_CODE,    
  SERIES_ID,      
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),    
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),    
        AMT = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN -PAMT         
                ELSE SAMT END),         
        PAMT,         
        SAMT,         
        AMTSTT = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN -(PAMT+INS_CHRG)         
                ELSE (SAMT-INS_CHRG) END),         
        PAMTSTT = (         
        CASE         
                WHEN SELL_BUY = 1         
                THEN PAMT+INS_CHRG         
                ELSE 0 END),         
        SAMTSTT = (         
        CASE         
                WHEN SELL_BUY = 2     
                THEN SAMT-INS_CHRG         
                ELSE 0 END),         
  AMTSERSTT = (    
        CASE         
                WHEN SELL_BUY = 1         
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)         
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),    
  PAMTSERSTT = (    
        CASE         
                WHEN SELL_BUY = 1         
                THEN (PAMT+INS_CHRG+SERVICE_TAX)         
                ELSE 0 END),    
  SAMTSERSTT = (    
        CASE         
                WHEN SELL_BUY = 2         
                THEN (SAMT-INS_CHRG-SERVICE_TAX)         
                ELSE 0 END),    
        EXPIRYDATE,        
        PARTY_CODE,        
        SELL_BUY,        
        CONTRACTNO  ,        
        SAUDA_DATE,        
        SDT=SAUDA_DATE,        
        STRIKE_PRICE,          
        PSERVICE_TAX,        
        SSERVICE_TAX,        
        YY,        
        MM,        
        DD,        
        DFLAG,        
        BROKER_CHRG,        
        TURN_TAX,        
        SEBI_TAX,        
        OTHER_CHRG,          
        PINS_CHRG=(        
        CASE         
                WHEN SELL_BUY = 1         
                THEN INS_CHRG         
                ELSE 0 END),          
        SINS_CHRG=(        
        CASE         
                WHEN SELL_BUY = 2         
                THEN INS_CHRG         
                ELSE 0 END),          
        INS_CHRG,        
        SERVICE_TAX,        
        NSERTAX,        
        BROKERAGE,        
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),        
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),        
        BRANCH_CD,        
        SUB_BROKER,        
        TRADER,        
        PRINTF,        
        SERVICE_CHRG,           
        PARTYNAME,         
        L_ADDRESS1,         
        L_ADDRESS2,         
        L_ADDRESS3,         
        L_CITY,         
        L_STATE,         
        L_ZIP,         
  SEBI_NO,        
        PAN_GIR_NO,         
        OFF_PHONE1,         
        OFF_PHONE2,           
        MAPIDID,          
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),         
        PMARKETAMT = PRATE * PQTY ,         
        SMARKETAMT = SRATE * SQTY ,         
        SERIES     = '',        
        TMARK      ='',          
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,        
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN         
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
       ELSE '' END),           
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN        
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
       ELSE '' END),    
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)           
FROM    #CONTSETTNEW         
WITH         
        (         
                NOLOCK         
        )         
ORDER BY BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  PARTY_CODE,         
  CONTRACTNO DESC,    
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
  EXPIRYDATE,         
  STRIKE_PRICE,    
  ORDER_NO,   
   
  TRADE_NO    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_14012012
-- --------------------------------------------------
  
CREATE PROCEDURE  [dbo].[V2_CONTSECTION_14012012]       
 (       
   @STATUSID VARCHAR(15),       
   @STATUSNAME VARCHAR(25),       
   @SAUDA_DATE VARCHAR(11),       
   @FROMPARTY_CODE VARCHAR(10),       
   @TOPARTY_CODE VARCHAR(10),       
   @BRANCH VARCHAR(10),       
   @SUB_BROKER VARCHAR(10),       
   @FROMCONTRACTNO VARCHAR(12),       
   @TOCONTRACTNO VARCHAR(12),       
   @CONTFLAG VARCHAR(10),  
   @TOSAUDA_DATE VARCHAR(11) = '',  
   @BOUNCEDFLAG INT = 0  
 )       
       
 AS       
   
 --EXEC V2_CONTSECTION 'BROKER','BROKER','MAY 24 2011','','ZZZZZZZZZZZ','%','%','0','99999999999','CONTRACT','',0  
   
 DECLARE @_STATUS CHAR(1)  
  
 IF @SUB_BROKER = 'ALL' OR @SUB_BROKER = ''       
 BEGIN       
  SET @SUB_BROKER = '%'       
 END       
 IF @BRANCH = 'ALL' OR @BRANCH = ''       
 BEGIN       
         SET @BRANCH = '%'       
 END       
 IF @FROMCONTRACTNO = ''      
 BEGIN      
  SET @FROMCONTRACTNO = 000000      
 END      
       
 IF @TOCONTRACTNO = ''      
 BEGIN      
  SET @TOCONTRACTNO = 99999999      
 END   
   
 IF @TOSAUDA_DATE = ''  
 BEGIN  
 SET @TOSAUDA_DATE = @SAUDA_DATE  
 END    
    
/*------------------  CANNED CONTRACT PLUG IN ------------------------*/      
/*  
IF EXISTS (SELECT TOP 1 PARTY_CODE FROM CONTRACT_DATA (NOLOCK) WHERE SAUDA_DATE >= @SAUDA_DATE)  
BEGIN      
 EXEC V2_CONTSECTION_DETAIL @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@BRANCH,@SUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@TOSAUDA_DATE,@BOUNCEDFLAG,@_STATUS OUTPUT      
 IF  @_STATUS =1      
 RETURN      
END  
*/  
/*---------------------------------------------------------------------*/      
    
  
 CREATE TABLE #BPARTY  
 (   
 PARTY_CODE VARCHAR(15)   
 )  
  
 IF @BOUNCEDFLAG <> 0  
 BEGIN  
  INSERT INTO #BPARTY  
  SELECT   
   DISTINCT PARTY_CODE   
  FROM   
   TBL_ECNBOUNCED(NOLOCK)   
  WHERE   
   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #BPARTY  
  SELECT   
   DISTINCT PARTY_CODE   
  FROM   
   CLIENT2 (NOLOCK)   
  WHERE   
   PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE  
 END  
    
SELECT  C2.PARTY_CODE,       
        C1.LONG_NAME,       
        C1.L_ADDRESS1,       
        C1.L_ADDRESS2,       
        C1.L_ADDRESS3,       
        C1.L_CITY,       
        C1.L_STATE,       
        C1.L_ZIP,       
        C1.BRANCH_CD ,       
        C1.SUB_BROKER,       
        C1.TRADER,       
        C1.PAN_GIR_NO,       
        C1.OFF_PHONE1,       
        C1.OFF_PHONE2,       
        PRINTF,       
        MAPIDID,       
        C2.SERVICE_CHRG,       
        BROKERNOTE,       
        TURNOVER_TAX,       
        SEBI_TURN_TAX,       
        C2.OTHER_CHRG,       
        INSURANCE_CHRG,      
  SEBI_NO = FD_CODE      
INTO    #CLIENTMASTER       
FROM      
  CLIENT1 C1       
WITH       
        (       
                NOLOCK       
        )       
        ,       
        CLIENT2 C2       
WITH       
        (       
                NOLOCK       
        )       
  LEFT OUTER JOIN UCC_CLIENT UC       
WITH       
        (       
                NOLOCK       
        )       
        ON C2.PARTY_CODE = UC.PARTY_CODE       
  --CLIENT_PRINT_SETTINGS  CP (NOLOCK) ,  
WHERE   C2.CL_CODE       = C1.CL_CODE       
        AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE       
        AND @STATUSNAME = (       
        CASE       
                WHEN @STATUSID = 'BRANCH'       
                THEN C1.BRANCH_CD       
                WHEN @STATUSID = 'SUBBROKER'       
                THEN C1.SUB_BROKER       
                WHEN @STATUSID = 'TRADER'       
                THEN C1.TRADER       
                WHEN @STATUSID = 'FAMILY'       
                THEN C1.FAMILY       
                WHEN @STATUSID = 'AREA'       
                THEN C1.AREA       
                WHEN @STATUSID = 'REGION'       
                THEN C1.REGION       
                WHEN @STATUSID = 'CLIENT'       
                THEN C2.PARTY_CODE       
                ELSE 'BROKER' END)       
        AND BRANCH_CD = CASE WHEN @BRANCH  ='%' THEN BRANCH_CD ELSE @BRANCH END  
        AND SUB_BROKER = CASE WHEN @SUB_BROKER  ='%' THEN SUB_BROKER ELSE @SUB_BROKER END        
        --AND PRINTF =  CP.PRINT_FLAG  
  --AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'  
  AND C2.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))  
   
  
SELECT  CONTRACTNO,       
        BILLNO=0,       
        TRADE_NO,       
        PARTY_CODE,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  MARKETRATE=TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        USER_ID=TERMINALID,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        MARKETTYPE=OPTION_TYPE,       
        ORDER_NO,       
        SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
  VAL_PERC,       
        NORMAL,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,   
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        AMOUNT=TRADE_AMOUNT,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_DATE=ORDER_TIMESTAMP,       
        DUMMY1,       
        DUMMY2,       
        RESERVED1       
INTO    #FOSETT       
FROM    BFOSETTLEMENT       
WHERE   1 = 2       
INSERT       
INTO    #FOSETT       
SELECT  CONTRACTNO,       
        BILLNO=0,       
        TRADE_NO,       
        PARTY_CODE,       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  MARKETRATE=TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        USER_ID=TERMINALID,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        MARKETTYPE=OPTION_TYPE,       
        ORDER_NO,       
  SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
        VAL_PERC,       
        NORMAL,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,       
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        AMOUNT=TRADE_AMOUNT,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_DATE=ORDER_TIMESTAMP,       
        DUMMY1,       
        DUMMY2,       
        RESERVED1  
FROM    BFOSETTLEMENT       
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
        AND PARTY_CODE >= @FROMPARTY_CODE       
        AND PARTY_CODE <= @TOPARTY_CODE       
        AND AUCTIONPART NOT IN ('CA')       
        AND TRADEQTY <> 0       
        AND TRADE_PRICE > 0       
        AND RESERVED1 = 0       
      
CREATE  INDEX [DELPOS]       
        ON [DBO].[#FOSETT]       
        (       
                [PARTY_CODE]       
        )       
      
SELECT  ORDER_NO,       
        ORDER_TIME = RIGHT(ORDER_DATE,8),       
        TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,       
  BILLNO=0,  
        PQTY = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN TRADEQTY       
                ELSE 0 END),       
        SQTY = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN TRADEQTY       
                ELSE 0 END),       
        PRATE = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL(MARKETRATE,0)       
                ELSE 0 END),       
        SRATE = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN ISNULL(MARKETRATE,0)       
                ELSE 0 END),       
        PBROK =(       
    CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL((BROKAPPLIED + (       
                CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
    ELSE 0 END),       
        SBROK =(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN ISNULL((BROKAPPLIED + (       
                CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
                ELSE 0 END),       
        PNETRATE = (       
        CASE       
                WHEN SELL_BUY =1       
                THEN ISNULL(NETRATE + (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
                ELSE 0 END),       
        SNETRATE = (       
        CASE       
                WHEN SELL_BUY =2       
                THEN ISNULL(NETRATE - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
                ELSE 0 END),       
        ISNULL(AMOUNT,0) AMOUNT ,       
        PRODUCT_TYPE= (       
        CASE       
                WHEN F.AUCTIONPART = 'EA'       
                THEN STUFF(PRODUCT_TYPE,1,3,'EA-')       
                ELSE PRODUCT_TYPE END),       
  PRODUCT_CODE = (       
        CASE       
                WHEN F.AUCTIONPART = 'EA'       
                THEN STUFF(PRODUCT_CODE,1,3,'EA-')       
                ELSE PRODUCT_CODE END),      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=(       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (TRADEQTY * NETRATE) + (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END) END ) END )       
                ELSE 0 END),       
        SAMT=(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN(TRADEQTY * NETRATE) - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END ) END ) END)       
                ELSE 0 END),       
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,       
        F.PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,       
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,       
        PSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                              WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        SSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        YY          =YEAR(SAUDA_DATE),       
        MM          =MONTH(SAUDA_DATE),       
        DD          =DAY(SAUDA_DATE),       
        DFLAG       = 1 ,       
        BROKER_CHRG = (       
        CASE       
                WHEN BROKERNOTE = 1       
                THEN BROKER_CHRG       
                ELSE 0 END ),       
        TURN_TAX = (       
        CASE       
                WHEN TURNOVER_TAX = 1       
                THEN TURN_TAX       
                ELSE 0 END),       
        SEBI_TAX = (       
        CASE       
                WHEN SEBI_TURN_TAX = 1       
                THEN SEBI_TAX       
                ELSE 0 END),       
        OTHER_CHRG = (       
        CASE       
                WHEN C.OTHER_CHRG = 1       
                THEN F.OTHER_CHRG       
                ELSE 0 END) ,       
        INS_CHRG = (       
        CASE       
                WHEN INSURANCE_CHRG = 1       
                THEN INS_CHRG       
                ELSE 0 END ),       
        SERVICE_TAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX       
                ELSE 0 END ),       
        NSERTAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX      
                ELSE 0 END ),       
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0) + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),  
        C.BRANCH_CD ,       
        C.SUB_BROKER,       
        C.TRADER,       
        PRINTF,         
        C.SERVICE_CHRG,         
        PARTYNAME=LONG_NAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,             
  OFF_PHONE2,         
        MAPIDID,      
  SEBI_NO      
INTO    #CONTSETT       
FROM    #FOSETT F,       
        #CLIENTMASTER C       
WHERE   F.PARTY_CODE     >= @FROMPARTY_CODE       
        AND F.PARTY_CODE <= @TOPARTY_CODE       
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO      
        AND F.PARTY_CODE=C.PARTY_CODE       
      
      
UPDATE         
 #CONTSETT        
SET        
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END        
      + (CASE WHEN SERVICE_CHRG = 1 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
        ELSE 0 END),        
 SERVICE_TAX = SERVICE_TAX+(CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN SERVICE_TAX+CD_TOT_BUYSERTAX ELSE 0 END        
   ELSE 0 END),        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN 0 ELSE SERVICE_TAX+CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
        PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)        
              ELSE 0 END),         
        SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK         
  - (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)        
              ELSE 0 END)        
FROM        
 CHARGES_DETAIL        
WHERE        
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)        
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE         
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE      
 AND CD_PRODUCT_CODE = PRODUCT_CODE      
 AND CD_SERIES_ID = SERIES_ID      
 AND CD_SERIES_CODE = SERIES_CODE      
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE        
 AND PRADNYA.DBO.REPLACETRADENO(CD_TRADE_NO) = TRADE_NO        
 AND CD_ORDER_NO = ORDER_NO        
        
      
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',         
 BILLNO=1,  
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,        
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX        
  ELSE 0 END),        
 SSERVICE_TAX = 0,        
 YY          =YEAR(CD_SAUDA_DATE),         
 MM          =MONTH(CD_SAUDA_DATE),         
 DD          =DAY(CD_SAUDA_DATE),         
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX = 0,         
 SEBI_TAX = 0,         
 OTHER_CHRG = 0 ,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 C.BRANCH_CD ,         
 C.SUB_BROKER,         
 C.TRADER,         
 PRINTF,           
 C.SERVICE_CHRG,           
 PARTYNAME=LONG_NAME,         
 L_ADDRESS1,         
 L_ADDRESS2,         
 L_ADDRESS3,         
 L_CITY,         
 L_STATE,         
 L_ZIP,         
 PAN_GIR_NO,         
 OFF_PHONE1,         
 OFF_PHONE2,           
 MAPIDID,        
 SEBI_NO      
FROM    CHARGES_DETAIL F,         
        #CLIENTMASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE +' 23:59:59'  
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_BUYBROK > 0        
        
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',   
 BILLNO =1,   
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,         
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = 0 ,        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX        
  ELSE 0 END),        
 YY          =YEAR(CD_SAUDA_DATE),         
 MM          =MONTH(CD_SAUDA_DATE),         
 DD       =DAY(CD_SAUDA_DATE),         
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX =0,         
 SEBI_TAX =0,         
 OTHER_CHRG = 0,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_SELLBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 C.BRANCH_CD ,         
 C.SUB_BROKER,         
 C.TRADER,         
 PRINTF,           
 C.SERVICE_CHRG,           
 PARTYNAME=LONG_NAME,         
 L_ADDRESS1,         
 L_ADDRESS2,         
 L_ADDRESS3,         
 L_CITY,         
 L_STATE,         
 L_ZIP,         
 PAN_GIR_NO,         
 OFF_PHONE1,         
 OFF_PHONE2,           
 MAPIDID,        
 SEBI_NO      
FROM    CHARGES_DETAIL F,         
        #CLIENTMASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_SELLBROK > 0          
      
      
      
      
      
SELECT  ORDER_NO  ='0000000000000000',       
        ORDER_TIME      ='                ',       
        TRADE_NO        ='0000000000000000',       
        TRADETIME       ='0000000000000000',       
  BILLNO=1,  
        PQTY            =SUM(PQTY),       
        SQTY            =SUM(SQTY),       
        PRATE           =(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END),       
        SRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PBROK=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PBROK*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SBROK=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SBROK*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PNETRATE=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SNETRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        AMOUNT=SUM(AMOUNT),       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=SUM(PAMT),       
        SAMT=SUM(SAMT),       
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),   
        STRIKE_PRICE,       
        PSERVICE_TAX=SUM(PSERVICE_TAX),       
        SSERVICE_TAX=SUM(SSERVICE_TAX),       
        YY,       
        MM,       
        DD,       
        DFLAG,       
        BROKER_CHRG = SUM(BROKER_CHRG),       
        TURN_TAX    = SUM(TURN_TAX),       
        SEBI_TAX    = SUM(SEBI_TAX),       
        OTHER_CHRG  = SUM(OTHER_CHRG) ,       
        INS_CHRG    = SUM(INS_CHRG),       
        SERVICE_TAX = SUM(SERVICE_TAX),       
        NSERTAX     = SUM(NSERTAX),       
        BROKERAGE   = SUM(BROKERAGE),       
        BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PRINTF,         
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,        
        MAPIDID,      
  SEBI_NO      
INTO    #CONTSETTNEW       
FROM    #CONTSETT       
WHERE   PRINTF = '3'       
GROUP BY PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        STRIKE_PRICE,       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),       
        YY,       
        MM,       
        DD,       
        DFLAG,       
        BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PRINTF,         
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,      
  SEBI_NO      
  
INSERT       
INTO    #CONTSETTNEW SELECT  *       
FROM    #CONTSETT       
WITH       
        (       
                NOLOCK       
        )       
WHERE   PRINTF <> '3'       
UPDATE #CONTSETTNEW       
        SET ORDER_NO = S.ORDER_NO,       
        ORDER_TIME   = S.ORDER_TIME,       
        TRADETIME    = S.TRADETIME,       
        TRADE_NO     = S.TRADE_NO       
FROM    #CONTSETT S       
WITH       
        (       
                NOLOCK       
        )       
WHERE   S.PRINTF           = #CONTSETTNEW.PRINTF       
        AND S.PRINTF       = '3'       
        AND S.PARTY_CODE   = #CONTSETTNEW.PARTY_CODE       
  AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE      
  AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE      
  AND S.SERIES_CODE  = #CONTSETTNEW.SERIES_CODE      
  AND S.SERIES_ID    = #CONTSETTNEW.SERIES_ID      
        AND S.EXPIRYDATE   = #CONTSETTNEW.EXPIRYDATE       
        AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE       
        AND S.SELL_BUY     = #CONTSETTNEW.SELL_BUY       
        AND S.SAUDA_DATE   =       
        (SELECT MIN(SAUDA_DATE)       
        FROM    #CONTSETT ISETT       
        WITH       
                (       
                        NOLOCK       
                )       
        WHERE   PRINTF             = '3'       
                AND S.PARTY_CODE   = ISETT.PARTY_CODE       
    AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE      
    AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE      
    AND S.SERIES_CODE  = ISETT.SERIES_CODE      
    AND S.SERIES_ID    = ISETT.SERIES_ID      
    AND S.EXPIRYDATE   = ISETT.EXPIRYDATE       
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE       
                AND S.SELL_BUY     = ISETT.SELL_BUY       
        )       
      
IF (@CONTFLAG = 'CONTRACT')      
BEGIN       
SELECT  ORDER_NO,      
        ORDER_TIME,      
        TRADE_NO,      
        TM=TRADETIME,        
  QTY = PQTY + SQTY,    
  LOTSIZE = BILLNO,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,      
        PQTY,      
        SQTY,        
        RATE = PRATE + SRATE,        
        PRATE,      
        SRATE,        
        BROK=PBROK+SBROK,        
        PBROK,      
        SBROK,        
        NETRATE = PNETRATE + SNETRATE,        
        PNETRATE,      
        SNETRATE,        
        AMOUNT,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIESCODE = SERIES_CODE,  
  SERIES_CODE,      
  SERIES_ID,      
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),  
        AMT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -PAMT       
                ELSE SAMT END),       
        PAMT,       
        SAMT,       
        AMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG)       
                ELSE (SAMT-INS_CHRG) END),       
        PAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN PAMT+INS_CHRG       
                ELSE 0 END),       
        SAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN SAMT-INS_CHRG       
                ELSE 0 END),       
  AMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),  
  PAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN (PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE 0 END),  
  SAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 2       
                THEN (SAMT-INS_CHRG-SERVICE_TAX)       
                ELSE 0 END),  
        EXPIRYDATE,      
        PARTY_CODE,      
        SELL_BUY,      
        CONTRACTNO,      
        SAUDA_DATE,      
        SDT=SAUDA_DATE,      
        STRIKE_PRICE,        
        PSERVICE_TAX,      
        SSERVICE_TAX,      
        YY,      
        MM,      
        DD,      
        DFLAG,      
  BROKER_CHRG,      
        TURN_TAX,      
        SEBI_TAX,      
        OTHER_CHRG,        
        PINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 1       
                THEN INS_CHRG       
                ELSE 0 END),        
        SINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 2       
                THEN INS_CHRG       
                ELSE 0 END),        
        INS_CHRG,      
        SERVICE_TAX,      
        NSERTAX,      
        BROKERAGE,      
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),      
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),      
        BRANCH_CD,      
        SUB_BROKER,      
        TRADER,      
        PRINTF,      
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
  SEBI_NO,      
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,        
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),       
        PMARKETAMT = PRATE * PQTY ,       
        SMARKETAMT = SRATE * SQTY ,       
        SERIES     = '',      
        TMARK      ='',        
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,      
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN       
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN      
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)  
FROM    #CONTSETTNEW       
WITH       
        (       
                NOLOCK       
        )       
WHERE   PRINTF <> 1       
ORDER BY BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        STRIKE_PRICE,       
        ORDER_NO,       
        TRADE_NO       
END       
ELSE BEGIN       
SELECT  ORDER_NO,      
        ORDER_TIME,      
        TRADE_NO,      
        TM=TRADETIME,       
  QTY = PQTY + SQTY,      
  LOTSIZE = BILLNO,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,      
        PQTY,      
        SQTY,        
        RATE = PRATE + SRATE,        
        PRATE,      
        SRATE,        
        BROK=PBROK+SBROK,        
        PBROK,      
        SBROK,        
        NETRATE = PNETRATE + SNETRATE,        
        PNETRATE,      
        SNETRATE,        
        AMOUNT,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIESCODE =  SERIES_CODE,      
  SERIES_CODE,  
  SERIES_ID,    
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),  
        AMT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -PAMT       
                ELSE SAMT END),       
        PAMT,       
        SAMT,       
        AMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG)       
                ELSE (SAMT-INS_CHRG) END),       
        PAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN PAMT+INS_CHRG       
                ELSE 0 END),       
        SAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 2   
                THEN SAMT-INS_CHRG       
                ELSE 0 END),       
  AMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),  
  PAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN (PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE 0 END),  
  SAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 2       
                THEN (SAMT-INS_CHRG-SERVICE_TAX)       
                ELSE 0 END),  
        EXPIRYDATE,      
        PARTY_CODE,      
        SELL_BUY,      
        CONTRACTNO,      
        SAUDA_DATE,      
        SDT=SAUDA_DATE,      
        STRIKE_PRICE,        
        PSERVICE_TAX,      
        SSERVICE_TAX,      
        YY,      
        MM,      
        DD,      
        DFLAG,      
        BROKER_CHRG,      
        TURN_TAX,      
        SEBI_TAX,      
        OTHER_CHRG,        
        PINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 1       
                THEN INS_CHRG       
                ELSE 0 END),        
        SINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 2       
                THEN INS_CHRG       
                ELSE 0 END),        
        INS_CHRG,      
        SERVICE_TAX,      
        NSERTAX,      
        BROKERAGE,      
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),      
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),      
        BRANCH_CD,      
        SUB_BROKER,      
        TRADER,      
        PRINTF,      
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
  SEBI_NO,      
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,        
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),       
        PMARKETAMT = PRATE * PQTY ,       
        SMARKETAMT = SRATE * SQTY ,       
        SERIES     = '',      
        TMARK      ='',        
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,      
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN       
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN      
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),  
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
FROM    #CONTSETTNEW       
WITH       
        (       
                NOLOCK       
        )       
ORDER BY BRANCH_CD,       
  SUB_BROKER,       
  TRADER,       
  PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  EXPIRYDATE,       
  STRIKE_PRICE,  
  ORDER_NO,  
  TRADE_NO  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_18122012
-- --------------------------------------------------
        
CREATE PROCEDURE  [dbo].[V2_CONTSECTION_18122012]             
 (             
   @STATUSID VARCHAR(15),             
   @STATUSNAME VARCHAR(25),             
   @SAUDA_DATE VARCHAR(11),             
   @FROMPARTY_CODE VARCHAR(10),             
   @TOPARTY_CODE VARCHAR(10),             
   @BRANCH VARCHAR(10),             
   @SUB_BROKER VARCHAR(10),             
   @FROMCONTRACTNO VARCHAR(12),             
   @TOCONTRACTNO VARCHAR(12),             
   @CONTFLAG VARCHAR(10),        
   @TOSAUDA_DATE VARCHAR(11) = '',        
   @BOUNCEDFLAG INT = 0        
 )             
             
 AS             
         
 --EXEC V2_CONTSECTION 'BROKER','BROKER','MAY 24 2005','','ZZZZZZZZZZZ','%','%','0','99999999999','CONTRACT','MAY 24 2012',0        
         
 DECLARE @_STATUS CHAR(1)        
        
 IF @SUB_BROKER = 'ALL' OR @SUB_BROKER = ''             
 BEGIN             
  SET @SUB_BROKER = '%'             
 END             
 IF @BRANCH = 'ALL' OR @BRANCH = ''             
 BEGIN             
         SET @BRANCH = '%'             
 END             
 IF @FROMCONTRACTNO = ''            
 BEGIN            
  SET @FROMCONTRACTNO = 000000            
 END            
             
 IF @TOCONTRACTNO = ''            
 BEGIN            
  SET @TOCONTRACTNO = 99999999            
 END         
         
 IF @TOSAUDA_DATE = ''        
 BEGIN        
 SET @TOSAUDA_DATE = @SAUDA_DATE        
 END          
          
/*------------------  CANNED CONTRACT PLUG IN ------------------------*/            
IF EXISTS (SELECT TOP 1 PARTY_CODE FROM CONTRACT_DATA (NOLOCK) WHERE SAUDA_DATE >= @SAUDA_DATE)        
BEGIN            
 EXEC V2_CONTSECTION_DETAIL @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@BRANCH,@SUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@TOSAUDA_DATE,@BOUNCEDFLAG,@_STATUS OUTPUT            
 IF  @_STATUS =1            
 RETURN            
END        
        
        
        
/*---------------------------------------------------------------------*/            
          
        
 CREATE TABLE #BPARTY        
 (         
 PARTY_CODE VARCHAR(15)         
 )        
        
 IF @BOUNCEDFLAG <> 0        
 BEGIN        
  INSERT INTO #BPARTY        
  SELECT         
   DISTINCT PARTY_CODE         
  FROM         
   TBL_ECNBOUNCED(NOLOCK)         
  WHERE         
   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'        
 END        
 ELSE        
 BEGIN        
  INSERT INTO #BPARTY        
  SELECT         
   DISTINCT PARTY_CODE         
  FROM         
   CLIENT2 (NOLOCK)         
  WHERE         
   PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE        
 END        
          
SELECT  C2.PARTY_CODE,             
        C1.LONG_NAME,             
        C1.L_ADDRESS1,             
        C1.L_ADDRESS2,             
        C1.L_ADDRESS3,             
        C1.L_CITY,             
        C1.L_STATE,             
        C1.L_ZIP,             
        C1.BRANCH_CD ,             
        C1.SUB_BROKER,             
        C1.TRADER,             
        C1.PAN_GIR_NO,             
        C1.OFF_PHONE1,             
        C1.OFF_PHONE2,             
        PRINTF,             
        MAPIDID,             
        C2.SERVICE_CHRG,             
        BROKERNOTE,             
        TURNOVER_TAX,             
        SEBI_TURN_TAX,             
        C2.OTHER_CHRG,             
        INSURANCE_CHRG,            
  SEBI_NO = FD_CODE            
INTO    #CLIENTMASTER             
FROM            
  CLIENT1 C1             
WITH             
        (             
                NOLOCK             
        )             
        ,             
        CLIENT2 C2             
WITH             
        (             
                NOLOCK             
        )             
  LEFT OUTER JOIN UCC_CLIENT UC             
WITH             
        (             
                NOLOCK             
        )             
        ON C2.PARTY_CODE = UC.PARTY_CODE             
  --CLIENT_PRINT_SETTINGS  CP (NOLOCK) ,        
WHERE   C2.CL_CODE       = C1.CL_CODE             
        AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE        
        AND Cl_Type <> 'INS'                     
        AND @STATUSNAME = (             
        CASE             
                WHEN @STATUSID = 'BRANCH'             
                THEN C1.BRANCH_CD             
          WHEN @STATUSID = 'SUBBROKER'             
                THEN C1.SUB_BROKER             
                WHEN @STATUSID = 'TRADER'             
                THEN C1.TRADER             
                WHEN @STATUSID = 'FAMILY'             
                THEN C1.FAMILY             
     WHEN @STATUSID = 'AREA'             
                THEN C1.AREA             
                WHEN @STATUSID = 'REGION'             
                THEN C1.REGION             
                WHEN @STATUSID = 'CLIENT'             
                THEN C2.PARTY_CODE             
                ELSE 'BROKER' END)          
        AND BRANCH_CD = CASE WHEN @BRANCH  ='%' THEN BRANCH_CD ELSE @BRANCH END        
        AND SUB_BROKER = CASE WHEN @SUB_BROKER  ='%' THEN SUB_BROKER ELSE @SUB_BROKER END              
        --AND PRINTF =  CP.PRINT_FLAG        
  --AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'        
  AND C2.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))        
         
        
SELECT  CONTRACTNO,             
        BILLNO=LOT_SIZE,             
        TRADE_NO,             
        PARTY_CODE,            
  PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIES_CODE,            
  SERIES_ID,            
  MARKETRATE=TRADE_PRICE,             
        EXPIRYDATE,             
        STRIKE_PRICE,             
        USER_ID=TERMINALID,             
        PRO_CLI,             
        TRADEQTY,             
        AUCTIONPART,             
        MARKETTYPE=OPTION_TYPE,             
        ORDER_NO,             
        SAUDA_DATE,             
        TABLE_NO,             
        LINE_NO,             
  VAL_PERC,             
        NORMAL,             
        DAY_PUC,             
        DAY_SALES,             
        SETT_PURCH,             
        SETT_SALES,         
        SELL_BUY,             
        SETTFLAG,             
        BROKAPPLIED,             
        NETRATE,             
        AMOUNT=TRADE_AMOUNT,             
        INS_CHRG,             
        TURN_TAX,             
        OTHER_CHRG,             
        SEBI_TAX,             
        BROKER_CHRG,             
        SERVICE_TAX,             
        TRADE_AMOUNT,             
        PARTICIPANTCODE,             
        STATUS,             
        ORDER_DATE=ORDER_TIMESTAMP,             
        DUMMY1,             
        DUMMY2,             
        RESERVED1             
INTO    #FOSETT             
FROM    BFOSETTLEMENT             
WHERE   1 = 2             
INSERT             
INTO    #FOSETT             
SELECT  CONTRACTNO,             
        BILLNO=LOT_SIZE,             
        TRADE_NO,             
        PARTY_CODE,             
  PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIES_CODE,            
  SERIES_ID,            
  MARKETRATE=TRADE_PRICE,             
        EXPIRYDATE,             
        STRIKE_PRICE,             
        USER_ID=TERMINALID,             
        PRO_CLI,             
        TRADEQTY,             
        AUCTIONPART,             
        MARKETTYPE=OPTION_TYPE,             
        ORDER_NO,             
  SAUDA_DATE,             
        TABLE_NO,             
        LINE_NO,             
        VAL_PERC,             
        NORMAL,             
        DAY_PUC,             
        DAY_SALES,             
        SETT_PURCH,             
        SETT_SALES,             
        SELL_BUY,             
        SETTFLAG,             
        BROKAPPLIED,             
        NETRATE,             
        AMOUNT=TRADE_AMOUNT,             
        INS_CHRG,             
        TURN_TAX,             
        OTHER_CHRG,             
        SEBI_TAX,             
        BROKER_CHRG,             
        SERVICE_TAX,             
        TRADE_AMOUNT,             
        PARTICIPANTCODE,             
        STATUS,             
        ORDER_DATE=ORDER_TIMESTAMP,             
        DUMMY1,             
        DUMMY2,             
        RESERVED1        
FROM    BFOSETTLEMENT             
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'        
        AND PARTY_CODE >= @FROMPARTY_CODE             
        AND PARTY_CODE <= @TOPARTY_CODE             
        AND AUCTIONPART NOT IN ('CA')             
        AND TRADEQTY <> 0             
        AND TRADE_PRICE > 0             
        AND RESERVED1 = 0             
            
CREATE  INDEX [DELPOS]             
        ON [DBO].[#FOSETT]             
        (             
                [PARTY_CODE]             
        )             
            
SELECT  ORDER_NO,             
        ORDER_TIME = RIGHT(ORDER_DATE,8),             
        TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),             
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,             
  BILLNO,        
        PQTY = (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN TRADEQTY             
                ELSE 0 END),             
        SQTY = (             
        CASE             
                WHEN SELL_BUY = 2             
                THEN TRADEQTY             
                ELSE 0 END),             
        PRATE = (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN ISNULL(MARKETRATE,0)             
                ELSE 0 END),             
        SRATE = (             
        CASE             
                WHEN SELL_BUY = 2             
                THEN ISNULL(MARKETRATE,0)             
             ELSE 0 END),             
        PBROK =(             
    CASE             
                WHEN SELL_BUY = 1             
                THEN ISNULL((BROKAPPLIED + (             
                CASE             
                        WHEN C.SERVICE_CHRG=1             
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)             
                        ELSE 0 END )),0)             
    ELSE 0 END),             
        SBROK =(             
        CASE             
                WHEN SELL_BUY = 2             
                THEN ISNULL((BROKAPPLIED + (             
                CASE             
                        WHEN C.SERVICE_CHRG=1             
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)             
                        ELSE 0 END )),0)             
                ELSE 0 END),             
        PNETRATE = (             
        CASE             
                WHEN SELL_BUY =1             
                THEN ISNULL(NETRATE + (             
                CASE             
                        WHEN C.SERVICE_CHRG = 1             
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)             
                        ELSE 0 END),0)             
                ELSE 0 END),             
        SNETRATE = (             
        CASE             
                WHEN SELL_BUY =2             
                THEN ISNULL(NETRATE - (             
                CASE             
                        WHEN C.SERVICE_CHRG = 1             
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)             
                        ELSE 0 END),0)             
                ELSE 0 END),             
        ISNULL(AMOUNT,0) AMOUNT ,             
        PRODUCT_TYPE= (             
        CASE             
                WHEN F.AUCTIONPART = 'EA'             
                THEN STUFF(PRODUCT_TYPE,1,3,'EA-')             
                ELSE PRODUCT_TYPE END),             
  PRODUCT_CODE = (             
        CASE             
                WHEN F.AUCTIONPART = 'EA'             
                THEN STUFF(PRODUCT_CODE,1,3,'EA-')             
                ELSE PRODUCT_CODE END),            
  SERIES_CODE,            
  SERIES_ID,            
        PAMT=(             
        CASE             
   WHEN SELL_BUY = 1             
                THEN (TRADEQTY * NETRATE) + (             
                CASE             
                        WHEN C.SERVICE_CHRG = 1             
                        THEN ISNULL((F.SERVICE_TAX),0)             
                        ELSE (             
                        CASE             
                                WHEN C.SERVICE_CHRG = 0             
                                THEN 0             
                                ELSE (             
                                CASE             
                                        WHEN C.SERVICE_CHRG = 2             
                                        THEN 0             
                                        ELSE 0 END) END ) END )             
                ELSE 0 END),             
        SAMT=(             
        CASE             
                WHEN SELL_BUY = 2             
                THEN(TRADEQTY * NETRATE) - (             
                CASE             
                        WHEN C.SERVICE_CHRG = 1             
                        THEN ISNULL((F.SERVICE_TAX),0)             
                        ELSE (             
                        CASE             
                                WHEN C.SERVICE_CHRG = 0             
                                THEN 0             
                                ELSE (             
                                CASE             
             WHEN C.SERVICE_CHRG = 2             
                                        THEN 0             
                                        ELSE 0 END ) END ) END)             
                ELSE 0 END),             
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,             
        F.PARTY_CODE,             
        SELL_BUY,             
        CONTRACTNO,             
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,             
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,             
        PSERVICE_TAX= (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN (             
                CASE             
                        WHEN C.SERVICE_CHRG=0             
                        THEN (F.SERVICE_TAX)             
     ELSE (             
                        CASE             
                              WHEN C.SERVICE_CHRG=1             
                                THEN 0             
                                ELSE (             
                                CASE             
                                        WHEN C.SERVICE_CHRG=2             
                                        THEN 0 END) END) END)             
                ELSE 0 END),             
        SSERVICE_TAX= (             
        CASE             
                WHEN SELL_BUY = 2             
                THEN (             
                CASE             
                        WHEN C.SERVICE_CHRG=0             
                        THEN (F.SERVICE_TAX)             
                        ELSE (             
                        CASE             
                                WHEN C.SERVICE_CHRG=1             
                                THEN 0             
                                ELSE (             
                                CASE             
                                        WHEN C.SERVICE_CHRG=2             
                                        THEN 0 END) END) END)             
                ELSE 0 END),             
        YY          =YEAR(SAUDA_DATE),             
        MM          =MONTH(SAUDA_DATE),             
        DD          =DAY(SAUDA_DATE),             
        DFLAG       = 1 ,             
        BROKER_CHRG = (             
        CASE             
                WHEN BROKERNOTE = 1             
                THEN BROKER_CHRG             
                ELSE 0 END ),             
        TURN_TAX = (             
        CASE             
                WHEN TURNOVER_TAX = 1             
                THEN TURN_TAX             
                ELSE 0 END),             
        SEBI_TAX = (             
        CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN SEBI_TAX             
                ELSE 0 END),             
        OTHER_CHRG = (             
        CASE             
                WHEN C.OTHER_CHRG = 1             
                THEN F.OTHER_CHRG             
                ELSE 0 END) ,             
        INS_CHRG = (             
        CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN INS_CHRG             
                ELSE 0 END ),             
        SERVICE_TAX = (             
        CASE             
                WHEN SERVICE_CHRG = 0             
                THEN SERVICE_TAX             
                ELSE 0 END ),             
        NSERTAX = (      
        CASE             
                WHEN SERVICE_CHRG = 0             
                THEN SERVICE_TAX            
                ELSE 0 END ),             
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0) + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),        
        C.BRANCH_CD ,             
        C.SUB_BROKER,             
        C.TRADER,             
        PRINTF,               
        C.SERVICE_CHRG,               
        PARTYNAME=LONG_NAME,             
        L_ADDRESS1,             
        L_ADDRESS2,             
        L_ADDRESS3,             
        L_CITY,             
        L_STATE,             
        L_ZIP,             
        PAN_GIR_NO,             
        OFF_PHONE1,                   
  OFF_PHONE2,               
        MAPIDID,            
  SEBI_NO            
INTO    #CONTSETT             
FROM    #FOSETT F,             
        #CLIENTMASTER C             
WHERE   F.PARTY_CODE     >= @FROMPARTY_CODE           
        AND F.PARTY_CODE <= @TOPARTY_CODE             
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO            
        AND F.PARTY_CODE=C.PARTY_CODE             
            
            
UPDATE               
 #CONTSETT              
SET              
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END              
      + (CASE WHEN SERVICE_CHRG = 1 THEN               
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END              
        ELSE 0 END),              
 SERVICE_TAX = SERVICE_TAX+(CASE WHEN SERVICE_CHRG = 0 THEN               
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END              
   ELSE 0 END),              
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN               
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END              
   ELSE 0 END),              
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN               
   CASE WHEN SELL_BUY =1 THEN SERVICE_TAX+CD_TOT_BUYSERTAX ELSE 0 END              
   ELSE 0 END),              
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN               
   CASE WHEN SELL_BUY =1 THEN 0 ELSE SERVICE_TAX+CD_TOT_SELLSERTAX END              
   ELSE 0 END),              
        PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK               
  + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)              
              ELSE 0 END),               
        SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK               
  - (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)              
              ELSE 0 END)              
FROM              
 CHARGES_DETAIL              
WHERE              
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)              
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE               
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE            
 AND CD_PRODUCT_CODE = PRODUCT_CODE            
 AND CD_SERIES_ID = SERIES_ID            
 AND CD_SERIES_CODE = SERIES_CODE            
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE              
 AND PRADNYA.DBO.REPLACETRADENO(CD_TRADE_NO) = TRADE_NO              
 AND CD_ORDER_NO = ORDER_NO              
              
            
INSERT INTO #CONTSETT              
SELECT  CD_ORDER_NO,               
 ORDER_TIME = '',               
 CD_TRADE_NO,               
 TRADETIME='',               
 BILLNO=1,        
 PQTY = 0,               
 SQTY = 0,               
 PRATE = 0,               
 SRATE = 0,               
 PBROK =0,               
 SBROK =0,               
 PNETRATE = 0,               
 SNETRATE = 0,               
 AMOUNT =0,               
 CD_PRODUCT_TYPE,               
 CD_PRODUCT_CODE,            
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),               
 CD_SERIES_ID,            
 PAMT=0,              
 SAMT=0,               
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE             
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,               
 CD_PARTY_CODE,              
 SELL_BUY = 1,               
 CD_CONTRACT_NO,               
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,          
 STRIKE_PRICE = 0 ,            
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN               
  CD_TOT_BUYSERTAX              
  ELSE 0 END),              
 SSERVICE_TAX = 0,              
 YY          =YEAR(CD_SAUDA_DATE),               
 MM          =MONTH(CD_SAUDA_DATE),               
 DD          =DAY(CD_SAUDA_DATE),               
 DFLAG       = 1 ,               
 BROKER_CHRG = 0,               
 TURN_TAX = 0,               
 SEBI_TAX = 0,               
 OTHER_CHRG = 0 ,               
 INS_CHRG = 0,               
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN               
  CD_TOT_BUYSERTAX               
  ELSE 0 END),              
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN               
  CD_TOT_BUYSERTAX               
  ELSE 0 END),              
 BROKERAGE = CD_TOT_BUYBROK               
  + (CASE WHEN SERVICE_CHRG = 1 THEN               
  CD_TOT_BUYSERTAX               
  ELSE 0 END),              
 C.BRANCH_CD ,               
 C.SUB_BROKER,               
 C.TRADER,               
 PRINTF,                 
 C.SERVICE_CHRG,                 
 PARTYNAME=LONG_NAME,               
 L_ADDRESS1,               
 L_ADDRESS2,               
 L_ADDRESS3,               
 L_CITY,               
 L_STATE,               
 L_ZIP,               
 PAN_GIR_NO,               
 OFF_PHONE1,               
 OFF_PHONE2,                 
 MAPIDID,              
 SEBI_NO            
FROM    CHARGES_DETAIL F,               
        #CLIENTMASTER C               
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE +' 23:59:59'        
 AND CD_PARTY_CODE     >= '0'               
 AND CD_PARTY_CODE <= 'ZZ'               
 AND CD_CONTRACT_NO BETWEEN (               
 CASE               
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'               
         AND CD_AUCTIONPART ='EA'               
         THEN 0               
         ELSE '0' END)               
 AND '9999'               
 AND CD_PARTY_CODE=C.PARTY_CODE              
 AND CD_TRADE_NO = ''              
 AND CD_TOT_BUYBROK > 0              
              
INSERT INTO #CONTSETT              
SELECT  CD_ORDER_NO,               
 ORDER_TIME = '',               
 CD_TRADE_NO,               
 TRADETIME='',         
 BILLNO =1,         
 PQTY = 0,               
 SQTY = 0,               
 PRATE = 0,               
 SRATE = 0,               
 PBROK =0,               
 SBROK =0,               
 PNETRATE = 0,               
 SNETRATE = 0,               
 AMOUNT =0,               
 CD_PRODUCT_TYPE,               
 CD_PRODUCT_CODE,            
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),               
 CD_SERIES_ID,            
 PAMT=0,               
 SAMT=0,               
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE             
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,               
 CD_PARTY_CODE,              
 SELL_BUY = 1,               
 CD_CONTRACT_NO,               
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,       
 STRIKE_PRICE = 0 ,            
 PSERVICE_TAX = 0 ,              
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN               
  CD_TOT_SELLSERTAX              
  ELSE 0 END),              
 YY          =YEAR(CD_SAUDA_DATE),               
 MM          =MONTH(CD_SAUDA_DATE),               
 DD       =DAY(CD_SAUDA_DATE),               
 DFLAG       = 1 ,               
 BROKER_CHRG = 0,               
 TURN_TAX =0,               
 SEBI_TAX =0,               
 OTHER_CHRG = 0,               
 INS_CHRG = 0,               
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN               
  CD_TOT_SELLSERTAX               
  ELSE 0 END),              
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN               
  CD_TOT_SELLSERTAX               
  ELSE 0 END),              
 BROKERAGE = CD_TOT_SELLBROK               
  + (CASE WHEN SERVICE_CHRG = 1 THEN               
  CD_TOT_SELLSERTAX               
  ELSE 0 END),              
 C.BRANCH_CD ,               
 C.SUB_BROKER,               
 C.TRADER,               
 PRINTF,                 
 C.SERVICE_CHRG,                 
 PARTYNAME=LONG_NAME,               
 L_ADDRESS1,               
 L_ADDRESS2,               
 L_ADDRESS3,               
 L_CITY,               
 L_STATE,               
 L_ZIP,               
 PAN_GIR_NO,               
 OFF_PHONE1,               
 OFF_PHONE2,                 
 MAPIDID,              
 SEBI_NO            
FROM    CHARGES_DETAIL F,               
        #CLIENTMASTER C               
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'        
 AND CD_PARTY_CODE     >= '0'               
 AND CD_PARTY_CODE <= 'ZZ'               
 AND CD_CONTRACT_NO BETWEEN (               
 CASE               
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'               
         AND CD_AUCTIONPART ='EA'               
         THEN 0               
         ELSE '0' END)               
 AND '9999'               
 AND CD_PARTY_CODE=C.PARTY_CODE              
 AND CD_TRADE_NO = ''              
 AND CD_TOT_SELLBROK > 0                
            
            
            
            
            
SELECT  ORDER_NO  ='0000000000000000',             
        ORDER_TIME      ='                ',             
        TRADE_NO        ='0000000000000000',             
        TRADETIME       ='0000000000000000',             
  BILLNO,        
        PQTY            =SUM(PQTY),             
        SQTY            =SUM(SQTY),             
        PRATE           =(             
        CASE             
                WHEN SUM(PQTY) > 0             
                THEN SUM(PRATE*PQTY)/SUM(PQTY)             
                ELSE 0 END),             
        SRATE=(             
        CASE             
                WHEN SUM(SQTY) > 0             
                THEN SUM(SRATE*SQTY)/SUM(SQTY)             
                ELSE 0 END ),             
        PBROK=(             
        CASE             
                WHEN SUM(PQTY) > 0             
                THEN SUM(PBROK*PQTY)/SUM(PQTY)             
                ELSE 0 END ),             
        SBROK=(             
        CASE             
                WHEN SUM(SQTY) > 0             
                THEN SUM(SBROK*SQTY)/SUM(SQTY)             
                ELSE 0 END ),             
        PNETRATE=(             
        CASE             
                WHEN SUM(PQTY) > 0             
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)             
                ELSE 0 END ),             
        SNETRATE=(             
        CASE             
                WHEN SUM(SQTY) > 0             
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)             
                ELSE 0 END ),             
        AMOUNT=SUM(AMOUNT),             
  PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIES_CODE,            
  SERIES_ID,            
        PAMT=SUM(PAMT),             
        SAMT=SUM(SAMT),             
        EXPIRYDATE,             
        PARTY_CODE,             
        SELL_BUY,             
        CONTRACTNO,             
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),         
        STRIKE_PRICE,             
        PSERVICE_TAX=SUM(PSERVICE_TAX),             
        SSERVICE_TAX=SUM(SSERVICE_TAX),             
        YY,             
        MM,             
        DD,             
        DFLAG,             
        BROKER_CHRG = SUM(BROKER_CHRG),             
        TURN_TAX    = SUM(TURN_TAX),             
   SEBI_TAX    = SUM(SEBI_TAX),             
        OTHER_CHRG  = SUM(OTHER_CHRG) ,             
        INS_CHRG    = SUM(INS_CHRG),             
        SERVICE_TAX = SUM(SERVICE_TAX),             
        NSERTAX     = SUM(NSERTAX),             
        BROKERAGE   = SUM(BROKERAGE),             
        BRANCH_CD,             
        SUB_BROKER,             
        TRADER,             
        PRINTF,               
        SERVICE_CHRG,               
        PARTYNAME,             
        L_ADDRESS1,             
        L_ADDRESS2,             
        L_ADDRESS3,             
        L_CITY,             
        L_STATE,             
        L_ZIP,             
        PAN_GIR_NO,             
        OFF_PHONE1,             
        OFF_PHONE2,              
        MAPIDID,            
  SEBI_NO            
INTO    #CONTSETTNEW             
FROM    #CONTSETT             
WHERE   PRINTF = '3'             
GROUP BY PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIES_CODE,            
  SERIES_ID,            
        EXPIRYDATE,             
        PARTY_CODE,             
        SELL_BUY,             
        CONTRACTNO,             
        STRIKE_PRICE,             
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),             
        YY,             
        MM,             
        DD,             
        DFLAG,             
        BRANCH_CD,             
        SUB_BROKER,             
        TRADER,             
        PRINTF,               
        SERVICE_CHRG,               
        PARTYNAME,             
        L_ADDRESS1,             
        L_ADDRESS2,             
        L_ADDRESS3,             
        L_CITY,             
        L_STATE,             
        L_ZIP,             
        PAN_GIR_NO,             
        OFF_PHONE1,             
        OFF_PHONE2,               
        MAPIDID,            
  SEBI_NO,BILLNO            
        
INSERT             
INTO    #CONTSETTNEW SELECT  *             
FROM    #CONTSETT             
WITH             
        (             
                NOLOCK             
        )             
WHERE   PRINTF <> '3'             
UPDATE #CONTSETTNEW             
        SET ORDER_NO = S.ORDER_NO,             
        ORDER_TIME   = S.ORDER_TIME,             
        TRADETIME    = S.TRADETIME,             
        TRADE_NO     = S.TRADE_NO             
FROM    #CONTSETT S             
WITH             
        (             
                NOLOCK             
        )             
WHERE   S.PRINTF           = #CONTSETTNEW.PRINTF             
        AND S.PRINTF       = '3'             
        AND S.PARTY_CODE   = #CONTSETTNEW.PARTY_CODE             
  AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE            
  AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE            
  AND S.SERIES_CODE  = #CONTSETTNEW.SERIES_CODE            
  AND S.SERIES_ID    = #CONTSETTNEW.SERIES_ID            
        AND S.EXPIRYDATE   = #CONTSETTNEW.EXPIRYDATE             
        AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE             
        AND S.SELL_BUY     = #CONTSETTNEW.SELL_BUY             
        AND S.SAUDA_DATE   =             
        (SELECT MIN(SAUDA_DATE)             
        FROM    #CONTSETT ISETT             
        WITH             
                (             
                        NOLOCK             
                )             
        WHERE   PRINTF             = '3'             
                AND S.PARTY_CODE   = ISETT.PARTY_CODE             
    AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE            
    AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE            
    AND S.SERIES_CODE  = ISETT.SERIES_CODE            
    AND S.SERIES_ID    = ISETT.SERIES_ID          
    AND S.EXPIRYDATE   = ISETT.EXPIRYDATE             
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE             
                AND S.SELL_BUY     = ISETT.SELL_BUY             
        )             
            
IF (@CONTFLAG = 'CONTRACT')            
BEGIN             
SELECT  ORDER_NO,            
        ORDER_TIME,            
        TRADE_NO,            
        TM=TRADETIME,              
  QTY = PQTY + SQTY,          
  LOTSIZE = BILLNO,          
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,            
        PQTY,            
        SQTY,              
        RATE = PRATE + SRATE,              
        PRATE,            
        SRATE,              
        BROK=PBROK+SBROK,              
        PBROK,            
        SBROK,              
        NETRATE = PNETRATE + SNETRATE,              
        PNETRATE,            
        SNETRATE,              
        AMOUNT,            
  PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIESCODE = SERIES_CODE,        
  SERIES_CODE,            
  SERIES_ID,            
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),        
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),        
        AMT = (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN -PAMT             
                ELSE SAMT END),             
        PAMT,             
        SAMT,             
        AMTSTT = (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN -(PAMT+INS_CHRG)             
                ELSE (SAMT-INS_CHRG) END),             
        PAMTSTT = (             
        CASE     
                WHEN SELL_BUY = 1             
                THEN PAMT+INS_CHRG             
                ELSE 0 END),             
        SAMTSTT = (             
        CASE             
                WHEN SELL_BUY = 2             
                THEN SAMT-INS_CHRG             
                ELSE 0 END),             
  AMTSERSTT = (        
        CASE             
                WHEN SELL_BUY = 1             
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)             
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),        
  PAMTSERSTT = (        
        CASE             
                WHEN SELL_BUY = 1             
                THEN (PAMT+INS_CHRG+SERVICE_TAX)             
                ELSE 0 END),        
  SAMTSERSTT = (        
        CASE             
                WHEN SELL_BUY = 2             
                THEN (SAMT-INS_CHRG-SERVICE_TAX)             
                ELSE 0 END),        
        EXPIRYDATE,            
        PARTY_CODE,            
        SELL_BUY,            
        CONTRACTNO,            
        SAUDA_DATE,            
        SDT=SAUDA_DATE,            
        STRIKE_PRICE,              
        PSERVICE_TAX,            
        SSERVICE_TAX,            
        YY,            
        MM,            
        DD,            
        DFLAG,            
  BROKER_CHRG,            
        TURN_TAX,            
        SEBI_TAX,            
        OTHER_CHRG,              
        PINS_CHRG=(            
        CASE             
                WHEN SELL_BUY = 1             
                THEN INS_CHRG             
                ELSE 0 END),              
        SINS_CHRG=(            
        CASE             
                WHEN SELL_BUY = 2             
                THEN INS_CHRG             
                ELSE 0 END),              
        INS_CHRG,            
        SERVICE_TAX,            
        NSERTAX,            
        BROKERAGE,            
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),            
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),            
        BRANCH_CD,            
        SUB_BROKER,            
        TRADER,            
        PRINTF,            
        SERVICE_CHRG,               
        PARTYNAME,             
        L_ADDRESS1,             
        L_ADDRESS2,             
        L_ADDRESS3,             
        L_CITY,             
        L_STATE,             
        L_ZIP,             
  SEBI_NO,            
        PAN_GIR_NO,             
        OFF_PHONE1,             
        OFF_PHONE2,               
        MAPIDID,              
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),             
        PMARKETAMT = PRATE * PQTY ,             
        SMARKETAMT = SRATE * SQTY ,             
        SERIES     = '',            
        TMARK      ='',              
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,            
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN             
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)             
       ELSE '' END),               
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN            
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)             
       ELSE '' END),               
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)        
FROM    #CONTSETTNEW             
WITH             
        (             
                NOLOCK             
        )             
WHERE   PRINTF <> 1             
ORDER BY BRANCH_CD,             
        SUB_BROKER,             
        TRADER,             
        PARTY_CODE,             
  CONTRACTNO DESC,        
  PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIES_CODE,            
  SERIES_ID,            
        EXPIRYDATE,             
        STRIKE_PRICE,             
        ORDER_NO,             
        TRADE_NO             
END             
ELSE BEGIN             
SELECT  ORDER_NO,            
        ORDER_TIME,            
        TRADE_NO,            
        TM=TRADETIME,             
  QTY = PQTY + SQTY,            
  LOTSIZE = BILLNO,          
 BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,            
        PQTY,            
        SQTY,              
        RATE = PRATE + SRATE,              
        PRATE,            
        SRATE,              
        BROK=PBROK+SBROK,              
        PBROK,            
        SBROK,              
        NETRATE = PNETRATE + SNETRATE,              
        PNETRATE,            
        SNETRATE,              
        AMOUNT,            
  PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIESCODE =  SERIES_CODE,            
  SERIES_CODE,        
  SERIES_ID,          
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),        
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),        
        AMT = (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN -PAMT             
                ELSE SAMT END),             
        PAMT,             
        SAMT,             
        AMTSTT = (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN -(PAMT+INS_CHRG)             
                ELSE (SAMT-INS_CHRG) END),             
        PAMTSTT = (             
        CASE             
                WHEN SELL_BUY = 1             
                THEN PAMT+INS_CHRG             
                ELSE 0 END),             
        SAMTSTT = (             
        CASE             
                WHEN SELL_BUY = 2         
                THEN SAMT-INS_CHRG             
                ELSE 0 END),             
  AMTSERSTT = (        
        CASE             
                WHEN SELL_BUY = 1             
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)             
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),        
  PAMTSERSTT = (        
        CASE             
                WHEN SELL_BUY = 1             
                THEN (PAMT+INS_CHRG+SERVICE_TAX)             
                ELSE 0 END),        
  SAMTSERSTT = (        
        CASE             
                WHEN SELL_BUY = 2             
                THEN (SAMT-INS_CHRG-SERVICE_TAX)             
                ELSE 0 END),        
        EXPIRYDATE,            
        PARTY_CODE,            
        SELL_BUY,            
        CONTRACTNO  ,            
        SAUDA_DATE,            
        SDT=SAUDA_DATE,            
        STRIKE_PRICE,              
        PSERVICE_TAX,            
        SSERVICE_TAX,            
        YY,            
        MM,            
        DD,            
        DFLAG,            
        BROKER_CHRG,            
        TURN_TAX,            
        SEBI_TAX,            
        OTHER_CHRG,              
        PINS_CHRG=(            
        CASE             
                WHEN SELL_BUY = 1             
                THEN INS_CHRG             
                ELSE 0 END),              
        SINS_CHRG=(            
        CASE             
                WHEN SELL_BUY = 2             
                THEN INS_CHRG             
                ELSE 0 END),              
        INS_CHRG,            
        SERVICE_TAX,            
        NSERTAX,            
        BROKERAGE,            
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),            
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),            
        BRANCH_CD,            
        SUB_BROKER,            
        TRADER,            
        PRINTF,            
        SERVICE_CHRG,               
        PARTYNAME,             
        L_ADDRESS1,             
        L_ADDRESS2,             
        L_ADDRESS3,             
        L_CITY,             
        L_STATE,             
        L_ZIP,             
  SEBI_NO,            
        PAN_GIR_NO,             
        OFF_PHONE1,             
        OFF_PHONE2,               
        MAPIDID,              
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),             
        PMARKETAMT = PRATE * PQTY ,             
        SMARKETAMT = SRATE * SQTY ,             
        SERIES     = '',            
        TMARK      ='',              
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,            
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN             
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)             
       ELSE '' END),               
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN            
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)             
       ELSE '' END),        
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)               
FROM    #CONTSETTNEW             
WITH             
        (             
                NOLOCK             
        )             
ORDER BY BRANCH_CD,             
  SUB_BROKER,             
  TRADER,             
  PARTY_CODE,             
  CONTRACTNO DESC,        
  PRODUCT_TYPE,            
  PRODUCT_CODE,            
  SERIES_CODE,            
  SERIES_ID,            
  EXPIRYDATE,             
  STRIKE_PRICE,        
  ORDER_NO,       
       
  TRADE_NO        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_24012012
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[V2_CONTSECTION_24012012]       
 (       
   @STATUSID VARCHAR(15),       
   @STATUSNAME VARCHAR(25),       
   @SAUDA_DATE VARCHAR(11),       
   @FROMPARTY_CODE VARCHAR(10),       
   @TOPARTY_CODE VARCHAR(10),       
   @BRANCH VARCHAR(10),       
   @SUB_BROKER VARCHAR(10),       
   @FROMCONTRACTNO VARCHAR(12),       
   @TOCONTRACTNO VARCHAR(12),       
   @CONTFLAG VARCHAR(10),  
   @TOSAUDA_DATE VARCHAR(11) = '',  
   @BOUNCEDFLAG INT = 0  
 )       
       
 AS       
   
 --EXEC V2_CONTSECTION 'BROKER','BROKER','MAY 24 2005','','ZZZZZZZZZZZ','%','%','0','99999999999','CONTRACT','MAY 24 2012',0  
   
 DECLARE @_STATUS CHAR(1)  
  
 IF @SUB_BROKER = 'ALL' OR @SUB_BROKER = ''       
 BEGIN       
  SET @SUB_BROKER = '%'       
 END       
 IF @BRANCH = 'ALL' OR @BRANCH = ''       
 BEGIN       
         SET @BRANCH = '%'       
 END       
 IF @FROMCONTRACTNO = ''      
 BEGIN      
  SET @FROMCONTRACTNO = 000000      
 END      
       
 IF @TOCONTRACTNO = ''      
 BEGIN      
  SET @TOCONTRACTNO = 99999999      
 END   
   
 IF @TOSAUDA_DATE = ''  
 BEGIN  
 SET @TOSAUDA_DATE = @SAUDA_DATE  
 END    
    
/*------------------  CANNED CONTRACT PLUG IN ------------------------*/      
IF EXISTS (SELECT TOP 1 PARTY_CODE FROM CONTRACT_DATA (NOLOCK) WHERE SAUDA_DATE >= @SAUDA_DATE)  
BEGIN      
 EXEC V2_CONTSECTION_DETAIL @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@BRANCH,@SUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@TOSAUDA_DATE,@BOUNCEDFLAG,@_STATUS OUTPUT      
 IF  @_STATUS =1      
 RETURN      
END  
  
  
  
/*---------------------------------------------------------------------*/      
    
  
 CREATE TABLE #BPARTY  
 (   
 PARTY_CODE VARCHAR(15)   
 )  
  
 IF @BOUNCEDFLAG <> 0  
 BEGIN  
  INSERT INTO #BPARTY  
  SELECT   
   DISTINCT PARTY_CODE   
  FROM   
   TBL_ECNBOUNCED(NOLOCK)   
  WHERE   
   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #BPARTY  
  SELECT   
   DISTINCT PARTY_CODE   
  FROM   
   CLIENT2 (NOLOCK)   
  WHERE   
   PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE  
 END  
    
SELECT  C2.PARTY_CODE,       
        C1.LONG_NAME,       
        C1.L_ADDRESS1,       
        C1.L_ADDRESS2,       
        C1.L_ADDRESS3,       
        C1.L_CITY,       
        C1.L_STATE,       
        C1.L_ZIP,       
        C1.BRANCH_CD ,       
        C1.SUB_BROKER,       
        C1.TRADER,       
        C1.PAN_GIR_NO,       
        C1.OFF_PHONE1,       
        C1.OFF_PHONE2,       
        PRINTF,       
        MAPIDID,       
        C2.SERVICE_CHRG,       
        BROKERNOTE,       
        TURNOVER_TAX,       
        SEBI_TURN_TAX,       
        C2.OTHER_CHRG,       
        INSURANCE_CHRG,      
  SEBI_NO = FD_CODE      
INTO    #CLIENTMASTER       
FROM      
  CLIENT1 C1       
WITH       
        (       
                NOLOCK       
        )       
        ,       
        CLIENT2 C2       
WITH       
        (       
                NOLOCK       
        )       
  LEFT OUTER JOIN UCC_CLIENT UC       
WITH       
        (       
                NOLOCK       
        )       
        ON C2.PARTY_CODE = UC.PARTY_CODE       
  --CLIENT_PRINT_SETTINGS  CP (NOLOCK) ,  
WHERE   C2.CL_CODE       = C1.CL_CODE       
        AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE  
        AND Cl_Type <> 'INS'               
        AND @STATUSNAME = (       
        CASE       
                WHEN @STATUSID = 'BRANCH'       
                THEN C1.BRANCH_CD       
                WHEN @STATUSID = 'SUBBROKER'       
                THEN C1.SUB_BROKER       
                WHEN @STATUSID = 'TRADER'       
                THEN C1.TRADER       
                WHEN @STATUSID = 'FAMILY'       
                THEN C1.FAMILY       
                WHEN @STATUSID = 'AREA'       
                THEN C1.AREA       
                WHEN @STATUSID = 'REGION'       
                THEN C1.REGION       
                WHEN @STATUSID = 'CLIENT'       
                THEN C2.PARTY_CODE       
                ELSE 'BROKER' END)               AND BRANCH_CD = CASE WHEN @BRANCH  ='%' THEN BRANCH_CD ELSE @BRANCH END  
        AND SUB_BROKER = CASE WHEN @SUB_BROKER  ='%' THEN SUB_BROKER ELSE @SUB_BROKER END        
        --AND PRINTF =  CP.PRINT_FLAG  
  --AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'  
  AND C2.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))  
   
  
SELECT  CONTRACTNO,       
        BILLNO=LOT_SIZE,       
        TRADE_NO,       
        PARTY_CODE,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  MARKETRATE=TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        USER_ID=TERMINALID,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        MARKETTYPE=OPTION_TYPE,       
        ORDER_NO,       
        SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
  VAL_PERC,       
        NORMAL,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,   
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        AMOUNT=TRADE_AMOUNT,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_DATE=ORDER_TIMESTAMP,       
        DUMMY1,       
        DUMMY2,       
        RESERVED1       
INTO    #FOSETT       
FROM    BFOSETTLEMENT       
WHERE   1 = 2       
INSERT       
INTO    #FOSETT       
SELECT  CONTRACTNO,       
        BILLNO=LOT_SIZE,       
        TRADE_NO,       
        PARTY_CODE,       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  MARKETRATE=TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        USER_ID=TERMINALID,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        MARKETTYPE=OPTION_TYPE,       
        ORDER_NO,       
  SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
        VAL_PERC,       
        NORMAL,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,       
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        AMOUNT=TRADE_AMOUNT,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_DATE=ORDER_TIMESTAMP,       
        DUMMY1,       
        DUMMY2,       
        RESERVED1  
FROM    BFOSETTLEMENT       
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
        AND PARTY_CODE >= @FROMPARTY_CODE       
        AND PARTY_CODE <= @TOPARTY_CODE       
        AND AUCTIONPART NOT IN ('CA')       
        AND TRADEQTY <> 0       
        AND TRADE_PRICE > 0       
        AND RESERVED1 = 0       
      
CREATE  INDEX [DELPOS]       
        ON [DBO].[#FOSETT]       
        (       
                [PARTY_CODE]       
        )       
      
SELECT  ORDER_NO,       
        ORDER_TIME = RIGHT(ORDER_DATE,8),       
        TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,       
  BILLNO,  
        PQTY = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN TRADEQTY       
                ELSE 0 END),       
        SQTY = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN TRADEQTY       
                ELSE 0 END),       
        PRATE = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL(MARKETRATE,0)       
                ELSE 0 END),       
        SRATE = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN ISNULL(MARKETRATE,0)       
           ELSE 0 END),       
        PBROK =(       
    CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL((BROKAPPLIED + (       
                CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
    ELSE 0 END),       
        SBROK =(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN ISNULL((BROKAPPLIED + (       
                CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
                ELSE 0 END),       
        PNETRATE = (       
        CASE       
                WHEN SELL_BUY =1       
                THEN ISNULL(NETRATE + (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
                ELSE 0 END),       
        SNETRATE = (       
        CASE       
                WHEN SELL_BUY =2       
                THEN ISNULL(NETRATE - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
                ELSE 0 END),       
        ISNULL(AMOUNT,0) AMOUNT ,       
        PRODUCT_TYPE= (       
        CASE       
                WHEN F.AUCTIONPART = 'EA'       
                THEN STUFF(PRODUCT_TYPE,1,3,'EA-')       
                ELSE PRODUCT_TYPE END),       
  PRODUCT_CODE = (       
        CASE       
                WHEN F.AUCTIONPART = 'EA'       
                THEN STUFF(PRODUCT_CODE,1,3,'EA-')       
                ELSE PRODUCT_CODE END),      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=(       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (TRADEQTY * NETRATE) + (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END) END ) END )       
                ELSE 0 END),       
        SAMT=(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN(TRADEQTY * NETRATE) - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END ) END ) END)       
                ELSE 0 END),       
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,       
        F.PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,       
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,       
        PSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
   ELSE (       
                        CASE       
                              WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        SSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        YY          =YEAR(SAUDA_DATE),       
        MM          =MONTH(SAUDA_DATE),       
        DD          =DAY(SAUDA_DATE),       
        DFLAG       = 1 ,       
        BROKER_CHRG = (       
        CASE       
                WHEN BROKERNOTE = 1       
                THEN BROKER_CHRG       
                ELSE 0 END ),       
        TURN_TAX = (       
        CASE       
                WHEN TURNOVER_TAX = 1       
                THEN TURN_TAX       
                ELSE 0 END),       
        SEBI_TAX = (       
        CASE       
                WHEN SEBI_TURN_TAX = 1       
                THEN SEBI_TAX       
                ELSE 0 END),       
        OTHER_CHRG = (       
        CASE       
                WHEN C.OTHER_CHRG = 1       
                THEN F.OTHER_CHRG       
                ELSE 0 END) ,       
        INS_CHRG = (       
        CASE       
                WHEN INSURANCE_CHRG = 1       
                THEN INS_CHRG       
                ELSE 0 END ),       
        SERVICE_TAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX       
                ELSE 0 END ),       
        NSERTAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX      
                ELSE 0 END ),       
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0) + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),  
        C.BRANCH_CD ,       
        C.SUB_BROKER,       
        C.TRADER,       
        PRINTF,         
        C.SERVICE_CHRG,         
        PARTYNAME=LONG_NAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,             
  OFF_PHONE2,         
        MAPIDID,      
  SEBI_NO      
INTO    #CONTSETT       
FROM    #FOSETT F,       
        #CLIENTMASTER C       
WHERE   F.PARTY_CODE     >= @FROMPARTY_CODE       
        AND F.PARTY_CODE <= @TOPARTY_CODE       
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO      
        AND F.PARTY_CODE=C.PARTY_CODE       
      
      
UPDATE         
 #CONTSETT        
SET        
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END        
      + (CASE WHEN SERVICE_CHRG = 1 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
        ELSE 0 END),        
 SERVICE_TAX = SERVICE_TAX+(CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN SERVICE_TAX+CD_TOT_BUYSERTAX ELSE 0 END        
   ELSE 0 END),        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN 0 ELSE SERVICE_TAX+CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
        PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)        
              ELSE 0 END),         
        SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK         
  - (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)        
              ELSE 0 END)        
FROM        
 CHARGES_DETAIL        
WHERE        
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)        
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE         
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE      
 AND CD_PRODUCT_CODE = PRODUCT_CODE      
 AND CD_SERIES_ID = SERIES_ID      
 AND CD_SERIES_CODE = SERIES_CODE      
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE        
 AND PRADNYA.DBO.REPLACETRADENO(CD_TRADE_NO) = TRADE_NO        
 AND CD_ORDER_NO = ORDER_NO        
        
      
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',         
 BILLNO=1,  
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,        
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX        
  ELSE 0 END),        
 SSERVICE_TAX = 0,        
 YY          =YEAR(CD_SAUDA_DATE),         
 MM          =MONTH(CD_SAUDA_DATE),         
 DD          =DAY(CD_SAUDA_DATE),         
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX = 0,         
 SEBI_TAX = 0,         
 OTHER_CHRG = 0 ,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 C.BRANCH_CD ,         
 C.SUB_BROKER,         
 C.TRADER,         
 PRINTF,           
 C.SERVICE_CHRG,           
 PARTYNAME=LONG_NAME,         
 L_ADDRESS1,         
 L_ADDRESS2,         
 L_ADDRESS3,         
 L_CITY,         
 L_STATE,         
 L_ZIP,         
 PAN_GIR_NO,         
 OFF_PHONE1,         
 OFF_PHONE2,           
 MAPIDID,        
 SEBI_NO      
FROM    CHARGES_DETAIL F,         
        #CLIENTMASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE +' 23:59:59'  
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_BUYBROK > 0        
        
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',   
 BILLNO =1,   
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,         
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = 0 ,        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX        
  ELSE 0 END),        
 YY          =YEAR(CD_SAUDA_DATE),         
 MM          =MONTH(CD_SAUDA_DATE),         
 DD       =DAY(CD_SAUDA_DATE),         
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX =0,         
 SEBI_TAX =0,         
 OTHER_CHRG = 0,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_SELLBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 C.BRANCH_CD ,         
 C.SUB_BROKER,         
 C.TRADER,         
 PRINTF,           
 C.SERVICE_CHRG,           
 PARTYNAME=LONG_NAME,         
 L_ADDRESS1,         
 L_ADDRESS2,         
 L_ADDRESS3,         
 L_CITY,         
 L_STATE,         
 L_ZIP,         
 PAN_GIR_NO,         
 OFF_PHONE1,         
 OFF_PHONE2,           
 MAPIDID,        
 SEBI_NO      
FROM    CHARGES_DETAIL F,         
        #CLIENTMASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_SELLBROK > 0          
      
      
      
      
      
SELECT  ORDER_NO  ='0000000000000000',       
        ORDER_TIME      ='                ',       
        TRADE_NO        ='0000000000000000',       
        TRADETIME       ='0000000000000000',       
  BILLNO,  
        PQTY            =SUM(PQTY),       
        SQTY            =SUM(SQTY),       
        PRATE           =(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END),       
        SRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PBROK=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PBROK*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SBROK=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SBROK*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PNETRATE=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SNETRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        AMOUNT=SUM(AMOUNT),       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=SUM(PAMT),       
        SAMT=SUM(SAMT),       
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),   
        STRIKE_PRICE,       
        PSERVICE_TAX=SUM(PSERVICE_TAX),       
        SSERVICE_TAX=SUM(SSERVICE_TAX),       
        YY,       
        MM,       
        DD,       
        DFLAG,       
        BROKER_CHRG = SUM(BROKER_CHRG),       
        TURN_TAX    = SUM(TURN_TAX),       
 SEBI_TAX    = SUM(SEBI_TAX),       
        OTHER_CHRG  = SUM(OTHER_CHRG) ,       
        INS_CHRG    = SUM(INS_CHRG),       
        SERVICE_TAX = SUM(SERVICE_TAX),       
        NSERTAX     = SUM(NSERTAX),       
        BROKERAGE   = SUM(BROKERAGE),       
        BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PRINTF,         
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,        
        MAPIDID,      
  SEBI_NO      
INTO    #CONTSETTNEW       
FROM    #CONTSETT       
WHERE   PRINTF = '3'       
GROUP BY PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        STRIKE_PRICE,       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),       
        YY,       
        MM,       
        DD,       
        DFLAG,       
        BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PRINTF,         
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,      
  SEBI_NO,BILLNO      
  
INSERT       
INTO    #CONTSETTNEW SELECT  *       
FROM    #CONTSETT       
WITH       
        (       
                NOLOCK       
        )       
WHERE   PRINTF <> '3'       
UPDATE #CONTSETTNEW       
        SET ORDER_NO = S.ORDER_NO,       
        ORDER_TIME   = S.ORDER_TIME,       
        TRADETIME    = S.TRADETIME,       
        TRADE_NO     = S.TRADE_NO       
FROM    #CONTSETT S       
WITH       
        (       
                NOLOCK       
        )       
WHERE   S.PRINTF           = #CONTSETTNEW.PRINTF       
        AND S.PRINTF       = '3'       
        AND S.PARTY_CODE   = #CONTSETTNEW.PARTY_CODE       
  AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE      
  AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE      
  AND S.SERIES_CODE  = #CONTSETTNEW.SERIES_CODE      
  AND S.SERIES_ID    = #CONTSETTNEW.SERIES_ID      
        AND S.EXPIRYDATE   = #CONTSETTNEW.EXPIRYDATE       
        AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE       
        AND S.SELL_BUY     = #CONTSETTNEW.SELL_BUY       
        AND S.SAUDA_DATE   =       
        (SELECT MIN(SAUDA_DATE)       
        FROM    #CONTSETT ISETT       
        WITH       
                (       
                        NOLOCK       
                )       
        WHERE   PRINTF             = '3'       
                AND S.PARTY_CODE   = ISETT.PARTY_CODE       
    AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE      
    AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE      
    AND S.SERIES_CODE  = ISETT.SERIES_CODE      
    AND S.SERIES_ID    = ISETT.SERIES_ID      
    AND S.EXPIRYDATE   = ISETT.EXPIRYDATE       
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE       
                AND S.SELL_BUY     = ISETT.SELL_BUY       
        )       
      
IF (@CONTFLAG = 'CONTRACT')      
BEGIN       
SELECT  ORDER_NO,      
        ORDER_TIME,      
        TRADE_NO,      
        TM=TRADETIME,        
  QTY = PQTY + SQTY,    
  LOTSIZE = BILLNO,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,      
        PQTY,      
        SQTY,        
        RATE = PRATE + SRATE,        
        PRATE,      
        SRATE,        
        BROK=PBROK+SBROK,        
        PBROK,      
        SBROK,        
        NETRATE = PNETRATE + SNETRATE,        
        PNETRATE,      
        SNETRATE,        
        AMOUNT,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIESCODE = SERIES_CODE,  
  SERIES_CODE,      
  SERIES_ID,      
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),  
        AMT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -PAMT       
                ELSE SAMT END),       
        PAMT,       
        SAMT,       
        AMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG)       
                ELSE (SAMT-INS_CHRG) END),       
        PAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN PAMT+INS_CHRG       
                ELSE 0 END),       
        SAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN SAMT-INS_CHRG       
                ELSE 0 END),       
  AMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),  
  PAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN (PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE 0 END),  
  SAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 2       
                THEN (SAMT-INS_CHRG-SERVICE_TAX)       
                ELSE 0 END),  
        EXPIRYDATE,      
        PARTY_CODE,      
        SELL_BUY,      
        CONTRACTNO,      
        SAUDA_DATE,      
        SDT=SAUDA_DATE,      
        STRIKE_PRICE,        
        PSERVICE_TAX,      
        SSERVICE_TAX,      
        YY,      
        MM,      
        DD,      
        DFLAG,      
  BROKER_CHRG,      
        TURN_TAX,      
        SEBI_TAX,      
        OTHER_CHRG,        
        PINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 1       
                THEN INS_CHRG       
                ELSE 0 END),        
        SINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 2       
                THEN INS_CHRG       
                ELSE 0 END),        
        INS_CHRG,      
        SERVICE_TAX,      
        NSERTAX,      
        BROKERAGE,      
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),      
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),      
        BRANCH_CD,      
        SUB_BROKER,      
        TRADER,      
        PRINTF,      
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
  SEBI_NO,      
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,        
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),       
        PMARKETAMT = PRATE * PQTY ,       
        SMARKETAMT = SRATE * SQTY ,       
        SERIES     = '',      
        TMARK      ='',        
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,      
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN       
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN      
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)  
FROM    #CONTSETTNEW       
WITH       
        (       
                NOLOCK       
        )       
WHERE   PRINTF <> 1       
ORDER BY BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        STRIKE_PRICE,       
        ORDER_NO,       
        TRADE_NO       
END       
ELSE BEGIN       
SELECT  ORDER_NO,      
        ORDER_TIME,      
        TRADE_NO,      
        TM=TRADETIME,       
  QTY = PQTY + SQTY,      
  LOTSIZE = BILLNO,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,      
        PQTY,      
        SQTY,        
        RATE = PRATE + SRATE,        
        PRATE,      
        SRATE,        
        BROK=PBROK+SBROK,        
        PBROK,      
        SBROK,        
        NETRATE = PNETRATE + SNETRATE,        
        PNETRATE,      
        SNETRATE,        
        AMOUNT,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIESCODE =  SERIES_CODE,      
  SERIES_CODE,  
  SERIES_ID,    
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),  
        AMT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -PAMT       
                ELSE SAMT END),       
        PAMT,       
        SAMT,       
        AMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG)       
                ELSE (SAMT-INS_CHRG) END),       
        PAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN PAMT+INS_CHRG       
                ELSE 0 END),       
        SAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 2   
                THEN SAMT-INS_CHRG       
                ELSE 0 END),       
  AMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),  
  PAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN (PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE 0 END),  
  SAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 2       
                THEN (SAMT-INS_CHRG-SERVICE_TAX)       
                ELSE 0 END),  
        EXPIRYDATE,      
        PARTY_CODE,      
        SELL_BUY,      
        CONTRACTNO,      
        SAUDA_DATE,      
        SDT=SAUDA_DATE,      
        STRIKE_PRICE,        
        PSERVICE_TAX,      
        SSERVICE_TAX,      
        YY,      
        MM,      
        DD,      
        DFLAG,      
        BROKER_CHRG,      
        TURN_TAX,      
        SEBI_TAX,      
        OTHER_CHRG,        
        PINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 1       
                THEN INS_CHRG       
                ELSE 0 END),        
        SINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 2       
                THEN INS_CHRG       
                ELSE 0 END),        
        INS_CHRG,      
        SERVICE_TAX,      
        NSERTAX,      
        BROKERAGE,      
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),      
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),      
        BRANCH_CD,      
        SUB_BROKER,      
        TRADER,      
        PRINTF,      
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
  SEBI_NO,      
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,        
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),       
        PMARKETAMT = PRATE * PQTY ,       
        SMARKETAMT = SRATE * SQTY ,       
        SERIES     = '',      
        TMARK      ='',        
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,      
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN       
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN      
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),  
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
FROM    #CONTSETTNEW       
WITH       
        (       
                NOLOCK       
        )       
ORDER BY BRANCH_CD,       
  SUB_BROKER,       
  TRADER,       
  PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  EXPIRYDATE,       
  STRIKE_PRICE,  
  ORDER_NO,  
  TRADE_NO  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_DETAIL
-- --------------------------------------------------
CREATE   PROC [dbo].[V2_CONTSECTION_DETAIL]     
(    
  @STATUSID VARCHAR(15),    
  @STATUSNAME VARCHAR(25),     
  @SAUDA_DATE VARCHAR(11),     
  @FROMPARTY_CODE VARCHAR(10),     
  @TOPARTY_CODE VARCHAR(10),     
  @BRANCH VARCHAR(10),     
  @SUB_BROKER VARCHAR(10),     
  @FROMCONTRACTNO VARCHAR(12),     
  @TOCONTRACTNO VARCHAR(12),     
  @CONTFLAG VARCHAR(10),  
  @TOSAUDA_DATE VARCHAR(11) = '',
  @BOUNCEDFLAG INT = 0,
  @STATUS AS CHAR(1) OUTPUT      
)     
AS  
BEGIN
    

--CHECK WHETHER RECORDS PRESENT OR NOT
	IF NOT EXISTS (SELECT 1 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM 
	 WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE    
	 AND SAUDA_DATE <= @TOSAUDA_DATE  
	 AND CM.PARTY_CODE >= @FROMPARTY_CODE   
	 AND CM.PARTY_CODE <= @TOPARTY_CODE   
	 AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO     
     AND BRANCH_CD LIKE @BRANCH   
     AND SUBBROKER LIKE @SUB_BROKER    
     AND @STATUSNAME = (  
    CASE  
        WHEN @STATUSID = 'BRANCH'     
        THEN CM.BRANCH_CD     
        WHEN @STATUSID = 'SUBBROKER'     
        THEN CM.SUBBROKER     
        WHEN @STATUSID = 'TRADER'     
        THEN CM.TRADER     
        WHEN @STATUSID = 'FAMILY'     
        THEN CM.FAMILY     
        WHEN @STATUSID = 'AREA'     
        THEN CM.AREA     
        WHEN @STATUSID = 'REGION'     
        THEN CM.REGION     
        WHEN @STATUSID = 'CLIENT'     
        THEN CM.PARTY_CODE     
        ELSE 'BROKER'   
		END)  )
      BEGIN
		SET @STATUS =0
        RETURN 
      END  

  
	 CREATE TABLE #BPARTY  
	 (   
	 PARTY_CODE VARCHAR(15)   
	 )  
	  
	 IF @BOUNCEDFLAG <> 0  
	 BEGIN  
	  INSERT INTO #BPARTY  
	  SELECT   
	   DISTINCT PARTY_CODE   
	  FROM   
	   TBL_ECNBOUNCED(NOLOCK)   
	  WHERE   
	   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
	 END  
	 ELSE  
	 BEGIN  
	  INSERT INTO #BPARTY  
	  SELECT   
	   DISTINCT PARTY_CODE   
	  FROM   
	   CLIENT2 (NOLOCK)   
	  WHERE   
	   PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE  
	 END  

	IF (@CONTFLAG = 'CONTRACT')  
	BEGIN   
	SELECT  ORDER_NO,  
			ORDER_TIME,  
			TRADE_NO,  
			TM=TRADETIME,    
	 QTY = PQTY + SQTY,  
	 BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,  
			PQTY,  
			SQTY,    
			RATE = PRATE + SRATE,    
			PRATE,  
			SRATE,    
			BROK=PBROK+SBROK,    
			PBROK,  
			SBROK,    
			NETRATE = PNETRATE + SNETRATE,    
			PNETRATE,  
			SNETRATE,    
			AMOUNT,  
	 PRODUCT_TYPE,  
	 PRODUCT_CODE,  
	 SERIES_CODE,  
	 SERIES_ID,  
	SERIESCODE =  SERIES_CODE,    
	CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),
	NOOFCONTRACT = (PQTY + SQTY)/(CASE WHEN LOTSIZE=0 THEN 1 ELSE LOTSIZE END),
			AMT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -PAMT   
					ELSE SAMT END),   
			PAMT,   
			SAMT,   
			AMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -(PAMT+INS_CHRG)   
					ELSE (SAMT-INS_CHRG) END),   
			PAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN PAMT+INS_CHRG   
					ELSE 0 END),   
			SAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SAMT-INS_CHRG   
					ELSE 0 END),   
			EXPIRYDATE,  
			CM.PARTY_CODE,  
			SELL_BUY,  
			CONTRACTNO,  
			SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),  
			SDT=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),
			STRIKE_PRICE,    
			PSERVICE_TAX,  
			SSERVICE_TAX,  
			YY          =YEAR(SAUDA_DATE),     
			MM          =MONTH(SAUDA_DATE),     
			DD          =DAY(SAUDA_DATE),
			DFLAG,  
	   BROKER_CHRG,  
			TURN_TAX,  
			SEBI_TAX,  
			C.OTHER_CHRG,    
			PINS_CHRG=(  
			CASE   
					WHEN SELL_BUY = 1   
					THEN INS_CHRG   
					ELSE 0 END),    
			SINS_CHRG=(  
			CASE   
					WHEN SELL_BUY = 2   
					THEN INS_CHRG   
					ELSE 0 END),    
			INS_CHRG,  
			SERVICE_TAX,  
			NSERTAX,  
			BROKERAGE,  
			PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),  
			SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),  
			CM.BRANCH_CD,  
			CM.SUBBROKER AS SUB_BROKER,  
			CM.TRADER,  
			C.PRINTF,  
			C.SERVICE_CHRG,     
			CM.PARTYNAME,   
			CM.L_ADDRESS1,   
			CM.L_ADDRESS2,   
			CM.L_ADDRESS3,   
			CM.L_CITY,   
			CM.L_STATE,   
			CM.L_ZIP,   
	 CM.SEBI_NO,  
			CM.PAN_GIR_NO,   
			CM.OFF_PHONE1,   
			CM.OFF_PHONE2,     
			CM.MAPIDID,    
			MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),   
			PMARKETAMT = PRATE * PQTY ,   
			SMARKETAMT = SRATE * SQTY ,   
			SERIES     = '',  
			TMARK      ='',    
			SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,  
			PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN   
	   RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)   
		ELSE '' END),     
			SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN  
	   RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)   
		ELSE '' END),
		LOTSIZE,
		BILLNO=LOTSIZE,
		SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
     
	FROM     CONTRACT_DATA C (NOLOCK) ,  CONTRACT_MASTER CM
	WHERE   C.PRINTF <> 1  AND  CM.PARTY_CODE = C.PARTY_CODE   
	 AND LEFT(C.SAUDA_DATE,11) = LEFT(CM.TRADE_DATE,11) 
	 AND SAUDA_DATE >= @SAUDA_DATE   
	 AND SAUDA_DATE <= @TOSAUDA_DATE  
	 AND CM.PARTY_CODE >= @FROMPARTY_CODE   
	 AND CM.PARTY_CODE <= @TOPARTY_CODE
	 
	 AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO     
     AND BRANCH_CD LIKE @BRANCH   
     AND SUBBROKER LIKE @SUB_BROKER       
     AND @STATUSNAME = (  
		CASE  
        WHEN @STATUSID = 'BRANCH'     
        THEN CM.BRANCH_CD     
        WHEN @STATUSID = 'SUBBROKER'     
        THEN CM.SUBBROKER     
        WHEN @STATUSID = 'TRADER'     
        THEN CM.TRADER     
        WHEN @STATUSID = 'FAMILY'     
        THEN CM.FAMILY     
        WHEN @STATUSID = 'AREA'     
        THEN CM.AREA     
        WHEN @STATUSID = 'REGION'     
        THEN CM.REGION     
        WHEN @STATUSID = 'CLIENT'     
        THEN CM.PARTY_CODE     
        ELSE 'BROKER'   
		END)  
	AND C.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))  
  
	ORDER BY CM.BRANCH_CD,   
			SUB_BROKER,   
			CM.TRADER,   
			CM.PARTY_CODE,   
	 PRODUCT_TYPE,  
	 PRODUCT_CODE,  
	 SERIES_CODE,  
	 SERIES_ID,  
			EXPIRYDATE,   
			STRIKE_PRICE,   
			ORDER_NO,   
			TRADE_NO   
	END  
 
	ELSE BEGIN   
	SELECT  ORDER_NO,  
			ORDER_TIME,  
			TRADE_NO,  
			TM=TRADETIME,   
	 QTY = PQTY + SQTY,  
	 BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,  
			PQTY,  
			SQTY,    
			RATE = PRATE + SRATE,    
			PRATE,  
			SRATE,    
			BROK=PBROK+SBROK,    
			PBROK,  
			SBROK,    
			NETRATE = PNETRATE + SNETRATE,    
			PNETRATE,  
			SNETRATE,    
			AMOUNT,  
	 PRODUCT_TYPE,  
	 PRODUCT_CODE,  
	 SERIES_CODE,  
	 SERIES_ID,  
	SERIESCODE =  SERIES_CODE,    
	CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),
	NOOFCONTRACT = (PQTY + SQTY)/(CASE WHEN LOTSIZE=0 THEN 1 ELSE LOTSIZE END),
			AMT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -PAMT   
					ELSE SAMT END),   
			PAMT,   
			SAMT,   
			AMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -(PAMT+INS_CHRG)   
					ELSE (SAMT-INS_CHRG) END),   
			PAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN PAMT+INS_CHRG   
					ELSE 0 END),   
			SAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SAMT-INS_CHRG   
					ELSE 0 END),   
			EXPIRYDATE,  
			CM.PARTY_CODE,  
			SELL_BUY,  
			CONTRACTNO,  
			SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),    
			SDT=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),
			STRIKE_PRICE,    
			PSERVICE_TAX,  
			SSERVICE_TAX,  
			YY          =YEAR(SAUDA_DATE),     
			MM          =MONTH(SAUDA_DATE),     
			DD          =DAY(SAUDA_DATE),
			DFLAG,  
			BROKER_CHRG,  
			TURN_TAX,  
			SEBI_TAX,  
			C.OTHER_CHRG,    
			PINS_CHRG=(  
			CASE   
					WHEN SELL_BUY = 1   
					THEN INS_CHRG   
					ELSE 0 END),    
			SINS_CHRG=(  
			CASE   
					WHEN SELL_BUY = 2   
					THEN INS_CHRG   
					ELSE 0 END),    
			INS_CHRG,  
			SERVICE_TAX,  
			NSERTAX,  
			BROKERAGE,  
			PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),  
			SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),  
			CM.BRANCH_CD,  
			SUBBROKER AS SUB_BROKER,  
			CM.TRADER,  
			C.PRINTF,  
			C.SERVICE_CHRG,     
			CM.PARTYNAME,   
			CM.L_ADDRESS1,   
			CM.L_ADDRESS2,   
			CM.L_ADDRESS3,   
			CM.L_CITY,   
			CM.L_STATE,   
			CM.L_ZIP,   
	        CM.SEBI_NO,  
			CM.PAN_GIR_NO,   
			CM.OFF_PHONE1,   
			CM.OFF_PHONE2,     
			CM.MAPIDID,    
			MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),   
			PMARKETAMT = PRATE * PQTY ,   
			SMARKETAMT = SRATE * SQTY ,   
			SERIES     = '',  
			TMARK      ='',    
			SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,  
			PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN   
	   RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)   
	  ELSE '' END),     
			SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN  
	   RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)   
	  ELSE '' END),
		LOTSIZE,
		BILLNO=LOTSIZE,
		SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
	FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM , CLIENT_PRINT_SETTINGS  CP (NOLOCK) 
	 WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE  AND LEFT(C.SAUDA_DATE,11) = LEFT(CM.TRADE_DATE,11)
	 AND SAUDA_DATE <= @TOSAUDA_DATE  
	 AND CM.PARTY_CODE >= @FROMPARTY_CODE   
	 AND CM.PARTY_CODE <= @TOPARTY_CODE   
	 AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO     
     AND BRANCH_CD LIKE @BRANCH   
     AND SUBBROKER LIKE @SUB_BROKER    
     AND @STATUSNAME = (  
    CASE  
        WHEN @STATUSID = 'BRANCH'     
        THEN CM.BRANCH_CD     
        WHEN @STATUSID = 'SUBBROKER'     
        THEN CM.SUBBROKER     
        WHEN @STATUSID = 'TRADER'     
        THEN CM.TRADER     
        WHEN @STATUSID = 'FAMILY'     
        THEN CM.FAMILY     
        WHEN @STATUSID = 'AREA'     
        THEN CM.AREA     
        WHEN @STATUSID = 'REGION'     
        THEN CM.REGION     
        WHEN @STATUSID = 'CLIENT'     
        THEN CM.PARTY_CODE     
        ELSE 'BROKER'   
		END)  
           AND C.PRINTF =  CP.PRINT_FLAG
	   AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'
 	   AND C.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))  

	ORDER BY CM.BRANCH_CD,   
	SUB_BROKER,   
			CM.TRADER,   
			CM.PARTY_CODE,   
	 PRODUCT_TYPE,  
	 PRODUCT_CODE,  
	 SERIES_CODE,  
	 SERIES_ID,  
			EXPIRYDATE,   
			STRIKE_PRICE,   
			ORDER_NO,   
			TRADE_NO   
	END

   IF @@ROWCOUNT>0 
      SET @STATUS=1 
   ELSE 
	SET @STATUS=0  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_DETAIL_14012012
-- --------------------------------------------------
CREATE   PROC [dbo].[V2_CONTSECTION_DETAIL_14012012]       
(      
  @STATUSID VARCHAR(15),      
  @STATUSNAME VARCHAR(25),       
  @SAUDA_DATE VARCHAR(11),       
  @FROMPARTY_CODE VARCHAR(10),       
  @TOPARTY_CODE VARCHAR(10),       
  @BRANCH VARCHAR(10),       
  @SUB_BROKER VARCHAR(10),       
  @FROMCONTRACTNO VARCHAR(12),       
  @TOCONTRACTNO VARCHAR(12),       
  @CONTFLAG VARCHAR(10),    
  @TOSAUDA_DATE VARCHAR(11) = '',  
  @STATUS AS CHAR(1) OUTPUT        
)       
AS    
BEGIN  
      
  
--CHECK WHETHER RECORDS PRESENT OR NOT  
 IF NOT EXISTS (SELECT 1 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM   
  WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE      
  AND SAUDA_DATE <= @TOSAUDA_DATE    
  AND CM.PARTY_CODE >= @FROMPARTY_CODE     
  AND CM.PARTY_CODE <= @TOPARTY_CODE     
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO       
     AND BRANCH_CD LIKE @BRANCH     
     AND SUBBROKER LIKE @SUB_BROKER      
     AND @STATUSNAME = (    
    CASE    
        WHEN @STATUSID = 'BRANCH'       
        THEN CM.BRANCH_CD       
        WHEN @STATUSID = 'SUBBROKER'       
        THEN CM.SUBBROKER       
        WHEN @STATUSID = 'TRADER'       
        THEN CM.TRADER       
        WHEN @STATUSID = 'FAMILY'       
        THEN CM.FAMILY       
        WHEN @STATUSID = 'AREA'       
        THEN CM.AREA       
        WHEN @STATUSID = 'REGION'       
        THEN CM.REGION       
        WHEN @STATUSID = 'CLIENT'       
        THEN CM.PARTY_CODE       
        ELSE 'BROKER'     
  END)  )  
      BEGIN  
  SET @STATUS =0  
        RETURN   
      END    
  
 IF (@CONTFLAG = 'CONTRACT')    
 BEGIN     
 SELECT  ORDER_NO,    
   ORDER_TIME,    
   TRADE_NO,    
   TM=TRADETIME,      
  QTY = PQTY + SQTY,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,    
   PQTY,    
   SQTY,      
   RATE = PRATE + SRATE,      
   PRATE,    
   SRATE,      
   BROK=PBROK+SBROK,      
   PBROK,    
   SBROK,      
   NETRATE = PNETRATE + SNETRATE,      
   PNETRATE,    
   SNETRATE,      
   AMOUNT,    
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
 SERIESCODE =  SERIES_CODE,      
 CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
 NOOFCONTRACT = 1,  
 LOTSIZE=1,  
   AMT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -PAMT     
     ELSE SAMT END),     
   PAMT,     
   SAMT,     
   AMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -(PAMT+INS_CHRG)     
     ELSE (SAMT-INS_CHRG) END),     
   PAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN PAMT+INS_CHRG     
     ELSE 0 END),     
   SAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN SAMT-INS_CHRG     
     ELSE 0 END),     
   EXPIRYDATE,    
   CM.PARTY_CODE,    
   SELL_BUY,    
   CONTRACTNO,    
   SAUDA_DATE,    
   SDT=SAUDA_DATE,    
   STRIKE_PRICE,      
   PSERVICE_TAX,    
   SSERVICE_TAX,    
   YY          =YEAR(SAUDA_DATE),       
   MM          =MONTH(SAUDA_DATE),       
   DD          =DAY(SAUDA_DATE),  
   DFLAG,    
    BROKER_CHRG,    
   TURN_TAX,    
   SEBI_TAX,    
   C.OTHER_CHRG,      
   PINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 1     
     THEN INS_CHRG     
     ELSE 0 END),      
   SINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 2     
     THEN INS_CHRG     
     ELSE 0 END),      
   INS_CHRG,    
   SERVICE_TAX,    
   NSERTAX,    
   BROKERAGE,    
   PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),    
   SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),    
   CM.BRANCH_CD,    
   CM.SUBBROKER AS SUB_BROKER,    
   CM.TRADER,    
   C.PRINTF,    
   C.SERVICE_CHRG,       
   CM.PARTYNAME,     
   CM.L_ADDRESS1,     
   CM.L_ADDRESS2,     
   CM.L_ADDRESS3,     
   CM.L_CITY,     
   CM.L_STATE,     
   CM.L_ZIP,     
  CM.SEBI_NO,    
   CM.PAN_GIR_NO,     
   CM.OFF_PHONE1,     
   CM.OFF_PHONE2,       
   CM.MAPIDID,      
   MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),     
   PMARKETAMT = PRATE * PQTY ,     
   SMARKETAMT = SRATE * SQTY ,     
   SERIES     = '',    
   TMARK      ='',      
   SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,    
   PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN     
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
   ELSE '' END),       
   SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN    
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
   ELSE '' END)       
 FROM     CONTRACT_DATA C (NOLOCK) ,  CONTRACT_MASTER CM  
 WHERE   C.PRINTF <> 1  AND  CM.PARTY_CODE = C.PARTY_CODE      
  AND SAUDA_DATE >= @SAUDA_DATE     
  AND SAUDA_DATE <= @TOSAUDA_DATE    
  AND CM.PARTY_CODE >= @FROMPARTY_CODE     
  AND CM.PARTY_CODE <= @TOPARTY_CODE     
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO       
     AND BRANCH_CD LIKE @BRANCH     
     AND SUBBROKER LIKE @SUB_BROKER         
     AND @STATUSNAME = (    
    CASE    
        WHEN @STATUSID = 'BRANCH'       
        THEN CM.BRANCH_CD       
        WHEN @STATUSID = 'SUBBROKER'       
        THEN CM.SUBBROKER       
        WHEN @STATUSID = 'TRADER'       
        THEN CM.TRADER       
        WHEN @STATUSID = 'FAMILY'       
        THEN CM.FAMILY       
        WHEN @STATUSID = 'AREA'       
        THEN CM.AREA       
        WHEN @STATUSID = 'REGION'       
        THEN CM.REGION       
        WHEN @STATUSID = 'CLIENT'       
        THEN CM.PARTY_CODE       
        ELSE 'BROKER'     
  END)    
 ORDER BY CM.BRANCH_CD,     
   SUB_BROKER,     
   CM.TRADER,     
   CM.PARTY_CODE,     
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
   EXPIRYDATE,     
   STRIKE_PRICE,     
   ORDER_NO,     
   TRADE_NO     
 END    
   
 ELSE BEGIN     
 SELECT  ORDER_NO,    
   ORDER_TIME,    
   TRADE_NO,    
   TM=TRADETIME,     
  QTY = PQTY + SQTY,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,    
   PQTY,    
   SQTY,      
   RATE = PRATE + SRATE,      
   PRATE,    
   SRATE,      
   BROK=PBROK+SBROK,      
   PBROK,    
   SBROK,      
   NETRATE = PNETRATE + SNETRATE,      
   PNETRATE,    
   SNETRATE,      
   AMOUNT,    
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
 SERIESCODE =  SERIES_CODE,      
 CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
 NOOFCONTRACT = 1,  
 LOTSIZE=1,  
   AMT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -PAMT     
     ELSE SAMT END),     
   PAMT,     
   SAMT,     
   AMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -(PAMT+INS_CHRG)     
     ELSE (SAMT-INS_CHRG) END),     
   PAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN PAMT+INS_CHRG     
     ELSE 0 END),     
   SAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN SAMT-INS_CHRG     
     ELSE 0 END),     
   EXPIRYDATE,    
   CM.PARTY_CODE,    
   SELL_BUY,    
   CONTRACTNO,    
   SAUDA_DATE,    
   SDT=SAUDA_DATE,    
   STRIKE_PRICE,      
   PSERVICE_TAX,    
   SSERVICE_TAX,    
   YY          =YEAR(SAUDA_DATE),       
   MM          =MONTH(SAUDA_DATE),       
   DD          =DAY(SAUDA_DATE),  
   DFLAG,    
   BROKER_CHRG,    
   TURN_TAX,    
   SEBI_TAX,    
   C.OTHER_CHRG,      
   PINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 1     
     THEN INS_CHRG     
     ELSE 0 END),      
   SINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 2     
     THEN INS_CHRG     
     ELSE 0 END),      
   INS_CHRG,    
   SERVICE_TAX,    
   NSERTAX,    
   BROKERAGE,    
   PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),    
   SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),    
   CM.BRANCH_CD,    
   SUBBROKER AS SUB_BROKER,    
   CM.TRADER,    
   C.PRINTF,    
   C.SERVICE_CHRG,       
   CM.PARTYNAME,     
   CM.L_ADDRESS1,     
   CM.L_ADDRESS2,     
   CM.L_ADDRESS3,     
   CM.L_CITY,     
   CM.L_STATE,     
   CM.L_ZIP,     
         CM.SEBI_NO,    
   CM.PAN_GIR_NO,     
   CM.OFF_PHONE1,     
   CM.OFF_PHONE2,       
   CM.MAPIDID,      
   MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),     
   PMARKETAMT = PRATE * PQTY ,     
   SMARKETAMT = SRATE * SQTY ,     
   SERIES     = '',    
   TMARK      ='',      
   SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,    
   PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN     
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
   ELSE '' END),       
   SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN    
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
   ELSE '' END)       
 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM , CLIENT_PRINT_SETTINGS  CP (NOLOCK)   
  WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE      
  AND SAUDA_DATE <= @TOSAUDA_DATE    
  AND CM.PARTY_CODE >= @FROMPARTY_CODE     
  AND CM.PARTY_CODE <= @TOPARTY_CODE     
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO       
     AND BRANCH_CD LIKE @BRANCH     
     AND SUBBROKER LIKE @SUB_BROKER      
     AND @STATUSNAME = (    
    CASE    
        WHEN @STATUSID = 'BRANCH'       
        THEN CM.BRANCH_CD       
        WHEN @STATUSID = 'SUBBROKER'       
        THEN CM.SUBBROKER       
        WHEN @STATUSID = 'TRADER'       
        THEN CM.TRADER       
        WHEN @STATUSID = 'FAMILY'       
        THEN CM.FAMILY       
        WHEN @STATUSID = 'AREA'       
        THEN CM.AREA       
        WHEN @STATUSID = 'REGION'       
        THEN CM.REGION       
        WHEN @STATUSID = 'CLIENT'       
        THEN CM.PARTY_CODE       
        ELSE 'BROKER'     
  END)    
           AND C.PRINTF =  CP.PRINT_FLAG  
   -- AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'  
   
 ORDER BY CM.BRANCH_CD,     
 SUB_BROKER,     
   CM.TRADER,     
   CM.PARTY_CODE,     
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
   EXPIRYDATE,     
   STRIKE_PRICE,     
   ORDER_NO,     
   TRADE_NO     
 END  
  
   IF @@ROWCOUNT>0   
      SET @STATUS=1   
   ELSE   
 SET @STATUS=0    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_DETAIL_18122012
-- --------------------------------------------------
  
CREATE   PROC [dbo].[V2_CONTSECTION_DETAIL_18122012]       
(      
  @STATUSID VARCHAR(15),      
  @STATUSNAME VARCHAR(25),       
  @SAUDA_DATE VARCHAR(11),       
  @FROMPARTY_CODE VARCHAR(10),       
  @TOPARTY_CODE VARCHAR(10),       
  @BRANCH VARCHAR(10),       
  @SUB_BROKER VARCHAR(10),       
  @FROMCONTRACTNO VARCHAR(12),       
  @TOCONTRACTNO VARCHAR(12),       
  @CONTFLAG VARCHAR(10),    
  @TOSAUDA_DATE VARCHAR(11) = '',  
  @BOUNCEDFLAG INT = 0,  
  @STATUS AS CHAR(1) OUTPUT        
)       
AS    
BEGIN  
      
  
--CHECK WHETHER RECORDS PRESENT OR NOT  
 IF NOT EXISTS (SELECT 1 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM   
  WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE      
  AND SAUDA_DATE <= @TOSAUDA_DATE    
  AND CM.PARTY_CODE >= @FROMPARTY_CODE     
  AND CM.PARTY_CODE <= @TOPARTY_CODE     
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO       
     AND BRANCH_CD LIKE @BRANCH     
     AND SUBBROKER LIKE @SUB_BROKER      
     AND @STATUSNAME = (    
    CASE    
        WHEN @STATUSID = 'BRANCH'       
        THEN CM.BRANCH_CD       
        WHEN @STATUSID = 'SUBBROKER'       
        THEN CM.SUBBROKER       
        WHEN @STATUSID = 'TRADER'       
        THEN CM.TRADER       
        WHEN @STATUSID = 'FAMILY'       
        THEN CM.FAMILY       
        WHEN @STATUSID = 'AREA'       
        THEN CM.AREA       
        WHEN @STATUSID = 'REGION'       
        THEN CM.REGION       
        WHEN @STATUSID = 'CLIENT'       
        THEN CM.PARTY_CODE       
        ELSE 'BROKER'     
  END)  )  
      BEGIN  
  SET @STATUS =0  
        RETURN   
      END    
  
    
  CREATE TABLE #BPARTY    
  (     
  PARTY_CODE VARCHAR(15)     
  )    
     
  IF @BOUNCEDFLAG <> 0    
  BEGIN    
   INSERT INTO #BPARTY    
   SELECT     
    DISTINCT PARTY_CODE     
   FROM     
    TBL_ECNBOUNCED(NOLOCK)     
   WHERE     
    SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #BPARTY    
   SELECT     
    DISTINCT PARTY_CODE     
   FROM     
    CLIENT2 (NOLOCK)     
   WHERE     
    PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE    
  END    
  
 IF (@CONTFLAG = 'CONTRACT')    
 BEGIN     
 SELECT  ORDER_NO,    
   ORDER_TIME,    
   TRADE_NO,    
   TM=TRADETIME,      
  QTY = PQTY + SQTY,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,    
   PQTY,    
   SQTY,      
   RATE = PRATE + SRATE,      
   PRATE,    
   SRATE,      
   BROK=PBROK+SBROK,      
   PBROK,    
   SBROK,      
   NETRATE = PNETRATE + SNETRATE,      
   PNETRATE,    
   SNETRATE,      
   AMOUNT,    
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
 SERIESCODE =  SERIES_CODE,      
 CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
 NOOFCONTRACT = (PQTY + SQTY)/(CASE WHEN LOTSIZE=0 THEN 1 ELSE LOTSIZE END),  
   AMT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -PAMT     
     ELSE SAMT END),     
   PAMT,     
   SAMT,     
   AMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -(PAMT+INS_CHRG)     
     ELSE (SAMT-INS_CHRG) END),     
   PAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN PAMT+INS_CHRG     
     ELSE 0 END),     
   SAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN SAMT-INS_CHRG     
     ELSE 0 END),     
   EXPIRYDATE,    
   CM.PARTY_CODE,    
   SELL_BUY,    
   CONTRACTNO,    
   SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),    
   SDT=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),  
   STRIKE_PRICE,      
   PSERVICE_TAX,    
   SSERVICE_TAX,    
   YY          =YEAR(SAUDA_DATE),       
   MM          =MONTH(SAUDA_DATE),       
   DD          =DAY(SAUDA_DATE),  
   DFLAG,    
    BROKER_CHRG,    
   TURN_TAX,    
   SEBI_TAX,    
   C.OTHER_CHRG,      
   PINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 1     
     THEN INS_CHRG     
     ELSE 0 END),      
   SINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 2     
     THEN INS_CHRG     
     ELSE 0 END),      
   INS_CHRG,    
   SERVICE_TAX,    
   NSERTAX,    
   BROKERAGE,    
   PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),    
   SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),    
   CM.BRANCH_CD,    
   CM.SUBBROKER AS SUB_BROKER,    
   CM.TRADER,    
   C.PRINTF,    
   C.SERVICE_CHRG,       
   CM.PARTYNAME,     
   CM.L_ADDRESS1,     
   CM.L_ADDRESS2,     
   CM.L_ADDRESS3,     
   CM.L_CITY,     
   CM.L_STATE,     
   CM.L_ZIP,     
  CM.SEBI_NO,    
   CM.PAN_GIR_NO,     
   CM.OFF_PHONE1,     
   CM.OFF_PHONE2,       
   CM.MAPIDID,      
   MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),     
   PMARKETAMT = PRATE * PQTY ,     
   SMARKETAMT = SRATE * SQTY ,     
   SERIES     = '',    
   TMARK      ='',      
   SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,    
   PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN     
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
  ELSE '' END),       
   SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN    
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
  ELSE '' END),  
  LOTSIZE,  
  BILLNO=LOTSIZE,  
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)           
       
 FROM     CONTRACT_DATA C (NOLOCK) ,  CONTRACT_MASTER CM  
 WHERE   C.PRINTF <> 1  AND  CM.PARTY_CODE = C.PARTY_CODE     
  AND LEFT(C.SAUDA_DATE,11) = LEFT(CM.TRADE_DATE,11)   
  AND SAUDA_DATE >= @SAUDA_DATE     
  AND SAUDA_DATE <= @TOSAUDA_DATE    
  AND CM.PARTY_CODE >= @FROMPARTY_CODE     
  AND CM.PARTY_CODE <= @TOPARTY_CODE     
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO       
     AND BRANCH_CD LIKE @BRANCH     
     AND SUBBROKER LIKE @SUB_BROKER         
     AND @STATUSNAME = (    
  CASE    
        WHEN @STATUSID = 'BRANCH'       
        THEN CM.BRANCH_CD       
        WHEN @STATUSID = 'SUBBROKER'       
        THEN CM.SUBBROKER       
        WHEN @STATUSID = 'TRADER'       
        THEN CM.TRADER       
        WHEN @STATUSID = 'FAMILY'       
        THEN CM.FAMILY       
        WHEN @STATUSID = 'AREA'       
        THEN CM.AREA       
        WHEN @STATUSID = 'REGION'       
        THEN CM.REGION       
        WHEN @STATUSID = 'CLIENT'       
        THEN CM.PARTY_CODE       
        ELSE 'BROKER'     
  END)    
 AND C.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))    
    
 ORDER BY CM.BRANCH_CD,     
   SUB_BROKER,     
   CM.TRADER,     
   CM.PARTY_CODE,     
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
   EXPIRYDATE,     
   STRIKE_PRICE,     
   ORDER_NO,     
   TRADE_NO     
 END    
   
 ELSE BEGIN     
 SELECT  ORDER_NO,    
   ORDER_TIME,    
   TRADE_NO,    
   TM=TRADETIME,     
  QTY = PQTY + SQTY,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,    
   PQTY,    
   SQTY,      
   RATE = PRATE + SRATE,      
   PRATE,    
   SRATE,      
   BROK=PBROK+SBROK,      
   PBROK,    
   SBROK,      
   NETRATE = PNETRATE + SNETRATE,      
   PNETRATE,    
   SNETRATE,      
   AMOUNT,    
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
 SERIESCODE =  SERIES_CODE,      
 CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
 NOOFCONTRACT = (PQTY + SQTY)/(CASE WHEN LOTSIZE=0 THEN 1 ELSE LOTSIZE END),  
   AMT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -PAMT     
     ELSE SAMT END),     
   PAMT,     
   SAMT,     
   AMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN -(PAMT+INS_CHRG)     
     ELSE (SAMT-INS_CHRG) END),     
   PAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN PAMT+INS_CHRG     
     ELSE 0 END),     
   SAMTSTT = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN SAMT-INS_CHRG     
     ELSE 0 END),     
   EXPIRYDATE,    
   CM.PARTY_CODE,    
   SELL_BUY,    
   CONTRACTNO,    
   SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),      
   SDT=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),  
   STRIKE_PRICE,      
   PSERVICE_TAX,    
   SSERVICE_TAX,    
   YY          =YEAR(SAUDA_DATE),       
   MM          =MONTH(SAUDA_DATE),       
   DD          =DAY(SAUDA_DATE),  
   DFLAG,    
   BROKER_CHRG,    
   TURN_TAX,    
   SEBI_TAX,    
   C.OTHER_CHRG,      
   PINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 1     
     THEN INS_CHRG     
     ELSE 0 END),      
   SINS_CHRG=(    
   CASE     
     WHEN SELL_BUY = 2     
     THEN INS_CHRG     
     ELSE 0 END),      
   INS_CHRG,    
   SERVICE_TAX,    
   NSERTAX,    
   BROKERAGE,    
   PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),    
   SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),    
   CM.BRANCH_CD,    
   SUBBROKER AS SUB_BROKER,    
   CM.TRADER,    
   C.PRINTF,    
   C.SERVICE_CHRG,       
   CM.PARTYNAME,     
   CM.L_ADDRESS1,     
   CM.L_ADDRESS2,     
   CM.L_ADDRESS3,     
   CM.L_CITY,     
   CM.L_STATE,     
   CM.L_ZIP,     
         CM.SEBI_NO,    
   CM.PAN_GIR_NO,     
   CM.OFF_PHONE1,     
   CM.OFF_PHONE2,       
   CM.MAPIDID,      
   MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),     
   PMARKETAMT = PRATE * PQTY ,     
   SMARKETAMT = SRATE * SQTY ,     
   SERIES     = '',    
   TMARK      ='',      
   SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,    
   PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN     
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
   ELSE '' END),       
   SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN    
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
   ELSE '' END),  
  LOTSIZE,  
  BILLNO=LOTSIZE,  
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)           
 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM , anand1.msajag.dbo.CLIENT_PRINT_SETTINGS  CP (NOLOCK)   
  WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE  AND LEFT(C.SAUDA_DATE,11) = LEFT(CM.TRADE_DATE,11)  
  AND SAUDA_DATE <= @TOSAUDA_DATE    
  AND CM.PARTY_CODE >= @FROMPARTY_CODE     
  AND CM.PARTY_CODE <= @TOPARTY_CODE     
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO       
     AND BRANCH_CD LIKE @BRANCH     
     AND SUBBROKER LIKE @SUB_BROKER      
     AND @STATUSNAME = (    
    CASE    
        WHEN @STATUSID = 'BRANCH'       
        THEN CM.BRANCH_CD       
        WHEN @STATUSID = 'SUBBROKER'       
        THEN CM.SUBBROKER       
        WHEN @STATUSID = 'TRADER'       
        THEN CM.TRADER       
        WHEN @STATUSID = 'FAMILY'       
        THEN CM.FAMILY       
        WHEN @STATUSID = 'AREA'       
        THEN CM.AREA       
        WHEN @STATUSID = 'REGION'       
        THEN CM.REGION       
        WHEN @STATUSID = 'CLIENT'       
        THEN CM.PARTY_CODE       
        ELSE 'BROKER'     
  END)    
           AND C.PRINTF =  CP.PRINT_FLAG  
    AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'  
     AND C.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))    
  
 ORDER BY CM.BRANCH_CD,     
 SUB_BROKER,     
   CM.TRADER,     
   CM.PARTY_CODE,     
  PRODUCT_TYPE,    
  PRODUCT_CODE,    
  SERIES_CODE,    
  SERIES_ID,    
   EXPIRYDATE,     
   STRIKE_PRICE,     
   ORDER_NO,     
   TRADE_NO     
 END  
  
   IF @@ROWCOUNT>0   
      SET @STATUS=1   
   ELSE   
 SET @STATUS=0    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_DETAIL_24012012
-- --------------------------------------------------
CREATE   PROC [dbo].[V2_CONTSECTION_DETAIL_24012012]           
(          
  @STATUSID VARCHAR(15),          
  @STATUSNAME VARCHAR(25),           
  @SAUDA_DATE VARCHAR(11),           
  @FROMPARTY_CODE VARCHAR(10),           
  @TOPARTY_CODE VARCHAR(10),           
  @BRANCH VARCHAR(10),           
  @SUB_BROKER VARCHAR(10),           
  @FROMCONTRACTNO VARCHAR(12),           
  @TOCONTRACTNO VARCHAR(12),           
  @CONTFLAG VARCHAR(10),        
  @TOSAUDA_DATE VARCHAR(11) = '',      
  @BOUNCEDFLAG INT = 0,      
  @STATUS AS CHAR(1) OUTPUT            
)           
AS        
BEGIN      
          
      
--CHECK WHETHER RECORDS PRESENT OR NOT      
 IF NOT EXISTS (SELECT 1 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM       
  WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE          
  AND SAUDA_DATE <= @TOSAUDA_DATE        
  AND CM.PARTY_CODE >= @FROMPARTY_CODE         
  AND CM.PARTY_CODE <= @TOPARTY_CODE         
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO           
     AND BRANCH_CD LIKE @BRANCH         
     AND SUBBROKER LIKE @SUB_BROKER          
     AND @STATUSNAME = (        
    CASE        
        WHEN @STATUSID = 'BRANCH'           
        THEN CM.BRANCH_CD           
        WHEN @STATUSID = 'SUBBROKER'           
        THEN CM.SUBBROKER           
        WHEN @STATUSID = 'TRADER'           
        THEN CM.TRADER           
        WHEN @STATUSID = 'FAMILY'           
        THEN CM.FAMILY           
        WHEN @STATUSID = 'AREA'           
        THEN CM.AREA           
        WHEN @STATUSID = 'REGION'           
        THEN CM.REGION           
        WHEN @STATUSID = 'CLIENT'           
        THEN CM.PARTY_CODE           
        ELSE 'BROKER'         
  END)  )      
      BEGIN      
  SET @STATUS =0      
        RETURN       
      END        
      
        
  CREATE TABLE #BPARTY        
  (         
  PARTY_CODE VARCHAR(15)         
  )        
         
  IF @BOUNCEDFLAG <> 0        
  BEGIN        
   INSERT INTO #BPARTY        
   SELECT         
    DISTINCT PARTY_CODE         
   FROM         
    TBL_ECNBOUNCED(NOLOCK)         
   WHERE         
    SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'        
  END        
  ELSE        
  BEGIN        
   INSERT INTO #BPARTY        
   SELECT         
    DISTINCT PARTY_CODE         
   FROM         
    CLIENT2 (NOLOCK)         
   WHERE         
    PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE        
  END        
      
 IF (@CONTFLAG = 'CONTRACT')        
 BEGIN         
 SELECT  ORDER_NO,        
   ORDER_TIME,        
   TRADE_NO,        
   TM=TRADETIME,          
  QTY = PQTY + SQTY,        
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,        
   PQTY,        
   SQTY,          
   RATE = PRATE + SRATE,          
   PRATE,        
   SRATE,          
   BROK=PBROK+SBROK,          
   PBROK,        
   SBROK,          
   NETRATE = PNETRATE + SNETRATE,          
   PNETRATE,        
   SNETRATE,          
   AMOUNT,        
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
 SERIESCODE =  SERIES_CODE,          
 CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),      
 NOOFCONTRACT = (PQTY + SQTY)/(CASE WHEN LOT_SIZE=0 THEN 1 ELSE LOT_SIZE END),      
   AMT = (         
   CASE         
     WHEN SELL_BUY = 1         
     THEN -PAMT         
     ELSE SAMT END),         
   PAMT,         
   SAMT,         
   AMTSTT = (         
   CASE         
     WHEN SELL_BUY = 1         
     THEN -(PAMT+INS_CHRG)         
     ELSE (SAMT-INS_CHRG) END),         
   PAMTSTT = (         
   CASE         
     WHEN SELL_BUY = 1         
     THEN PAMT+INS_CHRG         
     ELSE 0 END),         
   SAMTSTT = (         
   CASE         
     WHEN SELL_BUY = 2         
     THEN SAMT-INS_CHRG         
     ELSE 0 END),         
   EXPIRYDATE,        
   CM.PARTY_CODE,        
   SELL_BUY,        
   CONTRACTNO,        
   SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),        
   SDT=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),      
   STRIKE_PRICE,          
   PSERVICE_TAX,        
   SSERVICE_TAX,        
   YY          =YEAR(SAUDA_DATE),           
   MM          =MONTH(SAUDA_DATE),           
   DD       =DAY(SAUDA_DATE),      
   DFLAG,        
    BROKER_CHRG,        
   TURN_TAX,        
   SEBI_TAX,        
   C.OTHER_CHRG,          
   PINS_CHRG=(        
   CASE         
     WHEN SELL_BUY = 1         
     THEN INS_CHRG         
     ELSE 0 END),          
   SINS_CHRG=(        
   CASE         
     WHEN SELL_BUY = 2         
     THEN INS_CHRG         
     ELSE 0 END),          
   INS_CHRG,        
   SERVICE_TAX,        
   NSERTAX,        
   BROKERAGE,        
   PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),        
   SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),        
   CM.BRANCH_CD,        
   CM.SUBBROKER AS SUB_BROKER,        
   CM.TRADER,        
   C.PRINTF,        
   C.SERVICE_CHRG,           
   CM.PARTYNAME,         
   CM.L_ADDRESS1,         
   CM.L_ADDRESS2,         
   CM.L_ADDRESS3,         
   CM.L_CITY,         
   CM.L_STATE,         
   CM.L_ZIP,         
  CM.SEBI_NO,        
   CM.PAN_GIR_NO,         
   CM.OFF_PHONE1,         
   CM.OFF_PHONE2,           
   CM.MAPIDID,          
   MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),         
   PMARKETAMT = PRATE * PQTY ,         
   SMARKETAMT = SRATE * SQTY ,         
   SERIES     = '',        
   TMARK      ='',          
   SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,        
   PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN         
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
  ELSE '' END),           
   SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN        
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
  ELSE '' END),      
  LOT_SIZE,      
  BILLNO=LOT_SIZE,      
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)               
           
 FROM     CONTRACT_DATA C (NOLOCK) ,  CONTRACT_MASTER CM      
 WHERE   C.PRINTF <> 1  AND  CM.PARTY_CODE = C.PARTY_CODE         
  AND LEFT(C.SAUDA_DATE,11) = LEFT(CM.TRADE_DATE,11)       
  AND SAUDA_DATE >= @SAUDA_DATE         
  AND SAUDA_DATE <= @TOSAUDA_DATE        
  AND CM.PARTY_CODE >= @FROMPARTY_CODE         
  AND CM.PARTY_CODE <= @TOPARTY_CODE      
        
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO           
     AND BRANCH_CD LIKE @BRANCH         
     AND SUBBROKER LIKE @SUB_BROKER             
     AND @STATUSNAME = (        
  CASE        
        WHEN @STATUSID = 'BRANCH'           
        THEN CM.BRANCH_CD           
        WHEN @STATUSID = 'SUBBROKER'           
        THEN CM.SUBBROKER           
        WHEN @STATUSID = 'TRADER'           
        THEN CM.TRADER           
        WHEN @STATUSID = 'FAMILY'           
        THEN CM.FAMILY           
        WHEN @STATUSID = 'AREA'           
        THEN CM.AREA           
        WHEN @STATUSID = 'REGION'           
        THEN CM.REGION           
        WHEN @STATUSID = 'CLIENT'           
        THEN CM.PARTY_CODE           
        ELSE 'BROKER'         
  END)        
 AND C.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))        
        
 ORDER BY CM.BRANCH_CD,         
   SUB_BROKER,         
   CM.TRADER,         
   CM.PARTY_CODE,         
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
   EXPIRYDATE,         
   STRIKE_PRICE,         
   ORDER_NO,         
   TRADE_NO         
 END        
       
 ELSE BEGIN         
 SELECT  ORDER_NO,        
   ORDER_TIME,        
   TRADE_NO,        
   TM=TRADETIME,         
  QTY = PQTY + SQTY,        
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,        
   PQTY,        
   SQTY,          
   RATE = PRATE + SRATE,          
   PRATE,        
   SRATE,          
   BROK=PBROK+SBROK,      
   PBROK,        
   SBROK,          
   NETRATE = PNETRATE + SNETRATE,          
   PNETRATE,        
   SNETRATE,          
   AMOUNT,        
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
 SERIESCODE =  SERIES_CODE,          
 CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),      
 NOOFCONTRACT = (PQTY + SQTY)/(CASE WHEN LOT_SIZE=0 THEN 1 ELSE LOT_SIZE END),      
   AMT = (         
   CASE         
     WHEN SELL_BUY = 1         
 THEN -PAMT         
     ELSE SAMT END),         
   PAMT,         
   SAMT,         
   AMTSTT = (         
   CASE         
     WHEN SELL_BUY = 1         
     THEN -(PAMT+INS_CHRG)         
     ELSE (SAMT-INS_CHRG) END),         
   PAMTSTT = (         
   CASE         
     WHEN SELL_BUY = 1         
     THEN PAMT+INS_CHRG         
     ELSE 0 END),         
   SAMTSTT = (         
   CASE         
     WHEN SELL_BUY = 2         
     THEN SAMT-INS_CHRG         
     ELSE 0 END),         
   EXPIRYDATE,        
   CM.PARTY_CODE,        
   SELL_BUY,        
   CONTRACTNO,        
   SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),          
   SDT=CONVERT(VARCHAR,CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,SAUDA_DATE),11)),103),      
   STRIKE_PRICE,          
   PSERVICE_TAX,        
   SSERVICE_TAX,        
   YY          =YEAR(SAUDA_DATE),           
   MM          =MONTH(SAUDA_DATE),           
   DD          =DAY(SAUDA_DATE),      
   DFLAG,        
   BROKER_CHRG,        
   TURN_TAX,        
   SEBI_TAX,        
   C.OTHER_CHRG,          
   PINS_CHRG=(        
   CASE         
     WHEN SELL_BUY = 1         
     THEN INS_CHRG         
     ELSE 0 END),          
   SINS_CHRG=(        
   CASE         
     WHEN SELL_BUY = 2         
     THEN INS_CHRG         
     ELSE 0 END),          
   INS_CHRG,        
   SERVICE_TAX,        
   NSERTAX,        
   BROKERAGE,        
   PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),        
   SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),        
   CM.BRANCH_CD,        
   SUBBROKER AS SUB_BROKER,        
   CM.TRADER,        
   C.PRINTF,        
   C.SERVICE_CHRG,           
   CM.PARTYNAME,         
   CM.L_ADDRESS1,         
   CM.L_ADDRESS2,         
   CM.L_ADDRESS3,         
   CM.L_CITY,         
   CM.L_STATE,         
   CM.L_ZIP,         
         CM.SEBI_NO,        
   CM.PAN_GIR_NO,         
   CM.OFF_PHONE1,         
   CM.OFF_PHONE2,           
   CM.MAPIDID,          
   MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),         
   PMARKETAMT = PRATE * PQTY ,         
   SMARKETAMT = SRATE * SQTY ,         
   SERIES     = '',        
   TMARK      ='',          
   SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,        
   PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN         
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
   ELSE '' END),           
   SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN        
    RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
   ELSE '' END),      
  LOT_SIZE,      
  BILLNO=LOT_SIZE,      
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)               
 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM , CLIENT_PRINT_SETTINGS  CP (NOLOCK)       
  WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.PARTY_CODE = C.PARTY_CODE  AND LEFT(C.SAUDA_DATE,11) = LEFT(CM.TRADE_DATE,11)      
  AND SAUDA_DATE <= @TOSAUDA_DATE        
  AND CM.PARTY_CODE >= @FROMPARTY_CODE         
  AND CM.PARTY_CODE <= @TOPARTY_CODE         
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO           
     AND BRANCH_CD LIKE @BRANCH         
     AND SUBBROKER LIKE @SUB_BROKER          
     AND @STATUSNAME = (        
    CASE        
        WHEN @STATUSID = 'BRANCH'           
        THEN CM.BRANCH_CD           
        WHEN @STATUSID = 'SUBBROKER'           
  THEN CM.SUBBROKER           
        WHEN @STATUSID = 'TRADER'           
        THEN CM.TRADER           
        WHEN @STATUSID = 'FAMILY'           
        THEN CM.FAMILY           
        WHEN @STATUSID = 'AREA'           
        THEN CM.AREA           
        WHEN @STATUSID = 'REGION'           
        THEN CM.REGION           
        WHEN @STATUSID = 'CLIENT'           
        THEN CM.PARTY_CODE           
        ELSE 'BROKER'         
  END)        
           AND C.PRINTF =  CP.PRINT_FLAG      
   -- AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'      
     AND C.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))        
      
 ORDER BY CM.BRANCH_CD,         
 SUB_BROKER,         
   CM.TRADER,         
   CM.PARTY_CODE,         
  PRODUCT_TYPE,        
  PRODUCT_CODE,        
  SERIES_CODE,        
  SERIES_ID,        
   EXPIRYDATE,         
   STRIKE_PRICE,         
   ORDER_NO,         
   TRADE_NO         
 END      
      
   IF @@ROWCOUNT>0       
      SET @STATUS=1       
   ELSE       
 SET @STATUS=0        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_DIGITALDATA_REGULATION
-- --------------------------------------------------

--EXEC V2_DIGITALDATA_REGULATION 

CREATE  PROC [dbo].[V2_DIGITALDATA_REGULATION]
AS
BEGIN
		SELECT * INTO V2_CONTRACT_DIGITAL_DATA_BAK FROM V2_CONTRACT_DIGITAL_DATA
		SELECT * INTO V2_CONTRACT_DIGITAL_TEXT_BAK FROM V2_CONTRACT_DIGITAL_TEXT
		
		
		DROP TABLE V2_CONTRACT_DIGITAL_DATA
		DROP TABLE V2_CONTRACT_DIGITAL_TEXT
		
		CREATE TABLE [dbo].[V2_CONTRACT_DIGITAL_DATA_13012012] (
			[C_SR_NO] [numeric](10, 0),
			[C_TEXT] [varchar] (2000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,
			[C_Type] [char] (1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL 
		) ON [PRIMARY]

		CREATE TABLE [dbo].[V2_CONTRACT_DIGITAL_TEXT_13012012] (
			[C_SR_NO] [numeric](10, 0),
			[C_TEXT] [varchar] (500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,
			[C_Type] [char] (1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL 
		) ON [PRIMARY]
		
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(1,'','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(2,'<tr><TD  width="25%" align="left"></TD><TD width="50%" align=center><FONT SIZE = 1 FACE="VERDANA, ARIAL, HELVETICA, SANS-SERIF" COLOR="#660000"><STRONG>CONTRACT NOTE FOR DERIVATIVE SEGMENT <BR>CONTRACT NOTE - FORM A </STRONG></FONT></TD><TD colspan=1  align=center   rowspan=3 style="BORDER-RIGHT: #000000 1px solid; BORDER-TOP: #000000 1px solid; BORDER-LEFT: #000000 1px solid; BORDER-BOTTOM: #000000 1px solid"  color="#660000" width="25%" Border=1 BorderColor="#660000"><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"  ><b>DEALING OFFICE:<BR></b>****</FONT></TD></tr>','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(3,'<!--<tr><TD  width="25%" align="left"><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"><b>Authorised Signatory:<br>Archana Gorhe<BR>Darshana Deshpande<BR>Kirti Pisal</b></FONT></TD><TD width="50%" align=center><FONT SIZE = 1 FACE="VERDANA, ARIAL, HELVETICA, SANS-SERIF" COLOR="#660000"><STRONG>CONTRACT NOTE FOR DERIVATIVE SEGMENT <BR>CONTRACT NOTE - FORM A </STRONG></FONT></TD><TD colspan=1  align=center   rowspan=3 style="BORDER-RIGHT: #000000 1px solid; BORDER-TOP: #000000 1px solid; BORDER-LEFT: #000000 1px solid; BORDER-BOTTOM: #000000 1px solid"  color="#660000" width="25%" Border=1 BorderColor="#660000"><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"><b>DEALING OFFICE:<BR></b>****</FONT></TD></tr>-->','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(4,'<TR><TD align=center colspan=3><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"><B>CONTRACT NOTE ISSUED BY TRADING MEMBER ACTING  AS BROKERS & AGENT</B></TD></TR>','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(5,'<TR><TD align=center colspan=3><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"><B>MEMBER OF BOMBAY STOCK EXCHANGE LIMITED (DERIVATIVES SEGMENT)</B></TD></TR>','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(6,'<TR><TD align=center colspan=3>#OWNER#</TD></TR>','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(7,'','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(8,'','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(9,'','H')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(10,'<TR><TD  colspan=6 align=left>* Others Include levies</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(11,'<TR><TD  colspan=6>This contract is made subject to the rules, Bye-laws, Regulations, Business Requirement Specifications, orders, notices and decisions of the Derivatives Segment/Currency Derivatives Segment of the Stock Exchange, Mumbai and the Clearing House.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(12,'<TR><TD  colspan=6>Brokerage/Commission has been expressly marked and charged as stated and has been charged at rates not exceeding the official scale of brokerage / commission. The brokerage/commission is not included in the purchase price or excluded from the sale price.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(13,'<TR><TD  colspan=6>The Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect of all other proceedings, the Courts having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(14,'<TR><TD  colspan=6>In the event of any claim (whether admitted or not) difference or dispute arising between you and me/us out of these transactions, (including any question whether such dealings, transactions and contracts have been entered into or not), the matter shall be referred to arbitration in the concerned Regional Arbitration Centre as provided in the Rules, Bye-laws, Regulations and Business Requirement Specifications of the Derivatives Segment/Currency Derivatives Segment of the Stock Exchange,Mumbai.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(15,'<TR><TD  colspan=6><BR>The provisions printed overleaf form a part of the contract.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(16,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(17,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(18,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(19,'<TR><TD  colspan=6><br> Place :  MUMBAI</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(20,'<TR><TD  colspan=6> DATE:</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(21,'<TR><TD  colspan=6> &nbsp;</TD></TR></TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(22,'<TABLE><TR><TD width="65%" ><B>&nbsp;</B></TD><TD align=center> Yours faithfully, </TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(23,'<TR><TD width="65%" ></TD><TD align=center >#OWNERF#</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(24,'<!--<TR><TD colspan=5 nowrap><B>AUTHORISED SIGNATORIES:</B><BR>XXXX/YYY/ZZZZ</TD></TD><TD align=center>&nbsp; </TD></TR>-->','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(25,'</TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(26,'<TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(27,'<TR><TD colspan=6><B>(This is a computer generated statement hence no physical signature is required. We do proprietory trading occasionally.)</B></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(28,'</TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(29,'<TABLE cellSpacing=0 cellPadding=2 width="100%" Border=1 BorderColor=Black><TR><TD align=center><Font Face=Verdana Size=1><B>Derivatives/Currency Derivatives Segment Bye-laws</B><BR></TD></TR><TR><TD Align=center><Font Face=Verdana Size=1><B>Resolution by Arbitration</B><BR></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(30,'<TR><TD><Font Face=Verdana Size=1>12.1 In case of any claim, complaint, dispute or difference between a Member and a Client arising out of or in relation to a Derivatives Contract or trading, clearing or settlement in a Derivatives Contract made subject to the Rules, Bye-laws and Regulations of the Derivatives Segment or with reference to anything incidental thereto or in pursuance thereof or relating to the construction, fulfillment or validity thereof, the parties thereto shall resolve such claim, complaint, dispute or difference by arbitration as per the procedure specified in this Chapter. In respect of any claim, complaint, dispute or difference to be resolved by arbitration, no party shall commence any legal proceedings in a court or other tribunal without the permission of the Governing Council.<BR></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(31,'<TR><TD Align=center><Font Face=Verdana Size=1><B>Submission of Dispute</B><BR></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(32,'<TR><TD><Font Face=Verdana Size=1>12.2 In the case of every claim, complaint, dispute or difference of the kind referred to in Bye-law [12.1], any of the parties concerned may submit to the concerned Regional Arbitration Centre of the Exchange an application for arbitration in such form and with such fee as may be specified by the Derivatives Segment/Currency Derivatives Segment from time to time.<BR></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(33,'<TR><TD align=center><Font Face=Verdana Size=1><B>Operation of Contracts</B><br></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(34,'<TR><TD>12.36 All dealings, transactions and contracts which are subject to these Rules, Byelaws and Regulations shall take effect as if wholly made, entered into and to be performed in the city of Mumbai and the parties to such dealings, transactions, contracts and agreements shall be deemed to have submitted to the exclusive jurisdiction of the Courts in Mumbai for the purpose of giving effect to the','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(35,'provisions of these Rules, Bye-laws and Regulations. Provided, however, that upon the amendments to the Rules, Bye-laws and Regulations with regards to Regional Arbitration Centres and other incidental and consequential matters in connection therewith or relating thereto coming into force, the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect of all other proceedings, the courts having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(36,'<TR><TD align=center><Font Face=Verdana Size=1><B>Derivatives/Currency Derivatives Segment Regulations<br></B></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(37,'<TR><TD><Font Face=Verdana Size=1>3.1A The Application for Arbitration shall be filed by the Applicant at the concerned Regional Arbitration Centre referred to in column 1 below covering that State or Union Territory of India, referred to in column 2 below, within which the most recent residential address or registered office of the client, as duly','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(38,'communicated in writing to the member in accordance with law, is located. Provided in respect of a non-resident Indian client, the Seat of Arbitration shall be Regional Arbitration Centre which covers the States or Union Territories given in the Column 2, in which lies the address or the registered office address, as the case may be, of the Member, depending upon corporate or non-corporate membership of the Member. The hearings shall be held in the concerned Regional Arbitration Centre in which the Applicant has duly filed the Application for Arbitration.<br></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(39,'</TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(40,'<TABLE borderColor=black cellSpacing=1 cellPadding=10 border=1 ><TBODY><TR><TD   BORDER-LEFT:Black   align=center><FONT  face=Verdana size=1 width="40%"><B>Column 1</B></FONT></TD><TD   BORDER-LEFT:Black  align=center ><FONT face=Verdana size=1 width="60%"><B>Column 2</B></FONT></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(41,'<TR><TD   BORDER-LEFT:Black width="40%"><FONT face=Verdana size=1 ><B>Regional Arbitration Centres</B></FONT></TD>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(42,'<TD width="60%"   BORDER-LEFT:Black><FONT face=Verdana size=1 ><B>States &amp; Union Territories covered by the Regional Arbitration Centres</B></FONT></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(43,'<TR><TD   BORDER-TOP:Black ><FONT face=Verdana size=1 ><B>DELHI</B></FONT></TD>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(44,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black ><FONT face=Verdana size=1>Delhi, Haryana, Uttar Pradesh,Uttaranchal,Himachal Pradesh, Punjab, Jammu &amp; Kashmir, Chandigarh, Rajasthan.</FONT></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(45,'<TR><TD   BORDER-TOP:Black><FONT face=Verdana size=1 ><B>KOLKATA</B></FONT></TD>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(46,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black><FONT face=Verdana size=1 >Andhra Pradesh, Karnataka, Kerala, Tamilnadu, Andaman &amp; Nicobar, Lakshadweep, Pondicherry.</FONT></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(47,'<TR><TD   BORDER-TOP:Black><FONT face=Verdana size=1 ><B>Mumbai</B></FONT></TD>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(48,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black><FONT face=Verdana size=1 >West Bengal, Bihar,Jharkhand,Orissa, Assam, Arunachal Pradesh, Mizoram, Manipur, Sikkim, Meghalaya, Nagaland, Tripura,Chattisgarh.</FONT></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(49,'<TR><TD   BORDER-TOP:Black><FONT face=Verdana size=1 ><B>CHENNAI</B></FONT></TD>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(50,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black><FONT face=Verdana size=1 >Maharashtra, Gujarat, Goa, Daman, Diu, Dadra &amp; Nagar Haveli, Madhya Pradesh.</FONT></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(51,'</TBODY></TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(52,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(53,'<TABLE cellSpacing=0 cellPadding=2 width="100%" Border=1 BorderColor=Black><TR><TD><Font Face=Verdana Size=1>&nbsp;<br></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(54,'<TR><TD align=center><Font Face=Verdana Size=1><B>JURISDICTION OF COURTS<br></B></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(55,'<TR><TD><Font Face=Verdana Size=1>Upon the amendments to the Rules, Bye-laws and Regulations with regard to Regional Arbitration Centers and other incidental and consequential matters in connection therewith or relating thereto coming into force,','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(56,'the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect of all other proceedings, the  Courts having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.<br></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(57,'<TR><TD align=center><Font Face=Verdana Size=1><B>&nbsp;</B></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(58,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(59,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(60,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(61,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(62,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(63,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(64,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(65,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(66,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(67,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(68,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(69,'','F')


INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(1,'                                                               CONTRACT NOTE FOR DERIVATIVE SEGMENT','H')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(2,'                                                                       CONTRACT NOTE - FORM A','H')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(3,'                                                   CONTRACT NOTE ISSUED BY TRADING MEMBER ACTING AS BROKERS & AGENT','H')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(4,'                                                      MEMBER OF BOMBAY STOCK EXCHANGE LIMITED (DERIVATIVES SEGMENT)','H')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(5,'                                                                                         #OWNER#','H')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(6,'****','H')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(7,'This contract is made subject to the Rules, Bye-laws, Regulations, Business Requirement Specifications, orders, notices and decisions of the Derivatives','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(8,'Segment/Currency Derivatives Segment of the Stock Exchange, Mumbai and the Clearing House.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(9,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(10,'Brokerage/Commission has been expressly marked and charged as stated and has been charged at rates not exceeding the official scale of brokerage / commission. The','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(11,'brokerage/commission is not included in the purchase price or excluded from the sale price.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(12,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(13,'The Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect of all other proceedings, the Courts','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(14,'having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(15,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(16,'In the event of any claim (whether admitted or not) difference or dispute arising between you and me/us out of these transactions, (including any question whether','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(17,'such dealings, transactions and contracts have been entered into or not), the matter shall be referred to arbitration in the concerned Regional Arbitration Centre as provided','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(18,'in the Rules, Bye-laws, Regulations and Business Requirement Specifications of the Derivatives Segment/Currency Derivatives Segment of the Stock Exchange, Mumbai.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(19,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(20,'The provisions printed overleaf form a part of the contract.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(21,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(22,'PLACE: MUMBAI','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(23,'DATE:','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(24,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(25,'                                                                                 Yours faithfully,','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(26,'                                                                                                                 #OWNERF#','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(27,'AUTHORISED SIGNATORIES:','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(28,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(29,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(30,'                        Derivatives/Currency Derivatives Segment Bye-laws','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(31,'     Resolution by Arbitration','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(32,'12.1 In case of any claim, complaint, dispute or difference between a Member and a Client arising out of or in relation to a Derivatives Contract or trading, clearing or','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(33,'settlement in a Derivatives Contract made subject to the Rules, Bye-laws and Regulations of the Derivatives Segment or with reference to anything incidental','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(34,'thereto or in pursuance thereof or relating to the construction, fulfillment or validity thereof, the parties thereto shall resolve such claim, complaint, dispute or','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(35,'difference by arbitration as per the procedure specified in this Chapter. In respect of any claim, complaint, dispute or difference to be resolved by arbitration, no','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(36,'party shall commence any legal proceedings in a court or other tribunal without the permission of the Governing Council.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(37,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(38,'     Submission of Dispute','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(39,'12.2 In the case of every claim, complaint, dispute or difference of the kind referred to in Bye-law [12.1], any of the parties concerned may submit to the concerned Regional','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(40,'Arbitration Centre of the Exchange an application for arbitration in such form and with such fee as may be specified by the Derivatives Segment/Currency Derivatives Segment from time to time.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(41,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(42,'     Operation of Contracts','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(43,'12.36 All dealings, transactions and contracts which are subject to these Rules, Byelaws and Regulations shall take effect as if wholly made, entered into and to be','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(44,'performed in the city of Mumbai and the parties to such dealings, transactions, contracts and agreements shall be deemed to have submitted to the exclusive','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(45,'jurisdiction of the Courts in Mumbai for the purpose of giving effect to the provisions of these Rules, Bye-laws and Regulations. Provided, however, that','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(46,'upon the amendments to the Rules, Bye-laws and Regulations with regards to Regional Arbitration Centres and other incidental and consequential matters in','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(47,'connection therewith or relating thereto coming into force, the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(48,'Exchange is a party, and in respect of all other proceedings, the courts having jurisdiction over the area in which the respective Regional Arbitration Centre is','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(49,'situated, shall have jurisdiction.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(50,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(51,'     Derivatives/Currency Derivatives Segment Regulations','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(52,'3.1A The Application for Arbitration shall be filed by the Applicant at the concerned Regional Arbitration Centre referred to in column 1 below covering that State or','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(53,'Union Territory of India, referred to in column 2 below, within which the most recent residential address or registered office of the client, as duly','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(54,'communicated in writing to the member in accordance with law, is located.Provided in respect of a non-resident Indian client, the Seat of Arbitration shall','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(55,'be Regional Arbitration Centre which covers the States or Union Territories given in the Column 2, in which lies the address or the registered office address,','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(56,'as the case may be, of the Member, depending upon corporate or non-corporate membership of the Member. The hearings shall be held in the concerned','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(57,'Regional Arbitration Centre in which the Applicant has duly filed the Application for Arbitration.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(58,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(59,'<TABLE Border=1 BorderColor=Black><TR><TD>   Column 1  </TD><TD>      Column 2</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(60,'<TR><TD>Regional Arbitration Centres</TD><TD>       States and Union Territories covered by the Regional Arbitration Centres</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(61,'<TR><TD>DELHI</TD><TD>                                                                            Delhi, Haryana, Uttar Pradesh, Uttaranchal, Himachal Pradesh, Punjab, Jammu & Kashmir, Chandigarh, Rajasthan</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(62,'<TR><TD>KOLKATA</TD><TD>                                                                          West Bengal, Bihar, Jharkhand, Orissa, Assam, Arunachal Pradesh, Mizoram,Manipur, Sikkim, Meghalaya, Nagaland, Tripura, Chhattisgarh</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(63,'<TR><TD>CHENNAI</TD><TD>                                                                          Andhra Pradesh, Karnataka, Kerala, Tamilnadu, Andaman & Nicobar, Lakshadweep, Pondicherry. </TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(64,'<TR><TD>Mumbai</TD><TD>                                                                           Maharashtra, Gujarat, Goa, Daman & Diu, Dadra &  Nagar Haveli, Madhya Pradesh</TD></TR></TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(65,'                                  JURISDICTION OF COURTS','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(66,'Upon the amendments to the Rules, Bye-laws and Regulations with regard to Regional Arbitration Centers and other incidental and consequential matters in connection therewith','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(67,'or relating thereto coming into force,  the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(68,'of all other proceedings,  the  Courts having jurisdiction over the area in which the  respective Regional Arbitration Centre is situated, shall have jurisdiction.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(69,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(70,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(71,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(72,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(73,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(74,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(75,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(76,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(77,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(78,'  ','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(79,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(80,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(81,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(82,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(83,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(84,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(85,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(86,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(87,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(88,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(89,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(90,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(91,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(92,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(93,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(94,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(95,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(96,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(97,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(98,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(99,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(100,'','F')	

		SELECT * INTO V2_CONTRACT_DIGITAL_DATA FROM V2_CONTRACT_DIGITAL_DATA_13012012 ORDER BY C_SR_NO ASC
		SELECT * INTO V2_CONTRACT_DIGITAL_TEXT FROM V2_CONTRACT_DIGITAL_TEXT_13012012 ORDER BY C_SR_NO ASC
		
		DROP TABLE V2_CONTRACT_DIGITAL_DATA_13012012
		DROP TABLE V2_CONTRACT_DIGITAL_TEXT_13012012


--COMMIT
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_DIGITALDATA_REGULATION_18122012
-- --------------------------------------------------
  
--EXEC V2_DIGITALDATA_REGULATION   
  
CREATE  PROC [dbo].[V2_DIGITALDATA_REGULATION_18122012]  
AS  
BEGIN  
  SELECT * INTO V2_CONTRACT_DIGITAL_DATA_BAK FROM V2_CONTRACT_DIGITAL_DATA  
  SELECT * INTO V2_CONTRACT_DIGITAL_TEXT_BAK FROM V2_CONTRACT_DIGITAL_TEXT  
    
    
  DROP TABLE V2_CONTRACT_DIGITAL_DATA  
  DROP TABLE V2_CONTRACT_DIGITAL_TEXT  
    
  CREATE TABLE [dbo].[V2_CONTRACT_DIGITAL_DATA_13012012] (  
   [C_SR_NO] [numeric](10, 0),  
   [C_TEXT] [varchar] (2000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,  
   [C_Type] [char] (1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL   
  ) ON [PRIMARY]  
  
  CREATE TABLE [dbo].[V2_CONTRACT_DIGITAL_TEXT_13012012] (  
   [C_SR_NO] [numeric](10, 0),  
   [C_TEXT] [varchar] (500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,  
   [C_Type] [char] (1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL   
  ) ON [PRIMARY]  
    
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(1,'','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(2,'<tr><TD  width="25%" align="left"></TD><TD width="50%" align=center><FONT SIZE = 1 FACE="VERDANA, ARIAL, HELVETICA, SANS-SERIF" COLOR="#660000"><STRONG>CONTRACT NOTE FO
R DERIVATIVE SEGMENT <BR>CONTRACT NOTE - FORM A </STRONG></FONT></TD><TD colspan=1  align=center   rowspan=3 style="BORDER-RIGHT: #000000 1px solid; BORDER-TOP: #000000 1px solid; BORDER-LEFT: #000000 1px solid; BORDER-BOTTOM: #000000 1px solid"  color="#
660000" width="25%" Border=1 BorderColor="#660000"><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"  ><b>DEALING OFFICE:<BR></b>****</FONT></TD></tr>','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(3,'<!--<tr><TD  width="25%" align="left"><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"><b>Authorised Signatory:<br>Archana Gorhe<BR>Darshana 
Deshpande<BR>Kirti Pisal</b></FONT></TD><TD width="50%" align=center><FONT SIZE = 1 FACE="VERDANA, ARIAL, HELVETICA, SANS-SERIF" COLOR="#660000"><STRONG>CONTRACT NOTE FOR DERIVATIVE SEGMENT <BR>CONTRACT NOTE - FORM A </STRONG></FONT></TD><TD colspan=1  al
ign=center   rowspan=3 style="BORDER-RIGHT: #000000 1px solid; BORDER-TOP: #000000 1px solid; BORDER-LEFT: #000000 1px solid; BORDER-BOTTOM: #000000 1px solid"  color="#660000" width="25%" Border=1 BorderColor="#660000"><font size = 1 face="Verdana, Arial
, Helvetica, sans-serif" color="#660000"><b>DEALING OFFICE:<BR></b>****</FONT></TD></tr>-->','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(4,'<TR><TD align=center colspan=3><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"><B>CONTRACT NOTE ISSUED BY TRADING MEMBER ACTING  AS BROKERS 
& AGENT</B></TD></TR>','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(5,'<TR><TD align=center colspan=3><font size = 1 face="Verdana, Arial, Helvetica, sans-serif" color="#660000"><B>MEMBER OF BOMBAY STOCK EXCHANGE LIMITED (DERIVATIVES SEGME
NT)</B></TD></TR>','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(6,'<TR><TD align=center colspan=3>#OWNER#</TD></TR>','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(7,'','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(8,'','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(9,'','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(10,'<TR><TD  colspan=6 align=left>* Others Include levies</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(11,'<TR><TD  colspan=6>This contract is made subject to the rules, Bye-laws, Regulations, Business Requirement Specifications, orders, notices and decisions of the Derivat
ives Segment/Currency Derivatives Segment of the Stock Exchange, Mumbai and the Clearing House.</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(12,'<TR><TD  colspan=6>Brokerage/Commission has been expressly marked and charged as stated and has been charged at rates not exceeding the official scale of brokerage / c
ommission. The brokerage/commission is not included in the purchase price or excluded from the sale price.</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(13,'<TR><TD  colspan=6>The Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect of all other p
roceedings, the Courts having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(14,'<TR><TD  colspan=6>In the event of any claim (whether admitted or not) difference or dispute arising between you and me/us out of these transactions, (including any qu
estion whether such dealings, transactions and contracts have been entered into or not), the matter shall be referred to arbitration in the concerned Regional Arbitration Centre as provided in the Rules, Bye-laws, Regulations and Business Requirement Spec
ifications of the Derivatives Segment/Currency Derivatives Segment of the Stock Exchange,Mumbai.</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(15,'<TR><TD  colspan=6><BR>The provisions printed overleaf form a part of the contract.</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(16,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(17,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(18,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(19,'<TR><TD  colspan=6><br> Place :  MUMBAI</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(20,'<TR><TD  colspan=6> DATE:</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(21,'<TR><TD  colspan=6> &nbsp;</TD></TR></TABLE>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(22,'<TABLE><TR><TD width="65%" ><B>&nbsp;</B></TD><TD align=center> Yours faithfully, </TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(23,'<TR><TD width="65%" ></TD><TD align=center >#OWNERF#</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(24,'<!--<TR><TD colspan=5 nowrap><B>AUTHORISED SIGNATORIES:</B><BR>XXXX/YYY/ZZZZ</TD></TD><TD align=center>&nbsp; </TD></TR>-->','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(25,'</TABLE>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(26,'<TABLE>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(27,'<TR><TD colspan=6><B>(This is a computer generated statement hence no physical signature is required. We do proprietory trading occasionally.)</B></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(28,'</TABLE>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(29,'<TABLE cellSpacing=0 cellPadding=2 width="100%" Border=1 BorderColor=Black><TR><TD align=center><Font Face=Verdana Size=1><B>Derivatives/Currency Derivatives Segment B
ye-laws</B><BR></TD></TR><TR><TD Align=center><Font Face=Verdana Size=1><B>Resolution by Arbitration</B><BR></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(30,'<TR><TD><Font Face=Verdana Size=1>12.1 In case of any claim, complaint, dispute or difference between a Member and a Client arising out of or in relation to a Derivati
ves Contract or trading, clearing or settlement in a Derivatives Contract made subject to the Rules, Bye-laws and Regulations of the Derivatives Segment or with reference to anything incidental thereto or in pursuance thereof or relating to the constructi
on, fulfillment or validity thereof, the parties thereto shall resolve such claim, complaint, dispute or difference by arbitration as per the procedure specified in this Chapter. In respect of any claim, complaint, dispute or difference to be resolved by 
arbitration, no party shall commence any legal proceedings in a court or other tribunal without the permission of the Governing Council.<BR></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(31,'<TR><TD Align=center><Font Face=Verdana Size=1><B>Submission of Dispute</B><BR></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(32,'<TR><TD><Font Face=Verdana Size=1>12.2 In the case of every claim, complaint, dispute or difference of the kind referred to in Bye-law [12.1], any of the parties conce
rned may submit to the concerned Regional Arbitration Centre of the Exchange an application for arbitration in such form and with such fee as may be specified by the Derivatives Segment/Currency Derivatives Segment from time to time.<BR></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(33,'<TR><TD align=center><Font Face=Verdana Size=1><B>Operation of Contracts</B><br></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(34,'<TR><TD>12.36 All dealings, transactions and contracts which are subject to these Rules, Byelaws and Regulations shall take effect as if wholly made, entered into and 
to be performed in the city of Mumbai and the parties to such dealings, transactions, contracts and agreements shall be deemed to have submitted to the exclusive jurisdiction of the Courts in Mumbai for the purpose of giving effect to the','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(35,'provisions of these Rules, Bye-laws and Regulations. Provided, however, that upon the amendments to the Rules, Bye-laws and Regulations with regards to Regional Arbitr
ation Centres and other incidental and consequential matters in connection therewith or relating thereto coming into force, the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respe
ct of all other proceedings, the courts having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(36,'<TR><TD align=center><Font Face=Verdana Size=1><B>Derivatives/Currency Derivatives Segment Regulations<br></B></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(37,'<TR><TD><Font Face=Verdana Size=1>3.1A The Application for Arbitration shall be filed by the Applicant at the concerned Regional Arbitration Centre referred to in colu
mn 1 below covering that State or Union Territory of India, referred to in column 2 below, within which the most recent residential address or registered office of the client, as duly','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(38,'communicated in writing to the member in accordance with law, is located. Provided in respect of a non-resident Indian client, the Seat of Arbitration shall be Regiona
l Arbitration Centre which covers the States or Union Territories given in the Column 2, in which lies the address or the registered office address, as the case may be, of the Member, depending upon corporate or non-corporate membership of the Member. The
 hearings shall be held in the concerned Regional Arbitration Centre in which the Applicant has duly filed the Application for Arbitration.<br></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(39,'</TABLE>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(40,'<TABLE borderColor=black cellSpacing=1 cellPadding=10 border=1 ><TBODY><TR><TD   BORDER-LEFT:Black   align=center><FONT  face=Verdana size=1 width="40%"><B>Column 1</B
></FONT></TD><TD   BORDER-LEFT:Black  align=center ><FONT face=Verdana size=1 width="60%"><B>Column 2</B></FONT></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(41,'<TR><TD   BORDER-LEFT:Black width="40%"><FONT face=Verdana size=1 ><B>Regional Arbitration Centres</B></FONT></TD>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(42,'<TD width="60%"   BORDER-LEFT:Black><FONT face=Verdana size=1 ><B>States &amp; Union Territories covered by the Regional Arbitration Centres</B></FONT></TD></TR>','F')
  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(43,'<TR><TD   BORDER-TOP:Black ><FONT face=Verdana size=1 ><B>DELHI</B></FONT></TD>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(44,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black ><FONT face=Verdana size=1>Delhi, Haryana, Uttar Pradesh,Uttaranchal,Himachal Pradesh, Punjab, Jammu &amp; Kashmir, Chan
digarh, Rajasthan.</FONT></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(45,'<TR><TD   BORDER-TOP:Black><FONT face=Verdana size=1 ><B>KOLKATA</B></FONT></TD>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(46,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black><FONT face=Verdana size=1 >Andhra Pradesh, Karnataka, Kerala, Tamilnadu, Andaman &amp; Nicobar, Lakshadweep, Pondicherry
.</FONT></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(47,'<TR><TD   BORDER-TOP:Black><FONT face=Verdana size=1 ><B>Mumbai</B></FONT></TD>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(48,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black><FONT face=Verdana size=1 >West Bengal, Bihar,Jharkhand,Orissa, Assam, Arunachal Pradesh, Mizoram, Manipur, Sikkim, Megh
alaya, Nagaland, Tripura,Chattisgarh.</FONT></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(49,'<TR><TD   BORDER-TOP:Black><FONT face=Verdana size=1 ><B>CHENNAI</B></FONT></TD>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(50,'<TD   BORDER-TOP:Black solid;BORDER-LEFT:Black><FONT face=Verdana size=1 >Maharashtra, Gujarat, Goa, Daman, Diu, Dadra &amp; Nagar Haveli, Madhya Pradesh.</FONT></TD><
/TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(51,'</TBODY></TABLE>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(52,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(53,'<TABLE cellSpacing=0 cellPadding=2 width="100%" Border=1 BorderColor=Black><TR><TD><Font Face=Verdana Size=1>&nbsp;<br></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(54,'<TR><TD align=center><Font Face=Verdana Size=1><B>JURISDICTION OF COURTS<br></B></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(55,'<TR><TD><Font Face=Verdana Size=1>Upon the amendments to the Rules, Bye-laws and Regulations with regard to Regional Arbitration Centers and other incidental and conse
quential matters in connection therewith or relating thereto coming into force,','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(56,'the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect of all other proceedings, the  Co
urts having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.<br></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(57,'<TR><TD align=center><Font Face=Verdana Size=1><B>&nbsp;</B></TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(58,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(59,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(60,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(61,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(62,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(63,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(64,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(65,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(66,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(67,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(68,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_DATA_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(69,'','F')  
  
  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(1,'                                                               CONTRACT NOTE FOR DERIVATIVE SEGMENT','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(2,'                                                                       CONTRACT NOTE - FORM A','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(3,'                                                   CONTRACT NOTE ISSUED BY TRADING MEMBER ACTING AS BROKERS & AGENT','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(4,'                                                      MEMBER OF BOMBAY STOCK EXCHANGE LIMITED (DERIVATIVES SEGMENT)','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(5,'                                                                                         #OWNER#','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(6,'****','H')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(7,'This contract is made subject to the Rules, Bye-laws, Regulations, Business Requirement Specifications, orders, notices and decisions of the Derivatives','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(8,'Segment/Currency Derivatives Segment of the Stock Exchange, Mumbai and the Clearing House.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(9,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(10,'Brokerage/Commission has been expressly marked and charged as stated and has been charged at rates not exceeding the official scale of brokerage / commission. The','F'
)  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(11,'brokerage/commission is not included in the purchase price or excluded from the sale price.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(12,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(13,'The Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in respect of all other proceedings, the Cou
rts','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(14,'having jurisdiction over the area in which the respective Regional Arbitration Centre is situated, shall have jurisdiction.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(15,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(16,'In the event of any claim (whether admitted or not) difference or dispute arising between you and me/us out of these transactions, (including any question whether','F'
)  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(17,'such dealings, transactions and contracts have been entered into or not), the matter shall be referred to arbitration in the concerned Regional Arbitration Centre as p
rovided','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(18,'in the Rules, Bye-laws, Regulations and Business Requirement Specifications of the Derivatives Segment/Currency Derivatives Segment of the Stock Exchange, Mumbai.','F'
)  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(19,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(20,'The provisions printed overleaf form a part of the contract.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(21,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(22,'PLACE: MUMBAI','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(23,'DATE:','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(24,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(25,'                                                                                 Yours faithfully,','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(26,'                                                                                                                 #OWNERF#','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(27,'AUTHORISED SIGNATORIES:','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(28,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(29,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(30,'                        Derivatives/Currency Derivatives Segment Bye-laws','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(31,'     Resolution by Arbitration','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(32,'12.1 In case of any claim, complaint, dispute or difference between a Member and a Client arising out of or in relation to a Derivatives Contract or trading, clearing 
or','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(33,'settlement in a Derivatives Contract made subject to the Rules, Bye-laws and Regulations of the Derivatives Segment or with reference to anything incidental','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(34,'thereto or in pursuance thereof or relating to the construction, fulfillment or validity thereof, the parties thereto shall resolve such claim, complaint, dispute or',
'F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(35,'difference by arbitration as per the procedure specified in this Chapter. In respect of any claim, complaint, dispute or difference to be resolved by arbitration, no',
'F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(36,'party shall commence any legal proceedings in a court or other tribunal without the permission of the Governing Council.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(37,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(38,'     Submission of Dispute','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(39,'12.2 In the case of every claim, complaint, dispute or difference of the kind referred to in Bye-law [12.1], any of the parties concerned may submit to the concerned R
egional','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(40,'Arbitration Centre of the Exchange an application for arbitration in such form and with such fee as may be specified by the Derivatives Segment/Currency Derivatives Se
gment from time to time.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(41,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(42,'     Operation of Contracts','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(43,'12.36 All dealings, transactions and contracts which are subject to these Rules, Byelaws and Regulations shall take effect as if wholly made, entered into and to be','
F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(44,'performed in the city of Mumbai and the parties to such dealings, transactions, contracts and agreements shall be deemed to have submitted to the exclusive','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(45,'jurisdiction of the Courts in Mumbai for the purpose of giving effect to the provisions of these Rules, Bye-laws and Regulations. Provided, however, that','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(46,'upon the amendments to the Rules, Bye-laws and Regulations with regards to Regional Arbitration Centres and other incidental and consequential matters in','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(47,'connection therewith or relating thereto coming into force, the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(48,'Exchange is a party, and in respect of all other proceedings, the courts having jurisdiction over the area in which the respective Regional Arbitration Centre is','F')
  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(49,'situated, shall have jurisdiction.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(50,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(51,'     Derivatives/Currency Derivatives Segment Regulations','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(52,'3.1A The Application for Arbitration shall be filed by the Applicant at the concerned Regional Arbitration Centre referred to in column 1 below covering that State or'
,'F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(53,'Union Territory of India, referred to in column 2 below, within which the most recent residential address or registered office of the client, as duly','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(54,'communicated in writing to the member in accordance with law, is located.Provided in respect of a non-resident Indian client, the Seat of Arbitration shall','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(55,'be Regional Arbitration Centre which covers the States or Union Territories given in the Column 2, in which lies the address or the registered office address,','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(56,'as the case may be, of the Member, depending upon corporate or non-corporate membership of the Member. The hearings shall be held in the concerned','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(57,'Regional Arbitration Centre in which the Applicant has duly filed the Application for Arbitration.','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(58,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(59,'<TABLE Border=1 BorderColor=Black><TR><TD>   Column 1  </TD><TD>      Column 2</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(60,'<TR><TD>Regional Arbitration Centres</TD><TD>       States and Union Territories covered by the Regional Arbitration Centres</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(61,'<TR><TD>DELHI</TD><TD>                                                                            Delhi, Haryana, Uttar Pradesh, Uttaranchal, Himachal Pradesh, Punjab
, Jammu & Kashmir, Chandigarh, Rajasthan</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(62,'<TR><TD>KOLKATA</TD><TD>                                                                          West Bengal, Bihar, Jharkhand, Orissa, Assam, Arunachal Pradesh, Mizo
ram,Manipur, Sikkim, Meghalaya, Nagaland, Tripura, Chhattisgarh</TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(63,'<TR><TD>CHENNAI</TD><TD>                                                                          Andhra Pradesh, Karnataka, Kerala, Tamilnadu, Andaman & Nicobar, Laks
hadweep, Pondicherry. </TD></TR>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(64,'<TR><TD>Mumbai</TD><TD>                                                                           Maharashtra, Gujarat, Goa, Daman & Diu, Dadra &  Nagar Haveli, Madhya
 Pradesh</TD></TR></TABLE>','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(65,'                                  JURISDICTION OF COURTS','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(66,'Upon the amendments to the Rules, Bye-laws and Regulations with regard to Regional Arbitration Centers and other incidental and consequential matters in connection the
rewith','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(67,'or relating thereto coming into force,  the Courts in Mumbai shall have exclusive jurisdiction in respect of all proceedings to which the Exchange is a party, and in r
espect','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(68,'of all other proceedings,  the  Courts having jurisdiction over the area in which the  respective Regional Arbitration Centre is situated, shall have jurisdiction.','F
')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(69,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(70,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(71,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(72,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(73,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(74,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(75,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(76,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(77,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(78,'  ','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(79,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(80,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(81,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(82,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(83,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(84,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(85,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(86,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(87,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(88,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(89,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(90,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(91,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(92,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(93,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(94,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(95,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(96,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(97,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(98,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(99,'','F')  
INSERT INTO [V2_CONTRACT_DIGITAL_TEXT_13012012] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(100,'','F')   
  
  SELECT * INTO V2_CONTRACT_DIGITAL_DATA FROM V2_CONTRACT_DIGITAL_DATA_13012012 ORDER BY C_SR_NO ASC  
  SELECT * INTO V2_CONTRACT_DIGITAL_TEXT FROM V2_CONTRACT_DIGITAL_TEXT_13012012 ORDER BY C_SR_NO ASC  
    
  DROP TABLE V2_CONTRACT_DIGITAL_DATA_13012012  
  DROP TABLE V2_CONTRACT_DIGITAL_TEXT_13012012  
  
  
--COMMIT  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FOBILLDETAIL
-- --------------------------------------------------
---EXEC V2_FOBILLDETAIL 'BROKER','BROKER','FEB 12 2007','02Q32','02Q32','','ZZZZZZZ','','ZZZZZZZ'    
    
    
CREATE    PROC [DBO].[V2_FOBILLDETAIL]    
 (    
 @STATUSID VARCHAR(20),    
 @STATUSNAME VARCHAR(50),    
 @FROMDATE VARCHAR(11),     
 @FROMPARTYCODE VARCHAR(20),    
 @TOPARTYCODE VARCHAR(20),    
 @FROMBRANCH VARCHAR(10),    
 @TOBRANCH VARCHAR(10),    
 @FROMSUB_BROKER VARCHAR(10),    
 @TOSUB_BROKER VARCHAR(10),    
 @TODATE VARCHAR(11)=''     
 )    
     
 AS    
    
 IF @TODATE = ''    
 BEGIN    
  SET @TODATE = @FROMDATE    
 END    
    
 SET NOCOUNT ON    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
     
 SELECT    
  PARTYNAME = F.PARTY_NAME,    
  F.PARTY_CODE,     
  F.CLIENT_TYPE,     
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
         C1.OFF_PHONE1,     
         C1.OFF_PHONE2,     
  F.BRANCH_CODE BRANCH_CD,    
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  MULTIPLIER = LOT_SIZE,    
  BILLNO = '0000000000',    
  CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,    
  INST_TYPE = PRODUCT_CODE,    
  SYMBOL = SERIES_CODE,    
  CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,    
  F.STRIKE_PRICE,     
  OPTION_TYPE = (CASE WHEN F.PRODUCT_TYPE = '' THEN '' ELSE F.PRODUCT_TYPE END),    
  CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,    
         SCRIPNAME  = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + LEFT(EXPIRYDATE,11) + ' '    
    + (CASE WHEN STRIKE_PRICE > 0 THEN RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + '' ELSE + ' ' END)    
    + (CASE WHEN PRODUCT_TYPE <> '' THEN RTRIM(PRODUCT_TYPE) ELSE + '' END) ),    
         SCRIPNAME1 = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + CONVERT(VARCHAR,SERIES_ID)),    
  CL_RATE AS CLRATE,     
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END END AS PRATE,        
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END END AS SRATE,        
      
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,        
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,        
      
  CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,        
  CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,        
     
  SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,        
  SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) ) AS CHRG_TOTAL,        
  SUM((F.PBILLAMT) + ((F.SERVICE_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,        
     
  CLCHARGES = SUM(F.CL_CHRG - F.EXCL_CHRG), /* CLEARING CHARGES */    
  SERVICE_TAX = SUM(F.SERVICE_TAX - F.EXSER_TAX), /* SERVICE TAX */    
  SEBI_TAX = SUM(F.SEBI_TAX), /* SEBI TAX */    
  TURN_TAX = SUM(F.TURN_TAX), /* TURNOVER TAX */    
  BROKER_NOTE = SUM(F.BROKER_NOTE), /* STAMP DUTY */    
  INS_CHRG = SUM(F.INS_CHRG), /* INS CHARGES */    
  OTHER_CHRG = SUM(F.OTHER_CHRG), /* OTHERCHARGES */    
     
  CASE WHEN F.TRADETYPE = 'BF'     
   THEN '<FONT STYLE="COLOR: #FF0000;">' + F.TRADETYPE + '</FONT>'         
          ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'FUT%'         
    THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'         
           ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'OPT%'         
     THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'         
     ELSE F.TRADETYPE         
                    END       
    END         
   END AS TRADETYPE,        
     
   CASE WHEN F.TRADETYPE = 'BF'     
   THEN F.TRADETYPE        
   ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'FUT%'         
    THEN  'FF'         
    ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'OPT%'         
     THEN  'EA'         
     ELSE F.TRADETYPE         
     END         
    END         
   END AS TRADETYPEPRINT         
     
 INTO #FOBILL    
     
 FROM    
  BFOBILLVALAN F (NOLOCK),     
  CLIENT1 C1 (NOLOCK),     
  CLIENT2 C2 (NOLOCK)    
     
 WHERE    
  C1.CL_CODE = C2.CL_CODE    
  AND C2.PARTY_CODE = F.PARTY_CODE    
  AND F.PARTY_CODE >= @FROMPARTYCODE    
  AND F.PARTY_CODE <= @TOPARTYCODE    
  AND F.SAUDA_DATE >= @FROMDATE    
         AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'    
   AND F.TRADETYPE LIKE     
   (CASE WHEN PRODUCT_CODE LIKE 'OPT%'     
    THEN 'BT'     
    ELSE '%'     
    END )    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')    
     WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')    
     WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')    
     WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')    
     WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')    
     WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')    
     WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')    
     WHEN @STATUSID = 'BROKER' THEN @STATUSNAME    
     END)    
         AND F.BRANCH_CODE  >= @FROMBRANCH     
         AND F.BRANCH_CODE  <= @TOBRANCH     
         AND F.SUB_BROKER  >= @FROMSUB_BROKER    
         AND F.SUB_BROKER  <= @TOSUB_BROKER     
    
 GROUP BY     
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,     
  F.PARTY_CODE,     
  F.PARTY_NAME,     
  F.CLIENT_TYPE,     
  F.SERIES_CODE,     
  F.PRODUCT_CODE,     
  F.EXPIRYDATE,     
  F.STRIKE_PRICE,     
  F.PRODUCT_TYPE,    
  F.SERIES_ID,    
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,     
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
  F.TRADETYPE,     
         C1.OFF_PHONE1,     
         C1.OFF_PHONE2,     
  F.SAUDA_DATE,    
  C1.EMAIL,    
  CL_RATE,    
  AUCTIONPART,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  BILLNO,    
LOT_SIZE  
    
    
 INSERT INTO #FOBILL    
 SELECT    
  PARTYNAME = F.PARTY_NAME,    
  F.PARTY_CODE,     
  F.CLIENT_TYPE,     
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
         C1.OFF_PHONE1,     
         C1.OFF_PHONE2,     
  F.BRANCH_CODE BRANCH_CD,    
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  MULTIPLIER = LOT_SIZE,    
  BILLNO = '0000000000',    
  CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,    
  INST_TYPE = PRODUCT_CODE,    
  SYMBOL = SERIES_CODE,    
  CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,    
  F.STRIKE_PRICE,     
  OPTION_TYPE = (CASE WHEN F.PRODUCT_TYPE = '' THEN '' ELSE F.PRODUCT_TYPE END),    
  CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,    
         SCRIPNAME  = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + LEFT(EXPIRYDATE,11) + ' '    
    + (CASE WHEN STRIKE_PRICE > 0 THEN RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + '' ELSE + ' ' END)    
    + (CASE WHEN PRODUCT_TYPE <> '' THEN RTRIM(PRODUCT_TYPE) ELSE + '' END) ),    
         SCRIPNAME1 = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + CONVERT(VARCHAR,SERIES_ID)),    
    
  CLRATE = 0, --CL_RATE    
  PRATE = CASE WHEN SUM(PQTY - SQTY) < 0 THEN CL_RATE ELSE 0  END,    
  SRATE = CASE WHEN SUM(PQTY - SQTY) > 0 THEN CL_RATE ELSE 0  END,    
  PQTY = CASE WHEN SUM(PQTY - SQTY) < 0 THEN ABS(SUM(PQTY - SQTY)) ELSE 0  END,    
  SQTY = CASE WHEN SUM(PQTY - SQTY) > 0 THEN ABS(SUM(PQTY - SQTY)) ELSE 0  END,    
  PBILLAMT = 0,    
  SBILLAMT = 0,    
  DIFF = 0,    
  CHRG_TOTAL = 0,    
  FINALFIGURE = 0,    
  CLCHARGES = 0, /* CLEARING CHARGES */    
  SERVICE_TAX = 0, /* SERVICE TAX */    
  SEBI_TAX = 0, /* SEBI TAX */    
  TURN_TAX = 0, /* TURNOVER TAX */    
  BROKER_NOTE = 0, /* STAMP DUTY */    
  INS_CHRG = 0, /* INS CHARGES */    
  OTHER_CHRG = 0, /* OTHERCHARGES */    
  TRADETYPE = 'CF',    
  TRADETYPEPRINT = 'CF'    
 FROM    
  BFOBILLVALAN F (NOLOCK),     
  CLIENT1 C1 (NOLOCK),     
  CLIENT2 C2 (NOLOCK)    
     
 WHERE    
  C1.CL_CODE = C2.CL_CODE    
  AND C2.PARTY_CODE = F.PARTY_CODE    
  AND F.PARTY_CODE >= @FROMPARTYCODE    
  AND F.PARTY_CODE <= @TOPARTYCODE    
  AND F.SAUDA_DATE >= @FROMDATE    
         AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'    
   /*AND F.TRADETYPE LIKE     
   (CASE WHEN PRODUCT_CODE LIKE 'OPT%'     
    THEN 'BT'     
    ELSE '%'     
    END )*/    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')    
     WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')    
     WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')    
     WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')    
     WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')    
     WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')    
     WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')    
     WHEN @STATUSID = 'BROKER' THEN @STATUSNAME    
     END)    
         AND F.BRANCH_CODE  >= @FROMBRANCH     
         AND F.BRANCH_CODE  <= @TOBRANCH     
         AND F.SUB_BROKER  >= @FROMSUB_BROKER    
         AND F.SUB_BROKER  <= @TOSUB_BROKER     
     
 GROUP BY     
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,     
  F.PARTY_CODE,     
  F.PARTY_NAME,     
  F.CLIENT_TYPE,     
  F.SERIES_CODE,     
  F.PRODUCT_CODE,     
  F.EXPIRYDATE,     
  F.STRIKE_PRICE,     
  F.PRODUCT_TYPE,    
  F.SERIES_ID,    
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,     
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
  C1.OFF_PHONE1,     
  C1.OFF_PHONE2,     
  F.SAUDA_DATE,    
  C1.EMAIL,    
  CL_RATE,    
  AUCTIONPART,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  BILLNO,    
LOT_SIZE  
    
 HAVING    
  SUM(PQTY-SQTY) <> 0    
    
 --------------------------------------------------------------------    
     
 UPDATE #FOBILL    
 SET BILLNO = FA.BILL_NO    
 FROM BFOACCBILL FA    
 WHERE FA.PARTY_CODE = #FOBILL.PARTY_CODE    
 AND LEFT(SAUDADATE,11) = LEFT(CONVERT(VARCHAR,BILLDATE,103),11)    
    
    
 SELECT     
  *     
 FROM     
  #FOBILL    
 ORDER BY     
  BRANCH_CODE,    
  SUB_BROKER,    
  PARTY_CODE,     
  CLIENT_TYPE,     
  INST_TYPE,    
  SYMBOL,    
  EXPIRYDATE,    
  STRIKE_PRICE,     
  OPTION_TYPE,    
  TRADETYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FOBILLDETAIL_25012012
-- --------------------------------------------------
---EXEC V2_FOBILLDETAIL 'BROKER','BROKER','FEB 12 2007','02Q32','02Q32','','ZZZZZZZ','','ZZZZZZZ'    
    
    
CREATE    PROC [DBO].[V2_FOBILLDETAIL_25012012]    
 (    
 @STATUSID VARCHAR(20),    
 @STATUSNAME VARCHAR(50),    
 @FROMDATE VARCHAR(11),     
 @FROMPARTYCODE VARCHAR(20),    
 @TOPARTYCODE VARCHAR(20),    
 @FROMBRANCH VARCHAR(10),    
 @TOBRANCH VARCHAR(10),    
 @FROMSUB_BROKER VARCHAR(10),    
 @TOSUB_BROKER VARCHAR(10),    
 @TODATE VARCHAR(11)=''     
 )    
     
 AS    
    
 IF @TODATE = ''    
 BEGIN    
  SET @TODATE = @FROMDATE    
 END    
    
 SET NOCOUNT ON    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
     
 SELECT    
  PARTYNAME = F.PARTY_NAME,    
  F.PARTY_CODE,     
  F.CLIENT_TYPE,     
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
         C1.OFF_PHONE1,     
         C1.OFF_PHONE2,     
  F.BRANCH_CODE BRANCH_CD,    
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  MULTIPLIER = LOT_SIZE,    
  BILLNO = '0000000000',    
  CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,    
  INST_TYPE = PRODUCT_CODE,    
  SYMBOL = SERIES_CODE,    
  CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,    
  F.STRIKE_PRICE,     
  OPTION_TYPE = (CASE WHEN F.PRODUCT_TYPE = '' THEN '' ELSE F.PRODUCT_TYPE END),    
  CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,    
         SCRIPNAME  = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + LEFT(EXPIRYDATE,11) + ' '    
    + (CASE WHEN STRIKE_PRICE > 0 THEN RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + '' ELSE + ' ' END)    
    + (CASE WHEN PRODUCT_TYPE <> '' THEN RTRIM(PRODUCT_TYPE) ELSE + '' END) ),    
         SCRIPNAME1 = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + CONVERT(VARCHAR,SERIES_ID)),    
  CL_RATE AS CLRATE,     
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END END AS PRATE,        
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END END AS SRATE,        
      
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,        
  CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,        
      
  CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,        
  CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,        
     
  SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,        
  SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) ) AS CHRG_TOTAL,        
  SUM((F.PBILLAMT) + ((F.SERVICE_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,        
     
  CLCHARGES = SUM(F.CL_CHRG - F.EXCL_CHRG), /* CLEARING CHARGES */    
  SERVICE_TAX = SUM(F.SERVICE_TAX - F.EXSER_TAX), /* SERVICE TAX */    
  SEBI_TAX = SUM(F.SEBI_TAX), /* SEBI TAX */    
  TURN_TAX = SUM(F.TURN_TAX), /* TURNOVER TAX */    
  BROKER_NOTE = SUM(F.BROKER_NOTE), /* STAMP DUTY */    
  INS_CHRG = SUM(F.INS_CHRG), /* INS CHARGES */    
  OTHER_CHRG = SUM(F.OTHER_CHRG), /* OTHERCHARGES */    
     
  CASE WHEN F.TRADETYPE = 'BF'     
   THEN '<FONT STYLE="COLOR: #FF0000;">' + F.TRADETYPE + '</FONT>'         
          ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'FUT%'         
    THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'         
           ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'OPT%'         
     THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'         
     ELSE F.TRADETYPE         
                    END       
    END         
   END AS TRADETYPE,        
     
   CASE WHEN F.TRADETYPE = 'BF'     
   THEN F.TRADETYPE        
   ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'FUT%'         
    THEN  'FF'         
    ELSE CASE WHEN AUCTIONPART = 'EA' AND PRODUCT_CODE LIKE 'OPT%'         
     THEN  'EA'         
     ELSE F.TRADETYPE         
     END         
    END         
   END AS TRADETYPEPRINT         
     
 INTO #FOBILL    
     
 FROM    
  BFOBILLVALAN F (NOLOCK),     
  CLIENT1 C1 (NOLOCK),     
  CLIENT2 C2 (NOLOCK)    
     
 WHERE    
  C1.CL_CODE = C2.CL_CODE    
  AND C2.PARTY_CODE = F.PARTY_CODE    
  AND F.PARTY_CODE >= @FROMPARTYCODE    
  AND F.PARTY_CODE <= @TOPARTYCODE    
  AND F.SAUDA_DATE >= @FROMDATE    
         AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'    
   AND F.TRADETYPE LIKE     
   (CASE WHEN PRODUCT_CODE LIKE 'OPT%'     
    THEN 'BT'     
    ELSE '%'     
    END )    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')    
     WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')    
     WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')    
     WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')    
     WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')    
     WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')    
     WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')    
     WHEN @STATUSID = 'BROKER' THEN @STATUSNAME    
     END)    
         AND F.BRANCH_CODE  >= @FROMBRANCH     
         AND F.BRANCH_CODE  <= @TOBRANCH     
         AND F.SUB_BROKER  >= @FROMSUB_BROKER    
         AND F.SUB_BROKER  <= @TOSUB_BROKER     
    
 GROUP BY     
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,     
  F.PARTY_CODE,     
  F.PARTY_NAME,     
  F.CLIENT_TYPE,     
  F.SERIES_CODE,     
  F.PRODUCT_CODE,     
  F.EXPIRYDATE,     
  F.STRIKE_PRICE,     
  F.PRODUCT_TYPE,    
  F.SERIES_ID,    
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,     
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
  F.TRADETYPE,     
         C1.OFF_PHONE1,     
         C1.OFF_PHONE2,     
  F.SAUDA_DATE,    
  C1.EMAIL,    
  CL_RATE,    
  AUCTIONPART,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  BILLNO,    
LOT_SIZE  
    
    
 INSERT INTO #FOBILL    
 SELECT    
  PARTYNAME = F.PARTY_NAME,    
  F.PARTY_CODE,     
  F.CLIENT_TYPE,     
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
         C1.OFF_PHONE1,     
         C1.OFF_PHONE2,     
  F.BRANCH_CODE BRANCH_CD,    
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  MULTIPLIER = LOT_SIZE,    
  BILLNO = '0000000000',    
  CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,    
  INST_TYPE = PRODUCT_CODE,    
  SYMBOL = SERIES_CODE,    
  CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,    
  F.STRIKE_PRICE,     
  OPTION_TYPE = (CASE WHEN F.PRODUCT_TYPE = '' THEN '' ELSE F.PRODUCT_TYPE END),    
  CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,    
         SCRIPNAME  = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + LEFT(EXPIRYDATE,11) + ' '    
    + (CASE WHEN STRIKE_PRICE > 0 THEN RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + '' ELSE + ' ' END)    
    + (CASE WHEN PRODUCT_TYPE <> '' THEN RTRIM(PRODUCT_TYPE) ELSE + '' END) ),    
         SCRIPNAME1 = (RTRIM(PRODUCT_CODE) + ' '    
    + RTRIM(SERIES_CODE) + ' '    
    + CONVERT(VARCHAR,SERIES_ID)),    
    
  CLRATE = 0, --CL_RATE    
  PRATE = CASE WHEN SUM(PQTY - SQTY) < 0 THEN CL_RATE ELSE 0  END,    
  SRATE = CASE WHEN SUM(PQTY - SQTY) > 0 THEN CL_RATE ELSE 0  END,    
  PQTY = CASE WHEN SUM(PQTY - SQTY) < 0 THEN ABS(SUM(PQTY - SQTY)) ELSE 0  END,    
  SQTY = CASE WHEN SUM(PQTY - SQTY) > 0 THEN ABS(SUM(PQTY - SQTY)) ELSE 0  END,    
  PBILLAMT = 0,    
  SBILLAMT = 0,    
  DIFF = 0,    
  CHRG_TOTAL = 0,    
  FINALFIGURE = 0,    
  CLCHARGES = 0, /* CLEARING CHARGES */    
  SERVICE_TAX = 0, /* SERVICE TAX */    
  SEBI_TAX = 0, /* SEBI TAX */    
  TURN_TAX = 0, /* TURNOVER TAX */    
  BROKER_NOTE = 0, /* STAMP DUTY */    
  INS_CHRG = 0, /* INS CHARGES */    
  OTHER_CHRG = 0, /* OTHERCHARGES */    
  TRADETYPE = 'CF',    
  TRADETYPEPRINT = 'CF'    
 FROM    
  BFOBILLVALAN F (NOLOCK),     
  CLIENT1 C1 (NOLOCK),     
  CLIENT2 C2 (NOLOCK)    
     
 WHERE    
  C1.CL_CODE = C2.CL_CODE    
  AND C2.PARTY_CODE = F.PARTY_CODE    
  AND F.PARTY_CODE >= @FROMPARTYCODE    
  AND F.PARTY_CODE <= @TOPARTYCODE    
  AND F.SAUDA_DATE >= @FROMDATE    
         AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'    
   /*AND F.TRADETYPE LIKE     
   (CASE WHEN PRODUCT_CODE LIKE 'OPT%'     
    THEN 'BT'     
    ELSE '%'     
    END )*/    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')    
     WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')    
     WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')    
     WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')    
     WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')    
     WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')    
     WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')    
     WHEN @STATUSID = 'BROKER' THEN @STATUSNAME    
     END)    
         AND F.BRANCH_CODE  >= @FROMBRANCH     
         AND F.BRANCH_CODE  <= @TOBRANCH     
         AND F.SUB_BROKER  >= @FROMSUB_BROKER    
         AND F.SUB_BROKER  <= @TOSUB_BROKER     
     
 GROUP BY     
  F.BRANCH_CODE,    
  F.SUB_BROKER,    
         C1.TRADER,     
  F.PARTY_CODE,     
  F.PARTY_NAME,     
  F.CLIENT_TYPE,     
  F.SERIES_CODE,     
  F.PRODUCT_CODE,     
  F.EXPIRYDATE,     
  F.STRIKE_PRICE,     
  F.PRODUCT_TYPE,    
  F.SERIES_ID,    
  C1.L_ADDRESS1,     
  C1.L_ADDRESS2,     
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_STATE,    
  C1.L_NATION,    
  C1.L_ZIP,    
  C1.OFF_PHONE1,     
  C1.OFF_PHONE2,     
  F.SAUDA_DATE,    
  C1.EMAIL,    
  CL_RATE,    
  AUCTIONPART,    
  C1.PAN_GIR_NO,    
  C2.SERVICE_CHRG,    
  BILLNO,    
LOT_SIZE  
    
 HAVING    
  SUM(PQTY-SQTY) <> 0    
    
 --------------------------------------------------------------------    
     
 UPDATE #FOBILL    
 SET BILLNO = FA.BILL_NO    
 FROM BFOACCBILL FA    
 WHERE FA.PARTY_CODE = #FOBILL.PARTY_CODE    
 AND LEFT(SAUDADATE,11) = LEFT(CONVERT(VARCHAR,BILLDATE,103),11)    
    
    
 SELECT     
  *     
 FROM     
  #FOBILL    
 ORDER BY     
  BRANCH_CODE,    
  SUB_BROKER,    
  PARTY_CODE,     
  CLIENT_TYPE,     
  INST_TYPE,    
  SYMBOL,    
  EXPIRYDATE,    
  STRIKE_PRICE,     
  OPTION_TYPE,    
  TRADETYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FOSETTBROKEDITUP
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_FOSETTBROKEDITUP]    
(    
 @OPTION_TYPE VARCHAR(2),      
 @INST_TYPE VARCHAR(6),      
 @SYMBOL VARCHAR(20),      
 @SAUDA_DATE VARCHAR(11),      
 @STRIKE_PRICE NUMERIC(9),      
 @PARTY_CODE VARCHAR(10),      
 @TRADE_NO VARCHAR(14),      
 @ORDER_NO VARCHAR(16),      
 @CONTRACTNO VARCHAR(14) ,      
 @MARKETRATE NUMERIC(18,9),      
 @BROK NUMERIC(18,8),      
 @VAL_PERC VARCHAR(1),      
 @SELL_BUY INT,      
 @NETRATE NUMERIC(18,9),       
 @EXPIRYDATE VARCHAR(20),      
 @FLAG INT,    
 @STATUSID VARCHAR(50)='BROKER',    
 @STRMODULE VARCHAR(50)='BROKER'  
)      
AS      

DECLARE 
@ROFIG INT,
@NOZERO INT,
@ROUND_TO INT,
@ERRNUM NUMERIC(18,10)

SELECT @ROUND_TO = ROUND_TO, @NOZERO = NOZERO, @ROFIG = ROFIG, @ERRNUM = ERRNUM
FROM FOCLIENTTAXES
WHERE PARTY_CODE = @PARTY_CODE
AND @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO

SELECT @EXPIRYDATE = LEFT(CONVERT(DATETIME,@EXPIRYDATE),11) + ' 23:59'

IF @FLAG = 1       
BEGIN       
  UPDATE FOSETTLEMENT SET      
    BROKAPPLIED = (  CASE        
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
      THEN   @BROK    
     
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
      THEN   @BROK    
     
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
      THEN        
       ((FLOOR ( (((@BROK*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,@ROUND_TO) + @ROFIG +       
       @ERRNUM ) / (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  /POWER(10,@ROUND_TO))      
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
      THEN       
       ((FLOOR(( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +       
       @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
      WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )       
      THEN  @BROK    
     
      WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )       
      THEN       
       ((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) /(@ROFIG +       
       @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
      WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )      
      THEN   @BROK    
     
      WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )      
      THEN               
       ((FLOOR(( ((@BROK*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +       
       @ERRNUM ) /(@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
      WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )      
      THEN   @BROK    
     
      WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )      
      THEN       
       ((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +       
       @ERRNUM ) /(@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
      WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )      
      THEN  @BROK    
     
      WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )      
      THEN       
       ((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +       
       @ERRNUM ) / (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
      ELSE  0       
     END       
    ),      
       
  NETRATE = (  CASE        
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
     THEN       
  FOSETTLEMENT.PRICE + @BROK    
     
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
     THEN       
     
  FOSETTLEMENT.PRICE - @BROK    
     
     
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
     THEN       
      (FOSETTLEMENT.PRICE)+ ((FLOOR(( (((@BROK*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,@ROUND_TO)+@ROFIG +       
      @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
     THEN       
      (FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,@ROUND_TO)+@ROFIG +       
      @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
     WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )       
     THEN       
     
  FOSETTLEMENT.PRICE + @BROK    
     
     
     WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )       
     THEN       
      (FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
     WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )      
     THEN       
  FOSETTLEMENT.PRICE - @BROK    
     WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )      
     THEN       
      (FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
     WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )      
     THEN      
     
  FOSETTLEMENT.PRICE + @BROK    
     
     
     WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )      
     THEN       
      (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+@ROFIG +       
      @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
     WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )      
     THEN       
     
  FOSETTLEMENT.PRICE - @BROK    
     
     
     WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )      
     THEN       
      (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  /  POWER(10,@ROUND_TO))      
     ELSE  0       
    END       
    ),      
  AMOUNT =       
     ( CASE        
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
     THEN       
     
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)    
     
     
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
     THEN       
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)    
     
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
     THEN       
      FOSETTLEMENT.TRADEQTY  * ((FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100 )* F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
     THEN       
      FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
     WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )       
     THEN       
     
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)    
     
     WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )      
     THEN       
      FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
     WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )      
     THEN       
    
     
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)    
 
    WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )      
     THEN       
      FOSETTLEMENT.TRADEQTY * (  (FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
     WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )      
     THEN       
     
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)    
     
     WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )      
     THEN       
      FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
     WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )      
     THEN       
     
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)    
     
     WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )      
     THEN       
      FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
      @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  /  POWER(10,@ROUND_TO)))      
     ELSE  0       
    END       
    ),  
  SERVICE_TAX =  (CASE      
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V')    
      THEN     
  ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
      WHEN (FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P')    
      THEN     
       ((FLOOR((     
       (((((FLOOR((   ((@BROK*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +    
       @ERRNUM ) / (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
       POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  FOGLOBALS.SERVICE_TAX) / 100) * POWER(10,@ROUND_TO)+    
       @ROFIG + @ERRNUM ) /    
       (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))    
      WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )     
      THEN  
  ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
      WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )     
      THEN     
       ((FLOOR((     
       (((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / (@ROFIG +    
       @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
       POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+    
       @ROFIG + @ERRNUM ) /    
       (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
      WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )    
      THEN     
  
 ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
  
      WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )    
      THEN     
       ((FLOOR((     
       (((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / (@ROFIG +     
       @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
       POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+    
       @ROFIG + @ERRNUM ) /    
       (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
      WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )    
      THEN      
  
 ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
  
      WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )    
      THEN     
       ((FLOOR((     
       (((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / (@ROFIG +    
       @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
       POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+    
       @ROFIG + @ERRNUM ) / 
    (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
      WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )    
      THEN       
  
 ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
  
  
      WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )    
      THEN      
       ((FLOOR((     
       (((((FLOOR((( (@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / (@ROFIG +     
       @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
       POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+    
       @ROFIG + @ERRNUM ) /    
       (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
      ELSE  0     
     END     
     ),      
   TRADE_AMOUNT = FOSETTLEMENT.TRADEQTY * FOSETTLEMENT.PRICE,             
   STATUS = 'E'      
   FROM      
    FOSETTLEMENT,      
    BROKTABLE,      
    CLIENT2,      
    CLIENT1,      
    FOGLOBALS,      
         ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,F.STRIKE_PRICE,      
      F.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,      
      SAUDA_DATE,F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,      
      BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,      
      BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,        
      MPRICE = (CASE WHEN C2.DUMMY1 = 0         
              THEN PRICE         
              ELSE        
           (CASE WHEN C2.DUMMY1 = 1         
          THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
                        ELSE F.STRIKE_PRICE + PRICE          
            END)        
         END) ,         
      MULTIPLIER = 1,       
      TAXPRICE = (CASE WHEN TAXESFLAG = 0         
              THEN PRICE         
              ELSE        
           (CASE WHEN TAXESFLAG = 1         
          THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
                        ELSE F.STRIKE_PRICE + PRICE          
            END)        
         END) ,        
      F.RESERVED1,F.DUMMY1,STATUS        
      FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER        
      WHERE C2.PARTY_CODE = F.PARTY_CODE         
      AND F.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'      
      AND F.PARTY_CODE = @PARTY_CODE    
      AND F.INST_TYPE = @INST_TYPE        
      AND F.SYMBOL = @SYMBOL        
      AND F.EXPIRYDATE = @EXPIRYDATE       
      AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)        
      AND F.OPTION_TYPE = @OPTION_TYPE      
          ) F     
   WHERE       
   LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND      
   FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE       
   AND FOSETTLEMENT.INST_TYPE = @INST_TYPE      
   AND FOSETTLEMENT.SYMBOL = @SYMBOL        
   AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = LEFT(@EXPIRYDATE,11)
   AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                       
   AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE       
   AND FOSETTLEMENT.TRADE_NO = CASE WHEN @TRADE_NO  ='%' THEN FOSETTLEMENT.TRADE_NO ELSE @TRADE_NO END       
   AND FOSETTLEMENT.ORDER_NO = CASE WHEN @ORDER_NO  ='%' THEN FOSETTLEMENT.ORDER_NO ELSE @ORDER_NO END         
   AND FOSETTLEMENT.CONTRACTNO = CASE WHEN @CONTRACTNO  ='%' THEN FOSETTLEMENT.CONTRACTNO ELSE @CONTRACTNO END      
   AND CLIENT2.PARTY_CODE = @PARTY_CODE       
   AND CLIENT2.CL_CODE = CLIENT1.CL_CODE      
   AND FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND      
   FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND        
   FOSETTLEMENT.SYMBOL=F.SYMBOL AND      
   FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND      
   FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                      
   FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                        
   FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND      
   FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND       
   FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND      
   FOSETTLEMENT.SELL_BUY = F.SELL_BUY   AND      
   YEAR_START_DT <= FOSETTLEMENT.SAUDA_DATE AND      
   YEAR_END_DT >= FOSETTLEMENT.SAUDA_DATE        
   AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE TABLE_NO = (CASE WHEN RIGHT(F.INST_TYPE,3) = 'FUT'        
          THEN CLIENT2.STD_RATE      
          ELSE CLIENT2.BROK2_TABLENO      
          END))      
   AND BROKTABLE.LINE_NO = 1       
AND FOSETTLEMENT.TRADEQTY > 0       
    
    
    
END      
IF @FLAG = 2       
BEGIN      
  UPDATE FOSETTLEMENT SET      
  BROKAPPLIED = (  CASE        
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
    THEN  @BROK    
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
    THEN   @BROK    
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
    THEN        
     ((FLOOR ( (((@BROK*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,@ROUND_TO) + @ROFIG +       
     @ERRNUM ) / (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  /POWER(10,@ROUND_TO))      
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
    THEN       
     ((FLOOR(( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +      
      @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )       
    THEN @BROK    
    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )       
    THEN       
     ((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +       
     @ERRNUM ) /(@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )      
    THEN  @BROK    
    WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )      
    THEN               
     ((FLOOR(( ((@BROK*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +       
     @ERRNUM ) /(@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
     WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )      
    THEN  @BROK    
    WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )      
    THEN       
     ((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /(@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )      
    THEN  @BROK    
    WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )      
    THEN       
     ((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) / (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    ELSE  0       
    END       
   ),      
      
  NETRATE = (  CASE        
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
    THEN       
  FOSETTLEMENT.PRICE + @BROK    
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
    THEN       
  FOSETTLEMENT.PRICE - @BROK    
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
    THEN       
     (FOSETTLEMENT.PRICE)+ ((FLOOR(( (((@BROK*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,@ROUND_TO)+@ROFIG +      
      @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
    THEN       
     (FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,@ROUND_TO)+@ROFIG +       
     @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )       
    THEN     
  FOSETTLEMENT.PRICE + @BROK      
    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )       
    THEN       
     (FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )      
    THEN       
     FOSETTLEMENT.PRICE - @BROK    
    WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )      
    THEN       
     (FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )      
    THEN     
  FOSETTLEMENT.PRICE + @BROK      
    WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )      
    THEN       
     (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) /  (@ROFIG +       
     @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO))      
    WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )      
    THEN       
  FOSETTLEMENT.PRICE - @BROK    
    WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )      
    THEN       
     (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  /  POWER(10,@ROUND_TO))      
    ELSE  0       
    END       
   ),      
  AMOUNT =       
    (  CASE        
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
    THEN       
    FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)    
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
    THEN       
    FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)     
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
    THEN       
     FOSETTLEMENT.TRADEQTY  * ((FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100 )* F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
    THEN       
     FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )       
    THEN       
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)    
    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )       
    THEN       
     FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
    WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )      
    THEN       
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)    
    WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )      
    THEN       
     FOSETTLEMENT.TRADEQTY * (  (FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))      
    WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )      
    THEN       
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)    
    WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )      
    THEN       
     FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  / POWER(10,@ROUND_TO)))         
    WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )      
    THEN       
  FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)    
    WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )      
    THEN       
     FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,@ROUND_TO)+      
     @ROFIG + @ERRNUM ) /  (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) )  /  POWER(10,@ROUND_TO)))      
    ELSE  0       
    END       
   ),      
  
  SERVICE_TAX =  (CASE      
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V')    
     THEN     
  ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
   
     WHEN (FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P')    
     THEN     
      ((FLOOR((     
      (((((FLOOR((   ((@BROK*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +     
      @ERRNUM ) / (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
      POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) /    
      (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))    
     WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' )     
     THEN      
  ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
     WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' )     
     THEN     
      ((FLOOR((     
      (((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / (@ROFIG +     
      @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
      POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) /    
      (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
     WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )    
     THEN     
  ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
     WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )    
     THEN     
      ((FLOOR((     
      (((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / (@ROFIG +     
      @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
      POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) /    
      (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
     WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )    
     THEN      
  ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
     WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )    
     THEN     
      ((FLOOR((     
      (((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / (@ROFIG +    
      @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
      POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) /    
      (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
     WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )    
     THEN       
  ROUND(@BROK *  FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)  
     WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )    
     THEN      
      ((FLOOR((     
      (((((FLOOR((( (@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,@ROUND_TO)+@ROFIG +    
      @ERRNUM ) / (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) /    
      POWER(10,@ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,@ROUND_TO)+@ROFIG + @ERRNUM ) / 
      (@ROFIG + @NOZERO )) * (@ROFIG +@NOZERO ) ) / POWER(10,@ROUND_TO))        
     ELSE  0     
     END     
    ),    
    TRADE_AMOUNT = FOSETTLEMENT.TRADEQTY * FOSETTLEMENT.PRICE,   
    STATUS = 'E'      
   FROM      
     BROKTABLE,      
     CLIENT2,      
     CLIENT1 ,      
     FOGLOBALS,      
          ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,F.STRIKE_PRICE,      
       F.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,      
       SAUDA_DATE,F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,      
       BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,      
       BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,        
       MPRICE = (CASE WHEN C2.DUMMY1 = 0         
               THEN PRICE         
               ELSE        
            (CASE WHEN C2.DUMMY1 = 1         
           THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
                         ELSE F.STRIKE_PRICE + PRICE          
             END)        
          END) ,         
       MULTIPLIER = 1,       
       TAXPRICE = (CASE WHEN TAXESFLAG = 0         
               THEN PRICE         
               ELSE        
            (CASE WHEN TAXESFLAG = 1         
           THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
                         ELSE F.STRIKE_PRICE + PRICE          
             END)        
          END) ,        
       F.RESERVED1,F.DUMMY1,STATUS        
       FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER        
       WHERE C2.PARTY_CODE = F.PARTY_CODE         
       AND F.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'        
       AND F.PARTY_CODE = @PARTY_CODE        
       AND F.INST_TYPE = @INST_TYPE        
       AND F.SYMBOL = @SYMBOL        
       AND F.EXPIRYDATE = @EXPIRYDATE 
       AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)        
       AND F.OPTION_TYPE = @OPTION_TYPE      
           ) F        
   WHERE       
     LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND      
     FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE       
     AND FOSETTLEMENT.INST_TYPE = @INST_TYPE      
     AND FOSETTLEMENT.SYMBOL = @SYMBOL        
     AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = LEFT(@EXPIRYDATE,11)
     AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                       
     AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE       
     AND FOSETTLEMENT.TRADE_NO = CASE WHEN @TRADE_NO  ='%' THEN FOSETTLEMENT.TRADE_NO ELSE @TRADE_NO END       
     AND FOSETTLEMENT.ORDER_NO = CASE WHEN @ORDER_NO  ='%' THEN FOSETTLEMENT.ORDER_NO ELSE @ORDER_NO END         
     AND FOSETTLEMENT.CONTRACTNO = CASE WHEN @CONTRACTNO  ='%' THEN FOSETTLEMENT.CONTRACTNO ELSE @CONTRACTNO END        
     AND FOSETTLEMENT.PRICE = @MARKETRATE       
     AND CLIENT2.PARTY_CODE = @PARTY_CODE       
     AND CLIENT2.CL_CODE = CLIENT1.CL_CODE      
     AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE       
            WHERE TABLE_NO = (CASE WHEN RIGHT(F.INST_TYPE,3) = 'FUT'        
            THEN CLIENT2.STD_RATE      
            ELSE CLIENT2.BROK2_TABLENO      
            END))      
     AND FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND      
     FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND        
     FOSETTLEMENT.SYMBOL=F.SYMBOL AND      
     FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND      
     FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                      
     FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                        
     FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND      
     FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND       
 FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND      
     FOSETTLEMENT.SELL_BUY = F.SELL_BUY         
     AND BROKTABLE.LINE_NO =  1       
     AND FOSETTLEMENT.SELL_BUY = @SELL_BUY      
     AND YEAR_START_DT <= FOSETTLEMENT.SAUDA_DATE      
     AND YEAR_END_DT >= FOSETTLEMENT.SAUDA_DATE    
	 AND FOSETTLEMENT.TRADEQTY > 0       
    
END          
ELSE IF @FLAG = 3      
BEGIN      
  UPDATE FOSETTLEMENT SET       
   NETRATE = @NETRATE, N_NETRATE =@NETRATE,      
   BROKAPPLIED = ABS(@NETRATE - F.MPRICE), NBROKAPP = ABS(@NETRATE - F.MPRICE),      
   SERVICE_TAX = CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE     
   ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,@ROUND_TO) END,       
   NSERTAX = ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,@ROUND_TO),      
   AMOUNT = ROUND(@NETRATE*FOSETTLEMENT.TRADEQTY,@ROUND_TO) , STATUS = 'E'      
  FROM       
    CLIENT2 ,      
    FOGLOBALS,      
    BROKTABLE,      
         ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,F.STRIKE_PRICE,      
      F.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,      
      SAUDA_DATE,F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,      
      BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,      
      BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,        
      MPRICE = (CASE WHEN C2.DUMMY1 = 0         
              THEN PRICE         
              ELSE        
           (CASE WHEN C2.DUMMY1 = 1         
          THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
                        ELSE F.STRIKE_PRICE + PRICE        
          END)        
         END) ,         
      MULTIPLIER = 1,       
      TAXPRICE = (CASE WHEN TAXESFLAG = 0         
              THEN PRICE         
              ELSE        
           (CASE WHEN TAXESFLAG = 1         
          THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
                        ELSE F.STRIKE_PRICE + PRICE          
            END)        
         END) ,        
      F.RESERVED1,F.DUMMY1,STATUS        
      FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER        
      WHERE C2.PARTY_CODE = F.PARTY_CODE         
      AND F.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
      AND F.PARTY_CODE = @PARTY_CODE        
      AND F.INST_TYPE = @INST_TYPE        
      AND F.SYMBOL = @SYMBOL        
      AND F.EXPIRYDATE = @EXPIRYDATE      
      AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)        
      AND F.OPTION_TYPE = @OPTION_TYPE      
          ) F     
  WHERE        
    LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND      
    FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE       
    AND FOSETTLEMENT.INST_TYPE = @INST_TYPE      
    AND FOSETTLEMENT.SYMBOL = @SYMBOL        
    AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = LEFT(@EXPIRYDATE,11)
    AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                       
    AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE       
    AND FOSETTLEMENT.TRADE_NO = CASE WHEN @TRADE_NO  ='%' THEN FOSETTLEMENT.TRADE_NO ELSE @TRADE_NO END       
    AND FOSETTLEMENT.ORDER_NO = CASE WHEN @ORDER_NO  ='%' THEN FOSETTLEMENT.ORDER_NO ELSE @ORDER_NO END         
    AND FOSETTLEMENT.CONTRACTNO = CASE WHEN @CONTRACTNO  ='%' THEN FOSETTLEMENT.CONTRACTNO ELSE @CONTRACTNO END        
    AND CLIENT2.PARTY_CODE = @PARTY_CODE      
    AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE      
           WHERE TABLE_NO = (CASE WHEN RIGHT(F.INST_TYPE,3) = 'FUT'        
                 THEN CLIENT2.STD_RATE      
          ELSE CLIENT2.BROK2_TABLENO      
                 END))      
    AND FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND      
    FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND        
    FOSETTLEMENT.SYMBOL=F.SYMBOL AND      
    FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND      
    FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                      
    FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                        
    FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND      
    FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND       
    FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND      
    FOSETTLEMENT.SELL_BUY = F.SELL_BUY  
    AND FOSETTLEMENT.SELL_BUY = @SELL_BUY      
    AND BROKTABLE.LINE_NO = 1      
    AND YEAR_START_DT <= FOSETTLEMENT.SAUDA_DATE      
    AND YEAR_END_DT >= FOSETTLEMENT.SAUDA_DATE        
    AND FOSETTLEMENT.TRADEQTY > 0       

END        
ELSE IF @FLAG =4      
BEGIN      
  UPDATE FOSETTLEMENT SET       
   NETRATE = @NETRATE, N_NETRATE =@NETRATE,      
   BROKAPPLIED = ABS(@NETRATE - F.MPRICE), NBROKAPP = ABS(@NETRATE - F.MPRICE),      
   SERVICE_TAX = CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE    
  ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,@ROUND_TO) END,      
   NSERTAX = ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,@ROUND_TO),      
   AMOUNT = ROUND(@NETRATE*FOSETTLEMENT.TRADEQTY,@ROUND_TO) , STATUS = 'E'      
  FROM      
    CLIENT2 ,      
    FOGLOBALS,      
    BROKTABLE,      
    FOSETTLEMENT,      
         ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,      
      USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,SAUDA_DATE,      
      F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,      
      AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,      
      NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,        
      MPRICE = (CASE WHEN C2.DUMMY1 = 0         
              THEN PRICE         
              ELSE        
				(CASE WHEN C2.DUMMY1 = 1         
						  THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
										ELSE F.STRIKE_PRICE + PRICE          
							END)        
						 END) ,         
      MULTIPLIER = 1,       
      TAXPRICE = (CASE WHEN TAXESFLAG = 0         
              THEN PRICE         
              ELSE        
           (CASE WHEN TAXESFLAG = 1         
          THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )             
                        ELSE F.STRIKE_PRICE + PRICE          
            END)        
         END) ,        
      F.RESERVED1,F.DUMMY1,STATUS        
      FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER        
      WHERE C2.PARTY_CODE = F.PARTY_CODE         
      AND F.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
      AND F.PARTY_CODE = @PARTY_CODE        
      AND F.INST_TYPE = @INST_TYPE        
      AND F.SYMBOL = @SYMBOL        
      AND F.EXPIRYDATE = @EXPIRYDATE       
      AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)            
      AND F.OPTION_TYPE = @OPTION_TYPE      
          ) F    
  WHERE       
   LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND      
   FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE       
   AND FOSETTLEMENT.INST_TYPE = @INST_TYPE      
   AND FOSETTLEMENT.SYMBOL = @SYMBOL        
   AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = LEFT(@EXPIRYDATE,11)        
   AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                       
   AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE       
   AND FOSETTLEMENT.TRADE_NO = CASE WHEN @TRADE_NO  ='%' THEN FOSETTLEMENT.TRADE_NO ELSE @TRADE_NO END       
   AND FOSETTLEMENT.ORDER_NO = CASE WHEN @ORDER_NO  ='%' THEN FOSETTLEMENT.ORDER_NO ELSE @ORDER_NO END         
   AND FOSETTLEMENT.CONTRACTNO = CASE WHEN @CONTRACTNO  ='%' THEN FOSETTLEMENT.CONTRACTNO ELSE @CONTRACTNO END        
   AND FOSETTLEMENT.PRICE = @MARKETRATE       
   AND CLIENT2.PARTY_CODE = @PARTY_CODE      
   AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE       
          WHERE TABLE_NO = (CASE WHEN RIGHT(F.INST_TYPE,3) = 'FUT'        
               THEN CLIENT2.STD_RATE      
               ELSE CLIENT2.BROK2_TABLENO      
               END))      
   AND FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND      
   FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND        
   FOSETTLEMENT.SYMBOL=F.SYMBOL AND      
   FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND      
   FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                      
   FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                        
   FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND      
   FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND       
   FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND      
   FOSETTLEMENT.SELL_BUY = F.SELL_BUY         
   AND FOSETTLEMENT.SELL_BUY = @SELL_BUY      
   AND BROKTABLE.LINE_NO = 1       
   AND YEAR_START_DT <= FOSETTLEMENT.SAUDA_DATE      
   AND YEAR_END_DT >= FOSETTLEMENT.SAUDA_DATE        
   AND FOSETTLEMENT.TRADEQTY > 0       
END        
  
  
UPDATE FOSETTLEMENT SET SERVICE_TAX = 0  
FROM CLIENT2 C2  
WHERE C2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE         
AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE        
AND FOSETTLEMENT.INST_TYPE = @INST_TYPE        
AND FOSETTLEMENT.SYMBOL = @SYMBOL        
AND FOSETTLEMENT.EXPIRYDATE = @EXPIRYDATE        
AND FOSETTLEMENT.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN FOSETTLEMENT.STRIKE_PRICE ELSE @STRIKE_PRICE END)        
AND FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE  
AND TRADE_NO = CASE WHEN @TRADE_NO  ='%' THEN TRADE_NO ELSE @TRADE_NO END     
AND ORDER_NO = CASE WHEN @ORDER_NO  ='%' THEN ORDER_NO ELSE @ORDER_NO END     
AND CONTRACTNO = CASE WHEN @CONTRACTNO  ='%' THEN CONTRACTNO ELSE @CONTRACTNO END
AND SELL_BUY = @SELL_BUY  
AND SERVICE_CHRG = 1 AND SERTAXMETHOD = 1
AND FOSETTLEMENT.TRADEQTY > 0       

INSERT INTO INST_LOG
(
	PARTY_CODE,
	NEW_PARTY_CODE,
	SAUDA_DATE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	ORDER_NO,
	TRADE_NO,
	SELL_BUY,
	CONTRACT_NO,
	NEW_CONTRACT_NO,
	BROKERAGE,
	NEW_BROKERAGE,
	MARKET_RATE,
	NEW_MARKET_RATE,
	NET_RATE,
	NEW_NET_RATE,
	QTY,
	NEW_QTY,
	ROUNDTO,
	PARTICIPANT_CODE,
	NEW_PARTICIPANT_CODE,
	USERNAME,
	MODULE,
	CALLED_FROM,
	TIMESTAMP,
	EXTRAFIELD3,
	EXTRAFIELD4,
	EXTRAFIELD5
)
SELECT
	@PARTY_CODE,
	@PARTY_CODE,
	@SAUDA_DATE,
	@INST_TYPE,
	@SYMBOL,
	@EXPIRYDATE,
	@STRIKE_PRICE,
	@OPTION_TYPE,
	@ORDER_NO,
	@TRADE_NO,
	@SELL_BUY,
	@CONTRACTNO,
	@CONTRACTNO,
	BROKERAGE = 0,
	NEW_BROKERAGE = 0,
	MARKET_RATE = 0,
	NEW_MARKET_RATE = 0,
	NET_RATE = 0,
	NEW_NET_RATE = 0,
	QTY = 0,
	NEW_QTY = 0,
	ROUNDTO = 0,
	PARTICIPANT_CODE = '%',
	NEW_PARTICIPANT_CODE = '%',
	USERNAME = @STATUSID,
	MODULE = @STRMODULE,
	CALLED_FROM = 'V2_FOSETTBROKEDITUP',
	TIMESTAMP = GETDATE(),
	EXTRAFIELD3 = '',
	EXTRAFIELD4 = '',
	EXTRAFIELD5 = ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INSTCONTSECTION
-- --------------------------------------------------
CREATE PROC [dbo].[V2_INSTCONTSECTION]
 (     
 @STATUSID VARCHAR(15),     
 @STATUSNAME VARCHAR(25),     
 @SAUDA_DATE VARCHAR(11),     
 @FROMPARTY_CODE VARCHAR(15),     
 @TOPARTY_CODE VARCHAR(15),     
 /*@FROMBRANCH VARCHAR(15),
 @TOBRANCH VARCHAR(15),
 @FROMSUB_BROKER VARCHAR(15),     
 @TOSUB_BROKER VARCHAR(15),*/     
 @BRANCH VARCHAR(10),     
 @SUB_BROKER VARCHAR(10),     
 @FROMCONTRACTNO VARCHAR(12),     
 @TOCONTRACTNO VARCHAR(12),     
 @CONTFLAG VARCHAR(10),
 @TOSAUDA_DATE VARCHAR(11) = '',
 @BOUNCEDFLAG INT = 0     
 )     
     
 AS     

---EXEC [V2_INSTCONTSECTION] 'BROKER','BROKER','SEP 29 2007'	,'','ZZZZZ','%','%','0','9999999999','CONTRACT','SEP 29 2011',0

 Declare @STax Numeric(18,4)

 Select @STax = Service_Tax From BFOGlobals
 Where @SAUDA_DATE BETWEEN BFOGLOBALS.YEAR_START_DT AND BFOGLOBALS.YEAR_END_DT     

 DECLARE @TOSUB_BROKER VARCHAR(15)
 DECLARE @TOBRANCH VARCHAR(15)
 
 If @SUB_BROKER = 'ALL' OR @SUB_BROKER = '' OR @SUB_BROKER = '%'
 Begin     
		Set @TOSUB_BROKER = 'zzzzzzzz'     
 End     
 If @BRANCH = 'ALL' OR @BRANCH = '' OR @BRANCH = '%'    
 Begin     
        Set @TOBRANCH = 'zzzzzzzz'     
 End     

 If @FROMCONTRACTNO = ''    
 Begin    
  set @FROMCONTRACTNO = 000000    
 End    
     
 If @TOCONTRACTNO = ''    
 Begin    
  Set @TOCONTRACTNO = 99999999    
 End

IF @TOSAUDA_DATE = ''
BEGIN
	SET @TOSAUDA_DATE = @SAUDA_DATE
END
    
CREATE TABLE #BPARTY
( 
PARTY_CODE VARCHAR(15) 
)

IF @BOUNCEDFLAG <> 0
BEGIN
	INSERT INTO #BPARTY
	SELECT 
		DISTINCT PARTY_CODE 
	FROM 
		TBL_ECNBOUNCED(NOLOCK) 
	WHERE 
		SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'
END
ELSE
BEGIN
	INSERT INTO #BPARTY
	SELECT 
		DISTINCT PARTY_CODE 
	FROM 
		CLIENT2 (NOLOCK) 
	WHERE 
		PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE
END

SELECT  C2.PARTY_CODE,     
        C1.LONG_NAME,     
        C1.L_ADDRESS1,     
        C1.L_ADDRESS2,     
        C1.L_ADDRESS3,     
        C1.L_CITY,     
        C1.L_STATE,     
        C1.L_ZIP,     
        C1.BRANCH_CD ,     
        C1.SUB_BROKER,     
        C1.TRADER,     
        C1.PAN_GIR_NO,     
        C1.OFF_PHONE1,     
        C1.OFF_PHONE2,     
        PRINTF,     
        MAPIDID,     
        C2.SERVICE_CHRG,     
        BROKERNOTE,     
        TURNOVER_TAX,     
        SEBI_TURN_TAX,     
        C2.OTHER_CHRG,     
        INSURANCE_CHRG,    
		SEBI_NO = FD_Code,
		CL_TYPE,
        CUSTODIANCODE   = ISNULL(C.CUSTODIANCODE,''),     
        PARTICIPANTCODE = ISNULL(C2.BANKID,''),
		PARENTCODE,
		UCC_CODE 
INTO    #CLIENTMASTER     
FROM    CLIENT1 C1     
WITH     
        (     
                NOLOCK     
        ),
        CLIENT2 C2     
WITH     
        (     
                NOLOCK     
        )     
LEFT OUTER JOIN CUSTODIAN C     
WITH    
        (    
                NOLOCK    
        )     
        ON (C2.CLTDPNO = C.CUSTODIANCODE)
LEFT OUTER JOIN UCC_CLIENT UC     
WITH     
        (     
                NOLOCK     
        )     
        ON C2.PARTY_CODE = UC.PARTY_CODE,
		CLIENT_PRINT_SETTINGS  CP (NOLOCK)
WHERE   C2.CL_CODE       = C1.CL_CODE     
        AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE
        AND Cl_Type = 'INS'     
        AND @STATUSNAME = (     
        CASE     
                WHEN @STATUSID = 'BRANCH'     
                THEN C1.BRANCH_CD     
                WHEN @STATUSID = 'SUBBROKER'     
                THEN C1.SUB_BROKER     
                WHEN @STATUSID = 'TRADER'     
                THEN C1.TRADER     
                WHEN @STATUSID = 'FAMILY'     
                THEN C1.FAMILY     
                WHEN @STATUSID = 'AREA'     
                THEN C1.AREA     
                WHEN @STATUSID = 'REGION'     
                THEN C1.REGION     
                WHEN @STATUSID = 'CLIENT'     
                THEN C2.PARTY_CODE     
                ELSE 'BROKER' END)     
        AND BRANCH_CD BETWEEN @BRANCH AND @TOBRANCH
        AND SUB_BROKER BETWEEN @SUB_BROKER AND @TOSUB_BROKER     
        AND PRINTF =  CP.PRINT_FLAG
		AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'
		AND C2.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))
		
		

SELECT  CONTRACTNO,     
        BILLNO=LOT_SIZE,     
        TRADE_NO,     
        PARTY_CODE,    
		PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIES_CODE,    
		SERIES_ID,    
		MARKETRATE=TRADE_PRICE,     
        EXPIRYDATE,     
        STRIKE_PRICE,     
        USER_ID=TERMINALID,     
        PRO_CLI,     
        TRADEQTY,     
        AUCTIONPART,     
        MARKETTYPE=OPTION_TYPE,     
        ORDER_NO,     
        SAUDA_DATE,     
        TABLE_NO,     
        LINE_NO,     
		VAL_PERC,     
        NORMAL,     
        DAY_PUC,     
        DAY_SALES,     
        SETT_PURCH,     
        SETT_SALES, 
        SELL_BUY,     
        SETTFLAG,     
        BROKAPPLIED,     
        NETRATE,     
        AMOUNT=TRADE_AMOUNT,     
        INS_CHRG,     
        TURN_TAX,     
        OTHER_CHRG,     
        SEBI_TAX,     
        BROKER_CHRG,     
        SERVICE_TAX,     
        TRADE_AMOUNT,     
        PARTICIPANTCODE,     
        STATUS,     
        ORDER_DATE=ORDER_TIMESTAMP,     
        DUMMY1,     
        DUMMY2,     
        RESERVED1     
INTO    #FOSETT     
FROM    BFOSETTLEMENT     
WHERE   1 = 2     

INSERT     
INTO    #FOSETT     
SELECT  CONTRACTNO,     
        BILLNO=LOT_SIZE,     
        TRADE_NO,     
        PARTY_CODE,     
		PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIES_CODE,    
		SERIES_ID,    
		MARKETRATE=TRADE_PRICE,     
        EXPIRYDATE,     
        STRIKE_PRICE,     
        USER_ID=TERMINALID,     
        PRO_CLI,     
        TRADEQTY,     
        AUCTIONPART,     
        MARKETTYPE=OPTION_TYPE,     
        ORDER_NO,     
		SAUDA_DATE,     
        TABLE_NO,     
        LINE_NO,     
        VAL_PERC,     
        NORMAL,     
        DAY_PUC,     
        DAY_SALES,     
        SETT_PURCH,     
        SETT_SALES,     
        SELL_BUY,     
        SETTFLAG,     
        BROKAPPLIED,     
        NETRATE,     
        AMOUNT=TRADE_AMOUNT,     
        INS_CHRG,     
        TURN_TAX,     
        OTHER_CHRG,     
        SEBI_TAX,     
        BROKER_CHRG,     
        SERVICE_TAX,     
        TRADE_AMOUNT,     
        PARTICIPANTCODE,     
        STATUS,     
        ORDER_DATE=ORDER_TIMESTAMP,     
        DUMMY1,     
        DUMMY2,     
        RESERVED1
FROM    BFOSETTLEMENT     
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'
        AND PARTY_CODE >= @FROMPARTY_CODE     
        AND PARTY_CODE <= @TOPARTY_CODE     
        AND AUCTIONPART NOT IN ('CA')     
        AND TRADEQTY <> 0     
        AND TRADE_PRICE > 0     
        AND ( RESERVED1 = 1    
		Or Party_Code In (Select Party_Code From #ClientMaster Where Cl_Type = 'INS') )    



Create  INDEX [DELPOS]     
        ON [dbo].[#FOSETT]     
        (     
                [PARTY_CODE]     
        )     
    
SELECT  ORDER_NO,     
        ORDER_TIME = RIGHT(ORDER_DATE,8),     
        TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),     
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,     
		BILLNO,
        PQTY = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN TRADEQTY     
                ELSE 0 END),     
        SQTY = (     
        CASE     
                WHEN SELL_BUY = 2     
                THEN TRADEQTY     
                ELSE 0 END),     
        PRATE = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN ISNULL(MARKETRATE,0)     
                ELSE 0 END),     
        SRATE = (     
        CASE     
                WHEN SELL_BUY = 2     
                THEN ISNULL(MARKETRATE,0)     
                ELSE 0 END),     
        PBROK =(     
    CASE     
                WHEN SELL_BUY = 1     
                THEN ISNULL((BROKAPPLIED + (     
                CASE     
                        WHEN C.SERVICE_CHRG=1     
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
                        ELSE 0 END )),0)     
				ELSE 0 END),     
        SBROK =(     
        CASE     
                WHEN SELL_BUY = 2     
                THEN ISNULL((BROKAPPLIED + (     
                CASE     
                        WHEN C.SERVICE_CHRG=1     
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
                        ELSE 0 END )),0)     
                ELSE 0 END),     
        PNETRATE = (     
        CASE     
                WHEN SELL_BUY =1     
                THEN ISNULL(NETRATE + (     
                CASE     
                        WHEN C.SERVICE_CHRG = 1     
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
                        ELSE 0 END),0)     
                ELSE 0 END),     
        SNETRATE = (     
        CASE     
                WHEN SELL_BUY =2     
                THEN ISNULL(NETRATE - (     
                CASE     
                        WHEN C.SERVICE_CHRG = 1     
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
                        ELSE 0 END),0)     
                ELSE 0 END),     
        ISNULL(AMOUNT,0) AMOUNT ,     
        PRODUCT_TYPE= (     
        CASE     
                WHEN F.AUCTIONPART = 'EA'     
                THEN STUFF(PRODUCT_TYPE,1,3,'EA-')     
                ELSE PRODUCT_TYPE END),     
		PRODUCT_CODE = (     
        CASE     
                WHEN F.AUCTIONPART = 'EA'     
                THEN STUFF(PRODUCT_CODE,1,3,'EA-')     
                ELSE PRODUCT_CODE END),    
		SERIES_CODE,    
		SERIES_ID,    
        PAMT=(     
        CASE     
                WHEN SELL_BUY = 1     
                THEN (TRADEQTY * NETRATE) + (     
                CASE     
                        WHEN C.SERVICE_CHRG = 1     
                        THEN ISNULL((F.SERVICE_TAX),0)     
                        ELSE (     
                        CASE     
                                WHEN C.SERVICE_CHRG = 0     
                                THEN 0     
                                ELSE (     
                                CASE     
                                        WHEN C.SERVICE_CHRG = 2     
                                        THEN 0     
                                        ELSE 0 END) END ) END )     
                ELSE 0 END),     
        SAMT=(     
        CASE     
                WHEN SELL_BUY = 2     
                THEN(TRADEQTY * NETRATE) - (     
                CASE     
                        WHEN C.SERVICE_CHRG = 1     
                        THEN ISNULL((F.SERVICE_TAX),0)     
                        ELSE (     
                        CASE     
                                WHEN C.SERVICE_CHRG = 0     
                                THEN 0     
                                ELSE (     
                                CASE     
                                        WHEN C.SERVICE_CHRG = 2     
                                        THEN 0     
                                        ELSE 0 END ) END ) END)     
                ELSE 0 END),     
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,     
        F.PARTY_CODE,     
        SELL_BUY,     
        CONTRACTNO,     
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,     
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,     
        PSERVICE_TAX= (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN (     
                CASE     
                        WHEN C.SERVICE_CHRG=0     
                        THEN (F.SERVICE_TAX)     
                        ELSE (     
                        CASE     
                              WHEN C.SERVICE_CHRG=1     
                                THEN 0     
                                ELSE (     
                                CASE     
                                        WHEN C.SERVICE_CHRG=2     
                                        THEN 0 END) END) END)     
                ELSE 0 END),     
        SSERVICE_TAX= (     
        CASE     
                WHEN SELL_BUY = 2     
                THEN (     
                CASE     
                        WHEN C.SERVICE_CHRG=0     
                        THEN (F.SERVICE_TAX)     
                        ELSE (     
                        CASE     
                                WHEN C.SERVICE_CHRG=1     
                                THEN 0     
                                ELSE (     
                                CASE     
                                        WHEN C.SERVICE_CHRG=2     
                                        THEN 0 END) END) END)     
                ELSE 0 END),     
        YY          =YEAR(SAUDA_DATE),     
        MM          =MONTH(SAUDA_DATE),     
        DD          =DAY(SAUDA_DATE),     
        DFLAG       = 1 ,     
        BROKER_CHRG = (     
        CASE     
                WHEN BROKERNOTE = 1     
                THEN BROKER_CHRG     
                ELSE 0 END ),     
        TURN_TAX = (     
        CASE     
                WHEN TURNOVER_TAX = 1     
                THEN TURN_TAX     
                ELSE 0 END),     
        SEBI_TAX = (     
        CASE     
                WHEN SEBI_TURN_TAX = 1     
                THEN SEBI_TAX     
                ELSE 0 END),     
        OTHER_CHRG = (     
        CASE     
                WHEN C.OTHER_CHRG = 1     
                THEN F.OTHER_CHRG     
                ELSE 0 END) ,     
        INS_CHRG = (     
        CASE     
                WHEN INSURANCE_CHRG = 1     
                THEN INS_CHRG     
                ELSE 0 END ),     
        SERVICE_TAX = (     
        CASE     
                WHEN SERVICE_CHRG = 0     
                THEN SERVICE_TAX     
                ELSE 0 END ),     
        NSERTAX = (     
        CASE     
                WHEN SERVICE_CHRG = 0     
                THEN SERVICE_TAX    
                ELSE 0 END ),     
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0) + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),
        C.BRANCH_CD ,     
        C.SUB_BROKER,     
        C.TRADER,     
        PRINTF,       
        C.SERVICE_CHRG,       
        PARTYNAME=LONG_NAME,     
        L_ADDRESS1,     
        L_ADDRESS2,     
        L_ADDRESS3,     
        L_CITY,     
        L_STATE,     
        L_ZIP,     
        PAN_GIR_NO,     
        OFF_PHONE1,           
		OFF_PHONE2,       
        MAPIDID,    
		SEBI_NO    
INTO    #CONTSETT     
FROM    #FOSETT F,     
        #CLIENTMASTER C     
WHERE   F.PARTY_CODE     >= @FROMPARTY_CODE     
        AND F.PARTY_CODE <= @TOPARTY_CODE     
		AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO    
        AND F.PARTY_CODE=C.PARTY_CODE     

UPDATE       
 #CONTSETT      
SET      
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END      
      + (CASE WHEN SERVICE_CHRG = 1 THEN       
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END      
        ELSE 0 END),      
 SERVICE_TAX = SERVICE_TAX+(CASE WHEN SERVICE_CHRG = 0 THEN       
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END      
   ELSE 0 END),      
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN       
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END      
   ELSE 0 END),      
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN       
   CASE WHEN SELL_BUY =1 THEN SERVICE_TAX+CD_TOT_BUYSERTAX ELSE 0 END      
   ELSE 0 END),      
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN       
   CASE WHEN SELL_BUY =1 THEN 0 ELSE SERVICE_TAX+CD_TOT_SELLSERTAX END      
   ELSE 0 END),      
        PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK       
  + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)      
              ELSE 0 END),       
        SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK       
  - (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)      
              ELSE 0 END)      
FROM      
 CHARGES_DETAIL      
WHERE      
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)      
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE       
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE    
 AND CD_PRODUCT_CODE = PRODUCT_CODE    
 AND CD_SERIES_ID = SERIES_ID    
 AND CD_SERIES_CODE = SERIES_CODE    
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE      
 AND PRADNYA.DBO.REPLACETRADENO(CD_TRADE_NO) = TRADE_NO      
 AND CD_ORDER_NO = ORDER_NO      
      


INSERT INTO #CONTSETT      
SELECT  CD_ORDER_NO,       
 ORDER_TIME = '',       
 CD_TRADE_NO,       
 TRADETIME='',       
 BILLNO=1,
 PQTY = 0,       
 SQTY = 0,       
 PRATE = 0,       
 SRATE = 0,       
 PBROK =0,       
 SBROK =0,       
 PNETRATE = 0,       
 SNETRATE = 0,       
 AMOUNT =0,       
 CD_PRODUCT_TYPE,       
 CD_PRODUCT_CODE,    
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),       
 CD_SERIES_ID,    
 PAMT=0,      
 SAMT=0,       
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE     
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,       
 CD_PARTY_CODE,      
 SELL_BUY = 1,       
 CD_CONTRACT_NO,       
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,       
 STRIKE_PRICE = 0 ,    
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN       
  CD_TOT_BUYSERTAX      
  ELSE 0 END),      
 SSERVICE_TAX = 0,      
 YY          =YEAR(CD_SAUDA_DATE),       
 MM          =MONTH(CD_SAUDA_DATE),       
 DD          =DAY(CD_SAUDA_DATE),       
 DFLAG       = 1 ,       
 BROKER_CHRG = 0,       
 TURN_TAX = 0,       
 SEBI_TAX = 0,       
 OTHER_CHRG = 0 ,       
 INS_CHRG = 0,       
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN       
  CD_TOT_BUYSERTAX       
  ELSE 0 END),      
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN       
  CD_TOT_BUYSERTAX       
  ELSE 0 END),      
 BROKERAGE = CD_TOT_BUYBROK       
  + (CASE WHEN SERVICE_CHRG = 1 THEN       
  CD_TOT_BUYSERTAX       
  ELSE 0 END),      
 C.BRANCH_CD ,       
 C.SUB_BROKER,       
 C.TRADER,       
 PRINTF,         
 C.SERVICE_CHRG,         
 PARTYNAME=LONG_NAME,       
 L_ADDRESS1,       
 L_ADDRESS2,       
 L_ADDRESS3,       
 L_CITY,       
 L_STATE,       
 L_ZIP,       
 PAN_GIR_NO,       
 OFF_PHONE1,       
 OFF_PHONE2,         
 MAPIDID,      
 SEBI_NO    
FROM    CHARGES_DETAIL F,       
        #CLIENTMASTER C       
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE +' 23:59:59'
 AND CD_PARTY_CODE     >= '0'       
 AND CD_PARTY_CODE <= 'ZZ'       
 AND CD_CONTRACT_NO BETWEEN (       
 CASE       
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'       
         AND CD_AUCTIONPART ='EA'       
         THEN 0       
         ELSE '0' END)       
 AND '9999'       
 AND CD_PARTY_CODE=C.PARTY_CODE      
 AND CD_TRADE_NO = ''      
 AND CD_TOT_BUYBROK > 0      
      
INSERT INTO #CONTSETT      
SELECT  CD_ORDER_NO,       
 ORDER_TIME = '',       
 CD_TRADE_NO,       
 TRADETIME='', 
 BILLNO =1, 
 PQTY = 0,       
 SQTY = 0,       
 PRATE = 0,       
 SRATE = 0,       
 PBROK =0,       
 SBROK =0,       
 PNETRATE = 0,       
 SNETRATE = 0,       
 AMOUNT =0,       
 CD_PRODUCT_TYPE,       
 CD_PRODUCT_CODE,    
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),       
 CD_SERIES_ID,    
 PAMT=0,       
 SAMT=0,       
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE     
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,       
 CD_PARTY_CODE,      
 SELL_BUY = 1,       
 CD_CONTRACT_NO,       
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,       
 STRIKE_PRICE = 0 ,    
 PSERVICE_TAX = 0 ,      
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN       
  CD_TOT_SELLSERTAX      
  ELSE 0 END),      
 YY          =YEAR(CD_SAUDA_DATE),       
 MM          =MONTH(CD_SAUDA_DATE),       
 DD       =DAY(CD_SAUDA_DATE),       
 DFLAG       = 1 ,       
 BROKER_CHRG = 0,       
 TURN_TAX =0,       
 SEBI_TAX =0,       
 OTHER_CHRG = 0,       
 INS_CHRG = 0,       
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN       
  CD_TOT_SELLSERTAX       
  ELSE 0 END),      
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN       
  CD_TOT_SELLSERTAX       
  ELSE 0 END),      
 BROKERAGE = CD_TOT_SELLBROK       
  + (CASE WHEN SERVICE_CHRG = 1 THEN       
  CD_TOT_SELLSERTAX       
  ELSE 0 END),      
 C.BRANCH_CD ,       
 C.SUB_BROKER,       
 C.TRADER,       
 PRINTF,         
 C.SERVICE_CHRG,         
 PARTYNAME=LONG_NAME,       
 L_ADDRESS1,       
 L_ADDRESS2,       
 L_ADDRESS3,       
 L_CITY,       
 L_STATE,       
 L_ZIP,       
 PAN_GIR_NO,       
 OFF_PHONE1,       
 OFF_PHONE2,         
 MAPIDID,      
 SEBI_NO    
FROM    CHARGES_DETAIL F,       
        #CLIENTMASTER C       
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'
 AND CD_PARTY_CODE     >= '0'       
 AND CD_PARTY_CODE <= 'ZZ'       
 AND CD_CONTRACT_NO BETWEEN (       
 CASE       
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'       
         AND CD_AUCTIONPART ='EA'       
         THEN 0       
         ELSE '0' END)       
 AND '9999'       
 AND CD_PARTY_CODE=C.PARTY_CODE      
 AND CD_TRADE_NO = ''      
 AND CD_TOT_SELLBROK > 0        
    
    
SELECT  ORDER_NO		='0000000000000000',     
        ORDER_TIME      ='                ',     
        TRADE_NO        ='0000000000000000',     
        TRADETIME       ='0000000000000000',     
		BILLNO,
        PQTY            =SUM(PQTY),     
        SQTY            =SUM(SQTY),     
        PRATE           =(     
        CASE     
                WHEN SUM(PQTY) > 0     
                THEN SUM(PRATE*PQTY)/SUM(PQTY)     
                ELSE 0 END),     
        SRATE=(     
        CASE     
                WHEN SUM(SQTY) > 0     
                THEN SUM(SRATE*SQTY)/SUM(SQTY)     
                ELSE 0 END ),     
        PBROK=(     
        CASE     
                WHEN SUM(PQTY) > 0     
                THEN SUM(PBROK*PQTY)/SUM(PQTY)     
                ELSE 0 END ),     
        SBROK=(     
        CASE     
                WHEN SUM(SQTY) > 0     
                THEN SUM(SBROK*SQTY)/SUM(SQTY)     
                ELSE 0 END ),     
        PNETRATE=(     
        CASE     
                WHEN SUM(PQTY) > 0     
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)     
                ELSE 0 END ),     
        SNETRATE=(     
        CASE     
                WHEN SUM(SQTY) > 0     
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)     
                ELSE 0 END ),     
        AMOUNT=SUM(AMOUNT),     
		PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIES_CODE,    
		SERIES_ID,    
        PAMT=SUM(PAMT),     
        SAMT=SUM(SAMT),     
        EXPIRYDATE,     
        PARTY_CODE,     
        SELL_BUY,     
        CONTRACTNO,     
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
        STRIKE_PRICE,     
        PSERVICE_TAX=SUM(PSERVICE_TAX),     
        SSERVICE_TAX=SUM(SSERVICE_TAX),     
        YY,     
        MM,     
        DD,     
        DFLAG,     
        BROKER_CHRG = SUM(BROKER_CHRG),     
        TURN_TAX    = SUM(TURN_TAX),     
        SEBI_TAX    = SUM(SEBI_TAX),     
        OTHER_CHRG  = SUM(OTHER_CHRG) ,     
        INS_CHRG    = SUM(INS_CHRG),     
        SERVICE_TAX = SUM(SERVICE_TAX),     
        NSERTAX     = SUM(NSERTAX),     
        BROKERAGE   = SUM(BROKERAGE),     
        BRANCH_CD,     
        SUB_BROKER,     
        TRADER,     
        PRINTF,       
        SERVICE_CHRG,       
        PARTYNAME,     
        L_ADDRESS1,     
        L_ADDRESS2,     
        L_ADDRESS3,     
        L_CITY,     
        L_STATE,     
        L_ZIP,     
        PAN_GIR_NO,     
        OFF_PHONE1,     
        OFF_PHONE2,      
        MAPIDID,    
		SEBI_NO    
INTO    #CONTSETTNEW     
FROM    #CONTSETT     
WHERE   PRINTF = '3'     
GROUP BY PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIES_CODE,    
		SERIES_ID,    
        EXPIRYDATE,     
        PARTY_CODE,     
        SELL_BUY,     
        CONTRACTNO,     
        STRIKE_PRICE,     
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),     
        YY,     
        MM,     
        DD,     
        DFLAG,     
        BRANCH_CD,     
        SUB_BROKER,     
        TRADER,     
        PRINTF,       
        SERVICE_CHRG,       
        PARTYNAME,     
        L_ADDRESS1,     
        L_ADDRESS2,     
        L_ADDRESS3,     
        L_CITY,     
        L_STATE,     
        L_ZIP,     
        PAN_GIR_NO,     
        OFF_PHONE1,     
        OFF_PHONE2,       
        MAPIDID,    
		SEBI_NO,BILLNO 
		
INSERT     
INTO    #CONTSETTNEW SELECT  *     
FROM    #CONTSETT     
WITH     
        (     
                NOLOCK     
        )     
WHERE   PRINTF <> '3'     
   
  
UPDATE #CONTSETTNEW     
        SET ORDER_NO = S.ORDER_NO,     
        ORDER_TIME   = S.ORDER_TIME,     
        TRADETIME    = S.TRADETIME,     
        TRADE_NO     = S.TRADE_NO     
FROM    #CONTSETT S     
WITH     
        (     
                NOLOCK     
        )     
WHERE   S.PRINTF           = #CONTSETTNEW.PRINTF     
        AND S.PRINTF       = '3'     
        AND S.PARTY_CODE   = #CONTSETTNEW.PARTY_CODE     
		AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE    
		AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE    
		AND S.SERIES_CODE  = #CONTSETTNEW.SERIES_CODE    
		AND S.SERIES_ID    = #CONTSETTNEW.SERIES_ID    
        AND S.EXPIRYDATE   = #CONTSETTNEW.EXPIRYDATE     
        AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE     
        AND S.SELL_BUY     = #CONTSETTNEW.SELL_BUY     
        AND S.SAUDA_DATE   =     
        (SELECT MIN(SAUDA_DATE)     
        FROM    #CONTSETT ISETT     
        WITH     
                (     
                        NOLOCK     
                )     
        WHERE   PRINTF             = '3'     
                AND S.PARTY_CODE   = ISETT.PARTY_CODE     
				AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE    
				AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE    
				AND S.SERIES_CODE  = ISETT.SERIES_CODE    
				AND S.SERIES_ID    = ISETT.SERIES_ID    
				AND S.EXPIRYDATE   = ISETT.EXPIRYDATE     
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE     
                AND S.SELL_BUY     = ISETT.SELL_BUY     
        )     
    
IF (@CONTFLAG = 'CONTRACT')    
BEGIN     
SELECT  ORDER_NO,    
        ORDER_TIME,    
        TRADE_NO,    
        TM=TRADETIME,      
		QTY = PQTY + SQTY,  
		LOTSIZE = BILLNO,  
		BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,    
        PQTY,    
        SQTY,      
        RATE = PRATE + SRATE,      
        PRATE,    
        SRATE,      
        BROK=PBROK+SBROK,      
        PBROK,    
        SBROK,      
        NETRATE = PNETRATE + SNETRATE,      
        PNETRATE,    
        SNETRATE,      
        AMOUNT,    
		PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIESCODE = SERIES_CODE,
		SERIES_CODE,    
		SERIES_ID,    
		CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),
		NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),
        AMT = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN -PAMT     
                ELSE SAMT END),     
        PAMT,     
        SAMT,     
        AMTSTT = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN -(PAMT+INS_CHRG)     
                ELSE (SAMT-INS_CHRG) END),     
        PAMTSTT = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN PAMT+INS_CHRG     
                ELSE 0 END),     
        SAMTSTT = (     
        CASE     
                WHEN SELL_BUY = 2     
                THEN SAMT-INS_CHRG     
                ELSE 0 END),     
		AMTSERSTT = (
        CASE     
                WHEN SELL_BUY = 1     
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)     
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),
		PAMTSERSTT = (
        CASE     
                WHEN SELL_BUY = 1     
                THEN (PAMT+INS_CHRG+SERVICE_TAX)     
                ELSE 0 END),
		SAMTSERSTT = (
        CASE     
                WHEN SELL_BUY = 2     
                THEN (SAMT-INS_CHRG-SERVICE_TAX)     
                ELSE 0 END),
        EXPIRYDATE,    
        PARTY_CODE,    
        SELL_BUY,    
        CONTRACTNO,    
        SAUDA_DATE,    
        SDT=SAUDA_DATE,    
        STRIKE_PRICE,      
        PSERVICE_TAX,    
        SSERVICE_TAX,    
        YY,    
        MM,    
        DD,    
        DFLAG,    
		BROKER_CHRG,    
        TURN_TAX,    
        SEBI_TAX,    
        OTHER_CHRG,      
        PINS_CHRG=(    
        CASE     
                WHEN SELL_BUY = 1     
                THEN INS_CHRG     
                ELSE 0 END),      
        SINS_CHRG=(    
        CASE     
                WHEN SELL_BUY = 2     
                THEN INS_CHRG     
                ELSE 0 END),      
        INS_CHRG,    
        SERVICE_TAX,    
        NSERTAX,    
        BROKERAGE,    
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),    
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),    
        BRANCH_CD,    
        SUB_BROKER,    
        TRADER,    
        PRINTF,    
        SERVICE_CHRG,       
        PARTYNAME,     
        L_ADDRESS1,     
        L_ADDRESS2,     
        L_ADDRESS3,     
        L_CITY,     
        L_STATE,     
        L_ZIP,     
		SEBI_NO,    
        PAN_GIR_NO,     
        OFF_PHONE1,     
        OFF_PHONE2,       
        MAPIDID,      
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),     
        PMARKETAMT = PRATE * PQTY ,     
        SMARKETAMT = SRATE * SQTY ,     
        SERIES     = '',    
        TMARK      ='',      
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,    
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN     
					  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
					  ELSE '' END),       
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN    
					  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
					  ELSE '' END),       
		SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)
FROM    #CONTSETTNEW     
WITH     
        (     
                NOLOCK     
        )     
WHERE   PRINTF <> 1     
ORDER BY BRANCH_CD,     
        SUB_BROKER,     
        TRADER,     
        PARTY_CODE,     
		CONTRACTNO DESC,
		PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIES_CODE,    
		SERIES_ID,    
        EXPIRYDATE,     
        STRIKE_PRICE,     
        ORDER_NO,     
        TRADE_NO     
END     
ELSE BEGIN     
SELECT  ORDER_NO,    
        ORDER_TIME,    
        TRADE_NO,    
        TM=TRADETIME,     
		QTY = PQTY + SQTY,    
		LOTSIZE = BILLNO,  
		BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,    
        PQTY,    
        SQTY,      
        RATE = PRATE + SRATE,      
        PRATE,    
        SRATE,      
        BROK=PBROK+SBROK,      
        PBROK,    
        SBROK,      
        NETRATE = PNETRATE + SNETRATE,      
        PNETRATE,    
        SNETRATE,      
        AMOUNT,    
		PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIESCODE =  SERIES_CODE,    
		SERIES_CODE,
		SERIES_ID,  
		CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),
		NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),
        AMT = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN -PAMT     
                ELSE SAMT END),     
        PAMT,     
        SAMT,     
        AMTSTT = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN -(PAMT+INS_CHRG)     
                ELSE (SAMT-INS_CHRG) END),     
        PAMTSTT = (     
        CASE     
                WHEN SELL_BUY = 1     
                THEN PAMT+INS_CHRG     
                ELSE 0 END),     
        SAMTSTT = (     
        CASE     
                WHEN SELL_BUY = 2 
                THEN SAMT-INS_CHRG     
                ELSE 0 END),     
		AMTSERSTT = (
        CASE     
                WHEN SELL_BUY = 1     
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)     
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),
		PAMTSERSTT = (
        CASE     
                WHEN SELL_BUY = 1     
                THEN (PAMT+INS_CHRG+SERVICE_TAX)     
                ELSE 0 END),
		SAMTSERSTT = (
        CASE     
                WHEN SELL_BUY = 2     
                THEN (SAMT-INS_CHRG-SERVICE_TAX)     
                ELSE 0 END),
        EXPIRYDATE,    
        PARTY_CODE,    
        SELL_BUY,    
        CONTRACTNO,    
        SAUDA_DATE,    
        SDT=SAUDA_DATE,    
        STRIKE_PRICE,      
        PSERVICE_TAX,    
        SSERVICE_TAX,    
        YY,    
        MM,    
        DD,    
        DFLAG,    
        BROKER_CHRG,    
        TURN_TAX,    
        SEBI_TAX,    
        OTHER_CHRG,      
        PINS_CHRG=(    
        CASE     
                WHEN SELL_BUY = 1     
                THEN INS_CHRG     
                ELSE 0 END),      
        SINS_CHRG=(    
        CASE     
                WHEN SELL_BUY = 2     
                THEN INS_CHRG     
                ELSE 0 END),      
        INS_CHRG,    
        SERVICE_TAX,    
        NSERTAX,    
        BROKERAGE,    
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),    
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),    
        BRANCH_CD,    
        SUB_BROKER,    
        TRADER,    
        PRINTF,    
        SERVICE_CHRG,       
        PARTYNAME,     
        L_ADDRESS1,     
        L_ADDRESS2,     
        L_ADDRESS3,     
        L_CITY,     
        L_STATE,     
        L_ZIP,     
		SEBI_NO,    
        PAN_GIR_NO,     
        OFF_PHONE1,     
        OFF_PHONE2,       
        MAPIDID,      
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),     
        PMARKETAMT = PRATE * PQTY ,     
        SMARKETAMT = SRATE * SQTY ,     
        SERIES     = '',    
        TMARK      ='',      
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,    
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN     
					  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
					  ELSE '' END),       
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN    
					  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)     
					  ELSE '' END),
		SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
FROM    #CONTSETTNEW     
WITH     
        (     
                NOLOCK     
        )     
ORDER BY BRANCH_CD,     
		SUB_BROKER,     
		TRADER,     
		PARTY_CODE,     
		CONTRACTNO DESC,
		PRODUCT_TYPE,    
		PRODUCT_CODE,    
		SERIES_CODE,    
		SERIES_ID,    
		EXPIRYDATE,     
		STRIKE_PRICE,
		ORDER_NO,
		TRADE_NO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INSTCONTSECTION_18122012
-- --------------------------------------------------
CREATE PROC [dbo].[V2_INSTCONTSECTION_18122012]  
 (       
 @STATUSID VARCHAR(15),       
 @STATUSNAME VARCHAR(25),       
 @SAUDA_DATE VARCHAR(11),       
 @FROMPARTY_CODE VARCHAR(15),       
 @TOPARTY_CODE VARCHAR(15),       
 /*@FROMBRANCH VARCHAR(15),  
 @TOBRANCH VARCHAR(15),  
 @FROMSUB_BROKER VARCHAR(15),       
 @TOSUB_BROKER VARCHAR(15),*/       
 @BRANCH VARCHAR(10),       
 @SUB_BROKER VARCHAR(10),       
 @FROMCONTRACTNO VARCHAR(12),       
 @TOCONTRACTNO VARCHAR(12),       
 @CONTFLAG VARCHAR(10),  
 @TOSAUDA_DATE VARCHAR(11) = '',  
 @BOUNCEDFLAG INT = 0       
 )       
       
 AS       
  
---EXEC [V2_INSTCONTSECTION] 'BROKER','BROKER','SEP 29 2007' ,'','ZZZZZ','%','%','0','9999999999','CONTRACT','SEP 29 2011',0  
  
 Declare @STax Numeric(18,4)  
  
 Select @STax = Service_Tax From BFOGlobals  
 Where @SAUDA_DATE BETWEEN BFOGLOBALS.YEAR_START_DT AND BFOGLOBALS.YEAR_END_DT       
  
 DECLARE @TOSUB_BROKER VARCHAR(15)  
 DECLARE @TOBRANCH VARCHAR(15)  
   
 If @SUB_BROKER = 'ALL' OR @SUB_BROKER = '' OR @SUB_BROKER = '%'  
 Begin       
  Set @TOSUB_BROKER = 'zzzzzzzz'       
 End       
 If @BRANCH = 'ALL' OR @BRANCH = '' OR @BRANCH = '%'      
 Begin       
        Set @TOBRANCH = 'zzzzzzzz'       
 End       
  
 If @FROMCONTRACTNO = ''      
 Begin      
  set @FROMCONTRACTNO = 000000      
 End      
       
 If @TOCONTRACTNO = ''      
 Begin      
  Set @TOCONTRACTNO = 99999999      
 End  
  
IF @TOSAUDA_DATE = ''  
BEGIN  
 SET @TOSAUDA_DATE = @SAUDA_DATE  
END  
      
CREATE TABLE #BPARTY  
(   
PARTY_CODE VARCHAR(15)   
)  
  
IF @BOUNCEDFLAG <> 0  
BEGIN  
 INSERT INTO #BPARTY  
 SELECT   
  DISTINCT PARTY_CODE   
 FROM   
  TBL_ECNBOUNCED(NOLOCK)   
 WHERE   
  SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
END  
ELSE  
BEGIN  
 INSERT INTO #BPARTY  
 SELECT   
  DISTINCT PARTY_CODE   
 FROM   
  CLIENT2 (NOLOCK)   
 WHERE   
  PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE  
END  
  
SELECT  C2.PARTY_CODE,       
        C1.LONG_NAME,       
        C1.L_ADDRESS1,       
        C1.L_ADDRESS2,       
        C1.L_ADDRESS3,       
        C1.L_CITY,       
        C1.L_STATE,       
        C1.L_ZIP,       
        C1.BRANCH_CD ,       
        C1.SUB_BROKER,       
        C1.TRADER,       
        C1.PAN_GIR_NO,       
        C1.OFF_PHONE1,       
        C1.OFF_PHONE2,       
        PRINTF,       
        MAPIDID,       
        C2.SERVICE_CHRG,       
        BROKERNOTE,       
        TURNOVER_TAX,       
        SEBI_TURN_TAX,       
        C2.OTHER_CHRG,       
        INSURANCE_CHRG,      
  SEBI_NO = FD_Code,  
  CL_TYPE,  
        CUSTODIANCODE   = ISNULL(C.CUSTODIANCODE,''),       
        PARTICIPANTCODE = ISNULL(C2.BANKID,''),  
  PARENTCODE,  
  UCC_CODE   
INTO    #CLIENTMASTER       
FROM    CLIENT1 C1       
WITH       
        (       
                NOLOCK       
        ),  
        CLIENT2 C2       
WITH       
        (       
                NOLOCK       
        )       
LEFT OUTER JOIN CUSTODIAN C       
WITH      
        (      
                NOLOCK      
        )       
        ON (C2.CLTDPNO = C.CUSTODIANCODE)  
LEFT OUTER JOIN UCC_CLIENT UC       
WITH       
        (       
                NOLOCK       
        )       
        ON C2.PARTY_CODE = UC.PARTY_CODE,  
  CLIENT_PRINT_SETTINGS  CP (NOLOCK)  
WHERE   C2.CL_CODE       = C1.CL_CODE       
        AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE  
        AND Cl_Type = 'INS'       
        AND @STATUSNAME = (       
        CASE       
                WHEN @STATUSID = 'BRANCH'       
                THEN C1.BRANCH_CD       
                WHEN @STATUSID = 'SUBBROKER'       
                THEN C1.SUB_BROKER       
                WHEN @STATUSID = 'TRADER'       
                THEN C1.TRADER       
                WHEN @STATUSID = 'FAMILY'       
                THEN C1.FAMILY       
                WHEN @STATUSID = 'AREA'       
                THEN C1.AREA       
                WHEN @STATUSID = 'REGION'       
                THEN C1.REGION       
                WHEN @STATUSID = 'CLIENT'       
                THEN C2.PARTY_CODE       
                ELSE 'BROKER' END)       
        AND BRANCH_CD BETWEEN @BRANCH AND @TOBRANCH  
        AND SUB_BROKER BETWEEN @SUB_BROKER AND @TOSUB_BROKER       
        AND PRINTF =  CP.PRINT_FLAG  
  --AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'  
  AND C2.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY (NOLOCK))  
    
    
  
SELECT  CONTRACTNO,       
        BILLNO=LOT_SIZE,       
        TRADE_NO,       
        PARTY_CODE,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  MARKETRATE=TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        USER_ID=TERMINALID,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        MARKETTYPE=OPTION_TYPE,       
        ORDER_NO,       
        SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
  VAL_PERC,       
        NORMAL,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,   
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        AMOUNT=TRADE_AMOUNT,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_DATE=ORDER_TIMESTAMP,       
        DUMMY1,       
        DUMMY2,       
        RESERVED1       
INTO    #FOSETT       
FROM    BFOSETTLEMENT       
WHERE   1 = 2       
  
INSERT       
INTO    #FOSETT       
SELECT  CONTRACTNO,       
        BILLNO=LOT_SIZE,       
        TRADE_NO,       
        PARTY_CODE,       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  MARKETRATE=TRADE_PRICE,       
        EXPIRYDATE,       
        STRIKE_PRICE,       
        USER_ID=TERMINALID,       
        PRO_CLI,       
        TRADEQTY,       
        AUCTIONPART,       
        MARKETTYPE=OPTION_TYPE,       
        ORDER_NO,       
  SAUDA_DATE,       
        TABLE_NO,       
        LINE_NO,       
        VAL_PERC,       
        NORMAL,       
        DAY_PUC,       
        DAY_SALES,       
        SETT_PURCH,       
        SETT_SALES,       
        SELL_BUY,       
        SETTFLAG,       
        BROKAPPLIED,       
        NETRATE,       
        AMOUNT=TRADE_AMOUNT,       
        INS_CHRG,       
        TURN_TAX,       
        OTHER_CHRG,       
        SEBI_TAX,       
        BROKER_CHRG,       
        SERVICE_TAX,       
        TRADE_AMOUNT,       
        PARTICIPANTCODE,       
        STATUS,       
        ORDER_DATE=ORDER_TIMESTAMP,       
        DUMMY1,       
        DUMMY2,       
        RESERVED1  
FROM    BFOSETTLEMENT       
WHERE   SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
        AND PARTY_CODE >= @FROMPARTY_CODE       
        AND PARTY_CODE <= @TOPARTY_CODE       
        AND AUCTIONPART NOT IN ('CA')       
        AND TRADEQTY <> 0       
        AND TRADE_PRICE > 0       
        AND ( RESERVED1 = 1      
  Or Party_Code In (Select Party_Code From #ClientMaster Where Cl_Type = 'INS') )      
  
  
  
Create  INDEX [DELPOS]       
        ON [dbo].[#FOSETT]       
        (       
                [PARTY_CODE]       
        )       
      
SELECT  ORDER_NO,       
        ORDER_TIME = RIGHT(ORDER_DATE,8),       
        TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,       
  BILLNO,  
        PQTY = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN TRADEQTY       
                ELSE 0 END),       
        SQTY = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN TRADEQTY       
                ELSE 0 END),       
        PRATE = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL(MARKETRATE,0)       
                ELSE 0 END),       
        SRATE = (       
        CASE       
              WHEN SELL_BUY = 2       
                THEN ISNULL(MARKETRATE,0)       
                ELSE 0 END),       
        PBROK =(       
    CASE       
                WHEN SELL_BUY = 1       
                THEN ISNULL((BROKAPPLIED + (       
                CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
    ELSE 0 END),       
        SBROK =(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN ISNULL((BROKAPPLIED + (       
                CASE       
                        WHEN C.SERVICE_CHRG=1       
                        THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)       
                        ELSE 0 END )),0)       
                ELSE 0 END),       
        PNETRATE = (       
        CASE       
                WHEN SELL_BUY =1       
                THEN ISNULL(NETRATE + (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
                ELSE 0 END),       
        SNETRATE = (       
        CASE       
                WHEN SELL_BUY =2       
                THEN ISNULL(NETRATE - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)       
                        ELSE 0 END),0)       
                ELSE 0 END),       
        ISNULL(AMOUNT,0) AMOUNT ,       
        PRODUCT_TYPE= (       
        CASE       
                WHEN F.AUCTIONPART = 'EA'       
                THEN STUFF(PRODUCT_TYPE,1,3,'EA-')       
                ELSE PRODUCT_TYPE END),       
  PRODUCT_CODE = (       
        CASE       
                WHEN F.AUCTIONPART = 'EA'       
                THEN STUFF(PRODUCT_CODE,1,3,'EA-')       
                ELSE PRODUCT_CODE END),      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=(       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (TRADEQTY * NETRATE) + (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END) END ) END )       
                ELSE 0 END),       
        SAMT=(       
        CASE       
                WHEN SELL_BUY = 2       
                THEN(TRADEQTY * NETRATE) - (       
                CASE       
                        WHEN C.SERVICE_CHRG = 1       
                        THEN ISNULL((F.SERVICE_TAX),0)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG = 0       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG = 2       
                                        THEN 0       
                                        ELSE 0 END ) END ) END)       
                ELSE 0 END),       
        LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,       
        F.PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,       
        ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,       
        PSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                              WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        SSERVICE_TAX= (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN (       
                CASE       
                        WHEN C.SERVICE_CHRG=0       
                        THEN (F.SERVICE_TAX)       
                        ELSE (       
                        CASE       
                                WHEN C.SERVICE_CHRG=1       
                                THEN 0       
                                ELSE (       
                                CASE       
                                        WHEN C.SERVICE_CHRG=2       
                                        THEN 0 END) END) END)       
                ELSE 0 END),       
        YY          =YEAR(SAUDA_DATE),       
        MM          =MONTH(SAUDA_DATE),       
        DD          =DAY(SAUDA_DATE),       
        DFLAG       = 1 ,       
        BROKER_CHRG = (       
        CASE       
                WHEN BROKERNOTE = 1       
                THEN BROKER_CHRG       
                ELSE 0 END ),       
        TURN_TAX = (       
        CASE       
                WHEN TURNOVER_TAX = 1       
                THEN TURN_TAX       
                ELSE 0 END),       
        SEBI_TAX = (       
        CASE       
                WHEN SEBI_TURN_TAX = 1       
                THEN SEBI_TAX       
                ELSE 0 END),       
        OTHER_CHRG = (       
        CASE       
                WHEN C.OTHER_CHRG = 1       
                THEN F.OTHER_CHRG       
                ELSE 0 END) ,       
        INS_CHRG = (       
        CASE       
                WHEN INSURANCE_CHRG = 1       
                THEN INS_CHRG       
                ELSE 0 END ),       
        SERVICE_TAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX       
                ELSE 0 END ),       
        NSERTAX = (       
        CASE       
                WHEN SERVICE_CHRG = 0       
                THEN SERVICE_TAX      
                ELSE 0 END ),       
        BROKERAGE = ISNULL(TRADEQTY*BROKAPPLIED,0) + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),  
        C.BRANCH_CD ,       
        C.SUB_BROKER,       
        C.TRADER,       
        PRINTF,         
        C.SERVICE_CHRG,         
        PARTYNAME=LONG_NAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,             
  OFF_PHONE2,         
        MAPIDID,      
  SEBI_NO      
INTO    #CONTSETT       
FROM    #FOSETT F,       
        #CLIENTMASTER C       
WHERE   F.PARTY_CODE     >= @FROMPARTY_CODE       
        AND F.PARTY_CODE <= @TOPARTY_CODE       
  AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO      
        AND F.PARTY_CODE=C.PARTY_CODE       
  
UPDATE         
 #CONTSETT        
SET        
 BROKERAGE = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END        
      + (CASE WHEN SERVICE_CHRG = 1 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
        ELSE 0 END),        
 SERVICE_TAX = SERVICE_TAX+(CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 NSERTAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN SERVICE_TAX+CD_TOT_BUYSERTAX ELSE 0 END        
   ELSE 0 END),        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
   CASE WHEN SELL_BUY =1 THEN 0 ELSE SERVICE_TAX+CD_TOT_SELLSERTAX END        
   ELSE 0 END),        
        PAMT=(CASE WHEN SELL_BUY = 1 THEN (PQTY * PRATE)+ CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_BUYSERTAX),0) ELSE 0 END)        
              ELSE 0 END),         
        SAMT=(CASE WHEN SELL_BUY = 2 THEN (SQTY * SRATE) - CD_TOT_SELLBROK         
  - (CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX+ISNULL((CD_TOT_SELLSERTAX),0) ELSE 0 END)        
              ELSE 0 END)        
FROM        
 CHARGES_DETAIL        
WHERE        
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)        
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE         
 AND CD_PRODUCT_TYPE = PRODUCT_TYPE      
 AND CD_PRODUCT_CODE = PRODUCT_CODE      
 AND CD_SERIES_ID = SERIES_ID      
 AND CD_SERIES_CODE = SERIES_CODE      
 AND CONVERT(VARCHAR,CD_EXPIRYDATE,106) = EXPIRYDATE        
 AND PRADNYA.DBO.REPLACETRADENO(CD_TRADE_NO) = TRADE_NO        
 AND CD_ORDER_NO = ORDER_NO        
        
  
  
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',         
 BILLNO=1,  
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,        
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
 LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX        
  ELSE 0 END),        
 SSERVICE_TAX = 0,        
 YY          =YEAR(CD_SAUDA_DATE),         
 MM          =MONTH(CD_SAUDA_DATE),         
 DD          =DAY(CD_SAUDA_DATE),         
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX = 0,         
 SEBI_TAX = 0,         
 OTHER_CHRG = 0 ,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_BUYBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_BUYSERTAX         
  ELSE 0 END),        
 C.BRANCH_CD ,         
 C.SUB_BROKER,         
 C.TRADER,         
 PRINTF,           
 C.SERVICE_CHRG,           
 PARTYNAME=LONG_NAME,         
 L_ADDRESS1,         
 L_ADDRESS2,         
 L_ADDRESS3,         
 L_CITY,         
 L_STATE,         
 L_ZIP,         
 PAN_GIR_NO,         
 OFF_PHONE1,         
 OFF_PHONE2,           
 MAPIDID,        
 SEBI_NO      
FROM    CHARGES_DETAIL F,         
        #CLIENTMASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE +' 23:59:59'  
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_BUYBROK > 0        
        
INSERT INTO #CONTSETT        
SELECT  CD_ORDER_NO,         
 ORDER_TIME = '',         
 CD_TRADE_NO,         
 TRADETIME='',   
 BILLNO =1,   
 PQTY = 0,         
 SQTY = 0,         
 PRATE = 0,         
 SRATE = 0,         
 PBROK =0,         
 SBROK =0,         
 PNETRATE = 0,         
 SNETRATE = 0,         
 AMOUNT =0,         
 CD_PRODUCT_TYPE,         
 CD_PRODUCT_CODE,      
 CD_SERIES_CODE =(CASE WHEN CD_SERIES_CODE = '' THEN 'CONT BROK' ELSE CD_SERIES_CODE END),         
 CD_SERIES_ID,      
 PAMT=0,         
 SAMT=0,         
 (CASE WHEN CD_SERIES_CODE = '' THEN '' ELSE       
  LEFT(CONVERT(VARCHAR,CD_EXPIRYDATE,106),11) END) AS EXPIRYDATE,         
 CD_PARTY_CODE,        
 SELL_BUY = 1,         
 CD_CONTRACT_NO,         
 CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,         
 STRIKE_PRICE = 0 ,      
 PSERVICE_TAX = 0 ,        
 SSERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX        
  ELSE 0 END),        
 YY          =YEAR(CD_SAUDA_DATE),         
 MM          =MONTH(CD_SAUDA_DATE),         
 DD       =DAY(CD_SAUDA_DATE),         
 DFLAG       = 1 ,         
 BROKER_CHRG = 0,         
 TURN_TAX =0,         
 SEBI_TAX =0,         
 OTHER_CHRG = 0,         
 INS_CHRG = 0,         
 SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 NSERTAX= (CASE WHEN SERVICE_CHRG = 0 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 BROKERAGE = CD_TOT_SELLBROK         
  + (CASE WHEN SERVICE_CHRG = 1 THEN         
  CD_TOT_SELLSERTAX         
  ELSE 0 END),        
 C.BRANCH_CD ,         
 C.SUB_BROKER,         
 C.TRADER,         
 PRINTF,           
 C.SERVICE_CHRG,           
 PARTYNAME=LONG_NAME,         
 L_ADDRESS1,         
 L_ADDRESS2,         
 L_ADDRESS3,         
 L_CITY,         
 L_STATE,         
 L_ZIP,         
 PAN_GIR_NO,         
 OFF_PHONE1,         
 OFF_PHONE2,           
 MAPIDID,        
 SEBI_NO      
FROM    CHARGES_DETAIL F,         
        #CLIENTMASTER C         
WHERE   CD_SAUDA_DATE BETWEEN @SAUDA_DATE AND @TOSAUDA_DATE + ' 23:59:59'  
 AND CD_PARTY_CODE     >= '0'         
 AND CD_PARTY_CODE <= 'ZZ'         
 AND CD_CONTRACT_NO BETWEEN (         
 CASE         
         WHEN RIGHT(CD_PRODUCT_CODE,3) =  'OPT'         
         AND CD_AUCTIONPART ='EA'         
         THEN 0         
         ELSE '0' END)         
 AND '9999'         
 AND CD_PARTY_CODE=C.PARTY_CODE        
 AND CD_TRADE_NO = ''        
 AND CD_TOT_SELLBROK > 0          
      
      
SELECT  ORDER_NO  ='0000000000000000',       
        ORDER_TIME      ='                ',       
        TRADE_NO        ='0000000000000000',       
        TRADETIME       ='0000000000000000',       
  BILLNO,  
        PQTY            =SUM(PQTY),       
        SQTY            =SUM(SQTY),       
        PRATE           =(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END),       
        SRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PBROK=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PBROK*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SBROK=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SBROK*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        PNETRATE=(       
        CASE       
                WHEN SUM(PQTY) > 0       
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)       
                ELSE 0 END ),       
        SNETRATE=(       
        CASE       
                WHEN SUM(SQTY) > 0       
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)       
                ELSE 0 END ),       
        AMOUNT=SUM(AMOUNT),       
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        PAMT=SUM(PAMT),       
        SAMT=SUM(SAMT),       
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),   
        STRIKE_PRICE,       
        PSERVICE_TAX=SUM(PSERVICE_TAX),       
        SSERVICE_TAX=SUM(SSERVICE_TAX),       
        YY,       
        MM,       
        DD,       
        DFLAG,       
        BROKER_CHRG = SUM(BROKER_CHRG),       
        TURN_TAX    = SUM(TURN_TAX),       
        SEBI_TAX    = SUM(SEBI_TAX),       
        OTHER_CHRG  = SUM(OTHER_CHRG) ,       
        INS_CHRG    = SUM(INS_CHRG),       
        SERVICE_TAX = SUM(SERVICE_TAX),       
        NSERTAX     = SUM(NSERTAX),       
        BROKERAGE   = SUM(BROKERAGE),       
        BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PRINTF,         
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,        
        MAPIDID,      
  SEBI_NO      
INTO    #CONTSETTNEW       
FROM    #CONTSETT       
WHERE   PRINTF = '3'       
GROUP BY PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        PARTY_CODE,       
        SELL_BUY,       
        CONTRACTNO,       
        STRIKE_PRICE,       
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),       
        YY,       
        MM,       
        DD,       
        DFLAG,       
        BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PRINTF,         
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,      
  SEBI_NO,BILLNO   
    
INSERT       
INTO    #CONTSETTNEW SELECT  *       
FROM    #CONTSETT       
WITH       
        (       
                NOLOCK       
        )       
WHERE   PRINTF <> '3'       
     
    
UPDATE #CONTSETTNEW       
        SET ORDER_NO = S.ORDER_NO,       
        ORDER_TIME   = S.ORDER_TIME,       
        TRADETIME    = S.TRADETIME,       
        TRADE_NO     = S.TRADE_NO       
FROM    #CONTSETT S       
WITH       
        (       
                NOLOCK       
        )       
WHERE   S.PRINTF           = #CONTSETTNEW.PRINTF       
        AND S.PRINTF       = '3'       
        AND S.PARTY_CODE   = #CONTSETTNEW.PARTY_CODE       
  AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE      
  AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE      
  AND S.SERIES_CODE  = #CONTSETTNEW.SERIES_CODE      
  AND S.SERIES_ID    = #CONTSETTNEW.SERIES_ID      
        AND S.EXPIRYDATE   = #CONTSETTNEW.EXPIRYDATE       
        AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE       
        AND S.SELL_BUY     = #CONTSETTNEW.SELL_BUY       
        AND S.SAUDA_DATE   =       
        (SELECT MIN(SAUDA_DATE)       
        FROM    #CONTSETT ISETT       
        WITH       
                (       
                        NOLOCK       
                )       
        WHERE   PRINTF             = '3'       
                AND S.PARTY_CODE   = ISETT.PARTY_CODE       
    AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE      
    AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE      
    AND S.SERIES_CODE  = ISETT.SERIES_CODE      
    AND S.SERIES_ID    = ISETT.SERIES_ID      
    AND S.EXPIRYDATE   = ISETT.EXPIRYDATE       
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE       
                AND S.SELL_BUY     = ISETT.SELL_BUY       
        )       
      
IF (@CONTFLAG = 'CONTRACT')      
BEGIN       
SELECT  ORDER_NO,      
        ORDER_TIME,      
        TRADE_NO,      
        TM=TRADETIME,        
  QTY = PQTY + SQTY,    
  LOTSIZE = BILLNO,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,      
        PQTY,      
        SQTY,        
        RATE = PRATE + SRATE,        
        PRATE,      
        SRATE,        
        BROK=PBROK+SBROK,        
        PBROK,      
        SBROK,        
        NETRATE = PNETRATE + SNETRATE,        
        PNETRATE,      
        SNETRATE,        
        AMOUNT,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIESCODE = SERIES_CODE,  
  SERIES_CODE,      
  SERIES_ID,      
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),  
        AMT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -PAMT       
                ELSE SAMT END),       
        PAMT,       
        SAMT,       
        AMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG)       
                ELSE (SAMT-INS_CHRG) END),       
        PAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN PAMT+INS_CHRG       
                ELSE 0 END),       
        SAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 2       
                THEN SAMT-INS_CHRG       
                ELSE 0 END),       
  AMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),  
  PAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN (PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE 0 END),  
  SAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 2       
                THEN (SAMT-INS_CHRG-SERVICE_TAX)       
                ELSE 0 END),  
        EXPIRYDATE,      
        PARTY_CODE,      
        SELL_BUY,      
        CONTRACTNO,      
        SAUDA_DATE,      
        SDT=SAUDA_DATE,      
        STRIKE_PRICE,        
        PSERVICE_TAX,      
        SSERVICE_TAX,      
        YY,      
        MM,      
        DD,      
        DFLAG,      
  BROKER_CHRG,      
        TURN_TAX,      
        SEBI_TAX,      
        OTHER_CHRG,        
        PINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 1       
                THEN INS_CHRG       
                ELSE 0 END),        
        SINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 2       
                THEN INS_CHRG       
                ELSE 0 END),        
        INS_CHRG,      
        SERVICE_TAX,      
        NSERTAX,      
        BROKERAGE,      
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),      
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),      
        BRANCH_CD,      
        SUB_BROKER,      
        TRADER,      
        PRINTF,      
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
  SEBI_NO,      
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,        
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),       
        PMARKETAMT = PRATE * PQTY ,       
        SMARKETAMT = SRATE * SQTY ,       
        SERIES     = '',      
        TMARK      ='',        
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,      
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN       
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN      
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)  
FROM    #CONTSETTNEW       
WITH       
        (       
                NOLOCK       
        )       
WHERE   PRINTF <> 1       
ORDER BY BRANCH_CD,       
        SUB_BROKER,       
        TRADER,       
        PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
        EXPIRYDATE,       
        STRIKE_PRICE,       
        ORDER_NO,       
        TRADE_NO       
END       
ELSE BEGIN       
SELECT  ORDER_NO,      
        ORDER_TIME,      
        TRADE_NO,      
        TM=TRADETIME,       
  QTY = PQTY + SQTY,      
  LOTSIZE = BILLNO,    
  BUYSELL = CASE WHEN PQTY >0 THEN 'BUY' ELSE 'SELL' END ,      
        PQTY,      
        SQTY,        
        RATE = PRATE + SRATE,        
        PRATE,      
        SRATE,        
        BROK=PBROK+SBROK,        
        PBROK,      
        SBROK,        
        NETRATE = PNETRATE + SNETRATE,        
        PNETRATE,      
        SNETRATE,        
        AMOUNT,      
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIESCODE =  SERIES_CODE,      
  SERIES_CODE,  
  SERIES_ID,    
  CONTRACTDESC =   PRODUCT_TYPE + ' '+ PRODUCT_CODE +' ' + SERIES_CODE + ' '+ CONVERT(VARCHAR,SERIES_ID),  
  NOOFCONTRACT = (PQTY + SQTY) / (CASE WHEN BILLNO=0 THEN 1 ELSE BILLNO END),  
        AMT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -PAMT       
                ELSE SAMT END),       
        PAMT,       
        SAMT,       
        AMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG)       
                ELSE (SAMT-INS_CHRG) END),       
        PAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 1       
                THEN PAMT+INS_CHRG       
                ELSE 0 END),       
        SAMTSTT = (       
        CASE       
                WHEN SELL_BUY = 2   
                THEN SAMT-INS_CHRG       
                ELSE 0 END),       
  AMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN -(PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE (SAMT-INS_CHRG-SERVICE_TAX) END),  
  PAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 1       
                THEN (PAMT+INS_CHRG+SERVICE_TAX)       
                ELSE 0 END),  
  SAMTSERSTT = (  
        CASE       
                WHEN SELL_BUY = 2       
                THEN (SAMT-INS_CHRG-SERVICE_TAX)       
                ELSE 0 END),  
        EXPIRYDATE,      
        PARTY_CODE,      
        SELL_BUY,      
        CONTRACTNO,      
        SAUDA_DATE,      
        SDT=SAUDA_DATE,      
        STRIKE_PRICE,        
        PSERVICE_TAX,      
        SSERVICE_TAX,      
        YY,      
        MM,      
        DD,      
        DFLAG,      
        BROKER_CHRG,      
        TURN_TAX,      
        SEBI_TAX,      
        OTHER_CHRG,        
        PINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 1       
                THEN INS_CHRG       
                ELSE 0 END),        
        SINS_CHRG=(      
        CASE       
                WHEN SELL_BUY = 2       
                THEN INS_CHRG       
                ELSE 0 END),        
        INS_CHRG,      
        SERVICE_TAX,      
        NSERTAX,      
        BROKERAGE,      
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),      
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),      
        BRANCH_CD,      
        SUB_BROKER,      
        TRADER,      
        PRINTF,      
        SERVICE_CHRG,         
        PARTYNAME,       
        L_ADDRESS1,       
        L_ADDRESS2,       
        L_ADDRESS3,       
        L_CITY,       
        L_STATE,       
        L_ZIP,       
  SEBI_NO,      
        PAN_GIR_NO,       
        OFF_PHONE1,       
        OFF_PHONE2,         
        MAPIDID,        
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),       
        PMARKETAMT = PRATE * PQTY ,       
        SMARKETAMT = SRATE * SQTY ,       
        SERIES     = '',      
        TMARK      ='',        
        SCRIPNAME  =  RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108) ,      
        PSCRIPNAME = (CASE WHEN SELL_BUY=1 THEN       
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),         
        SSCRIPNAME = (CASE WHEN SELL_BUY=2 THEN      
       RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)       
       ELSE '' END),  
  SCRIPNAMESHORT = RTRIM(PRODUCT_CODE) + ' ' + RTRIM(SERIES_CODE) + ' ' + CONVERT(VARCHAR,SERIES_ID,108)         
FROM    #CONTSETTNEW       
WITH       
        (       
                NOLOCK       
        )       
ORDER BY BRANCH_CD,       
  SUB_BROKER,       
  TRADER,       
  PARTY_CODE,       
  CONTRACTNO DESC,  
  PRODUCT_TYPE,      
  PRODUCT_CODE,      
  SERIES_CODE,      
  SERIES_ID,      
  EXPIRYDATE,       
  STRIKE_PRICE,  
  ORDER_NO,  
  TRADE_NO  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_NSEFOINSTREPORT
-- --------------------------------------------------
-- EXEC V2_NSEFOINSTREPORT 'NOV 13 2006','NOV 13 2006','0','ZZZZZ',1,0,'103','','BROKER','BROKER',76


CREATE     PROC [DBO].[V2_NSEFOINSTREPORT](
           @FROMDATE    VARCHAR(11),
           @TODATE      VARCHAR(11),
           @FROMPARTY   VARCHAR(15),
           @TOPARTY     VARCHAR(15),
           @REPORT_TYPE INT,
           @SUMMARIES   INT,
           @DATEFORMAT  VARCHAR(30),
           @SETTDATE    VARCHAR(11),
           @STATUSID    VARCHAR(15),
           @STATUSNAME  VARCHAR(25),
           @RPTREPORTNO INT)

  AS

  DECLARE  @STRING VARCHAR(25)  
  DECLARE  @TSTRING VARCHAR(25)  
  DECLARE  @ESTRING VARCHAR(25)  
  DECLARE  @TDATELEN INT  
  DECLARE  @TDATEFORMAT INT  
  DECLARE  @TDATEFREPLACE VARCHAR(1)  
  DECLARE  @TDATEREPLACE VARCHAR(1)  
  DECLARE  @EDATELEN INT  
  DECLARE  @EDATEFORMAT INT  
  DECLARE  @EDATEFREPLACE VARCHAR(1)  
  DECLARE  @EDATEREPLACE VARCHAR(1)
  
  DECLARE  @TBLTRADECONFIRMATION  TABLE(
                                        --PARENTCODE               VARCHAR(10)   DEFAULT (''),
                                        PARTY_CODE               VARCHAR(10)   DEFAULT (''),
                                        TRADEDATE                VARCHAR(20)   DEFAULT (''),
                                        TRADEDTIME               VARCHAR(20)   DEFAULT (''),
                                        TRADEDTIME_1             VARCHAR(20)   DEFAULT (''),
                                        SETTDATE                 VARCHAR(20)   DEFAULT (''),
                                        TRADEDATETIME            VARCHAR(20)   DEFAULT (''),
                                        ORDER_NO                 VARCHAR(20)   DEFAULT (''),
                                        ORDER_NO_NEW             VARCHAR(20)   DEFAULT (''),
                                        TRADE_NO                 VARCHAR(15)   DEFAULT (''),
                                        INST_TYPE                VARCHAR(6)    DEFAULT (''),
                                        INST_TYPE_1              VARCHAR(6)    DEFAULT (''),
                                        SYMBOL                   VARCHAR(12)   DEFAULT (''),
                                        EXPIRYDATE               VARCHAR(20)   DEFAULT (''),
                                        EXPIRYDATETIME           VARCHAR(20)   DEFAULT (''),
                                        STRIKE_PRICE             MONEY         DEFAULT (0),
                                        OPTION_TYPE              VARCHAR(2)    DEFAULT (''),
										OPTION_TYPE_NEW          VARCHAR(2)    DEFAULT (''),
                                        SEC_NAME                 VARCHAR(25)   DEFAULT (''),
										SCRIPNAME				 VARCHAR(60)   DEFAULT (''),
                                        SELL_BUY                 VARCHAR(5)    DEFAULT (''),
                                        SELL_BUYBS               CHAR(1)       DEFAULT (''),
                                        SELL_BUY_O               INT   	       DEFAULT (0),
                                        BOUGHT_SOLD              VARCHAR(6)    DEFAULT (''),
                                        QTY                      VARCHAR(25)   DEFAULT (''),
                                        QTYPLUS                  VARCHAR(25)   DEFAULT (''),
                                        BQTY                     VARCHAR(25)   DEFAULT (''),
                                        SQTY                     VARCHAR(25)   DEFAULT (''),
                                        CONTRACTS                VARCHAR(25)   DEFAULT (''),
                                        CONTRACTSBS              VARCHAR(25)   DEFAULT (''),
                                        CONTRACTLOT              INT   	       DEFAULT (0),
                                        PRICE                    VARCHAR(25)   DEFAULT (''),
                                        PRICE2D                  VARCHAR(25)   DEFAULT (''),
                                        PRICE4D                  VARCHAR(25)   DEFAULT (''),
                                        AMOUNT                   VARCHAR(25)   DEFAULT (''),
                                        BAMOUNT                  VARCHAR(25)   DEFAULT (''),
                                        SAMOUNT                  VARCHAR(25)   DEFAULT (''),
                                        PARTYNAME                VARCHAR(250)  DEFAULT (''),
                                        PARTICIPANTCODE          VARCHAR(25)   DEFAULT (''),
                                        BROKERCODE               VARCHAR(15)   DEFAULT (''),
                                        COMPANYNAME              VARCHAR(250)  DEFAULT (''),
                                        COMPANYADD1              VARCHAR(150)  DEFAULT (''),
                                        COMPANYADD2              VARCHAR(150)  DEFAULT (''),
                                        COMPANYCITY              VARCHAR(150)  DEFAULT (''),
                                        COMPANYZIP               VARCHAR(15)   DEFAULT (''),
                                        COMPANYPHONE             VARCHAR(15)   DEFAULT (''),
                                        COMPANYPSEBINO           VARCHAR(25)   DEFAULT (''),
                                        ISIN                     VARCHAR(25)   DEFAULT (''),
                                        RICCODE                  VARCHAR(25)   DEFAULT (''),
                                        --RICCODECITY              VARCHAR(25)   DEFAULT (''),
                                        CUSIP                    VARCHAR(25)   DEFAULT (''),
                                        REUTERCODE               VARCHAR(25)   DEFAULT (''),
                                        BLOOMBURGCODE            VARCHAR(45)   DEFAULT (''),
                                        BLOOMBERG_TICKER         VARCHAR(45)   DEFAULT (''),
                                        ACTIVITYTIME             VARCHAR(25)   DEFAULT (''),
                                        LASTMODIFIEDTIME         VARCHAR(25)   DEFAULT (''),
                                        COMMISION                VARCHAR(25)   DEFAULT (''),
                                        CLEARINGCOMM             VARCHAR(25)   DEFAULT (''),
                                        TOTALCOMMISION           VARCHAR(25)   DEFAULT (''),
                                        STT                      VARCHAR(25)   DEFAULT (''),
                                        STTPER                   VARCHAR(25)   DEFAULT (''),
                                        REUTERSCODE              VARCHAR(25)   DEFAULT (''),
                                        SCHEME                   VARCHAR(25)   DEFAULT (''),
                                        EXPIRYDATE_DATEFORMAT    DATETIME,
                                        STRIKE_PRICE_MONEYFORMAT MONEY        DEFAULT (0),
                                        STATUS                   VARCHAR(3)   DEFAULT (''),
                                        BOOKTYPE                 VARCHAR(2)   DEFAULT (''),
                                        BOOKTYPENAME             VARCHAR(3)   DEFAULT (''),
                                        MARKETTYPE               VARCHAR(2)   DEFAULT (''),
                                        USER_ID                  VARCHAR(15)  DEFAULT (''),
                                        BRANCH_ID                VARCHAR(15)  DEFAULT (''),
                                        PRO_CLI                  VARCHAR(4)   DEFAULT (''),
                                        O_C_FLAG                 VARCHAR(5)   DEFAULT (''),
                                        C_U_FLAG                 VARCHAR(7)   DEFAULT (''),
                   						TRADETYPE1               VARCHAR(7)   DEFAULT (''),
										TRADETYPE2               VARCHAR(15)  DEFAULT (''),
                   						TRADER               	 VARCHAR(15)  DEFAULT (''),
										TRADERNAME               VARCHAR(50)  DEFAULT (''),
										ACTIVITYTIME_NEW		 VARCHAR(20)  DEFAULT (''),
										LASTMODIFIEDTIME_NEW     VARCHAR(20)  DEFAULT (''), 	
										OPP_BROKER_ID			 VARCHAR(5)   DEFAULT (''),
										ORDER_ENTER_MOD_DATETIME VARCHAR(20)  DEFAULT (''),
										DIRECTOR_NAME			 VARCHAR(50)  DEFAULT ('')
                                        )
  
  SET @STRING = @DATEFORMAT
                
  IF (CHARINDEX('|',@STRING) > 0)
    BEGIN
      SET @TSTRING = LEFT(@STRING,CHARINDEX('|',@STRING) - 1)
      
      SET @ESTRING = RIGHT(@STRING,LEN(@STRING) - CHARINDEX('|',@STRING))
      
      SET @STRING = @TSTRING
      
      IF (CHARINDEX(';',@STRING) > 0)
        BEGIN
          SET @TDATELEN = LEFT(@STRING,CHARINDEX(';',@STRING) - 1)
          
          SET @STRING = RIGHT(@STRING,LEN(@STRING) - CHARINDEX(';',@STRING))
          
          SET @TDATEFORMAT = LEFT(@STRING,CHARINDEX(';',@STRING) - 1)
          
          SET @STRING = RIGHT(@STRING,LEN(@STRING) - CHARINDEX(';',@STRING))
          
          SET @TDATEFREPLACE = LEFT(@STRING,CHARINDEX(';',@STRING) - 1)
          
          SET @STRING = RIGHT(@STRING,LEN(@STRING) - CHARINDEX(';',@STRING))
          
          SET @TDATEREPLACE = LEFT(@STRING,LEN(@STRING))
        END
        
      SET @STRING = @ESTRING
      
      IF (CHARINDEX(';',@STRING) > 0)
        BEGIN
          SET @EDATELEN = LEFT(@STRING,CHARINDEX(';',@STRING) - 1)
          
          SET @STRING = RIGHT(@STRING,LEN(@STRING) - CHARINDEX(';',@STRING))
          
          SET @EDATEFORMAT = LEFT(@STRING,CHARINDEX(';',@STRING) - 1)
          
          SET @STRING = RIGHT(@STRING,LEN(@STRING) - CHARINDEX(';',@STRING))
          
          SET @EDATEFREPLACE = LEFT(@STRING,CHARINDEX(';',@STRING) - 1)
          
          SET @STRING = RIGHT(@STRING,LEN(@STRING) - CHARINDEX(';',@STRING))
          
          SET @EDATEREPLACE = LEFT(@STRING,LEN(@STRING))
        END
    END
  ELSE
    BEGIN
      SET @TDATELEN = 11
      
      SET @TDATEFORMAT = CONVERT(NUMERIC,@DATEFORMAT)
      
      SET @TDATEFREPLACE = ''
      
      SET @TDATEREPLACE = ''
      
      SET @EDATELEN = 11
      
      SET @EDATEFORMAT = CONVERT(NUMERIC,@DATEFORMAT)
      
      SET @EDATEFREPLACE = ''
      
      SET @EDATEREPLACE = ''
    END
    
  IF @TDATEFREPLACE = ''
    SET @TDATEFREPLACE = ' '
                         
  IF @EDATEFREPLACE = ''
    SET @EDATEFREPLACE = ' '
                         

  IF (@REPORT_TYPE <> 1)
    BEGIN
      SELECT   CONTRACTNO,
               BILLNO,
               TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
               --PARENTCODE = C2.PARENTCODE,
               PARTY_CODE = F.PARTY_CODE,
               INST_TYPE,
               SYMBOL,
               SEC_NAME,
               EXPIRYDATE,
               STRIKE_PRICE,
               OPTION_TYPE,
               USER_ID,
               PRO_CLI,
               O_C_FLAG,
               C_U_FLAG,
               TRADEQTY = SUM(TRADEQTY),
               AUCTIONPART,
               MARKETTYPE,
               SERIES,
               ORDER_NO,
               PRICE = SUM(TRADEQTY * PRICE) / SUM(TRADEQTY),
			   ACTUALPRICE = SUM(TRADEQTY * F.DUMMY2) / SUM(TRADEQTY),
               SAUDA_DATE,
               F.TABLE_NO,
               LINE_NO,
               VAL_PERC,
               NORMAL,
               DAY_PUC,
               DAY_SALES,
               SETT_PURCH,
               SETT_SALES,
               SELL_BUY,
               SETTFLAG = (CASE 
                             WHEN SELL_BUY = 1 THEN 2
                             ELSE 3
                           END),
               BROKAPPLIED = SUM(BROKAPPLIED * TRADEQTY) / SUM(TRADEQTY),
               NETRATE = SUM(NETRATE * TRADEQTY) / SUM(TRADEQTY),
               AMOUNT = SUM(AMOUNT),
               TOTBROK = SUM(BROKAPPLIED * TRADEQTY),
               INS_CHRG = SUM(INS_CHRG),
               TURN_TAX = SUM(TURN_TAX),
               OTHER_CHRG = SUM(F.OTHER_CHRG),
               SEBI_TAX = SUM(SEBI_TAX),
               BROKER_CHRG = SUM(BROKER_CHRG),
               SERVICE_TAX = SUM(SERVICE_TAX),
               TRADE_AMOUNT = SUM(TRADE_AMOUNT),
               BILLFLAG = 0,
               SETT_NO = '    ',
               NBROKAPP = 0,
               NSERTAX = 0,
               N_NETRATE = 0,
               SETT_TYPE = '  ',
               CL_RATE = 0,
               PARTICIPANTCODE,
               STATUS = ' ',
               CPID,
               INSTRUMENT = '0',
               BOOKTYPE = '0',
               BRANCH_ID = ' ',
               TMARK = ' ',
               SCHEME = ' ',
               DUMMY1 = '0',
               DUMMY2 = 0,
               RESERVED1,
               RESERVED2 = 0,
               CL_TYPE

      INTO     #FOSETT
      FROM     FOSETTLEMENT F WITH (NOLOCK),
               V2_INST_PARTYMAPPING PM WITH (NOLOCK),
               CLIENT1 C1 WITH (NOLOCK),
               CLIENT2 C2 WITH (NOLOCK)
      WHERE    F.PARTY_CODE = PM.PARTY_CODE
               AND PM.RPT_REPORT_NO = @RPTREPORTNO
               AND F.TRADEQTY > 0
               AND F.SAUDA_DATE >= @FROMDATE
               AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'
               AND F.PARTY_CODE >= @FROMPARTY
               AND F.PARTY_CODE <= @TOPARTY
               AND C1.CL_CODE = C2.CL_CODE
               AND C2.PARTY_CODE = F.PARTY_CODE
               AND F.DUMMY1 = 1
      GROUP BY CONTRACTNO,BILLNO,PRADNYA.DBO.REPLACETRADENO(TRADE_NO),--C2.PARENTCODE,
               F.PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,
               EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID,
               PRO_CLI,O_C_FLAG,C_U_FLAG,AUCTIONPART,
               MARKETTYPE,SERIES,ORDER_NO,SAUDA_DATE,
               F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,
               DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
               SELL_BUY,PARTICIPANTCODE,CPID,RESERVED1,
               CL_TYPE
               

	/*
      UPDATE #FOSETT
      SET    BROKAPPLIED = (CASE 
                              WHEN SELL_BUY = 1 THEN CD_TOT_BUYBROK / TRADEQTY
                              ELSE CD_TOT_SELLBROK / TRADEQTY
                            END),
             TOTBROK = (CASE 
                          WHEN SELL_BUY = 1 THEN CD_TOT_BUYBROK
                          ELSE CD_TOT_SELLBROK
                        END),
             SERVICE_TAX = SERVICE_TAX + (CASE 
                                            WHEN SELL_BUY = 1 THEN CD_TOT_BUYSERTAX
                                            ELSE CD_TOT_SELLSERTAX
                                          END),
             NETRATE = PRICE + (CASE 
                                  WHEN SELL_BUY = 1 THEN CD_TOT_BUYBROK / TRADEQTY
                                  ELSE -(CD_TOT_SELLBROK / TRADEQTY)
                                END)
      FROM   CHARGES_DETAIL,
             CLIENT2 C2
      WHERE  LEFT(CONVERT(VARCHAR,CD_SAUDA_DATE,103),11) = LEFT(CONVERT(VARCHAR,SAUDA_DATE,103),11)
             AND CD_PARTY_CODE = #FOSETT.PARTY_CODE
             AND CD_INST_TYPE = INST_TYPE
             AND CD_SYMBOL = SYMBOL
             AND LEFT(CONVERT(VARCHAR,CD_EXPIRY_DATE,103),11) = LEFT(CONVERT(VARCHAR,EXPIRYDATE,103),11)
             AND CD_OPTION_TYPE = OPTION_TYPE
             AND CD_STRIKE_PRICE = STRIKE_PRICE
             AND CD_TRADE_NO = TRADE_NO
             AND CD_ORDER_NO = ORDER_NO
             AND CD_PARTY_CODE = C2.PARTY_CODE
	*/

                                 
      UPDATE #FOSETT
      SET    BROKAPPLIED = (CASE 
                              WHEN SERVICE_CHRG = 1 THEN BROKAPPLIED + SERVICE_TAX / TRADEQTY
                              ELSE BROKAPPLIED
                            END),
             SERVICE_TAX = (CASE 
                              WHEN SERVICE_CHRG = 0 THEN SERVICE_TAX
                              ELSE 0
                            END),
             TOTBROK = (CASE 
                          WHEN SERVICE_CHRG = 1 THEN TOTBROK + SERVICE_TAX
                          ELSE TOTBROK
                        END),
             NETRATE = PRICE + (CASE 
                                  WHEN SELL_BUY = 1 THEN (CASE 
                                                            WHEN SERVICE_CHRG = 1 THEN BROKAPPLIED + SERVICE_TAX / TRADEQTY
                                                            ELSE BROKAPPLIED
                                                          END)
                                  ELSE -(CASE 
                                           WHEN SERVICE_CHRG = 1 THEN BROKAPPLIED + SERVICE_TAX / TRADEQTY
                                           ELSE BROKAPPLIED
                                         END)
                                END),
             AMOUNT = TRADEQTY * PRICE + (CASE 
                                            WHEN SELL_BUY = 1 THEN (CASE 
                                                                      WHEN SERVICE_CHRG = 1 THEN TOTBROK + SERVICE_TAX
                                                                      ELSE TOTBROK --+ SERVICE_TAX
                                                                    END)
                                            ELSE -(CASE 
                                                     WHEN SERVICE_CHRG = 1 THEN TOTBROK + SERVICE_TAX
                                                     ELSE TOTBROK --+ SERVICE_TAX
                                                   END)
                                          END)
      FROM   CLIENT2 C2
      WHERE  C2.PARTY_CODE = #FOSETT.PARTY_CODE
    END
    
  IF @REPORT_TYPE = 1
    BEGIN
    
      IF @SUMMARIES = 1
        BEGIN
        
          SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
          
          SELECT   --PARENTCODE = C2.PARENTCODE,
                   PARTY_CODE = F.PARTY_CODE,
                   TRADEDATE = LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME,@TDATEFORMAT),
                                            @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN),
                   TRADEDTIME = CONVERT(VARCHAR,MIN(ACTIVITYTIME),108),
                   SETTDATE = (CASE 
                                 WHEN @SETTDATE = '' THEN LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME + 1,@TDATEFORMAT),
                                                                       @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                                 ELSE LEFT(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SETTDATE,103),@TDATEFORMAT),
                                                   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                               END),
                   ORDER_NO = MIN(ORDER_NO),
                   TRADE_NO = PRADNYA.DBO.REPLACETRADENO(MIN(TRADE_NO)),
                   INST_TYPE = F.INST_TYPE,
                   SYMBOL = F.SYMBOL,
                   EXPIRYDATE = LEFT(REPLACE(CONVERT(VARCHAR,F.EXPIRYDATE,@EDATEFORMAT),
                                             @EDATEFREPLACE,@EDATEREPLACE),@EDATELEN),
                   STRIKE_PRICE = F.STRIKE_PRICE,
                   OPTION_TYPE = F.OPTION_TYPE,
                   SEC_NAME = F.SEC_NAME,
                   SELL_BUY = (CASE 
                                 WHEN SELL_BUY = 1 THEN 'BUY'
                                 ELSE 'SELL'
                               END),
                   SELL_BUYBS = (CASE 
                                   WHEN SELL_BUY = 1 THEN 'B'
                                   ELSE 'S'
                                 END),
                   QTY = SUM(TRADEQTY),
                   QTYPLUS = SUM(CASE 
                                   WHEN SELL_BUY = 1 THEN TRADEQTY
                                   ELSE -TRADEQTY
                                 END),
                   BOUGHT_SOLD = (CASE 
                                    WHEN SELL_BUY = 1 THEN 'BOUGHT'
                                    ELSE 'SOLD'
                                  END),
                   BQTY = SUM(CASE 
                                WHEN SELL_BUY = 1 THEN TRADEQTY
                                ELSE 0
                              END),
                   SQTY = SUM(CASE 
                                WHEN SELL_BUY = 2 THEN TRADEQTY
                                ELSE 0
                              END),
                   CONTRACTS = (CASE 
                                  WHEN S2.C_REGULAR_LOT > 0 THEN (SUM(F.TRADEQTY) / S2.C_REGULAR_LOT)
                                  ELSE SUM(F.TRADEQTY)
                                END),
                   CONTRACTSBS = (CASE 
                                    WHEN SELL_BUY = 2 THEN -1
                                    ELSE 1
                                  END) * (CASE 
                                            WHEN S2.C_REGULAR_LOT > 0 THEN (SUM(F.TRADEQTY) / S2.C_REGULAR_LOT)
                                            ELSE SUM(F.TRADEQTY)
                                          END),
                   CONTRACTLOT = ISNULL(S2.C_REGULAR_LOT,0),
                   PRICE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)),4))),
                   PRICE2D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)),2))),
                   PRICE4D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)),4))),
                   AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TRADEQTY * PRICE),2))),
                   PARTYNAME = C1.LONG_NAME,
                   PARTICIPANTCODE,
                   BROKERCODE = ISNULL(O.MEMBERCODE,''),
                   COMPANYNAME = ISNULL(O.COMPANY,''),
                   COMPANYADD1 = ISNULL(O.ADDR1,''),
                   COMPANYADD2 = ISNULL(O.ADDR2,''),
                   COMPANYCITY = ISNULL(O.CITY,''),
                   COMPANYZIP = ISNULL(O.ZIP,''),
                   COMPANYPHONE = ISNULL(O.PHONE,''),
                   COMPANYPSEBINO = ISNULL(O.SEBINO,''),
                   ISIN = ISNULL(ISIN,''),
                   RICCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                   F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                    ''),
                   CUSIP = ISNULL(DBO.GETCUSIP(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   REUTERCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                             F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                       ''),
                   BLOOMBURGCODE = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   BLOOMBERG_TICKER = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   REUTERSCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                   F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),''),
                   SCHEME = ISNULL(UC.UCC_CODE,''),
                   STATUS,
                   BOOKTYPE,
                   BOOKTYPENAME,
                   MARKETTYPE,
                   USER_ID,
                   BRANCH_ID,
                   PRO_CLI,
                   O_C_FLAG,
                   C_U_FLAG

          FROM     FOTRADE F WITH (NOLOCK)
                   LEFT OUTER JOIN MULTIISIN M WITH (NOLOCK)
                     ON (M.SCRIP_CD = F.SYMBOL
                         AND M.VALID = 1
						AND M.SERIES='EQ')
                   /*LEFT OUTER JOIN BLOOMBERGMASTER B WITH (NOLOCK)
                     ON (B.SCRIP_CD = F.SYMBOL)
                   LEFT OUTER JOIN REUTERSCODEMASTER RT WITH (NOLOCK)
                     ON (RT.SYMBOL = F.SYMBOL
                         AND F.EXPIRYDATE LIKE LEFT(CONVERT(VARCHAR,RT.EXPIRYDATE,109),11) + '%')*/
                   LEFT OUTER JOIN UCC_CLIENT UC WITH (NOLOCK)
                     ON (UC.PARTY_CODE = F.PARTY_CODE),
                   FOSCRIP2 S2 WITH (NOLOCK),
                   CLIENT1 C1 WITH (NOLOCK),
                   CLIENT2 C2 WITH (NOLOCK),
                   FOOWNER O WITH (NOLOCK),
                   V2_INST_PARTYMAPPING PM WITH (NOLOCK)
          WHERE    C1.CL_CODE = C2.CL_CODE
                   AND C2.PARTY_CODE = F.PARTY_CODE
                   AND F.INST_TYPE = S2.INST_TYPE
                   AND F.SYMBOL = S2.SYMBOL
                   AND F.EXPIRYDATE = S2.EXPIRYDATE
                   AND F.STRIKE_PRICE = S2.STRIKE_PRICE
                   AND F.OPTION_TYPE = S2.OPTION_TYPE
                   AND F.TRADEQTY > 0
                   AND F.PARTY_CODE = PM.PARTY_CODE
                   AND PM.RPT_REPORT_NO = @RPTREPORTNO
                   AND F.ACTIVITYTIME >= @FROMDATE
                   AND F.ACTIVITYTIME <= @TODATE + ' 23:59:59'
                   AND F.PARTY_CODE >= @FROMPARTY
                   AND F.PARTY_CODE <= @TOPARTY
                   AND @STATUSNAME = (CASE 
                                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                        WHEN @STATUSID = 'AREA' THEN C1.AREA
                                        WHEN @STATUSID = 'REGION' THEN C1.REGION
                                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                        ELSE 'BROKER'
                                      END)
                                     
          GROUP BY /*C2.PARENTCODE,*/F.PARTY_CODE,LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME,@TDATEFORMAT),
                                @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN),(CASE 
                      WHEN @SETTDATE = '' THEN LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME + 1,@TDATEFORMAT),
                                                            @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                      ELSE LEFT(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SETTDATE,103),@TDATEFORMAT),
                                        @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                    END),
                   F.INST_TYPE,LEFT(F.EXPIRYDATE,11),F.SYMBOL,LEFT(REPLACE(CONVERT(VARCHAR,F.EXPIRYDATE,@EDATEFORMAT),
                                @EDATEFREPLACE,@EDATEREPLACE),@EDATELEN),
                   F.STRIKE_PRICE,F.OPTION_TYPE,F.SEC_NAME,SELL_BUY,
                   S2.C_REGULAR_LOT,C1.LONG_NAME,PARTICIPANTCODE,ISNULL(O.MEMBERCODE,''),
                   ISNULL(ISIN,''),
				   ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                          ''),
                   ISNULL(DBO.GETCUSIP(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''), 
                   ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   ISNULL(O.COMPANY,''),ISNULL(O.ADDR1,''),ISNULL(O.ADDR2,''),ISNULL(O.CITY,''),
                   ISNULL(O.ZIP,''),ISNULL(O.PHONE,''),ISNULL(O.SEBINO,''),
                   ISNULL(UC.UCC_CODE,''),STATUS,BOOKTYPE,BOOKTYPENAME,
                   MARKETTYPE,USER_ID,BRANCH_ID,PRO_CLI,
                   O_C_FLAG,C_U_FLAG
          ORDER BY TRADEDATE,
                   F.PARTY_CODE,
                   --C2.PARENTCODE,
                   F.SYMBOL,
                   SELL_BUY
                   
        END
      ELSE
        BEGIN
          INSERT INTO @TBLTRADECONFIRMATION (
					--PARENTCODE,
					PARTY_CODE,
					TRADEDATE,
					TRADEDTIME,
					TRADEDTIME_1,
					SETTDATE,
					TRADEDATETIME,
					ORDER_NO,
					ORDER_NO_NEW,
					TRADE_NO,
					INST_TYPE,
					INST_TYPE_1,
					SYMBOL,
					EXPIRYDATE,
					EXPIRYDATETIME,
					STRIKE_PRICE,
					OPTION_TYPE,
					OPTION_TYPE_NEW,
					SEC_NAME,
					SCRIPNAME,
					SELL_BUY,
					SELL_BUYBS,
					SELL_BUY_O,
					BOUGHT_SOLD,
					QTY,
					QTYPLUS,
					BQTY,
					SQTY,
					CONTRACTS,
					CONTRACTSBS,
					CONTRACTLOT,
					PRICE,
					PRICE2D,
					PRICE4D,
					AMOUNT,
					BAMOUNT,
					SAMOUNT,
					PARTYNAME,
					PARTICIPANTCODE,
					BROKERCODE,
					COMPANYNAME,
					COMPANYADD1,
					COMPANYADD2,
					COMPANYCITY,
					COMPANYZIP,
					COMPANYPHONE,
					COMPANYPSEBINO,
					ISIN,
					RICCODE,
					--RICCODECITY,
					CUSIP,
					REUTERCODE,
					BLOOMBURGCODE,
					BLOOMBERG_TICKER,
					ACTIVITYTIME,
					LASTMODIFIEDTIME,
					COMMISION,
					CLEARINGCOMM,
					TOTALCOMMISION,
					STT,
					STTPER,
					REUTERSCODE,
					SCHEME,
					EXPIRYDATE_DATEFORMAT,
					STRIKE_PRICE_MONEYFORMAT,
					STATUS,
					BOOKTYPE,
					BOOKTYPENAME,
					MARKETTYPE,
					USER_ID,
					BRANCH_ID,
					PRO_CLI,
					O_C_FLAG,
					C_U_FLAG,
					TRADETYPE1,
					TRADETYPE2,
					TRADER,
					TRADERNAME,
					ACTIVITYTIME_NEW,
					LASTMODIFIEDTIME_NEW,
					OPP_BROKER_ID,
					ORDER_ENTER_MOD_DATETIME,
					DIRECTOR_NAME)

          SELECT   --PARENTCODE = C2.PARENTCODE,
                   PARTY_CODE = F.PARTY_CODE,
                   TRADEDATE = LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME,@TDATEFORMAT),
                                            @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN),
                   TRADEDTIME = CONVERT(VARCHAR,ACTIVITYTIME,108),
                   TRADEDTIME_1 = REPLACE(CONVERT(VARCHAR,ACTIVITYTIME,108),':',''),
                   SETTDATE = (CASE 
                                 WHEN @SETTDATE = '' THEN LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME + 1,@TDATEFORMAT),
                                                                       @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                                 ELSE LEFT(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SETTDATE,103),@TDATEFORMAT),
                                                   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                               END),
                   TRADEDATETIME = LEFT(CONVERT(VARCHAR,ACTIVITYTIME,101),11) + ' ' + LEFT(CONVERT(VARCHAR,ACTIVITYTIME,108),5),
                   ORDER_NO,
				   ORDER_NO_NEW = SUBSTRING(ORDER_NO,3,LEN(ORDER_NO)),
                   TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
                   INST_TYPE = F.INST_TYPE,
                   INST_TYPE_1 = (CASE 
                                    WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN 'F'
                                    ELSE 'O'
                                  END),
                   SYMBOL = F.SYMBOL,
                   EXPIRYDATE = LEFT(REPLACE(CONVERT(VARCHAR,F.EXPIRYDATE,@EDATEFORMAT),
                                             @EDATEFREPLACE,@EDATEREPLACE),@EDATELEN),
				   EXPIRYDATETIME = LEFT(REPLACE(CONVERT(VARCHAR,F.EXPIRYDATE,@EDATEFORMAT),
                                             @EDATEFREPLACE,@EDATEREPLACE),@EDATELEN) + ' ' + LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,108),5),
                   STRIKE_PRICE = F.STRIKE_PRICE,
                   OPTION_TYPE = F.OPTION_TYPE,
				   OPTION_TYPE_NEW = (CASE WHEN F.OPTION_TYPE = '' THEN 'XX' ELSE F.OPTION_TYPE END),
                   SEC_NAME = F.SEC_NAME,
                   SCRIPNAME = (CASE 
                                  WHEN F.INST_TYPE LIKE 'FUT%' THEN RTRIM(F.INST_TYPE) + ' ' + RTRIM(F.SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,113),11)
                                  ELSE RTRIM(F.INST_TYPE) + ' ' + RTRIM(F.SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,113),11) + ' ' + RTRIM(CAST(CAST(F.STRIKE_PRICE AS NUMERIC(18,0)) AS VARCHAR)) + ' ' + RTRIM(F.OPTION_TYPE)
                                END),
                   SELL_BUY = (CASE 
                                 WHEN SELL_BUY = 1 THEN 'BUY'
                                 ELSE 'SELL'
                               END),
                   SELL_BUYBS = (CASE 
                                   WHEN SELL_BUY = 1 THEN 'B'
                                   ELSE 'S'
                                 END),
                   SELL_BUY_O = SELL_BUY,
                   BOUGHT_SOLD = (CASE 
                                    WHEN SELL_BUY = 1 THEN 'BOUGHT'
                                    ELSE 'SOLD'
                                  END),
                   QTY = TRADEQTY,
                   QTYPLUS = (CASE 
                                WHEN SELL_BUY = 1 THEN TRADEQTY
                                ELSE -TRADEQTY
                              END),
                   BQTY = (CASE 
                             WHEN SELL_BUY = 1 THEN TRADEQTY
                             ELSE 0
                           END),
                   SQTY = (CASE 
                             WHEN SELL_BUY = 2 THEN TRADEQTY
                             ELSE 0
                           END),
                   CONTRACTS = '',
                   CONTRACTSBS = '',
                   CONTRACTLOT = '',
                   PRICE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(PRICE,4))),
                   PRICE2D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(PRICE,2))),
                   PRICE4D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(PRICE,4))),
                   AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((TRADEQTY * PRICE),2))),
                   BAMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                            WHEN SELL_BUY = 1 THEN (TRADEQTY * PRICE)
                                                                            ELSE 0
                                                                          END),2))),
                   SAMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                            WHEN SELL_BUY = 2 THEN (TRADEQTY * PRICE)
                                                                            ELSE 0
                                                                          END),2))),
                   PARTYNAME = C1.LONG_NAME,
                   PARTICIPANTCODE,
                   BROKERCODE = '',
                   COMPANYNAME = '',
                   COMPANYADD1 = '',
                   COMPANYADD2 = '',
                   COMPANYCITY = '',
                   COMPANYZIP = '',
                   COMPANYPHONE = '',
                   COMPANYPSEBINO = '',
                   ISIN = '',
					/*
                   RICCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                          F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                    ''),
                   CUSIP = ISNULL(DBO.GETCUSIP(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   REUTERCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                             F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                       ''),
                   BLOOMBURGCODE = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   BLOOMBERG_TICKER = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
					*/
				   RICCODE = '',
				   CUSIP = '',
				   REUTERCODE = '',
				   BLOOMBURGCODE = '',
				   BLOOMBERG_TICKER = '',
                   ACTIVITYTIME = LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME,@TDATEFORMAT),
                                               @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN) + ' ' + LEFT(CONVERT(VARCHAR,ACTIVITYTIME,108),5),
                   LASTMODIFIEDTIME = LEFT(REPLACE(CONVERT(VARCHAR,LAST_MOD_TIME,@TDATEFORMAT),
                                                   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN) + ' ' + LEFT(CONVERT(VARCHAR,LAST_MOD_TIME,108),5),
                   COMMISION = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((CASE 
                                                                              WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN (CASE 
                                                                                                                       WHEN SELL_BUY = 1 THEN (((F.STRIKE_PRICE * DAY_PUC) / 100) * TRADEQTY)
                                                                                                                       ELSE (((F.STRIKE_PRICE * DAY_SALES) / 100) * TRADEQTY)
                                                                                                                     END)
                                                                              ELSE (CASE 
                                                                                      WHEN SELL_BUY = 1 THEN (((PRICE * DAY_PUC) / 100) * TRADEQTY)
                                                                                      ELSE (((PRICE * DAY_SALES) / 100) * TRADEQTY)
                                                                                    END)
                                                                            END),4))),
                   CLEARINGCOMM = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((CASE 
                                                                                 WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN (((F.STRIKE_PRICE * 0.01) / 100) * TRADEQTY)
                                                                                 ELSE (((PRICE * 0.01) / 100) * TRADEQTY)
                                                                               END),4))),
                   TOTALCOMMISION = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((CASE 
                                                                                   WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN (CASE 
                                                                                                                            WHEN SELL_BUY = 1 THEN (((F.STRIKE_PRICE * DAY_PUC) / 100) * TRADEQTY)
                                                                                                                            ELSE (((F.STRIKE_PRICE * DAY_SALES) / 100) * TRADEQTY)
                                                                                                                          END)
                                                                                   ELSE (CASE 
                                                                                           WHEN SELL_BUY = 1 THEN (((PRICE * DAY_PUC) / 100) * TRADEQTY)
                                                                                           ELSE (((PRICE * DAY_SALES) / 100) * TRADEQTY)
                                                                                         END)
                                                                                 END) + (CASE 
                                                                                           WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN (((F.STRIKE_PRICE * 0.01) / 100) * TRADEQTY)
                                                                                           ELSE (((PRICE * 0.01) / 100) * TRADEQTY)
                                                                                         END) + (CASE 
                                                                                                   WHEN INSURANCE_CHRG = 1
                                                                                                        AND SELL_BUY = 2 THEN (((((F.STRIKE_PRICE + PRICE) * TRADEQTY) * TRDSELLTRANS) / 100))
                                                                                                   ELSE 0
                                                                                                 END),4))),
                   STT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((CASE 
                                                                        WHEN INSURANCE_CHRG = 1
                                                                             AND SELL_BUY = 2 THEN (((((F.STRIKE_PRICE + PRICE) * TRADEQTY) * TRDSELLTRANS) / 100))
                                                                        ELSE 0
                                                                      END),4))),
                   STTPER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((CASE 
                                                                           WHEN INSURANCE_CHRG = 1
                                                                                AND SELL_BUY = 2 THEN TRDSELLTRANS
                                                                           ELSE 0
                                                                         END),4))),
					/*
                   REUTERSCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                   F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),''),*/
				   REUTERSCODE ='',	
                   SCHEME = '',
                   EXPIRYDATE_DATEFORMAT = F.EXPIRYDATE,
                   STRIKE_PRICE_MONEYFORMAT = F.STRIKE_PRICE,
                   STATUS,
                   BOOKTYPE,
                   BOOKTYPENAME,
                   MARKETTYPE,
                   USER_ID,
                   BRANCH_ID,
                   PRO_CLI,
                   O_C_FLAG,
                   C_U_FLAG,
				   TRADETYPE1 = (CASE 
                                  WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN 
										'F'
                                  WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN
                                       	F.OPTION_TYPE
                                  ELSE 	''
                                END),
                   TRADETYPE2 = (CASE 
                                  WHEN F.INST_TYPE = 'FUTIDX' THEN 'INDEX FUTURE'
								  WHEN F.INST_TYPE = 'FUTSTK' THEN 'STOCK FUTURE'
								  WHEN F.INST_TYPE = 'OPTIDX' THEN 'INDEX OPTIONS'
								  WHEN F.INST_TYPE = 'OPTSTK' THEN 'STOCK OPTIONS'
                                  ELSE ''
                                END),
				   TRADER = ISNULL(BR.SHORT_NAME,''),
				   TRADERNAME = ISNULL(BR.LONG_NAME,''),
				   ACTIVITYTIME_NEW = LEFT(REPLACE(CONVERT(VARCHAR,ACTIVITYTIME,@TDATEFORMAT),
														   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN) + ' ' + LEFT(CONVERT(VARCHAR,ACTIVITYTIME,108),8),
				   LASTMODIFIEDTIME_NEW = LEFT(REPLACE(CONVERT(VARCHAR,LAST_MOD_TIME,@TDATEFORMAT),
														   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN) + ' ' + LEFT(CONVERT(VARCHAR,LAST_MOD_TIME,108),8),
				   OPP_BROKER_ID = 'NIL',
				   ORDER_ENTER_MOD_DATETIME = LEFT(REPLACE(CONVERT(VARCHAR,LAST_MOD_TIME,@TDATEFORMAT),
														   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN) + ' ' + LEFT(CONVERT(VARCHAR,LAST_MOD_TIME,108),8),
				   DIRECTOR_NAME = ''

          FROM     FOTRADE F WITH (NOLOCK),
                   CLIENT1 C1 WITH (NOLOCK)
				   LEFT OUTER JOIN BRANCHES BR WITH(NOLOCK) ON
				   (
		  			BR.SHORT_NAME = C1.TRADER 
				   ),
                   CLIENT2 C2 WITH (NOLOCK)
                   LEFT OUTER JOIN BROKTABLE BK WITH (NOLOCK)
                     ON (BK.TABLE_NO = C2.BROK2_TABLENO),
                   BFOGLOBALS G WITH (NOLOCK),
                   V2_INST_PARTYMAPPING PM WITH (NOLOCK)
          WHERE    C1.CL_CODE = C2.CL_CODE
                   AND C2.PARTY_CODE = F.PARTY_CODE
                   AND F.TRADEQTY > 0
                   AND F.PARTY_CODE = PM.PARTY_CODE
                   AND PM.RPT_REPORT_NO = @RPTREPORTNO
                   AND F.ACTIVITYTIME >= @FROMDATE
                   AND F.ACTIVITYTIME <= @TODATE + ' 23:59:59'
                   AND G.YEAR_START_DT <= @FROMDATE
                   AND G.YEAR_END_DT >= @FROMDATE
                   AND F.PARTY_CODE >= @FROMPARTY
                   AND F.PARTY_CODE <= @TOPARTY
                   AND @STATUSNAME = (CASE 
                                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                        WHEN @STATUSID = 'AREA' THEN C1.AREA
                                        WHEN @STATUSID = 'REGION' THEN C1.REGION
                                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                        ELSE 'BROKER'
                                      END)
          ORDER BY TRADEDATE,
                   F.PARTY_CODE,
                   --C2.PARENTCODE,
                   F.SYMBOL,
                   SELL_BUY

          /*         
          --- UPDATE REUTERSCODE
          UPDATE @TBLTRADECONFIRMATION
          SET    REUTERSCODE = B.REUTERSCODE
          FROM   @TBLTRADECONFIRMATION A,
                 REUTERSCODEMASTER B
          --WHERE A.EXPIRYDATE_DATEFORMAT LIKE LEFT(CONVERT(VARCHAR,B.EXPIRYDATE,109),11) + '%'
          WHERE LEFT(A.EXPIRYDATE_DATEFORMAT,11) = LEFT(B.EXPIRYDATE,11)
                 AND A.SYMBOL = B.SYMBOL
          */
                      
          --- UPDATE UCC CODE
          UPDATE @TBLTRADECONFIRMATION
          SET    SCHEME = B.UCC_CODE
          FROM   @TBLTRADECONFIRMATION A,
                 UCC_CLIENT B
          WHERE  A.PARTY_CODE = B.PARTY_CODE
                                
          --- UPDATE BLOOMBURGCODE
/*          UPDATE @TBLTRADECONFIRMATION
          SET    BLOOMBURGCODE = ISNULL(B.BLOOMBERGCODE,'')
          FROM   @TBLTRADECONFIRMATION A,
                 BLOOMBERGMASTER B
          WHERE  A.SYMBOL = B.SCRIP_CD*/
                            
          --- UPDATE ISIN DETAILS
          UPDATE @TBLTRADECONFIRMATION
          SET    ISIN = ISNULL(B.ISIN,'')
          FROM   @TBLTRADECONFIRMATION A,
                 MULTIISIN B
          WHERE  A.SYMBOL = B.SCRIP_CD
                 AND B.VALID = 1
		 AND B.SERIES='EQ'
                               
          --- UPDATE COMPANY/OWNER DEAILS
          UPDATE @TBLTRADECONFIRMATION
          SET    BROKERCODE = ISNULL(MEMBERCODE,''),
                 COMPANYNAME = ISNULL(COMPANY,''),
                 COMPANYADD1 = ISNULL(ADDR1,''),
                 COMPANYADD2 = ISNULL(ADDR2,''),
                 COMPANYCITY = ISNULL(CITY,''),
                 COMPANYZIP = ISNULL(ZIP,''),
                 COMPANYPHONE = ISNULL(PHONE,''),
                 COMPANYPSEBINO = ISNULL(SEBINO,'')
          FROM   @TBLTRADECONFIRMATION,
                 FOOWNER
                 
          --- UPDATE CONTRACT DETAILS
          UPDATE @TBLTRADECONFIRMATION
          SET    CONTRACTSBS = (CASE 
                                  WHEN SELL_BUY_O = 2 THEN -1
                                  ELSE 1
                                END) * (CASE 
                                          WHEN B.C_REGULAR_LOT > 0 THEN (F.QTY / B.C_REGULAR_LOT)
                                          ELSE F.QTY
                                        END),
                 CONTRACTS = (CASE 
                                WHEN B.C_REGULAR_LOT > 0 THEN (F.QTY / B.C_REGULAR_LOT)
                                ELSE F.QTY
                              END),
                 CONTRACTLOT = ISNULL(B.C_REGULAR_LOT,0),
				RICCODE = ISNULL(DBO.GETRICCODE(B.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
													  F.STRIKE_PRICE,F.OPTION_TYPE,B.SCRIP_ID,@RPTREPORTNO),''),
				CUSIP = ISNULL(DBO.GETCUSIP(B.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,B.SCRIP_ID),''),
				REUTERCODE = ISNULL(DBO.GETRICCODE(B.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
														 F.STRIKE_PRICE,F.OPTION_TYPE,B.SCRIP_ID,@RPTREPORTNO),''),
				BLOOMBURGCODE = ISNULL(DBO.GETBLOOMBERGCODE(B.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,B.SCRIP_ID),''),
				BLOOMBERG_TICKER = ISNULL(DBO.GETBLOOMBERGCODE(B.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,B.SCRIP_ID),''),
				REUTERSCODE = ISNULL(DBO.GETRICCODE(B.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
											   F.STRIKE_PRICE,F.OPTION_TYPE,B.SCRIP_ID,@RPTREPORTNO),'')

          FROM   @TBLTRADECONFIRMATION F,
                 FOSCRIP2 B
          WHERE LEFT(F.EXPIRYDATE_DATEFORMAT,11) = LEFT(B.EXPIRYDATE,11)
                 AND F.INST_TYPE = B.INST_TYPE
                 AND F.SYMBOL = B.SYMBOL
                 AND F.STRIKE_PRICE = B.STRIKE_PRICE
                 AND F.OPTION_TYPE = B.OPTION_TYPE
	

          UPDATE @TBLTRADECONFIRMATION
          SET    DIRECTOR_NAME = ISNULL(C5.DIRECTOR_NAME,'')
		  FROM	 CLIENT5 C5
		  WHERE	 PARTY_CODE = C5.CL_CODE

                                     
          SELECT --PARENTCODE,
				PARTY_CODE,
				TRADEDATE,
				TRADEDTIME,
				TRADEDTIME_1,
				SETTDATE,
				TRADEDATETIME,
				ORDER_NO,
				ORDER_NO_NEW,
				TRADE_NO,
				INST_TYPE,
				INST_TYPE_1,
				SYMBOL,
				EXPIRYDATE,
				EXPIRYDATETIME,
				STRIKE_PRICE,
				OPTION_TYPE,
				OPTION_TYPE_NEW,
				SEC_NAME,
				SCRIPNAME,
				SELL_BUY,
				SELL_BUYBS,
				SELL_BUY_O,
				BOUGHT_SOLD,
				QTY,
				QTYPLUS,
				BQTY,
				SQTY,
				CONTRACTS,
				CONTRACTSBS,
				CONTRACTLOT,
				PRICE,
				PRICE2D,
				PRICE4D,
				AMOUNT,
				BAMOUNT,
				SAMOUNT,
				PARTYNAME,
				PARTICIPANTCODE,
				BROKERCODE,
				COMPANYNAME,
				COMPANYADD1,
				COMPANYADD2,
				COMPANYCITY,
				COMPANYZIP,
				COMPANYPHONE,
				COMPANYPSEBINO,
				ISIN,
				RICCODE,
				--RICCODECITY,
				CUSIP,
				REUTERCODE,
				BLOOMBURGCODE,
				BLOOMBERG_TICKER,
				ACTIVITYTIME,
				LASTMODIFIEDTIME,
				COMMISION,
				CLEARINGCOMM,
				TOTALCOMMISION,
				STT,
				STTPER,
				REUTERSCODE,
				SCHEME,
				STATUS,
				BOOKTYPE,
				BOOKTYPENAME,
				MARKETTYPE,
				USER_ID,
				BRANCH_ID,
				PRO_CLI,
				O_C_FLAG,
				C_U_FLAG,
				TRADETYPE1,
				TRADETYPE2,
				TRADER,
				TRADERNAME,
				ACTIVITYTIME_NEW,
				LASTMODIFIEDTIME_NEW,
				OPP_BROKER_ID,
				ORDER_ENTER_MOD_DATETIME,
				DIRECTOR_NAME
			FROM   
				@TBLTRADECONFIRMATION
        END
        
    END
  ELSE
    BEGIN
    
      IF @SUMMARIES = 1
        BEGIN
        
          SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
          
          SELECT   --PARENTCODE = C2.PARENTCODE,
                   PARTY_CODE = F.PARTY_CODE,
                   TRADEDATE = LEFT(REPLACE(CONVERT(VARCHAR,SAUDA_DATE,@TDATEFORMAT),
                                            @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN),
                   TRADEDTIME = CONVERT(VARCHAR,MIN(SAUDA_DATE),108),
                   SETTDATE = (CASE 
                                 WHEN @SETTDATE = '' THEN LEFT(REPLACE(CONVERT(VARCHAR,SAUDA_DATE + 1,@TDATEFORMAT),
                                                                       @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                                 ELSE LEFT(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SETTDATE,103),@TDATEFORMAT),
                                                   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                               END),
                   ORDER_NO = MIN(ORDER_NO),
                   TRADE_NO = PRADNYA.DBO.REPLACETRADENO(MIN(TRADE_NO)),
                   CONTRACTNO,
                   INST_TYPE = F.INST_TYPE,
                   INST_TYPE_SHORT = LEFT(F.INST_TYPE,3),
                   SYMBOL = F.SYMBOL,
                   EXPIRYDATE = LEFT(REPLACE(CONVERT(VARCHAR,F.EXPIRYDATE,@EDATEFORMAT),
                                             @EDATEFREPLACE,@EDATEREPLACE),@EDATELEN),
                   STRIKE_PRICE = F.STRIKE_PRICE,
				   STRIKE_PRICE_FUTOPT = (CASE WHEN LEFT(F.INST_TYPE,3) = 'OPT'
						THEN CONVERT(VARCHAR,F.STRIKE_PRICE)
						ELSE 'XXXX'
						END),
                   OPTION_TYPE = F.OPTION_TYPE,
                   SEC_NAME = F.SEC_NAME,
                   SCRIPNAME = (CASE 
                                  WHEN F.INST_TYPE LIKE 'FUT%' THEN RTRIM(F.INST_TYPE) + ' ' + RTRIM(F.SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,113),11)
                                  ELSE RTRIM(F.INST_TYPE) + ' ' + RTRIM(F.SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,113),11) + ' ' + RTRIM(CAST(CAST(F.STRIKE_PRICE AS NUMERIC(18,0)) AS VARCHAR)) + ' ' + RTRIM(F.OPTION_TYPE)
                                END),
				   NSESCRIPNAME = (SELECT ISNULL(SCRIP_NAME,'') FROM MSAJAG.DBO.SCRIP_CODES WHERE SYMBOL = F.SYMBOL),
                   SELL_BUY = (CASE 
                                 WHEN SELL_BUY = 1 THEN 'BUY'
                                 ELSE 'SELL'
                               END),
                   SELL_BUYBS = (CASE 
                                   WHEN SELL_BUY = 1 THEN 'B'
                                   ELSE 'S'
                                 END),
                   SELL_BUY_O = SELL_BUY,
                   BOUGHT_SOLD = (CASE 
                                    WHEN SELL_BUY = 1 THEN 'BOUGHT'
                                    ELSE 'SOLD'
                                  END),
				   SELL_BUY_IFPURSAL = (CASE 
										WHEN SELL_BUY = 1 THEN 'IFPUR'
										ELSE 'IFSAL'
										END),
                   QTY = SUM(TRADEQTY),
                   QTYPLUS = SUM(CASE 
                                   WHEN SELL_BUY = 1 THEN TRADEQTY
                                   ELSE -TRADEQTY
                                 END),
                   BQTY = SUM(CASE 
                                WHEN SELL_BUY = 1 THEN TRADEQTY
                                ELSE 0
                              END),
                   SQTY = SUM(CASE 
                                WHEN SELL_BUY = 2 THEN TRADEQTY
                                ELSE 0
                              END),
                   CONTRACTS = (CASE 
                                  WHEN S2.C_REGULAR_LOT > 0 THEN (SUM(F.TRADEQTY) / S2.C_REGULAR_LOT)
                                  ELSE SUM(F.TRADEQTY)
                                END),
                   CONTRACTSBS = (CASE 
                                    WHEN SELL_BUY = 2 THEN -1
                                    ELSE 1
                                  END) * (CASE 
                                            WHEN S2.C_REGULAR_LOT > 0 THEN (SUM(F.TRADEQTY) / S2.C_REGULAR_LOT)
                                            ELSE SUM(F.TRADEQTY)
                                          END),
                   CONTRACTLOT = ISNULL(S2.C_REGULAR_LOT,0),
				   ACTUALQTY = SUM(F.TRADEQTY * CONVERT(NUMERIC,S2.C_REGULAR_LOT)),
                   PRICE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)),4))),
                   PRICE2D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)),2))),
                   PRICE4D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)),4))),
					ACTUALPRICE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * ACTUALPRICE) / SUM(TRADEQTY)),4))),
                   GROSSRATE = (CASE 
                                  WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN F.STRIKE_PRICE
                                  ELSE SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)
                                END),
                   PREMIUM = (CASE 
                                WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)
                                ELSE 0
                              END),
                   
                   AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TRADEQTY * PRICE),2))),
                   AMOUNTCITI = (CASE 
					WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN
						CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TRADEQTY * PRICE),2)))
					ELSE ''	END),
                   LOTAMOUNT = (CASE 
                                  WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                                                                       WHEN S2.C_REGULAR_LOT > 0 THEN (SUM(F.TRADEQTY) / S2.C_REGULAR_LOT)
                                                                                                                       ELSE SUM(F.TRADEQTY)
                                                                                                                     END) * SUM(TRADEQTY * PRICE) / SUM(TRADEQTY) * ISNULL(S2.C_REGULAR_LOT,0),
                                                                                                                    2)))
                                  ELSE '' /*CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),0))*/
                                END),
                   AMOUNTWITHSTRIKEP = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TRADEQTY * (PRICE + F.STRIKE_PRICE)),
                                                                                   2))),
                   NETRATE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * NETRATE) / SUM(TRADEQTY)),
                                                                         4))),
                   NETRATE2D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(TRADEQTY * NETRATE) / SUM(TRADEQTY)),
                                                                         2))),
                   NETRATESTT = (CASE 
                                   WHEN SELL_BUY = 1 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * NETRATE) + SUM(INS_CHRG)) / SUM(TRADEQTY),
                                                                                                      4)))
                                   ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY * NETRATE) - SUM(INS_CHRG)) / SUM(TRADEQTY),
                                                                                    4)))
                                 END),
                   NETAMOUNT = (CASE 
                                  WHEN SELL_BUY = 1 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(AMOUNT)),2)))
                                  ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(AMOUNT)),2)))
                                END),
                   NETAMOUNTSTT = (CASE 
                                     WHEN SELL_BUY = 1 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(AMOUNT) + SUM(INS_CHRG)),2)))
                                     ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(AMOUNT) - SUM(INS_CHRG)),2)))
                                   END),
                   
                   BROKRAGE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(BROKAPPLIED * TRADEQTY) / SUM(TRADEQTY)),
                                                                          4))),
                   TOTBROKRAGE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TOTBROK),2))),
                   TOTBROKRAGESTT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(TOTBROK) + SUM(INS_CHRG)),2))),
                   BROKRAGEPER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(TOTBROK) / SUM(TRADEQTY)) * 100 / (SUM(TRADEQTY * PRICE) / SUM(TRADEQTY)),2))),
				   BROKRAGEPERNEW = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE WHEN SELL_BUY = 1 THEN DAY_PUC ELSE DAY_SALES END),2))),
                   TOTBROKRAGEWITHSER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TOTBROK),2))),
                   BROKRAGEWITHSER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TOTBROK),2))),
					INCLUSIVESERTAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TOTBROK)-SUM(TOTBROK)*100/(100+G.SERVICE_TAX),2))),
					TOTBROKRAGEWITHOUTSER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TOTBROK)-(SUM(TOTBROK)-SUM(TOTBROK)*100/(100+G.SERVICE_TAX)),2))),
                   CLEARINGCHARG = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(TOTBROK) * 0.25 / 100) / 100,4))),
                   CLEARINGCHARGNEW = (CASE 
					WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
					THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY*PRICE) * 0.011236/100),4)))
					WHEN LEFT(F.INST_TYPE,3) = 'OPT' 
					THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(TRADEQTY*F.STRIKE_PRICE) * 0.011236/100),4)))
					END),
                   NETRATESTTCLCHRG = (CASE 
                                   	WHEN SELL_BUY = 1 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(AMOUNT) + SUM(INS_CHRG) + (CASE 
																		WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
																		THEN (SUM(TRADEQTY*PRICE)*0.011236/100)
																		WHEN LEFT(F.INST_TYPE,3) = 'OPT' 
																		THEN (SUM(TRADEQTY*F.STRIKE_PRICE)*0.011236/100)
																		END)) / SUM(TRADEQTY),4)))
                                   	ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((SUM(AMOUNT) - SUM(INS_CHRG) - (CASE 
																WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
																THEN (SUM(TRADEQTY*PRICE)*0.011236/100)
																WHEN LEFT(F.INST_TYPE,3) = 'OPT' 
																THEN (SUM(TRADEQTY*F.STRIKE_PRICE)*0.011236/100)
																END)) / SUM(TRADEQTY),4)))
                                 	END),
                   STT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE 
                                                                           WHEN INSURANCE_CHRG = 1 THEN INS_CHRG
                                                                           ELSE 0
                                                                         END),2))),
                   STTPER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(MAX(CASE 
                                                                              WHEN INSURANCE_CHRG = 1
                                                                                   AND SELL_BUY = 2 THEN TRDSELLTRANS
                                                                              ELSE 0
                                                                            END),4))),
                   TURN_TAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE 
                                                                                WHEN C2.TURNOVER_TAX = 1 THEN TURN_TAX
                                                                                ELSE 0
                                                                              END),2))),
                   SEBI_TAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE 
                                                                                WHEN SEBI_TURN_TAX = 1 THEN SEBI_TAX
                                                                                ELSE 0
                                                                              END),2))),
                   OTHER_CHRG = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE 
                                                                                  WHEN C2.OTHER_CHRG = 1 THEN F.OTHER_CHRG
                                                                                  ELSE 0
                                                                                END),2))),
                   SERVICE_TAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE 
                                                                                   WHEN SERVICE_CHRG = 0 THEN F.SERVICE_TAX
                                                                                   ELSE 0
                                                                                 END),2))),
                   BROKER_CHRG = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE 
                                                                                   WHEN BROKERNOTE = 1 THEN BROKER_CHRG
                                                                                   ELSE 0
                                                                                 END),2))),
                   TOTCHARGES = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TOTBROK) + SUM(CASE 
                                                                                                 WHEN SERVICE_CHRG = 0 THEN F.SERVICE_TAX
                                                                                                 ELSE 0
                                                                                               END) + SUM(CASE 
                                                                                                            WHEN INSURANCE_CHRG = 1 THEN INS_CHRG
                                                                                                            ELSE 0
                                                                                                          END),2))),
                   EDUCESSTAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                               WHEN SERVICE_CHRG = 0 THEN SUM(F.SERVICE_TAX) - (SUM(F.SERVICE_TAX) * 100 / (100 + CESS_TAX))
                                                                               ELSE 0
                                                                             END),2))),
                   
                   SERWITHOUTEDUCESSTAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                                         WHEN SERVICE_CHRG = 0 THEN SUM(F.SERVICE_TAX) - (SUM(F.SERVICE_TAX) - (SUM(F.SERVICE_TAX) * 100 / (100 + CESS_TAX)))
                                                                                         ELSE 0
                                                                                       END),2))),

                   TURNSTAMPTAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE 
                                                                                WHEN C2.TURNOVER_TAX = 1 THEN TURN_TAX
                                                                                ELSE 0
                                                                              END)
																			+ SUM(CASE 
                                                                                   WHEN BROKERNOTE = 1 THEN BROKER_CHRG
                                                                                   ELSE 0
                                                                                 END)
																			,2))),
                   PARTYNAME = C1.LONG_NAME,
                   PARTICIPANTCODE,
                   BROKERCODE = ISNULL(O.MEMBERCODE,''),
                   COMPANYNAME = ISNULL(O.COMPANY,''),
                   COMPANYADD1 = ISNULL(O.ADDR1,''),
                   COMPANYADD2 = ISNULL(O.ADDR2,''),
                   COMPANYCITY = ISNULL(O.CITY,''),
                   COMPANYZIP = ISNULL(O.ZIP,''),
                   COMPANYPHONE = ISNULL(O.PHONE,''),
                   COMPANYPSEBINO = ISNULL(O.SEBINO,''),
                   ISIN = ISNULL(ISIN,''),
                   ISINNIFTY = (CASE WHEN F.SYMBOL IN ('BANKNIFTY','MINIFTY','MINNIFTY','NIFTY') THEN F.SYMBOL ELSE ISNULL(ISIN,'') END),
                   RICCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                          F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                    ''),
                   CUSIP = ISNULL(DBO.GETCUSIP(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   REUTERCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                             F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                       ''),
                   BLOOMBURGCODE = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   BLOOMBERG_TICKER = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   TRADETYPE = (CASE 
                                  WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN 'FUTURE'
                                  WHEN LEFT(F.INST_TYPE,3) = 'OPT'
                                       AND LEFT(F.OPTION_TYPE,1) = 'C' THEN 'OPTION CALL'
                                  WHEN LEFT(F.INST_TYPE,3) = 'OPT'
                                       AND LEFT(F.OPTION_TYPE,1) = 'P' THEN 'OPTION PUT'
                                  ELSE 'OPTION'
                                END),
                   EXCHANGE = 'NSE',
                   ARBITRAGE = 'N',
                   REUTERSCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                          F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),''),
                   SCHEME = ISNULL(UC.UCC_CODE,''),
					SCHEME_NEW = C1.WARD_NO,
                   TRADER = ISNULL(BR.SHORT_NAME,''),
					TRADERNAME = ISNULL(BR.LONG_NAME,''),
                   CL_TYPE = F.CL_TYPE,
                   CALLPUT = (CASE 
                                WHEN LEFT(F.OPTION_TYPE,1) = 'C' THEN 'CALL'
                                WHEN LEFT(F.OPTION_TYPE,1) = 'P' THEN 'PUT'
                                ELSE ''
                              END),
                   TRADETYPE1 = (CASE 
                                  WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN 
										'F'
                                  WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN
                                       	F.OPTION_TYPE
                                  ELSE 	''
                                END),
                   TRADETYPE2 = (CASE 
                                  WHEN F.INST_TYPE = 'FUTIDX' THEN 'INDEX FUTURE'
								  WHEN F.INST_TYPE = 'FUTSTK' THEN 'STOCK FUTURE'
								  WHEN F.INST_TYPE = 'OPTIDX' AND F.OPTION_TYPE IN ('PE','PA','CE','CA') THEN 'INDEX OPTION CALL'
								  WHEN F.INST_TYPE = 'OPTSTK' AND F.OPTION_TYPE IN ('PE','PA','CE','CA') THEN 'STOCK OPTION PUT'
                                  ELSE ''
                                END),
                   TRADETYPE3 = (CASE 
									WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN 'FUTURE'
									WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN 'OPTION'
									ELSE ''
									END),
                   TRADETYPE4 = (CASE 
									WHEN RIGHT(F.INST_TYPE,3) = 'STK' THEN 'STOCK'
									WHEN RIGHT(F.INST_TYPE,3) = 'IDX' THEN 'INDEX'
									ELSE ''
									END),
                   TRADETYPE5 = (CASE 
                                  WHEN F.INST_TYPE = 'FUTIDX' THEN 'INDEX FUTURE'
								  WHEN F.INST_TYPE = 'FUTSTK' THEN 'STOCK FUTURE'
								  WHEN F.INST_TYPE = 'OPTIDX' THEN 'INDEX OPTIONS'
								  WHEN F.INST_TYPE = 'OPTSTK' THEN 'STOCK OPTIONS'
                                  ELSE ''
                                END),
				   --ACCOUNTCODE 	= MIN(DBO.GETACCOUNTCODE(LEFT(F.SAUDA_DATE,11),F.SYMBOL,@RPTREPORTNO,F.PARTY_CODE,'ACCOUNTCODE')),
				   --EXECBROKER 	= MAX(DBO.GETACCOUNTCODE(LEFT(F.SAUDA_DATE,11),F.SYMBOL,@RPTREPORTNO,F.PARTY_CODE,'BROKERCODE')),
				   EXPIRYMONTH 	= UPPER(LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,109),3)),
				   EXPIRYYEAR 	= RIGHT(LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,109),11),4),
				   MERRYLCODE	= ISNULL(DBO.GETMERRYLCODE(F.SYMBOL),''),
				   SQUAREOFF	= (CASE WHEN SELL_BUY = 1 THEN 'Y' ELSE 'N' END),
				   DIRECTOR_NAME= ISNULL(DIRECTOR_NAME,'')

          FROM     #FOSETT F
                   LEFT OUTER JOIN MULTIISIN M WITH (NOLOCK)
                     ON (M.SCRIP_CD = F.SYMBOL
                         AND M.VALID = 1
						 /*AND M.SERIES = F.SERIES*/ )
                   /*LEFT OUTER JOIN BLOOMBERGMASTER B WITH (NOLOCK)
                     ON (B.SCRIP_CD = F.SYMBOL)
                   LEFT OUTER JOIN REUTERSCODEMASTER RT WITH (NOLOCK)
                     ON (RT.SYMBOL = F.SYMBOL
                         AND F.EXPIRYDATE LIKE LEFT(CONVERT(VARCHAR,RT.EXPIRYDATE,109),11) + '%')*/
                   LEFT OUTER JOIN UCC_CLIENT UC WITH (NOLOCK)
                     ON (UC.PARTY_CODE = F.PARTY_CODE),
                   FOSCRIP2 S2 WITH (NOLOCK),
                   CLIENT1 C1 WITH (NOLOCK)
				   LEFT OUTER JOIN BRANCHES BR WITH(NOLOCK) ON
				   (
		  			BR.SHORT_NAME = C1.TRADER 
				   )
                   LEFT OUTER JOIN CLIENT5 C5 WITH (NOLOCK) ON 
				   (
					C1.CL_CODE = C5.CL_CODE
				   ),
                   CLIENT2 C2 WITH (NOLOCK),
                   FOOWNER O WITH (NOLOCK),
                   BFOGLOBALS G WITH (NOLOCK)
          WHERE    C1.CL_CODE = C2.CL_CODE
                   AND C2.PARTY_CODE = F.PARTY_CODE
                   AND F.INST_TYPE = S2.INST_TYPE
                   AND F.SYMBOL = S2.SYMBOL
                   AND F.EXPIRYDATE = S2.EXPIRYDATE
                   AND F.STRIKE_PRICE = S2.STRIKE_PRICE
                   AND F.OPTION_TYPE = S2.OPTION_TYPE
                   AND F.TRADEQTY > 0
                   AND F.SAUDA_DATE >= @FROMDATE
                   AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'
                   AND G.YEAR_START_DT <= @FROMDATE
                   AND G.YEAR_END_DT >= @FROMDATE
                   AND F.PARTY_CODE >= @FROMPARTY
                   AND F.PARTY_CODE <= @TOPARTY
				   AND CL_STATUS = (CASE 
										WHEN @RPTREPORTNO = (SELECT SRNO FROM V2_INSTREPORT_SETTING WHERE RPT_NAME = 'PMS TRADE REPORT') THEN 'PMS'
									ELSE CL_STATUS
									END)
                   AND @STATUSNAME = (CASE 
                                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                        WHEN @STATUSID = 'AREA' THEN C1.AREA
                                        WHEN @STATUSID = 'REGION' THEN C1.REGION
                                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                        ELSE 'BROKER'
                                      END)
					
                                     
          GROUP BY /*C2.PARENTCODE,*/F.PARTY_CODE,LEFT(REPLACE(CONVERT(VARCHAR,SAUDA_DATE,@TDATEFORMAT),
                                @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN),(CASE 
                      WHEN @SETTDATE = '' THEN LEFT(REPLACE(CONVERT(VARCHAR,SAUDA_DATE + 1,@TDATEFORMAT),
                                                            @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                      ELSE LEFT(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SETTDATE,103),@TDATEFORMAT),
                                        @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                    END),
                   CONTRACTNO,LEFT(REPLACE(CONVERT(VARCHAR,F.EXPIRYDATE,@EDATEFORMAT),
                                @EDATEFREPLACE,@EDATEREPLACE),@EDATELEN),F.INST_TYPE,LEFT(F.INST_TYPE,3),
                   F.SYMBOL,(CASE 
                      WHEN F.INST_TYPE LIKE 'FUT%' THEN RTRIM(F.INST_TYPE) + ' ' + RTRIM(F.SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,113),11)
                      ELSE RTRIM(F.INST_TYPE) + ' ' + RTRIM(F.SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,113),11) + ' ' + RTRIM(CAST(CAST(F.STRIKE_PRICE AS NUMERIC(18,0)) AS VARCHAR)) + ' ' + RTRIM(F.OPTION_TYPE)
                    END),F.STRIKE_PRICE,F.OPTION_TYPE,
                   F.SEC_NAME,SELL_BUY,S2.C_REGULAR_LOT,C1.LONG_NAME,
                   PARTICIPANTCODE,ISNULL(O.MEMBERCODE,''),ISNULL(ISIN,''),
					ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                          ''),
                   ISNULL(DBO.GETCUSIP(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''), 
                   ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),ISNULL(O.COMPANY,''),ISNULL(O.ADDR1,''),
                   ISNULL(O.ADDR2,''),ISNULL(O.CITY,''),ISNULL(O.ZIP,''),ISNULL(O.PHONE,''),
                   ISNULL(O.SEBINO,''),ISNULL(UC.UCC_CODE,''),ISNULL(BR.SHORT_NAME,''),
				   ISNULL(BR.LONG_NAME,''),
                   CESS_TAX,SERVICE_CHRG,F.CL_TYPE,
                   (CASE 
                      WHEN LEFT(F.OPTION_TYPE,1) = 'C' THEN 'CALL'
                      WHEN LEFT(F.OPTION_TYPE,1) = 'P' THEN 'PUT'
                      ELSE ''
                    END),
					CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE WHEN SELL_BUY = 1 THEN DAY_PUC ELSE DAY_SALES END),2))),
					(CASE 
					WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN 
					'F'
					WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN
   						F.OPTION_TYPE
					ELSE 	''
					END),
					C1.WARD_NO,
					UPPER(LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,109),3)),
					RIGHT(LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,109),11),4),
					G.SERVICE_TAX,
					ISNULL(DBO.GETMERRYLCODE(F.SYMBOL),''),
					ISNULL(DIRECTOR_NAME,'')
                   
          ORDER BY TRADEDATE,
                   F.PARTY_CODE,
                   --C2.PARENTCODE,
                   F.SYMBOL,
                   SELL_BUY
                   
        END
      ELSE
        BEGIN
        
          SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
          
          SELECT   --PARENTCODE = C2.PARENTCODE,
                   PARTY_CODE = F.PARTY_CODE,
                   TRADEDATE = LEFT(REPLACE(CONVERT(VARCHAR,SAUDA_DATE,@TDATEFORMAT),
                                            @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN),
                   TRADEDTIME = CONVERT(VARCHAR,SAUDA_DATE,108),
                   SETTDATE = (CASE 
                                 WHEN @SETTDATE = '' THEN LEFT(REPLACE(CONVERT(VARCHAR,SAUDA_DATE + 1,@TDATEFORMAT),
                                                                       @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                                 ELSE LEFT(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SETTDATE,103),@TDATEFORMAT),
                                                   @TDATEFREPLACE,@TDATEREPLACE),@TDATELEN)
                               END),
                   ORDER_NO,
                   TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
                   CONTRACTNO,
                   INST_TYPE = F.INST_TYPE,
                   SYMBOL = F.SYMBOL,
                   EXPIRYDATE = LEFT(REPLACE(CONVERT(VARCHAR,F.EXPIRYDATE,@EDATEFORMAT),
                                             @EDATEFREPLACE,@EDATEREPLACE),@EDATELEN),
                   STRIKE_PRICE = F.STRIKE_PRICE,
                   OPTION_TYPE = F.OPTION_TYPE,
                   OPTION_TYPE_F = (CASE 
                                      WHEN F.OPTION_TYPE = '' THEN 'FF'
                                      ELSE F.OPTION_TYPE
                                    END),
                   SEC_NAME = F.SEC_NAME,
                   SELL_BUY = (CASE 
                                 WHEN SELL_BUY = 1 THEN 'BUY'
                                 ELSE 'SELL'
                               END),
                   SELL_BUYPS = (CASE 
                                   WHEN SELL_BUY = 1 THEN 'P'
                                   ELSE 'S'
                                 END),
                   SELL_BUY_O = SELL_BUY,
                   BOUGHT_SOLD = (CASE 
                                    WHEN SELL_BUY = 1 THEN 'BOUGHT'
                                    ELSE 'SOLD'
                                  END),
                   QTY = TRADEQTY,
                   QTYPLUS = (CASE 
                                WHEN SELL_BUY = 1 THEN TRADEQTY
                                ELSE -TRADEQTY
                              END),
                   BQTY = (CASE 
                             WHEN SELL_BUY = 1 THEN TRADEQTY
                             ELSE 0
                           END),
                   SQTY = (CASE 
                             WHEN SELL_BUY = 2 THEN TRADEQTY
                             ELSE 0
                           END),
                   CONTRACTS = (CASE 
                                  WHEN S2.C_REGULAR_LOT > 0 THEN (F.TRADEQTY / S2.C_REGULAR_LOT)
                                  ELSE F.TRADEQTY
                                END),
                   CONTRACTSBS = (CASE 
                                    WHEN SELL_BUY = 2 THEN -1
                                    ELSE 1
                                  END) * (CASE 
                                            WHEN S2.C_REGULAR_LOT > 0 THEN (F.TRADEQTY / S2.C_REGULAR_LOT)
                                            ELSE F.TRADEQTY
                                          END),
                   CONTRACTLOT = ISNULL(S2.C_REGULAR_LOT,0),
                   PRICE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(PRICE,4))),
                   PRICE2D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(PRICE,2))),
                   PRICE4D = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(PRICE,4))),
					BUYPRICE = (CASE WHEN SELL_BUY = 1 THEN 
					CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(PRICE,4)))
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(0,4))) 
					END),	
					SELLPRICE = (CASE WHEN SELL_BUY = 2 THEN 
					CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(PRICE,4)))
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(0,4))) 
					END),	
					ACTUALPRICE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(ACTUALPRICE,4))),
                   AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((TRADEQTY * PRICE),2))),
                   LOTAMOUNT = (CASE 
                                  WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                                                                       WHEN S2.C_REGULAR_LOT > 0 THEN (F.TRADEQTY / S2.C_REGULAR_LOT)
                                                                                                                       ELSE F.TRADEQTY
                                                                                                                     END) * (PRICE * ISNULL(S2.C_REGULAR_LOT,0)),
                                                                                                                    2)))
                                  ELSE ''/*CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),0))*/
                                END),
                   NETRATE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(NETRATE,4))),
                   NETRATESTT = (CASE 
                                   WHEN SELL_BUY = 1 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((NETRATE + INS_CHRG),4)))
                                   ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((NETRATE - INS_CHRG),4)))
                                 END),
                   NETAMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                              WHEN SELL_BUY = 1 THEN (AMOUNT)
                                                                              ELSE (AMOUNT)
                                                                            END),2))),
                   NETAMOUNTSTT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                                 WHEN SELL_BUY = 1 THEN (AMOUNT) + INS_CHRG
                                                                                 ELSE (AMOUNT) - INS_CHRG
                                                                               END),2))),
                   BROKRAGE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(BROKAPPLIED,4))),
                   TOTBROKRAGE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((TOTBROK),2))),
                   TOTBROKRAGESTT = (CASE 
                                   	WHEN SELL_BUY = 1 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((TOTBROK + INS_CHRG),2)))
                                   	ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((TOTBROK - INS_CHRG),2)))
                                 	END),
                   BROKRAGEPER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((BROKAPPLIED * 100) / PRICE,2))),
		   BROKRAGEPERNEW = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE WHEN SELL_BUY = 1 THEN DAY_PUC ELSE DAY_SALES END),2))),
                   CLEARINGCOMM = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                                 WHEN LEFT(F.INST_TYPE,3) = 'OPT' THEN (((F.STRIKE_PRICE * 0.01) / 100) * TRADEQTY)
                                                                                 ELSE (((PRICE * 0.01) / 100) * TRADEQTY)
                                                                               END),2))),
                   TOTBROKRAGESTTCLCOMM = (CASE 
                                   	WHEN SELL_BUY = 1 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((TOTBROK + INS_CHRG),2)))
                                   	ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((TOTBROK + INS_CHRG),2)))
                                 	END),
                   STT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                        WHEN INSURANCE_CHRG = 1 THEN INS_CHRG
                                                                        ELSE 0
                                                                      END),2))),
                   STTPER = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND((CASE 
                                                                           WHEN INSURANCE_CHRG = 1
                                                                                AND SELL_BUY = 2 THEN TRDSELLTRANS
                                                                           ELSE 0
                                                                         END),4))),
                   TURN_TAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                             WHEN C2.TURNOVER_TAX = 1 THEN TURN_TAX
                                                                             ELSE 0
                                                                           END),2))),
                   SEBI_TAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                             WHEN SEBI_TURN_TAX = 1 THEN SEBI_TAX
                                                                             ELSE 0
                                                                           END),2))),
                   OTHER_CHRG = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                               WHEN C2.OTHER_CHRG = 1 THEN F.OTHER_CHRG
                                                                               ELSE 0
                                                                             END),2))),
                   SERVICE_TAX = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                                WHEN SERVICE_CHRG = 0 THEN F.SERVICE_TAX
                                                                                ELSE 0
                                                                              END),2))),
                   BROKER_CHRG = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((CASE 
                                                                                WHEN BROKERNOTE = 1 THEN BROKER_CHRG
                                                                                ELSE 0
                                                                              END),2))),
                   PARTYNAME = C1.LONG_NAME,
                   PARTICIPANTCODE,
                   BROKERCODE = ISNULL(O.MEMBERCODE,''),
                   COMPANYNAME = ISNULL(O.COMPANY,''),
                   COMPANYADD1 = ISNULL(O.ADDR1,''),
                   COMPANYADD2 = ISNULL(O.ADDR2,''),
                   COMPANYCITY = ISNULL(O.CITY,''),
                   COMPANYZIP = ISNULL(O.ZIP,''),
                   COMPANYPHONE = ISNULL(O.PHONE,''),
                   COMPANYPSEBINO = ISNULL(O.SEBINO,''),
                   ISIN = ISNULL(ISIN,''),
                   RICCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                          F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                    ''),
                   CUSIP = ISNULL(DBO.GETCUSIP(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   REUTERCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                             F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),
                                       ''),
                   BLOOMBURGCODE = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   BLOOMBERG_TICKER = ISNULL(DBO.GETBLOOMBERGCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID),''),
                   NSECMBPID,
                   SEGMENT = 'D',
                   ARBITRAGE = 'N',
                   REUTERSCODE = ISNULL(DBO.GETRICCODE(S2.PRODUCT_TYPE,F.SYMBOL,LEFT(F.EXPIRYDATE,11),
                                                          F.STRIKE_PRICE,F.OPTION_TYPE,S2.SCRIP_ID,@RPTREPORTNO),''),
                   SCHEME = ISNULL(UC.UCC_CODE,''),
                   TRADER = ISNULL(BR.SHORT_NAME,''),
				   TRADERNAME = ISNULL(BR.LONG_NAME,''),
                   CL_TYPE = F.CL_TYPE,
                   CALLPUT = (CASE 
                                WHEN LEFT(F.OPTION_TYPE,1) = 'C' THEN 'CALL'
                                WHEN LEFT(F.OPTION_TYPE,1) = 'P' THEN 'PUT'
                                ELSE ''
                              END)
				   --ACCOUNTCODE = DBO.GETACCOUNTCODE(LEFT(F.SAUDA_DATE,11),F.SYMBOL,@RPTREPORTNO,F.PARTY_CODE,'ACCOUNTCODE'),
				   --EXECBROKER = DBO.GETACCOUNTCODE(LEFT(F.SAUDA_DATE,11),F.SYMBOL,@RPTREPORTNO,F.PARTY_CODE,'BROKERCODE')
                             
          FROM     #FOSETT F WITH (NOLOCK)
                   LEFT OUTER JOIN MULTIISIN M WITH (NOLOCK)
                     ON (M.SCRIP_CD = F.SYMBOL
                         AND M.VALID = 1
			 AND M.SERIES = F.SERIES)
                   /*LEFT OUTER JOIN BLOOMBERGMASTER B WITH (NOLOCK)
                     ON (B.SCRIP_CD = F.SYMBOL)
                   LEFT OUTER JOIN REUTERSCODEMASTER RT WITH (NOLOCK)
                     ON (RT.SYMBOL = F.SYMBOL
                         AND F.EXPIRYDATE LIKE LEFT(CONVERT(VARCHAR,RT.EXPIRYDATE,109),11) + '%')*/
                   LEFT OUTER JOIN UCC_CLIENT UC WITH (NOLOCK)
                     ON (UC.PARTY_CODE = F.PARTY_CODE),
                   FOSCRIP2 S2 WITH (NOLOCK),
                   CLIENT1 C1 WITH (NOLOCK)
		   LEFT OUTER JOIN BRANCHES BR WITH(NOLOCK) ON
		   (
		  	BR.SHORT_NAME = C1.TRADER 
		   ),
                   CLIENT2 C2 WITH (NOLOCK),
                   FOOWNER O WITH (NOLOCK),
                   MSAJAG.DBO.DELSEGMENT D WITH (NOLOCK),
                   BFOGLOBALS G WITH (NOLOCK),
                   V2_INST_PARTYMAPPING PM WITH (NOLOCK)
                   
          WHERE    C1.CL_CODE = C2.CL_CODE
                   AND C2.PARTY_CODE = F.PARTY_CODE
                   AND F.INST_TYPE = S2.INST_TYPE
                   AND F.SYMBOL = S2.SYMBOL
                   AND F.EXPIRYDATE = S2.EXPIRYDATE
                   AND F.STRIKE_PRICE = S2.STRIKE_PRICE
                   AND F.OPTION_TYPE = S2.OPTION_TYPE
                   AND F.TRADEQTY > 0
                   AND F.PARTY_CODE = PM.PARTY_CODE
                   AND PM.RPT_REPORT_NO = @RPTREPORTNO
                                          
                   AND F.SAUDA_DATE >= @FROMDATE
                   AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'
                   AND G.YEAR_START_DT <= @FROMDATE
                   AND G.YEAR_END_DT >= @FROMDATE
                   AND F.PARTY_CODE >= @FROMPARTY
                   AND F.PARTY_CODE <= @TOPARTY
                   AND @STATUSNAME = (CASE 
                                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                        WHEN @STATUSID = 'AREA' THEN C1.AREA
                                        WHEN @STATUSID = 'REGION' THEN C1.REGION
                                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                        ELSE 'BROKER'
                                      END)
                                     
          ORDER BY TRADEDATE,
                   F.PARTY_CODE,
                   --C2.PARENTCODE,
                   F.SYMBOL,
                   SELL_BUY
        END
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_TRADE_TRANSFER_ISETL
-- --------------------------------------------------

CREATE PROC [dbo].[V2_PROC_TRADE_TRANSFER_ISETL]
(
	@SAUDA_DATE      VARCHAR(11),
	@PARTYFROM       VARCHAR(10),
	@PARTYTO         VARCHAR(10),
	@INST_TYPE       VARCHAR(6) ,
	@SYMBOL          VARCHAR(20),
	@EXPIRY_DATE     VARCHAR(11),
	@STRIKE_PRICE    MONEY      ,
	@OPTION_TYPE     VARCHAR(2) ,
	@SELL_BUY       INT        ,
	@PARTICIPANTCODE VARCHAR(15),
	@CONTRACTNO      VARCHAR(7) ,
	@ORDER_NO    VARCHAR(16),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY       INT        ,
	@QTYTOTRANSFER   INT   ,
	@STATUSID	 VARCHAR(50) ='BROKER',
	@STRMODULE       VARCHAR(50) ='',
	@USERID 	VARCHAR(15) ='',
	@CONTRACTNONEW 	VARCHAR(7)=''
) AS



DECLARE
@TRADECURSOR     CURSOR     ,
@CONTRACTNOCUR   CURSOR     ,
@QTYINTRADE      INT        ,
@NEW_TRADE_NO    VARCHAR(14),
@NEW_CONTRACTNO  VARCHAR(7) ,
@BILLNO			 INT        ,
@STYLE           INT    ,
@CLTYPE			 VARCHAR(3) ,
@CONTSTYLE       CHAR(1) ,
@PARTICIPANTCODENEW VARCHAR(15),
@KEEPINST		TINYINT,
@NEW_CONTRACTNO_INT		INT ,
@@NRMSERIESPREFIX		VARCHAR(2),
@@NRMSERIESPREFIX_NEW	VARCHAR(2),
@@SERIESFLAG	INT

SET @KEEPINST = 1

SELECT @NEW_CONTRACTNO = 0

IF @STRMODULE <> ''
BEGIN
	EXEC CONSOLE_LOG  @PARTYFROM,@PARTYTO,@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
	@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACTNO,'',0,0,0,0,0,0,@ACTUALQTY,@QTYTOTRANSFER,0,@PARTICIPANTCODE,'',@STATUSID,@STRMODULE,'PROC_TRADE_TRANSFER_ISETL'
END

SELECT @CLTYPE = CL_TYPE,@CONTSTYLE=C2.INSCONT,@PARTICIPANTCODENEW=BANKID FROM CLIENT1 C1, CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = @PARTYTO

IF @CONTRACTNONEW <> ''
BEGIN
	SET @NEW_CONTRACTNO = @CONTRACTNONEW
END
ELSE
  BEGIN
  IF @CLTYPE <> 'PRO'
  BEGIN
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'S'
	BEGIN
	  SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYTO
			AND DUMMY1 = 0
            AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
            AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
            AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
            AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
            AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
          	AND RESERVED1 = 1
			AND TRADEQTY <> 0
			AND CONTRACTNO <> 0
	END
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'O'
	BEGIN
	  SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYTO
			AND DUMMY1 = 0
            AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
            AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
            AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
            AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
            AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
          	AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
			AND RESERVED1 = 1
			AND TRADEQTY <> 0
			AND CONTRACTNO <> 0
	END
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'N'
	BEGIN
	    SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT WHERE PARTY_CODE = @PARTYTO
		AND DUMMY1 = 0 AND RESERVED1 = 1 AND TRADEQTY <> 0  AND CONTRACTNO <> 0
		AND SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	END


	IF LEN(@NEW_CONTRACTNO) = 1
	BEGIN
	
		SELECT 
			 @@SERIESFLAG = SERIESFLAG ,
			 @NEW_CONTRACTNO_INT = CASE WHEN SERIESFLAG = 0
										THEN
											CONVERT(INT,RIGHT(CONTRACTNO,LEN(CONTRACTNO)-LEN(RTRIM(NRMSERIESPREFIX))))
										ELSE
											CONVERT(INT,RIGHT(INSTCONTRACTNO,LEN(INSTCONTRACTNO)-LEN(RTRIM(INSSERIESPREFIX))))
										END,
			 @@NRMSERIESPREFIX = CASE WHEN SERIESFLAG = 0 THEN RTRIM(NRMSERIESPREFIX) ELSE RTRIM(INSSERIESPREFIX) END
		FROM CONTGEN 
		WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
				
		IF @@SERIESFLAG = 0
		BEGIN
		
			SET @NEW_CONTRACTNO = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
									 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = 'I'
												THEN 'AA' + 
													 RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 5)
												ELSE 
													(CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
														  THEN 'A' +  
															  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 6)		
														  ELSE 
															  (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																	THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																	ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
															   END) 
																+ RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 
																7 - LEN((CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																			  THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																			  ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																		  END)))	
													 END)
												END)
									 ELSE RTRIM(@@NRMSERIESPREFIX) + 
										  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 7-LEN(RTRIM(@@NRMSERIESPREFIX)))
								END)
								
				SET @@NRMSERIESPREFIX_NEW = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
									 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = 'I'
												THEN 'AA' 
												ELSE (CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
														   THEN 'A'
														   ELSE (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																	THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																	ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
															   END)
													  END)
												END)
									 ELSE RTRIM(@@NRMSERIESPREFIX) 
								END)
		
				UPDATE CONTGEN SET CONTRACTNO = @NEW_CONTRACTNO ,NRMSERIESPREFIX = @@NRMSERIESPREFIX_NEW
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
		END
		ELSE
		BEGIN
			   SET @NEW_CONTRACTNO = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
										 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = '['
													THEN 'IA' + 
														 RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 5)
													ELSE 
														(CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
															  THEN 'I' +  
																  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 6)		
															  ELSE 
																  (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																		THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																		ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																   END) 
																	+ RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 
																	7 - LEN((CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																				  THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																				  ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																			  END)))	
														 END)
													END)
										 ELSE RTRIM(@@NRMSERIESPREFIX) + 
											  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 7-LEN(RTRIM(@@NRMSERIESPREFIX)))
									END)
									
					SET @@NRMSERIESPREFIX_NEW = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
										 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = '['
													THEN 'IA' 
													ELSE (CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
															   THEN 'I'
															   ELSE (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																		THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																		ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																   END)
														  END)
													END)
										 ELSE RTRIM(@@NRMSERIESPREFIX) 
									END)
		
				UPDATE CONTGEN SET INSTCONTRACTNO = @NEW_CONTRACTNO ,INSSERIESPREFIX = @@NRMSERIESPREFIX_NEW
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
		END
	END
	ELSE
	BEGIN
	  SELECT @NEW_CONTRACTNO = STUFF('0000000', 8 - LEN(@NEW_CONTRACTNO), LEN(@NEW_CONTRACTNO), @NEW_CONTRACTNO)
	END
 END
END

SELECT 
	CONTRACTNO,TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,
	BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
	TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
	ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
INTO #BFOSETTLEMENT FROM BFOSETTLEMENT WHERE 1 = 2

SELECT @BILLNO = 0

IF @ACTUALQTY = @QTYTOTRANSFER
BEGIN
 INSERT INTO #BFOSETTLEMENT
 SELECT   
	CONTRACTNO=@NEW_CONTRACTNO,TRADE_NO=LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,
	BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE=CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 
	THEN 'INST' ELSE @PARTICIPANTCODENEW END ELSE PARTICIPANTCODE END,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
	TERMINALID,ORDER_NO,PARTY_CODE=@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
	ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
 FROM BFOSETTLEMENT
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
        AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
        AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
        AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
        AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
        AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		AND TRADEQTY > 0
		AND DUMMY1 <> '1'
		
	INSERT INTO INST_LOG
	(
		PARTY_CODE,
		NEW_PARTY_CODE,
		SAUDA_DATE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		ORDER_NO,
		TRADE_NO,
		SELL_BUY,
		CONTRACT_NO,
		NEW_CONTRACT_NO,
		BROKERAGE,
		NEW_BROKERAGE,
		MARKET_RATE,
		NEW_MARKET_RATE,
		NET_RATE,
		NEW_NET_RATE,
		QTY,
		NEW_QTY,
		ROUNDTO,
		PARTICIPANT_CODE,
		NEW_PARTICIPANT_CODE,
		USERNAME,
		MODULE,
		CALLED_FROM,
		TIMESTAMP,
		EXTRAFIELD3,
		EXTRAFIELD4,
		EXTRAFIELD5
	)
	SELECT
		PARTY_CODE = @PARTYFROM,
		NEW_PARTY_CODE = @PARTYTO,
		SAUDA_DATE = @SAUDA_DATE,
		INST_TYPE = PRODUCT_CODE,
		SYMBOL = SERIES_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE = OPTION_TYPE,
		ORDER_NO = '%',
		TRADE_NO = '%',
		SELL_BUY,
		CONTRACTNO,
		NEW_CONTRACT_NO = @NEW_CONTRACTNO,
		BROKERAGE = 0,
		NEW_BROKERAGE = 0,
		MARKET_RATE = 0,
		NEW_MARKET_RATE = 0,
		NET_RATE = 0,
		NEW_NET_RATE = 0,
		QTY = 0,
		NEW_QTY = 0,
		ROUNDTO = 0, 
		PARTICIPANT_CODE = @PARTICIPANTCODE,
		NEW_PARTICIPANT_CODE = PARTICIPANTCODE,
		USERNAME = @STATUSID,
		MODULE = @STRMODULE,
		CALLED_FROM = 'V2_PROC_TRADE_TRANSFER_ISETL',
		TIMESTAMP = GETDATE(),
		EXTRAFIELD3 = '',
		EXTRAFIELD4 = '',
		EXTRAFIELD5 = ''
	FROM
		#BFOSETTLEMENT
		
 UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,
	SERVICE_TAX = 0,   TRADE_AMOUNT = 0,
 INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
        AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
        AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
        AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
        AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
        AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		AND TRADEQTY > 0
		AND DUMMY1 <> '1'

   INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
   TRUNCATE TABLE #BFOSETTLEMENT

END
ELSE
BEGIN
    SET @TRADECURSOR = CURSOR FOR
        SELECT TRADEQTY, TRADE_NO,ORDER_NO FROM BFOSETTLEMENT
        WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
        AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
        AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
        AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
        AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
        AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		AND TRADEQTY > 0
		AND DUMMY1 <> '1'
 ORDER BY TRADEQTY DESC

        OPEN @TRADECURSOR
        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO, @ORDER_NO
 WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0
 BEGIN
  IF @QTYTOTRANSFER >= @QTYINTRADE
  BEGIN
   INSERT INTO #BFOSETTLEMENT
	SELECT 
	
	CONTRACTNO=@NEW_CONTRACTNO,TRADE_NO=LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,
	BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE=CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 
	THEN 'INST' ELSE @PARTICIPANTCODENEW END ELSE PARTICIPANTCODE END,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
	TERMINALID,ORDER_NO,PARTY_CODE=@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
	ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS

	FROM BFOSETTLEMENT
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
		AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		AND TRADEQTY = @QTYINTRADE
		AND TRADEQTY > 0
		AND DUMMY1 <> '1'
INSERT INTO INST_LOG
	(
		PARTY_CODE,
		NEW_PARTY_CODE,
		SAUDA_DATE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		ORDER_NO,
		TRADE_NO,
		SELL_BUY,
		CONTRACT_NO,
		NEW_CONTRACT_NO,
		BROKERAGE,
		NEW_BROKERAGE,
		MARKET_RATE,
		NEW_MARKET_RATE,
		NET_RATE,
		NEW_NET_RATE,
		QTY,
		NEW_QTY,
		ROUNDTO,
		PARTICIPANT_CODE,
		NEW_PARTICIPANT_CODE,
		USERNAME,
		MODULE,
		CALLED_FROM,
		TIMESTAMP,
		EXTRAFIELD3,
		EXTRAFIELD4,
		EXTRAFIELD5
	)
	SELECT
		PARTY_CODE = @PARTYFROM,
		NEW_PARTY_CODE = @PARTYTO,
		SAUDA_DATE = @SAUDA_DATE,
		INST_TYPE = PRODUCT_CODE,
		SYMBOL = SERIES_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE = OPTION_TYPE,
		ORDER_NO = '%',
		TRADE_NO = '%',
		SELL_BUY,
		CONTRACTNO,
		NEW_CONTRACT_NO = @NEW_CONTRACTNO,
		BROKERAGE = 0,
		NEW_BROKERAGE = 0,
		MARKET_RATE = 0,
		NEW_MARKET_RATE = 0,
		NET_RATE = 0,
		NEW_NET_RATE = 0,
		QTY = 0,
		NEW_QTY = 0,
		ROUNDTO = 0, 
		PARTICIPANT_CODE = @PARTICIPANTCODE,
		NEW_PARTICIPANT_CODE = PARTICIPANTCODE,
		USERNAME = @STATUSID,
		MODULE = @STRMODULE,
		CALLED_FROM = 'V2_PROC_TRADE_TRANSFER_ISETL',
		TIMESTAMP = GETDATE(),
		EXTRAFIELD3 = '',
		EXTRAFIELD4 = '',
		EXTRAFIELD5 = ''
	FROM
		#BFOSETTLEMENT

   UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,
   SERVICE_TAX = 0,  TRADE_AMOUNT = 0,
   INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
		AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @NEW_TRADE_NO = '%' THEN TRADE_NO ELSE @NEW_TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		AND TRADEQTY = @QTYINTRADE
		AND TRADEQTY > 0
		AND DUMMY1 <> '1'

   INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
   TRUNCATE TABLE #BFOSETTLEMENT

   SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINTRADE
  END
  ELSE
  BEGIN
   INSERT INTO #BFOSETTLEMENT
   SELECT 
   
		CONTRACTNO=@NEW_CONTRACTNO,TRADE_NO=LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
		EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY=@QTYTOTRANSFER,SETT_FLAG,CA_LEVEL,
		BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE=CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 
		THEN 'INST' ELSE @PARTICIPANTCODENEW END ELSE PARTICIPANTCODE END,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
		TERMINALID,ORDER_NO,PARTY_CODE=@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
		TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
		ROUND_TO,TRADE_AMOUNT=@QTYTOTRANSFER*TRADE_PRICE,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
		SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
   FROM BFOSETTLEMENT
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
		AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @NEW_TRADE_NO = '%' THEN TRADE_NO ELSE @NEW_TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		AND TRADEQTY = @QTYINTRADE
		AND TRADEQTY > 0
		AND DUMMY1 <> '1'
INSERT INTO INST_LOG
	(
		PARTY_CODE,
		NEW_PARTY_CODE,
		SAUDA_DATE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		ORDER_NO,
		TRADE_NO,
		SELL_BUY,
		CONTRACT_NO,
		NEW_CONTRACT_NO,
		BROKERAGE,
		NEW_BROKERAGE,
		MARKET_RATE,
		NEW_MARKET_RATE,
		NET_RATE,
		NEW_NET_RATE,
		QTY,
		NEW_QTY,
		ROUNDTO,
		PARTICIPANT_CODE,
		NEW_PARTICIPANT_CODE,
		USERNAME,
		MODULE,
		CALLED_FROM,
		TIMESTAMP,
		EXTRAFIELD3,
		EXTRAFIELD4,
		EXTRAFIELD5
	)
	SELECT
		PARTY_CODE = @PARTYFROM,
		NEW_PARTY_CODE = @PARTYTO,
		SAUDA_DATE = @SAUDA_DATE,
		INST_TYPE = PRODUCT_CODE,
		SYMBOL = SERIES_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE = OPTION_TYPE,
		ORDER_NO = '%',
		TRADE_NO = '%',
		SELL_BUY,
		CONTRACTNO,
		NEW_CONTRACT_NO = @NEW_CONTRACTNO,
		BROKERAGE = 0,
		NEW_BROKERAGE = 0,
		MARKET_RATE = 0,
		NEW_MARKET_RATE = 0,
		NET_RATE = 0,
		NEW_NET_RATE = 0,
		QTY = 0,
		NEW_QTY = 0,
		ROUNDTO = 0, 
		PARTICIPANT_CODE = @PARTICIPANTCODE,
		NEW_PARTICIPANT_CODE = PARTICIPANTCODE,
		USERNAME = @STATUSID,
		MODULE = @STRMODULE,
		CALLED_FROM = 'V2_PROC_TRADE_TRANSFER_ISETL',
		TIMESTAMP = GETDATE(),
		EXTRAFIELD3 = '',
		EXTRAFIELD4 = '',
		EXTRAFIELD5 = ''
	FROM
		#BFOSETTLEMENT
   UPDATE BFOSETTLEMENT SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER, TRADE_AMOUNT = (TRADEQTY - @QTYTOTRANSFER)*TRADE_PRICE
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
		AND PARTY_CODE = @PARTYFROM
		AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
		AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
		AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 1
		AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
		AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
		AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @NEW_TRADE_NO = '%' THEN TRADE_NO ELSE @NEW_TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		AND TRADEQTY > 0
		AND DUMMY1 <> '1'

	INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
    TRUNCATE TABLE #BFOSETTLEMENT

	SELECT @QTYTOTRANSFER = 0
  END
         FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO, @ORDER_NO
 END
 CLOSE @TRADECURSOR
 DEALLOCATE @TRADECURSOR
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_TRADE_TRANSFER_RECAL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_PROC_TRADE_TRANSFER_RECAL] 
(
	@SAUDA_DATE      VARCHAR(11),  
	@PARTY_CODE      VARCHAR(10),  
	@INST_TYPE       VARCHAR(6) ,  
	@SYMBOL          VARCHAR(20),  
	@EXPIRY_DATE     VARCHAR(11),  
	@STRIKE_PRICE    MONEY      ,  
	@OPTION_TYPE     VARCHAR(2)   ,
	@STATUID 	VARCHAR(10) ='BROKER',
	@STATUNAME 	VARCHAR(20) =''
)
AS

IF RIGHT(@INST_TYPE,3) = 'FUT'
BEGIN
	SET @OPTION_TYPE = ''
END

SELECT @OPTION_TYPE = (CASE WHEN @OPTION_TYPE = '' THEN '%' ELSE @OPTION_TYPE END)

  UPDATE BFOSETTLEMENT 
  SET    TABLE_NO = BROKTABLE.TABLE_NO, 
         LINE_NO = BROKTABLE.LINE_NO, 
         VAL_PERC = BROKTABLE.VAL_PERC, 
         NORMAL = BROKTABLE.NORMAL, 
         DAY_PUC = BROKTABLE.DAY_PUC, 
         DAY_SALES = BROKTABLE.DAY_SALES, 
         SETT_PURCH = BROKTABLE.SETT_PURCH, 
         SETT_SALES = BROKTABLE.SETT_SALES, 
         BROKAPPLIED = (CASE 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((BROKTABLE.NORMAL * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((BROKTABLE.NORMAL * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((((BROKTABLE.NORMAL *
						F.MULTIPLIER * F.MPRICE)  / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((((BROKTABLE.NORMAL *
						F.MULTIPLIER  * F.MPRICE) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER))
						* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN 
						((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER  * F.MPRICE) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) 
						+ FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.DAY_SALES * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN 
						((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER  * F.MPRICE) / 100)*
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_PURCH * F.MULTIPLIER * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') 
						THEN ((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER  * F.MPRICE) / 100)* 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_SALES * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') 
						THEN ((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER  * F.MPRICE) / 100)*
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  ELSE 0 
					END), 
          
         NETRATE = (CASE 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.MARKETRATE) +
						((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.MARKETRATE) -
						((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER * F.MPRICE))  / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER  * F.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) +
						((FLOOR(((((BROKTABLE.DAY_PUC * F.MULTIPLIER * F.MPRICE))  / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG 
						+ FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR(((((BROKTABLE.DAY_SALES * F.MULTIPLIER  * F.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR(((((BROKTABLE.SETT_PURCH * F.MULTIPLIER  * F.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR(((((BROKTABLE.SETT_SALES * F.MULTIPLIER  * F.MPRICE)) / 100)*
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      ELSE 0 
                    END), 
         AMOUNT = (CASE 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN BFOSETTLEMENT.TRADEQTY *
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER * F.MPRICE))  / 100)*
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN BFOSETTLEMENT.TRADEQTY *
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER  * F.MPRICE)) / 100)* 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY *
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(((((BROKTABLE.DAY_PUC * F.MULTIPLIER  * F.MPRICE)) / 100)* 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(((((BROKTABLE.DAY_SALES * F.MULTIPLIER  * F.MPRICE)) / 100)* 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(((((BROKTABLE.SETT_PURCH * F.MULTIPLIER  * F.MPRICE)) / 100)*
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
					WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(((((BROKTABLE.SETT_SALES * F.MULTIPLIER  * F.MPRICE)) / 100)*
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     ELSE 0 
                   END), 
         INS_CHRG = 0, 
         TURN_TAX = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_TURNOVER_TAX 
					ELSE OPT_TURNOVER_TAX 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         OTHER_CHRG = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_OTHER_CHRG 
					ELSE OPT_OTHER_CHRG 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         SEBI_TAX = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_SEBITURN_TAX 
					ELSE OPT_SEBITURN_TAX 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         BROKER_CHRG = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKER_NOTE 
					ELSE OPT_BROKER_NOTE 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         SERVICE_TAX = CASE 
					 WHEN CLIENT2.SERVICE_CHRG = 1 
						  AND CLIENT2.SERTAXMETHOD = 1 THEN 0 
					 ELSE (CASE 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						   AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.NORMAL * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 1 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER  * F.MPRICE) / 100)* 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 2 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.DAY_PUC * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 2 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER * F.MPRICE)  / 100)*
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 3 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.DAY_SALES * F.MULTIPLIER) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 3 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER  * F.MPRICE) / 100)*
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 4 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.SETT_PURCH * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 4 
							AND BROKTABLE.VAL_PERC = 'P') THEN
							((FLOOR(((((((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER  * F.MPRICE) / 100)*
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 5 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.SETT_SALES * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) *
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 5 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER  * F.MPRICE) / 100)* 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 ELSE 0 
						 END) 
				   END, 
         TRADE_AMOUNT = BFOSETTLEMENT.TRADEQTY * BFOSETTLEMENT.MARKETRATE 
  FROM   BROKTABLE, 
         (SELECT SDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
                 F.TRADE_NO, 
                 F.PRODUCT_CODE, 
                 F.PRODUCT_TYPE, 
                 F.PARTY_CODE, 
                 F.SERIES_CODE, 
                 F.SERIES_ID, 
                 S2.EXPIRYDATE, 
                 F.USER_ID, 
                 F.SELL_BUY, 
                 F.TRADEQTY, 
                 F.MARKETRATE, 
                 F.CL_TYPE, 
                 F.OPPMEMCODE, 
                 F.OPPTRADERCODE, 
                 S2.STRIKEPRICE, 
                 F.SAUDA_DATE, 
                 F.ORDER_DATE, 
                 F.ORDER_NO, 
                 F.SETTFLAG, 
                 F.GROUPID, 
                 F.TRADERCODE, 
                 TRAN_CAT, 
                 OFF_PHONE1, 
                 MPRICE = (CASE 
                         WHEN C2.DUMMY1 = 0 THEN MARKETRATE 
                         ELSE (
							CASE 
                             WHEN C2.DUMMY1 = 1 THEN (
								CASE 
                                WHEN S2.STRIKEPRICE = 0 THEN F.MARKETRATE 
                                ELSE S2.STRIKEPRICE 
                                END) 
                             ELSE S2.STRIKEPRICE + MARKETRATE 
                           END) 
                       END), 
                 MULTIPLIER = 1, 
                 MARKETLOT 
          FROM   BFOSETTLEMENT F, 
                 CLIENT2 C2, 
                 BFOSCRIP2 S2, 
                 CLIENT1 C1 
          WHERE  C2.PARTY_CODE = F.PARTY_CODE 
                 AND C1.CL_CODE = C2.CL_CODE 
                 AND F.PRODUCT_TYPE = S2.PRODUCT_TYPE 
                 AND F.PRODUCT_CODE = S2.PRODUCT_CODE 
                 AND F.SERIES_CODE = S2.SERIES_CODE 
                 AND F.SERIES_ID = S2.SERIES_ID 
                                    
                 AND F.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
                 AND F.STATUS <> 'E' 
                 AND F.PARTY_CODE = @PARTY_CODE 
                 AND F.PRODUCT_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN F.PRODUCT_TYPE ELSE @OPTION_TYPE END 
                 AND F.PRODUCT_CODE = CASE WHEN @INST_TYPE = '%' THEN F.PRODUCT_CODE ELSE @INST_TYPE END  
                 AND F.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
                 AND F.STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END 
                 AND F.SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN F.SERIES_CODE ELSE @SYMBOL END) F, 
         BFOGLOBALS, 
         CLIENT1, 
         CLIENT2, 
    (SELECT   SDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
                   T1.PARTY_CODE, 
                   T1.PRODUCT_TYPE, 
                   T1.PRODUCT_CODE, 
                   T1.SERIES_CODE, 
                   T1.SERIES_ID, 
                   PQTY = SUM(CASE 
                                WHEN SELL_BUY = 1 THEN TRADEQTY 
                                ELSE 0 
                              END), 
                   SQTY = SUM(CASE 
                                WHEN SELL_BUY = 2 THEN TRADEQTY 
                                ELSE 0 
                              END), 
                   STRIKEPRICE = ISNULL((SELECT DISTINCT BS.STRIKEPRICE 
                                         FROM   BFOSCRIP2 BS 
                                         WHERE  BS.PRODUCT_CODE = T1.PRODUCT_CODE 
                                                AND BS.PRODUCT_TYPE = T1.PRODUCT_TYPE 
                                                AND BS.SERIES_CODE = T1.SERIES_CODE 
                                                AND BS.SERIES_ID = T1.SERIES_ID), 
                                        0), 
                   PRATE = (CASE 
                              WHEN SUM(CASE 
                                         WHEN SELL_BUY = 1 THEN TRADEQTY 
                                         ELSE 0 
                                       END) > 0 THEN SUM(CASE 
                                                           WHEN SELL_BUY = 1 THEN TRADEQTY * MARKETRATE 
                                                           ELSE 0 
                                                         END) / SUM(CASE 
                                                                      WHEN SELL_BUY = 1 THEN TRADEQTY 
                                                                      ELSE 0 
                                                                    END) 
                              ELSE 0 
                            END), 
                   SRATE = (CASE 
                              WHEN SUM(CASE 
                                         WHEN SELL_BUY = 2 THEN TRADEQTY 
                                         ELSE 0 
                                       END) > 0 THEN SUM(CASE 
                                                           WHEN SELL_BUY = 2 THEN TRADEQTY * MARKETRATE 
                                                           ELSE 0 
                                                         END) / SUM(CASE 
                                                                      WHEN SELL_BUY = 2 THEN TRADEQTY 
                                                                      ELSE 0 
                                                                    END) 
                              ELSE 0 
                            END) 
          FROM     BFOSETTLEMENT T1 
          WHERE    T1.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
                   AND T1.STATUS <> 'E' 
                   AND T1.PARTY_CODE = @PARTY_CODE 
                   AND T1.PRODUCT_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN T1.PRODUCT_TYPE ELSE @OPTION_TYPE END
                   AND T1.PRODUCT_CODE = CASE WHEN @INST_TYPE = '%' THEN T1.PRODUCT_CODE ELSE @INST_TYPE END 
                   AND T1.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
                   AND T1.STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN T1.STRIKE_PRICE ELSE @STRIKE_PRICE END 
                   AND T1.SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN T1.SERIES_CODE ELSE @SYMBOL END 
          GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),T1.PARTY_CODE,T1.PRODUCT_TYPE,T1.PRODUCT_CODE, 
                   T1.SERIES_CODE,T1.SERIES_ID) S, 
         FOCLIENTTAXES, 
         FOCLIENTBROKSCHEME 
  WHERE  BFOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO 
         AND BFOSETTLEMENT.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO 
         AND F.PARTY_CODE = CLIENT2.PARTY_CODE 
         AND CLIENT1.CL_CODE = CLIENT2.CL_CODE 
         AND F.PARTY_CODE = S.PARTY_CODE 
         AND F.PRODUCT_TYPE = S.PRODUCT_TYPE 
         AND F.PRODUCT_CODE = S.PRODUCT_CODE 
         AND F.SERIES_CODE = S.SERIES_CODE 
         AND F.SERIES_ID = S.SERIES_ID 
         AND BROKTABLE.TABLE_NO = (CASE 
                                     WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
                                     ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
                                   END) 
         AND BROKTABLE.LINE_NO = (CASE 
                                    WHEN (FOCLIENTBROKSCHEME.BROK_SCHEME = 1 
		                            OR FOCLIENTBROKSCHEME.BROK_SCHEME = 5) THEN 
									(SELECT MIN(BROKTABLE.LINE_NO) 
									FROM   BROKTABLE 
									WHERE  BROKTABLE.TABLE_NO = (CASE 
									WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE -- F.STD_RATE       
									ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
									END) 
									AND TRD_DEL = (CASE 
													WHEN S.PQTY >= S.SQTY THEN (CASE 
														  WHEN (F.SELL_BUY = 1) THEN 'F' 
														  ELSE 'S' 
														END) 
													ELSE (CASE 
															WHEN (F.SELL_BUY = 2) THEN 'F' 
															ELSE 'S' 
														  END) 
												  END) 
									AND F.PARTY_CODE = S.PARTY_CODE 
                                                   AND F.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN (FOCLIENTBROKSCHEME.BROK_SCHEME = 3 
                                           OR FOCLIENTBROKSCHEME.BROK_SCHEME = 6) THEN 
										(SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = (CASE 
										WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
										ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
										END) 
										AND TRD_DEL = (CASE 
										WHEN S.PQTY > S.SQTY THEN (CASE 
													 WHEN (F.SELL_BUY = 1) THEN 'F' 
													 ELSE 'S' 
												   END) 
										ELSE (CASE 
										WHEN (F.SELL_BUY = 2) THEN 'F' 
										ELSE 'S' 
										END) 
										END) 
										AND F.PARTY_CODE = S.PARTY_CODE 
										AND F.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 2 THEN 
										(SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = (CASE 
											 WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE 
											 ELSE OPT_BROKTABLE 
										   END)-- F.STD_RATE                                                         
										AND TRD_DEL = (CASE 
										WHEN S.PQTY = S.SQTY THEN (CASE 
										   WHEN S.PRATE >= S.SRATE THEN (CASE 
													   WHEN (F.SELL_BUY = 1) THEN 'F' 
													   ELSE 'S' 
													 END) 
										   ELSE (CASE 
												   WHEN (F.SELL_BUY = 2) THEN 'F' 
												   ELSE 'S' 
												 END) 
										 END) 
										ELSE (CASE 
											  WHEN S.PQTY >= S.SQTY THEN (
													CASE 
													WHEN (F.SELL_BUY = 1) THEN 'F' 
													ELSE 'S' 
												  END) 
											  ELSE (CASE 
													  WHEN (F.SELL_BUY = 2) THEN 'F' 
													  ELSE 'S' 
													END) 
											END) 
										END) 
										AND F.PARTY_CODE = S.PARTY_CODE 
										AND F.MARKETRATE <= BROKTABLE.UPPER_LIM) 
                                    ELSE (SELECT MIN(LINE_NO) 
                                          FROM   BROKTABLE 
   WHERE  F.MPRICE <= BROKTABLE.UPPER_LIM 
                                                 AND BROKTABLE.TABLE_NO = (
												CASE 
                                                 WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
                                                 ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
                                               END)) 
                              END) 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
         AND BFOSETTLEMENT.TRADE_NO = F.TRADE_NO 
         AND BFOSETTLEMENT.ORDER_NO = F.ORDER_NO 
         AND BFOSETTLEMENT.SELL_BUY = F.SELL_BUY 
         AND BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE 
         AND BFOSETTLEMENT.PRODUCT_TYPE = F.PRODUCT_TYPE 
         AND BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE 
         AND BFOSETTLEMENT.SERIES_ID = F.SERIES_ID 
         AND BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
         AND BFOSETTLEMENT.STATUS <> 'E' 
         AND BFOSETTLEMENT.PARTY_CODE = @PARTY_CODE 
         AND BFOSETTLEMENT.PRODUCT_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN BFOSETTLEMENT.PRODUCT_TYPE ELSE @OPTION_TYPE END 
         AND BFOSETTLEMENT.PRODUCT_CODE = CASE WHEN @INST_TYPE = '%' THEN BFOSETTLEMENT.PRODUCT_CODE ELSE @INST_TYPE END  
         AND BFOSETTLEMENT.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
         AND BFOSETTLEMENT.STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN BFOSETTLEMENT.STRIKE_PRICE ELSE @STRIKE_PRICE END 
         AND BFOSETTLEMENT.SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN BFOSETTLEMENT.SERIES_CODE ELSE @SYMBOL END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_TRADE_TRANSFER_SETL
-- --------------------------------------------------

CREATE  PROC [dbo].[V2_PROC_TRADE_TRANSFER_SETL]
(
	@SAUDA_DATE      VARCHAR(11),
	@PARTYFROM       VARCHAR(10),
	@PARTYTO         VARCHAR(10),
	@INST_TYPE       VARCHAR(6) ,
	@SYMBOL          VARCHAR(20),
	@EXPIRY_DATE     VARCHAR(11),
	@STRIKE_PRICE    MONEY      ,
	@OPTION_TYPE     VARCHAR(2) ,
	@SELL_BUY       INT        ,
	@PARTICIPANTCODE VARCHAR(15),
	@CONTRACTNO      VARCHAR(7) ,
	@ORDER_NO    VARCHAR(20),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY       INT        ,
	@QTYTOTRANSFER   INT   ,
	@STATUSID	 VARCHAR(50) ='BROKER',
	@STRMODULE       VARCHAR(50) ='',
	@USERID 	VARCHAR(15) ='',
	@CONTRACTNONEW 	VARCHAR(7)=''
) AS



DECLARE
@TRADECURSOR     CURSOR     ,
@CONTRACTNOCUR   CURSOR     ,
@QTYINTRADE      INT        ,
@NEW_TRADE_NO    VARCHAR(14),
@NEW_CONTRACTNO  VARCHAR(7) ,
@BILLNO			 INT        ,
@STYLE           INT    ,
@CLTYPE			 VARCHAR(3) ,
@CONTSTYLE       CHAR(1) ,
@PARTICIPANTCODENEW VARCHAR(15),
@NEW_CONTRACTNO_INT		INT ,
@@NRMSERIESPREFIX		VARCHAR(2),
@@NRMSERIESPREFIX_NEW	VARCHAR(2),
@@SERIESFLAG	INT


SELECT @NEW_CONTRACTNO = 0

IF @STRMODULE <> ''
BEGIN
	EXEC CONSOLE_LOG  @PARTYFROM,@PARTYTO,@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
	@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACTNO,'',0,0,0,0,0,0,@ACTUALQTY,@QTYTOTRANSFER,0,@PARTICIPANTCODE,'',@STATUSID,@STRMODULE,'PROC_TRADE_TRANSFER_ISETL'
END

SELECT @CLTYPE = CL_TYPE,@CONTSTYLE=C2.INSCONT,@PARTICIPANTCODENEW=BANKID FROM CLIENT1 C1, CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = @PARTYTO

IF @CONTRACTNONEW <> ''
BEGIN
	SET @NEW_CONTRACTNO = @CONTRACTNONEW
END
ELSE
  BEGIN
  IF @CLTYPE <> 'PRO'
  BEGIN
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'S'
	BEGIN
	  SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYTO
			AND DUMMY1 = 0
            AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
            AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
            AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
            AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
            AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
          	AND RESERVED1 = 0
			AND TRADEQTY <> 0
			AND CONTRACTNO <> 0
	END
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'O'
	BEGIN
	  SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYTO
			AND DUMMY1 = 0
            AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
            AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
            AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
            AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
            AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
          	AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
			AND RESERVED1 = 0
			AND TRADEQTY <> 0
			AND CONTRACTNO <> 0
	END
	IF /*@PARTYFROM <> @PARTYTO AND*/ @CONTSTYLE = 'N'
	BEGIN
	    SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM BFOSETTLEMENT WHERE PARTY_CODE = @PARTYTO
		AND DUMMY1 = 0 AND RESERVED1 = 0 AND TRADEQTY <> 0  AND CONTRACTNO <> 0
		AND SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	END


	IF LEN(@NEW_CONTRACTNO) = 1
	BEGIN
	
		SELECT 
			 @@SERIESFLAG = SERIESFLAG ,
			 @NEW_CONTRACTNO_INT = CASE WHEN SERIESFLAG = 0
										THEN
											CONVERT(INT,RIGHT(CONTRACTNO,LEN(CONTRACTNO)-LEN(RTRIM(NRMSERIESPREFIX))))
										ELSE
											CONVERT(INT,RIGHT(INSTCONTRACTNO,LEN(INSTCONTRACTNO)-LEN(RTRIM(INSSERIESPREFIX))))
										END,
			 @@NRMSERIESPREFIX = CASE WHEN SERIESFLAG = 0 THEN RTRIM(NRMSERIESPREFIX) ELSE RTRIM(INSSERIESPREFIX) END
		FROM CONTGEN 
		WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
				
		IF @@SERIESFLAG = 0
		BEGIN
		
			SET @NEW_CONTRACTNO = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
									 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = 'I'
												THEN 'AA' + 
													 RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 5)
												ELSE 
													(CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
														  THEN 'A' +  
															  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 6)		
														  ELSE 
															  (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																	THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																	ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
															   END) 
																+ RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 
																7 - LEN((CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																			  THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																			  ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																		  END)))	
													 END)
												END)
									 ELSE RTRIM(@@NRMSERIESPREFIX) + 
										  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 7-LEN(RTRIM(@@NRMSERIESPREFIX)))
								END)
								
				SET @@NRMSERIESPREFIX_NEW = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
									 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = 'I'
												THEN 'AA' 
												ELSE (CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
														   THEN 'A'
														   ELSE (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																	THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																	ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
															   END)
													  END)
												END)
									 ELSE RTRIM(@@NRMSERIESPREFIX) 
								END)
		
				UPDATE CONTGEN SET CONTRACTNO = @NEW_CONTRACTNO ,NRMSERIESPREFIX = @@NRMSERIESPREFIX_NEW
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
		END
		ELSE
		BEGIN
			   SET @NEW_CONTRACTNO = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
										 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = '['
													THEN 'IA' + 
														 RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 5)
													ELSE 
														(CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
															  THEN 'I' +  
																  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 6)		
															  ELSE 
																  (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																		THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																		ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																   END) 
																	+ RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 
																	7 - LEN((CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																				  THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																				  ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																			  END)))	
														 END)
													END)
										 ELSE RTRIM(@@NRMSERIESPREFIX) + 
											  RIGHT('0000000'+CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1)), 7-LEN(RTRIM(@@NRMSERIESPREFIX)))
									END)
									
					SET @@NRMSERIESPREFIX_NEW = (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX) + CONVERT(VARCHAR,(CONVERT(INT,@NEW_CONTRACTNO_INT)+1))) > 7 
										 THEN (CASE WHEN CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1) = '['
													THEN 'IA' 
													ELSE (CASE WHEN RTRIM(@@NRMSERIESPREFIX) = '' 
															   THEN 'I'
															   ELSE (CASE WHEN LEN(RTRIM(@@NRMSERIESPREFIX)) = 2 
																		THEN LEFT(RTRIM(@@NRMSERIESPREFIX),1)+CHAR(ASCII(RTRIM(RIGHT(RTRIM(@@NRMSERIESPREFIX),1))) + 1) 
																		ELSE CHAR(ASCII(RTRIM(@@NRMSERIESPREFIX)) + 1)
																   END)
														  END)
													END)
										 ELSE RTRIM(@@NRMSERIESPREFIX) 
									END)
		
				UPDATE CONTGEN SET INSTCONTRACTNO = @NEW_CONTRACTNO ,INSSERIESPREFIX = @@NRMSERIESPREFIX_NEW
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
		END
	END
	ELSE
	BEGIN
	  SELECT @NEW_CONTRACTNO = STUFF('0000000', 8 - LEN(@NEW_CONTRACTNO), LEN(@NEW_CONTRACTNO), @NEW_CONTRACTNO)
	END
 END
END

SELECT 
	CONTRACTNO,TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,
	BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
	TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
	ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
INTO #BFOSETTLEMENT FROM BFOSETTLEMENT WHERE 1 = 2

SELECT @BILLNO = 0

IF @ACTUALQTY = @QTYTOTRANSFER
BEGIN
 INSERT INTO #BFOSETTLEMENT
 SELECT  
 	CONTRACTNO=@NEW_CONTRACTNO,TRADE_NO=LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,
	BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
	TERMINALID,ORDER_NO,PARTY_CODE=@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
	ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
 FROM BFOSETTLEMENT
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
        AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
        AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 0
        AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
        AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
        AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END

 UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,
 SERVICE_TAX = 0, TRADE_AMOUNT = 0,
 INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
    AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
        AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
        AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 0
        AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
        AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
        AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END

   INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
   TRUNCATE TABLE #BFOSETTLEMENT

END
ELSE
BEGIN
    SET @TRADECURSOR = CURSOR FOR
        SELECT TRADEQTY, TRADE_NO FROM BFOSETTLEMENT
        WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
        AND PARTY_CODE = @PARTYFROM
        AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
        AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
        AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		AND RESERVED1 = 0
        AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
        AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
        AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
 ORDER BY TRADEQTY DESC

        OPEN @TRADECURSOR
        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO
 WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0
 BEGIN
  IF @QTYTOTRANSFER >= @QTYINTRADE
  BEGIN
   INSERT INTO #BFOSETTLEMENT
	SELECT 
	
	CONTRACTNO=@NEW_CONTRACTNO,TRADE_NO=LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY,SETT_FLAG,CA_LEVEL,
	BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
	TERMINALID,ORDER_NO,PARTY_CODE,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
	ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS
	
   FROM BFOSETTLEMENT
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
          AND PARTY_CODE = @PARTYFROM
		  AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
		  AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
		  AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		  AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
		  AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		  AND RESERVED1 = 0
          AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
          AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
          AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
          AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
          AND TRADE_NO = CASE WHEN @NEW_TRADE_NO = '%' THEN TRADE_NO ELSE @NEW_TRADE_NO END
		  AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
		  AND TRADEQTY = @QTYINTRADE

   UPDATE BFOSETTLEMENT SET TRADEQTY = 0, TRADE_PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,
   SERVICE_TAX = 0, TRADE_AMOUNT = 0,
   INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
          AND PARTY_CODE = @PARTYFROM
          AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
          AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
          AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
          AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
          AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		  AND RESERVED1 = 0
          AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
          AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
          AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
          AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
          AND TRADE_NO = CASE WHEN @NEW_TRADE_NO = '%' THEN TRADE_NO ELSE @NEW_TRADE_NO END
		  AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
	      AND TRADEQTY = @QTYINTRADE

   INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
   TRUNCATE TABLE #BFOSETTLEMENT

   SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINTRADE
  END
  ELSE
  BEGIN
   INSERT INTO #BFOSETTLEMENT
   SELECT 
   	CONTRACTNO=@NEW_CONTRACTNO,TRADE_NO=LEFT('R'+TRADE_NO,14),SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,ASSET_CODE,
	EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,SELL_BUY,TRADEQTY=@QTYTOTRANSFER,SETT_FLAG,CA_LEVEL,
	BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,
	TERMINALID,ORDER_NO,PARTY_CODE=@PARTYTO,REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,ROFIG,ERRNUM,NOZERO,
	ROUND_TO,TRADE_AMOUNT=@QTYTOTRANSFER*TRADE_PRICE,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,NETRATE,
	SERVICE_TAX,AUCTIONPART,RESERVED1,DUMMY1,DUMMY2,STATUS 
   FROM BFOSETTLEMENT
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
          AND PARTY_CODE = @PARTYFROM
          AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
          AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
          AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
          AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
          AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
	      AND RESERVED1 = 0
	      AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
          AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
          AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @NEW_TRADE_NO = '%' THEN TRADE_NO ELSE @NEW_TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END
	      AND TRADEQTY = @QTYINTRADE

   UPDATE BFOSETTLEMENT SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER, TRADE_AMOUNT = (TRADEQTY - @QTYTOTRANSFER)*TRADE_PRICE
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
          AND PARTY_CODE = @PARTYFROM
          AND PRODUCT_CODE  = CASE WHEN @INST_TYPE = '%' THEN PRODUCT_CODE ELSE @INST_TYPE END
          AND SERIES_CODE = CASE WHEN @SYMBOL = '%' THEN SERIES_CODE ELSE @SYMBOL END
          AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
          AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
          AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END
		  AND RESERVED1 = 0
          AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
          AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' OR @PARTICIPANTCODE = '' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END
          AND CONTRACTNO = CASE WHEN @CONTRACTNO = '%' OR @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END
        AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
        AND TRADE_NO = CASE WHEN @NEW_TRADE_NO = '%' THEN TRADE_NO ELSE @NEW_TRADE_NO END
		AND TERMINALID = CASE WHEN @USERID <> '' THEN @USERID ELSE TERMINALID END

	INSERT INTO BFOSETTLEMENT SELECT * FROM #BFOSETTLEMENT
    TRUNCATE TABLE #BFOSETTLEMENT

	SELECT @QTYTOTRANSFER = 0
  END
         FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO
 END
 CLOSE @TRADECURSOR
 DEALLOCATE @TRADECURSOR
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_TRADE_TRANSFER_TRADE
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_TRADE_TRANSFER_TRADE]
(
	@SAUDA_DATE      VARCHAR(11),
	@PARTYFROM       VARCHAR(10),
	@PARTYTO         VARCHAR(10),
	@INST_TYPE       VARCHAR(6) ,
	@SYMBOL          VARCHAR(12),
	@EXPIRY_DATE     VARCHAR(11),
	@STRIKE_PRICE    MONEY      ,
	@OPTION_TYPE     VARCHAR(2) ,
	@SELL_BUY     INT        ,
	@PARTICIPANTCODE VARCHAR(15),
	@ORDER_NO  VARCHAR(20),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY NUMERIC(36,0)        ,
	@QTYTOTRANSFER   NUMERIC(36,0)        ,
	@STATUSID  VARCHAR(50) ='BROKER',
	@STRMODULE       VARCHAR(50) ='',
	@USERID  VARCHAR(15) =''
) AS

DECLARE
	@QTYINFOTRADE      INT        ,
	@NEW_TRADE_NO    VARCHAR(14),
	@BANKID VARCHAR(16),
	@KEEPINST TINYINT

SELECT @KEEPINST = 1

If Len(@EXPIRY_DATE) = 10 And CharIndex('/', @EXPIRY_DATE) > 0
	Begin
		Set @EXPIRY_DATE = Convert(Varchar(11), Convert(DateTime, @EXPIRY_DATE, 103), 109)
	End
If Len(@SAUDA_DATE) = 10 And CharIndex('/', @SAUDA_DATE) > 0
	Begin
		Set @SAUDA_DATE = Convert(Varchar(11), Convert(DateTime, @SAUDA_DATE, 103), 109)
	End
	
IF @STRMODULE <> ''
	BEGIN
		EXEC CONSOLE_LOG  @PARTYFROM,@PARTYTO,@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
		@ORDER_NO,@TRADE_NO,@SELL_BUY,'','',0,0,0,0,0,0,@ACTUALQTY,@QTYTOTRANSFER,0,@PARTICIPANTCODE,'',@STATUSID,@STRMODULE,'PROC_TRADE_TRANSFER_TRADE'
	END
SELECT @BANKID=CASE WHEN CL_TYPE ='INS' THEN BANKID ELSE MEMBERCODE END FROM CLIENT1 C1, CLIENT2 C2, FOOWNER WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = @PARTYTO

IF @ACTUALQTY = @QTYTOTRANSFER
	BEGIN
		INSERT INTO INST_LOG
		SELECT DISTINCT
			@PARTYTO,
			@PARTYTO,
			CASE WHEN @SAUDA_DATE = '%' THEN GETDATE() ELSE @SAUDA_DATE END,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			'%',
			'%',
			@SELL_BUY,
			CONTRACTNO = '',
			'',
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			PARTICIPANTCODE,
			CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END,
			@STATUSID,
			@STRMODULE,
			'EDIT_PARTICIPANT',
			GETDATE(),
			'EDITPARTICIPANT',
			'',
			''
		FROM FOTRADE
		WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
			AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
			AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
			AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
			AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END   
			AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
		    AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
			AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END

		UPDATE FOTRADE SET PARTY_CODE = @PARTYTO,
			PARTICIPANTCODE = CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END ELSE PARTICIPANTCODE END
		WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
			AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
			AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
			AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
			AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END   
			AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
		    AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
			AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END
	END
ELSE
	BEGIN
		DECLARE @FOTRADECURSOR CURSOR, @NEW_ORDER_NO VARCHAR(20)
		SELECT * INTO #INST_LOG FROM INST_LOG WHERE 1 = 0
		SET @FOTRADECURSOR = CURSOR FOR
		SELECT TRADEQTY, TRADE_NO, ORDER_NO FROM FOTRADE
		WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
			AND PARTY_CODE = @PARTYFROM
			AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
			AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
			AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
			AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
			AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
			AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
			AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END 
			AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
		    AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
			AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END
		ORDER BY TRADEQTY DESC
        OPEN @FOTRADECURSOR
        FETCH NEXT FROM @FOTRADECURSOR INTO @QTYINFOTRADE, @NEW_TRADE_NO, @NEW_ORDER_NO
		WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0
			BEGIN
				IF @QTYTOTRANSFER >= @QTYINFOTRADE
					BEGIN
						INSERT INTO #INST_LOG
						SELECT
							@PARTYTO,
							@PARTYTO,
							@SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE,
							STRIKE_PRICE,
							OPTION_TYPE,
							'%',
							'%',
							SELL_BUY,
							CONTRACTNO='',
							'',
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							PARTICIPANTCODE,
							CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END,
							@STATUSID,
							@STRMODULE,
							'EDIT_PARTICIPANT',
							GETDATE(),
							'EDITPARTICIPANT',
							'',
							''
						FROM
							FOTRADE
						WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
							AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
							AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END 
							AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
							AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
							AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END

						UPDATE FOTRADE SET PARTY_CODE = @PARTYTO,
							PARTICIPANTCODE = CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END ELSE PARTICIPANTCODE END
						WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
							AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
							AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END 
							AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
							AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
							AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END

						SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINFOTRADE
					END
				ELSE
					BEGIN
						INSERT INTO #INST_LOG
						SELECT
							@PARTYTO,
							@PARTYTO,
							@SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE,
							STRIKE_PRICE,
							OPTION_TYPE,
							'%',
							'%',
							SELL_BUY,
							CONTRACTNO='',
							'',
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							0,
							PARTICIPANTCODE,
							CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END,
							@STATUSID,
							@STRMODULE,
							'EDIT_PARTICIPANT',
							GETDATE(),
							'EDITPARTICIPANT',
							'',
							''
						FROM
							FOTRADE
						WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
							AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
							AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END 
							AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
							AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
							AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END

						INSERT INTO FOTRADE
						SELECT 'T'+TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME,BOOKTYPE,BOOKTYPENAME,
							MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,@QTYTOTRANSFER,PRICE,PRO_CLI,@PARTYTO,
							PARTICIPANTCODE = CASE WHEN @PARTYFROM <> @PARTYTO THEN CASE WHEN PARTICIPANTCODE = 'INST' AND @KEEPINST = 1 THEN 'INST' ELSE @BANKID END ELSE PARTICIPANTCODE END,
							O_C_FLAG,
							C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,SETTFLAG,MEMBERCODE,TMPARTYCODE,
							RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5=0 FROM FOTRADE
						WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
							AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
							AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END 
							AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
							AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
							AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END

						UPDATE FOTRADE SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER
						WHERE ACTIVITYTIME BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
							AND PARTY_CODE = @PARTYFROM
							AND INST_TYPE = CASE WHEN @INST_TYPE = '%' THEN INST_TYPE ELSE @INST_TYPE END
							AND SYMBOL = CASE WHEN @SYMBOL = '%' THEN SYMBOL ELSE @SYMBOL END
							AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
							AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = '0' THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
							AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '%' THEN OPTION_TYPE ELSE @OPTION_TYPE END 
							AND SELL_BUY BETWEEN CASE WHEN @SELL_BUY = 3 THEN 1 ELSE @SELL_BUY END AND CASE WHEN @SELL_BUY = 3 THEN 2 ELSE @SELL_BUY END
							AND PARTICIPANTCODE = CASE WHEN @PARTICIPANTCODE = '%' THEN PARTICIPANTCODE ELSE @PARTICIPANTCODE END 
							AND ORDER_NO = CASE WHEN @ORDER_NO = '%' THEN ORDER_NO ELSE @ORDER_NO END
							AND TRADE_NO = CASE WHEN @TRADE_NO = '%' THEN TRADE_NO ELSE @TRADE_NO END
							AND USER_ID = CASE WHEN @USERID <> '' THEN @USERID ELSE USER_ID END

						SELECT @QTYTOTRANSFER = 0
					END
				FETCH NEXT FROM @FOTRADECURSOR INTO @QTYINFOTRADE, @NEW_TRADE_NO, @NEW_ORDER_NO
			END
		CLOSE @FOTRADECURSOR
		DEALLOCATE @FOTRADECURSOR
		INSERT INTO INST_LOG
		SELECT
			PARTY_CODE,
			NEW_PARTY_CODE,
			SAUDA_DATE,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			ORDER_NO,
			TRADE_NO = '',
			SELL_BUY,
			CONTRACT_NO,
			NEW_CONTRACT_NO,
			BROKERAGE = SUM(BROKERAGE),
			NEW_BROKERAGE = SUM(NEW_BROKERAGE),
			MARKET_RATE = SUM(MARKET_RATE),
			NEW_MARKET_RATE = SUM(NEW_MARKET_RATE),
			NET_RATE = SUM(NET_RATE),
			NEW_NET_RATE = SUM(NEW_NET_RATE),
			QTY = SUM(QTY),
			NEW_QTY = SUM(NEW_QTY),
			ROUNDTO = 0,
			PARTICIPANT_CODE,
			NEW_PARTICIPANT_CODE,
			USERNAME = @STATUSID,
			MODULE = @STRMODULE,
			CALLED_FROM = 'EDIT PARTICIPANT',
			GETDATE(),
			EXTRAFIELD3 = 'EDIT PARTICIPANT-TRF',
			EXTRAFIELD4 = '',
			EXTRAFIELD5 = ''
		FROM
			#INST_LOG
		GROUP BY
			PARTY_CODE,
			NEW_PARTY_CODE,
			SAUDA_DATE,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			ORDER_NO,
			SELL_BUY,
			CONTRACT_NO,
			NEW_CONTRACT_NO,
			PARTICIPANT_CODE,
			NEW_PARTICIPANT_CODE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROCESS_STATUS_LOG_UPD
-- --------------------------------------------------


--EXEC V2_PROCESS_STATUS_LOG_UPD 'DEC 23 2011','CHKPOST','','914127',''   
    
    
CREATE PROC [dbo].[V2_PROCESS_STATUS_LOG_UPD]     
    
(    
 @@SAUDA_DATE VARCHAR(11),    
 @PROCESSID VARCHAR(10),     
 @FILENAME VARCHAR(255),    
 @UNAME VARCHAR(20),    
 @MACHINEIP VARCHAR(20) =''    
    
)    
AS    
    
DECLARE @PROCESSNAME VARCHAR(50)    
SET @PROCESSNAME = @PROCESSID    
    
SELECT @PROCESSNAME =     
CASE     
 WHEN @PROCESSID = 'BILLGEN' THEN 'BILL GENERATION'    
 WHEN @PROCESSID = 'CHKPOST' THEN 'BILL POSTING'    
 WHEN @PROCESSID = 'CONTRACT' THEN 'CONTRACT POP'    
 WHEN @PROCESSID = 'IMPTRD' THEN 'IMPORT TRADE'    
 WHEN @PROCESSID = 'MRGFILE' THEN 'MARGIN RET FILE GEN'    
 WHEN @PROCESSID = 'MRGIMP' THEN 'EXCH MARGIN IMPORT'    
 WHEN @PROCESSID = 'POSIMP' THEN 'EXCH POS IMPORT'    
 WHEN @PROCESSID = 'VBB' THEN 'VBB COMPUTATION'    
 WHEN @PROCESSID = 'CNTMST' THEN 'CONTRACT MASTER IMP'    
 WHEN @PROCESSID = 'CLRATE' THEN 'CLOSING RATE IMP'    
 WHEN @PROCESSID = 'CLOSE' THEN 'CLOSE TR DATE'    
END    
    
IF (SELECT COUNT(1)      
  FROM   (SELECT TOP 1 BUSINESS_DATE      
          FROM   V2_BUSINESS_PROCESS      
          WHERE  BUSINESS_DATE  = @@SAUDA_DATE) A) = 0      
BEGIN        
 INSERT INTO V2_BUSINESS_PROCESS     
 SELECT     
  BUSINESS_DATE=@@SAUDA_DATE,    
  CONTRACTMASTERIMP =0 ,    
  IMPORT_TRADE = 0 ,    
  VBB = 0 ,    
  BILLING = 0 ,    
  CONTRACT = 0 ,    
  POSTING = 0 ,    
  POSITIONFILE = 0 ,    
  CLOSINGRATE = 0 ,    
  MARGINFILE = 0 ,    
  MARGINRETURNFILE = 0 ,    
  OPEN_CLOSE = 0,    
  PROCESSDATE = GETDATE(),    
  PROCESSBY = @UNAME,    
  LASTUPDATEDATE = '',    
  LASTUPDATEBY = '',    
  MACHINEIP = @MACHINEIP    
END    
    
    
IF @PROCESSID = 'IMPTRD'  /*IMPORT TRADE*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
  IMPORT_TRADE   = IMPORT_TRADE + 1,    
  BILLING    = 0,CONTRACT  = CONTRACT + 1,POSTING   = 0,    
  POSITIONFILE   = 1,MARGINFILE   = 0,MARGINRETURNFILE  = 0,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
    
    
IF @PROCESSID = 'CNTMST' /*CONTRACT MASTER IMPORT*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
  CONTRACTMASTERIMP = CONTRACTMASTERIMP + 1 ,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
    
IF @PROCESSID = 'CLRATE' /*CLOSING RATE IMPORT*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
  CLOSINGRATE = CLOSINGRATE + 1 ,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
    
IF @PROCESSID = 'BILLGEN' /*BILL GENERATION*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
    
  BILLING   = BILLING + 1,    
  CONTRACT  = 0,POSTING   = 0,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
    
    
    
    
    
IF @PROCESSID = 'CONTRACT' /*CONTRACT PRINT DATA POPUP*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
    
  CONTRACT   = CONTRACT + 1,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
     
    
IF @PROCESSID = 'MRGFILE' /*MARGIN RETURN FILE GENEATION*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
    
  MARGINRETURNFILE   = MARGINRETURNFILE + 1,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
     
    
     
    
IF @PROCESSID = 'MRGIMP' /*IMPORT EXCHG MARGIN FILE*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
    
  MARGINFILE   = MARGINFILE + 1,    
  MARGINRETURNFILE =0,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
     
    
    
IF @PROCESSID = 'POSIMP' /*IMPORT EXCHG POSITION FILE*/   
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
    
  POSITIONFILE   = POSITIONFILE + 1,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
     
    
    
IF @PROCESSID = 'VBB' /*VBB COMPUTATION*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
    
  VBB    = VBB + 1,    
  BILLING   = 0,CONTRACT  = 0,    
  POSTING   = 0,MARGINRETURNFILE  = 0,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
    
    
    
    
IF @PROCESSID = 'CLOSE' /*CLOSE TRADING DAY*/    
BEGIN    
 UPDATE     
  V2_BUSINESS_PROCESS     
 SET     
    
  OPEN_CLOSE  =  1,    
  LASTUPDATEDATE = GETDATE(),    
  LASTUPDATEBY = @UNAME  ,    
  MACHINEIP = @MACHINEIP     
 WHERE     
  BUSINESS_DATE  = @@SAUDA_DATE     
END    
     
      
      
IF @PROCESSID = 'CHKPOST' /*CHECKING BLL POSTING STATUS*/      
BEGIN      
      
      
      DECLARE @POSTFLAG INT      
      
      SELECT * INTO #ACCBILL FROM BFoAccBill  (NOLOCK)      
      WHERE BILLDATE LIKE @@SAUDA_DATE + '%'       
   AND AMOUNT <> 0      
        
      SELECT * INTO #BILLMATCH FROM ACCOUNTbfo.DBO.BILLMATCH  (NOLOCK)      
      WHERE DATE LIKE @@SAUDA_DATE + '%'       
   AND AMOUNT <> 0      
        
      SELECT @POSTFLAG = ISNULL(COUNT(1),0)        
      FROM   (SELECT   POSTFLAG = ISNULL(B.PARTY_CODE,'0')        
              FROM     #ACCBILL A        
                       LEFT OUTER JOIN #BILLMATCH B        
                         ON ( A.PARTY_CODE = B.PARTY_CODE        
                             AND A.AMOUNT = B.AMOUNT        
                             AND SELL_BUY = (CASE         
                                               WHEN DRCR = 'D' THEN 1        
                                               ELSE 2        
                                             END))        
              WHERE          
     NOT EXISTS (SELECT ACCODE        
                                       FROM   VALANACCOUNT        
                                       WHERE  ACCODE = A.PARTY_CODE)        
              GROUP BY ISNULL(B.PARTY_CODE,'0')        
              UNION         
              SELECT POSTFLAG = '0'        
              FROM   #BILLMATCH B        
              WHERE  NOT EXISTS (SELECT PARTY_CODE        
FROM   #ACCBILL A        
                                     WHERE  A.PARTY_CODE = B.PARTY_CODE        
    )) P        
         WHERE  POSTFLAG = '0'        
                                
      
 DROP TABLE #BILLMATCH      
 DROP TABLE #ACCBILL      
      
 IF (SELECT COUNT(1)        
           FROM   ACCOUNTbfo.DBO.BILLPOSTED  (NOLOCK)      
           WHERE  LEFT(VDT,11) = @@SAUDA_DATE) > 0      
 BEGIN      
  UPDATE       
   V2_BUSINESS_PROCESS       
  SET        
   Posting  =  CASE WHEN  BILLING = 0 THEN 0       
      ELSE (CASE         
                                 WHEN @POSTFLAG = 0 THEN 1        
                                 ELSE 0        
                               END)       
      END      
  WHERE       
   LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE         
 END      
END      
      
    
    
    
    
INSERT INTO V2_PROCESS_STATUS_LOG     
(     
 EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,    
 FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP    
)    
SELECT    
 EXCHANGE=(SELECT TOP 1 EXCHANGE FROM BFOTAXES),    
 SEGMENT='FUTURES',    
 BUSINESSDATE=@@SAUDA_DATE,    
 PROCESSID = @PROCESSID,    
 PROCESSNAME= @PROCESSNAME,    
 FILENAME=@FILENAME,    
 START_END_FLAG=1,    
 PROCESSDATE=GETDATE(),    
 PROCESSBY=@UNAME,    
 MACHINEIP= @MACHINEIP    
/*---------------------------------------------------  END OF THE PROC -------------------*/    
    
    
    
    
    
/*--------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROCESS_STATUS_LOG_UPD_BKUP_10Aug2023
-- --------------------------------------------------

CREATE PROC [dbo].[V2_PROCESS_STATUS_LOG_UPD_BKUP_10Aug2023]   
  
(  
 @@SAUDA_DATE VARCHAR(11),  
 @PROCESSID VARCHAR(10),   
 @FILENAME VARCHAR(255),  
 @UNAME VARCHAR(20),  
 @MACHINEIP VARCHAR(20) =''  
  
)  
AS  
  
DECLARE @PROCESSNAME VARCHAR(50)  
SET @PROCESSNAME = @PROCESSID  
  
SELECT @PROCESSNAME =   
CASE   
 WHEN @PROCESSID = 'BILLGEN' THEN 'BILL GENERATION'  
 WHEN @PROCESSID = 'CHKPOST' THEN 'BILL POSTING'  
 WHEN @PROCESSID = 'CONTRACT' THEN 'CONTRACT POP'  
 WHEN @PROCESSID = 'IMPTRD' THEN 'IMPORT TRADE'  
 WHEN @PROCESSID = 'MRGFILE' THEN 'MARGIN RET FILE GEN'  
 WHEN @PROCESSID = 'MRGIMP' THEN 'EXCH MARGIN IMPORT'  
 WHEN @PROCESSID = 'POSIMP' THEN 'EXCH POS IMPORT'  
 WHEN @PROCESSID = 'VBB' THEN 'VBB COMPUTATION'  
 WHEN @PROCESSID = 'CNTMST' THEN 'CONTRACT MASTER IMP'  
 WHEN @PROCESSID = 'CLRATE' THEN 'CLOSING RATE IMP'  
 WHEN @PROCESSID = 'CLOSE' THEN 'CLOSE TR DATE'  
END  
  
IF (SELECT COUNT(1)    
  FROM   (SELECT TOP 1 BUSINESS_DATE    
          FROM   V2_BUSINESS_PROCESS    
          WHERE  BUSINESS_DATE  = @@SAUDA_DATE) A) = 0    
BEGIN      
 INSERT INTO V2_BUSINESS_PROCESS   
 SELECT   
  BUSINESS_DATE=@@SAUDA_DATE,  
  CONTRACTMASTERIMP =0 ,  
  IMPORT_TRADE = 0 ,  
  VBB = 0 ,  
  BILLING = 0 ,  
  CONTRACT = 0 ,  
  POSTING = 0 ,  
  POSITIONFILE = 0 ,  
  CLOSINGRATE = 0 ,  
  MARGINFILE = 0 ,  
  MARGINRETURNFILE = 0 ,  
  OPEN_CLOSE = 0,  
  PROCESSDATE = GETDATE(),  
  PROCESSBY = @UNAME,  
  LASTUPDATEDATE = '',  
  LASTUPDATEBY = '',  
  MACHINEIP = @MACHINEIP  
END  
  

IF @PROCESSID = 'CHKPOST' /*CHECKING BLL POSTING STATUS*/  
BEGIN  
  

  
      DECLARE @POSTFLAG INT  
  
      SELECT * INTO #ACCBILL FROM bFOACCBILL  (NOLOCK)  
      WHERE BILLDATE LIKE @@SAUDA_DATE + '%'   
   AND AMOUNT <> 0  
    
      SELECT * INTO #BILLMATCH FROM ACCOUNTbFO.DBO.BILLMATCH  (NOLOCK)  
      WHERE DATE LIKE @@SAUDA_DATE + '%'   
   AND AMOUNT <> 0  
    
      SELECT @POSTFLAG = ISNULL(COUNT(1),0)    
      FROM   (SELECT   POSTFLAG = ISNULL(B.PARTY_CODE,'0')    
              FROM     #ACCBILL A    
                       LEFT OUTER JOIN #BILLMATCH B    
                         ON ( A.PARTY_CODE = B.PARTY_CODE    
                             AND A.AMOUNT = B.AMOUNT    
                             AND SELL_BUY = (CASE     
                                               WHEN DRCR = 'D' THEN 1    
                                               ELSE 2    
                                             END))    
              WHERE      
     NOT EXISTS (SELECT ACCODE    
                                       FROM   VALANACCOUNT    
                                       WHERE  ACCODE = A.PARTY_CODE)    
              GROUP BY ISNULL(B.PARTY_CODE,'0')    
              UNION     
              SELECT POSTFLAG = '0'    
              FROM   #BILLMATCH B    
              WHERE  NOT EXISTS (SELECT PARTY_CODE    
                                     FROM   #ACCBILL A    
                                     WHERE  A.PARTY_CODE = B.PARTY_CODE    
    )) P    
         WHERE  POSTFLAG = '0'    
                            
  
 DROP TABLE #BILLMATCH  
 DROP TABLE #ACCBILL  
  
 IF (SELECT COUNT(1)    
           FROM   ACCOUNTbFO.DBO.BILLPOSTED  (NOLOCK)  
           WHERE  LEFT(VDT,11) = @@SAUDA_DATE) > 0  
 BEGIN  
  UPDATE   
   V2_BUSINESS_PROCESS   
  SET    
   Posting  =  Posting + 1 
  WHERE   
   LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE     
 END  
END  
  
IF @PROCESSID = 'IMPTRD'  /*IMPORT TRADE*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  IMPORT_TRADE   = IMPORT_TRADE + 1,  
  BILLING    = 0,CONTRACT  = CONTRACT + 1,POSTING   = 0,  
  POSITIONFILE   = 0,MARGINFILE   = 0,MARGINRETURNFILE  = 0,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
  
  
IF @PROCESSID = 'CNTMST' /*CONTRACT MASTER IMPORT*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  CONTRACTMASTERIMP = CONTRACTMASTERIMP + 1 ,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
  
IF @PROCESSID = 'CLRATE' /*CLOSING RATE IMPORT*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  CLOSINGRATE = CLOSINGRATE + 1 ,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
  
IF @PROCESSID = 'BILLGEN' /*BILL GENERATION*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  
  BILLING   = BILLING + 1,  
  CONTRACT  = 0,POSTING   = 0,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
  
  
  
  
  
IF @PROCESSID = 'CONTRACT' /*CONTRACT PRINT DATA POPUP*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  
  CONTRACT   = CONTRACT + 1,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
   
  
IF @PROCESSID = 'MRGFILE' /*MARGIN RETURN FILE GENEATION*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  
  MARGINRETURNFILE   = MARGINRETURNFILE + 1,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
   
  
   
  
IF @PROCESSID = 'MRGIMP' /*IMPORT EXCHG MARGIN FILE*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  
  MARGINFILE   = MARGINFILE + 1,  
  MARGINRETURNFILE =0,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
   
  
  
IF @PROCESSID = 'POSIMP' /*IMPORT EXCHG POSITION FILE*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  
  POSITIONFILE   = POSITIONFILE + 1,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
   
  
  
IF @PROCESSID = 'VBB' /*VBB COMPUTATION*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  
  VBB    = VBB + 1,  
  BILLING   = 0,CONTRACT  = 0,  
  POSTING   = 0,MARGINRETURNFILE  = 0,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
  
  
  
  
IF @PROCESSID = 'CLOSE' /*CLOSE TRADING DAY*/  
BEGIN  
 UPDATE   
  V2_BUSINESS_PROCESS   
 SET   
  
  OPEN_CLOSE  =  1,  
  LASTUPDATEDATE = GETDATE(),  
  LASTUPDATEBY = @UNAME  ,  
  MACHINEIP = @MACHINEIP   
 WHERE   
  BUSINESS_DATE  = @@SAUDA_DATE   
END  
   
  
  
  
  
  
INSERT INTO V2_PROCESS_STATUS_LOG   
(   
 EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,  
 FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP  
)  
SELECT  
 EXCHANGE=(SELECT TOP 1 EXCHANGE FROM BFOTAXES),  
 SEGMENT='FUTURES',  
 BUSINESSDATE=@@SAUDA_DATE,  
 PROCESSID = @PROCESSID,  
 PROCESSNAME= @PROCESSNAME,  
 FILENAME=@FILENAME,  
 START_END_FLAG=1,  
 PROCESSDATE=GETDATE(),  
 PROCESSBY=@UNAME,  
 MACHINEIP= @MACHINEIP  
/*---------------------------------------------------  END OF THE PROC -------------------*/  
  
  
  
  
  
/*--------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROCESSFORTODAY
-- --------------------------------------------------
CREATE PROC V2_PROCESSFORTODAY    
(      
           @PROCESSFLAG VARCHAR(15),      
           @UNAME       VARCHAR(50),      
           @PROCESSDATE VARCHAR(11)    
)      
AS      
    
/*    
======================================================================    
   PROCESS FLAG    
======================================================================    
    
 IMPTRD  - Import Trade    
 MRGPOP  - Client Margin Update    
 MRGFILE  - Margin File Generation    
 BILLGEN  - Bill Generation    
 VBB  - VBB Computation    
 CONTRACT - Contract Data Popup    
 POSIMP  - Position File Import    
 MRGIMP  - Margin File Import    
 STT  - STT Computation    
 STATUS  - Check Overall Status    
======================================================================    
*/    
     
    
    
 /*-------------------------------------------------------------------------*/    
    
 IF @PROCESSFLAG = 'VBB'      
 BEGIN      
  EXEC PR_Charges_Detail @PROCESSDATE,@PROCESSDATE,'0','zzzzzz',@UNAME    
 END    
    
 /*-------------------------------------------------------------------------*/    
    
 IF @PROCESSFLAG = 'STT'      
 BEGIN      
  EXEC STT_Charges_Final @PROCESSDATE,'0','zzzzzz',@UNAME    
 END    
    
 /*-------------------------------------------------------------------------*/    
    
 IF @PROCESSFLAG = 'BILLGEN'      
 BEGIN      
  EXEC BFOBILLGENERATE @PROCESSDATE,@UNAME    
 END    
    
    
 IF @PROCESSFLAG = 'VALANGEN'      
 BEGIN      
  EXEC BFOVALANGENERATE @PROCESSDATE,@UNAME    
 END    
    
 /*-------------------------------------------------------------------------*/    
 IF @PROCESSFLAG = 'CONTRACT'      
 BEGIN      
  EXEC POP_CONTRACTDATA @PROCESSDATE,@UNAME    
 END    
    
 /*-------------------------------------------------------------------------*/    
 IF @PROCESSFLAG = 'CLOSE'      
 BEGIN     
  EXEC V2_PROCESS_STATUS_LOG_UPD @PROCESSDATE,@PROCESSFLAG,'',@UNAME,''    
 END    
    
 /*-------------------------------------------------------------------------*/    
 IF @PROCESSFLAG = 'STATUS'      
 BEGIN      
    
  /*-----------------------------------------------------------------*/    
  CREATE TABLE #PROCESS_LOG    
  (    
   PROCESS_ID VARCHAR(100),    
   PROCESS_STAT VARCHAR(200)     
  )    
    
    
    
    
  /*--------------------- Contract Master Import ------------------------*/    
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND ContractMasterImp > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Contract Master Import','Pending')    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #PROCESS_LOG     
   SELECT 'Contract Master Import','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
   WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
   FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
   WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
    WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='CNTMST')    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Contract Master Import','Done')    
   END    
  END    
    
    
  /*--------------------- Import Trade ------------------------*/    
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND Import_Trade > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Import Trade','Pending')    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #PROCESS_LOG     
   SELECT 'Import Trade','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
   WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
   FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
   WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
    WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='IMPTRD')    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Import Trade','Done')    
   END    
  END    
    
  /*--------------------- VBB Computation ------------------------*/     
  IF (SELECT COUNT(1) FROM SCHEME_MAPPING (NOLOCK)) > 0    
  BEGIN    
   IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
    WHERE Left(Business_Date,11) = @PROCESSDATE AND VBB > 0)= 0     
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('VBB Computation','Pending')    
   END    
   ELSE    
   BEGIN    
    INSERT INTO #PROCESS_LOG     
    SELECT 'VBB Computation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
    WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
    FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
    WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
     WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='VBB')    
   END    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('VBB Computation','Done')    
   END    
  END    
    
  /*--------------------- Position File Import ------------------------*/     
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND PositionFile > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Position File Import','Pending')    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #PROCESS_LOG     
   SELECT 'Position File Import','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
   WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
   FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
   WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
    WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='POSIMP')    
    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Position File Import','Done')    
   END    
  END    
    
    
  /*--------------------- BILL GENERATION ------------------------*/    
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND Billing > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Bill Generation','Pending')    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #PROCESS_LOG     
   SELECT 'Bill Generation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
   WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
   FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
   WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
    WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='BILLGEN')    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Bill Generation','Done')    
   END    
  END    
    
  /*--------------------- VALAN GENERATION ------------------------*/    
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND Billing > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Valan Generation','Pending')    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #PROCESS_LOG     
   SELECT 'Valan Generation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
   WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
   FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
   WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
    WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='VALANGEN')    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Valan Generation','Done')    
   END    
  END    
    
    
  /*--------------------- BILL POSTING ------------------------*/    
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND POSTING > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Bill Posting','Pending')    
  END    
  ELSE    
  BEGIN    
 INSERT INTO #PROCESS_LOG   
 SELECT  'Bill Posting','Done - ' + PROC_STAT FROM  
 (SELECT TOP 1 (CASE WHEN CONVERT(VARCHAR,POSTDATE,108) <> '00:00:00'   
 THEN CONVERT(VARCHAR,POSTDATE) ELSE LEFT(POSTDATE,11) END ) +   
 (CASE WHEN ISNULL(USERNAME,'')<>'' THEN ' ('+ USERNAME + ')' ELSE '' END) AS PROC_STAT  
 FROM  ACCOUNTbFO.DBO.BILLPOSTED (NOLOCK) WHERE VDT BETWEEN @PROCESSDATE AND @PROCESSDATE + ' 23:59') STAT  
  
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Bill Posting','Done')    
   END    
  END    
    
    
  /*--------------------- Contract Print canned data Popup ------------------------*/    
  IF (SELECT TOP 1 EXCHANGE FROM BFOTAXES (NOLOCK) ) <> 'NCM'    
  BEGIN    
   IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
    WHERE Left(Business_Date,11) = @PROCESSDATE AND CONTRACT > 0) = 0     
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Contract Print Data Popup','Pending')    
   END    
   ELSE    
   BEGIN    
    INSERT INTO #PROCESS_LOG     
    SELECT 'Contract Print Data Popup','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
    WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
    FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
    WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
     WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='CONTRACT')    
   END    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Contract Print Data Popup','Done')    
   END    
  END    
    
  /*--------------------- Margin File Import ------------------------*/    
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND MarginFile > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Margin File Import','Pending')    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #PROCESS_LOG     
   SELECT 'Margin File Import','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
   WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
   FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
   WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
    WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGIMP')    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Margin File Import','Done')    
   END    
  END    
    
     
  /*--------------------- Margin Return File Generation ------------------------*/    
  IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)    
   WHERE Left(Business_Date,11) = @PROCESSDATE AND MarginReturnFile > 0) = 0     
  BEGIN    
   INSERT INTO #PROCESS_LOG VALUES ('Margin Return File Generation','Pending')    
  END    
  ELSE    
  BEGIN    
   INSERT INTO #PROCESS_LOG     
   SELECT 'Margin Return File Generation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE     
   WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END     
   FROM V2_PROCESS_STATUS_LOG (NOLOCK)    
   WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK)     
    WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGFILE')    
    
   IF @@ROWCOUNT  = 0    
   BEGIN    
    INSERT INTO #PROCESS_LOG VALUES ('Margin Return File Generation','Done')    
   END    
  END    
     
    
    
    
    
  SELECT * FROM #PROCESS_LOG    
     
  DROP TABLE #PROCESS_LOG    
      
      
      
 END    
    
/*--------------------------------------------- EOF --------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_ADMINPASSWORD_26112019
-- --------------------------------------------------
CREATE PROC [DBO].[V2_UPDATE_ADMINPASSWORD]  
(  
 @PASSWORD VARCHAR(512),  
 @ADMINID VARCHAR(25),  
 @DAYCOUNT INT   
)  
  
AS
SET NOCOUNT ON  
  
DECLARE @@FLDOLDPASSWORD TINYINT  
DECLARE @@FLDAUTO INT  
DECLARE @@PASSAUTO BIGINT  
DECLARE @@OLDPASSSTRING VARCHAR(2000)  
DECLARE @@OLDPASSCOUNT INT  
DECLARE @@NEWPASSSTRING VARCHAR(2000)  
  
  
/*  
CREATE TABLE TBLUSERPASSHIST  
(  
 FLDAUTO BIGINT IDENTITY(1,1),  
 FLDUSERID INT,  
 FLDOLDPASSLISTING VARCHAR(2000)  
)  
*/  
  
  
SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS  
  
IF ISNULL(@@FLDOLDPASSWORD,0) = 0  
BEGIN  
 SET @@FLDOLDPASSWORD = 1  
END  
  
  
  
SELECT @@FLDAUTO = ISNULL(FLDAUTO_ADMIN,0) FROM TBLADMIN  
WHERE FLDNAME = @ADMINID  
  
IF ISNULL(@@FLDAUTO,0) = 0  
BEGIN  
 SELECT MSG = 'ADMIN USER NOT FOUND'  
 RETURN  
END  
  
  
  
SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLADMINPASSHIST  
WHERE FLDADMINID = @@FLDAUTO  
  
IF ISNULL(@@OLDPASSSTRING,'') = ''  
BEGIN  
 SET @@OLDPASSSTRING = ''  
END  
  
IF ISNULL(@@PASSAUTO,0) = 0  
BEGIN  
 SET @@PASSAUTO = 0  
END  
  
  
SELECT   
 @@OLDPASSCOUNT = COUNT(1)  
FROM   
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
WHERE   
 SPLITTED_VALUE = @PASSWORD  
 AND SNO > (  
      SELECT   
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)  
      FROM   
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
     )  
  
  
IF ISNULL(@@OLDPASSCOUNT,0) > 0  
BEGIN  
 SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'  
 RETURN  
END  
  
  
  
UPDATE TBLADMIN   
SET   
 FLDPASSWORD = @PASSWORD,  
 PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT),
 FLDATTEMPTCNT = 0 
WHERE   
 FLDAUTO_ADMIN = @@FLDAUTO  
  
SET @@NEWPASSSTRING = ''  
  
DECLARE @@STRING VARCHAR(100)  
  
DECLARE VENDOR_CURSOR CURSOR FOR   
  
SELECT SPLITTED_VALUE  
FROM   
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
WHERE  SNO > (  
      SELECT   
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)  
      FROM   
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
     )  
OPEN VENDOR_CURSOR  
  
FETCH NEXT FROM VENDOR_CURSOR   
INTO @@STRING  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''  
FETCH NEXT FROM VENDOR_CURSOR   
INTO @@STRING  
END   
  
CLOSE VENDOR_CURSOR  
DEALLOCATE VENDOR_CURSOR  
  
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD   
  
IF ISNULL(@@PASSAUTO,0) = 0  
BEGIN  
 INSERT INTO TBLADMINPASSHIST   
 (FLDADMINID, FLDOLDPASSLISTING)   
 VALUES  
 (@@FLDAUTO, @@NEWPASSSTRING)  
END  
ELSE  
BEGIN  
 UPDATE TBLADMINPASSHIST  
 SET FLDOLDPASSLISTING = @@NEWPASSSTRING  
 WHERE FLDAUTO = @@PASSAUTO  
 AND FLDADMINID = @@FLDAUTO   
END  
  
SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'  
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_PASSWORD
-- --------------------------------------------------

CREATE  PROC [dbo].[V2_UPDATE_PASSWORD]
(
	@PASSWORD VARCHAR(512),
	@USERID VARCHAR(25),
	@DAYCOUNT INT	
)

AS


SET NOCOUNT ON

DECLARE @@FLDOLDPASSWORD TINYINT
DECLARE @@FLDAUTO INT
DECLARE @@PASSAUTO BIGINT
DECLARE @@OLDPASSSTRING VARCHAR(2000)
DECLARE @@OLDPASSCOUNT INT
DECLARE @@NEWPASSSTRING VARCHAR(2000)


/*
CREATE TABLE TBLUSERPASSHIST
(
	FLDAUTO BIGINT IDENTITY(1,1),
	FLDUSERID INT,
	FLDOLDPASSLISTING VARCHAR(2000)
)
*/


SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS

IF ISNULL(@@FLDOLDPASSWORD,0) = 0
BEGIN
	SET @@FLDOLDPASSWORD = 1
END



SELECT @@FLDAUTO = ISNULL(FLDAUTO,0) FROM TBLPRADNYAUSERS
WHERE FLDUSERNAME = @USERID

IF ISNULL(@@FLDAUTO,0) = 0
BEGIN
	SELECT MSG = 'USER NOT FOUND'
	RETURN
END



SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLUSERPASSHIST
WHERE FLDUSERID = @@FLDAUTO

IF ISNULL(@@OLDPASSSTRING,'') = ''
BEGIN
	SET @@OLDPASSSTRING = ''
END

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	SET @@PASSAUTO = 0
END


SELECT 
	@@OLDPASSCOUNT = COUNT(1)
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE 
	SPLITTED_VALUE = @PASSWORD
	AND SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)


IF ISNULL(@@OLDPASSCOUNT,0) > 0
BEGIN
	SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'
	RETURN
END



UPDATE TBLPRADNYAUSERS 
SET 
	FLDPASSWORD = @PASSWORD,
	PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT)
WHERE 
	FLDAUTO = @@FLDAUTO

								
UPDATE TBLUSERCONTROLMASTER 
SET 
	FLDATTEMPTCNT = 0,
	FLDFIRSTLOGIN = 'N'
WHERE 
	TBLUSERCONTROLMASTER.FLDUSERID = @@FLDAUTO 



SET @@NEWPASSSTRING = ''


DECLARE @@STRING VARCHAR(100)

DECLARE vendor_cursor CURSOR FOR 

SELECT SPLITTED_VALUE
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE  SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)
OPEN vendor_cursor

FETCH NEXT FROM vendor_cursor 
INTO @@STRING

WHILE @@FETCH_STATUS = 0
BEGIN
	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''
FETCH NEXT FROM vendor_cursor 
INTO @@STRING
END 

CLOSE vendor_cursor
DEALLOCATE vendor_cursor

	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD 

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	INSERT INTO TBLUSERPASSHIST 
	(FLDUSERID, FLDOLDPASSLISTING) 
	VALUES
	(@@FLDAUTO, @@NEWPASSSTRING)
END
ELSE
BEGIN
	UPDATE TBLUSERPASSHIST
	SET FLDOLDPASSLISTING = @@NEWPASSSTRING
	WHERE FLDAUTO = @@PASSAUTO
	AND FLDUSERID = @@FLDAUTO 
END

SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_ADDITIONAL_CHARGES
-- --------------------------------------------------

/*--- BILL POSTING  IPFT_CHRG ------*/

CREATE	PROC [dbo].[VALAN_ADDITIONAL_CHARGES]
		(
		@BILLDATE	VARCHAR(11)
		)

		AS

		/*
		EXEC	VALAN_ADDITIONAL_CHARGES '2022521','M'
		*/

		DECLARE	@NARRATION			VARCHAR(100),
				@START_DATE         DATETIME,    
				@END_DATE           DATETIME,    
				@SEC_PAYIN          DATETIME,    
				@SEC_PAYOUT         DATETIME,    
				@ACNAME             VARCHAR(50),    
				@ACCODE             VARCHAR(10),
				@IPFTCHRG			VARCHAR(10),
				@SETT_NO			VARCHAR(10),    
				@SETT_TYPE			VARCHAR(3),
				@IPFTCHRG_FUT		NUMERIC(18,4),
				@IPFTCHRG_OPT		NUMERIC(18,4),
				@IPFTCHRG_INS		INT

	
		SELECT	@IPFTCHRG_FUT = ISNULL(IPFTCHRG_FUT,0), @IPFTCHRG_OPT = ISNULL(IPFTCHRG_OPT,0), @IPFTCHRG_INS = ISNULL(IPFTCHRG_INS,0) 
		FROM	BFOGLOBALS (NOLOCK)
		WHERE	@BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT

		IF (@IPFTCHRG_FUT+@IPFTCHRG_OPT) = 0
		BEGIN
			RETURN 
		END
		
		SELECT	PARTY_CODE,
				CONTRACTNO,
				INST_TYPE,
				SYMBOL,
				EXPIRYDATE,
				OPTION_TYPE,
				STRIKE_PRICE,
				--SELL_BUY,
				IPFT_CHRG = ROUND(SUM(IPFT_CHRG),2)
		INTO	#ADD_CHRG
		FROM	TBL_ADDITIONAL_TAX_DATA T (NOLOCK)
		WHERE	SAUDA_DATE BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59' 
		GROUP BY
				PARTY_CODE,
				CONTRACTNO,
				INST_TYPE,
				SYMBOL,
				EXPIRYDATE,
				OPTION_TYPE,
				STRIKE_PRICE
				--SELL_BUY
		HAVING	SUM(IPFT_CHRG) <> 0
					
		
		IF (SELECT COUNT(1) FROM #ADD_CHRG) = 0
		BEGIN
			RETURN 
		END

		/*
		SELECT	@START_DATE = START_DATE,    
				@END_DATE = END_DATE,    
				@SEC_PAYIN = SEC_PAYIN,    
				@SEC_PAYOUT = SEC_PAYOUT    
		FROM	SETT_MST (NOLOCK)
		WHERE	SETT_NO = @SETT_NO    
				AND SETT_TYPE = @SETT_TYPE 
		*/

		SELECT	@NARRATION = ISNULL(MAX(NARRATION),'BILL POSTED'),
				@START_DATE = MAX(START_DATE),
				@END_DATE = MAX(END_DATE),
				@SEC_PAYIN = MAX(PAYIN_DATE),
				@SEC_PAYOUT = MAX(PAYOUT_DATE),
				@SETT_NO='',    
				@SETT_TYPE=''
		FROM	BFOACCBILL 
		WHERE	BILLDATE BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59'


		SELECT  @ACNAME = V.ACNAME,    
				@IPFTCHRG = V.ACCODE    
		FROM    VALANACCOUNT V(NOLOCK),
				ACCOUNTBFO.DBO.ACMAST A(NOLOCK)    
		WHERE   V.ACCODE = A.CLTCODE
				AND V.ACNAME = 'INVESTOR PROTECTION FUND TRUST'
				AND EFFDATE = (SELECT  MAX(EFFDATE)    
								FROM   VALANACCOUNT A    
								WHERE  A.EFFDATE <= @END_DATE   
										AND V.ACNAME = A.ACNAME)    
		ORDER BY V.ACNAME   


		IF ISNULL(@ACNAME,'') = ''
		BEGIN
			SELECT 'IPFT CHARGES VALAN ACOOUNT NOT SETUP IN MASTER'
			RETURN
		END

		--SELECT @ACNAME, @IPFTCHRG, @START_DATE, @END_DATE

		DELETE	FROM BFOACCBILL
		WHERE	BILLDATE BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59' AND PARTY_CODE = @IPFTCHRG

		DELETE	FROM BFOACCBILL 
		WHERE	BILLDATE BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59'
		AND PARTY_CODE IN (SELECT ACCODE FROM VALANACCOUNT WHERE ACNAME = 'ROUNDING OFF')


		DELETE	FROM BFOACCBILL 
		WHERE	BILLDATE BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59'
		AND PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #ADD_CHRG WHERE IPFT_CHRG <> 0)


		INSERT INTO BFOACCBILL              
		SELECT PARTY_CODE,BILLNO='0',            
		SELL_BUY = (CASE WHEN SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE             
				  THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG + IPFT_CHRG)       
				  ELSE -1 END ) > 0             
		   THEN 2            
				  ELSE 1            
			 END),            
		SETT_NO='',SETT_TYPE='',@BILLDATE,START_DATE=@BILLDATE,END_DATE=@BILLDATE,SEC_PAYIN=@BILLDATE,SEC_PAYOUT=@BILLDATE,            
		AMOUNT = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE             
							THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG + IPFT_CHRG)            
												 ELSE - (SBILLAMT + PBILLAMT + (SERVICE_TAX - EXSER_TAX + TURN_TAX + INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG + IPFT_CHRG))
				  END)),2) ,            
		MTM = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE             
							THEN SBILLAMT - PBILLAMT + SBROKAMT - PBROKAMT             
												 ELSE SBILLAMT + PBILLAMT - SBROKAMT - PBROKAMT             
				  END)),2) ,            
		0,0,0,            
		BROKERAGE=ROUND(SUM(SBROKAMT + PBROKAMT),2),            
		SERVICE_TAX=ROUND(SUM(SERVICE_TAX - EXSER_TAX),4),            
		0,0,0,0,0,            
		BRANCH_CODE,'BILL POSTED'            
		FROM BFOBILLVALAN, BFOOWNER, #ADD_CHRG 
		WHERE SAUDA_DATE BETWEEN @BILLDATE  AND @BILLDATE + ' 23:59'
		AND #ADD_CHRG.PARTY_CODE = BFOBILLVALAN.PARTY_CODE
		AND #ADD_CHRG.CONTRACTNO = BFOBILLVALAN.CONTRACTNO
		AND #ADD_CHRG.INST_TYPE = BFOBILLVALAN.PRODUCT_CODE
		AND #ADD_CHRG.SYMBOL = BFOBILLVALAN.SERIES_CODE
		AND #ADD_CHRG.EXPIRYDATE = BFOBILLVALAN.EXPIRYDATE
		AND #ADD_CHRG.STRIKE_PRICE = BFOBILLVALAN.STRIKE_PRICE
		AND #ADD_CHRG.OPTION_TYPE = BFOBILLVALAN.OPTION_TYPE
		GROUP BY BRANCH_CODE,PARTY_CODE


		INSERT	INTO BFOACCBILL
		SELECT	PARTY_CODE=@IPFTCHRG,BILL_NO=0,SELL_BUY='2',SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@SEC_PAYIN,@SEC_PAYOUT,
				AMOUNT=ROUND(SUM(IPFT_CHRG),2),0,0,0,0,0,0,0,0,0,0,0,BRANCH_CD,NARRATION='BILL POSTED'
		FROM	TBL_ADDITIONAL_TAX_DATA T (NOLOCK),
				CLIENT1 C1 (NOLOCK)
		WHERE	SAUDA_DATE BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59' 
				AND T.PARTY_CODE = C1.CL_CODE
		GROUP BY
				BRANCH_CD


		INSERT	INTO BFOACCBILL
		SELECT	PARTY_CODE=@IPFTCHRG,BILL_NO=0,SELL_BUY='2',SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@SEC_PAYIN,@SEC_PAYOUT,
				AMOUNT=ROUND(SUM(IPFT_CHRG),2),0,0,0,0,0,0,0,0,0,0,0,BRANCH_CD='ZZZ',NARRATION='BILL POSTED'
		FROM	TBL_ADDITIONAL_TAX_DATA T (NOLOCK),
				CLIENT1 C1 (NOLOCK)
		WHERE	SAUDA_DATE BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59' 
				AND T.PARTY_CODE = C1.CL_CODE


		INSERT INTO BFOACCBILL
		SELECT PARTY_CODE=ACCODE,BILL_NO=0,
		SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
		SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@SEC_PAYIN,@SEC_PAYOUT,
		AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),
		0,0,0,0,0,0,0,0,0,0,0,BRANCHCD,NARRATION='BILL POSTED'
		FROM BFOACCBILL G, VALANACCOUNT 
		WHERE Billdate BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59'
		AND ACNAME = 'ROUNDING OFF' 
		AND Branchcd <> 'ZZZ'
		GROUP BY ACCODE,BRANCHCD 
		HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0 
		ORDER BY BRANCHCD 

		
		INSERT INTO BFOACCBILL
		SELECT PARTY_CODE=ACCODE,BILL_NO=0,
		SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
		SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@SEC_PAYIN,@SEC_PAYOUT,
		AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),
		0,0,0,0,0,0,0,0,0,0,0,'ZZZ',NARRATION=@NARRATION 
		FROM BFOACCBILL G, VALANACCOUNT, ACCOUNTBFO.DBO.ACMAST 
		WHERE Billdate BETWEEN @BILLDATE AND @BILLDATE +' 23:59:59'
		AND VALANACCOUNT.ACNAME = 'ROUNDING OFF' 
		AND G.Party_Code = CLTCODE 
		AND (BRANCHCD = 'ZZZ' OR ACCAT = 4)
		GROUP BY ACCODE
		HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_ADDITIONAL_PROCESS
-- --------------------------------------------------
CREATE PROC [dbo].[VALAN_ADDITIONAL_PROCESS]
(
	@BILLDATE	VARCHAR(11)
)
AS

DECLARE @SBCCODE VARCHAR(10)
DECLARE @SBCCODEPAY VARCHAR(10) 
DECLARE @KKCCODE VARCHAR(10)
DECLARE @KKCCODEPAY VARCHAR(10) 

SET @SBCCODE = ''
SET @SBCCODEPAY = ''
SET @KKCCODE = ''
SET @KKCCODEPAY = ''

SELECT @KKCCODE = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'KRISHI KALYAN CESS'

SELECT @KKCCODEPAY = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'KRISHI KALYAN CESS PAYABLE'

SELECT @SBCCODE = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'SWACHH BHARAT CESS'

SELECT @SBCCODEPAY = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'SWACHH BHARAT CESS PAYABLE'

IF ISNULL(@SBCCODE,'')='' AND ISNULL(@KKCCODE,'')=''
BEGIN
	RETURN
END

SELECT A.* INTO #SBC
FROM FOACCBILL A, VALANACCOUNT V, BFOGLOBALS
WHERE BILLDATE = @BILLDATE
AND PARTY_CODE = ACCODE
AND V.ACNAME = 'SERVICE TAX'
AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
--AND ISNULL(SBCCHARGE,0) > 0  -- VK

IF (SELECT ISNULL(COUNT(1),0) FROM #SBC) > 0 
BEGIN
	--UPDATE #SBC SET PARTY_CODE = @SBCCODE, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100,2) -- VK
	UPDATE #SBC SET PARTY_CODE = @SBCCODE, AMOUNT = ROUND(AMOUNT * 100 / SERVICE_TAX * 100, 2)
	FROM BFOGLOBALS
	WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	--AND ISNULL(SBCCHARGE,0) > 0  -- VK

	SELECT A.* INTO #SERTAX
	FROM FOACCBILL A, VALANACCOUNT V, BFOGLOBALS
	WHERE BILLDATE = @BILLDATE
	AND PARTY_CODE = ACCODE
	AND V.ACNAME = 'SERVICE TAX'
	AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	--AND ISNULL(SBCCHARGE,0) > 0  --VK

	UPDATE #SERTAX SET AMOUNT = #SERTAX.AMOUNT - #SBC.AMOUNT
	FROM #SBC 
	WHERE #SERTAX.BILLDATE = #SBC.BILLDATE
	AND #SERTAX.BRANCHCD = #SBC.BRANCHCD

	
	INSERT INTO FOACCBILL
	SELECT * FROM #SBC


		SELECT A.* INTO #KKC
		FROM FOACCBILL A, VALANACCOUNT V, BFOGLOBALS
		WHERE BILLDATE = @BILLDATE
		AND PARTY_CODE = ACCODE
		AND V.ACNAME = 'SERVICE TAX'
		AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
		AND ISNULL(KRISHICHARGE,0) > 0

		IF (SELECT ISNULL(COUNT(1),0) FROM #KKC) > 0 
		BEGIN
			UPDATE #KKC SET PARTY_CODE = @KKCCODE, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100,2)
			FROM BFOGLOBALS
			WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
			AND ISNULL(KRISHICHARGE,0) > 0

			UPDATE #SERTAX SET AMOUNT = #SERTAX.AMOUNT - #KKC.AMOUNT
			FROM #KKC 
			WHERE #SERTAX.BILLDATE = #KKC.BILLDATE
			AND #SERTAX.BRANCHCD = #KKC.BRANCHCD


			INSERT INTO FOACCBILL
			SELECT * FROM #KKC

		END
		DROP TABLE #KKC
		
	
	DELETE FROM FOACCBILL
	WHERE BILLDATE = @BILLDATE
	AND EXISTS (SELECT PARTY_CODE FROM #SERTAX WHERE FOACCBILL.PARTY_CODE = #SERTAX.PARTY_CODE)	

	INSERT INTO FOACCBILL
	SELECT * FROM #SERTAX

	DROP TABLE #SERTAX
END
DROP TABLE #SBC

SELECT A.* INTO #PAYSBC
FROM FOACCBILL A, VALANACCOUNT V, BFOGLOBALS
WHERE BILLDATE = @BILLDATE
AND PARTY_CODE = ACCODE
AND V.ACNAME = 'SERVICE TAX PAYABLE'
AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
--AND ISNULL(SBCCHARGE,0) > 0  -- VK

IF (SELECT ISNULL(COUNT(1),0) FROM #PAYSBC) > 0 
BEGIN
	--UPDATE #PAYSBC SET PARTY_CODE = @SBCCODEPAY, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100,2)  --VK
	UPDATE #SBC SET PARTY_CODE = @SBCCODE, AMOUNT = ROUND(AMOUNT * 100 / SERVICE_TAX * 100,2)
	FROM BFOGLOBALS
	WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	--AND ISNULL(SBCCHARGE,0) > 0  -- VK

	SELECT A.* INTO #PAYSERTAX
	FROM FOACCBILL A, VALANACCOUNT V, BFOGLOBALS
	WHERE BILLDATE = @BILLDATE
	AND PARTY_CODE = ACCODE
	AND V.ACNAME = 'SERVICE TAX PAYABLE'
	AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	--AND ISNULL(SBCCHARGE,0) > 0  -- VK

	UPDATE #PAYSERTAX SET AMOUNT = #PAYSERTAX.AMOUNT - #PAYSBC.AMOUNT
	FROM #PAYSBC 
	WHERE #PAYSERTAX.BILLDATE = #PAYSBC.BILLDATE
	AND #PAYSERTAX.BRANCHCD = #PAYSBC.BRANCHCD

	INSERT INTO FOACCBILL
	SELECT * FROM #PAYSBC

		SELECT A.* INTO #PAYKKC
		FROM FOACCBILL A, VALANACCOUNT V, BFOGLOBALS
		WHERE BILLDATE = @BILLDATE
		AND PARTY_CODE = ACCODE
		AND V.ACNAME = 'SERVICE TAX PAYABLE'
		AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
		AND ISNULL(KRISHICHARGE,0) > 0

		IF (SELECT ISNULL(COUNT(1),0) FROM #PAYKKC) > 0 
		BEGIN
			UPDATE #PAYKKC SET PARTY_CODE = @KKCCODEPAY, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100,2)
			FROM BFOGLOBALS
			WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
			AND ISNULL(KRISHICHARGE,0) > 0

			UPDATE #PAYSERTAX SET AMOUNT = #PAYSERTAX.AMOUNT - #PAYKKC.AMOUNT
			FROM #PAYKKC 
			WHERE #PAYSERTAX.BILLDATE = #PAYKKC.BILLDATE
			AND #PAYSERTAX.BRANCHCD = #PAYKKC.BRANCHCD

			DELETE FROM FOACCBILL
			WHERE BILLDATE = @BILLDATE
			AND EXISTS (SELECT PARTY_CODE FROM #PAYSERTAXKKC WHERE FOACCBILL.PARTY_CODE = #PAYSERTAXKKC.PARTY_CODE)

			INSERT INTO FOACCBILL
			SELECT * FROM #PAYKKC

		END
		DROP TABLE #PAYKKC

	DELETE FROM FOACCBILL
	WHERE BILLDATE = @BILLDATE
	AND EXISTS (SELECT PARTY_CODE FROM #PAYSERTAX WHERE FOACCBILL.PARTY_CODE = #PAYSERTAX.PARTY_CODE)

	INSERT INTO FOACCBILL
	SELECT * FROM #PAYSERTAX

	DROP TABLE #PAYSERTAX
END
DROP TABLE #PAYSBC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_GST_BILLPOST
-- --------------------------------------------------

CREATE PROC [dbo].[VALAN_GST_BILLPOST]
(
       @BILLDATE     VARCHAR(11)
)
AS

DECLARE @NARRATION VARCHAR(100),
              @START_DATE   DATETIME,
              @END_DATE     DATETIME,
              @PAYIN_DATE   DATETIME,
              @PAYOUT_DATE DATETIME

SELECT @NARRATION = ISNULL(MAX(NARRATION),'BILL POSTED'),
          @START_DATE = MAX(START_DATE),
          @END_DATE = MAX(END_DATE),
          @PAYIN_DATE = MAX(PAYIN_DATE),
          @PAYOUT_DATE = MAX(PAYOUT_DATE)
FROM BFOACCBILL WHERE Billdate LIKE @BILLDATE + '%'

SELECT N.PARTY_CODE, N.Branch_Code,
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(Exser_Tax),
TARGETSTATE=L_STATE, SOURCESTATE=STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0) 
INTO #GSTDATA
FROM TBL_CLIENT_GST_DATA G, TBL_GST_LOCATION L, BFOBILLVALAN N 
WHERE N.Sauda_Date BETWEEN @BILLDATE AND @BILLDATE + ' 23:59'
AND N.Party_Code = G.PARTY_CODE
AND GST_LOCATION = LOC_CODE
AND @BILLDATE BETWEEN G.EFF_FROM_DATE AND G.EFF_TO_DATE
AND TRADETYPE = 'BT'
AND  SERVICE_TAX > 0 
GROUP BY N.PARTY_CODE,N.Branch_Code,L_STATE,STATE 

INSERT INTO #GSTDATA
SELECT N.PARTY_CODE, N.Branch_Code,
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(Exser_Tax),
TARGETSTATE=L_STATE, SOURCESTATE=FOOWNER.STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0) 
FROM BFOBILLVALAN N, FOOWNER,
TBL_STATE_GST_DATA T, CLIENT1 G
WHERE N.Sauda_Date BETWEEN @BILLDATE AND @BILLDATE + ' 23:59' 
AND FOOWNER.State = STATE_NAME
AND @BILLDATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE 
AND TRADETYPE = 'BT'
AND  SERVICE_TAX > 0 
AND N.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #GSTDATA WHERE N.PARTY_CODE = #GSTDATA.Party_Code)
AND G.CL_CODE = N.Party_Code
GROUP BY N.PARTY_CODE,N.Branch_Code,FOOWNER.STATE, L_STATE 

UPDATE #GSTDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM STATE_MASTER)

UPDATE #GSTDATA SET 
STATE_CODE=D.STATE_CODE,
GST_PER=D.GST_PER,
CGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.CGST_PER ELSE 0 END),
IGST_PER=(CASE WHEN SOURCESTATE <> TARGETSTATE THEN D.IGST_PER ELSE 0 END),
SGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 0 THEN D.SGST_PER ELSE 0 END),
UGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 1 THEN D.UGST_PER ELSE 0 END),
AGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.AGST_PER ELSE 0 END)
FROM TBL_STATE_GST_DATA D
WHERE D.STATE_NAME = SOURCESTATE
AND @BILLDATE BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

UPDATE #GSTDATA SET 
CGST_PER = SERVICE_TAX * CGST_PER / GST_PER,
SGST_PER = SERVICE_TAX * SGST_PER / GST_PER,
IGST_PER = SERVICE_TAX * IGST_PER / GST_PER,
UGST_PER = SERVICE_TAX * UGST_PER / GST_PER,
AGST_PER = SERVICE_TAX * AGST_PER / GST_PER

UPDATE #GSTDATA SET SGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + UGST_PER + AGST_PER)
WHERE SGST_PER > 0 
UPDATE #GSTDATA SET UGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + SGST_PER + AGST_PER)
WHERE UGST_PER > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA WHERE GST_PER > 0) <= 0 
BEGIN
       RETURN
END

IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA WHERE GST_PER > 0) > 0 
BEGIN
       DELETE FROM BFOACCBILL 
       WHERE Billdate LIKE @BILLDATE + '%'
       AND Party_Code IN (SELECT ACCODE FROM Valanaccount
       WHERE ACNAME = 'SERVICE TAX')

       DELETE FROM BFOACCBILL 
       WHERE  Billdate LIKE @BILLDATE + '%'
       AND PARTY_CODE IN (SELECT ACCODE FROM VALANACCOUNT WHERE ACNAME = 'ROUNDING OFF')

       UPDATE BFOACCBILL SET AMOUNT = ROUND(AMOUNT,2)
       WHERE  Billdate LIKE @BILLDATE + '%'
END

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_IGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_IGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_SGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_SGST'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,0,0,0,0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),
0,0,0,0,0,0,0,0,0,0,0,Branchcd,NARRATION=@NARRATION
FROM BFOACCBILL G, VALANACCOUNT 
WHERE Billdate LIKE @BILLDATE + '%'
AND ACNAME = 'ROUNDING OFF' 
AND Branchcd <> 'ZZZ'
GROUP BY ACCODE,BRANCHCD 
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0 
ORDER BY BRANCHCD 

INSERT INTO BFOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),
0,0,0,0,0,0,0,0,0,0,0,'ZZZ',NARRATION=@NARRATION 
FROM BFOACCBILL G, VALANACCOUNT, ACCOUNTBFO.DBO.ACMAST 
WHERE Billdate LIKE @BILLDATE + '%'
AND VALANACCOUNT.ACNAME = 'ROUNDING OFF' 
AND G.Party_Code = CLTCODE 
AND (BRANCHCD = 'ZZZ' OR ACCAT = 4)
GROUP BY ACCODE
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_INTEROP
-- --------------------------------------------------


CREATE PROC [dbo].[VALAN_INTEROP]
(
	@SAUDA_Date VARCHAR(11)
)
AS

DECLARE @CLEARINGCODE	VARCHAR(10) 
 

SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM TBL_INTEROP_SETTING
WHERE  @SAUDA_Date BETWEEN FROM_DATE AND TO_DATE

IF @CLEARINGCODE = ''
BEGIN
	RETURN
END 

DELETE FROM FOACCBILL_ORG 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

INSERT INTO FOACCBILL_ORG 
SELECT * FROM FOACCBILL 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOACCBILL 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOBILLVALAN_ORG
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

INSERT INTO FOBILLVALAN_ORG 
SELECT * FROM FOBILLVALAN 
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOBILLVALAN
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

IF @CLEARINGCODE = 'NSCCL'   
BEGIN
	UPDATE FOACCBILL_ORG SET PARTY_CODE = N.ACCODE FROM NSEFO.DBO.ValanAccount N, BSEFO.DBO.ValanAccount B
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	AND N.AcName = 'Clearing House'
	AND B.AcName = 'Clearing House'
	AND B.AcCode = PARTY_CODE 
	
	UPDATE FOACCBILL_ORG SET PARTY_CODE = N.ACCODE FROM NSEFO.DBO.ValanAccount N, BSEFO.DBO.ValanAccount B
	Where BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	AND N.AcName = 'Rounding Off'
	AND B.AcName = 'Rounding Off'
	AND B.AcCode = PARTY_CODE 
END
ELSE
BEGIN
	SELECT * INTO #ACC_OP FROM NSEFO.DBO.FOACCBILL_ORG 
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	
	INSERT INTO #ACC_OP 
	SELECT PARTY_CODE,BILL_NO,SELL_BUY,SETT_NO,SETT_TYPE,BILLDATE,
	START_DATE=LEFT(START_DATE,11),END_DATE=LEFT(END_DATE,11),PAYIN_DATE=LEFT(PAYIN_DATE,11),PAYOUT_DATE=LEFT(PAYOUT_DATE,11),
	AMOUNT,EXPIRYFLAG='',RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION 
	FROM BSEFO.DBO.FOACCBILL_ORG
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	
	INSERT INTO FOACCBILL  
	SELECT Party_Code,Bill_No,
	Sell_Buy=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 1 ELSE 2 END),
	Sett_No='',Sett_Type='',BillDate,
	Start_Date=MAX(Start_Date),End_Date=MAX(End_Date),
	PayIn_Date=MAX(PayIn_Date),PayOut_Date=MAX(PayOut_Date),
	Amount=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),
MTM=0,
PREMIUMPAYABLE=0,
PREMIUMRECEIVABLE=0,
NETPREMIUM=0,
BROKERAGE=0,
SERVICETAX=0,
	RESERVED1,RESERVED2,RESERVED3,RESERVED4=0,RESERVED5=0,branchCd,narration=MAX(narration)
	FROM #ACC_OP  
	GROUP BY Party_Code,Bill_No,BillDate,branchCd,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3
	
	INSERT INTO BFOBILLVALAN
	SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,PRODUCT_TYPE='',INST_TYPE,ASSET_CODE='',EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	   SYMBOL,SERIES_ID='0',BILLNO,AUCTIONPART,
	   MATURITYDATE,SAUDA_DATE,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,
	   EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,
	   FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,REGION,
	   UPDATEDATE,EMAIL,AREA 
	FROM BSEFO.DBO.FOBILLVALAN_ORG
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'
	  
	INSERT INTO bFOBILLVALAN
	SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,PRODUCT_TYPE='',INST_TYPE,ASSET_CODE='',EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	   SYMBOL,SERIES_ID='0',BILLNO,AUCTIONPART,
	   MATURITYDATE,SAUDA_DATE,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,
	   EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,
	   FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,REGION,
	   UPDATEDATE,EMAIL,AREA 
	FROM NSEFO.DBO.FOBILLVALAN_ORG
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59' 

	update bFOBILLVALAN set PARTICIPANTCODE = B.MEMBERCODE
	FROM FOOWNER B, NSEFO.DBO.FOOWNER N
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'
	AND bFOBILLVALAN.PARTICIPANTCODE = N.MEMBERCODE

	UPDATE bFOBILLVALAN SET 
	PRODUCT_CODE = M.INST_TYPE,
	SERIES_CODE = M.SYMBOL,
	EXPIRYDATE = M.EXPIRYDATE,
	STRIKE_PRICE = M.STRIKE_PRICE,
	OPTION_TYPE = M.OPTION_TYPE
	FROM TBL_FOSCRIPMAP M
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'
	AND bFOBILLVALAN.PRODUCT_CODE = M.N_INST_TYPE
	AND bFOBILLVALAN.SERIES_CODE = M.N_SYMBOL
	AND bFOBILLVALAN.EXPIRYDATE = M.N_EXPIRYDATE
	AND bFOBILLVALAN.STRIKE_PRICE = M.N_STRIKE_PRICE
	AND bFOBILLVALAN.OPTION_TYPE = M.N_OPTION_TYPE

	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_INTEROP_BAK_11082023
-- --------------------------------------------------

--EXEC VALAN_INTEROP 'AUG  9 2023'


CREATE PROC [dbo].[VALAN_INTEROP]
(
	@SAUDA_Date VARCHAR(11)
)
AS

DECLARE @CLEARINGCODE	VARCHAR(10) 
 

SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM TBL_INTEROP_SETTING
WHERE  @SAUDA_Date BETWEEN FROM_DATE AND TO_DATE

IF @CLEARINGCODE = ''
BEGIN
	RETURN
END 

DELETE FROM FOACCBILL_ORG 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

INSERT INTO FOACCBILL_ORG 
SELECT * FROM FOACCBILL 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOACCBILL 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOBILLVALAN_ORG
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

--Change done by VK ----

INSERT INTO FOBILLVALAN_ORG (
PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,
OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MATURITYDATE,SAUDA_DATE,ISIN,PQTY,SQTY,PRATE,SRATE,PAMT,
SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,
SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,TERMINAL_ID,FAMILY,
FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,STATUSNAME,EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,
REGION,UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING)
SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,
OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MATURITYDATE,SAUDA_DATE,ISIN,PQTY,SQTY,PRATE,SRATE,PAMT,
SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,
SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,TERMINAL_ID,FAMILY,
FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,STATUSNAME,EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,
REGION,UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING FROM FOBILLVALAN 
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

--Change done by VK (END) ----


DELETE FROM FOBILLVALAN
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

IF @CLEARINGCODE = 'NSCCL'   
BEGIN
	UPDATE FOACCBILL_ORG SET PARTY_CODE = N.ACCODE FROM NSEFO.DBO.ValanAccount N, BSEFO.DBO.ValanAccount B
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	AND N.AcName = 'Clearing House'
	AND B.AcName = 'Clearing House'
	AND B.AcCode = PARTY_CODE 
	
	UPDATE FOACCBILL_ORG SET PARTY_CODE = N.ACCODE FROM NSEFO.DBO.ValanAccount N, BSEFO.DBO.ValanAccount B
	Where BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	AND N.AcName = 'Rounding Off'
	AND B.AcName = 'Rounding Off'
	AND B.AcCode = PARTY_CODE 
END
ELSE
BEGIN
	SELECT * INTO #ACC_OP FROM NSEFO.DBO.FOACCBILL_ORG 
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	
	INSERT INTO #ACC_OP 
	SELECT PARTY_CODE,BILL_NO,SELL_BUY,SETT_NO,SETT_TYPE,BILLDATE,
	START_DATE=LEFT(START_DATE,11),END_DATE=LEFT(END_DATE,11),PAYIN_DATE=LEFT(PAYIN_DATE,11),PAYOUT_DATE=LEFT(PAYOUT_DATE,11),
	AMOUNT,EXPIRYFLAG='',RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION 
	FROM BSEFO.DBO.FOACCBILL_ORG
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	
	INSERT INTO FOACCBILL  
	SELECT Party_Code,Bill_No,
	Sell_Buy=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 1 ELSE 2 END),
	Sett_No='',Sett_Type='',BillDate,
	Start_Date=MAX(Start_Date),End_Date=MAX(End_Date),
	PayIn_Date=MAX(PayIn_Date),PayOut_Date=MAX(PayOut_Date),
	Amount=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),
MTM=0,
PREMIUMPAYABLE=0,
PREMIUMRECEIVABLE=0,
NETPREMIUM=0,
BROKERAGE=0,
SERVICETAX=0,
	RESERVED1,RESERVED2,RESERVED3,RESERVED4=0,RESERVED5=0,branchCd,narration=MAX(narration)
	FROM #ACC_OP  
	GROUP BY Party_Code,Bill_No,BillDate,branchCd,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3
	
	INSERT INTO BFOBILLVALAN
	SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,PRODUCT_TYPE='',INST_TYPE,ASSET_CODE='',EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	   SYMBOL,SERIES_ID='0',BILLNO,AUCTIONPART,
	   MATURITYDATE,SAUDA_DATE,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,
	   EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,
	   FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,REGION,
	   UPDATEDATE,EMAIL,AREA 
	FROM BSEFO.DBO.FOBILLVALAN_ORG
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'
	  
	INSERT INTO bFOBILLVALAN
	SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,PRODUCT_TYPE='',INST_TYPE,ASSET_CODE='',EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	   SYMBOL,SERIES_ID='0',BILLNO,AUCTIONPART,
	   MATURITYDATE,SAUDA_DATE,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,
	   EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,
	   FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,REGION,
	   UPDATEDATE,EMAIL,AREA 
	FROM NSEFO.DBO.FOBILLVALAN_ORG
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59' 

	update bFOBILLVALAN set PARTICIPANTCODE = B.MEMBERCODE
	FROM FOOWNER B, NSEFO.DBO.FOOWNER N
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'
	AND bFOBILLVALAN.PARTICIPANTCODE = N.MEMBERCODE

	UPDATE bFOBILLVALAN SET 
	PRODUCT_CODE = M.INST_TYPE,
	SERIES_CODE = M.SYMBOL,
	EXPIRYDATE = M.EXPIRYDATE,
	STRIKE_PRICE = M.STRIKE_PRICE,
	OPTION_TYPE = M.OPTION_TYPE
	FROM TBL_FOSCRIPMAP M
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'
	AND bFOBILLVALAN.PRODUCT_CODE = M.N_INST_TYPE
	AND bFOBILLVALAN.SERIES_CODE = M.N_SYMBOL
	AND bFOBILLVALAN.EXPIRYDATE = M.N_EXPIRYDATE
	AND bFOBILLVALAN.STRIKE_PRICE = M.N_STRIKE_PRICE
	AND bFOBILLVALAN.OPTION_TYPE = M.N_OPTION_TYPE

	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALANGENERATE_CLCHRG
-- --------------------------------------------------

CREATE PROC [dbo].[VALANGENERATE_CLCHRG]
(	
	@SAUDA_DATE VARCHAR(11)
)
AS
DECLARE 
		@FROMPARTY	VARCHAR(10),
		@TOPARTY	VARCHAR(10)

 
SET @FROMPARTY = ''
SET @TOPARTY = 'ZZZZZZ'

SELECT TRADE_NO_CNT = 1, T.SNO, FROM_LIMIT, TO_LIMIT  
INTO #TOT
FROM TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG'
AND FROM_LIMIT = (SELECT MIN(FROM_LIMIT) FROM  TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG')

IF (SELECT ISNULL(COUNT(1),0) FROM #TOT ) < 1
BEGIN
	RETURN
END

SELECT A.* INTO #BFOACCBILL 
FROM BFOACCBILL A, VALANACCOUNT V 
WHERE BILLDATE LIKE @SAUDA_DATE + '%'
AND A.PARTY_CODE = V.ACCODE
AND V.ACNAME = 'TURN OVER TAX'

IF (SELECT ISNULL(COUNT(1),0) FROM #BFOACCBILL ) >= 1
BEGIN
	DELETE FROM BFOACCBILL
	WHERE BILLDATE LIKE @SAUDA_DATE + '%'
	AND EXISTS (SELECT PARTY_CODE FROM #BFOACCBILL
				WHERE #BFOACCBILL.BILLDATE LIKE @SAUDA_DATE + '%'
				AND BFOACCBILL.PARTY_CODE = #BFOACCBILL.PARTY_CODE)					

	SELECT SAUDA_DATE, PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		  ORDER_NO, TRADE_NO, SRNO = MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO), TOTFLAG = 1
	INTO #TOTTRADE
	FROM (
			SELECT SAUDA_DATE=LEFT(SAUDA_DATE,11), PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
				   ORDER_NO, TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO), SRNO = 
					MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO)
			FROM BFOSETTLEMENT
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND TRADEQTY > 0 AND TRADE_PRICE > 0
			AND AUCTIONPART <> 'CA'
			GROUP BY LEFT(SAUDA_DATE,11), PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO,TRADE_NO 
			) A 
	GROUP BY SAUDA_DATE, PARTY_CODE, PRODUCT_CODE, SERIES_CODE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO
	 
	CREATE TABLE #CLTAX 
	(
		PARTY_CODE	VARCHAR(10)
	)

	INSERT INTO #CLTAX
	SELECT PARTY_CODE 
	FROM FOCLIENTTAXES 
	WHERE @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
	AND FUT_TURNOVER_TAX <= 0 
	AND EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
				WHERE #TOTTRADE.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE)

	UPDATE #TOTTRADE SET TOTFLAG = 0
	FROM #CLTAX C
	WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

	TRUNCATE TABLE #CLTAX

	INSERT INTO #CLTAX
	SELECT PARTY_CODE 
	FROM CLIENT2 WHERE EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
							   WHERE #TOTTRADE.PARTY_CODE = CLIENT2.CL_CODE)
	AND TURNOVER_TAX <= 0

	UPDATE #TOTTRADE SET TOTFLAG = 0
	FROM #CLTAX C
	WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

	SELECT BRANCH_CD, CHARGE_TAX = SUM(CHARGE_TAX)
	INTO #CLCHRG
	FROM BFOSETTLEMENT, #TOT T, #TOTTRADE T1, TBL_TURNOVER_TAX B, CLIENT1 C2
	WHERE BFOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
	AND BFOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND T.SNO = B.SNO
	AND BFOSETTLEMENT.SRNO = T1.SRNO
	AND TOTFLAG = 1
	AND BFOSETTLEMENT.PARTY_CODE = C2.CL_CODE
	GROUP BY BRANCH_CD

	UPDATE #BFOACCBILL SET AMOUNT = AMOUNT - CLCHRG
	FROM (
			SELECT BRANCH_CD, CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			GROUP BY BRANCH_CD
			HAVING SUM(CHARGE_TAX) <> 0 
			UNION ALL
			SELECT BRANCH_CD='ZZZ', CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			HAVING SUM(CHARGE_TAX) <> 0 
		  ) A
	WHERE BRANCHCD = A.BRANCH_CD
	
	INSERT INTO BFOACCBILL
	SELECT * FROM #BFOACCBILL

	INSERT INTO BFOACCBILL
	SELECT PARTY_CODE=ACCODE,BILL_NO,SELL_BUY,SETT_NO,SETT_TYPE,BILLDATE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,
		   AMOUNT=CLCHRG,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION
    FROM #BFOACCBILL, (
			SELECT BRANCH_CD, CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			GROUP BY BRANCH_CD
			HAVING SUM(CHARGE_TAX) <> 0 
			UNION ALL
			SELECT BRANCH_CD='ZZZ', CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			HAVING SUM(CHARGE_TAX) <> 0 
		  ) A, VALANACCOUNT
	WHERE BRANCHCD = A.BRANCH_CD		  
	AND ACNAME = 'ICCL CLEARING CHARGE'  
	         
	DROP TABLE #TOTTRADE
	DROP TABLE #CLTAX 
	DROP TABLE #TOT
	DROP TABLE #CLCHRG
	DROP TABLE #BFOACCBILL
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VBB_CI_NEW
-- --------------------------------------------------


CREATE PROC [dbo].[VBB_CI_NEW] 
AS 
SELECT DISTINCT PARTY_CODE,TABLE_NAME INTO  #CLT FROM  FOCLIENTBROKSCHEME C WITH(NOLOCK) ,BROKTABLE B  WHERE C.FUT_BROKTABLE  =B.TABLE_NO
AND ( TABLE_NAME LIKE '%VBB%' OR TABLE_NAME LIKE '%Plus%') 
  AND DATE_FROM >CONVERT(VARCHAR(11),GETDATE()-5,120)  AND DATE_TO > GETDATE() 

  CREATE INDEX #CL ON #CLT (PARTY_CODE)
  
INSERT INTO Scheme_Mapping
SELECT DISTINCT * FROM (
SELECT  PARTY_CODE,'O' A , 'FUT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,	MIN_BROK	,MAX_BROK,'0.0000' S,'-1.0000' T,
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM 
(
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER,	DEL_TO_TURNOVER	 AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE
AND DEL_SCHEME_ID <> '' 
UNION ALL
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER,	TO_TURNOVER	,MIN_BROK,	MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE 
AND TRD_SCHEME_ID <> ''
) A ,
Scheme_Master S ,#CLT V
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER
---AND PARTY_CODE  IN (SELECT * FROM #CL)
) A
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE)
UNION ALL
SELECT DISTINCT * FROM (
SELECT  PARTY_CODE,'O' A , 'OPT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,	MIN_BROK	,MAX_BROK,'0.0000' S,'-1.0000' T,
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM 
(
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER,	DEL_TO_TURNOVER	 AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE 
AND DEL_SCHEME_ID <> ''
UNION ALL
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER,	TO_TURNOVER	,MIN_BROK,	MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE
AND TRD_SCHEME_ID <> ''
 ) A ,
Scheme_Master S ,#CLT V
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER
---AND PARTY_CODE  IN (SELECT * FROM #CL)
) A
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE) 


UPDATE R SET CR_Date_To = CR_Date_FROM-1 + ' 23:59:59.000'
FROM  CONTRACT_ROUNDING R, #CLT C WHERE CR_Party_Code =C.Party_Code AND CR_Date_To >= GETDATE()

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VBB_CI_NEW_CLIENT
-- --------------------------------------------------
   
     
CREATE PROC [dbo].[VBB_CI_NEW_CLIENT] (@PARTY_CODE VARCHAR(10),@BROK_SCHEME VARCHAR(50))     
AS     
    
--SELECT DISTINCT PARTY_CODE =@PARTY_CODE ,TABLE_NAME =@BROK_SCHEME INTO #CLT     
    
--CREATE INDEX #CL ON #CLT (PARTY_CODE)    
    
SELECT DISTINCT PARTY_CODE =Cl_Code ,TABLE_NAME =@BROK_SCHEME INTO #CLT     
From Client5 With(Nolock) where Cl_code =@PARTY_CODE    
    
CREATE INDEX #CL ON #CLT (PARTY_CODE)    
    
IF(Select Count(1) from #CLT) >=1    
Begin     
    
      
UPDATE Scheme_Mapping SET SP_Date_To= CONVERT(VARCHAR(11),GETDATE()-1,120)  + ' 23:59:59.000' WHERE SP_Party_Code =@PARTY_CODE AND  SP_Date_To >GETDATE()    
    
INSERT INTO Scheme_Mapping    
    
---Select top 1 *from Scheme_Mapping    
SELECT DISTINCT * FROM (    
SELECT  PARTY_CODE,'O' A , 'FUT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,    
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,    
SM_Value_From,SM_Value_To,SM_ComputationOn,SM_ComputationType, MIN_BROK ,MAX_BROK,'0.0000' S,'-1.0000' T,    
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R,SM_TurnOverOn,'' SCRip FROM     
(    
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER, DEL_TO_TURNOVER  AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK    
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE     
AND DEL_SCHEME_ID <> ''    
UNION ALL    
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER, TO_TURNOVER ,MIN_BROK, MAX_BROK     
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE    
AND TRD_SCHEME_ID <> ''    
 ) A ,    
Scheme_Master S ,#CLT V    
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'    
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER    
---AND PARTY_CODE  IN (SELECT * FROM #CL)    
) A    
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE AND SP_Date_To >GETDATE())     
UNION ALL    
SELECT DISTINCT *  FROM (    
SELECT  PARTY_CODE,'O' A , 'OPT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,    
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,    
SM_Value_From,SM_Value_To,SM_ComputationOn,SM_ComputationType, MIN_BROK ,MAX_BROK,'0.0000' S,'-1.0000' T,    
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R,SM_TurnOverOn,'' SCRip FROM     
(    
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER, DEL_TO_TURNOVER  AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK    
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE    
AND DEL_SCHEME_ID <> ''     
UNION ALL    
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER, TO_TURNOVER ,MIN_BROK, MAX_BROK     
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE    
AND TRD_SCHEME_ID <> ''    
 ) A ,    
Scheme_Master S ,#CLT V    
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'    
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER    
---AND PARTY_CODE  IN (SELECT * FROM #CL)    
) A    
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE AND SP_Date_To >GETDATE())     
    
UPDATE R SET CR_Date_To = CR_Date_FROM-1 + ' 23:59:59.000'    
FROM  CONTRACT_ROUNDING R, #CLT C WHERE CR_Party_Code =C.Party_Code  AND CR_Date_To >= GETDATE()    
    
    
UPDATE R SET TODATE = CONVERT(VARCHAR(11),GETDATE()-1,120) + ' 23:59:59.000'    
FROM  TBL_ADDITIONAL_BROEKRAGE R, #CLT C WHERE R.Party_Code =C.Party_Code  AND TODATE >= GETDATE()    
    
     SELECT 'BSE' AS EXCHANGE,'FUTURES' AS SEGMENT, @BROK_SCHEME+' UPDATED' AS STATUS 
    
END    
ELSE     
BEGIN     
  Select 'BSE' AS EXCHANGE,'FUTURES' AS SEGMENT,'Client Not Registered' As Status    
    
   Return    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------
    
CREATE PROC Vw @VwName VARCHAR(25)AS                   
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- TABLE dbo.ACCBILL
-- --------------------------------------------------
CREATE TABLE [dbo].[ACCBILL]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [START_DATE] DATETIME NOT NULL,
    [END_DATE] DATETIME NOT NULL,
    [PAYIN_DATE] DATETIME NOT NULL,
    [PAYOUT_DATE] DATETIME NOT NULL,
    [AMOUNT] MONEY NOT NULL,
    [BRANCHCD] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACCBILL_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[ACCBILL_ORG]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Start_Date] DATETIME NOT NULL,
    [End_Date] DATETIME NOT NULL,
    [Payin_Date] DATETIME NOT NULL,
    [Payout_Date] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Area
-- --------------------------------------------------
CREATE TABLE [dbo].[Area]
(
    [Areacode] VARCHAR(20) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUTHORISEDSIGNETORIES
-- --------------------------------------------------
CREATE TABLE [dbo].[AUTHORISEDSIGNETORIES]
(
    [Authorisedsignetory1] VARCHAR(100) NULL,
    [Authorisedsignetory2] VARCHAR(100) NULL,
    [Authorisedsignetory3] VARCHAR(100) NULL,
    [Authorisedsignetory4] VARCHAR(100) NULL,
    [Authorisedsignetory5] VARCHAR(100) NULL,
    [Authorisedsignetory6] VARCHAR(100) NULL,
    [Authorisedsignetory7] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.baddebts
-- --------------------------------------------------
CREATE TABLE [dbo].[baddebts]
(
    [Client Code] NVARCHAR(255) NULL,
    [Amount] FLOAT NULL,
    [type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_APR2017
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_APR2017]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_FEB2017
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_FEB2017]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_MAR2017
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_MAR2017]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_OCT2016
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_OCT2016]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_BFOSETTLEMENTJUN272017
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_BFOSETTLEMENTJUN272017]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BBGBFOSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[BBGBFOSETTLEMENT]
(
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bd
-- --------------------------------------------------
CREATE TABLE [dbo].[bd]
(
    [Clientcode] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [baddebt_recovery] FLOAT NULL,
    [TYPE] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bdr_details
-- --------------------------------------------------
CREATE TABLE [dbo].[bdr_details]
(
    [Clientcode] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [baddebt_recovery] FLOAT NULL,
    [Rec_Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoAccBill
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoAccBill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [BillDate] SMALLDATETIME NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [MTM] MONEY NULL,
    [PREMIUMPAYABLE] MONEY NULL,
    [PREMIUMRECEIVABLE] MONEY NULL,
    [NETPREMIUM] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [SERVICETAX] MONEY NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL,
    [RESERVED3] MONEY NULL,
    [RESERVED4] MONEY NULL,
    [RESERVED5] INT NULL,
    [branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOAdhocMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOAdhocMargin]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [AddMargin] MONEY NULL,
    [ChargeFlag] CHAR(1) NULL,
    [DIS_Penalty] MONEY NULL,
    [MWL_Penalty] MONEY NULL,
    [CLPL_Penalty] MONEY NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOAdhocMargin_Exch
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOAdhocMargin_Exch]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [AddMargin] MONEY NULL,
    [ChargeFlag] CHAR(1) NULL,
    [DIS_Penalty] MONEY NULL,
    [MWL_Penalty] MONEY NULL,
    [CLPL_Penalty] MONEY NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOAdhocMargin_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOAdhocMargin_Imp]
(
    [Sauda_Date] VARCHAR(11) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [AddMargin] MONEY NULL,
    [ChargeFlag] CHAR(1) NULL,
    [DIS_Penalty] MONEY NULL,
    [MWL_Penalty] MONEY NULL,
    [CLPL_Penalty] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoBillno
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoBillno]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [BILLDATE] SMALLDATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOBILLVALAN
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOBILLVALAN]
(
    [PARTY_CODE] VARCHAR(15) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CLIENT_TYPE] VARCHAR(20) NOT NULL,
    [BILLNO] VARCHAR(20) NOT NULL,
    [CONTRACTNO] VARCHAR(20) NOT NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(9, 0) NULL,
    [LOT_SIZE] NUMERIC(9, 0) NULL,
    [AUCTIONPART] VARCHAR(20) NOT NULL,
    [MATURITYDATE] DATETIME NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PQTY] INT NOT NULL,
    [SQTY] INT NOT NULL,
    [PRATE] NUMERIC(36, 12) NOT NULL,
    [SRATE] NUMERIC(36, 12) NOT NULL,
    [PAMT] NUMERIC(36, 12) NOT NULL,
    [SAMT] NUMERIC(36, 12) NOT NULL,
    [PBROKAMT] NUMERIC(36, 12) NOT NULL,
    [SBROKAMT] NUMERIC(36, 12) NOT NULL,
    [PBILLAMT] NUMERIC(36, 12) NOT NULL,
    [SBILLAMT] NUMERIC(36, 12) NOT NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [CL_CHRG] NUMERIC(36, 12) NOT NULL,
    [EXCL_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [EXSER_TAX] NUMERIC(36, 12) NOT NULL,
    [INEXSERFLAG] SMALLINT NOT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_NOTE] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [TRADETYPE] VARCHAR(20) NOT NULL,
    [PARTICIPANTCODE] VARCHAR(25) NOT NULL,
    [FAMILY] VARCHAR(20) NOT NULL,
    [FAMILYNAME] VARCHAR(100) NOT NULL,
    [TRADER] VARCHAR(40) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [SUB_BROKER] VARCHAR(20) NOT NULL,
    [REGION] VARCHAR(20) NULL,
    [UPDATEDATE] VARCHAR(11) NOT NULL,
    [EMAIL] VARCHAR(100) NOT NULL,
    [AREA] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOBILLVALAN_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOBILLVALAN_ORG]
(
    [PARTY_CODE] VARCHAR(15) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CLIENT_TYPE] VARCHAR(20) NOT NULL,
    [BILLNO] VARCHAR(20) NOT NULL,
    [CONTRACTNO] VARCHAR(20) NOT NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(9, 0) NULL,
    [LOT_SIZE] NUMERIC(9, 0) NULL,
    [AUCTIONPART] VARCHAR(20) NOT NULL,
    [MATURITYDATE] DATETIME NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PQTY] INT NOT NULL,
    [SQTY] INT NOT NULL,
    [PRATE] NUMERIC(36, 12) NOT NULL,
    [SRATE] NUMERIC(36, 12) NOT NULL,
    [PAMT] NUMERIC(36, 12) NOT NULL,
    [SAMT] NUMERIC(36, 12) NOT NULL,
    [PBROKAMT] NUMERIC(36, 12) NOT NULL,
    [SBROKAMT] NUMERIC(36, 12) NOT NULL,
    [PBILLAMT] NUMERIC(36, 12) NOT NULL,
    [SBILLAMT] NUMERIC(36, 12) NOT NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [CL_CHRG] NUMERIC(36, 12) NOT NULL,
    [EXCL_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [EXSER_TAX] NUMERIC(36, 12) NOT NULL,
    [INEXSERFLAG] SMALLINT NOT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_NOTE] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [TRADETYPE] VARCHAR(20) NOT NULL,
    [PARTICIPANTCODE] VARCHAR(25) NOT NULL,
    [FAMILY] VARCHAR(20) NOT NULL,
    [FAMILYNAME] VARCHAR(100) NOT NULL,
    [TRADER] VARCHAR(40) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [SUB_BROKER] VARCHAR(20) NOT NULL,
    [REGION] VARCHAR(20) NULL,
    [UPDATEDATE] VARCHAR(11) NOT NULL,
    [EMAIL] VARCHAR(100) NOT NULL,
    [AREA] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoclearingchrg
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoclearingchrg]
(
    [Party_code] VARCHAR(10) NULL,
    [orderno] VARCHAR(20) NULL,
    [series_code] VARCHAR(14) NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [Clearingcharges] MONEY NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOCLOSING
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOCLOSING]
(
    [TRADE_DATE] DATETIME NULL,
    [SESSION_ID] NUMERIC(10, 0) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [PRV_CLOSE_PRICE] NUMERIC(20, 4) NULL,
    [OPEN_PRICE] NUMERIC(20, 4) NULL,
    [HIGH_PRICE] NUMERIC(20, 4) NULL,
    [LOW_PRICE] NUMERIC(20, 4) NULL,
    [CLOSE_PRICE] NUMERIC(20, 4) NULL,
    [TOTAL_TRADED_QTY] NUMERIC(12, 0) NULL,
    [TOTAL_TRADED_VALUE] NUMERIC(20, 4) NULL,
    [AVRG_TRADED_PRICE] NUMERIC(20, 4) NULL,
    [NO_OF_TRADES] NUMERIC(12, 0) NULL,
    [WEEK_HIGH] NUMERIC(20, 4) NULL,
    [WEEK_LOW] NUMERIC(20, 4) NULL,
    [OPEN_INTEREST] NUMERIC(12, 0) NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOCLOSING_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOCLOSING_IMP]
(
    [TRADE_DATE] DATETIME NULL,
    [SESSION_ID] NUMERIC(10, 0) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [PRV_CLOSE_PRICE] VARCHAR(20) NULL,
    [OPEN_PRICE] VARCHAR(20) NULL,
    [HIGH_PRICE] VARCHAR(20) NULL,
    [LOW_PRICE] VARCHAR(20) NULL,
    [CLOSE_PRICE] NUMERIC(20, 4) NULL,
    [TOTAL_TRADED_QTY] VARCHAR(20) NULL,
    [TOTAL_TRADED_VALUE] VARCHAR(20) NULL,
    [AVRG_TRADED_PRICE] VARCHAR(20) NULL,
    [NO_OF_TRADES] VARCHAR(20) NULL,
    [WEEK_HIGH] VARCHAR(20) NULL,
    [WEEK_LOW] VARCHAR(20) NULL,
    [OPEN_INTEREST] NUMERIC(12, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfodetails
-- --------------------------------------------------
CREATE TABLE [dbo].[bfodetails]
(
    [party_code] VARCHAR(15) NOT NULL,
    [margindate] DATETIME NOT NULL,
    [ledgeramount] MONEY NOT NULL,
    [cashcoll] MONEY NOT NULL,
    [noncash] MONEY NOT NULL,
    [margin] MONEY NOT NULL,
    [lasttradedate] DATETIME NULL,
    [region] VARCHAR(25) NULL,
    [branch] VARCHAR(25) NULL,
    [sbtag] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bfoerrorlog
-- --------------------------------------------------
CREATE TABLE [dbo].[Bfoerrorlog]
(
    [ErrDate] SMALLDATETIME NULL,
    [CName] VARCHAR(200) NULL,
    [MName] VARCHAR(200) NULL,
    [SName] VARCHAR(200) NULL,
    [ErrStr] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOERRTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOERRTRADE]
(
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] CHAR(2) NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETTFLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(6) NULL,
    [TRADE_PRICE] NUMERIC(20, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(6) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(6) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] CHAR(1) NULL,
    [RESERVED1] TINYINT NULL,
    [RESERVED2] TINYINT NULL,
    [RESERVED3] TINYINT NULL,
    [RESERVED4] TINYINT NULL,
    [RESERVED5] TINYINT NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOEXALLOCSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOEXALLOCSETTLEMENT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOEXALLOCTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOEXALLOCTRADE]
(
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] CHAR(2) NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETTFLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(20, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(6) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(6) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] CHAR(1) NULL,
    [RESERVED1] TINYINT NULL,
    [RESERVED2] TINYINT NULL,
    [RESERVED3] TINYINT NULL,
    [RESERVED4] TINYINT NULL,
    [RESERVED5] TINYINT NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOEXERCISEALLOCATION
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOEXERCISEALLOCATION]
(
    [POSITION_DATE] DATETIME NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [MEMBER_TYPE] CHAR(1) NULL,
    [TM_CODE] VARCHAR(12) NULL,
    [ACCOUNT_TYPE] CHAR(1) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] INT NULL,
    [BF_LONG_QTY] NUMERIC(9, 0) NULL,
    [BF_LONG_VALUE] NUMERIC(22, 2) NULL,
    [BF_SHORT_QTY] NUMERIC(9, 0) NULL,
    [BF_SHORT_VALUE] NUMERIC(22, 2) NULL,
    [DAY_BUY_QTY] NUMERIC(9, 0) NULL,
    [DAY_BUY_VALUE] NUMERIC(22, 2) NULL,
    [DAY_SELL_QTY] NUMERIC(9, 0) NULL,
    [DAY_SELL_VALUE] NUMERIC(22, 2) NULL,
    [PRE_LONG_QTY] NUMERIC(9, 0) NULL,
    [PRE_LONG_VALUE] NUMERIC(22, 2) NULL,
    [PRE_SHORT_QTY] NUMERIC(9, 0) NULL,
    [PRE_SHORT_VALUE] NUMERIC(22, 2) NULL,
    [EXERCISED_QTY] NUMERIC(9, 0) NULL,
    [ASSIGNED_QTY] NUMERIC(9, 0) NULL,
    [POST_LONG_QTY] NUMERIC(9, 0) NULL,
    [POST_LONG_VALUE] NUMERIC(22, 2) NULL,
    [POST_SHORT_QTY] NUMERIC(9, 0) NULL,
    [POST_SHORT_VALUE] NUMERIC(22, 2) NULL,
    [SETTLEMENT_PRICE] NUMERIC(11, 4) NULL,
    [NET_PREMIUM] NUMERIC(22, 2) NULL,
    [DAILY_MTM_SETTLEMENT_VALUE] NUMERIC(22, 2) NULL,
    [FINAL_SETTLEMENT_VALUE] NUMERIC(22, 2) NULL,
    [EXERCISED_ASSIGNED_VALUE] NUMERIC(22, 2) NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOEXERCISEALLOCATION_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOEXERCISEALLOCATION_IMP]
(
    [POSITION_DATE] DATETIME NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [MEMBER_TYPE] CHAR(1) NULL,
    [TM_CODE] VARCHAR(12) NULL,
    [ACCOUNT_TYPE] CHAR(1) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [CA_LEVEL] INT NULL,
    [BF_LONG_QTY] NUMERIC(9, 0) NULL,
    [BF_LONG_VALUE] NUMERIC(22, 2) NULL,
    [BF_SHORT_QTY] NUMERIC(9, 0) NULL,
    [BF_SHORT_VALUE] NUMERIC(22, 2) NULL,
    [DAY_BUY_QTY] NUMERIC(9, 0) NULL,
    [DAY_BUY_VALUE] NUMERIC(22, 2) NULL,
    [DAY_SELL_QTY] NUMERIC(9, 0) NULL,
    [DAY_SELL_VALUE] NUMERIC(22, 2) NULL,
    [PRE_LONG_QTY] NUMERIC(9, 0) NULL,
    [PRE_LONG_VALUE] NUMERIC(22, 2) NULL,
    [PRE_SHORT_QTY] NUMERIC(9, 0) NULL,
    [PRE_SHORT_VALUE] NUMERIC(22, 2) NULL,
    [EXERCISED_QTY] NUMERIC(9, 0) NULL,
    [ASSIGNED_QTY] NUMERIC(9, 0) NULL,
    [POST_LONG_QTY] NUMERIC(9, 0) NULL,
    [POST_LONG_VALUE] NUMERIC(22, 2) NULL,
    [POST_SHORT_QTY] NUMERIC(9, 0) NULL,
    [POST_SHORT_VALUE] NUMERIC(22, 2) NULL,
    [SETTLEMENT_PRICE] NUMERIC(11, 4) NULL,
    [NET_PREMIUM] NUMERIC(22, 2) NULL,
    [DAILY_MTM_SETTLEMENT_VALUE] NUMERIC(22, 2) NULL,
    [FINAL_SETTLEMENT_VALUE] NUMERIC(22, 2) NULL,
    [EXERCISED_ASSIGNED_VALUE] NUMERIC(22, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOEXPIRYBACKUP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOEXPIRYBACKUP]
(
    [SRNO] INT NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] NUMERIC(10, 0) NULL,
    [ORDER_NO] VARCHAR(16) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL,
    [EXP_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOEXPIRYSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOEXPIRYSETTLEMENT]
(
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] NUMERIC(10, 0) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoFinalClosing
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoFinalClosing]
(
    [ClosingDate] SMALLDATETIME NOT NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Cl_Rate] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOFTTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOFTTRADE]
(
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] CHAR(2) NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CA_LEVEL] VARCHAR(11) NULL,
    [BUY_BROKER] VARCHAR(6) NULL,
    [SELL_BROKER] VARCHAR(6) NULL,
    [TRADE_PRICE] NUMERIC(20, 4) NULL,
    [TRADEQTY] NUMERIC(12, 0) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [BUYER_LOCATIONID] VARCHAR(16) NULL,
    [BUY_CM_CODE] VARCHAR(6) NULL,
    [SELL_CM_CODE] VARCHAR(6) NULL,
    [SELLER_LOCATIONID] VARCHAR(16) NULL,
    [BUY_PARTICIPANT] VARCHAR(12) NULL,
    [BUY_CONFIRMATION] VARCHAR(1) NULL,
    [SELL_PARTICIPANT] VARCHAR(12) NULL,
    [SELL_CONFIRMATION] VARCHAR(1) NULL,
    [BUY_OC_FLAG] VARCHAR(1) NULL,
    [SELL_OC_FLAG] VARCHAR(1) NULL,
    [BUY_OLD_PARTICIPANT] VARCHAR(12) NULL,
    [BUY_OLD_CM_CODE] VARCHAR(6) NULL,
    [SELL_OLD_PARTICIPANT] VARCHAR(12) NULL,
    [SELL_OLD_CM_CODE] VARCHAR(6) NULL,
    [BUY_TERMINALID] VARCHAR(20) NULL,
    [SELL_TERMINALID] VARCHAR(20) NULL,
    [BUY_ORDER_NO] VARCHAR(20) NULL,
    [SELL_ORDER_NO] VARCHAR(20) NULL,
    [BUY_CLIENT_CODE] VARCHAR(12) NULL,
    [SELL_CLIENT_CODE] VARCHAR(12) NULL,
    [BUY_REMARKS] VARCHAR(24) NULL,
    [SELL_REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [BUY_PRO_CLI] VARCHAR(1) NULL,
    [SELL_PRO_CLI] VARCHAR(1) NULL,
    [BUY_ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [SELL_ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [BUY_ORDER_ACTIVEFLAG] CHAR(1) NULL,
    [SELL_ORDER_ACTIVEFLAG] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOFTTRADE_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOFTTRADE_IMP]
(
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] VARCHAR(20) NULL,
    [TRADESTATUS] CHAR(2) NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(15) NULL,
    [ASSET_CODE] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CA_LEVEL] VARCHAR(11) NULL,
    [BUY_BROKER] VARCHAR(6) NULL,
    [SELL_BROKER] VARCHAR(6) NULL,
    [TRADE_PRICE] NUMERIC(20, 4) NULL,
    [TRADEQTY] NUMERIC(12, 0) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [BUYER_LOCATIONID] VARCHAR(16) NULL,
    [BUY_CM_CODE] VARCHAR(6) NULL,
    [SELL_CM_CODE] VARCHAR(6) NULL,
    [SELLER_LOCATIONID] VARCHAR(16) NULL,
    [BUY_PARTICIPANT] VARCHAR(12) NULL,
    [BUY_CONFIRMATION] VARCHAR(1) NULL,
    [SELL_PARTICIPANT] VARCHAR(12) NULL,
    [SELL_CONFIRMATION] VARCHAR(1) NULL,
    [BUY_OC_FLAG] VARCHAR(1) NULL,
    [SELL_OC_FLAG] VARCHAR(1) NULL,
    [BUY_OLD_PARTICIPANT] VARCHAR(12) NULL,
    [BUY_OLD_CM_CODE] VARCHAR(6) NULL,
    [SELL_OLD_PARTICIPANT] VARCHAR(12) NULL,
    [SELL_OLD_CM_CODE] VARCHAR(6) NULL,
    [BUY_TERMINALID] VARCHAR(20) NULL,
    [SELL_TERMINALID] VARCHAR(20) NULL,
    [BUY_ORDER_NO] VARCHAR(20) NULL,
    [SELL_ORDER_NO] VARCHAR(20) NULL,
    [BUY_CLIENT_CODE] VARCHAR(12) NULL,
    [SELL_CLIENT_CODE] VARCHAR(12) NULL,
    [BUY_REMARKS] VARCHAR(24) NULL,
    [SELL_REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [BUY_PRO_CLI] VARCHAR(1) NULL,
    [SELL_PRO_CLI] VARCHAR(1) NULL,
    [BUY_ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [SELL_ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [BUY_ORDER_ACTIVEFLAG] CHAR(1) NULL,
    [SELL_ORDER_ACTIVEFLAG] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfofuttrade
-- --------------------------------------------------
CREATE TABLE [dbo].[bfofuttrade]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoglobals
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoglobals]
(
    [year] VARCHAR(4) NULL,
    [exchange] VARCHAR(3) NULL,
    [service_tax] MONEY NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] SMALLINT NULL,
    [sebi_turn_ac] SMALLINT NULL,
    [broker_note_ac] SMALLINT NULL,
    [other_chrg_ac] SMALLINT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NULL,
    [year_end_dt] DATETIME NULL,
    [CESS_Tax] NUMERIC(10, 9) NULL,
    [TrdBuyTrans] NUMERIC(18, 4) NULL,
    [TrdSellTrans] NUMERIC(18, 4) NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [OptTrdSellTrans] NUMERIC(18, 4) NULL,
    [OptDelSellTrans] NUMERIC(18, 4) NULL,
    [STT_On] VARCHAR(7) NULL,
    [SBCCHARGE] NUMERIC(18, 4) NULL,
    [KRISHICHARGE] NUMERIC(18, 4) NULL,
    [FODELSTT] NUMERIC(18, 9) NULL,
    [IPFTCHRG_FUT] NUMERIC(18, 4) NULL,
    [IPFTCHRG_OPT] NUMERIC(18, 4) NULL,
    [IPFTCHRG_INS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOGLOBALS_BAK_KKCUPD
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOGLOBALS_BAK_KKCUPD]
(
    [year] VARCHAR(4) NULL,
    [exchange] VARCHAR(3) NULL,
    [service_tax] MONEY NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] SMALLINT NULL,
    [sebi_turn_ac] SMALLINT NULL,
    [broker_note_ac] SMALLINT NULL,
    [other_chrg_ac] SMALLINT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NULL,
    [year_end_dt] DATETIME NULL,
    [CESS_Tax] NUMERIC(10, 9) NULL,
    [TrdBuyTrans] NUMERIC(18, 4) NULL,
    [TrdSellTrans] NUMERIC(18, 4) NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [OptTrdSellTrans] NUMERIC(18, 4) NULL,
    [OptDelSellTrans] NUMERIC(18, 4) NULL,
    [STT_On] VARCHAR(7) NULL,
    [KRISHICHARGE] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoglobals_BKUP_14Aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoglobals_BKUP_14Aug2023]
(
    [year] VARCHAR(4) NULL,
    [exchange] VARCHAR(3) NULL,
    [service_tax] MONEY NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] SMALLINT NULL,
    [sebi_turn_ac] SMALLINT NULL,
    [broker_note_ac] SMALLINT NULL,
    [other_chrg_ac] SMALLINT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NULL,
    [year_end_dt] DATETIME NULL,
    [CESS_Tax] NUMERIC(10, 9) NULL,
    [TrdBuyTrans] NUMERIC(18, 4) NULL,
    [TrdSellTrans] NUMERIC(18, 4) NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [OptTrdSellTrans] NUMERIC(18, 4) NULL,
    [OptDelSellTrans] NUMERIC(18, 4) NULL,
    [STT_On] VARCHAR(7) NULL,
    [KRISHICHARGE] NUMERIC(18, 4) NULL,
    [IPFTCHRG_FUT] NUMERIC(18, 4) NULL,
    [IPFTCHRG_OPT] NUMERIC(18, 4) NULL,
    [IPFTCHRG_INS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOMARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOMARGIN]
(
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(16) NULL,
    [SPAN_MARGIN] NUMERIC(22, 2) NULL,
    [EXTREME_LOSS_MARGIN] NUMERIC(22, 2) NULL,
    [NET_PREMIUM] NUMERIC(22, 2) NULL,
    [DAILY_MTM_SETTLEMENT_VALUE] NUMERIC(22, 2) NULL,
    [FINAL_SETTLEMENT_MARGIN] NUMERIC(22, 2) NULL,
    [TOTAL_MARGIN] NUMERIC(22, 2) NULL,
    [ACCOUNT_TYPE] CHAR(3) NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL,
    [FILLER1_MAR] NUMERIC(18, 4) NULL,
    [FILLER2_MAR] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOMARGIN_EXCH
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOMARGIN_EXCH]
(
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(16) NULL,
    [SPAN_MARGIN] NUMERIC(22, 2) NULL,
    [EXTREME_LOSS_MARGIN] NUMERIC(22, 2) NULL,
    [NET_PREMIUM] NUMERIC(22, 2) NULL,
    [DAILY_MTM_SETTLEMENT_VALUE] NUMERIC(22, 2) NULL,
    [FINAL_SETTLEMENT_MARGIN] NUMERIC(22, 2) NULL,
    [TOTAL_MARGIN] NUMERIC(22, 2) NULL,
    [ACCOUNT_TYPE] CHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOMARGIN_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOMARGIN_IMP]
(
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(16) NULL,
    [SPAN_MARGIN] NUMERIC(22, 2) NULL,
    [EXTREME_LOSS_MARGIN] NUMERIC(22, 2) NULL,
    [NET_PREMIUM] NUMERIC(22, 2) NULL,
    [DAILY_MTM_SETTLEMENT_VALUE] NUMERIC(22, 2) NULL,
    [FINAL_SETTLEMENT_MARGIN] NUMERIC(22, 2) NULL,
    [TOTAL_MARGIN] NUMERIC(22, 2) NULL,
    [ACCOUNT_TYPE] CHAR(3) NULL,
    [FILLER1_MAR] NUMERIC(18, 4) NULL,
    [FILLER2_MAR] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOOWNER
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOOWNER]
(
    [Company] VARCHAR(200) NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(25) NULL,
    [Zip] VARCHAR(10) NULL,
    [city] VARCHAR(20) NULL,
    [membertype] VARCHAR(15) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] INT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [TradingFees] MONEY NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgTrdfees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [TrdFeePerValue] MONEY NULL,
    [ClFeePerValue] MONEY NULL,
    [Tm_Code] VARCHAR(10) NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [clrgchg] INT NULL,
    [chmclchrg] INT NULL,
    [StampDuty] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [TaxesFlag] INT NULL,
    [expdeposit] MONEY NULL,
    [Sebi_Regn_No] VARCHAR(30) NULL,
    [style] INT NULL,
    [contno] VARCHAR(7) NULL,
    [State] VARCHAR(50) NULL,
    [SebiNo] VARCHAR(10) NULL,
    [KEEPINST] TINYINT NULL,
    [EMAIL] VARCHAR(100) NULL,
    [SMTP_SRV_NAME] VARCHAR(100) NULL,
    [BROKERSEBIREGNO] VARCHAR(20) NULL,
    [FAX] VARCHAR(25) NULL,
    [SERVICES_TAXNO] VARCHAR(25) NULL,
    [WEBSITE_ID] VARCHAR(100) NULL,
    [PANNO] VARCHAR(15) NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(50) NULL,
    [COMPLIANCE_PHONE] VARCHAR(50) NULL,
    [COMPLIANCE_MOBILE] VARCHAR(50) NULL,
    [LOGO_FILE_PATH] VARCHAR(300) NULL,
    [CIN] VARCHAR(30) NULL,
    [TURN_CHRG_ON] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP1
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP1]
(
    [PRODUCT_TYPE] VARCHAR(5) NULL,
    [PRODUCT_CODE] VARCHAR(10) NULL,
    [UL_ASSET_CODE] VARCHAR(7) NULL,
    [UL_ASSET_TYPE] VARCHAR(4) NULL,
    [SCRIP_ID] INT NULL,
    [MULTIPLIER] MONEY NULL,
    [MARKETLOT] INT NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [TICKSIZE] INT NULL,
    [DECIMALLOCATOR] INT NULL,
    [EXPIRATIONTIMESTAMP] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP1_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP1_IMP]
(
    [PRODUCT_TYPE] VARCHAR(5) NULL,
    [PRODUCT_CODE] VARCHAR(10) NULL,
    [UL_ASSET_CODE] VARCHAR(7) NULL,
    [UL_ASSET_TYPE] VARCHAR(4) NULL,
    [SCRIP_ID] INT NULL,
    [MULTIPLIER] MONEY NULL,
    [MARKETLOT] INT NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [TICKSIZE] INT NULL,
    [DECIMALLOCATOR] INT NULL,
    [EXPIRATIONTIMESTAMP] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP2
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP2]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [UNDERLYING_ASSET] VARCHAR(20) NULL,
    [CA_LEVEL] VARCHAR(12) NULL,
    [BASE_PRICE] NUMERIC(20, 4) NULL,
    [STARTDATE] DATETIME NULL,
    [MATURITYDATE] DATETIME NULL,
    [EXERCISE_STARTDATE] DATETIME NULL,
    [EXERCISE_ENDDATE] DATETIME NULL,
    [MINIMUM_LOT_SIZE] NUMERIC(12, 0) NULL,
    [LOT_SIZE_MULTIPLE] NUMERIC(12, 0) NULL,
    [PRICE_TICK] NUMERIC(28, 4) NULL,
    [MARGIN_INDICATOR] VARCHAR(1) NULL,
    [INITAIL_MARGIN_PERC] NUMERIC(28, 4) NULL,
    [STATUS_FLAG] VARCHAR(1) NULL,
    [ISIN] VARCHAR(12) NULL,
    [TRADE_DATE] DATETIME NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP2_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP2_IMP]
(
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [UNDERLYING_ASSET] VARCHAR(20) NULL,
    [CA_LEVEL] VARCHAR(12) NULL,
    [BASE_PRICE] NUMERIC(20, 4) NULL,
    [STARTDATE] DATETIME NULL,
    [MATURITYDATE] DATETIME NULL,
    [EXERCISE_STARTDATE] DATETIME NULL,
    [EXERCISE_ENDDATE] DATETIME NULL,
    [MINIMUM_LOT_SIZE] NUMERIC(12, 0) NULL,
    [LOT_SIZE_MULTIPLE] NUMERIC(12, 0) NULL,
    [PRICE_TICK] NUMERIC(28, 4) NULL,
    [MARGIN_INDICATOR] VARCHAR(1) NULL,
    [INITAIL_MARGIN_PERC] NUMERIC(28, 4) NULL,
    [STATUS_FLAG] VARCHAR(1) NULL,
    [ISIN] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP2_IMP_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP2_IMP_TEMP]
(
    [COL1] VARCHAR(50) NULL,
    [COL2] VARCHAR(50) NULL,
    [COL3] VARCHAR(50) NULL,
    [COL4] VARCHAR(50) NULL,
    [COL5] VARCHAR(50) NULL,
    [COL6] VARCHAR(50) NULL,
    [COL7] VARCHAR(50) NULL,
    [COL8] VARCHAR(50) NULL,
    [COL9] VARCHAR(50) NULL,
    [COL10] VARCHAR(50) NULL,
    [COL11] VARCHAR(50) NULL,
    [COL12] VARCHAR(50) NULL,
    [COL13] VARCHAR(50) NULL,
    [COL14] VARCHAR(50) NULL,
    [COL15] VARCHAR(50) NULL,
    [COL16] VARCHAR(50) NULL,
    [COL17] VARCHAR(50) NULL,
    [COL18] VARCHAR(50) NULL,
    [COL19] VARCHAR(50) NULL,
    [COL20] VARCHAR(50) NULL,
    [COL21] VARCHAR(50) NULL,
    [COL22] VARCHAR(50) NULL,
    [COL23] VARCHAR(50) NULL,
    [COL24] VARCHAR(50) NULL,
    [COL25] VARCHAR(50) NULL,
    [COL26] VARCHAR(50) NULL,
    [COL27] VARCHAR(50) NULL,
    [COL28] VARCHAR(50) NULL,
    [COL29] VARCHAR(50) NULL,
    [COL30] VARCHAR(50) NULL,
    [COL31] VARCHAR(50) NULL,
    [COL32] VARCHAR(50) NULL,
    [COL33] VARCHAR(50) NULL,
    [COL34] VARCHAR(50) NULL,
    [COL35] VARCHAR(50) NULL,
    [COL36] VARCHAR(50) NULL,
    [COL37] VARCHAR(50) NULL,
    [COL38] VARCHAR(50) NULL,
    [COL39] VARCHAR(50) NULL,
    [COL40] VARCHAR(50) NULL,
    [COL41] VARCHAR(50) NULL,
    [COL42] VARCHAR(50) NULL,
    [COL43] VARCHAR(50) NULL,
    [COL44] VARCHAR(50) NULL,
    [COL45] VARCHAR(50) NULL,
    [COL46] VARCHAR(50) NULL,
    [COL47] VARCHAR(50) NULL,
    [COL48] VARCHAR(50) NULL,
    [COL49] VARCHAR(50) NULL,
    [COL50] VARCHAR(50) NULL,
    [COL51] VARCHAR(50) NULL,
    [COL52] VARCHAR(50) NULL,
    [COL53] VARCHAR(50) NULL,
    [COL54] VARCHAR(50) NULL,
    [COL55] VARCHAR(50) NULL,
    [COL56] VARCHAR(50) NULL,
    [COL57] VARCHAR(50) NULL,
    [COL58] VARCHAR(50) NULL,
    [COL59] VARCHAR(50) NULL,
    [COL60] VARCHAR(50) NULL,
    [COL61] VARCHAR(50) NULL,
    [COL62] VARCHAR(50) NULL,
    [COL63] VARCHAR(50) NULL,
    [COL64] VARCHAR(50) NULL,
    [COL65] VARCHAR(50) NULL,
    [COL66] VARCHAR(50) NULL,
    [COL67] VARCHAR(50) NULL,
    [COL68] VARCHAR(50) NULL,
    [COL69] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP2_IMP_TEMP_bkup
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP2_IMP_TEMP_bkup]
(
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [UNDERLYING_ASSET] VARCHAR(20) NULL,
    [CA_LEVEL] VARCHAR(12) NULL,
    [BASE_PRICE] NUMERIC(20, 4) NULL,
    [STARTDATE] DATETIME NULL,
    [MATURITYDATE] DATETIME NULL,
    [EXERCISE_STARTDATE] DATETIME NULL,
    [EXERCISE_ENDDATE] DATETIME NULL,
    [MINIMUM_LOT_SIZE] NUMERIC(12, 0) NULL,
    [LOT_SIZE_MULTIPLE] NUMERIC(12, 0) NULL,
    [PRICE_TICK] NUMERIC(28, 4) NULL,
    [MARGIN_INDICATOR] VARCHAR(1) NULL,
    [INITAIL_MARGIN_PERC] NUMERIC(28, 4) NULL,
    [STATUS_FLAG] VARCHAR(1) NULL,
    [ISIN] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfosett_mst
-- --------------------------------------------------
CREATE TABLE [dbo].[bfosett_mst]
(
    [Exchange] CHAR(5) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] VARCHAR(10) NULL,
    [Series_code] VARCHAR(20) NULL,
    [Start_date] SMALLDATETIME NULL,
    [expirydate] SMALLDATETIME NULL,
    [Funds_Payin] SMALLDATETIME NULL,
    [Funds_Payout] SMALLDATETIME NULL,
    [Sec_Payin] SMALLDATETIME NULL,
    [Sec_Payout] SMALLDATETIME NULL,
    [Series] VARCHAR(3) NULL,
    [MarketType] VARCHAR(2) NULL,
    [maturitydate] SMALLDATETIME NULL,
    [Product_type] VARCHAR(5) NULL,
    [Product_code] VARCHAR(10) NULL,
    [Series_Id] VARCHAR(13) NULL,
    [Series_type] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSETTLEMENT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfosettlement_RTb
-- --------------------------------------------------
CREATE TABLE [dbo].[bfosettlement_RTb]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] MONEY NULL,
    [DAY_PUC] MONEY NULL,
    [DAY_SALES] MONEY NULL,
    [SETT_PURCH] MONEY NULL,
    [SETT_SALES] MONEY NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSETTLEMENTEXPIRY
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSETTLEMENTEXPIRY]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoSpanMargin_intraday
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoSpanMargin_intraday]
(
    [node] VARCHAR(7) NOT NULL,
    [Intradate] SMALLDATETIME NOT NULL,
    [isSetl] INT NOT NULL,
    [qual] VARCHAR(7) NOT NULL,
    [Intratime] VARCHAR(7) NULL,
    [run] VARCHAR(7) NULL,
    [firm] VARCHAR(7) NOT NULL,
    [acct] VARCHAR(7) NOT NULL,
    [seg] VARCHAR(4) NULL,
    [Intratype] VARCHAR(7) NULL,
    [isCust] VARCHAR(7) NULL,
    [ec] VARCHAR(10) NULL,
    [cc] VARCHAR(10) NULL,
    [Intracurrency] VARCHAR(7) NULL,
    [lfv] FLOAT NULL,
    [sfv] FLOAT NULL,
    [lov] FLOAT NULL,
    [sov] FLOAT NULL,
    [isM] FLOAT NULL,
    [pbc] VARCHAR(7) NULL,
    [spanReq] FLOAT NULL,
    [anov] FLOAT NULL,
    [sr] FLOAT NULL,
    [ia] FLOAT NULL,
    [dr] FLOAT NULL,
    [ie] FLOAT NULL,
    [iex] FLOAT NULL,
    [som] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoSpMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoSpMargin]
(
    [Date] SMALLDATETIME NULL,
    [NSeries_Code] VARCHAR(13) NULL,
    [Near_ExpiryDate] SMALLDATETIME NULL,
    [FSeries_Code] VARCHAR(13) NULL,
    [Far_ExpiryDate] SMALLDATETIME NULL,
    [Valid_Date] SMALLDATETIME NULL,
    [SpreadMargin] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfostat_trd
-- --------------------------------------------------
CREATE TABLE [dbo].[bfostat_trd]
(
    [actioncode] VARCHAR(3) NULL,
    [sysdate] SMALLDATETIME NULL,
    [filedate] SMALLDATETIME NULL,
    [com_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfotaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[bfotaxes]
(
    [Exchange] VARCHAR(3) NULL,
    [Trans_cat] VARCHAR(3) NULL,
    [Insurance_Chrg] NUMERIC(18, 4) NULL,
    [Turnover_tax] NUMERIC(18, 4) NULL,
    [Other_chrg] NUMERIC(18, 4) NULL,
    [Sebiturn_tax] NUMERIC(18, 4) NULL,
    [Broker_note] NUMERIC(18, 4) NULL,
    [From_date] DATETIME NULL,
    [Demat_Insure] NUMERIC(18, 4) NULL,
    [TO_DATE] DATETIME NULL,
    [TURNOVER_TAX_ON] VARCHAR(16) NULL,
    [TURN_TAX_OPT_NONLEIPS_ACTIVE] VARCHAR(9) NULL,
    [TURN_TAX_OPT_NONLEIPS_PASSIVE] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOtermparty
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOtermparty]
(
    [UserId] CHAR(10) NOT NULL,
    [Party_code] CHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoTMinfo
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoTMinfo]
(
    [TM_Code] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Short_Name] VARCHAR(20) NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Add1] VARCHAR(50) NULL,
    [Add2] VARCHAR(50) NULL,
    [PhoneNo] VARCHAR(15) NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [ClFeePerQty] MONEY NULL,
    [Rounding] INT NULL,
    [MtoM] NUMERIC(18, 0) NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOTRADE]
(
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] CHAR(2) NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETTFLAG] INT NULL,
    [CA_LEVEL] VARCHAR(11) NULL,
    [BROKER_CD] VARCHAR(6) NULL,
    [TRADE_PRICE] NUMERIC(20, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(6) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(6) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] CHAR(1) NULL,
    [RESERVED1] TINYINT NULL,
    [RESERVED2] TINYINT NULL,
    [RESERVED3] TINYINT NULL,
    [RESERVED4] TINYINT NULL,
    [RESERVED5] TINYINT NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOTRADE1_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOTRADE1_IMP]
(
    [USERID] VARCHAR(10) NULL,
    [BOOKTYPE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SCRIP_NAME] VARCHAR(25) NULL,
    [MARKETRATE] NUMERIC(18, 4) NULL,
    [TRADEQTY] INT NULL,
    [INSTRUMENTYPE] VARCHAR(1) NULL,
    [INSTRUMENT] VARCHAR(1) NULL,
    [TRD_DATE] VARCHAR(12) NULL,
    [TRD_TIME] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [MARKETTYPE] VARCHAR(1) NULL,
    [SELL_BUY] VARCHAR(1) NULL,
    [TRADE_NO] VARCHAR(14) NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [ISIN] VARCHAR(12) NULL,
    [GROUP_CODE] VARCHAR(2) NULL,
    [SETTNO] VARCHAR(15) NULL,
    [ORDER_TIME] VARCHAR(20) NULL,
    [FILLER] VARCHAR(20) NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOTRADE2_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOTRADE2_IMP]
(
    [TMCODE] VARCHAR(10) NULL,
    [GROUP_ID] VARCHAR(7) NULL,
    [TRADER_CODE] VARCHAR(7) NULL,
    [PRODUCT_CODE] VARCHAR(10) NULL,
    [PRODUCT_TYPE] VARCHAR(5) NULL,
    [SERIES_ID] INT NULL,
    [SERIES_CODE] VARCHAR(20) NULL,
    [SELL_BUY] CHAR(1) NULL,
    [TRADEQTY] INT NULL,
    [MARKETRATE] MONEY NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [SAUDA_DATE] VARCHAR(10) NULL,
    [TRADE_TIME] VARCHAR(10) NULL,
    [ORDER_DATE] VARCHAR(10) NULL,
    [ORDER_TIME] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [TRANS_TYPE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOTRADEMISSING
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOTRADEMISSING]
(
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] CHAR(2) NULL,
    [SEGMENT] CHAR(1) NULL,
    [SETT_TYPE] CHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETTFLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(6) NULL,
    [TRADE_PRICE] NUMERIC(20, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(6) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(6) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] CHAR(1) NULL,
    [RESERVED1] TINYINT NULL,
    [RESERVED2] TINYINT NULL,
    [RESERVED3] TINYINT NULL,
    [RESERVED4] TINYINT NULL,
    [RESERVED5] TINYINT NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch
-- --------------------------------------------------
CREATE TABLE [dbo].[branch]
(
    [BRANCH_CODE] CHAR(10) NULL,
    [BRANCH] CHAR(40) NULL,
    [Long_Name] CHAR(50) NULL,
    [Address1] VARCHAR(100) NULL,
    [Address2] VARCHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(100) NULL,
    [Prefix] VARCHAR(3) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchBrokTable
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchBrokTable]
(
    [Table_No] INT NULL,
    [Table_Name] VARCHAR(30) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Table_Type] CHAR(1) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Remarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branches
-- --------------------------------------------------
CREATE TABLE [dbo].[Branches]
(
    [Branch_Cd] VARCHAR(50) NOT NULL,
    [Short_Name] VARCHAR(20) NOT NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(25) NULL,
    [Address2] VARCHAR(25) NULL,
    [City] VARCHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(25) NULL,
    [Com_Perc] MONEY NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Deftrader] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchPayMode
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchPayMode]
(
    [AcName] VARCHAR(100) NULL,
    [Branch] VARCHAR(10) NULL,
    [CltCode] VARCHAR(10) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_no] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] DECIMAL(10, 6) NULL,
    [Day_Sales] DECIMAL(10, 6) NULL,
    [Sett_Purch] DECIMAL(10, 6) NULL,
    [round_to] DECIMAL(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] DECIMAL(10, 6) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] DECIMAL(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [BRANCH_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cdsl
-- --------------------------------------------------
CREATE TABLE [dbo].[cdsl]
(
    [client_hldg] VARCHAR(50) NULL,
    [isin_hldg] VARCHAR(50) NULL,
    [edmat_hldg] VARCHAR(50) NULL,
    [cdas_hldg] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL]
(
    [CD_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CD_PARTY_CODE] VARCHAR(10) NULL,
    [CD_SAUDA_DATE] DATETIME NOT NULL,
    [CD_CONTRACT_NO] VARCHAR(14) NULL,
    [CD_TRADE_NO] VARCHAR(15) NULL,
    [CD_ORDER_NO] VARCHAR(20) NULL,
    [CD_PRODUCT_TYPE] VARCHAR(3) NULL,
    [CD_PRODUCT_CODE] VARCHAR(7) NULL,
    [CD_ASSET_CODE] VARCHAR(8) NULL,
    [CD_EXPIRYDATE] DATETIME NULL,
    [CD_STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [CD_OPTION_TYPE] VARCHAR(2) NULL,
    [CD_SERIES_CODE] VARCHAR(22) NULL,
    [CD_SERIES_ID] NUMERIC(9, 0) NULL,
    [CD_LOT_SIZE] NUMERIC(9, 0) NULL,
    [CD_AUCTIONPART] VARCHAR(2) NULL,
    [CD_MARKETLOT] INT NOT NULL,
    [CD_SCHEME_ID] INT NOT NULL,
    [CD_COMPUTATIONLEVEL] CHAR(1) NULL,
    [CD_COMPUTATIONON] CHAR(1) NULL,
    [CD_COMPUTATIONTYPE] CHAR(1) NULL,
    [CD_BUYRATE] NUMERIC(36, 12) NOT NULL,
    [CD_SELLRATE] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYQTY] INT NOT NULL,
    [CD_TOT_SELLQTY] INT NOT NULL,
    [CD_TOT_BUYTURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLTURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYTURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLTURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_LOT] INT NOT NULL,
    [CD_TOT_RES_TURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_RES_TURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_RES_LOT] INT NOT NULL,
    [CD_TOT_BUYBROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLBROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYSERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLSERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_STT] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_STAMPDUTY] NUMERIC(36, 12) NOT NULL,
    [CD_EXCH_BUYRATE] NUMERIC(36, 12) NOT NULL,
    [CD_EXCH_SELLRATE] NUMERIC(36, 12) NOT NULL,
    [CD_TIMESTAMP] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cl
-- --------------------------------------------------
CREATE TABLE [dbo].[cl]
(
    [Trading Code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(200) NULL,
    [IndexType] VARCHAR(18) NULL,
    [IndexColumns] NVARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableListing]
(
    [TableName] VARCHAR(50) NULL,
    [Description] VARCHAR(200) NULL,
    [StatusFlag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD]
(
    [FILE_DATA] VARCHAR(8000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD_BULK
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD_BULK]
(
    [FILEDATA] VARCHAR(2000) NOT NULL,
    [SPID] BIGINT NOT NULL DEFAULT @@spid
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD_LOG]
(
    [FILE_PARAM] VARCHAR(1000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_BROK_DETAILS_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_BROK_DETAILS_TMP]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(7) NOT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Trd_Brok] INT NULL,
    [Del_Brok] INT NULL,
    [Ser_Tax] TINYINT NULL,
    [Ser_Tax_Method] TINYINT NULL,
    [Credit_Limit] INT NOT NULL,
    [InActive_From] DATETIME NULL,
    [Print_Options] TINYINT NULL,
    [No_Of_Copies] INT NULL,
    [Participant_Code] VARCHAR(15) NULL,
    [Custodian_Code] VARCHAR(50) NULL,
    [Inst_Contract] CHAR(1) NULL,
    [Round_Style] INT NULL,
    [STP_Provider] VARCHAR(5) NULL,
    [STP_Rp_Style] INT NULL,
    [Market_Type] INT NULL,
    [Multiplier] INT NULL,
    [Charged] INT NULL,
    [Maintenance] INT NULL,
    [Reqd_By_Exch] INT NULL,
    [Reqd_By_Broker] INT NULL,
    [Client_Rating] VARCHAR(10) NULL,
    [Debit_Balance] CHAR(1) NULL,
    [Inter_Sett] CHAR(1) NULL,
    [TRD_STT] MONEY NULL,
    [Trd_Tran_Chrgs] NUMERIC(18, 6) NULL,
    [Trd_Sebi_Fees] NUMERIC(18, 6) NULL,
    [Trd_Stamp_Duty] MONEY NULL,
    [Trd_Other_Chrgs] MONEY NULL,
    [Trd_Eff_Dt] DATETIME NULL,
    [Del_Stt] MONEY NULL,
    [Del_Tran_Chrgs] NUMERIC(18, 6) NULL,
    [Del_SEBI_Fees] NUMERIC(18, 6) NULL,
    [Del_Stamp_Duty] MONEY NULL,
    [Del_Other_Chrgs] MONEY NULL,
    [Del_Eff_Dt] DATETIME NULL,
    [Rounding_Method] VARCHAR(10) NULL,
    [Round_To_Digit] TINYINT NULL,
    [Round_To_Paise] INT NULL,
    [Fut_Brok] INT NULL,
    [Fut_Opt_Brok] INT NULL,
    [Fut_Fut_Fin_Brok] INT NULL,
    [Fut_Opt_Exc] INT NULL,
    [Fut_Brok_Applicable] INT NULL,
    [Fut_Stt] SMALLINT NULL,
    [Fut_Tran_Chrgs] SMALLINT NULL,
    [Fut_Sebi_Fees] SMALLINT NULL,
    [Fut_Stamp_Duty] SMALLINT NULL,
    [Fut_Other_Chrgs] SMALLINT NULL,
    [Status] CHAR(1) NULL,
    [Modifiedon] DATETIME NULL,
    [Modifiedby] VARCHAR(25) NULL,
    [Imp_Status] TINYINT NULL,
    [Pay_B3B_Payment] CHAR(1) NULL,
    [Pay_Bank_name] VARCHAR(50) NULL,
    [Pay_Branch_name] VARCHAR(50) NULL,
    [Pay_AC_No] VARCHAR(10) NULL,
    [Pay_payment_Mode] CHAR(1) NULL,
    [Brok_Eff_Date] DATETIME NULL,
    [Inst_Trd_Brok] INT NULL,
    [Inst_Del_Brok] INT NULL,
    [SYSTEMDATE] DATETIME NULL,
    [Active_Date] DATETIME NULL,
    [CheckActiveClient] VARCHAR(1) NULL,
    [Deactive_Remarks] VARCHAR(100) NULL,
    [Deactive_value] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_details_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[client_details_tmp]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(20) NULL,
    [long_name] VARCHAR(100) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [l_address1] VARCHAR(40) NOT NULL,
    [l_city] VARCHAR(40) NULL,
    [l_address2] VARCHAR(40) NULL,
    [l_state] VARCHAR(50) NULL,
    [l_address3] VARCHAR(40) NULL,
    [l_nation] VARCHAR(15) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [ward_no] VARCHAR(50) NULL,
    [sebi_regn_no] VARCHAR(25) NULL,
    [res_phone1] VARCHAR(15) NULL,
    [res_phone2] VARCHAR(15) NULL,
    [off_phone1] VARCHAR(15) NULL,
    [off_phone2] VARCHAR(15) NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [fax] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [cl_type] VARCHAR(3) NOT NULL,
    [cl_status] VARCHAR(3) NOT NULL,
    [family] VARCHAR(10) NOT NULL,
    [region] VARCHAR(50) NULL,
    [area] VARCHAR(10) NULL,
    [p_address1] VARCHAR(50) NULL,
    [p_city] VARCHAR(20) NULL,
    [p_address2] VARCHAR(50) NULL,
    [p_state] VARCHAR(50) NULL,
    [p_address3] VARCHAR(50) NULL,
    [p_nation] VARCHAR(15) NULL,
    [p_zip] VARCHAR(10) NULL,
    [p_phone] VARCHAR(15) NULL,
    [addemailid] VARCHAR(230) NULL,
    [sex] CHAR(1) NULL,
    [dob] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [approver] VARCHAR(30) NULL,
    [interactmode] TINYINT NULL,
    [passport_no] VARCHAR(30) NULL,
    [passport_issued_at] VARCHAR(30) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] VARCHAR(30) NULL,
    [licence_issued_at] VARCHAR(30) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] VARCHAR(30) NULL,
    [rat_card_issued_at] VARCHAR(30) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] VARCHAR(30) NULL,
    [votersid_issued_at] VARCHAR(30) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] VARCHAR(30) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] VARCHAR(50) NULL,
    [regr_at] VARCHAR(50) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] VARCHAR(50) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] VARCHAR(50) NULL,
    [dealing_with_other_tm] VARCHAR(50) NULL,
    [other_ac_no] VARCHAR(50) NULL,
    [introducer_id] VARCHAR(50) NULL,
    [introducer_relation] VARCHAR(50) NULL,
    [repatriat_bank] NUMERIC(18, 0) NULL,
    [repatriat_bank_ac_no] VARCHAR(30) NULL,
    [chk_kyc_form] TINYINT NULL,
    [chk_corporate_deed] TINYINT NULL,
    [chk_bank_certificate] TINYINT NULL,
    [chk_annual_report] TINYINT NULL,
    [chk_networth_cert] TINYINT NULL,
    [chk_corp_dtls_recd] TINYINT NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [AC_Type] VARCHAR(10) NULL,
    [AC_Num] VARCHAR(20) NULL,
    [Depository1] VARCHAR(7) NULL,
    [DpId1] VARCHAR(16) NULL,
    [CltDpId1] VARCHAR(16) NULL,
    [Poa1] CHAR(1) NULL,
    [Depository2] VARCHAR(7) NULL,
    [DpId2] VARCHAR(16) NULL,
    [CltDpId2] VARCHAR(16) NULL,
    [Poa2] CHAR(1) NULL,
    [Depository3] VARCHAR(7) NULL,
    [DpId3] VARCHAR(16) NULL,
    [CltDpId3] VARCHAR(16) NULL,
    [Poa3] CHAR(1) NULL,
    [rel_mgr] VARCHAR(10) NULL,
    [c_group] VARCHAR(10) NULL,
    [sbu] VARCHAR(10) NULL,
    [Status] CHAR(1) NULL,
    [Imp_Status] TINYINT NULL,
    [ModifidedBy] VARCHAR(25) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] VARCHAR(9) NULL,
    [Mapin_id] VARCHAR(12) NULL,
    [UCC_Code] VARCHAR(12) NULL,
    [Micr_No] VARCHAR(10) NULL,
    [Director_name] VARCHAR(200) NULL,
    [paylocation] VARCHAR(20) NULL,
    [FMCode] VARCHAR(10) NULL,
    [INCOME_SLAB] INT NULL,
    [NETWORTH_SLAB] INT NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [PRODUCTCODE] VARCHAR(10) NULL,
    [RES_PHONE1_STD] VARCHAR(5) NULL,
    [RES_PHONE2_STD] VARCHAR(5) NULL,
    [OFF_PHONE1_STD] VARCHAR(5) NULL,
    [OFF_PHONE2_STD] VARCHAR(5) NULL,
    [P_PHONE_STD] VARCHAR(5) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Party_Modification_Tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Party_Modification_Tmp]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Old_Party_Code] VARCHAR(10) NOT NULL,
    [New_Party_Code] VARCHAR(10) NOT NULL,
    [Branch_Cd] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(10) NOT NULL,
    [family] VARCHAR(10) NOT NULL,
    [area] VARCHAR(10) NOT NULL,
    [region] VARCHAR(20) NOT NULL,
    [Status] INT NOT NULL,
    [AddedBy] VARCHAR(50) NOT NULL,
    [AddedOn] DATETIME NOT NULL,
    [UpdatedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Print_Settings
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Print_Settings]
(
    [Print_Flag] TINYINT NOT NULL,
    [Print_Flag_Desc] VARCHAR(35) NOT NULL,
    [VALID_REPORT] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client1
-- --------------------------------------------------
CREATE TABLE [dbo].[client1]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(100) NULL,
    [L_Address2] VARCHAR(100) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(100) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(20) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(100) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [trader] VARCHAR(20) NULL,
    [WARD_NO] VARCHAR(50) NULL,
    [Region] VARCHAR(20) NULL,
    [Area] VARCHAR(20) NULL,
    [ClRating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client2
-- --------------------------------------------------
CREATE TABLE [dbo].[client2]
(
    [Cl_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] DECIMAL(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] INT NULL,
    [Sub_TableNo] INT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] INT NULL,
    [P_To_P] INT NULL,
    [exposure_lim] DECIMAL(12, 2) NOT NULL,
    [demat_tableno] INT NULL,
    [BankId] VARCHAR(16) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] SMALLINT NULL,
    [AlbmCF_tableno] INT NULL,
    [MF_tableno] INT NULL,
    [SB_tableno] INT NULL,
    [brok1_tableno] INT NULL,
    [brok2_tableno] INT NULL,
    [brok3_tableno] INT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [MinContAmt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [PRODUCTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client2_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Client2_Log]
(
    [Cl_Code] CHAR(10) NULL,
    [Exchange] CHAR(3) NULL,
    [Tran_Cat] CHAR(3) NULL,
    [Scrip_Cat] DECIMAL(9, 0) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [Margin] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [Sebi_Turn_Tax] TINYINT NULL,
    [Insurance_Chrg] TINYINT NULL,
    [Service_Chrg] TINYINT NULL,
    [Std_Rate] INT NULL,
    [P_To_P] INT NULL,
    [Exposure_Lim] DECIMAL(18, 0) NULL,
    [Demat_Tableno] INT NULL,
    [Bankid] VARCHAR(16) NULL,
    [Cltdpno] VARCHAR(16) NULL,
    [Printf] TINYINT NULL,
    [Albmdelchrg] TINYINT NULL,
    [Albmdelivery] INT NULL,
    [Albmcf_Tableno] INT NULL,
    [Mf_Tableno] INT NULL,
    [Sb_Tableno] INT NULL,
    [Brok1_Tableno] INT NULL,
    [Brok2_Tableno] INT NULL,
    [Brok3_Tableno] INT NULL,
    [Brokernote] TINYINT NULL,
    [Other_Chrg] TINYINT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [Mincontamt] TINYINT NULL,
    [Addledgerbal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [Inscont] CHAR(1) NULL,
    [Sertaxmethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [Activefrom] DATETIME NULL,
    [Inactivefrom] DATETIME NULL,
    [Debitbalflag] INT NULL,
    [Intersettflag] INT NULL,
    [Logfld_Script_Name] VARCHAR(500) NULL,
    [Logfld_Session_Id] VARCHAR(30) NULL,
    [Logfld_Local_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Host] VARCHAR(50) NULL,
    [Logfld_Statusname] VARCHAR(50) NULL,
    [Logfld_Username] VARCHAR(100) NULL,
    [Logfld_When_109] VARCHAR(30) NULL,
    [Logfld_Action] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client3
-- --------------------------------------------------
CREATE TABLE [dbo].[Client3]
(
    [Cl_Code] VARCHAR(10) NULL,
    [Party_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Markettype] VARCHAR(15) NOT NULL,
    [Margin] MONEY NOT NULL,
    [Nooftimes] DECIMAL(2, 0) NOT NULL,
    [Margin_Recd] DECIMAL(18, 0) NULL,
    [Mtom] DECIMAL(18, 0) NULL,
    [Pmarginrate] DECIMAL(5, 2) NULL,
    [Mtomdate] DATETIME NULL,
    [Initialmargin] DECIMAL(18, 4) NULL,
    [Mainenancetmargin] DECIMAL(18, 4) NULL,
    [Marginexchange] DECIMAL(18, 4) NULL,
    [Marginbroker] DECIMAL(18, 4) NULL,
    [Dummy1] VARCHAR(4) NULL,
    [Dummy2] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client4
-- --------------------------------------------------
CREATE TABLE [dbo].[client4]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(20) NULL,
    [Cltdpid] VARCHAR(20) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client5
-- --------------------------------------------------
CREATE TABLE [dbo].[Client5]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Birthdate] SMALLDATETIME NULL,
    [Sex] CHAR(1) NULL,
    [Activefrom] SMALLDATETIME NULL,
    [Interactmode] TINYINT NULL,
    [Repatriatac] TINYINT NULL,
    [Repatriatbank] INT NULL,
    [Repatriatacno] VARCHAR(30) NULL,
    [Introducer] VARCHAR(30) NULL,
    [Approver] VARCHAR(30) NULL,
    [Kycform] TINYINT NULL,
    [Bankcert] TINYINT NULL,
    [Passport] TINYINT NULL,
    [Passportdtl] VARCHAR(30) NULL,
    [Votersid] TINYINT NULL,
    [Votersiddtl] VARCHAR(30) NULL,
    [Itreturn] TINYINT NULL,
    [Itreturndtl] VARCHAR(30) NULL,
    [Drivelicen] TINYINT NULL,
    [Drivelicendtl] VARCHAR(30) NULL,
    [Rationcard] TINYINT NULL,
    [Rationcarddtl] VARCHAR(30) NULL,
    [Corpdtlrecd] TINYINT NULL,
    [Corpdeed] TINYINT NULL,
    [Anualreport] TINYINT NULL,
    [Networthcert] TINYINT NULL,
    [Inactivefrom] DATETIME NULL,
    [P_Address1] VARCHAR(100) NULL,
    [P_Address2] VARCHAR(100) NULL,
    [P_Address3] VARCHAR(100) NULL,
    [P_City] VARCHAR(20) NULL,
    [P_State] VARCHAR(50) NULL,
    [P_Nation] VARCHAR(15) NULL,
    [P_Phone] VARCHAR(15) NULL,
    [P_Zip] VARCHAR(10) NULL,
    [Addemailid] VARCHAR(230) NULL,
    [Passportdateofissue] DATETIME NULL,
    [Passportplaceofissue] VARCHAR(30) NULL,
    [Voteriddateofissue] DATETIME NULL,
    [Voteridplaceofissue] VARCHAR(30) NULL,
    [Itreturndateoffiling] DATETIME NULL,
    [Licencenodateofissue] DATETIME NULL,
    [Licencenoplaceofissue] VARCHAR(30) NULL,
    [Rationcarddateofissue] DATETIME NULL,
    [Rationcardplaceofissue] VARCHAR(30) NULL,
    [Client_Agre_Dt] DATETIME NULL,
    [Regr_No] VARCHAR(50) NULL,
    [Regr_Place] VARCHAR(50) NULL,
    [Regr_Date] DATETIME NULL,
    [Regr_Auth] VARCHAR(50) NULL,
    [Introd_Client_Id] VARCHAR(50) NULL,
    [Introd_Relation] VARCHAR(50) NULL,
    [Any_Other_Acc] VARCHAR(50) NULL,
    [Sett_Mode] VARCHAR(50) NULL,
    [Dealing_With_Othrer_Tm] VARCHAR(50) NULL,
    [Systumdate] DATETIME NULL,
    [Passportexpdate] DATETIME NULL,
    [Driveexpdate] DATETIME NULL,
    [Director_name] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientCharges
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientCharges]
(
    [Exchange] CHAR(10) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Party_code] CHAR(10) NULL,
    [MinUnitBrok] SMALLMONEY NULL,
    [Charge1] SMALLMONEY NULL,
    [Charge1Desc] VARCHAR(20) NULL,
    [Charge2] SMALLMONEY NULL,
    [Charge2Desc] VARCHAR(20) NULL,
    [Charge3] SMALLMONEY NULL,
    [Charge3Desc] VARCHAR(20) NULL,
    [Charge4] SMALLMONEY NULL,
    [Charge4Desc] VARCHAR(20) NULL,
    [MinContAmt] SMALLMONEY NULL,
    [Leg] CHAR(2) NULL,
    [Sett_type] CHAR(3) NULL,
    [NOC] TINYINT NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientSettings
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientSettings]
(
    [Exchange] CHAR(3) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Cl_Code] VARCHAR(50) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] SMALLINT NOT NULL,
    [Sub_TableNo] SMALLINT NOT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] SMALLINT NOT NULL,
    [P_To_P] SMALLINT NOT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] SMALLINT NOT NULL,
    [BankId] VARCHAR(16) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [Dummy6] VARCHAR(4) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(4) NULL,
    [Dummy9] VARCHAR(4) NULL,
    [Dummy10] VARCHAR(4) NULL,
    [RoundStyle] SMALLINT NULL,
    [RoundStyle1] SMALLINT NULL,
    [DebitBalance] TINYINT NULL,
    [InterSett] TINYINT NULL,
    [Latest] CHAR(4) NULL,
    [Area] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Cl_Type] CHAR(3) NULL,
    [Cl_status] CHAR(3) NULL,
    [Clrating] VARCHAR(10) NULL,
    [Family] VARCHAR(50) NULL,
    [Sub_Broker] VARCHAR(50) NULL,
    [Trader] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientstatus
-- --------------------------------------------------
CREATE TABLE [dbo].[clientstatus]
(
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Description] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientTaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientTaxes]
(
    [Exchange] CHAR(10) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Party_code] CHAR(10) NULL,
    [Cl_type] CHAR(5) NULL,
    [Trans_cat] CHAR(5) NULL,
    [Insurance_Chrg] SMALLMONEY NULL,
    [Turnover_tax] SMALLMONEY NULL,
    [Other_chrg] SMALLMONEY NULL,
    [Sebiturn_tax] SMALLMONEY NULL,
    [Broker_note] SMALLMONEY NULL,
    [Demat_Insure] SMALLMONEY NULL,
    [Service_tax] SMALLMONEY NULL,
    [Tax1] SMALLMONEY NULL,
    [Tax2] SMALLMONEY NULL,
    [Tax3] SMALLMONEY NULL,
    [Tax4] SMALLMONEY NULL,
    [Tax5] SMALLMONEY NULL,
    [Tax6] SMALLMONEY NULL,
    [Tax7] SMALLMONEY NULL,
    [Tax8] SMALLMONEY NULL,
    [Tax9] SMALLMONEY NULL,
    [Tax10] SMALLMONEY NULL,
    [Latest] CHAR(10) NULL,
    [State] CHAR(15) NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttype
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttype]
(
    [Cl_Type] VARCHAR(3) NOT NULL,
    [Description] VARCHAR(25) NULL,
    [prefix] CHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_EXCH_IMPFILE_TYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_EXCH_IMPFILE_TYPE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FILETYPE_CD] VARCHAR(12) NULL,
    [FILETYPE_DESC] VARCHAR(30) NULL,
    [VALID_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_TRADEFILE_TYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_TRADEFILE_TYPE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FILETYPE_CD] VARCHAR(12) NULL,
    [FILETYPE_DESC] VARCHAR(30) NULL,
    [VALID_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMPANY_LOGO
-- --------------------------------------------------
CREATE TABLE [dbo].[COMPANY_LOGO]
(
    [CL_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CL_TYPE] CHAR(5) NULL,
    [CL_LOGO] IMAGE NULL,
    [CL_LOGO64] VARCHAR(100) NULL,
    [CL_UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTGEN
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTGEN]
(
    [Contractno] VARCHAR(10) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [SERIESFLAG] INT NULL,
    [INSTCONTRACTNO] VARCHAR(10) NULL,
    [NRMSERIESPREFIX] VARCHAR(2) NULL,
    [INSSERIESPREFIX] VARCHAR(2) NULL,
    [TRDDELFLAG] INT NULL,
    [FUTDELCONTRACTNO] VARCHAR(10) NULL,
    [OPTDELCONTRACTNO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContLogin
-- --------------------------------------------------
CREATE TABLE [dbo].[ContLogin]
(
    [LoginId] VARCHAR(30) NULL,
    [FromParty] VARCHAR(10) NULL,
    [ToParty] VARCHAR(10) NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [series_code] VARCHAR(13) NULL,
    [Expirydate] DATETIME NULL,
    [series_id] INT NULL,
    [Qty] INT NULL,
    [Sell_Buy] INT NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [ContractNo] VARCHAR(10) NULL,
    [SplitDate] SMALLDATETIME NULL,
    [Printed] INT NULL,
    [TradeNo] VARCHAR(14) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA]
(
    [ORDER_NO] VARCHAR(20) NULL,
    [ORDER_TIME] VARCHAR(20) NULL,
    [TRADE_NO] VARCHAR(16) NOT NULL,
    [TRADETIME] VARCHAR(13) NOT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] MONEY NULL,
    [SNETRATE] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [PRODUCT_TYPE] VARCHAR(5) NULL,
    [PRODUCT_CODE] VARCHAR(10) NULL,
    [SERIES_CODE] VARCHAR(20) NULL,
    [SERIES_ID] INT NULL,
    [PAMT] MONEY NULL,
    [SAMT] MONEY NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SELL_BUY] INT NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [PSERVICE_TAX] MONEY NULL,
    [SSERVICE_TAX] MONEY NULL,
    [DFLAG] INT NOT NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [PRINTF] INT NOT NULL DEFAULT 0,
    [SERVICE_CHRG] TINYINT NOT NULL,
    [CREATERNAME] VARCHAR(50) NOT NULL DEFAULT 'SYSTEM',
    [CREATEDDATETIME] DATETIME NOT NULL DEFAULT (getdate()),
    [LOTSIZE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA_COMMON
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA_COMMON]
(
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [ORDER_TIME] VARCHAR(20) NULL,
    [TRADE_NO] VARCHAR(16) NOT NULL,
    [TRADETIME] VARCHAR(13) NOT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] MONEY NULL,
    [SNETRATE] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [PRODUCT_TYPE] VARCHAR(5) NULL,
    [PRODUCT_CODE] VARCHAR(10) NULL,
    [SERIES_CODE] VARCHAR(20) NULL,
    [SERIES_ID] INT NULL,
    [PAMT] MONEY NULL,
    [SAMT] MONEY NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SELL_BUY] INT NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [PSERVICE_TAX] MONEY NULL,
    [SSERVICE_TAX] MONEY NULL,
    [DFLAG] INT NOT NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [PRINTF] INT NOT NULL,
    [SERVICE_CHRG] TINYINT NOT NULL,
    [CREATERNAME] VARCHAR(50) NOT NULL,
    [CREATEDDATETIME] DATETIME NOT NULL,
    [LOTSIZE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA_DET
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA_DET]
(
    [ORDER_NO] VARCHAR(20) NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [TRADE_NO] VARCHAR(16) NOT NULL,
    [TRADETIME] VARCHAR(13) NOT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] MONEY NULL,
    [SNETRATE] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [PRODUCT_TYPE] VARCHAR(5) NULL,
    [PRODUCT_CODE] VARCHAR(10) NULL,
    [SERIES_CODE] VARCHAR(20) NULL,
    [SERIES_ID] INT NULL,
    [PAMT] MONEY NULL,
    [SAMT] MONEY NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SELL_BUY] INT NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [PSERVICE_TAX] MONEY NULL,
    [SSERVICE_TAX] MONEY NULL,
    [DFLAG] INT NOT NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [PRINTF] INT NOT NULL DEFAULT 0,
    [SERVICE_CHRG] TINYINT NOT NULL,
    [CREATERNAME] VARCHAR(50) NOT NULL DEFAULT 'SYSTEM',
    [CREATEDDATETIME] DATETIME NOT NULL DEFAULT (getdate()),
    [LOTSIZE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_MASTER]
(
    [TRADE_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [L_ADDRESS1] VARCHAR(40) NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(20) NULL,
    [REGION] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(15) NULL,
    [OFF_PHONE2] VARCHAR(15) NULL,
    [PRINTF] INT NULL,
    [MAPIDID] VARCHAR(12) NULL,
    [UCC_CODE] VARCHAR(16) NULL,
    [SERVICE_CHRG] MONEY NULL,
    [BROKERNOTE] NUMERIC(18, 4) NULL,
    [TURNOVER_TAX] NUMERIC(18, 4) NULL,
    [SEBI_TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [INSURANCE_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_NO] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_MASTER_ang
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_MASTER_ang]
(
    [TRADE_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [L_ADDRESS1] VARCHAR(40) NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(20) NULL,
    [REGION] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(15) NULL,
    [OFF_PHONE2] VARCHAR(15) NULL,
    [PRINTF] INT NULL,
    [MAPIDID] VARCHAR(12) NULL,
    [UCC_CODE] VARCHAR(16) NULL,
    [SERVICE_CHRG] MONEY NULL,
    [BROKERNOTE] NUMERIC(18, 4) NULL,
    [TURNOVER_TAX] NUMERIC(18, 4) NULL,
    [SEBI_TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [INSURANCE_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_NO] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_master_COMMON
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_master_COMMON]
(
    [TRADE_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [L_ADDRESS1] VARCHAR(40) NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(20) NULL,
    [REGION] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(50) NULL,
    [OFF_PHONE2] VARCHAR(50) NULL,
    [PRINTF] INT NULL,
    [MAPIDID] VARCHAR(12) NULL,
    [UCC_CODE] VARCHAR(16) NULL,
    [SERVICE_CHRG] MONEY NULL,
    [BROKERNOTE] NUMERIC(18, 4) NULL,
    [TURNOVER_TAX] NUMERIC(18, 4) NULL,
    [SEBI_TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [INSURANCE_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_NO] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Contract_Rounding
-- --------------------------------------------------
CREATE TABLE [dbo].[Contract_Rounding]
(
    [CR_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CR_Party_Code] VARCHAR(10) NULL,
    [CR_Min_ContractAmt] NUMERIC(18, 4) NOT NULL,
    [CR_Max_ContractAmt] NUMERIC(18, 4) NOT NULL,
    [CR_Date_From] DATETIME NOT NULL,
    [CR_Date_To] DATETIME NOT NULL,
    [CR_CreatedBy] VARCHAR(20) NULL,
    [CR_CreatedOn] DATETIME NOT NULL,
    [CR_ModifiedBy] VARCHAR(20) NULL,
    [CR_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Custodian
-- --------------------------------------------------
CREATE TABLE [dbo].[Custodian]
(
    [Custodiancode] VARCHAR(15) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(50) NULL,
    [State] VARCHAR(50) NULL,
    [Nation] VARCHAR(50) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(10) NULL,
    [Off_Phone1] CHAR(10) NULL,
    [Off_Phone2] CHAR(10) NULL,
    [Email] CHAR(10) NULL,
    [Cltdpno] VARCHAR(16) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Sebiregno] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEALINGADDRESS
-- --------------------------------------------------
CREATE TABLE [dbo].[DEALINGADDRESS]
(
    [BRANCHNAME] VARCHAR(100) NULL,
    [ADDR1] VARCHAR(100) NULL,
    [ADDR2] VARCHAR(100) NULL,
    [ADDR3] VARCHAR(100) NULL,
    [PHONE1] VARCHAR(100) NULL,
    [PHONE2] VARCHAR(100) NULL,
    [FAX] VARCHAR(100) NULL,
    [Email] VARCHAR(100) NULL,
    [COMPLEmail1] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELIVERY_POSITION
-- --------------------------------------------------
CREATE TABLE [dbo].[DELIVERY_POSITION]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SELL_BUY] INT NULL,
    [EXPIRYDATE] DATETIME NULL,
    [BSECODE] VARCHAR(12) NULL,
    [DEL_QTY] INT NULL,
    [DEL_PRICE] NUMERIC(12, 4) NULL,
    [BROKERAGE] NUMERIC(12, 4) NULL,
    [SERVICE_TAX] NUMERIC(12, 4) NULL,
    [UPDATED_BY] VARCHAR(30) NULL,
    [UPDATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delpartyflag
-- --------------------------------------------------
CREATE TABLE [dbo].[Delpartyflag]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Debitflag] INT NULL,
    [Interflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dppoa
-- --------------------------------------------------
CREATE TABLE [dbo].[dppoa]
(
    [Column 0] VARCHAR(50) NULL,
    [Column 1] VARCHAR(50) NULL,
    [Column 2] VARCHAR(50) NULL,
    [Column 3] VARCHAR(50) NULL,
    [Column 4] VARCHAR(50) NULL,
    [Column 5] VARCHAR(50) NULL,
    [Column 6] VARCHAR(50) NULL,
    [Column 7] VARCHAR(50) NULL,
    [Column 8] VARCHAR(50) NULL,
    [Column 9] VARCHAR(50) NULL,
    [Column 10] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Blank_Check
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Blank_Check]
(
    [Email_Blank_Flag] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Login_User
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Login_User]
(
    [Email_Login_Id] VARCHAR(10) NOT NULL,
    [Email_Login_Name] VARCHAR(50) NOT NULL,
    [Email_Login_Password] VARCHAR(10) NOT NULL,
    [Email_Login_Status] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Partyreport
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Partyreport]
(
    [Email_Party_Code] CHAR(10) NOT NULL,
    [Email_Report_Names] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Report_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Report_Log]
(
    [Email_Login_Id] VARCHAR(10) NOT NULL,
    [Email_Activity_Type] CHAR(1) NOT NULL,
    [Email_Activity_Date] INT NOT NULL,
    [Email_Activity_Time] INT NOT NULL,
    [Email_From_Party] VARCHAR(10) NOT NULL,
    [Email_Mail_Add] VARCHAR(50) NOT NULL,
    [Email_Report_Name] VARCHAR(5000) NULL,
    [Email_Report_Date] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Report_Settings
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Report_Settings]
(
    [Email_Report_Name] VARCHAR(50) NOT NULL,
    [Email_Report_Path] VARCHAR(256) NOT NULL,
    [Email_Report_Subject] VARCHAR(256) NOT NULL,
    [Email_Report_Cc] VARCHAR(256) NOT NULL,
    [Email_Report_Body] VARCHAR(256) NOT NULL,
    [Email_Report_Priority] INT NOT NULL,
    [Email_Report_Parameter] VARCHAR(256) NOT NULL,
    [Email_Search_Parameter] VARCHAR(256) NOT NULL,
    [Email_Out_File_Prefix] VARCHAR(10) NOT NULL,
    [Email_Output_FoLder] VARCHAR(256) NOT NULL,
    [Email_Output_Sub_FoLder] VARCHAR(100) NOT NULL,
    [Email_DateFoRmat] INT NOT NULL,
    [Email_Table_Name] VARCHAR(200) NULL,
    [Email_Network_Path] VARCHAR(256) NOT NULL,
    [Email_Report_From] VARCHAR(256) NOT NULL,
    [Email_Out_File_Suffix] VARCHAR(20) NULL,
    [Email_Out_File_SubFolderFlag] INT NULL,
    [Email_Out_File_SrNo_Part1] INT NULL,
    [Email_Out_File_SrNo_Part2] INT NULL,
    [Email_Out_File_SrNo_Type] VARCHAR(8) NULL,
    [Email_Out_File_Name] VARCHAR(50) NULL,
    [Email_Report_Desc] VARCHAR(30) NULL,
    [Email_Zip_File] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ErrorLog
-- --------------------------------------------------
CREATE TABLE [dbo].[ErrorLog]
(
    [ErrDate] SMALLDATETIME NULL,
    [CName] VARCHAR(200) NULL,
    [MName] VARCHAR(200) NULL,
    [SName] VARCHAR(200) NULL,
    [ErrStr] NTEXT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILE_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FILE_DATA]
(
    [TEXTDATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_POS_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_POS_DETAILS_DAS]
(
    [FOPDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [FOPDD_INST_TYPE] VARCHAR(6) NULL,
    [FOPDD_SYMBOL] VARCHAR(12) NULL,
    [FOPDD_STRIKE_PRICE] MONEY NULL,
    [FOPDD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOPDD_INTFLAG] VARCHAR(15) NULL,
    [FOPDD_EXPIRYDATE] DATETIME NULL,
    [FOPDD_SEC_NAME] VARCHAR(35) NULL,
    [FOPDD_OPENING_PQTY] INT NULL,
    [FOPDD_OPENING_SQTY] INT NULL,
    [FOPDD_TODAY_PQTY] INT NULL,
    [FOPDD_TODAY_SQTY] INT NULL,
    [FOPDD_EXERCISEDQTY] INT NULL,
    [FOPDD_ASSIGNEDQTY] INT NULL,
    [FOPDD_INS_PQTY] INT NULL,
    [FOPDD_INS_SQTY] INT NULL,
    [FOPDD_CLOSING_PQTY] INT NULL,
    [FOPDD_CLOSING_SQTY] INT NULL,
    [FOPDD_EXPQTY] INT NULL,
    [FOPDD_AUTOCORPQTY] INT NULL,
    [FOPDD_LONGVALUE] MONEY NULL,
    [FOPDD_SHORTVALUE] MONEY NULL,
    [FOPDD_CLOSINGPRICE] MONEY NULL,
    [FOPDD_STLMNTPRICE] MONEY NULL,
    [FOPDD_FLAG] VARCHAR(2) NULL,
    [FOPDD_SAUDA_DATE] DATETIME NOT NULL,
    [FOPDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [FOPDD_CREATED_DT] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_TRADE_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_TRADE_DETAILS_DAS]
(
    [FOTDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [FOTDD_INST_TYPE] VARCHAR(6) NULL,
    [FOTDD_SYMBOL] VARCHAR(12) NULL,
    [FOTDD_STRIKE_PRICE] MONEY NULL,
    [FOTDD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOTDD_EXPIRY_DATE] DATETIME NULL,
    [FOTDD_SEC_NAME] VARCHAR(25) NOT NULL,
    [FOTDD_TRADEQTY] INT NULL,
    [FOTDD_VALUE] MONEY NULL,
    [FOTDD_PRICE] MONEY NULL,
    [FOTDD_PQTY] INT NULL,
    [FOTDD_SQTY] INT NULL,
    [FOTDD_PAMT] MONEY NULL,
    [FOTDD_SAMT] MONEY NULL,
    [FOTDD_NETRATE] NUMERIC(15, 7) NULL,
    [FOTDD_CFPPRICE] MONEY NULL,
    [FOTDD_CFSPRICE] MONEY NULL,
    [FOTDD_SETTPRICE] MONEY NULL,
    [FOTDD_SAUDA_DATE] DATETIME NOT NULL,
    [FOTDD_PNETRATE] MONEY NULL,
    [FOTDD_SNETRATE] MONEY NULL,
    [FOTDD_CHARGES] MONEY NULL,
    [FOTDD_BROKERAGE] MONEY NULL,
    [FOTDD_SERVICE_TAX] MONEY NULL,
    [FOTDD_BROKER_NOTE] MONEY NULL,
    [FOTDD_TURN_TAX] MONEY NULL,
    [FOTDD_SEBI_TAX] MONEY NULL,
    [FOTDD_CONTRACTNO] VARCHAR(14) NOT NULL,
    [FOTDD_PCOMM] MONEY NULL,
    [FOTDD_SCOMM] MONEY NULL,
    [FOTDD_INS_CHRG] MONEY NULL,
    [FOTDD_FLAG] VARCHAR(5) NULL,
    [FOTDD_O_C_FLAG] VARCHAR(5) NULL,
    [FOTDD_AUCTIONPART] VARCHAR(2) NULL,
    [FOTDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [FOTDD_CREATED_DT] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foaccbill_BAK_14082023
-- --------------------------------------------------
CREATE TABLE [dbo].[foaccbill_BAK_14082023]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(12) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [BillDate] SMALLDATETIME NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NULL,
    [expiryflag] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [Reserved3] INT NULL,
    [Branchcd] VARCHAR(10) NOT NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOACCBILL_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOACCBILL_ORG]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [BillDate] SMALLDATETIME NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [MTM] MONEY NULL,
    [PREMIUMPAYABLE] MONEY NULL,
    [PREMIUMRECEIVABLE] MONEY NULL,
    [NETPREMIUM] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [SERVICETAX] MONEY NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL,
    [RESERVED3] MONEY NULL,
    [RESERVED4] MONEY NULL,
    [RESERVED5] INT NULL,
    [branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOBILLVALAN_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOBILLVALAN_ORG]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(50) NULL,
    [CLIENT_TYPE] VARCHAR(10) NULL,
    [BILLNO] VARCHAR(9) NULL,
    [CONTRACTNO] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(7) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [AUCTIONPART] VARCHAR(20) NOT NULL,
    [MATURITYDATE] DATETIME NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [ISIN] VARCHAR(1) NOT NULL,
    [PQTY] INT NOT NULL,
    [SQTY] INT NOT NULL,
    [PRATE] NUMERIC(36, 12) NOT NULL,
    [SRATE] NUMERIC(36, 12) NOT NULL,
    [PAMT] NUMERIC(36, 12) NOT NULL,
    [SAMT] NUMERIC(36, 12) NOT NULL,
    [PBROKAMT] NUMERIC(36, 12) NOT NULL,
    [SBROKAMT] NUMERIC(36, 12) NOT NULL,
    [PBILLAMT] NUMERIC(36, 12) NOT NULL,
    [SBILLAMT] NUMERIC(36, 12) NOT NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [CL_CHRG] NUMERIC(36, 12) NOT NULL,
    [EXCL_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [EXSER_TAX] NUMERIC(36, 12) NOT NULL,
    [INEXSERFLAG] SMALLINT NOT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_NOTE] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [TRADETYPE] VARCHAR(20) NOT NULL,
    [PARTICIPANTCODE] VARCHAR(25) NOT NULL,
    [TERMINAL_ID] VARCHAR(1) NOT NULL,
    [FAMILY] VARCHAR(20) NOT NULL,
    [FAMILYNAME] VARCHAR(100) NOT NULL,
    [TRADER] VARCHAR(40) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [SUB_BROKER] VARCHAR(20) NOT NULL,
    [STATUSNAME] VARCHAR(1) NOT NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(1) NOT NULL,
    [MEMBERTYPE] VARCHAR(1) NOT NULL,
    [COMPANYNAME] VARCHAR(1) NOT NULL,
    [REGION] VARCHAR(20) NULL,
    [UPDATEDATE] VARCHAR(11) NOT NULL,
    [EMAIL] VARCHAR(100) NOT NULL,
    [SBU] VARCHAR(1) NOT NULL,
    [RELMGR] VARCHAR(1) NOT NULL,
    [GRP] VARCHAR(1) NOT NULL,
    [SECTOR] VARCHAR(1) NOT NULL,
    [CMCLOSING] NUMERIC(36, 12) NOT NULL,
    [TRACK] VARCHAR(1) NOT NULL,
    [AREA] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoClientBrokScheme
-- --------------------------------------------------
CREATE TABLE [dbo].[FoClientBrokScheme]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Date_From] DATETIME NULL,
    [Date_To] DATETIME NULL,
    [Fut_BrokTable] INT NULL,
    [Opt_BrokTable] INT NULL,
    [Fut_Exp_BrokTable] INT NULL,
    [Opt_Exc_BrokTable] INT NULL,
    [Comm_Del_BrokTable] INT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Opt_Brok_ComputeOn] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoClientTaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[FoClientTaxes]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Date_From] DATETIME NULL,
    [Date_To] DATETIME NULL,
    [Fut_Insurance_Chrg] DECIMAL(18, 5) NULL,
    [Fut_Turnover_Tax] DECIMAL(18, 5) NULL,
    [Fut_Other_Chrg] DECIMAL(18, 5) NULL,
    [Fut_Sebiturn_Tax] DECIMAL(18, 5) NULL,
    [Fut_Broker_Note] DECIMAL(18, 5) NULL,
    [Opt_Insurance_Chrg] DECIMAL(18, 5) NULL,
    [Opt_Turnover_Tax] DECIMAL(18, 5) NULL,
    [Opt_Other_Chrg] DECIMAL(18, 5) NULL,
    [Opt_Sebiturn_Tax] DECIMAL(18, 5) NULL,
    [Opt_Broker_Note] DECIMAL(18, 5) NULL,
    [Round_To] DECIMAL(18, 0) NULL,
    [RoFig] INT NULL,
    [ErrNum] NUMERIC(18, 10) NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCORPACTADJUSTMENT_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCORPACTADJUSTMENT_LOG]
(
    [FILE_DATE] DATETIME NULL,
    [SAUDA_DATE] DATETIME NULL,
    [ASSET_CODE] VARCHAR(12) NULL,
    [METHOD] VARCHAR(10) NULL,
    [ADJFACTORQTY] NUMERIC(18, 4) NULL,
    [ADJFACTORPRICE] NUMERIC(18, 4) NULL,
    [OLDLOTSIZE] INT NULL,
    [NEWLOTSIZE] INT NULL,
    [ROUNDING] INT NULL,
    [CREATEDBY] VARCHAR(20) NULL,
    [CREATEDON] DATETIME NULL,
    [NEW_ASSET_CODE] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOGLOBALS_12
-- --------------------------------------------------
CREATE TABLE [dbo].[FOGLOBALS_12]
(
    [year] VARCHAR(4) NULL,
    [exchange] VARCHAR(3) NULL,
    [service_tax] MONEY NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] SMALLINT NULL,
    [sebi_turn_ac] SMALLINT NULL,
    [broker_note_ac] SMALLINT NULL,
    [other_chrg_ac] SMALLINT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NULL,
    [year_end_dt] DATETIME NULL,
    [CESS_Tax] NUMERIC(10, 9) NULL,
    [TrdBuyTrans] NUMERIC(18, 4) NULL,
    [TrdSellTrans] NUMERIC(18, 4) NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [OptTrdSellTrans] NUMERIC(18, 4) NULL,
    [OptDelSellTrans] NUMERIC(18, 4) NULL,
    [STT_On] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Span
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Span]
(
    [Party_Code] VARCHAR(10) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Spanmargin] MONEY NULL,
    [Premium] MONEY NULL,
    [Totalmargin] MONEY NULL,
    [Pmarginrate] DECIMAL(18, 0) NULL,
    [Mdate] DATETIME NULL,
    [Newspanmargin] MONEY NULL,
    [Finaltotalmargin] MONEY NULL,
    [Cl_Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMG13REFERENCE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMG13REFERENCE]
(
    [RefNo] INT NULL,
    [SubMenuRefno] INT NULL,
    [Subject] VARCHAR(50) NULL,
    [Heading] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSETTCORPACT
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSETTCORPACT]
(
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [TRADE_NO] VARCHAR(16) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TRADESTATUS] VARCHAR(2) NULL,
    [SEGMENT] VARCHAR(1) NULL,
    [SETT_TYPE] VARCHAR(1) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(12, 0) NULL,
    [LOT_SIZE] NUMERIC(12, 0) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [SETT_FLAG] INT NULL,
    [CA_LEVEL] VARCHAR(1) NULL,
    [BROKER_CD] VARCHAR(10) NULL,
    [TRADE_PRICE] NUMERIC(12, 4) NULL,
    [LOCATIONID] VARCHAR(16) NULL,
    [CM_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(12) NULL,
    [CP_CONFIRMATION] VARCHAR(1) NULL,
    [OC_FLAG] VARCHAR(1) NULL,
    [OLD_CP_CODE] VARCHAR(12) NULL,
    [OLD_CM_CODE] VARCHAR(10) NULL,
    [TERMINALID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(24) NULL,
    [BUY_POSITION] VARCHAR(1) NULL,
    [SELL_POSITION] VARCHAR(1) NULL,
    [PRO_CLI] VARCHAR(1) NULL,
    [ORDER_TIMESTAMP] VARCHAR(20) NULL,
    [ORDER_ACTIVEFLAG] VARCHAR(1) NULL,
    [TABLE_NO] SMALLINT NULL,
    [LINE_NO] DECIMAL(18, 0) NULL,
    [VAL_PERC] VARCHAR(1) NULL,
    [NORMAL] DECIMAL(18, 0) NULL,
    [DAY_PUC] DECIMAL(18, 0) NULL,
    [DAY_SALES] DECIMAL(18, 0) NULL,
    [SETT_PURCH] DECIMAL(18, 0) NULL,
    [SETT_SALES] DECIMAL(18, 0) NULL,
    [SETTFLAG] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 8) NULL,
    [NOZERO] INT NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [TRADE_AMOUNT] NUMERIC(18, 4) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [BROKAPPLIED] NUMERIC(18, 4) NULL,
    [INS_CHRG] NUMERIC(18, 4) NULL,
    [TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_TAX] NUMERIC(18, 4) NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NULL,
    [NETRATE] NUMERIC(18, 4) NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [RESERVED1] TINYINT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [STATUS] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRADE_STANDARD_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRADE_STANDARD_IMP]
(
    [TRADDT] VARCHAR(100) NULL,
    [BIZDT] VARCHAR(100) NULL,
    [SGMT] VARCHAR(100) NULL,
    [SRC] VARCHAR(100) NULL,
    [XCHG] VARCHAR(100) NULL,
    [CLRMMBID] VARCHAR(100) NULL,
    [BRKR] VARCHAR(100) NULL,
    [FININSTRMTP] VARCHAR(100) NULL,
    [FININSTRMID] VARCHAR(100) NULL,
    [ISIN] VARCHAR(100) NULL,
    [TCKRSYMB] VARCHAR(100) NULL,
    [SCTYSRS] VARCHAR(100) NULL,
    [XPRYDT] VARCHAR(100) NULL,
    [FININSTRMACTLXPRYDT] VARCHAR(100) NULL,
    [STRKPRIC] VARCHAR(100) NULL,
    [OPTNTP] VARCHAR(100) NULL,
    [FININSTRMNM] VARCHAR(100) NULL,
    [CLNTTP] VARCHAR(100) NULL,
    [CLNTID] VARCHAR(100) NULL,
    [FULLYEXCTDCONFSNT] VARCHAR(100) NULL,
    [ORGNLCTDNPTCPTID] VARCHAR(100) NULL,
    [CTDNPTCPTID] VARCHAR(100) NULL,
    [STTLMTP] VARCHAR(100) NULL,
    [SCTIESSTTLMTXID] VARCHAR(100) NULL,
    [BUYSELLIND] VARCHAR(100) NULL,
    [TRADQTY] VARCHAR(100) NULL,
    [NEWBRDLOTQTY] VARCHAR(100) NULL,
    [PRIC] VARCHAR(100) NULL,
    [UNQTRADIDR] VARCHAR(100) NULL,
    [RPTDTXSTS] VARCHAR(100) NULL,
    [TRADDTTM] VARCHAR(100) NULL,
    [UPDDT] VARCHAR(100) NULL,
    [ORDRREF] VARCHAR(100) NULL,
    [ORDRDTTM] VARCHAR(100) NULL,
    [INSTGUSR] VARCHAR(100) NULL,
    [CTCLID] VARCHAR(100) NULL,
    [TRADREGNORGN] VARCHAR(100) NULL,
    [ORDRTP] VARCHAR(100) NULL,
    [BLCKDEALIND] VARCHAR(100) NULL,
    [STTLMCYCL] VARCHAR(100) NULL,
    [MKTTPANDID] VARCHAR(100) NULL,
    [RMKS] VARCHAR(100) NULL,
    [RSVD1] VARCHAR(100) NULL,
    [RSVD2] VARCHAR(100) NULL,
    [RSVD3] VARCHAR(100) NULL,
    [RSVD4] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_ContractNo
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_ContractNo]
(
    [Sno] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Order_No] VARCHAR(20) NULL,
    [PRODUCT_CODE] VARCHAR(10) NULL,
    [SERIES_CODE] VARCHAR(20) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [InsCont] CHAR(1) NULL,
    [Sell_Buy] INT NULL,
    [CL_TYPE] VARCHAR(4) NULL,
    [NEWCONTRACTNO] VARCHAR(10) NULL,
    [CONTSERIES] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDING_APR17
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDING_APR17]
(
    [HLD_AC_CODE] VARCHAR(16) NULL,
    [VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDING_FEB
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDING_FEB]
(
    [HLD_AC_CODE] VARCHAR(16) NULL,
    [VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDING_mar17
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDING_mar17]
(
    [HLD_AC_CODE] VARCHAR(16) NULL,
    [VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDING_OCT
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDING_OCT]
(
    [HLD_AC_CODE] VARCHAR(16) NULL,
    [VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IMP_FilePath
-- --------------------------------------------------
CREATE TABLE [dbo].[IMP_FilePath]
(
    [File_Type] VARCHAR(20) NULL,
    [File_Path] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INST_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[INST_LOG]
(
    [Party_Code] VARCHAR(10) NULL,
    [New_Party_Code] VARCHAR(10) NULL,
    [Sauda_Date] DATETIME NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(20) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Order_No] VARCHAR(20) NULL,
    [Trade_No] VARCHAR(20) NULL,
    [Sell_Buy] VARCHAR(1) NULL,
    [Contract_No] VARCHAR(20) NULL,
    [New_Contract_No] VARCHAR(20) NULL,
    [Brokerage] NUMERIC(18, 4) NULL,
    [New_Brokerage] NUMERIC(18, 4) NULL,
    [Market_Rate] NUMERIC(18, 4) NULL,
    [New_Market_Rate] NUMERIC(18, 4) NULL,
    [Net_Rate] NUMERIC(18, 4) NULL,
    [New_net_rate] NUMERIC(18, 4) NULL,
    [Qty] BIGINT NULL,
    [New_Qty] BIGINT NULL,
    [RoundTo] INT NULL,
    [Participant_Code] VARCHAR(20) NULL,
    [New_Participant_Code] VARCHAR(20) NULL,
    [UserName] VARCHAR(50) NULL,
    [Module] VARCHAR(100) NULL,
    [Called_From] VARCHAR(100) NULL,
    [TimeStamp] DATETIME NULL,
    [ExtraField3] VARCHAR(50) NULL,
    [ExtraField4] VARCHAR(50) NULL,
    [ExtraField5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Instclient_Tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[Instclient_Tbl]
(
    [Partycode] CHAR(10) NULL,
    [Marketrate] CHAR(1) NULL,
    [Brokerage] CHAR(1) NULL,
    [Netrate] CHAR(1) NULL,
    [Noc] INT NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_DETAILS_DAS]
(
    [LEDDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [LEDDD_SAUDA_DATE] DATETIME NULL,
    [LEDDD_OPENING_BAL] MONEY NULL,
    [LEDDD_CHQ_REC] MONEY NULL,
    [LEDDD_CHQ_PAY] MONEY NULL,
    [LEDDD_JV_ENTRY] MONEY NULL,
    [LEDDD_CLOSING_BAL] MONEY NULL,
    [LEDDD_CASH_MARGIN] MONEY NULL,
    [LEDDD_OPENING_INIT_MARGIN] MONEY NULL,
    [LEDDD_MRG_REC] MONEY NULL,
    [LEDDD_MRG_REPAY] MONEY NULL,
    [LEDDD_MRG_JV_ENTRY] MONEY NULL,
    [LEDDD_CLOSING_INIT_MARGIN] MONEY NULL,
    [LEDDD_NONCASH_COLL_HC] MONEY NULL,
    [LEDDD_INIT_EXPO_MARGIN] MONEY NULL,
    [LEDDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [LEDDD_CREATED_DT] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOG_PWDMAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[LOG_PWDMAILS]
(
    [FLDID] INT NOT NULL,
    [FLDSTNAME] VARCHAR(10) NOT NULL,
    [FLDUSERNAME] VARCHAR(20) NOT NULL,
    [PAN_GIR_NO] VARCHAR(20) NOT NULL,
    [DOB] VARCHAR(10) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [IP_ADDR] VARCHAR(20) NOT NULL,
    [MAC_ID] VARCHAR(25) NOT NULL,
    [ERROR_DESC] VARCHAR(100) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL,
    [EMAIL_SENT_STAT] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MARGIN_REPORTING
-- --------------------------------------------------
CREATE TABLE [dbo].[MARGIN_REPORTING]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PREV_CASH] NUMERIC(18, 4) NULL,
    [PREV_FD] NUMERIC(18, 4) NULL,
    [PREV_BG] NUMERIC(18, 4) NULL,
    [PREV_SEC] NUMERIC(18, 4) NULL,
    [PREV_VAR] NUMERIC(18, 4) NULL,
    [CURR_CASH] NUMERIC(18, 4) NULL,
    [CURR_FD] NUMERIC(18, 4) NULL,
    [CURR_BG] NUMERIC(18, 4) NULL,
    [CURR_SEC] NUMERIC(18, 4) NULL,
    [MAR_ADJUST] NUMERIC(18, 4) NULL,
    [MAR_STATUS] NUMERIC(18, 4) NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCX_UCC
-- --------------------------------------------------
CREATE TABLE [dbo].[MCX_UCC]
(
    [Client Code] VARCHAR(50) NULL,
    [Client Name] VARCHAR(50) NULL,
    [Category] VARCHAR(50) NULL,
    [PAN] VARCHAR(50) NULL,
    [Gender] VARCHAR(50) NULL,
    [Father's Husband's Guardian's Name] VARCHAR(50) NULL,
    [Marital Status] VARCHAR(50) NULL,
    [Nationality] VARCHAR(50) NULL,
    [Nationality (Others)] VARCHAR(50) NULL,
    [Client Email ID] VARCHAR(50) NULL,
    [Address 1 (Corresponding)] VARCHAR(50) NULL,
    [Address 2 (Corresponding)] VARCHAR(50) NULL,
    [Address 3 (Corresponding)] VARCHAR(50) NULL,
    [Country (Corresponding)] VARCHAR(50) NULL,
    [State-City Code (Corresponding)] VARCHAR(50) NULL,
    [Pin Code (Corresponding)] VARCHAR(50) NULL,
    [Permanent  Address same as Corresponding Address] VARCHAR(50) NULL,
    [Address 1 (Permanent)] VARCHAR(50) NULL,
    [Address 2 (Permanent)] VARCHAR(50) NULL,
    [Address 3 (Permanent)] VARCHAR(50) NULL,
    [Country (Permanent) ] VARCHAR(50) NULL,
    [State-City Code (Permanent)] VARCHAR(50) NULL,
    [Pin Code (Permanent)] VARCHAR(50) NULL,
    [Telephone Number (R)] VARCHAR(50) NULL,
    [Mobile Number] VARCHAR(50) NULL,
    [Telephone Number(O)] VARCHAR(50) NULL,
    [Date of Birth Incorporation] VARCHAR(50) NULL,
    [UID Number] VARCHAR(50) NULL,
    [Bank Name-1] VARCHAR(50) NULL,
    [Bank Branch Address-1] VARCHAR(50) NULL,
    [Bank Account Number-1] VARCHAR(50) NULL,
    [Bank Account Type-1] VARCHAR(50) NULL,
    [Bank Name-2] VARCHAR(50) NULL,
    [Bank Branch Address-2] VARCHAR(50) NULL,
    [Bank Account Number-2] VARCHAR(50) NULL,
    [Bank Account Type-2] VARCHAR(50) NULL,
    [Bank Name-3] VARCHAR(50) NULL,
    [Bank Branch Address-3] VARCHAR(50) NULL,
    [Bank Account Number-3] VARCHAR(50) NULL,
    [Bank Account Type-3] VARCHAR(50) NULL,
    [Depository Name-1] VARCHAR(50) NULL,
    [Depository Participant Id-1] VARCHAR(50) NULL,
    [Beneficiary Account ID-1] VARCHAR(50) NULL,
    [Depository Name-2] VARCHAR(50) NULL,
    [Depository Participant Id-2] VARCHAR(50) NULL,
    [Beneficiary Account ID-2] VARCHAR(50) NULL,
    [Depository Name-3] VARCHAR(50) NULL,
    [Depository Participant Id-3] VARCHAR(50) NULL,
    [Beneficiary Account ID-3] VARCHAR(50) NULL,
    [CIN] VARCHAR(50) NULL,
    [Place of Incorporation] VARCHAR(50) NULL,
    [Occupation] VARCHAR(50) NULL,
    [Occupation Details (For Others)] VARCHAR(50) NULL,
    [Date of Commencement of Business] VARCHAR(50) NULL,
    [Income Detail (per annum in Rs )] VARCHAR(50) NULL,
    [Income As on Date] VARCHAR(50) NULL,
    [Networth (in Rs )] VARCHAR(50) NULL,
    [Networth As on Date] VARCHAR(50) NULL,
    [Politically Exposed Person(PEP)] VARCHAR(50) NULL,
    [CP Code] VARCHAR(50) NULL,
    [Registration Number of Client] VARCHAR(50) NULL,
    [Registering Authority] VARCHAR(50) NULL,
    [Place of Registration] VARCHAR(50) NULL,
    [Date of Registration] VARCHAR(50) NULL,
    [Inperson Verification] VARCHAR(50) NULL,
    [Client Agreement Date] VARCHAR(50) NULL,
    [Reserved] VARCHAR(50) NULL,
    [Relationship Code] VARCHAR(50) NULL,
    [Proof Type] VARCHAR(50) NULL,
    [Proof Number] VARCHAR(50) NULL,
    [Issue Place of Proof] VARCHAR(50) NULL,
    [Issue Date of Proof] VARCHAR(50) NULL,
    [Client Status] VARCHAR(50) NULL,
    [Remarks] VARCHAR(50) NULL,
    [Client Type-Corporate] VARCHAR(50) NULL,
    [Name of Contact Person-1] VARCHAR(50) NULL,
    [Designation of Contact Person-1] VARCHAR(50) NULL,
    [PAN of Contact Person-1] VARCHAR(50) NULL,
    [Address of Contact Person-1] VARCHAR(50) NULL,
    [Contact Details of Contact Person-1] VARCHAR(50) NULL,
    [DIN of Contact Person-1] VARCHAR(50) NULL,
    [UID of Contact Person-1] VARCHAR(50) NULL,
    [Email Id Contact Person-1] VARCHAR(50) NULL,
    [Name of Contact Person-2] VARCHAR(50) NULL,
    [Designation ofContact Person-2] VARCHAR(50) NULL,
    [PAN of Contact Person-2] VARCHAR(50) NULL,
    [Address of Contact Person-2] VARCHAR(50) NULL,
    [Contact Details of Contact Person-2] VARCHAR(50) NULL,
    [DIN of Contact Person-2] VARCHAR(50) NULL,
    [UID of Contact Person-2] VARCHAR(50) NULL,
    [Email Id Contact Person-2] VARCHAR(50) NULL,
    [Name of Contact Person-3] VARCHAR(50) NULL,
    [Designation of Contact Person-3] VARCHAR(50) NULL,
    [PAN of Contact Person-3] VARCHAR(50) NULL,
    [Address of Contact Person-3] VARCHAR(50) NULL,
    [Contact Details of Contact Person-3] VARCHAR(50) NULL,
    [DIN of Contact Person-3] VARCHAR(50) NULL,
    [UID of Contact Person-3] VARCHAR(50) NULL,
    [Email Id Contact Person-3] VARCHAR(50) NULL,
    [Name of Contact Person-4] VARCHAR(50) NULL,
    [Designation of Contact Person-4] VARCHAR(50) NULL,
    [PAN of Contact Person-4] VARCHAR(50) NULL,
    [Address of Contact Person-4] VARCHAR(50) NULL,
    [Contact Details of Contact Person-4] VARCHAR(50) NULL,
    [DIN of Contact Person-4] VARCHAR(50) NULL,
    [UID of Contact Person-4] VARCHAR(50) NULL,
    [Email Id Contact Person-4] VARCHAR(50) NULL,
    [Name of Contact Person-5] VARCHAR(50) NULL,
    [Designation of Contact Person-5] VARCHAR(50) NULL,
    [PAN of Contact Person-5] VARCHAR(50) NULL,
    [Address of Contact Person-5] VARCHAR(50) NULL,
    [Contact Details of Contact Person-5] VARCHAR(50) NULL,
    [DIN of Contact Person-5] VARCHAR(50) NULL,
    [UID of Contact Person-5] VARCHAR(50) NULL,
    [Email Id Contact Person-5] VARCHAR(50) NULL,
    [Name of Contact Person-6] VARCHAR(50) NULL,
    [Designation of Contact Person-6] VARCHAR(50) NULL,
    [PAN of Contact Person-6] VARCHAR(50) NULL,
    [Address of Contact Person-6] VARCHAR(50) NULL,
    [Contact Details of Contact Person-6] VARCHAR(50) NULL,
    [DIN of Contact Person-6] VARCHAR(50) NULL,
    [UID of Contact Person-6] VARCHAR(50) NULL,
    [Email Id Contact Person-6] VARCHAR(50) NULL,
    [Name of Contact Person-7] VARCHAR(50) NULL,
    [Designation of Contact Person-7] VARCHAR(50) NULL,
    [PAN of Contact Person-7] VARCHAR(50) NULL,
    [Address of Contact Person-7] VARCHAR(50) NULL,
    [Contact Details of Contact Person-7] VARCHAR(50) NULL,
    [DIN of Contact Person-7] VARCHAR(50) NULL,
    [UID of Contact Person-7] VARCHAR(50) NULL,
    [Email Id Contact Person-7] VARCHAR(50) NULL,
    [Name of Contact Person-71] VARCHAR(50) NULL,
    [Designation of Contact Person-8] VARCHAR(50) NULL,
    [PAN of Contact Person-8] VARCHAR(50) NULL,
    [Address of Contact Person-8] VARCHAR(50) NULL,
    [Contact Details of Contact Person-8] VARCHAR(50) NULL,
    [DIN of Contact Person-8] VARCHAR(50) NULL,
    [UID of Contact Person-8] VARCHAR(50) NULL,
    [Email Id Contact Person-8] VARCHAR(50) NULL,
    [Name of Contact Person-9] VARCHAR(50) NULL,
    [Designation of Contact Person-9] VARCHAR(50) NULL,
    [PAN of Contact Person-9] VARCHAR(50) NULL,
    [Address of Contact Person-9] VARCHAR(50) NULL,
    [Contact Details of Contact Person-9] VARCHAR(50) NULL,
    [DIN of Contact Person-9] VARCHAR(50) NULL,
    [UID of Contact Person-9] VARCHAR(50) NULL,
    [Email Id Contact Person-9] VARCHAR(50) NULL,
    [Name of Contact Person-10] VARCHAR(50) NULL,
    [Designation of Contact Person-10] VARCHAR(50) NULL,
    [PAN of Contact Person-10] VARCHAR(50) NULL,
    [Address of Contact Person-10] VARCHAR(50) NULL,
    [Contact Details of Contact Person-10] VARCHAR(50) NULL,
    [DIN of Contact Person-10] VARCHAR(50) NULL,
    [UID of Contact Person-10] VARCHAR(50) NULL,
    [Email Id Contact Person-10] VARCHAR(50) NULL,
    [Name of Contact Person-11] VARCHAR(50) NULL,
    [Designation of Contact Person-11] VARCHAR(50) NULL,
    [PAN of Contact Person-11] VARCHAR(50) NULL,
    [Address of Contact Person-11] VARCHAR(50) NULL,
    [Contact Details of Contact Person-11] VARCHAR(50) NULL,
    [DIN of Contact Person-11] VARCHAR(50) NULL,
    [UID of Contact Person-11] VARCHAR(50) NULL,
    [Email Id Contact Person-11] VARCHAR(50) NULL,
    [Name of Contact Person-12] VARCHAR(50) NULL,
    [Designation of Contact Person-12] VARCHAR(50) NULL,
    [PAN of Contact Person-12] VARCHAR(50) NULL,
    [Address of Contact Person-12] VARCHAR(50) NULL,
    [Contact Details of Contact Person-12] VARCHAR(50) NULL,
    [DIN of Contact Person-12] VARCHAR(50) NULL,
    [UID of Contact Person-12] VARCHAR(50) NULL,
    [Email Id Contact Person-12] VARCHAR(50) NULL,
    [Name of Contact Person-13] VARCHAR(50) NULL,
    [Designation of Contact Person-13] VARCHAR(50) NULL,
    [PAN of Contact Person-13] VARCHAR(50) NULL,
    [Address of Contact Person-13] VARCHAR(50) NULL,
    [Contact Details of Contact Person-13] VARCHAR(50) NULL,
    [DIN of Contact Person-13] VARCHAR(50) NULL,
    [UID of Contact Person-13] VARCHAR(50) NULL,
    [Email Id Contact Person-13] VARCHAR(50) NULL,
    [Name of Contact Person-14] VARCHAR(50) NULL,
    [Designation of Contact Person-14] VARCHAR(50) NULL,
    [PAN of Contact Person-14] VARCHAR(50) NULL,
    [Address of Contact Person-14] VARCHAR(50) NULL,
    [Contact Details of Contact Person-14] VARCHAR(50) NULL,
    [DIN of Contact Person-14] VARCHAR(50) NULL,
    [UID of Contact Person-14] VARCHAR(50) NULL,
    [Email Id Contact Person-14] VARCHAR(50) NULL,
    [Name of Contact Person-15] VARCHAR(50) NULL,
    [Designation of Contact Person-15] VARCHAR(50) NULL,
    [PAN of Contact Person-15] VARCHAR(50) NULL,
    [Address of Contact Person-15] VARCHAR(50) NULL,
    [Contact Details of Contact Person-15] VARCHAR(50) NULL,
    [DIN of Contact Person-15] VARCHAR(50) NULL,
    [UID of Contact Person-15] VARCHAR(50) NULL,
    [Email Id Contact Person-15] VARCHAR(50) NULL,
    [Name of Contact Person-16] VARCHAR(50) NULL,
    [Designation of Contact Person-16] VARCHAR(50) NULL,
    [PAN of Contact Person-16] VARCHAR(50) NULL,
    [Address of Contact Person-16] VARCHAR(50) NULL,
    [Contact Details of Contact Person-16] VARCHAR(50) NULL,
    [DIN of Contact Person-16] VARCHAR(50) NULL,
    [UID of Contact Person-16] VARCHAR(50) NULL,
    [Email Id Contact Person-16] VARCHAR(50) NULL,
    [Name of Contact Person-17] VARCHAR(50) NULL,
    [Designation of Contact Person-17] VARCHAR(50) NULL,
    [PAN of Contact Person-17] VARCHAR(50) NULL,
    [Address of Contact Person-17] VARCHAR(50) NULL,
    [Contact Details of Contact Person-17] VARCHAR(50) NULL,
    [DIN of Contact Person-17] VARCHAR(50) NULL,
    [UID of Contact Person-17] VARCHAR(50) NULL,
    [Email Id Contact Person-17] VARCHAR(50) NULL,
    [Name of Contact Person-18] VARCHAR(50) NULL,
    [Designation of Contact Person-18] VARCHAR(50) NULL,
    [PAN of Contact Person-18] VARCHAR(50) NULL,
    [Address of Contact Person-18] VARCHAR(50) NULL,
    [Contact Details of Contact Person-18] VARCHAR(50) NULL,
    [DIN of Contact Person-18] VARCHAR(50) NULL,
    [UID of Contact Person-18] VARCHAR(50) NULL,
    [Email Id Contact Person-18] VARCHAR(50) NULL,
    [Name of Contact Person-19] VARCHAR(50) NULL,
    [Designation of Contact Person-19] VARCHAR(50) NULL,
    [PAN of Contact Person-19] VARCHAR(50) NULL,
    [Address of Contact Person-19] VARCHAR(50) NULL,
    [Contact Details of Contact Person-19] VARCHAR(50) NULL,
    [DIN of Contact Person-19] VARCHAR(50) NULL,
    [UID of Contact Person-19] VARCHAR(50) NULL,
    [Email Id Contact Person-19] VARCHAR(50) NULL,
    [Name of Contact Person-20] VARCHAR(50) NULL,
    [Designation of Contact Person-20] VARCHAR(50) NULL,
    [PAN of Contact Person-20] VARCHAR(50) NULL,
    [Address of Contact Person-20] VARCHAR(50) NULL,
    [Contact Details of Contact Person-20] VARCHAR(50) NULL,
    [DIN of Contact Person-20] VARCHAR(50) NULL,
    [UID of Contact Person-20] VARCHAR(50) NULL,
    [Email Id Contact Person-20] VARCHAR(50) NULL,
    [Created Date Time] VARCHAR(50) NULL,
    [Last Modified Date Time] VARCHAR(50) NULL,
    [Column 237] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mcxucc
-- --------------------------------------------------
CREATE TABLE [dbo].[mcxucc]
(
    [Client Code] NVARCHAR(255) NULL,
    [Client Name] NVARCHAR(255) NULL,
    [Category] FLOAT NULL,
    [PAN] NVARCHAR(255) NULL,
    [Gender] NVARCHAR(255) NULL,
    [Father's/Husband's/Guardian's Name] NVARCHAR(255) NULL,
    [Marital Status] NVARCHAR(255) NULL,
    [Nationality] FLOAT NULL,
    [Nationality (Others)] NVARCHAR(255) NULL,
    [Client Email ID] NVARCHAR(255) NULL,
    [Address 1 (Corresponding)] NVARCHAR(255) NULL,
    [Address 2 (Corresponding)] NVARCHAR(255) NULL,
    [Address 3 (Corresponding)] NVARCHAR(255) NULL,
    [Country (Corresponding)] FLOAT NULL,
    [State-City Code (Corresponding)] FLOAT NULL,
    [Pin Code (Corresponding)] FLOAT NULL,
    [Permanent  Address same as Corresponding Address] NVARCHAR(255) NULL,
    [Address 1 (Permanent)] NVARCHAR(255) NULL,
    [Address 2 (Permanent)] NVARCHAR(255) NULL,
    [Address 3 (Permanent)] NVARCHAR(255) NULL,
    [Country (Permanent) ] FLOAT NULL,
    [State-City Code (Permanent)] FLOAT NULL,
    [Pin Code (Permanent)] FLOAT NULL,
    [Telephone Number (R)] NVARCHAR(255) NULL,
    [Mobile Number] FLOAT NULL,
    [Telephone Number(O)] FLOAT NULL,
    [Date of Birth/Incorporation] DATETIME NULL,
    [UID Number] NVARCHAR(255) NULL,
    [Bank Name-1] NVARCHAR(255) NULL,
    [Bank Branch Address-1] NVARCHAR(255) NULL,
    [Bank Account Number-1] NVARCHAR(255) NULL,
    [Bank Account Type-1] FLOAT NULL,
    [Bank Name-2] NVARCHAR(255) NULL,
    [Bank Branch Address-2] NVARCHAR(255) NULL,
    [Bank Account Number-2] NVARCHAR(255) NULL,
    [Bank Account Type-2] NVARCHAR(255) NULL,
    [Bank Name-3] NVARCHAR(255) NULL,
    [Bank Branch Address-3] NVARCHAR(255) NULL,
    [Bank Account Number-3] NVARCHAR(255) NULL,
    [Bank Account Type-3] NVARCHAR(255) NULL,
    [Depository Name-1] FLOAT NULL,
    [Depository Participant Id-1] NVARCHAR(255) NULL,
    [Beneficiary Account ID-1] NVARCHAR(255) NULL,
    [Depository Name-2] FLOAT NULL,
    [Depository Participant Id-2] NVARCHAR(255) NULL,
    [Beneficiary Account ID-2] NVARCHAR(255) NULL,
    [Depository Name-3] NVARCHAR(255) NULL,
    [Depository Participant Id-3] NVARCHAR(255) NULL,
    [Beneficiary Account ID-3] NVARCHAR(255) NULL,
    [CIN] NVARCHAR(255) NULL,
    [Place of Incorporation] NVARCHAR(255) NULL,
    [Occupation] FLOAT NULL,
    [Occupation Details (For Others)] NVARCHAR(255) NULL,
    [Date of Commencement of Business] NVARCHAR(255) NULL,
    [Income Detail (per annum in Rs#)] FLOAT NULL,
    [Income As on Date] DATETIME NULL,
    [Networth (in Rs#)] NVARCHAR(255) NULL,
    [Networth As on Date] NVARCHAR(255) NULL,
    [Politically Exposed Person(PEP)] FLOAT NULL,
    [CP Code] NVARCHAR(255) NULL,
    [Registration Number of Client] NVARCHAR(255) NULL,
    [Registering Authority] NVARCHAR(255) NULL,
    [Place of Registration] NVARCHAR(255) NULL,
    [Date of Registration] NVARCHAR(255) NULL,
    [Inperson Verification] NVARCHAR(255) NULL,
    [Client Agreement Date] DATETIME NULL,
    [Reserved] NVARCHAR(255) NULL,
    [Relationship Code] NVARCHAR(255) NULL,
    [Proof Type] NVARCHAR(255) NULL,
    [Proof Number] NVARCHAR(255) NULL,
    [Issue Place of Proof] NVARCHAR(255) NULL,
    [Issue Date of Proof] DATETIME NULL,
    [Client Status] FLOAT NULL,
    [Remarks] NVARCHAR(255) NULL,
    [Client Type-Corporate] NVARCHAR(255) NULL,
    [Name of Contact Person-1] NVARCHAR(255) NULL,
    [Designation of Contact Person-1] NVARCHAR(255) NULL,
    [PAN of Contact Person-1] NVARCHAR(255) NULL,
    [Address of Contact Person-1] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-1] NVARCHAR(255) NULL,
    [DIN of Contact Person-1] NVARCHAR(255) NULL,
    [UID of Contact Person-1] NVARCHAR(255) NULL,
    [Email Id Contact Person-1] NVARCHAR(255) NULL,
    [Name of Contact Person-2] NVARCHAR(255) NULL,
    [Designation ofContact Person-2] NVARCHAR(255) NULL,
    [PAN of Contact Person-2] NVARCHAR(255) NULL,
    [Address of Contact Person-2] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-2] NVARCHAR(255) NULL,
    [DIN of Contact Person-2] NVARCHAR(255) NULL,
    [UID of Contact Person-2] NVARCHAR(255) NULL,
    [Email Id Contact Person-2] NVARCHAR(255) NULL,
    [Name of Contact Person-3] NVARCHAR(255) NULL,
    [Designation of Contact Person-3] NVARCHAR(255) NULL,
    [PAN of Contact Person-3] NVARCHAR(255) NULL,
    [Address of Contact Person-3] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-3] NVARCHAR(255) NULL,
    [DIN of Contact Person-3] NVARCHAR(255) NULL,
    [UID of Contact Person-3] NVARCHAR(255) NULL,
    [Email Id Contact Person-3] NVARCHAR(255) NULL,
    [Name of Contact Person-4] NVARCHAR(255) NULL,
    [Designation of Contact Person-4] NVARCHAR(255) NULL,
    [PAN of Contact Person-4] NVARCHAR(255) NULL,
    [Address of Contact Person-4] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-4] NVARCHAR(255) NULL,
    [DIN of Contact Person-4] NVARCHAR(255) NULL,
    [UID of Contact Person-4] NVARCHAR(255) NULL,
    [Email Id Contact Person-4] NVARCHAR(255) NULL,
    [Name of Contact Person-5] NVARCHAR(255) NULL,
    [Designation of Contact Person-5] NVARCHAR(255) NULL,
    [PAN of Contact Person-5] NVARCHAR(255) NULL,
    [Address of Contact Person-5] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-5] NVARCHAR(255) NULL,
    [DIN of Contact Person-5] NVARCHAR(255) NULL,
    [UID of Contact Person-5] NVARCHAR(255) NULL,
    [Email Id Contact Person-5] NVARCHAR(255) NULL,
    [Name of Contact Person-6] NVARCHAR(255) NULL,
    [Designation of Contact Person-6] NVARCHAR(255) NULL,
    [PAN of Contact Person-6] NVARCHAR(255) NULL,
    [Address of Contact Person-6] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-6] NVARCHAR(255) NULL,
    [DIN of Contact Person-6] NVARCHAR(255) NULL,
    [UID of Contact Person-6] NVARCHAR(255) NULL,
    [Email Id Contact Person-6] NVARCHAR(255) NULL,
    [Name of Contact Person-7] NVARCHAR(255) NULL,
    [Designation of Contact Person-7] NVARCHAR(255) NULL,
    [PAN of Contact Person-7] NVARCHAR(255) NULL,
    [Address of Contact Person-7] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-7] NVARCHAR(255) NULL,
    [DIN of Contact Person-7] NVARCHAR(255) NULL,
    [UID of Contact Person-7] NVARCHAR(255) NULL,
    [Email Id Contact Person-7] NVARCHAR(255) NULL,
    [Name of Contact Person-71] NVARCHAR(255) NULL,
    [Designation of Contact Person-8] NVARCHAR(255) NULL,
    [PAN of Contact Person-8] NVARCHAR(255) NULL,
    [Address of Contact Person-8] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-8] NVARCHAR(255) NULL,
    [DIN of Contact Person-8] NVARCHAR(255) NULL,
    [UID of Contact Person-8] NVARCHAR(255) NULL,
    [Email Id Contact Person-8] NVARCHAR(255) NULL,
    [Name of Contact Person-9] NVARCHAR(255) NULL,
    [Designation of Contact Person-9] NVARCHAR(255) NULL,
    [PAN of Contact Person-9] NVARCHAR(255) NULL,
    [Address of Contact Person-9] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-9] NVARCHAR(255) NULL,
    [DIN of Contact Person-9] NVARCHAR(255) NULL,
    [UID of Contact Person-9] NVARCHAR(255) NULL,
    [Email Id Contact Person-9] NVARCHAR(255) NULL,
    [Name of Contact Person-10] NVARCHAR(255) NULL,
    [Designation of Contact Person-10] NVARCHAR(255) NULL,
    [PAN of Contact Person-10] NVARCHAR(255) NULL,
    [Address of Contact Person-10] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-10] NVARCHAR(255) NULL,
    [DIN of Contact Person-10] NVARCHAR(255) NULL,
    [UID of Contact Person-10] NVARCHAR(255) NULL,
    [Email Id Contact Person-10] NVARCHAR(255) NULL,
    [Name of Contact Person-11] NVARCHAR(255) NULL,
    [Designation of Contact Person-11] NVARCHAR(255) NULL,
    [PAN of Contact Person-11] NVARCHAR(255) NULL,
    [Address of Contact Person-11] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-11] NVARCHAR(255) NULL,
    [DIN of Contact Person-11] NVARCHAR(255) NULL,
    [UID of Contact Person-11] NVARCHAR(255) NULL,
    [Email Id Contact Person-11] NVARCHAR(255) NULL,
    [Name of Contact Person-12] NVARCHAR(255) NULL,
    [Designation of Contact Person-12] NVARCHAR(255) NULL,
    [PAN of Contact Person-12] NVARCHAR(255) NULL,
    [Address of Contact Person-12] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-12] NVARCHAR(255) NULL,
    [DIN of Contact Person-12] NVARCHAR(255) NULL,
    [UID of Contact Person-12] NVARCHAR(255) NULL,
    [Email Id Contact Person-12] NVARCHAR(255) NULL,
    [Name of Contact Person-13] NVARCHAR(255) NULL,
    [Designation of Contact Person-13] NVARCHAR(255) NULL,
    [PAN of Contact Person-13] NVARCHAR(255) NULL,
    [Address of Contact Person-13] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-13] NVARCHAR(255) NULL,
    [DIN of Contact Person-13] NVARCHAR(255) NULL,
    [UID of Contact Person-13] NVARCHAR(255) NULL,
    [Email Id Contact Person-13] NVARCHAR(255) NULL,
    [Name of Contact Person-14] NVARCHAR(255) NULL,
    [Designation of Contact Person-14] NVARCHAR(255) NULL,
    [PAN of Contact Person-14] NVARCHAR(255) NULL,
    [Address of Contact Person-14] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-14] NVARCHAR(255) NULL,
    [DIN of Contact Person-14] NVARCHAR(255) NULL,
    [UID of Contact Person-14] NVARCHAR(255) NULL,
    [Email Id Contact Person-14] NVARCHAR(255) NULL,
    [Name of Contact Person-15] NVARCHAR(255) NULL,
    [Designation of Contact Person-15] NVARCHAR(255) NULL,
    [PAN of Contact Person-15] NVARCHAR(255) NULL,
    [Address of Contact Person-15] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-15] NVARCHAR(255) NULL,
    [DIN of Contact Person-15] NVARCHAR(255) NULL,
    [UID of Contact Person-15] NVARCHAR(255) NULL,
    [Email Id Contact Person-15] NVARCHAR(255) NULL,
    [Name of Contact Person-16] NVARCHAR(255) NULL,
    [Designation of Contact Person-16] NVARCHAR(255) NULL,
    [PAN of Contact Person-16] NVARCHAR(255) NULL,
    [Address of Contact Person-16] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-16] NVARCHAR(255) NULL,
    [DIN of Contact Person-16] NVARCHAR(255) NULL,
    [UID of Contact Person-16] NVARCHAR(255) NULL,
    [Email Id Contact Person-16] NVARCHAR(255) NULL,
    [Name of Contact Person-17] NVARCHAR(255) NULL,
    [Designation of Contact Person-17] NVARCHAR(255) NULL,
    [PAN of Contact Person-17] NVARCHAR(255) NULL,
    [Address of Contact Person-17] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-17] NVARCHAR(255) NULL,
    [DIN of Contact Person-17] NVARCHAR(255) NULL,
    [UID of Contact Person-17] NVARCHAR(255) NULL,
    [Email Id Contact Person-17] NVARCHAR(255) NULL,
    [Name of Contact Person-18] NVARCHAR(255) NULL,
    [Designation of Contact Person-18] NVARCHAR(255) NULL,
    [PAN of Contact Person-18] NVARCHAR(255) NULL,
    [Address of Contact Person-18] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-18] NVARCHAR(255) NULL,
    [DIN of Contact Person-18] NVARCHAR(255) NULL,
    [UID of Contact Person-18] NVARCHAR(255) NULL,
    [Email Id Contact Person-18] NVARCHAR(255) NULL,
    [Name of Contact Person-19] NVARCHAR(255) NULL,
    [Designation of Contact Person-19] NVARCHAR(255) NULL,
    [PAN of Contact Person-19] NVARCHAR(255) NULL,
    [Address of Contact Person-19] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-19] NVARCHAR(255) NULL,
    [DIN of Contact Person-19] NVARCHAR(255) NULL,
    [UID of Contact Person-19] NVARCHAR(255) NULL,
    [Email Id Contact Person-19] NVARCHAR(255) NULL,
    [Name of Contact Person-20] NVARCHAR(255) NULL,
    [Designation of Contact Person-20] NVARCHAR(255) NULL,
    [PAN of Contact Person-20] NVARCHAR(255) NULL,
    [Address of Contact Person-20] NVARCHAR(255) NULL,
    [Contact Details of Contact Person-20] NVARCHAR(255) NULL,
    [DIN of Contact Person-20] NVARCHAR(255) NULL,
    [UID of Contact Person-20] NVARCHAR(255) NULL,
    [Email Id Contact Person-20] NVARCHAR(255) NULL,
    [Created Date Time] DATETIME NULL,
    [Last Modified Date Time] DATETIME NULL,
    [F238] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multicltid
-- --------------------------------------------------
CREATE TABLE [dbo].[Multicltid]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Cltdpno] VARCHAR(16) NOT NULL,
    [Dpid] VARCHAR(16) NOT NULL,
    [Introducer] VARCHAR(100) NULL,
    [Dptype] VARCHAR(4) NULL,
    [Def] INT NULL,
    [DDPIFLAG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MultiCltLog
-- --------------------------------------------------
CREATE TABLE [dbo].[MultiCltLog]
(
    [Party_Code] VARCHAR(10) NULL,
    [OCltDpId] VARCHAR(16) NULL,
    [ODpId] VARCHAR(8) NULL,
    [OPOA] INT NULL,
    [NCltDpID] VARCHAR(16) NULL,
    [NDpId] VARCHAR(8) NULL,
    [NPOA] INT NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedDate] DATETIME NULL,
    [RecordFrom] VARCHAR(20) NULL,
    [DDPIFLAG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIISIN
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIISIN]
(
    [Scrip_cd] VARCHAR(12) NULL,
    [Series] CHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Valid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NONLEIPS_SCRIPTS
-- --------------------------------------------------
CREATE TABLE [dbo].[NONLEIPS_SCRIPTS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UL_ASSET_CODE] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.offer_pcnorderDetails_FO_RTB
-- --------------------------------------------------
CREATE TABLE [dbo].[offer_pcnorderDetails_FO_RTB]
(
    [party_code] VARCHAR(20) NULL,
    [segment] VARCHAR(20) NULL,
    [order_No] VARCHAR(100) NULL,
    [order_time] VARCHAR(30) NULL,
    [trade_time] VARCHAR(30) NULL,
    [buysell] VARCHAR(20) NULL,
    [qty] INT NULL,
    [trade_no] VARCHAR(50) NULL,
    [security_name] VARCHAR(200) NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Expirydate] DATE NULL,
    [Strike_price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Userid] INT NULL,
    [trade_date] DATETIME NULL,
    [sett_no] VARCHAR(30) NULL,
    [contract_no] VARCHAR(50) NULL,
    [brokerage] MONEY NULL,
    [net_rate_per_unit] MONEY NULL,
    [net_total_before_levies] MONEY NULL,
    [market_rate] FLOAT NULL,
    [cl_rate] FLOAT NULL,
    [Trade_type] VARCHAR(15) NULL,
    [CTCLID] VARCHAR(20) NULL,
    [memID] VARCHAR(20) NULL,
    [ContractNo] VARCHAR(30) NULL,
    [ContractNo_seg] VARCHAR(30) NULL,
    [Stampduty] NUMERIC(18, 4) NULL,
    [service_tax] NUMERIC(18, 4) NULL,
    [turn_tax] NUMERIC(18, 4) NULL,
    [stt] NUMERIC(18, 4) NULL,
    [sebifee] NUMERIC(18, 4) NULL,
    [series] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(20) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [LOT_SIZE] INT NULL,
    [Table_No] VARCHAR(5) NULL,
    [Line_No] INT NULL,
    [Val_perc] CHAR(2) NULL,
    [leg_Type] VARCHAR(8) NULL,
    [Day_puc] NUMERIC(18, 4) NULL,
    [Day_Sales] NUMERIC(18, 4) NULL,
    [Sett_Purch] NUMERIC(18, 4) NULL,
    [sett_sales] NUMERIC(18, 4) NULL,
    [NORMAL] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NULL,
    [NUMERATOR] NUMERIC(18, 4) NULL,
    [DENOMINATOR] NUMERIC(18, 4) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [OFFER_DISCOUNT_BROKERAGE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFER_PRORDERWISEDETAILS_FO_RTB
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFER_PRORDERWISEDETAILS_FO_RTB]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Contract_No] VARCHAR(14) NOT NULL,
    [Trade_No] VARCHAR(15) NOT NULL,
    [Order_No] VARCHAR(20) NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [Strike_Price] MONEY NOT NULL,
    [MarketLot] INT NOT NULL,
    [Scheme_Id] INT NOT NULL,
    [ComputationLevel] CHAR(1) NOT NULL,
    [ComputationOn] CHAR(1) NOT NULL,
    [ComputationType] CHAR(1) NOT NULL,
    [BuyRate] MONEY NOT NULL,
    [SellRate] MONEY NOT NULL,
    [Tot_BuyQty] INT NOT NULL,
    [Tot_SellQty] INT NOT NULL,
    [Tot_BuyTurnOver] MONEY NOT NULL,
    [Tot_SellTurnOver] MONEY NOT NULL,
    [Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [Tot_TurnOver] MONEY NOT NULL,
    [Tot_TurnOver_Rounded] MONEY NOT NULL,
    [Tot_Lot] INT NOT NULL,
    [Tot_Res_TurnOver] MONEY NOT NULL,
    [Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [Tot_Res_Lot] INT NOT NULL,
    [Tot_BuyBrok] MONEY NOT NULL,
    [Tot_SellBrok] MONEY NOT NULL,
    [Tot_Brok] MONEY NOT NULL,
    [Tot_BuySerTax] MONEY NOT NULL,
    [Tot_SellSerTax] MONEY NOT NULL,
    [Tot_SerTax] MONEY NOT NULL,
    [Tot_Stt] MONEY NOT NULL,
    [Tot_Turn_Tax] MONEY NOT NULL,
    [Exch_BuyRate] MONEY NOT NULL,
    [Exch_SellRate] MONEY NOT NULL,
    [TimeStamp] DATETIME NOT NULL,
    [TOT_OTHER_CHRG] NUMERIC(36, 12) NULL,
    [OFFER_DISCOUNT_BROKERAGE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.orderwisedetail_rtb
-- --------------------------------------------------
CREATE TABLE [dbo].[orderwisedetail_rtb]
(
    [CD_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CD_PARTY_CODE] VARCHAR(10) NULL,
    [CD_SAUDA_DATE] DATETIME NOT NULL,
    [CD_CONTRACT_NO] VARCHAR(14) NULL,
    [CD_TRADE_NO] VARCHAR(15) NULL,
    [CD_ORDER_NO] VARCHAR(20) NULL,
    [CD_PRODUCT_TYPE] VARCHAR(3) NULL,
    [CD_PRODUCT_CODE] VARCHAR(7) NULL,
    [CD_ASSET_CODE] VARCHAR(8) NULL,
    [CD_EXPIRYDATE] DATETIME NULL,
    [CD_STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [CD_OPTION_TYPE] VARCHAR(2) NULL,
    [CD_SERIES_CODE] VARCHAR(22) NULL,
    [CD_SERIES_ID] NUMERIC(9, 0) NULL,
    [CD_LOT_SIZE] NUMERIC(9, 0) NULL,
    [CD_AUCTIONPART] VARCHAR(2) NULL,
    [CD_MARKETLOT] INT NOT NULL,
    [CD_SCHEME_ID] INT NOT NULL,
    [CD_COMPUTATIONLEVEL] CHAR(1) NULL,
    [CD_COMPUTATIONON] CHAR(1) NULL,
    [CD_COMPUTATIONTYPE] CHAR(1) NULL,
    [CD_BUYRATE] NUMERIC(36, 12) NOT NULL,
    [CD_SELLRATE] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYQTY] INT NOT NULL,
    [CD_TOT_SELLQTY] INT NOT NULL,
    [CD_TOT_BUYTURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLTURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYTURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLTURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_LOT] INT NOT NULL,
    [CD_TOT_RES_TURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_RES_TURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_RES_LOT] INT NOT NULL,
    [CD_TOT_BUYBROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLBROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYSERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLSERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_STT] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_STAMPDUTY] NUMERIC(36, 12) NOT NULL,
    [CD_EXCH_BUYRATE] NUMERIC(36, 12) NOT NULL,
    [CD_EXCH_SELLRATE] NUMERIC(36, 12) NOT NULL,
    [CD_TIMESTAMP] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PartyMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[PartyMapping]
(
    [OldParty_Code] VARCHAR(12) NULL,
    [NewParty_code] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.paymentmode
-- --------------------------------------------------
CREATE TABLE [dbo].[paymentmode]
(
    [paycode] VARCHAR(2) NULL,
    [paycodename] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pcnTradeSummary_FO_RTB
-- --------------------------------------------------
CREATE TABLE [dbo].[pcnTradeSummary_FO_RTB]
(
    [Party_Code] VARCHAR(10) NULL,
    [BillNo] INT NULL,
    [ContractNo] VARCHAR(10) NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [expirydate] SMALLDATETIME NULL,
    [Option_type] VARCHAR(2) NULL,
    [Strike_Price] MONEY NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MaturityDate] SMALLDATETIME NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [IsIn] VARCHAR(12) NULL,
    [PQty] INT NULL,
    [SQty] INT NULL,
    [PRate] MONEY NULL,
    [SRate] MONEY NULL,
    [PAmt] MONEY NULL,
    [SAmt] MONEY NULL,
    [PBrokAmt] MONEY NULL,
    [SBrokAmt] MONEY NULL,
    [PBillAmt] MONEY NULL,
    [SBillAmt] MONEY NULL,
    [Cl_Rate] MONEY NULL,
    [Cl_Chrg] MONEY NULL,
    [ExCl_Chrg] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [ExSer_Tax] MONEY NULL,
    [InExSerFlag] SMALLINT NULL,
    [sebi_tax] MONEY NULL,
    [turn_tax] MONEY NULL,
    [Broker_note] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [TradeType] VARCHAR(3) NULL,
    [ParticiPantCode] VARCHAR(15) NULL,
    [Terminal_Id] VARCHAR(15) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [StatusName] VARCHAR(15) NULL,
    [Exchange] VARCHAR(5) NULL,
    [Segment] VARCHAR(10) NULL,
    [MemberType] VARCHAR(2) NULL,
    [Dummy5] MONEY NULL,
    [CMCLOSING] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Pobank
-- --------------------------------------------------
CREATE TABLE [dbo].[Pobank]
(
    [Bankid] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Bank_Name] VARCHAR(50) NOT NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Nation] VARCHAR(25) NULL,
    [Zip] VARCHAR(15) NULL,
    [Phone1] VARCHAR(15) NULL,
    [Phone2] VARCHAR(15) NULL,
    [Fax] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL,
    [MICRNO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Pobank_BKP
-- --------------------------------------------------
CREATE TABLE [dbo].[Pobank_BKP]
(
    [Bankid] NUMERIC(18, 0) NULL,
    [Bank_Name] VARCHAR(50) NOT NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Nation] VARCHAR(25) NULL,
    [Zip] VARCHAR(15) NULL,
    [Phone1] VARCHAR(15) NULL,
    [Phone2] VARCHAR(15) NULL,
    [Fax] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL,
    [MICRNO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rating
-- --------------------------------------------------
CREATE TABLE [dbo].[Rating]
(
    [Rating] VARCHAR(10) NULL,
    [Description] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Region
-- --------------------------------------------------
CREATE TABLE [dbo].[Region]
(
    [Regioncode] VARCHAR(20) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.REUTERS_CALENDER
-- --------------------------------------------------
CREATE TABLE [dbo].[REUTERS_CALENDER]
(
    [Mnth] VARCHAR(3) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [RC_Code] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.roundparam
-- --------------------------------------------------
CREATE TABLE [dbo].[roundparam]
(
    [RoundStyle] SMALLINT NULL,
    [Description] CHAR(25) NULL,
    [Round_to] SMALLINT NULL,
    [RoFig] SMALLINT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] SMALLINT NULL,
    [RoundMarketrate] TINYINT NULL,
    [RoundBrokerage] TINYINT NULL,
    [RoundNetrate] TINYINT NULL,
    [OtherRound] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sbu_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Sbu_Master]
(
    [Sbu_Code] VARCHAR(10) NOT NULL,
    [Sbu_Name] VARCHAR(50) NOT NULL,
    [Sbu_Addr1] VARCHAR(40) NOT NULL,
    [Sbu_Addr2] VARCHAR(40) NULL,
    [Sbu_Addr3] VARCHAR(40) NULL,
    [Sbu_City] VARCHAR(20) NULL,
    [Sbu_State] VARCHAR(20) NULL,
    [Sbu_Zip] VARCHAR(10) NULL,
    [Sbu_Phone1] VARCHAR(15) NULL,
    [Sbu_Phone2] VARCHAR(15) NULL,
    [Sbu_Type] VARCHAR(10) NOT NULL,
    [Sbu_Party_Code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[Scheme_Mapping]
(
    [SP_SrNo] INT IDENTITY(1,1) NOT NULL,
    [SP_Party_Code] VARCHAR(10) NULL,
    [SP_Computation_Level] CHAR(1) NULL,
    [SP_Product_Type] VARCHAR(3) NULL,
    [SP_Product_Code] VARCHAR(10) NULL,
    [SP_Scheme_Id] INT NOT NULL,
    [SP_Trd_Type] VARCHAR(3) NULL,
    [SP_Scheme_Type] CHAR(1) NULL,
    [SP_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Buy_Brok_Type] CHAR(1) NULL,
    [SP_Sell_Brok_Type] CHAR(1) NULL,
    [SP_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Sell_Brok] NUMERIC(18, 4) NULL,
    [SP_Value_From] NUMERIC(18, 4) NOT NULL,
    [SP_Value_To] NUMERIC(18, 4) NOT NULL,
    [SP_Brok_ComputeOn] CHAR(1) NULL,
    [SP_Brok_ComputeType] CHAR(1) NULL,
    [SP_Min_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Min_ScripAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_ScripAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Date_From] DATETIME NOT NULL,
    [SP_Date_To] DATETIME NOT NULL,
    [SP_CreatedBy] VARCHAR(20) NULL,
    [SP_CreatedOn] DATETIME NOT NULL,
    [SP_ModifiedBy] VARCHAR(20) NULL,
    [SP_ModifiedOn] DATETIME NOT NULL,
    [SP_TurnOverOn] VARCHAR(7) NULL,
    [Sp_Scrip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scheme_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Scheme_Master]
(
    [SM_SrNo] INT IDENTITY(1,1) NOT NULL,
    [SM_Scheme_Id] INT NOT NULL,
    [SM_Scheme_Desc] VARCHAR(60) NULL,
    [SM_Trd_Type] VARCHAR(3) NULL,
    [SM_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SM_Buy_Brok_Type] CHAR(1) NULL,
    [SM_Sell_Brok_Type] CHAR(10) NULL,
    [SM_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Value_From] NUMERIC(18, 4) NOT NULL,
    [SM_Value_To] NUMERIC(18, 4) NOT NULL,
    [SM_TurnOverOn] VARCHAR(7) NULL,
    [SM_ComputationOn] CHAR(1) NULL,
    [SM_ComputationType] CHAR(1) NULL,
    [SM_CreatedBy] VARCHAR(20) NULL,
    [SM_CreatedOn] DATETIME NOT NULL,
    [SM_ModifiedBy] VARCHAR(20) NULL,
    [SM_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Schemes
-- --------------------------------------------------
CREATE TABLE [dbo].[Schemes]
(
    [schemeID] TINYINT NULL,
    [Desc] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCRIP_CODES
-- --------------------------------------------------
CREATE TABLE [dbo].[SCRIP_CODES]
(
    [SYMBOL] VARCHAR(15) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [RICBASIC] VARCHAR(15) NOT NULL,
    [BLOOMBERG] VARCHAR(15) NOT NULL,
    [SEDOL] VARCHAR(15) NOT NULL,
    [CUSIP] VARCHAR(15) NOT NULL,
    [SCRIP_NAME] VARCHAR(100) NOT NULL,
    [BSECODE] VARCHAR(50) NOT NULL,
    [MERRYLCODE] VARCHAR(15) NULL,
    [MDSCODE] VARCHAR(25) NULL,
    [IDBI_SCRIP] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scrip_imp
-- --------------------------------------------------
CREATE TABLE [dbo].[Scrip_imp]
(
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [SCRIP_NAME] VARCHAR(50) NULL,
    [FILLER1] VARCHAR(12) NULL,
    [ISIN] VARCHAR(12) NULL,
    [Sno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scrip1
-- --------------------------------------------------
CREATE TABLE [dbo].[Scrip1]
(
    [Co_Code] VARCHAR(6) NOT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Short_Name] VARCHAR(50) NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Market_Lot] INT NULL,
    [Face_Val] FLOAT NULL,
    [Book_Cl_Dt] DATETIME NULL,
    [Ex_Div_Dt] DATETIME NULL,
    [Ex_Bon_Dt] DATETIME NULL,
    [Ex_Rit_Dt] DATETIME NULL,
    [Eqt_Type] VARCHAR(3) NULL,
    [Sub_Type] VARCHAR(3) NULL,
    [Agent_Cd] VARCHAR(6) NULL,
    [Demat_Flag] SMALLINT NULL,
    [Demat_Date] DATETIME NOT NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scrip2
-- --------------------------------------------------
CREATE TABLE [dbo].[Scrip2]
(
    [Co_Code] VARCHAR(6) NOT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Scrip_Cat] VARCHAR(3) NULL,
    [No_Del_Fr] DATETIME NULL,
    [No_Del_To] DATETIME NULL,
    [Cl_Rate] FLOAT NULL,
    [Clos_Rate_Dt] DATETIME NULL,
    [Min_Trd_Qty] INT NULL,
    [Bsecode] VARCHAR(10) NULL,
    [Isin] VARCHAR(20) NULL,
    [Delsc_Cat] VARCHAR(3) NULL,
    [Sector] VARCHAR(10) NULL,
    [Track] VARCHAR(10) NULL,
    [Cdol_No] VARCHAR(10) NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL,
    [Globalcustodian] VARCHAR(10) NULL,
    [common_code] CHAR(10) NULL,
    [IndexName] VARCHAR(10) NULL,
    [Industry] VARCHAR(10) NULL,
    [Bloomberg] VARCHAR(10) NULL,
    [RicCode] VARCHAR(10) NULL,
    [Reuters] VARCHAR(10) NULL,
    [IES] VARCHAR(10) NULL,
    [NoofIssuedshares] NUMERIC(18, 4) NULL,
    [Status] VARCHAR(10) NULL,
    [ADRGDRRatio] NUMERIC(18, 4) NULL,
    [GEMultiple] NUMERIC(18, 4) NULL,
    [GroupforGE] INT NULL,
    [RBICeilingIndicatorFlag] VARCHAR(2) NULL,
    [RBICeilingIndicatorValue] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SPANMARGIN_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[SPANMARGIN_IMP]
(
    [NODE] VARCHAR(20) NULL,
    [INTRADATE] VARCHAR(20) NULL,
    [ISSETL] VARCHAR(20) NULL,
    [QUAL] VARCHAR(20) NULL,
    [INTRATIME] VARCHAR(20) NULL,
    [RUN] VARCHAR(20) NULL,
    [FIRM] VARCHAR(20) NULL,
    [ACCT] VARCHAR(20) NULL,
    [SEG] VARCHAR(20) NULL,
    [INTRATYPE] VARCHAR(20) NULL,
    [ISCUST] VARCHAR(20) NULL,
    [EC] VARCHAR(20) NULL,
    [CC] VARCHAR(20) NULL,
    [INTRACURRENCY] VARCHAR(20) NULL,
    [LFV] VARCHAR(20) NULL,
    [SFV] VARCHAR(20) NULL,
    [LOV] VARCHAR(20) NULL,
    [SOV] VARCHAR(20) NULL,
    [ISM] VARCHAR(20) NULL,
    [PBC] VARCHAR(20) NULL,
    [SPANREQ] VARCHAR(20) NULL,
    [ANOV] VARCHAR(20) NULL,
    [SR] VARCHAR(20) NULL,
    [IA] VARCHAR(20) NULL,
    [DR] VARCHAR(20) NULL,
    [IE] VARCHAR(20) NULL,
    [IEX] VARCHAR(20) NULL,
    [SOM] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Spanmargin_Intraday
-- --------------------------------------------------
CREATE TABLE [dbo].[Spanmargin_Intraday]
(
    [Node] VARCHAR(10) NOT NULL,
    [Intradate] SMALLDATETIME NOT NULL,
    [Issetl] INT NOT NULL,
    [Qual] VARCHAR(7) NOT NULL,
    [Intratime] VARCHAR(7) NULL,
    [Run] VARCHAR(7) NULL,
    [Firm] VARCHAR(7) NOT NULL,
    [Acct] VARCHAR(10) NOT NULL,
    [Seg] VARCHAR(4) NULL,
    [Intratype] VARCHAR(7) NULL,
    [Iscust] VARCHAR(7) NULL,
    [Ec] VARCHAR(10) NULL,
    [Cc] VARCHAR(10) NULL,
    [Intracurrency] VARCHAR(7) NULL,
    [Lfv] FLOAT NULL,
    [Sfv] FLOAT NULL,
    [Lov] FLOAT NULL,
    [Sov] FLOAT NULL,
    [Ism] FLOAT NULL,
    [Pbc] VARCHAR(7) NULL,
    [Spanreq] FLOAT NULL,
    [Anov] FLOAT NULL,
    [Sr] FLOAT NULL,
    [Ia] FLOAT NULL,
    [Dr] FLOAT NULL,
    [Ie] FLOAT NULL,
    [Iex] FLOAT NULL,
    [Som] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.State_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[State_Master]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [State] VARCHAR(50) NOT NULL,
    [TrdStampDuty] DECIMAL(18, 4) NOT NULL,
    [DelStampDuty] DECIMAL(18, 4) NOT NULL,
    [ProStampDuty] DECIMAL(18, 4) NOT NULL,
    [Min_Multiplier] DECIMAL(18, 4) NULL,
    [For_Turnover] DECIMAL(18, 4) NULL,
    [Maximum_Limit] DECIMAL(18, 4) NULL,
    [Year_Start_Date] DATETIME NULL,
    [Year_End_Date] DATETIME NULL,
    [FutBuyStampDuty] DECIMAL(18, 6) NULL,
    [FutSellStampDuty] DECIMAL(18, 6) NULL,
    [OptBuyStampDuty] DECIMAL(18, 6) NULL,
    [OptSellStampDuty] DECIMAL(18, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STRU_INST_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[STRU_INST_LOG]
(
    [Party_Code] VARCHAR(10) NULL,
    [New_Party_Code] VARCHAR(10) NULL,
    [Sauda_Date] DATETIME NULL,
    [Procuct_Code] VARCHAR(6) NULL,
    [Series_Code] VARCHAR(12) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Product_Type] VARCHAR(2) NULL,
    [Order_No] VARCHAR(20) NULL,
    [Trade_No] VARCHAR(20) NULL,
    [Sell_Buy] VARCHAR(1) NULL,
    [Contract_No] VARCHAR(20) NULL,
    [New_Contract_No] VARCHAR(20) NULL,
    [Brokerage] NUMERIC(18, 4) NULL,
    [New_Brokerage] NUMERIC(18, 4) NULL,
    [Market_Rate] NUMERIC(18, 4) NULL,
    [New_Market_Rate] NUMERIC(18, 4) NULL,
    [Net_Rate] NUMERIC(18, 4) NULL,
    [New_net_rate] NUMERIC(18, 4) NULL,
    [Qty] BIGINT NULL,
    [New_Qty] BIGINT NULL,
    [RoundTo] INT NULL,
    [Participant_Code] VARCHAR(20) NULL,
    [New_Participant_Code] VARCHAR(20) NULL,
    [UserName] VARCHAR(25) NULL,
    [Module] VARCHAR(50) NULL,
    [Called_From] VARCHAR(100) NULL,
    [TimeStamp] DATETIME NULL,
    [ExtraField3] VARCHAR(10) NULL,
    [ExtraField4] VARCHAR(1) NULL,
    [ExtraField5] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Stt_Clientdetail
-- --------------------------------------------------
CREATE TABLE [dbo].[Stt_Clientdetail]
(
    [Rectype] INT NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Contractno] VARCHAR(7) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(15) NULL,
    [Series_code] VARCHAR(50) NULL,
    [Series_id] INT NULL,
    [Expirydate] DATETIME NOT NULL,
    [Trdprice] MONEY NULL,
    [Pqtytrd] INT NULL,
    [Pamttrd] MONEY NULL,
    [Pstttrd] MONEY NULL,
    [Sqtytrd] INT NULL,
    [Samttrd] MONEY NULL,
    [Sstttrd] MONEY NULL,
    [Totalstt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Stt_Clientdetail_BKUP_10Aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[Stt_Clientdetail_BKUP_10Aug2023]
(
    [Rectype] INT NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Contractno] VARCHAR(7) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NULL,
    [Series_id] INT NULL,
    [Expirydate] DATETIME NOT NULL,
    [Trdprice] MONEY NULL,
    [Pqtytrd] INT NULL,
    [Pamttrd] MONEY NULL,
    [Pstttrd] MONEY NULL,
    [Sqtytrd] INT NULL,
    [Samttrd] MONEY NULL,
    [Sstttrd] MONEY NULL,
    [Totalstt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STT_CLIENTDETAIL_RTB
-- --------------------------------------------------
CREATE TABLE [dbo].[STT_CLIENTDETAIL_RTB]
(
    [RecType] INT NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [ContractNo] VARCHAR(7) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Option_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expirydate] DATETIME NOT NULL,
    [Strike_price] MONEY NULL,
    [TrdPrice] MONEY NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PSTTTrd] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SSTTTrd] MONEY NULL,
    [TotalSTT] MONEY NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(15) NULL,
    [Series_code] VARCHAR(50) NULL,
    [Series_id] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STT_EXCHG
-- --------------------------------------------------
CREATE TABLE [dbo].[STT_EXCHG]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [STT_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(9, 0) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [TOT_TURNOVER] NUMERIC(18, 4) NULL,
    [TOT_STT] NUMERIC(18, 4) NULL,
    [SERIES_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subbrokers
-- --------------------------------------------------
CREATE TABLE [dbo].[subbrokers]
(
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Name] VARCHAR(50) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [branch_code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sursh
-- --------------------------------------------------
CREATE TABLE [dbo].[sursh]
(
    [TRADE_DATE] DATETIME NULL,
    [SESSION_ID] NUMERIC(10, 0) NULL,
    [SERIES_ID] NUMERIC(10, 0) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(11, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [PRV_CLOSE_PRICE] NUMERIC(20, 4) NULL,
    [OPEN_PRICE] NUMERIC(20, 4) NULL,
    [HIGH_PRICE] NUMERIC(20, 4) NULL,
    [LOW_PRICE] NUMERIC(20, 4) NULL,
    [CLOSE_PRICE] NUMERIC(20, 4) NULL,
    [TOTAL_TRADED_QTY] NUMERIC(12, 0) NULL,
    [TOTAL_TRADED_VALUE] NUMERIC(20, 4) NULL,
    [AVRG_TRADED_PRICE] NUMERIC(20, 4) NULL,
    [NO_OF_TRADES] NUMERIC(12, 0) NULL,
    [WEEK_HIGH] NUMERIC(20, 4) NULL,
    [WEEK_LOW] NUMERIC(20, 4) NULL,
    [OPEN_INTEREST] NUMERIC(12, 0) NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ADDITIONAL_TAX_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ADDITIONAL_TAX_DATA]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [CONTRACTNO] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [INST_TYPE] VARCHAR(12) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [PRICE] NUMERIC(18, 4) NULL,
    [TRADEQTY] INT NULL,
    [AMOUNT] NUMERIC(18, 4) NULL,
    [SELL_BUY] INT NULL,
    [TRDTYPE] CHAR(1) NULL,
    [IPFT_CHRG] NUMERIC(18, 4) NULL,
    [ADD_CHRG_1] NUMERIC(18, 4) NULL,
    [ADD_CHRG_2] NUMERIC(18, 4) NULL,
    [ADD_CHRG_3] NUMERIC(18, 4) NULL,
    [ADD_CHRG_4] NUMERIC(18, 4) NULL,
    [ADD_CHRG_5] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLIENT_GST_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLIENT_GST_DATA]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(250) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(100) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [L_NATION] VARCHAR(15) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(100) NULL,
    [EFF_FROM_DATE] DATETIME NOT NULL,
    [EFF_TO_DATE] DATETIME NOT NULL,
    [CREATED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_clientmargin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_clientmargin]
(
    [Party_Code] VARCHAR(15) NOT NULL,
    [Margindate] DATETIME NOT NULL,
    [Billamount] MONEY NOT NULL,
    [Ledgeramount] MONEY NOT NULL,
    [Cash_Coll] MONEY NOT NULL,
    [Noncash_Coll] MONEY NOT NULL,
    [Initialmargin] MONEY NOT NULL,
    [Lst_Update_Dt] DATETIME NOT NULL,
    [Short_Name] VARCHAR(100) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Family] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [Trader] VARCHAR(20) NULL,
    [Mtmmargin] MONEY NULL,
    [AddMargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_COLLATERAL_MARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_COLLATERAL_MARGIN]
(
    [EFFDATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [CASH] MONEY NULL,
    [NONCASH] MONEY NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [ISIN] VARCHAR(20) NULL,
    [CL_RATE] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [QTY] NUMERIC(18, 4) NULL,
    [HAIRCUT] MONEY NULL,
    [FINALAMOUNT] MONEY NULL,
    [PERCENTAGECASH] NUMERIC(18, 2) NULL,
    [PERECNTAGENONCASH] NUMERIC(18, 2) NULL,
    [COLL_TYPE] VARCHAR(6) NULL,
    [CASH_NCASH] VARCHAR(2) NULL,
    [FD_BG_NO] VARCHAR(20) NULL,
    [BANK_CODE] VARCHAR(15) NULL,
    [FD_TYPE] VARCHAR(1) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CONTRACT_TERMINAL_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CONTRACT_TERMINAL_MAPPING]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [TERMINAL_ID] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [REMARK_ID] CHAR(1) NULL,
    [REMARK_DESC] VARCHAR(200) NULL,
    [FROM_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL,
    [INSERTEDON] DATETIME NULL,
    [INSERTEDBY] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ECNBOUNCED
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ECNBOUNCED]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FOSCRIPMAP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FOSCRIPMAP]
(
    [N_INST_TYPE] VARCHAR(6) NOT NULL,
    [N_SYMBOL] VARCHAR(12) NOT NULL,
    [N_EXPIRYDATE] SMALLDATETIME NOT NULL,
    [N_STRIKE_PRICE] MONEY NOT NULL,
    [N_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [B_INST_TYPE] VARCHAR(7) NULL,
    [B_SYMBOL] VARCHAR(50) NULL,
    [B_EXPIRYDATE] SMALLDATETIME NOT NULL,
    [B_STRIKE_PRICE] MONEY NOT NULL,
    [B_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [M_INST_TYPE] VARCHAR(6) NOT NULL,
    [M_SYMBOL] VARCHAR(12) NOT NULL,
    [M_EXPIRYDATE] SMALLDATETIME NOT NULL,
    [M_STRIKE_PRICE] MONEY NOT NULL,
    [M_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [INST_TYPE] VARCHAR(7) NULL,
    [SYMBOL] VARCHAR(30) NULL,
    [EXPIRYDATE] SMALLDATETIME NOT NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NOT NULL,
    [EFF_FROM] DATETIME NOT NULL,
    [EFF_TO] DATETIME NOT NULL,
    [UPLOAD_ON] DATETIME NOT NULL,
    [UPLOAD_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FOSCRIPMAP_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FOSCRIPMAP_TMP]
(
    [N_INST_TYPE] VARCHAR(6) NOT NULL,
    [N_SYMBOL] VARCHAR(12) NOT NULL,
    [N_EXPIRYDATE] VARCHAR(12) NOT NULL,
    [N_STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [N_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [B_INST_TYPE] VARCHAR(6) NOT NULL,
    [B_SYMBOL] VARCHAR(12) NOT NULL,
    [B_EXPIRYDATE] VARCHAR(12) NOT NULL,
    [B_STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [B_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [M_INST_TYPE] VARCHAR(6) NOT NULL,
    [M_SYMBOL] VARCHAR(12) NOT NULL,
    [M_EXPIRYDATE] VARCHAR(12) NOT NULL,
    [M_STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [M_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [INST_TYPE] VARCHAR(6) NOT NULL,
    [SYMBOL] VARCHAR(12) NOT NULL,
    [EXPIRYDATE] VARCHAR(12) NOT NULL,
    [STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_GST_LOCATION
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_GST_LOCATION]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [LOC_CODE] VARCHAR(20) NULL,
    [LOCATION] VARCHAR(80) NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [ADDRESS1] VARCHAR(100) NULL,
    [ADDRESS2] VARCHAR(100) NULL,
    [CITY] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [NATION] VARCHAR(50) NULL,
    [ZIP] VARCHAR(30) NULL,
    [PHONE1] VARCHAR(30) NULL,
    [PHONE2] VARCHAR(30) NULL,
    [FAX] VARCHAR(30) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [GST_NO] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INTEROP_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INTEROP_SETTING]
(
    [CLEARINGCODE] VARCHAR(10) NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL,
    [BROK_SQ_OFF] INT NULL,
    [STAMP_SQ_OFF] INT NULL,
    [MERGE_DELIVERY] INT NULL,
    [MERGE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTOMPREMIUMBILL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTOMPREMIUMBILL]
(
    [BILLDATE] DATETIME NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [NETRATE] NUMERIC(18, 5) NULL,
    [CL_RATE] NUMERIC(18, 5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PRODUCT_TYPE] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(7) NULL,
    [ASSET_CODE] VARCHAR(8) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(12, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SERIES_CODE] VARCHAR(22) NULL,
    [SERIES_ID] NUMERIC(9, 0) NULL,
    [LOT_SIZE] NUMERIC(9, 0) NULL,
    [SDATE] DATETIME NULL,
    [SELL_BUY] INT NULL,
    [SERVICE_TAX] NUMERIC(18, 5) NULL,
    [BROK] NUMERIC(18, 5) NULL,
    [NONEXPIRYSERVICE_TAX] NUMERIC(18, 5) NULL,
    [NONEXPIRYBROK] NUMERIC(18, 5) NULL,
    [SEBI_TAX] NUMERIC(18, 5) NULL,
    [TURN_TAX] NUMERIC(18, 5) NULL,
    [STAMPDUTY] NUMERIC(18, 5) NULL,
    [INEX_SERVICE_TAX] NUMERIC(18, 5) NULL,
    [INEX_SEBI_TAX] NUMERIC(18, 5) NULL,
    [INEX_TURN_TAX] NUMERIC(18, 5) NULL,
    [INEX_STAMPDUTY] NUMERIC(18, 5) NULL,
    [EXPIRYBROK] NUMERIC(18, 5) NULL,
    [EXPIRYSERVICE_TAX] NUMERIC(18, 5) NULL,
    [INSURANCE_CHRG] NUMERIC(18, 5) NULL,
    [INEX_INSURANCE_CHRG] NUMERIC(18, 5) NULL,
    [OTHER_CHRG] NUMERIC(18, 5) NULL,
    [INEX_OTHER_CHRG] NUMERIC(18, 5) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [NETWITHBROK] NUMERIC(18, 5) NULL,
    [BFDAYFLAG] VARCHAR(3) NULL,
    [RESERVED1] INT NULL,
    [ACTBUYQTY] INT NULL,
    [ACTSELLQTY] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STAMP_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STAMP_DATA]
(
    [SAUDA_DATE] DATETIME NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [BUYQTY] INT NULL,
    [SELLQTY] INT NULL,
    [BUYAVGRATE] NUMERIC(38, 2) NULL,
    [SELLAVGRATE] NUMERIC(38, 2) NULL,
    [BUYSTAMP] NUMERIC(38, 2) NULL,
    [SELLSTAMP] NUMERIC(38, 2) NULL,
    [TOTALSTAMP] NUMERIC(38, 2) NULL,
    [L_STATE] VARCHAR(100) NULL,
    [LASTRUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STAMP_DATA_RTB
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STAMP_DATA_RTB]
(
    [SAUDA_DATE] DATETIME NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [BUYQTY] INT NULL,
    [SELLQTY] INT NULL,
    [BUYAVGRATE] NUMERIC(38, 2) NULL,
    [SELLAVGRATE] NUMERIC(38, 2) NULL,
    [BUYSTAMP] NUMERIC(38, 2) NULL,
    [SELLSTAMP] NUMERIC(38, 2) NULL,
    [TOTALSTAMP] NUMERIC(38, 2) NULL,
    [L_STATE] VARCHAR(100) NULL,
    [LASTRUNDATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STAMP_TAX
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STAMP_TAX]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [BUYTAX] NUMERIC(18, 6) NULL,
    [SELLTAX] NUMERIC(18, 6) NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STATE_GST_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STATE_GST_DATA]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [STATE_NAME] VARCHAR(50) NULL,
    [STATE_CODE] VARCHAR(10) NULL,
    [TIN_NO] VARCHAR(10) NULL,
    [UTI_FLAG] INT NULL,
    [GST_PER] NUMERIC(18, 4) NULL,
    [CGST_PER] NUMERIC(18, 4) NULL,
    [SGST_PER] NUMERIC(18, 4) NULL,
    [IGST_PER] NUMERIC(18, 4) NULL,
    [UGST_PER] NUMERIC(18, 4) NULL,
    [AGST_PER] NUMERIC(18, 4) NULL,
    [EFF_FROM_DATE] DATETIME NULL,
    [EFF_TO_DATE] DATETIME NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NULL,
    [MODIFY_BY] VARCHAR(50) NULL,
    [MODIFY_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_TURNOVER_SLAB
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_TURNOVER_SLAB]
(
    [INST_TYPE] VARCHAR(3) NULL,
    [TRADE_TYPE] VARCHAR(3) NULL,
    [CHARGE_ON] INT NULL,
    [FROM_TOT] NUMERIC(18, 4) NULL,
    [TO_TOT] NUMERIC(18, 4) NULL,
    [CHARGE_PER] NUMERIC(18, 6) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_TURNOVER_SLAB_SYMBOL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_TURNOVER_SLAB_SYMBOL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [INST_TYPE] VARCHAR(3) NULL,
    [SYMBOL] VARCHAR(20) NULL,
    [TRADE_TYPE] VARCHAR(3) NULL,
    [CHARGE_ON] INT NULL,
    [FROM_TOT] NUMERIC(18, 4) NULL,
    [TO_TOT] NUMERIC(18, 4) NULL,
    [CHARGE_PER] NUMERIC(18, 6) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_TURNOVER_TAX
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_TURNOVER_TAX]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [REC_FOR] VARCHAR(10) NULL,
    [FROM_LIMIT] NUMERIC(18, 4) NULL,
    [TO_LIMIT] NUMERIC(18, 4) NULL,
    [CHARGE_TAX] NUMERIC(18, 4) NULL,
    [EXCLUDE_GRP_TYPE_NO] INT NULL,
    [EXCLUDE_SETT_TYPE_NO] INT NULL,
    [EFF_FROM_DATE] DATETIME NULL,
    [EFF_TO_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbladmin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbladmin]
(
    [fldauto_admin] INT IDENTITY(1,1) NOT NULL,
    [fldname] VARCHAR(30) NOT NULL,
    [fldpassword] VARCHAR(512) NULL,
    [fldcompany] VARCHAR(50) NULL,
    [fldstname] VARCHAR(50) NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [flddesc] VARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMIN_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMIN_LOG]
(
    [Fldauto_Admin] INT NOT NULL,
    [Fldname] VARCHAR(30) NOT NULL,
    [Fldpassword] VARCHAR(512) NULL,
    [Fldcompany] VARCHAR(50) NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Fldstatus] VARCHAR(25) NOT NULL,
    [Flddesc] VARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblAdminconfig
-- --------------------------------------------------
CREATE TABLE [dbo].[TblAdminconfig]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldadmin] VARCHAR(50) NULL,
    [Fldflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMINPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMINPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDADMINID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory]
(
    [fldcategorycode] INT IDENTITY(1,1) NOT NULL,
    [fldcategoryname] VARCHAR(50) NOT NULL,
    [fldadminauto] INT NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATEGORY_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATEGORY_LOG]
(
    [Fldcategorycode] INT NOT NULL,
    [Fldcategoryname] VARCHAR(50) NOT NULL,
    [Fldadminauto] INT NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcatmenu
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcatmenu]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldreportcode] INT NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldcategorycode] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATMENU_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATMENU_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldcategorycode_OLD] VARCHAR(2000) NULL,
    [Fldcategorycode_NEW] VARCHAR(2000) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINE_IP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSADMINLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSADMINLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDADMINNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSUSERLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDUSERNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblglobalparams
-- --------------------------------------------------
CREATE TABLE [dbo].[tblglobalparams]
(
    [FLDPWDMINLENGTH] SMALLINT NULL,
    [FLDPWDMAXLENGTH] SMALLINT NULL,
    [FLDSPCLCHAR] CHAR(1) NULL,
    [FLDENCRYPTION] CHAR(1) NULL,
    [FLDBLOCKPWD] VARCHAR(255) NULL,
    [FLDDELBLOCK] CHAR(1) NULL,
    [fldlastins] BIGINT NULL,
    [fldlastdel] BIGINT NULL,
    [fldlastupdt] BIGINT NULL,
    [fldupdtdate] DATETIME NULL,
    [fldclientMakerCheker] INT NULL,
    [fldAutoCodeGenerate] INT NULL,
    [fldflag] VARCHAR(3) NULL,
    [fldreportflag] VARCHAR(3) NULL,
    [fldCheckClientProcess] VARCHAR(1) NULL,
    [fldBranchAdd] TINYINT NULL,
    [BranchFlag] CHAR(1) NULL,
    [FldPANValidation] VARCHAR(1) NULL,
    [FldPwdAlphaNumOnly] INT NULL,
    [FLDPARTYCODEBy] VARCHAR(10) NULL,
    [FLDOLDPASSWORD] TINYINT NULL,
    [ALLOW_MULTI_LOGIN] INT NULL,
    [MAX_REJECTION_ALLOW] SMALLINT NULL,
    [MAC_ID_VALIDATION] INT NULL,
    [MKCKFLAG] SMALLINT NULL,
    [FldAddRpt] SMALLINT NULL,
    [FldCaptcha] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblmenuhead
-- --------------------------------------------------
CREATE TABLE [dbo].[tblmenuhead]
(
    [fldmenucode] VARCHAR(20) NULL,
    [fldmenuname] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPradnyausers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPradnyausers]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(512) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLPRADNYAUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLPRADNYAUSERS_LOG]
(
    [Fldauto] INT NOT NULL,
    [Fldusername] VARCHAR(25) NULL,
    [Fldpassword] VARCHAR(512) NULL,
    [Fldfirstname] VARCHAR(25) NULL,
    [Fldmiddlename] VARCHAR(25) NULL,
    [Fldlastname] VARCHAR(25) NULL,
    [Fldsex] VARCHAR(8) NULL,
    [Fldaddress1] VARCHAR(100) NULL,
    [Fldaddress2] VARCHAR(100) NULL,
    [Fldphone1] VARCHAR(10) NULL,
    [Fldphone2] VARCHAR(10) NULL,
    [Fldcategory] VARCHAR(10) NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MachineIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreportgrp
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreportgrp]
(
    [fldreportgrp] INT IDENTITY(1,1) NOT NULL,
    [fldgrpname] VARCHAR(35) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTGRP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTGRP_LOG]
(
    [Fldreportgrp] INT NOT NULL,
    [Fldgrpname] VARCHAR(35) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreports
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreports]
(
    [fldreportcode] INT IDENTITY(1,1) NOT NULL,
    [fldreportname] VARCHAR(25) NULL,
    [fldpath] VARCHAR(500) NULL,
    [fldtarget] VARCHAR(25) NULL,
    [flddesc] VARCHAR(80) NULL,
    [fldreportgrp] VARCHAR(10) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [fldstatus] VARCHAR(20) NULL,
    [fldorder] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreports_bkp
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreports_bkp]
(
    [fldreportcode] INT IDENTITY(1,1) NOT NULL,
    [fldreportname] VARCHAR(25) NULL,
    [fldpath] VARCHAR(500) NULL,
    [fldtarget] VARCHAR(25) NULL,
    [flddesc] VARCHAR(80) NULL,
    [fldreportgrp] VARCHAR(10) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [fldstatus] VARCHAR(20) NULL,
    [fldorder] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblReports_Blocked
-- --------------------------------------------------
CREATE TABLE [dbo].[TblReports_Blocked]
(
    [fldusername] VARCHAR(25) NOT NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [Block_Flag] INT NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [fldpath] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTS_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldreportname] VARCHAR(35) NULL,
    [Fldpath] VARCHAR(500) NULL,
    [Fldtarget] VARCHAR(25) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [Fldreportgrp] VARCHAR(10) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Fldstatus] VARCHAR(20) NULL,
    [Fldorder] INT NOT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblsysusers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblsysusers]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERBLOCK
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERBLOCK]
(
    [FLDAUTO] INT NOT NULL,
    [FLDNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlGlobals]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDCATEGORYID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NOT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLD_MAC_ID] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster_Jrnl]
(
    [FLDAUTO] BIGINT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLDUPDTBY] VARCHAR(20) NULL,
    [FLDUPDTDT] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS_LOG]
(
    [FLDAUTO] INT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(20) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TermLimit
-- --------------------------------------------------
CREATE TABLE [dbo].[TermLimit]
(
    [USERID] VARCHAR(50) NULL,
    [TRADELIMIT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TermLimit_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[TermLimit_Log]
(
    [USERID] VARCHAR(50) NULL,
    [TRADELIMIT] MONEY NULL,
    [MODIFIEDBY] VARCHAR(50) NULL,
    [MODIFIEDON] DATETIME NULL,
    [MODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.termparty
-- --------------------------------------------------
CREATE TABLE [dbo].[termparty]
(
    [UserId] NVARCHAR(10) NOT NULL,
    [Party_code] NVARCHAR(10) NOT NULL,
    [ProCli] INT NULL,
    [Exceptparty] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TermParty_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[TermParty_Log]
(
    [Userid] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(15) NULL,
    [Procli] INT NULL,
    [Exceptparty] VARCHAR(15) NULL,
    [Modified_By] VARCHAR(15) NULL,
    [Modified_On] DATETIME NULL,
    [Mode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ucc_Client
-- --------------------------------------------------
CREATE TABLE [dbo].[Ucc_Client]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Client_Name] VARCHAR(100) NOT NULL,
    [Contract_Person] VARCHAR(60) NULL,
    [Clearingno1] VARCHAR(4) NOT NULL,
    [Clearingno2] VARCHAR(4) NULL,
    [Clearingno3] VARCHAR(4) NULL,
    [Clearingno4] VARCHAR(4) NULL,
    [Mapidid] VARCHAR(12) NULL,
    [Fmcode] VARCHAR(10) NULL,
    [Dealing_With_Othrer_Tm] VARCHAR(50) NULL,
    [Any_Other_Acc] VARCHAR(50) NULL,
    [Family_Code1] VARCHAR(10) NULL,
    [Family_Code2] VARCHAR(10) NULL,
    [Family_Code3] VARCHAR(10) NULL,
    [Family_Code4] VARCHAR(10) NULL,
    [Remark] VARCHAR(100) NULL,
    [Ucc_Code] VARCHAR(12) NULL,
    [Stpprovider] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(10) NULL,
    [Dummy2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERDISABLED_LIST
-- --------------------------------------------------
CREATE TABLE [dbo].[USERDISABLED_LIST]
(
    [USERID] BIGINT NULL,
    [USERSTATUS] SMALLINT NULL,
    [MODEFLAG] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_DATA_PDF
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_DATA_PDF]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_TEXT]
(
    [C_SR_NO] DECIMAL(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_BillPrint_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_BillPrint_Setting]
(
    [Rpt_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(300) NULL,
    [Rpt_XPos] NUMERIC(10, 0) NULL,
    [Rpt_YPos] NUMERIC(18, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_BUSINESS_PROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_BUSINESS_PROCESS]
(
    [BUSINESS_DATE] SMALLDATETIME NULL,
    [CONTRACTMASTERIMP] INT NULL,
    [IMPORT_TRADE] INT NULL,
    [VBB] INT NULL,
    [BILLING] INT NULL,
    [CONTRACT] INT NULL,
    [POSTING] INT NULL,
    [POSITIONFILE] INT NULL,
    [CLOSINGRATE] INT NULL,
    [MARGINFILE] INT NULL,
    [MARGINRETURNFILE] INT NULL,
    [OPEN_CLOSE] INT NULL,
    [PROCESSDATE] DATETIME NULL,
    [PROCESSBY] VARCHAR(20) NULL,
    [LASTUPDATEDATE] DATETIME NULL,
    [LASTUPDATEBY] VARCHAR(20) NULL,
    [MACHINEIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Contract_Digital_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Contract_Digital_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Contract_Digital_data_125
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Contract_Digital_data_125]
(
    [C_SR_NO] DECIMAL(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CONTRACT_DIGITAl_DATA_PDF
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CONTRACT_DIGITAl_DATA_PDF]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Contract_Digital_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Contract_Digital_TEXT]
(
    [C_SR_NO] DECIMAL(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_contractprint_setting
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_contractprint_setting]
(
    [Rpt_SrNo] INT NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(50) NULL,
    [Rpt_XPos] NUMERIC(10, 0) NULL,
    [Rpt_YPos] NUMERIC(18, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_contractprint_setting1
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_contractprint_setting1]
(
    [Rpt_SrNo] INT NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(50) NULL,
    [Rpt_XPos] NUMERIC(10, 0) NULL,
    [Rpt_YPos] NUMERIC(18, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Digital_File_Name
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Digital_File_Name]
(
    [SrNo] INT NOT NULL,
    [D_Type] VARCHAR(15) NULL,
    [D_Name] VARCHAR(10) NULL,
    [D_Description] VARCHAR(30) NULL,
    [D_Value] VARCHAR(15) NULL,
    [D_Order] INT NULL,
    [D_Seprater] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INST_PARTYMAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INST_PARTYMAPPING]
(
    [PARTY_CODE] VARCHAR(15) NULL,
    [RPT_REPORT_NO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INST_PARTYMAPPINGLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INST_PARTYMAPPINGLOG]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [RPT_REPORT_NO] INT NULL,
    [ACTIONBY] VARCHAR(25) NULL,
    [MACHINENAME] VARCHAR(25) NULL,
    [ACTION] VARCHAR(10) NULL,
    [ACTIONDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INSTREPORT_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INSTREPORT_SETTING]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Rpt_Type] VARCHAR(10) NULL,
    [Rpt_Name] VARCHAR(50) NULL,
    [Rpt_Column] VARCHAR(500) NULL,
    [Rpt_Field] VARCHAR(500) NULL,
    [Rpt_Summaries] CHAR(3) NULL,
    [Rpt_FileName] VARCHAR(50) NULL,
    [Rpt_DateFormat] VARCHAR(25) NULL,
    [Rpt_SubTotal] VARCHAR(200) NULL,
    [Rpt_GrandTotal] VARCHAR(200) NULL,
    [Rpt_TopHeader] VARCHAR(500) NULL,
    [Rpt_Footer] VARCHAR(500) NULL,
    [Rpt_SQL_Proc1] VARCHAR(50) NULL,
    [Rpt_Delimiter] VARCHAR(50) NULL,
    [Rpt_BatchGen] VARCHAR(50) NULL,
    [Rpt_Incremental_Allowed] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LOGIN_ERR_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LOGIN_ERR_LOG]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [LOGIN_ID] VARCHAR(20) NULL,
    [LOGIN_PWD] VARCHAR(512) NULL,
    [IPADD] VARCHAR(20) NULL,
    [ERR_TYPE] VARCHAR(20) NULL,
    [LOGIN_TYPE] VARCHAR(10) NULL,
    [LOGIN_DT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Login_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Login_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(64) NULL,
    [Category] VARCHAR(64) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusId] VARCHAR(32) NULL,
    [IPADD] VARCHAR(20) NULL,
    [Action] VARCHAR(6) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PROCESS_STATUS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PROCESS_STATUS_LOG]
(
    [SNO] NUMERIC(9, 0) IDENTITY(1,1) NOT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [BusinessDate] SMALLDATETIME NULL,
    [ProcessId] VARCHAR(10) NULL,
    [ProcessName] VARCHAR(50) NULL,
    [FileName] VARCHAR(255) NULL,
    [Start_End_Flag] INT NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(64) NULL,
    [MachineIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Report_Access_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Report_Access_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [RepPath] VARCHAR(4000) NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(50) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusID] VARCHAR(32) NULL,
    [IPAdd] VARCHAR(20) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ValanAccount
-- --------------------------------------------------
CREATE TABLE [dbo].[ValanAccount]
(
    [AcCode] VARCHAR(10) NULL,
    [AcName] VARCHAR(50) NULL,
    [Reversed] INT NULL,
    [RevCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.AUDIT_MARGIN_VIEW
-- --------------------------------------------------
CREATE VIEW AUDIT_MARGIN_VIEW
AS
SELECT PARTY_CODE, MDATE, MARGIN = SPREADMARGIN + MTOM FROM FOMARGINNEW

GO

-- --------------------------------------------------
-- VIEW dbo.BFOAsalepur1
-- --------------------------------------------------
CREATE view [dbo].[BFOAsalepur1] AS
select t1.party_code,t1.series_code,t1.sell_buy,
      pqty = isnull((select sum(tradeqty) from bfotrade where 
                bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.sell_buy = 1),0),
      Sqty =isnull( (select sum(tradeqty) from bfotrade where 
   
              bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.sell_buy = 2),0),
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from bfotrade t1
GROUP BY 
t1.party_code,t1.series_code,t1.sell_buy

GO

-- --------------------------------------------------
-- VIEW dbo.BFOASALEPUR2
-- --------------------------------------------------
CREATE view [dbo].[BFOASALEPUR2] AS
select t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy,
      pqty = isnull((select sum(tradeqty) from bfotrade where 
                bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 1),0),
      Sqty =isnull( (select sum(tradeqty) from bfotrade where 
   
              bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
               and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 2),0),
strikeprice=isnull((select distinct bs.StrikePrice from bfoscrip2 bs where bs.product_code=t1.product_code and bs.product_type=t1.product_type and bs.series_code=t1.series_code and bs.series_id=t1.series_id) ,0) ,
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from bfotrade t1
GROUP BY 
t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBILLPQTYSQTY
-- --------------------------------------------------
CREATE view [dbo].[BFOBILLPQTYSQTY] AS   
select   
pqty = ( case when s.sell_buy = 1 then sum(s.tradeqty) else 0 end ),  
sqty = ( case when s.sell_buy = 2 then sum(s.tradeqty) else 0 end )  ,  
Party_Code,s.Series_Code,s.Series_id,S.EXPIRYDATE  
from BFoSettlement s  
group by   
party_code,s.Series_Code,s.Series_id,S.EXPIRYDATE,sell_Buy

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBILLTOTQT
-- --------------------------------------------------
CREATE view [dbo].[BFOBILLTOTQT] AS  
SELECT PQTY=SUM(pqty),SQTY=SUM(Sqty),Party_Code,s.Series_Code,s.Series_id,S.EXPIRYDATE  
from BFOBILLPQTYSQTY s  
group by   
party_code,s.Series_Code,s.Series_id,s.expirydate

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBROKVIEW_EXALLOCFINAL
-- --------------------------------------------------
CREATE VIEW [DBO].[BFOBROKVIEW_EXALLOCFINAL] 
AS 
  SELECT BFOBROKVIEW_EXALLOC.TRADE_NO, 
         BFOBROKVIEW_EXALLOC.PRODUCT_CODE, 
         BFOBROKVIEW_EXALLOC.PRODUCT_TYPE, 
         BFOBROKVIEW_EXALLOC.ASSET_CODE,
         BFOBROKVIEW_EXALLOC.PARTY_CODE, 
         BFOBROKVIEW_EXALLOC.SERIES_CODE, 
         BFOBROKVIEW_EXALLOC.SERIES_ID, 
         BFOBROKVIEW_EXALLOC.EXPIRYDATE, 
         BFOBROKVIEW_EXALLOC.MULTIPLIER, 
         BFOBROKVIEW_EXALLOC.USER_ID, 
         BFOBROKVIEW_EXALLOC.SELL_BUY, 
         BFOBROKVIEW_EXALLOC.TRADEQTY, 
         BFOBROKVIEW_EXALLOC.MARKETRATE, 
         BFOBROKVIEW_EXALLOC.CL_TYPE, 
         BFOBROKVIEW_EXALLOC.OPPMEMCODE, 
         BFOBROKVIEW_EXALLOC.OPPTRADERCODE, 
         BFOBROKVIEW_EXALLOC.TRANS_TYPE, 
         BFOBROKVIEW_EXALLOC.STRIKE_PRICE, 
         BFOBROKVIEW_EXALLOC.OPTION_TYPE, 
         BFOBROKVIEW_EXALLOC.SAUDA_DATE, 
         BFOBROKVIEW_EXALLOC.ORDER_DATE, 
         BFOBROKVIEW_EXALLOC.ORDER_NO, 
         BFOBROKVIEW_EXALLOC.SETTFLAG, 
         BFOBROKVIEW_EXALLOC.GROUPID, 
         BFOBROKVIEW_EXALLOC.TRADERCODE, 
         FUT_BROKTABLE, 
         BFOBROKVIEW_EXALLOC.TRAN_CAT, 
         BFOBROKVIEW_EXALLOC.OFF_PHONE1, 
         BROK_SCHEME, 
         MPRICE, 
         BFOGLOBALS.SERVICE_TAX, 
         BROKTABLE.TABLE_NO, 
         BROKTABLE.LINE_NO, 
         BROKTABLE.VAL_PERC, 
         BROKTABLE.NORMAL, 
         BROKTABLE.DAY_PUC, 
         BROKTABLE.DAY_SALES, 
         BROKTABLE.SETT_PURCH, 
         BROKTABLE.SETT_SALES, 
         FOCLIENTTAXES.ROUND_TO, 
         FOCLIENTTAXES.ROFIG, 
         FOCLIENTTAXES.ERRNUM, 
         FOCLIENTTAXES.NOZERO, 
         FUT_INSURANCE_CHRG, 
         FUT_TURNOVER_TAX, 
         FUT_SEBITURN_TAX, 
         FUT_BROKER_NOTE, 
         SERTAX = BFOGLOBALS.SERVICE_TAX, 
         BFOGLOBALS.YEAR, 
         BFOGLOBALS.EXCHANGE, 
         MARKETLOT, 
         BFOTAXES.INSURANCE_CHRG,BFOTAXES.TURNOVER_TAX,BFOTAXES.SEBITURN_TAX,BFOTAXES.BROKER_NOTE,
         BROKAPPLIED = BFOBROKVIEW_EXALLOC.MULTIPLIER * (CASE 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'V' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN ((FLOOR((BROKTABLE.NORMAL *
					 POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					 POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'V' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN ((FLOOR((BROKTABLE.NORMAL * 
					 POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					 (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					 POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'P' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN ((FLOOR((((BROKTABLE.NORMAL * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'P' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN ((FLOOR((((BROKTABLE.NORMAL  *
					(BFOBROKVIEW_EXALLOC.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
					FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 2 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((((BROKTABLE.DAY_PUC)) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 2 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.DAY_PUC  * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
					FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 3 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.DAY_SALES * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 3 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.DAY_SALES  * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
					FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 4 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_PURCH * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 4 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.SETT_PURCH  * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 5 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_SALES * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 5 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.SETT_SALES  *
					(BFOBROKVIEW_EXALLOC.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               ELSE 0 
             END), 
          
         INS_CHRG = 0, 
         TURN_TAX = CASE WHEN BFOTAXES.TURNOVER_TAX > 0 THEN
				((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_TURNOVER_TAX 
				ELSE OPT_TURNOVER_TAX 
				END * (BFOBROKVIEW_EXALLOC.CL_RATE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
				POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END, 
         OTHER_CHRG = CASE WHEN BFOTAXES.OTHER_CHRG > 0 THEN 
				((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_OTHER_CHRG 
				ELSE OPT_OTHER_CHRG 
				END * (BFOBROKVIEW_EXALLOC.CL_RATE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
				POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END, 
				
         SEBI_TAX = CASE WHEN BFOTAXES.SEBITURN_TAX > 0 THEN
				((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_SEBITURN_TAX 
				ELSE OPT_SEBITURN_TAX 
				END * (BFOBROKVIEW_EXALLOC.STRIKE_PRICE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) *
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
				POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END, 
				
         BROKER_CHRG = CASE WHEN BFOTAXES.BROKER_NOTE > 0 THEN
				((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKER_NOTE 
				ELSE OPT_BROKER_NOTE 
				END * (BFOBROKVIEW_EXALLOC.CL_RATE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
				POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END, 
         BFOBROKVIEW_EXALLOC.SEC_NAME, 
         BFOBROKVIEW_EXALLOC.CL_RATE, 
         BFOBROKVIEW_EXALLOC.CALLPUT, 
         PRO_CLI, 
         O_C_FLAG, 
         C_U_FLAG, 
         MARKETTYPE, 
         AUCTIONPART, 
         PARTICIPANTCODE, 
         OLDPARTYCODE 
  FROM   BROKTABLE BROKTABLE, 
		 BFOTAXES,
         (SELECT TRADE_NO = F.TRADE_NO, 
                 STATUS = '11', 
                 PRODUCT_CODE = F.PRODUCT_CODE, 
                 PRODUCT_TYPE = F.PRODUCT_TYPE, 
                 SERIES_CODE = F.SERIES_CODE, 
                 SERIES_ID = F.SERIES_ID, 
                 EXPIRYDATE = F.EXPIRYDATE, 
                 STRIKE_PRICE = F.STRIKE_PRICE, 
                 OPTION_TYPE = F.OPTION_TYPE,
                 CALLPUT = '', 
                 CL_TYPE = '', 
                 OPPMEMCODE = '', 
                 OPPTRADERCODE = '', 
                 TRANS_TYPE = '', 
                 SEC_NAME = F.PRODUCT_CODE + LEFT(F.EXPIRYDATE,11) + CONVERT(VARCHAR,F.STRIKE_PRICE) + F.OPTION_TYPE, 
                 BOOKTYPE = '1', 
                 TRADERCODE = '', 
                 MARKETTYPE = '', 
                 USER_ID = F.TERMINALID, 
                 BRANCH_ID = '1', 
                 SELL_BUY = F.SELL_BUY, 
                 TRADEQTY = F.TRADEQTY, 
                 MARKETRATE = F.TRADE_PRICE, 
                 PRO_CLI = F.PRO_CLI, 
                 PARTY_CODE = F.PARTY_CODE, 
                 PARTICIPANTCODE = '', 
                 O_C_FLAG = 0, 
                 C_U_FLAG = 0, 
                 SAUDA_DATE , 
                 ORDER_DATE = F.ORDER_TIMESTAMP, 
                 ORDER_NO = F.ORDER_NO, 
                 OPP_BROKER_ID = '', 
                 SETTFLAG = F.SETTFLAG, 
                 GROUPID = '', 
                 TRAN_CAT, 
                 OFF_PHONE1 = '', 
                 AUCTIONPART = '', 
                 MPRICE = 0, 
                 MULTIPLIER = 1, 
                 CL_RATE = 0, 
                 OLDPARTYCODE=F.PARTY_CODE, 
                 MARKETLOT = LOT_SIZE_MULTIPLE,
                 F.ASSET_CODE
				FROM   BFOEXALLOCTRADE F, 
                 CLIENT2 C2, 
                 BFOSCRIP2 S2 
          WHERE  C2.PARTY_CODE = F.PARTY_CODE 
                 --AND F.PRODUCT_TYPE = S2.PRODUCT_TYPE 
                 AND F.PRODUCT_CODE = S2.PRODUCT_CODE 
                 AND F.SERIES_CODE = S2.SERIES_CODE 
                 AND F.SERIES_ID = S2.SERIES_ID) BFOBROKVIEW_EXALLOC, 
         BFOGLOBALS, 
         (SELECT   PARTY_CODE = T1.PARTY_CODE, 
                   PRODUCT_TYPE = T1.PRODUCT_TYPE, 
                   PRODUCT_CODE = T1.PRODUCT_CODE, 
                   SERIES_CODE = T1.SERIES_CODE, 
                   SERIES_ID = T1.SERIES_ID, 
                   SELL_BUY = T1.SELL_BUY, 
				   PQTY = SUM(CASE 
								WHEN SELL_BUY = 1 THEN TRADEQTY 
                                ELSE 0 
                           END), 
                   SQTY = SUM(CASE 
                                WHEN SELL_BUY = 2 THEN TRADEQTY 
                                ELSE 0 
                           END), 
                   STRIKE_PRICE = ISNULL((SELECT DISTINCT BS.STRIKE_PRICE 
                                         FROM   BFOSCRIP2 BS 
                                         WHERE  BS.PRODUCT_CODE = T1.PRODUCT_CODE 
                                                --AND BS.PRODUCT_TYPE = T1.PRODUCT_TYPE 
                                                AND BS.SERIES_CODE = T1.SERIES_CODE 
                                                AND BS.SERIES_ID = T1.SERIES_ID), 
                                        0), 
                   PRATE = (CASE 
							WHEN T1.SELL_BUY = 1 THEN SUM(TRADE_PRICE * TRADEQTY) / (CASE 
								  WHEN SUM(TRADEQTY) > 0 THEN SUM(TRADEQTY) 
								  ELSE 1 
								END) 
							ELSE 0 
							END), 
                   SRATE = (CASE 
							WHEN T1.SELL_BUY = 2 THEN SUM(TRADE_PRICE * TRADEQTY) / (CASE 
								  WHEN SUM(TRADEQTY) > 0 THEN SUM(TRADEQTY) 
								  ELSE 1 
								END) 
							ELSE 0 
							END) 
          FROM     BFOEXALLOCTRADE T1 
          GROUP BY T1.PARTY_CODE,T1.PRODUCT_TYPE,T1.PRODUCT_CODE,T1.SERIES_CODE, 
                   T1.SERIES_ID,T1.SELL_BUY) S, 
         FOCLIENTTAXES, 
         FOCLIENTBROKSCHEME 
  WHERE  BFOBROKVIEW_EXALLOC.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE 
         AND BFOBROKVIEW_EXALLOC.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO 
         AND BFOBROKVIEW_EXALLOC.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE 
         AND BFOBROKVIEW_EXALLOC.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO 
         AND BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
         AND BFOTAXES.TRANS_CAT = 'DEL'
         AND BFOBROKVIEW_EXALLOC.SAUDA_DATE BETWEEN BFOTAXES.FROM_DATE AND BFOTAXES.TO_DATE  
         AND BFOBROKVIEW_EXALLOC.SELL_BUY = S.SELL_BUY 
         --AND BFOBROKVIEW_EXALLOC.PRODUCT_TYPE = S.PRODUCT_TYPE 
         AND BFOBROKVIEW_EXALLOC.PRODUCT_CODE = S.PRODUCT_CODE 
         AND BFOBROKVIEW_EXALLOC.SERIES_CODE = S.SERIES_CODE 
         AND BFOBROKVIEW_EXALLOC.SERIES_ID = S.SERIES_ID 
         AND BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
         AND BROKTABLE.LINE_NO = (CASE 
									WHEN (BROK_SCHEME = 1 
									OR BROK_SCHEME = 5) THEN (SELECT MIN(BROKTABLE.LINE_NO) 
									FROM   BROKTABLE 
									WHERE  BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
									AND TRD_DEL = (CASE 
												 WHEN S.PQTY >= S.SQTY THEN (CASE 
																	WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
																	ELSE 'S' 
																	END) 
												 ELSE (CASE 
														 WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
														 ELSE 'S' 
													   END) 
											   END) 
									AND BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
									AND BFOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN (BROK_SCHEME = 3 
										OR BROK_SCHEME = 6) THEN (SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
										AND TRD_DEL = (CASE 
											 WHEN S.PQTY > S.SQTY THEN (CASE 
													  WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
													  ELSE 'S' 
													END) 
											 ELSE (CASE 
													 WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
													 ELSE 'S' 
												   END) 
										   END) 
										AND BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
										AND BFOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM) 
                                WHEN BROK_SCHEME = 2 THEN (SELECT MIN(BROKTABLE.LINE_NO) 
								FROM   BROKTABLE 
								WHERE  BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
								AND TRD_DEL = (CASE 
									WHEN S.PQTY = S.SQTY THEN (CASE 
										WHEN S.PRATE >= S.SRATE THEN (CASE 
											WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
											ELSE 'S' 
										  END) 
										ELSE (CASE 
										WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
										ELSE 'S' 
										END) 
										END) 
									ELSE (CASE 
									WHEN S.PQTY >= S.SQTY THEN (CASE 
														 WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
														 ELSE 'S' 
													   END) 
									ELSE (CASE 
									WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
									ELSE 'S' 
									END) 
									END) 
									END) 
								AND BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
								AND BFOBROKVIEW_EXALLOC.CL_RATE <= BROKTABLE.UPPER_LIM) 
								ELSE (SELECT MIN(LINE_NO) 
								FROM   BROKTABLE 
								WHERE  BFOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM 
								AND BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE) 
                                  END) 
         AND BFOBROKVIEW_EXALLOC.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBROKVIEWFINAL
-- --------------------------------------------------
  
CREATE VIEW [DBO].[BFOBROKVIEWFINAL] AS    
    
SELECT     
 BFOTRADE.TRADE_NO,    
 BFOTRADE.SAUDA_DATE,    
 BFOTRADE.TRADESTATUS,    
 BFOTRADE.SEGMENT,    
 BFOTRADE.SETT_TYPE,    
 BFOTRADE.PRODUCT_TYPE,    
 BFOTRADE.PRODUCT_CODE,    
 BFOTRADE.ASSET_CODE,    
 BFOTRADE.EXPIRYDATE,    
 BFOTRADE.STRIKE_PRICE,    
 BFOTRADE.OPTION_TYPE,    
 BFOTRADE.SERIES_CODE,    
 BFOTRADE.SERIES_ID,    
 BFOTRADE.LOT_SIZE,    
 BFOTRADE.SELL_BUY,    
 BFOTRADE.TRADEQTY,    
 BFOTRADE.CA_LEVEL,    
 BFOTRADE.BROKER_CD,    
 BFOTRADE.TRADE_PRICE,    
 BFOTRADE.LOCATIONID,    
 BFOTRADE.CM_CODE,    
 BFOTRADE.PARTICIPANTCODE,    
 BFOTRADE.CP_CONFIRMATION,    
 BFOTRADE.OC_FLAG,    
 BFOTRADE.OLD_CP_CODE,    
 BFOTRADE.OLD_CM_CODE,    
 BFOTRADE.TERMINALID,    
 BFOTRADE.ORDER_NO,    
 BFOTRADE.PARTY_CODE,    
 BFOTRADE.REMARKS,    
 BFOTRADE.BUY_POSITION,    
 BFOTRADE.SELL_POSITION,    
 BFOTRADE.PRO_CLI,    
 BFOTRADE.ORDER_TIMESTAMP,    
 BFOTRADE.ORDER_ACTIVEFLAG,    
 BROKTABLE.TABLE_NO,    
 BROKTABLE.LINE_NO,    
 BROKTABLE.VAL_PERC,    
 BROKTABLE.NORMAL,    
 BROKTABLE.DAY_PUC,    
 BROKTABLE.DAY_SALES,    
 BROKTABLE.SETT_PURCH,    
 BROKTABLE.SETT_SALES,    
 BFOTRADE.SETTFLAG,    
 FOCLIENTTAXES.ROFIG,    
 FOCLIENTTAXES.ERRNUM,    
 FOCLIENTTAXES.NOZERO,    
 FOCLIENTTAXES.ROUND_TO,    
 TRADE_AMOUNT = TRADEQTY*TRADE_PRICE,    
 BRANCH_CD = BFOTRADE.PARTY_CODE,     
    BROKAPPLIED =     
 (CASE     
         WHEN (SETTFLAG = 1 AND BROKTABLE.VAL_PERC = 'V' AND SELL_BUY = 1)     
   THEN ((FLOOR((BROKTABLE.NORMAL * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 1 AND BROKTABLE.VAL_PERC = 'V' AND SELL_BUY = 2)     
   THEN ((FLOOR((BROKTABLE.NORMAL * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 1 AND BROKTABLE.VAL_PERC = 'P' AND SELL_BUY = 1)     
   THEN ((FLOOR((((BROKTABLE.NORMAL * (TRADE_PRICE))  / 100)*     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 1  AND BROKTABLE.VAL_PERC = 'P' AND SELL_BUY = 2)     
   THEN ((FLOOR((((BROKTABLE.NORMAL  * (TRADE_PRICE)) / 100)*     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /     
    POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 2 AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((((BROKTABLE.DAY_PUC)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +    
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 2 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.DAY_PUC  *     
    (TRADE_PRICE))/ 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 3 AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)     
    + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 3 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.DAY_SALES  * (TRADE_PRICE)) / 100)*     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 4 AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 4 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.SETT_PURCH  * (TRADE_PRICE))/ 100) *     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 5 AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 5 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.SETT_SALES  * (TRADE_PRICE))/ 100) *     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 8 AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((((BROKTABLE.SETT_PURCH)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 8 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.SETT_PURCH  * (TRADE_PRICE))/ 100) *     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))                                                      
         WHEN (SETTFLAG = 9 AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *    
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 9 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.SETT_SALES  * (TRADE_PRICE))/ 100) *     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 6 AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 6 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.SETT_PURCH  * (TRADE_PRICE)) / 100)*     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 7  AND BROKTABLE.VAL_PERC = 'V')     
   THEN ((FLOOR((BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
    FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *     
    (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (SETTFLAG = 7 AND BROKTABLE.VAL_PERC = 'P')     
   THEN ((FLOOR((((BROKTABLE.SETT_SALES * (TRADE_PRICE))  / 100)*     
    POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         ELSE 0    
       END) ,    
INS_CHRG = CASE WHEN BFOTAXES.INSURANCE_CHRG > 0 THEN    
   ((FLOOR((((CASE WHEN RIGHT(PRODUCT_CODE,3) ='FUT' THEN FUT_INSURANCE_CHRG ELSE OPT_INSURANCE_CHRG  END/ 100) *     
    (TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END,    
          
TURN_TAX = CASE WHEN BFOTAXES.TURNOVER_TAX > 0   THEN    
   CASE WHEN TURNOVER_TAX_ON = 'ACTIVE_TRD'  AND ORDER_ACTIVEFLAG <> 0 THEN 0 ELSE    
       
   ((FLOOR((((CASE WHEN RIGHT(PRODUCT_CODE,3) ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END / 100) *     
    (TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
   END    
       
   ELSE 0 END,    
    
OTHER_CHRG = CASE WHEN BFOTAXES.OTHER_CHRG > 0 THEN     
   ((FLOOR((((CASE WHEN RIGHT(PRODUCT_CODE,3) ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END  / 100) *     
    (TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END,    
    
SEBI_TAX = CASE WHEN BFOTAXES.SEBITURN_TAX > 0 THEN    
   ((FLOOR((((CASE WHEN RIGHT(PRODUCT_CODE,3) ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END/ 100) *     
    (TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +     
    FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END,    
    
BROKER_CHRG = 0    
     
FROM    
 BFOTRADE (NOLOCK),    
 FOCLIENTTAXES (NOLOCK),    
 FOCLIENTBROKSCHEME (NOLOCK),    
 BROKTABLE (NOLOCK),    
 BFOTAXES (NOLOCK),    
 CLIENT1 (NOLOCK),    
 CLIENT2 (NOLOCK),    
 (    
 SELECT     
 PARTY_CODE,SERIES_CODE,    
 PQTY=SUM(CASE WHEN SELL_BUY =1 THEN TRADEQTY ELSE 0 END),    
 SQTY=SUM(CASE WHEN SELL_BUY =2 THEN TRADEQTY ELSE 0 END),    
 PRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0  
        THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /  
      SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)  
        ELSE 0 END),    
 SRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0  
        THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /  
      SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)  
        ELSE 0 END)  
  FROM    
  BFOTRADE (NOLOCK)    
 GROUP BY    
  PARTY_CODE,SERIES_CODE    
 ) TRD    
WHERE    
 CLIENT1.CL_CODE = CLIENT2.CL_CODE AND    
 CLIENT2.PARTY_CODE = TRD.PARTY_CODE AND    
 BROKTABLE.TABLE_NO = FOCLIENTBROKSCHEME.FUT_BROKTABLE AND    
 BFOTRADE.PARTY_CODE = TRD.PARTY_CODE AND    
 BFOTRADE.SERIES_CODE = TRD.SERIES_CODE AND    
 BROKTABLE.LINE_NO = (    
       SELECT LINE_NO FROM BROKTABLE B    
       WHERE     
        B.TABLE_NO = BROKTABLE.TABLE_NO AND    
        BFOTRADE.TRADE_PRICE >= B.LOWER_LIM AND   
        BFOTRADE.TRADE_PRICE < B.UPPER_LIM AND     
        TRD_DEL =     
           CASE     
            WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 0      
            THEN 'T'    
            WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 1 THEN    
             CASE       
             WHEN TRD.PQTY = TRD.SQTY     
   THEN (CASE       
               WHEN TRD.PRATE > = TRD.SRATE     
               THEN (CASE       
                 WHEN BFOTRADE.SELL_BUY = 1     
                 THEN 'F'      
                 ELSE 'S'      
         END)      
               ELSE (CASE       
                 WHEN (BFOTRADE.SELL_BUY = 2)     
                 THEN 'F'      
                 ELSE 'S'      
                END)      
               END)      
             ELSE (CASE       
               WHEN TRD.PQTY > = TRD.SQTY     
               THEN (CASE       
                 WHEN (BFOTRADE.SELL_BUY = 1)     
                 THEN 'F'      
                ELSE 'S'      
                END)      
               ELSE (CASE       
                 WHEN (BFOTRADE.SELL_BUY = 2)     
                 THEN 'F'      
                 ELSE 'S'      
                END)      
               END)      
             END                                         
            WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 3 THEN     
             CASE       
              WHEN ((TRD.PQTY > TRD.SQTY)      
                 AND SETTFLAG IN (1,2,3,4,      
                      5)) THEN (CASE       
                         WHEN (BFOTRADE.SELL_BUY = 1) THEN 'F'      
                         ELSE 'S'      
                       END)      
              WHEN SETTFLAG IN (6,7) THEN 'S'      
              WHEN SETTFLAG IN (8,9) THEN 'F'      
              WHEN ((TRD.PQTY <= TRD.SQTY)      
                 AND SETTFLAG IN (1,2,3,4,      
                      5)) THEN (CASE       
                         WHEN (BFOTRADE.SELL_BUY = 2) THEN 'F'      
                         ELSE 'S'      
                       END)      
              WHEN SETTFLAG IN (6,7) THEN 'S'      
              WHEN SETTFLAG IN (8,9) THEN 'F'      
              WHEN SETTFLAG = 0 THEN 'F'      
               END                  
           END    
      ) AND         
 BFOTRADE.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND    
 BFOTRADE.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND    
 BFOTRADE.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND    
 BFOTRADE.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND    
 BFOTAXES.TRANS_CAT = CASE WHEN CLIENT2.TRAN_CAT = 'PRO' THEN 'PRO' ELSE 'TRD' END AND    
 BFOTRADE.SAUDA_DATE BETWEEN BFOTAXES.FROM_DATE AND BFOTAXES.TO_DATE

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBROKVIEWFINAL_EXPIRY
-- --------------------------------------------------

CREATE VIEW [DBO].[BFOBROKVIEWFINAL_EXPIRY] AS

SELECT 
	BFOTRADE.TRADE_NO,
	BFOTRADE.SAUDA_DATE,
	BFOTRADE.TRADESTATUS,
	BFOTRADE.SEGMENT,
	BFOTRADE.SETT_TYPE,
	BFOTRADE.PRODUCT_TYPE,
	BFOTRADE.PRODUCT_CODE,
	BFOTRADE.ASSET_CODE,
	BFOTRADE.EXPIRYDATE,
	BFOTRADE.STRIKE_PRICE,
	BFOTRADE.OPTION_TYPE,
	BFOTRADE.SERIES_CODE,
	BFOTRADE.SERIES_ID,
	BFOTRADE.LOT_SIZE,
	BFOTRADE.SELL_BUY,
	BFOTRADE.TRADEQTY,
    BFOTRADE.CA_LEVEL,
	BFOTRADE.BROKER_CD,
	BFOTRADE.TRADE_PRICE,
	BFOTRADE.LOCATIONID,
	BFOTRADE.CM_CODE,
	BFOTRADE.PARTICIPANTCODE,
	BFOTRADE.CP_CONFIRMATION,
	BFOTRADE.OC_FLAG,
	BFOTRADE.OLD_CP_CODE,
	BFOTRADE.OLD_CM_CODE,
	BFOTRADE.TERMINALID,
	BFOTRADE.ORDER_NO,
	BFOTRADE.PARTY_CODE,
	BFOTRADE.REMARKS,
	BFOTRADE.BUY_POSITION,
	BFOTRADE.SELL_POSITION,
	BFOTRADE.PRO_CLI,
	BFOTRADE.ORDER_TIMESTAMP,
	BFOTRADE.ORDER_ACTIVEFLAG,
	BROKTABLE.TABLE_NO,
	BROKTABLE.LINE_NO,
	BROKTABLE.VAL_PERC,
	BROKTABLE.NORMAL,
	BROKTABLE.DAY_PUC,
	BROKTABLE.DAY_SALES,
	BROKTABLE.SETT_PURCH,
	BROKTABLE.SETT_SALES,
	BFOTRADE.SETTFLAG,
	FOCLIENTTAXES.ROFIG,
	FOCLIENTTAXES.ERRNUM,
	FOCLIENTTAXES.NOZERO,
	FOCLIENTTAXES.ROUND_TO,
	TRADE_AMOUNT = TRADEQTY*TRADE_PRICE,
	BRANCH_CD = BFOTRADE.PARTY_CODE,	
    BROKAPPLIED = 
	(CASE 
	        WHEN (SETTFLAG = 1 AND BROKTABLE.VAL_PERC = 'V' AND SELL_BUY = 1) 
			THEN ((FLOOR((BROKTABLE.NORMAL * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 1 AND BROKTABLE.VAL_PERC = 'V' AND SELL_BUY = 2) 
			THEN ((FLOOR((BROKTABLE.NORMAL * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 1 AND BROKTABLE.VAL_PERC = 'P' AND SELL_BUY = 1) 
			THEN ((FLOOR((((BROKTABLE.NORMAL * (TRADE_PRICE)) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 1  AND BROKTABLE.VAL_PERC = 'P' AND SELL_BUY = 2) 
			THEN ((FLOOR((((BROKTABLE.NORMAL  * (TRADE_PRICE)) / 100)* 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
				POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 2 AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((((BROKTABLE.DAY_PUC)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 2 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.DAY_PUC  * 
				(TRADE_PRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 3 AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) 
				+ FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /	POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 3 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.DAY_SALES  * (TRADE_PRICE)) / 100)* 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 4 AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 4 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.SETT_PURCH * (TRADE_PRICE)) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 5 AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 5 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.SETT_SALES  * (TRADE_PRICE)) / 100)* 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 8 AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((((BROKTABLE.SETT_PURCH)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 8 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.SETT_PURCH  * (TRADE_PRICE)) / 100)* 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))	                                                 
	        WHEN (SETTFLAG = 9 AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 9 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.SETT_SALES  * (TRADE_PRICE)) / 100)* 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 6 AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 6 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.SETT_PURCH * (TRADE_PRICE)) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 7  AND BROKTABLE.VAL_PERC = 'V') 
			THEN ((FLOOR((BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
				FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        WHEN (SETTFLAG = 7 AND BROKTABLE.VAL_PERC = 'P') 
			THEN ((FLOOR((((BROKTABLE.SETT_SALES* (TRADE_PRICE))  / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))
	        ELSE 0
	      END)	,
INS_CHRG = 0,
	     
TURN_TAX = CASE WHEN BFOTAXES.TURNOVER_TAX > 0 THEN
			((FLOOR((((FUT_TURNOVER_TAX / 100) * 
				(TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END,

OTHER_CHRG = CASE WHEN BFOTAXES.OTHER_CHRG > 0 THEN 
			((FLOOR((((FUT_OTHER_CHRG / 100) * 
				(TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END,

SEBI_TAX = CASE WHEN BFOTAXES.SEBITURN_TAX > 0 THEN
			((FLOOR((((FUT_SEBITURN_TAX / 100) * 
				(TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END,

BROKER_CHRG = CASE WHEN BFOTAXES.BROKER_NOTE > 0 THEN
			((FLOOR((((FUT_BROKER_NOTE / 100) * 
				(TRADE_PRICE*TRADEQTY)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
				FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) ELSE 0 END
	
FROM
	BFOTRADE (NOLOCK),
	FOCLIENTTAXES (NOLOCK),
	FOCLIENTBROKSCHEME (NOLOCK),
	BROKTABLE (NOLOCK),
	BFOTAXES (NOLOCK),
	CLIENT1 (NOLOCK),
	CLIENT2 (NOLOCK),
	(
	SELECT 
		PARTY_CODE,SERIES_CODE,
		PQTY=SUM(CASE WHEN SELL_BUY =1 THEN TRADEQTY ELSE 0 END),
		SQTY=SUM(CASE WHEN SELL_BUY =2 THEN TRADEQTY ELSE 0 END),
		PRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0
			   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /
				SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)
			   ELSE 0 END),  
		SRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0
			   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*TRADE_PRICE ELSE 0 END) /
				SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)
			   ELSE 0 END)
	FROM
		BFOTRADE (NOLOCK)
	GROUP BY
		PARTY_CODE,SERIES_CODE
	) TRD
WHERE
	CLIENT1.CL_CODE = CLIENT2.CL_CODE AND
	CLIENT2.PARTY_CODE = TRD.PARTY_CODE AND
	BROKTABLE.TABLE_NO = FOCLIENTBROKSCHEME.FUT_BROKTABLE AND
	BFOTRADE.PARTY_CODE = TRD.PARTY_CODE AND
	BFOTRADE.SERIES_CODE = TRD.SERIES_CODE AND
	BROKTABLE.LINE_NO = (
							SELECT LINE_NO FROM BROKTABLE B
							WHERE 
								B.TABLE_NO = BROKTABLE.TABLE_NO AND
								BFOTRADE.TRADE_PRICE BETWEEN B.LOWER_LIM AND B.UPPER_LIM AND 
								TRD_DEL = 
											CASE 
												WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 0  
												THEN 'T'
												WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 2 THEN
													CASE   
													WHEN TRD.PQTY = TRD.SQTY 
													THEN (CASE   
															WHEN TRD.PRATE > = TRD.SRATE 
															THEN (CASE   
																	WHEN BFOTRADE.SELL_BUY = 1 
																	THEN 'F'  
																	ELSE 'S'  
																END)  
															ELSE (CASE   
																	WHEN (BFOTRADE.SELL_BUY = 2) 
																	THEN 'F'  
																	ELSE 'S'  
																END)  
															END)  
													ELSE (CASE   
															WHEN TRD.PQTY > = TRD.SQTY 
															THEN (CASE   
																	WHEN (BFOTRADE.SELL_BUY = 1) 
																	THEN 'F'  
																ELSE 'S'  
																END)  
															ELSE (CASE   
																	WHEN (BFOTRADE.SELL_BUY = 2) 
																	THEN 'F'  
																	ELSE 'S'  
																END)  
															END)  
													END                         												
												WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 2 THEN 
													CASE   
														WHEN ((TRD.PQTY > TRD.SQTY)  
															  AND SETTFLAG IN (1,2,3,4,  
																			   5)) THEN (CASE   
																						   WHEN (BFOTRADE.SELL_BUY = 1) THEN 'F'  
																						   ELSE 'S'  
																						 END)  
														WHEN SETTFLAG IN (6,7) THEN 'S'  
														WHEN SETTFLAG IN (8,9) THEN 'F'  
														WHEN ((TRD.PQTY <= TRD.SQTY)  
															  AND SETTFLAG IN (1,2,3,4,  
																			   5)) THEN (CASE   
																						   WHEN (BFOTRADE.SELL_BUY = 2) THEN 'F'  
																						   ELSE 'S'  
																						 END)  
														WHEN SETTFLAG IN (6,7) THEN 'S'  
														WHEN SETTFLAG IN (8,9) THEN 'F'  
														WHEN SETTFLAG = 0 THEN 'F'  
													  END  												
											END
						) AND					
	BFOTRADE.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND
	BFOTRADE.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND
	BFOTRADE.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND
	BFOTRADE.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND
	BFOTAXES.TRANS_CAT = 'DEL' AND
	BFOTRADE.SAUDA_DATE BETWEEN BFOTAXES.FROM_DATE AND BFOTAXES.TO_DATE

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCONFIRMVIEW
-- --------------------------------------------------



CREATE VIEW [DBO].[BFOCONFIRMVIEW] AS   
  
SELECT 
	TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,
	ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,
	SELL_BUY,TRADEQTY,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,
	CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,BFOBROKVIEWFINAL.PARTY_CODE,
	REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	BFOBROKVIEWFINAL.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,
	ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,
	BFOBROKVIEWFINAL.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,	
	NETRATE = (CASE WHEN BFOBROKVIEWFINAL.SELL_BUY = 1 
			THEN BFOBROKVIEWFINAL.TRADE_PRICE + BROKAPPLIED 
			ELSE BFOBROKVIEWFINAL.TRADE_PRICE - BROKAPPLIED 
			END),  
	SERVICE_TAX = CASE WHEN C2.SERVICE_CHRG = 1 AND C2.SERTAXMETHOD = 1 THEN 0 ELSE  
				((FLOOR ( (BROKAPPLIED*TRADEQTY *LOT_SIZE * BFOGLOBALS.SERVICE_TAX/100 
				* POWER(10,BFOBROKVIEWFINAL.ROUND_TO) + 
				BFOBROKVIEWFINAL.ROFIG + BFOBROKVIEWFINAL.ERRNUM  ) /  
				(BFOBROKVIEWFINAL.ROFIG + BFOBROKVIEWFINAL.NOZERO)) * (BFOBROKVIEWFINAL.ROFIG +
				BFOBROKVIEWFINAL.NOZERO) )  / POWER(10,BFOBROKVIEWFINAL.ROUND_TO)) END
FROM
	BFOBROKVIEWFINAL ,CLIENT2 C2 (NOLOCK), BFOGLOBALS (NOLOCK)
WHERE
	C2.PARTY_CODE = BFOBROKVIEWFINAL.PARTY_CODE
	AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCONFIRMVIEW_EXPIRY
-- --------------------------------------------------
CREATE VIEW [DBO].[BFOCONFIRMVIEW_EXPIRY] AS   
  
SELECT 
	TRADE_NO,SAUDA_DATE,TRADESTATUS,SEGMENT,SETT_TYPE,PRODUCT_TYPE,PRODUCT_CODE,
	ASSET_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SERIES_CODE,SERIES_ID,LOT_SIZE,
	SELL_BUY,TRADEQTY,CA_LEVEL,BROKER_CD,TRADE_PRICE,LOCATIONID,CM_CODE,PARTICIPANTCODE,
	CP_CONFIRMATION,OC_FLAG,OLD_CP_CODE,OLD_CM_CODE,TERMINALID,ORDER_NO,BFOBROKVIEWFINAL_EXPIRY.PARTY_CODE,
	REMARKS,BUY_POSITION,SELL_POSITION,PRO_CLI,ORDER_TIMESTAMP,ORDER_ACTIVEFLAG,
	BFOBROKVIEWFINAL_EXPIRY.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SETTFLAG,
	ROFIG,ERRNUM,NOZERO,ROUND_TO,TRADE_AMOUNT,BRANCH_CD,BROKAPPLIED,INS_CHRG,TURN_TAX,
	BFOBROKVIEWFINAL_EXPIRY.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,	
	NETRATE = (CASE WHEN BFOBROKVIEWFINAL_EXPIRY.SELL_BUY = 1 
			THEN BFOBROKVIEWFINAL_EXPIRY.TRADE_PRICE + BROKAPPLIED 
			ELSE BFOBROKVIEWFINAL_EXPIRY.TRADE_PRICE - BROKAPPLIED 
			END),  
	SERVICE_TAX = CASE WHEN C2.SERVICE_CHRG = 1 AND C2.SERTAXMETHOD = 1 THEN 0 ELSE  
				((FLOOR ( (BROKAPPLIED*TRADEQTY *LOT_SIZE * BFOGLOBALS.SERVICE_TAX/100 
				* POWER(10,BFOBROKVIEWFINAL_EXPIRY.ROUND_TO) + 
				BFOBROKVIEWFINAL_EXPIRY.ROFIG + BFOBROKVIEWFINAL_EXPIRY.ERRNUM  ) /  
				(BFOBROKVIEWFINAL_EXPIRY.ROFIG + BFOBROKVIEWFINAL_EXPIRY.NOZERO)) * (BFOBROKVIEWFINAL_EXPIRY.ROFIG +
				BFOBROKVIEWFINAL_EXPIRY.NOZERO) )  / POWER(10,BFOBROKVIEWFINAL_EXPIRY.ROUND_TO)) END
FROM
	BFOBROKVIEWFINAL_EXPIRY ,CLIENT2 C2 (NOLOCK), BFOGLOBALS (NOLOCK)
WHERE
	C2.PARTY_CODE = BFOBROKVIEWFINAL_EXPIRY.PARTY_CODE
	AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCursorContSale
-- --------------------------------------------------
/****** Object:  View dbo.BFOCursorContSale    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOCursorContSale    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFOCursorContSale    Script Date: 09/25/2001 6:04:22 AM ******/
CREATE view [dbo].[BFOCursorContSale]
As
select t1.party_code,t1.product_type,t1.series_code,t1.expirydate,t1.series_id,t1.product_code,t1.sell_buy,t1.tradeqty,sauda_date = Left(Convert(varchar,sauda_date,109),11), /*  t1.price,  */    
pqty = isnull((select sum(tradeqty) from bfosettlement where 
		bfosettlement.party_code = t1.party_code and
                bfosettlement.product_type=t1.product_type and 
                bfosettlement.series_code=t1.series_code and 
                bfosettlement.expirydate=t1.expirydate  and
                bfosettlement.series_id=t1.series_id and  
                bfosettlement.product_code=t1.product_code 
		and Left(Convert(varchar,sauda_date,109),11) = Left(Convert(varchar,t1.sauda_date,109),11)
                and bfosettlement.sell_buy = 1
		),0),
Sqty =isnull( (select sum(tradeqty) from bfosettlement where 
                bfosettlement.party_code = t1.party_code and
                bfosettlement.product_type=t1.product_type and
		bfosettlement.series_code=t1.series_code and
		bfosettlement.expirydate=t1.expirydate and
                bfosettlement.series_id=t1.series_id and 
                bfosettlement.product_code=t1.product_code 
		and Left(Convert(varchar,sauda_date,109),11) = Left(Convert(varchar,t1.sauda_date,109),11)
                and bfosettlement.sell_buy = 2
		),0)
from bfosettlement t1, Client2  where  tradeqty > 0  
and t1.PARTY_CODE = CLIENT2.PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCursorContUnEqualSalePur
-- --------------------------------------------------
/****** Object:  View dbo.BFOCursorContUnEqualSalePur    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOCursorContUnEqualSalePur    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFOCursorContUnEqualSalePur    Script Date: 09/25/2001 6:04:22 AM ******/
CREATE view [dbo].[BFOCursorContUnEqualSalePur] as 
select s1.party_code,s1.product_type,s1.series_code,s1.expirydate,s1.series_id,s1.product_code,sauda_date,
isnull(s1.pqty,0) pqty,isnull(s1.sqty,0) sqty 
from BFOCursorContSale s1 
group by Sauda_date,s1.party_code,s1.product_type,s1.product_code,s1.series_code,s1.series_id,s1.expirydate,Sqty,Pqty

GO

-- --------------------------------------------------
-- VIEW dbo.BFOEXALLOCCONFIRMVIEW
-- --------------------------------------------------
CREATE VIEW [DBO].[BFOEXALLOCCONFIRMVIEW] AS
	SELECT  BFOBROKVIEW_EXALLOCFINAL.TRADE_NO,BFOBROKVIEW_EXALLOCFINAL.PRODUCT_CODE,BFOBROKVIEW_EXALLOCFINAL.PRODUCT_TYPE,
	BFOBROKVIEW_EXALLOCFINAL.ASSET_CODE, BFOBROKVIEW_EXALLOCFINAL.PARTY_CODE,
	BFOBROKVIEW_EXALLOCFINAL.SERIES_CODE,BFOBROKVIEW_EXALLOCFINAL.SERIES_ID,BFOBROKVIEW_EXALLOCFINAL.EXPIRYDATE,BFOBROKVIEW_EXALLOCFINAL.MULTIPLIER,BFOBROKVIEW_EXALLOCFINAL.USER_ID,
	BFOBROKVIEW_EXALLOCFINAL.TRADEQTY,BFOBROKVIEW_EXALLOCFINAL.MARKETRATE,BFOBROKVIEW_EXALLOCFINAL.CL_TYPE,BFOBROKVIEW_EXALLOCFINAL.OPPMEMCODE,
	BFOBROKVIEW_EXALLOCFINAL.OPPTRADERCODE,BFOBROKVIEW_EXALLOCFINAL.TRANS_TYPE,BFOBROKVIEW_EXALLOCFINAL.STRIKE_PRICE,OPTION_TYPE,BFOBROKVIEW_EXALLOCFINAL.SAUDA_DATE,BFOBROKVIEW_EXALLOCFINAL.ORDER_DATE,
	BFOBROKVIEW_EXALLOCFINAL.ORDER_NO,BFOBROKVIEW_EXALLOCFINAL.GROUPID,BFOBROKVIEW_EXALLOCFINAL.TRADERCODE,  
	BFOBROKVIEW_EXALLOCFINAL.TABLE_NO,BFOBROKVIEW_EXALLOCFINAL.LINE_NO,BFOBROKVIEW_EXALLOCFINAL.VAL_PERC,BFOBROKVIEW_EXALLOCFINAL.NORMAL,BFOBROKVIEW_EXALLOCFINAL.DAY_PUC,
	BFOBROKVIEW_EXALLOCFINAL.DAY_SALES,BFOBROKVIEW_EXALLOCFINAL.SETT_PURCH,BFOBROKVIEW_EXALLOCFINAL.SETT_SALES, BFOBROKVIEW_EXALLOCFINAL.SELL_BUY,BFOBROKVIEW_EXALLOCFINAL.SETTFLAG,	
	BROKAPPLIED ,NETRATE = (CASE WHEN BFOBROKVIEW_EXALLOCFINAL.SELL_BUY = 1 
		                    THEN BFOBROKVIEW_EXALLOCFINAL.MARKETRATE + BROKAPPLIED 
				    ELSE BFOBROKVIEW_EXALLOCFINAL.MARKETRATE - BROKAPPLIED 
			       END), 	
	AMOUNT = BFOBROKVIEW_EXALLOCFINAL.TRADEQTY * (CASE WHEN BFOBROKVIEW_EXALLOCFINAL.SELL_BUY = 1 
		      				 THEN ( BFOBROKVIEW_EXALLOCFINAL.MARKETRATE + BROKAPPLIED )
	   	      				 ELSE ( BFOBROKVIEW_EXALLOCFINAL.MARKETRATE - BROKAPPLIED )
		 			    END),  	
	SERTAX,YEAR,EXCHANGE,OFF_PHONE1,	 
	SERVICE_TAX = ((FLOOR ( (BROKAPPLIED*TRADEQTY*MULTIPLIER*BFOBROKVIEW_EXALLOCFINAL.SERVICE_TAX/100 * POWER(10,BFOBROKVIEW_EXALLOCFINAL.ROUND_TO) +
	BFOBROKVIEW_EXALLOCFINAL.ROFIG + BFOBROKVIEW_EXALLOCFINAL.ERRNUM  ) /  (BFOBROKVIEW_EXALLOCFINAL.ROFIG + BFOBROKVIEW_EXALLOCFINAL.NOZERO)) * (BFOBROKVIEW_EXALLOCFINAL.ROFIG +
	BFOBROKVIEW_EXALLOCFINAL.NOZERO) )  / POWER(10,BFOBROKVIEW_EXALLOCFINAL.ROUND_TO)),
	TRADE_AMOUNT = BFOBROKVIEW_EXALLOCFINAL.TRADEQTY * BFOBROKVIEW_EXALLOCFINAL.MARKETRATE,
	BFOBROKVIEW_EXALLOCFINAL.INS_CHRG,BFOBROKVIEW_EXALLOCFINAL.TURN_TAX,BFOBROKVIEW_EXALLOCFINAL.OTHER_CHRG,BFOBROKVIEW_EXALLOCFINAL.SEBI_TAX,BFOBROKVIEW_EXALLOCFINAL.BROKER_CHRG,
	SEC_NAME = BFOBROKVIEW_EXALLOCFINAL.SEC_NAME,CL_RATE = BFOBROKVIEW_EXALLOCFINAL.CL_RATE,CALLPUT,PRO_CLI,O_C_FLAG,C_U_FLAG,
	MARKETTYPE,PRICE = MARKETRATE,AUCTIONPART,PARTICIPANTCODE,OLDPARTYCODE AS BRANCH_ID,MARKETLOT
	FROM BFOBROKVIEW_EXALLOCFINAL

GO

-- --------------------------------------------------
-- VIEW dbo.bfoexallocsalepur
-- --------------------------------------------------
CREATE view [dbo].[bfoexallocsalepur]
as
select  t1.bfoeatrd_party_code,t1.bfoeatrd_Product_type,t1.bfoeatrd_Product_Code,t1.bfoeatrd_Series_Code,t1.bfoeatrd_Series_ID,t1.bfoeatrd_expirydate,t1.bfoeatrd_strike_price ,t1.bfoeatrd_CallPut,
        t1.bfoeatrd_sell_buy, t1.bfoeatrd_tradeqty ,
      bfoeatrd_pqty = isnull((select sum(bfoeatrd_tradeqty) from bfoexalloctrade where 
                bfoexalloctrade.bfoeatrd_party_code = t1.bfoeatrd_party_code and
                bfoexalloctrade.bfoeatrd_Product_Type=t1.bfoeatrd_Product_Type and 
                bfoexalloctrade.bfoeatrd_Product_Code=t1.bfoeatrd_Product_Code and 
                bfoexalloctrade.bfoeatrd_Series_Code=t1.bfoeatrd_Series_Code and 
                bfoexalloctrade.bfoeatrd_Series_ID=t1.bfoeatrd_Series_ID and                 
                bfoexalloctrade.bfoeatrd_expirydate=t1.bfoeatrd_expirydate  and
                bfoexalloctrade.bfoeatrd_strike_price=t1.bfoeatrd_strike_price and  
                bfoexalloctrade.bfoeatrd_Series_Code = t1.bfoeatrd_series_Code  and 
                bfoexalloctrade.bfoeatrd_Series_ID = t1.bfoeatrd_series_ID  and
                bfoexalloctrade.bfoeatrd_Sec_name = t1.bfoeatrd_sec_name  and
                bfoexalloctrade.bfoeatrd_CallPut =t1.bfoeatrd_CallPut 
                and bfoexalloctrade.bfoeatrd_sell_buy = 1),0),
      bfoeatrd_Sqty =isnull( (select sum(bfoeatrd_tradeqty) from bfoexalloctrade where 
                bfoexalloctrade.bfoeatrd_party_code = t1.bfoeatrd_party_code and
                bfoexalloctrade.bfoeatrd_Product_Type=t1.bfoeatrd_Product_Type and
          bfoexalloctrade.bfoeatrd_Product_Code=t1.bfoeatrd_Product_Code and
         bfoexalloctrade.bfoeatrd_Series_Code = t1.bfoeatrd_series_Code  and
                bfoexalloctrade.bfoeatrd_Series_ID = t1.bfoeatrd_series_ID  and
                bfoexalloctrade.bfoeatrd_expirydate=t1.bfoeatrd_expirydate and
                bfoexalloctrade.bfoeatrd_strike_price=t1.bfoeatrd_strike_price and
                bfoexalloctrade.bfoeatrd_Sec_name = t1.bfoeatrd_sec_name  and
                bfoexalloctrade.bfoeatrd_CallPut=t1.bfoeatrd_CallPut
                and bfoexalloctrade.bfoeatrd_sell_buy = 2),0)
from bfoexalloctrade t1

GO

-- --------------------------------------------------
-- VIEW dbo.BFOMARGINCOLL
-- --------------------------------------------------

	CREATE VIEW BFOMARGINCOLL
	AS

	SELECT 
		FILE_DATE	= MARGIN_DATE,
		PARTY_CODE,
		CL_TYPE	=ACCOUNT_TYPE,
		GROUPID	=1,
		MTM_MARGIN	= FINAL_SETTLEMENT_MARGIN,
		MTM_COLL	=0,
		MTM_SHORT	=0,
		INIT_MARGIN	= SPAN_MARGIN,
		IM_COLL	=0,
		IM_SHORT =0,	
		PREMIUM	= NET_PREMIUM,
		PREMIUM_COLL = 0,
		PREMIUM_SHORT = 0,
		RESERVED1	=0,
		RESERVED2	=0,
		RESERVED3	=0,
		RESERVED4	=0,
		RESERVED5	=0,
		PENALITY	=0,
		SERIES_CODE	='',
		PRODUCT_TYPE= '',	
		PRODUCT_CODE='',
		EXP_MARGIN	=0
	FROM 
		BFOMARGIN (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.BFOMARGINCOLL_EXCH
-- --------------------------------------------------
		
	CREATE VIEW BFOMARGINCOLL_EXCH
	AS

	SELECT 
		FILE_DATE	= MARGIN_DATE,
		PARTY_CODE,
		CL_TYPE	=ACCOUNT_TYPE,
		GROUPID	=1,
		MTM_MARGIN	= FINAL_SETTLEMENT_MARGIN,
		MTM_COLL	=0,
		MTM_SHORT	=0,
		INIT_MARGIN	= SPAN_MARGIN,
		IM_COLL	=0,
		IM_SHORT =0,	
		PREMIUM	= NET_PREMIUM,
		PREMIUM_COLL = 0,
		PREMIUM_SHORT = 0,
		RESERVED1	=0,
		RESERVED2	=0,
		RESERVED3	=0,
		RESERVED4	=0,
		RESERVED5	=0,
		PENALITY	=0,
		SERIES_CODE	='',
		PRODUCT_TYPE= '',	
		PRODUCT_CODE='',
		EXP_MARGIN	=0
	FROM 
		BFOMARGIN_EXCH (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.BFoNetPosView
-- --------------------------------------------------
/****** Object:  View dbo.BFoNetPosView    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFoNetPosView    Script Date: 29-Sep-01 8:30:23 PM ******/
/* Created By Sandeep On 20 Aug 2001 used in BFoNetPosPartywiseSp*/
CREATE view [dbo].[BFoNetPosView] as
select s.party_code,s.product_type,s.product_code,s.series_code,s.series_id,s.sauda_date,s.expirydate,
pqty = ( case when sell_buy = 1 then sum(s.tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(s.tradeqty) else 0 end ),netrate
from bfosettlement s, bfoscrip2 s1  
where s1.product_Type = s.product_type 
      and s.product_code = s1.product_code 
      and s.series_code = s1.series_code
      and s.series_id = s1.series_id 
      and s.expirydate = s1.expirydate
group by s.party_code,s.product_type,s.product_code,s.series_code,s.series_id,s.expirydate,s.sauda_date,s.sell_buy,s.netrate

GO

-- --------------------------------------------------
-- VIEW dbo.BFOSALEPUR
-- --------------------------------------------------
/****** Object:  View dbo.BFOSALEPUR    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 8/7/01 8:35:38 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 5/24/01 4:09:46 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 3/28/01 7:40:15 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 3/21/01 1:26:01 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 21-Mar-01 12:07:04 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 3/15/01 10:04:32 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 22-Feb-01 10:10:18 PM ******/
CREATE view [dbo].[BFOSALEPUR] AS
select t1.trade_no,t1.party_code,t1.Series_code,t1.sell_buy,t1.tradeqty,t1.settflag 
from bfotrade t1,client2 c1,bfoscrip2 s2 where
     ( (t1.sell_buy = 1 ) and
         (t1.party_code in ( select t2.party_code from bfotrade t2
                           where
                              (t1.series_code = t2.series_code) 
                              and (t2.sell_buy = 2) 
                            )
          )
       )
       Or
       ((t1.sell_buy = 2 ) and
         (t1.party_code in ( select t2.party_code from bfotrade t2
                           where
                                   (t1.series_code = t2.series_code) 
                                and (t2.sell_buy = 1) 
                            )
         )
        )
 and t1.party_code = c1.party_code  
group by t1.party_code,t1.series_code,t1.sell_buy,t1.tradeqty,t1.Trade_no,t1.settflag

GO

-- --------------------------------------------------
-- VIEW dbo.BFOsalepur1
-- --------------------------------------------------
CREATE view [dbo].[BFOsalepur1] AS
select t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy,
      pqty = isnull((select sum(tradeqty) from bfotrade where 
                bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 1),0),
      Sqty =isnull( (select sum(tradeqty) from bfotrade where 
   
              bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
               and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 2),0),
strikeprice=isnull((select distinct bs.StrikePrice from bfoscrip2 bs where bs.product_code=t1.product_code and bs.product_type=t1.product_type and bs.series_code=t1.series_code and bs.series_id=t1.series_id) ,0) ,
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from bfotrade t1
GROUP BY 
t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy

GO

-- --------------------------------------------------
-- VIEW dbo.bfosettbfview
-- --------------------------------------------------
CREATE view [dbo].[bfosettbfview] as
select Party_Code,s.product_code,s.product_type,s.series_id,s.series_code,s.expirydate,
Pqty=(Case When sell_buy = 1 then sum(tradeqty*s.multiplier) else 0 end),
Sqty=(Case When sell_buy = 2 then sum(tradeqty*s.multiplier) else 0 end),
sauda_date 
from bfosettlement s
where right(ltrim(rtrim(s.product_type)),1) not like 'O%'
group by Party_Code,s.product_code,s.product_type,s.series_id,s.series_code,s.expirydate,
sell_buy,expirydate,sauda_date

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSale
-- --------------------------------------------------
CREATE view [dbo].[BFoSettSale] As 
select t1.party_code,t1.product_type,t1.series_code,t1.expirydate,t1.sell_buy,
PQty = (Case When Sell_buy = 1 Then sum(tradeqty) else 0 end ),
SQty = (Case When Sell_buy = 2 Then sum(tradeqty) else 0 end ),
SDate = Left(Convert(Varchar,sauda_date,109),11),product_code,series_id,
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
Strike_Price
from BfoSettlement t1 
GROUP BY t1.party_code,t1.product_type,t1.series_code,t1.expirydate,t1.sell_buy,Left(Convert(Varchar,sauda_date,109),11)
,product_code,series_id,Strike_Price

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSaleexpiry
-- --------------------------------------------------
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 8/7/01 8:35:38 PM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 8/7/01 5:47:28 PM ******/
CREATE view [dbo].[BFoSettSaleexpiry] As 
select t1.party_code,t1.series_code,t1.sell_buy,
PQty = (Case When Sell_buy = 1 Then sum(tradeqty) else 0 end ),
SQty = (Case When Sell_buy = 2 Then sum(tradeqty) else 0 end ),
SDate = Left(Convert(Varchar,sauda_date,109),11),
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from Bfofuttrade t1 
GROUP BY  t1.party_code,t1.series_code,t1.sell_buy,Left(Convert(Varchar,sauda_date,109),11)

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSalePur
-- --------------------------------------------------
/****** Object:  View dbo.BFoSettSalePur    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFoSettSalePur    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFoSettSalePur    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BFoSettSalePur    Script Date: 8/7/01 8:35:38 PM ******/
CREATE view [dbo].[BFoSettSalePur] As 
select t1.party_code,t1.series_code,
PQty = Sum(Pqty),SQty = Sum(Sqty),SDate,PRATE=SUM(PRATE),SRATE=SUM(SRATE)
from BFoSettSale t1 GROUP BY t1.party_code,t1.series_code,SDate

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSalePur1
-- --------------------------------------------------
CREATE view [dbo].[BFoSettSalePur1] As
SELECT party_code,product_type,product_code,expirydate,PQty=SUM(PQty),SQty=Sum(SQty),SDate,Series_code,series_id,strike_price
FROM BFoSettSale
group by party_code,product_type,product_code,expirydate,SDate,Series_code,series_id,strike_price

GO

-- --------------------------------------------------
-- VIEW dbo.BfosettsalepurSum
-- --------------------------------------------------
/****** Object:  View dbo.BfosettsalepurSum    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BfosettsalepurSum    Script Date: 29-Sep-01 8:30:24 PM ******/
/****** Object:  View dbo.BfosettsalepurSum    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BfosettsalepurSum    Script Date: 8/7/01 8:35:38 PM ******/
CREATE view [dbo].[BfosettsalepurSum] as
select  t1.party_code,t1.series_code,
      pqty=sum(pqty),
      sqty=sum(sqty),sdate,
       PRATE=SUM(PRATE),
      SRATE=SUM(SRATE)
    
from Bfosettsalepur t1
GROUP BY
t1.party_code,t1.series_code,t1.sdate

GO

-- --------------------------------------------------
-- VIEW dbo.BFOSETTVIEW
-- --------------------------------------------------
/****** Object:  View dbo.BFOSETTVIEW    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOSETTVIEW    Script Date: 29-Sep-01 8:30:24 PM ******/
/****** Object:  View dbo.BFOSETTVIEW    Script Date: 09/25/2001 6:04:21 AM ******/
CREATE view [dbo].[BFOSETTVIEW] AS
SELECT distinct  ContractNo,BillNo,F.Trade_no,F.Product_code,F.Product_type,F.Party_code,F.Series_code,F.Series_id,s2.Expirydate,F.user_id,
Tradeqty,AuctionPart,MarketType,Series,Order_no,MarketRate,strike_price,Sauda_date,F.Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,
Sett_purch,Sett_sales,F.sell_buy,F.SettFlag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,F.other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,
sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,F.Cl_type,F.Order_Date, F.OppMemCode,F.OppTraderCode,F.Cl_rate,F.groupid,F.tradercode,
MPrice = (CASE WHEN C2.Dummy1 = 0 
               THEN MarketRate 
               Else
		    (Case When C2.Dummy1 = 1 
    		          Then (Case When s2.StrikePrice = 0 Then F.Marketrate Else s2.StrikePrice End )    
                  	  Else s2.Strikeprice + MarketRate
      		    END)
   	  END),
MultiPlier = ( Case When ( c2.Brok_Scheme = 4 or c2.Brok_Scheme = 5 or c2.Brok_Scheme = 6 or c2.Brok_scheme=1 or c2.Brok_Scheme=2 or c2.Brok_Scheme=3) 
  		    Then ceiling(Convert(numeric(19,2),TradeQty) / Convert(numeric(19,2),s2.marketLot)) 
  		    Else  1
       	      End) ,
TaxPrice = (CASE WHEN TaxesFlag = 0 
	       THEN marketrate 
	       Else
		   (Case When TaxesFlag = 1 
			 Then (Case When F.Strike_Price = 0 Then F.marketrate Else F.Strike_Price End ) 				
	                		 Else F.marketrate + marketrate
		    END)
	  END) 
from BFosettlement F, Client2 C2,BFoScrip2 S2,Client1 C1,BFOOwner
where c2.Party_Code = F.Party_Code 
and C1.Cl_Code = C2.Cl_Code
and F.Product_type = S2.Product_type
and F.Product_code=s2.product_code
AND F.series_code = S2.series_code
AND F.series_id = S2.series_id

GO

-- --------------------------------------------------
-- VIEW dbo.Bfounequalsalepur1
-- --------------------------------------------------
CREATE view [dbo].[Bfounequalsalepur1] as   
select  s1.party_code,s1.product_type,s1.product_code,s1.series_code,s1.series_id,s1.sell_buy,  
              isnull(s1.pqty,0) pqty,isnull(s1.sqty,0) sqty   
 from BFOASALEPUR2 s1,client2 client2  
 where  isnull(s1.pqty,0) <> isnull(s1.sqty,0)  
          and client2.party_code = s1.party_code  
GROUP BY s1.party_code,s1.product_type,s1.product_code,s1.series_code,s1.series_id,s1.sell_buy,s1.pqty,s1.sqty

GO

-- --------------------------------------------------
-- VIEW dbo.bOptionExAllocView
-- --------------------------------------------------
CREATE view [dbo].[bOptionExAllocView]
as 
select s.party_code,s.Product_type,s.Product_Code,s.Series_Code,s.Series_ID,s.strike_price,s.MarketType,s.expirydate,
pqty = ( case when s.sell_buy = 1 then sum(s.tradeqty*s.multiplier) else 0 end ),
sqty = ( case when s.sell_buy = 2 then sum(s.tradeqty*s.multiplier) else 0 end ),
Nsertax = ( case when s.billflag>3 then sum(s.nsertax) else 0 end ),
nbrokapp = ( case when s.billflag > 3 then sum(s.nbrokapp*s.tradeqty) else 0 end ),s.billflag,
cl_rate = isnull(( select bfofinalclosing.cl_rate from bfofinalclosing
                         where bfofinalclosing.closingdate like s.expirydate
                           and bfoscrip2.maturitydate like bfofinalclosing.closingdate
                                        and bfofinalclosing.Series_Code=s.Series_Code   
           ),0)
from bfosettlement s, bfoscrip2
where right(s.Product_type,3) = 'IO'
and right(bfoscrip2.Product_type,3) = 'IO'
and bfoscrip2.Product_Code = s.Product_Code
and bfoscrip2.Product_type = s.Product_type
and bfoscrip2.Series_Code = s.Series_Code
and bfoscrip2.Series_ID = s.Series_ID
and bfoscrip2.strikeprice = s.strike_price
and bfoscrip2.expirydate = s.expirydate
group by s.party_code,s.Product_type,s.Product_Code,s.Series_Code,s.Series_ID,s.strike_price,s.MarketType,s.expirydate,s.sell_buy,s.billflag,bfoscrip2.maturitydate,s.multiplier

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT2_VIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[CLIENT2_VIEW] AS
SELECT * FROM CLIENT2 (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLOSING
-- --------------------------------------------------
CREATE VIEW CLOSING AS  
SELECT * FROM ANAND1.MSAJAG.DBO.CLOSING (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_BROKTABLE_VIEW
-- --------------------------------------------------


CREATE VIEW [dbo].[CLS_BROKTABLE_VIEW] AS
SELECT 
	TABLE_NO,TABLE_NAME = CONVERT(VARCHAR,TABLE_NO) + ' - ' + TABLE_NAME,
	SRNO = LINE_NO,VALUE  = CONVERT(VARCHAR,LOWER_LIM) + '-' + CONVERT(VARCHAR,UPPER_LIM),
	DAY_BUY = CONVERT(VARCHAR,DAY_PUC) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	DAY_SELL = CONVERT(VARCHAR,DAY_SALES) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	SETT_BUY = CONVERT(VARCHAR,SETT_PURCH) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	SETT_SELL = CONVERT(VARCHAR,SETT_SALES) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	DELIVERY = CONVERT(VARCHAR,NORMAL) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END
FROM BROKTABLE (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_OWNER
-- --------------------------------------------------
CREATE VIEW [DBO].[CLS_OWNER]  

AS  

SELECT * FROM BFOOWNER

GO

-- --------------------------------------------------
-- VIEW dbo.FOACCBILL
-- --------------------------------------------------


CREATE VIEW [dbo].[FOACCBILL] AS
SELECT * FROM BFOACCBILL

GO

-- --------------------------------------------------
-- VIEW dbo.FOBILLVALAN
-- --------------------------------------------------

CREATE VIEW [dbo].[FOBILLVALAN] AS

SELECT 
	PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE=PRODUCT_CODE,SYMBOL=SERIES_CODE,
	EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MATURITYDATE,SAUDA_DATE,ISIN='',PQTY,SQTY,PRATE,
	SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,EXCL_CHRG,SERVICE_TAX,
	EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,
	TERMINAL_ID='',FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,STATUSNAME='',EXCHANGE='',SEGMENT='',MEMBERTYPE='',
	COMPANYNAME='',REGION,UPDATEDATE,EMAIL,SBU='',RELMGR='',GRP='',SECTOR='',CMCLOSING=CL_RATE,TRACK='',AREA
FROM BFOBILLVALAN (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOEXERCISEALLOCATION
-- --------------------------------------------------

CREATE VIEW FOEXERCISEALLOCATION AS  
SELECT   
 FOEA_TABLE_NO = 0,  
 FOEA_POSITION_DATE = POSITION_DATE,  
 FOEA_DESC = '''',  
 FOEA_SEGMENT_IND = SEGMENT,  
 FOEA_SETT_TYPE = SETT_TYPE,  
 FOEA_CM_CODE = CM_CODE,  
 FOEA_MEM_TYPE = MEMBER_TYPE,  
 FOEA_TM_CODE = TM_CODE,  
 FOEA_ACC_TYPE = ACCOUNT_TYPE,  
 FOEA_PARTY_CODE = PARTY_CODE,  
 FOEA_INST_TYPE = PRODUCT_CODE,  
 FOEA_SYMBOL = SERIES_CODE,  
 FOEA_EXPIRYDATE = EXPIRYDATE,  
 FOEA_STRIKE_PRICE = STRIKE_PRICE,  
 FOEA_OPTION_TYPE = OPTION_TYPE,  
 --FOEA_COR_ACT_LEVEL = CA_LEVEL,  
 FOEA_PREEXALL_LONGQTY = PRE_LONG_QTY,  
 FOEA_PREEXALL_SHORTQTY = PRE_SHORT_QTY,  
 FOEA_EXERCISE_QTY = EXERCISED_QTY,  
 FOEA_ALLOC_QTY = ASSIGNED_QTY,  
 FOEA_POSTEXALL_LONGQTY = POST_LONG_QTY,  
 FOEA_POSTEXALL_SHORTQTY = POST_SHORT_QTY,  
 FOEA_BROUGHT_FORWARD_LONG_QUANTITY = BF_LONG_QTY,  
 FOEA_BROUGHT_FORWARD_LONG_VALUE = BF_LONG_VALUE,  
 FOEA_BROUGHT_FORWARD_SHORT_QUANTITY = BF_SHORT_QTY,  
 FOEA_BROUGHT_FORWARD_SHORT_VALUE = BF_SHORT_VALUE,  
 FOEA_DAY_BUY_OPEN_QUANTITY = DAY_BUY_QTY,  
 FOEA_DAY_BUY_OPEN_VALUE = DAY_BUY_VALUE,  
 FOEA_DAY_SELL_OPEN_QUANTITY = DAY_SELL_QTY,  
 FOEA_DAY_SELL_OPEN_VALUE = DAY_SELL_VALUE,  
 FOEA_PREEXALL_LONGVALUE = PRE_LONG_VALUE,  
 FOEA_PREEXALL_SHORTVALUE = PRE_SHORT_VALUE,  
 FOEA_POSTEXALL_LONGVALUE = POST_LONG_VALUE,  
 FOEA_POSTEXALL_SHORTVALUE = POST_SHORT_VALUE,  
 FOEA_SETTLEMENTPRICE = SETTLEMENT_PRICE,  
 FOEA_NETPREMIUM = NET_PREMIUM,  
 FOEA_DAILY_MTM_SETTLEMENT_VALUE = DAILY_MTM_SETTLEMENT_VALUE,  
 FOEA_FUTURES_FINAL_SETTLEMENT_VALUE = FINAL_SETTLEMENT_VALUE,  
 FOEA_EXERCISED_ASSIGNED_VALUE = EXERCISED_ASSIGNED_VALUE  
FROM BFOEXERCISEALLOCATION (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOEXERCISEALLOCATION_31012012
-- --------------------------------------------------
  
  
CREATE VIEW FOEXERCISEALLOCATION_31012012 AS  
  
SELECT   
 FOEA_TABLE_NO = 0,  
 FOEA_POSITION_DATE = POSITION_DATE,  
 FOEA_DESC = '',  
 FOEA_SEGMENT_IND = SEGMENT,  
 FOEA_SETT_TYPE = SETT_TYPE,  
 FOEA_CM_CODE = CM_CODE,  
 FOEA_MEM_TYPE = MEMBER_TYPE,  
 FOEA_TM_CODE = TM_CODE,  
 FOEA_ACC_TYPE = ACCOUNT_TYPE,  
 FOEA_PARTY_CODE = PARTY_CODE,  
 FOEA_INST_TYPE = PRODUCT_CODE,  
 FOEA_SYMBOL = SERIES_CODE,  
 FOEA_EXPIRYDATE = EXPIRYDATE,  
 FOEA_STRIKE_PRICE = STRIKE_PRICE,  
 FOEA_OPTION_TYPE = OPTION_TYPE,  
 --FOEA_COR_ACT_LEVEL = CA_LEVEL,  
 FOEA_PREEXALL_LONGQTY = PRE_LONG_QTY,  
 FOEA_PREEXALL_SHORTQTY = PRE_SHORT_QTY,  
 FOEA_EXERCISE_QTY = EXERCISED_QTY,  
 FOEA_ALLOC_QTY = ASSIGNED_QTY,  
 FOEA_POSTEXALL_LONGQTY = POST_LONG_QTY,  
 FOEA_POSTEXALL_SHORTQTY = POST_SHORT_QTY,  
 FOEA_BROUGHT_FORWARD_LONG_QUANTITY = BF_LONG_QTY,  
 FOEA_BROUGHT_FORWARD_LONG_VALUE = BF_LONG_VALUE,  
 FOEA_BROUGHT_FORWARD_SHORT_QUANTITY = BF_SHORT_QTY,  
 FOEA_BROUGHT_FORWARD_SHORT_VALUE = BF_SHORT_VALUE,  
 FOEA_DAY_BUY_OPEN_QUANTITY = DAY_BUY_QTY,  
 FOEA_DAY_BUY_OPEN_VALUE = DAY_BUY_VALUE,  
 FOEA_DAY_SELL_OPEN_QUANTITY = DAY_SELL_QTY,  
 FOEA_DAY_SELL_OPEN_VALUE = DAY_SELL_VALUE,  
 FOEA_PREEXALL_LONGVALUE = PRE_LONG_VALUE,  
 FOEA_PREEXALL_SHORTVALUE = PRE_SHORT_VALUE,  
 FOEA_POSTEXALL_LONGVALUE = POST_LONG_VALUE,  
 FOEA_POSTEXALL_SHORTVALUE = POST_SHORT_VALUE,  
 FOEA_SETTLEMENTPRICE = SETTLEMENT_PRICE,  
 FOEA_NETPREMIUM = NET_PREMIUM,  
 FOEA_DAILY_MTM_SETTLEMENT_VALUE = DAILY_MTM_SETTLEMENT_VALUE,  
 FOEA_FUTURES_FINAL_SETTLEMENT_VALUE = FINAL_SETTLEMENT_VALUE,  
 FOEA_EXERCISED_ASSIGNED_VALUE = EXERCISED_ASSIGNED_VALUE  
FROM BFOEXERCISEALLOCATION (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOGLOBALS
-- --------------------------------------------------
CREATE VIEW [dbo].[FOGLOBALS] AS
SELECT * FROM BFOGLOBALS

GO

-- --------------------------------------------------
-- VIEW dbo.FOMARGINNEW
-- --------------------------------------------------
CREATE VIEW [dbo].[FOMARGINNEW]  
AS  
SELECT PARTY_CODE,  
SPREADMARGIN = SPAN_MARGIN,  
NONSPREADMARGIN = NET_PREMIUM,  
TOTALMARGIN = SPAN_MARGIN + NET_PREMIUM,  
PMARGIN = 0,  
MDATE = MARGIN_DATE,  
PMARGINAMOUNT = SPAN_MARGIN,  
PSPANMARGIN = SPAN_MARGIN,  
CL_TYPE = ACCOUNT_TYPE,  
MTOM = EXTREME_LOSS_MARGIN,  
ADDMARGIN = 0  
FROM BFOMARGIN

GO

-- --------------------------------------------------
-- VIEW dbo.FOMARGINNEW_VIEW
-- --------------------------------------------------

CREATE VIEW [dbo].[FOMARGINNEW_VIEW] AS

SELECT * FROM FOMARGINNEW (NOLOCK)

--SELECT *,ADDMARGIN = 0 FROM FOMARGINNEW (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOOWNER
-- --------------------------------------------------
CREATE VIEW [DBO].[FOOWNER] AS
SELECT * FROM BFOOWNER (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOSCRIP2
-- --------------------------------------------------


CREATE VIEW [dbo].[FOSCRIP2] 
AS

	SELECT
		INST_TYPE = BFS2.PRODUCT_CODE,
		SYMBOL = SERIES_CODE,
		SEC_NAME = SERIES_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE ,
		STARTDATE ,
		MATURITYDATE,
		SERIES = '',
		COR_ACT_LEVEL = 0,
		C_REGULAR_LOT = BFS2.MINIMUM_LOT_SIZE,
		C_ISSUE_MAT_DT= MATURITYDATE,
		C_U_INST_TYPE = BFS2.PRODUCT_CODE,
		C_U_SYMBOL = SERIES_CODE,
		C_U_SERIES = '',
		C_U_EXPIRYDATE = EXPIRYDATE,
		C_U_STRIKEPRICE = STRIKE_PRICE,
		C_U_OPTION_TYPE = OPTION_TYPE,
		C_U_CAL = 0,
		SCRIP_ID = ISNULL(BFS1.SCRIP_ID,''),
		PRODUCT_TYPE = (CASE 
							WHEN PRODUCT_TYPE = 'IF' THEN 'FUTIDX'
							WHEN PRODUCT_TYPE = 'IO' THEN 'OPTIDX'
							WHEN PRODUCT_TYPE = 'EO' THEN 'OPTSTK'
							WHEN PRODUCT_TYPE = 'EF' THEN 'FUTSTK'
							ELSE PRODUCT_TYPE
						END)
	FROM 
		BFOSCRIP2 BFS2 (NOLOCK)
		
			LEFT OUTER JOIN 
			(
				SELECT 
					DISTINCT UL_ASSET_CODE, SCRIP_ID
				FROM
					BFOSCRIP1 (NOLOCK) 
			) BFS1
			ON
			(
				UL_ASSET_CODE = REPLACE(REPLACE(BFS2.PRODUCT_CODE,'FUT',''),'OPT','')
			)

GO

-- --------------------------------------------------
-- VIEW dbo.FOSETTLEMENT
-- --------------------------------------------------


CREATE VIEW [dbo].[FOSETTLEMENT] AS

SELECT 
	SRNO,CONTRACTNO,BILLNO=LOT_SIZE,TRADE_NO,PARTY_CODE,
	INST_TYPE = PRODUCT_CODE,
	SYMBOL=SERIES_CODE,SEC_NAME=SERIES_CODE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	USER_ID=LOCATIONID,PRO_CLI,O_C_FLAG=0,C_U_FLAG=0,TRADEQTY,AUCTIONPART ,
	MARKETTYPE='1',SERIES=0,ORDER_NO,PRICE=TRADE_PRICE,SAUDA_DATE,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,
	BROKAPPLIED,NETRATE,AMOUNT=TRADEQTY*TRADE_PRICE,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,
	BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG=1,SETT_NO=0,NBROKAPP=BROKAPPLIED,NSERTAX=SERVICE_TAX,
	N_NETRATE=NETRATE,SETT_TYPE='F',CL_RATE=0,PARTICIPANTCODE,STATUS,CPID=RIGHT(ORDER_TIMESTAMP,8),INSTRUMENT=1,
	BOOKTYPE=1,BRANCH_ID=PARTY_CODE,TMARK='N',SCHEME=0,DUMMY1,DUMMY2,S.RESERVED1,RESERVED2=0
FROM
	BFOSETTLEMENT S (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOTAXES
-- --------------------------------------------------


CREATE VIEW FOTAXES AS
SELECT * FROM BFOTAXES

GO

-- --------------------------------------------------
-- VIEW dbo.FOTRADE
-- --------------------------------------------------


CREATE VIEW FOTRADE 

	AS

	SELECT
		TRADE_NO,
		STATUS = '',
		INST_TYPE = PRODUCT_CODE,
		SYMBOL = SERIES_CODE,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE ,
		SEC_NAME = SERIES_CODE,
		BOOKTYPE = 0,
		BOOKTYPENAME = 0,
		MARKETTYPE = 0,
		USER_ID=TERMINALID,
		BRANCH_ID = 0,
		SELL_BUY,
		TRADEQTY,
		PRICE=TRADE_PRICE,
		PRO_CLI = 0,
		PARTY_CODE,
		PARTICIPANTCODE,
		O_C_FLAG = 0,
		C_U_FLAG = 0,
		ACTIVITYTIME = SAUDA_DATE,
		LAST_MOD_TIME = ORDER_TIMESTAMP,
		ORDER_NO,
		OPP_BROKER_ID = '',
		SETTFLAG,
		MEMBERCODE=CM_CODE,
		TMPARTYCODE=PARTY_CODE,
		RESERVED1,
		RESERVED2,
		RESERVED3,
		RESERVED4,
		TRANS_TYPE = RESERVED5
	FROM 
		BFOTRADE (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOTRADE_DELLOG
-- --------------------------------------------------
CREATE VIEW [dbo].[FOTRADE_DELLOG]
AS
SELECT 
	TRADE_NO,
	STATUS,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	SEC_NAME,
	BOOKTYPE,
	BOOKTYPENAME,
	MARKETTYPE,
	USER_ID,
	BRANCH_ID,
	SELL_BUY,
	TRADEQTY,
	PRICE,
	PRO_CLI,
	PARTY_CODE,
	PARTICIPANTCODE,
	O_C_FLAG,
	C_U_FLAG,
	ACTIVITYTIME,
	LAST_MOD_TIME,
	ORDER_NO,
	OPP_BROKER_ID,
	SETTFLAG,
	MEMBERCODE,
	TMPARTYCODE,
	RESERVED1,
	RESERVED2,
	RESERVED3,
	RESERVED4,
	RESERVED5,
	DEL_ON,
	DEL_IP
FROM
	BFOTRADE_DELLOG

GO

-- --------------------------------------------------
-- VIEW dbo.MULTICOMPANY
-- --------------------------------------------------
CREATE  VIEW [dbo].[MULTICOMPANY]
AS
SELECT * FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE ='BSE'AND SEGMENT='FUTURES'

GO

-- --------------------------------------------------
-- VIEW dbo.OPEN_BILL_DATES
-- --------------------------------------------------
CREATE VIEW OPEN_BILL_DATES
AS
	SELECT DISTINCT BILLDATE, FUNDS_PAYIN = PAYIN_DATE FROM BFOACCBILL

GO

-- --------------------------------------------------
-- VIEW dbo.OWNER
-- --------------------------------------------------
CREATE VIEW [DBO].[OWNER]
AS
SELECT * FROM BFOOWNER

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MParty
-- --------------------------------------------------
CREATE   View [dbo].[Rpt_View_NewM2MParty] AS     
Select bfoea_position_date=Sauda_date,bfoea_party_code=BFoBillValan.Party_Code,    
bfoea_NetPremium=0,  
bfoea_Daily_MTM_Settlement_Value=isnull(Premium,0)  ,  
bfoea_Futures_Final_Settlement_Value=isnull(mtm_margin,0),  
bfoea_Exercised_Assigned_Value=0   
From BFoBillValan
Left Outer Join
(
	Select File_Date,Party_Code,mtm_margin=abs(sum(mtm_margin)),Premium=sum(Premium)
	From bfomargincoll Group By  File_Date,Party_Code
) bfomargincoll
On
( 
	File_Date like Left(Convert(VarChar, sauda_date, 109),11) + '%'   
	and bfomargincoll.Party_Code = BFoBillValan.Party_Code
)
Group By Sauda_Date,BFoBillValan.Party_Code,mtm_margin,Premium

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MScrip
-- --------------------------------------------------
CREATE  View [dbo].[Rpt_View_NewM2MScrip] AS     
Select bfoea_position_date=Sauda_Date,bfoea_series_code=Series_Code,
bfoea_Product_code = Product_Code,bfoea_expirydate=ExpiryDate,
bfoea_strike_price=Strike_price,bfoea_product_type=Product_Type,
bfoea_NetPremium=Premium,
bfoea_Daily_MTM_Settlement_Value=mtm_margin,    
bfoea_Futures_Final_Settlement_Value=0 ,
bfoea_Exercised_Assigned_Value=0    

From BFoBillValan,
(
	Select File_Date,Party_Code,mtm_margin=sum(mtm_margin),Premium=sum(Premium)
	From bfomargincoll Group By  File_Date,Party_Code
) bfomargincoll

where 
File_Date like Left(Convert(VarChar, sauda_date, 109),11) + '%'   
and bfomargincoll.Party_Code = BFoBillValan.Party_Code
Group By Product_code,Sauda_Date,Series_Code,ExpiryDate,Strike_Price,Product_Type,
Premium,mtm_margin

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MScripParty
-- --------------------------------------------------
CREATE  View [dbo].[Rpt_View_NewM2MScripParty] AS     
Select bfoea_position_date=Sauda_Date,bfoea_series_code=Series_Code,
bfoea_party_code=BFoBillValan.Party_Code, 
bfoea_Product_code = Product_Code,bfoea_expirydate=ExpiryDate,
bfoea_strike_price=Strike_price,bfoea_product_type=Product_Type,
bfoea_NetPremium=Premium,  
bfoea_Daily_MTM_Settlement_Value=mtm_margin,    
bfoea_Futures_Final_Settlement_Value=0 ,
bfoea_Exercised_Assigned_Value=0    

From BFoBillValan,
(
	Select File_Date,Party_Code,mtm_margin=sum(mtm_margin),Premium=sum(Premium)
	From bfomargincoll Group By  File_Date,Party_Code
) bfomargincoll
 where 
File_Date like Left(Convert(VarChar, sauda_date, 109),11) + '%'   
and bfomargincoll.Party_Code = BFoBillValan.Party_Code
Group By BFoBillValan.Party_Code,Product_code,Sauda_Date,Series_Code,ExpiryDate,Strike_Price,
Product_Type,mtm_margin,Premium

GO

-- --------------------------------------------------
-- VIEW dbo.TBL_CLIENTMARGIN_VIEW
-- --------------------------------------------------


CREATE VIEW [dbo].[TBL_CLIENTMARGIN_VIEW] AS

SELECT * FROM TBL_CLIENTMARGIN (NOLOCK)

--SELECT *,ADDMARGIN = 0 FROM TBL_CLIENTMARGIN (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.TRADERS
-- --------------------------------------------------
CREATE VIEW [dbo].[TRADERS] AS
SELECT 
	BRANCH_CD,TRADER_CODE = SHORT_NAME,LONG_NAME,ADDRESS1,ADDRESS2,CITY,STATE,NATION,ZIP,PHONE1,PHONE2,FAX,EMAIL,[REMOTE]
	SECURITY_NET,MONEY_NET,EXCISE_REG,CONTACT_PERSON,COM_PERC,TERMINAL_ID,DEFTRADER
FROM BRANCHES

GO

-- --------------------------------------------------
-- VIEW dbo.V2_CLASS_VW_ENTITYMASTER
-- --------------------------------------------------
CREATE VIEW [dbo].[V2_CLASS_VW_ENTITYMASTER]     
    
AS    
    
  SELECT ENT_CODE = 'BROKER',    
         ENT_NAME = 'BROKER',     
         ENT_TYPE = 'BROKER',     
         ORDER_BY = 1      
  FROM   OWNER  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = BRANCH_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'BRANCH' ,     
         ORDER_BY = 2      
  FROM   BRANCH   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SHORT_NAME,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'TRADER',     
         ORDER_BY = 4        
  FROM   BRANCHES   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SUB_BROKER,    
         ENT_NAME = [NAME],     
         ENT_TYPE = 'SUBBROKER',     
         ORDER_BY = 3        
  FROM   SUBBROKERS  (NOLOCK)   
  UNION ALL     
  SELECT DISTINCT ENT_CODE = AREACODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'AREA',     
         ORDER_BY = 7        
  FROM   AREA   (NOLOCK)  
  UNION ALL     
  SELECT DISTINCT ENT_CODE = REGIONCODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'REGION',     
         ORDER_BY = 8        
  FROM   REGION   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = CL_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'CLIENT',     
         ORDER_BY = 5        
  FROM   CLIENT1  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = FAMILY,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'FAMILY',     
         ORDER_BY = 6        
  FROM   CLIENT1  (NOLOCK)  
  WHERE  CL_CODE = FAMILY    
  UNION ALL     
    
  SELECT ENT_CODE = CL_TYPE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLTYPE',     
         ORDER_BY = 9        
  FROM   CLIENTTYPE   (NOLOCK)   
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'GROUP',     
         ORDER_BY = 10        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'GROUP'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'RELMGR',     
         ORDER_BY = 11        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'RELMGR'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'SBU',     
         ORDER_BY = 12        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'SBU'    
  UNION ALL     
  SELECT ENT_CODE = CL_STATUS,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLSTATUS',     
         ORDER_BY = 13        
  FROM  CLIENTSTATUS   (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_MAPPING_TABLE
-- --------------------------------------------------
CREATE VIEW Vw_MAPPING_TABLE AS  
  
SELECT * FROM  MSAJAG.DBO.MAPPING_TABLE

GO

