-- DDL Export
-- Server: 10.254.33.61
-- Database: NXT_Admin
-- Exported: 2026-02-05T11:35:14.250094

USE NXT_Admin;
GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_Get_StartData
-- --------------------------------------------------

CREATE function [dbo].[fn_Get_StartData]
(
	@period varchar(20) ='MTD'
)
/*
select convert(Date,DateAdd(yy, -1, dateadd(d,1,getdate()))) StartDate
select dbo.fn_Get_StartData('YTD')
select dbo.fn_Get_StartData('MTD')
select dbo.fn_Get_StartData('yTD')
*/
returns date
AS
BEGIN
	declare @rdate datetime = getdate()
	if (@period = 'YTD')
	BEGIN

	--select @rdate=convert(Date,DateAdd(yy, -1, dateadd(d,1,getdate())))

		select @rdate=cast(DateAdd(yy, -1,DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))-1),
DATEADD(mm,1,getdate()))) as date)
		--set @rdate = cast('01-Apr-' +
		--		cast(case
		--				when datepart(mm,getdate()) in (4,5,6,7,8,9,10,11,12) 
		--			then DATEPART(yy,getdate()) 
		--			else DATEPART(yy,getdate())-1 
		--			end as varchar
		--		) as date) 
	END
	ELSE
		if (@period = 'MTD')
	BEGIN
		set @rdate = cast(DATEADD(month, DATEDIFF(month, 0, getdate()), 0) as date) 
	END

	ElSE

	Begin 
		set @rdate = '1900-01-01'
	End

	return @rdate ;
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_NavDetails
-- --------------------------------------------------
CREATE FUNCTION fn_NavDetails (
@Scheme_code VARCHAR(50),
@fund_code VARCHAR(50))
RETURNS TABLE
AS
RETURN
	SELECT T.fund_code,	T.Scheme_code , T.NAV_Date NAV_Date , NAV.NAV 
	from MutualFund..vw_NAV NAV WITH (NOLOCK)
	inner join 
	(
	SELECT fund_code,	Scheme_code , convert(date,max(NAV_Date)) NAV_Date 
	FROM MutualFund..vw_NAV WITH (NOLOCK)
	GROUP BY fund_code,	Scheme_code
	) T ON convert(date,NAV.NAV_Date)=T.NAV_Date
	and NAV.fund_code=T.fund_code 
	and NAV.Scheme_code=T.Scheme_code
	WHERE NAV.scheme_code = @Scheme_code 
	AND NAV.fund_code = @fund_code

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_NavDetails_New
-- --------------------------------------------------
create  FUNCTION [dbo].[fn_NavDetails_New] (
@Scheme_code VARCHAR(50),
@fund_code VARCHAR(50))
--RETURNS TABLE
RETURNS numeric(10,6)
AS
BEGIN 


Declare @NAV numeric(10,6)

	SELECT @NAV=NAV.NAV 
	from MutualFund..vw_NAV NAV WITH (NOLOCK)
	inner join 
	(
	SELECT fund_code,	Scheme_code , convert(date,max(NAV_Date)) NAV_Date 
	FROM MutualFund..vw_NAV WITH (NOLOCK)
	GROUP BY fund_code,	Scheme_code
	) T ON convert(date,NAV.NAV_Date)=T.NAV_Date
	and NAV.fund_code=T.fund_code 
	and NAV.Scheme_code=T.Scheme_code
	WHERE 
		NAV.scheme_code = @Scheme_code 
		AND NAV.fund_code = @fund_code


RETURN @NAV
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_Split1
-- --------------------------------------------------




Create FUNCTION [dbo].[fn_Split1](@text VARCHAR(MAX),  @delimiter VARCHAR(1) = ',') 
RETURNS @Strings TABLE
(   
	 StringValue VARCHAR(MAX)
)
AS

BEGIN
	DECLARE @index INT = -1 

	WHILE (LEN(@text) > 0)
	BEGIN  
		SET @index = CHARINDEX(@delimiter,@text)  

		IF (@index = 0) AND (LEN(@text) > 0)  
		BEGIN   
			INSERT INTO @Strings
			VALUES (LTRIM(RTRIM(@text)))
			BREAK  
		END

		IF (@index > 1)  
		  BEGIN   
			INSERT INTO @Strings
			VALUES (LTRIM(RTRIM(LEFT(@text,@index - 1))))   
			SET @text = RIGHT(@text, (LEN(@text) - @index))  
		  END  
		ELSE 
		  SET @text = RIGHT(@text, (LEN(@text) - @index)) 
		END

		RETURN
	END

GO

-- --------------------------------------------------
-- INDEX dbo.ActionMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ActionMaster_ActionName] ON [dbo].[ActionMaster] ([ActionName])

GO

-- --------------------------------------------------
-- INDEX dbo.ControllerMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ControllerMaster_ControllerName] ON [dbo].[ControllerMaster] ([ControllerName])

GO

-- --------------------------------------------------
-- INDEX dbo.IWMF_trn_current_holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_IWMF_trn_current_holding_party_Code] ON [dbo].[IWMF_trn_current_holding] ([party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.ModuleMappingMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ModuleMappingMaster_Moduleid] ON [dbo].[ModuleMappingMaster] ([ModuleId], [ControllerId], [ActionId])

GO

-- --------------------------------------------------
-- INDEX dbo.ModuleMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ModuleMaster_Moduleid] ON [dbo].[ModuleMaster] ([ModuleId], [ModuleName])

GO

-- --------------------------------------------------
-- INDEX dbo.ModuleRoleMapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ModuleRoleMapping_Active] ON [dbo].[ModuleRoleMapping] ([Active])

GO

-- --------------------------------------------------
-- INDEX dbo.ModuleRoleMapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ModuleRoleMapping_Active_New] ON [dbo].[ModuleRoleMapping] ([Active], [Roleid], [ModuleID])

GO

-- --------------------------------------------------
-- INDEX dbo.ModuleRoleMapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ModuleRoleMapping_Moduleid] ON [dbo].[ModuleRoleMapping] ([Roleid], [ModuleID])

GO

-- --------------------------------------------------
-- INDEX dbo.RoleMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_RoleMaster_RoleName] ON [dbo].[RoleMaster] ([RoleName])

GO

-- --------------------------------------------------
-- INDEX dbo.SIP_Scheme_V1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_SIP_Scheme_V1_SchemeCode_SIPFrequency_AMCName_SchemeName_SIPDates_SchemeType] ON [dbo].[SIP_Scheme_V1] ([SchemeCode], [SIPFrequency]) INCLUDE ([AMCName], [SchemeName], [SIPDates], [SchemeType])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.UserMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_name] ON [dbo].[UserMaster] ([Name])

GO

-- --------------------------------------------------
-- INDEX dbo.UserMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_UserMaster_UserId_Name] ON [dbo].[UserMaster] ([Userid], [Name])

GO

-- --------------------------------------------------
-- INDEX dbo.UserModuleExclude
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_UserModuleExclude_UserId] ON [dbo].[UserModuleExclude] ([userid], [ModuleId], [roleid])

GO

-- --------------------------------------------------
-- INDEX dbo.UserModuleExclude
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_UserModuleExclude_UserId_roleid] ON [dbo].[UserModuleExclude] ([userid], [roleid])

GO

-- --------------------------------------------------
-- INDEX dbo.UserModuleMappingMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_user] ON [dbo].[UserModuleMappingMaster] ([Userid])

GO

-- --------------------------------------------------
-- INDEX dbo.UserModuleMappingMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_UserModuleMappingMaster_UserId_ModuleId] ON [dbo].[UserModuleMappingMaster] ([Userid], [ModuleId]) INCLUDE ([Active])

GO

-- --------------------------------------------------
-- INDEX dbo.UserRolePermission
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_UserRolePermission_UserId_Roleid] ON [dbo].[UserRolePermission] ([Userid], [Roleid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ActionMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[ActionMaster] ADD CONSTRAINT [PK__ActionMa__FFE3F4D92DD1C37F] PRIMARY KEY ([ActionId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ControllerMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[ControllerMaster] ADD CONSTRAINT [PK__Controll__5A8912906CF8245B] PRIMARY KEY ([ControllerId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ProjectMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[ProjectMaster] ADD CONSTRAINT [PK__ProjectM__761ABEF069279377] PRIMARY KEY ([ProjectId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RoleMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[RoleMaster] ADD CONSTRAINT [PK__RoleMast__8AF5CA3206B7F65E] PRIMARY KEY ([Roleid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RunTotalTestData
-- --------------------------------------------------
ALTER TABLE [dbo].[RunTotalTestData] ADD CONSTRAINT [PK__RunTotal__3213E83F09E968C4] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagr__C2B05B61689D8392] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.[Usp_Rpt_Brokerage_Details_New11
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[[Usp_Rpt_Brokerage_Details_New11]
(	

	@client_Code  varchar(200)=NULL,
	@Mode varchar(20)= NULL,
	--@fyear varchar(20),
	@fromdt date = NULL,
	@todt date = NULL
	 
)

/*
EXEC [[Usp_Rpt_Brokerage_Details_New11] @client_Code='RP61', @fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details_New11] @client_Code='P51295',@Mode='LUMSUM',@fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details_New11] ''
*/
AS
BEGIN



	      
	IF (@Mode='Lumsum')    
	BEGIN    
		SET @Mode=''    
	END  


	




	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			ExistCode Client_Code,FirstHolderName Client_Name,tbl_clientdetails.tdate,tbl_clientdetails.ISIN,SM.SchemeName,SM.SchemeClassDescription,TrxnMode
			,FolioNo
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) BalanceUnit
			,tbl_clientdetails.Units
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,dpflag Mode,TranCode,Cr_amt,dr_amt,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem',SubTranType ,fund_code,schcode
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select ISIN,tdate,TrxnMode, FolioNo,OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
			union all		   
			
			select ISIN,tdate,TrxnMode,FolioNo, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON tbl_clientdetails.schcode=SM.SchemeCode
	where (IM.ExistCode = @client_Code or @client_Code IS NULL)


	Select distinct C.Client_Code,C.Client_Name,
	SM.SchemeClassDescription AS Trxn_Mode,
	C.SchemeClassDescription,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode, 
	C.tdate AS [DATE],C.[Invested/Redeem],C.FolioNo,MF.AMC_NAME,c.SchemeName,mf.LastNAVPrice NAV,C.Units,C.Amount,'' AS [Net Payable ( Revenue)],'' AS[Type of Revenue]
	INTO #Final
	from #tbl_clientdetails C
	inner join (
			SELECT distinct party_Code,fndmst.name as AMC_NAME,fndmst.code,fsSchemeCode,LastNAVPrice from IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
			inner join MutualFund.dbo.vw_FundMaster fndmst WITH (NOLOCK)
			on hldg.fund_code = fndmst.code
			)mf
	on c.Client_Code = mf.party_Code
	and C.fund_code = mf.code
	and C.schcode=substring(fsSchemeCode,2,len(fsSchemeCode))
	LEFT JOIN MutualFund.dbo.SchemeMaster SM  WITH (NOLOCK) ON C.schcode=SM.SchemeCode


	DECLARE @Sub_Broker  varchar(20)     
	select @Sub_Broker=sub_broker from sb_client_details where cl_code=@client_Code


	Declare  @Brokerage Table
	(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
	)
--INSERT INTO @Brokerage
--EXEC mutualfund.dbo.[usp_BillTransaction_Angel] @AgentCode= 'EMT',@BillPeriodFrom='01/11/2017',@BillPeriodTo ='30/11/2017'

INSERT INTO @Brokerage
EXEC mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @Sub_Broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt

	
	select * from @Brokerage where [Client Code]='RP61'

	SELECT distinct
		F.Client_Code,F.Client_Name,F.Trxn_Mode,F.SchemeClassDescription,f.Mode,F.DATE,
		F.[Invested/Redeem],F.FolioNo,F.AMC_NAME,
		F.SchemeName,F.NAV,F.Units,F.Amount,
		B.Commission as [Net Payable ( Revenue)],B.[Revenue Type] as [Type of Revenue]
		FROM  #Final F
		INNER JOIN @Brokerage B 
	ON 
		F.Client_Code=B.[Client Code] AND F.FolioNo=B.[Folio No]
		and B.[Trxn Date]=F.DATE
	order by 
		B.Commission DESC

	--WHERE Mode LIKE @Mode 
			
	DROP TABLE #tbl_clientdetails
	drop table #Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.abc
-- --------------------------------------------------
 create procedure abc (@abc float)
  as
  begin
  select @abc 

  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AddActiveUser_WithExclude
-- --------------------------------------------------
CREATE Procedure AddActiveUser_WithExclude
(
	@username varchar(100)--='RRYS'
)
as
begin

--Begin tran
--Declare @username varchar(100)='RRYS'


--Truncate table UserMaster
--Truncate table UserModuleExclude
--Truncate table UserRolePermission




--select * into UserModuleExclude_Bkp05Sept2018 from UserModuleExclude
--select* from [196.1.115.132].rolemgm.dbo.TempUserMaster
--select * into UserMaster_Bkp05Sept2018 from UserMaster
--select * into UserRolePermission_Bkp05Sept2018 from UserRolePermission


Declare @userid int


if not exists(select * from [196.1.115.132].rolemgm.dbo.TempUserMaster where username=@username)
begin 

insert into [196.1.115.132].rolemgm.dbo.TempUserMaster
select distinct  username,GETDATE() from [196.1.115.132].rolemgm.dbo.user_login a with (nolock)
--inner join [196.1.115.167].sb_comp.dbo.sb_broker b 
--on a.access_code=b.sbtag
where 
--SbCat='Gold'
--and 
usertype='USER'
and username not in (select username from [196.1.115.132].rolemgm.dbo.TempUserMaster)
and status=1
and login_inactive_date>getdate()
and access_to='SB'
and a.username=@username


END
select @userid =userid from [196.1.115.132].rolemgm.dbo.user_login a with (nolock) where username=@username


if not exists(select * from UserModuleExclude where userid=@userid )
begin 
insert into UserModuleExclude
(
	ModuleId
	,userid
	,CreatedBy
	,CreatedDate
	,IPaddress
	,roleid

)
select 
	30 ModuleId
	,userid
	,'System' CreatedBy
	,getdate() CreatedDate
	,''IPaddress
	,19 roleid

 from NXT.dbo.nxtsblogin a
 inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
where convert(Date,insertedon)=convert(date,getdate())
and usertype='User'
and a.username=@username

--and status=1
--and login_inactive_date>getdate()
END


if not exists(select * from UserMaster where userid=@userid )
begin 
insert into UserMaster
(
		 Userid
		,Name
		,password
		,Active
		,createDate
		,CreateBy
		,UpdateDate
		,UpdateBy
)

select 
		 A.Userid
		,A.username
		,A.userpassword
		,1 Active
		,Getdate() createDate
		,'admin' CreateBy
		,'' UpdateDate
		,'' UpdateBy

 from NXT.dbo.nxtsblogin A
 inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
where convert(Date,insertedon )=convert(date,getdate())
and usertype='User'
and a.username=@username
--and A.username<>'GSGO'

END



if not exists(select * from UserRolePermission where userid=@userid )
begin 

insert into UserRolePermission
(
Userid
,Roleid
,ProjectId
,createDate
,CreateBy
,UpdateDate
,UpdateBy
)
select 
		A.Userid
		,19 Roleid
		,1 ProjectId
		,getdate() createDate
		,'Admin' CreateBy
		,'' UpdateDate
		,'' UpdateBy
 from NXT.dbo.nxtsblogin A
 inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
where convert(Date,insertedon )=convert(date,getdate())
and usertype='User'
and a.username=@username
--and A.username<>'GSGO'

END


--select * from [196.1.115.132].rolemgm.dbo.user_login a
--inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
--where convert(Date,insertedon )='2018-09-05' --where username='GSGO'
--and a.username not in (select username from [196.1.115.132].rolemgm.dbo.TempUserMaster_Bkp04Sept2018)
--and a.username='CBI'
 

 --Commit
--Rollback

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AddActiveUser_WithExclude_ForInactiveUser
-- --------------------------------------------------
CREATE  Procedure AddActiveUser_WithExclude_ForInactiveUser
(
	@username varchar(100)--='RRYS'
)
as
begin

--Begin tran
--Declare @username varchar(100)='RRYS'


--Truncate table UserMaster
--Truncate table UserModuleExclude
--Truncate table UserRolePermission




--select * into UserModuleExclude_Bkp05Sept2018 from UserModuleExclude
--select* from [196.1.115.132].rolemgm.dbo.TempUserMaster
--select * into UserMaster_Bkp05Sept2018 from UserMaster
--select * into UserRolePermission_Bkp05Sept2018 from UserRolePermission


Declare @userid int


if not exists(select * from [196.1.115.132].rolemgm.dbo.TempUserMaster where username=@username)
begin 

insert into [196.1.115.132].rolemgm.dbo.TempUserMaster
select distinct  username,GETDATE() from [196.1.115.132].rolemgm.dbo.user_login a with (nolock)
--inner join [196.1.115.167].sb_comp.dbo.sb_broker b 
--on a.access_code=b.sbtag
where 
--SbCat='Gold'
--and 
usertype='USER'
and username not in (select username from [196.1.115.132].rolemgm.dbo.TempUserMaster)
--and status=0
--and login_inactive_date<getdate()
and access_to='SB'
and a.username=@username


END
select @userid =userid from [196.1.115.132].rolemgm.dbo.user_login a with (nolock) where username=@username


if not exists(select * from UserModuleExclude where userid=@userid )
begin 
insert into UserModuleExclude
(
	ModuleId
	,userid
	,CreatedBy
	,CreatedDate
	,IPaddress
	,roleid

)
select 
	30 ModuleId
	,userid
	,'System' CreatedBy
	,getdate() CreatedDate
	,''IPaddress
	,19 roleid

 from NXT.dbo.nxtsblogin a
 inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
where convert(Date,insertedon)=convert(date,getdate())
and usertype='User'
and a.username=@username

--and status=1
--and login_inactive_date>getdate()
END


if not exists(select * from UserMaster where userid=@userid )
begin 
insert into UserMaster
(
		 Userid
		,Name
		,password
		,Active
		,createDate
		,CreateBy
		,UpdateDate
		,UpdateBy
)

select 
		 A.Userid
		,A.username
		,A.userpassword
		,1 Active
		,Getdate() createDate
		,'admin' CreateBy
		,'' UpdateDate
		,'' UpdateBy

 from NXT.dbo.nxtsblogin A
 inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
where convert(Date,insertedon )=convert(date,getdate())
and usertype='User'
and a.username=@username
--and A.username<>'GSGO'

END



if not exists(select * from UserRolePermission where userid=@userid )
begin 

insert into UserRolePermission
(
Userid
,Roleid
,ProjectId
,createDate
,CreateBy
,UpdateDate
,UpdateBy
)
select 
		A.Userid
		,19 Roleid
		,1 ProjectId
		,getdate() createDate
		,'Admin' CreateBy
		,'' UpdateDate
		,'' UpdateBy
 from NXT.dbo.nxtsblogin A
 inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
where convert(Date,insertedon )=convert(date,getdate())
and usertype='User'
and a.username=@username
--and A.username<>'GSGO'

END


--select * from [196.1.115.132].rolemgm.dbo.user_login a
--inner join [196.1.115.132].rolemgm.dbo.TempUserMaster B On A.username=B.username
--where convert(Date,insertedon )='2018-09-05' --where username='GSGO'
--and a.username not in (select username from [196.1.115.132].rolemgm.dbo.TempUserMaster_Bkp04Sept2018)
--and a.username='CBI'
 

 --Commit
--Rollback

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AddUserExceptionBeeNXT
-- --------------------------------------------------
CREATE Procedure [dbo].[AddUserExceptionBeeNXT]
(
  @userid INT 
  	  ,@roleid INT

)

As
begin



  --Declare @userid INT 
  Declare @CreatedBy Varchar(200)='System'
  Declare @CreatedDate Datetime=Getdate()
  Declare @IPaddress Varchar(100)=''



  EXEC USerAndRoleInsert @userid 
  
  Print @userid

If not exists(select * from [UserModuleExclude]  where userid=@userid)
 begin 
  insert into [dbo].[UserModuleExclude]
  (
	   [ModuleId]
      ,[userid]
      ,[CreatedBy]
      ,[CreatedDate]
      ,[IPaddress]
	  ,roleid
  )
  Select 
		8  [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate [CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  9	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  92	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  16 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  31 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select	  
	    33	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  35	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  36	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  37	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  54 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  102 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  74 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid


UNION
Select
	  75 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  69 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  133 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  108 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  109 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  110 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  111 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  76 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  132 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid


END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AddUserExceptionBeeNXT_ForLive
-- --------------------------------------------------
CREATE Procedure [dbo].[AddUserExceptionBeeNXT_ForLive]
(
  @userid INT 
  	  ,@roleid INT

)

As
begin



  --Declare @userid INT 
  Declare @CreatedBy Varchar(200)='System Admin'
  Declare @CreatedDate Datetime=Getdate()
  Declare @IPaddress Varchar(100)=''



  EXEC USerAndRoleInsert_ForLive @userid 
  
  Print @userid

If not exists(select * from [UserModuleExclude_ForLive]  where userid=@userid)
 begin 
  insert into [dbo].[UserModuleExclude_ForLive]
  (
	   [ModuleId]
      ,[userid]
      ,[CreatedBy]
      ,[CreatedDate]
      ,[IPaddress]
	  ,roleid
  )
  Select 
		8  [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate [CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  9	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  92	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  16 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  31 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select	  
	    33	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  35	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  36	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  37	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  54 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  102 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  74 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid


UNION
Select
	  75 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  69 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  133 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  108 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  109 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  110 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  111 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  76 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  132 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid


END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AddUserExceptionBeeNXT_Specific
-- --------------------------------------------------
CREATE Procedure [dbo].[AddUserExceptionBeeNXT_Specific]
(
  @userid INT 
  	  ,@roleid INT

)

As
begin



  --Declare @userid INT 
  Declare @CreatedBy Varchar(200)='System'
  Declare @CreatedDate Datetime=Getdate()
  Declare @IPaddress Varchar(100)=''





  --SET  @userid=254015
  
--254015
--229010
--244840
--243669
--223122
--213365
--209621
--210456
--256043
--79201



  insert into [dbo].[UserModuleExclude]
  (
	   [ModuleId]
      ,[userid]
      ,[CreatedBy]
      ,[CreatedDate]
      ,[IPaddress]
	  ,roleid
  )
  
Select
	  132 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid


--UNION
--Select
--	  108 [ModuleId]
--	   , @userid [userid]
--      ,@CreatedBy [CreatedBy]
--      ,@CreatedDate[CreatedDate]
--      ,'' [IPaddress]
--	  ,@roleid

--UNION
--Select
--	  109 [ModuleId]
--	   , @userid [userid]
--      ,@CreatedBy [CreatedBy]
--      ,@CreatedDate[CreatedDate]
--      ,'' [IPaddress]
--	  ,@roleid

--UNION
--Select
--	  110 [ModuleId]
--	   , @userid [userid]
--      ,@CreatedBy [CreatedBy]
--      ,@CreatedDate[CreatedDate]
--      ,'' [IPaddress]
--	  ,@roleid

--UNION
--Select
--	  111 [ModuleId]
--	   , @userid [userid]
--      ,@CreatedBy [CreatedBy]
--      ,@CreatedDate[CreatedDate]
--      ,'' [IPaddress]
--	  ,@roleid

--	  UNION
--Select
--	  76 [ModuleId]
--	   , @userid [userid]
--      ,@CreatedBy [CreatedBy]
--      ,@CreatedDate[CreatedDate]
--      ,'' [IPaddress]
--	  ,@roleid






--UNION
--Select
--	  69 [ModuleId]
--	   , @userid [userid]
--      ,@CreatedBy [CreatedBy]
--      ,@CreatedDate[CreatedDate]
--      ,'' [IPaddress]
--	  ,@roleid


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AddUserExceptionNXT
-- --------------------------------------------------

CREATE Procedure [dbo].[AddUserExceptionNXT]
(
  @userid INT 
  	  ,@roleid INT

)

As
begin



  --Declare @userid INT 
  Declare @CreatedBy Varchar(200)='System'
  Declare @CreatedDate Datetime=Getdate()
  Declare @IPaddress Varchar(100)=''





  --SET  @userid=254015
  
--254015
--229010
--244840
--243669
--223122
--213365
--209621
--210456
--256043
--79201



  insert into [dbo].[UserModuleExclude]
  (
	   [ModuleId]
      ,[userid]
      ,[CreatedBy]
      ,[CreatedDate]
      ,[IPaddress]
	  ,roleid
  )
  Select 
		8  [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate [CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  9	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  92	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  16 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  31 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select	  
	    33	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  35	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  36	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  37	[ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  54 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid
UNION
Select
	  102 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  74 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid


UNION
Select
	  75 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  69 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid

UNION
Select
	  133 [ModuleId]
	   , @userid [userid]
      ,@CreatedBy [CreatedBy]
      ,@CreatedDate[CreatedDate]
      ,'' [IPaddress]
	  ,@roleid


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertUsermodulemappingMaster
-- --------------------------------------------------
CREATE procedure [dbo].[InsertUsermodulemappingMaster]
(
@username varchar(100)
)
as
begin
dECLARE @usERID int
--dECLARE @Username int




select  @usERID= UserId from UserMaster WITH (NOLOCK) where  name = @username




	INSERT INTO UserModuleMappingMaster 
		(Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress )
		SELECT Userid=@usERID,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress 
		FROM  UserModuleMappingMaster WITH (NOLOCK)
		WHERE Userid = 72468


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IPartner_Prc_GetTransData
-- --------------------------------------------------
--exec Prc_GetTransData 'GDS','','','PHY','','',''

/*

Begin tran

declare @Sdate datetime = getdate()
--EXEC USP_MF_rpt_redemptionDetails_opt
exec IPartner_Prc_GetTransData 'EMT','','','','','A120968','' 
--exec Prc_GetTransData 'GDS','','','PHY','','V15745','' 
select datediff(ms,@Sdate,GETDATE())

Rollback tran


*/


CREATE Procedure [dbo].[IPartner_Prc_GetTransData]
(
@SBCode varchar(20),
@Frmdate varchar(12)='',
@Todate varchar(12)='',
@Type varchar(20)=null,
@Branch varchar(50)=null,
@ClientCode varchar(50)=null,
@Scheme varchar(50)=null

)
As
Begin
SET FMTONLY OFF;    

/*
declare @SBCode varchar(20)='GDS',
@Frmdate varchar(12)=null,
@Todate varchar(12)=null,
@Type varchar(20)=null,
@Branch varchar(50)=null,
@ClientCode varchar(50)=null,
@Scheme varchar(50)=null
*/
declare @condition varchar(max),@sql nvarchar(max),@sql1 varchar(max)
set @condition =''



if(isnull(@Frmdate,'')='' and isnull(@Todate,'')='')
begin
set @Frmdate ='01 Jan 2000'
set @Todate  =CONVERT(varchar(12),getdate(),106)
end
if(isnull(@Type,'')='')
Begin
set @Type='%'
End
if(isnull(@Branch,'')='')
Begin
set @Branch='%'
End
if(isnull(@ClientCode,'')='')
Begin
set @ClientCode='%'
End
if(isnull(@Scheme,'')='')
Begin
set @Scheme='%'
End
if(@Type<>'%' )
Begin
set @condition=@condition + 'and dpflag like '''+@Type+''''
End
if(@ClientCode<>'%' )
Begin
set @condition=@condition + 'and Clientcode like '''+@ClientCode+''''
End
 


--CREATE TABLE [dbo].[#BuySell](
--	RecID int identity(1,1),
--	[schemeclassdescription] [varchar](50) NULL,
--	[schemesubclassdescription] [varchar](50) NULL,
--	[SchemeName] [varchar](250) NULL,
--	[clsb_code] [varchar](50) NULL,
--	[Scheme_Code] [varchar](50) NULL,
--	[Clientcode] [varchar](50) NULL,
--	[name] [varchar](100) NULL,
--	[tdate] [datetime] NULL,
--	[SubTranType] [varchar](50) NOT NULL,
--	[BUYSELL] [varchar](4) NOT NULL,
--	[FolioNo] [varchar](50) NULL,
--	[Nav] [numeric](17, 4) NULL,
--	[Units] [numeric](17, 4) NULL,
--	[Amount] [numeric](35, 2) NULL
--) 


--drop table #t 
--set @sql='
----insert into #BuySell
--select schemeclassdescription,schemesubclassdescription,SchemeName,a.* 
--INTO ##BuySell 
--from schememaster  s
--inner join
--(
--select clsb_code,Scheme_Code,Clientcode,name,tdate,SubTranType,BUYSELL,FolioNo,Nav,Units,Amount from vw_TransactionBuy_UniqueCode u with(nolock)  inner join vw_InvestorMaster v with(nolock)
--on u.app_code=v.code
--where v.equitycode is not null and clsb_code='''+@SBCode+''' and tdate>=convert(datetime,'''+@Frmdate+''') and tdate<=convert(datetime,'''+@Todate+''') 
--'+@condition+')a
--on s.SchemeCode=substring(a.scheme_code,2,LEN(a.scheme_code)) '
--print (@sql)
--Exec Sp_executesql @sql






set @sql1='
--insert into #BuySell
select schemeclassdescription,schemesubclassdescription,SchemeName,a.* 
INTO ##BuySell1
 from MUTUALFUND..schememaster  s
inner join
(
select clsb_code,Scheme_Code,Clientcode,name,tdate,SubTranType,BUYSELL=''SELL'',FolioNo,Nav,Units,(Nav*Units) as Amount from tbl_TransactionSale_UniqueCode_syn u with(nolock)  inner join MUTUALFUND..vw_InvestorMaster v with(nolock)
on u.app_code=v.code
where v.equitycode is not null and  clsb_code='''+@SBCode+''' and tdate>=convert(datetime,'''+@Frmdate+''') and tdate<=convert(datetime,'''+@Todate+''') 
'+@condition+'
)a
on s.SchemeCode=substring(a.scheme_code,2,LEN(a.scheme_code))'   
print (@sql1)
exec (@sql1)


SELECT row_number() over ( order by BUYSELL,tdate) as RecID,
* INTO  #BuySell  FROM ##BuySell1

--DROP TABLE ##BuySell
DROP TABLE ##BuySell1
select * from 
(
select RecID,case when schemeclassdescription not in ('Debt','Liquid Fund') then 'Other' else schemeclassdescription  end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType ,convert(VARCHAR(11),tdate) as tdate,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMCSchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,cd.branch_cd as Branch,Clsb_code as Sbcode from #BuySell b
inner join NXT..sb_client_details cd on
b.Clientcode=cd.party_code
where schemeclassdescription<>'Equity' and SchemeName like @Scheme  and cd.branch_cd like @Branch
union all
select RecID,case when schemesubclassdescription not in ('ELSS','Balanced Fund') then 'Equity' else schemesubclassdescription end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType,convert(VARCHAR(11),tdate) as tdate,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMCSchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,cd.branch_cd as Branch,Clsb_code as Sbcode from #BuySell b
inner join NXT..sb_client_details cd on
b.Clientcode=cd.party_code
where schemeclassdescription='Equity' and SchemeName like @Scheme and cd.branch_cd like @Branch
)zx order by RecID
--union all
--select case when schemeclassdescription not in ('Debt','Liquid Fund') then 'Other' else schemeclassdescription  end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType ,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMC,SchemeName as SchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,'' as Branch,Clsb_code as Sbcode from #Sell
--where schemeclassdescription<>'Equity' and SchemeName like @Scheme 
--union all
--select case when schemesubclassdescription not in ('ELSS','Balanced Fund') then 'Equity' else schemesubclassdescription end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMC,SchemeName as SchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,'' as Branch,Clsb_code as Sbcode from #Sell
--where schemeclassdescription='Equity' and SchemeName like @Scheme 




drop table [#BuySell]

End
--drop table #t
--select top 1 * from vw_TransactionBuy_UniqueCode with(nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IPartner_Prc_GetTransData_BKP_20180507
-- --------------------------------------------------
--exec Prc_GetTransData 'GDS','','','PHY','','',''

/*

Begin tran

declare @Sdate datetime = getdate()
--EXEC USP_MF_rpt_redemptionDetails_opt
exec IPartner_Prc_GetTransData 'EMT','','','','','A120968','' 
--exec Prc_GetTransData 'GDS','','','PHY','','V15745','' 
select datediff(ms,@Sdate,GETDATE())

Rollback tran


*/


CREATE Procedure [dbo].[IPartner_Prc_GetTransData_BKP_20180507]
(
@SBCode varchar(20),
@Frmdate varchar(12)='',
@Todate varchar(12)='',
@Type varchar(20)=null,
@Branch varchar(50)=null,
@ClientCode varchar(50)=null,
@Scheme varchar(50)=null

)
As
Begin
SET FMTONLY OFF;    

/*
declare @SBCode varchar(20)='GDS',
@Frmdate varchar(12)=null,
@Todate varchar(12)=null,
@Type varchar(20)=null,
@Branch varchar(50)=null,
@ClientCode varchar(50)=null,
@Scheme varchar(50)=null
*/
declare @condition varchar(max),@sql nvarchar(max),@sql1 varchar(max)
set @condition =''



if(isnull(@Frmdate,'')='' and isnull(@Todate,'')='')
begin
set @Frmdate ='01 Jan 2000'
set @Todate  =CONVERT(varchar(12),getdate(),106)
end
if(isnull(@Type,'')='')
Begin
set @Type='%'
End
if(isnull(@Branch,'')='')
Begin
set @Branch='%'
End
if(isnull(@ClientCode,'')='')
Begin
set @ClientCode='%'
End
if(isnull(@Scheme,'')='')
Begin
set @Scheme='%'
End
if(@Type<>'%' )
Begin
set @condition=@condition + 'and dpflag like '''+@Type+''''
End
if(@ClientCode<>'%' )
Begin
set @condition=@condition + 'and Clientcode like '''+@ClientCode+''''
End
 


--CREATE TABLE [dbo].[#BuySell](
--	RecID int identity(1,1),
--	[schemeclassdescription] [varchar](50) NULL,
--	[schemesubclassdescription] [varchar](50) NULL,
--	[SchemeName] [varchar](250) NULL,
--	[clsb_code] [varchar](50) NULL,
--	[Scheme_Code] [varchar](50) NULL,
--	[Clientcode] [varchar](50) NULL,
--	[name] [varchar](100) NULL,
--	[tdate] [datetime] NULL,
--	[SubTranType] [varchar](50) NOT NULL,
--	[BUYSELL] [varchar](4) NOT NULL,
--	[FolioNo] [varchar](50) NULL,
--	[Nav] [numeric](17, 4) NULL,
--	[Units] [numeric](17, 4) NULL,
--	[Amount] [numeric](35, 2) NULL
--) 


--drop table #t 
--set @sql='
----insert into #BuySell
--select schemeclassdescription,schemesubclassdescription,SchemeName,a.* 
--INTO ##BuySell 
--from schememaster  s
--inner join
--(
--select clsb_code,Scheme_Code,Clientcode,name,tdate,SubTranType,BUYSELL,FolioNo,Nav,Units,Amount from vw_TransactionBuy_UniqueCode u with(nolock)  inner join vw_InvestorMaster v with(nolock)
--on u.app_code=v.code
--where v.equitycode is not null and clsb_code='''+@SBCode+''' and tdate>=convert(datetime,'''+@Frmdate+''') and tdate<=convert(datetime,'''+@Todate+''') 
--'+@condition+')a
--on s.SchemeCode=substring(a.scheme_code,2,LEN(a.scheme_code)) '
--print (@sql)
--Exec Sp_executesql @sql






set @sql1='
--insert into #BuySell
select schemeclassdescription,schemesubclassdescription,SchemeName,a.* 
INTO ##BuySell1
 from MUTUALFUND..schememaster  s
inner join
(
select clsb_code,Scheme_Code,Clientcode,name,tdate,SubTranType,BUYSELL=''SELL'',FolioNo,Nav,Units,Amount from tbl_TransactionSale_UniqueCode_syn u with(nolock)  inner join MUTUALFUND..vw_InvestorMaster v with(nolock)
on u.app_code=v.code
where v.equitycode is not null and  clsb_code='''+@SBCode+''' and tdate>=convert(datetime,'''+@Frmdate+''') and tdate<=convert(datetime,'''+@Todate+''') 
'+@condition+'
)a
on s.SchemeCode=substring(a.scheme_code,2,LEN(a.scheme_code))'   
print (@sql1)
exec (@sql1)


SELECT row_number() over ( order by BUYSELL,tdate) as RecID,
* INTO  #BuySell  FROM ##BuySell1

--DROP TABLE ##BuySell
DROP TABLE ##BuySell1
select * from 
(
select RecID,case when schemeclassdescription not in ('Debt','Liquid Fund') then 'Other' else schemeclassdescription  end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType ,convert(VARCHAR(11),tdate) as tdate,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMCSchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,cd.branch_cd as Branch,Clsb_code as Sbcode from #BuySell b
inner join NXT..sb_client_details cd on
b.Clientcode=cd.party_code
where schemeclassdescription<>'Equity' and SchemeName like @Scheme  and cd.branch_cd like @Branch
union all
select RecID,case when schemesubclassdescription not in ('ELSS','Balanced Fund') then 'Equity' else schemesubclassdescription end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType,convert(VARCHAR(11),tdate) as tdate,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMCSchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,cd.branch_cd as Branch,Clsb_code as Sbcode from #BuySell b
inner join NXT..sb_client_details cd on
b.Clientcode=cd.party_code
where schemeclassdescription='Equity' and SchemeName like @Scheme and cd.branch_cd like @Branch
)zx order by RecID
--union all
--select case when schemeclassdescription not in ('Debt','Liquid Fund') then 'Other' else schemeclassdescription  end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType ,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMC,SchemeName as SchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,'' as Branch,Clsb_code as Sbcode from #Sell
--where schemeclassdescription<>'Equity' and SchemeName like @Scheme 
--union all
--select case when schemesubclassdescription not in ('ELSS','Balanced Fund') then 'Equity' else schemesubclassdescription end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMC,SchemeName as SchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,'' as Branch,Clsb_code as Sbcode from #Sell
--where schemeclassdescription='Equity' and SchemeName like @Scheme 




drop table [#BuySell]

End
--drop table #t
--select top 1 * from vw_TransactionBuy_UniqueCode with(nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IPartner_Prc_GetTransData_NewTest
-- --------------------------------------------------
--exec Prc_GetTransData 'GDS','','','PHY','','',''

/*

Begin tran

declare @Sdate datetime = getdate()
--EXEC USP_MF_rpt_redemptionDetails_opt
exec IPartner_Prc_GetTransData_opt 'GDS','','','PHY','','V15745','' 
--exec Prc_GetTransData 'GDS','','','PHY','','V15745','' 
select datediff(ms,@Sdate,GETDATE())

Rollback tran


*/


Create  Procedure [dbo].[IPartner_Prc_GetTransData_NewTest]
(
@SBCode varchar(20),
@Frmdate varchar(12)='',
@Todate varchar(12)='',
@Type varchar(20)=null,
@Branch varchar(50)=null,
@ClientCode varchar(50)=null,
@Scheme varchar(50)=null

)
As
Begin
SET FMTONLY OFF;    

/*

EXEC [dbo].[IPartner_Prc_GetTransData_NewTest] @SBCode='EMT',@ClientCode='A120968'

*/

/*
declare @SBCode varchar(20)='GDS',
@Frmdate varchar(12)=null,
@Todate varchar(12)=null,
@Type varchar(20)=null,
@Branch varchar(50)=null,
@ClientCode varchar(50)=null,
@Scheme varchar(50)=null
*/
declare @condition varchar(max),@sql nvarchar(max),@sql1 varchar(max)
set @condition =''



if(isnull(@Frmdate,'')='' and isnull(@Todate,'')='')
begin
set @Frmdate ='01 Jan 2000'
set @Todate  =CONVERT(varchar(12),getdate(),106)
end
if(isnull(@Type,'')='')
Begin
set @Type='%'
End
if(isnull(@Branch,'')='')
Begin
set @Branch='%'
End
if(isnull(@ClientCode,'')='')
Begin
set @ClientCode='%'
End
if(isnull(@Scheme,'')='')
Begin
set @Scheme='%'
End
if(@Type<>'%' )
Begin
set @condition=@condition + 'and dpflag like '''+@Type+''''
End
if(@ClientCode<>'%' )
Begin
set @condition=@condition + 'and Clientcode like '''+@ClientCode+''''
End
 


--CREATE TABLE [dbo].[#BuySell](
--	RecID int identity(1,1),
--	[schemeclassdescription] [varchar](50) NULL,
--	[schemesubclassdescription] [varchar](50) NULL,
--	[SchemeName] [varchar](250) NULL,
--	[clsb_code] [varchar](50) NULL,
--	[Scheme_Code] [varchar](50) NULL,
--	[Clientcode] [varchar](50) NULL,
--	[name] [varchar](100) NULL,
--	[tdate] [datetime] NULL,
--	[SubTranType] [varchar](50) NOT NULL,
--	[BUYSELL] [varchar](4) NOT NULL,
--	[FolioNo] [varchar](50) NULL,
--	[Nav] [numeric](17, 4) NULL,
--	[Units] [numeric](17, 4) NULL,
--	[Amount] [numeric](35, 2) NULL
--) 


--drop table #t 
--set @sql='
----insert into #BuySell
--select schemeclassdescription,schemesubclassdescription,SchemeName,a.* 
--INTO ##BuySell 
--from schememaster  s
--inner join
--(
--select clsb_code,Scheme_Code,Clientcode,name,tdate,SubTranType,BUYSELL,FolioNo,Nav,Units,Amount from vw_TransactionBuy_UniqueCode u with(nolock)  inner join vw_InvestorMaster v with(nolock)
--on u.app_code=v.code
--where v.equitycode is not null and clsb_code='''+@SBCode+''' and tdate>=convert(datetime,'''+@Frmdate+''') and tdate<=convert(datetime,'''+@Todate+''') 
--'+@condition+')a
--on s.SchemeCode=substring(a.scheme_code,2,LEN(a.scheme_code)) '
--print (@sql)
--Exec Sp_executesql @sql






set @sql1='
--insert into #BuySell
select schemeclassdescription,schemesubclassdescription,SchemeName,a.* 
INTO ##BuySell1
 from MUTUALFUND..schememaster  s
inner join
(
select clsb_code,Scheme_Code,Clientcode,name,tdate,SubTranType,BUYSELL=''SELL'',FolioNo,Nav,Units,Amount 
from tbl_TransactionSale_UniqueCode_syn u with(nolock)  
inner join MUTUALFUND..vw_InvestorMaster v with(nolock)
on u.app_code=v.code
where v.equitycode is not null and  clsb_code='''+@SBCode+''' and tdate>=convert(datetime,'''+@Frmdate+''') and tdate<=convert(datetime,'''+@Todate+''') 
'+@condition+'
)a
on s.SchemeCode=substring(a.scheme_code,2,LEN(a.scheme_code))'   
print (@sql1)
exec (@sql1)


SELECT row_number() over ( order by BUYSELL,tdate) as RecID,
* INTO  #BuySell  FROM ##BuySell1

--DROP TABLE ##BuySell
DROP TABLE ##BuySell1
select * from 
(
select RecID,case when schemeclassdescription not in ('Debt','Liquid Fund') then 'Other' else schemeclassdescription  end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType ,convert(VARCHAR(11),tdate) as tdate,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMCSchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,cd.branch_cd as Branch,Clsb_code as Sbcode from #BuySell b
inner join NXT..sb_client_details cd on
b.Clientcode=cd.party_code
where schemeclassdescription<>'Equity' and SchemeName like @Scheme  and cd.branch_cd like @Branch
union all
select RecID,case when schemesubclassdescription not in ('ELSS','Balanced Fund') then 'Equity' else schemesubclassdescription end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType,convert(VARCHAR(11),tdate) as tdate,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMCSchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,cd.branch_cd as Branch,Clsb_code as Sbcode from #BuySell b
inner join NXT..sb_client_details cd on
b.Clientcode=cd.party_code
where schemeclassdescription='Equity' and SchemeName like @Scheme and cd.branch_cd like @Branch
)zx order by RecID
--union all
--select case when schemeclassdescription not in ('Debt','Liquid Fund') then 'Other' else schemeclassdescription  end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType ,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMC,SchemeName as SchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,'' as Branch,Clsb_code as Sbcode from #Sell
--where schemeclassdescription<>'Equity' and SchemeName like @Scheme 
--union all
--select case when schemesubclassdescription not in ('ELSS','Balanced Fund') then 'Equity' else schemesubclassdescription end as  TrxnMode,'' as [Group],ClientCode,name as [Client Name],case when SubTranType='SIP' then SubTranType else 'LumpSum' end SubTranType,BuySELL as [Invested/Redeem],FolioNo,SchemeName as AMC,SchemeName as SchemeName,Nav,Units as [No.of Unit],Amount,'' as Strategy,'' as Branch,Clsb_code as Sbcode from #Sell
--where schemeclassdescription='Equity' and SchemeName like @Scheme 




drop table [#BuySell]

End
--drop table #t
--select top 1 * from vw_TransactionBuy_UniqueCode with(nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USerAndRoleInsert
-- --------------------------------------------------
CREATE procedure USerAndRoleInsert
(
@userid Varchar(100)
)
as
begin 

--Declare @USerid Varchar(100)

Declare @roleid Varchar(100)
--Set @USerid =223002

Declare @username varchar(200)
Declare @password varchar(200),
@usertype varchar(200)


select 
		@username =username , 
		@password =userpassword  ,
		@usertype=usertype 
from 
	[196.1.115.132].ROLEMGM.dbo.user_login  WITH (NOLOCK)  
where  userid =@userid  and usertype='USer'

--select * from [196.1.115.132].ROLEMGM.dbo.user_login where userid=223002

--select @username 

If not exists(select * from UserMaster WITH (NOLOCK) where Name=@UserName)
 begin 

	   insert into UserMaster(Userid,Name,password,Active,createDate,CreateBy)
	   values(@userid,@username,@password,1,GETDATE(),'System')
END	  

	   select @roleid=RoleMaster.Roleid from RoleMaster  WITH (NOLOCK) where RoleName=@usertype
	
	
If not exists(select * from UserRolePermission WITH (NOLOCK) where Userid=@userid and Roleid=@roleid)
 begin 
	
	   
	   insert into UserRolePermission(Userid,Roleid,ProjectId,createDate,CreateBy)
	   values(@userid,@roleid,1,GETDATE(),'System')

END


If not exists(select * from UserModuleMappingMaster WITH (NOLOCK) where Userid=@userid)
 begin 
	
		INSERT INTO UserModuleMappingMaster (Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress )
		SELECT Userid=@userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress 
		FROM  UserModuleMappingMaster  WITH (NOLOCK) 
		WHERE Userid = 72468

END


--select * from UserMaster where  userid =@userid 
--select * from UserRolePermission where  userid =@userid 

--rollback

END

--insert into UserMaster

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ActionMaster
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[usp_ActionMaster]
(
		
		@ActionName VARCHAR(20),
		@ControllerId INT,
		@Active bit
		
)

AS
BEGIN 

--usp_AddNewRole 'AAA','Node','10'

SET NOCOUNT ON 
BEGIN TRANSACTION
BEGIN TRY 

	INSERT INTO ActionMaster(ActionName,ControllerId,Active)
	Select 	@ActionName,@ControllerId,@Active
	
	Commit


END TRY  
BEGIN CATCH  
   	SELECT  
        ERROR_NUMBER() AS ErrorNumber  
        ,ERROR_SEVERITY() AS ErrorSeverity  
        ,ERROR_STATE() AS ErrorState  
        ,ERROR_PROCEDURE() AS ErrorProcedure  
        ,ERROR_LINE() AS ErrorLine  
        ,ERROR_MESSAGE() AS ErrorMessage;  
 Rollback
END CATCH

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ActivateCard
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[USP_ActivateCard]  
(  
@ControllerId nvarchar(10),  
@CardNumber nvarchar (50) ,
@ExpiryDate nvarchar(20)  
)  
As  
BEGIN  

Declare @Message nvarchar (Max),
        @Status bit=0,
		@Msg nvarchar(Max),
		@IPAddress nvarchar(50),
		@CardId nvarchar(10),
		@SlaveId nvarchar(10),
		@TCP int

		 IF(@CardNumber is not null and @CardNumber!='')
         BEGIN
                 IF Exists(Select  CardId,CardNumber from CardDetail where CardNumber=@CardNumber and Status=1 and ControllerId=@ControllerId)
                 BEGIN
                 
				 Select @CardId=CardId from CardDetail where CardNumber=@CardNumber and Status=1 and ControllerId=@ControllerId


				 update CardDetail set IsActive=1,IsDeleted=0,IsDeleteFromAll=0,AccessCardExpiry=@ExpiryDate where  CardNumber=@CardNumber and CardId=@CardId and ControllerId=@ControllerId and Status=1



				 Select @ControllerID=[ControllerId],@SlaveId=[SlaveID],@IPAddress=[IPAddress],@TCP=[TCPPort] from 
				 [AccessManagementSystem].[dbo].[ControllerDetail] where Status=1 and ControllerId=@ControllerId
                 
				 Set @Msg=@CardId+'@'+@ControllerID
				 

				 insert into [dbo].[SyncUserData] ([ControllerId],[IpAddress],[TcpPort],[SlaveId],[InsertedDate],[Status],[Code],[Message]) values 
				 (@ControllerID,@IPAddress,@TCP,@SlaveId,format( getdate(), 'yyyy-MM-dd' ),1,101,@Msg)
				  Set @Status =1
		          Set @Message='Record Inserted Successfully.' 

                 END
                 ELSE
                 BEGIN
                  Set @Status =0 
		          Set @Message='Card Not Exists.' 
                 END

       END
	   ELSE
	   BEGIN
        Set @Status =0 
		Set @Message='Enter Card Value.'      
       END

	   Select @Status As Status , @Message As Messagae
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AddNewRole
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[usp_AddNewRole]
(
		@RoleName VARCHAR(200)	
	,	@NodeType VARCHAR(100)	
	,	@ParentId INT
	,@CreatedBy	VARCHAR(100)=NULL
	,@CreatedDate	datetime=NULL
	,@UpdatedBy	VARCHAR(100)=NULL
	,@UpdatedDate datetime=NULL
	,@Roleid int

)

AS
BEGIN 

--usp_AddNewRole 'AAA','Node',1

SET NOCOUNT ON 
BEGIN TRANSACTION
BEGIN TRY 
     
	IF @Roleid=0
	 BEGIN
	   INSERT INTO RoleMaster(RoleName,NodeType,ParentId,CreatedBy,CreatedDate,UpdatedBy,UpdatedDate)
	   Select 	@RoleName ,	@NodeType 	,	@ParentId ,@CreatedBy,getdate(),@UpdatedBy,@UpdatedDate
	 END
	ELSE
	 BEGIN
	   Update RoleMaster set RoleName=@RoleName,NodeType=@NodeType,ParentId=@ParentId,UpdatedBy=@CreatedBy,UpdatedDate=GETDATE() where Roleid=@Roleid
	 END
   
	Commit


END TRY  
BEGIN CATCH  
    Rollback
	SELECT  
        ERROR_NUMBER() AS ErrorNumber  
        ,ERROR_SEVERITY() AS ErrorSeverity  
        ,ERROR_STATE() AS ErrorState  
        ,ERROR_PROCEDURE() AS ErrorProcedure  
        ,ERROR_LINE() AS ErrorLine  
        ,ERROR_MESSAGE() AS ErrorMessage;  
END CATCH


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AddNewUser
-- --------------------------------------------------
CREATE  PROCEDURE usp_AddNewUser
(
		@Name Varchar(200),
		@password Varchar(200)
		,@Active Bit
		,@createDate	datetime=NULL
		,@CreateBy	varchar(100)=NULL
		,@UpdateDate	datetime=NULL
		,@UpdateBy	varchar(100)=NULL

)
--usp_AddNewUser 'AAA','AAA','1'
AS
BEGIN 
SET NOCOUNT ON 
BEGIN TRANSACTION
BEGIN TRY 

	INSERT INTO UserMaster(Name,password,Active,createDate,CreateBy,UpdateDate,UpdateBy)
	Select 	@Name,@password,@Active,@createDate,@CreateBy,@UpdateDate,@UpdateBy	
	
	Commit


END TRY  
BEGIN CATCH  
    Rollback
	SELECT  
        ERROR_NUMBER() AS ErrorNumber  
        ,ERROR_SEVERITY() AS ErrorSeverity  
        ,ERROR_STATE() AS ErrorState  
        ,ERROR_PROCEDURE() AS ErrorProcedure  
        ,ERROR_LINE() AS ErrorLine  
        ,ERROR_MESSAGE() AS ErrorMessage;  
END CATCH


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_AMD_IWMF_current_holding
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_AMD_IWMF_current_holding]
	AS
	BEGIN
		SET NOCOUNT ON
		IF OBJECT_ID('TEMPDB..#IWMF_current_holding') IS NOT NULL
			DROP TABLE #IWMF_current_holding

		SELECT	AsOnDate,party_Code,fund_code,scheme_code,folio_no,AMFI_Code,DPFlag,Angel_Qty,Actual_Qty,avg_rate,UpdateTime,fsSchemeCode,
				MapID,ProductID,RedeemableUnit,isElssData,SchemeName,ISIN,LastNAVPrice,LastNAVDate,PrevNAV
		INTO #IWMF_current_holding
		FROM [172.31.16.85].ABR_DW_DION.dbo.IWMF_trn_current_holding WITH (NOLOCK)

		
		TRUNCATE TABLE IWMF_trn_current_holding_Prev

		INSERT INTO IWMF_trn_current_holding_Prev
		SELECT * FROM IWMF_trn_current_holding WITH (NOLOCK)
		
		DROP SYNONYM IWMF_trn_current_holding_syn

		CREATE SYNONYM IWMF_trn_current_holding_syn for IWMF_trn_current_holding_Prev

		TRUNCATE TABLE IWMF_trn_current_holding

		INSERT INTO IWMF_trn_current_holding(AsOnDate,party_Code,fund_code,scheme_code,folio_no,AMFI_Code,DPFlag,Angel_Qty,Actual_Qty,
					avg_rate,UpdateTime,fsSchemeCode,MapID,ProductID,RedeemableUnit,isElssData,SchemeName,ISIN,LastNAVPrice,LastNAVDate,PrevNAV)
	
		SELECT	* FROM #IWMF_current_holding

		DROP SYNONYM IWMF_trn_current_holding_syn

		CREATE SYNONYM IWMF_trn_current_holding_syn for IWMF_trn_current_holding


	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_AMD_MFTransactionData_UniqueCode
-- --------------------------------------------------
CREATE PROCEDURE Usp_AMD_MFTransactionData_UniqueCode
AS 
BEGIN
	
	SET NOCOUNT ON
	IF OBJECT_ID('TEMPDB..#MFTransBuyData') IS NOT NULL
		DROP TABLE #MFTransBuyData

	SELECT	Sch_OptionFlag,Scheme_Code,ISIN,TranCode,tdate,clsb_code,app_code,BrkApplName,Clientcode,BUYSELL,PsubCode,BrkCategory,fund_code,schcode,Amount,
			Navdt,NAV,Units,BankName,Branch,AcNo,billto,Bcode,TranType,SubTranType,Expr1,RateType,FolioNo,ChqNo,Chqdt,Appno,ExeCD,Ar_No,Product,UPFRateAC,
			UPFAmtAC,UPRateIN,UpAmtIN,UPPRateIN,UpPAmtIN,AnnRateIN,AnnAmtIN,AnnPRateIN,AnnPAmtIN,UPRateOUT,UpAmtOUT,UPPRateOUT,UpPAmtOUT,AnnRateOUT,AnnAmtOUT,
			AnnPRateOUT,AnnPAmtOUT,EntryDate,ModifyDate,ActualBrokerCode,TXNNO,OrgTRType,DivRein,rowguid,recordID,TRRecoRef,Billpost,PayPost,bill_to,tcol,fd_mdate,
			uploadflag,DIVREINPROC,ARN_NO,remark,TrRecordid,AutoTr,FileDescription,DFRemarks,SIPStartDate,dpflag,OrderNo,Flag,Ticob_Trxn_Type,Ticob_Trxn_no,
			Ticob_Posted_date,Tax,total_tax,Cams_remarks,TrxnMode,PostDate,txnid,processdate,rmcode,Registrar,TranHead,TrxnType,Corporate_Action_No,
			Org_Nav,Org_Units,Transaction_head,Remarks,OrgArn,TrxnNo,EUIN,CityCategory,TrxnCharges,ValidEUIN,TD_PurRed,To_ProductCode,DPID,DpClientID,
			RejectionReferanceNo,Tr_PurRed,TaxStatus,incentivein,Incentive,TranEmailDT,BalUnits,DivAmt,seqno,taxben,OldClientcode,MergeDate,NavDate,
			requestcode,DStatus,panno,InPayStatus,PayStatus,MovedFrom,UpdateDescription,FtFolio,BrokerRule,RevTag,BSEREFNO
	INTO #MFTransBuyData
	FROM MutualFund.dbo.vw_TransactionBuy_UniqueCode_New WITH (NOLOCK)

	TRUNCATE TABLE tbl_TransactionBuy_UniqueCode_Prev

	INSERT INTO tbl_TransactionBuy_UniqueCode_Prev
	SELECT *from tbl_TransactionBuy_UniqueCode_New WITH (NOLOCK)

	DROP  Synonym tbl_TransactionBuy_UniqueCode_syn

	Create Synonym tbl_TransactionBuy_UniqueCode_syn for tbl_TransactionBuy_UniqueCode_Prev

	TRUNCATE TABLE tbl_TransactionBuy_UniqueCode_New
	
	INSERT INTO tbl_TransactionBuy_UniqueCode_New(Sch_OptionFlag,Scheme_Code,ISIN,TranCode,tdate,clsb_code,app_code,BrkApplName,Clientcode,
			BUYSELL,PsubCode,BrkCategory,fund_code,schcode,Amount,Navdt,NAV,Units,BankName,Branch,AcNo,billto,Bcode,TranType,SubTranType,
			Expr1,RateType,FolioNo,ChqNo,Chqdt,Appno,ExeCD,Ar_No,Product,UPFRateAC,UPFAmtAC,UPRateIN,UpAmtIN,UPPRateIN,UpPAmtIN,AnnRateIN,
			AnnAmtIN,AnnPRateIN,AnnPAmtIN,UPRateOUT,UpAmtOUT,UPPRateOUT,UpPAmtOUT,AnnRateOUT,AnnAmtOUT,AnnPRateOUT,AnnPAmtOUT,EntryDate,
			ModifyDate,ActualBrokerCode,TXNNO,OrgTRType,DivRein,rowguid,recordID,TRRecoRef,Billpost,PayPost,bill_to,tcol,fd_mdate,uploadflag,
			DIVREINPROC,ARN_NO,remark,TrRecordid,AutoTr,FileDescription,DFRemarks,SIPStartDate,dpflag,OrderNo,Flag,Ticob_Trxn_Type,Ticob_Trxn_no,
			Ticob_Posted_date,Tax,total_tax,Cams_remarks,TrxnMode,PostDate,txnid,processdate,rmcode,Registrar,TranHead,TrxnType,Corporate_Action_No,
			Org_Nav,Org_Units,Transaction_head,Remarks,OrgArn,TrxnNo,EUIN,CityCategory,TrxnCharges,ValidEUIN,TD_PurRed,To_ProductCode,DPID,DpClientID,
			RejectionReferanceNo,Tr_PurRed,TaxStatus,incentivein,Incentive,TranEmailDT,BalUnits,DivAmt,seqno,taxben,OldClientcode,MergeDate,NavDate,
			requestcode,DStatus,panno,InPayStatus,PayStatus,MovedFrom,UpdateDescription,FtFolio,BrokerRule,RevTag,BSEREFNO)

	SELECT	* FROM #MFTransBuyData

	DROP  Synonym tbl_TransactionBuy_UniqueCode_syn

	Create Synonym tbl_TransactionBuy_UniqueCode_syn for tbl_TransactionBuy_UniqueCode_New


	IF OBJECT_ID('TEMPDB..#MFTransSaleData') IS NOT NULL
		DROP TABLE #MFTransSaleData

	SELECT		Sch_OptionFlag,Scheme_Code,ISIN,TranCode,tdate,clsb_code,app_code,BrkApplName,Clientcode,BUYSELL,PsubCode,BrkCategory,fund_code,schcode,
				Amount,Navdt,NAV,Units,BankName,Branch,AcNo,billto,Bcode,TranType,SubTranType,Expr1,RateType,FolioNo,ChqNo,Chqdt,Appno,ExeCD,Ar_No,Product,
				UPFRateAC,UPFAmtAC,UPRateIN,UpAmtIN,UPPRateIN,UpPAmtIN,AnnRateIN,AnnAmtIN,AnnPRateIN,AnnPAmtIN,UPRateOUT,UpAmtOUT,UPPRateOUT,UpPAmtOUT,
				AnnRateOUT,AnnAmtOUT,AnnPRateOUT,AnnPAmtOUT,EntryDate,ModifyDate,ActualBrokerCode,TXNNO,OrgTRType,DivRein,rowguid,recordID,TRRecoRef,Billpost,
				PayPost,bill_to,tcol,fd_mdate,uploadflag,DIVREINPROC,ARN_NO,remark,TrRecordid,AutoTr,FileDescription,DFRemarks,SIPStartDate,dpflag,OrderNo,Flag,
				Ticob_Trxn_Type,Ticob_Trxn_no,Ticob_Posted_date,Tax,total_tax,Cams_remarks,TrxnMode,PostDate,txnid,processdate,rmcode,Registrar,TranHead,TrxnType,
				Corporate_Action_No,Org_Nav,Org_Units,Transaction_head,Remarks,OrgArn,TrxnNo,EUIN,CityCategory,TrxnCharges,ValidEUIN,TD_PurRed,To_ProductCode,DPID,
				DpClientID,RejectionReferanceNo,Tr_PurRed,TaxStatus,incentivein,Incentive,TranEmailDT,BalUnits,DivAmt,seqno,taxben,OldClientcode,MergeDate,NavDate,
				requestcode,DStatus,panno,InPayStatus,PayStatus,MovedFrom,UpdateDescription,FtFolio,BrokerRule,RevTag,BSEREFNO
	INTO #MFTransSaleData
	FROM MutualFund.dbo.vw_TransactionSell_UniqueCode WITH (NOLOCK)

	TRUNCATE TABLE tbl_TransactionSell_UniqueCode_Prev

	INSERT INTO tbl_TransactionSell_UniqueCode_Prev
	SELECT *from tbl_TransactionSell_UniqueCode WITH (NOLOCK)

	DROP  Synonym tbl_TransactionSale_UniqueCode_syn

	Create Synonym tbl_TransactionSale_UniqueCode_syn for tbl_TransactionSell_UniqueCode_Prev

	TRUNCATE TABLE tbl_TransactionSell_UniqueCode

	INSERT INTO tbl_TransactionSell_UniqueCode (Sch_OptionFlag,Scheme_Code,ISIN,TranCode,tdate,clsb_code,app_code,BrkApplName,Clientcode,BUYSELL,PsubCode,
				BrkCategory,fund_code,schcode,Amount,Navdt,NAV,Units,BankName,Branch,AcNo,billto,Bcode,TranType,SubTranType,Expr1,RateType,FolioNo,ChqNo,
				Chqdt,Appno,ExeCD,Ar_No,Product,UPFRateAC,UPFAmtAC,UPRateIN,UpAmtIN,UPPRateIN,UpPAmtIN,AnnRateIN,AnnAmtIN,AnnPRateIN,AnnPAmtIN,UPRateOUT,
				UpAmtOUT,UPPRateOUT,UpPAmtOUT,AnnRateOUT,AnnAmtOUT,AnnPRateOUT,AnnPAmtOUT,EntryDate,ModifyDate,ActualBrokerCode,TXNNO,OrgTRType,DivRein,
				rowguid,recordID,TRRecoRef,Billpost,PayPost,bill_to,tcol,fd_mdate,uploadflag,DIVREINPROC,ARN_NO,remark,TrRecordid,AutoTr,FileDescription,
				DFRemarks,SIPStartDate,dpflag,OrderNo,Flag,Ticob_Trxn_Type,Ticob_Trxn_no,Ticob_Posted_date,Tax,total_tax,Cams_remarks,TrxnMode,PostDate,
				txnid,processdate,rmcode,Registrar,TranHead,TrxnType,Corporate_Action_No,Org_Nav,Org_Units,Transaction_head,Remarks,OrgArn,TrxnNo,EUIN,
				CityCategory,TrxnCharges,ValidEUIN,TD_PurRed,To_ProductCode,DPID,DpClientID,RejectionReferanceNo,Tr_PurRed,TaxStatus,incentivein,Incentive,
				TranEmailDT,BalUnits,DivAmt,seqno,taxben,OldClientcode,MergeDate,NavDate,requestcode,DStatus,panno,InPayStatus,PayStatus,MovedFrom,
				UpdateDescription,FtFolio,BrokerRule,RevTag,BSEREFNO)
	SELECT	* FROM #MFTransSaleData

	DROP  Synonym tbl_TransactionSale_UniqueCode_syn

	Create Synonym tbl_TransactionSale_UniqueCode_syn for tbl_TransactionSell_UniqueCode_Prev

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AMD_tblArnEuinMaster
-- --------------------------------------------------



CREATE PROCEDURE  [dbo].[USP_AMD_tblArnEuinMaster]

AS

BEGIN 

--If EXISTS (SELECT * FROM Sys.tables
--WHERE name = 'tblArnEuinMaster')
--BEGIN
--DROP TABLE tblArnEuinMaster
--END


--SELECT * INTO tblArnEuinMaster FROM [196.1.115.132].MUTUALFUND.DBO.tblArnEuinMaster

TRUNCATE TABLE tblArnEuinMaster

INSERT INTO tblArnEuinMaster (
								 [Sr No]
								,[SB Equity Tag]
								,[SB Name]
								,[ARN No]
								,[ARN Holder Name]
								,[Validity From]
								,[Validity To]
								,[EUIN No]
								)
								(
			SELECT 
				 [Sr No]
				,[SB Equity Tag]
				,[SB Name]
				,[ARN No]
				,[ARN Holder Name]
				,[Validity From]
				,[Validity To]
				,[EUIN No]
				
				 FROM [196.1.115.132].MUTUALFUND.DBO.tblArnEuinMaster WITH(NOLOCK))

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_AMD_UpdateSBClientDetails
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[Usp_AMD_UpdateSBClientDetails]
AS
BEGIN
	
	SET NOCOUNT ON 
	BEGIN Try 	
	BEGIN TRANSACTION

		TRUNCATE TABLE sb_client_details

		INSERT INTO sb_client_details
		(
			party_code, branch_cd, sub_broker, cl_code, email, long_name, mobile_pager, bank_name, first_active_date, last_inactive_date, B2C, 
			BSE_LAST_DATE, NSE_LAST_DATE, FO_LAST_DATE, NCDX_LAST_DATE, MCDX_LAST_DATE, nsx_last_Date, mcd_last_Date, bsefo_last_Date, comb_last_date, 
			EQ_AUM, MF_AUM, ARQEQInvstAmt, ARQEQLastPrice, ARQMFInvstAmt, ARQMFLastNAVPrice, ARQClient, mf_Active_Date, mf_last_date, InitialMargin,
			short_name,l_address1,l_address2,l_address3,l_city,l_state,l_nation,l_zip,pan_gir_no,CltDpId1,DPId,BSECM,NSECM,NSEFutures,NSECurrency,
			BSECurrency,MCXCurrency,MCX,NCX,MF
		)
		SELECT 
			party_code, branch_cd, sub_broker, cl_code, '' email, long_name, '' mobile_pager, bank_name, first_active_date, last_inactive_date, B2C, 
			BSE_LAST_DATE, NSE_LAST_DATE, FO_LAST_DATE, NCDX_LAST_DATE, MCDX_LAST_DATE, nsx_last_Date, mcd_last_Date, bsefo_last_Date, comb_last_date, 
			EQ_AUM, MF_AUM, ARQEQInvstAmt, ARQEQLastPrice, ARQMFInvstAmt, ARQMFLastNAVPrice, ARQClient, mf_Active_Date, mf_last_date, InitialMargin ,
			short_name,'' l_address1,'' l_address2,'' l_address3,l_city,l_state,l_nation,l_zip,'' pan_gir_no,CltDpId1,DPId,BSECM,NSECM,NSEFutures,NSECurrency,BSECurrency,
			MCXCurrency,MCX,NCX,MF
		FROM NXT.dbo.sb_client_details WITH (NOLOCK)
	COMMIT TRANSACTION;
	END TRY
	BEGIN CATCH
		ROLLBACK TRANSACTION
		DECLARE @Error_Message varchar(max) = ERROR_MESSAGE()

		IF @Error_Message IS NOT NULL
			RAISERROR(@Error_Message, 16, 1)
		ELSE
			RAISERROR(1, 1, 1)
	END CATCH;

	SET NOCOUNT OFF
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AMD_user_login
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_AMD_user_login]
AS
BEGIN

--------------------------Prev Table Insert------------------
		
TRUNCATE TABLE user_login_Prev

INSERT INTO user_login_Prev
SELECT
	userid 
	,person_name
	,username
	,userpassword
	,usertype
	,access_to
	,access_code
	,cat_code
	,status
	,last_login
	,NoOfTry
	,NoOfLogin
	,login_Activated
	,login_inactive_date
	,active
	,email
	,IP
	,IP_active
	,Gateway
	,Gateway_active
	,session_id
	,CreatedBy
	,CreatedOn
	,LastModifiedBy
	,LastModifiedOn
FROM user_login WITH (NOLOCK)
		
DROP SYNONYM user_login_syn

CREATE SYNONYM user_login_syn for user_login_Prev


--------------------------Original Table Insert------------------

TRUNCATE TABLE user_login
-----------------------------------------------------------------

INSERT INTO user_login
SELECT 
	userid
	,person_name
	,username
	,userpassword
	,usertype
	,access_to
	,access_code
	,cat_code
	,status
	,last_login
	,NoOfTry
	,NoOfLogin
	,login_Activated
	,login_inactive_date
	,active
	,email
	,IP
	,IP_active
	,Gateway
	,Gateway_active
	,session_id
	,CreatedBy
	,CreatedOn
	,LastModifiedBy
	,LastModifiedOn 
 
FROM 
[196.1.115.132].rolemgm.dbo.user_login WITH (NOLOCK)



DROP SYNONYM user_login_syn

CREATE SYNONYM user_login_syn for user_login

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_BigSavingDetails
-- --------------------------------------------------

CREATE  procedure [dbo].[usp_BigSavingDetails]
(
	@Sub_Broker varchar(100)
)

--EXEC [usp_BigSavingDetails] 'EMT'
as
begin


SELECT SB.long_name,party_code,VMF.TotalQty Units,CONVERT(NUMERIC(18,4),CONVERT(NUMERIC(18,4),nLastNav)*CONVERT(NUMERIC(18,4),VMF.TotalQty)) CurrentValue,nLastNav ,''  Actions
FROM 
[172.31.16.85].ABR_DW.dbo.IWMF_vw_ClientMFLFHoldings VMF WITH (NOLOCK)  
Inner join [196.1.115.132].MUTUALFUND.dbo.tblBigSavingAccount Big with (nolock)
ON VMF.PartyCode=Big.sClientCode
Inner join NXT.[dbo].[sb_client_details] SB  WITH (NOLOCK)
ON Big.sClientCode=SB.party_code
where sb.sub_broker=@Sub_Broker
AND lastnavprice IS NOT NULL   
		 AND prevnav IS NOT NULL  
		 AND DPFlag = 'PHY'  
		 AND TotalQty>0
		 order by CurrentValue desc

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USp_ChangeUserRolePermission
-- --------------------------------------------------

CREATE PROCEDURE USp_ChangeUserRolePermission
(
		@Userid varchar(100) ,
		@Roleid varchar(100),
		@ProjId varchar(100)

)
AS

--USp_UserRolePermission 2,102,1
BEGIN


		Update UserRolePermission
		Set 
			Roleid=@Roleid ,
			ProjectId=@ProjId 
		Where Userid =@Userid 


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ControllerMaster
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[usp_ControllerMaster]
(
		
		@ControllerName VARCHAR(200),
		@Active Bit
		
)

AS
BEGIN 

--usp_AddNewRole 'AAA','Node','10'

SET NOCOUNT ON 
BEGIN TRANSACTION
BEGIN TRY 

	INSERT INTO ControllerMaster(ControllerName,Active)
	Select 	@ControllerName,@Active
	
	Commit


END TRY  
BEGIN CATCH  
   	SELECT  
        ERROR_NUMBER() AS ErrorNumber  
        ,ERROR_SEVERITY() AS ErrorSeverity  
        ,ERROR_STATE() AS ErrorState  
        ,ERROR_PROCEDURE() AS ErrorProcedure  
        ,ERROR_LINE() AS ErrorLine  
        ,ERROR_MESSAGE() AS ErrorMessage;  
 Rollback
END CATCH

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Dash_MF_LUMSUMClients
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[Usp_Dash_MF_LUMSUMClients]
@sub_broker varchar(200)
AS

/*
CREATED BY	: PRASAD KHARADE
PARAMETER	: EXEC [Usp_Dash_MF_LUMSUMClients]'GDS'

*/

BEGIN
	
select Sub_Broker,Client_Code,Client_Name,LUMPSUM_Amount from 
(
	SELECT s.sub_broker as Sub_Broker,Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as LUMPSUM_Amount,
	Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE S.sub_broker = @Sub_Broker
	UNION
	select s.sub_broker,
	Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as LUMPSUM_Amount
	,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	from sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	where S.sub_broker = @Sub_Broker
 ) T
where Investment_Type='LUMPSUM' and LUMPSUM_Amount <> 0
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Dash_MF_LUMSUMClients_Opti
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_Dash_MF_LUMSUMClients_opti]
@sub_broker varchar(200)
AS

/*
CREATED BY	: PRASAD KHARADE
PARAMETER	: EXEC [Usp_Dash_MF_LUMSUMClients]'GDS'

*/

BEGIN

SET NOCOUNT  ON
	
select Sub_Broker,Client_Code,Client_Name,LUMPSUM_Amount from 
(
	SELECT s.sub_broker as Sub_Broker,Party_Code as Client_Code,S.long_name  as Client_Name,ISNULL(TB.Amount,0) as LUMPSUM_Amount
	,SubTranType
	--,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE S.sub_broker = 'GDS' and  SubTranType = ''
	UNION
	select s.sub_broker,
	Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as LUMPSUM_Amount
	,SubTranType
	--,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	from sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	where S.sub_broker = 'GDS' and SubTranType = ''
 ) T
where  LUMPSUM_Amount >0 

	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Dash_MF_SIPClientCount
-- --------------------------------------------------


CREATE PROC usp_Dash_MF_SIPClientCount
@SubBroker varchar(100)=NULL

AS

BEGIN

/*
CREATED BY: PRASAD KHARADE

DESCRIPTION : GIVES COUNT OF SIP CLIENTS SUBBROKER WISE

EXECUTION PARAMETER: [usp_Dash_MF_SIPClientCount] 'GDS'
					 [usp_Dash_MF_SIPClientCount] 'EMT'
					 [usp_Dash_MF_SIPClientCount] 'ET'
 
*/



SET NOCOUNT ON

;WITH ResultCTE AS
(
	SELECT 
	s.sub_broker,
	Party_Code Client_Code--,
	,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM 
	sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE 
		S.sub_broker = @SubBroker or @SubBroker is null
	UNION
	SELECT 
			s.sub_broker,
			Party_Code Client_Code--,
			--Amount Cr_amt, 0 as dr_amt ,
			,CASE WHEN SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE 
	S.sub_broker = @SubBroker or @SubBroker is null
)
select sub_broker,COUNT(1) as SIPClientCount from ResultCTE 
WHere Investment_Type='SIP' 
GROUP by sub_broker


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Dash_MF_SIPClients
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[Usp_Dash_MF_SIPClients]
@sub_broker varchar(200)
AS

/*
CREATED BY :		PRASAD KHARADE
PARAMETER  :		EXEC [Usp_Dash_MF_SIPClients]'GDS'
*/

BEGIN


--Declare @sub_broker varchar(100)='GDS'
	
select Sub_Broker,Client_Code,Client_Name,SIP_Amount from 
(
	SELECT s.sub_broker as Sub_Broker,Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIP_Amount,
	Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE S.sub_broker = @Sub_Broker
	UNION
	select s.sub_broker,
	Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIPAMOUNT
	,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	from sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	where S.sub_broker = @Sub_Broker
 ) T
where Investment_Type='SIP' and SIP_Amount <> 0
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Dash_MF_SIPClients_opti
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_Dash_MF_SIPClients_opti]
@sub_broker varchar(200)
AS

/*
CREATED BY :		PRASAD KHARADE
PARAMETER  :		EXEC [Usp_Dash_MF_SIPClients]'GDS'
*/

BEGIN


--Declare @sub_broker varchar(100)='GDS'
--Declare @s datetime=getdate()
select Sub_Broker,Client_Code,Client_Name,SIP_Amount from 
(
	SELECT s.sub_broker as Sub_Broker,Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIP_Amount,SubTranType
	--Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE S.sub_broker = 'GDS'
	UNION
	select s.sub_broker,
	Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIPAMOUNT,SubTranType
	--,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	from sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	where S.sub_broker = 'GDS'
 ) T
where  SIP_Amount <> 0 and SubTranType = 'SIP'
--Investment_Type='SIP' and
--Select datediff(ms,@s,GETDATE())

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Dash_MF_SIPClients_opti16042018
-- --------------------------------------------------
/*
Declare @s datetime=getdate()
EXEC [Usp_Dash_MF_SIPClients_opti16042018]'GDS'
select datediff (ms,@s,getdate())
*/


CREATE PROCEDURE [dbo].[Usp_Dash_MF_SIPClients_opti16042018]
@sub_broker varchar(200)
AS

/*
CREATED BY :		PRASAD KHARADE
PARAMETER  :		EXEC [Usp_Dash_MF_SIPClients]'GDS'
*/

BEGIN


--Declare @sub_broker varchar(100)='GDS'
	/*
select Sub_Broker,Client_Code,Client_Name,SIP_Amount from 
(
	SELECT s.sub_broker as Sub_Broker,Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIP_Amount,
	Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE S.sub_broker = 'GDS'
	UNION
	select s.sub_broker,
	Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIPAMOUNT
	,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	from sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	where S.sub_broker = 'GDS'
 ) T
where Investment_Type='SIP' and SIP_Amount <> 0
*/	

select Sub_Broker,Client_Code,Client_Name,SIP_Amount from 
(
	SELECT s.sub_broker as Sub_Broker,Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIP_Amount,
	Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE S.sub_broker =  @sub_broker
	UNION
	select s.sub_broker,
	Party_Code Client_Code,S.long_name Client_Name,ISNULL(TB.Amount,0) as SIPAMOUNT,
	Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	from sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	where S.sub_broker =  @sub_broker
 ) T
where Investment_Type <> 'SIP' and SIP_Amount <> 0


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Dash_MF_TickerIndex
-- --------------------------------------------------

CREATE  PROC [dbo].[usp_Dash_MF_TickerIndex]
AS
BEGIN 


SET NOCOUNT ON 


SELECT 
CASE WHEN Symbol='CNXMIDCAP' THEN 'NIFTYMID100'
				WHEN Symbol='CNXREALTY'  THEN 'REALITY'
				WHEN Symbol='CNXIT' THEN 'NIFTYIT'
				ELSE Symbol END symbol




,	CurrValue	,absolutechange	,NetChangeFromPrevClose



FROM
(
SELECT
		case when VI.co_code=20559 then 1 
		     when VI.co_code=20558 then 2
			 --when VI.co_code=26753 then 9
			 when VI.co_code=26000 then 3
			 when VI.co_code=26009 then 4
			 when VI.co_code=26044 then 5
			 when VI.co_code=26021 then 6
			 when VI.co_code=26008 then 7
		END Order_by,
			 case when VI.symbol='BSESENSEX' then 'SENSEX' 
			 when VI.symbol='BANKNIFTY' then 'Bank Nifty' ELSE VI.symbol END as symbol, 
			 nLastTradedPrice CurrValue,
	substring(case when (nLastTradedPrice)>(PrevClose) THEN  '+' +cast(((nLastTradedPrice) - (PrevClose)) as Varchar(200)) ELSE cast(((nLastTradedPrice) - (PrevClose)) as varchar(200))  END
	 ,1,charindex('.',case when (nLastTradedPrice)>(PrevClose) THEN  '+' +cast(((CurrValue) - (PrevClose)) as Varchar(200)) ELSE cast(((nLastTradedPrice) - (PrevClose)) as varchar(200)) 
	 END )+2) absolutechange,
	substring(
		CASE WHEN nLastTradedPrice/100.00 >PrevClose/100.00 THEN '+'+ cast(ROUND(((nLastTradedPrice/100.00) - (PrevClose/100.00))*100/ (PrevClose/100.00),2) as varchar(200))
		ELSE Cast(ROUND(((nLastTradedPrice/100.00) - (PrevClose/100.00))*100/ (PrevClose/100.00),2) as varchar(200)) END 
		,1,charindex('.',CASE WHEN nLastTradedPrice/100.00 >(PrevClose/100.00) THEN '+'+ cast(ROUND(((nLastTradedPrice/100.00) - (PrevClose/100.00))*100/ (PrevClose/100.00),2) as varchar(200))
		ELSE Cast(ROUND(((nLastTradedPrice/100.00) - (PrevClose/100.00))*100/ (PrevClose/100.00),2) as varchar(200)) END )+2)	NetChangeFromPrevClose
		FROM [172.31.16.75].ANGEL_WMS.DBO.Vw_IndianIndices VI WITH(NOLOCK) 
		Inner JOIN 
		(
			SELECT 													
				--VSM.co_code,
				VWF.sSeries,
				
				CASE WHEN VWF.sSymbol='NIFTYMID100' THEN 'CNXMIDCAP'
				WHEN VWF.sSymbol='REALITY'  THEN 'CNXREALTY'
				WHEN VWF.sSymbol='NIFTYIT' THEN 'CNXIT'
				ELSE VWF.sSymbol END sSymbol,
				
				
				--VWF.sSymbol,
				VWF.nToken,
				VWF.nMarketSegmentId,
				NSEEQ.nLastTradedPrice/100.00 nLastTradedPrice,
				CASE WHEN PREV.nLastTradedPrice <>0 then PREV.nLastTradedPrice/100.00 else  isnull(PREV.nClose/100.00,0) END PrevClose
		FROM 

				[172.31.16.85].[ODINFEED].[dbo].tbl_ScripMaster VWF WITH (NOLOCK)
				INNER JOIN [172.31.16.85].[ODINFEED].[dbo].[tbl_MarketTickInfo_NSEEQ_Prev] PREV  WITH (NOLOCK) ON VWF.nMarketSegmentId=PREV.nMarketSegmentId AND VWF.nToken=PREV.nToken
				INNER JOIN [172.31.16.85].[ODINFEED].[dbo].[tbl_MarketTickInfo_NSEEQ] NSEEQ  WITH (NOLOCK) ON VWF.nMarketSegmentId=NSEEQ.nMarketSegmentId AND VWF.nToken=NSEEQ.nToken
		where VWF.nToken in (26000,26009,26044,26021,26008)
		--where VWF.nToken in (26000,26009,26044,26021,26008)

		UNION
		
			SELECT 													
				--VSM.co_code,
				VWF.sSeries,
				'BSESENSEX' sSymbol,
				VWF.nToken,
				VWF.nMarketSegmentId,
				BSEEQ.nLastTradedPrice/100.00 nLastTradedPrice,
				CASE WHEN PREV.nLastTradedPrice <>0 then PREV.nLastTradedPrice/100.00 else  isnull(PREV.nClose/100.00,0) END PrevClose
		FROM 

				[172.31.16.85].[ODINFEED].[dbo].tbl_ScripMaster VWF WITH (NOLOCK)
				INNER JOIN [172.31.16.85].[ODINFEED].[dbo].[tbl_MarketTickInfo_BSEEQ_Prev] PREV  WITH (NOLOCK) ON VWF.nMarketSegmentId=PREV.nMarketSegmentId AND VWF.nToken=PREV.nToken
				INNER JOIN [172.31.16.85].[ODINFEED].[dbo].[tbl_MarketTickInfo_BSEEQ] BSEEQ  WITH (NOLOCK) ON VWF.nMarketSegmentId=BSEEQ.nMarketSegmentId AND VWF.nToken=BSEEQ.nToken
		where VWF.nToken in (19000)
		) T ON 
		T.sSymbol COLLATE  database_default=VI.Symbol COLLATE  database_default
		



/*
UNION

		SELECT 
		case when P.NAME='Nikkei 225' then 3 	
			 when P.NAME='DAX' then 4 
			 when P.Name='Nasdaq'then 5  
			 when P.Name='DJIA'then 6 
			 --when P.Name='Straits Times'then 6 
			 --when P.Name='S&P 100' then 7 
			 when P.Name='S&P 500'then 7
			 END Order_by,
		CASE WHEN P.NAME='Nikkei 225' THEN 'Nikkei' ELSE P.NAME END Exchange, index_value, 
		
		CASE WHEN change_value>0 then '+'+
		convert(varchar(10),substring (convert(varchar(10),change_value),1,charindex('.',change_value)))
		+ convert(varchar(10),substring(convert(varchar(10),change_value), charindex('.',change_value)+1,2)) ELSE 
			convert(varchar(10),substring (convert(varchar(10),change_value),1,charindex('.',change_value)))
			+ convert(varchar(10),substring(convert(varchar(10),change_value), charindex('.',change_value)+1,2))
		
		 END AS	change_value, 
		
		CASE WHEN pchange>0 then '+'+
		convert(varchar(10),substring (convert(varchar(10),pchange),1,charindex('.',pchange)))
		+ convert(varchar(10),substring(convert(varchar(10),pchange), charindex('.',pchange)+1,2))	else 
				convert(varchar(10),substring (convert(varchar(10),pchange),1,charindex('.',pchange)))
		+ convert(varchar(10),substring(convert(varchar(10),pchange), charindex('.',pchange)+1,2))
		END pchange

		 --FROM [172.31.16.75].ANGEL_WMS.DBO.Vw_GlobalIndices GI WITH(NOLOCK) 
		 FROM FSS_EQUITY.dbo.feed_windicesmaster M WITH (NOLOCK)
		INNER JOIN FSS_EQUITY.dbo.bi_worldindices_latestprices P WITH (NOLOCK) ON M.NAME = P.NAME
		
		WHERE P.NAME IN ('DAX','Nikkei 225','Nasdaq','DJIA','S&P 500')
*/

) T
ORDER BY Order_by
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Delete_ApplicationForm
-- --------------------------------------------------
-- =============================================
-- Author:                Sharad Patil
-- Create date: 26-March-2018
-- Description:        To Delete Apllication form details

-- EXEC [USP_Delete_ApplicationForm] 'A123','GDS'

-- =============================================

CREATE PROCEDURE [dbo].[USP_Delete_ApplicationForm] 
        (
         @ApplicationNo VARCHAR (100)
        ,@Sb_Code VARCHAR (100)
                
        )

AS
SET NOCOUNT ON
BEGIN

        DELETE
        FROM ApplicationForm 
        WHERE Applicationno =@ApplicationNo 
        and Sb_Code = @Sb_Code 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------
      
CREATE PROCEDURE USP_FINDINUSP                    
 @DBNAME VARCHAR(500),                  
 @SRCSTR VARCHAR(500)                    
AS                    
                    
 SET NOCOUNT ON                  
 SET @SRCSTR  = '%' + @SRCSTR + '%'                    
                  
 DECLARE @STR AS VARCHAR(1000),@xdbname as varchar(500)                  
      
 set @xdbname=@DBNAME      
      
 SET @STR=''                  
 IF @DBNAME <>''                  
 BEGIN                  
 SET @DBNAME=@DBNAME+'.DBO.'                  
 END                  
 ELSE                  
 BEGIN                  
 SET @DBNAME=DB_NAME()+'.DBO.'                  
 END                  
 ----PRINT @DBNAME                  
                  
 SET @STR='SELECT DISTINCT '''+@xdbname+''' as DBNAME,O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '                   
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '                   
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                    
 PRINT @STR                  
  EXEC(@STR)                  
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Get_ApplicationFormDetails
-- --------------------------------------------------

-- =============================================
-- Author:		Sharad Patil
-- Create date: 26-March-2018
-- Description:	To fetch Apllication form details

-- EXEC [Usp_Get_ApplicationFormDetails] 'GDS'

-- =============================================

CREATE PROCEDURE [dbo].[usp_Get_ApplicationFormDetails] 
	(
	 @Sb_Code VARCHAR (100)
	--,@InvestmentType VARCHAR (30)
		
	)

AS
SET NOCOUNT ON

--declare @Sb_Code VARCHAR (100) = 'GDS'
BEGIN

	select	
	ApplicationNo,
	InvestorName + ' | ' + PAN as InvestorName_PAN,
	InvestorName,
	PAN,
	CAST(LoginDate as DATE) as LoginDate,
	SchemeName,
	ChequeNo + ' | ' + CONVERT(VARCHAR, ChequeDate, 103) as ChequeNo_ChequeDate,
	ChequeNo,
	CAST(ChequeDate as DATE) as ChequeDate,
	BankName
	--CASE WHEN @InvestmentType = 'Lumpsum' then Amount Else InstallmentAmount end as Amount
	,Amount
	,InstallmentAmount
	,CAST(CONVERT(DATE,SIP_StartDate) as varchar (20)) + ' - ' +   CAST(CONVERT(DATE,SIP_EndtDate) as varchar (20)) + ' | ' + CAST(NoOfInstallments as varchar (20)) as SIPPeriod_NoofInstallment

	from ApplicationForm WITH (NOLOCK)
	where Sb_Code=@Sb_Code --and InvestmentType=@InvestmentType

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetAssetWiseSchemeWiseAll
-- --------------------------------------------------

CREATE PROC [dbo].[Usp_GetAssetWiseSchemeWiseAll]
(
--Declare 	
	@SubBroker VARCHAR (10)='EMT'
)
AS
BEGIN 

SET NOCOUNT ON 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].Usp_GetAssetWiseSchemeWiseAll 'EMT'
--exec [dbo].[Usp_GetAssetWiseSchemeWiseAll] 'AJYC'
Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate

--select * from ##temp2 --where type_of_fund='Funds of Funds'


select  GROUPING_ID(case when type_of_fund not in ('Debt','ELSS','Equity','Liquid Fund','Balanced fund') then 'Other' Else type_of_fund end,SchemeName) AS 'Grouping_Level' ,
case when type_of_fund not in ('Debt','ELSS','Equity','Liquid Fund','Balanced fund') then 'Other' Else type_of_fund end as type_of_fund,SchemeName,max(fund_code) as Fund_Code,--count(distinct fund_code) as party_code,
 sum(presentvalue) as present_value,
sum(investedAmount) as investedAmount
,sum(noofclient) as noofclient
INTO #tEMP
 FROM ##temp2 
GROUP BY ROLLUP(case when type_of_fund not in ('Debt','ELSS','Equity','Liquid Fund','Balanced fund') then 'Other' Else type_of_fund end,SchemeName)
--HAVING GROUPING_ID(type_of_fund,SchemeName)<>1
ORDER BY GROUPING_ID(case when type_of_fund not in ('Debt','ELSS','Equity','Liquid Fund','Balanced fund') then 'Other' Else type_of_fund end,SchemeName)

	--select '#tEMP',* from ##temp2 
--select * from #tEMP --order by type_of_fund,	SchemeName


SELECT row_number() over (partition by case type_of_fund when 'Equity' then 'a'
When 'Debt' then 'b'
When 'ELSS' then 'c'
when 'Liquid fund' then 'd'
when 'Balanced fund' then 'e'
when 'Other' then 'f' end,Grouping_Level Order by  type_of_fund ) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	
	
	--select '#TEMP1',* from #TEMP1
	--where Order_By=1

		update #TEMP1 
		set type_of_fund = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		,Fund_COde = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN '' else Fund_Code end
		where (schemename is NULL or schemename ='')
		--and type_of_fund is not null
		and Order_By=1
		--and Grouping_Level in (3,4)

SELECT 
	--Grouping_Level,Order_By,
		type_of_fund = Case when type_of_fund is null THEN 'Grand Total' ELSE type_of_fund END ,
		schemename = CASE WHEN type_of_fund is null THEN 'Grand Total' WHEN type_of_fund = 'Total' THEN '' ELSE ISNULL(schemename,'') END,
		Fund_Code,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		--isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient as Total_clients
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		--Grouping_Level,Order_By,
		type_of_fund ='Grand Total' ,
		--schemename = CASE WHEN  type_of_fund  is null THEN 'Grand Total' WHEN  type_of_fund = 'Total' THEN '' ELSE ISNULL(schemename,'') END,
		schemename = '',
		Fund_Code,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		--isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient  as Total_clients
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


drop table #tEMP
drop table #TEMP1
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetAssetWiseSchemeWiseAll_2
-- --------------------------------------------------

CREATE PROC [dbo].[Usp_GetAssetWiseSchemeWiseAll_2]
(
--Declare 	
	@SubBroker VARCHAR (10)='EMT'
)
AS
BEGIN 

SET NOCOUNT ON 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].Usp_GetAssetWiseSchemeWiseAll 'EMT'
--exec [dbo].[Usp_GetAssetWiseSchemeWiseAll_1] 'EMT'
Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate

--select * from ##temp2 --where type_of_fund='Funds of Funds'

select  GROUPING_ID(type_of_fund,SchemeName,fund_code) AS 'Grouping_Level' ,
type_of_fund,SchemeName,fund_code,--count(distinct fund_code) as party_code,
 sum(presentvalue) as present_value,
sum(investedAmount) as investedAmount
,sum(noofclient) as noofclient
INTO #tEMP
 FROM ##temp2 
GROUP BY ROLLUP(type_of_fund,SchemeName,fund_code)
--HAVING GROUPING_ID(type_of_fund,SchemeName)<>1
ORDER BY GROUPING_ID(type_of_fund,SchemeName,fund_code)

	--select * from ##temp2 
select 1,* from #tEMP --order by type_of_fund,	SchemeName


SELECT row_number() over (partition by type_of_fund,SchemeName,fund_code,Grouping_Level order by type_of_fund) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	
	select 2,* from #TEMP1

		update #TEMP1 
		set type_of_fund = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where (schemename is NULL or schemename ='')
		--and type_of_fund is not null
		and Order_By=1
		--and Grouping_Level in (3,4)

SELECT 
	--Grouping_Level,Order_By,
		type_of_fund = Case when type_of_fund is null THEN 'Grand Total' ELSE type_of_fund END ,
		schemename = CASE WHEN type_of_fund is null THEN 'Grand Total' WHEN type_of_fund = 'Total' THEN '' ELSE ISNULL(schemename,'') END,
		Fund_Code,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		--isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient as Total_clients
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		--Grouping_Level,Order_By,
		type_of_fund ='Grand Total' ,
		--schemename = CASE WHEN  type_of_fund  is null THEN 'Grand Total' WHEN  type_of_fund = 'Total' THEN '' ELSE ISNULL(schemename,'') END,
		schemename = '',
		fund_code,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		--isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient  as Total_clients
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


drop table #tEMP
drop table #TEMP1
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetAssetWiseSchemeWiseAll_bkp2018May17
-- --------------------------------------------------

CREATE PROC [dbo].[Usp_GetAssetWiseSchemeWiseAll_bkp2018May17]
(
--Declare 	
	@SubBroker VARCHAR (10)='EMT'
)
AS
BEGIN 

SET NOCOUNT ON 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].Usp_GetAssetWiseSchemeWiseAll 'EMT'
--exec [dbo].[Usp_GetAssetWiseSchemeWiseAll] 'EMT'
Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate

--select * from ##temp2 --where type_of_fund='Funds of Funds'

select  GROUPING_ID(type_of_fund,SchemeName) AS 'Grouping_Level' ,
type_of_fund,SchemeName,--count(distinct fund_code) as party_code,
 sum(presentvalue) as present_value,
sum(investedAmount) as investedAmount
,sum(noofclient) as noofclient
INTO #tEMP
 FROM ##temp2 
GROUP BY ROLLUP(type_of_fund,SchemeName)
--HAVING GROUPING_ID(type_of_fund,SchemeName)<>1
ORDER BY GROUPING_ID(type_of_fund,SchemeName)

	--select * from ##temp2 
--select * from #tEMP --order by type_of_fund,	SchemeName


SELECT row_number() over (partition by type_of_fund,Grouping_Level order by type_of_fund) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	
	--select * from #TEMP1

		update #TEMP1 
		set type_of_fund = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where (schemename is NULL or schemename ='')
		--and type_of_fund is not null
		and Order_By=1
		--and Grouping_Level in (3,4)

SELECT 
	--Grouping_Level,Order_By,
		type_of_fund = Case when type_of_fund is null THEN 'Grand Total' ELSE type_of_fund END ,
		schemename = CASE WHEN type_of_fund is null THEN 'Grand Total' WHEN type_of_fund = 'Total' THEN '' ELSE ISNULL(schemename,'') END,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		--isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient as Total_clients
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		--Grouping_Level,Order_By,
		type_of_fund ='Grand Total' ,
		--schemename = CASE WHEN  type_of_fund  is null THEN 'Grand Total' WHEN  type_of_fund = 'Total' THEN '' ELSE ISNULL(schemename,'') END,
		schemename = '',
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		--isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient  as Total_clients
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


drop table #tEMP
drop table #TEMP1
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll
-- --------------------------------------------------
CREATE  PROC [dbo].Usp_GetFundWiseSchemeWiseAll
(
	@SubBroker VARCHAR (10)='ET'
)
AS
BEGIN 

sET nocount on 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].[Usp_GetFundWiseSchemeWiseAll_NNEW] 'EMT'
--exec [dbo].[Usp_GetFundWiseSchemeWiseAll] 'EMT'
Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate
--Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_111 NULL	,NULL	,'EMT'	,NULL	,NULL	,NULL	,'1900-01-01',	'2018-04-18'

--Select * from ##temp2

select GROUPING_ID(fund_code,SchemeName,type_of_fund) AS 'Grouping_Level' ,
fund_code,SchemeName,type_of_fund,count(distinct fund_code) as party_code, sum(presentvalue) as present_value,
sum(investedAmount) as investedAmount,sum(noofclient) as noofclient

into #tEMP
 from ##temp2 
group by ROLLUP(fund_code,SchemeName,type_of_fund )
	having GROUPING_ID(fund_code,SchemeName,type_of_fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,type_of_fund)
	--select * from ##temp2 
--select * from #tEMP

--drop table #tEMP
SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient as Total_clients
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient  as Total_clients
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_BKP_08Apr2018
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_BKP_08Apr2018]
(
@SubBroker VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll] 'EMT'

	SELECT 	GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count(Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	inner JOIN 
	(
	select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.sub_broker=@SubBroker
	--AND  isnull(T.SchemeClassDescription ,'')<>''
	) T 
	group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)
	
	--select * from #Temp	where 
	
	
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		Case when fund_code is null THEN 'Grand Total' ELSE fund_code END  fund_code,
		ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		Case when fund_code is null THEN 'Grand Total' ELSE fund_code END  fund_code,
		ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


DROP TABLE #TEMP
DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_bkp_20180502
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_bkp_20180502]
(
@SubBroker VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll] 'EMT'

	SELECT 	GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count(Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	inner JOIN 
	(
	--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.sub_broker=@SubBroker
	--AND  isnull(T.SchemeClassDescription ,'')<>''
	) T 
	group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)
	
	--select * from #Temp	where 
	
	
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


DROP TABLE #TEMP
DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_bkp_2018may10
-- --------------------------------------------------
CREATE  PROC [dbo].[Usp_GetFundWiseSchemeWiseAll_bkp_2018may10]
(
	@SubBroker VARCHAR (10)='ET'
)
AS
BEGIN 

sET nocount on 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].[Usp_GetFundWiseSchemeWiseAll_v3] 'ET'

select GROUPING_ID(fund_code,SchemeName,SchemeClassDescription) AS 'Grouping_Level' ,
	fund_code,hldg.SchemeName,	count(distinct hldg.party_Code) Total_clients,	Sum(Angel_Qty*avg_rate) 'InvestmentAmount'
,T.SchemeClassDescription 'Type_of_Fund' 
,sum((Angel_Qty*LastNAVPrice)) 'Total_AUM'
into #tEMP
 from 
IWMF_trn_current_holding_syn HLDG with (nolock)
INNER JOIN sb_client_details SB
ON HLDG.party_Code=SB.party_Code
left JOIN 
	(
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
				THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode
				from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
--where substring(fsSchemeCode,2,len(fsSchemeCode))='14059455.002067'
WHERE sub_broker=@SubBroker
--group by fund_code,hldg.SchemeName,T.SchemeClassDescription 
group by ROLLUP(fund_code,hldg.SchemeName,T.SchemeClassDescription )
	having GROUPING_ID(fund_code,SchemeName,SchemeClassDescription)<>1
	order by GROUPING_ID(fund_code,SchemeName,SchemeClassDescription)


	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_Bkp09May2018
-- --------------------------------------------------

Create procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_Bkp09May2018]
(
@SubBroker VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll] 'EMT'

	SELECT 	GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count(Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	inner JOIN 
	(
	--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.sub_broker=@SubBroker
	--AND  isnull(T.SchemeClassDescription ,'')<>''
	) T 
	group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)
	
	--select * from #Temp	where 
	
	
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


DROP TABLE #TEMP
DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_Count
-- --------------------------------------------------
CREATE  PROC [dbo].[Usp_GetFundWiseSchemeWiseAll_Count]
(
	@SubBroker VARCHAR (10)='ET',
	@Period VARCHAR(5) = 'YTD'
)
AS
BEGIN 

sET nocount on 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].[Usp_GetFundWiseSchemeWiseAll_NNEW] 'EMT'
--exec [dbo].[Usp_GetFundWiseSchemeWiseAll] 'EMT'
Declare @edate as date,
@sdate Date
select @sdate = dbo.fn_Get_StartData(@Period)
Set @edate = cast(getdate() as date)--'2018-04-18'

EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_Total NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,@sdate,	@edate
--Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_111 NULL	,NULL	,'EMT'	,NULL	,NULL	,NULL	,'1900-01-01',	'2018-04-18'

--Select * from ##temp2

select GROUPING_ID(fund_code,SchemeName,type_of_fund) AS 'Grouping_Level' ,
fund_code,SchemeName,type_of_fund,count(distinct fund_code) as party_code, sum(presentvalue) as present_value,
sum(investedAmount) as investedAmount,sum(noofclient) as noofclient

into #tEMP
 from ##temp2 
group by ROLLUP(fund_code,SchemeName,type_of_fund )
	having GROUPING_ID(fund_code,SchemeName,type_of_fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,type_of_fund)
	--select * from ##temp2 
--select * from #tEMP

--drop table #tEMP
SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		present_value as Total_AUM,
		investedAmount as InvestmentAmount,
		isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient as Total_Clients
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		present_value as Total_AUM,
		investedAmount as InvestmentAmount,
		isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient  as Total_Clients
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_New1
-- --------------------------------------------------
CREATE PROC [dbo].[Usp_GetFundWiseSchemeWiseAll_New1]
(
	@SubBroker VARCHAR (10)='ET'
)
AS
BEGIN 

sET nocount on 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].[Usp_GetFundWiseSchemeWiseAll_v3] 'ET'

select 
--GROUPING_ID(fund_code,SchemeName,SchemeClassDescription) AS 'Grouping_Level' ,
--	fund_code,hldg.SchemeName,	count(distinct hldg.party_Code) Total_clients,	Sum(Angel_Qty*avg_rate) 'InvestmentAmount'
--,
T.SchemeClassDescription 'Type_of_Fund' 
,sum((Angel_Qty*LastNAVPrice)) 'Total_AUM'
--into #tEMP
 from 
IWMF_trn_current_holding_syn HLDG with (nolock)
INNER JOIN sb_client_details SB WITH (NOLOCK)
ON HLDG.party_Code=SB.party_Code
left JOIN 
	(
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
				THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode
				from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
--where substring(fsSchemeCode,2,len(fsSchemeCode))='14059455.002067'
WHERE sub_broker=@SubBroker
--group by fund_code,hldg.SchemeName,T.SchemeClassDescription 
group by --fund_code,hldg.SchemeName,
T.SchemeClassDescription 
	--having GROUPING_ID(fund_code,SchemeName,SchemeClassDescription)<>1
	--order by GROUPING_ID(fund_code,SchemeName,SchemeClassDescription)


--	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
--	INTO #TEMP1
--	FROM #TEMP 
--	--where fund_code in ('14011040','14050025')
--	--and schemename is NULL
	
--		update #TEMP1 
--		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
--		where schemename is NULL
--		and fund_code is not null
--		and Order_By=1
--		and Grouping_Level in (3,4)
--		--and fund_code IN ('14011040','14050025')

--SELECT 
--		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
--		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
--		--ISNULL(schemename,'') schemename,
--		InvestmentAmount,
--		Total_AUM,
--		isnull(Type_of_Fund,'') Type_of_Fund,
--		Total_clients 
----INTO #Final
--FROM #TEMP1 
--where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
--UNION ALL
--SELECT 
--		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
--		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
--		--ISNULL(schemename,'') schemename,
--		InvestmentAmount,
--		Total_AUM,
--		isnull(Type_of_Fund,'') Type_of_Fund,
--		Total_clients 
--FROM #TEMP1 
--where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_NNEW
-- --------------------------------------------------
CREATE  PROC [dbo].Usp_GetFundWiseSchemeWiseAll_NNEW
(
	@SubBroker VARCHAR (10)='ET'
)
AS
BEGIN 

sET nocount on 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].[Usp_GetFundWiseSchemeWiseAll_NNEW] 'EMT'
--exec [dbo].[Usp_GetFundWiseSchemeWiseAll] 'EMT'
Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate
--Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_111 NULL	,NULL	,'EMT'	,NULL	,NULL	,NULL	,'1900-01-01',	'2018-04-18'

--Select * from ##temp2

select GROUPING_ID(fund_code,SchemeName,type_of_fund) AS 'Grouping_Level' ,
fund_code,SchemeName,type_of_fund,count(distinct fund_code) as party_code, sum(presentvalue) as present_value,
sum(investedAmount) as investedAmount,sum(noofclient) as noofclient

into #tEMP
 from ##temp2 
group by ROLLUP(fund_code,SchemeName,type_of_fund )
	having GROUPING_ID(fund_code,SchemeName,type_of_fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,type_of_fund)
	--select * from ##temp2 
--select * from #tEMP

--drop table #tEMP
SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient as Total_clients
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		investedAmount as InvestmentAmount,
		present_value as Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		noofclient  as Total_clients
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_v2
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_v2]
(
@SubBroker VARCHAR (10),
@Period VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2] 'ET','mTD'
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2] 'ET','yTD'

	DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

		--SELECT @SDate

	SELECT 	--GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count( Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			 HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB WITH (NOLOCK)
	ON HLDG.party_Code=SB.party_Code
	--Inner join MutualFund.dbo.transactiondetail td with (nolock)
	Inner join (select distinct AgentCode from MutualFund.dbo.transactiondetail td with (nolock) where  td.TranDate between  @SDate and @EDate ) td
	ON td.AgentCode=SB.sub_broker
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	left JOIN 
	(
			--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
				THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	
				from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--And  td.TranDate between  @SDate and @EDate 
	AND  SB.sub_broker=@SubBroker
	) T 
	where Type_of_Fund <> '' 
	group by fund_code,SchemeName,Type_of_Fund
		--and isnull(SchemeName,'')<>'' and SchemeName<>'NULL'
	--group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	--having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	--order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)

	--select * from #Temp	where 
	
	/*
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )

*/

select * from #Temp


DROP TABLE #TEMP
--DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_v2_07May2018
-- --------------------------------------------------

Create  procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_v2_07May2018]
(
@SubBroker VARCHAR (10),
@Period VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2] 'ET','mTD'
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2] 'ET','yTD'

	DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

		--SELECT @SDate

	SELECT 	--GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count( Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			 HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	--Inner join MutualFund.dbo.transactiondetail td with (nolock)
	Inner join (select distinct AgentCode from MutualFund.dbo.transactiondetail td with (nolock) where  td.TranDate between  @SDate and @EDate ) td
	ON td.AgentCode=SB.sub_broker
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	left JOIN 
	(
			--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
				THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	
				from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--And  td.TranDate between  @SDate and @EDate 
	AND  SB.sub_broker=@SubBroker
	) T 
	where Type_of_Fund <> '' 
	group by fund_code,SchemeName,Type_of_Fund
		--and isnull(SchemeName,'')<>'' and SchemeName<>'NULL'
	--group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	--having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	--order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)

	--select * from #Temp	where 
	
	/*
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )

*/

select * from #Temp


DROP TABLE #TEMP
--DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_v2_Bkp05May2018
-- --------------------------------------------------

create procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_v2_Bkp05May2018]
(
@SubBroker VARCHAR (10),
@Period VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2] 'ET','mTD'
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2] 'ET','yTD'

	DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

		--SELECT @SDate

	SELECT 	GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count( Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			DISTINCT HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	Inner join MutualFund.dbo.transactiondetail td with (nolock)
	ON td.AgentCode=SB.sub_broker
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	left JOIN 
	(
			--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
				THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	
				from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	And  td.TranDate between  @SDate and @EDate 
	AND  SB.sub_broker=@SubBroker
	) T 
	where Type_of_Fund <> '' 
		and isnull(SchemeName,'')<>'' and SchemeName<>'NULL'
	group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)

	--select * from #Temp	where 
	
	
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


DROP TABLE #TEMP
DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_v2_New
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_v2_New]
(
@SubBroker VARCHAR (10),
@Period VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2_New] 'ET','mTD'
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2_New] 'ET','yTD'

	DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

		--SELECT @SDate

	SELECT 	GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count( Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			DISTINCT HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB WITH (NOLOCK)
	ON HLDG.party_Code=SB.party_Code
	Inner join MutualFund.dbo.transactiondetail td with (nolock)
	ON td.AgentCode=SB.sub_broker
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	left JOIN 
	(
			--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
				THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	
				from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	And  td.TranDate between  @SDate and @EDate 
	AND  SB.sub_broker=@SubBroker
	) T 
	where Type_of_Fund <> '' 
		and isnull(SchemeName,'')<>'' and SchemeName<>'NULL'
	group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)

	--select * from #Temp	where 
	
	






	
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


DROP TABLE #TEMP
DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_v2_SD
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseAll_v2_SD]
(
@SubBroker VARCHAR (10),
@Period VARCHAR (10)
)
AS
BEGIN
--EXEC [Usp_GetFundWiseSchemeWiseAll_v2_SD] 'EMT','YTD'

	DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

	SELECT 	GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			--party_Code,
			fund_code,
			--fsSchemeCode,
			 --ISNULL(SchemeName,'Total') SchemeName,
			 SchemeName SchemeName,
			 SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM'
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			,Count(Total) 'Total_clients'
	INTO #Temp	
	 from 
	(
	SELECT --SB.party_Code,
			HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB WITH (NOLOCK)
	ON HLDG.party_Code=SB.party_Code
	Inner join MutualFund.dbo.transactiondetail td with (nolock)
	ON td.AgentCode=SB.sub_broker
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(
	--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
		THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	
		from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	And  td.TranDate between  @SDate and @EDate 
	AND  SB.sub_broker=@SubBroker
	) T 
	group by ROLLUP(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1
	order by GROUPING_ID(fund_code,SchemeName,Type_of_Fund)
	
	select sum(Total_AUM) from #Temp	 
	
	
	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )


DROP TABLE #TEMP
DROP TABLE #TEMP1

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseAll_v3
-- --------------------------------------------------
CREATE  PROC [dbo].[Usp_GetFundWiseSchemeWiseAll_v3]
(
	@SubBroker VARCHAR (10)='ET'
)
AS
BEGIN 

sET nocount on 
--Declare @SubBroker VARCHAR (10)='ET'

--exec [dbo].[Usp_GetFundWiseSchemeWiseAll_v3] 'ET'

select GROUPING_ID(fund_code,SchemeName,SchemeClassDescription) AS 'Grouping_Level' ,
	fund_code,hldg.SchemeName,	count(distinct hldg.party_Code) Total_clients,	Sum(Angel_Qty*avg_rate) 'InvestmentAmount'
,T.SchemeClassDescription 'Type_of_Fund' 
,sum((Angel_Qty*LastNAVPrice)) 'Total_AUM'
into #tEMP
 from 
IWMF_trn_current_holding_syn HLDG with (nolock)
INNER JOIN sb_client_details SB WITH (NOLOCk)
ON HLDG.party_Code=SB.party_Code
left JOIN 
	(
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) 
				THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode
				from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
--where substring(fsSchemeCode,2,len(fsSchemeCode))='14059455.002067'
WHERE sub_broker=@SubBroker
--group by fund_code,hldg.SchemeName,T.SchemeClassDescription 
group by ROLLUP(fund_code,hldg.SchemeName,T.SchemeClassDescription )
	having GROUPING_ID(fund_code,SchemeName,SchemeClassDescription)<>1
	order by GROUPING_ID(fund_code,SchemeName,SchemeClassDescription)


	SELECT row_number() over (partition by fund_code,Grouping_Level order by fund_code) AS Order_By,* 
	INTO #TEMP1
	FROM #TEMP 
	--where fund_code in ('14011040','14050025')
	--and schemename is NULL
	
		update #TEMP1 
		set fund_code = case when (ISNULL(schemename,'')='' OR schemename='NULL')  THEN 'Total' else schemename end
		where schemename is NULL
		and fund_code is not null
		and Order_By=1
		and Grouping_Level in (3,4)
		--and fund_code IN ('14011040','14050025')

SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		Total_clients 
--INTO #Final
FROM #TEMP1 
where Grouping_Level<>(select max(Grouping_Level) from #TEMP1 )
UNION ALL
SELECT 
		fund_code = Case when fund_code is null THEN 'Grand Total' ELSE fund_code END ,
		schemename = CASE WHEN fund_code is null THEN 'Grand Total' WHEN fund_code = 'Total' THEN 'Total' ELSE ISNULL(schemename,'') END,
		--ISNULL(schemename,'') schemename,
		InvestmentAmount,
		Total_AUM,
		isnull(Type_of_Fund,'') Type_of_Fund,
		Total_clients 
FROM #TEMP1 
where Grouping_Level=(select max(Grouping_Level) from #TEMP1 )



end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseParty
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[Usp_GetFundWiseSchemeWiseParty]
(
--Declare 	@Party_Code VARCHAR(200)='K69188'
--K69188
@Party_Code VARCHAR(200)

)
AS
BEGIN
--EXEC Usp_GetFundWiseSchemeWiseParty 'K69188'
--EXEC Usp_GetFundWiseSchemeWiseParty 'RP61'


	SELECT 	--GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			
			fund_code,
			--fsSchemeCode,
			ISNULL(SchemeName,'Total') SchemeName,
			SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM_As_On_Date'
			--,
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			--,Count(Total) 'Total no. of clients'
			--party_Code
	INTO #TEMP
	 from 
	(
	SELECT --SB.party_Code,
			HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			--,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB WITH (NOLOCK)
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(
		--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
		SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.Party_Code=@Party_Code
	) T
	--group by fund_code,SchemeName,Type_of_Fund--,party_Code--,Type_of_Fund
	GROUP BY Rollup(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1


		update #TEMP set fund_code = case when schemename = 'Total' and fund_code is not null then 'Total' when schemename = 'Total' and fund_code is null then 'Grand Total' else fund_code end
		,schemename  = case when schemename = 'Total' then '' else schemename end 
		where schemename= 'Total'

		-- Added By Nazma Khan on 08th Apr, 2018
		update #TEMP set schemename = fund_code where fund_code in ('Total','Grand Total')

SELECT * FROM #TEMP

DROP TABLE #TEMP

	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseParty_BKP_08Apr2018
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[Usp_GetFundWiseSchemeWiseParty_BKP_08Apr2018]
(
--Declare 	@Party_Code VARCHAR(200)='K69188'
--K69188
@Party_Code VARCHAR(200)

)
AS
BEGIN
--EXEC Usp_GetFundWiseSchemeWiseParty 'K69188'
--EXEC Usp_GetFundWiseSchemeWiseParty 'RP61'


	SELECT 	--GROUPING_ID(fund_code,SchemeName,Type_of_Fund) AS 'Grouping_Level' ,
			
			fund_code,
			--fsSchemeCode,
			ISNULL(SchemeName,'Total') SchemeName,
			SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'Total_AUM_As_On_Date'
			--,
			,ISNULL(Type_of_Fund,'') Type_of_Fund
			--,Count(Total) 'Total no. of clients'
			--party_Code
	INTO #TEMP
	 from 
	(
	SELECT --SB.party_Code,
			HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			--,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	left JOIN 
	(
			select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			UNION
			select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.Party_Code=@Party_Code
	) T
	--group by fund_code,SchemeName,Type_of_Fund--,party_Code--,Type_of_Fund
	GROUP BY Rollup(fund_code,SchemeName,Type_of_Fund)
	having GROUPING_ID(fund_code,SchemeName,Type_of_Fund)<>1


		update #TEMP set fund_code = case when schemename = 'Total' and fund_code is not null then 'Total' when schemename = 'Total' and fund_code is null then 'Grand Total' else fund_code end
		,schemename  = case when schemename = 'Total' then '' else schemename end 
		where schemename= 'Total'


SELECT * FROM #TEMP

DROP TABLE #TEMP

	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseSubBroker
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseSubBroker]
(
	@SubBroker varchar(200)	,
	@fund_code varchar(500),
	@SchemeName varchar(500)
	
)
AS
BEGIN
--EXEC Usp_GetFundWiseSchemeWiseSubBroker_Sd 'EMT',@fund_code='14050025',@SchemeName='Canara Robeco Emerging Equities - Growth'
--EXEC Usp_GetFundWiseSchemeWiseSubBroker 'EMT',@fund_code='14050025',@SchemeName='Canara Robeco Emerging Equities - Growth'
--EXEC [Usp_GetFundWiseSchemeWiseSubBroker_bkp_20180423] 'EMT',@fund_code='14060009.08',@SchemeName='Reliance Liquid Fund - Treasury Plan - Growth'

----Declare @CurrDate as date
----Set @CurrDate = cast(getdate() as date)--'2018-04-18'

----EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate
------Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_111 NULL	,NULL	,'EMT'	,NULL	,NULL	,NULL	,'1900-01-01',	'2018-04-18'

Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

Select AMCcode as fund_code, SchemeName,InvestedAmount as InvestmentAmount, PresentValue as TotalAUMAsOnDate, SchemeClassDescription as Type_Of_Fund,ExistCode as Party_Code from (
(select  ExistCode,AMCcode,SchemeName,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end as SchemeClassDescription,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.amount else td.amount end) as InvestedAmount,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)*ln.NAVAmt as PresentValue,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)as BalanceUnits    
 ,count(distinct AMCcode) as NoOfClient
 from mutualfund..transactiondetail td with (nolock)
 INNER JOIN mutualfund..schememaster sm  with (nolock) on td.schcode=sm.schemecode
 INNER JOIN mutualfund..LatestNavDetails ln with (nolock)   ON td.schcode=ln.SchemeCode 
 INNER join mutualfund..InvestorMaster H WITH (NOLOCK) on H.InvCode = td.InvestorCode
 left join sb_client_details SB ON SB.sub_broker=td.AgentCode and H.ExistCode = sb.party_code
 where td.schcode=sm.schemecode and td.schcode=ln.SchemeCode and ISNULL(td.RevTag, '') <> 'Y' and td.units >= 0   and Td.InvestorCode In(select distinct investorcode from mutualfund..transactiondetail where agentcode=@SubBroker )--and td.AgentCode = @SubBroker 
  --and td.AgentCode = @SubBroker 
 and td.TranDate 
 between '1900-01-01' and @CurrDate 
 and AMCcode = @fund_code and SchemeName = @SchemeName
 group by AMCcode,SchemeName,td.InvestorCode,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end,td.SchCode,ln.NAVAmt  ,ExistCode
 having sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)>0) 
	
	Union All  
	
(select  ExistCode,AMCcode,SchemeName,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end as SchemeClassDescription,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.amount else td.amount end) as InvestedAmount,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)*ln.NAVAmt as PresentValue,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)as BalanceUnits    
 ,count(distinct AMCcode) as NoOfClient
 from mutualfund..otherbrokertransactiondetail td with (nolock)
 INNER JOIN mutualfund..schememaster sm  with (nolock) on td.schcode=sm.schemecode
 INNER JOIN mutualfund..LatestNavDetails ln with (nolock)   ON td.schcode=ln.SchemeCode 
 INNER join mutualfund..InvestorMaster H WITH (NOLOCK) on H.InvCode = td.InvestorCode
 left join sb_client_details SB ON SB.sub_broker=td.AgentCode and H.ExistCode = sb.party_code
 where td.schcode=sm.schemecode and td.schcode=ln.SchemeCode and td.Active='Y' and td.amount >= 0  and Td.InvestorCode In(select distinct investorcode from mutualfund..transactiondetail where agentcode=@SubBroker )--and td.AgentCode = @SubBroker 
  --and td.AgentCode = @SubBroker 
 and td.TranDate between 
 '1900-01-01' and @CurrDate and AMCcode = @fund_code and SchemeName = @SchemeName
 group by AMCcode,SchemeName,td.InvestorCode,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end,td.SchCode,ln.NAVAmt  ,ExistCode
    having sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)>0)) Data 
	
--select * from ##temp2 SB
--	where fund_code=@fund_code
--	AND SchemeName=@SchemeName


/*
	--SELECT 	
			
	--		fund_code,
	--		--fsSchemeCode,
	--		SchemeName,
	--		SUM(InvestmentAmount) InvestmentAmount,
	--		sum(Total_AUM) 'TotalAUMAsOnDate',
	--		Type_of_Fund,
	--		--,Count(Total) 'Total no. of clients'
	--		party_Code
	-- from 
	--(
	SELECT --SB.party_Code,
			HLDG.fund_code as fund_code,
			--fsSchemeCode,
			sm.SchemeName			
			,Angel_Qty*avg_rate 'InvestmentAmount',
			(Angel_Qty*LastNAVPrice) 'TotalAUMAsOnDate'
			,T.SchemeClassDescription 'Type_of_Fund' 
			--,(SB.party_Code) 'Total'
			,SB.party_Code
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.sub_broker=@SubBroker
	and HLDG.fund_code=@fund_code
	AND sm.SchemeName=@SchemeName
	
	--) T
	--group by fund_code,SchemeName,party_Code,Type_of_Fund

	*/

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseSubBroker_3
-- --------------------------------------------------


CREATE  procedure [dbo].[Usp_GetFundWiseSchemeWiseSubBroker_3]
(
	@SubBroker varchar(200)	,
	@fund_code varchar(500),
	@SchemeName varchar(500)
	
)
AS
BEGIN
--EXEC Usp_GetFundWiseSchemeWiseSubBroker_3 'AJYC',@fund_code='14055552',@SchemeName='Motilal Oswal Multicap 35 Fund - Growth'
--EXEC Usp_GetFundWiseSchemeWiseSubBroker 'EMT',@fund_code='14050025',@SchemeName='Canara Robeco Emerging Equities - Growth'
--EXEC [Usp_GetFundWiseSchemeWiseSubBroker_bkp_20180423] 'EMT',@fund_code='14060009.08',@SchemeName='Reliance Liquid Fund - Treasury Plan - Growth'

----Declare @CurrDate as date
----Set @CurrDate = cast(getdate() as date)--'2018-04-18'

----EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate
------Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_111 NULL	,NULL	,'EMT'	,NULL	,NULL	,NULL	,'1900-01-01',	'2018-04-18'

Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

Select AMCcode as fund_code, SchemeName,InvestedAmount as InvestmentAmount, PresentValue as TotalAUMAsOnDate, SchemeClassDescription as Type_Of_Fund,ExistCode as Party_Code from (
(
select  ExistCode,AMCcode,SchemeName,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end as SchemeClassDescription,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.amount else td.amount end) as InvestedAmount,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)*ln.NAVAmt as PresentValue,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)as BalanceUnits    
 ,count(distinct AMCcode) as NoOfClient
 from mutualfund..transactiondetail td with (nolock)
 INNER JOIN mutualfund..schememaster sm  with (nolock) on td.schcode=sm.schemecode
 INNER JOIN mutualfund..LatestNavDetails ln with (nolock)   ON td.schcode=ln.SchemeCode 
 INNER join mutualfund..InvestorMaster H WITH (NOLOCK) on H.InvCode = td.InvestorCode
 left join sb_client_details SB ON SB.sub_broker=td.AgentCode and H.ExistCode = sb.party_code
 where td.schcode=sm.schemecode and td.schcode=ln.SchemeCode and ISNULL(td.RevTag, '') <> 'Y' and td.units >= 0   and Td.InvestorCode In(select distinct investorcode from mutualfund..transactiondetail where agentcode=@SubBroker )
 --and td.AgentCode = @SubBroker 
  --and td.AgentCode = @SubBroker 
 and td.TranDate 
 between '1900-01-01' and @CurrDate 
 and AMCcode = @fund_code and SchemeName = @SchemeName
 group by AMCcode,SchemeName,td.InvestorCode,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end,td.SchCode,ln.NAVAmt  ,ExistCode
 having sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)>0) 
	
	Union All  
	
(select  ExistCode,AMCcode,SchemeName,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end as SchemeClassDescription,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.amount else td.amount end) as InvestedAmount,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)*ln.NAVAmt as PresentValue,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)as BalanceUnits    
 ,count(distinct AMCcode) as NoOfClient
 from mutualfund..otherbrokertransactiondetail td with (nolock)
 INNER JOIN mutualfund..schememaster sm  with (nolock) on td.schcode=sm.schemecode
 INNER JOIN mutualfund..LatestNavDetails ln with (nolock)   ON td.schcode=ln.SchemeCode 
 INNER join mutualfund..InvestorMaster H WITH (NOLOCK) on H.InvCode = td.InvestorCode
 left join sb_client_details SB ON SB.sub_broker=td.AgentCode and H.ExistCode = sb.party_code
 where td.schcode=sm.schemecode and td.schcode=ln.SchemeCode and td.Active='Y' and td.amount >= 0  and Td.InvestorCode In(select distinct investorcode from mutualfund..transactiondetail where agentcode=@SubBroker )--
 --and td.AgentCode = @SubBroker 
  --and td.AgentCode = @SubBroker 
 and td.TranDate between 
 '1900-01-01' and @CurrDate and AMCcode = @fund_code and SchemeName = @SchemeName
 group by AMCcode,SchemeName,td.InvestorCode,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end,td.SchCode,ln.NAVAmt  ,ExistCode
    having sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)>0)) Data 
	
--select * from ##temp2 SB
--	where fund_code=@fund_code
--	AND SchemeName=@SchemeName



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseSubBroker_bkp_20180423
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseSubBroker_bkp_20180423]
(
	@SubBroker varchar(200)	,
	@fund_code varchar(500),
	@SchemeName varchar(500)
	
)
AS
BEGIN
--EXEC Usp_GetFundWiseSchemeWiseSubBroker 'EMT',@fund_code='14050025',@SchemeName='Canara Robeco Emerging Equities - Growth'

	SELECT 	
			
			fund_code,
			--fsSchemeCode,
			SchemeName,
			SUM(InvestmentAmount) InvestmentAmount,
			sum(Total_AUM) 'TotalAUMAsOnDate',
			Type_of_Fund,
			--,Count(Total) 'Total no. of clients'
			party_Code
	 from 
	(
	SELECT SB.party_Code,
			HLDG.fund_code,
			--fsSchemeCode,
			sm.SchemeName,
			(Angel_Qty*LastNAVPrice) 'Total_AUM'
			,T.SchemeClassDescription 'Type_of_Fund' 
			--,(SB.party_Code) 'Total'
			,Angel_Qty*avg_rate 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.sub_broker=@SubBroker
	and HLDG.fund_code=@fund_code
	AND sm.SchemeName=@SchemeName
	
	) T
	group by fund_code,SchemeName,party_Code,Type_of_Fund
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseSubBroker_bkp_2018May11
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseSubBroker_bkp_2018May11]
(
	@SubBroker varchar(200)	,
	@fund_code varchar(500),
	@SchemeName varchar(500)
	
)
AS
BEGIN
--EXEC Usp_GetFundWiseSchemeWiseSubBroker 'EMT',@fund_code='14060009.08',@SchemeName='Reliance Liquid Fund - Treasury Plan - Growth'
--EXEC [Usp_GetFundWiseSchemeWiseSubBroker_bkp_20180423] 'EMT',@fund_code='14060009.08',@SchemeName='Reliance Liquid Fund - Treasury Plan - Growth'

	--SELECT 	
			
	--		fund_code,
	--		--fsSchemeCode,
	--		SchemeName,
	--		SUM(InvestmentAmount) InvestmentAmount,
	--		sum(Total_AUM) 'TotalAUMAsOnDate',
	--		Type_of_Fund,
	--		--,Count(Total) 'Total no. of clients'
	--		party_Code
	-- from 
	--(
	SELECT --SB.party_Code,
			HLDG.fund_code as fund_code,
			--fsSchemeCode,
			sm.SchemeName			
			,Angel_Qty*avg_rate 'InvestmentAmount',
			(Angel_Qty*LastNAVPrice) 'TotalAUMAsOnDate'
			,T.SchemeClassDescription 'Type_of_Fund' 
			--,(SB.party_Code) 'Total'
			,SB.party_Code
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.sub_broker=@SubBroker
	and HLDG.fund_code=@fund_code
	AND sm.SchemeName=@SchemeName
	
	--) T
	--group by fund_code,SchemeName,party_Code,Type_of_Fund
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetFundWiseSchemeWiseSubBroker_SD
-- --------------------------------------------------

CREATE procedure [dbo].[Usp_GetFundWiseSchemeWiseSubBroker_SD]
(
	@SubBroker varchar(200)	,
	@fund_code varchar(500),
	@SchemeName varchar(500)
	
)
AS
BEGIN
--EXEC Usp_GetFundWiseSchemeWiseSubBroker_Sd 'EMT',@fund_code='14050025',@SchemeName='Canara Robeco Emerging Equities - Growth'
--EXEC Usp_GetFundWiseSchemeWiseSubBroker 'EMT',@fund_code='14050025',@SchemeName='Canara Robeco Emerging Equities - Growth'
--EXEC [Usp_GetFundWiseSchemeWiseSubBroker_bkp_20180423] 'EMT',@fund_code='14060009.08',@SchemeName='Reliance Liquid Fund - Treasury Plan - Growth'

----Declare @CurrDate as date
----Set @CurrDate = cast(getdate() as date)--'2018-04-18'

----EXEC MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_FundWiseSchemeWise NULL	,NULL	,@SubBroker	,NULL	,NULL	,NULL	,'1900-01-01',	@CurrDate
------Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_111 NULL	,NULL	,'EMT'	,NULL	,NULL	,NULL	,'1900-01-01',	'2018-04-18'

Declare @CurrDate as date
Set @CurrDate = cast(getdate() as date)--'2018-04-18'

Select AMCcode as fund_code, SchemeName,InvestedAmount as InvestmentAmount, PresentValue as TotalAUMAsOnDate, SchemeClassDescription as Type_Of_Fund,ExistCode as Party_Code from (
(select  ExistCode,AMCcode,SchemeName,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end as SchemeClassDescription,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.amount else td.amount end) as InvestedAmount,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)*ln.NAVAmt as PresentValue,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)as BalanceUnits    
 ,count(distinct AMCcode) as NoOfClient
 from mutualfund..transactiondetail td with (nolock)
 INNER JOIN mutualfund..schememaster sm  with (nolock) on td.schcode=sm.schemecode
 INNER JOIN mutualfund..LatestNavDetails ln with (nolock)   ON td.schcode=ln.SchemeCode 
 INNER join mutualfund..InvestorMaster H WITH (NOLOCK) on H.InvCode = td.InvestorCode
 where td.schcode=sm.schemecode and td.schcode=ln.SchemeCode and ISNULL(td.RevTag, '') <> 'Y' and td.units >= 0   and td.AgentCode = @SubBroker and td.TranDate 
 between '1900-01-01' and @CurrDate 
 and AMCcode = @fund_code and SchemeName = @SchemeName
 group by AMCcode,SchemeName,td.InvestorCode,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end,td.SchCode,ln.NAVAmt  ,ExistCode
 having sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)>0) 
	
	Union All  
	
(select  ExistCode,AMCcode,SchemeName,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end as SchemeClassDescription,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.amount else td.amount end) as InvestedAmount,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)*ln.NAVAmt as PresentValue,   
 sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)as BalanceUnits    
 ,count(distinct AMCcode) as NoOfClient
 from mutualfund..otherbrokertransactiondetail td with (nolock)
 INNER JOIN mutualfund..schememaster sm  with (nolock) on td.schcode=sm.schemecode
 INNER JOIN mutualfund..LatestNavDetails ln with (nolock)   ON td.schcode=ln.SchemeCode 
 INNER join mutualfund..InvestorMaster H WITH (NOLOCK) on H.InvCode = td.InvestorCode
 where td.schcode=sm.schemecode and td.schcode=ln.SchemeCode and td.Active='Y' and td.amount >= 0  and td.AgentCode = @SubBroker and td.TranDate between 
 '1900-01-01' and @CurrDate and AMCcode = @fund_code and SchemeName = @SchemeName
 group by AMCcode,SchemeName,td.InvestorCode,case when sm.SchemesubClassDescription = 'Balanced Fund' then 'Balanced' when sm.SchemesubClassDescription = 'ELSS' then 'ELSS' else sm.SchemeClassDescription end,td.SchCode,ln.NAVAmt  ,ExistCode
    having sum(case when td.trxntype in('Redemption','Switch out','Transfer Out') Then -td.units else td.units end)>0)) Data 
	
--select * from ##temp2 SB
--	where fund_code=@fund_code
--	AND SchemeName=@SchemeName


/*
	--SELECT 	
			
	--		fund_code,
	--		--fsSchemeCode,
	--		SchemeName,
	--		SUM(InvestmentAmount) InvestmentAmount,
	--		sum(Total_AUM) 'TotalAUMAsOnDate',
	--		Type_of_Fund,
	--		--,Count(Total) 'Total no. of clients'
	--		party_Code
	-- from 
	--(
	SELECT --SB.party_Code,
			HLDG.fund_code as fund_code,
			--fsSchemeCode,
			sm.SchemeName			
			,Angel_Qty*avg_rate 'InvestmentAmount',
			(Angel_Qty*LastNAVPrice) 'TotalAUMAsOnDate'
			,T.SchemeClassDescription 'Type_of_Fund' 
			--,(SB.party_Code) 'Total'
			,SB.party_Code
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(--select SchemeClassDescription=case when SchemeSubClassDescription = 'ELSS' then SchemeSubClassDescription else SchemeClassDescription END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt') 
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription='ELSS'
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
	--AND sb.MF='Y'
	--and HLDG.fund_code='14053747'
	--and fsSchemeCode='B14055249.002199'
	AND  SB.sub_broker=@SubBroker
	and HLDG.fund_code=@fund_code
	AND sm.SchemeName=@SchemeName
	
	--) T
	--group by fund_code,SchemeName,party_Code,Type_of_Fund

	*/

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMFDPFlagCheck
-- --------------------------------------------------
CREATE  Procedure [dbo].[usp_GetMFDPFlagCheck]
(
--Declare 
	@PartyCode Varchar(200)='A104895',
	@Flag Varchar(10)='Buy',
	--@SchemeCode Varchar(200)
	@ISIN Varchar(2000)='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

)
AS
BEGIN
/*
For Checking 

select dpflag,* from [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK) 
	where Clientcode='ALWR1937'
and isin  in ('INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')


select ISIN,* from [IWMF_trn_current_holding_syn] with (nolock) 
where  isin  in ('INF204K01UE8','INF209K01BR9','INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')
and 
party_Code='ALWR1937'


EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR2144',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9,INF204K01UE8'

EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR2144',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9,INF204K01UE8'
EXEC usp_GetMFDPFlagCheck_33 @PartyCode='ALWR2144',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9,INF204K01UE8'



EXEC [dbo].usp_GetMFDPFlagCheck_33 'ALWR2151','Buy','INF204K01UN9,INF740K01250'



EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR2144',@Flag='Sell',@ISIN='INF204K01UE8'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR1937',@Flag='Buy',@ISIN='INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A104895',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'



*/




SET NOCOUNT ON 

--Declare @SchemeCode varchar(200)='G14051581.002066' --DP
--Declare @SchemeCode varchar(200)='G14053239.002066'  --DP
--Declare @SchemeCode varchar(200)='G14051454.002066,G14053239.002066'  --PHY

Create Table #Buy_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


Create Table #Buy_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


--Select @PartyCode ='A100644'
Create Table #FinalDP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #FinalPhy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #Final
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)



 IF OBJECT_ID('TempDB..#SchemeCode') IS NOT NULL  
  DROP TABLE #SchemeCode
 SELECT StringValue AS ISIN ,@PartyCode PartyCode 
  INTO #SchemeCode
 FROM dbo.fn_Split1(@ISIN, ',')  

 Declare @angelid varchar(10)
--Declare @PartyCode varchar(10)='A100644'


select @angelid=angelid from [172.31.16.75].[ANGEL_WMS].[dbo].users with (nolock) where loginID=@PartyCode

select userType,angelId,@PartyCode PartyCode   
Into #userType
from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) where angelid=@angelid

 --select *  from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) 



 --select * from #SchemeCode


--------------------Logic for DP ------------------
If EXISTS (select * from #userType where userType='Trading')
Begin 



insert into #Buy_DP
SELECT @PartyCode Party_Code,@Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN --INTO #Buy_DP 
FROM #SchemeCode SCH 
left join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 and @Flag='Buy' 
AND DPFlag='DP'
and Buy.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg WITh (NOLOCK)
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin



--select * from #Buy_DP


insert into #Sell_DP
SELECT @PartyCode Party_Code, @Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  --INTO #Sell_DP 
--INTO #Sell_DP
FROM #SchemeCode SCH left join 
[dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='DP'
and Sell.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin




--select * from #Sell_DP



IF 	(
	SELECT DISTINCT 1 FROM #Buy_DP 
		UNION 
	SELECT 1 FROM #Sell_DP  )>0
BEGIN 

Print 'A'

Insert into #FinalDP
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_DP
		UNION ALL
		SELECT * FROM #Sell_DP) T
inner join [dbo].[IWMF_trn_current_holding_syn] hldg
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin
 

END



--select * from #FinalDP 


insert into #Final
SELECT Party_Code,	Flag,	'DP' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
--INTO #FinalDP1
 FROM #FinalDP
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'DP' DPFlag,	 hldg.fund_code,	fsSchemeCode Scheme_Code,folio_no	FolioNo,	A.ISIN,'Fresh' BuySell
 from #SchemeCode A
 left join #FinalDP B ON A.ISIN=B.ISIN and A.PartyCode=B.Party_Code
 left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
 ON hldg.party_Code=B.Party_Code and hldg.isin=B.isin 
 where A.ISIN not in  (select isin from #FinalDP where dpflag='DP' and ISIN not in ('INF204K01UN9') )--and ISIN not in ('INF204K01UN9'))/*Added By Yogesh_04June2018 For INF204K01UN9 ISIN to Fetch*/ 
--and A.ISIN not in ('INF204K01UN9')

 


 
 END

 Update #Final
 Set dpflag='Phy'
 where ISIN= 'INF204K01UN9'

 --select '1',* from #Final
--------------------Logic for DP ------------------



--------------------Logic for Phy ------------------
If EXISTS (select * from #userType where userType in ('MF','MFIP','PU'))
Begin 

Print 'AA'
insert into #Buy_Phy
SELECT @PartyCode Party_Code,@Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN 
--INTO #Buy_Phy 
FROM #SchemeCode SCH 
inner join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 --and  Scheme_Code=@SchemeCode 
 and @Flag='Buy' 
AND DPFlag='Phy'



Insert into #Sell_Phy 
SELECT @PartyCode Party_Code, @Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  
--INTO #Sell_Phy 
FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
left join #SchemeCode SCH
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='Phy'

--select * from #Buy_Phy
--select * from #Sell_Phy


IF 	(
	SELECT DISTINCT 1 FROM #Buy_Phy 
		UNION 
	SELECT 1 FROM #Sell_Phy  )>0
BEGIN 

Print 'A'

Insert into #FinalPhy
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_Phy
		UNION ALL
		SELECT * FROM #Sell_Phy) T
--inner join [dbo].[IWMF_trn_current_holding_syn] hldg
-- ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin and hldg.folio_no=T.FolioNo


 
END


insert into #Final
SELECT Party_Code,	Flag,	'Phy' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
 FROM #FinalPhy
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	'' fund_code,	'' Scheme_Code,'' FolioNo,	T.ISIN,'Fresh' BuySell
 from #SchemeCode T
 --left join [dbo].[IWMF_trn_current_holding_syn] hldg
 --ON hldg.party_Code=T.PartyCode and hldg.isin=T.isin
 where T.ISIN not in  (select isin from #FinalPhy where dpflag='Phy')
 
 --------------------Logic for Phy ------------------

--select * from #Final

END


select Party_Code,ISIN,count(1) Cnt
Into #Delete 
from #Final
group by Party_Code,ISIN
having count(1)>1

delete A
from #Final A
Inner join #Delete B ON A.Party_Code=B.party_code
and A.ISIN=B.ISIN
Where BuySell='Fresh'
--and A.isin not in (select hldg.isin from [dbo].[IWMF_trn_current_holding_syn] hldg inner join #SchemeCode B ON hldg.Party_Code=B.PartyCode)



select * from #Final
--where isin not in (select isin from [dbo].[IWMF_trn_current_holding_syn] hldg)
--and BuySell='Fresh'

--UNION
--select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	'' fund_code,	'' Scheme_Code,'' 	FolioNo,	ISIN,'Fresh' BuySell
-- from #SchemeCode
-- where ISIN not in  (select isin from #FinalPhy)--------------------Logic for Phy ------------------


--SELECT distinct A.*,SchemeName  FROM #Final A
--left join MutualFund.dbo.schememaster B
--ON substring(A.Scheme_Code,2,len(A.Scheme_Code))=B.SchemeCode




Drop table #Buy_DP
Drop table #Sell_DP
Drop table #Buy_Phy
Drop table #Sell_Phy
Drop table #FinalDP
Drop table #FinalPhy
Drop table #Final
--Drop table #FinalDP1
--Drop table #FinalPhy1
Drop table #userType

drop table #Delete 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMFDPFlagCheck_1New
-- --------------------------------------------------


CREATE Procedure [dbo].[usp_GetMFDPFlagCheck_1New]
(
--Declare 
	@PartyCode Varchar(200)='A104895',
	@Flag Varchar(10)='Buy',
	--@SchemeCode Varchar(200)
	@ISIN Varchar(2000)='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

)
AS
BEGIN
/*
For Checking 

EXEC usp_GetMFDPFlagCheck_1New @PartyCode='A120281',@Flag='sell',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9' --changes are proper but need to check with yogesh -- 344 line no

exec [dbo].[usp_GetMFDPFlagCheck_1New] 'P77935','Buy','INF204K01UN9'--changes are pending


select dpflag,* from [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK) 
	where Clientcode='A120281'
and isin  in ('INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC [dbo].[usp_GetMFDPFlagCheck] 'P77935','Buy','INF204K01UN9,INF740K01250'


select ISIN,* from [IWMF_trn_current_holding_syn] with (nolock) 
where  isin  in ('INF209K01BR9','INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')
and 
party_Code='ALWR1937'

EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR2144',@Flag='Sell',@ISIN='INF204K01UE8'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR1937',@Flag='Buy',@ISIN='INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A104895',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'



*/




SET NOCOUNT ON 

--Declare @SchemeCode varchar(200)='G14051581.002066' --DP
--Declare @SchemeCode varchar(200)='G14053239.002066'  --DP
--Declare @SchemeCode varchar(200)='G14051454.002066,G14053239.002066'  --PHY

Create Table #Buy_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


Create Table #Buy_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


--Select @PartyCode ='A100644'
Create Table #FinalDP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #FinalPhy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #Final
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)



 IF OBJECT_ID('TempDB..#SchemeCode') IS NOT NULL  
  DROP TABLE #SchemeCode
 SELECT StringValue AS ISIN ,@PartyCode PartyCode 
  INTO #SchemeCode
 FROM dbo.fn_Split1(@ISIN, ',')  

 Declare @angelid varchar(10)
--Declare @PartyCode varchar(10)='A100644'


select @angelid=angelid from [172.31.16.75].[ANGEL_WMS].[dbo].users with (nolock) where loginID=@PartyCode

select userType,angelId,@PartyCode PartyCode   
Into #userType
from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) where angelid=@angelid

 --select *  from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) 



 --select * from #SchemeCode


--------------------Logic for DP ------------------
If EXISTS (select * from #userType where userType='Trading')
Begin 



insert into #Buy_DP
SELECT @PartyCode Party_Code,@Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN --INTO #Buy_DP 
FROM #SchemeCode SCH 
left join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 and @Flag='Buy' 
AND DPFlag='DP'
and Buy.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin



--select * from #Buy_DP


insert into #Sell_DP
SELECT @PartyCode Party_Code, @Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  --INTO #Sell_DP 
--INTO #Sell_DP
FROM #SchemeCode SCH left join 
[dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='DP'
and Sell.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin




--select * from #Sell_DP



IF 	(
	SELECT DISTINCT 1 FROM #Buy_DP 
		UNION 
	SELECT 1 FROM #Sell_DP  )>0
BEGIN 

Print 'A'

Insert into #FinalDP
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_DP
		UNION ALL
		SELECT * FROM #Sell_DP) T
inner join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin
 

END



--select * from #FinalDP 


insert into #Final
SELECT Party_Code,	Flag,	'DP' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
--INTO #FinalDP1
 FROM #FinalDP
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'DP' DPFlag,	 hldg.fund_code,	fsSchemeCode Scheme_Code,folio_no	FolioNo,	A.ISIN,'Fresh' BuySell
 from #SchemeCode A
 left join #FinalDP B ON A.ISIN=B.ISIN and A.PartyCode=B.Party_Code
 left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCk)
 ON hldg.party_Code=B.Party_Code and hldg.isin=B.isin 
 where A.ISIN not in  (select isin from #FinalDP where dpflag='DP' )--and ISIN not in ('INF204K01UN9'))/*Added By Yogesh_04June2018 For INF204K01UN9 ISIN to Fetch*/ 
and A.ISIN not in ('INF204K01UN9')

 


 
 END

 Update #Final
 Set dpflag='Phy'
 where ISIN= 'INF204K01UN9'

 --select '1',* from #Final
--------------------Logic for DP ------------------



--------------------Logic for Phy ------------------
If EXISTS (select * from #userType where userType in ('MF','MFIP','PU'))
Begin 

Print 'AA'
insert into #Buy_Phy
SELECT @PartyCode Party_Code,@Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN 
--INTO #Buy_Phy 
FROM #SchemeCode SCH 
inner join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 --and  Scheme_Code=@SchemeCode 
 and @Flag='Buy' 
AND DPFlag='Phy'



Insert into #Sell_Phy 
SELECT @PartyCode Party_Code, @Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  
--INTO #Sell_Phy 
FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
left join #SchemeCode SCH
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='Phy'

--select * from #Buy_Phy
--select * from #Sell_Phy


IF 	(
	SELECT DISTINCT 1 FROM #Buy_Phy 
		UNION 
	SELECT 1 FROM #Sell_Phy  )>0
BEGIN 

Print 'A'

Insert into #FinalPhy
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_Phy
		UNION ALL
		SELECT * FROM #Sell_Phy) T
inner join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin and hldg.folio_no=T.FolioNo


 
END

/*
--insert into #Final
--SELECT Party_Code,	Flag,	'Phy' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
-- FROM #FinalPhy
--UNION 
--select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	fund_code fund_code,	'' Scheme_Code,folio_no FolioNo,	T.ISIN,'Fresh' BuySell
-- from #SchemeCode T
-- left join [dbo].[IWMF_trn_current_holding_syn] hldg
-- ON hldg.party_Code=T.PartyCode and hldg.isin=T.isin
-- where T.ISIN not in  (select isin from #FinalPhy where dpflag='Phy')
 Code commented by Sharad Patil as on 04-june-2018

*/

--Below new code added by Sharad Patil as on 04-june-2018
insert into #Final
SELECT Party_Code,	Flag,	'Phy' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
 FROM #FinalPhy
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	fund_code fund_code,	'' Scheme_Code,foliono FolioNo,	T.ISIN,'Fresh' BuySell
 from #SchemeCode T
 left join [dbo].[tbl_TransactionBuy_UniqueCode_syn] hldg WITH (NOLOCk)
 ON hldg.Clientcode=T.PartyCode and hldg.isin=T.isin
 --and @Flag = 'Buy'
 where T.ISIN not in  (select isin from #FinalPhy where dpflag='Phy')


 
 --------------------Logic for Phy ------------------

--select * from #Final

END

select * from #Final
--UNION
--select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	'' fund_code,	'' Scheme_Code,'' 	FolioNo,	ISIN,'Fresh' BuySell
-- from #SchemeCode
-- where ISIN not in  (select isin from #FinalPhy)--------------------Logic for Phy ------------------


--SELECT distinct A.*,SchemeName  FROM #Final A
--left join MutualFund.dbo.schememaster B
--ON substring(A.Scheme_Code,2,len(A.Scheme_Code))=B.SchemeCode




Drop table #Buy_DP
Drop table #Sell_DP
Drop table #Buy_Phy
Drop table #Sell_Phy
Drop table #FinalDP
Drop table #FinalPhy
Drop table #Final
--Drop table #FinalDP1
--Drop table #FinalPhy1
Drop table #userType



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMFDPFlagCheck_33
-- --------------------------------------------------
CREATE  Procedure [dbo].[usp_GetMFDPFlagCheck_33]
(
--Declare 
	@PartyCode Varchar(200)='A104895',
	@Flag Varchar(10)='Buy',
	--@SchemeCode Varchar(200)
	@ISIN Varchar(2000)='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

)
AS
BEGIN
/*
For Checking 

select dpflag,* from [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK) 
	where Clientcode='ALWR2144'
and isin  in ('INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')


select ISIN,* from [IWMF_trn_current_holding_syn] with (nolock) 
where  isin  in ('INF204K01UE8','INF209K01BR9','INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')
and 
party_Code='ALWR2144'


EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR2144',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9,INF204K01UE8'

EXEC [dbo].[usp_GetMFDPFlagCheck] 'ALWR1937','Buy','INF204K01UN9,INF740K01250'



EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR2144',@Flag='Sell',@ISIN='INF204K01UE8'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR1937',@Flag='Buy',@ISIN='INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A104895',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'



*/




SET NOCOUNT ON 

--Declare @SchemeCode varchar(200)='G14051581.002066' --DP
--Declare @SchemeCode varchar(200)='G14053239.002066'  --DP
--Declare @SchemeCode varchar(200)='G14051454.002066,G14053239.002066'  --PHY

Create Table #Buy_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


Create Table #Buy_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


--Select @PartyCode ='A100644'
Create Table #FinalDP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #FinalPhy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #Final
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)



 IF OBJECT_ID('TempDB..#SchemeCode') IS NOT NULL  
  DROP TABLE #SchemeCode
 SELECT StringValue AS ISIN ,@PartyCode PartyCode 
  INTO #SchemeCode
 FROM dbo.fn_Split1(@ISIN, ',')  

 Declare @angelid varchar(10)
--Declare @PartyCode varchar(10)='A100644'


select @angelid=angelid from [172.31.16.75].[ANGEL_WMS].[dbo].users with (nolock) where loginID=@PartyCode

select userType,angelId,@PartyCode PartyCode   
Into #userType
from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) where angelid=@angelid

 --select *  from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) 



 --select * from #SchemeCode


--------------------Logic for DP ------------------
If EXISTS (select * from #userType where userType='Trading')
Begin 



insert into #Buy_DP
SELECT @PartyCode Party_Code,@Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN --INTO #Buy_DP 
FROM #SchemeCode SCH 
left join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 and @Flag='Buy' 
AND DPFlag='DP'
and Buy.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCk)
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin



--select * from #Buy_DP


insert into #Sell_DP
SELECT @PartyCode Party_Code, @Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  --INTO #Sell_DP 
--INTO #Sell_DP
FROM #SchemeCode SCH left join 
[dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='DP'
and Sell.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCk)
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin




--select * from #Sell_DP



IF 	(
	SELECT DISTINCT 1 FROM #Buy_DP 
		UNION 
	SELECT 1 FROM #Sell_DP  )>0
BEGIN 

Print 'A'

Insert into #FinalDP
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_DP
		UNION ALL
		SELECT * FROM #Sell_DP) T
inner join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCk)
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin
 

END



--select * from #FinalDP 


insert into #Final
SELECT Party_Code,	Flag,	'DP' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
--INTO #FinalDP1
 FROM #FinalDP
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'DP' DPFlag,	 hldg.fund_code,	fsSchemeCode Scheme_Code,folio_no	FolioNo,	A.ISIN,'Fresh' BuySell
 from #SchemeCode A
 left join #FinalDP B ON A.ISIN=B.ISIN and A.PartyCode=B.Party_Code
 left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
 ON hldg.party_Code=B.Party_Code and hldg.isin=B.isin 
 where A.ISIN not in  (select isin from #FinalDP where dpflag='DP' and ISIN not in ('INF204K01UN9') )--and ISIN not in ('INF204K01UN9'))/*Added By Yogesh_04June2018 For INF204K01UN9 ISIN to Fetch*/ 
--and A.ISIN not in ('INF204K01UN9')

 


 
 END

 Update #Final
 Set dpflag='Phy'
 where ISIN= 'INF204K01UN9'

 --select '1',* from #Final
--------------------Logic for DP ------------------



--------------------Logic for Phy ------------------
If EXISTS (select * from #userType where userType in ('MF','MFIP','PU'))
Begin 

Print 'AA'
insert into #Buy_Phy
SELECT @PartyCode Party_Code,@Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN 
--INTO #Buy_Phy 
FROM #SchemeCode SCH 
inner join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 --and  Scheme_Code=@SchemeCode 
 and @Flag='Buy' 
AND DPFlag='Phy'



Insert into #Sell_Phy 
SELECT @PartyCode Party_Code, @Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  
--INTO #Sell_Phy 
FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
left join #SchemeCode SCH
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='Phy'

--select * from #Buy_Phy
--select * from #Sell_Phy


IF 	(
	SELECT DISTINCT 1 FROM #Buy_Phy 
		UNION 
	SELECT 1 FROM #Sell_Phy  )>0
BEGIN 

Print 'A'

Insert into #FinalPhy
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_Phy
		UNION ALL
		SELECT * FROM #Sell_Phy) T
--inner join [dbo].[IWMF_trn_current_holding_syn] hldg
-- ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin and hldg.folio_no=T.FolioNo


 
END


insert into #Final
SELECT Party_Code,	Flag,	'Phy' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
 FROM #FinalPhy
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	'' fund_code,	'' Scheme_Code,'' FolioNo,	T.ISIN,'Fresh' BuySell
 from #SchemeCode T
 --left join [dbo].[IWMF_trn_current_holding_syn] hldg
 --ON hldg.party_Code=T.PartyCode and hldg.isin=T.isin
 where T.ISIN not in  (select isin from #FinalPhy where dpflag='Phy')
 
 --------------------Logic for Phy ------------------

--select * from #Final

END


select Party_Code,ISIN,count(1) Cnt
Into #Delete 
from #Final
group by Party_Code,ISIN
having count(1)>1

delete A
from #Final A
Inner join #Delete B ON A.Party_Code=B.party_code
and A.ISIN=B.ISIN
Where BuySell='Fresh'
--and A.isin not in (select hldg.isin from [dbo].[IWMF_trn_current_holding_syn] hldg inner join #SchemeCode B ON hldg.Party_Code=B.PartyCode)



select * from #Final
--where isin not in (select isin from [dbo].[IWMF_trn_current_holding_syn] hldg)
--and BuySell='Fresh'

--UNION
--select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	'' fund_code,	'' Scheme_Code,'' 	FolioNo,	ISIN,'Fresh' BuySell
-- from #SchemeCode
-- where ISIN not in  (select isin from #FinalPhy)--------------------Logic for Phy ------------------


--SELECT distinct A.*,SchemeName  FROM #Final A
--left join MutualFund.dbo.schememaster B
--ON substring(A.Scheme_Code,2,len(A.Scheme_Code))=B.SchemeCode




Drop table #Buy_DP
Drop table #Sell_DP
Drop table #Buy_Phy
Drop table #Sell_Phy
Drop table #FinalDP
Drop table #FinalPhy
Drop table #Final
--Drop table #FinalDP1
--Drop table #FinalPhy1
Drop table #userType

drop table #Delete 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMFDPFlagCheck_BkpSchemeCode30May2018
-- --------------------------------------------------
--Select * from MutualFund..SchemeMaster

CREATE Procedure usp_GetMFDPFlagCheck_BkpSchemeCode30May2018
(
	@PartCode Varchar(200),
	@Flag Varchar(10),
	@SchemeCode Varchar(200)
--Declare @SchemeName Varchar(200)=''
)
AS
BEGIN

--EXEC usp_GetMFDPFlagCheck 'RP61','Sell','G14051454.002066,G14053239.002066'
--EXEC usp_GetMFDPFlagCheck 'RP61','Buy','G14051454.002066,G14053239.002066'

--Declare @PartCode Varchar(200)
--Declare @Flag Varchar(10)='Buy'
--Declare @SchemeName Varchar(200)=''

SET NOCOUNT ON 

--Declare @SchemeCode varchar(200)='G14051581.002066' --DP
--Declare @SchemeCode varchar(200)='G14053239.002066'  --DP
--Declare @SchemeCode varchar(200)='G14051454.002066,G14053239.002066'  --PHY



--Select @PartCode ='RP61'
Create Table #Final
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,SchemeCode Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)


 IF OBJECT_ID('TempDB..#SchemeCode') IS NOT NULL  
  DROP TABLE #SchemeCode
 SELECT StringValue AS SchemeCode  
  INTO #SchemeCode
 FROM dbo.fn_Split1(@SchemeCode, ',')  

--------------------Logic for DP ------------------

SELECT Clientcode Party_Code,@Flag Flag,DPFlag,fund_code,SCH.SchemeCode SchemeCode,FolioNo,ISIN INTO #Buy_DP FROM [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
Inner join #SchemeCode SCH
ON Buy.Scheme_Code=SCH.SchemeCode
 where Clientcode=@PartCode 
 --and  Scheme_Code=@SchemeCode 
 and @Flag='Buy' 
AND DPFlag='DP'

SELECT Clientcode Party_Code, @Flag Flag,DPFlag,fund_code,SCH.SchemeCode SchemeCode,FolioNo,ISIN INTO #Sell_DP FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
Inner join #SchemeCode SCH
ON Sell.Scheme_Code=SCH.SchemeCode
where Clientcode=@PartCode and  Scheme_Code=@SchemeCode and @Flag='Sell'
AND DPFlag='DP'


IF 	(
	SELECT DISTINCT 1 FROM #Buy_DP 
		UNION 
	SELECT 1 FROM #Sell_DP  )>0
BEGIN 

Print 'A'

Insert into #Final
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,	T.SchemeCode,	T.FolioNo,T.ISIN,
CASE WHEN hldg.fsSchemeCode IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 

--INTO #Final_DP
From 
(SELECT * FROM #Buy_DP
		UNION ALL
		SELECT * FROM #Sell_DP) T
Left join [dbo].[IWMF_trn_current_holding_syn] hldg
 ON hldg.party_Code=T.Party_Code and hldg.fsSchemeCode=T.SchemeCode  
 
END

--------------------Logic for DP ------------------



--------------------Logic for Phy ------------------


SELECT Clientcode Party_Code,@Flag Flag,DPFlag,fund_code,SCH.SchemeCode SchemeCode,FolioNo,ISIN INTO #Buy_Phy FROM [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK) 
Inner join #SchemeCode SCH
ON Buy.Scheme_Code=SCH.SchemeCode
WHERE Clientcode=@PartCode and @Flag='Buy' 
AND DPFlag='Phy'

SELECT Clientcode Party_Code, @Flag Flag,DPFlag,fund_code,SCH.SchemeCode SchemeCode,FolioNo,ISIN INTO #Sell_Phy FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
Inner join #SchemeCode SCH
ON Sell.Scheme_Code=SCH.SchemeCode
where Clientcode=@PartCode and @Flag='Sell'
AND DPFlag='Phy'


IF 	(SELECT DISTINCT 1 FROM #Buy_Phy 
		UNION 
	SELECT 1 FROM #Sell_Phy  )>0
BEGIN 

Print 'B'

Insert into #Final
SELECT distinct 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,	T.SchemeCode,	T.FolioNo,T.ISIN,
CASE WHEN hldg.folio_no IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
--INTO #Final_Phy
From 
(SELECT * FROM #Buy_Phy
		UNION ALL
		SELECT * FROM #Sell_Phy) T
Left join [dbo].[IWMF_trn_current_holding_syn] hldg
 ON hldg.party_Code=T.Party_Code and hldg.fsSchemeCode=T.SchemeCode  
 
END

--------------------Logic for Phy ------------------


SELECT A.*,B.SchemeName FROM #Final A
Inner join MutualFund.dbo.schememaster B
ON substring(A.SchemeCode,2,len(A.SchemeCode))=B.SchemeCode




Drop table #Buy_DP
Drop table #Sell_DP
Drop table #Buy_Phy
Drop table #Sell_Phy
--Drop table #Final_DP
--Drop table #Final_Phy
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMFDPFlagCheck_ISIN
-- --------------------------------------------------
CREATE Procedure [dbo].[usp_GetMFDPFlagCheck_ISIN]
(
--Declare 
@PartCode Varchar(200),
	@Flag Varchar(10),
	--@SchemeCode Varchar(200)
	@ISIN Varchar(2000)

--Declare @SchemeName Varchar(200)=''
)
AS
BEGIN

--EXEC usp_GetMFDPFlagCheck 'RP61','Sell','G14051454.002066,G14053239.002066'
--EXEC usp_GetMFDPFlagCheck 'RP61','Buy','G14051454.002066,G14053239.002066'

--Declare @PartCode Varchar(200)
--Declare @Flag Varchar(10)='Buy'
--Declare @SchemeName Varchar(200)=''

SET NOCOUNT ON 

--Declare @SchemeCode varchar(200)='G14051581.002066' --DP
--Declare @SchemeCode varchar(200)='G14053239.002066'  --DP
--Declare @SchemeCode varchar(200)='G14051454.002066,G14053239.002066'  --PHY



--Select @PartCode ='RP61'
Create Table #Final
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)


 IF OBJECT_ID('TempDB..#SchemeCode') IS NOT NULL  
  DROP TABLE #SchemeCode
 SELECT StringValue AS ISIN  
  INTO #SchemeCode
 FROM dbo.fn_Split1(@ISIN, ',')  




--------------------Logic for DP ------------------

SELECT Clientcode Party_Code,@Flag Flag,DPFlag,fund_code,Scheme_Code,FolioNo,Buy.ISIN INTO #Buy_DP FROM [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
Inner join #SchemeCode SCH
--ON Buy.Scheme_Code=SCH.SchemeCode
ON Buy.ISIN=SCH.ISIN
 where Clientcode=@PartCode 
 --and  Scheme_Code=@SchemeCode 
 and @Flag='Buy' 
AND DPFlag='DP'

SELECT Clientcode Party_Code, @Flag Flag,DPFlag,fund_code,Scheme_Code,FolioNo,Sell.ISIN INTO #Sell_DP FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
Inner join #SchemeCode SCH
ON Sell.ISIN=SCH.ISIN
where Clientcode=@PartCode --and  Scheme_Code=@SchemeCode 
and @Flag='Sell'
AND DPFlag='DP'

--select * from #Buy_DP



IF 	(
	SELECT DISTINCT 1 FROM #Buy_DP 
		UNION 
	SELECT 1 FROM #Sell_DP  )>0
BEGIN 

Print 'A'

Insert into #Final
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
CASE WHEN hldg.fsSchemeCode IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 

--INTO #Final_DP
From 
(SELECT * FROM #Buy_DP
		UNION ALL
		SELECT * FROM #Sell_DP) T
Left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin
 
END



--------------------Logic for DP ------------------



--------------------Logic for Phy ------------------


SELECT Clientcode Party_Code,@Flag Flag,DPFlag,fund_code,Scheme_Code,FolioNo,Buy.ISIN INTO #Buy_Phy FROM [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK) 
Inner join #SchemeCode SCH
ON Buy.ISIN=SCH.ISIN
WHERE Clientcode=@PartCode and @Flag='Buy' 
AND DPFlag='Phy'

SELECT Clientcode Party_Code, @Flag Flag,DPFlag,fund_code,Scheme_Code,FolioNo,Sell.ISIN INTO #Sell_Phy FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
Inner join #SchemeCode SCH
ON Sell.ISIN=SCH.ISIN
where Clientcode=@PartCode and @Flag='Sell'
AND DPFlag='Phy'


IF 	(SELECT DISTINCT 1 FROM #Buy_Phy 
		UNION 
	SELECT 1 FROM #Sell_Phy  )>0
BEGIN 

Print 'B'

Insert into #Final
SELECT distinct 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
CASE WHEN hldg.folio_no IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
--INTO #Final_Phy
From 
(SELECT * FROM #Buy_Phy
		UNION ALL
		SELECT * FROM #Sell_Phy) T
Left join [dbo].[IWMF_trn_current_holding_syn] hldg WITH (NOLOCK)
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin
 
END

--------------------Logic for Phy ------------------

select * from #Final

SELECT A.*,SchemeName  FROM #Final A
left join MutualFund.dbo.schememaster B WITH (NOLOCk)
ON substring(A.Scheme_Code,2,len(A.Scheme_Code))=B.SchemeCode




Drop table #Buy_DP
Drop table #Sell_DP
Drop table #Buy_Phy
Drop table #Sell_Phy
Drop table #Final
--Drop table #Final_Phy
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMFDPFlagCheck_New04June2018
-- --------------------------------------------------


CREATE Procedure [dbo].[usp_GetMFDPFlagCheck_New04June2018]
(
--Declare 
	@PartyCode Varchar(200)='A104895',
	@Flag Varchar(10)='Buy',
	--@SchemeCode Varchar(200)
	@ISIN Varchar(2000)='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

)
AS
BEGIN
/*
For Checking 

select dpflag,* from [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK) 
	where Clientcode='A120281'
and isin  in ('INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')

EXEC usp_GetMFDPFlagCheck_New04June2018 @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC [dbo].[usp_GetMFDPFlagCheck_New04June2018] 'P77935','Buy','INF204K01UN9'


select ISIN,* from [IWMF_trn_current_holding_syn] with (nolock) 
where  isin  in ('INF209K01BR9','INF789F01372','INF179K01392','INF740K01250','INF204K01UN9')
and 
party_Code='ALWR1937'

EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR2144',@Flag='Sell',@ISIN='INF204K01UE8'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='ALWR1937',@Flag='Buy',@ISIN='INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A120281',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'

EXEC usp_GetMFDPFlagCheck @PartyCode='A104895',@Flag='Buy',@ISIN='INF209K01BR9,INF789F01372,INF179K01392,INF740K01250,INF204K01UN9'



*/




SET NOCOUNT ON 

--Declare @SchemeCode varchar(200)='G14051581.002066' --DP
--Declare @SchemeCode varchar(200)='G14053239.002066'  --DP
--Declare @SchemeCode varchar(200)='G14051454.002066,G14053239.002066'  --PHY

Create Table #Buy_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_DP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


Create Table #Buy_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)

Create Table #Sell_Phy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	--,BuySell Varchar(100)
)


--Select @PartyCode ='A100644'
Create Table #FinalDP
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #FinalPhy
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)

Create Table #Final
(
	Party_Code Varchar(100)
	,Flag Varchar(10)
	,dpflag Varchar(100)
	,fund_code Varchar(100)
	,Scheme_Code Varchar(100)
	,FolioNo Varchar(100)
	,ISIN Varchar(100)
	,BuySell Varchar(100)
)



 IF OBJECT_ID('TempDB..#SchemeCode') IS NOT NULL  
  DROP TABLE #SchemeCode
 SELECT StringValue AS ISIN ,@PartyCode PartyCode 
  INTO #SchemeCode
 FROM dbo.fn_Split1(@ISIN, ',')  

 Declare @angelid varchar(10)
--Declare @PartyCode varchar(10)='A100644'


select @angelid=angelid from [172.31.16.75].[ANGEL_WMS].[dbo].users with (nolock) where loginID=@PartyCode

select userType,angelId,@PartyCode PartyCode   
Into #userType
from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) where angelid=@angelid

 --select *  from [172.31.16.75].[ANGEL_WMS].[dbo].[user_type_mapper] WITH (NOLOCK) 



 --select * from #SchemeCode


--------------------Logic for DP ------------------
If EXISTS (select * from #userType where userType='Trading')
Begin 



insert into #Buy_DP
SELECT @PartyCode Party_Code,@Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN --INTO #Buy_DP 
FROM #SchemeCode SCH 
left join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 and @Flag='Buy' 
AND DPFlag='DP'
and Buy.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg 
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin



select * from #Buy_DP


insert into #Sell_DP
SELECT @PartyCode Party_Code, @Flag Flag, DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  --INTO #Sell_DP 
--INTO #Sell_DP
FROM #SchemeCode SCH left join 
[dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='DP'
and Sell.ISIN not in ('INF204K01UN9')
UNION
select @PartyCode Party_Code,@Flag Flag,'PHY' DPFlag,fund_code,'',folio_no,SCH.ISIN  from #SchemeCode SCH  
left join [dbo].[IWMF_trn_current_holding_syn] hldg 
ON sch.PartyCode=hldg.party_code and hldg.isin=sch.isin




--select * from #Sell_DP



IF 	(
	SELECT DISTINCT 1 FROM #Buy_DP 
		UNION 
	SELECT 1 FROM #Sell_DP  )>0
BEGIN 

Print 'A'

Insert into #FinalDP
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_DP
		UNION ALL
		SELECT * FROM #Sell_DP) T
inner join [dbo].[IWMF_trn_current_holding_syn] hldg
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin
 

END



--select * from #FinalDP 


insert into #Final
SELECT Party_Code,	Flag,	'DP' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
--INTO #FinalDP1
 FROM #FinalDP
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'DP' DPFlag,	 hldg.fund_code,	fsSchemeCode Scheme_Code,folio_no	FolioNo,	A.ISIN,'Fresh' BuySell
 from #SchemeCode A
 left join #FinalDP B ON A.ISIN=B.ISIN and A.PartyCode=B.Party_Code
 left join [dbo].[IWMF_trn_current_holding_syn] hldg
 ON hldg.party_Code=B.Party_Code and hldg.isin=B.isin 
 where A.ISIN not in  (select isin from #FinalDP where dpflag='DP' )--and ISIN not in ('INF204K01UN9'))/*Added By Yogesh_04June2018 For INF204K01UN9 ISIN to Fetch*/ 
and A.ISIN not in ('INF204K01UN9')
 
 END

 Update #Final
 Set dpflag='Phy'
 where ISIN= 'INF204K01UN9'

 --select '1',* from #Final
--------------------Logic for DP ------------------



--------------------Logic for Phy ------------------
If EXISTS (select * from #userType where userType in ('MF','MFIP','PU'))
Begin 

Print 'AA'
insert into #Buy_Phy
SELECT @PartyCode Party_Code,@Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN 
--INTO #Buy_Phy 
FROM #SchemeCode SCH 
inner join  [dbo].[tbl_TransactionBuy_UniqueCode_syn] Buy WITH (NOLOCK)
ON SCH.PartyCode=Buy.Clientcode
 and SCH.ISIN=Buy.ISIN
 where SCH.PartyCode=@PartyCode 
 --and  Scheme_Code=@SchemeCode 
 and @Flag='Buy' 
AND DPFlag='Phy'



Insert into #Sell_Phy 
SELECT @PartyCode Party_Code, @Flag Flag,'Phy' DPFlag,fund_code,Scheme_Code,FolioNo,SCH.ISIN  
--INTO #Sell_Phy 
FROM [dbo].[tbl_TransactionSale_UniqueCode_syn] Sell WITH (NOLOCK) 
left join #SchemeCode SCH
ON Sell.Clientcode=SCH.PartyCode
and Sell.ISIN=SCH.ISIN
where Clientcode=@PartyCode 
and @Flag='Sell'
AND DPFlag='Phy'

--select * from #Buy_Phy
--select * from #Sell_Phy


IF 	(
	SELECT DISTINCT 1 FROM #Buy_Phy 
		UNION 
	SELECT 1 FROM #Sell_Phy  )>0
BEGIN 

Print 'A'

Insert into #FinalPhy
SELECT 
T.Party_Code,	T.Flag,	T.dpflag,	T.fund_code,T.Scheme_Code,	T.FolioNo,T.ISIN,
--CASE WHEN hldg.ISIN IS NULL THEN 'Fresh' ELSE 'Additional' END As 'BuySell' 
'Additional' As 'BuySell' 
--INTO #Final_DP
From 
(SELECT * FROM #Buy_Phy
		UNION ALL
		SELECT * FROM #Sell_Phy) T
inner join [dbo].[IWMF_trn_current_holding_syn] hldg
 ON hldg.party_Code=T.Party_Code and hldg.isin=T.isin and hldg.folio_no=T.FolioNo


 
END


insert into #Final
SELECT Party_Code,	Flag,	'Phy' dpflag,	fund_code,	Scheme_Code,	FolioNo	,ISIN,	BuySell
 FROM #FinalPhy
UNION 
select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	fund_code fund_code,	'' Scheme_Code,folio_no FolioNo,	T.ISIN,'Fresh' BuySell
 from #SchemeCode T
 left join [dbo].[IWMF_trn_current_holding_syn] hldg
 ON hldg.party_Code=T.PartyCode and hldg.isin=T.isin
 where T.ISIN not in  (select isin from #FinalPhy where dpflag='Phy')
 
 --------------------Logic for Phy ------------------

--select * from #Final

END

select * from #Final
--UNION
--select @PartyCode Party_Code,	@Flag Flag,	'Phy' DPFlag,	'' fund_code,	'' Scheme_Code,'' 	FolioNo,	ISIN,'Fresh' BuySell
-- from #SchemeCode
-- where ISIN not in  (select isin from #FinalPhy)--------------------Logic for Phy ------------------


--SELECT distinct A.*,SchemeName  FROM #Final A
--left join MutualFund.dbo.schememaster B
--ON substring(A.Scheme_Code,2,len(A.Scheme_Code))=B.SchemeCode




Drop table #Buy_DP
Drop table #Sell_DP
Drop table #Buy_Phy
Drop table #Sell_Phy
Drop table #FinalDP
Drop table #FinalPhy
Drop table #Final
--Drop table #FinalDP1
--Drop table #FinalPhy1
Drop table #userType



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getMFLedgerBalance
-- --------------------------------------------------
Create PROCEDURE usp_getMFLedgerBalance
(@PartyCode Varchar(200))
AS
BEGIN

--EXEC usp_getMFLedgerBalance @PartyCode ='I9223'


SELECT sum(DRAMOUNT) DRAMOUNT,CL_CODE As PartyCode 
INTO #Temp
FROM [196.1.115.200].BBO_FA.dbo.MFSS_REL_DATA with (nolock) WHERE RELDT_DR ='' AND RELDT_CR =''
and VTYPE=2
and CL_CODE=@PartyCode 
group by CL_CODE



--select * from #Temp


SELECT		Sum(cramount)                 AS CRAMOUNT,                   
            Sum(dramount)                 AS DRAMOUNT,                  
            Sum(cramount) - Sum(dramount) AS BALANCE,                   
            cltcode,                   
            edt                   
     INTO   #bse                   
     FROM   [196.1.115.200].bbo_fa.dbo.mfss_ledger_bse with (nolock)                   
     --WHERE  CONVERT(DATETIME, CONVERT(VARCHAR(11), edt)) = CONVERT(DATETIME,CONVERT(VARCHAR(11), Getdate()))                   
    -- WHERE EDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
       WHERE VDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
       and EDT>=(SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)
       and cltcode=@PartyCode 
     GROUP  BY cltcode,                   
               edt                   
                 
     SELECT Sum(cramount)                 AS CRAMOUNT,                   
            Sum(dramount)                 AS DRAMOUNT,                  
            Sum(cramount) - Sum(dramount) AS BALANCE,                   
            cltcode,                   
            edt                   
     INTO   #nse                   
     FROM   [196.1.115.200].bbo_fa.dbo.mfss_ledger_nse  with (nolock)                
     --WHERE  CONVERT(DATETIME, CONVERT(VARCHAR(11), edt)) = CONVERT(DATETIME,CONVERT(VARCHAR(11), Getdate()))                   
     WHERE EDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
     and EDT>=(SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)
     and cltcode=@PartyCode
     GROUP  BY cltcode,                   
               edt          

--select * from #bse 
--select * from #nse 


--select '1',* from #bse A inner join #Temp B  ON A.cltcode=B.PartyCode 
--select '2',* from #nse A inner join #Temp B  ON A.cltcode=B.PartyCode 


Select * INTO #MF_PO from risk.dbo.vw_MutualFundPendingOrder_NCMS WITH (NOLOCK)
--Select * INTO #MF_PO from [196.1.115.132].risk.dbo.vw_MutualFundPendingOrder_NCMS WITH (NOLOCK)
               
SELECT SUM(balance)-SUM(ISNULL(B.DRAMOUNT,0))-ISNULL(SUM(PO.Amount),0) Balance,B.PartyCode  from #bse A --order by edt    
left JOIN #Temp B  ON A.cltcode=B.PartyCode  
left join #MF_PO PO ON A.cltcode=PO.clientcode       
GROUP BY B.PartyCode         

select SUM(balance)-SUM(ISNULL(B.DRAMOUNT,0))-ISNULL(SUM(PO.Amount),0) Balance ,B.PartyCode  from #nse A--order by edt
left JOIN #Temp B  ON A.cltcode=B.PartyCode
left join #MF_PO PO ON A.cltcode=PO.clientcode
GROUP BY B.PartyCode         


DROP TABLE #bse
DROP TABLE #nse
Drop table #Temp
DROP TABLE #MF_PO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise]
(
	@RoleName varchar(100)
)
AS
--Usp_GetModuleListRoleWise 'admin'
--Usp_GetModuleListRoleWise 'Sales'
--Usp_GetModuleListRoleWise 'CSO'

begin

SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
	FROM 
		RoleMaster RM WITH (NOLOCK)
		INNER JOIN ModuleRoleMapping MMM WITH (NOLOCK)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM WITH (NOLOCK)
		ON MM.ModuleId=MMM.ModuleId
	WHERE RM.RoleName=@RoleName 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New]
(
--Declare 	
	@RoleName varchar(100)
)
--WITH RECOMPILE
AS

--EXEC [Usp_GetModuleListRoleWise_New_SD] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--EXEC [Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster with(nolock)  where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	--into #Temp
	FROM 
	
		RoleMaster RM with(nolock)
		INNER JOIN ModuleRoleMapping MMM with(nolock)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM with(nolock)
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM with(nolock)
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM with(nolock)
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM with(nolock)
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	--select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM with(nolock)
	left join ModuleRoleMapping MMM with(nolock)
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM with(nolock)
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM with(nolock)
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM with(nolock)
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select MM.moduleid 
						from RoleMaster RM with(nolock)
	INNER JOIN ModuleRoleMapping MMM with(nolock)
	ON RM.Roleid=MMM.Roleid
	inner join ModuleMaster MM with(nolock)
	ON MM.ModuleId=MMM.ModuleId
	--Left join ModuleMappingMaster MMMM with(nolock)
	--ON MMMM.ModuleID=MM.ModuleId
	--Left join ControllerMaster CM with(nolock)
	--ON CM.ControllerId=MMMM.ControllerId
	--Left join ActionMaster AM with(nolock)
	--ON AM.ActionId=MMMM.ActionId
WHERE 
	RM.RoleName=@RoleName and
	MMM.Active=1 )

and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


--drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New_bkp_20180423
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New_bkp_20180423]
(
	@RoleName varchar(100)='Admin'
)
AS
--[Usp_GetModuleListRoleWise_New] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT

select @RoleId=Roleid from RoleMaster where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	into #Temp
	FROM 
	
		RoleMaster RM
		INNER JOIN ModuleRoleMapping MMM
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,'0' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	FROM ModuleMaster MM
	left join ModuleRoleMapping MMM
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
 --MMM.ModuleID is null
 --and RM.RoleName=@RoleName 
--and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New_Bkp03Aug2018
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New_Bkp03Aug2018]
(
--Declare 	
	@RoleName varchar(100)='CSO'
)
--WITH RECOMPILE
AS

--EXEC [Usp_GetModuleListRoleWise_New_SD] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--EXEC [Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster with(nolock)  where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	into #Temp
	FROM 
	
		RoleMaster RM with(nolock)
		INNER JOIN ModuleRoleMapping MMM with(nolock)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM with(nolock)
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM with(nolock)
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM with(nolock)
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM with(nolock)
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM with(nolock)
	left join ModuleRoleMapping MMM with(nolock)
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM with(nolock)
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM with(nolock)
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM with(nolock)
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New_Bkp18June2018
-- --------------------------------------------------

--1,2,6,7,8,23,29,31,35

CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New_Bkp18June2018]
(
--Declare 	
	@RoleName varchar(100)='CSO'
)
AS
--[Usp_GetModuleListRoleWise_New] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--[Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	into #Temp
	FROM 
	
		RoleMaster RM
		INNER JOIN ModuleRoleMapping MMM
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	FROM ModuleMaster MM
	left join ModuleRoleMapping MMM
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New_Bkp18June2018_5_08Pm
-- --------------------------------------------------

--1,2,6,7,8,23,29,31,35

CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New_Bkp18June2018_5_08Pm]
(
--Declare 	
	@RoleName varchar(100)='CSO'
)
AS
--[Usp_GetModuleListRoleWise_New] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--[Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	into #Temp
	FROM 
	
		RoleMaster RM
		INNER JOIN ModuleRoleMapping MMM
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	FROM ModuleMaster MM
	left join ModuleRoleMapping MMM
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New_Bkp19June2018
-- --------------------------------------------------


--1,2,6,7,8,23,29,31,35

CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New_Bkp19June2018]
(
--Declare 	
	@RoleName varchar(100)='CSO'
)
AS
--[Usp_GetModuleListRoleWise_New] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--[Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	into #Temp
	FROM 
	
		RoleMaster RM
		INNER JOIN ModuleRoleMapping MMM
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active
	FROM ModuleMaster MM
	left join ModuleRoleMapping MMM
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New_SD
-- --------------------------------------------------


--1,2,6,7,8,23,29,31,35

CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New_SD]
(
--Declare 	
	@RoleName varchar(100)='CSO'
)
AS
--EXEC [Usp_GetModuleListRoleWise_New_SD] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--[Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	into #Temp
	FROM 
	
		RoleMaster RM WITH (NOLOCk)
		INNER JOIN ModuleRoleMapping MMM WITH (NOLOCK)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM WITH (NOLOCK)
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM WITH (NOLOCK)
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM WITH (NOLOCK)
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM WITH (NOLOCK)
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM WITH (NOLOCK)
	left join ModuleRoleMapping MMM WITH (NOLOCK)
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM WITH (NOLOCK)
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM WITH (NOLOCK)
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM WITH (NOLOCK)
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New_test
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New_test]
(
--Declare 	
	@RoleName varchar(100)
)
--WITH RECOMPILE
AS

--EXEC [Usp_GetModuleListRoleWise_New_SD] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--EXEC [Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster with(nolock)  where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	--into #Temp
	FROM 
	
		RoleMaster RM with(nolock)
		INNER JOIN ModuleRoleMapping MMM with(nolock)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM with(nolock)
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM with(nolock)
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM with(nolock)
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM with(nolock)
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	--select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM with(nolock)
	left join ModuleRoleMapping MMM with(nolock)
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM with(nolock)
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM with(nolock)
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM with(nolock)
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select MM.moduleid 
						from RoleMaster RM with(nolock)
	INNER JOIN ModuleRoleMapping MMM with(nolock)
	ON RM.Roleid=MMM.Roleid
	inner join ModuleMaster MM with(nolock)
	ON MM.ModuleId=MMM.ModuleId
	--Left join ModuleMappingMaster MMMM with(nolock)
	--ON MMMM.ModuleID=MM.ModuleId
	--Left join ControllerMaster CM with(nolock)
	--ON CM.ControllerId=MMMM.ControllerId
	--Left join ActionMaster AM with(nolock)
	--ON AM.ActionId=MMMM.ActionId
WHERE 
	RM.RoleName=@RoleName and
	MMM.Active=1 )

and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


--drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWise_New999
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListRoleWise_New999]
(
--Declare 	
	@RoleName varchar(100)='CSO'
)
--WITH RECOMPILE
AS

--EXEC [Usp_GetModuleListRoleWise_New_SD] 'admin'
--[Usp_GetModuleListRoleWise_New] 'Sales'
--EXEC [Usp_GetModuleListRoleWise_New] 'SB'
--[Usp_GetModuleListRoleWise_New] 'CSO'

begin

Declare @RoleId iNT
,@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster with(nolock)  where rolename=@RoleName


SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	into #Temp
	FROM 
	
		RoleMaster RM with(nolock)
		INNER JOIN ModuleRoleMapping MMM with(nolock)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM with(nolock)
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM with(nolock)
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM with(nolock)
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM with(nolock)
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1

	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM with(nolock)
	left join ModuleRoleMapping MMM with(nolock)
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM with(nolock)
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM with(nolock)
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM with(nolock)
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN
-- --------------------------------------------------


CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN]
(
	@RoleName varchar(100)
)
AS
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Newadmin'
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'SB'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN_1] 'User'

BEGIN

--return 0 
Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

--INSERT INTO #ModuleParentChildMaster
--EXEC usp_ModuleParentChildMaster

INSERT INTO #ModuleParentChildMaster
SELECT	
	A.ModuleId,A.ModuleName,B.ModuleName as ParentModuleName,
	A.Type,A.Parentid 
FROM
	ModuleMaster A
	LEFT JOIN ModuleMaster B
	ON A.Parentid=B.ModuleId
--where A.Type='Menu'



--INSERT INTO #ModuleListRoleWise
--EXEC [Usp_GetModuleListRoleWise_New] @RoleName


--------------------------------------------


Declare
 --@RoleId iNT
--,
@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster where rolename=@RoleName

SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	into #Temp
	FROM 
	
		RoleMaster RM
		INNER JOIN ModuleRoleMapping MMM
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1


	
insert into #ModuleListRoleWise
	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM
	left join ModuleRoleMapping MMM
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
--and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp


----------------------------------------------------

--Update #ModuleListRoleWise
--Set Flag=0 
--where ModuleName='MyBusiness'
--and Rolename=@RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
 FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId
--inner join [ModuleRoleMapping] C 
--ON A.ModuleId=C.ModuleId
--	and A.Roleid=C.Roleid
--where B.Type='Menu'
--and C.Active=1

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_AccessPermission
-- --------------------------------------------------
CREATE  PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission]
(
	@RoleName varchar(100)
)
with recompile
AS
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN


--return 0
Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




if object_id('tempdb..##RoleWiseAssignedYN') is not null
		drop table ##RoleWiseAssignedYN;

SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018
-- --------------------------------------------------
CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018]
(
	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY
)
AS

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_SD
-- --------------------------------------------------
CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_SD]
(
	@RoleName varchar(100)
	,@tableVariable tablevariable readonly 
)
AS
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'SB'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Begin try
Begin tran
Begin
Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




if object_id('tempdb..##RoleWiseAssignedYN') is not null

		
		drop table ##RoleWiseAssignedYN;
		
	
	

SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster

End

Commit tran
End try
Begin catch

if @@trancount > 0
Begin
Rollback tran
End
End catch
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_bkp_05102018
-- --------------------------------------------------


CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_bkp_05102018]
(
	@RoleName varchar(100)
)
AS
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Newadmin'
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'SB'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN_1] 'User'

BEGIN

Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

--INSERT INTO #ModuleParentChildMaster
--EXEC usp_ModuleParentChildMaster

INSERT INTO #ModuleParentChildMaster
SELECT	
	A.ModuleId,A.ModuleName,B.ModuleName as ParentModuleName,
	A.Type,A.Parentid 
FROM
	ModuleMaster A
	LEFT JOIN ModuleMaster B
	ON A.Parentid=B.ModuleId
where A.Type='Menu'



--INSERT INTO #ModuleListRoleWise
--EXEC [Usp_GetModuleListRoleWise_New] @RoleName


--------------------------------------------


Declare
 --@RoleId iNT
--,
@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster where rolename=@RoleName

SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	into #Temp
	FROM 
	
		RoleMaster RM
		INNER JOIN ModuleRoleMapping MMM
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1


	
insert into #ModuleListRoleWise
	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM
	left join ModuleRoleMapping MMM
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp


----------------------------------------------------

--Update #ModuleListRoleWise
--Set Flag=0 
--where ModuleName='MyBusiness'
--and Rolename=@RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
 FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId
--inner join [ModuleRoleMapping] C 
--ON A.ModuleId=C.ModuleId
--	and A.Roleid=C.Roleid
where B.Type='Menu'
--and C.Active=1

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_bkp_20180423
-- --------------------------------------------------



CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_bkp_20180423]
(
	@RoleName varchar(100)
)
AS
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Declare @RoleId iNT

select @RoleId=Roleid from RoleMaster where rolename=@RoleName

Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_bkp20180830_1PM
-- --------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_bkp20180830_1PM]
(
	@RoleName varchar(100)
)
AS
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Newadmin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

--INSERT INTO #ModuleParentChildMaster
--EXEC usp_ModuleParentChildMaster

INSERT INTO #ModuleParentChildMaster
SELECT	
	A.ModuleId,A.ModuleName,B.ModuleName as ParentModuleName,
	A.Type,A.Parentid 
FROM
	ModuleMaster A
	LEFT JOIN ModuleMaster B
	ON A.Parentid=B.ModuleId




--INSERT INTO #ModuleListRoleWise
--EXEC [Usp_GetModuleListRoleWise_New] @RoleName


--------------------------------------------


Declare
 --@RoleId iNT
--,
@ParentId INT

--select @RoleId=Roleid from RoleMaster where rolename=@RoleName
select @RoleId=Roleid,@ParentId  = ParentId from RoleMaster where rolename=@RoleName

SELECT RM.Roleid,MM.ModuleId,RM.RoleName,MM.ModuleName,MM.FreePaid ,'1' Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	into #Temp
	FROM 
	
		RoleMaster RM
		INNER JOIN ModuleRoleMapping MMM
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM
		ON MM.ModuleId=MMM.ModuleId
		Left join ModuleMappingMaster MMMM
		ON MMMM.ModuleID=MM.ModuleId
		Left join ControllerMaster CM
		ON CM.ControllerId=MMMM.ControllerId
		Left join ActionMaster AM
		ON AM.ActionId=MMMM.ActionId
	WHERE RM.RoleName=@RoleName 
	and MMM.Active=1


	
insert into #ModuleListRoleWise
	select * from #Temp
	UNION 
SELECT @RoleId RoleId, MM.ModuleId,@RoleName RoleName,MM.ModuleName,MM.FreePaid ,0 Flag,MM.Level,CM.ControllerName	,AM.ActionName,MMM.Active,MMM.FromDate,MMM.ToDate,MMM.Reason
	FROM ModuleMaster MM
	left join ModuleRoleMapping MMM
	ON MM.ModuleId=MMM.ModuleId
	--left join #Temp RM
	--ON RM.Roleid=MMM.Roleid
	Left join ModuleMappingMaster MMMM
	ON MMMM.ModuleID=MM.ModuleId
	Left join ControllerMaster CM
	ON CM.ControllerId=MMMM.ControllerId
	Left join ActionMaster AM
	ON AM.ActionId=MMMM.ActionId
	and MM.ModuleId=MMM.ModuleId
where MM.moduleid not in (select moduleid from #Temp where Roleid=@RoleId)
and case when @RoleId <> 1 THEn MMM.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 
-- --MMM.ModuleID is null
-- --and RM.RoleName=@RoleName 
----and MMM.Active=1


--SELECT RM.Roleid,MM.ModuleId,RM.RoleName,RM.NodeType,MM.ModuleName 
--	FROM 
--		RoleMaster RM
--		INNER JOIN ModuleRoleMapping MMM
--		ON RM.Roleid=MMM.Roleid
--		inner join ModuleMaster MM
--		ON MM.ModuleId=MMM.ModuleId
--	WHERE RM.RoleName=@RoleName 


drop table #Temp


----------------------------------------------------



SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
 FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_Bkp25Apr2018
-- --------------------------------------------------


create PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_Bkp25Apr2018]
(
	@RoleName varchar(100)
)
AS
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_Bkp25July2018
-- --------------------------------------------------

CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_Bkp25July2018]
(
	@RoleName varchar(100)
)
AS
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Newadmin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
 FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_New
-- --------------------------------------------------


CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_New]
(
	@RoleName varchar(100)
)
AS
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_New] 'SB'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)


INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

select 1,* from #ModuleParentChildMaster

INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName

Select 2,* from #ModuleListRoleWise

SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 FROM
 #ModuleListRoleWise A
INNER join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListRoleWiseAssignedYN_SD
-- --------------------------------------------------


CREATE PROC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_SD]
(
	@RoleName varchar(100)
)
AS
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_SD] 'Newadmin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New_SD] @RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,A.FromDate
	,A.ToDate
	,A.Reason
 FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWise
-- --------------------------------------------------


-------------------------------------------------------------------------------------Fetching --------------------------

CREATE  PROCEDURE [dbo].[Usp_GetModuleListUserWise]
(
@UserName varchar(100)
--,@Role varchar(200) 
)
AS
--EXEC Usp_GetModuleListUserWise 'Vishal'
--EXEC Usp_GetModuleListUserWise 'Yogesh'

BEGIN

	SELECT @UserName UserName,RM.RoleName,RM.NodeType,MM.ModuleName 
	FROM 
		UserMaster UM WITH (NOLOCK)
		INNER JOIN UserRolePermission URP WITH (NOLOCK)
		ON URP.Userid=UM.Userid
		inner join RoleMaster RM WITH (NOLOCK)
		ON RM.Roleid=URP.roleid
		INNER JOIN ModuleRoleMapping MMM WITH (NOLOCK)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM WITH (NOLOCK)
		ON MM.ModuleId=MMM.ModuleId
	WHERE UM.Name=@UserName 
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWise_MenuWise
-- --------------------------------------------------

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- Usp_GetModuleListUserWise_MenuWise 'HOIIIT' 
-- =============================================
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWise_MenuWise]
	-- Add the parameters for the stored procedure here
	@UserName varchar(100)=NULL

AS
declare @RoleName varchar(50)
BEGIN

SET NOCOUNT ON;
	
Declare @UserId int
--Declare @RoleName Varchar (50)

select  @UserId = UserId from UserMaster WITH(NOLOCK) where  name = @UserName

--select * into user_login_04122018 from [196.1.115.132].rolemgm.dbo.user_login WITH (NOLOCK)

--SELECT * INTO #TEMP FROM user_login_31220118

  IF (@UserId is null or @UserId=0)
   BEGIN

	 SELECT * INTO #TEMP FROM user_login_syn WITH (NOLOCK) where [status] = 1 and username=@UserName

     INSERT INTO UserMaster(Userid,Name,password,Active,createDate,CreateBy)
	 select userid,username,userpassword,1,getdate(),'system' from #TEMP  where username=@UserName

	 select  @UserId = UserId from UserMaster where  name = @UserName

	 DECLARE @ROLEID INT

	 select @ROLEID=RoleMaster.Roleid from RoleMaster  WITH(NOLOCK)
	 inner join #TEMP  loginsb  WITH(NOLOCK) on (case when loginsb.usertype='ADMIN' then 'SB' else loginsb.usertype end)=RoleMaster.RoleName
	 where userid=@UserId

	 INSERT INTO UserRolePermission(Userid,Roleid,createDate,CreateBy)
	 SELECT @UserId,@ROLEID,GETDATE(),'system'

   END

Select @RoleName = Rm.RoleName from UserRolePermission R  WITH(NOLOCK)
inner join RoleMaster Rm  WITH(NOLOCK) on RM.Roleid = R.Roleid
where R.Userid = @UserId



IF exists (select 1 from UserModuleMappingMaster M  WITH(NOLOCK)
where M.Userid = @UserId
and M.Active = '1')
Begin
Print 'AA'
	
--	create table #allmenusUser (
--Roleid int,ModuleId int,RoleName varchar(50),ModuleName varchar(50),Parentid int,ParentModuleName varchar(50),Type varchar(10),Flag int,FreePaid varchar(10),
--Level int,ControllerName varchar(50),ActionName varchar(50),FromDate varchar(50),ToDate varchar(50),Reason varchar(50)
--)


create table #allmenusUser1 (
RoleId	INT,Userid	INT,Name Varchar(100),	RoleName	Varchar(100),ModuleId	INT,ModuleName	Varchar(100),
Shortcode	Varchar(100),Parentid	INT,ParentModuleName	Varchar(100),Type	Varchar(100),Flag	Varchar(100),
FreePaid	Varchar(100),Level	Varchar(100),ControllerName	Varchar(100),ControllerId	INT,ActionName	Varchar(100),
ActionId	INT,FromDate	Varchar(100),Todate	Varchar(100),Reason Varchar(100)
)



	insert into #allmenusUser1 exec Usp_GetModuleListUserWiseAssignedParentYN NULL,@UserName 
	 
    select distinct ModuleId,ModuleName,Parentid,Type,Flag from #allmenusUser1 where Type='Menu' and Flag=1
	drop table #allmenusUser1
End

Else 

Begin 

Print 'BB'
		create table #allmenusRole (
Roleid int,ModuleId int,RoleName varchar(50),ModuleName varchar(50),Parentid int,ParentModuleName varchar(50),Type varchar(10),Flag int,FreePaid varchar(10),
Level int,ControllerName varchar(50),ActionName varchar(50),FromDate varchar(50),ToDate varchar(50),Reason varchar(50)
)

	insert into #allmenusRole exec Usp_GetModuleListUserWiseAssignedParentYN @RoleName
	 
    select distinct ModuleId,ModuleName,Parentid,Type,Flag from #allmenusRole where Type='Menu' and Flag=1
	drop table #allmenusRole
	
End
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWise_MenuWise_bkp03122018
-- --------------------------------------------------

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- Usp_GetModuleListUserWise_MenuWise 'HOIIIT' 
-- =============================================
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWise_MenuWise_bkp03122018]
	-- Add the parameters for the stored procedure here
	@UserName varchar(100)=NULL

AS
declare @RoleName varchar(50)
BEGIN

SET NOCOUNT ON;
	
Declare @UserId int
--Declare @RoleName Varchar (50)

select  @UserId = UserId from UserMaster WITH(NOLOCK) where  name = @UserName

  IF (@UserId is null or @UserId=0)
   BEGIN
     INSERT INTO UserMaster(Userid,Name,password,Active,createDate,CreateBy)
	 select userid,username,userpassword,1,getdate(),'system' from [196.1.115.132].rolemgm.dbo.user_login  WITH(NOLOCK)  where username=@UserName

	 select  @UserId = UserId from UserMaster where  name = @UserName

	 DECLARE @ROLEID INT

	 select @ROLEID=RoleMaster.Roleid from RoleMaster  WITH(NOLOCK)
	 inner join [196.1.115.132].rolemgm.dbo.user_login  loginsb  WITH(NOLOCK) on (case when loginsb.usertype='ADMIN' then 'SB' else loginsb.usertype end)=RoleMaster.RoleName
	 where userid=@UserId

	 INSERT INTO UserRolePermission(Userid,Roleid,createDate,CreateBy)
	 SELECT @UserId,@ROLEID,GETDATE(),'system'

   END

Select @RoleName = Rm.RoleName from UserRolePermission R  WITH(NOLOCK)
inner join RoleMaster Rm  WITH(NOLOCK) on RM.Roleid = R.Roleid
where R.Userid = @UserId



IF exists (select 1 from UserModuleMappingMaster M  WITH(NOLOCK)
where M.Userid = @UserId
and M.Active = '1')
Begin
Print 'AA'
	
--	create table #allmenusUser (
--Roleid int,ModuleId int,RoleName varchar(50),ModuleName varchar(50),Parentid int,ParentModuleName varchar(50),Type varchar(10),Flag int,FreePaid varchar(10),
--Level int,ControllerName varchar(50),ActionName varchar(50),FromDate varchar(50),ToDate varchar(50),Reason varchar(50)
--)


create table #allmenusUser1 (
RoleId	INT,Userid	INT,Name Varchar(100),	RoleName	Varchar(100),ModuleId	INT,ModuleName	Varchar(100),
Shortcode	Varchar(100),Parentid	INT,ParentModuleName	Varchar(100),Type	Varchar(100),Flag	Varchar(100),
FreePaid	Varchar(100),Level	Varchar(100),ControllerName	Varchar(100),ControllerId	INT,ActionName	Varchar(100),
ActionId	INT,FromDate	Varchar(100),Todate	Varchar(100),Reason Varchar(100)
)



	insert into #allmenusUser1 exec Usp_GetModuleListUserWiseAssignedParentYN NULL,@UserName 
	 
    select distinct ModuleId,ModuleName,Parentid,Type,Flag from #allmenusUser1 where Type='Menu' and Flag=1
	drop table #allmenusUser1
End

Else 

Begin 

Print 'BB'
		create table #allmenusRole (
Roleid int,ModuleId int,RoleName varchar(50),ModuleName varchar(50),Parentid int,ParentModuleName varchar(50),Type varchar(10),Flag int,FreePaid varchar(10),
Level int,ControllerName varchar(50),ActionName varchar(50),FromDate varchar(50),ToDate varchar(50),Reason varchar(50)
)

	insert into #allmenusRole exec Usp_GetModuleListUserWiseAssignedParentYN @RoleName
	 
    select distinct ModuleId,ModuleName,Parentid,Type,Flag from #allmenusRole where Type='Menu' and Flag=1
	drop table #allmenusRole
	
End
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWise_MenuWise_New
-- --------------------------------------------------

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- Usp_GetModuleListUserWise_MenuWise 'SLLM' 
/*
exec Usp_GetModuleListUserWise_MenuWise 'SLLM' 
go
exec Usp_GetModuleListUserWise_MenuWise_New 'SLLM' 

*/

-- =============================================
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWise_MenuWise_New]
	-- Add the parameters for the stored procedure here
	@UserName varchar(100)=NULL

AS
declare @RoleName varchar(50)
BEGIN

SET NOCOUNT ON;
	
Declare @UserId int
--Declare @RoleName Varchar (50)

select  @UserId = UserId from UserMaster WITH(NOLOCK) where  name = @UserName

select @UserId 
--select * into user_login_04122018 from [196.1.115.132].rolemgm.dbo.user_login WITH (NOLOCK)

--SELECT * INTO #TEMP FROM user_login_31220118

  IF (@UserId is null or @UserId=0)
   BEGIN

	 SELECT * INTO #TEMP FROM user_login_syn WITH (NOLOCK) where [status] = 1 and username=@UserName

     INSERT INTO UserMaster(Userid,Name,password,Active,createDate,CreateBy)
	 select userid,username,userpassword,1,getdate(),'system' from #TEMP  where username=@UserName

	 select  @UserId = UserId from UserMaster where  name = @UserName

	 DECLARE @ROLEID INT

	 select @ROLEID=RoleMaster.Roleid from RoleMaster  WITH(NOLOCK)
	 inner join #TEMP  loginsb  WITH(NOLOCK) on (case when loginsb.usertype='ADMIN' then 'SB' else loginsb.usertype end)=RoleMaster.RoleName
	 where userid=@UserId

	 INSERT INTO UserRolePermission(Userid,Roleid,createDate,CreateBy)
	 SELECT @UserId,@ROLEID,GETDATE(),'system'

   END

Select @RoleName = Rm.RoleName from UserRolePermission R  WITH(NOLOCK)
inner join RoleMaster Rm  WITH(NOLOCK) on RM.Roleid = R.Roleid
where R.Userid = @UserId


select * from UserModuleMappingMaster M  WITH(NOLOCK)
where M.Userid = @UserId
and M.Active = '1'

IF exists (
select 1 from UserModuleMappingMaster M  WITH(NOLOCK)
where M.Userid = @UserId
and M.Active = '1')
Begin
Print 'AA11'
	
--	create table #allmenusUser (
--Roleid int,ModuleId int,RoleName varchar(50),ModuleName varchar(50),Parentid int,ParentModuleName varchar(50),Type varchar(10),Flag int,FreePaid varchar(10),
--Level int,ControllerName varchar(50),ActionName varchar(50),FromDate varchar(50),ToDate varchar(50),Reason varchar(50)
--)


create table #allmenusUser1 (
RoleId	INT,Userid	INT,Name Varchar(100),	RoleName	Varchar(100),ModuleId	INT,ModuleName	Varchar(100),
Shortcode	Varchar(100),Parentid	INT,ParentModuleName	Varchar(100),Type	Varchar(100),Flag	Varchar(100),
FreePaid	Varchar(100),Level	Varchar(100),ControllerName	Varchar(100),ControllerId	INT,ActionName	Varchar(100),
ActionId	INT,FromDate	Varchar(100),Todate	Varchar(100),Reason Varchar(100)
)



	insert into #allmenusUser1 exec Usp_GetModuleListUserWiseAssignedParentYN NULL,@UserName 
	 
    select distinct ModuleId,ModuleName,Parentid,Type,Flag from #allmenusUser1 where Type='Menu' and Flag=1
	drop table #allmenusUser1
End

Else 

Begin 

Print 'BB11'
		create table #allmenusRole (
Roleid int,ModuleId int,RoleName varchar(50),ModuleName varchar(50),Parentid int,ParentModuleName varchar(50),Type varchar(10),Flag int,FreePaid varchar(10),
Level int,ControllerName varchar(50),ActionName varchar(50),FromDate varchar(50),ToDate varchar(50),Reason varchar(50)
)

	insert into #allmenusRole exec Usp_GetModuleListUserWiseAssignedParentYN @RoleName
	 
    select distinct ModuleId,ModuleName,Parentid,Type,Flag from #allmenusRole where Type='Menu' and Flag=1
	drop table #allmenusRole
	
End
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN]
(
	@RoleName varchar(100)=NULL,
	@UserName varchar(100)=NULL

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN  @RoleName='USER'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN  @UserName='ETPF'
AS
BEGIN

 --RETURN '0'
Declare @UserId int
--Declare @RoleName Varchar (50)

select  @UserId = UserId from UserMaster WITH (NOLOCK) where  name = @UserName

IF (isnull(@RoleName,'') = '')
Begin

Select @RoleName = Rm.RoleName from UserRolePermission R
inner join RoleMaster Rm  WITH (NOLOCK) on RM.Roleid = R.Roleid
where R.Userid = @UserId

End

IF exists (select 1 from UserModuleMappingMaster M WITH (NOLOCK)
where M.Userid = @UserId
and M.Active = '1')
Begin

Print 'A'
	EXEC [Usp_GetModuleListUserWiseAssignedYN] @UserName
	End

Else 

Begin 

Print 'B'

	EXEC [Usp_GetModuleListroleWiseAssignedYN] @RoleName

End


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
	EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
	EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
	EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'Admin','HOCBHO','home','BusinessDashboard'
	EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
	EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
*/
AS
BEGIN


--If @UserName='HOCBHO'
--begin
--return 0 
--END


--Begin try

--Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  WITH (NOLOCK) left join UserRolePermission P WITH (NOLOCK) 
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN




begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP  WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK) 
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

IF OBJECT_ID('tempdb.dbo.#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC 

select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK) 
inner join UserRolePermission UR  WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR  WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B  WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm  WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm  WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac  WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1


IF OBJECT_ID('tempdb.dbo.#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd

select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK) 
INNER JOIN UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


--if object_id('tempdb..##UserWiseAssignedYN') is not null
--		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	
declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
--Print 'AAA'
--Print @RoleName
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName



insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join (SELECT * FROM [UserModuleExclude]  WITH (NOLOCK) WHERE userid=@UserId) B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL
						--and b.userid=@UserId

-----------------------------------------------------------

END
END

--Commit tran

--End try

--Begin catch
--IF @@trancount > 0
--begin

--SELECT @@ERROR,eRROR_MESSAGE()

----SELECT 1
--Rollback tran
--end

--End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'
--EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018]  'SB','Vishal','Advisory','SearchCompany'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN

--DECLARE @myInputTableOrig myTableType
--DECLARE @myUpdatedTable myTableType

--INSERT INTO @myInputTableOrig ( someInt,somenVarChar )
--VALUES ( 0, N'Value 0' ), ( 1, N'Value 1' ), ( 2, N'Value 2' )

--INSERT INTO @myUpdatedTable EXEC returnTableTypeData @someInputInt=1, @myInputTable=@myInputTableOrig

--SELECT * FROM @myUpdatedTable



	SELECT * FROM @UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
	END

ELSE 

BEGIN 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			SELECT * FROM @RoleWiseAssignedYN
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018_New]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'
--EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018_New]  'SB','Vishal','Advisory','SearchCompany'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END


	SELECT * FROM @UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END









			SELECT * FROM @RoleWiseAssignedYN_New
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName





-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_999
-- --------------------------------------------------

Create PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_999]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

*/
AS
BEGIN


--Begin try

--Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  WITH (NOLOCK) left join UserRolePermission P WITH (NOLOCK) 
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN




begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP  WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK) 
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

IF OBJECT_ID('tempdb.dbo.#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC 

select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK) 
inner join UserRolePermission UR  WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR  WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B  WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm  WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm  WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac  WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1


IF OBJECT_ID('tempdb.dbo.#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd

select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK) 
INNER JOIN UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


--if object_id('tempdb..##UserWiseAssignedYN') is not null
--		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	
declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
--Print 'AAA'
--Print @RoleName
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName



insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join (SELECT * FROM [UserModuleExclude]  WITH (NOLOCK) WHERE userid=@UserId) B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL
						--and b.userid=@UserId

-----------------------------------------------------------

END
END

--Commit tran

--End try

--Begin catch
--IF @@trancount > 0
--begin

--SELECT @@ERROR,eRROR_MESSAGE()

----SELECT 1
--Rollback tran
--end

--End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_bkp_22_June_2018
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_bkp_22_June_2018]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',ET,'Home','Risk'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB','Vishal','Advisory','SearchCompany'
AS
BEGIN

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--CREATE TABLE #UserWiseAssignedYN (
--RoleId INT 
--,UserId INT
--,Name VARCHAR (100)
--,Rolename VARCHAR (20)
--,ModuleId INT
--,ModuleName VARCHAR (100)
--,ShortCode VARCHAR (100)
--,Parentid INT
--,ParentModuleName VARCHAR (100)
--,Type VARCHAR (100)
--,Flag BIT
--,Frepaid Varchar (100)
--,Level INT
--,ControllerName VARCHAR (10)
--,ControllerID INT
--,ActionName VARCHAR (100)
--,ActionId INT
--,FromDate VARCHAR (10)
--,ToDate VARCHAR (10)
--,Reason VARCHAR (2000)
--)

--INSERT INTO #UserWiseAssignedYN


--	EXEC [Usp_GetModuleListUserWiseAssignedYN] @UserName
EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName

	SELECT * FROM ##UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
	END

ELSE 

BEGIN 


--CREATE TABLE #RoleWiseAssignedYN
--(
--Roleid	INT,
--ModuleId	INT,
--RoleName	VARCHAR(100),
--Parentid INT,
--ParentModuleName	VARCHAR(100),
--Type	VARCHAR(10),
--Flag BIT,
--FreePaid VARCHAR(10),
--Level INT,
--ControllerName	VARCHAR(100),
--ActionName VARCHAR(100),
--)

--INSERT INTO #RoleWiseAssignedYN

	--EXEC [Usp_GetModuleListroleWiseAssignedYN] @RoleName
	EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName
			
			SELECT * FROM ##RoleWiseAssignedYN
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
--DROP table #RoleWiseAssignedYN
END


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp02Sept2021
-- --------------------------------------------------

Create PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp02Sept2021]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
	EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
	EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
	EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
	EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
	EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
*/
AS
BEGIN



--return 0 



--Begin try

--Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  WITH (NOLOCK) left join UserRolePermission P WITH (NOLOCK) 
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN




begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP  WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK) 
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

IF OBJECT_ID('tempdb.dbo.#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC 

select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK) 
inner join UserRolePermission UR  WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR  WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B  WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm  WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm  WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac  WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1


IF OBJECT_ID('tempdb.dbo.#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd

select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK) 
INNER JOIN UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


--if object_id('tempdb..##UserWiseAssignedYN') is not null
--		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	
declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
--Print 'AAA'
--Print @RoleName
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName



insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join (SELECT * FROM [UserModuleExclude]  WITH (NOLOCK) WHERE userid=@UserId) B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL
						--and b.userid=@UserId

-----------------------------------------------------------

END
END

--Commit tran

--End try

--Begin catch
--IF @@trancount > 0
--begin

--SELECT @@ERROR,eRROR_MESSAGE()

----SELECT 1
--Rollback tran
--end

--End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp12July2018
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp12July2018]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB','Vishal','Advisory','SearchCompany'

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--CREATE TABLE #UserWiseAssignedYN (
--RoleId INT 
--,UserId INT
--,Name VARCHAR (100)
--,Rolename VARCHAR (20)
--,ModuleId INT
--,ModuleName VARCHAR (100)
--,ShortCode VARCHAR (100)
--,Parentid INT
--,ParentModuleName VARCHAR (100)
--,Type VARCHAR (100)
--,Flag BIT
--,Frepaid Varchar (100)
--,Level INT
--,ControllerName VARCHAR (10)
--,ControllerID INT
--,ActionName VARCHAR (100)
--,ActionId INT
--,FromDate VARCHAR (10)
--,ToDate VARCHAR (10)
--,Reason VARCHAR (2000)
--)

--INSERT INTO #UserWiseAssignedYN


	
	--IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL
 --   DROP TABLE ##UserWiseAssignedYN

	--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
 --   DROP TABLE ##RoleWiseAssignedYN


--	EXEC [Usp_GetModuleListUserWiseAssignedYN] @UserName
EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName

	SELECT * FROM ##UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
--	IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##UserWiseAssignedYN

--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##RoleWiseAssignedYN


	END

ELSE 

BEGIN 


--CREATE TABLE #RoleWiseAssignedYN
--(
--Roleid	INT,
--ModuleId	INT,
--RoleName	VARCHAR(100),
--Parentid INT,
--ParentModuleName	VARCHAR(100),
--Type	VARCHAR(10),
--Flag BIT,
--FreePaid VARCHAR(10),
--Level INT,
--ControllerName	VARCHAR(100),
--ActionName VARCHAR(100),
--)

--INSERT INTO #RoleWiseAssignedYN

	--EXEC [Usp_GetModuleListroleWiseAssignedYN] @RoleName


		
--	IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##UserWiseAssignedYN
	
--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##RoleWiseAssignedYN

	EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName
			
			SELECT * FROM ##RoleWiseAssignedYN
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName

--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##RoleWiseAssignedYN


--DROP table #RoleWiseAssignedYN
END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

--SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp12July2018_7_04PM
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp12July2018_7_04PM]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'
--EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018_New]  'SB','Vishal','Advisory','SearchCompany'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END


	SELECT * FROM @UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END









			SELECT * FROM @RoleWiseAssignedYN_New
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName





-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp18July2018
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp18July2018]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'
--EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018_New]  'SB','Vishal','Advisory','SearchCompany'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END


	SELECT * FROM @UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END









			SELECT * FROM @RoleWiseAssignedYN_New
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName





-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp20July2018
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Bkp20July2018]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'
--EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_12jULY2018_New]  'SB','Vishal','Advisory','SearchCompany'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END


	SELECT * FROM @UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END









			SELECT * FROM @RoleWiseAssignedYN_New
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName





-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_bkup_22June2021
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_bkup_22June2021]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_bkup_22June2021] 'admin','CBHO','E-Welcome',''

*/
AS
BEGIN


--return 0 



--Begin try

--Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  WITH (NOLOCK) left join UserRolePermission P WITH (NOLOCK) 
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN




begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP  WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK) 
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

IF OBJECT_ID('tempdb.dbo.#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC 

select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK) 
inner join UserRolePermission UR  WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR  WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B  WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm  WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm  WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac  WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1


IF OBJECT_ID('tempdb.dbo.#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd

select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK) 
INNER JOIN UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


--if object_id('tempdb..##UserWiseAssignedYN') is not null
--		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	
declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
--Print 'AAA'
--Print @RoleName
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName



insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join (SELECT * FROM [UserModuleExclude]  WITH (NOLOCK) WHERE userid=@UserId) B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND isnull(ActionName,'') = isnull(@ActionName,'') /*Changes Done according to requirrement*/
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL
						--and b.userid=@UserId

-----------------------------------------------------------

END
END

--Commit tran

--End try

--Begin catch
--IF @@trancount > 0
--begin

--SELECT @@ERROR,eRROR_MESSAGE()

----SELECT 1
--Rollback tran
--end

--End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
AS
BEGIN

Declare @UserType Varchar(200)

select @UserType=UserType from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName 


if @UserType='USER'
begin 
	
	Set @RoleName='USER'
END

select '5',@RoleName


/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

begin tran

--delete FROM UserMaster where name ='HOET'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','ALWRAJYC','home','BusinessDashboard'
EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','AJYC','home','BusinessDashboard'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','HOET','home','BusinessDashboard'

rollback


exec Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'USER','SHAY','home','BusinessDashboard'

*/





Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

--select @UserName
--select @UserId

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M WITH (NOLOCK) left join UserRolePermission P WITH (NOLOCK)
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'

select '3',@RoleName

--select @UserID





Select 
--@Rolename=RM.Rolename,
@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC where ModuleName ='Business Dashboard'



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN
select '2',@RoleName

DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName


select '1',@RoleName

--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join [UserModuleExclude] B WITH (NOLOCK)
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL


-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222
-- --------------------------------------------------
CREATE PROCEDURE [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

begin tran

delete FROM UserMaster where name ='HOET'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','ALWRAJYC','home','BusinessDashboard'
EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','AJYC','home','BusinessDashboard'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','HOET','home','BusinessDashboard'

rollback


exec Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'USER','SHAY','home','BusinessDashboard'

*/
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

--select @UserName
--select @UserId

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  left join UserRolePermission P
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



select @UserID





Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC where ModuleName ='Business Dashboard'



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			SELECT * FROM @UserWiseAssignedYN
				WHERE ControllerName = @ControllerName
				AND ActionName = @ActionName
				and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join [UserModuleExclude] B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL


-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333
-- --------------------------------------------------
CREATE PROCEDURE [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
*/
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END


	SELECT * FROM @UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	 and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END



			SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join [UserModuleExclude] B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL



-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Sandeep
-- --------------------------------------------------
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB','Vishal','Advisory','SearchCompany'  

CREATE  PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Sandeep]  
(  
 @RoleName VARCHAR(100)=NULL,  
 @UserName VARCHAR(100)=NULL,  
 @ControllerName VARCHAR (100),  
 @ActionName VARCHAR (100)  
  
)  
  
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'  
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB','Vishal','Advisory','SearchCompany'  
  
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'  
AS  
BEGIN  
  
Begin try  
  
Begin tran  
Begin  
  
DECLARE @UserId INT  
--Declare @RoleName Varchar (50)  
  
SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName  
  
IF (isnull(@RoleName,'') = '')  
BEGIN  
  
SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)  
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid  
WHERE R.Userid = @UserId  
  
END  
  
IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M WITH (NOLOCK)   
WHERE M.Userid = @UserId  
AND M.Active = '1')  
  
BEGIN  
  
--CREATE TABLE #UserWiseAssignedYN (  
--RoleId INT   
--,UserId INT  
--,Name VARCHAR (100)  
--,Rolename VARCHAR (20)  
--,ModuleId INT  
--,ModuleName VARCHAR (100)  
--,ShortCode VARCHAR (100)  
--,Parentid INT  
--,ParentModuleName VARCHAR (100)  
--,Type VARCHAR (100)  
--,Flag BIT  
--,Frepaid Varchar (100)  
--,Level INT  
--,ControllerName VARCHAR (10)  
--,ControllerID INT  
--,ActionName VARCHAR (100)  
--,ActionId INT  
--,FromDate VARCHAR (10)  
--,ToDate VARCHAR (10)  
--,Reason VARCHAR (2000)  
--)  
  
--INSERT INTO #UserWiseAssignedYN  
  
  
   
 --IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL  
 --   DROP TABLE ##UserWiseAssignedYN  
  
 --IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL  
 --   DROP TABLE ##RoleWiseAssignedYN  
  
  
-- EXEC [Usp_GetModuleListUserWiseAssignedYN] @UserName  

declare @GetData as Table([RoleId] [int] NULL,[Userid] [int] NOT NULL,[Name] [varchar](100) NULL,
[RoleName] [varchar](20) NULL,[ModuleId] [int] NOT NULL,[ModuleName] [varchar](100) NULL,[Shortcode] [varchar](100) NULL,
[Parentid] [int] NULL,[ParentModuleName] [varchar](100) NULL,[Type] [varchar](100) NULL,[Flag] [bit] NULL,
[FreePaid] [varchar](10) NULL,[Level] [int] NULL,[ControllerName] [varchar](100) NULL,[ControllerId] [int] NULL,
[ActionName] [varchar](100) NULL,[ActionId] [int] NULL,[FromDate] [varchar](10) NULL,
[Todate] [varchar](10) NULL,[Reason] [varchar](max) NULL)
insert into @GetData
EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission_sandeep @UserName  
  
 SELECT * FROM @GetData
 WHERE ControllerName = @ControllerName  
 AND ActionName = @ActionName  
   
-- IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL  
--    DROP TABLE ##UserWiseAssignedYN  
  
--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL  
--    DROP TABLE ##RoleWiseAssignedYN  
  
  
 END  
  
ELSE   
  
BEGIN   
  
  
--CREATE TABLE #RoleWiseAssignedYN  
--(  
--Roleid INT,  
--ModuleId INT,  
--RoleName VARCHAR(100),  
--Parentid INT,  
--ParentModuleName VARCHAR(100),  
--Type VARCHAR(10),  
--Flag BIT,  
--FreePaid VARCHAR(10),  
--Level INT,  
--ControllerName VARCHAR(100),  
--ActionName VARCHAR(100),  
--)  
  
--INSERT INTO #RoleWiseAssignedYN  
  
 --EXEC [Usp_GetModuleListroleWiseAssignedYN] @RoleName  
  
  
    
-- IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL  
--    DROP TABLE ##UserWiseAssignedYN  
   
--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL  
--    DROP TABLE ##RoleWiseAssignedYN  
  declare @GetData1 as Table([RoleId] [int] NULL,[Userid] [int] NOT NULL,[Name] [varchar](100) NULL,
[RoleName] [varchar](20) NULL,[ModuleId] [int] NOT NULL,[ModuleName] [varchar](100) NULL,[Shortcode] [varchar](100) NULL,
[Parentid] [int] NULL,[ParentModuleName] [varchar](100) NULL,[Type] [varchar](100) NULL,[Flag] [bit] NULL,
[FreePaid] [varchar](10) NULL,[Level] [int] NULL,[ControllerName] [varchar](100) NULL,[ControllerId] [int] NULL,
[ActionName] [varchar](100) NULL,[ActionId] [int] NULL,[FromDate] [varchar](10) NULL,
[Todate] [varchar](10) NULL,[Reason] [varchar](max) NULL)
insert into @GetData
 EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission_sandeep @RoleName  
     
   SELECT * FROM @GetData1  
     WHERE ControllerName = @ControllerName  
     AND ActionName = @ActionName  
  
--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL  
--    DROP TABLE ##RoleWiseAssignedYN  
  
  
--DROP table #RoleWiseAssignedYN  
END  
END  
  
Commit tran  
  
End try  
  
Begin catch  
IF @@trancount > 0  
begin  
  
--SELECT @@ERROR,eRROR_MESSAGE()  
  
--SELECT 1  
Rollback tran  
end  
  
End catch  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_SD  'SB',NULL,'Advisory','SearchCompany'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB','Vishal','Advisory','SearchCompany'

--EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M WITH (NOLOCK) 
WHERE M.Userid = @UserId
AND M.Active = '1')

BEGIN

--CREATE TABLE #UserWiseAssignedYN (
--RoleId INT 
--,UserId INT
--,Name VARCHAR (100)
--,Rolename VARCHAR (20)
--,ModuleId INT
--,ModuleName VARCHAR (100)
--,ShortCode VARCHAR (100)
--,Parentid INT
--,ParentModuleName VARCHAR (100)
--,Type VARCHAR (100)
--,Flag BIT
--,Frepaid Varchar (100)
--,Level INT
--,ControllerName VARCHAR (10)
--,ControllerID INT
--,ActionName VARCHAR (100)
--,ActionId INT
--,FromDate VARCHAR (10)
--,ToDate VARCHAR (10)
--,Reason VARCHAR (2000)
--)

--INSERT INTO #UserWiseAssignedYN


	
	--IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL
	--begin
 --   DROP TABLE ##UserWiseAssignedYN
	--end
	--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
 --   DROP TABLE ##RoleWiseAssignedYN



--	EXEC [Usp_GetModuleListUserWiseAssignedYN] @UserName
EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName




	SELECT * FROM ##UserWiseAssignedYN
	WHERE ControllerName = @ControllerName
	AND ActionName = @ActionName
	
--	IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL
--	begin
--    DROP TABLE ##UserWiseAssignedYN
--	END
--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
--	begin
--    DROP TABLE ##RoleWiseAssignedYN
--	END

	END

ELSE 

BEGIN 


--CREATE TABLE #RoleWiseAssignedYN
--(
--Roleid	INT,
--ModuleId	INT,
--RoleName	VARCHAR(100),
--Parentid INT,
--ParentModuleName	VARCHAR(100),
--Type	VARCHAR(10),
--Flag BIT,
--FreePaid VARCHAR(10),
--Level INT,
--ControllerName	VARCHAR(100),
--ActionName VARCHAR(100),
--)

--INSERT INTO #RoleWiseAssignedYN

	--EXEC [Usp_GetModuleListroleWiseAssignedYN] @RoleName


		
--	IF OBJECT_ID('tempdb..##UserWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##UserWiseAssignedYN
	
--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##RoleWiseAssignedYN

--CREATE TABLE #RoleWiseAssignedYN
--(
--Roleid	INT,
--ModuleId	INT,
--RoleName	Varchar(100),
--ModuleName	Varchar(100),
--FreePaid Varchar(10),
--Flag Bit,
--Level INT,
--ControllerName	Varchar(100),
--ActionName Varchar(100),
--Active int,
--FromDate date,
--ToDate date,
--Reason varchar(200)
--)

--insert into #RoleWiseAssignedYN
--declare @abc nvarchar (max)

DECLARE @TableVariable1 as table (
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
    );

	EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_SD @RoleName,@tableVariable = @TableVariable1 output
			
			select * from @TableVariable1
			SELECT * FROM ##RoleWiseAssignedYN
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName

--IF OBJECT_ID('tempdb..##RoleWiseAssignedYN') IS NOT NULL
--    DROP TABLE ##RoleWiseAssignedYN


--DROP table #RoleWiseAssignedYN
END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin
Rollback tran
select ERROR_MESSAGE()

end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Test
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_Test]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

*/
AS
BEGIN


--return 0 

--Begin try

--Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  WITH (NOLOCK) left join UserRolePermission P WITH (NOLOCK) 
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN




begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP  WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK) 
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

IF OBJECT_ID('tempdb.dbo.#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC 

select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK) 
inner join UserRolePermission UR  WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR  WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B  WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm  WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm  WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac  WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1


IF OBJECT_ID('tempdb.dbo.#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd

select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK) 
INNER JOIN UserModuleMappingMaster UMM  WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM  WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


--if object_id('tempdb..##UserWiseAssignedYN') is not null
--		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	
declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
--Print 'AAA'
--Print @RoleName
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New_test] @RoleName



insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join (SELECT * FROM [UserModuleExclude]  WITH (NOLOCK) WHERE userid=@UserId) B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL
						--and b.userid=@UserId

-----------------------------------------------------------

END
END

--Commit tran

--End try

--Begin catch
--IF @@trancount > 0
--begin

--SELECT @@ERROR,eRROR_MESSAGE()

----SELECT 1
--Rollback tran
--end

--End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

begin tran

--delete FROM UserMaster where name ='HOET'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','ALWRAJYC','home','BusinessDashboard'
EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','AJYC','home','BusinessDashboard'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','HOET','home','BusinessDashboard'

rollback


exec Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'USER','SHAY','home','BusinessDashboard'

*/
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WITH (NOLOCK) WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R WITH (NOLOCK)
INNER JOIN RoleMaster Rm WITH (NOLOCK) ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

--select @UserName
--select @UserId

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M WITH (NOLOCK)  left join UserRolePermission P WITH (NOLOCK)
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID





Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC where ModuleName ='Business Dashboard'



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join [UserModuleExclude] B WITH (NOLOCK)
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL


-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_4444
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_4444]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

begin tran

--delete FROM UserMaster where name ='HOET'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','ALWRAJYC','home','BusinessDashboard'
EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','AJYC','home','BusinessDashboard'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','HOET','home','BusinessDashboard'

rollback

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_4444 'SB','HOET','home','BusinessDashboard'
EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_4444 'SB','AJYC','home','BusinessDashboard'
exec [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_4444] 'USER','SHAY','home','BusinessDashboard'

*/
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

--select @UserName
--select @UserId

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  left join UserRolePermission P
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN

select 'If'

--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID





Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC where ModuleName ='Business Dashboard'



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			SELECT '1',* FROM @UserWiseAssignedYN A
			left join [UserModuleExclude] B
			ON a.UserId=B.userid
			and a.ModuleId=b.ModuleId

				WHERE ControllerName = @ControllerName
				AND ActionName = @ActionName

				--and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	

			SELECT '2',* FROM @UserWiseAssignedYN
				WHERE ControllerName = @ControllerName
				AND ActionName = @ActionName
				and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	




	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT '3',a.* FROM @RoleWiseAssignedYN_New A
			left join [UserModuleExclude] B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL


-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_Bkp18July2018
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_Bkp18July2018]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

begin tran

--delete FROM UserMaster where name ='HOET'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','ALWRAJYC','home','BusinessDashboard'
EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','AJYC','home','BusinessDashboard'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','HOET','home','BusinessDashboard'

rollback


exec Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'USER','SHAY','home','BusinessDashboard'

*/
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

--select @UserName
--select @UserId

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  left join UserRolePermission P
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID





Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC where ModuleName ='Business Dashboard'



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			SELECT * FROM @UserWiseAssignedYN
				WHERE ControllerName = @ControllerName
				AND ActionName = @ActionName
				and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join [UserModuleExclude] B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL


-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_Bkp20July2018
-- --------------------------------------------------
CREATe PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_UAT_Bkp20July2018]
(
	@RoleName VARCHAR(100)=NULL,
	@UserName VARCHAR(100)=NULL,
	@ControllerName VARCHAR (100),
	@ActionName VARCHAR (100)

)
/*
EXEC [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333] 'SB',NULL,'Advisory','SearchCompany'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission] 'USER','SHAY','home','BusinessDashboard'
EXEC [Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_New333]'USER','SHAY','home','BusinessDashboard'
EXEC Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission  'SB',NULL,'Advisory','SearchCompany'

begin tran

--delete FROM UserMaster where name ='HOET'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','ALWRAJYC','home','BusinessDashboard'
EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','AJYC','home','BusinessDashboard'

EXEC [dbo].Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'SB','HOET','home','BusinessDashboard'

rollback


exec Usp_GetModuleListUserWiseAssignedParentYN_AccessPermission_nEW1111_222 'USER','SHAY','home','BusinessDashboard'

*/
AS
BEGIN

Begin try

Begin tran
Begin

DECLARE @UserId INT
--Declare @RoleName Varchar (50)

SELECT  @UserId = UserId FROM UserMaster WHERE  name = @UserName

IF (isnull(@RoleName,'') = '')
BEGIN

SELECT @RoleName = Rm.RoleName FROM UserRolePermission R
INNER JOIN RoleMaster Rm ON RM.Roleid = R.Roleid
WHERE R.Userid = @UserId

END

--select @UserName
--select @UserId

IF EXISTS (SELECT 1 FROM UserModuleMappingMaster M  left join UserRolePermission P
ON M.Userid=P.Userid
WHERE M.Userid = @UserId
and P.Roleid<>7
AND M.Active = '1')

BEGIN



--EXEC Usp_GetModuleListUserWiseAssignedYN_AccessPermission @UserName
DECLARE @UserWiseAssignedYN UserWiseAssignedYN_New

--insert @UserWiseAssignedYN
--exec [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] @UserName--,@UserWiseAssignedYN



----------------------------------------------


--Declare @UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 

--Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

--Declare @UserID INT
Declare --@Rolename Varchar(20),
@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID





Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC where ModuleName ='Business Dashboard'



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

--SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

			--SELECT * FROM @UserWiseAssignedYN
			--	WHERE ControllerName = @ControllerName
			--	AND ActionName = @ActionName
			--	and moduleid not in (select distinct moduleid from [UserModuleExclude]) --To Exclude module
	
	--select 1,* from @UserWiseAssignedYN
	
-----------------------------------------------------------------

	END

--ELSE 

BEGIN 
-----------------------------------------------------------------------------------------------------
--Select 'ELSE' 

dECLARE @RoleWiseAssignedYN RoleWiseAssignedYN_New
	--EXEC Usp_GetModuleListRoleWiseAssignedYN_AccessPermission @RoleName

	--insert @RoleWiseAssignedYN
	--exec [Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] @RoleName--,@RoleWiseAssignedYN
			
			
--Declare 	@RoleName varchar(100)--,
	--@RoleWiseAssignedYN RoleWiseAssignedYN READONLY

declare @RoleWiseAssignedYN_New RoleWiseAssignedYN_New 


--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN_AccessPermission_12jULY2018] 'admin'
--[dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'Sales'
--exec [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'CSO'

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date,
ToDate date,
Reason varchar(200)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)
--select 1
INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster

--select 2
INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName




--if object_id('tempdb..##RoleWiseAssignedYN') is not null
--		drop table ##RoleWiseAssignedYN;

insert @RoleWiseAssignedYN_New
SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName

 --INTO ##RoleWiseAssignedYN
 
  FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise

--SELECT * FROM @RoleWiseAssignedYN_New


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster



END


--select 2
	SELECT a.* FROM @RoleWiseAssignedYN_New A
			left join [UserModuleExclude] B
			ON 	A.Roleid	=B.Roleid
				and A.ModuleId	=B.ModuleId	
					WHERE ControllerName = @ControllerName
					AND ActionName = @ActionName
					--and moduleid not in (select distinct moduleid from [UserModuleExclude])   --To Exclude module
					--and Roleid not in (select distinct ROLEID from [UserModuleExclude])   --To Exclude module
			and b.ModuleId IS NULL


-----------------------------------------------------------

END
END

Commit tran

End try

Begin catch
IF @@trancount > 0
begin

SELECT @@ERROR,eRROR_MESSAGE()

--SELECT 1
Rollback tran
end

End catch


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_bkp_20180426
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_bkp_20180426]
(
	@RoleName varchar(100)=NULL,
	@UserName varchar(100)=NULL

)

--EXEC Usp_GetModuleListUserWiseAssignedParentYN  @RoleName='Hocp'
--EXEC Usp_GetModuleListUserWiseAssignedParentYN  @UserName='Hocp'
AS
BEGIN

If isnull(@RoleName,'')<>''
begin
		EXEC [Usp_GetModuleListroleWiseAssignedYN] @RoleName
END

If isnull(@UserName,'')<>''
begin
	EXEC [Usp_GetModuleListUserWiseAssignedYN] @UserName
END


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_MenuWise
-- --------------------------------------------------

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- Usp_GetModuleListUserWiseAssignedParentYN_MenuWise 'SB','BVIGDS' 
-- =============================================
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_MenuWise]
	-- Add the parameters for the stored procedure here
	@RoleName varchar(100)=NULL,
	@UserName varchar(100)=NULL

AS
BEGIN

SET NOCOUNT ON;
	
Declare @UserId int
--Declare @RoleName Varchar (50)

select  @UserId = UserId from UserMaster WITH(NOLOCK) where  name = @UserName

IF (isnull(@RoleName,'') = '')
Begin

Select @RoleName = Rm.RoleName from UserRolePermission R WITH(NOLOCK)
inner join RoleMaster Rm  WITH(NOLOCK) on RM.Roleid = R.Roleid
where R.Userid = @UserId

End

create table #mergedMenus(
	ModuleId varchar(100) null,
	ModuleName varchar(100) null,
	Parentid int null,
	Flag bit null,
	[Type] varchar(100) null,
	)

IF exists (select 1 from UserModuleMappingMaster M  WITH(NOLOCK)
where M.Userid = @UserId
and M.Active = '1')
Begin
Print 'AA'
	create table #AllMenus(
	RoleId varchar(100) null,
	Userid int null,
	Name varchar(100) null,
	RoleName varchar(20) null,
	ModuleId varchar(100) null,
	ModuleName varchar(100) null,
	Shortcode varchar(100) null,
	Parentid int null,
	ParentModuleName varchar(100) null,
	[Type] varchar(100) null,
	Flag bit null,
	FreePaid varchar(10) null,
	[Level] int null,
	ControllerName varchar(100) null,
	ControllerId int null,
	ActionName varchar(100) null,
	ActionId int null,
	FromDate varchar(10) null,
	Todate varchar(10) null,
	Reason varchar(max) null
	)

	insert into #AllMenus exec Usp_GetModuleListUserWiseAssignedParentYN NULL,@UserName 
	 
    insert into #mergedMenus select ModuleId,ModuleName,Parentid,Flag,[Type] from  #AllMenus 
	drop table #AllMenus
End

Else 

Begin 

Print 'BB'
	create table #AllMenus1(
	RoleId varchar(100) null,
	ModuleId varchar(100) null,
	RoleName varchar(20) null,
	ModuleName varchar(100) null,
	Parentid int null,
	ParentModuleName varchar(100) null,
	[Type] varchar(100) null,
	Flag bit null,
	FreePaid varchar(10) null,
	[Level] int null,
	ControllerName varchar(100) null,
	ActionName varchar(100) null,
	FromDate varchar(10) null,
	Todate varchar(10) null,
	Reason varchar(max) null
	)

	insert into #AllMenus1 exec Usp_GetModuleListUserWiseAssignedParentYN @RoleName
    insert into #mergedMenus select ModuleId,ModuleName,Parentid,Flag,[Type] from  #AllMenus1 
	drop table #AllMenus1
End


	select ModuleName,ModuleId,Parentid into #finalMenus from #mergedMenus  where [Type] = 'Menu' and Flag = 1 group by ModuleName,ModuleId,Parentid

	-- all Perent Menus
	select * from #finalMenus where Parentid = 0 order by ModuleId asc
	-- all Child Menus
	select * from #finalMenus where Parentid <> 0 order by ModuleId asc

	drop table #finalMenus
	drop table #mergedMenus
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedParentYN_MenuWise_bkp20180830_01PM
-- --------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- Usp_GetModuleListUserWiseAssignedParentYN_MenuWise 'SB','HOET' 
-- =============================================
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedParentYN_MenuWise_bkp20180830_01PM]
	-- Add the parameters for the stored procedure here
	@RoleName varchar(100)=NULL,
	@UserName varchar(100)=NULL

AS
BEGIN

SET NOCOUNT ON;
	
Declare @UserId int
--Declare @RoleName Varchar (50)

select  @UserId = UserId from UserMaster where  name = @UserName

IF (isnull(@RoleName,'') = '')
Begin

Select @RoleName = Rm.RoleName from UserRolePermission R
inner join RoleMaster Rm on RM.Roleid = R.Roleid
where R.Userid = @UserId

End

create table #mergedMenus(
	ModuleId varchar(100) null,
	ModuleName varchar(100) null,
	Parentid int null,
	Flag bit null,
	[Type] varchar(100) null,
	)

IF exists (select 1 from UserModuleMappingMaster M 
where M.Userid = @UserId
and M.Active = '1')
Begin
Print 'A'
	create table #AllMenus(
	RoleId varchar(100) null,
	Userid int null,
	Name varchar(100) null,
	RoleName varchar(20) null,
	ModuleId varchar(100) null,
	ModuleName varchar(100) null,
	Shortcode varchar(100) null,
	Parentid int null,
	ParentModuleName varchar(100) null,
	[Type] varchar(100) null,
	Flag bit null,
	FreePaid varchar(10) null,
	[Level] int null,
	ControllerName varchar(100) null,
	ControllerId int null,
	ActionName varchar(100) null,
	ActionId int null,
	FromDate varchar(10) null,
	Todate varchar(10) null,
	Reason varchar(max) null
	)

	insert into #AllMenus exec Usp_GetModuleListUserWiseAssignedParentYN @RoleName,@UserName 
	 
    insert into #mergedMenus select ModuleId,ModuleName,Parentid,Flag,[Type] from  #AllMenus 
	drop table #AllMenus
End

Else 

Begin 

Print 'B'
	create table #AllMenus1(
	RoleId varchar(100) null,
	ModuleId varchar(100) null,
	RoleName varchar(20) null,
	ModuleName varchar(100) null,
	Parentid int null,
	ParentModuleName varchar(100) null,
	[Type] varchar(100) null,
	Flag bit null,
	FreePaid varchar(10) null,
	[Level] int null,
	ControllerName varchar(100) null,
	ActionName varchar(100) null,
	FromDate varchar(10) null,
	Todate varchar(10) null,
	Reason varchar(max) null
	)

	insert into #AllMenus1 exec Usp_GetModuleListUserWiseAssignedParentYN @RoleName,@UserName
    insert into #mergedMenus select ModuleId,ModuleName,Parentid,Flag,[Type] from  #AllMenus1 
	drop table #AllMenus1
End


	select ModuleName,ModuleId,Parentid into #finalMenus from #mergedMenus  where [Type] = 'Menu' and Flag = 1 group by ModuleName,ModuleId,Parentid

	-- all Perent Menus
	select * from #finalMenus where Parentid = 0 order by ModuleId asc
	-- all Child Menus
	select * from #finalMenus where Parentid <> 0 order by ModuleId asc

	drop table #finalMenus
	drop table #mergedMenus
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN
-- --------------------------------------------------
CREATE procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN]
(
--Declare 
	@UserName varchar(100)='ET'
)
AS


--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'ET'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 


/*
If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'

If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END
*/

Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,Case when MR.Active = 0 then UMM.Active else MR.Active end as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId --and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1  or UMM.active = 1)



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 
and ModuleId not in (185,186)

select * from #abc

DROP table #ABC
DROP table #ABCD


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_19Apr2018
-- --------------------------------------------------
Create PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedYN_19Apr2018]
(
	@UserName varchar(100)
)
AS
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'Yogesh'




begin

Declare @UserID INT
Declare @Rolename Varchar(20)

select  @UserID = userid from UserMaster where Name = @UserName

Select @Rolename=RM.Rolename from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 


select UM.Userid,UM.Name,@Rolename Rolename,MM.ModuleId,MM.ModuleName,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,1 as flag,MM.FreePaid,MM.Level from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where name = @UserName
and UMM.Active=1

UNION

select UM.Userid,UM.Name,@Rolename Rolename,MM.ModuleId,MM.ModuleName,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,1 as flag,MM.FreePaid,MM.Level from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where name  = @UserName
and MRM.Active=1

UNION


--Select * from (
select @UserID as UserId,@UserName as Name,@Rolename Rolename,MMM.ModuleId,MMM.ModuleName,MMM.Parentid,B.ModuleName as ParentModuleName,MMM.Type,0 as flag,MMM.FreePaid,MMM.Level  
from ModuleMaster MMM
--left join UserMaster UM on UM.Userid = MMM.ModuleId
LEFT JOIN ModuleMaster B ON MMM.Parentid=B.ModuleId
--where UM.Name = 'yogesh'

where not exists (select MM.ModuleName from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)

and NOT exists (select MM.ModuleName from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)
--) OtherModule
--where ModuleName <> ParentModuleName





END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_AccessPermission
-- --------------------------------------------------
--Declare 	@UserName varchar(100)
CREATE procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN_AccessPermission]
(
--Declare 
	@UserName varchar(100)='ET'
)
AS

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

select * INTO ##UserWiseAssignedYN from #abc

DROP table #ABC
DROP table #ABCD


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018
-- --------------------------------------------------
CREATE procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018]
(
--Declare 
	@UserName varchar(100)='ET'
	--,
	--@UserWiseAssignedYN UserWiseAssignedYN READONLY 
)
AS

Declare @UserWiseAssignedYN UserWiseAssignedYN_New 

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission_12jULY2018] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

insert @UserWiseAssignedYN 
select * from #abc

SELECT * FROM @UserWiseAssignedYN

--SELECT * FROM ##UserWiseAssignedYN


DROP table #ABC
DROP table #ABCD


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_AccessPermission_bkp22Jun2018
-- --------------------------------------------------

--Declare 	@UserName varchar(100)
CREATE procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN_AccessPermission_bkp22Jun2018]
(
--Declare 
	@UserName varchar(100)='ET'
)
AS

--EXEC [Usp_GetModuleListRoleWiseAssignedYN] 'Admin'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),FromDate,103) as FromDate,convert(varchar (10),Todate,103) as Todate,Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


if object_id('tempdb..##UserWiseAssignedYN') is not null
		drop table ##UserWiseAssignedYN;

select * INTO ##UserWiseAssignedYN from #abc

DROP table #ABC
DROP table #ABCD


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_AccessPermission_New
-- --------------------------------------------------
CREATE procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN_AccessPermission_New]
(
--Declare 
	@UserName varchar(100)='ET'
)
AS

--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission] 'ET'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 



If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId 
--and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1 or UMM.Active = 1)
--and UMM.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 


select * from  #abc

--if object_id('tempdb..#UserWiseAssignedYN') is not null
--		drop table #UserWiseAssignedYN;

--select * INTO #UserWiseAssignedYN from #abc

DROP table #ABC
DROP table #ABCD


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_AccessPermission_Sandeep
-- --------------------------------------------------
--Usp_GetModuleListUserWiseAssignedYN_AccessPermission_Sandeep 'et'  
CREATE procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN_AccessPermission_Sandeep]  
(  
--Declare   
 @UserName varchar(100)='ET'
 
)  
AS  
  
--EXEC [Usp_GetModuleListUserWiseAssignedYN_AccessPermission] 'ET'  
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'et'  
  
  
--Select @UserName='Hocp'  
  
  
--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'  
  
  
begin  
  
Declare @UserID INT  
Declare @Rolename Varchar(20),@RoleID int  
,@ParentId INT   
  
select  @UserID = userid from UserMaster where Name = @UserName  
  
--SELECT  @UserID   
  
  
  
If @UserID  iS NULL  
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'  
  
  
  
--select @UserID  
  
  
  
If not exists(select * from UserMaster with(nolock) where userid=@UserID)  
 begin   
 Set IDENTITY_INSERT UserMaster on  
  
insert into UserMaster (USERID,Name, password, Active, createDate, CreateBy, UpdateDate, UpdateBy)  
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'  
  
  
END  
  
  
Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId    
from UserRolePermission URP inner join RoleMaster RM  
ON URP.Roleid=RM.Roleid  
where URP.Userid=@UserID   
  
--select @Rolename  
  
  
  
select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level    
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,case when MR.Active = 0 then UMM.Active else MR.Active END as Flag,MM.FreePaid,MM.Level  
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason  
INTO #ABC  
from UserMaster UM  with(nolock)
inner join UserRolePermission UR with(nolock) on UR.Userid = UM.Userid  
INNER JOIN ModuleRoleMapping MR with(nolock) on MR.Roleid = UR.Roleid  
INNER JOIN ModuleMaster MM with(nolock) on MM.ModuleId = MR.ModuleID  
left JOIN ModuleMaster B with(nolock) ON MM.Parentid=B.ModuleId  
left join ModuleMappingMaster mmm with(nolock) on mmm.ModuleId=MM.ModuleId  
left join ControllerMaster cm with(nolock) on mmm.ControllerId=cm.ControllerId  
left join ActionMaster ac with(nolock) on mmm.ActionId=ac.ActionId  
left join UserModuleMappingMaster UMM with(nolock) on UMM.ModuleId = MM.ModuleId   
--and UMM.FreePaid = 'Paid'   
and UMM.Userid = UM.Userid  
where UM.Userid=@UserID  
--name = @UserName  
and (MR.Active = 1 or UMM.Active = 1)  
--and UMM.Active = 1  
  
  
  
--select * from #ABC  
  
 
  
select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM with(nolock)  
INNER JOIN UserModuleMappingMaster UMM with(nolock) on UMM.Userid = UM.Userid  
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID  
where UM.Userid=@UserID  
--UM.Name = @UserName  
--and UMM.active = 0  
  
print 'Data' 
  
update a set a.flag = b.active from #ABC a  
inner join #ABCD b on a.moduleid = b.moduleid  
where B.active= 0  
  
update a set a.flag = 0 from #ABC a  
--left join #ABCD b on a.moduleid = b.moduleid  
--where b.userid is null  
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid )   
  
  
if object_id('tempdb..##UserWiseAssignedYN') is not null  
  drop table ##UserWiseAssignedYN;  
  
select * from #abc  
  
DROP table #ABC  
DROP table #ABCD  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_bkp_20180423
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedYN_bkp_20180423]
(
	@UserName varchar(100)
)
AS
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'



begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
--declare @UserName varchar(100)='HOCP'
	

select  @UserID = userid from UserMaster where Name = @UserName

Select @Rolename=RM.Rolename,@RoleID=rm.Roleid from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 


select distinct @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,1 as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,ac.ActionName 
from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=UMM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId

where name = @UserName --and ac.ActionName is not null
and UMM.Active=1 

UNION

select @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,1 as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,ac.ActionName from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId

left join ModuleMappingMaster mmm on mmm.ModuleId=MRM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId

where name  = @UserName --and ac.ActionName is not null
and MRM.Active=1

UNION


--Select * from (
select @RoleID as RoleId,@UserID as UserId,@UserName as Name,@Rolename RoleName,MMM.ModuleId,MMM.ModuleName,MMM.Parentid,B.ModuleName as ParentModuleName,MMM.Type,0 as Flag,MMM.FreePaid,MMM.Level  
,cm.ControllerName,ac.ActionName 
from ModuleMaster MMM
--left join UserMaster UM on UM.Userid = MMM.ModuleId
LEFT JOIN ModuleMaster B ON MMM.Parentid=B.ModuleId
--where UM.Name = 'yogesh'
left join ModuleMappingMaster mm on mm.ModuleId=MMM.ModuleId
left join ControllerMaster cm on mm.ControllerId=cm.ControllerId
left join ActionMaster ac on mm.ActionId=ac.ActionId

where not exists (select MM.ModuleName from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)

and NOT exists (select MM.ModuleName from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)-- and ac.ActionName is not null
--) OtherModule
--where ModuleName <> ParentModuleName



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_bkp_20180426
-- --------------------------------------------------


CREATE Procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN_bkp_20180426]
(
--Declare 	@UserName varchar(100)
@UserName varchar(100)
)
AS

--EXEC [Usp_GetModuleListRoleWiseAssignedYN] 'Admin'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'Hocp'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'



begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 
--declare @UserName varchar(100)='HOCP'
	

select  @UserID = userid from UserMaster where Name = @UserName

Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 


select distinct @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,UMM.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName ,ac.ActionId
from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=UMM.ModuleId --and UMM.Active=MMM.Active
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId

where name = @UserName --and ac.ActionName is not null
--and UMM.Active=1 

UNION

select @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MRM.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId
 from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
left JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MRM.ModuleId and UMM.Active=MRM.Active
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId

left join ModuleMappingMaster mmm on mmm.ModuleId=MRM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId

where name  = @UserName --and ac.ActionName is not null
and UMM.Active=1

UNION


--Select * from (
select @RoleID as RoleId,@UserID as UserId,@UserName as Name,@Rolename RoleName,MMM.ModuleId,MMM.ModuleName,MMM.Shortcode,MMM.Parentid,B.ModuleName as ParentModuleName,MMM.Type,0 as Flag,MMM.FreePaid,MMM.Level  
,cm.ControllerName,Cm.ControllerId,ac.ActionName ,ac.ActionId
from ModuleMaster MMM
Inner join UserRolePermission URP on URP.Userid = @UserID
--left join UserMaster UM on UM.Userid = MMM.ModuleId
LEFT JOIN ModuleMaster B ON MMM.Parentid=B.ModuleId
--where UM.Name = 'yogesh'
left join ModuleMappingMaster mm on mm.ModuleId=MMM.ModuleId
left join ControllerMaster cm on mm.ControllerId=cm.ControllerId
left join ActionMaster ac on mm.ActionId=ac.ActionId
left join ModuleRoleMapping MMM1
	ON MM.ModuleId=MMM1.ModuleId

where not exists (select MM.ModuleName from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)

and NOT exists (select MM.ModuleName from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)-- and ac.ActionName is not null
--) OtherModule
--where ModuleName <> ParentModuleName
and case when @RoleId <> 1 THEn MMM1.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM1.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_Bkp22Sept2022
-- --------------------------------------------------
CREATE  procedure [dbo].[Usp_GetModuleListUserWiseAssignedYN_Bkp22Sept2022]
(
--Declare 
	@UserName varchar(100)='ET'
)
AS


--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'ET'


--Select @UserName='Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'


begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 


/*
If @UserID  iS NULL
SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'

If not exists(select * from UserMaster  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END
*/

Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,Case when MR.Active = 0 then UMM.Active else MR.Active end as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId --and UMM.FreePaid = 'Paid' 
and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and (MR.Active = 1  or UMM.active = 1)



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

select * from #abc

DROP table #ABC
DROP table #ABCD


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_Bkp25Apr2018
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedYN_Bkp25Apr2018]
(
	@UserName varchar(100)
)
AS

--EXEC [Usp_GetModuleListRoleWiseAssignedYN] 'Admin'
--EXEC [Usp_GetModuleListUserWiseAssignedYN] 'Hocp'



--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'



begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 
--declare @UserName varchar(100)='HOCP'
	

select  @UserID = userid from UserMaster where Name = @UserName

Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 


select distinct @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,1 as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName ,ac.ActionId
from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=UMM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId

where name = @UserName --and ac.ActionName is not null
and UMM.Active=1 

UNION

select @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MRM.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId
 from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId

left join ModuleMappingMaster mmm on mmm.ModuleId=MRM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId

where name  = @UserName --and ac.ActionName is not null
--and MRM.Active=1

UNION


--Select * from (
select @RoleID as RoleId,@UserID as UserId,@UserName as Name,@Rolename RoleName,MMM.ModuleId,MMM.ModuleName,MMM.Shortcode,MMM.Parentid,B.ModuleName as ParentModuleName,MMM.Type,0 as Flag,MMM.FreePaid,MMM.Level  
,cm.ControllerName,Cm.ControllerId,ac.ActionName ,ac.ActionId
from ModuleMaster MMM
Inner join UserRolePermission URP on URP.Userid = @UserID
--left join UserMaster UM on UM.Userid = MMM.ModuleId
LEFT JOIN ModuleMaster B ON MMM.Parentid=B.ModuleId
--where UM.Name = 'yogesh'
left join ModuleMappingMaster mm on mm.ModuleId=MMM.ModuleId
left join ControllerMaster cm on mm.ControllerId=cm.ControllerId
left join ActionMaster ac on mm.ActionId=ac.ActionId
left join ModuleRoleMapping MMM1
	ON MM.ModuleId=MMM1.ModuleId

where not exists (select MM.ModuleName from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)

and NOT exists (select MM.ModuleName from UserMaster UM 
INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
where um.name = @UserName
and MMM.ModuleId = MM.ModuleId)-- and ac.ActionName is not null
--) OtherModule
--where ModuleName <> ParentModuleName
and case when @RoleId <> 1 THEn MMM1.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
and case when @RoleId <> 1 THEn MMM1.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModuleListUserWiseAssignedYN_SD
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModuleListUserWiseAssignedYN_SD]
(
	@UserName varchar(100)
)
AS
--EXEC [Usp_GetModuleListUserWiseAssignedYN_sd] 'Hocp'


--EXEC [Usp_GetModuleListUserWiseAssignedYN_19Apr2018] 'Hocp'



begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 
--declare @UserName varchar(100)='HOCP'
	

select  @UserID = userid from UserMaster where Name = @UserName

Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 


select distinct @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,1 as Flag,MM.FreePaid,MM.Level
--,cm.ControllerName,ac.ActionName 
from ModuleMaster MM
INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
INNER JOIN usermaster UM on UM.Userid = UMM.Userid
LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=UMM.ModuleId
--left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
--left join ActionMaster ac on mmm.ActionId=ac.ActionId

where name = @UserName --and ac.ActionName is not null
and UMM.Active=1 

--UNION

--select @RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,1 as Flag,MM.FreePaid,MM.Level
----,cm.ControllerName,ac.ActionName
-- from UserMaster UM 
--INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
--INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
--INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
--LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId

--left join ModuleMappingMaster mmm on mmm.ModuleId=MRM.ModuleId
----left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
----left join ActionMaster ac on mmm.ActionId=ac.ActionId

--where name  = @UserName --and ac.ActionName is not null
--and MRM.Active=1

--UNION


----Select * from (
--select @RoleID as RoleId,@UserID as UserId,@UserName as Name,@Rolename RoleName,MMM.ModuleId,MMM.ModuleName,MMM.Shortcode,MMM.Parentid,B.ModuleName as ParentModuleName,MMM.Type,0 as Flag,MMM.FreePaid,MMM.Level  
----,cm.ControllerName,ac.ActionName 
--from ModuleMaster MMM
--Inner join UserRolePermission URP on URP.Userid = @UserID
----left join UserMaster UM on UM.Userid = MMM.ModuleId
--LEFT JOIN ModuleMaster B ON MMM.Parentid=B.ModuleId
----where UM.Name = 'yogesh'
--left join ModuleMappingMaster mm on mm.ModuleId=MMM.ModuleId
----left join ControllerMaster cm on mm.ControllerId=cm.ControllerId
----left join ActionMaster ac on mm.ActionId=ac.ActionId
--left join ModuleRoleMapping MMM1
--	ON MM.ModuleId=MMM1.ModuleId
	

--where not exists (select MM.ModuleName from ModuleMaster MM
--INNER JOIN UserModuleMappingMaster UMM ON UMM.ModuleId = MM.ModuleId
--INNER JOIN usermaster UM on UM.Userid = UMM.Userid
--LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
--where um.name = @UserName
--and MMM.ModuleId = MM.ModuleId)

--and NOT exists (select MM.ModuleName from UserMaster UM 
--INNER JOIN UserRolePermission URP on URP.Userid = UM.Userid
--INNER JOIN ModuleRoleMapping MRM on MRM.Roleid = URP.Roleid
--INNER JOIN ModuleMaster MM on MM.ModuleId = MRM.ModuleID
--LEFT JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
--where um.name = @UserName
--and MMM.ModuleId = MM.ModuleId)-- and ac.ActionName is not null
----) OtherModule
----where ModuleName <> ParentModuleName
--and case when @RoleId <> 1 THEn MMM1.Roleid else 1 end = case when @RoleId <> 1 THEn @ParentId else 1 end 
--and case when @RoleId <> 1 THEn MMM1.Active else 1 end = case when @RoleId <> 1 THEn 1 else 1 end 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModulesUserNameAdmin
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModulesUserNameAdmin] (@UserName varchar(100)='ET')
as
-- EXEC Usp_GetModulesUserNameAdmin 'GDS'
Begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 

--exec Usp_GetModulesUserNameAdmin 'hoet'


If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster WITH (NOLOCK)  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

--select * from #abc


--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date
,ToDate Date
,Reason varchar (max)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 INTO #Main FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId


Select * from #abc
--Select '2',* from #Main 

--Update A set A.Flag = B.flag from  #Main A
--Inner join #abc B on A.ActionName = B.ActionName 
--and A.ModuleId  = B.ModuleId and A.Roleid = B.Roleid and A.Parentid = B.Parentid
-- where B.Flag = 1


--select RoleId,ModuleId,RoleName,ModuleName,Parentid,
--ParentModuleName,Type,Flag,FreePaid,
--Level,ControllerName,ActionName 
--  FROM #Main



--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster


DROP table #ABC
DROP table #ABCD




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModulesUserNameAdmin_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_GetModulesUserNameAdmin_New] (@UserName varchar(100)='ET')
as
-- EXEC Usp_GetModulesUserNameAdmin 'GDS'
Begin

Declare @UserID INT
Declare @Rolename Varchar(20),@RoleID int
,@ParentId INT 

select  @UserID = userid from UserMaster WITH (NOLOCK) where Name = @UserName

--SELECT  @UserID 

--exec Usp_GetModulesUserNameAdmin 'hoet'


If @UserID  iS NULL
SELECT @UserID = userid  FROM [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



If not exists(select * from UserMaster WITH (NOLOCK)  where userid=@UserID)
 begin 
 Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


END


Select @Rolename=RM.Rolename,@RoleID=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID as RoleId,UM.Userid,UM.Name,@Rolename RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC



select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

--select * from #abc


--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date
,ToDate Date
,Reason varchar (max)
)


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 INTO #Main FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId


Select * from #abc
--Select '2',* from #Main 

--Update A set A.Flag = B.flag from  #Main A
--Inner join #abc B on A.ActionName = B.ActionName 
--and A.ModuleId  = B.ModuleId and A.Roleid = B.Roleid and A.Parentid = B.Parentid
-- where B.Flag = 1


--select RoleId,ModuleId,RoleName,ModuleName,Parentid,
--ParentModuleName,Type,Flag,FreePaid,
--Level,ControllerName,ActionName 
--  FROM #Main



--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


DROP TABLE #ModuleListRoleWise
DROP TABLE #ModuleParentChildMaster


DROP table #ABC
DROP table #ABCD




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModulesUserNameForAdmin
-- --------------------------------------------------

CREATE Procedure [dbo].[Usp_GetModulesUserNameForAdmin]
(
		@UserName varchar(100)='ET'
)
as
begin 
 
--EXEC Usp_GetModulesUserNameForAdmin 'AAYJ'

Declare 
--@UserName varchar(100),
@RoleId INT,
@ParentId1 INT,
@RoleName varchar(100)
,@Userid INT


--Set @UserName ='ET'

If not exists(select * from UserMaster  where Name=@UserName)
 begin 
 --Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select userid, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName --and usertype='USER'




INSERT INTO UserRolePermission (Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
SELECT USERID,19,1,GETDATE(),'Usp_GetModulesUserNameForAdmin',null,'' 
FROM 
[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName


END



select @Userid=Userid from UserMaster WITH (NOLOCK) where name =@UserName
select @RoleId =Roleid from UserRolePermission WITH (NOLOCK) where Userid=(select Userid from UserMaster where Name=@UserName )
select @ParentId1=parentid,@RoleName=RoleName from   rolemaster WITH (NOLOCK) where  Roleid=@RoleId




--Declare @RoleName varchar(100)=@RoleName

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster WITH (NOLOCK) where rolename=@RoleName

--drop table #ModuleListRoleWise1
IF OBJECT_ID('tempdb..#ModuleListRoleWise1', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise1; 

Create table #ModuleListRoleWise1
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


--drop Table #ModuleParentChildMaster1
IF OBJECT_ID('tempdb..#ModuleParentChildMaster1', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster1; 


Create Table #ModuleParentChildMaster1
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster1
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise1
EXEC [Usp_GetModuleListRoleWise_New] @RoleName

--drop table #RoleWise
IF OBJECT_ID('tempdb..#RoleWise', 'U') IS NOT NULL
  DROP TABLE #RoleWise; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
Into #RoleWise
 FROM
 #ModuleListRoleWise1 A
left join #ModuleParentChildMaster1 B
ON A.ModuleId=B.ModuleId
--where B.Type='Menu'

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise1
--DROP TABLE #ModuleParentChildMaster1



END



--------------------------------------------------------------------------------------------------------------------------------


--Declare @UserName varchar(100)=@UserName

-- EXEC Usp_GetModulesUserNameAdmin 'GDS'
Begin

--Declare @UserID INT
Declare @Rolename1 Varchar(20),@RoleID1 int
,@ParentId INT 

--select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 

--exec Usp_GetModulesUserNameAdmin 'hoet'


--If @UserID  iS NULL
--SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



Select @Rolename1=RM.Rolename,@RoleID1=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

--drop table #ABC

IF OBJECT_ID('tempdb..#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC; 



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID1 as RoleId,UM.Userid,UM.Name,@Rolename1 RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC


--drop table #abcd
IF OBJECT_ID('tempdb..#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd; 


select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

--select * from #abc


--Declare @RoleId iNT
--,@ParentId INT

select @RoleId1=Roleid--, @ParentId=ParentId 
from RoleMaster WITH (NOLOCK) where rolename=@RoleName1

--drop table #ModuleListRoleWise

IF OBJECT_ID('tempdb..#ModuleListRoleWise', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise; 


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date
,ToDate Date
,Reason varchar (max)
)


--drop  Table #ModuleParentChildMaster
IF OBJECT_ID('tempdb..#ModuleParentChildMaster', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster; 


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName1


IF OBJECT_ID('tempdb..#Main', 'U') IS NOT NULL
  DROP TABLE #Main; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 INTO #Main FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--drop table #UserWise
IF OBJECT_ID('tempdb..#UserWise', 'U') IS NOT NULL
  DROP TABLE #UserWise; 


Select * into #UserWise from #abc
--Select '2',* from #Main 

--Update A set A.Flag = B.flag from  #Main A
--Inner join #abc B on A.ActionName = B.ActionName 
--and A.ModuleId  = B.ModuleId and A.Roleid = B.Roleid and A.Parentid = B.Parentid
-- where B.Flag = 1


--select RoleId,ModuleId,RoleName,ModuleName,Parentid,
--ParentModuleName,Type,Flag,FreePaid,
--Level,ControllerName,ActionName 
--  FROM #Main



--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise
--DROP TABLE #ModuleParentChildMaster


--DROP table #ABC
--DROP table #ABCD




END

--INSERT INTO @RoleWise 
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'User'



--INSERT INTO @UserWise 
--EXEC Usp_GetModulesUserNameAdmin 'ET'


Update #RoleWise set Flag=1


--select * from #RoleWise
--select * from #UserWise

Update A
set Flag=B.flag
from #RoleWise A
inner join #UserWise B
ON A.ModuleId=B.ModuleId
inner join [dbo].[UserModuleMappingMaster] UMM WITH (NOLOCK)
ON UMM.ModuleId=B.ModuleId
and UMM.Userid=B.Userid

Update A
set Flag=0
from #RoleWise A
inner join UserModuleExclude B WITH (NOLOCK)
ON A.ModuleId=B.ModuleId
and A.Roleid=B.roleid
and B.Userid=@Userid




select * from #RoleWise
--where Type='Menu'



END


--drop table #RoleWise
--drop table #UserWise



-----------------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModulesUserNameForAdmin_bkp_05102018
-- --------------------------------------------------

CREATE Procedure [dbo].[Usp_GetModulesUserNameForAdmin_bkp_05102018]
(
		@UserName varchar(100)='ET'
)
as
begin 
 
--EXEC Usp_GetModulesUserNameForAdmin 'AAYJ'

Declare 
--@UserName varchar(100),
@RoleId INT,
@ParentId1 INT,
@RoleName varchar(100)
,@Userid INT


--Set @UserName ='ET'

If not exists(select * from UserMaster  where Name=@UserName)
 begin 
 --Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select userid, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName --and usertype='USER'




INSERT INTO UserRolePermission (Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
SELECT USERID,19,1,GETDATE(),'Usp_GetModulesUserNameForAdmin',null,'' 
FROM 
[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName


END



select @Userid=Userid from UserMaster WITH (NOLOCK) where name =@UserName
select @RoleId =Roleid from UserRolePermission WITH (NOLOCK) where Userid=(select Userid from UserMaster where Name=@UserName )
select @ParentId1=parentid,@RoleName=RoleName from   rolemaster WITH (NOLOCK) where  Roleid=@RoleId




--Declare @RoleName varchar(100)=@RoleName

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster WITH (NOLOCK) where rolename=@RoleName

--drop table #ModuleListRoleWise1
IF OBJECT_ID('tempdb..#ModuleListRoleWise1', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise1; 

Create table #ModuleListRoleWise1
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


--drop Table #ModuleParentChildMaster1
IF OBJECT_ID('tempdb..#ModuleParentChildMaster1', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster1; 


Create Table #ModuleParentChildMaster1
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster1
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise1
EXEC [Usp_GetModuleListRoleWise_New] @RoleName

--drop table #RoleWise
IF OBJECT_ID('tempdb..#RoleWise', 'U') IS NOT NULL
  DROP TABLE #RoleWise; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
Into #RoleWise
 FROM
 #ModuleListRoleWise1 A
left join #ModuleParentChildMaster1 B
ON A.ModuleId=B.ModuleId
where B.Type='Menu'

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise1
--DROP TABLE #ModuleParentChildMaster1



END



--------------------------------------------------------------------------------------------------------------------------------


--Declare @UserName varchar(100)=@UserName

-- EXEC Usp_GetModulesUserNameAdmin 'GDS'
Begin

--Declare @UserID INT
Declare @Rolename1 Varchar(20),@RoleID1 int
,@ParentId INT 

--select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 

--exec Usp_GetModulesUserNameAdmin 'hoet'


--If @UserID  iS NULL
--SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



Select @Rolename1=RM.Rolename,@RoleID1=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

--drop table #ABC

IF OBJECT_ID('tempdb..#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC; 



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID1 as RoleId,UM.Userid,UM.Name,@Rolename1 RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC


--drop table #abcd
IF OBJECT_ID('tempdb..#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd; 


select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

--select * from #abc


--Declare @RoleId iNT
--,@ParentId INT

select @RoleId1=Roleid--, @ParentId=ParentId 
from RoleMaster WITH (NOLOCK) where rolename=@RoleName1

--drop table #ModuleListRoleWise

IF OBJECT_ID('tempdb..#ModuleListRoleWise', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise; 


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date
,ToDate Date
,Reason varchar (max)
)


--drop  Table #ModuleParentChildMaster
IF OBJECT_ID('tempdb..#ModuleParentChildMaster', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster; 


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName1


IF OBJECT_ID('tempdb..#Main', 'U') IS NOT NULL
  DROP TABLE #Main; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 INTO #Main FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--drop table #UserWise
IF OBJECT_ID('tempdb..#UserWise', 'U') IS NOT NULL
  DROP TABLE #UserWise; 


Select * into #UserWise from #abc
--Select '2',* from #Main 

--Update A set A.Flag = B.flag from  #Main A
--Inner join #abc B on A.ActionName = B.ActionName 
--and A.ModuleId  = B.ModuleId and A.Roleid = B.Roleid and A.Parentid = B.Parentid
-- where B.Flag = 1


--select RoleId,ModuleId,RoleName,ModuleName,Parentid,
--ParentModuleName,Type,Flag,FreePaid,
--Level,ControllerName,ActionName 
--  FROM #Main



--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise
--DROP TABLE #ModuleParentChildMaster


--DROP table #ABC
--DROP table #ABCD




END

--INSERT INTO @RoleWise 
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'User'



--INSERT INTO @UserWise 
--EXEC Usp_GetModulesUserNameAdmin 'ET'


Update #RoleWise set Flag=1


--select * from #RoleWise
--select * from #UserWise

Update A
set Flag=B.flag
from #RoleWise A
inner join #UserWise B
ON A.ModuleId=B.ModuleId
inner join [dbo].[UserModuleMappingMaster] UMM WITH (NOLOCK)
ON UMM.ModuleId=B.ModuleId
and UMM.Userid=B.Userid

Update A
set Flag=0
from #RoleWise A
inner join UserModuleExclude B WITH (NOLOCK)
ON A.ModuleId=B.ModuleId
and A.Roleid=B.roleid
and B.Userid=@Userid




select * from #RoleWise
where Type='Menu'



END


--drop table #RoleWise
--drop table #UserWise



-----------------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModulesUserNameForAdmin_bkp20180830_1PM
-- --------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE  Procedure [dbo].[Usp_GetModulesUserNameForAdmin_bkp20180830_1PM]
(
		@UserName varchar(100)='ET'
)
as
begin 
 
--EXEC Usp_GetModulesUserNameForAdmin 'AAYJ'

Declare 
--@UserName varchar(100),
@RoleId INT,
@ParentId1 INT,
@RoleName varchar(100)
,@Userid INT


--Set @UserName ='ET'

If not exists(select * from UserMaster  where Name=@UserName)
 begin 
 --Set IDENTITY_INSERT UserMaster on

insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
select userid, @UserName,userpassword,1,getdate(),'System','','' from [NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName --and usertype='USER'




INSERT INTO UserRolePermission (Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
SELECT USERID,19,1,GETDATE(),'Usp_GetModulesUserNameForAdmin',null,'' 
FROM 
[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName


END



select @Userid=Userid from UserMaster WITH (NOLOCK) where name =@UserName
select @RoleId =Roleid from UserRolePermission WITH (NOLOCK) where Userid=(select Userid from UserMaster where Name=@UserName )
select @ParentId1=parentid,@RoleName=RoleName from   rolemaster WITH (NOLOCK) where  Roleid=@RoleId




--Declare @RoleName varchar(100)=@RoleName

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster WITH (NOLOCK) where rolename=@RoleName

--drop table #ModuleListRoleWise1
IF OBJECT_ID('tempdb..#ModuleListRoleWise1', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise1; 

Create table #ModuleListRoleWise1
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


--drop Table #ModuleParentChildMaster1
IF OBJECT_ID('tempdb..#ModuleParentChildMaster1', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster1; 


Create Table #ModuleParentChildMaster1
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster1
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise1
EXEC [Usp_GetModuleListRoleWise_New] @RoleName

--drop table #RoleWise
IF OBJECT_ID('tempdb..#RoleWise', 'U') IS NOT NULL
  DROP TABLE #RoleWise; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
Into #RoleWise
 FROM
 #ModuleListRoleWise1 A
left join #ModuleParentChildMaster1 B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise1
--DROP TABLE #ModuleParentChildMaster1



END



--------------------------------------------------------------------------------------------------------------------------------


--Declare @UserName varchar(100)=@UserName

-- EXEC Usp_GetModulesUserNameAdmin 'GDS'
Begin

--Declare @UserID INT
Declare @Rolename1 Varchar(20),@RoleID1 int
,@ParentId INT 

--select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 

--exec Usp_GetModulesUserNameAdmin 'hoet'


--If @UserID  iS NULL
--SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



Select @Rolename1=RM.Rolename,@RoleID1=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP WITH (NOLOCK) inner join RoleMaster RM WITH (NOLOCK)
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

--drop table #ABC

IF OBJECT_ID('tempdb..#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC; 



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID1 as RoleId,UM.Userid,UM.Name,@Rolename1 RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM WITH (NOLOCK)
inner join UserRolePermission UR WITH (NOLOCK) on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR WITH (NOLOCK) on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B WITH (NOLOCK) ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm WITH (NOLOCK) on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm WITH (NOLOCK) on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac WITH (NOLOCK) on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC


--drop table #abcd
IF OBJECT_ID('tempdb..#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd; 


select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM WITH (NOLOCK)
INNER JOIN UserModuleMappingMaster UMM WITH (NOLOCK) on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM WITH (NOLOCK) on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

--select * from #abc


--Declare @RoleId iNT
--,@ParentId INT

select @RoleId1=Roleid--, @ParentId=ParentId 
from RoleMaster WITH (NOLOCK) where rolename=@RoleName1

--drop table #ModuleListRoleWise

IF OBJECT_ID('tempdb..#ModuleListRoleWise', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise; 


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date
,ToDate Date
,Reason varchar (max)
)


--drop  Table #ModuleParentChildMaster
IF OBJECT_ID('tempdb..#ModuleParentChildMaster', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster; 


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName1


IF OBJECT_ID('tempdb..#Main', 'U') IS NOT NULL
  DROP TABLE #Main; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 INTO #Main FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--drop table #UserWise
IF OBJECT_ID('tempdb..#UserWise', 'U') IS NOT NULL
  DROP TABLE #UserWise; 


Select * into #UserWise from #abc
--Select '2',* from #Main 

--Update A set A.Flag = B.flag from  #Main A
--Inner join #abc B on A.ActionName = B.ActionName 
--and A.ModuleId  = B.ModuleId and A.Roleid = B.Roleid and A.Parentid = B.Parentid
-- where B.Flag = 1


--select RoleId,ModuleId,RoleName,ModuleName,Parentid,
--ParentModuleName,Type,Flag,FreePaid,
--Level,ControllerName,ActionName 
--  FROM #Main



--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise
--DROP TABLE #ModuleParentChildMaster


--DROP table #ABC
--DROP table #ABCD




END

--INSERT INTO @RoleWise 
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'User'



--INSERT INTO @UserWise 
--EXEC Usp_GetModulesUserNameAdmin 'ET'


Update #RoleWise set Flag=1


--select * from #RoleWise
--select * from #UserWise

Update A
set Flag=B.flag
from #RoleWise A
inner join #UserWise B
ON A.ModuleId=B.ModuleId
inner join [dbo].[UserModuleMappingMaster] UMM WITH (NOLOCK)
ON UMM.ModuleId=B.ModuleId
and UMM.Userid=B.Userid

Update A
set Flag=0
from #RoleWise A
inner join UserModuleExclude B WITH (NOLOCK)
ON A.ModuleId=B.ModuleId
and A.Roleid=B.roleid
and B.Userid=@Userid




select * from #RoleWise



END


--drop table #RoleWise
--drop table #UserWise

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModulesUserNameForAdmin_Bkp20July2018
-- --------------------------------------------------

CREATE Procedure [dbo].[Usp_GetModulesUserNameForAdmin_Bkp20July2018]
(
		@UserName varchar(100)='ET'
)
as
begin 
 
--EXEC Usp_GetModulesUserNameForAdmin 'ET'

Declare 
--@UserName varchar(100),
@RoleId INT,
@ParentId1 INT,
@RoleName varchar(100)
,@Userid INT


--Set @UserName ='ET'


select @Userid=Userid from UserMaster where name =@UserName
select @RoleId =Roleid from UserRolePermission where Userid=(select Userid from UserMaster where Name=@UserName )
select @ParentId1=parentid,@RoleName=RoleName from   rolemaster where  Roleid=@RoleId





--Declare @RoleName varchar(100)=@RoleName

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName

--drop table #ModuleListRoleWise1
IF OBJECT_ID('tempdb..#ModuleListRoleWise1', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise1; 

Create table #ModuleListRoleWise1
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


--drop Table #ModuleParentChildMaster1
IF OBJECT_ID('tempdb..#ModuleParentChildMaster1', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster1; 


Create Table #ModuleParentChildMaster1
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster1
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise1
EXEC [Usp_GetModuleListRoleWise_New] @RoleName

--drop table #RoleWise
IF OBJECT_ID('tempdb..#RoleWise', 'U') IS NOT NULL
  DROP TABLE #RoleWise; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
Into #RoleWise
 FROM
 #ModuleListRoleWise1 A
left join #ModuleParentChildMaster1 B
ON A.ModuleId=B.ModuleId

--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise1
--DROP TABLE #ModuleParentChildMaster1



END



--------------------------------------------------------------------------------------------------------------------------------


--Declare @UserName varchar(100)=@UserName

-- EXEC Usp_GetModulesUserNameAdmin 'GDS'
Begin

--Declare @UserID INT
Declare @Rolename1 Varchar(20),@RoleID1 int
,@ParentId INT 

--select  @UserID = userid from UserMaster where Name = @UserName

--SELECT  @UserID 

--exec Usp_GetModulesUserNameAdmin 'hoet'


--If @UserID  iS NULL
--SELECT @UserID = userid  FROM [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'



--select @UserID



--If not exists(select * from UserMaster  where userid=@UserID)
-- begin 
-- Set IDENTITY_INSERT UserMaster on

--insert into UserMaster (USERID,Name,	password,	Active,	createDate,	CreateBy,	UpdateDate,	UpdateBy)
--select @UserID, @UserName,userpassword,1,getdate(),'System','','' from [172.31.16.95].[NXT].[dbo].[NXTSBLogin] WITH (NOLOCK) WHERE username=@UserName and usertype='USER'


--END


Select @Rolename1=RM.Rolename,@RoleID1=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

--drop table #ABC

IF OBJECT_ID('tempdb..#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC; 



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID1 as RoleId,UM.Userid,UM.Name,@Rolename1 RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC


--drop table #abcd
IF OBJECT_ID('tempdb..#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd; 


select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

--select * from #abc


--Declare @RoleId iNT
--,@ParentId INT

select @RoleId1=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName1

--drop table #ModuleListRoleWise

IF OBJECT_ID('tempdb..#ModuleListRoleWise', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise; 


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date
,ToDate Date
,Reason varchar (max)
)


--drop  Table #ModuleParentChildMaster
IF OBJECT_ID('tempdb..#ModuleParentChildMaster', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster; 


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName1


IF OBJECT_ID('tempdb..#Main', 'U') IS NOT NULL
  DROP TABLE #Main; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 INTO #Main FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--drop table #UserWise
IF OBJECT_ID('tempdb..#UserWise', 'U') IS NOT NULL
  DROP TABLE #UserWise; 


Select * into #UserWise from #abc
--Select '2',* from #Main 

--Update A set A.Flag = B.flag from  #Main A
--Inner join #abc B on A.ActionName = B.ActionName 
--and A.ModuleId  = B.ModuleId and A.Roleid = B.Roleid and A.Parentid = B.Parentid
-- where B.Flag = 1


--select RoleId,ModuleId,RoleName,ModuleName,Parentid,
--ParentModuleName,Type,Flag,FreePaid,
--Level,ControllerName,ActionName 
--  FROM #Main



--select * from #ModuleParentChildMaster --order by ParentModuleName
--select * from #ModuleListRoleWise


--DROP TABLE #ModuleListRoleWise
--DROP TABLE #ModuleParentChildMaster


--DROP table #ABC
--DROP table #ABCD




END

--INSERT INTO @RoleWise 
--EXEC [dbo].[Usp_GetModuleListRoleWiseAssignedYN] 'User'



--INSERT INTO @UserWise 
--EXEC Usp_GetModulesUserNameAdmin 'ET'


Update #RoleWise set Flag=1


--select * from #RoleWise
--select * from #UserWise

--Update A
--set Flag=B.flag
--from #RoleWise A
--inner join #UserWise B
--ON A.ModuleId=B.ModuleId
--inner join [dbo].[UserModuleMappingMaster] UMM
--ON UMM.ModuleId=B.ModuleId
--and UMM.Userid=B.Userid

Update A
set Flag=0
from #RoleWise A
inner join UserModuleExclude B
ON A.ModuleId=B.ModuleId
and A.Roleid=B.roleid
--and B.Userid=@Userid




select * from #RoleWise



END


--drop table #RoleWise
--drop table #UserWise

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetModulesUserNameForAdmin_Test
-- --------------------------------------------------

Create Procedure [dbo].[Usp_GetModulesUserNameForAdmin_Test]
(
		@UserName varchar(100)='ET'
)
as
begin 
 
--EXEC Usp_GetModulesUserNameForAdmin_Final 'Aagi'

Declare 
--@UserName varchar(100),
@RoleId INT,
@ParentId1 INT,
@RoleName varchar(100)
,@Userid INT


--Set @UserName ='ET'


select @Userid=Userid from UserMaster where name =@UserName
select @RoleId =Roleid from UserRolePermission where Userid=(select Userid from UserMaster where Name=@UserName )
select @ParentId1=parentid,@RoleName=RoleName from   rolemaster where  Roleid=@RoleId





--Declare @RoleName varchar(100)=@RoleName

BEGIN

--Declare @RoleId iNT
--,@ParentId INT

select @RoleId=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName

--drop table #ModuleListRoleWise1
IF OBJECT_ID('tempdb..#ModuleListRoleWise1', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise1; 

Create table #ModuleListRoleWise1
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date ,
ToDate date ,
Reason varchar (max)
)


--drop Table #ModuleParentChildMaster1
IF OBJECT_ID('tempdb..#ModuleParentChildMaster1', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster1; 


Create Table #ModuleParentChildMaster1
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster1
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise1
EXEC [Usp_GetModuleListRoleWise_New] @RoleName

--drop table #RoleWise
IF OBJECT_ID('tempdb..#RoleWise', 'U') IS NOT NULL
  DROP TABLE #RoleWise; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
	,convert (nvarchar (10),A.FromDate,103) as FromDate
	,convert (nvarchar (10),A.ToDate,103) as ToDate
	,A.Reason
Into #RoleWise
 FROM
 #ModuleListRoleWise1 A
left join #ModuleParentChildMaster1 B
ON A.ModuleId=B.ModuleId


END



--------------------------------------------------------------------------------------------------------------------------------


Begin

--Declare @UserID INT
Declare @Rolename1 Varchar(20),@RoleID1 int
,@ParentId INT 


Select @Rolename1=RM.Rolename,@RoleID1=rm.Roleid ,@ParentId = ParentId  
from UserRolePermission URP inner join RoleMaster RM
ON URP.Roleid=RM.Roleid
where URP.Userid=@UserID 

--select @Rolename

--drop table #ABC

IF OBJECT_ID('tempdb..#ABC', 'U') IS NOT NULL
  DROP TABLE #ABC; 



select Distinct --Ur.Roleid,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level  
@RoleID1 as RoleId,UM.Userid,UM.Name,@Rolename1 RoleName,MM.ModuleId,MM.ModuleName,MM.Shortcode,MM.Parentid,B.ModuleName as ParentModuleName,MM.Type,MR.Active as Flag,MM.FreePaid,MM.Level
,cm.ControllerName,Cm.ControllerId,ac.ActionName,ac.ActionId,convert(varchar (10),MR.FromDate,103) as FromDate,convert(varchar (10),MR.Todate,103) as Todate,MR.Reason
INTO #ABC
from UserMaster UM
inner join UserRolePermission UR on UR.Userid = UM.Userid
INNER JOIN ModuleRoleMapping MR on MR.Roleid = UR.Roleid
INNER JOIN ModuleMaster MM on MM.ModuleId = MR.ModuleID
left JOIN ModuleMaster B ON MM.Parentid=B.ModuleId
left join ModuleMappingMaster mmm on mmm.ModuleId=MM.ModuleId
left join ControllerMaster cm on mmm.ControllerId=cm.ControllerId
left join ActionMaster ac on mmm.ActionId=ac.ActionId
left join UserModuleMappingMaster UMM on UMM.ModuleId = MM.ModuleId and UMM.FreePaid = 'Paid' and UMM.Userid = UM.Userid
where UM.Userid=@UserID
--name = @UserName
and MR.Active = 1



--select * from #ABC


--drop table #abcd
IF OBJECT_ID('tempdb..#abcd', 'U') IS NOT NULL
  DROP TABLE #abcd; 


select UM.Userid,UMM.ModuleId,MM.ModuleName,UMM.Active,FromDate,Todate INTO #abcd from UserMaster UM
INNER JOIN UserModuleMappingMaster UMM on UMM.Userid = UM.Userid
INNER JOIN ModuleMaster MM on MM.ModuleId = UMM.ModuleID
where UM.Userid=@UserID
--UM.Name = @UserName
--and UMM.active = 0


update a set a.flag = b.active from #ABC a
inner join #ABCD b on a.moduleid = b.moduleid
where B.active= 0

update a set a.flag = 0 from #ABC a
--left join #ABCD b on a.moduleid = b.moduleid
--where b.userid is null
where not exists (select 1 from #ABCD b where a.moduleid = b.moduleid ) 

--select * from #abc

select @RoleId1=Roleid--, @ParentId=ParentId 
from RoleMaster where rolename=@RoleName1

--drop table #ModuleListRoleWise

IF OBJECT_ID('tempdb..#ModuleListRoleWise', 'U') IS NOT NULL
  DROP TABLE #ModuleListRoleWise; 


Create table #ModuleListRoleWise
(
Roleid	INT,
ModuleId	INT,
RoleName	Varchar(100),
ModuleName	Varchar(100),
FreePaid Varchar(10),
Flag Bit,
Level INT,
ControllerName	Varchar(100),
ActionName Varchar(100),
Active int,
FromDate date
,ToDate Date
,Reason varchar (max)
)


--drop  Table #ModuleParentChildMaster
IF OBJECT_ID('tempdb..#ModuleParentChildMaster', 'U') IS NOT NULL
  DROP TABLE #ModuleParentChildMaster; 


Create Table #ModuleParentChildMaster
(

	ModuleId	INT ,
	ModuleName	VARCHAR(100),
	ParentModuleName	VARCHAR(100),
	Type	VARCHAR(10),
	Parentid INT



)

INSERT INTO #ModuleParentChildMaster
EXEC usp_ModuleParentChildMaster


INSERT INTO #ModuleListRoleWise
EXEC [Usp_GetModuleListRoleWise_New] @RoleName1


IF OBJECT_ID('tempdb..#Main', 'U') IS NOT NULL
  DROP TABLE #Main; 


SELECT DISTINCT 
	A.Roleid	
	,A.ModuleId	
	,A.RoleName	
	,A.ModuleName	
	,B.Parentid
	,B.ParentModuleName	
	,B.Type	
	,A.Flag
	,A.FreePaid
	,A.Level
	,A.ControllerName
	,A.ActionName
 INTO #Main FROM
 #ModuleListRoleWise A
left join #ModuleParentChildMaster B
ON A.ModuleId=B.ModuleId

--drop table #UserWise
IF OBJECT_ID('tempdb..#UserWise', 'U') IS NOT NULL
  DROP TABLE #UserWise; 


Select * into #UserWise from #abc
--Select '2',* from #Main 





END


Update #RoleWise set Flag=1


Update A
set Flag=B.flag
from #RoleWise A
inner join #UserWise B
ON A.ModuleId=B.ModuleId
inner join [dbo].[UserModuleMappingMaster] UMM
ON UMM.ModuleId=B.ModuleId
and UMM.Userid=B.Userid

Update A
set Flag=0
from #RoleWise A
inner join UserModuleExclude B
ON A.ModuleId=B.ModuleId
and A.Roleid=B.roleid
--and B.Userid=@Userid




select * from #RoleWise



END


--drop table #RoleWise
--drop table #UserWise

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetNodeType
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_GetNodeType]
AS
BEGIN
SET NOCOUNT ON
		--SELECT 'Root' NodeType
		--UNION
		--SELECT 'Node'
		--UNION
		--SELECT 'Leaf'
		SELECT 'Parent' NodeType
		UNION
		SELECT 'Child'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetNXTException
-- --------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--EXEC drop proc Get_NXTException 'abc'

CREATE PROCEDURE [dbo].[USP_GetNXTException]
--(
 --@GUID	varchar	(200)

--)

AS
BEGIN 

SET NOCOUNT ON

SELECT GUID,ModuleName,Stage,Exception,CreatedBy,CreatedOn
	 FROM NXTException WITH (NOLOCK)
--WHERE GUID = @GUID
ORDER BY CreatedOn DESC

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getParentChildRole
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[usp_getParentChildRole]
--(
--@RoleName Varchar(100)
--)
AS
BEGIN

	WITH Hierarchy(Roleid, RoleName, ParentId)--, ParentName)
	AS
	(
		SELECT 
			Roleid,RoleName,ParentId--,'' ParentName
		 FROM RoleMaster WITH (NOLOCK)
		  WHERE ParentId =0    
		UNION ALL
		SELECT 
			NextGeneration.Roleid,NextGeneration.RoleName,NextGeneration.ParentId--,NextGeneration.RoleName ParentName 
		FROM RoleMaster AS NextGeneration WITH (NOLOCK)
		INNER JOIN Hierarchy AS Parent 
		ON NextGeneration.ParentId = Parent.Roleid    
	)
	SELECT A.*,B.RoleName ParentRoleName FROM Hierarchy A WITH (NOLOCK)
	INNER JOIN RoleMaster B WITH (NOLOCK)
	ON a.ParentId=b.Roleid
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetRoleList
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[Usp_GetRoleList]
AS
BEGIN

	;WITH GetRoleList AS
	(
	SELECT Roleid,RoleName,ParentId,NodeType from RoleMaster WITH (NOLOCK)
	--WHERE RoleName = 'Service'
	UNION ALL
	SELECT C.ParentID,R.RoleName,R.ParentId,R.NodeType FROM RoleMaster R WITH (NOLOCK)
	INNER JOIN GetRoleList C
	ON C.ParentId=R.Roleid
	)
	select DISTINCT A.Roleid,A.RoleName,A.ParentId,B.RoleName ParentRoleName,A.NodeType from GetRoleList A WITH (NOLOCK)
	LEFT JOIN GetRoleList B
	ON A.ParentId=B.Roleid
		WHERE A.ParentId<>0

	/*
	SELECT DISTINCT RoleName FROM RoleMaster WITH (NOLOCK)
	WHERE ParentId<>0
	*/
		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GettblArnEuinMasterSubBroker
-- --------------------------------------------------



CREATE PROCEDURE  [dbo].[USP_GettblArnEuinMasterSubBroker]
(
@SubBroker Varchar (100)
)
AS

--EXEC [USP_GettblArnEuinMasterSubBroker] 'WLTH'

BEGIN 

Select 
[SB Equity Tag]
,[SB Name]
,[ARN No]
,[ARN Holder Name]
,[Validity From]
,[Validity To]
,[EUIN No]

 from tblArnEuinMaster WITH (NOLOCK)
where [SB Equity Tag] = @SubBroker
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetUserListRoleWise
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_GetUserListRoleWise]
(
	@RoleName varchar(100)
)
AS
--Usp_GetUserListRoleWise 'admin'
--Usp_GetUserListRoleWise 'Sales'
--Usp_GetUserListRoleWise 'CSO'

begin

	SELECT distinct UM.Name,RM.RoleName,RM.NodeType--,Type,FreePaid

	FROM 
		UserMaster UM WITH (NOLOCK)
		INNER JOIN UserRolePermission URP WITH (NOLOCK)
		ON URP.Userid=UM.Userid
		inner join RoleMaster RM WITH (NOLOCK)
		ON RM.Roleid=URP.roleid
		INNER JOIN ModuleRoleMapping MMM WITH (NOLOCK)
		ON RM.Roleid=MMM.Roleid
		inner join ModuleMaster MM WITH (NOLOCK)
		ON MM.ModuleId=MMM.ModuleId
	WHERE RM.RoleName=@RoleName
	 and UM.Active=1
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getUserModuleMappingMaster
-- --------------------------------------------------
Create procedure usp_getUserModuleMappingMaster
(@userid INT )
as
begin 

SELECT 
		Userid
		,ModuleId
		,FreePaid
		,FromDate
		,Todate
		,Active
		,createDate
		,CreateBy
		,UpdateDate
		,UpdateBy
FROM UserModuleMappingMaster with (nolock)
WHERE userid=@userid

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ins_upd_applicationform
-- --------------------------------------------------



/*
CREATED BY  : PRASAD KHARADE
DESCRIPTION : Updates table ApplicationForm if ApplicationNo already present else inserts record	

EXEC usp_ins_upd_applicationform  @Flag =NULL,
								  @Application_No='zZA013',
								  @InvestmentType='LUMSUM',
								  @InvestorName='Prd',
								  @Sb_Code='EMT',
								  @PAN='BOGPK9729F',
								  @LoginDate='2018-03-22',
								  @BankName='ICICI',
								  @ChequeDate='2018-03-22',			
								  @ChequeNo='123',			
								  @SchemeName='Tax',			
								  @Amount=10000				
								  			
*/


CREATE PROC [dbo].[usp_ins_upd_applicationform]
(
@Flag				varchar(100),
@Application_No		varchar(100),
@InvestmentType		varchar(10),
@Sb_Code			varchar (100),
@InvestorName		varchar (100)=NULL,
@ClientCode			varchar (100)=NULL,
@PAN				varchar(20)=NULL,
@LoginDate			datetime=NULL,
@BankName			varchar(100)=NULL,
@SIP_StartDate		datetime=NULL,
@SIP_EndtDate		datetime=NULL,	
@SIP_InstallmentAmount	decimal(18,4)=NULL,
@ChequeDate			datetime=NULL,
@ChequeNo			varchar(100)=NULL ,
@SchemeName			varchar(100) =NULL,
@Amount				decimal(18,4)=NULL,
@NoOfInstallments	INT=NULL,
@FormImage			VARBINARY(MAX)=NULL
)
AS
BEGIN

SET NOCOUNT ON


IF (@Flag = 'Update')
BEGIN

		UPDATE ApplicationForm
		SET [InvestmentType]	=@InvestmentType,
			[InvestorName]		=@InvestorName	,
			[ClientCode]		=@ClientCode		,
			[Sb_Code]			=@Sb_Code	,
			[PAN]				=@PAN			,
			[LoginDate]			=@LoginDate		,
			[BankName]			=@BankName		,
			[SIP_StartDate]		=@SIP_StartDate	,
			[SIP_EndtDate]		=@SIP_EndtDate	,
			[InstallmentAmount]	=@SIP_InstallmentAmount,
			[ChequeDate]		=@ChequeDate	,
			[ChequeNo]			=@ChequeNo		,
			[SchemeName]		=@SchemeName	,
			[Amount]			=@Amount		,
			[FormImage]			=@FormImage		,		
			[InsertedDate]		=GETDATE()
		WHERE [ApplicationNo] = @Application_No
	
		SELECT 'Record updated successfully' as Msg			
END
ELSE IF (@Flag = 'Insert')
	
		IF (SELECT count(1) from ApplicationForm where ApplicationNo=@Application_No) > 0 
		
		SELECT 'Application already present' as Msg
		
	
		ELSE
		BEGIN
		INSERT INTO ApplicationForm ([ApplicationNo],[InvestmentType],[InvestorName],[ClientCode],[Sb_Code],[PAN],
									 [LoginDate],[BankName],[SIP_StartDate],[SIP_EndtDate],		
									 [InstallmentAmount],[ChequeDate],[ChequeNo],[SchemeName],
									 [Amount],[NoOfInstallments],[FormImage],[InsertedDate])
		VALUES(@Application_No,@InvestmentType,@InvestorName,@ClientCode,@Sb_Code,@PAN,@LoginDate,		
				@BankName,@SIP_StartDate,@SIP_EndtDate,@SIP_InstallmentAmount,@ChequeDate,
				@ChequeNo,@SchemeName,@Amount,@NoOfInstallments,@FormImage,GETDATE())
		SELECT 'Record inserted successfully' as Msg
		END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ins_upd_applicationform_V1
-- --------------------------------------------------





/*
CREATED BY  : PRASAD KHARADE
DESCRIPTION : Updates table ApplicationForm if ApplicationNo already present else inserts record	

EXEC usp_ins_upd_applicationform_V1  @Flag ='update',
								  @Application_No='Sanand',
								  @InvestmentType='LUMSUM',
								  @InvestorName='Prd',
								  @Sb_Code='EMT',
								  @PAN='BOGPK9729F',
								  @LoginDate='22/05/2018',
								  @BankName='ICICI',
								  @ChequeDate='22/05/2018',			
								  @ChequeNo='123',			
								  @SchemeName='Tax',			
								  @Amount=10000				
								  			
*/


CREATE PROC [dbo].[usp_ins_upd_applicationform_V1]
(
@Flag				varchar(100),
@Application_No		varchar(100),
@InvestmentType		varchar(10),
@Sb_Code			varchar (100),
@InvestorName		varchar (100)=NULL,   
@ClientCode			varchar (100)=NULL,
@PAN				varchar(20)=NULL,
@LoginDate			varchar(20)=NULL,
@BankName			varchar(100)=NULL,
@SIP_StartDate		datetime=NULL,
@SIP_EndtDate		datetime=NULL,	
@SIP_InstallmentAmount	decimal(18,4)=NULL,
@ChequeDate			varchar(20)=NULL,
@ChequeNo			varchar(100)=NULL ,
@SchemeName			varchar(100) =NULL,
@Amount				decimal(18,4)=NULL,
@NoOfInstallments	INT=NULL,
@FormImage			VARBINARY(MAX)=NULL
)
AS
BEGIN

SET NOCOUNT ON


IF (@Flag = 'Update')
BEGIN

		UPDATE ApplicationForm
		SET [InvestmentType]	=@InvestmentType,
			[InvestorName]		=@InvestorName	,
			[ClientCode]		=@ClientCode		,
			[Sb_Code]			=@Sb_Code	,
			[PAN]				=@PAN			,
			[LoginDate]			=convert(date,cast(@LoginDate as varchar(20)),103)		,
			[BankName]			=@BankName		,
			[SIP_StartDate]		=@SIP_StartDate	,
			[SIP_EndtDate]		=@SIP_EndtDate	,
			[InstallmentAmount]	=@SIP_InstallmentAmount,
			[ChequeDate]		=convert(date,cast(@ChequeDate as varchar(20)),103)	,
			[ChequeNo]			=@ChequeNo		,
			[SchemeName]		=@SchemeName	,
			[Amount]			=@Amount		,
			[FormImage]			=@FormImage		,		
			[InsertedDate]		=GETDATE()		,
			[NoOfInstallments] = @NoOfInstallments
		WHERE [ApplicationNo] = @Application_No
	
		SELECT 'Record updated successfully' as Msg			
END
ELSE IF (@Flag = 'Insert')
	
		IF (SELECT count(1) from ApplicationForm where ApplicationNo=@Application_No) > 0 
		
		SELECT 'Application already present' as Msg
		
	
		ELSE
		BEGIN
		INSERT INTO ApplicationForm ([ApplicationNo],[InvestmentType],[InvestorName],[ClientCode],[Sb_Code],[PAN],
									 [LoginDate],[BankName],[SIP_StartDate],[SIP_EndtDate],		
									 [InstallmentAmount],[ChequeDate],[ChequeNo],[SchemeName],
									 [Amount],[NoOfInstallments],[FormImage],[InsertedDate])
		VALUES(@Application_No,@InvestmentType,@InvestorName,@ClientCode,@Sb_Code,@PAN,convert(date,cast(@LoginDate as varchar(20)),103),		
				@BankName,@SIP_StartDate,@SIP_EndtDate,@SIP_InstallmentAmount,convert(date,cast(@ChequeDate as varchar(20)),103),
				@ChequeNo,@SchemeName,@Amount,@NoOfInstallments,@FormImage,GETDATE())
		SELECT 'Record inserted successfully' as Msg
		END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Ins_UserRolePermission
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_Ins_UserRolePermission]
(
		@Userid		VARCHAR(100),
		@Roleid		VARCHAR(100),
		@ProjectId  VARCHAR(100),
		@createDate DATETIME,
		@CreateBy	VARCHAR(100),
		@UpdateDate DATETIME,
		@UpdateBy	VARCHAR(100)
)
AS
BEGIN


IF EXISTS (SELECT * FROM UserRolePermission WHERE Userid = @Userid)
BEGIN 	
	UPDATE UserRolePermission 
	SET 
		Roleid=@Roleid,
		ProjectId=@ProjectId,
		UpdateDate=@UpdateDate,
		UpdateBy=@UpdateBy
		WHERE Userid=@Userid
END
ELSE
BEGIN
	INSERT INTO UserRolePermission (Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
	SELECT @Userid,@Roleid,@ProjectId,GETDATE(),@CreateBy,@UpdateDate,@UpdateBy
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IPartnerAdmin_AuthenticateUser
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_IPartnerAdmin_AuthenticateUser]
@username varchar(100),
@password varchar(100),
@usertype varchar(50)
as
declare @userid int
declare @roleid int
BEGIN
--EXEC [USP_IPartnerAdmin_AuthenticateUser] 'Yogesh','Yogesh'

    IF not EXISTS(select * from UserMaster WITH (NOLOCK) where Name=@username and password=@password)
	 BEGIN

		--select @userid=userid from Nxt.dbo.NXTSBLogin with(nolock) where username=@username and userpassword=@password
		-- changed on 22/11/2018 by Vivek for admin panel anthentication..

		select @userid=userid from [196.1.115.132].rolemgm.dbo.user_login with(nolock) where username=@username and userpassword=@password

	   insert into UserMaster(Userid,Name,password,Active,createDate,CreateBy)

	   values(@userid,@username,@password,1,GETDATE(),'System')
	  

	   select @roleid=RoleMaster.Roleid from RoleMaster WITH (NOLOCK) where RoleName=@usertype
	   
	   insert into UserRolePermission(Userid,Roleid,ProjectId,createDate,CreateBy)
	   values(@userid,@roleid,1,GETDATE(),'System')
	   
	 END

	 SELECT UM.*,RM.RoleName,RM.Roleid FROM UserMaster UM WITH (NOLOCK)
	   inner join UserRolePermission URP WITH (NOLOCK)
	   ON UM.Userid =URP.Userid
	   inner join RoleMaster RM WITH (NOLOCK)
	   ON RM.Roleid=URP.Roleid
	   WHERE Name = @username and password = @password;

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IPartnerAdmin_AuthenticateUser_1June18
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_IPartnerAdmin_AuthenticateUser]
@username varchar(100),
@password varchar(100)
as
BEGIN
--EXEC [USP_IPartnerAdmin_AuthenticateUser] 'Yogesh','Yogesh'


	SELECT UM.*,RM.RoleName,RM.Roleid FROM UserMaster UM
	inner join UserRolePermission URP
	ON UM.Userid =URP.Userid
	inner join RoleMaster RM
	ON RM.Roleid=URP.Roleid
	WHERE Name = @username and password = @password;
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IPartnerAdmin_AuthenticateUser_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_IPartnerAdmin_AuthenticateUser_New]

@username varchar(100),

@password varchar(100),

@usertype varchar(50)

as

declare @userid int

declare @roleid int

BEGIN

--EXEC [USP_IPartnerAdmin_AuthenticateUser] 'Yogesh','Yogesh'



    IF not EXISTS(select * from UserMaster WITH (NOLOCK) where Name=@username and password=@password)

	 BEGIN


	  select @userid=userid from Nxt.dbo.NXTSBLogin with(nolock) where username=@username and userpassword=@password

	   insert into UserMaster(Userid,Name,password,Active,createDate,CreateBy)

	   values(@userid,@username,@password,1,GETDATE(),'System')

	    



	   select @roleid=RoleMaster.Roleid from RoleMaster WITH (NOLOCK) where RoleName=@usertype

	   

	   insert into UserRolePermission(Userid,Roleid,ProjectId,createDate,CreateBy)

	   values(@userid,@roleid,1,GETDATE(),'System')

	   

	 END



	 SELECT UM.*,RM.RoleName,RM.Roleid FROM UserMaster UM WITH (NOLOCK)

	   inner join UserRolePermission URP WITH (NOLOCK)

	   ON UM.Userid =URP.Userid

	   inner join RoleMaster RM WITH (NOLOCK)

	   ON RM.Roleid=URP.Roleid

	   WHERE Name = @username and password = @password;



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MF_AUMClientWise
-- --------------------------------------------------

CREATE Procedure [dbo].[USP_MF_AUMClientWise]
(
	@party_Code varchar(100)
)
as
begin 

--USP_MF_AUMClientWise 'RP61'

--Declare @party_Code varchar(100)='RP61'
Declare @long_name varchar(100)


CREATE TABLE #temp
(
	SchemeClassDescription VARCHAR(100)
)

INSERT INTO #temp
select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
--select SchemeClassDescription 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
--UNION
--select SchemeSubClassDescription  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')


 select @long_name=long_name
 from sb_client_details SB WITH (NOLOCK)
where party_code=@party_Code 


 SELECT SB.party_Code,T.SchemeClassDescription,sum(Angel_Qty*LastNAVPrice) 'Total' 
 INTO #final1
 from 
  IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB with (nolock)
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(
		select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
and SB.party_Code =@party_Code 
group by SB.party_Code,SB.long_name,T.SchemeClassDescription
	

	
Select 	SchemeClassDescription ,party_Code,@long_name long_name,Sum(OtherTotal)  OtherAUM,0 Total
 INTO #final
from 
(
 SELECT SB.party_Code,'Other' SchemeClassDescription ,(Angel_Qty*LastNAVPrice) 'OtherTotal' 

 from 
  IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB with (nolock)
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	INNER JOIN 
	(
		select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription not in ('Equity','Debt','Liquid Fund')
			--select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription not in ('Equity','Debt','Liquid Fund')
			--UNION
			--select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription not IN ('ELSS','Balanced Fund')
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
and SB.party_Code =@party_Code 
) T1
group by party_Code,SchemeClassDescription
	
	
	--select * from #temp
	--select * from #final1
	
	
	
	
	
SELECT 
Case when A.SchemeClassDescription='Liquid Fund' THEN 'Liquid' ELSE A.SchemeClassDescription END SchemeClassDescription,
@party_Code party_Code,
@long_name long_name,
ISNULL(B.Total,0) 'AUM',
0 Total
Into #aa
 FROM #temp A
LEFT JOIN #final1 B
ON a.SchemeClassDescription=b.SchemeClassDescription
	UNION
SELECT * FROM #final	
	

SELECT Party_Code ,long_name, ISNULL(Equity,0) Equity,ISNULL(Debt,0) Debt, ISNULL(Balanced,0) Balanced,ISNULL(ELSS,0) ELSS,ISNULL(Liquid,0) Liquid,ISNULL(Others,0)  Others,
ISNULL(Equity,0)+ISNULL(Debt,0)+ISNULL(Balanced,0)+ISNULL(ELSS,0)+ISNULL(Liquid,0)+ISNULL(Others,0) Total
FROM (
SELECT SchemeClassDescription, party_Code,long_name, Total,AUM
FROM #aa) up
PIVOT (SUM(AUM) FOR SchemeClassDescription IN (Equity,Debt, Balanced,ELSS,Liquid, Others)) AS pvt
ORDER BY party_Code



--Select Party_Code ,long_name, SUM(Equity) Equity,SUm(Debt) Debt ,
-- Sum(ISNULL(Balanced,0)) Balanced,SUM(ELSS) ELSS,SUM(Liquid) Liquid, Sum(Others) Others 
--from #Final2
--group by Party_Code ,long_name	
	
DROP TABLE #aa
DROP TABLE #temp
drop table #final
drop table #final1

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MF_AUMClientWise_BKP_08Apr2018
-- --------------------------------------------------

CREATE Procedure [dbo].[USP_MF_AUMClientWise_BKP_08Apr2018]
(
	@party_Code varchar(100)
)
as
begin 

--USP_MF_AUMClientWise 'RP61'

--Declare @party_Code varchar(100)='RP61'
Declare @long_name varchar(100)


CREATE TABLE #temp
(
	SchemeClassDescription VARCHAR(100)
)

INSERT INTO #temp
select SchemeClassDescription 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
UNION
select SchemeSubClassDescription  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')


 select @long_name=long_name
 from sb_client_details SB
where party_code=@party_Code 


 SELECT SB.party_Code,T.SchemeClassDescription,sum(Angel_Qty*LastNAVPrice) 'Total' 
 INTO #final1
 from 
  IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	inner JOIN 
	(
			select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
			UNION
			select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
and SB.party_Code =@party_Code 
group by SB.party_Code,SB.long_name,T.SchemeClassDescription
	

	
Select 	SchemeClassDescription ,party_Code,@long_name long_name,Sum(OtherTotal)  OtherAUM,0 Total
 INTO #final
from 
(
 SELECT SB.party_Code,'Other' SchemeClassDescription ,(Angel_Qty*LastNAVPrice) 'OtherTotal' 

 from 
  IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	left JOIN 
	(
			select SchemeClassDescription,SchemeCode 	from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription not in ('Equity','Debt','Liquid Fund')
			UNION
			select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription not IN ('ELSS','Balanced Fund')
	) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
	WHERE ISNULL(HLDG.fund_code,'')<>''
and SB.party_Code =@party_Code 
) T1
group by party_Code,SchemeClassDescription
	
	
	--select * from #temp
	--select * from #final1
	
	
	
	
	
SELECT 
Case when A.SchemeClassDescription='Liquid Fund' THEN 'Liquid' ELSE A.SchemeClassDescription END SchemeClassDescription,
@party_Code party_Code,
@long_name long_name,
ISNULL(B.Total,0) 'AUM',
0 Total
Into #aa
 FROM #temp A
LEFT JOIN #final1 B
ON a.SchemeClassDescription=b.SchemeClassDescription
	UNION
SELECT * FROM #final	
	

SELECT Party_Code ,long_name, ISNULL(Equity,0) Equity,ISNULL(Debt,0) Debt, ISNULL(Balanced,0) Balanced,ISNULL(ELSS,0) ELSS,ISNULL(Liquid,0) Liquid,ISNULL(Others,0)  Others,
ISNULL(Equity,0)+ISNULL(Debt,0)+ISNULL(Balanced,0)+ISNULL(ELSS,0)+ISNULL(Liquid,0)+ISNULL(Others,0) Total
FROM (
SELECT SchemeClassDescription, party_Code,long_name, Total,AUM
FROM #aa) up
PIVOT (SUM(AUM) FOR SchemeClassDescription IN (Equity,Debt, Balanced,ELSS,Liquid, Others)) AS pvt
ORDER BY party_Code



--Select Party_Code ,long_name, SUM(Equity) Equity,SUm(Debt) Debt ,
-- Sum(ISNULL(Balanced,0)) Balanced,SUM(ELSS) ELSS,SUM(Liquid) Liquid, Sum(Others) Others 
--from #Final2
--group by Party_Code ,long_name	
	
DROP TABLE #aa
DROP TABLE #temp
drop table #final
drop table #final1

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Business_ClientwiseSchemeDetails
-- --------------------------------------------------


CREATE procedure [dbo].[usp_MF_Business_ClientwiseSchemeDetails]
(
	@FromDate Datetime,
	@ToDate Datetime,
	--@SchemeName varchar(2000),
	--@SchemeCode Nvarchar (16),
	@AgentCode varchar(100),
	@ClientCOde varchar(50)
	
)
--EXEC usp_MF_Business_SchemewiseDetails '2018-01-01','2018-04-01','14050018.012066','EMT'
--EXEC [usp_MF_Business_ClientwiseSchemeDetails] '2018-01-01','2018-04-01','EMT','A99423'

AS
BEGIN 

	Select 	SM.SchemeName,	ExistCode	, SB.sub_broker,
	SUM(Bd.PaidBrokMF) As Commission 
	INTO #Comm
	from MutualFund.dbo.TRansactiondetail TR WITH (NOLOCK)
	inner join MutualFund.dbo.schememaster SM WITH (NOLOCK) on TR.SchCode = SM.SchemeCode     
	inner join MutualFund.dbo.investormaster IM WITH (NOLOCK) on TR.InvestorCode = IM.invCode 
	Inner Join   MutualFund.dbo.BrokerageDetail Bd WITH (NOLOCK) On  TR.TranCode=Bd.TranCode  
	inner join sb_client_details SB WITH (NOLOCK) ON IM.ExistCode=SB.cl_code
	--inner join MutualFund.dbo.BillSummary BS on BS.BillNo= Bd.BillNo  
	--inner join MutualFund.dbo.BrokTypeMaster BT on Bd.BrokTypeId = bt.BrokTypeCode
	Where --BS.AgentCode=@AgentCode 
	--And 
	SB.sub_broker=@AgentCode and 
	--SM.SchemeCode=@SchemeCode and 
	IM.ExistCode = @ClientCOde and
	TR.TranDate>=CONVERT(Date,@FromDate,103) and TR.TranDate<=CONVERT(Date,@ToDate,103)
	group by ExistCode,SB.sub_broker,SM.SchemeName

--select * from #Comm

select 
			SM.SchemeName,IM.ExistCode ClientCode
		,IM.FirstHolderName ClientName
		,COUNT(*) AS TxnCount
		,SUM(ISNULL(tr.Amount,0)) AS Amount
		,SUM(Comm.Commission) Commission
		,CASE WHEN TR.SubTrxnType IS NULL THEN 'Lumpsum' ELSE 'SIP' END TrxnType

From
#Comm Comm left join MutualFund.dbo.investormaster IM  WITH (NOLOCK)   ON Comm.ExistCode=IM.ExistCode
	left join MutualFund.dbo.TRansactiondetail TR WITH (NOLOCK) on TR.InvestorCode = IM.invCode 
	inner join MutualFund.dbo.schememaster SM WITH (NOLOCK) on TR.SchCode = SM.SchemeCode     
	--inner join MutualFund.dbo.investormaster IM on TR.InvestorCode = IM.invCode 
	Inner Join   MutualFund.dbo.BrokerageDetail Bd WITH (NOLOCK) On  TR.TranCode=Bd.TranCode  
	--inner join MutualFund.dbo.BillSummary BS on BS.BillNo= Bd.BillNo  
	--inner join MutualFund.dbo.BrokTypeMaster BT on Bd.BrokTypeId = bt.BrokTypeCode
	--left join #Comm Comm ON Comm.ExistCode=IM.ExistCode
where IM.ExistCode = @ClientCOde
and TR.TranDate>=CONVERT(Date,@FromDate,103) and TR.TranDate<=CONVERT(Date,@ToDate,103)
GROUP BY IM.ExistCode ,IM.FirstHolderName,CASE WHEN TR.SubTrxnType IS NULL THEN 'Lumpsum' ELSE 'SIP' END,Comm.sub_broker,SM.SchemeName

 
Drop table #Comm


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Business_Schemewise
-- --------------------------------------------------
CREATE procedure [dbo].[usp_MF_Business_Schemewise]
(
	@FromDate Datetime,
	@ToDate Datetime,
	@AgentCode varchar(100)
)
--EXEC usp_MF_Business_Schemewise '2018-04-03','2018-05-02',@AgentCode='ajyc'

--EXEC usp_MF_Business_Schemewise @AgentCode = 'AJYC', @FromDate = '01-Dec-2017', @ToDate = '25-Apr-2018' 

AS
BEGIN 



	Select 	ExistCode	, SB.sub_broker,
	SUM(Bd.PaidBrokMF) As Commission 
	INTO #Comm
	from MutualFund.dbo.TRansactiondetail TR WITH (NOLOCK) 
	inner join MutualFund.dbo.schememaster SM WITH (NOLOCK) on TR.SchCode = SM.SchemeCode     
	inner join MutualFund.dbo.investormaster IM WITH (NOLOCK) on TR.InvestorCode = IM.invCode 
	Inner Join   MutualFund.dbo.BrokerageDetail Bd WITH (NOLOCK) On  TR.TranCode=Bd.TranCode  
	inner join sb_client_details SB WITH (NOLOCK) ON IM.ExistCode=SB.cl_code
	--inner join MutualFund.dbo.BillSummary BS on BS.BillNo= Bd.BillNo  
	--inner join MutualFund.dbo.BrokTypeMaster BT on Bd.BrokTypeId = bt.BrokTypeCode
	Where SB.sub_broker=@AgentCode 
	AND 
	--SchemeName='Reliance Banking Fund - Dividend' and 
	TR.TranDate>=CONVERT(Date,@FromDate,103) and TR.TranDate<=CONVERT(Date,@ToDate,103)
	group by ExistCode,SB.sub_broker

select		SM.SchemeName,SM.SchemeCode
			,SUM(ISNULL(tr.Amount,0)) AS Amount
			--,SUM((ISNULL(bd.PaidBrok,0))) As Commission
			,CASE WHEN sub_broker='EMT' THEN 0 ELSE  ISNULL(MAX(Commission),0) END AS Commission 
			,COUNT(*) AS TxnCount
			,sub_broker
FROM  #Comm Comm
		
left join MutualFund.dbo.investormaster IM WITH (NOLOCK)    ON Comm.ExistCode=IM.ExistCode
	left join MutualFund.dbo.TRansactiondetail TR WITH (NOLOCK) on TR.InvestorCode = IM.invCode 
	inner join MutualFund.dbo.schememaster SM WITH (NOLOCK) on TR.SchCode = SM.SchemeCode     
	--inner join MutualFund.dbo.investormaster IM on TR.InvestorCode = IM.invCode 
	Inner Join   MutualFund.dbo.BrokerageDetail Bd WITH (NOLOCK) On  TR.TranCode=Bd.TranCode  
			
WHERE 
			(tr.TranDate Between IsNull(@FromDate,tr.TranDate) And IsNull(@ToDate,tr.TranDate) )
			GROUP BY SM.SchemeName,sub_broker,SM.SchemeCode


DROP TABLE #Comm	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Business_Schemewise_bkp_20180502
-- --------------------------------------------------
CREATE procedure [dbo].[usp_MF_Business_Schemewise_bkp_20180502]
(
	@FromDate Datetime,
	@ToDate Datetime,
	@AgentCode varchar(100)
)
--EXEC usp_MF_Business_Schemewise '2018-01-01','2018-04-01',@AgentCode='EMT'

--EXEC usp_MF_Business_Schemewise @AgentCode = 'AJYC', @FromDate = '01-Dec-2017', @ToDate = '25-Apr-2018' 

AS
BEGIN 



	Select 	SM.SchemeName	,SM.SchemeCode, SB.sub_broker,
	SUM(Bd.PaidBrokMF) As Commission 
	INTO #Comm
	from MutualFund.dbo.TRansactiondetail TR 
	inner join MutualFund.dbo.schememaster SM on TR.SchCode = SM.SchemeCode     
	inner join MutualFund.dbo.investormaster IM on TR.InvestorCode = IM.invCode 
	Inner Join   MutualFund.dbo.BrokerageDetail Bd On  TR.TranCode=Bd.TranCode  
	inner join sb_client_details SB ON IM.ExistCode=SB.cl_code
	--inner join MutualFund.dbo.BillSummary BS on BS.BillNo= Bd.BillNo  
	--inner join MutualFund.dbo.BrokTypeMaster BT on Bd.BrokTypeId = bt.BrokTypeCode
	Where SB.sub_broker=@AgentCode 
	AND 
	--SchemeName='Reliance Banking Fund - Dividend' and 
	TR.TranDate>=CONVERT(Date,@FromDate,103) and TR.TranDate<=CONVERT(Date,@ToDate,103)
	group by SM.SchemeName , SB.sub_broker,SM.SchemeCode

select		SM.SchemeName,SM.SchemeCode
			,SUM(ISNULL(tr.Amount,0)) AS Amount
			--,SUM((ISNULL(bd.PaidBrok,0))) As Commission
			,CASE WHEN sub_broker='EMT' THEN 0 ELSE  ISNULL(MAX(Commission),0) END AS Commission 
			,COUNT(*) AS TxnCount
			,sub_broker
FROM  #Comm Comm
		Left join  MutualFund.dbo.SchemeMaster sm with (nolock) 
		ON Comm.SchemeName=sm.SchemeName
		Left join MutualFund.dbo.TransactionDetail tr with (nolock) 
		On tr.SchCode=sm.SchemeCode
			
WHERE 
			(tr.TranDate Between IsNull(@FromDate,tr.TranDate) And IsNull(@ToDate,tr.TranDate) )
			GROUP BY SM.SchemeName,sub_broker,SM.SchemeCode


DROP TABLE #Comm	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Business_SchemewiseDetails
-- --------------------------------------------------


CREATE procedure [dbo].[usp_MF_Business_SchemewiseDetails]
(
	@FromDate Datetime,
	@ToDate Datetime,
	--@SchemeName varchar(2000),
	@SchemeCode Nvarchar (16),
	@AgentCode varchar(100)
	
)
--EXEC usp_MF_Business_SchemewiseDetails '2018-01-01','2018-04-01','14050018.012066','ajyc'

AS
BEGIN 

	Select 	ExistCode	, SB.sub_broker,
	SUM(Bd.PaidBrokMF) As Commission 
	INTO #Comm
	from MutualFund.dbo.TRansactiondetail TR WITH (NOLOCK)
	inner join MutualFund.dbo.schememaster SM WITH (NOLOCK) on TR.SchCode = SM.SchemeCode     
	inner join MutualFund.dbo.investormaster IM WITH (NOLOCK) on TR.InvestorCode = IM.invCode 
	Inner Join   MutualFund.dbo.BrokerageDetail Bd WITH (NOLOCK) On  TR.TranCode=Bd.TranCode  
	inner join sb_client_details SB WITH (NOLOCK) ON IM.ExistCode=SB.cl_code
	--inner join MutualFund.dbo.BillSummary BS on BS.BillNo= Bd.BillNo  
	--inner join MutualFund.dbo.BrokTypeMaster BT on Bd.BrokTypeId = bt.BrokTypeCode
	Where --BS.AgentCode=@AgentCode 
	--And 
	SB.sub_broker=@AgentCode and 
	SM.SchemeCode=@SchemeCode and 
	TR.TranDate>=CONVERT(Date,@FromDate,103) and TR.TranDate<=CONVERT(Date,@ToDate,103)
	group by ExistCode,SB.sub_broker

--select * from #Comm

select 
		IM.ExistCode ClientCode
		,IM.FirstHolderName ClientName
		,COUNT(*) AS TxnCount
		,SUM(ISNULL(tr.Amount,0)) AS Amount
		,SUM(Comm.Commission) Commission
		,CASE WHEN TR.SubTrxnType IS NULL THEN 'Lumpsum' ELSE 'SIP' END TrxnType

From
#Comm Comm left join MutualFund.dbo.investormaster IM WITH (NOLOCK)    ON Comm.ExistCode=IM.ExistCode
	left join MutualFund.dbo.TRansactiondetail TR WITH (NOLOCK) on TR.InvestorCode = IM.invCode 
	inner join MutualFund.dbo.schememaster SM WITH (NOLOCK) on TR.SchCode = SM.SchemeCode     
	--inner join MutualFund.dbo.investormaster IM on TR.InvestorCode = IM.invCode 
	Inner Join   MutualFund.dbo.BrokerageDetail Bd WITH (NOLOCK) On  TR.TranCode=Bd.TranCode  
	--inner join MutualFund.dbo.BillSummary BS on BS.BillNo= Bd.BillNo  
	--inner join MutualFund.dbo.BrokTypeMaster BT on Bd.BrokTypeId = bt.BrokTypeCode
	--left join #Comm Comm ON Comm.ExistCode=IM.ExistCode
where SM.SchemeCode=@SchemeCode and
--Comm.sub_broker=@AgentCode and 
TR.TranDate>=CONVERT(Date,@FromDate,103) and TR.TranDate<=CONVERT(Date,@ToDate,103)
GROUP BY IM.ExistCode ,IM.FirstHolderName,CASE WHEN TR.SubTrxnType IS NULL THEN 'Lumpsum' ELSE 'SIP' END,Comm.sub_broker

 
Drop table #Comm


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_BusinessReport
-- --------------------------------------------------



/**************************************************************/
/*
	DATE:			04/04/2018
	AUTHOR:			Brijesh B
	DESCRIPTION:	

	EXEC dbo.usp_MF_BusinessReport 'DateWise', 'PJMA', NULL, '11-Dec-2016', '11-Dec-2017'
	EXEC dbo.usp_MF_BusinessReport 'ClientWise', 'PJMA', NULL, '11-Dec-2016', '11-Dec-2017'
	EXEC dbo.usp_MF_BusinessReport 'ClientWise', 'PJMA', 'RCN101', '11-Dec-2016', '11-Dec-2017'
	
*/	
/**************************************************************/
CREATE  PROCEDURE [dbo].[usp_MF_BusinessReport]
	@ReportType VARCHAR(10)
	,@AgentCode VARCHAR(10)
	,@PartyCode VARCHAR(10)=NULL
	,@FromDate DATETIME = NULL
	,@ToDate DATETIME = NULL
AS
BEGIN

	SET NOCOUNT ON
	
	IF @ReportType = 'DateWise'
	BEGIN

		EXEC MutualFund.dbo.[usp_CalculateUpFrontBrokShow] @DateFrom=@FromDate,@DateTo=@ToDate,@AgentCode1=@AgentCode	

		SELECT 
			Replace(convert(varchar,tr.Trandate,106),' ','-') as [Trandate]
			,BTM.BrokTypeDesc as  BrokType
			,SUM(ISNULL(tr.Amount,0)) AS Amount
			--,SUM((ISNULL(bd.PaidBrok,0))) As Commission
			,Case WHEN @AgentCode='EMT' THEN 0 ELSE SUM((ISNULL(bd.PaidBrok,0))) END As Commission
			
			
			,COUNT(*) AS TxnCount
		FROM 
			MutualFund.dbo.TransactionDetail tr with (nolock) 
			left Join MutualFund.dbo.BrokerageDetailTempCalculation bd with (nolock) On bd.TranCode=tr.TranCode
			Inner Join MutualFund.dbo.SchemeMaster sm with (nolock) On tr.SchCode=sm.SchemeCode
			Left Outer Join MutualFund.dbo.BrokTypeMaster BTM WITH (NOLOCK) On bd.broktypeid=BTM.BrokTypeCode
		WHERE 
			Tr.AgentCode = @AgentCode
			And (tr.TranDate Between IsNull(@FromDate,tr.TranDate) And IsNull(@ToDate,tr.TranDate) )
			And bd.BrokTypeId in ('101','104','105')--,'103'
		GROUP BY 
			tr.Trandate
			,BTM.BrokTypeDesc
		ORDER BY 
			tr.TranDate desc

	END
	ELSE IF @ReportType = 'ClientWise'
	BEGIN
		
		EXEC MutualFund.dbo.[usp_CalculateUpFrontBrokShow] @DateFrom=@FromDate,@DateTo=@ToDate,@AgentCode1=@AgentCode	

		SELECT 
			--tr.investorcode
			IM.ExistCode AS PartyCode
			,ISNULL(IM.FirstHolderName, '') AS FirstHolderName
			,Replace(convert(varchar,tr.Trandate,106),' ','-') as [Trandate]
			,BTM.BrokTypeDesc as  BrokType
			,SUM(ISNULL(tr.Amount,0)) AS Amount
			,Case WHEN @AgentCode='EMT' THEN 0 ELSE SUM((ISNULL(bd.PaidBrok,0))) END As Commission
		FROM 
			MutualFund.dbo.TransactionDetail tr with (nolock) 
			left Join MutualFund.dbo.BrokerageDetailTempCalculation bd with (nolock) On bd.TranCode=tr.TranCode
			Inner Join MutualFund.dbo.SchemeMaster sm with (nolock) On tr.SchCode=sm.SchemeCode
			Left Outer Join MutualFund.dbo.BrokTypeMaster BTM WITH (NOLOCK) On bd.broktypeid=BTM.BrokTypeCode
			LEFT OUTER JOIN MutualFund.dbo.InvestorMaster IM WITH (NOLOCK) ON tr.investorcode = IM.InvCode
		WHERE 
			Tr.AgentCode = @AgentCode
			And (tr.TranDate Between IsNull(@FromDate,tr.TranDate) And IsNull(@ToDate,tr.TranDate) )
			And bd.BrokTypeId in ('101','104','105')--,'103'
			AND IM.ExistCode = ISNULL(@PartyCode, ExistCode)
		GROUP BY
			--tr.investorcode
			IM.ExistCode
			,IM.FirstHolderName
			,tr.Trandate
			,BTM.BrokTypeDesc
		ORDER BY 
			tr.TranDate desc
			--,tr.investorcode
			,IM.ExistCode

	END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_aLLCount
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[usp_MF_Dash_aLLCount]
--declare
--@ReportType as varchar(100),
	@SubBroker VARCHAR(100), --= 'ET',
	@UserType as varchar(100), --= 'Agent',
	@ReportType VARCHAR(10), --= 'All', --- 'All/SIP/Lumsum
	@Period VARCHAR(5) = 'MTD'
AS
/*
exec dbo.[usp_MF_Dash_aLLCount] @SubBroker = 'EMT', @UserType = 'Agent', @ReportType = 'All', @Period = 'YTD'
exec dbo.[usp_MF_Dash_aLLCount] @SubBroker = 'EMT', @UserType = 'Agent', @ReportType = 'All', @Period = 'ITD'
*/
BEGIN
	if object_id('tempdb..#tmp_aum_cnt') is not null
		drop table #tmp_aum_cnt
	CREATE table #tmp_aum_cnt
	(
		Header varchar(20),
		subbroker varchar(50),
		Total float
	)
	---Aum Count
	insert into #tmp_aum_cnt
	EXEC dbo.[usp_MF_NXT_SubBrokerTotalAUM]  @SubBroker, @Period

	if object_id('tempdb..#tmp_Clientcnt') is not null
		drop table #tmp_Clientcnt
	CREATE table #tmp_Clientcnt
	(
		account int,
		havingPortfolio int,
		MFSegmentActive int,
		RegisteredInMF int,
		MFPortfoliioAmount float
	)

	insert into #tmp_Clientcnt
	EXEC NXT.dbo.[usp_MF_Dash_GetClientCounts] @SubBroker, @ReportType, @Period
		
	if object_id('tempdb..#tmp_TransCnt') is not null
		drop table #tmp_TransCnt
	CREATE table #tmp_TransCnt
	(
		sub_broker varchar(100),
		purchaseAmount float,
		SaleAmount Float,
		NetSale float
	)
	
	insert into #tmp_TransCnt
	exec NXT.dbo.usp_MF_Dash_TransactionTotal @SubBroker,@Period
	------exec NXT.dbo.usp_MF_Dash_TransactionTotal 'GDS','MTD'
	
	declare @sdate varchar(10) , @edate varchar(10)
	
	select @sdate = CONVERT(char(10), dbo.fn_Get_StartData(@Period) , 103) 
	set @edate = CONVERT(char(10), getdate() , 103) 


	if object_id('tempdb..#tmp_CommissionCnt') is not null
		drop table #tmp_CommissionCnt;

	CREATE table #tmp_CommissionCnt
	(
		ClientCode varchar(50),
		ClientName varchar(max), 
		SchemeType varchar(50),
		SchemeName varchar(max),
		InvestmentType varchar(20),	
		TrxnDate date,
		FolioNo	varchar(50), 
		PurchaseNAV float,
		Units float,
		Amount float,
		GrossReceipt float,
		Commission float,
		RevenueType varchar(50)
	)

	insert into #tmp_CommissionCnt
	exec [MutualFund].[dbo].[usp_BillTransaction_Angel_ForIPartner] @AgentCode=@SubBroker,@BillPeriodFrom=@sdate,@BillPeriodTo =@edate
	
	--select round(sum(Commission), 4) CommissionCnt from #tmp_CommissionCnt

	select @SubBroker as sub_broker, 
	max(Aum_Count) as Aum_Count, 
	max(Client_Count) as Client_Count,
	CASE WHEN max(Transaction_Count) = 0 THEN MIN(Transaction_Count) ELSE MAX(Transaction_Count) END as Transaction_Count,
	--max(Transaction_Count) as Transaction_Count, 
	max(Commission_Count) as Commission_Count
	from
	(
		select isnull(Total, 0) as Aum_Count, 0 as Client_Count, 0 as Transaction_Count, 0 as Commission_Count from #tmp_aum_cnt 
		union all
		select 0 as Aum_Count, isnull(account, 0) as Client_Count, 0 as Transaction_Count, 0 as Commission_Count from #tmp_Clientcnt 
		union all
		select 0 as Aum_Count, 0 as Client_Count, isnull(NetSale, 0) as Transaction_Count, 0 as Commission_Count from #tmp_TransCnt 
		union all 
		select 0 as Aum_Count, 0 as Client_Count, 0 as Transaction_Count, isnull(round(sum(Commission), 4), 0) as Commission_Count from #tmp_CommissionCnt 
	) a



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_aLLCount_25May2018
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[usp_MF_Dash_aLLCount_25May2018]
--declare
--@ReportType as varchar(100),
	@SubBroker VARCHAR(100), --= 'ET',
	@UserType as varchar(100), --= 'Agent',
	@ReportType VARCHAR(10), --= 'All', --- 'All/SIP/Lumsum
	@Period VARCHAR(5) = 'MTD'
AS
/*
exec dbo.[usp_MF_Dash_aLLCount_1] @SubBroker = 'EMT', @UserType = 'Agent', @ReportType = 'All', @Period = 'YTD'
exec dbo.[usp_MF_Dash_aLLCount] @SubBroker = 'EMT', @UserType = 'Agent', @ReportType = 'All', @Period = 'ITD'
*/
--BEGIN

Begin try
Begin tran
BEGIN

	--if object_id('tempdb..#tmp_aum_cnt') is not null
	--	drop table #tmp_aum_cnt
	--CREATE table #tmp_aum_cnt
	--(
	--	Header varchar(20),
	--	subbroker varchar(50),
	--	Total float
	--)
	-----Aum Count
	--select 2
	--insert into #tmp_aum_cnt
	EXEC dbo.[usp_MF_NXT_SubBrokerTotalAUM_25May2018]  @SubBroker, @Period
	
	if object_id('tempdb..#tmp_Clientcnt') is not null
		drop table #tmp_Clientcnt
	CREATE table #tmp_Clientcnt
	(
		account int,
		havingPortfolio int,
		MFSegmentActive int,
		RegisteredInMF int,
		MFPortfoliioAmount float
	)

	insert into #tmp_Clientcnt
	EXEC NXT.dbo.[usp_MF_Dash_GetClientCounts] @SubBroker, @ReportType, @Period
	
	if object_id('tempdb..#tmp_TransCnt') is not null
		drop table #tmp_TransCnt
	CREATE table #tmp_TransCnt
	(
		sub_broker varchar(100),
		purchaseAmount float,
		SaleAmount Float,
		NetSale float
	)
	
	insert into #tmp_TransCnt
	exec NXT.dbo.usp_MF_Dash_TransactionTotal @SubBroker,@Period
	------exec NXT.dbo.usp_MF_Dash_TransactionTotal 'GDS','MTD'
	
	declare @sdate varchar(10) , @edate varchar(10)
	
	select @sdate = CONVERT(char(10), dbo.fn_Get_StartData(@Period) , 103) 
	set @edate = CONVERT(char(10), getdate() , 103) 


	if object_id('tempdb..#tmp_CommissionCnt') is not null
		drop table #tmp_CommissionCnt;
		
	CREATE table #tmp_CommissionCnt
	(
		ClientCode varchar(50),
		ClientName varchar(max), 
		SchemeType varchar(50),
		SchemeName varchar(max),
		InvestmentType varchar(20),	
		TrxnDate date,
		FolioNo	varchar(50), 
		PurchaseNAV float,
		Units float,
		Amount float,
		GrossReceipt float,
		Commission float,
		RevenueType varchar(50)
	)

	insert into #tmp_CommissionCnt
	exec [MutualFund].[dbo].[usp_BillTransaction_Angel_ForIPartner] @AgentCode=@SubBroker,@BillPeriodFrom=@sdate,@BillPeriodTo =@edate
	
	--select round(sum(Commission), 4) CommissionCnt from #tmp_CommissionCnt
	
	select @SubBroker as sub_broker, 
	max(Aum_Count) as Aum_Count, 
	max(Client_Count) as Client_Count,
	CASE WHEN max(Transaction_Count) = 0 THEN MIN(Transaction_Count) ELSE MAX(Transaction_Count) END as Transaction_Count,
	--max(Transaction_Count) as Transaction_Count, 
	max(Commission_Count) as Commission_Count
	from
	(
		select isnull(Total_AUM, 0) as Aum_Count, 0 as Client_Count, 0 as Transaction_Count, 0 as Commission_Count from ##Main 
		union all
		select 0 as Aum_Count, isnull(account, 0) as Client_Count, 0 as Transaction_Count, 0 as Commission_Count from #tmp_Clientcnt 
		union all
		select 0 as Aum_Count, 0 as Client_Count, isnull(NetSale, 0) as Transaction_Count, 0 as Commission_Count from #tmp_TransCnt 
		union all 
		select 0 as Aum_Count, 0 as Client_Count, 0 as Transaction_Count, isnull(round(sum(Commission), 4), 0) as Commission_Count from #tmp_CommissionCnt 
	) a
	
	END
	Commit tran;
	END try
	Begin catch 

	IF @@trancount > 0
	
	rollback tran
	
	End catch
	

--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_AUMCount_bckup_15032018
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Usp_MF_Dash_AUMCount_bckup_15032018]
(
	--@ReportType as varchar(100),
	@UserType as varchar(100),
	@UserCode  as varchar(100)

)
--EXEC [Usp_MF_Dash_AUMCount] @UserType='Agent',@UserCode='GDS'
AS
BEGIN 



Declare @Temp table   
(
	SchemeClassDescription nvarchar (4000)
	,PresentValue decimal(38,2)
	,InvestedAmount decimal(38,2)
	,PresentValuePercentage decimal(38,2),
	InvestedAmountPercentage decimal(38,2)
)

declare @Final table
(
  Headers varchar(100),
  Equity decimal(38,2),
  Debt decimal(38,2),
  ELSS decimal(38,2),
  [Liquid Fund] decimal(38,2),
  [Balanced Fund] decimal(38,2),
  [Gilt Fund] decimal(38,2),
  [Funds of Funds] decimal(38,2),
  [Income] decimal(38,2),
  [Dynamic Asset Allocation] decimal(38,2),
  [Money Market] decimal(38,2),
  [Special Fund] decimal(38,2)
  
  )

    
--Declare Variablese
Declare @_InvCode varchar(100)   
Declare @_InvGroupCode varchar(100)      
Declare @_AgentCode varchar(100)
Declare @_SubAgencyCode varchar(100)     
Declare @_RMCode varchar(100)    
Declare @_BranchCode varchar(100)     
Declare @_PANNo as varchar(100)


Declare @CurrentMonthStartDate DateTime
Declare @CurrentDate DateTime


--Initialize with Null
Set @_InvCode =null     
Set @_InvGroupCode =null        
Set @_AgentCode =null
Set @_SubAgencyCode =null       
Set @_RMCode =null       
Set @_BranchCode =null       
Set @_PANNo =Null


Set @CurrentMonthStartDate =  dateadd(month,datediff(month,0,getdate()),0)
Set @CurrentDate = Cast(convert(varchar,getdate(),106) As DateTime)


--Set value in Appropriate variable
If Upper(@UserType)='INVESTOR'		Set @_InvCode =@UserCode --select @_InvCode=InvCode from investormaster where FirstHolderPAN=@UserCode
If Upper(@UserType)='INVESTORGROUP' Set @_InvGroupCode = @UserCode
If Upper(@UserType)='AGENT'			Set @_AgentCode = @UserCode
If Upper(@UserType)='SUBAGENT'		Set @_SubAgencyCode = @UserCode
If Upper(@UserType)='RM'			Set @_RMCode = @UserCode
If Upper(@UserType)='BRANCH'		Set @_BranchCode = @UserCode
If Upper(@UserType)='PAN'			Set @_PANNo = @UserCode

	
--set @IncludeZero=isnull(@IncludeZero,'N')


insert into @Temp
Exec MutualFund.[dbo].[usp_PortfolioAllocationAssetClasswise2] @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode


--seleCt * from @Temp



insert into @Final
select *  from

(
/*select * from
(
	select schemeclassdescription,
	InvestedAmount 
	
	from @Temp
)as SourceTable pivot (sum(InvestedAmount) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund])) as PivotTable
union all*/
select 'AUM' as Headers,* from
(
	select schemeclassdescription,
	PresentValue 
	
	from @Temp 
)as SourceTable pivot (sum(PresentValue) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund],[Gilt Fund],[Funds of Funds],[Income],[Dynamic Asset Allocation],[Money Market],[Special Fund])) as PivotTable
)z


select Headers,
@UserCode SubBroker ,
--CONVERT(varchar(100), isnull(Equity,0)) as Equity,CONVERT(varchar(100),isnull(Debt,0)) as Debt,CONVERT(varchar(100),isnull(ELSS,0)) as ELSS,
--CONVERT(varchar(100),isnull([Liquid Fund],0)) as [LiquidFund],CONVERT(varchar(100),isnull([Balanced Fund],0)) as [BalancedFund],convert(varchar(8000),(isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)
--+isnull([Money Market],0)+isnull([Special Fund],0))) as Other
CONVERT(varchar(100),isnull(Equity,0)+isnull(Debt,0)+isnull(ELSS,0)+isnull([Liquid Fund],0)+isnull([Balanced Fund],0)+isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)+isnull([Money Market],0)+isnull
([Special Fund],0) ) as Total from @Final



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_AUMDetails
-- --------------------------------------------------
--select dbo.fn_Get_StartData('YTD')

CREATE PROCEDURE [dbo].[Usp_MF_Dash_AUMDetails]
(
	--@ReportType as varchar(100),
	@UserType as varchar(100)='AGENT',
	@UserCode  as varchar(100),
	@Period varchar(5) = 'MTD'
)

/*
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd', @Period= 'MTD'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd', @Period= 'yTD'
EXEC [Usp_MF_Dash_AUMDetails_11] @UserType='Agent',@UserCode='EMT', @Period= 'yTD'
EXEC [Usp_MF_Dash_AUMDetails] @UserType='Agent',@UserCode='EMT', @Period= 'yTD'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='EMT', @Period= 'MTD'
*/
with recompile
as
Begin 

	/* Refering below sp 109 Mutual Fund
	exec usp_ReportsForWebTrade_Angel_inhouse_final @ReportType='AssetWiseAllocation',@UserType='Agent',@UserCode='kgd'
	*/

	declare @sdate date , @edate date
	select @sdate =dbo.fn_Get_StartData(@Period),	@edate = cast(getdate() as date) 

	Declare @Temp table   
	(
		SchemeClassDescription nvarchar (4000)
		,PresentValue decimal(38,2)
		,InvestedAmount decimal(38,2)
		,PresentValuePercentage decimal(38,2),
		InvestedAmountPercentage decimal(38,2)
	)

	declare @Final table
	(
		Headers varchar(100),
		Equity decimal(38,2),
		Debt decimal(38,2),
		ELSS decimal(38,2),
		[Liquid Fund] decimal(38,2),
		[Balanced Fund] decimal(38,2),
		[Gilt Fund] decimal(38,2),
		[Funds of Funds] decimal(38,2),
		[Income] decimal(38,2),
		[Dynamic Asset Allocation] decimal(38,2),
		[Money Market] decimal(38,2),
		[Special Fund] decimal(38,2)
	)

    
	--Declare Variablese
	Declare @_InvCode varchar(100)   
	Declare @_InvGroupCode varchar(100)      
	Declare @_AgentCode varchar(100)
	Declare @_SubAgencyCode varchar(100)     
	Declare @_RMCode varchar(100)    
	Declare @_BranchCode varchar(100)     
	Declare @_PANNo as varchar(100)
	Declare @CurrentMonthStartDate DateTime
	Declare @CurrentDate DateTime


	--Initialize with Null
	Set @_InvCode =null     
	Set @_InvGroupCode =null        
	Set @_AgentCode =null
	Set @_SubAgencyCode =null       
	Set @_RMCode =null       
	Set @_BranchCode =null       
	Set @_PANNo =Null


	Set @CurrentMonthStartDate =  dateadd(month,datediff(month,0,getdate()),0)
	Set @CurrentDate = Cast(convert(varchar,getdate(),106) As DateTime)


	--Set value in Appropriate variable
	If Upper(@UserType)='INVESTOR'		Set @_InvCode =@UserCode --select @_InvCode=InvCode from investormaster where FirstHolderPAN=@UserCode
	If Upper(@UserType)='INVESTORGROUP' Set @_InvGroupCode = @UserCode
	If Upper(@UserType)='AGENT'			Set @_AgentCode = @UserCode
	If Upper(@UserType)='SUBAGENT'		Set @_SubAgencyCode = @UserCode
	If Upper(@UserType)='RM'			Set @_RMCode = @UserCode
	If Upper(@UserType)='BRANCH'		Set @_BranchCode = @UserCode
	If Upper(@UserType)='PAN'			Set @_PANNo = @UserCode
	--set @IncludeZero=isnull(@IncludeZero,'N')


	insert into @Temp
	--Exec MutualFund.[dbo].[usp_PortfolioAllocationAssetClasswise2] @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode
	Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode,@sdate,@edate
	--seleCt * from @Temp

	insert into @Final
	select *  from
	(
		/*select * from
		(
			select schemeclassdescription,
			InvestedAmount 
	
			from @Temp
		)as SourceTable pivot (sum(InvestedAmount) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund])) as PivotTable
		union all*/
		select 'AUM' as Headers,* from
		(
			select schemeclassdescription,
			PresentValue 	
			from @Temp 
		)as SourceTable 
		pivot 
		(
			sum(PresentValue) For schemeclassdescription in 
			([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund],[Gilt Fund],[Funds of Funds],[Income],[Dynamic Asset Allocation],[Money Market],[Special Fund])
		) as PivotTable
	)z


	select Headers,
	@UserCode SubBroker ,
	CONVERT(varchar(100), isnull(Equity,0)) as Equity,CONVERT(varchar(100),isnull(Debt,0)) as Debt,CONVERT(varchar(100),isnull(ELSS,0)) as ELSS,
	CONVERT(varchar(100),isnull([Liquid Fund],0)) as [LiquidFund],CONVERT(varchar(100),isnull([Balanced Fund],0)) as [BalancedFund],convert(varchar(8000),(isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)
	+isnull([Money Market],0)+isnull([Special Fund],0))) as Other
	,CONVERT(varchar(100),isnull(Equity,0)+isnull(Debt,0)+isnull(ELSS,0)+isnull([Liquid Fund],0)+isnull([Balanced Fund],0)+isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)+isnull([Money Market],0)+isnull
	([Special Fund],0) ) as Total from @Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_AUMDetails_bckup_15032018
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_MF_Dash_AUMDetails_bckup_15032018]
(
	--@ReportType as varchar(100),
	@UserType as varchar(100)='AGENT',
	@UserCode  as varchar(100)

)

--EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd'
as
Begin 


/* Refering below sp 109 Mutual Fund
exec usp_ReportsForWebTrade_Angel_inhouse_final @ReportType='AssetWiseAllocation',@UserType='Agent',@UserCode='kgd'

*/


--Declare 
--@ReportType as varchar(100),
--@UserType as varchar(100),
--@UserCode  as varchar(100)





  --Select @ReportType='AssetWiseAllocation',@UserType='Agent',@UserCode='kgd'


Declare @Temp table   
(
	SchemeClassDescription nvarchar (4000)
	,PresentValue decimal(38,2)
	,InvestedAmount decimal(38,2)
	,PresentValuePercentage decimal(38,2),
	InvestedAmountPercentage decimal(38,2)
)

declare @Final table
(
  Headers varchar(100),
  Equity decimal(38,2),
  Debt decimal(38,2),
  ELSS decimal(38,2),
  [Liquid Fund] decimal(38,2),
  [Balanced Fund] decimal(38,2),
  [Gilt Fund] decimal(38,2),
  [Funds of Funds] decimal(38,2),
  [Income] decimal(38,2),
  [Dynamic Asset Allocation] decimal(38,2),
  [Money Market] decimal(38,2),
  [Special Fund] decimal(38,2)
  
  )

    
--Declare Variablese
Declare @_InvCode varchar(100)   
Declare @_InvGroupCode varchar(100)      
Declare @_AgentCode varchar(100)
Declare @_SubAgencyCode varchar(100)     
Declare @_RMCode varchar(100)    
Declare @_BranchCode varchar(100)     
Declare @_PANNo as varchar(100)


Declare @CurrentMonthStartDate DateTime
Declare @CurrentDate DateTime


--Initialize with Null
Set @_InvCode =null     
Set @_InvGroupCode =null        
Set @_AgentCode =null
Set @_SubAgencyCode =null       
Set @_RMCode =null       
Set @_BranchCode =null       
Set @_PANNo =Null


Set @CurrentMonthStartDate =  dateadd(month,datediff(month,0,getdate()),0)
Set @CurrentDate = Cast(convert(varchar,getdate(),106) As DateTime)


--Set value in Appropriate variable
If Upper(@UserType)='INVESTOR'		Set @_InvCode =@UserCode --select @_InvCode=InvCode from investormaster where FirstHolderPAN=@UserCode
If Upper(@UserType)='INVESTORGROUP' Set @_InvGroupCode = @UserCode
If Upper(@UserType)='AGENT'			Set @_AgentCode = @UserCode
If Upper(@UserType)='SUBAGENT'		Set @_SubAgencyCode = @UserCode
If Upper(@UserType)='RM'			Set @_RMCode = @UserCode
If Upper(@UserType)='BRANCH'		Set @_BranchCode = @UserCode
If Upper(@UserType)='PAN'			Set @_PANNo = @UserCode

	
--set @IncludeZero=isnull(@IncludeZero,'N')


insert into @Temp
Exec MutualFund.[dbo].[usp_PortfolioAllocationAssetClasswise2] @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode


--seleCt * from @Temp



insert into @Final
select *  from

(
/*select * from
(
	select schemeclassdescription,
	InvestedAmount 
	
	from @Temp
)as SourceTable pivot (sum(InvestedAmount) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund])) as PivotTable
union all*/
select 'AUM' as Headers,* from
(
	select schemeclassdescription,
	PresentValue 
	
	from @Temp 
)as SourceTable pivot (sum(PresentValue) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund],[Gilt Fund],[Funds of Funds],[Income],[Dynamic Asset Allocation],[Money Market],[Special Fund])) as PivotTable
)z


select Headers,
@UserCode SubBroker ,
CONVERT(varchar(100), isnull(Equity,0)) as Equity,CONVERT(varchar(100),isnull(Debt,0)) as Debt,CONVERT(varchar(100),isnull(ELSS,0)) as ELSS,
CONVERT(varchar(100),isnull([Liquid Fund],0)) as [LiquidFund],CONVERT(varchar(100),isnull([Balanced Fund],0)) as [BalancedFund],convert(varchar(8000),(isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)


+isnull([Money Market],0)+isnull([Special Fund],0))) as Other
,CONVERT(varchar(100),isnull(Equity,0)+isnull(Debt,0)+isnull(ELSS,0)+isnull([Liquid Fund],0)+isnull([Balanced Fund],0)+isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)+isnull([Money Market],0)+isnull


([Special Fund],0) ) as Total from @Final



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_AUMDetails_New
-- --------------------------------------------------

Create PROCEDURE [dbo].[Usp_MF_Dash_AUMDetails_New]
(
	--@ReportType as varchar(100),
	@UserType as varchar(100)='AGENT',
	@UserCode  as varchar(100),
	@Period varchar(5) = 'MTD'
)

/*
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd', @Period= 'MTD'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd', @Period= 'yTD'
*/
as
Begin 

	/* Refering below sp 109 Mutual Fund
	exec usp_ReportsForWebTrade_Angel_inhouse_final @ReportType='AssetWiseAllocation',@UserType='Agent',@UserCode='kgd'
	*/
	--Declare 
	--@ReportType as varchar(100),
	--@UserType as varchar(100),
	--@UserCode  as varchar(100)
	declare @sdate date , @edate date
	if (upper(@period) = 'YTD')
	BEGIN
		select @sdate = cast('01-Apr-' +
				cast(case
						when datepart(mm,getdate()) in (4,5,6,7,8,9,10,11,12) 
					then DATEPART(yy,getdate()) 
					else DATEPART(yy,getdate())-1 
					end as varchar
				) as date) , 
		@edate = cast(getdate() as date) 
	END
	ELSE
	BEGIN
		select @sdate = cast(DATEADD(month, DATEDIFF(month, 0, getdate()), 0) as date),
		@edate = cast(getdate() as date) 
	END
	--select @sdate, @edate

	--Select @ReportType='AssetWiseAllocation',@UserType='Agent',@UserCode='kgd'
	Declare @Temp table   
	(
		SchemeClassDescription nvarchar (4000)
		,PresentValue decimal(38,2)
		,InvestedAmount decimal(38,2)
		,PresentValuePercentage decimal(38,2),
		InvestedAmountPercentage decimal(38,2)
	)

	declare @Final table
	(
		Headers varchar(100),
		Equity decimal(38,2),
		Debt decimal(38,2),
		ELSS decimal(38,2),
		[Liquid Fund] decimal(38,2),
		[Balanced Fund] decimal(38,2),
		[Gilt Fund] decimal(38,2),
		[Funds of Funds] decimal(38,2),
		[Income] decimal(38,2),
		[Dynamic Asset Allocation] decimal(38,2),
		[Money Market] decimal(38,2),
		[Special Fund] decimal(38,2)
	)

    
	--Declare Variablese
	Declare @_InvCode varchar(100)   
	Declare @_InvGroupCode varchar(100)      
	Declare @_AgentCode varchar(100)
	Declare @_SubAgencyCode varchar(100)     
	Declare @_RMCode varchar(100)    
	Declare @_BranchCode varchar(100)     
	Declare @_PANNo as varchar(100)
	Declare @CurrentMonthStartDate DateTime
	Declare @CurrentDate DateTime


	--Initialize with Null
	Set @_InvCode =null     
	Set @_InvGroupCode =null        
	Set @_AgentCode =null
	Set @_SubAgencyCode =null       
	Set @_RMCode =null       
	Set @_BranchCode =null       
	Set @_PANNo =Null


	Set @CurrentMonthStartDate =  dateadd(month,datediff(month,0,getdate()),0)
	Set @CurrentDate = Cast(convert(varchar,getdate(),106) As DateTime)


	--Set value in Appropriate variable
	If Upper(@UserType)='INVESTOR'		Set @_InvCode =@UserCode --select @_InvCode=InvCode from investormaster where FirstHolderPAN=@UserCode
	If Upper(@UserType)='INVESTORGROUP' Set @_InvGroupCode = @UserCode
	If Upper(@UserType)='AGENT'			Set @_AgentCode = @UserCode
	If Upper(@UserType)='SUBAGENT'		Set @_SubAgencyCode = @UserCode
	If Upper(@UserType)='RM'			Set @_RMCode = @UserCode
	If Upper(@UserType)='BRANCH'		Set @_BranchCode = @UserCode
	If Upper(@UserType)='PAN'			Set @_PANNo = @UserCode
	--set @IncludeZero=isnull(@IncludeZero,'N')


	insert into @Temp
	--Exec MutualFund.[dbo].[usp_PortfolioAllocationAssetClasswise2] @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode
	Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode,@sdate,@edate
	--seleCt * from @Temp

	insert into @Final
	select *  from
	(
		/*select * from
		(
			select schemeclassdescription,
			InvestedAmount 
	
			from @Temp
		)as SourceTable pivot (sum(InvestedAmount) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund])) as PivotTable
		union all*/
		select 'AUM' as Headers,* from
		(
			select schemeclassdescription,
			PresentValue 	
			from @Temp 
		)as SourceTable 
		pivot 
		(
			sum(PresentValue) For schemeclassdescription in 
			([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund],[Gilt Fund],[Funds of Funds],[Income],[Dynamic Asset Allocation],[Money Market],[Special Fund])
		) as PivotTable
	)z


	select Headers,
	@UserCode SubBroker ,
	CONVERT(varchar(100), isnull(Equity,0)) as Equity,CONVERT(varchar(100),isnull(Debt,0)) as Debt,CONVERT(varchar(100),isnull(ELSS,0)) as ELSS,
	CONVERT(varchar(100),isnull([Liquid Fund],0)) as [LiquidFund],CONVERT(varchar(100),isnull([Balanced Fund],0)) as [BalancedFund],convert(varchar(8000),(isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)
	+isnull([Money Market],0)+isnull([Special Fund],0))) as Other
	,CONVERT(varchar(100),isnull(Equity,0)+isnull(Debt,0)+isnull(ELSS,0)+isnull([Liquid Fund],0)+isnull([Balanced Fund],0)+isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)+isnull([Money Market],0)+isnull
	([Special Fund],0) ) as Total from @Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_AUMDetails_New1
-- --------------------------------------------------
--select dbo.fn_Get_StartData('YTD')

CREATE PROCEDURE [dbo].[Usp_MF_Dash_AUMDetails_New1]
(
	--@ReportType as varchar(100),
	@UserType as varchar(100)='AGENT',
	@UserCode  as varchar(100),
	@Period varchar(5) = 'MTD'
)

/*
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='EMT', @Period= 'itd'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd', @Period= 'MTD'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd', @Period= 'yTD'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='EMT', @Period= 'itd'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='EMT', @Period= 'MTD'
*/
as
Begin 

	/* Refering below sp 109 Mutual Fund
	exec usp_ReportsForWebTrade_Angel_inhouse_final @ReportType='AssetWiseAllocation',@UserType='Agent',@UserCode='kgd'
	*/

	declare @sdate date , @edate date
	select @sdate =dbo.fn_Get_StartData(@Period),	@edate = cast(getdate() as date) 

	Declare @Temp table   
	(
		SchemeClassDescription nvarchar (4000)
		,PresentValue decimal(38,2)
		,InvestedAmount decimal(38,2)
		,PresentValuePercentage decimal(38,2),
		InvestedAmountPercentage decimal(38,2)
	)

	declare @Final table
	(
		Headers varchar(100),
		Equity decimal(38,2),
		Debt decimal(38,2),
		ELSS decimal(38,2),
		[Liquid Fund] decimal(38,2),
		[Balanced Fund] decimal(38,2),
		[Gilt Fund] decimal(38,2),
		[Funds of Funds] decimal(38,2),
		[Income] decimal(38,2),
		[Dynamic Asset Allocation] decimal(38,2),
		[Money Market] decimal(38,2),
		[Special Fund] decimal(38,2)
	)

    
	--Declare Variablese
	Declare @_InvCode varchar(100)   
	Declare @_InvGroupCode varchar(100)      
	Declare @_AgentCode varchar(100)
	Declare @_SubAgencyCode varchar(100)     
	Declare @_RMCode varchar(100)    
	Declare @_BranchCode varchar(100)     
	Declare @_PANNo as varchar(100)
	Declare @CurrentMonthStartDate DateTime
	Declare @CurrentDate DateTime


	--Initialize with Null
	Set @_InvCode =null     
	Set @_InvGroupCode =null        
	Set @_AgentCode =null
	Set @_SubAgencyCode =null       
	Set @_RMCode =null       
	Set @_BranchCode =null       
	Set @_PANNo =Null


	Set @CurrentMonthStartDate =  dateadd(month,datediff(month,0,getdate()),0)
	Set @CurrentDate = Cast(convert(varchar,getdate(),106) As DateTime)


	--Set value in Appropriate variable
	If Upper(@UserType)='INVESTOR'		Set @_InvCode =@UserCode --select @_InvCode=InvCode from investormaster where FirstHolderPAN=@UserCode
	If Upper(@UserType)='INVESTORGROUP' Set @_InvGroupCode = @UserCode
	If Upper(@UserType)='AGENT'			Set @_AgentCode = @UserCode
	If Upper(@UserType)='SUBAGENT'		Set @_SubAgencyCode = @UserCode
	If Upper(@UserType)='RM'			Set @_RMCode = @UserCode
	If Upper(@UserType)='BRANCH'		Set @_BranchCode = @UserCode
	If Upper(@UserType)='PAN'			Set @_PANNo = @UserCode
	--set @IncludeZero=isnull(@IncludeZero,'N')


	insert into @Temp
	--Exec MutualFund.[dbo].[usp_PortfolioAllocationAssetClasswise2] @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode
	Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode,@sdate,@edate
	
	seleCt * from @Temp


	/*
	insert into @Final
	select *  from
	(
		/*select * from
		(
			select schemeclassdescription,
			InvestedAmount 
	
			from @Temp
		)as SourceTable pivot (sum(InvestedAmount) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund])) as PivotTable
		union all*/
		select 'AUM' as Headers,* from
		(
			select schemeclassdescription,
			PresentValue 	
			from @Temp 
		)as SourceTable 
		pivot 
		(
			sum(PresentValue) For schemeclassdescription in 
			([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund],[Gilt Fund],[Funds of Funds],[Income],[Dynamic Asset Allocation],[Money Market],[Special Fund])
		) as PivotTable
	)z


	select Headers,
	@UserCode SubBroker ,
	CONVERT(varchar(100), isnull(Equity,0)) as Equity,CONVERT(varchar(100),isnull(Debt,0)) as Debt,CONVERT(varchar(100),isnull(ELSS,0)) as ELSS,
	CONVERT(varchar(100),isnull([Liquid Fund],0)) as [LiquidFund],CONVERT(varchar(100),isnull([Balanced Fund],0)) as [BalancedFund],convert(varchar(8000),(isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)
	+isnull([Money Market],0)+isnull([Special Fund],0))) as Other
	,CONVERT(varchar(100),isnull(Equity,0)+isnull(Debt,0)+isnull(ELSS,0)+isnull([Liquid Fund],0)+isnull([Balanced Fund],0)+isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)+isnull([Money Market],0)+isnull
	([Special Fund],0) ) as Total from @Final
	*/

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_AUMDetails_sss
-- --------------------------------------------------
--select dbo.fn_Get_StartData('YTD')

CREATE PROCEDURE [dbo].[Usp_MF_Dash_AUMDetails_sss]
(
	--@ReportType as varchar(100),
	@UserType as varchar(100)='AGENT',
	@UserCode  as varchar(100),
	@Period varchar(5) = 'MTD'
)
with recompile
/*
EXEC Usp_MF_Dash_AUMDetails_SSS @UserType='Agent',@UserCode='kgd', @Period= 'MTD'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='kgd', @Period= 'yTD'
EXEC [Usp_MF_Dash_AUMDetails_11] @UserType='Agent',@UserCode='EMT', @Period= 'yTD'
EXEC [Usp_MF_Dash_AUMDetails] @UserType='Agent',@UserCode='EMT', @Period= 'yTD'
EXEC Usp_MF_Dash_AUMDetails @UserType='Agent',@UserCode='EMT', @Period= 'MTD'
*/
as
Begin 

	/* Refering below sp 109 Mutual Fund
	exec usp_ReportsForWebTrade_Angel_inhouse_final @ReportType='AssetWiseAllocation',@UserType='Agent',@UserCode='kgd'
	*/
	select 1
	declare @sdate date , @edate date
	select @sdate =dbo.fn_Get_StartData(@Period),	@edate = cast(getdate() as date) 

	CREATE TABLE #Main 
	(
		SchemeClassDescription nvarchar (4000)
		,PresentValue decimal(38,2)
		,InvestedAmount decimal(38,2)
		,PresentValuePercentage decimal(38,2),
		InvestedAmountPercentage decimal(38,2)
	)

	declare @Final table
	(
		Headers varchar(100),
		Equity decimal(38,2),
		Debt decimal(38,2),
		ELSS decimal(38,2),
		[Liquid Fund] decimal(38,2),
		[Balanced Fund] decimal(38,2),
		[Gilt Fund] decimal(38,2),
		[Funds of Funds] decimal(38,2),
		[Income] decimal(38,2),
		[Dynamic Asset Allocation] decimal(38,2),
		[Money Market] decimal(38,2),
		[Special Fund] decimal(38,2)
	)

    
	--Declare Variablese
	Declare @_InvCode varchar(100)   
	Declare @_InvGroupCode varchar(100)      
	Declare @_AgentCode varchar(100)
	Declare @_SubAgencyCode varchar(100)     
	Declare @_RMCode varchar(100)    
	Declare @_BranchCode varchar(100)     
	Declare @_PANNo as varchar(100)
	Declare @CurrentMonthStartDate DateTime
	Declare @CurrentDate DateTime


	--Initialize with Null
	Set @_InvCode =null     
	Set @_InvGroupCode =null        
	Set @_AgentCode =null
	Set @_SubAgencyCode =null       
	Set @_RMCode =null       
	Set @_BranchCode =null       
	Set @_PANNo =Null


	Set @CurrentMonthStartDate =  dateadd(month,datediff(month,0,getdate()),0)
	Set @CurrentDate = Cast(convert(varchar,getdate(),106) As DateTime)


	--Set value in Appropriate variable
	If Upper(@UserType)='INVESTOR'		Set @_InvCode =@UserCode --select @_InvCode=InvCode from investormaster where FirstHolderPAN=@UserCode
	If Upper(@UserType)='INVESTORGROUP' Set @_InvGroupCode = @UserCode
	If Upper(@UserType)='AGENT'			Set @_AgentCode = @UserCode
	If Upper(@UserType)='SUBAGENT'		Set @_SubAgencyCode = @UserCode
	If Upper(@UserType)='RM'			Set @_RMCode = @UserCode
	If Upper(@UserType)='BRANCH'		Set @_BranchCode = @UserCode
	If Upper(@UserType)='PAN'			Set @_PANNo = @UserCode
	--set @IncludeZero=isnull(@IncludeZero,'N')

	select 2
	insert into #Main
	--Exec MutualFund.[dbo].[usp_PortfolioAllocationAssetClasswise2] @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode
	Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner_sss @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode,@sdate,@edate
	--seleCt * from @Temp
	select 3
	insert into @Final
	select *  from
	(
		/*select * from
		(
			select schemeclassdescription,
			InvestedAmount 
	
			from @Temp
		)as SourceTable pivot (sum(InvestedAmount) For schemeclassdescription in ([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund])) as PivotTable
		union all*/
		select 'AUM' as Headers,* from
		(
			select schemeclassdescription,
			PresentValue 	
			from #Main 
		)as SourceTable 
		pivot 
		(
			sum(PresentValue) For schemeclassdescription in 
			([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund],[Gilt Fund],[Funds of Funds],[Income],[Dynamic Asset Allocation],[Money Market],[Special Fund])
		) as PivotTable
	)z


	select Headers,
	@UserCode SubBroker ,
	CONVERT(varchar(100), isnull(Equity,0)) as Equity,CONVERT(varchar(100),isnull(Debt,0)) as Debt,CONVERT(varchar(100),isnull(ELSS,0)) as ELSS,
	CONVERT(varchar(100),isnull([Liquid Fund],0)) as [LiquidFund],CONVERT(varchar(100),isnull([Balanced Fund],0)) as [BalancedFund],convert(varchar(8000),(isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)
	+isnull([Money Market],0)+isnull([Special Fund],0))) as Other
	,CONVERT(varchar(100),isnull(Equity,0)+isnull(Debt,0)+isnull(ELSS,0)+isnull([Liquid Fund],0)+isnull([Balanced Fund],0)+isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)+isnull([Money Market],0)+isnull
	([Special Fund],0) ) as Total from @Final

DROP TABLE #Main
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_AUMTotal_bkp_2018May10
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_MF_Dash_AUMTotal_bkp_2018May10]
(
	--@ReportType as varchar(100),
	@UserType as varchar(100),
	@UserCode  as varchar(100),
	@Period varchar(5) = 'MTD'

)
/*
EXEC [Usp_MF_Dash_AUMTotal] @UserType='Agent',@UserCode='GDS',@Period ='MTD'
EXEC [Usp_MF_Dash_AUMTotal] @UserType='Agent',@UserCode='GDS',@Period ='yTD'
*/
/*

begin tran
declare @Sdate datetime = getdate()
EXEC [Usp_MF_Dash_AUMTotal] @UserType='Agent',@UserCode='EMT',@Period ='yTD'
select datediff(ms,@Sdate,GETDATE())
rollback tran

*/
AS
BEGIN 
declare @sdate date , @edate date 

select @sdate =dbo.fn_Get_StartData(@Period),	@edate = cast(getdate() as date) 


	Declare @Temp table   
	(
		SchemeClassDescription nvarchar (4000)
		,PresentValue decimal(38,2)
		,InvestedAmount decimal(38,2)
		,PresentValuePercentage decimal(38,2),
		InvestedAmountPercentage decimal(38,2)
	)

	--declare @Final table
	--CREATE TABLE #final
	--(
	--	Headers varchar(100),
	--	Equity decimal(38,2),
	--	Debt decimal(38,2),
	--	ELSS decimal(38,2),
	--	[Liquid Fund] decimal(38,2),
	--	[Balanced Fund] decimal(38,2),
	--	[Gilt Fund] decimal(38,2),
	--	[Funds of Funds] decimal(38,2),
	--	[Income] decimal(38,2),
	--	[Dynamic Asset Allocation] decimal(38,2),
	--	[Money Market] decimal(38,2),
	--	[Special Fund] decimal(38,2)
	--)

    
	--Declare Variablese
	Declare @_InvCode varchar(100)   
	Declare @_InvGroupCode varchar(100)      
	Declare @_AgentCode varchar(100)
	Declare @_SubAgencyCode varchar(100)     
	Declare @_RMCode varchar(100)    
	Declare @_BranchCode varchar(100)     
	Declare @_PANNo as varchar(100)
	Declare @CurrentMonthStartDate DateTime
	Declare @CurrentDate DateTime


	--Initialize with Null
	Set @_InvCode =null     
	Set @_InvGroupCode =null        
	Set @_AgentCode =null
	Set @_SubAgencyCode =null       
	Set @_RMCode =null       
	Set @_BranchCode =null       
	Set @_PANNo =Null
	Set @CurrentMonthStartDate =  dateadd(month,datediff(month,0,getdate()),0)
	Set @CurrentDate = Cast(convert(varchar,getdate(),106) As DateTime)


	--Set value in Appropriate variable
	If Upper(@UserType)='INVESTOR'		Set @_InvCode =@UserCode --select @_InvCode=InvCode from investormaster where FirstHolderPAN=@UserCode
	If Upper(@UserType)='INVESTORGROUP' Set @_InvGroupCode = @UserCode
	If Upper(@UserType)='AGENT'			Set @_AgentCode = @UserCode
	If Upper(@UserType)='SUBAGENT'		Set @_SubAgencyCode = @UserCode
	If Upper(@UserType)='RM'			Set @_RMCode = @UserCode
	If Upper(@UserType)='BRANCH'		Set @_BranchCode = @UserCode
	If Upper(@UserType)='PAN'			Set @_PANNo = @UserCode	
	--set @IncludeZero=isnull(@IncludeZero,'N')
	
	insert into @Temp
	--Exec MutualFund.[dbo].[usp_PortfolioAllocationAssetClasswise2] @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode
	Exec MutualFund.[dbo].usp_PortfolioAllocationAssetClasswise2_ForIPartner @_InvCode,@_InvGroupCode,@_AgentCode,@_SubAgencyCode,@_RMCode,@_BranchCode,@sdate,@edate


	--insert into #final
	select * INTO #Final from
	(
		select 'AUM' as Headers,* from
		(
			select schemeclassdescription,
			PresentValue 	
			from @Temp 
		)as SourceTable 
		pivot 
		(
			sum(PresentValue) For schemeclassdescription in 
			([Equity],[Debt],[ELSS],[Liquid Fund],[Balanced Fund],[Gilt Fund],[Funds of Funds],[Income],[Dynamic Asset Allocation],[Money Market],[Special Fund])
		) as PivotTable
	)z


	select Headers,
	@UserCode SubBroker ,
	CONVERT(varchar(100),isnull(Equity,0)+isnull(Debt,0)+isnull(ELSS,0)+isnull([Liquid Fund],0)+isnull([Balanced Fund],0)+isnull([Gilt Fund],0)+isnull([Funds of Funds],0)+isnull([Income],0)+isnull([Dynamic Asset Allocation],0)+isnull([Money Market],0)+isnull
	([Special Fund],0) ) as Total from #final



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MF_Dash_Commission_and_Graph
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_MF_Dash_Commission_and_Graph]
--DEclare 
	@subBroker varchar(50) --= 'ET'
	--@Period varchar(10)
AS
/*
USP_MF_Dash_Commission_and_Graph 'ET'
USP_MF_Dash_Commission_and_Graph 'ET', 'MTD'

begin tran
declare @Sdate datetime = getdate()
EXEC USP_MF_Dash_Commission_and_Graph 'EMT'
select datediff(ms,@Sdate,GETDATE())
rollback tran


*/
BEGIN

	declare @sdate date , @edate date
	declare @ydtsdate varchar(10) ,  @mdtsdate varchar(10) ,@eedate varchar(10),@ITDdate Date,@ITDdate1 varchar(10)

	select @sdate = dbo.fn_Get_StartData('YTD')
	set @edate = cast(getdate() as date) 
	select @ydtsdate = CONVERT(char(10), @sdate, 103), @eedate = CONVERT(char(10), @edate, 103)

		select @ITDdate = dbo.fn_Get_StartData('ITD')
		Set @ITDdate1 = CONVERT(char(10), @ITDdate, 103)

	if object_id('tempdb..#Month') is not null
		drop table #Month;
	CREATE TABLE #Month
	(
		[Month] DATE
	)

	DECLARE @i INT = 0
	WHILE(@i <= DATEDIFF(M,@SDate,@EDate))
	BEGIN			
		INSERT INTO #Month 
		SELECT DATEADD(M,DATEDIFF(M,0,DATEADD(M,@i,@SDate)),0)
		SET @i = @i+1
	END

	select @sdate = dbo.fn_Get_StartData('MTD')
	SEt @mdtsdate = CONVERT(char(10), @sdate, 103)
	--select @ydtsdate, @mdtsdate ,@eedate 
	
	--select * from #Month
	
	if object_id('tempdb..#tmp') is not null
		drop table #tmp;

	CREATE table #tmp
		(
			ClientCode varchar(50),
			ClientName varchar(max), 
			SchemeType varchar(50),
			SchemeName varchar(max),
			InvestmentType varchar(20),	
			TrxnDate date,
			FolioNo	varchar(50), 
			PurchaseNAV float,
			Units float,
			Amount float,
			GrossReceipt float,
			Commission float,
			RevenueType varchar(50)
		)

	insert into #tmp
	exec [MutualFund].[dbo].[usp_BillTransaction_Angel_ForIPartner] @AgentCode=@subBroker,@BillPeriodFrom=@ydtsdate,@BillPeriodTo =@eedate
	

	select CONVERT(VARCHAR(3),DATENAME(MONTH,M.[Month]))+''''+ RIGHT(YEAR(M.[Month]),2) AS [Month],
		isnull(sum(Commission) , 0) Commission
	from #Month M left join #tmp A
	on MONTH(M.[Month]) = MONTH(A.TrxnDate) 
	group by CONVERT(VARCHAR(3),DATENAME(MONTH,M.[Month]))+''''+ RIGHT(YEAR(M.[Month]),2),M.[Month] 
	order by M.[Month]
	--select * from #tmp order by TrxnDate
	
	declare @ytd_TotalBrokerage float
	select @ytd_TotalBrokerage = round(isnull(sum(Commission), 0), 4) from #tmp
	BEGIN
		truncate table #tmp; 
		
		insert into #tmp
		exec [MutualFund].[dbo].[usp_BillTransaction_Angel_ForIPartner] @AgentCode=@subBroker,@BillPeriodFrom=@mdtsdate,@BillPeriodTo =@eedate

		Select * INTO #tmp1 from #tmp

		truncate table #tmp
		insert into #tmp
		exec [MutualFund].[dbo].[usp_BillTransaction_Angel_ForIPartner] @AgentCode=@subBroker,@BillPeriodFrom=@ITDdate1,@BillPeriodTo =@eedate

				
		select @ytd_TotalBrokerage as TotalBrokerage, 'YTD' Period
		union
		select round(isnull(sum(Commission), 0), 4) TotalBrokerage, 'MTD' Period from #tmp1
		union
		select round(isnull(sum(Commission), 0), 4) TotalBrokerage, 'ITD' Period from #tmp
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MF_Dash_CommissionCount
-- --------------------------------------------------
CREATE PROCEDURE USP_MF_Dash_CommissionCount
(
	@SubBroker varchar(50) 
)
AS
---exec USP_MF_DASH_CommissionCount @SubBroker = 'ET'
BEGIN
	Select sum(Bd.PaidBrokMF) As Commission 
	from MutualFund.dbo.BrokerageDetail Bd WITH (NOLOCK)
	inner join MutualFund.dbo.BillSummary BS WITH (NOLOCK) 
	on BS.BillNo= Bd.BillNo  
	Where BS.AgentCode = @SubBroker
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_GetCLCount
-- --------------------------------------------------




/**************************************************************/
/*
	DATE:			3/16/2018
	AUTHOR:			Brijesh B
	DESCRIPTION:	
	EXEC dbo.usp_MF_Dash_GetCLCount 'AJYC', '2011-06-01', '2018-06-04'
	EXEC dbo.usp_MF_Dash_GetCLCount 'ET', '2017-04-01', '2018-03-27'
	EXEC dbo.usp_MF_Dash_GetCLCount 'ET', '2018-03-01', '2018-03-16'

*/	
/**************************************************************/
CREATE PROCEDURE [dbo].[usp_MF_Dash_GetCLCount]
	@SubBroker VARCHAR(10)
	,@SDate DATETIME
	,@EDate DATETIME
AS
BEGIN

	SET NOCOUNT ON

	;WITH Account AS
	(
		SELECT 
			COUNT(*) AS Ct
		FROM 
			sb_client_details SB WITH(NOLOCK)
		WHERE
			SB.sub_broker = @SubBroker
			--AND SB.B2C = 'N'
			AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN SB.B2C = 'N' THEN 1 ELSE 0 END
			AND SB.MF = 'Y'
			AND SB.first_active_date BETWEEN @SDate AND @EDate

	), ClientHavingPortfolio AS
	--(
	--	select COUNT(distinct partycode) Ct
	--	from [172.31.16.85].ABR_DW.dbo.IWMF_vw_ClientMFHoldings mf with(nolock)
	--	inner join sb_client_details cd on mf.partycode = cd.party_code
	--	where cd.sub_broker = @SubBroker
	--		--AND CD.B2C = 'N'
	--		AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN CD.B2C = 'N' THEN 1 ELSE 0 END
	--		AND CD.MF = 'Y'
	--	AND cd.first_active_date BETWEEN @SDate AND @EDate
	--),
	(select count(distinct existcode) ct from (
 SELECT  Td.InvestorCode as InvCode,im.FirstHolderName as InvName,td.schcode,im.ExistCode       
   --SUM(CASE sm.schemeclassdescription WHEN 'Equity' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS Equity,    
   --SUM(CASE sm.schemeclassdescription WHEN 'Debt' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS Debt,         
   --SUM(CASE sm.schemeclassdescription WHEN 'Liquid Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Liquid Fund],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Funds of Funds' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Funds of Funds],          
   --SUM(CASE sm.schemeclassdescription WHEN 'Gilt Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units END)*lnd.NavAmt ELSE 0 END) AS [Gilt Fund],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Dynamic Asset Allocation' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Dynamic Asset Allocation],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Special Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Special Fund],    
   --SUM(CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END) AS [Total]    
     FROM MUTUALFund.dbo.TransactionDetail td with(nolock)     
    Inner Join MUTUALFund.dbo.SchemeMaster sm with(nolock) On td.SchCode = sm.SchemeCode    
    Inner Join MUTUALFund.dbo.LatestNavDetails lnd with(nolock) On td.SchCode= lnd.SchemeCode    
    Inner Join MUTUALFund.dbo.InvestorMaster im with(nolock) On  td.InvestorCode=im.InvCode      
   INNER JOIN sb_client_details Sb WITH (NOLOCK) on Sb.party_code = IM.ExistCode
     where Td.InvestorCode In(select distinct investorcode from MUTUALFund.dbo.transactiondetail where agentcode=@SubBroker )    
     and ISNULL(td.RevTag, '') <> 'Y' and td.Units > 0          
	 AND td.trandate BETWEEN @SDate AND @EDate
	 and SB.first_active_date BETWEEN @SDate AND @EDate
     Group BY Td.InvestorCode,im.FirstHolderName,td.schcode,im.ExistCode        
     Having  SUM(CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)>0        

	 ) Main
	),
	
	
	 MFSegmentActive AS
	(
		select COUNT(DISTINCT mf.Party_Code) Ct  
		from [196.1.115.200].bsemfss.dbo.mfss_client mf with(nolock) 
		inner join sb_client_details cd WITH (NOLOCK) on mf.Party_Code = cd.party_code
		where cd.sub_broker = @SubBroker
			--AND CD.B2C = 'N'
			AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN CD.B2C = 'N' THEN 1 ELSE 0 END
			AND CD.MF = 'Y'
		and  mf.sub_broker = @SubBroker and inactive_from > GETDATE()
		AND active_from BETWEEN @SDate AND @EDate
	), RegisteredInMF AS
	( 
		SELECT 
			COUNT(*) AS Ct
		FROM 
			sb_client_details SB WITH(NOLOCK)
		WHERE
			SB.sub_broker = @SubBroker
			--AND SB.B2C = 'N'
			AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN SB.B2C = 'N' THEN 1 ELSE 0 END
			AND SB.MF = 'Y'
			AND SB.first_active_date BETWEEN @SDate AND @EDate
	), MFPortfolio AS
	--(
	--	SELECT 
	--		SUM(MF_AUM) AS Amount
	--	FROM 
	--		sb_client_details SB WITH(NOLOCK)
	--	WHERE
	--		SB.sub_broker = @SubBroker
	--		--AND SB.B2C = 'N'
	--		AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN SB.B2C = 'N' THEN 1 ELSE 0 END
	--		AND SB.MF = 'Y'
	--		AND SB.first_active_date BETWEEN @SDate AND @EDate
	--)
	(
	select SUM(MF_AUM) Amount from (
 SELECT  MF_AUM      
   --SUM(CASE sm.schemeclassdescription WHEN 'Equity' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS Equity,    
   --SUM(CASE sm.schemeclassdescription WHEN 'Debt' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS Debt,         
   --SUM(CASE sm.schemeclassdescription WHEN 'Liquid Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Liquid Fund],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Funds of Funds' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Funds of Funds],          
   --SUM(CASE sm.schemeclassdescription WHEN 'Gilt Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units END)*lnd.NavAmt ELSE 0 END) AS [Gilt Fund],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Dynamic Asset Allocation' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Dynamic Asset Allocation],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Special Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Special Fund],    
   --SUM(CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END) AS [Total]    
     FROM MUTUALFund.dbo.TransactionDetail td with(nolock)     
    Inner Join MUTUALFund.dbo.SchemeMaster sm with(nolock) On td.SchCode = sm.SchemeCode    
    Inner Join MUTUALFund.dbo.LatestNavDetails lnd with(nolock) On td.SchCode= lnd.SchemeCode    
    Inner Join MUTUALFund.dbo.InvestorMaster im with(nolock) On  td.InvestorCode=im.InvCode      
   INNER JOIN sb_client_details Sb WITH (NOLOCK) on Sb.party_code = IM.ExistCode
     where Td.InvestorCode In(select distinct investorcode from MUTUALFund.dbo.transactiondetail where agentcode=@SubBroker )    
     and ISNULL(td.RevTag, '') <> 'Y' and td.Units > 0          
	 AND td.trandate BETWEEN @SDate AND @EDate
	 and SB.first_active_date BETWEEN @SDate AND @EDate
     Group BY MF_AUM
     Having  SUM(CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)>0        

	 ) Main

	)

	
	SELECT A.Ct AS Account, C.Ct AS HavingPortfolio, M.Ct AS MFSegmentActive, R.Ct AS RegisteredInMF, isnull(P.Amount,0) AS MFPortfolioAmount
	FROM Account A, ClientHavingPortfolio C, MFSegmentActive M, RegisteredInMF R, MFPortfolio P

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_GetCLCount_Opti
-- --------------------------------------------------
/**************************************************************/
/*
	DATE:			3/16/2018
	AUTHOR:			Brijesh B
	DESCRIPTION:	
	EXEC dbo.usp_MF_Dash_GetCLCount 'EMT', '2017-06-01', '2018-05-25'
	EXEC dbo.usp_MF_Dash_GetCLCount 'ET', '2017-04-01', '2018-03-27'
	EXEC dbo.usp_MF_Dash_GetCLCount 'ET', '2018-03-01', '2018-03-16'

*/	
/**************************************************************/
Create  PROCEDURE [dbo].[usp_MF_Dash_GetCLCount_Opti]
	@SubBroker VARCHAR(10)
	,@SDate DATETIME
	,@EDate DATETIME
AS
BEGIN

	SET NOCOUNT ON

	;WITH Account AS
	(
		SELECT 
			COUNT(*) AS Ct
		FROM 
			sb_client_details SB WITH(NOLOCK)
		WHERE
			SB.sub_broker = @SubBroker
			--AND SB.B2C = 'N'
			AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN SB.B2C = 'N' THEN 1 ELSE 0 END
			AND SB.MF = 'Y'
			AND SB.first_active_date BETWEEN @SDate AND @EDate

	), ClientHavingPortfolio AS
	--(
	--	select COUNT(distinct partycode) Ct
	--	from [172.31.16.85].ABR_DW.dbo.IWMF_vw_ClientMFHoldings mf with(nolock)
	--	inner join sb_client_details cd on mf.partycode = cd.party_code
	--	where cd.sub_broker = @SubBroker
	--		--AND CD.B2C = 'N'
	--		AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN CD.B2C = 'N' THEN 1 ELSE 0 END
	--		AND CD.MF = 'Y'
	--	AND cd.first_active_date BETWEEN @SDate AND @EDate
	--),
	(select count(distinct existcode) ct from (
 SELECT  Td.InvestorCode as InvCode,im.FirstHolderName as InvName,td.schcode,im.ExistCode       
   --SUM(CASE sm.schemeclassdescription WHEN 'Equity' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS Equity,    
   --SUM(CASE sm.schemeclassdescription WHEN 'Debt' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS Debt,         
   --SUM(CASE sm.schemeclassdescription WHEN 'Liquid Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Liquid Fund],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Funds of Funds' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Funds of Funds],          
   --SUM(CASE sm.schemeclassdescription WHEN 'Gilt Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units END)*lnd.NavAmt ELSE 0 END) AS [Gilt Fund],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Dynamic Asset Allocation' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Dynamic Asset Allocation],    
   --SUM(CASE sm.schemeclassdescription WHEN 'Special Fund' THEN (CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)*lnd.NavAmt ELSE 0 END) AS [Special Fund],    
   --SUM(CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END) AS [Total]    
     FROM MUTUALFund.dbo.TransactionDetail td with(nolock)     
    Inner Join MUTUALFund.dbo.SchemeMaster sm with(nolock) On td.SchCode = sm.SchemeCode    
    Inner Join MUTUALFund.dbo.LatestNavDetails lnd with(nolock) On td.SchCode= lnd.SchemeCode    
    Inner Join MUTUALFund.dbo.InvestorMaster im with(nolock) On  td.InvestorCode=im.InvCode      
   INNER JOIN sb_client_details Sb on Sb.party_code = IM.ExistCode
     where Td.InvestorCode In(select distinct investorcode from MUTUALFund.dbo.transactiondetail where agentcode=@SubBroker )    
     and ISNULL(td.RevTag, '') <> 'Y' and td.Units > 0          
	 AND td.trandate BETWEEN @SDate AND @EDate
	 and SB.first_active_date BETWEEN @SDate AND @EDate
     Group BY Td.InvestorCode,im.FirstHolderName,td.schcode,im.ExistCode        
     Having  SUM(CASE WHEN td.trxntype in('Redemption','Switch out','Transfer out') Then -td.units Else td.units  END)>0        

	 ) Main
	),
	
	
	 MFSegmentActive AS
	(
		select COUNT(DISTINCT mf.Party_Code) Ct  
		from [196.1.115.200].bsemfss.dbo.mfss_client mf with(nolock) 
		inner join sb_client_details cd on mf.Party_Code = cd.party_code
		where cd.sub_broker = @SubBroker
			--AND CD.B2C = 'N'
			AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN CD.B2C = 'N' THEN 1 ELSE 0 END
			AND CD.MF = 'Y'
		and  mf.sub_broker = @SubBroker and inactive_from > GETDATE()
		AND active_from BETWEEN @SDate AND @EDate
	), RegisteredInMF AS
	( 
		SELECT 
			COUNT(*) AS Ct
		FROM 
			sb_client_details SB WITH(NOLOCK)
		WHERE
			SB.sub_broker = @SubBroker
			--AND SB.B2C = 'N'
			AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN SB.B2C = 'N' THEN 1 ELSE 0 END
			AND SB.MF = 'Y'
			AND SB.first_active_date BETWEEN @SDate AND @EDate
	), MFPortfolio AS
	(
		SELECT 
			SUM(MF_AUM) AS Amount
		FROM 
			sb_client_details SB WITH(NOLOCK)
		WHERE
			SB.sub_broker = @SubBroker
			--AND SB.B2C = 'N'
			AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN SB.B2C = 'N' THEN 1 ELSE 0 END
			AND SB.MF = 'Y'
			AND SB.first_active_date BETWEEN @SDate AND @EDate
	)
	SELECT A.Ct AS Account, C.Ct AS HavingPortfolio, M.Ct AS MFSegmentActive, R.Ct AS RegisteredInMF, isnull(P.Amount,0) AS MFPortfolioAmount
	FROM Account A, ClientHavingPortfolio C, MFSegmentActive M, RegisteredInMF R, MFPortfolio P

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_GetClientCounts
-- --------------------------------------------------


/**************************************************************/
/*
	DATE:			3/15/2018
	AUTHOR:			Brijesh B
	DESCRIPTION:	

	EXEC dbo.usp_MF_Dash_GetClientCounts 'EMT', 'All','ITD'
	--EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'All','ITD'
	

	EXEC dbo.usp_MF_Dash_GetClientCounts 'EMT', 'All', 'YTD'
	--EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'All', 'YTD'
	

	EXEC dbo.usp_MF_Dash_GetClientCounts 'ET', 'All', 'MTD'
	EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'All', 'MTD'



	EXEC dbo.usp_MF_Dash_GetClientCounts 'ET', 'SIP', 'ITD'
	EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'SIP', 'ITD'

	EXEC dbo.usp_MF_Dash_GetClientCounts 'ET', 'SIP', 'MTD'
	EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'SIP', 'MTD'
	
	EXEC dbo.usp_MF_Dash_GetClientCounts 'ET', 'SIP', 'MTD'
	EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'SIP', 'MTD'



	
	EXEC dbo.usp_MF_Dash_GetClientCounts 'ET', 'Lumpsum','ITD'
	EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'Lumpsum','ITD'


	EXEC dbo.usp_MF_Dash_GetClientCounts 'ET', 'Lumpsum', 'YTD'
	EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'Lumpsum', 'YTD'
	

	EXEC dbo.usp_MF_Dash_GetClientCounts 'ET', 'Lumpsum', 'MTD'
	EXEC dbo.[usp_MF_Dash_GetClientCounts_New] 'ET', 'Lumpsum', 'MTD'

	EXEC dbo.usp_MF_Dash_GetClientCounts 'EMT', 'All',null
*/	
/**************************************************************/
CREATE   PROCEDURE [dbo].[usp_MF_Dash_GetClientCounts]
	@SubBroker VARCHAR(10)
	,@ReportType VARCHAR(10) = 'All'
	,@Period VARCHAR(5) = NULL
AS
BEGIN

	SET NOCOUNT ON

	DECLARE @SDate DATETIME =  dbo.fn_Get_StartData('YTD')
	DECLARE @EDate DATETIME =  CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE()) + ' 23:59:59.997')
	DECLARE @MSDate DATETIME = dbo.fn_Get_StartData('MTD')
	DECLARE @IMSDate DATETIME = dbo.fn_Get_StartData('ITD')

	DECLARE @SDate1 DATE = CONVERT(DATE, @SDate)
	DECLARE @EDate1 DATE = CONVERT(DATE, @EDate)
	DECLARE @MSDate1 DATE = CONVERT(DATE, @MSDate)
	DECLARE @MSIDate1 DATE = CONVERT(DATE, @IMSDate)

	IF @ReportType = 'All'
	BEGIN
		
		IF @Period = 'YTD' OR @Period IS NULL
			EXEC dbo.usp_MF_Dash_GetCLCount @SubBroker, @SDate, @EDate
		
		IF @Period = 'MTD' OR @Period IS NULL
			EXEC dbo.usp_MF_Dash_GetCLCount @SubBroker, @MSDate, @EDate

		IF @Period = 'ITD' OR @Period IS NULL
			EXEC dbo.usp_MF_Dash_GetCLCount @SubBroker, @IMSDate, @EDate

	END

	ELSE IF @ReportType = 'SIP'
	BEGIN

		IF @Period = 'YTD' OR @Period IS NULL
			EXEC MutualFund.dbo.usp_SipDetailWithNewSIP_Angel_inhouse_MFNXT NULL,NULL,@SubBroker,NULL,NULL,NULL,@SDate,@EDate

		IF @Period = 'MTD' OR @Period IS NULL
			EXEC MutualFund.dbo.usp_SipDetailWithNewSIP_Angel_inhouse_MFNXT NULL,NULL,@SubBroker,NULL,NULL,NULL,@MSDate,@EDate

		IF @Period = 'ITD' OR @Period IS NULL
			EXEC MutualFund.dbo.usp_SipDetailWithNewSIP_Angel_inhouse_MFNXT NULL,NULL,@SubBroker,NULL,NULL,NULL,@IMSDate,@EDate

	END

	ELSE IF @ReportType = 'Lumpsum'
	BEGIN

		IF @Period = 'YTD' OR @Period IS NULL
			EXEC MutualFund.dbo.usp_LunmpSum_Angel_Inhouse_MFNXT NULL,NULL,@SubBroker,NULL,NULL,NULL,@SDate1,@EDate1

		IF @Period = 'MTD' OR @Period IS NULL
			EXEC MutualFund.dbo.usp_LunmpSum_Angel_Inhouse_MFNXT NULL,NULL,@SubBroker,NULL,NULL,NULL,@MSDate1,@EDate1

		IF @Period = 'ITD' OR @Period IS NULL
			EXEC MutualFund.dbo.usp_LunmpSum_Angel_Inhouse_MFNXT NULL,NULL,@SubBroker,NULL,NULL,NULL,@MSIDate1,@EDate1

	END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_GetClientCountsGraph
-- --------------------------------------------------

/**************************************************************/
/*
	DATE:			3/15/2018
	AUTHOR:			Brijesh B
	DESCRIPTION:	

	EXEC [dbo].[usp_MF_Dash_GetClientCountsGraph] 'EMT', 'All'
	EXEC [dbo].[usp_MF_Dash_GetClientCountsGraph] 'EMT', 'SIP'
	EXEC [dbo].[usp_MF_Dash_GetClientCountsGraph]  'EMT', 'Lumpsum'

*/	
/**************************************************************/
CREATE PROCEDURE [dbo].[usp_MF_Dash_GetClientCountsGraph]
	@SubBroker VARCHAR(10)
	,@ReportType VARCHAR(10) = 'All'
AS
BEGIN

	SET NOCOUNT ON

	DECLARE @SDate DATETIME =  dbo.fn_Get_StartData('YTD')
	DECLARE @EDate DATETIME =  CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE()) + ' 23:59:59.997')

	CREATE TABLE #Month
	(
		[Month] DATE
	)

	DECLARE @i INT = 0
	WHILE(@i <= DATEDIFF(M,@SDate,@EDate))
	BEGIN			
		INSERT INTO #Month 
		SELECT DATEADD(M,DATEDIFF(M,0,DATEADD(M,@i,@SDate)),0)
		SET @i = @i+1
	END

	/******************************************/
	-- All
	/******************************************/
	IF @ReportType = 'All'
	BEGIN

		SELECT
			CONVERT(VARCHAR(3),DATENAME(MONTH,M.[Month]))+''''+ RIGHT(YEAR(M.[Month]),2) AS [Month]
			,ISNULL(D.NoOfClients, 0) AS NoOfClients
		FROM
		#Month M
		LEFT JOIN (
				SELECT 
					DATEADD(M,DATEDIFF(M,0, first_active_date),0) AS [Month]
					,COUNT(*) AS NoOfClients
				FROM 
					sb_client_details SB WITH(NOLOCK)
				WHERE
					SB.sub_broker = @SubBroker
					--AND SB.B2C = 'N'
					AND 1 = CASE WHEN @SubBroker='EMT' THEN 1 WHEN SB.B2C = 'N' THEN 1 ELSE 0 END
					AND SB.MF = 'Y'
					AND SB.first_active_date BETWEEN @SDate AND @EDate
				GROUP BY 
						DATEADD(M,DATEDIFF(M,0, SB.first_active_date),0)
				) D
		ON M.[Month] = D.[Month]
		ORDER BY M.[Month]

	END
	
	/******************************************/
	-- SIP
	/******************************************/
	ELSE IF @ReportType = 'SIP'	
	BEGIN

		SELECT
			CONVERT(VARCHAR(3),DATENAME(MONTH,M.[Month]))+''''+ RIGHT(YEAR(M.[Month]),2) AS [Month]
			,ISNULL(D.NoOfClients, 0) AS NoOfClients
		FROM
		#Month M
		LEFT JOIN (
					SELECT
						DATEADD(M,DATEDIFF(M,0, RegistrationDate),0) AS [Month]
						,COUNT(DISTINCT InvCode) NoOfClients
					FROM
						(
							SELECT      
								MIN(sd.RegistrationDate) AS RegistrationDate
								,InvF.InvCode AS InvCode
							FROM 
								MutualFund.dbo.sipdetail sd with(nolock) 
								Inner join MutualFund.dbo.investorfolio InvF with(nolock) on sd.ProductCode=InvF.schemecode and sd.Foliono=InvF.foliono      
								INNER JOIN MutualFund.dbo.investormaster inv with(Nolock) on inv.invcode =  InvF.InvCode
								INNER JOIN dbo.sb_client_Details CD WITH(NOLOCK) ON inv.existcode = CD.party_code   
							WHERE 
								InvF.InvCode In (select Distinct InvCode from MutualFund.dbo.investormaster with(Nolock) Where AgentCode=@SubBroker)                  
								And sd.RegistrationDate Between IsNull(@SDate,sd.RegistrationDate) And IsNull(@EDate,sd.RegistrationDate)        
								and ToDate>GETDATE()
								AND CD.first_active_date BETWEEN @SDate AND @EDate
							GROUP BY 
								InvF.InvCode
						) S
					GROUP BY
						DATEADD(M,DATEDIFF(M,0, RegistrationDate),0)
				) D
		ON M.[Month] = D.[Month]
		ORDER BY M.[Month]
	
	END

	/******************************************/
	-- Lumpsum
	/******************************************/
	
	ELSE IF @ReportType = 'Lumpsum'	
	BEGIN

		SELECT
			CONVERT(VARCHAR(3),DATENAME(MONTH,M.[Month]))+''''+ RIGHT(YEAR(M.[Month]),2) AS [Month]
			,ISNULL(D.NoOfClients, 0) AS NoOfClients
		FROM
		#Month M
		LEFT JOIN (
					SELECT
						DATEADD(M,DATEDIFF(M,0, tranDate),0) AS [Month]
						,COUNT(DISTINCT InvestorCode) NoOfClients
					FROM
						(

							SELECT 
								MIN(sd.tranDate) AS tranDate
								,sd.InvestorCode
							FROM 
								MutualFund.dbo.transactiondetail sd WITH(NOLOCK)
								    Inner join MutualFund.dbo.investormaster inv with(nolock) on inv.invcode=sd.investorcode    
								Inner join MutualFund.dbo.schememaster sm with(nolock) on sm.schemecode=sd.schcode    
								Inner join MutualFund.dbo.mutfundmaster am with(nolock) on sm.amccode=am.mfcode
								INNER JOIN dbo.sb_client_Details CD WITH(NOLOCK) ON inv.existcode = CD.party_code
							WHERE 
								sd.tranDate Between IsNull(@SDate,sd.tranDate) And IsNull(@EDate,sd.tranDate) 
								and sd.agentcode = @SubBroker and trxntype in ('purchase','switch in','reinvestment','bonus','transfer in')
								  AND CD.first_active_date BETWEEN @SDate AND @EDate  
							GROUP BY
								InvestorCode

							) S
						GROUP BY
							DATEADD(M,DATEDIFF(M,0, tranDate),0)
				) D
		ON M.[Month] = D.[Month]
		ORDER BY M.[Month]

	END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_LUMPSUMClientCount
-- --------------------------------------------------

CREATE PROC [dbo].[usp_MF_Dash_LUMPSUMClientCount]
@SubBroker varchar(100)=NULL

AS

BEGIN

/*

declare @Sdate datetime = getdate()
EXEC [usp_MF_Dash_LUMPSUMClientCount] 'GDS'
select datediff(ms,@Sdate,GETDATE())


CREATED BY: PRASAD KHARADE

DESCRIPTION : GIVES COUNT OF LUMPSUM CLIENTS SUBBROKER WISE

EXECUTION PARAMETER: [usp_MF_Dash_LUMPSUMClientCount] 'GDS'
					 [usp_MF_Dash_LUMPSUMClientCount] 'EMT'
					 [usp_MF_Dash_LUMPSUMClientCount] 'ET'
 
*/



SET NOCOUNT ON

;WITH ResultCTE AS
(
	SELECT 
	s.sub_broker,
	Party_Code Client_Code--,
	,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM 
	sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE 
		S.sub_broker = @SubBroker or @SubBroker is null
	UNION
	SELECT 
			s.sub_broker,
			Party_Code Client_Code--,
			--Amount Cr_amt, 0 as dr_amt ,
			,CASE WHEN SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE 
	S.sub_broker = @SubBroker or @SubBroker is null
)
select sub_broker,COUNT(1) as LUMPSUMClientCount from ResultCTE 
WHere Investment_Type='LUMPSUM' 
GROUP by sub_broker


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_Dash_SIPClientCount
-- --------------------------------------------------

CREATE PROC usp_MF_Dash_SIPClientCount
@SubBroker varchar(100)=NULL

AS

BEGIN

/*
CREATED BY: PRASAD KHARADE

DESCRIPTION : GIVES COUNT OF SIP CLIENTS SUBBROKER WISE

EXECUTION PARAMETER: [usp_MF_Dash_SIPClientCount] 'GDS'
					 [usp_MF_Dash_SIPClientCount] 'EMT'
					 [usp_MF_Dash_SIPClientCount] 'ET'
 
*/



SET NOCOUNT ON

;WITH ResultCTE AS
(
	SELECT 
	s.sub_broker,
	Party_Code Client_Code--,
	,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM 
	sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE 
		S.sub_broker = @SubBroker or @SubBroker is null
	UNION
	SELECT 
			s.sub_broker,
			Party_Code Client_Code--,
			--Amount Cr_amt, 0 as dr_amt ,
			,CASE WHEN SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
	FROM sb_client_details S WITH (NOLOCK)
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
	ON s.party_code = TB.Clientcode 
	WHERE 
	S.sub_broker = @SubBroker or @SubBroker is null
)
select sub_broker,COUNT(1) as SIPClientCount from ResultCTE 
WHere Investment_Type='SIP' 
GROUP by sub_broker


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_Transaction
-- --------------------------------------------------

CREATE  Procedure [dbo].[Usp_MF_Dash_Transaction]
(
	@SubBroker Varchar(1000),
	@Period varchar(3)='YTD'
)

--EXEC Usp_MF_Dash_Transaction 'EMT','YTD'
--EXEC Usp_MF_Dash_Transaction_1 'CALNT','MTD'
as
Begin

SET NOCOUNT ON

Create Table #Temp
(
                SchemeClassDescription varchar(20)
)

Insert into #Temp 
select 'Equity'
UNION
select 'Debt'
UNION
select 'Liquid Fund'
UNION
select 'Others'
UNION
select 'Balanced Fund'
UNION
select 'ELSS'


Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()



	select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				INTO #PurchaseOther 
				from tbl_TransactionBuy_UniqueCode_syn VTB WITH (NOLOCK)
				Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
				ON SD.party_code=VTB.Clientcode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and sub_broker=@SubBroker 
		Group by SD.sub_broker,SchemeClassDescription,VTB.Amount,SubTranType

		--select * from #PurchaseOther


		select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 INTO #SalesOther 
				 from tbl_TransactionSale_UniqueCode_syn VTB WITH (NOLOCK)
				Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
				ON SD.party_code=VTB.Clientcode
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT IN ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='A100042' --and  
		sub_broker=@SubBroker 


 Select sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
Into #Purchase
 From 
 (
		select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,T.SchemeClassDescription as SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and sub_broker=@SubBroker 
		--party_code='A100042' --and  


		UNION 

		select 'Purchase' Status,@SubBroker,sum(PurchaseAmount),'others','' from #PurchaseOther
		
		
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
Into #Sale
 From 
 (
 select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB WITH (NOLOCK)
				Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
				ON SD.party_code=VTB.Clientcode
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='A100042' --and  
		sub_broker=@SubBroker 
		
		UNION

		select 'Sales' Status,@SubBroker,sum(SaleAmount),'others','' from #SalesOther

)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType



--Select sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
--Into #Purchase
-- From 
-- (

--SELECT 'Purchase' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) PurchaseAmount,
--				Case When SchemeClassDescription='Equity' Then 'Equity'
--				When SchemeClassDescription='Debt' Then 'Debt'
--				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
--				Else 'Others'
--				END SchemeClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

--		 from tbl_TransactionBuy_UniqueCode_syn VTB
--		Inner join [dbo].[sb_client_details] SD
--		ON SD.party_code=VTB.Clientcode
--		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
--		ON VTB.schcode=SM.SchemeCode
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker 
--		--and SubTranType in ('SIP','')
--		--and SchemeClassDescription='Equity'

--		UNION 
--		select 'Purchase' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) PurchaseAmount
--				,T.SchemeClassDescription as SchemeSubClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
--				 from tbl_TransactionBuy_UniqueCode_syn VTB
--				Inner join [dbo].[sb_client_details] SD
--				ON SD.party_code=VTB.Clientcode
--				 inner JOIN 
--        (
--                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
--                        from MutualFund.[dbo].schememaster sm  
--                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
--                        --UNION
--                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
--        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker --and 
--		--and SubTranType in ('SIP','')
--		--and  
--		--SchemeSubClassDescription = case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END
--)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType



--Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
--Into #Sale
-- From 
-- (
--SELECT 'Sale' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) SaleAmount,
--				Case When SchemeClassDescription='Equity' Then 'Equity'
--				When SchemeClassDescription='Debt' Then 'Debt'
--				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
--				Else 'Others'
--				END SchemeClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

--		 from tbl_TransactionSale_UniqueCode_syn VTB
--		 Inner join [dbo].[sb_client_details] SD
--		ON SD.party_code=VTB.Clientcode
--		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
--		ON VTB.schcode=SM.SchemeCode
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker 
--		--and SubTranType in ('SIP','')
--		--and SchemeClassDescription='Equity'

--		UNION 
--		select 'Sale' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) SaleAmount
--				--,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
--				--When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
--				--Else 'Others'
--				--END SchemeSubClassDescription
--				,T.SchemeClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
--				 from tbl_TransactionSale_UniqueCode_syn VTB
--				Inner join [dbo].[sb_client_details] SD
--				ON SD.party_code=VTB.Clientcode
--				 inner JOIN 
--        (
--                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
--                        from MutualFund.[dbo].schememaster sm  
--                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
--                        --UNION
--                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
--        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker 
--		--and SubTranType in ('SIP','')
--		--and  
--		----SchemeSubClassDescription IN ('ELSS','Balanced Fund')
--		--SchemeSubClassDescription = case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END
--)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


--Select * from #Purchase
--Select * from #Sale


Select @SubBroker AS sub_broker,iSNULL(P.PurchaseAmount,0) AS PurchaseAmount,ISNULL(S.SaleAmount,0) AS SaleAmount,t.SchemeClassDescription from 
#Temp t lEFT JOIN #Purchase P  on t.SchemeClassDescription = p.SchemeClassDescription
Left join #Sale S
ON P.sub_broker=S.sub_broker
and P.SchemeClassDescription=S.SchemeClassDescription
Drop table #Purchase
Drop table #Sale




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_Transaction_BKP_20180409
-- --------------------------------------------------

CREATE  Procedure [dbo].[Usp_MF_Dash_Transaction_BKP_20180409]
(
	@SubBroker Varchar(1000),
	@Period varchar(3)='YTD'
)

--EXEC Usp_MF_Dash_Transaction 'GDS','MTD'
as
Begin

Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()


Select sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
Into #Purchase
 From 
 (
SELECT 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount,
				Case When SchemeClassDescription='Equity' Then 'Equity'
				When SchemeClassDescription='Debt' Then 'Debt'
				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
				Else 'Others'
				END SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionBuy_UniqueCode_syn VTB
		Inner join [dbo].[sb_client_details] SD
		ON SD.party_code=VTB.Clientcode
		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
		ON VTB.schcode=SM.SchemeCode
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' --and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		and SchemeClassDescription='Equity'

		UNION 
		select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
				When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
				Else 'Others'
				END SchemeSubClassDescription

				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker and 
		--and SubTranType in ('SIP','')
		--and  
		SchemeSubClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType



Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
Into #Sale
 From 
 (
SELECT 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount,
				Case When SchemeClassDescription='Equity' Then 'Equity'
				When SchemeClassDescription='Debt' Then 'Debt'
				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
				Else 'Others'
				END SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionSale_UniqueCode_syn VTB
		 Inner join [dbo].[sb_client_details] SD
		ON SD.party_code=VTB.Clientcode
		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
		ON VTB.schcode=SM.SchemeCode
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		and SchemeClassDescription='Equity'

		UNION 
		select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
				When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
				Else 'Others'
				END SchemeSubClassDescription

				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		and  
		SchemeSubClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


--Select * from #Purchase
--Select * from #Sale


Select P.sub_broker,P.PurchaseAmount,S.SaleAmount,P.SchemeClassDescription from #Purchase P 
Left join #Sale S
ON P.sub_broker=S.sub_broker
and P.SchemeClassDescription=S.SchemeClassDescription
Drop table #Purchase
Drop table #Sale




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_Transaction_BKP_20180413
-- --------------------------------------------------

CREATE  Procedure [dbo].[Usp_MF_Dash_Transaction_BKP_20180413]
(
	@SubBroker Varchar(1000),
	@Period varchar(3)='YTD'
)

--EXEC Usp_MF_Dash_Transaction 'CALNT','MTD'
--EXEC Usp_MF_Dash_Transaction_1 'CALNT','MTD'
as
Begin

SET NOCOUNT ON

Create Table #Temp
(
                SchemeClassDescription varchar(20)
)

Insert into #Temp 
select 'Equity'
UNION
select 'Debt'
UNION
select 'Liquid Fund'
UNION
select 'Others'
UNION
select 'Balanced Fund'
UNION
select 'ELSS'


Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()


 Select sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
Into #Purchase
 From 
 (
		select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,T.SchemeClassDescription as SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and sub_broker=@SubBroker 
		--party_code='A100042' --and  


		UNION 

		select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,'Others' as SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='A100042' --and  
			sub_broker=@SubBroker --and 
		
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
Into #Sale
 From 
 (
 select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='A100042' --and  
		sub_broker=@SubBroker 
		
		UNION

		select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT IN ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='A100042' --and  
		sub_broker=@SubBroker 
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType



--Select sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
--Into #Purchase
-- From 
-- (

--SELECT 'Purchase' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) PurchaseAmount,
--				Case When SchemeClassDescription='Equity' Then 'Equity'
--				When SchemeClassDescription='Debt' Then 'Debt'
--				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
--				Else 'Others'
--				END SchemeClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

--		 from tbl_TransactionBuy_UniqueCode_syn VTB
--		Inner join [dbo].[sb_client_details] SD
--		ON SD.party_code=VTB.Clientcode
--		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
--		ON VTB.schcode=SM.SchemeCode
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker 
--		--and SubTranType in ('SIP','')
--		--and SchemeClassDescription='Equity'

--		UNION 
--		select 'Purchase' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) PurchaseAmount
--				,T.SchemeClassDescription as SchemeSubClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
--				 from tbl_TransactionBuy_UniqueCode_syn VTB
--				Inner join [dbo].[sb_client_details] SD
--				ON SD.party_code=VTB.Clientcode
--				 inner JOIN 
--        (
--                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
--                        from MutualFund.[dbo].schememaster sm  
--                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
--                        --UNION
--                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
--        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker --and 
--		--and SubTranType in ('SIP','')
--		--and  
--		--SchemeSubClassDescription = case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END
--)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType



--Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
--Into #Sale
-- From 
-- (
--SELECT 'Sale' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) SaleAmount,
--				Case When SchemeClassDescription='Equity' Then 'Equity'
--				When SchemeClassDescription='Debt' Then 'Debt'
--				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
--				Else 'Others'
--				END SchemeClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

--		 from tbl_TransactionSale_UniqueCode_syn VTB
--		 Inner join [dbo].[sb_client_details] SD
--		ON SD.party_code=VTB.Clientcode
--		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
--		ON VTB.schcode=SM.SchemeCode
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker 
--		--and SubTranType in ('SIP','')
--		--and SchemeClassDescription='Equity'

--		UNION 
--		select 'Sale' Status,
--				SD.sub_broker,
--				ISNULL(VTB.Amount,0) SaleAmount
--				--,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
--				--When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
--				--Else 'Others'
--				--END SchemeSubClassDescription
--				,T.SchemeClassDescription
--				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
--				 from tbl_TransactionSale_UniqueCode_syn VTB
--				Inner join [dbo].[sb_client_details] SD
--				ON SD.party_code=VTB.Clientcode
--				 inner JOIN 
--        (
--                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
--                        from MutualFund.[dbo].schememaster sm  
--                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
--                        --UNION
--                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
--        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
--		Where 
--		(tdate >=@StartDate and tdate < @EndDate )
--		and 
--		--party_code='A100042' --and  
--		sub_broker=@SubBroker 
--		--and SubTranType in ('SIP','')
--		--and  
--		----SchemeSubClassDescription IN ('ELSS','Balanced Fund')
--		--SchemeSubClassDescription = case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END
--)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


--Select * from #Purchase
--Select * from #Sale


Select @SubBroker AS sub_broker,iSNULL(P.PurchaseAmount,0) AS PurchaseAmount,ISNULL(S.SaleAmount,0) AS SaleAmount,t.SchemeClassDescription from 
#Temp t lEFT JOIN #Purchase P  on t.SchemeClassDescription = p.SchemeClassDescription
Left join #Sale S
ON P.sub_broker=S.sub_broker
and P.SchemeClassDescription=S.SchemeClassDescription
Drop table #Purchase
Drop table #Sale




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_Transaction_Opt
-- --------------------------------------------------

CREATE Procedure [dbo].[Usp_MF_Dash_Transaction_Opt]
(
	@SubBroker Varchar(1000),
	@Period varchar(3)='YTD'
)

--EXEC Usp_MF_Dash_Transaction 'CALNT','MTD'
--EXEC Usp_MF_Dash_Transaction_1 'CALNT','MTD'
/*

begin tran
declare @Sdate datetime = getdate()
EXEC Usp_MF_Dash_Transaction 'CALNT','YTD'
select datediff(ms,@Sdate,GETDATE())
rollback tran

*/
as
Begin

SET NOCOUNT ON


Create Table #Temp
(
                SchemeClassDescription varchar(20)
)

Insert into #Temp 
select 'Equity'
UNION
select 'Debt'
UNION
select 'Liquid Fund'
UNION
select 'Others'
UNION
select 'Balanced Fund'
UNION
select 'ELSS'


Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()

select substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code)) Scheme_CodeNew, Amount,sub_broker,tdate,SubTranType into #BuyTemp
from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
					Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and sub_broker=@SubBroker 


select substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code)) Scheme_CodeNew, Amount,sub_broker,tdate,SubTranType into #SaleTemp
		 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and sub_broker=@SubBroker 


 Select T.sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
Into #Purchase
 From 
 (
		select 'Purchase' Status,
				T.sub_broker,
				ISNULL(T.Amount,0) PurchaseAmount
				,T1.SchemeClassDescription as SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from #BuyTemp T
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
        ) T1 ON T1.SchemeCode =Scheme_CodeNew


		UNION 

			select 'Purchase' Status,
				T.sub_broker,
				ISNULL(T.Amount,0) PurchaseAmount
				,T1.SchemeClassDescription as SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from #BuyTemp T
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription not in ('Equity','Debt','Liquid Fund')
        ) T1 ON T1.SchemeCode =Scheme_CodeNew
	
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
Into #Sale
 From 
 (
 select 'Sale' Status,
				T2.sub_broker,
				ISNULL(T2.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from #SaleTemp T2
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =T2.Scheme_CodeNew
	
		UNION

		select 'Sale' Status,
				T2.sub_broker,
				ISNULL(T2.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from  #SaleTemp T2
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT IN ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =T2.Scheme_CodeNew
		
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


Select @SubBroker AS sub_broker,iSNULL(P.PurchaseAmount,0) AS PurchaseAmount,ISNULL(S.SaleAmount,0) AS SaleAmount,t.SchemeClassDescription from 
#Temp t LEFT JOIN #Purchase P  on t.SchemeClassDescription = p.SchemeClassDescription
Left join #Sale S
ON P.sub_broker=S.sub_broker
and P.SchemeClassDescription=S.SchemeClassDescription
Drop table #Purchase
Drop table #Sale

drop table #BuyTemp

drop table #SaleTemp


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_Transaction_Opt20180425
-- --------------------------------------------------


CREATE  Procedure [dbo].[Usp_MF_Dash_Transaction_Opt20180425]
(
	@SubBroker Varchar(20),
	@Period varchar(3)='YTD'
)

/*
SET STATISTICS IO ON;
SET STATISTICS TIME ON;
--EXEC Usp_MF_Dash_Transaction_Opt20180425 'EMT','YTD'
EXEC Usp_MF_Dash_Transaction_Opt20180425 'AHD','YTD'
SET STATISTICS IO OFF;
SET STATISTICS TIME OFF;
*/

--EXEC Usp_MF_Dash_Transaction_Opt20180425_1 'CALNT','MTD'
as
Begin

SET NOCOUNT ON

Create Table #Temp
(
                SchemeClassDescription varchar(20)
)

/*
Ashwini  
Query 1 :  cost 0%
*/

Insert into #Temp 
select 'Equity'
UNION
select 'Debt'
UNION
select 'Liquid Fund'
UNION
select 'Others'
UNION
select 'Balanced Fund'
UNION
select 'ELSS'


Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()

/*
Ashwini  
Query 2 :  cost 25%
*/
	select 'Purchase' Status, 
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				INTO #PurchaseOther 
				from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and sub_broker=@SubBroker 
		Group by SD.sub_broker,SchemeClassDescription,VTB.Amount,SubTranType

/*
Ashwini  
Query 3 :  cost 23%
*/
		select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 INTO #SalesOther 
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT IN ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		sub_broker=@SubBroker 

/*
Ashwini  
Query 4:  cost 26%
*/
 Select sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
Into #Purchase
 From 
 (
		select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,T.SchemeClassDescription as SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and sub_broker=@SubBroker 
		
		UNION ALL

		select 'Purchase' Status,@SubBroker,sum(PurchaseAmount),'others','' from #PurchaseOther
		
		
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType

/*
Ashwini  
Query 5 :  cost 25%
*/
Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
Into #Sale
 From 
 (
 select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		sub_broker=@SubBroker 
		
		UNION ALL

		select 'Sales' Status,@SubBroker,sum(SaleAmount),'others','' from #SalesOther

)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType

/*
Ashwini  
Query 6 :  cost 0%
*/
Select @SubBroker AS sub_broker,iSNULL(P.PurchaseAmount,0) AS PurchaseAmount,ISNULL(S.SaleAmount,0) AS SaleAmount,t.SchemeClassDescription from 
#Temp t lEFT JOIN #Purchase P  on t.SchemeClassDescription = p.SchemeClassDescription
Left join #Sale S
ON P.sub_broker=S.sub_broker
and P.SchemeClassDescription=S.SchemeClassDescription
Drop table #Purchase
Drop table #Sale

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_Transaction_Opti
-- --------------------------------------------------
--EXEC Usp_MF_Dash_Transaction 'CALNT','YTD'


CREATE  Procedure [dbo].[Usp_MF_Dash_Transaction_Opti]
(
	@SubBroker Varchar(1000),
	@Period varchar(3)='YTD'
)
--EXEC Usp_MF_Dash_Transaction 'CALNT','YTD'
--EXEC Usp_MF_Dash_Transaction 'EMT','YTD'
--EXEC Usp_MF_Dash_Transaction_1 'CALNT','MTD'
as
Begin

SET NOCOUNT ON

Create Table #Temp
(
                SchemeClassDescription varchar(20)
)

Insert into #Temp 
select 'Equity'
UNION
select 'Debt'
UNION
select 'Liquid Fund'
UNION
select 'Others'
UNION
select 'Balanced Fund'
UNION
select 'ELSS'


Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()

	select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				INTO #PurchaseOther 
				from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				and sub_broker=@SubBroker 
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		
		Group by SD.sub_broker,SchemeClassDescription,VTB.Amount,SubTranType

		--select * from #PurchaseOther


		select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 INTO #SalesOther 
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
					and sub_broker=@SubBroker 
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT IN ('Equity','Debt','Liquid Fund')
                        
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		--and sub_broker=@SubBroker 
		--party_code='A100042' --and  
		


 Select sub_broker,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
Into #Purchase
 From 
 (
		select 'Purchase' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) PurchaseAmount
				,T.SchemeClassDescription as SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
					and sub_broker=@SubBroker 
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
	
		--party_code='A100042' --and  


		UNION 

		select 'Purchase' Status,@SubBroker,sum(PurchaseAmount),'others','' from #PurchaseOther
		
		
)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


Select sub_broker,SUM(SaleAmount) SaleAmount,SchemeClassDescription
Into #Sale
 From 
 (
 select 'Sale' Status,
				SD.sub_broker,
				ISNULL(VTB.Amount,0) SaleAmount
				,T.SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
					and sub_broker=@SubBroker 
				 inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		--and 
		--sub_broker=@SubBroker 
		
		UNION

		select 'Sales' Status,@SubBroker,sum(SaleAmount),'others','' from #SalesOther

)T Group by sub_broker,SchemeClassDescription,Status--,SubTranType


Select @SubBroker AS sub_broker,iSNULL(P.PurchaseAmount,0) AS PurchaseAmount,ISNULL(S.SaleAmount,0) AS SaleAmount,t.SchemeClassDescription from 
#Temp t lEFT JOIN #Purchase P  on t.SchemeClassDescription = p.SchemeClassDescription
Left join #Sale S
ON P.sub_broker=S.sub_broker
and P.SchemeClassDescription=S.SchemeClassDescription
Drop table #Purchase
Drop table #Sale




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_TransactionTotal
-- --------------------------------------------------
CREATE Procedure [dbo].[Usp_MF_Dash_TransactionTotal]
(
	@SubBroker Varchar(1000),
	@Period Varchar(3)
)

--EXEC Usp_MF_Dash_TransactionTotal 'EMT','YTD'
--EXEC Usp_MF_Dash_Transaction 'EMT','YTD'
--EXEC Usp_MF_Dash_TransactionTotal_BKP_20180413 'EMT','YTD'
as
Begin

Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()



Select sub_broker,SUM(PurchaseAmount) PurchaseAmount
Into #Purchase
 From 
 (
SELECT 'Purchase' Status,
				SD.sub_broker,
				(VTB.Amount) PurchaseAmount,
				 SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionBuy_UniqueCode_syn VTB WITH (NOLOCK)
		Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
		ON SD.party_code=VTB.Clientcode
		--inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
		--ON VTB.schcode=SM.SchemeCode
		 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		--and SchemeClassDescription='Equity'

		UNION 
		select 'Purchase' Status,
				SD.sub_broker,
				(VTB.Amount) PurchaseAmount
				, SchemeClassDescription

				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB WITH (NOLOCK)
				Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
				ON SD.party_code=VTB.Clientcode
				--inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				--ON VTB.schcode=SM.SchemeCode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
			(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker
		--and SubTranType in ('SIP','')
		--and  T.SchemeClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,Status--,SubTranType



Select sub_broker,SUM(SaleAmount) SaleAmount
Into #Sale
 From 
 (
SELECT 'Sale' Status,
				SD.sub_broker,(VTB.Amount) SaleAmount,
				--Case When SchemeClassDescription='Equity' Then 'Equity'
				--When SchemeClassDescription='Debt' Then 'Debt'
				--When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
				--Else 'Others'
--				END 
				SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionSale_UniqueCode_syn VTB WITH (NOLOCK)
		Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
		ON SD.party_code=VTB.Clientcode
		 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription  in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
			(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker
		--and SubTranType in ('SIP','')
		--and SchemeClassDescription='Equity'

		UNION 
		select 'Sale' Status,
				SD.sub_broker,
				(VTB.Amount) SaleAmount
				--,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
				--When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
				--Else 'Others'
				--END SchemeSubClassDescription
				,SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB WITH (NOLOCK)
				Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
				ON SD.party_code=VTB.Clientcode
				 INNER JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm  
                        with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
			(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		--and  SchemeSubClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,Status--,SubTranType


--Select * from #Purchase
--Select * from #Sale


Select P.sub_broker,ISNULL(P.PurchaseAmount,0) PurchaseAmount,ISNULL(S.SaleAmount,0) SaleAmount ,
(ISNULL(P.PurchaseAmount,0)-ISNULL(S.SaleAmount,0)) AS 'NetSale'
from #Purchase P 
Left join #Sale S
ON P.sub_broker=S.sub_broker

Drop table #Purchase
Drop table #Sale




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_TransactionTotal_BKP_20180413
-- --------------------------------------------------
CREATE Procedure [dbo].[Usp_MF_Dash_TransactionTotal_BKP_20180413]
(
	@SubBroker Varchar(1000),
	@Period Varchar(3)
)

--Usp_MF_Dash_TransactionTotal 'GDS','MTD'
--Usp_MF_Dash_TransactionTotal 'ET','MTD'
as
Begin

Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()




Select sub_broker,SUM(PurchaseAmount) PurchaseAmount
Into #Purchase
 From 
 (
SELECT 'Purchase' Status,
				SD.sub_broker,
				(VTB.Amount) PurchaseAmount,
				Case When SchemeClassDescription='Equity' Then 'Equity'
				When SchemeClassDescription='Debt' Then 'Debt'
				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
				Else 'Others'
				END SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionBuy_UniqueCode_syn VTB
		Inner join [dbo].[sb_client_details] SD
		ON SD.party_code=VTB.Clientcode
		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
		ON VTB.schcode=SM.SchemeCode
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		--and SchemeClassDescription='Equity'

		UNION 
		select 'Purchase' Status,
				SD.sub_broker,
				(VTB.Amount) PurchaseAmount
				,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
				When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
				Else 'Others'
				END SchemeSubClassDescription

				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
		Where 
			(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker
		--and SubTranType in ('SIP','')
		and  SchemeSubClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,Status--,SubTranType



Select sub_broker,SUM(SaleAmount) SaleAmount
Into #Sale
 From 
 (
SELECT 'Sale' Status,
				SD.sub_broker,(VTB.Amount) SaleAmount,
				Case When SchemeClassDescription='Equity' Then 'Equity'
				When SchemeClassDescription='Debt' Then 'Debt'
				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
				Else 'Others'
				END SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionSale_UniqueCode_syn VTB
		Inner join [dbo].[sb_client_details] SD
		ON SD.party_code=VTB.Clientcode
		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
		ON VTB.schcode=SM.SchemeCode
		Where 
			(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker
		--and SubTranType in ('SIP','')
		--and SchemeClassDescription='Equity'

		UNION 
		select 'Sale' Status,
				SD.sub_broker,
				(VTB.Amount) SaleAmount
				,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
				When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
				Else 'Others'
				END SchemeSubClassDescription

				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB
				Inner join [dbo].[sb_client_details] SD
				ON SD.party_code=VTB.Clientcode
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
		Where 
			(tdate >=@StartDate and tdate < @EndDate )
		and 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		and  SchemeSubClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,Status--,SubTranType


--Select * from #Purchase
--Select * from #Sale


Select P.sub_broker,ISNULL(P.PurchaseAmount,0) PurchaseAmount,ISNULL(S.SaleAmount,0) SaleAmount ,
(ISNULL(P.PurchaseAmount,0)-ISNULL(S.SaleAmount,0)) AS 'NetSale'
from #Purchase P 
Left join #Sale S
ON P.sub_broker=S.sub_broker

Drop table #Purchase
Drop table #Sale




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_Dash_TransactionTotal_Opt20180425
-- --------------------------------------------------

CREATE Procedure [dbo].[Usp_MF_Dash_TransactionTotal_Opt20180425]
(
	@SubBroker Varchar(1000),
	@Period Varchar(3)
)

/*
SET STATISTICS TIME ON;
EXEC Usp_MF_Dash_TransactionTotal_Opt20180425 'AHD','YTD'
SET STATISTICS TIME OFF;
*/

--EXEC Usp_MF_Dash_Transaction_Opt20180425 'AHD','YTD'
--EXEC Usp_MF_Dash_TransactionTotal_Opt20180425_BKP_20180413 'EMT','YTD'
as
Begin

SET NOCOUNT ON;

Declare @StartDate Date
Declare @EndDate Date

Select @StartDate=dbo.fn_Get_StartData(@Period),@EndDate=Getdate()

Select 
--sub_broker,
SUM(PurchaseAmount) PurchaseAmount
Into #Purchase
From 
(
		SELECT 
			--'Purchase' Status,
			--SD.sub_broker,
		(VTB.Amount) PurchaseAmount
			--,SchemeClassDescription
			--,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
		from tbl_TransactionBuy_UniqueCode_syn VTB
		Inner join [dbo].[sb_client_details] SD
		ON SD.party_code=VTB.Clientcode
		INNER JOIN 
		MutualFund.[dbo].schememaster sm
		ON sm.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))

			--(
			--		select 
			--		--SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,
			--		SchemeCode         
			--		from MutualFund.[dbo].schememaster sm  
			--		with (nolock) --where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
			--) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and  sub_broker=@SubBroker 
			--UNION ALL
			--	select 
			--	'Purchase' Status,
			--		SD.sub_broker,
			--		(VTB.Amount) PurchaseAmount
			--		, SchemeClassDescription
			--		,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
			--			from tbl_TransactionBuy_UniqueCode_syn VTB
			--		Inner join [dbo].[sb_client_details] SD
			--		ON SD.party_code=VTB.Clientcode
			--			INNER JOIN 
			--	(
			--			select 
			--			SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
			--			from MutualFund.[dbo].schememaster sm  
			--			with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')                       
			--	) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
			--Where 
			--	(tdate >=@StartDate and tdate < @EndDate )
			--and sub_broker=@SubBroker
)T 
--Group by sub_broker,Status

Select 
--sub_broker,
SUM(SaleAmount) SaleAmount
Into #Sale
From 
(
		SELECT 
		'Sale' Status,
				--SD.sub_broker,
		(VTB.Amount) SaleAmount
				--,SchemeClassDescription
				--,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
		from tbl_TransactionSale_UniqueCode_syn VTB
		Inner join [dbo].[sb_client_details] SD
		ON SD.party_code=VTB.Clientcode
		INNER JOIN 
		MutualFund.[dbo].schememaster sm
		ON sm.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
				--     (
				--                     select 
				--			--SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,
				--			SchemeCode         
				--                     from MutualFund.[dbo].schememaster sm  
				--                     with (nolock) --where SchemeClassDescription  in ('Equity','Debt','Liquid Fund')
				--     ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
		Where 
		(tdate >=@StartDate and tdate < @EndDate )
		and  
		sub_broker=@SubBroker
				--UNION ALL
				--select 
				--'Sale' Status,
				--		SD.sub_broker,
				--		(VTB.Amount) SaleAmount
				--		,SchemeClassDescription
				--		,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				--		 from tbl_TransactionSale_UniqueCode_syn VTB
				--		Inner join [dbo].[sb_client_details] SD
				--		ON SD.party_code=VTB.Clientcode
				--		 INNER JOIN 
				--      (
				--                      select 
				--				SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,
				--				SchemeCode         
				--                      from MutualFund.[dbo].schememaster sm  
				--                      with (nolock) where SchemeClassDescription NOT in ('Equity','Debt','Liquid Fund')                       
				--      ) T ON T.SchemeCode =substring(VTB.Scheme_Code,2,len(VTB.Scheme_Code))
				--Where 
				--	(tdate >=@StartDate and tdate < @EndDate )
				--and 
				--sub_broker=@SubBroker 
)T 
--Group by sub_broker,Status

select @SubBroker, ISNULL(P.PurchaseAmount,0) PurchaseAmount,ISNULL(S.SaleAmount,0) SaleAmount ,
(ISNULL(P.PurchaseAmount,0)-ISNULL(S.SaleAmount,0)) AS 'NetSale'
from #Purchase P , #Sale S

--Select P.sub_broker,ISNULL(P.PurchaseAmount,0) PurchaseAmount,ISNULL(S.SaleAmount,0) SaleAmount ,
--(ISNULL(P.PurchaseAmount,0)-ISNULL(S.SaleAmount,0)) AS 'NetSale'
--from #Purchase P 
--Left join #Sale S
--ON P.sub_broker=S.sub_broker

Drop table #Purchase
Drop table #Sale

SET NOCOUNT OFF;
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_GetSBBankDetail
-- --------------------------------------------------

/**************************************************************/
/*
	DATE:			3/28/2018
	AUTHOR:			Brijesh B
	DESCRIPTION:	

	EXEC dbo.usp_MF_GetSBBankDetail 'KKGR'

*/	
/**************************************************************/
CREATE PROCEDURE dbo.usp_MF_GetSBBankDetail
	@SubBroker VARCHAR(10)
AS
BEGIN
	SET NOCOUNT ON

	SELECT
		BM.BankName
		,AM.BankAccNo
		,MICRCode
		,BM.[Status]
	FROM
		MutualFund.dbo.AgentMaster AM WITH(NOLOCK)
		JOIN MutualFund.dbo.BankMaster BM WITH(NOLOCK) ON AM.BankId = BM.BankId
	WHERE 
		AM.existcode = @SubBroker

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_IPartner_SubBrokerView_RevenueDetails
-- --------------------------------------------------

-- =============================================
-- Author:		Sharad Patil
-- Create date: 04-APRIL-2018
-- Description:	

-- EXEC [Usp_MF_IPartner_SubBrokerView_RevenueDetails] 'KGD' 
-- EXEC [Usp_MF_IPartner_SubBrokerView_RevenueDetails] 'EMT'

/*

--CREATE NONCLUSTERED INDEX IDX_SchemeMaster_SchemeSubClassDescription
--ON [dbo].[SchemeMaster] ([SchemeSubClassDescription])

declare @Sdate datetime = getdate()
 EXEC [Usp_MF_IPartner_SubBrokerView_RevenueDetails] 'KGD' 
select datediff(ms,@Sdate,GETDATE())

*/

--CREATE NONCLUSTERED INDEX IDX_sb_client_details_cl_code ON sb_client_details (Cl_code)

-- =============================================

CREATE PROCEDURE [dbo].[Usp_MF_IPartner_SubBrokerView_RevenueDetails]
(
 @subBroker VARCHAR(50)
)

 AS
 BEGIN

 SET NOCOUNT ON
 
 DECLARE @YTDStartDate DATE 
 DECLARE @MTDStartDate DATE 
 DECLARE @ENDDate DATE 

 
 Select @YTDStartDate=dbo.fn_Get_StartData('YTD'),@MTDStartDate=dbo.fn_Get_StartData('MTD'),@EndDate=cast(Getdate() as date)


 	
	CREATE TABLE #temp
(
	Order_By Varchar(2),
	SchemeClassDescriptiON VARCHAR(100)
)

INSERT INTO #temp
--SELECT SchemeClassDescriptiON 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON in ('Equity','Debt','Liquid Fund')
select '1' Order_By,'Equity' 
UNION 
select '2' Order_By,'Debt'
UNION 
select '4' Order_By,'Liquid Fund'
UNION
--SELECT SchemeSubClassDescriptiON  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON IN ('ELSS','Balanced Fund')
select '3' Order_By,'ELSS'
UNION
select '5' Order_By,'Balanced Fund'
UNION
SELECT '6' Order_By, 'Other'

--SELECT * from #temp
 
SELECT 
		BS.AgentCode AS sub_broker,
		TR.TRandate,
		TR.SchCode,
		Bd.PaidBrokMF  AS YTD_NettoSB_Revenue --, Bt.BrokTypeDesc AS [Revenue Type]
     INTO #Data
	   FROM MutualFund.[dbo].TRansactiondetail TR WITH (NOLOCK)
        INNER JOIN MutualFund.[dbo].BrokerageDetail Bd WITH (NOLOCK) ON  TR.TranCode=Bd.TranCode  
        INNER JOIN MutualFund.[dbo].BillSummary BS WITH (NOLOCK) ON BS.BillNo= Bd.BillNo  

        WHERE BS.AgentCode=@subBroker
		and CAST(TR.TRandate AS DATE) BETWEEN @YTDStartDate and @ENDDate

		CREATE INDEX IDX_#Data_sub_broker ON #Data (sub_broker)
		CREATE INDEX IDX_#Data_TRandate ON #Data (TRandate)
		CREATE INDEX IDX_#Data_SchCode ON #Data (SchCode)
		CREATE INDEX IDX_#temp_SchCode ON #temp (SchemeClassDescription)


SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode INTO #schememaster from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode INTO #schememaster1 from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  NOT in ('Equity','Debt','Liquid Fund')


 ;WITH YTDRevenue
		AS
		(			
	SELECT sub_broker,SchemeClassDescription,sum(YTD_NettoSB_Revenue) AS YTD_NettoSB_Revenue from #Data TR
		   		INNER JOIN 
	--(
	--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
	--		--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON = 'ELSS' THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON in ('Equity','Debt','Liquid Fund')
	--		--UNION
	--		--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON IN ('Balanced Fund')
	--) TT ON TT.SchemeCode =TR.SchCode
	#schememaster TT on TT.SchemeCode = TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @YTDStartDate and @ENDDate
	GROUP BY SchemeClassDescription,sub_broker

	UNION

		SELECT sub_broker,'OTHER' AS SchemeClassDescriptiON ,sum(YTD_NettoSB_Revenue) from #Data TR
		   		INNER JOIN 
	--(
	--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  NOT in ('Equity','Debt','Liquid Fund')
	--		--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON = 'ELSS' THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON NOT in ('Equity','Debt','Liquid Fund')
	--		--UNION
	--		--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON IN ('Balanced Fund')
	--) TT ON TT.SchemeCode =TR.SchCode
	#schememaster1 TT on TT.SchemeCode = TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @YTDStartDate and @ENDDate
	GROUP BY sub_broker
		
	)		,
			
			MTDRevenue
		As
		(
	
	SELECT sub_broker,SchemeClassDescription,sum(YTD_NettoSB_Revenue) AS MTD_NettoSB_Revenue from #Data TR
		   		INNER JOIN 
	--(
	--		SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
	--		--UNION
	--		--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON NOT IN ('Balanced Fund')
	--) TT ON TT.SchemeCode =TR.SchCode
	#schememaster TT on TT.SchemeCode = TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @MTDStartDate and @ENDDate
	GROUP BY SchemeClassDescription,sub_broker

	UNION

		SELECT sub_broker,'OTHER' AS SchemeClassDescriptiON ,sum(YTD_NettoSB_Revenue) from #Data TR
	INNER JOIN 
	--(
	--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  NOT in ('Equity','Debt','Liquid Fund')
	--		--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON = 'ELSS' THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON NOT in ('Equity','Debt','Liquid Fund')
	--		--UNION
	--		--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON NOT IN ('Balanced Fund')
	--) TT ON TT.SchemeCode =TR.SchCode
	#schememaster TT on TT.SchemeCode = TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @MTDStartDate and @ENDDate
	GROUP BY sub_broker

)

	SELECT	 @subBroker AS Sub_broker
				,T.SchemeClassDescriptiON AS Segment
				,CONVERT(DECIMAL(20,2),ROUND(ISNULL(Y.YTD_NettoSB_Revenue,0),2)) AS YTD_SB_Revenue
				,CONVERT(DECIMAL(20,2),ROUND(ISNULL(M.MTD_NettoSB_Revenue,0),2)) AS MTD_SB_Revenue
			
		FROM #temp T
		LEFT JOIN YTDRevenue Y ON Y.SchemeClassDescriptiON = T.SchemeClassDescription
		LEFT JOIN MTDRevenue M 	ON Y.sub_broker= M.sub_broker AND Y.SchemeClassDescription= M.SchemeClassDescription
		Order by Order_By

	DROP table #Data
	
	DROP table #temp
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_NXT_SubBrokerTotalAUM
-- --------------------------------------------------

CREATE  PROC [dbo].[usp_MF_NXT_SubBrokerTotalAUM]
	(
	@Sub_Broker Varchar(100)='EMT',
	@Period Varchar(10)='YTD'
	)
	
	as
	begin 

	--exec [usp_MF_NXT_SubBrokerTotalAUM]
	
		DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

		CREATE table #tmp_aum_cnt
	(
		fund_code varchar(50),
		schemename varchar(200),
		--subbroker varchar(50),
		Total float,
		InvestmentAmount float,
		Type_of_Fund varchar (30),
		Total_Clients INT
		

	)
	---Aum Count
	insert into #tmp_aum_cnt
	exec [dbo].[Usp_GetFundWiseSchemeWiseAll_Count] @Sub_Broker,@Period

	select 'AUM' as Header,@Sub_Broker as Sub_Broker ,Total as Total_AUM from #tmp_aum_cnt
	where fund_code = 'Grand Total'

	--[usp_MF_NXT_SubBrokerTotalAUM] @Sub_Broker ='EMT'
	
	--SELECT 	
	--'AUM' header,
	--@Sub_Broker Sub_Broker ,
	--SUM(ISNULL(Angel_Qty,0)*ISNULL(LastNAVPrice,0)) 'Total_AUM'
	--		--,T.SchemeClassDescription 'Type_of_Fund' 
	--		--,(SB.party_Code) 'Total'
	--		--,SUM(ISNULL(Angel_Qty,0)*ISNULL(avg_rate,0)) 'InvestmentAmount'
	-- FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	--INNER JOIN sb_client_details SB
	--ON HLDG.party_Code=SB.party_Code
	----INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	----ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	----WHERE ISNULL(HLDG.fund_code,'')<>''
	----Inner join MutualFund.dbo.transactiondetail td with (nolock)
	----ON td.AgentCode=SB.sub_broker
	
	--WHERE SB.sub_broker=@Sub_Broker
	--and first_active_date between @SDate and @EDate
	--GROUP BY SB.sub_broker
	
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_NXT_SubBrokerTotalAUM_25May2018
-- --------------------------------------------------

CREATE PROC [dbo].[usp_MF_NXT_SubBrokerTotalAUM_25May2018]
	(
	@Sub_Broker Varchar(100)='EMT',
	@Period Varchar(10)='YTD'
	)
	
	as
	begin 

	--exec [usp_MF_NXT_SubBrokerTotalAUM_1] 'EMT','YTD'
	
		DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

		CREATE table #tmp_aum_cnt
	(
		fund_code varchar(50),
		schemename varchar(200),
		--subbroker varchar(50),
		Total float,
		InvestmentAmount float,
		Type_of_Fund varchar (30),
		Total_Clients INT
		

	)
	---Aum Count
	insert into #tmp_aum_cnt
	exec [dbo].[Usp_GetFundWiseSchemeWiseAll_Count] @Sub_Broker,@Period
	--select '#tmp_aum_cnt' ,* from #tmp_aum_cnt
	if object_id('tempdb..##Main') is not null
		drop table ##Main;

	select 'AUM' as Header,@Sub_Broker as Sub_Broker ,Total as Total_AUM INTO ##Main from #tmp_aum_cnt
	where fund_code = 'Grand Total'

	--[usp_MF_NXT_SubBrokerTotalAUM] @Sub_Broker ='EMT'
	
	--SELECT 	
	--'AUM' header,
	--@Sub_Broker Sub_Broker ,
	--SUM(ISNULL(Angel_Qty,0)*ISNULL(LastNAVPrice,0)) 'Total_AUM'
	--		--,T.SchemeClassDescription 'Type_of_Fund' 
	--		--,(SB.party_Code) 'Total'
	--		--,SUM(ISNULL(Angel_Qty,0)*ISNULL(avg_rate,0)) 'InvestmentAmount'
	-- FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	--INNER JOIN sb_client_details SB
	--ON HLDG.party_Code=SB.party_Code
	----INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	----ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	----WHERE ISNULL(HLDG.fund_code,'')<>''
	----Inner join MutualFund.dbo.transactiondetail td with (nolock)
	----ON td.AgentCode=SB.sub_broker
	
	--WHERE SB.sub_broker=@Sub_Broker
	--and first_active_date between @SDate and @EDate
	--GROUP BY SB.sub_broker
	
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MF_NXT_SubBrokerTotalAUM_bkp_2018May10
-- --------------------------------------------------

CREATE  PROC [dbo].[usp_MF_NXT_SubBrokerTotalAUM_bkp_2018May10]
	(
	@Sub_Broker Varchar(100)='EMT',
	@Period Varchar(10)='YTD'
	)
	
	as
	begin 

	--exec [usp_MF_NXT_SubBrokerTotalAUM]
	
		DECLARE @SDate DATETIME =  dbo.fn_Get_StartData(@Period)
		DECLARE @EDate DATETIME =  convert(date,Getdate())

	--	CREATE table #tmp_aum_cnt
	--(
	--	fund_code varchar(50),
	--	schemename varchar(200),
	--	--subbroker varchar(50),
	--	Total float,
	--	InvestmentAmount float,
	--	Type_of_Fund varchar (30),
	--	Total_Clients INT
		

	--)
	-----Aum Count
	--insert into #tmp_aum_cnt
	--exec [dbo].[Usp_GetFundWiseSchemeWiseAll_Count] @Sub_Broker,@Period

	--select 'AUM' as Header,@Sub_Broker as Sub_Broker ,Total as Total_AUM from #tmp_aum_cnt
	--where fund_code = 'Grand Total'

	--[usp_MF_NXT_SubBrokerTotalAUM] @Sub_Broker ='EMT'
	
	SELECT 	
	'AUM' header,
	@Sub_Broker Sub_Broker ,
	SUM(ISNULL(Angel_Qty,0)*ISNULL(LastNAVPrice,0)) 'Total_AUM'
			--,T.SchemeClassDescription 'Type_of_Fund' 
			--,(SB.party_Code) 'Total'
			--,SUM(ISNULL(Angel_Qty,0)*ISNULL(avg_rate,0)) 'InvestmentAmount'
	 FROM IWMF_trn_current_holding_syn HLDG with (nolock)
	INNER JOIN sb_client_details SB
	ON HLDG.party_Code=SB.party_Code
	--INNER JOIN MutualFund.[dbo].schememaster sm  with (nolock)
	--ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=sm.SchemeCode
	--WHERE ISNULL(HLDG.fund_code,'')<>''
	--Inner join MutualFund.dbo.transactiondetail td with (nolock)
	--ON td.AgentCode=SB.sub_broker
	
	WHERE SB.sub_broker=@Sub_Broker
	and first_active_date between @SDate and @EDate
	GROUP BY SB.sub_broker
	
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MF_OneClientView_MandateDetails
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_MF_OneClientView_MandateDetails]
(@sClientCode VARCHAR(200))
AS
BEGIN 
--EXEC USP_MF_OneClientView_MandateDetails 'rp61'
--declare @sClientCode VARCHAR(200) = 'rp61'
SELECT 
	  [sClientCode]
	  ,isnull([sMandateID], '') sMandateID
      ,isnull([sMandateRefNo], '-') [sMandateRefNo]
	  ,[sAccountNo]
      ,[dStartDate] as dRegistrationDate
      ,[dEndDate]
      ,[nAmount]
      ,[sBankName]
	  ,'' as sIfscCode
      ,[sMandateStatus]
      ,[sUserType]
      ,[InsertedOn]
      ,dEndDate

  FROM [196.1.115.132].[MUTUALFUND].[dbo].[tblSipMandateDetails] with (nolock)
  where [sClientCode]=@sClientCode
 
 UNION 
  
 SELECT 
	 sClientCode
	 ,isnull([sMandateID], '') sMandateID
	 ,isnull([sMandateRefNo], '-') sMandateRefNo
	 ,[sAccountNo]
	 ,dRegistrationDate
	 ,''
	 ,nAmount
	 ,sBANKNAME
	 ,isnull(sIfscCode,'')
	 ,sMANDATESTATUS
	 ,''
	, dInsertedOn
	,dRegistrationDate

  FROM [196.1.115.132].[MUTUALFUND].[dbo].[TBLXSIPMANDATEDetails] with (nolock)
  where sClientCode=@sClientCode 


/*
SELECT 
	  [sClientCode]
      ,[sMandateRefNo]
      ,[dStartDate] ---Registration Date
      ,[dEndDate]
      ,[nAmount]
      ,[sBankName]
      ,[sMandateStatus]
      ,[sUserType]
      ,[InsertedOn]
      ,dEndDate

  FROM [196.1.115.132].[MUTUALFUND].[dbo].[tblSipMandateDetails] with (nolock)
  where [sClientCode]=@sClientCode
 
 UNION 
  
 SELECT 
	 sClientCode
	 ,sMandateRefNo
	 ,dRegistrationDate
	 ,''
	 ,nAmount
	 ,sBANKNAME
	 ,sMANDATESTATUS
	 ,''
	, dInsertedOn
	,dRegistrationDate

  FROM [196.1.115.132].[MUTUALFUND].[dbo].[TBLXSIPMANDATEDetails] with (nolock)
  where sClientCode=@sClientCode 
  */
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_OneClientView_Transaction_PartyCodeWise
-- --------------------------------------------------


CREATE Procedure [dbo].[Usp_MF_OneClientView_Transaction_PartyCodeWise]
(
	@PartyCode Varchar(1000)
	--,@Period varchar(3)='YTD'
)
--EXEC [Usp_MF_OneClientView_Transaction_PartyCodeWise] 'A100042'
as
Begin



Create Table #Temp
(
                SchemeClassDescription varchar(20)
)

Insert into #Temp 
select 'Equity'
UNION
select 'Debt'
UNION
select 'Liquid Fund'
UNION
select 'Others'
UNION
select 'Balanced Fund'
UNION
select 'ELSS'

Select PartyCode,SUM(PurchaseAmount) PurchaseAmount,SchemeClassDescription
Into #Purchase
 From 
 (
SELECT 'Purchase' Status,
                                @PartyCode PartyCode,
                                sum(Angel_Qty*avg_rate) PurchaseAmount,
                                Case When T.SchemeClassDescription='Equity' Then 'Equity'
                                When T.SchemeClassDescription='Debt' Then 'Debt'
                                When T.SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
                                Else 'Others'
                                END SchemeClassDescription
                                --,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

                 from IWMF_trn_current_holding_syn HLDG with (NOLOCK)
                Inner join [dbo].[sb_client_details] SD with (NOLOCK)
                ON SD.party_code=HLDG.party_Code
                --inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
                --ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=SM.SchemeCode
                inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         
                        from MutualFund.[dbo].schememaster sm   
                        with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
                Where 
                --(tdate >=@StartDate and tdate < @EndDate )
                --and 
                HLDG.party_code=@PartyCode --and  
                --sub_broker=@SubBroker 
                --and SubTranType in ('SIP','')
                --and T.SchemeClassDescription='Equity'
                group by T.SchemeClassDescription

                UNION 

                select 'Purchase' Status,
                                @PartyCode,
                                sum(Angel_Qty*avg_rate) PurchaseAmount
                                ,Case When T.SchemeSubClassDescription='ELSS' Then 'ELSS'
                                When T.SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
                                Else 'Others'
                                END SchemeSubClassDescription

                                --,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
                                 from IWMF_trn_current_holding_syn HLDG with (NOLOCK)
                                Inner join [dbo].[sb_client_details] SD with (NOLOCK)
                                ON SD.party_code=HLDG.party_Code
                                --inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
                                --ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=SM.SchemeCode
                                inner JOIN 
        (
                        
                        select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
                Where 
                --(tdate >=@StartDate and tdate < @EndDate )
                --and 
                HLDG.party_code=@PartyCode-- and  
                --sub_broker=@SubBroker and 
                --and SubTranType in ('SIP','')
                --and  
                --T.SchemeSubClassDescription IN ('ELSS','Balanced Fund')
                group by T.SchemeSubClassDescription
)T Group by PartyCode,T.SchemeClassDescription,Status--,SubTranType

--select * from #Purchase

Select PartyCode,SUM(SaleAmount) SaleAmount,SchemeClassDescription
Into #Sale
 From 
 (
SELECT 'Sale' Status,
                                @PartyCode PartyCode,
                                sum(Angel_Qty*LastNAVPrice) SaleAmount,
                                Case When T.SchemeClassDescription='Equity' Then 'Equity'
                                When T.SchemeClassDescription='Debt' Then 'Debt'
                                When T.SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
                                Else 'Others'
                                END SchemeClassDescription
                                --,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

                 from IWMF_trn_current_holding_syn HLDG with (NOLOCK)
                 Inner join [dbo].[sb_client_details] SD with (NOLOCK)
                ON SD.party_code=HLDG.party_Code
                --inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
                --ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=SM.SchemeCode
                inner JOIN 
        (
                        select SchemeClassDescription=case when SchemeSubClassDescription in ('ELSS','Balanced Fund') then SchemeSubClassDescription else SchemeClassDescription END,SchemeCode         from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeClassDescription in ('Equity','Debt','Liquid Fund')
                        --UNION
                        --select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
                Where 
                --(tdate >=@StartDate and tdate < @EndDate )
                --and 
                HLDG.party_code=@PartyCode --and  
                --sub_broker=@SubBroker 
                --and SubTranType in ('SIP','')
                --and T.SchemeClassDescription='Equity'
                Group by T.SchemeClassDescription

                UNION 
                select 'Sale' Status,
                                @PartyCode,
                                sum(Angel_Qty*LastNAVPrice) SaleAmount
                                ,Case When T.SchemeSubClassDescription='ELSS' Then 'ELSS'
                                When T.SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
                                Else 'Others'
                                END SchemeSubClassDescription

                                --,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
                                 from IWMF_trn_current_holding_syn HLDG with (NOLOCK)
                                Inner join [dbo].[sb_client_details] SD with (NOLOCK)
                                ON SD.party_code=HLDG.party_Code
                                --inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
                                --ON substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))=SM.SchemeCode
                inner JOIN 
        (
                        
                        select SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  with (nolock) where SchemeSubClassDescription IN ('ELSS','Balanced Fund')
        ) T ON T.SchemeCode =substring(HLDG.fsSchemeCode,2,len(fsSchemeCode))
        
                Where 
                --(tdate >=@StartDate and tdate < @EndDate )
                --and 
                HLDG.party_code=@PartyCode --and  
                --sub_broker=@SubBroker 
                --and SubTranType in ('SIP','')
                --and  
                --T.SchemeSubClassDescription IN ('ELSS','Balanced Fund')
                Group by T.SchemeSubClassDescription
)T Group by PartyCode,SchemeClassDescription,Status--,SubTranType


Select @PartyCode PartyCode,ISNULL(P.PurchaseAmount,0) PurchaseAmount,ISNULL(S.SaleAmount,0) SaleAmount,A.SchemeClassDescription from 
#Temp A left join #Purchase P ON A.SchemeClassDescription=P.SchemeClassDescription
Left join #Sale S
ON P.PartyCode=S.PartyCode
and P.SchemeClassDescription=S.SchemeClassDescription



--Select * from #Purchase
--Select * from #Sale


--Select @PartyCode PartyCode,ISNULL(P.PurchaseAmount,0) InvestingAmount,S.SaleAmount as CurrentAmount,A.SchemeClassDescription from 
--#Temp A left join #Purchase P ON A.SchemeClassDescription=P.SchemeClassDescription
--Left join #Sale S
--ON P.PartyCode=S.PartyCode
--and P.SchemeClassDescription=S.SchemeClassDescription


DROP table #Temp
Drop table #Purchase
Drop table #Sale

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MF_rpt_redemptionDetails
-- --------------------------------------------------

/*

Begin tran

declare @Sdate datetime = getdate()
EXEC USP_MF_rpt_redemptionDetails
select datediff(ms,@Sdate,GETDATE())

Rollback tran

*/
CREATE PROCEDURE [dbo].[USP_MF_rpt_redemptionDetails]
(
--declare 
	@sub_broker varchar(200) = 'GDS',
	@Clientcode varchar(200) = 'V15745'
)
AS
BEGIN

--EXEC [USP_MF_rpt_redemptionDetails] 'AJYC','ALWR1937'

	If OBJECT_ID('tempdb..#tmp_transDetails') is not null
		drop table #tmp_transDetails

	CREATE Table #tmp_transDetails
	(
		RecID bigint,
		TrxnMode varchar(100),
		[Group] varchar(100),
		ClientCode varchar(200),  
		clientName varchar(200),
		SubTranType varchar(20),
		tDate date,
		dr_cr varchar(10),
		FolioNo varchar(100),
		AMCSchemeName varchar(Max),
		Nav float,
		UnitNo float,
		Amount float,
		Strategy varchar(200),
		Branch varchar(200),
		sbcode varchar(200)
	)

	insert into #tmp_transDetails
	exec IPartner_Prc_GetTransData @sub_broker,'','','','',@Clientcode,'' 
	--exec MutualFund.dbo.Prc_GetTransData 'GDS','','','PHY','','V15745','' 

	select * from #tmp_transDetails where dr_cr = 'Sell'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MF_rpt_redemptionDetails_opt
-- --------------------------------------------------

/*

Begin tran

declare @Sdate datetime = getdate()
--EXEC USP_MF_rpt_redemptionDetails
EXEC USP_MF_rpt_redemptionDetails_opt
select datediff(ms,@Sdate,GETDATE())

Rollback tran

*/
CREATE PROCEDURE [dbo].[USP_MF_rpt_redemptionDetails_opt]
(
--declare 
	@sub_broker varchar(200) = 'GDS',
	@Clientcode varchar(200) = 'V15745'
)
AS
BEGIN

	If OBJECT_ID('tempdb..#tmp_transDetails') is not null
		drop table #tmp_transDetails

	CREATE Table #tmp_transDetails
	(
		RecID bigint,
		TrxnMode varchar(100),
		[Group] varchar(100),
		ClientCode varchar(200),  
		clientName varchar(200),
		SubTranType varchar(20),
		tDate date,
		dr_cr varchar(10),
		FolioNo varchar(100),
		AMCSchemeName varchar(Max),
		Nav float,
		UnitNo float,
		Amount float,
		Strategy varchar(200),
		Branch varchar(200),
		sbcode varchar(200)
	)

	insert into #tmp_transDetails
	exec IPartner_Prc_GetTransData @sub_broker,'','','PHY','',@Clientcode,'' 
	--exec MutualFund.dbo.Prc_GetTransData 'GDS','','','PHY','','V15745','' 

	select * from #tmp_transDetails where dr_cr = 'Sell'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MF_TransactionTotal
-- --------------------------------------------------
CREATE Procedure [dbo].[Usp_MF_TransactionTotal]
(
	@SubBroker Varchar(1000)
)

--Usp_MF_TransactionTotal 'GDS'
--Usp_MF_TransactionTotal 'EMT'
as
Begin



Select sub_broker,SUM(PurchaseAmount) PurchaseAmount
Into #Purchase
 From 
 (
SELECT 'Purchase' Status,
				SD.sub_broker,
				(VTB.Amount) PurchaseAmount,
				Case When SchemeClassDescription='Equity' Then 'Equity'
				When SchemeClassDescription='Debt' Then 'Debt'
				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
				Else 'Others'
				END SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionBuy_UniqueCode_syn VTB WITH (NOLOCK)
		Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
		ON SD.party_code=VTB.Clientcode
		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
		ON VTB.schcode=SM.SchemeCode
		Where 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		--and SchemeClassDescription='Equity'

		UNION 
		select 'Purchase' Status,
				SD.sub_broker,
				(VTB.Amount) PurchaseAmount
				,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
				When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
				Else 'Others'
				END SchemeSubClassDescription

				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionBuy_UniqueCode_syn VTB WITH (NOLOCK)
				Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
				ON SD.party_code=VTB.Clientcode
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
		Where 
		--party_code='RP61' and  
		sub_broker=@SubBroker
		--and SubTranType in ('SIP','')
		and  SchemeSubClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,Status--,SubTranType



Select sub_broker,SUM(SaleAmount) SaleAmount
Into #Sale
 From 
 (
SELECT 'Sale' Status,
				SD.sub_broker,(VTB.Amount) SaleAmount,
				Case When SchemeClassDescription='Equity' Then 'Equity'
				When SchemeClassDescription='Debt' Then 'Debt'
				When SchemeClassDescription='Liquid Fund' Then 'Liquid Fund'
				Else 'Others'
				END SchemeClassDescription
				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType

		 from tbl_TransactionSale_UniqueCode_syn VTB WITH (NOLOCK)
		Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
		ON SD.party_code=VTB.Clientcode
		inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
		ON VTB.schcode=SM.SchemeCode
		Where 
		--party_code='RP61' and  
		sub_broker=@SubBroker
		--and SubTranType in ('SIP','')
		--and SchemeClassDescription='Equity'

		UNION 
		select 'Sale' Status,
				SD.sub_broker,
				(VTB.Amount) SaleAmount
				,Case When SchemeSubClassDescription='ELSS' Then 'ELSS'
				When SchemeSubClassDescription='Balanced Fund' Then 'Balanced Fund'
				Else 'Others'
				END SchemeSubClassDescription

				,Case When SubTranType='SIP' THEN 'SIP' ELSE 'LumpSum' END SubTranType
				 from tbl_TransactionSale_UniqueCode_syn VTB WITH (NOLOCK)
				Inner join [dbo].[sb_client_details] SD WITH (NOLOCK)
				ON SD.party_code=VTB.Clientcode
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
		Where 
		--party_code='RP61' and  
		sub_broker=@SubBroker 
		--and SubTranType in ('SIP','')
		and  SchemeSubClassDescription IN ('ELSS','Balanced Fund')
)T Group by sub_broker,Status--,SubTranType


--Select * from #Purchase
--Select * from #Sale


Select P.sub_broker,P.PurchaseAmount,S.SaleAmount ,
(P.PurchaseAmount-S.SaleAmount) AS 'NetSale'
from #Purchase P 
Left join #Sale S
ON P.sub_broker=S.sub_broker

Drop table #Purchase
Drop table #Sale




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_MFNXT_Dash_Party_RevenueDetails
-- --------------------------------------------------

-- =============================================
-- Author:		Sharad Patil
-- Create date: 04-APRIL-2018
-- Description:	


-- EXEC [Usp_MFNXT_Dash_Party_RevenueDetails] 'RP61'


-- =============================================

CREATE PROCEDURE [dbo].[Usp_MFNXT_Dash_Party_RevenueDetails]
(
 @ClientCode VARCHAR(50)
)

 AS
 BEGIN

 SET NOCOUNT ON
 
 DECLARE @YTDStartDate DATE 
 DECLARE @MTDStartDate DATE 
 DECLARE @ENDDate DATE 
 ,@FirstHolderName VARCHAR(100)

 Select  @FirstHolderName = FirstHolderName from MutualFund.[dbo].investormaster where ExistCode = @ClientCode

 
 Select @YTDStartDate=dbo.fn_Get_StartData('YTD'),@MTDStartDate=dbo.fn_Get_StartData('MTD'),@EndDate=cast(Getdate() as date)


 	
	CREATE TABLE #temp
(
	SchemeClassDescriptiON VARCHAR(100)
)

INSERT INTO #temp
SELECT SchemeClassDescriptiON 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON in ('Equity','Debt','Liquid Fund')
UNION
SELECT SchemeSubClassDescriptiON  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON IN ('ELSS','Balanced Fund')
UNION
SELECT 'Other'

--SELECT * from #temp
 
SELECT 
		FirstHolderName AS Client_Name,
		TR.TRandate,
		TR.SchCode,
		Bd.PaidBrokMF  AS YTD_NettoSB_Revenue --, Bt.BrokTypeDesc AS [Revenue Type]
     INTO #Data
	   FROM MutualFund.[dbo].TRansactiondetail TR WITH (NOLOCK)
        INNER JOIN MutualFund.[dbo].investormaster IM WITH (NOLOCK) ON TR.InvestorCode = IM.invCode 
        INNER JOIN MutualFund.[dbo].BrokerageDetail Bd WITH (NOLOCK) ON  TR.TranCode=Bd.TranCode  
        INNER JOIN MutualFund.[dbo].BillSummary BS WITH (NOLOCK) ON BS.BillNo= Bd.BillNo  
		
        WHERE ExistCode=@ClientCode

		CREATE INDEX IDX_#Data_sub_broker ON #Data (Client_Name)
		CREATE INDEX IDX_#Data_TRandate ON #Data (TRandate)
		CREATE INDEX IDX_#Data_SchCode ON #Data (SchCode)
		CREATE INDEX IDX_#temp_SchCode ON #temp (SchemeClassDescription)


 ;WITH YTDRevenue
		AS
		(			
	SELECT Client_Name AS Client_Name,SchemeClassDescription,sum(YTD_NettoSB_Revenue) AS YTD_NettoSB_Revenue from #Data TR
		   		INNER JOIN 
	(
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON = 'ELSS' THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON in ('Equity','Debt','Liquid Fund')
			--UNION
			--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON IN ('Balanced Fund')
	) TT ON TT.SchemeCode =TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @YTDStartDate and @ENDDate
	GROUP BY SchemeClassDescription,Client_Name

	UNION

		SELECT Client_Name AS Client_Name,'OTHER' AS SchemeClassDescriptiON ,sum(YTD_NettoSB_Revenue) from #Data TR
		   		INNER JOIN 
	(
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  NOT in ('Equity','Debt','Liquid Fund')
			--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON = 'ELSS' THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON NOT in ('Equity','Debt','Liquid Fund')
			--UNION
			--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON IN ('Balanced Fund')
	) TT ON TT.SchemeCode =TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @YTDStartDate and @ENDDate
	GROUP BY Client_Name
		
	)		,
			
			MTDRevenue
		As
		(
	
	SELECT Client_Name AS Client_Name,SchemeClassDescription,sum(YTD_NettoSB_Revenue) AS MTD_NettoSB_Revenue from #Data TR
		   		INNER JOIN 
	(
			SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  in ('Equity','Debt','Liquid Fund')
			--UNION
			--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON NOT IN ('Balanced Fund')
	) TT ON TT.SchemeCode =TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @MTDStartDate and @ENDDate
	GROUP BY SchemeClassDescription,Client_Name

	UNION

		SELECT Client_Name AS Client_Name,'OTHER' AS SchemeClassDescriptiON ,sum(YTD_NettoSB_Revenue) from #Data TR
	INNER JOIN 
	(
	SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON IN ('Balanced Fund','ELSS' ) THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON  NOT in ('Equity','Debt','Liquid Fund')
			--SELECT SchemeClassDescription=CASE WHEN SchemeSubClassDescriptiON = 'ELSS' THEN SchemeSubClassDescriptiON else SchemeClassDescriptiON END ,SchemeCode 	from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeClassDescriptiON NOT in ('Equity','Debt','Liquid Fund')
			--UNION
			--SELECT SchemeSubClassDescription,SchemeCode  from MutualFund.[dbo].schememaster sm  WITH (NOLOCK) WHERE SchemeSubClassDescriptiON NOT IN ('Balanced Fund')
	) TT ON TT.SchemeCode =TR.SchCode
	WHERE CAST(TR.TRandate AS DATE) BETWEEN @MTDStartDate and @ENDDate
	GROUP BY Client_Name

)

	SELECT	 @ClientCode AS Client_Code
				,@FirstHolderName AS Client_Name
				,T.SchemeClassDescriptiON AS Segment
				,CONVERT(DECIMAL(20,2),ROUND(ISNULL(Y.YTD_NettoSB_Revenue,0),2)) AS YTD_SB_Revenue
				,CONVERT(DECIMAL(20,2),ROUND(ISNULL(M.MTD_NettoSB_Revenue,0),2)) AS MTD_SB_Revenue
			
		FROM #temp T
		LEFT JOIN YTDRevenue Y ON Y.SchemeClassDescriptiON = T.SchemeClassDescription
		LEFT JOIN MTDRevenue M 	ON Y.Client_Name= M.Client_Name AND Y.SchemeClassDescription= M.SchemeClassDescription
	DROP table #Data
	
	DROP table #temp
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_modifyapplication
-- --------------------------------------------------

CREATE Proc [dbo].[usp_modifyapplication]
@ApplicationNo varchar(30)
as 
begin
select * from ApplicationForm WITH (NOLOCK) where ApplicationNo = @ApplicationNo
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ModuleMappingMaster
-- --------------------------------------------------
CREATE procedure [dbo].[USP_ModuleMappingMaster]
(
	@ModuleId int
	--,@Roleid int
	,@ControllerId int
	,@ActionId int
	,@FreePaid VARCHAR(20)
	,@Active BIT
	,@createDate	datetime=NULL
	,@CreateBy	varchar(100)=NULL
	,@UpdateDate	datetime=NULL
	,@UpdateBy	varchar(100)=NULL

)
AS
Begin


	iF NOT EXISTS (SELECT COUNT(1) FROM ModuleMappingMaster WITH (NOLOCK) WHERE ModuleId=@ModuleId)
	BEGIN 
		INSERT INTO ModuleMappingMaster
		(
			 ModuleId
			--,Roleid
			,ControllerId
			,ActionId
			,FreePaid
			,Active
			,createDate
			,CreateBy
		)
		SELECT 
			 @ModuleId
			--,@Roleid
			,@ControllerId
			,@ActionId
			,@FreePaid
			,@Active
			,getdate()
			,@CreateBy
	END
	ELSE
	BEGIN
			UPDATE ModuleMappingMaster
			SET 
				 --Roleid=@Roleid,
				ControllerId=@ControllerId
				,ActionId=@ActionId
				,FreePaid=@FreePaid
				,Active=@Active
				,UpdateDate=@UpdateDate
				,UpdateBy=@UpdateBy
			WHERE  ModuleId= @ModuleId


	END

	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleMaster
-- --------------------------------------------------
CREATE PROCEDURE usp_ModuleMaster
(
		
		@Projectid INT
		,@ModuleName varchar(200)
		,@Type varchar(10)
		,@Level INT
		,@Parentid INT
		,@ControllerId INT
		,@ActionId INT
		,@FreePaid varchar(100)=NULL
		,@Active varchar(100)=NULL
		,@createDate	datetime=NULL
		,@CreateBy	varchar(100)=NULL
		,@UpdateDate	datetime=NULL
		,@UpdateBy	varchar(100)=NULL
		
)

AS
BEGIN 

--usp_AddNewRole 'AAA','Node','10'

SET NOCOUNT ON 
BEGIN TRANSACTION
BEGIN TRY 

	INSERT INTO ModuleMaster(Projectid,ModuleName,Type,Level,Parentid,createDate,CreateBy,UpdateDate,UpdateBy	 )
	Select 	@Projectid,@ModuleName,@Type,@Level,@Parentid ,@createDate,@CreateBy,@UpdateDate,@UpdateBy	
	
	Declare @IdentityModuleId INT
	Select @IdentityModuleId=@@IDENTITY

	--Select * from ModuleMaster with (NOLOCK) where 

		INSERT INTO ModuleMappingMaster
		(
			 ModuleId
			--,Roleid
			,ControllerId
			,ActionId
			,FreePaid
			,Active
			,createDate
			,CreateBy
		)
		SELECT 
			 @IdentityModuleId
			--,@Roleid
			,@ControllerId
			,@ActionId
			,@FreePaid
			,@Active
			,getdate()
			,@CreateBy
	






	Commit


END TRY  
BEGIN CATCH  
   	SELECT  
        ERROR_NUMBER() AS ErrorNumber  
        ,ERROR_SEVERITY() AS ErrorSeverity  
        ,ERROR_STATE() AS ErrorState  
        ,ERROR_PROCEDURE() AS ErrorProcedure  
        ,ERROR_LINE() AS ErrorLine  
        ,ERROR_MESSAGE() AS ErrorMessage;  
 Rollback
END CATCH

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleParentChildMaster
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[usp_ModuleParentChildMaster]
AS
BEGIN

SET NOCOUNT ON


--SELECT 
--	T2.ModuleId LowestModuleId,T2.ModuleName as LowestModuleName ,T1.LowestType,T1.ModuleName,
--	T2.Parentid,T1.Parentid ParentToParentid,T2.Type ParentType, T1.ParentModuleName ParentToParentModuleName ,T1.ParentType ParentToParentType

--from 
--(
--SELECT	
--	A.ModuleId,A.ModuleName,B.ModuleName as ParentModuleName,
--	A.Type LowestType , A.Parentid ,B.Type ParentType
--FROM
--	ModuleMaster A
--	LEFT JOIN ModuleMaster B
--	ON A.Parentid=B.ModuleId

--) T1
--Left join 
--(
--SELECT	
--	A.ModuleId,A.ModuleName,B.ModuleName as ParentModuleName,
--	A.Type,A.Parentid 
--FROM
--	ModuleMaster A
--	LEFT JOIN ModuleMaster B
--	ON A.Parentid=B.ModuleId
--)T2
--on T1.ModuleId=T2.Parentid
--where T2.ModuleId is not null



SELECT	
	A.ModuleId,A.ModuleName,B.ModuleName as ParentModuleName,
	A.Type,A.Parentid 
FROM
	ModuleMaster A WITH (NOLOCK)
	LEFT JOIN ModuleMaster B WITH (NOLOCK)
	ON A.Parentid=B.ModuleId

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleRoleMapping
-- --------------------------------------------------
CREATE procedure [dbo].[usp_ModuleRoleMapping]
(
--Declare 
@Moduleid VARCHAR(MAX),
@roleid INT,
@CreatedBy INT
--,@FreePaid Varchar(10)
)
as
begin
SET NOCOUNT ON
 --
 /*
 Begin tran
 EXEC [dbo].[usp_ModuleRoleMapping] '1-Free,38-Free,39-Free,40-Free,41-Free,42-Free,43-Free,44-Free,45-Free,106-Free,107-Free,79-Free,80-Free,81-Free,82-Free,30-Free,32-Free,34-Free,96-Free,97-Free,98-Free,99-Free,100-Free,101-Free,103-Free,104-Free,105-Free,46-Free,47-Free,48-Free,49-Free,93-Free,12-Paid,15-Paid,17-Paid,18-Free,24-Free,25-Free,26-Free,27-Free,28-Free,29-Free,87-Free,88-Free',30,NULL
 Rollback tran
 */



IF OBJECT_ID ('TEMPDB..#temp') IS NOT NULL
		DROP TABLE #temp

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 

IF OBJECT_ID ('TEMPDB..#ParentChildRole') IS NOT NULL
		DROP TABLE #ParentChildRole

--Create Table #ParentChildRole
--(
--Roleid	INT,
--RoleName Varchar(200),	
--ParentId	INT ,
--ParentRoleName Varchar(200)
--)

--Insert into #ParentChildRole
--EXEC usp_getParentChildRole

--select * from #ParentChildRole


select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp


			INSERT INTO [ModuleRoleMapping](Roleid,ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,FreePaid)
			OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log
			(
			Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			)

			SELECT 
				@roleid,A.ModuleId,1,'system','','',getdate(),A.FreePaid
			 FROM #Temp1 A
				left join [ModuleRoleMapping] B WITH (NOLOCK)
				ON A.Moduleid=B.ModuleID
			and B.Roleid=@roleid
	where B.ModuleID is null  

Create table #Exclude
(
	ModuleId INT,
	Roleid INT
)

Create table #Include
(
	ModuleId INT,
	Roleid INT
)


Insert into #Include
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A WITH (NOLOCK)
WHERE moduleid in (select ModuleID from #Temp1 B )
and Roleid=@roleid



Insert into #Exclude
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A WITH (NOLOCK)
WHERE moduleid not in (select ModuleID from #Temp1 B )
and Roleid=@roleid


Update A
Set Active=0,UpdateDate = Getdate()
OUTPUT inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					--,inserted.UpdatedBy
					,@CreatedBy 
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log
			(
			Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			)

from [ModuleRoleMapping] A
Inner join #Exclude B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid


Update A
Set Active=1,UpdateDate = Getdate()
OUTPUT inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					--,inserted.UpdatedBy
					,@CreatedBy 
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log
			(
			Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			)

from [ModuleRoleMapping] A WITH (NOLOCK)
Inner join #Include	B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid


----Update A
----set Active=0
----FROM [ModuleRoleMapping] A
----Inner join 
----(
----	select * from [ModuleRoleMapping]  where active=0 and Roleid in (select ParentId from #ParentChildRole where ParentId=@roleid)
----) T ON A.ModuleID=T.ModuleID --and A.roleid=T.roleid
------and A.Active=1
----and A.roleid in (select Roleid from #ParentChildRole  where ParentId=@roleid)




;with cte  as
	(Select ParentId from RoleMaster a
	where ParentId =@roleid
	
	union all

	Select b.Roleid from cte c
	inner join RoleMaster b WITH (NOLOCK) on
	b.ParentId = c.ParentId)
	--insert into #ParentChildRole
	select * INTO #MainCTE from cte


Update A
set Active=0
FROM [ModuleRoleMapping] A
Inner join 
(
	select * from [ModuleRoleMapping] WITH (NOLOCK)  where active=0 and Roleid in (select distinct parentid from #MainCTE a  )
) T ON A.ModuleID=T.ModuleID --and A.roleid=T.roleid
--and A.Active=1
and A.roleid in (select Roleid from RoleMaster WITH (NOLOCK)
	where ParentId in (
	select ParentId from #MainCTE
	)) 






DROP TABLE #Temp
DROP TABLE #Temp1
DROP TABLE #Exclude
DROP TABLE #Include
END


--select * from [ModuleRoleMapping] where Roleid=1
--select * from [ModuleRoleMapping] where Roleid=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleRoleMapping_Bkp15June2018
-- --------------------------------------------------

CREATE procedure [dbo].[usp_ModuleRoleMapping_Bkp15June2018]
(
--Declare 
@Moduleid VARCHAR(MAX),
@roleid INT
--,@FreePaid Varchar(10)
)
as
begin
SET NOCOUNT ON
 --EXEC [dbo].[usp_ModuleRoleMapping] '1-Free,23-Paid',1

--Set @Moduleid='1-Free,23-Paid,7-Paid'
--Set @roleid=2


IF OBJECT_ID ('TEMPDB..#temp') IS NOT NULL
		DROP TABLE #temp

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 


select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp


			INSERT INTO [ModuleRoleMapping](Roleid,ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,FreePaid)
			OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					,inserted.CreatedBy
					,inserted.UpdatedBy
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log

			SELECT 
				@roleid,A.ModuleId,1,'system','','',getdate(),A.FreePaid
			 FROM #Temp1 A
				left join [ModuleRoleMapping] B
				ON A.Moduleid=B.ModuleID
			and B.Roleid=@roleid
	where B.ModuleID is null  

Create table #Exclude
(
	ModuleId INT,
	Roleid INT
)

Create table #Include
(
	ModuleId INT,
	Roleid INT
)


Insert into #Include
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A 
WHERE moduleid in (select ModuleID from #Temp1 B )
and Roleid=@roleid



Insert into #Exclude
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A 
WHERE moduleid not in (select ModuleID from #Temp1 B )
and Roleid=@roleid


Update A
Set Active=0,UpdateDate = Getdate()


OUTPUT inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					,inserted.CreatedBy
					,inserted.UpdatedBy
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log

from [ModuleRoleMapping] A
Inner join #Exclude B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid


Update A
Set Active=1,UpdateDate = Getdate()

OUTPUT inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					,inserted.CreatedBy
					,inserted.UpdatedBy
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log

from [ModuleRoleMapping] A
Inner join #Include	B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid




DROP TABLE #Temp
DROP TABLE #Temp1
DROP TABLE #Exclude
DROP TABLE #Include
END


--select * from [ModuleRoleMapping] where Roleid=1
--select * from [ModuleRoleMapping] where Roleid=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleRoleMapping_bkp19June2018
-- --------------------------------------------------
CREATE procedure [dbo].[usp_ModuleRoleMapping_bkp19June2018]
(
--Declare 
@Moduleid VARCHAR(MAX),
@roleid INT,
@CreatedBy INT
--,@FreePaid Varchar(10)
)
as
begin
SET NOCOUNT ON
 --EXEC [dbo].[usp_ModuleRoleMapping] '1-Free,23-Paid',1

--Set @Moduleid='1-Free,23-Paid,7-Paid'
--Set @roleid=2


IF OBJECT_ID ('TEMPDB..#temp') IS NOT NULL
		DROP TABLE #temp

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 

IF OBJECT_ID ('TEMPDB..#ParentChildRole') IS NOT NULL
		DROP TABLE #ParentChildRole

Create Table #ParentChildRole
(
Roleid	INT,
RoleName Varchar(200),	
ParentId	INT ,
ParentRoleName Varchar(200)
)

Insert into #ParentChildRole
EXEC usp_getParentChildRole

--select * from #ParentChildRole


select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp


			INSERT INTO [ModuleRoleMapping](Roleid,ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,FreePaid)
			OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log

			SELECT 
				@roleid,A.ModuleId,1,'system','','',getdate(),A.FreePaid
			 FROM #Temp1 A
				left join [ModuleRoleMapping] B
				ON A.Moduleid=B.ModuleID
			and B.Roleid=@roleid
	where B.ModuleID is null  

Create table #Exclude
(
	ModuleId INT,
	Roleid INT
)

Create table #Include
(
	ModuleId INT,
	Roleid INT
)


Insert into #Include
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A 
WHERE moduleid in (select ModuleID from #Temp1 B )
and Roleid=@roleid



Insert into #Exclude
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A 
WHERE moduleid not in (select ModuleID from #Temp1 B )
and Roleid=@roleid


Update A
Set Active=0,UpdateDate = Getdate()
OUTPUT inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					--,inserted.UpdatedBy
					,@CreatedBy 
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log

from [ModuleRoleMapping] A
Inner join #Exclude B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid


Update A
Set Active=1,UpdateDate = Getdate()
OUTPUT inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					--,inserted.UpdatedBy
					,@CreatedBy 
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()

			INTO ModuleRoleMapping_Log

from [ModuleRoleMapping] A
Inner join #Include	B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid


Update A
set Active=0
FROM [ModuleRoleMapping] A
Inner join 
(
	select * from [ModuleRoleMapping]  where active=0 and Roleid in (select ParentId from #ParentChildRole where ParentId=@roleid)
) T ON A.ModuleID=T.ModuleID --and A.roleid=T.roleid
--and A.Active=1
and A.roleid in (select Roleid from #ParentChildRole  where ParentId=@roleid)




DROP TABLE #Temp
DROP TABLE #Temp1
DROP TABLE #Exclude
DROP TABLE #Include
END


--select * from [ModuleRoleMapping] where Roleid=1
--select * from [ModuleRoleMapping] where Roleid=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleRoleMapping_New
-- --------------------------------------------------
CREATE procedure [dbo].[usp_ModuleRoleMapping_New]
(
--Declare 
@Moduleid VARCHAR(MAX),
@roleid INT,
@CreatedBy INT,
--,@FreePaid Varchar(10)
@UserIPaddress Varchar(100)=NULL


)
as
begin
SET NOCOUNT ON
 --
 /*
 Begin tran
 --select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'
 EXEC [dbo].[usp_ModuleRoleMapping_new] '132-Free,1-Free,2-Free,3-Free,4-Free,5-Free,6-Free,7-Free,8-Free,9-Free,10-Free,11-Free,85-Free,38-Free,39-Free,40-Free,41-Free,42-Free,43-Free,44-Free,45-Free,106-Free,107-Free,79-Free,80-Free,81-Free,30-Free,31-Free,32-Free,33-Free,34-Free,35-Free,36-Free,37-Free,92-Free,96-Free,98-Free,99-Free,100-Free,101-Free,102-Free,103-Free,104-Free,105-Free,121-Free,123-Free,46-Free,47-Free,48-Free,49-Free,93-Free,50-Free,51-Free,52-Free,53-Free,54-Free,89-Free,90-Free,114-Free,115-Free,116-Free,117-Free,118-Free,124-Free,125-Free,12-Paid,15-Free,17-Free,12-Paid,13-Paid,14-Paid,16-Paid,86-Paid,18-Free,19-Free,20-Free,21-Free,22-Free,23-Free,95-Free,24-Free,25-Free,26-Free,27-Free,28-Free,29-Free,87-Free,88-Free,55-Free,56-Free,57-Free,58-Free,59-Free,60-Free,61-Free,62-Free,63-Free,64-Free,65-Free,67-Free,68-Free,69-Free,71-Free,72-Free,73-Free,74-Free,75-Free,76-Free,108-Free,109-Free,110-Free,111-Free,77-Free,78-Free,91-Free,112-Free,113-Free,127-Free,128-Free,129-Free,130-Free',7,1,'172.29.23.177'
--select * from ModuleRoleMapping_Log 
--where oldnew = 'old'
--and roleid = '7'
--and moduleid= '132'
	select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'
 Rollback tran
 */



IF OBJECT_ID ('TEMPDB..#temp') IS NOT NULL
		DROP TABLE #temp

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 

IF OBJECT_ID ('TEMPDB..#ParentChildRole') IS NOT NULL
		DROP TABLE #ParentChildRole

--Create Table #ParentChildRole
--(
--Roleid	INT,
--RoleName Varchar(200),	
--ParentId	INT ,
--ParentRoleName Varchar(200)
--)

--Insert into #ParentChildRole
--EXEC usp_getParentChildRole

--select * from #ParentChildRole


select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp



			INSERT INTO ModuleRoleMapping_Log
			(Roleid	,ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,FreePaid,EntryDate,FromDate,ToDate,Reason,UserIPaddress,OLDNew)
			SELECT 
			Roleid	,M.ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,M.FreePaid,getdate() EntryDate,FromDate,ToDate,Reason,UserIPaddress,'OLD' OLDNew
			FROM [ModuleRoleMapping] M WITH (NOLOCK)
			WHERE roleid=@roleid



			INSERT INTO [ModuleRoleMapping](Roleid,ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,FreePaid,UserIPaddress)
			OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()
					,Inserted.FromDate
					,Inserted.ToDate
					,Inserted.Reason
					,@UserIPaddress
					,'New'
			
			INTO ModuleRoleMapping_Log
			(
			 Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			,FromDate
			,ToDate
			,Reason
			,UserIPaddress
			,OLDNew
			)

			SELECT 
				@roleid,A.ModuleId,1,@CreatedBy,'','',getdate(),A.FreePaid,@UserIPaddress
			 FROM #Temp1 A
				left join [ModuleRoleMapping] B WITH (NOLOCK)
				ON A.Moduleid=B.ModuleID
			and B.Roleid=@roleid
	where B.ModuleID is null  



Create table #Exclude
(
	ModuleId INT,
	Roleid INT
)

Create table #Include
(
	ModuleId INT,
	Roleid INT
)


Insert into #Include
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A WITH (NOLOCK)
WHERE moduleid in (select ModuleID from #Temp1 B )
and Roleid=@roleid



Insert into #Exclude
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A WITH (NOLOCK)
WHERE moduleid not in (select ModuleID from #Temp1 B )
and Roleid=@roleid


Update A
Set Active=0,UpdateDate = Getdate(),UserIPaddress = @UserIPaddress
--OUTPUT inserted.Roleid
--					,inserted.ModuleID
--					,inserted.Active
--					--,inserted.CreatedBy
--					--,inserted.UpdatedBy
--					,@CreatedBy 
--					,@CreatedBy 
--					,inserted.UpdateDate
--					,inserted.createDate
--					,inserted.FreePaid
--					,Getdate()

--			INTO ModuleRoleMapping_Log
--			(
--			Roleid
--			,ModuleID
--			,Active
--			,CreatedBy
--			,UpdatedBy
--			,UpdateDate
--			,createDate
--			,FreePaid
--			,EntryDate
--			)


OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()
					,Inserted.FromDate
					,Inserted.ToDate
					,Inserted.Reason
					,@UserIPaddress
			
			INTO ModuleRoleMapping_Log
			(
			 Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			,FromDate
			,ToDate
			,Reason
			,UserIPaddress
			)


from [ModuleRoleMapping] A WITH (NOLOCK)
Inner join #Exclude B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid


Update A
Set Active=1,UpdateDate = Getdate(),UserIPaddress = @UserIPaddress
--OUTPUT inserted.Roleid
--					,inserted.ModuleID
--					,inserted.Active
--					--,inserted.CreatedBy
--					--,inserted.UpdatedBy
--					,@CreatedBy 
--					,@CreatedBy 
--					,inserted.UpdateDate
--					,inserted.createDate
--					,inserted.FreePaid
--					,Getdate()

--			INTO ModuleRoleMapping_Log
--			(
--			Roleid
--			,ModuleID
--			,Active
--			,CreatedBy
--			,UpdatedBy
--			,UpdateDate
--			,createDate
--			,FreePaid
--			,EntryDate
--			)

OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()
					,Inserted.FromDate
					,Inserted.ToDate
					,Inserted.Reason
					,@UserIPaddress
					,'New'
			
			INTO ModuleRoleMapping_Log
			(
			 Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			,FromDate
			,ToDate
			,Reason
			,UserIPaddress
			,OLDNew
			)

from [ModuleRoleMapping] A WITH (NOLOCK)
Inner join #Include	B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid


----Update A
----set Active=0
----FROM [ModuleRoleMapping] A
----Inner join 
----(
----	select * from [ModuleRoleMapping]  where active=0 and Roleid in (select ParentId from #ParentChildRole where ParentId=@roleid)
----) T ON A.ModuleID=T.ModuleID --and A.roleid=T.roleid
------and A.Active=1
----and A.roleid in (select Roleid from #ParentChildRole  where ParentId=@roleid)




;with cte  as
	(Select ParentId from RoleMaster a WITH (NOLOCK)
	where ParentId =@roleid
	
	union all

	Select b.Roleid from cte c
	inner join RoleMaster b WITH (NOLOCK) on
	b.ParentId = c.ParentId)
	--insert into #ParentChildRole
	select * INTO #MainCTE from cte


Update A
set Active=0
,UserIPaddress = @UserIPaddress
FROM [ModuleRoleMapping] A WITH (NOLOCK)
Inner join 
(
	select * from [ModuleRoleMapping] WITH (NOLOCK)  where active=0 and Roleid in (select distinct parentid from #MainCTE a  )
) T ON A.ModuleID=T.ModuleID --and A.roleid=T.roleid
--and A.Active=1
and A.roleid in (select Roleid from RoleMaster WITH (NOLOCK)
	where ParentId in (
	select ParentId from #MainCTE
	)) 






DROP TABLE #Temp
DROP TABLE #Temp1
DROP TABLE #Exclude
DROP TABLE #Include
END


--select * from [ModuleRoleMapping] where Roleid=1
--select * from [ModuleRoleMapping] where Roleid=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleRoleMapping_New_1
-- --------------------------------------------------
CREATE procedure [dbo].[usp_ModuleRoleMapping_New_1]
(
--Declare 
@Moduleid VARCHAR(MAX),
@roleid INT,
@CreatedBy INT,
--,@FreePaid Varchar(10)
@UserIPaddress Varchar(100)=NULL


)
as
begin
SET NOCOUNT ON
 --
 /*
 Begin tran
 EXEC [dbo].[usp_ModuleRoleMapping_new_1] '1-Free,2-Free,3-Free,4-Free,5-Free,6-Free,7-Free,8-Free,9-Free,10-Free,11-Free,85-Free,38-Free,39-Free,40-Free,41-Free,42-Free,43-Free,44-Free,45-Free,106-Free,107-Free,79-Free,80-Free,81-Free,30-Free,31-Free,32-Free,33-Free,34-Free,35-Free,36-Free,37-Free,92-Free,96-Free,98-Free,99-Free,100-Free,101-Free,102-Free,103-Free,104-Free,105-Free,121-Free,123-Free,46-Free,47-Free,48-Free,49-Free,93-Free,50-Free,51-Free,52-Free,53-Free,54-Free,89-Free,90-Free,114-Free,115-Free,116-Free,117-Free,118-Free,124-Free,125-Free,12-Paid,15-Free,17-Free,12-Paid,13-Paid,14-Paid,16-Paid,86-Paid,18-Free,19-Free,20-Free,21-Free,22-Free,23-Free,95-Free,24-Free,25-Free,26-Free,27-Free,28-Free,29-Free,87-Free,88-Free,55-Free,56-Free,57-Free,58-Free,59-Free,60-Free,61-Free,62-Free,63-Free,64-Free,65-Free,67-Free,68-Free,69-Free,71-Free,72-Free,73-Free,74-Free,75-Free,76-Free,108-Free,109-Free,110-Free,111-Free,77-Free,78-Free,91-Free,112-Free,113-Free,127-Free,128-Free,129-Free,130-Free'
 ,7,1,'172.29.23.177'
select * from ModuleRoleMapping_Log
where oldnew = 'new'
select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'
 Rollback tran
 */



IF OBJECT_ID ('TEMPDB..#temp') IS NOT NULL
		DROP TABLE #temp

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 

IF OBJECT_ID ('TEMPDB..#ParentChildRole') IS NOT NULL
		DROP TABLE #ParentChildRole

--Create Table #ParentChildRole
--(
--Roleid	INT,
--RoleName Varchar(200),	
--ParentId	INT ,
--ParentRoleName Varchar(200)
--)

--Insert into #ParentChildRole
--EXEC usp_getParentChildRole

--select * from #ParentChildRole


select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp

select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'

			INSERT INTO ModuleRoleMapping_Log
			(Roleid	,ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,FreePaid,EntryDate,FromDate,ToDate,Reason,UserIPaddress,OLDNew)
			SELECT 
			Roleid	,M.ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,M.FreePaid,getdate() EntryDate,FromDate,ToDate,Reason,UserIPaddress,'OLD' OLDNew
			FROM [ModuleRoleMapping] M
			WHERE roleid=7



			INSERT INTO [ModuleRoleMapping](Roleid,ModuleID,Active,CreatedBy,UpdatedBy,UpdateDate,createDate,FreePaid,UserIPaddress)
			OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()
					,Inserted.FromDate
					,Inserted.ToDate
					,Inserted.Reason
					,@UserIPaddress
					,'New'
			
			INTO ModuleRoleMapping_Log
			(
			 Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			,FromDate
			,ToDate
			,Reason
			,UserIPaddress
			,OLDNew
			)

			SELECT 
				@roleid,A.ModuleId,1,@CreatedBy,'','',getdate(),A.FreePaid,@UserIPaddress
			 FROM #Temp1 A
				left join [ModuleRoleMapping] B
				ON A.Moduleid=B.ModuleID
			and B.Roleid=@roleid
	where B.ModuleID is null  

	select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'

Create table #Exclude
(
	ModuleId INT,
	Roleid INT
)

Create table #Include
(
	ModuleId INT,
	Roleid INT
)


Insert into #Include
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A 
WHERE moduleid in (select ModuleID from #Temp1 B )
and Roleid=@roleid

select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'

Insert into #Exclude
SELECT A.ModuleId,@roleid FROM [ModuleRoleMapping] A 
WHERE moduleid not in (select ModuleID from #Temp1 B )
and Roleid=@roleid
select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'

Update A
Set Active=0,UpdateDate = Getdate()
--OUTPUT inserted.Roleid
--					,inserted.ModuleID
--					,inserted.Active
--					--,inserted.CreatedBy
--					--,inserted.UpdatedBy
--					,@CreatedBy 
--					,@CreatedBy 
--					,inserted.UpdateDate
--					,inserted.createDate
--					,inserted.FreePaid
--					,Getdate()

--			INTO ModuleRoleMapping_Log
--			(
--			Roleid
--			,ModuleID
--			,Active
--			,CreatedBy
--			,UpdatedBy
--			,UpdateDate
--			,createDate
--			,FreePaid
--			,EntryDate
--			)


OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()
					,Inserted.FromDate
					,Inserted.ToDate
					,Inserted.Reason
					,@UserIPaddress
			
			INTO ModuleRoleMapping_Log
			(
			 Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			,FromDate
			,ToDate
			,Reason
			,UserIPaddress
			)


from [ModuleRoleMapping] A
Inner join #Exclude B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid

	select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'
Update A
Set Active=1,UpdateDate = Getdate()
--OUTPUT inserted.Roleid
--					,inserted.ModuleID
--					,inserted.Active
--					--,inserted.CreatedBy
--					--,inserted.UpdatedBy
--					,@CreatedBy 
--					,@CreatedBy 
--					,inserted.UpdateDate
--					,inserted.createDate
--					,inserted.FreePaid
--					,Getdate()

--			INTO ModuleRoleMapping_Log
--			(
--			Roleid
--			,ModuleID
--			,Active
--			,CreatedBy
--			,UpdatedBy
--			,UpdateDate
--			,createDate
--			,FreePaid
--			,EntryDate
--			)

OUTPUT   inserted.Roleid
					,inserted.ModuleID
					,inserted.Active
					--,inserted.CreatedBy
					,@CreatedBy 
					--,inserted.UpdatedBy
					,@CreatedBy 
					,inserted.UpdateDate
					,inserted.createDate
					,inserted.FreePaid
					,Getdate()
					,Inserted.FromDate
					,Inserted.ToDate
					,Inserted.Reason
					,@UserIPaddress
					,'New'
			
			INTO ModuleRoleMapping_Log
			(
			 Roleid
			,ModuleID
			,Active
			,CreatedBy
			,UpdatedBy
			,UpdateDate
			,createDate
			,FreePaid
			,EntryDate
			,FromDate
			,ToDate
			,Reason
			,UserIPaddress
			,OLDNew
			)

from [ModuleRoleMapping] A
Inner join #Include	B
ON A.ModuleID=B.ModuleId
	And A.Roleid=B.Roleid
	select * from ModuleRoleMapping where Roleid = 7 and ModuleID = '132'

----Update A
----set Active=0
----FROM [ModuleRoleMapping] A
----Inner join 
----(
----	select * from [ModuleRoleMapping]  where active=0 and Roleid in (select ParentId from #ParentChildRole where ParentId=@roleid)
----) T ON A.ModuleID=T.ModuleID --and A.roleid=T.roleid
------and A.Active=1
----and A.roleid in (select Roleid from #ParentChildRole  where ParentId=@roleid)




;with cte  as
	(Select ParentId from RoleMaster a
	where ParentId =@roleid
	
	union all

	Select b.Roleid from cte c
	inner join RoleMaster b on
	b.ParentId = c.ParentId)
	--insert into #ParentChildRole
	select * INTO #MainCTE from cte


Update A
set Active=0
,UserIPaddress = @UserIPaddress
FROM [ModuleRoleMapping] A
Inner join 
(
	select * from [ModuleRoleMapping]  where active=0 and Roleid in (select distinct parentid from #MainCTE a  )
) T ON A.ModuleID=T.ModuleID --and A.roleid=T.roleid
--and A.Active=1
and A.roleid in (select Roleid from RoleMaster 
	where ParentId in (
	select ParentId from #MainCTE
	)) 






DROP TABLE #Temp
DROP TABLE #Temp1
DROP TABLE #Exclude
DROP TABLE #Include
END


--select * from [ModuleRoleMapping] where Roleid=1
--select * from [ModuleRoleMapping] where Roleid=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ModuleRoleMapping_UpdateReason
-- --------------------------------------------------
CREATE procedure [dbo].[usp_ModuleRoleMapping_UpdateReason]
(
	
	@RoleId INT
	,@ModuleId INT
	,@FreePaid Varchar(100)
	,@FromDate Varchar(20)
	,@Todate Varchar(20)
	,@UpdateBy VArchar(20)
	,@Reason VArchar(2000)
	,@IPaddress Varchar(50)
)
AS
BEGIN

SET NOCOUNT ON

select @FromDate = convert(datetime , @FromDate , 103)
select @Todate = convert(datetime , @Todate , 103)

SELECT @FromDate = CAST( @FromDate AS DATE)
SELECT @Todate = CAST( @Todate AS DATE)


Update ModuleRoleMapping
Set 
ModuleID	=	@ModuleId
,Active		=	1
,UpdatedBy	=	@UpdateBy
,UpdateDate	=	getdate()
,FreePaid	=	@FreePaid
,FromDate	=	@FromDate
,ToDate		=	@Todate
,Reason		=	@Reason
,UserIPaddress = @IPaddress

OUTPUT   

inserted.Roleid		
,inserted.ModuleID	
,inserted.Active		
,inserted.CreatedBy	
,inserted.UpdatedBy	
,inserted.UpdateDate	
,inserted.createDate	
,inserted.FreePaid	
,Getdate()
,inserted.FromDate	
,inserted.ToDate		
,inserted.Reason	
,inserted.UserIPaddress	

INTO ModuleRoleMapping_Log
(
Roleid
,ModuleID
,Active
,CreatedBy
,UpdatedBy
,UpdateDate
,createDate
,FreePaid
,EntryDate
,FromDate
,ToDate
,Reason
,UserIPaddress
)

WHERE Roleid=@RoleId
and ModuleId=@ModuleId

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_NewEmployee_Mimmansa
-- --------------------------------------------------
CREATE procedure usp_NewEmployee_Mimmansa
as

Begin 

Declare @Created_date Date =Convert(Date,Getdate())
Declare @userid varchar(100),@password varchar(100)

Create table #tbl_Emp_Master
(
USER_ID varchar(100),
password varchar(100) 

)

Insert into #tbl_Emp_Master
SELECT USER_ID,password FROM [196.1.115.132].mimansa.dbo.tbl_Emp_Master em with (nolock)
where 
	convert(date,Created_date)=@Created_date 

DECLARE db_cursor CURSOR FOR 
SELECT USER_ID,password FROM #tbl_Emp_Master
--where 
	--convert(date,Created_date)=@Created_date 
--and
 --user_id in (
	--'AALNA001'
	--,'AHNG001'
	--)

OPEN db_cursor  
FETCH NEXT FROM db_cursor INTO @userid,@password

WHILE @@FETCH_STATUS = 0  
BEGIN  

Declare @Maxuserid bigint
select @Maxuserid=max(userid)+1 from [dbo].[UserMaster] with (nolock)

--Declare @Password varchar(100)

SELECT @Password=Password FROM #tbl_Emp_Master WHERE USER_ID =@userid


If(select count(*) from [NXT_Admin].[dbo].[UserMaster]  with (nolock) where name=@userid)=0
begin
		insert into [NXT_Admin].[dbo].[UserMaster] 
		select 
			@Maxuserid Userid
			,@userid Name
			,@Password password
			,1 Active
			,getdate() createDate
			,'Admin' CreateBy
			,'' UpdateDate
			,'' UpdateBy

END

select @Maxuserid=Userid from [NXT_Admin].[dbo].UserMaster  with (nolock) where name  =@userid 



If(select count(*) from [NXT_Admin].[dbo].UserRolePermission where USERID=@Maxuserid  and roleid=40)=0
begin

Insert into UserRolePermission 
(
	Userid
	,Roleid
	,ProjectId
	,createDate
	,CreateBy
	,UpdateDate
	,UpdateBy
)
  select 
  	@Maxuserid Userid
	,40 Roleid
	,1 ProjectId
	,getdate() createDate
	,'Admin' CreateBy
	,''UpdateDate
	,'' UpdateBy
end
   
FETCH NEXT FROM db_cursor INTO @userid,@password
END 

CLOSE db_cursor  
DEALLOCATE db_cursor 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_NewEmployee_Mimmansa_Onetime
-- --------------------------------------------------
--select * into UserMaster_Bkp08June2021 from [dbo].UserMaster with (nolock)
--select * into UserRolePermission_Bkp08Jun2021 from [NXT_Admin].[dbo].UserRolePermission  with (nolock)

CREATE procedure usp_NewEmployee_Mimmansa_Onetime
as

Begin 

Declare @Created_date Date =Convert(Date,Getdate())
Declare @userid varchar(100),@password varchar(100)

Create table #tbl_Emp_Master
(
USER_ID varchar(100),
password varchar(100) 

)

Insert into #tbl_Emp_Master
SELECT USER_ID,password FROM [196.1.115.132].mimansa.dbo.tbl_Emp_Master em with (nolock)
where USER_ID 
not in (select name from [NXT_Admin].[dbo].UserMaster with (nolock))
--and USER_ID in (
--	'AUUL003'
--	,'AUUL004'
--	,'AUUL005'
--	,'AUUL006'
--	,'AUUL007'
--	,'AUUL008'
--	,'AUUL009'
--	,'AUUL010'
--)


DECLARE db_cursor CURSOR FOR 
SELECT USER_ID,password FROM #tbl_Emp_Master
--where 
	--convert(date,Created_date)=@Created_date 
--and
 --user_id in (
	--'AALNA001'
	--,'AHNG001'
	--)

OPEN db_cursor  
FETCH NEXT FROM db_cursor INTO @userid,@password

WHILE @@FETCH_STATUS = 0  
BEGIN  

Declare @Maxuserid bigint
select @Maxuserid=max(userid)+1 from [dbo].[UserMaster] with (nolock)

--Declare @Password varchar(100)

SELECT @Password=Password FROM #tbl_Emp_Master WHERE USER_ID =@userid


If(select count(*) from [NXT_Admin].[dbo].[UserMaster]  where name=@userid)=0
begin
		insert into [NXT_Admin].[dbo].[UserMaster] 
		select 
			@Maxuserid Userid
			,@userid Name
			,@Password password
			,1 Active
			,getdate() createDate
			,'Admin' CreateBy
			,'' UpdateDate
			,'' UpdateBy

END

select @Maxuserid=Userid from [NXT_Admin].[dbo].UserMaster  where name  =@userid 

If(select count(*) from [NXT_Admin].[dbo].UserRolePermission where USERID=@Maxuserid  and roleid=40)=0
begin

Insert into UserRolePermission 
(
	Userid
	,Roleid
	,ProjectId
	,createDate
	,CreateBy
	,UpdateDate
	,UpdateBy
)
  select 
  	@Maxuserid Userid
	,40 Roleid
	,1 ProjectId
	,getdate() createDate
	,'Admin' CreateBy
	,''UpdateDate
	,'' UpdateBy
end
   
FETCH NEXT FROM db_cursor INTO @userid,@password
END 

CLOSE db_cursor  
DEALLOCATE db_cursor 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_NewModuleActionControllAddition
-- --------------------------------------------------


CREATE Procedure [dbo].[Usp_NewModuleActionControllAddition]
(
	--@Moduleid varchar(100)
	--,
	@ModuleName varchar(100)
	,@Parentid  INT
	,@Type varchar(100) ='Menu'
	,@ControllerName varchar(100)
	--,@ControllerId INT
	--,@Actionid INT
	,@ActionName Varchar(110)
)

as
begin


--select* from Modulemaster where ModuleName='Mutual Fund'   --50
--select* from Modulemaster where Parentid=50
--select * from Modulemaster  where modulename='Square off intimation (T)'   --125
--select * from Modulemaster  where modulename='Equity'   --parentid 46
--select * from ControllerMaster where ControllerName='MyClient'
--select * from ActionMaster where ActionName='Totalcashsqoff'



Declare @Moduleid varchar(100)
,@ControllerId INT
,@Actionid INT


--Declare @ModuleName varchar(100)
--Declare @Parentid  INT
--Declare @Type varchar(100) ='Menu'
--Declare @ControllerName varchar(100)
--Declare @ControllerId INT
--Declare @Actionid INT
--Declare @ActionName Varchar(110)



IF NOT EXISTS(SELECT * FROM Modulemaster WITH (NOLOCK)  WHERE ModuleName=@ModuleName)
BEGIN 
		INSERT INTO ModuleMaster(Projectid,ModuleName,Type,Parentid,createDate,CreateBy,FreePaid)
		Values(1,@ModuleName,@Type,@Parentid ,GETDATE(),'Admin','Free')

		Select @Moduleid=@@IDENTITY
END
ELSE 
BEGIN 

		SELECT @Moduleid=ModuleId FROM Modulemaster WITH (NOLOCK) WHERE ModuleName=@ModuleName
END

-------------------------Controller -------------------

IF NOT EXISTS(SELECT * FROM ControllerMaster WITH (NOLOCK) WHERE ControllerName=@ControllerName)
BEGIN 

		INSERT INTO ControllerMaster (ControllerName) VALUES(@ControllerName)
		SELECT @ControllerId =@@IDENTITY

		-- select '1',@ControllerId

END
ELSE
BEGIN
		--SELECT @ControllerId =IDENT_CURRENT('ControllerMaster')
		--select '2',@ControllerId
		SELECT @ControllerId=ControllerId FROM ControllerMaster WITH (NOLOCK) WHERE ControllerName=@ControllerName


END


--------------------------Action--------------

IF NOT EXISTS(SELECT * FROM ActionMaster WITH (NOLOCK) WHERE ActionName=@ActionName)
BEGIN 

		Insert into ActionMaster(ActionName,ControllerId) Values(@ActionName,@ControllerId)
		SELECT @Actionid =@@IDENTITY


END
BEGIN

		--SELECT @Actionid =IDENT_CURRENT('ActionMaster')
		SELECT @Actionid=ActionId FROM ActionMaster WITH (NOLOCK) WHERE ActionName=@ActionName


END

--------------------------ModuleMappingMaster --------------------------------

IF NOT EXISTS(SELECT * FROM ModuleMappingMaster WITH (NOLOCK) WHERE ModuleId=@ModuleId and ControllerId=@ControllerId and ActionId =@ActionId)
BEGIN 

Insert into ModuleMappingMaster(ModuleId,ControllerId,ActionId,FreePaid,Active,createDate,CreateBy)
Values(@Moduleid,@ControllerId,@Actionid,'Free',1,GETDATE(),'System')

END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_NewModuleAddition
-- --------------------------------------------------

CREATE Procedure usp_NewModuleAddition
(
@ModuleName varchar(100),
@ParentId INT

)
as
begin

--Declare @ParentId INT,
Declare @ModuleId INT
--Declare @ModuleName varchar(100)

--EXEC  usp_NewModuleAddition 'Insurance',0

--Select @ParentId=146,@ModuleName='Stock SIP'



INSERT INTO ModuleMaster(Projectid,ModuleName,Type,Parentid,createDate,CreateBy,FreePaid)
		Values(1,@ModuleName,'Menu',@ParentId ,GETDATE(),'Admin','Free')



Select @ModuleId=ModuleId from ModuleMaster where modulename=@ModuleName


insert into ModuleRoleMapping 
(
Roleid
,ModuleID
,Active
,CreatedBy
,UpdatedBy
,UpdateDate
,createDate
,FreePaid
,FromDate
,ToDate
,Reason
,UserIPaddress

)

select 
Roleid
,@ModuleId ModuleID
,Active
,CreatedBy
,UpdatedBy
,getdate() UpdateDate
,getdate() createDate
,FreePaid
,FromDate
,ToDate
,Reason
,UserIPaddress

 from ModuleRoleMapping where moduleid=56

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_NXTException
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_NXTException]
(
 @GUID			varchar	(200)
,@ModuleName	varchar	(500)
,@Stage			varchar	(200)
,@Exception		varchar	(MAX)
,@CreatedBy		varchar	(100)
	

)

AS
BEGIN 

SET NOCOUNT ON

INSERT INTO NXTException
(
 GUID
,ModuleName
,Stage
,Exception
,CreatedBy
,CreatedOn
)

Values 
(
@GUID		
,@ModuleName
,@Stage		
,@Exception	
,@CreatedBy	
,GETDATE()
)

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ProjectMaster
-- --------------------------------------------------

CREATE PROCEDURE usp_ProjectMaster
(
		@ProjectName VARCHAR(200)	
)

AS
BEGIN 

--usp_AddNewRole 'AAA','Node','10'

SET NOCOUNT ON 
BEGIN TRANSACTION
BEGIN TRY 

	INSERT INTO ProjectMaster(ProjectName)
	Select 	@ProjectName
	
	Commit


END TRY  
BEGIN CATCH  
   	SELECT  
        ERROR_NUMBER() AS ErrorNumber  
        ,ERROR_SEVERITY() AS ErrorSeverity  
        ,ERROR_STATE() AS ErrorState  
        ,ERROR_PROCEDURE() AS ErrorProcedure  
        ,ERROR_LINE() AS ErrorLine  
        ,ERROR_MESSAGE() AS ErrorMessage;  
 Rollback
END CATCH

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Details
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Details]
(	

	@client_Code  varchar(200)=NULL,
	@Mode varchar(20)= NULL,
	--@fyear varchar(20),
	@fromdt date = NULL,
	@todt date = NULL
	 
)

/*
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='RP61', @fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='P51295',@Mode='LUMSUM',@fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details] ''
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='ALWR1937',@Mode=null,@fromdt='2017-06-07',@todt='2018-06-07'
*/
AS
BEGIN



	      
	IF (@Mode='Lumsum')    
	BEGIN    
		SET @Mode=''    
	END  


	




	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			ExistCode Client_Code,FirstHolderName Client_Name,tbl_clientdetails.tdate,tbl_clientdetails.ISIN,SM.SchemeName,SM.SchemeClassDescription,TrxnMode
			,FolioNo
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) BalanceUnit
			,tbl_clientdetails.Units
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,dpflag Mode,TranCode,Cr_amt,dr_amt,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem',SubTranType ,fund_code,schcode
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select ISIN,tdate,TrxnMode, FolioNo,OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
			union all		   
			
			select ISIN,tdate,TrxnMode,FolioNo, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON tbl_clientdetails.schcode=SM.SchemeCode
	where (IM.ExistCode = @client_Code or @client_Code IS NULL)


	Select distinct C.Client_Code,C.Client_Name,
	SM.SchemeClassDescription AS Trxn_Mode,
	C.SchemeClassDescription,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode, 
	C.tdate AS [DATE],C.[Invested/Redeem],C.FolioNo,MF.AMC_NAME,c.SchemeName,mf.LastNAVPrice NAV,C.Units,C.Amount,'' AS [Net Payable ( Revenue)],'' AS[Type of Revenue]
	INTO #Final
	from #tbl_clientdetails C
	left join (
			SELECT distinct party_Code,fndmst.name as AMC_NAME,fndmst.code,fsSchemeCode,LastNAVPrice from IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
			inner join MutualFund.dbo.vw_FundMaster fndmst WITH (NOLOCK)
			on hldg.fund_code = fndmst.code
			)mf
	on c.Client_Code = mf.party_Code
	and C.fund_code = mf.code
	and C.schcode=substring(fsSchemeCode,2,len(fsSchemeCode))
	LEFT JOIN MutualFund.dbo.SchemeMaster SM  WITH (NOLOCK) ON C.schcode=SM.SchemeCode
	where  (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)

	DECLARE @Sub_Broker  varchar(20)     
	select @Sub_Broker=sub_broker from sb_client_details where cl_code=@client_Code


	Declare  @Brokerage Table
	(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
	)
--INSERT INTO @Brokerage
--EXEC mutualfund.dbo.[usp_BillTransaction_Angel] @AgentCode= 'EMT',@BillPeriodFrom='01/11/2017',@BillPeriodTo ='30/11/2017'

INSERT INTO @Brokerage
EXEC mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @Sub_Broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt

	
	--select * from @Brokerage where [Client Code]='RP61'

	SELECT distinct
		F.Client_Code,F.Client_Name,F.Trxn_Mode,F.SchemeClassDescription,case when f.Mode = 'lumsum' then 'Lumpsum' else f.Mode END as Mode,F.DATE,
		F.[Invested/Redeem],F.FolioNo,F.AMC_NAME,
		F.SchemeName,F.NAV,F.Units,F.Amount,
		ISNULL(B.Commission,0.00) as [Net Payable ( Revenue)],B.[Revenue Type] as [Type of Revenue]
		FROM  #Final F
		left JOIN @Brokerage B 
	ON 
		F.Client_Code=B.[Client Code] AND F.FolioNo=B.[Folio No]
		and B.[Trxn Date]=F.DATE
where ISNULL(B.Commission,0.00)>0
	order by 
		ISNULL(B.Commission,0.00) DESC

	--WHERE Mode LIKE @Mode 
			
	DROP TABLE #tbl_clientdetails
	drop table #Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Details_bkp_20180424
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Details_bkp_20180424]
(	

	@client_Code  varchar(200)=NULL,
	@Mode varchar(20)= NULL,
	--@fyear varchar(20),
	@fromdt date = NULL,
	@todt date = NULL
	 
)

/*
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='RP61', @fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='P51295',@Mode='LUMSUM',@fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details] ''
*/
AS
BEGIN



	      
	IF (@Mode='Lumsum')    
	BEGIN    
		SET @Mode=''    
	END  


	




	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			ExistCode Client_Code,FirstHolderName Client_Name,tbl_clientdetails.tdate,tbl_clientdetails.ISIN,SM.SchemeName,SM.SchemeClassDescription,TrxnMode
			,FolioNo
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) BalanceUnit
			,tbl_clientdetails.Units
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,dpflag Mode,TranCode,Cr_amt,dr_amt,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem',SubTranType ,fund_code,schcode
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select ISIN,tdate,TrxnMode, FolioNo,OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
			union all		   
			
			select ISIN,tdate,TrxnMode,FolioNo, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON tbl_clientdetails.schcode=SM.SchemeCode
	where (IM.ExistCode = @client_Code or @client_Code IS NULL)


	Select distinct C.Client_Code,C.Client_Name,
	SM.SchemeClassDescription AS Trxn_Mode,
	C.SchemeClassDescription,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode, 
	C.tdate AS [DATE],C.[Invested/Redeem],C.FolioNo,MF.AMC_NAME,c.SchemeName,mf.LastNAVPrice NAV,C.Units,C.Amount,'' AS [Net Payable ( Revenue)],'' AS[Type of Revenue]
	INTO #Final
	from #tbl_clientdetails C
	left join (
			SELECT distinct party_Code,fndmst.name as AMC_NAME,fndmst.code,fsSchemeCode,LastNAVPrice from IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
			inner join MutualFund.dbo.vw_FundMaster fndmst WITH (NOLOCK)
			on hldg.fund_code = fndmst.code
			)mf
	on c.Client_Code = mf.party_Code
	and C.fund_code = mf.code
	and C.schcode=substring(fsSchemeCode,2,len(fsSchemeCode))
	LEFT JOIN MutualFund.dbo.SchemeMaster SM  WITH (NOLOCK) ON C.schcode=SM.SchemeCode
	where  (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)

	DECLARE @Sub_Broker  varchar(20)     
	select @Sub_Broker=sub_broker from sb_client_details where cl_code=@client_Code


	Declare  @Brokerage Table
	(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
	)
--INSERT INTO @Brokerage
--EXEC mutualfund.dbo.[usp_BillTransaction_Angel] @AgentCode= 'EMT',@BillPeriodFrom='01/11/2017',@BillPeriodTo ='30/11/2017'

INSERT INTO @Brokerage
EXEC mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @Sub_Broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt

	
	--select * from @Brokerage where [Client Code]='RP61'

	SELECT distinct
		F.Client_Code,F.Client_Name,F.Trxn_Mode,F.SchemeClassDescription,f.Mode,F.DATE,
		F.[Invested/Redeem],F.FolioNo,F.AMC_NAME,
		F.SchemeName,F.NAV,F.Units,F.Amount,
		ISNULL(B.Commission,0.00) as [Net Payable ( Revenue)],B.[Revenue Type] as [Type of Revenue]
		FROM  #Final F
		left JOIN @Brokerage B 
	ON 
		F.Client_Code=B.[Client Code] AND F.FolioNo=B.[Folio No]
		and B.[Trxn Date]=F.DATE
where ISNULL(B.Commission,0.00)>0
	order by 
		ISNULL(B.Commission,0.00) DESC

	--WHERE Mode LIKE @Mode 
			
	DROP TABLE #tbl_clientdetails
	drop table #Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Details_Bkp07Feb2018
-- --------------------------------------------------
create PROCEDURE [dbo].[Usp_Rpt_Brokerage_Details_Bkp07Feb2018]
(	

	@client_Code  varchar(200)=NULL,
	@Mode varchar(20)= NULL,
	--@fyear varchar(20),
	@fromdt date = NULL,
	@todt date = NULL
	 
)

/*
EXEC Usp_Rpt_Brokerage_Details @client_Code='RP61', @fromdt='2016-01-01',@todt='2018-02-01'
EXEC Usp_Rpt_Brokerage_Details @client_Code='P51295',@Mode='LUMSUM',@fromdt='2016-01-01',@todt='2018-02-01'
EXEC Usp_Rpt_Brokerage_Details ''
*/
AS
BEGIN
	      
	IF (@Mode='Lumsum')    
	BEGIN    
		SET @Mode=''    
	END  


	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			ExistCode Client_Code,FirstHolderName Client_Name,tbl_clientdetails.tdate,tbl_clientdetails.ISIN,SM.SchemeName,SM.SchemeClassDescription,TrxnMode
			,FolioNo,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) BalanceUnit,tbl_clientdetails.Units
			,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,dpflag Mode,TranCode,Cr_amt,dr_amt,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem',SubTranType 				
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM 
	Left join 
		(
			
			select ISIN,tdate,TrxnMode, FolioNo,OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate > @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
			union all		   
			
			select ISIN,tdate,TrxnMode,FolioNo, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate > @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON tbl_clientdetails.schcode=SM.SchemeCode
	where (IM.ExistCode = @client_Code or @client_Code IS NULL)


	Select C.Client_Code,C.Client_Name,
	mf.SCHEME_TYPE AS Trxn_Mode,
	C.SchemeClassDescription,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode, C.tdate AS [DATE],C.[Invested/Redeem],C.FolioNo,MF.AMC_NAME,c.SchemeName,C.NAV,C.Units,C.Amount,'' AS [Net Payable ( Revenue)],'' AS[Type of Revenue]
	INTO #Final
	from #tbl_clientdetails C
	inner join (
			SELECT distinct Scheme_ISIN,SCHEME_TYPE,AMC_NAME from [172.31.16.75].ANGEL_WMS.dbo.dw_mst_SIP_Scheme_Master WITH (NOLOCK)
			)mf
	on c.ISIN = mf.Scheme_ISIN
	
	SELECT * FROM #Final
	--WHERE Mode LIKE @Mode 
			
	DROP TABLE #tbl_clientdetails

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Details_Bkp09Feb2018
-- --------------------------------------------------

Create  PROCEDURE [dbo].[Usp_Rpt_Brokerage_Details_Bkp09Feb2018]
(	

	@client_Code  varchar(200)=NULL,
	@Mode varchar(20)= NULL,
	--@fyear varchar(20),
	@fromdt date = NULL,
	@todt date = NULL
	 
)

/*
EXEC Usp_Rpt_Brokerage_Details @client_Code='RP61', @fromdt='2016-01-01',@todt='2018-02-01'
EXEC Usp_Rpt_Brokerage_Details @client_Code='P51295',@Mode='LUMSUM',@fromdt='2016-01-01',@todt='2018-02-01'
EXEC Usp_Rpt_Brokerage_Details ''
*/
AS
BEGIN
	      
	IF (@Mode='Lumsum')    
	BEGIN    
		SET @Mode=''    
	END  


	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			ExistCode Client_Code,FirstHolderName Client_Name,tbl_clientdetails.tdate,tbl_clientdetails.ISIN,SM.SchemeName,SM.SchemeClassDescription,TrxnMode
			,FolioNo
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) BalanceUnit
			,tbl_clientdetails.Units
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,dpflag Mode,TranCode,Cr_amt,dr_amt,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem',SubTranType ,fund_code,schcode
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select ISIN,tdate,TrxnMode, FolioNo,OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
			union all		   
			
			select ISIN,tdate,TrxnMode,FolioNo, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON tbl_clientdetails.schcode=SM.SchemeCode
	where (IM.ExistCode = @client_Code or @client_Code IS NULL)


	Select distinct C.Client_Code,C.Client_Name,
	SM.SchemeClassDescription AS Trxn_Mode,


	C.SchemeClassDescription,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode, 
	C.tdate AS [DATE],C.[Invested/Redeem],C.FolioNo,MF.AMC_NAME,c.SchemeName,mf.LastNAVPrice NAV,C.Units,C.Amount,'' AS [Net Payable ( Revenue)],'' AS[Type of Revenue]
	INTO #Final
	from #tbl_clientdetails C
	inner join (
			SELECT distinct party_Code,fndmst.name as AMC_NAME,fndmst.code,fsSchemeCode,LastNAVPrice from IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
			inner join MutualFund.dbo.vw_FundMaster fndmst WITH (NOLOCK)
			on hldg.fund_code = fndmst.code
			)mf
	on c.Client_Code = mf.party_Code
	and C.fund_code = mf.code
	and C.schcode=substring(fsSchemeCode,2,len(fsSchemeCode))
	LEFT JOIN MutualFund.dbo.SchemeMaster SM  WITH (NOLOCK) ON C.schcode=SM.SchemeCode


	
	SELECT * FROM #Final order by Amount DESC
	--WHERE Mode LIKE @Mode 
			
	DROP TABLE #tbl_clientdetails
	drop table #Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Details_opti
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Details_opti]
(	

	@client_Code  varchar(200)=NULL,
	@Mode varchar(20)= NULL,
	--@fyear varchar(20),
	@fromdt date = NULL,
	@todt date = NULL
	 
)

/*
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='RP61', @fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='P51295',@Mode='LUMSUM',@fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details] ''
*/
AS
BEGIN



	      
	IF (@Mode='Lumsum')    
	BEGIN    
		SET @Mode=''    
	END  


	




	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			ExistCode Client_Code,FirstHolderName Client_Name,tbl_clientdetails.tdate,tbl_clientdetails.ISIN,SM.SchemeName,SM.SchemeClassDescription,TrxnMode
			,FolioNo
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) BalanceUnit
			,tbl_clientdetails.Units
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,dpflag Mode,TranCode,Cr_amt,dr_amt,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem',SubTranType ,fund_code,schcode
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select ISIN,tdate,TrxnMode, FolioNo,OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
			union all		   
			
			select ISIN,tdate,TrxnMode,FolioNo, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON tbl_clientdetails.schcode=SM.SchemeCode
	where (IM.ExistCode = @client_Code or @client_Code IS NULL)


	Select distinct C.Client_Code,C.Client_Name,
	SM.SchemeClassDescription AS Trxn_Mode,
	C.SchemeClassDescription,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode, 
	C.tdate AS [DATE],C.[Invested/Redeem],C.FolioNo,MF.AMC_NAME,c.SchemeName,mf.LastNAVPrice NAV,C.Units,C.Amount,'' AS [Net Payable ( Revenue)],'' AS[Type of Revenue]
	INTO #Final
	from #tbl_clientdetails C
	left join (
			SELECT distinct party_Code,fndmst.name as AMC_NAME,fndmst.code,fsSchemeCode,LastNAVPrice from IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
			inner join MutualFund.dbo.vw_FundMaster fndmst WITH (NOLOCK)
			on hldg.fund_code = fndmst.code
			)mf
	on c.Client_Code = mf.party_Code
	and C.fund_code = mf.code
	and C.schcode=substring(fsSchemeCode,2,len(fsSchemeCode))
	LEFT JOIN MutualFund.dbo.SchemeMaster SM  WITH (NOLOCK) ON C.schcode=SM.SchemeCode
	where  (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)

	DECLARE @Sub_Broker  varchar(20)     
	select @Sub_Broker=sub_broker from sb_client_details where cl_code=@client_Code


	Declare  @Brokerage Table
	(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
	)
--INSERT INTO @Brokerage
--EXEC mutualfund.dbo.[usp_BillTransaction_Angel] @AgentCode= 'EMT',@BillPeriodFrom='01/11/2017',@BillPeriodTo ='30/11/2017'

INSERT INTO @Brokerage
EXEC mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @Sub_Broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt

	
	--select * from @Brokerage where [Client Code]='RP61'

	SELECT distinct
		F.Client_Code,F.Client_Name,F.Trxn_Mode,F.SchemeClassDescription,f.Mode,F.DATE,
		F.[Invested/Redeem],F.FolioNo,F.AMC_NAME,
		F.SchemeName,F.NAV,F.Units,F.Amount,
		ISNULL(B.Commission,0.00) as [Net Payable ( Revenue)],B.[Revenue Type] as [Type of Revenue]
		FROM  #Final F
		left JOIN @Brokerage B 
	ON 
		F.Client_Code=B.[Client Code] AND F.FolioNo=B.[Folio No]
		and B.[Trxn Date]=F.DATE
where ISNULL(B.Commission,0.00)>0
	order by 
		ISNULL(B.Commission,0.00) DESC

	--WHERE Mode LIKE @Mode 
			
	DROP TABLE #tbl_clientdetails
	drop table #Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Details_v1
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Details_v1]
(	

	@client_Code  varchar(200)=NULL,
	@Mode varchar(20)= NULL,
	--@fyear varchar(20),
	@fromdt date = NULL,
	@todt date = NULL
	 
)

/*
EXEC [Usp_Rpt_Brokerage_Details_v1] @client_Code='RP61', @fromdt='2016-11-27',@todt='2018-11-28'

2017-10-17 
EXEC [Usp_Rpt_Brokerage_Details] @client_Code='P51295',@Mode='LUMSUM',@fromdt='2016-01-01',@todt='2018-02-01'
EXEC [Usp_Rpt_Brokerage_Details] ''
*/
AS
BEGIN



	      
	IF (@Mode='Lumsum')    
	BEGIN    
		SET @Mode=''    
	END  


	




	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			ExistCode Client_Code,FirstHolderName Client_Name,tbl_clientdetails.tdate,tbl_clientdetails.ISIN,SM.SchemeName
			,SM.SchemeClassDescription,TrxnMode
			,FolioNo
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) BalanceUnit
			,tbl_clientdetails.Units
			--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,dpflag Mode,TranCode,Cr_amt,dr_amt,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem',SubTranType ,fund_code,schcode
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select ISIN,tdate,TrxnMode, FolioNo,OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (Convert(date,tdate) >= @fromdt or @fromdt IS NULL) 
			and (Convert(date,tdate) <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
			union all		   
			
			select ISIN,tdate,TrxnMode,FolioNo, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) 
			where (Clientcode = @client_Code or @client_Code IS NULL)
			and (Convert(date,tdate) >= @fromdt or @fromdt IS NULL) 
			and (Convert(date,tdate) <= @todt or @todt IS NULL)
			AND (SubTranType = @Mode OR @Mode IS NULL)
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON tbl_clientdetails.schcode=SM.SchemeCode
	where (IM.ExistCode = @client_Code or @client_Code IS NULL)


	Select distinct C.Client_Code,C.Client_Name,
	SM.SchemeClassDescription AS Trxn_Mode,
	C.SchemeClassDescription,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode, 
	C.tdate AS [DATE],C.[Invested/Redeem],C.FolioNo,MF.AMC_NAME,c.SchemeName,mf.LastNAVPrice NAV,C.Units,C.Amount,'' AS [Net Payable ( Revenue)],'' AS[Type of Revenue]
	INTO #Final
	from #tbl_clientdetails C
	left join (
			SELECT distinct party_Code,fndmst.name as AMC_NAME,fndmst.code,fsSchemeCode,LastNAVPrice from IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
			inner join MutualFund.dbo.vw_FundMaster fndmst WITH (NOLOCK)
			on hldg.fund_code = fndmst.code
			)mf
	on c.Client_Code = mf.party_Code
	and C.fund_code = mf.code
	and C.schcode=substring(fsSchemeCode,2,len(fsSchemeCode))
	LEFT JOIN MutualFund.dbo.SchemeMaster SM  WITH (NOLOCK) ON C.schcode=SM.SchemeCode
	where  (Convert(date,tdate) >= @fromdt or @fromdt IS NULL) 
			and (Convert(date,tdate) <= @todt or @todt IS NULL)

	DECLARE @Sub_Broker  varchar(20)     
	select @Sub_Broker=sub_broker from sb_client_details where cl_code=@client_Code


	Declare  @Brokerage Table
	(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
	)
--INSERT INTO @Brokerage
--EXEC mutualfund.dbo.[usp_BillTransaction_Angel] @AgentCode= 'EMT',@BillPeriodFrom='01/11/2017',@BillPeriodTo ='30/11/2017'

INSERT INTO @Brokerage
EXEC mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @Sub_Broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt

	
	--select * from @Brokerage where [Client Code]='RP61'

	SELECT distinct
		F.Client_Code,F.Client_Name,F.Trxn_Mode,F.SchemeClassDescription,f.Mode,F.DATE,
		F.[Invested/Redeem],F.FolioNo,F.AMC_NAME,
		F.SchemeName,F.NAV,F.Units,F.Amount,
		ISNULL(B.Commission,0.00) as [Net Payable ( Revenue)],B.[Revenue Type] as [Type of Revenue]
		FROM  #Final F
		left JOIN @Brokerage B 
	ON 
		F.Client_Code=B.[Client Code] AND F.FolioNo=B.[Folio No]
		and B.[Trxn Date]=F.DATE
where ISNULL(B.Commission,0.00)>0
	order by 
		ISNULL(B.Commission,0.00) DESC

	--WHERE Mode LIKE @Mode 
			
	DROP TABLE #tbl_clientdetails
	drop table #Final

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)



--EXEC [dbo].[Usp_Rpt_Brokerage_Summary_Bkp14Feb2018] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC [dbo].[Usp_Rpt_Brokerage_Summary] @sub_broker='GDS',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC NXT.[dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='PJMA',@fromdt='2017-11-01',@todt ='2017-11-30'



AS
BEGIN


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

insert into @Brokerage
exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt


--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
				UNION
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)


			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			SUM(ISNULL(SIP,0)) SIP,
			SUM(ISNULL(Lumsum,0)) Lumsum,
			SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
		Into #Final1
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type



	 select * from #Final1 order by Remisier desc ,SIP desc ,Lumsum Desc
	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	DROP TABLE #Final1
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary_13042018
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary_13042018]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)



--EXEC [dbo].[Usp_Rpt_Brokerage_Summary_Bkp14Feb2018] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC [dbo].[Usp_Rpt_Brokerage_Summary] @sub_broker='GDS',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC NXT.[dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='PJMA',@fromdt='2017-11-01',@todt ='2017-11-30'



AS
BEGIN


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

insert into @Brokerage
exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt


--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
				UNION
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)


			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			SUM(ISNULL(SIP,0)) SIP,
			SUM(ISNULL(Lumsum,0)) Lumsum,
			SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
		Into #Final1
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type



	 select * from #Final1 order by Remisier desc ,SIP desc ,Lumsum Desc
	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	DROP TABLE #Final1
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary_Bkp14Feb2018
-- --------------------------------------------------
Create  PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary_Bkp14Feb2018]
(	

	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)

	--EXEC [Usp_Rpt_Brokerage_Summary_New] @sub_broker='EMT'

AS
BEGIN


--Create table #Temp
--(
--		ClientCode Varchar(200),
--		SchemeType Varchar(200),
--		Remisier Numeric(18,4)
--)

--Insert into #Temp values ('rp61','SIP',100)
--Insert into #Temp values ('rp61','SIP',10)
--Insert into #Temp values ('rp61','SIP',10)

--Insert into #Temp values ('rp61','LUMSUM',10)
--Insert into #Temp values ('rp61','LUMSUM',10)
--Insert into #Temp values ('rp61','LUMSUM',10)




	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
			s.sub_broker,
			Clientcode,
			Amount Cr_amt, 0 as dr_amt 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			
			union all		   
			
			select 
			s.sub_broker,
			Clientcode,
			0 Cr_amt, Amount dr_amt 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TS WITH (NOLOCK) 
			ON s.party_code = TS.Clientcode 
			where S.sub_broker = @sub_broker
			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	


	
	SELECT 
			Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			0.00 SIP,
			0.00 Lumsum,
			0.00 AS Remisier
			
	 FROM #tbl_clientdetails
	 WHERE sub_broker = @sub_broker
	Group by Client_Code,Client_Name
	--order by GrossBrokerage DESC
			
	DROP TABLE #tbl_clientdetails
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary_New]
(	

	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)

	--EXEC [Usp_Rpt_Brokerage_Summary_New] @sub_broker='EMT'

AS
BEGIN


--Create table #Temp
--(
--		ClientCode Varchar(200),
--		SchemeType Varchar(200),
--		Remisier Numeric(18,4)
--)

--Insert into #Temp values ('rp61','SIP',100)
--Insert into #Temp values ('rp61','SIP',10)
--Insert into #Temp values ('rp61','SIP',10)

--Insert into #Temp values ('rp61','LUMSUM',10)
--Insert into #Temp values ('rp61','LUMSUM',10)
--Insert into #Temp values ('rp61','LUMSUM',10)




	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT 
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM 
	Left join 
		(
			
			select 
			s.sub_broker,
			Clientcode,
			Amount Cr_amt, 0 as dr_amt 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			
			union all		   
			
			select 
			s.sub_broker,
			Clientcode,
			0 Cr_amt, Amount dr_amt 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TS WITH (NOLOCK) 
			ON s.party_code = TS.Clientcode 
			where S.sub_broker = @sub_broker
			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Clientcode=IM.ExistCode
	


	
	SELECT 
			Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			0.00 SIP,
			0.00 Lumsum,
			0.00 AS Remisier
			
	 FROM #tbl_clientdetails
	 WHERE sub_broker = @sub_broker
	Group by Client_Code,Client_Name
	--order by GrossBrokerage DESC
			
	DROP TABLE #tbl_clientdetails
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary_New1
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary_New1]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)

--EXEC [dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC NXT.[dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='PJMA',@fromdt='2017-11-01',@todt ='2017-11-30'



AS
BEGIN


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

insert into @Brokerage
exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt


--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
			s.sub_broker,
			Party_Code Client_Code--,
			--Amount Cr_amt, 0 as dr_amt ,
			,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			SUM(ISNULL(SIP,0)) SIP,
			SUM(ISNULL(Lumsum,0)) Lumsum,
			SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type

	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary_OPT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary_OPT]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)



--EXEC [dbo].[Usp_Rpt_Brokerage_Summary_Bkp14Feb2018] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC [dbo].[Usp_Rpt_Brokerage_Summary] @sub_broker='GDS',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC NXT.[dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='PJMA',@fromdt='2017-11-01',@todt ='2017-11-30'

/*

Begin tran
declare @Sdate datetime = getdate()
EXEC [dbo].[Usp_Rpt_Brokerage_Summary_opt] @sub_broker='GDS',@fromdt='2017-11-01',@todt ='2017-11-30'
select datediff(ms,@Sdate,GETDATE())
Rollback tran

*/
AS
BEGIN


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

--insert into @Brokerage
--exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt

select @sub_broker,@todt,@fromdt 
--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	--INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
				UNION
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)


			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			SUM(ISNULL(SIP,0)) SIP,
			SUM(ISNULL(Lumsum,0)) Lumsum,
			SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
		Into #Final1
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type



	 select * from #Final1 order by Remisier desc ,SIP desc ,Lumsum Desc
	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	DROP TABLE #Final1
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary_opti16042018
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary_opti16042018]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)



--EXEC [dbo].[Usp_Rpt_Brokerage_Summary_Bkp14Feb2018] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC [dbo].[Usp_Rpt_Brokerage_Summary] @sub_broker='GDS',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC NXT.[dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='PJMA',@fromdt='2017-11-01',@todt ='2017-11-30'



AS
BEGIN


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

insert into @Brokerage
exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt


--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
				UNION
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)


			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			SUM(ISNULL(SIP,0)) SIP,
			SUM(ISNULL(Lumsum,0)) Lumsum,
			SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
		Into #Final1
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type



	 select * from #Final1 order by Remisier desc ,SIP desc ,Lumsum Desc
	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	DROP TABLE #Final1
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_Brokerage_Summary_Opti27Apr2018
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[Usp_Rpt_Brokerage_Summary_Opti27Apr2018]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)



--EXEC [dbo].[Usp_Rpt_Brokerage_Summary_Bkp14Feb2018] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC [dbo].[Usp_Rpt_Brokerage_Summary] @sub_broker='GDS',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC NXT.[dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='PJMA',@fromdt='2017-11-01',@todt ='2017-11-30'



AS
BEGIN

Declare @investormaster Table 
(
InvGroupCode	varchar(20)
,InvCode	varchar(20)
,RegCode	varchar(10)
,ExistCode	varchar(50)
,FirstHolderName	varchar(100)
,FirstHolderPAN	varchar(75)
,Address1	varchar(200)
,Address2	varchar(200)
,Address3	varchar(200)
,City	varchar(50)
,State	varchar(50)
,PIN	varchar(50)
,PAddress1	varchar(200)
,PAddress2	varchar(200)
,PAddress3	varchar(200)
,PCity	varchar(50)
,PState	varchar(50)
,PPIN	varchar(50)
,Phone	varchar(100)
,PhoneOff	varchar(50)
,PhoneRes	varchar(50)
,FAX	varchar(25)
,Email	varchar(300)
,SecondHolderName	varchar(75)
,SecondHolderPAN	varchar(75)
,ThirdHolderName	varchar(75)
,ThirdHolderPAN	varchar(75)
,CategoryId	numeric(9,8)
,ContactPerName	varchar(100)
,ContactPerPhone	varchar(100)
,ContactPerEmail	varchar(50)
,BankName	varchar(100)
,BranchName	varchar(50)
,BankAccType	varchar(20)
,BankAccNo	varchar(25)
,RMCode	varchar(20)
,AgentCode	varchar(20)
,PaymentModeId	int
,InvTypeId	varchar(2)
,BranchId	varchar(18)
,Mobile	varchar(50)
,PREFIX	varchar(20)
,DOB	datetime
,SendStatementByEmail	char(1)
,Status	varchar(10)
,CRNNo	varchar(20)
,ActiveID	varchar(25)
,Minor	varchar(10)
,GuardianDetail	varchar(200)
,Occupation	varchar(100)
,TaxStatus	varchar(100)
,Nominee	varchar(100)
,Relation	varchar(100)
,GuardianPAN	varchar(50)
,CreatedBy	varchar(20)
,CreationDate	datetime
,ChangedRemarks	varchar(200)
,ChangedBy	varchar(30)
,ChangedDate	datetime
)



select * into #sb_client_details from sb_client_details where sub_broker=@sub_broker



insert into @investormaster
select IM.* from MutualFund.dbo.investormaster IM WITH (NOLOCK) 
inner join #sb_client_details SB ON SB.party_code=IM.ExistCode

select Clientcode,tdate,SubTranType into #tbl_TransactionBuy_UniqueCode_syn from tbl_TransactionBuy_UniqueCode_syn IM with (nolock)
inner join #sb_client_details SB ON SB.party_code=IM.Clientcode
and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)

select Clientcode,tdate,SubTranType  into #tbl_TransactionSale_UniqueCode_syn from tbl_TransactionSale_UniqueCode_syn IM with (nolock)
inner join #sb_client_details SB ON SB.party_code=IM.Clientcode
and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

insert into @Brokerage
exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt


--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	INTO #tbl_clientdetails
	--FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	From @investormaster IM 
	Left join 
		(
			
			select 
					s.sub_broker,
					S.party_code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from #sb_client_details S WITH (NOLOCK)
			LEFT JOIN #tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
				UNION
			select 
					s.sub_broker,
					S.party_code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from #sb_client_details S WITH (NOLOCK)
			LEFT JOIN #tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			SUM(ISNULL(SIP,0)) SIP,
			SUM(ISNULL(Lumsum,0)) Lumsum,
			SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
		Into #Final1
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type



	 select * from #Final1 order by Remisier desc ,SIP desc ,Lumsum Desc
	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	DROP TABLE #Final1
	DROP TABLE #sb_client_details	
	--DROP TABLE @investormaster 

--Drop table #tbl_TransactionBuy_UniqueCode_syn
--Drop table #tbl_TransactionSale_UniqueCode_syn


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USp_Rpt_MF_Party_ProtfolioGainerLoser
-- --------------------------------------------------



--USp_Rpt_MF_Party_ProtfolioGainerLoser 'A104018'


CREATE  PROCEDURE  [dbo].[USp_Rpt_MF_Party_ProtfolioGainerLoser]
(
	@Party_Code  VARCHAR(500)=NULL
)
AS

--[USp_Rpt_MF_Party_ProtfolioGainerLoser] 'A105307'
BEGIN 

SET NOCOUNT ON

				Select sum(A.amount) amount ,A.Clientcode  PartyCode,sum(Units*NAV) Cr_amt
				Into #Buy
				from 
				NXT.dbo.[tbl_TransactionBuy_UniqueCode_New] A With (nolock) 
				--inner join #BOData BO ON BO.PartyCode=A.Clientcode
				where A.Clientcode=@Party_Code
				group by A.Clientcode  
				

				Select sum(A.amount) amount ,A.Clientcode  PartyCode,sum(Units*NAV) dr_amt
				Into #Sale
				from 
				NXT.dbo.[tbl_TransactionSell_UniqueCode] A With (nolock) 
				--inner join #BOData BO ON BO.PartyCode=A.Clientcode
					where A.Clientcode=@Party_Code
				group by A.Clientcode  
			

			--select * from #Buy
			--select * from #Sale

select *,CurrentValue - Case when (CumInflow-CumOutflow)<0 THEN  (CumInflow-CumOutflow)*-1 ELSE (CumInflow-CumOutflow) END  as 'Gain_Loss'
--case when CumOutflow = 0 then  CurrentValue - CumInflow else CurrentValue - (CumInflow-CumOutflow) end as 'GainLoss'  
from (

Select 
--S.Sub_Broker,
MFBuy.Clientcode,
sum((LastNAVPrice*Angel_Qty)) CurrentValue,
max(Cr_amt) CumInflow,
ISNULL(max(dr_amt),0)	CumOutflow,
--ISNULL(max(dr_amt),0)	CumOutflow,
max(Angel_Qty) BalanceUnit,
--ISNULL((sum((LastNAVPrice*Angel_Qty))+max(dr_amt))-(max(Cr_amt)),0)  AS 'Gain_Loss',
sum((LastNAVPrice*Angel_Qty)) GrandTotal
From 
IWMF_trn_current_holding_syn hldg WITH (NOLOCK) 
LEFT JOIN sb_client_details S WITH (NOLOCK)
ON hldg.party_Code=s.party_code
Left join 
(
			select  T.Clientcode, sum(T.Units*T.NAV) Cr_amt--,SUm(units) units
			from 
			tbl_TransactionBuy_UniqueCode_syn T WITH (NOLOCK)
			INNER JOIN sb_client_details S WITH (NOLOCK)
			ON T.Clientcode=s.cl_code 
			where s.cl_code=@Party_Code  
			--where S.sub_broker = @SubBroker
			group by Clientcode
			--,S.sub_broker
) MFBuy 
	ON MFBuy.Clientcode=hldg.party_Code
Left join 
(		
		select * from #Sale
		--select 
		--S.sub_broker,
		--T.Clientcode, sum(T.Units* T.NAV) dr_amt--,SUm(units) units
		--from 
		--	tbl_TransactionSale_UniqueCode_syn T
		--	INNER JOIN sb_client_details S 
		--	ON T.Clientcode=s.cl_code
		--	where s.cl_code=@Party_Code 
		--	--where S.sub_broker = @SubBroker
		--group by Clientcode
		--,S.sub_broker

) mfsell 
	ON mfsell.PartyCode=hldg.party_Code
	where s.cl_code =@Party_Code
	--where S.sub_broker=@SubBroker
	group by MFBuy.Clientcode

) Main Order by 2 Desc

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USp_Rpt_MF_ProtfolioGainerLoser
-- --------------------------------------------------




CREATE PROCEDURE  [dbo].[USp_Rpt_MF_ProtfolioGainerLoser]
(
	@SubBroker VARCHAR(500)='EMT'
)
AS


BEGIN 
/*
EXEC [USp_Rpt_MF_ProtfolioGainerLoser] 'EMT'
EXEC [USp_Rpt_MF_ProtfolioGainerLoser] 'AJYC'
*/
SET NOCOUNT ON

--declare @SubBroker VARCHAR(500) = 'EMT'

	--Select sum(A.amount) amount ,A.Clientcode  PartyCode,sum(Units*NAV) dr_amt
	--			Into #Sale
	--			from 
	--			NXT.dbo.[tbl_TransactionSell_UniqueCode] A With (nolock) 
	--			--inner join #BOData BO ON BO.PartyCode=A.Clientcode
	--				where A.Clientcode=@Party_Code
	--			group by A.Clientcode  

select *,CurrentValue - Case when (CumInflow-CumOutflow)<0 THEN  (CumInflow-CumOutflow)*-1 ELSE (CumInflow-CumOutflow) END  as 'Gain/Loss'
--case when CumOutflow = 0 then  CurrentValue - CumInflow else CurrentValue - (CumInflow-CumOutflow) end as 'GainLoss'  
from (


Select @SubBroker SubBroker,
MFBuy.Clientcode,
sum((LastNAVPrice*Angel_Qty)) CurrentValue,
max(Cr_amt) CumInflow,
ISNULL(max(dr_amt),0)	CumOutflow,
max(Angel_Qty) BalanceUnit,
--ISNULL((sum((LastNAVPrice*Angel_Qty))+max(dr_amt))-(max(Cr_amt)),0)  AS 'Gain/Loss',
sum((LastNAVPrice*Angel_Qty)) GrandTotal
From 
IWMF_trn_current_holding_syn hldg WITH (NOLOCK) 
LEFT JOIN sb_client_details S WITH (NOLOCK)
ON hldg.party_Code=s.party_code
Left join 
(
			select   clsb_code sub_broker,T.Clientcode, sum(T.Units*T.NAV) Cr_amt--,SUm(units) units
			from 
			[tbl_TransactionBuy_UniqueCode_New] T WITH (NOLOCK)
			--INNER JOIN sb_client_details S 
			--ON T.Clientcode=s.cl_code   
			where clsb_code = @SubBroker
			group by clsb_code,Clientcode
) MFBuy 
	ON MFBuy.Clientcode=hldg.party_Code
Left join 
(		
		select clsb_code sub_broker,T.Clientcode,SUM(amount) dr_amt,sum(T.Units*T.NAV) dr_amt1 --,SUm(units) units
		from 
			--tbl_TransactionSale_UniqueCode_syn T
			NXT.dbo.[tbl_TransactionSell_UniqueCode] T With (nolock) 

			--left JOIN sb_client_details S 
			--ON T.Clientcode=s.cl_code
			where clsb_code = @SubBroker
			--and Clientcode='A105307'
			group by clsb_code,T.Clientcode

) mfsell 
	ON mfsell.Clientcode=hldg.party_Code
	and mfsell.sub_broker=S.sub_broker
	where S.sub_broker=@SubBroker
	--and MFBuy.Clientcode='A105307'
	group by S.sub_broker,MFBuy.Clientcode
) Main Order by 3 Desc
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USp_Rpt_MF_ProtfolioGainerLoser_opti
-- --------------------------------------------------

CREATE PROCEDURE  [dbo].[USp_Rpt_MF_ProtfolioGainerLoser_opti]
(
	@SubBroker VARCHAR(500)=NULL
)
AS


BEGIN 
--EXEC [USp_Rpt_MF_ProtfolioGainer/Loser] 'EMT'
SET NOCOUNT ON

--declare @SubBroker VARCHAR(500) = 'EMT'


SELECT  s.sub_broker,MFBuy.Clientcode,sum((LastNAVPrice*Angel_Qty)) CurrentValue,
		max(Cr_amt) CumInflow,ISNULL(max(dr_amt),0)	CumOutflow,max(Angel_Qty) BalanceUnit,
		ISNULL((sum((LastNAVPrice*Angel_Qty))+max(dr_amt))-(max(Cr_amt)),0)  AS 'Gain/Loss',
		sum((LastNAVPrice*Angel_Qty)) GrandTotal
FROM 
		IWMF_trn_current_holding_syn hldg WITH (NOLOCK) 
		LEFT JOIN sb_client_details S
		ON hldg.party_Code=s.cl_code
Left join 
(
			select  S.sub_broker,T.Clientcode, 
					sum(T.Units*T.NAV) Cr_amt--,SUm(units) units
			from 
					tbl_TransactionBuy_UniqueCode_syn T
					INNER JOIN sb_client_details S 
					ON T.Clientcode=s.cl_code   
			where S.sub_broker = 'EMT'
			group by Clientcode,S.sub_broker
) MFBuy 
	ON MFBuy.Clientcode=hldg.party_Code
Left join 
(		
		select S.sub_broker,T.Clientcode, sum(T.Units* T.NAV) dr_amt--,SUm(units) units
		from 
			tbl_TransactionSale_UniqueCode_syn T
			INNER JOIN sb_client_details S 
			ON T.Clientcode=s.cl_code
			where S.sub_broker = @SubBroker
		group by Clientcode,S.sub_broker

) mfsell 
	ON mfsell.Clientcode=hldg.party_Code
	where S.sub_broker='EMT'
	group by S.sub_broker,MFBuy.Clientcode

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USp_Rpt_MF_ProtfolioGainerLoser_Opti20Apr2018
-- --------------------------------------------------


CREATE PROCEDURE  [dbo].[USp_Rpt_MF_ProtfolioGainerLoser_Opti20Apr2018]
(
	@SubBroker VARCHAR(500)=NULL
)
AS


BEGIN 
--EXEC [USp_Rpt_MF_ProtfolioGainerLoser_Opti20Apr2018] 'EMT'
SET NOCOUNT ON

--declare @SubBroker VARCHAR(500) = 'EMT'


Select @SubBroker SubBroker,
MFBuy.Clientcode,
sum((LastNAVPrice*Angel_Qty)) CurrentValue,
max(Cr_amt) CumInflow,
ISNULL(max(dr_amt),0)	CumOutflow,
max(Angel_Qty) BalanceUnit,
ISNULL((sum((LastNAVPrice*Angel_Qty))+max(dr_amt))-(max(Cr_amt)),0)  AS 'Gain/Loss',
sum((LastNAVPrice*Angel_Qty)) GrandTotal
From 
IWMF_trn_current_holding_syn hldg WITH (NOLOCK) 
LEFT JOIN sb_client_details S
ON hldg.party_Code=s.party_code
Cross Apply
(
			select  S.sub_broker,T.Clientcode, sum(T.Units*T.NAV) Cr_amt--,SUm(units) units
			from 
			tbl_TransactionBuy_UniqueCode_syn T
			INNER JOIN sb_client_details S 
			ON T.Clientcode=s.cl_code   
			where T.Clientcode=hldg.party_Code and 
			S.sub_broker = @SubBroker
			group by Clientcode,S.sub_broker
) MFBuy 
	
Cross apply
(		
		select S.sub_broker,T.Clientcode, sum(T.Units* T.NAV) dr_amt--,SUm(units) units
		from 
			tbl_TransactionSale_UniqueCode_syn T
			INNER JOIN sb_client_details S 
			ON T.Clientcode=s.cl_code
			where 
			T.Clientcode=hldg.party_Code and 
			S.sub_broker = @SubBroker
		group by Clientcode,S.sub_broker
) mfsell 
	
	where S.sub_broker=@SubBroker
	group by S.sub_broker,MFBuy.Clientcode

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_MF_SubBrokerage_LUMSUM
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_MF_SubBrokerage_LUMSUM]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)

/*
CREATED BY: PRASAD KHARADE

PARAMETER: EXEC [dbo].[Usp_Rpt_MF_SubBrokerage_LUMSUM] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'

*/


AS

--Declare	@sub_broker varchar(200)='EMT',@fromdt date='2017-11-01',@todt date='2017-11-30'
	--@sub_broker varchar(200),
	--@fromdt Date=NULL,
	--@todt Date=NULL

BEGIN


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

insert into @Brokerage
exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt


--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
				UNION
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)


			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			--SUM(ISNULL(SIP,0)) SIP
			SUM(ISNULL(Lumsum,0)) Lumsum
			--SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
		Into #Final1
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type



	 select @sub_broker Sub_Broker,* from #Final1 order by Lumsum desc
	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	DROP TABLE #Final1
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Rpt_MF_SubBrokerage_Sip
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Rpt_MF_SubBrokerage_Sip]
(	

--Declare	@sub_broker varchar(200)='PJMA',@fromdt date='2017-11-01',@todt date='2017-11-30'
	@sub_broker varchar(200),
	@fromdt Date=NULL,
	@todt Date=NULL

	 
)



--EXEC [dbo].[Usp_Rpt_MF_SubBrokerage_Sip] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC [dbo].[Usp_Rpt_Brokerage_Summary] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'
--EXEC NXT.[dbo].[Usp_Rpt_Brokerage_Summary_New1] @sub_broker='EMT',@fromdt='2017-11-01',@todt ='2017-11-30'



AS

--Declare	@sub_broker varchar(200)='EMT',@fromdt date='2017-11-01',@todt date='2017-11-30'
	--@sub_broker varchar(200),
	--@fromdt Date=NULL,
	--@todt Date=NULL

BEGIN


Declare  @Brokerage Table
(
		[Client Code] varchar(255)	
		,[Client Name]	varchar(500)	
		,[Scheme Type]	varchar(25)	
		,[Scheme Name]	varchar(500)	
		,[Investment Type] varchar(25)	
		,[Trxn Date]	date
		,[Folio No]	varchar(50)	
		,[Purchase NAV]	numeric(15,4)
		,[Units]	numeric(15,4)
		,[Amount] numeric(15,2)	
		,[Gross Receipt]	numeric(15,2)
		,[Commission]	numeric(15,2)
		,[Revenue Type] varchar(25)
)

insert into @Brokerage
exec mutualfund.dbo.[usp_BillTransaction_Angel_New] @AgentCode= @sub_broker,@BillPeriodFrom=@fromdt,@BillPeriodTo =@todt


--select * from @Brokerage where [Client Code]='RCB008'

	IF OBJECT_ID ('TEMPDB..#tbl_clientdetails') IS NOT NULL
		DROP TABLE #tbl_clientdetails


	SELECT  
			sub_broker,ExistCode Client_Code,FirstHolderName Client_Name
			--,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.Investment_Type
	INTO #tbl_clientdetails
	FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
	Left join 
		(
			
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)
				UNION
			select 
					s.sub_broker,
					Party_Code Client_Code--,
					--Amount Cr_amt, 0 as dr_amt ,
					,Case when SubTranType='' Then 'LUMPSUM' ELSE 'SIP' END  'Investment_Type' 
			from sb_client_details S WITH (NOLOCK)
			LEFT JOIN tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
			ON s.party_code = TB.Clientcode 
			where S.sub_broker = @sub_broker
			and (tdate >= @fromdt or @fromdt IS NULL) 
			and (tdate <= @todt or @todt IS NULL)


			
	
		) tbl_clientdetails 
	ON tbl_clientdetails.Client_code=IM.ExistCode
	where ExistCode IS NOT NULL
	
	--select * from #tbl_clientdetails where Client_Code in ('RCB069','PJMA','AJMR3501','P79945')

	
	SELECT distinct
			A.Client_Code	,
			UPPER(Client_Name) AS Client_Name,
			--0.00 AS GrossBrokerage,
			--CASE WHEN T.Investment_Type='SIP' THEN (Commission) ELSE 0 END SIP,
			--CASE WHEN T.Investment_Type='LUMPSUM' THEN (Commission) ELSE 0 END Lumsum,
			SIP_Commission SIP,
			LUMPSUM_Commission Lumsum,


			NULL AS Remisier
	Into #Final		
	 FROM #tbl_clientdetails A
	 
	 outer apply 
	 (
		Select SUM(Commission) SIP_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and  B.[Investment Type]='SIP'
		group by B.[Client Code]
	 ) T

	 outer apply 
	 (
		Select SUM(Commission) LUMPSUM_Commission,[Client Code] AS Client_Code
		from  @Brokerage B where  A.Client_Code=B.[Client Code] and A.[Investment_Type]=B.[Investment Type]
		and B.[Investment Type]='LUMPSUM'
		group by B.[Client Code]
	 ) T1
	 WHERE A.sub_broker = @sub_broker
	 and (SIP_Commission>0 or LUMPSUM_Commission>0)

	 --select * from 		#Final where Client_Code='RCS121'


	 Select 
	 		Client_Code	,
			(Client_Name) AS Client_Name,
			SUM(ISNULL(SIP,0)) SIP
			--SUM(ISNULL(Lumsum,0)) Lumsum,
			--SUM(ISNULL(SIP,0)+ISNULL(Lumsum,0)) AS Remisier
		Into #Final1
	  from 
	 #Final
	 group by Client_Code,Client_Name --,Investment_Type



	 select @sub_broker Sub_Broker,* from #Final1 order by SIP desc
	 		
	DROP TABLE #tbl_clientdetails
	DROP TABLE #Final
	DROP TABLE #Final1
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFclient_portfolio
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[usp_rpt_MFclient_portfolio]
	@client_Code varchar(20) = null,
	@cLient_name varchar(200) = null,
	@mobileno varchar(50) = null
as 

--EXEC [dbo].[usp_rpt_MFclient_portfolio] 'rp61'


begin
	select party_code as CLIENT_CODE, investmst.FirstHolderName as CLIENT_NAME, fndmst.name as AMC_NAME,
		hldng.schemeName as SCHEME_NAME, hldng.angel_qty as UNITS, folio_no 'Demat id/Folio no', LAstNavPrice as NAV_RATE, LastNAVDate as NAV_DATE,
		CONVERT(Numeric(18,4),(hldng.angel_qty * LAstNavPrice)) as MARKET_VALUE
	from dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	join MutualFund.dbo.investormaster investmst WITH (NOLOCK)
	on hldng.party_code = investmst.existcode
	join MutualFund.dbo.vw_FundMaster fndmst WITH (NOLOCK) 
	on hldng.fund_code = fndmst.code
	where (party_code = @client_Code or isnull(@client_Code, '') = '')
	and (investmst.FirstHolderName like @cLient_name or isnull(@cLient_name, '') = '')
	and (investmst.PhoneRes = @mobileno or isnull(@mobileno, '') = '')
	order by party_code, hldng.schemeName
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFClientList
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[usp_rpt_MFClientList]
--declare
 @ClientCode VARCHAR(20)=null,
 @Mobile BIGINT = NULL,
 @ClientName VARCHAR(100) = Null
 AS 
 BEGIN
	
	---EXEC [usp_rpt_MFClientList] 'rp61'
	
	if OBJECT_ID('tempdb.#MandateDetails') is not null
		drop table #MandateDetails
	select * into #MandateDetails from
	(
		select sclientcode, sMandateID, nAmount, dRegistrationDate from [196.1.115.132].mutualfund.dbo.tblxsipmandatedetails WITH (NOLOCK) where sclientcode = @ClientCode
		union all
		select sclientcode, sMandateID, nAmount, InsertedOn as dRegistrationDate from [196.1.115.132].mutualfund.dbo.tblsipmandatedetails WITH (NOLOCK) where sclientcode = @ClientCode
	)a
	
	SELECT	
		CD.Cl_code,	
		CD.short_name,
		MF.CltDpId as DematId,
		MF.Mobile_NO,
		MF.Email_ID,
		case when(mnd.sMandateID <> 0) then 'YES' else 'NO' end as ECSMandate,
		mnd.nAmount as MandateValue, 
		mnd.dRegistrationDate as ECSREGDate,
		CD.First_Active_date as ActivationDate,
		CD.Last_inactive_date as InActiveDate,
		MF.Bank_Name,
		MF.NEFTCODE as IFSCCOde, 
		MF.Acc_No,
		(Select MAX(T1) from	(
							select MAX(tdate) as T1 from tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) where Clientcode=@ClientCode
							UNION
							select MAX(tdate) as T1 from tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) where Clientcode=@ClientCode
							) test ) as [Last Trade date]
	FROM 
		[196.1.115.132].risk.dbo.client_details CD WITH (NOLOCK)
		JOIN [196.1.115.200].bsemfss.dbo.MFSS_CLIENT MF WITH (NOLOCK)
		ON MF.Party_code=CD.cl_code
		join #MandateDetails mnd
		on CD.cl_code = mnd.sclientcode
	WHERE 
		(CD.cl_code=@ClientCode) 
		and (CD.Mobile_pager=@Mobile or @Mobile is null) 
		and (CD.short_name=@ClientName or @ClientName is null)



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFSubBrokerTranTotal
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[usp_rpt_MFSubBrokerTranTotal]
(
	@Sub_Broker VARCHAR(500)=NULL,
	@client_Code VARCHAR(500)=NULL
)
AS


BEGIN 
/*
EXEC [usp_rpt_MFSubBrokerTranTotal_New] 'GDS'
EXEC [usp_rpt_MFSubBrokerTranTotal] 'GDS'
EXEC [usp_rpt_MFSubBrokerTranTotal_111] 'AJYC','ALWR1937'
EXEC [usp_rpt_MFSubBrokerTranTotal] 'AJYC','ALWR1937'
EXEC [usp_rpt_MFSubBrokerTranTotal] 'A119382'
*/
select *,
 ISNULL((ISNULL(CurrentValue,0)+isnull(CumOutflow,0))-ISNULL(CumInflow,0),0) as 'GainLoss'

--CurrentValue - Case when (CumInflow-CumOutflow)<0 THEN  (CumInflow-CumOutflow)*-1 ELSE (CumInflow-CumOutflow) END  as 'GainLoss'
--case when CumOutflow = 0 then  CurrentValue - CumInflow else CurrentValue - (CumInflow-CumOutflow) end as 'GainLoss'
--,DPFlag
from (
SELECT 
		hldg.party_Code client_Code,long_name,
		ISNULL(sum((LastNAVPrice*Angel_Qty)),0) CurrentValue,
		ISNULL(max(Cr_amt),0) CumInflow,
		ISNULL(max(dr_amt),0)	CumOutflow
		,CAse when DPFlag='DP' THEN 'Demat' ELSE 'Physical' END DPFlag
		--ISNULL((sum((LastNAVPrice*Angel_Qty))+max(dr_amt))-(max(Cr_amt)),0)  AS 'GainLoss'
FROM 
IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
left join sb_client_details SB WITH (NOLOCK)
ON SB.party_code=hldg.party_Code 
Left join 
(
		
			SELECT  Clientcode, sum(Units*nav) Cr_amt--,SUm(units) units
			FROM 
			tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) --WHERE Clientcode = @client_Code
			GROUP BY Clientcode
) MFBuy ON MFBuy.Clientcode=hldg.party_Code
Left join 
(		
		SELECT Clientcode, sum(Units* nav) dr_amt--,SUm(units) units
		FROM 
			tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) --WHERE Clientcode = @client_Code
		GROUP BY Clientcode

) mfsell ON mfsell.Clientcode=hldg.party_Code
WHERE --sb.party_Code='rp61' and 
Sub_Broker =@Sub_Broker 
GROUP BY hldg.party_Code,long_name,DPFlag
) Main order by 3 desc

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFSubBrokerTranTotal_New
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[usp_rpt_MFSubBrokerTranTotal_New]
(
	@Sub_Broker VARCHAR(500)=NULL,
	@client_Code VARCHAR(500)=NULL
)
AS


BEGIN 
/*
EXEC [usp_rpt_MFSubBrokerTranTotal_New] 'GDS'
EXEC [usp_rpt_MFSubBrokerTranTotal] 'GDS'
EXEC [usp_rpt_MFTranTotal] 'rp61'
EXEC [usp_rpt_MFSubBrokerTranTotal] 'A119382'
*/
select *,CurrentValue - Case when (CumInflow-CumOutflow)<0 THEN  (CumInflow-CumOutflow)*-1 ELSE (CumInflow-CumOutflow) END  as 'GainLoss'
--case when CumOutflow = 0 then  CurrentValue - CumInflow else CurrentValue - (CumInflow-CumOutflow) end as 'GainLoss'
--,DPFlag
from (
SELECT 
		hldg.party_Code client_Code,long_name,
		ISNULL(sum((LastNAVPrice*Angel_Qty)),0) CurrentValue,
		ISNULL(max(Cr_amt),0) CumInflow,
		ISNULL(max(dr_amt),0)	CumOutflow
		,CAse when DPFlag='DP' THEN 'Demat' ELSE 'Physical' END DPFlag
		--ISNULL((sum((LastNAVPrice*Angel_Qty))+max(dr_amt))-(max(Cr_amt)),0)  AS 'GainLoss'
FROM 
IWMF_trn_current_holding_syn hldg WITH (NOLOCK)
left join sb_client_details SB
ON SB.party_code=hldg.party_Code 
Left join 
(
		
			SELECT  Clientcode, sum(Units*nav) Cr_amt--,SUm(units) units
			FROM 
			tbl_TransactionBuy_UniqueCode_syn --WHERE Clientcode = @client_Code
			GROUP BY Clientcode
) MFBuy ON MFBuy.Clientcode=hldg.party_Code
Left join 
(		
		SELECT Clientcode, sum(Units* nav) dr_amt--,SUm(units) units
		FROM 
			tbl_TransactionSale_UniqueCode_syn --WHERE Clientcode = @client_Code
		GROUP BY Clientcode

) mfsell ON mfsell.Clientcode=hldg.party_Code
WHERE --sb.party_Code='rp61' and 
Sub_Broker =@Sub_Broker 
GROUP BY hldg.party_Code,long_name,DPFlag
) Main order by 3 desc

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail
-- --------------------------------------------------
CREATE   PROCEDURE  [dbo].[usp_rpt_MFTranDetail]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 
/*
exec [usp_rpt_MFTranDetail] 'rp61'
exec usp_rpt_MFTranDetail_New111 'SRRC1002'

exec [usp_rpt_MFTranDetail] 'A120968'
exec usp_rpt_MFTranDetail_New111 'A120968'

exec [usp_rpt_MFTranDetail] 'srrc1002'
exec usp_rpt_MFTranDetail_New111 'srrc1002'

*/
SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		--,hld.dpflag
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		--,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		--,OrgTRType 'Invested/Redeem' 
		,TranType 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss
			

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
inner join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType

		from 
			tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
		from 
			tbl_Transactionsale_UniqueCode_syn WITH (NOLOCK) where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM WITH (NOLOCK) ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD WITH (NOLOCK) ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode

WHERE 
IM.ExistCode =@client_Code 

--select '#tbl_clientdetails',tdate,[Invested/Redeem],* from #tbl_clientdetails





SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	--sum(Nav1) amount,
	sum(amount) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main 

FROM  #tbl_clientdetails a
where SchemeName not like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	--sum(Nav1) amount,
	sum(amount) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	and b.TranCode <= a.TranCode
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main1

FROM  #tbl_clientdetails a
where SchemeName like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code,TranCode
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];





--select 1 ,* from #Main
select * from (select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  ,
	 CAse when DPFlag='DP' THEN 'Demat' ELSE 'Physical' END DPFlag

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2

	UNION ALL

select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  ,
	 CAse when DPFlag='DP' THEN 'Demat' ELSE 'Physical' END DPFlag

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main1 M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2)
	 temp
	 order by Client_Code,Client_Name,SchemeName,tdate,[Invested/Redeem]



	
DROP TABLE #tbl_clientdetails
--DROP TABLE #Buy
--DROP TABLE #Sale
DROP TABLE #Main
--DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_bkp_20180503
-- --------------------------------------------------




CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_bkp_20180503]
(

--Declare 	
@client_Code VARCHAR(500)=NULL--'rp61'
)
AS


BEGIN 


--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail] 'rp61'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		,0 BalanceUnit
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode


WHERE 
IM.ExistCode =@client_Code 



--select * from #tbl_clientdetails


;WITH CTE AS
	(
		SELECT t2.TranCode,
			   t2.tdate, 
			   --t2.Cr_amt, 
			   --t2.dr_amt, 
			 --   t2.Cr_Units, 
				--t2.dr_Units,
				t1.SchemeName,
			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
		FROM #tbl_clientdetails t1 
		INNER JOIN #tbl_clientdetails t2
			ON t1.TranCode <= t2.TranCode
		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
	)
	SELECT * into #Final1
	FROM CTE
	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
	order by TranCode desc


	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
	INTO #Final2
	from #Final1 F
	inner join #tbl_clientdetails C
	ON F.TranCode=C.TranCode
	and F.SchemeName=C.SchemeName




	
	--SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	--C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
	-- --C.BalanceUnit,
	-- Final.Balance BalanceUnit,
	-- Final.Mode1 Mode2 ,
	--C.FolioNo,
	--hldng.LastNAVDate,
	----C.NAV
	----,
	--C.NAV*Final.Balance [Present Value]
	----into #Last2
	--FROM #tbl_clientdetails C
	--left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	--ON hldng.party_Code=C.Client_Code
	--AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	--AND  C.fund_code=hldng.fund_code
	--inner join #Final2 Final
	--ON Final.Client_Code=C.Client_Code
	--	and Final.SchemeName=C.SchemeName
	--	and Final.tdate=C.tdate


SELECT DISTINCT 
	C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,
	SCHEME_TYPE as Type,
	CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	C.[Invested/Redeem] [Invested/Redeem],Sum(C.Units) Units,max(C.NAV) NAV,
	--C.Units*C.NAV Amount ,
	--SUM(ISNULL(RedeemableUnit,0)) BalanceUnit,
	SUM(ISNULL(Final.Balance,0)) BalanceUnit,

	 Final.Mode1 Mode2 ,
	C.FolioNo,
	hldng.LastNAVDate
	--,
	--C.NAV*RedeemableUnit [Present Value]
	Into #Final
	FROM #tbl_clientdetails C
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=C.Client_Code 
	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND  C.fund_code=hldng.fund_code
	inner join #Final2 Final
	ON Final.Client_Code=C.Client_Code
		and Final.SchemeName=C.SchemeName
		and Final.tdate=C.tdate
	group by C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END
	,C.[Invested/Redeem],Final.Mode1,C.FolioNo,hldng.LastNAVDate

--select *  from #Last2


select *,Units*NAV Amount ,NAV*BalanceUnit [Present Value]  from #Final





		
DROP TABLE #tbl_clientdetails
DROP TABLE #Final2
DROP TABLE #Final1
--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_BKP_20180507
-- --------------------------------------------------

create PROCEDURE  [dbo].[usp_rpt_MFTranDetail_BKP_20180507]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 


--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail] 'rp61'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		,0 BalanceUnit
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode
WHERE 
IM.ExistCode =@client_Code 

select ISIN,tdate, OrgTRType, 'Cr' dr_cr, sum(Units) Cr_Units,Clientcode,SUM(Amount) Cr_amt--, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
Into #Buy	
from 
	tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
group by ISIN,tdate, OrgTRType,Clientcode

select ISIN,tdate, CAse when OrgTRType='Redemption' THEN 'Redeem' END OrgTRType, 'Dr' dr_cr, Sum(Units) dr_Units,Clientcode
INTO #Sale
from 
	tbl_TransactionSell_UniqueCode where Clientcode = @client_Code
	group by ISIN,tdate, OrgTRType,Clientcode



--select * from #Buy where 	ISIN='INF247L01478'


;WITH CTE AS
	(
		SELECT t2.TranCode,
			   t2.tdate, 
			   --t2.Cr_amt, 
			   --t2.dr_amt, 
			 --   t2.Cr_Units, 
				--t2.dr_Units,
				t1.SchemeName,
			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
		FROM #tbl_clientdetails t1 
		INNER JOIN #tbl_clientdetails t2
			ON t1.TranCode <= t2.TranCode
		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
	)
	SELECT * into #Final1
	FROM CTE
	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
	order by TranCode desc


	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
	INTO #Final2
	from #Final1 F
	inner join #tbl_clientdetails C
	ON F.TranCode=C.TranCode
	and F.SchemeName=C.SchemeName




	
	--SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	--C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
	-- --C.BalanceUnit,
	-- Final.Balance BalanceUnit,
	-- Final.Mode1 Mode2 ,
	--C.FolioNo,
	--hldng.LastNAVDate,
	----C.NAV
	----,
	--C.NAV*Final.Balance [Present Value]
	----into #Last2
	--FROM #tbl_clientdetails C
	--left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	--ON hldng.party_Code=C.Client_Code
	--AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	--AND  C.fund_code=hldng.fund_code
	--inner join #Final2 Final
	--ON Final.Client_Code=C.Client_Code
	--	and Final.SchemeName=C.SchemeName
	--	and Final.tdate=C.tdate


SELECT DISTINCT 
	C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,
	SCHEME_TYPE as Type,
	CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	C.[Invested/Redeem] [Invested/Redeem],
	--Sum(C.Units) Units,
	max(C.NAV) NAV,
	--C.Units*C.NAV Amount ,
	--SUM(ISNULL(RedeemableUnit,0)) BalanceUnit,
	SUM(ISNULL(Final.Balance,0)) BalanceUnit,

	 Final.Mode1 Mode2 ,
	C.FolioNo,
	hldng.LastNAVDate
	--,
	--C.NAV*RedeemableUnit [Present Value]
	Into #Final
	FROM #tbl_clientdetails C
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=C.Client_Code 
	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND  C.fund_code=hldng.fund_code
	inner join #Final2 Final
	ON Final.Client_Code=C.Client_Code
		and Final.SchemeName=C.SchemeName
		and Final.tdate=C.tdate
		and final.[Invested/Redeem] = C.[Invested/Redeem]
	group by C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END
	,C.[Invested/Redeem],Final.Mode1,C.FolioNo,hldng.LastNAVDate

--select *  from #Last2


select 
	Client_Code,
	Client_Name ,
	SchemeName,
	A.ISIN, 
	A.tdate,
	Type,
	Mode,
	[Invested/Redeem],
	NAV,
	BalanceUnit,
	Mode2 ,
	FolioNo,
	LastNAVDate,
ISNULL(B.Cr_Units,C.dr_Units) Units,
ISNULL(B.Cr_Units,C.dr_Units)*NAV Amount ,NAV*BalanceUnit [Present Value]  from #Final A
left join #Buy B ON B.ISIN=A.ISIN   and B.tdate=A.tdate and  /*B.OrgTRType=A.[Invested/Redeem]  and */A.Client_Code=B.Clientcode
Left join #Sale C ON C.ISIN=A.ISIN   and C.tdate=A.tdate and  /*C.OrgTRType=A.[Invested/Redeem] and */ A.Client_Code=C.Clientcode
--where  A.Client_Code = 'RP61'
--	and A.ISIN='INF247L01478'

	
DROP TABLE #tbl_clientdetails
DROP TABLE #Final2
DROP TABLE #Final1
DROP TABLE #Buy
DROP TABLE #Sale
DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_bkp_20180509
-- --------------------------------------------------



CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_bkp_20180509]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 

--select 7.9900*4243.5931

--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail] 'A120968'
--exec [usp_rpt_MFTranDetail] 'A120968'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		--,hld.dpflag
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		--,OrgTRType 'Invested/Redeem' 
		--,TranType 
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType

		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode

WHERE 
IM.ExistCode =@client_Code 

--select '#tbl_clientdetails',tdate,[Invested/Redeem],* from #tbl_clientdetails





SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	sum(Nav1) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main 

FROM  #tbl_clientdetails a
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];





--select 1 ,* from #Main
select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2





--select ISIN,tdate, OrgTRType, 'Cr' dr_cr, sum(Units) Cr_Units,Clientcode,SUM(Amount) Cr_amt--, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
--Into #Buy	
--from 
--	tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
--group by ISIN,tdate, OrgTRType,Clientcode

--select ISIN,tdate, CAse when OrgTRType='Redemption' THEN 'Redeem' END OrgTRType, 'Dr' dr_cr, Sum(Units) dr_Units,Clientcode
--INTO #Sale
--from 
--	tbl_TransactionSell_UniqueCode where Clientcode = @client_Code
--	group by ISIN,tdate, OrgTRType,Clientcode



--select * from #Buy where 	ISIN='INF247L01478'


--;WITH CTE AS
--	(
--		SELECT t2.TranCode,
--			   t2.tdate, 
--			   --t2.Cr_amt, 
--			   --t2.dr_amt, 
--			 --   t2.Cr_Units, 
--				--t2.dr_Units,
--				t1.SchemeName,
--			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
--		FROM #tbl_clientdetails t1 
--		INNER JOIN #tbl_clientdetails t2
--			ON t1.TranCode <= t2.TranCode
--		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
--	)
--	SELECT * into #Final1
--	FROM CTE
--	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
--	order by TranCode desc


--	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
--	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
--	INTO #Final2
--	from #Final1 F
--	inner join #tbl_clientdetails C
--	ON F.TranCode=C.TranCode
--	and F.SchemeName=C.SchemeName

--	select '#Final2',* from #Final2


	
--	--SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	--C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
--	-- --C.BalanceUnit,
--	-- Final.Balance BalanceUnit,
--	-- Final.Mode1 Mode2 ,
--	--C.FolioNo,
--	--hldng.LastNAVDate,
--	----C.NAV
--	----,
--	--C.NAV*Final.Balance [Present Value]
--	----into #Last2
--	--FROM #tbl_clientdetails C
--	--left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	--ON hldng.party_Code=C.Client_Code
--	--AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	--AND  C.fund_code=hldng.fund_code
--	--inner join #Final2 Final
--	--ON Final.Client_Code=C.Client_Code
--	--	and Final.SchemeName=C.SchemeName
--	--	and Final.tdate=C.tdate


--SELECT DISTINCT 
--	C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,
--	SCHEME_TYPE as Type,
--	CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	C.[Invested/Redeem] [Invested/Redeem],
--	--Sum(C.Units) Units,
--	max(C.NAV) NAV,
--	--C.Units*C.NAV Amount ,
--	--SUM(ISNULL(RedeemableUnit,0)) BalanceUnit,
--	SUM(ISNULL(Final.Balance,0)) BalanceUnit,

--	 Final.Mode1 Mode2 ,
--	C.FolioNo,
--	hldng.LastNAVDate
--	--,
--	--C.NAV*RedeemableUnit [Present Value]
--	Into #Final
--	FROM #tbl_clientdetails C
--	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	ON hldng.party_Code=C.Client_Code 
--	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	AND  C.fund_code=hldng.fund_code
--	inner join #Final2 Final
--	ON Final.Client_Code=C.Client_Code
--		and Final.SchemeName=C.SchemeName
--		and Final.tdate=C.tdate
--		and final.[Invested/Redeem] = C.[Invested/Redeem]
--	group by C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END
--	,C.[Invested/Redeem],Final.Mode1,C.FolioNo,hldng.LastNAVDate

----select *  from #Last2


--select 
--	Client_Code,
--	Client_Name ,
--	SchemeName,
--	A.ISIN, 
--	A.tdate,
--	Type,
--	Mode,
--	[Invested/Redeem],
--	NAV,
--	BalanceUnit,
--	Mode2 ,
--	FolioNo,
--	LastNAVDate,
--ISNULL(B.Cr_Units,C.dr_Units) Units,
--ISNULL(B.Cr_Units,C.dr_Units)*NAV Amount ,NAV*BalanceUnit [Present Value]  from #Final A
--left join #Buy B ON B.ISIN=A.ISIN   and B.tdate=A.tdate and  /*B.OrgTRType=A.[Invested/Redeem]  and */A.Client_Code=B.Clientcode
--Left join #Sale C ON C.ISIN=A.ISIN   and C.tdate=A.tdate and  /*C.OrgTRType=A.[Invested/Redeem] and */ A.Client_Code=C.Clientcode
--where  A.Client_Code = 'RP61'
--	and A.ISIN='INF247L01478'

	
DROP TABLE #tbl_clientdetails
--DROP TABLE #Buy
--DROP TABLE #Sale
DROP TABLE #Main
--DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_Bkp04May2018
-- --------------------------------------------------

CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_Bkp04May2018]
(

--Declare 	
@client_Code VARCHAR(500)=NULL--'rp61'
)
AS


BEGIN 


--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail] 'rp61'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		,0 BalanceUnit
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode


WHERE 
IM.ExistCode =@client_Code 



--select * from #tbl_clientdetails


;WITH CTE AS
	(
		SELECT t2.TranCode,
			   t2.tdate, 
			   --t2.Cr_amt, 
			   --t2.dr_amt, 
			 --   t2.Cr_Units, 
				--t2.dr_Units,
				t1.SchemeName,
			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
		FROM #tbl_clientdetails t1 
		INNER JOIN #tbl_clientdetails t2
			ON t1.TranCode <= t2.TranCode
		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
	)
	SELECT * into #Final1
	FROM CTE
	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
	order by TranCode desc


	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
	INTO #Final2
	from #Final1 F
	inner join #tbl_clientdetails C
	ON F.TranCode=C.TranCode
	and F.SchemeName=C.SchemeName




	
	--SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	--C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
	-- --C.BalanceUnit,
	-- Final.Balance BalanceUnit,
	-- Final.Mode1 Mode2 ,
	--C.FolioNo,
	--hldng.LastNAVDate,
	----C.NAV
	----,
	--C.NAV*Final.Balance [Present Value]
	----into #Last2
	--FROM #tbl_clientdetails C
	--left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	--ON hldng.party_Code=C.Client_Code
	--AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	--AND  C.fund_code=hldng.fund_code
	--inner join #Final2 Final
	--ON Final.Client_Code=C.Client_Code
	--	and Final.SchemeName=C.SchemeName
	--	and Final.tdate=C.tdate


SELECT DISTINCT 
	C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,
	SCHEME_TYPE as Type,
	CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	C.[Invested/Redeem] [Invested/Redeem],Sum(C.Units) Units,max(C.NAV) NAV,
	--C.Units*C.NAV Amount ,
	--SUM(ISNULL(RedeemableUnit,0)) BalanceUnit,
	SUM(ISNULL(Final.Balance,0)) BalanceUnit,

	 Final.Mode1 Mode2 ,
	C.FolioNo,
	hldng.LastNAVDate
	--,
	--C.NAV*RedeemableUnit [Present Value]
	Into #Final
	FROM #tbl_clientdetails C
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=C.Client_Code 
	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND  C.fund_code=hldng.fund_code
	inner join #Final2 Final
	ON Final.Client_Code=C.Client_Code
		and Final.SchemeName=C.SchemeName
		and Final.tdate=C.tdate
		and final.[Invested/Redeem] = C.[Invested/Redeem]
	group by C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END
	,C.[Invested/Redeem],Final.Mode1,C.FolioNo,hldng.LastNAVDate

--select *  from #Last2


select *,Units*NAV Amount ,NAV*BalanceUnit [Present Value]  from #Final





		
DROP TABLE #tbl_clientdetails
DROP TABLE #Final2
DROP TABLE #Final1
--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_Bkp06Feb2018
-- --------------------------------------------------
Create   PROCEDURE  [dbo].[usp_rpt_MFTranDetail_Bkp06Feb2018]
(
	@client_Code VARCHAR(500)=NULL
)
AS


BEGIN 


--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail] 'rp61'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,Angel_Qty AS BalanceUnit
		,tbl_clientdetails.Units,tbl_clientdetails.isin
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		,TranCode
		,Cr_amt
		,dr_amt
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Purchase/Redeem'
		,SubTranType 	
		,SM.SchemeClassDescription SCHEME_TYPE
		,FolioNo
		,schcode,tbl_clientdetails.fund_code
INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select tdate, OrgTRType, 'Cr' dr_cr, isin,Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
		,FolioNo

		from 
			tbl_TransactionBuy_UniqueCode_syn where Clientcode = @client_Code
		
		union all		   
		
		select tdate, OrgTRType, 'Dr' dr_cr,isin, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
		,FolioNo
		from 
			tbl_TransactionSale_UniqueCode_syn where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode


WHERE 
IM.ExistCode =@client_Code 


--;WITH CTE AS
--	(
--		SELECT t2.TranCode,
--			   t2.tdate, 
--			   t2.Cr_amt, 
--			   t2.dr_amt, 
--			   SUM(COALESCE(t1.Cr_amt, 0) - COALESCE(t1.dr_amt, 0)) AS Balance
--		FROM #tbl_clientdetails t1 
--		INNER JOIN #tbl_clientdetails t2
--			ON t1.TranCode <= t2.TranCode
--		GROUP BY t2.tdate, t2.TranCode, t2.Cr_amt, t2.dr_amt
--	)
--	SELECT * into #Final
--	FROM CTE
--	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
--	order by TranCode desc


	SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	C.[Purchase/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount , C.BalanceUnit,C.Mode ,
	C.FolioNo,
	hldng.LastNAVDate,
	C.NAV*C.BalanceUnit [Present Value]

	FROM #tbl_clientdetails C
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=C.Client_Code
	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND  C.fund_code=hldng.fund_code
	--inner join 
	--(
		
	--		SELECT distinct Scheme_ISIN,SCHEME_TYPE,AMC_NAME from [172.31.16.75].ANGEL_WMS.dbo.dw_mst_SIP_Scheme_Master WITH (NOLOCK)
	--		)mf
	--on c.ISIN = mf.Scheme_ISIN
	--order by C.TranCode desc
	


		
DROP TABLE #tbl_clientdetails
--DROP TABLE #Final




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_Bkp10May2018
-- --------------------------------------------------




CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_Bkp10May2018]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 

--select 7.9900*4243.5931

--Declare @client_Code  varchar(200)= 'rp61'
--ALWR2110
--exec [usp_rpt_MFTranDetail] 'rp61'
--exec [usp_rpt_MFTranDetail] 'A120968'
--exec [usp_rpt_MFTranDetail] 'A120968'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		--,hld.dpflag
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		--,OrgTRType 'Invested/Redeem' 
		--,TranType 
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss
			

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
inner join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType

		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode

WHERE 
IM.ExistCode =@client_Code 

--select '#tbl_clientdetails',tdate,[Invested/Redeem],* from #tbl_clientdetails





SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	sum(Nav1) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main 

FROM  #tbl_clientdetails a
where SchemeName not like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	sum(Nav1) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	and b.TranCode <= a.TranCode
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main1

FROM  #tbl_clientdetails a
where SchemeName like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code,TranCode
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];





--select 1 ,* from #Main
select * from (select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2

	UNION ALL

select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main1 M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2)
	 temp
	 order by Client_Code,Client_Name,SchemeName,tdate,[Invested/Redeem]




--select ISIN,tdate, OrgTRType, 'Cr' dr_cr, sum(Units) Cr_Units,Clientcode,SUM(Amount) Cr_amt--, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
--Into #Buy	
--from 
--	tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
--group by ISIN,tdate, OrgTRType,Clientcode

--select ISIN,tdate, CAse when OrgTRType='Redemption' THEN 'Redeem' END OrgTRType, 'Dr' dr_cr, Sum(Units) dr_Units,Clientcode
--INTO #Sale
--from 
--	tbl_TransactionSell_UniqueCode where Clientcode = @client_Code
--	group by ISIN,tdate, OrgTRType,Clientcode



--select * from #Buy where 	ISIN='INF247L01478'


--;WITH CTE AS
--	(
--		SELECT t2.TranCode,
--			   t2.tdate, 
--			   --t2.Cr_amt, 
--			   --t2.dr_amt, 
--			 --   t2.Cr_Units, 
--				--t2.dr_Units,
--				t1.SchemeName,
--			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
--		FROM #tbl_clientdetails t1 
--		INNER JOIN #tbl_clientdetails t2
--			ON t1.TranCode <= t2.TranCode
--		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
--	)
--	SELECT * into #Final1
--	FROM CTE
--	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
--	order by TranCode desc


--	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
--	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
--	INTO #Final2
--	from #Final1 F
--	inner join #tbl_clientdetails C
--	ON F.TranCode=C.TranCode
--	and F.SchemeName=C.SchemeName

--	select '#Final2',* from #Final2


	
--	--SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	--C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
--	-- --C.BalanceUnit,
--	-- Final.Balance BalanceUnit,
--	-- Final.Mode1 Mode2 ,
--	--C.FolioNo,
--	--hldng.LastNAVDate,
--	----C.NAV
--	----,
--	--C.NAV*Final.Balance [Present Value]
--	----into #Last2
--	--FROM #tbl_clientdetails C
--	--left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	--ON hldng.party_Code=C.Client_Code
--	--AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	--AND  C.fund_code=hldng.fund_code
--	--inner join #Final2 Final
--	--ON Final.Client_Code=C.Client_Code
--	--	and Final.SchemeName=C.SchemeName
--	--	and Final.tdate=C.tdate


--SELECT DISTINCT 
--	C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,
--	SCHEME_TYPE as Type,
--	CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	C.[Invested/Redeem] [Invested/Redeem],
--	--Sum(C.Units) Units,
--	max(C.NAV) NAV,
--	--C.Units*C.NAV Amount ,
--	--SUM(ISNULL(RedeemableUnit,0)) BalanceUnit,
--	SUM(ISNULL(Final.Balance,0)) BalanceUnit,

--	 Final.Mode1 Mode2 ,
--	C.FolioNo,
--	hldng.LastNAVDate
--	--,
--	--C.NAV*RedeemableUnit [Present Value]
--	Into #Final
--	FROM #tbl_clientdetails C
--	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	ON hldng.party_Code=C.Client_Code 
--	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	AND  C.fund_code=hldng.fund_code
--	inner join #Final2 Final
--	ON Final.Client_Code=C.Client_Code
--		and Final.SchemeName=C.SchemeName
--		and Final.tdate=C.tdate
--		and final.[Invested/Redeem] = C.[Invested/Redeem]
--	group by C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END
--	,C.[Invested/Redeem],Final.Mode1,C.FolioNo,hldng.LastNAVDate

----select *  from #Last2


--select 
--	Client_Code,
--	Client_Name ,
--	SchemeName,
--	A.ISIN, 
--	A.tdate,
--	Type,
--	Mode,
--	[Invested/Redeem],
--	NAV,
--	BalanceUnit,
--	Mode2 ,
--	FolioNo,
--	LastNAVDate,
--ISNULL(B.Cr_Units,C.dr_Units) Units,
--ISNULL(B.Cr_Units,C.dr_Units)*NAV Amount ,NAV*BalanceUnit [Present Value]  from #Final A
--left join #Buy B ON B.ISIN=A.ISIN   and B.tdate=A.tdate and  /*B.OrgTRType=A.[Invested/Redeem]  and */A.Client_Code=B.Clientcode
--Left join #Sale C ON C.ISIN=A.ISIN   and C.tdate=A.tdate and  /*C.OrgTRType=A.[Invested/Redeem] and */ A.Client_Code=C.Clientcode
--where  A.Client_Code = 'RP61'
--	and A.ISIN='INF247L01478'

	
DROP TABLE #tbl_clientdetails
--DROP TABLE #Buy
--DROP TABLE #Sale
DROP TABLE #Main
--DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_Bkp26Apr2018
-- --------------------------------------------------




CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_Bkp26Apr2018]
(

--Declare 	
@client_Code VARCHAR(500)=NULL--'rp61'
)
AS


BEGIN 


--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail_Old1] 'rp61'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		,0 BalanceUnit
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode


WHERE 
IM.ExistCode =@client_Code 



--select * from #tbl_clientdetails


;WITH CTE AS
	(
		SELECT t2.TranCode,
			   t2.tdate, 
			   --t2.Cr_amt, 
			   --t2.dr_amt, 
			 --   t2.Cr_Units, 
				--t2.dr_Units,
				t1.SchemeName,
			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
		FROM #tbl_clientdetails t1 
		INNER JOIN #tbl_clientdetails t2
			ON t1.TranCode <= t2.TranCode
		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
	)
	SELECT * into #Final1
	FROM CTE
	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
	order by TranCode desc


	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
	INTO #Final2
	from #Final1 F
	inner join #tbl_clientdetails C
	ON F.TranCode=C.TranCode
	and F.SchemeName=C.SchemeName




	
	SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
	 --C.BalanceUnit,
	 Final.Balance BalanceUnit,
	 Final.Mode1 Mode2 ,
	C.FolioNo,
	hldng.LastNAVDate,
	--C.NAV
	--,
	C.NAV*Final.Balance [Present Value]
	--into #Last2
	FROM #tbl_clientdetails C
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=C.Client_Code
	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND  C.fund_code=hldng.fund_code
	inner join #Final2 Final
	ON Final.Client_Code=C.Client_Code
		and Final.SchemeName=C.SchemeName
		and Final.tdate=C.tdate


--select *  from #Last2




		
DROP TABLE #tbl_clientdetails
DROP TABLE #Final2
DROP TABLE #Final1
--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_BkpWithSubbrokerAdditioinCORRECT_10May2018
-- --------------------------------------------------




CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_BkpWithSubbrokerAdditioinCORRECT_10May2018]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 

Declare @sub_broker Varchar(100)
select @sub_broker=sub_broker from sb_client_details where cl_code=@client_Code


--select 7.9900*4243.5931

--Declare @client_Code  varchar(200)= 'rp61'
--ALWR2110
--exec [usp_rpt_MFTranDetail] 'rp61'
--exec [usp_rpt_MFTranDetail] 'A120968'
--exec [usp_rpt_MFTranDetail] 'A120968'

SET NOCOUNT ON 

SELECT Sub_Broker,
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		--,hld.dpflag
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		--,OrgTRType 'Invested/Redeem' 
		--,TranType 
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss
			

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM with(nolock) 
--FROM MUTUALFUND..vw_InvestorMaster IM with(nolock)
inner join 
	(
		
		select @sub_broker Sub_Broker,
		ISIN,tdate,app_code, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType

		from 
			[dbo].[tbl_TransactionBuy_UniqueCode_syn] where Clientcode = @client_Code and clsb_code=@sub_broker
		
		union all		   
		
		select @sub_broker Sub_Broker,
		ISIN,tdate,app_code, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
		from 
			[dbo].[tbl_TransactionSale_UniqueCode_syn] where Clientcode = @client_Code and clsb_code=@sub_broker

	) tbl_clientdetails --on tbl_clientdetails.app_code=IM.Code
	ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode
--and equitycode is not null 
WHERE 
IM.ExistCode =@client_Code 
and Sub_Broker=@sub_broker

--select '#tbl_clientdetails',tdate,[Invested/Redeem],* from #tbl_clientdetails


--select * from #tbl_clientdetails where dr_Units>0



SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	sum(Nav1) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main 

FROM  #tbl_clientdetails a
where SchemeName not like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	sum(Nav1) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	and b.TranCode <= a.TranCode
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main1

FROM  #tbl_clientdetails a
where SchemeName like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code,TranCode
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];





--select 1 ,* from #Main
select * from (select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2
	--where [Invested/Redeem]='Redeem'

	UNION ALL

select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main1 M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2
	--where [Invested/Redeem]='Redeem'
	)
	 temp

	 order by Client_Code,Client_Name,SchemeName,tdate,[Invested/Redeem]




--select ISIN,tdate, OrgTRType, 'Cr' dr_cr, sum(Units) Cr_Units,Clientcode,SUM(Amount) Cr_amt--, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
--Into #Buy	
--from 
--	tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
--group by ISIN,tdate, OrgTRType,Clientcode

--select ISIN,tdate, CAse when OrgTRType='Redemption' THEN 'Redeem' END OrgTRType, 'Dr' dr_cr, Sum(Units) dr_Units,Clientcode
--INTO #Sale
--from 
--	tbl_TransactionSell_UniqueCode where Clientcode = @client_Code
--	group by ISIN,tdate, OrgTRType,Clientcode



--select * from #Buy where 	ISIN='INF247L01478'


--;WITH CTE AS
--	(
--		SELECT t2.TranCode,
--			   t2.tdate, 
--			   --t2.Cr_amt, 
--			   --t2.dr_amt, 
--			 --   t2.Cr_Units, 
--				--t2.dr_Units,
--				t1.SchemeName,
--			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
--		FROM #tbl_clientdetails t1 
--		INNER JOIN #tbl_clientdetails t2
--			ON t1.TranCode <= t2.TranCode
--		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
--	)
--	SELECT * into #Final1
--	FROM CTE
--	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
--	order by TranCode desc


--	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
--	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
--	INTO #Final2
--	from #Final1 F
--	inner join #tbl_clientdetails C
--	ON F.TranCode=C.TranCode
--	and F.SchemeName=C.SchemeName

--	select '#Final2',* from #Final2


	
--	--SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	--C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
--	-- --C.BalanceUnit,
--	-- Final.Balance BalanceUnit,
--	-- Final.Mode1 Mode2 ,
--	--C.FolioNo,
--	--hldng.LastNAVDate,
--	----C.NAV
--	----,
--	--C.NAV*Final.Balance [Present Value]
--	----into #Last2
--	--FROM #tbl_clientdetails C
--	--left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	--ON hldng.party_Code=C.Client_Code
--	--AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	--AND  C.fund_code=hldng.fund_code
--	--inner join #Final2 Final
--	--ON Final.Client_Code=C.Client_Code
--	--	and Final.SchemeName=C.SchemeName
--	--	and Final.tdate=C.tdate


--SELECT DISTINCT 
--	C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,
--	SCHEME_TYPE as Type,
--	CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	C.[Invested/Redeem] [Invested/Redeem],
--	--Sum(C.Units) Units,
--	max(C.NAV) NAV,
--	--C.Units*C.NAV Amount ,
--	--SUM(ISNULL(RedeemableUnit,0)) BalanceUnit,
--	SUM(ISNULL(Final.Balance,0)) BalanceUnit,

--	 Final.Mode1 Mode2 ,
--	C.FolioNo,
--	hldng.LastNAVDate
--	--,
--	--C.NAV*RedeemableUnit [Present Value]
--	Into #Final
--	FROM #tbl_clientdetails C
--	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	ON hldng.party_Code=C.Client_Code 
--	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	AND  C.fund_code=hldng.fund_code
--	inner join #Final2 Final
--	ON Final.Client_Code=C.Client_Code
--		and Final.SchemeName=C.SchemeName
--		and Final.tdate=C.tdate
--		and final.[Invested/Redeem] = C.[Invested/Redeem]
--	group by C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END
--	,C.[Invested/Redeem],Final.Mode1,C.FolioNo,hldng.LastNAVDate

----select *  from #Last2


--select 
--	Client_Code,
--	Client_Name ,
--	SchemeName,
--	A.ISIN, 
--	A.tdate,
--	Type,
--	Mode,
--	[Invested/Redeem],
--	NAV,
--	BalanceUnit,
--	Mode2 ,
--	FolioNo,
--	LastNAVDate,
--ISNULL(B.Cr_Units,C.dr_Units) Units,
--ISNULL(B.Cr_Units,C.dr_Units)*NAV Amount ,NAV*BalanceUnit [Present Value]  from #Final A
--left join #Buy B ON B.ISIN=A.ISIN   and B.tdate=A.tdate and  /*B.OrgTRType=A.[Invested/Redeem]  and */A.Client_Code=B.Clientcode
--Left join #Sale C ON C.ISIN=A.ISIN   and C.tdate=A.tdate and  /*C.OrgTRType=A.[Invested/Redeem] and */ A.Client_Code=C.Clientcode
--where  A.Client_Code = 'RP61'
--	and A.ISIN='INF247L01478'

	
DROP TABLE #tbl_clientdetails
--DROP TABLE #Buy
--DROP TABLE #Sale
DROP TABLE #Main
--DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_NavChange
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_NavChange]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 
/*
exec [usp_rpt_MFTranDetail] 'H16389'
exec usp_rpt_MFTranDetail_New111 'SRRC1002'

exec [usp_rpt_MFTranDetail] 'A120968'
exec usp_rpt_MFTranDetail_New111 'A120968'

exec [usp_rpt_MFTranDetail] 'srrc1002'
exec usp_rpt_MFTranDetail_New111 'srrc1002'

*/
SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		--,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,LastNAVPrice Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		--,hld.dpflag
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		--,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		--,OrgTRType 'Invested/Redeem' 
		,TranType 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss
			

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
inner join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType

		from 
			tbl_TransactionBuy_UniqueCode_syn where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
		from 
			tbl_Transactionsale_UniqueCode_syn where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode

WHERE 
IM.ExistCode =@client_Code 

--select '#tbl_clientdetails',tdate,[Invested/Redeem],* from #tbl_clientdetails





SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	--sum(Nav1) amount,
	sum(amount) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main 

FROM  #tbl_clientdetails a
where SchemeName not like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	--sum(Nav1) amount,
	sum(amount) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	and b.TranCode <= a.TranCode
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main1

FROM  #tbl_clientdetails a
where SchemeName like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code,TranCode
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];





--select 1 ,* from #Main
select * from (select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  ,
	 CAse when DPFlag='DP' THEN 'Demat' ELSE 'Physical' END DPFlag

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2

	UNION ALL

select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  ,
	 CAse when DPFlag='DP' THEN 'Demat' ELSE 'Physical' END DPFlag

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main1 M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2)
	 temp
	 order by Client_Code,Client_Name,SchemeName,tdate,[Invested/Redeem]



	
DROP TABLE #tbl_clientdetails
--DROP TABLE #Buy
--DROP TABLE #Sale
DROP TABLE #Main
--DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_New
-- --------------------------------------------------



CREATE  PROCEDURE  [dbo].[usp_rpt_MFTranDetail_New]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 

Declare @sub_broker Varchar(100)
select @sub_broker=sub_broker from sb_client_details where cl_code=@client_Code


--select 7.9900*4243.5931

--Declare @client_Code  varchar(200)= 'rp61'
--ALWR2110
--exec [usp_rpt_MFTranDetail] 'rp61'
--exec [usp_rpt_MFTranDetail] 'A120968'
--exec [usp_rpt_MFTranDetail] 'A120968'

SET NOCOUNT ON 

SELECT Sub_Broker,
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		--,hld.dpflag
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		--,OrgTRType 'Invested/Redeem' 
		--,TranType 
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss
			

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM with(nolock) 
--FROM MUTUALFUND..vw_InvestorMaster IM with(nolock)
inner join 
	(
		
		select @sub_broker Sub_Broker,
		ISIN,tdate,app_code, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType

		from 
			[dbo].[tbl_TransactionBuy_UniqueCode_syn] where Clientcode = @client_Code and clsb_code=@sub_broker
		
		union all		   
		
		select @sub_broker Sub_Broker,
		ISIN,tdate,app_code, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
		from 
			[dbo].[tbl_TransactionSale_UniqueCode_syn] where Clientcode = @client_Code and clsb_code=@sub_broker

	) tbl_clientdetails --on tbl_clientdetails.app_code=IM.Code
	ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode
--and equitycode is not null 
WHERE 
IM.ExistCode =@client_Code 
and Sub_Broker=@sub_broker

--select '#tbl_clientdetails',tdate,[Invested/Redeem],* from #tbl_clientdetails


--select * from #tbl_clientdetails where dr_Units>0



SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	sum(Nav1) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main 

FROM  #tbl_clientdetails a
where SchemeName not like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	sum(Nav1) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	and b.TranCode <= a.TranCode
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
 
INTO #Main1

FROM  #tbl_clientdetails a
where SchemeName like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code,TranCode
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];





--select 1 ,* from #Main
select * from (select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2
	--where [Invested/Redeem]='Redeem'

	UNION ALL

select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  

	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main1 M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2
	--where [Invested/Redeem]='Redeem'
	)
	 temp

	 order by Client_Code,Client_Name,SchemeName,tdate,[Invested/Redeem]




--select ISIN,tdate, OrgTRType, 'Cr' dr_cr, sum(Units) Cr_Units,Clientcode,SUM(Amount) Cr_amt--, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
--Into #Buy	
--from 
--	tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
--group by ISIN,tdate, OrgTRType,Clientcode

--select ISIN,tdate, CAse when OrgTRType='Redemption' THEN 'Redeem' END OrgTRType, 'Dr' dr_cr, Sum(Units) dr_Units,Clientcode
--INTO #Sale
--from 
--	tbl_TransactionSell_UniqueCode where Clientcode = @client_Code
--	group by ISIN,tdate, OrgTRType,Clientcode



--select * from #Buy where 	ISIN='INF247L01478'


--;WITH CTE AS
--	(
--		SELECT t2.TranCode,
--			   t2.tdate, 
--			   --t2.Cr_amt, 
--			   --t2.dr_amt, 
--			 --   t2.Cr_Units, 
--				--t2.dr_Units,
--				t1.SchemeName,
--			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
--		FROM #tbl_clientdetails t1 
--		INNER JOIN #tbl_clientdetails t2
--			ON t1.TranCode <= t2.TranCode
--		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
--	)
--	SELECT * into #Final1
--	FROM CTE
--	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
--	order by TranCode desc


--	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
--	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
--	INTO #Final2
--	from #Final1 F
--	inner join #tbl_clientdetails C
--	ON F.TranCode=C.TranCode
--	and F.SchemeName=C.SchemeName

--	select '#Final2',* from #Final2


	
--	--SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	--C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
--	-- --C.BalanceUnit,
--	-- Final.Balance BalanceUnit,
--	-- Final.Mode1 Mode2 ,
--	--C.FolioNo,
--	--hldng.LastNAVDate,
--	----C.NAV
--	----,
--	--C.NAV*Final.Balance [Present Value]
--	----into #Last2
--	--FROM #tbl_clientdetails C
--	--left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	--ON hldng.party_Code=C.Client_Code
--	--AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	--AND  C.fund_code=hldng.fund_code
--	--inner join #Final2 Final
--	--ON Final.Client_Code=C.Client_Code
--	--	and Final.SchemeName=C.SchemeName
--	--	and Final.tdate=C.tdate


--SELECT DISTINCT 
--	C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,
--	SCHEME_TYPE as Type,
--	CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
--	C.[Invested/Redeem] [Invested/Redeem],
--	--Sum(C.Units) Units,
--	max(C.NAV) NAV,
--	--C.Units*C.NAV Amount ,
--	--SUM(ISNULL(RedeemableUnit,0)) BalanceUnit,
--	SUM(ISNULL(Final.Balance,0)) BalanceUnit,

--	 Final.Mode1 Mode2 ,
--	C.FolioNo,
--	hldng.LastNAVDate
--	--,
--	--C.NAV*RedeemableUnit [Present Value]
--	Into #Final
--	FROM #tbl_clientdetails C
--	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
--	ON hldng.party_Code=C.Client_Code 
--	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
--	AND  C.fund_code=hldng.fund_code
--	inner join #Final2 Final
--	ON Final.Client_Code=C.Client_Code
--		and Final.SchemeName=C.SchemeName
--		and Final.tdate=C.tdate
--		and final.[Invested/Redeem] = C.[Invested/Redeem]
--	group by C.Client_Code,C.Client_Name ,C.SchemeName,C.ISIN, C.tdate,SCHEME_TYPE,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END
--	,C.[Invested/Redeem],Final.Mode1,C.FolioNo,hldng.LastNAVDate

----select *  from #Last2


--select 
--	Client_Code,
--	Client_Name ,
--	SchemeName,
--	A.ISIN, 
--	A.tdate,
--	Type,
--	Mode,
--	[Invested/Redeem],
--	NAV,
--	BalanceUnit,
--	Mode2 ,
--	FolioNo,
--	LastNAVDate,
--ISNULL(B.Cr_Units,C.dr_Units) Units,
--ISNULL(B.Cr_Units,C.dr_Units)*NAV Amount ,NAV*BalanceUnit [Present Value]  from #Final A
--left join #Buy B ON B.ISIN=A.ISIN   and B.tdate=A.tdate and  /*B.OrgTRType=A.[Invested/Redeem]  and */A.Client_Code=B.Clientcode
--Left join #Sale C ON C.ISIN=A.ISIN   and C.tdate=A.tdate and  /*C.OrgTRType=A.[Invested/Redeem] and */ A.Client_Code=C.Clientcode
--where  A.Client_Code = 'RP61'
--	and A.ISIN='INF247L01478'

	
DROP TABLE #tbl_clientdetails
--DROP TABLE #Buy
--DROP TABLE #Sale
DROP TABLE #Main
--DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_Old
-- --------------------------------------------------



Create PROCEDURE  [dbo].[usp_rpt_MFTranDetail_Old]
(
	@client_Code VARCHAR(500)=NULL
)
AS


BEGIN 


--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail] 'rp61'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,'Type' as 'Type'
		,0 BalanceUnit
		,tbl_clientdetails.Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,dpflag Mode
		,TranCode
		,Cr_amt
		,dr_amt
		,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem'
		,SubTranType 				
		
INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select tdate, OrgTRType, 'Cr' dr_cr, Units,Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select tdate, OrgTRType, 'Dr' dr_cr, Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode

WHERE 
IM.ExistCode =@client_Code 


;WITH CTE AS
	(
		SELECT t2.TranCode,
			   t2.tdate, 
			   t2.Cr_amt, 
			   t2.dr_amt, 
			   SUM(COALESCE(t1.Cr_amt, 0) - COALESCE(t1.dr_amt, 0)) AS Balance
		FROM #tbl_clientdetails t1 
		INNER JOIN #tbl_clientdetails t2
			ON t1.TranCode <= t2.TranCode
		GROUP BY t2.tdate, t2.TranCode, t2.Cr_amt, t2.dr_amt
	)
	SELECT * into #Final
	FROM CTE
	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
	order by TranCode desc


	Select C.Client_Code,C.Client_Name ,C.SchemeName, C.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],C.Units,C.NAV,C.Amount , F.Balance,C.Mode from #Final F
	inner join #tbl_clientdetails C
	ON F.TranCode=C.TranCode
		order by F.TranCode desc

		
DROP TABLE #tbl_clientdetails
DROP TABLE #Final




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_Old1
-- --------------------------------------------------





CREATE PROCEDURE  [dbo].[usp_rpt_MFTranDetail_Old1]
(

--Declare 	
@client_Code VARCHAR(500)='rp61'
)
AS


BEGIN 


--Declare @client_Code  varchar(200)= 'rp61'

--exec [usp_rpt_MFTranDetail_Old1] 'rp61'

SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,'Type' as 'Type'
		,0 BalanceUnit
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
Left join 
	(
		
		select tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionBuy_UniqueCode_New where Clientcode = @client_Code
		
		union all		   
		
		select tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo
		from 
			tbl_TransactionSell_UniqueCode where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode


WHERE 
IM.ExistCode =@client_Code 



--select * from #tbl_clientdetails


;WITH CTE AS
	(
		SELECT t2.TranCode,
			   t2.tdate, 
			   --t2.Cr_amt, 
			   --t2.dr_amt, 
			 --   t2.Cr_Units, 
				--t2.dr_Units,
				t1.SchemeName,
			   sum(COALESCE(t1.Cr_Units, 0) - COALESCE(t1.dr_Units, 0)) AS Balance
		FROM #tbl_clientdetails t1 
		INNER JOIN #tbl_clientdetails t2
			ON t1.TranCode <= t2.TranCode
		GROUP BY t2.TranCode,t2.tdate,  t2.schcode,t1.SchemeName
	)
	SELECT * into #Final1
	FROM CTE
	--WHERE (tdate >= '2014/01/11' AND tdate <= '2014/02/28' ) 
	order by TranCode desc


	Select distinct C.Client_Code,C.Client_Name ,F.SchemeName, F.tdate,C.Type,C.SubTranType Mode,C.[Invested/Redeem],
	C.NAV,C.Amount , F.Balance,C.Mode Mode1 
	INTO #Final2
	from #Final1 F
	inner join #tbl_clientdetails C
	ON F.TranCode=C.TranCode
	and F.SchemeName=C.SchemeName




	
	SELECT DISTINCT C.Client_Code,C.Client_Name ,C.SchemeName, C.tdate,SCHEME_TYPE as Type,CASE WHEN C.SubTranType='' THEN 'Lumsum' ELSE C.SubTranType END  Mode,
	C.[Invested/Redeem] [Invested/Redeem],C.Units,C.NAV,C.Amount ,
	 --C.BalanceUnit,
	 Final.Balance BalanceUnit,
	 Final.Mode1 Mode2 ,
	C.FolioNo,
	hldng.LastNAVDate,
	--C.NAV
	--,
	C.NAV*Final.Balance [Present Value]
	into #Last2
	FROM #tbl_clientdetails C
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=C.Client_Code
	AND C.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND  C.fund_code=hldng.fund_code
	inner join #Final2 Final
	ON Final.Client_Code=C.Client_Code
		and Final.SchemeName=C.SchemeName
		and Final.tdate=C.tdate


select *  from #Last2




		
DROP TABLE #tbl_clientdetails
DROP TABLE #Final2
DROP TABLE #Final1
DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_V1
-- --------------------------------------------------

/*
-- =============================================
-- Author:		Ashwini Chavan
-- Create date: 11-Jun-2018
-- Description:	MF Portfolio Weekly Performance
-- Modification Details:
-- M001 -- 8-Jun-2018 -- Created new version of SP :"usp_rpt_MFTranDetail" added "Rate" column
-- =============================================
*/

CREATE   PROCEDURE  [dbo].[usp_rpt_MFTranDetail_V1]
(
@client_Code VARCHAR(500)='rp61'
)
AS


BEGIN 
/*
exec [usp_rpt_MFTranDetail_V1] 'A120968'
*/
SET NOCOUNT ON 

		SELECT 
			ExistCode Client_Code	
			,FirstHolderName Client_Name
			,tbl_clientdetails.tdate
			,SM.SchemeName
			,tbl_clientdetails.ISIN
			,'Type' as 'Type'
			,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
			,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
			,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
			,tbl_clientdetails.dpflag Mode
			,TranCode
			,Cr_amt
			,dr_amt
			,Cr_Units
			,dr_Units
			,tbl_clientdetails.schcode
			,TranType 'Invested/Redeem'
			,SubTranType 				
			,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss
			, Rate -- M001
		INTO #tbl_clientdetails
		FROM MutualFund.dbo.investormaster IM 
			inner join 
			(
				select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
				,FolioNo,NAV,TranType
				,NAV as  'Rate' -- M001
				from 
				tbl_TransactionBuy_UniqueCode_syn where Clientcode = @client_Code
		
				union all		   
		
				select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
				,FolioNo,NAV,TranType
				,NAV as  'Rate' -- M001
				from 
				tbl_Transactionsale_UniqueCode_syn where Clientcode = @client_Code

			) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
			LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
			Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
			and HLD.fund_code=tbl_clientdetails.fund_code
			and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode
		WHERE 
			IM.ExistCode =@client_Code 



		SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
			CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
			[Invested/Redeem],
			NAV,
			sum(amount) amount,
			(SELECT SUM(b.Total_unit)
			FROM #tbl_clientdetails b
			WHERE b.tdate <= a.tdate
			AND B.SchemeName = a.SchemeName) as Balance,
			Mode as Mode2 ,
			FolioNo,
			sum(Units) as Units,
			sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
			sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
			,Rate -- M001
		INTO #Main 
		FROM  #tbl_clientdetails a
		where SchemeName not like '%ETF%'
		group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
		,Rate -- M001
		ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

		SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
			CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
			[Invested/Redeem],
			NAV,
			sum(amount) amount,
			(SELECT SUM(b.Total_unit)
			FROM #tbl_clientdetails b
			WHERE b.tdate <= a.tdate
			and b.TranCode <= a.TranCode
			AND B.SchemeName = a.SchemeName) as Balance,
			Mode as Mode2 ,
			FolioNo,
			sum(Units) as Units,
			sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
			sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
			,Rate -- M001
		INTO #Main1
		FROM  #tbl_clientdetails a
		where SchemeName like '%ETF%'
		group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code,TranCode
		,Rate -- M001
		ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

		select * from (select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
			Mode,
			[Invested/Redeem],
			NAV,
			Balance as BalanceUnit,
			Mode2 as Mode2 ,
			FolioNo,
			LastNAVDate,
			units,
			amount ,NAV*Balance [Present Value]  
			,Rate -- M001
		from #Main M
			left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
			ON hldng.party_Code=M.Client_Code 
			AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
			AND M.fund_code=hldng.fund_code
			and hldng.DPFlag = M.Mode2
		UNION ALL
		select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
			Mode,
			[Invested/Redeem],
			NAV,
			Balance as BalanceUnit,
			Mode2 as Mode2 ,
			FolioNo,
			LastNAVDate,
			units,
			amount ,NAV*Balance [Present Value]  
			,Rate -- M001
		from #Main1 M
			left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
			ON hldng.party_Code=M.Client_Code 
			AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
			AND M.fund_code=hldng.fund_code
			and hldng.DPFlag = M.Mode2)
			temp
		order by Client_Code,Client_Name,SchemeName,tdate,[Invested/Redeem]

DROP TABLE #tbl_clientdetails
DROP TABLE #Main
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranDetail_V1_BCK2018Jun11
-- --------------------------------------------------

/*
Modification Details:
M001 -- 8-Jun-2018 added "Rate" column
*/
CREATE   PROCEDURE  [dbo].[usp_rpt_MFTranDetail_V1_BCK2018Jun11]
(
--Declare 	
@client_Code VARCHAR(500)='rp61'
--@client_Code VARCHAR(500)='A120968'--'rp61'
)
AS


BEGIN 
/*
exec [usp_rpt_MFTranDetail_V1_TEST] 'rp61'
exec usp_rpt_MFTranDetail_V1_TEST_New111 'SRRC1002'

exec [usp_rpt_MFTranDetail_V1_TEST] 'A120968'
exec usp_rpt_MFTranDetail_V1_TEST_New111 'A120968'

exec [usp_rpt_MFTranDetail_V1_TEST] 'srrc1002'
exec usp_rpt_MFTranDetail_V1_TEST_New111 'srrc1002'

*/
SET NOCOUNT ON 

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,tbl_clientdetails.tdate
		,SM.SchemeName
		,tbl_clientdetails.ISIN
		,'Type' as 'Type'
		--,tbl_clientdetails.Units
		,Case when Cr_Units>0 Then Cr_Units ELSE dr_Units END Units
		--,0 Nav
		,[dbo].[fn_NavDetails_New] (tbl_clientdetails.schcode,tbl_clientdetails.fund_code) Nav
		,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount
		,tbl_clientdetails.dpflag Mode
		--,hld.dpflag
		,TranCode
		,Cr_amt
		,dr_amt
		,Cr_Units
		,dr_Units
		,tbl_clientdetails.schcode
		--,Case When Cr_amt>0 Then 'Purchase' ELSE 'Redeem' END 'Invested/Redeem'
		--,OrgTRType 'Invested/Redeem' 
		,TranType 'Invested/Redeem'
		,SubTranType 				
		,SM.SchemeClassDescription SCHEME_TYPE
			,FolioNo
			--,schcode
			,tbl_clientdetails.fund_code
			,case when Dr_Units = 0 then  Cr_Units else - dr_Units End Total_unit
			,case when Dr_Units = 0 then  Cr_Units else  dr_Units End * Nav as NAV1
			,Nav as ss
			, Rate -- M001
			

INTO #tbl_clientdetails
FROM MutualFund.dbo.investormaster IM 
inner join 
	(
		
		select ISIN,tdate, OrgTRType, 'Cr' dr_cr, Units Cr_Units,0 dr_Units, Clientcode,Amount Cr_amt, 0 as dr_amt, dpflag,SubTranType,TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
			,NAV as  'Rate' -- M001
		from 
			tbl_TransactionBuy_UniqueCode_syn where Clientcode = @client_Code
		
		union all		   
		
		select ISIN,tdate, OrgTRType, 'Dr' dr_cr, 0 Cr_Units ,Units dr_Units,Clientcode,0 Cr_amt, Amount dr_amt, dpflag,SubTranType, TranCode ,schcode,fund_code
			,FolioNo,NAV,TranType
			,NAV as  'Rate' -- M001
		from 
			tbl_Transactionsale_UniqueCode_syn where Clientcode = @client_Code

	) tbl_clientdetails ON tbl_clientdetails.Clientcode=IM.ExistCode
LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
--LEFT JOIN MutualFund.dbo.SchemeMaster SM ON tbl_clientdetails.schcode=SM.SchemeCode
Left join IWMF_trn_current_holding_syn HLD ON HLD.party_Code=tbl_clientdetails.Clientcode
and HLD.fund_code=tbl_clientdetails.fund_code
and substring(HLD.fsSchemeCode,2,len(HLD.fsSchemeCode))=tbl_clientdetails.schcode

WHERE 
IM.ExistCode =@client_Code 

--select '#tbl_clientdetails',tdate,[Invested/Redeem],* from #tbl_clientdetails





SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	--sum(Nav1) amount,
	sum(amount) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
	,Rate -- M001
INTO #Main 

FROM  #tbl_clientdetails a
where SchemeName not like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code
,Rate -- M001
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];

SELECT Client_Code,Client_Name,SchemeName,ISIN,tdate,Type,
	CASE WHEN SubTranType='' THEN 'Lumsum' ELSE SubTranType END  Mode,
	[Invested/Redeem],
	NAV,
	--sum(Nav1) amount,
	sum(amount) amount,
	(SELECT SUM(b.Total_unit)
    FROM #tbl_clientdetails b
    WHERE b.tdate <= a.tdate
	and b.TranCode <= a.TranCode
	AND B.SchemeName = a.SchemeName) as Balance,
	Mode as Mode2 ,
	FolioNo,
	sum(Units) as Units,--sum(Amount) as Amount,
	sum(Cr_amt) as Cr_amt,sum(dr_amt) as dr_amt,
	sum(Cr_Units) as Cr_Units,sum(dr_Units) as dr_Units,schcode,SubTranType,SCHEME_TYPE,fund_code
	,Rate -- M001
INTO #Main1

FROM  #tbl_clientdetails a
where SchemeName like '%ETF%'
group by Client_Code,Client_Name,tdate,SchemeName,ISIN,Type,Nav,Mode,schcode,[Invested/Redeem],SubTranType,SCHEME_TYPE,FolioNo,fund_code,TranCode
,Rate -- M001
ORDER BY SchemeName,a.tdate,a.[Invested/Redeem];





--select 1 ,* from #Main
select * from (select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  
	 ,Rate -- M001
	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2

	UNION ALL

select Client_Code,Client_Name,M.SchemeName,M.ISIN,tdate,SCHEME_TYPE as Type,
	 Mode,
	[Invested/Redeem],
	NAV,
	Balance as BalanceUnit,
	Mode2 as Mode2 ,
	FolioNo,
	LastNAVDate,
	units,
	 amount ,NAV*Balance [Present Value]  
	 ,Rate -- M001
	--,hldng.party_Code,M.Client_Code ,M.schcode ,SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode)),
	--M.fund_code,hldng.fund_code,hldng.DPFlag , M.Mode2

	
	from #Main1 M
	left join dbo.IWMF_trn_current_holding_syn hldng with(nolock)
	ON hldng.party_Code=M.Client_Code 
	AND M.schcode =SUBSTRING(hldng.fsSchemeCode,2,len(hldng.fsSchemeCode))
	AND M.fund_code=hldng.fund_code
	and hldng.DPFlag = M.Mode2)
	 temp
	 order by Client_Code,Client_Name,SchemeName,tdate,[Invested/Redeem]



	
DROP TABLE #tbl_clientdetails
--DROP TABLE #Buy
--DROP TABLE #Sale
DROP TABLE #Main
--DROP TABLE #Final

--DROP TABLE #Last2



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranSummary
-- --------------------------------------------------
--[usp_rpt_MFTranSummary] @FromDate='2012-08-05 00:00:00.000',@ToDate='2012-08-05 00:00:00.000'
CREATE PROCEDURE [dbo].[usp_rpt_MFTranSummary]
(
		 @client_Code VARCHAR(200)  =NULL 
		,@SchemeName VARCHAR(1000)=NULL  
		,@FromDate Date=NULL
		,@ToDate Date=NULL
)
AS
BEGIN
SET NOCOUNT ON 

--EXEC [usp_rpt_MFTranSummary] @client_Code='rp61',@FromDate='2012-01-01',@ToDate='2018-08-05 00:00:00.000'
--EXEC [usp_rpt_MFTranSummary] @client_Code='CP5576'--,@SchemeName='Franklin India Prima Fund - Growth'--@FromDate='2012-08-05 00:00:00.000',@ToDate='2012-08-05 00:00:00.000'
--EXEC [usp_rpt_MFTranSummary] @SchemeName='SBI Blue Chip Fund - Growth',@FromDate='2018-01-05 00:00:00.000',@ToDate='2018-08-06 00:00:00.000'


SELECT --vtb.tdate,vts.tdate,
	DISTINCT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,SM.SchemeName
		,ISNULL(T.OpeningUnit,0) 'Opening Bal (Units)'                     
		,ISNULL(T.OpeningAmount,0) 'Opening Value(Rs.)'					  
		,T1.BuyUnits [Purchase (Units)]
		,T1.BuyAmount [Purchase Value (Rs.)]	
		,ISNULL(T1.SellUnits,0) [Redemption (Units)] 
		,ISNULL(T1.SellAmount,0) [Redemption Value(Rs.)] 
		,(ISNULL(T.OpeningUnit,0) + isnull(T1.BuyUnits,0) - ISNULL(T1.SellUnits,0))     [Closing Bal (Units)]  
		,(ISNULL(T.OpeningAmount,0) + ISNULL(T1.BuyAmount,0) - isnull(T1.SellAmount,0))  [Closing Value (Rs.)]	 
		,CASE WHEN ISNULL((T.OpeningUnit + T1.BuyUnits - T1.SellUnits),0)>0 THEN (T.OpeningUnit + T1.BuyUnits - T1.SellUnits) ELSE (ISNULL(T.OpeningUnit,0) + T1.BuyUnits - ISNULL(T1.SellUnits,0))  END 'No.of Units(As on date)' 
		,[dbo].[fn_NavDetails_New] (VTB.schcode,VTB.fund_code) 'NAV(As on Date)'
		,CASE when ISNULL(T1.SellAmount,0)>0 THEN (T.OpeningAmount + T1.BuyAmount - ISNULL(T1.SellAmount,0))*[dbo].[fn_NavDetails_New] (VTB.schcode,VTB.fund_code) ELSE  T1.BuyUnits*[dbo].[fn_NavDetails_New] (VTB.schcode,VTB.fund_code)	END 'Amount(As on Date)'	   
		--,	'Action'
		,VTB.BUYSELL 'Action'
		,VTS.BUYSELL 'Action'
FROM MutualFund.dbo.investormaster IM  WITH(NOLOCK)
	LEFT JOIN tbl_TransactionBuy_UniqueCode_syn VTB  WITH(NOLOCK)
	ON IM.ExistCode=VTB.Clientcode
	LEFT JOIN tbl_TransactionSale_UniqueCode_syn VTS  WITH(NOLOCK)
	ON VTB.Clientcode=VTS.Clientcode 
	and VTB.fund_code=VTS.fund_code
	and VTB.schcode=VTS.schcode
	--AND VTB.ISIN=VTS.ISIN
	LEFT JOIN MutualFund.dbo.SchemeMaster SM   WITH(NOLOCK)
	ON VTB.schcode=SM.SchemeCode
	Left join 
	(

			SELECT 
				MFBuy.Clientcode,MFBuy.SchemeName,MFBuy.SchemeCode,MFBuy.fund_code,
				ISNULL((MFSell.Units- MFBuy.Units),0) OpeningUnit,
				ISNULL((MFSell.Amount -MFBuy.Amount),0) OpeningAmount
				--Case When ISNULL((MFSell.Units- MFBuy.Units),0)=0 THEN MFBuy.Units ELSE ISNULL((MFSell.Units- MFBuy.Units),0) END OpeningUnit,
				--Case When ISNULL((MFSell.Amount -MFBuy.Amount),0)=0 THEN  MFBuy.Amount ELSE ISNULL((MFSell.Amount -MFBuy.Amount),0) END OpeningAmount
				--,
				--MFBUY.Units BuyUnits ,
				--MFBUY.Amount BuyAmount ,
				--MFSell.Units SellUnits ,
				--MFSell.Amount SellAmount 
			FROM

			(
				SELECT sum(Units) AS Units,SUM(Amount) AS Amount ,Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
				--,SUM(VTB.Units) Units,SUM(VTB.Amount) Amount

				FROM tbl_TransactionBuy_UniqueCode_syn VTB  WITH(NOLOCK)
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
				where Clientcode = @client_Code
				AND tdate<isnull(@FromDate,getdate())
				GROUP BY Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
			) MFBuy
			left join 
			(
					SELECT sum(Units) AS Units,SUM(Amount) AS Amount ,Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
					--,SUM(VTS.Units) Units,SUM(VTS.Amount) Amount
					FROM tbl_TransactionSale_UniqueCode_syn VTS  WITH(NOLOCK)
					inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) ON VTS.schcode=SM.SchemeCode
					where Clientcode = @client_Code
					AND tdate<ISNULL(@FromDate,GETDATE())
					GROUP BY Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
			) MFSell
			ON MFBuy.Clientcode    =   MFSell.Clientcode
			and MFBuy.SchemeName=MFSell.SchemeName
			and MFBuy.SchemeCode=MFSell.SchemeCode

		) T 
		ON T.Clientcode=IM.ExistCode
		and T.SchemeCode=VTB.schcode
		and T.fund_code=VTB.fund_code

	Left join 
	(

			SELECT 
				MFBuy.Clientcode,MFBuy.SchemeName,MFBuy.SchemeCode,MFBuy.fund_code,
				MFBUY.Units BuyUnits ,
				MFBUY.Amount BuyAmount ,
				MFSell.Units SellUnits ,
				MFSell.Amount SellAmount

			FROM

			(
				SELECT sum(Units) AS Units,SUM(Amount) AS Amount ,Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
				--,SUM(VTB.Units) Units,SUM(VTB.Amount) Amount

				FROM tbl_TransactionBuy_UniqueCode_syn VTB  WITH(NOLOCK)
				inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
				ON VTB.schcode=SM.SchemeCode
				WHERE (Clientcode = @client_Code or @client_Code IS NULL) 
						and (SM.SchemeName = @SchemeName or @SchemeName is null)
						and (vtb.tdate > @FromDate or @FromDate IS NULL) and (vtb.tdate <= @ToDate or @FromDate is NULL)
					  and Clientcode IS NOT NULL
				GROUP BY Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
			) MFBuy
			LEFT JOIN 
			(
					SELECT sum(Units) AS Units,SUM(Amount) AS Amount ,Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
					--,SUM(VTS.Units) Units,SUM(VTS.Amount) Amount
					FROM tbl_TransactionSale_UniqueCode_syn VTS  WITH(NOLOCK)
					inner join MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
					ON VTS.schcode=SM.SchemeCode
					WHERE (Clientcode = @client_Code or @client_Code IS NULL) 
						and (SM.SchemeName = @SchemeName or @SchemeName is null)
						and (VTS.tdate > @FromDate or @FromDate IS NULL) and (VTS.tdate <= @ToDate or @FromDate is NULL)
					  and Clientcode IS NOT NULL
					GROUP BY Clientcode,SM.SchemeName,SM.SchemeCode,fund_code
			) MFSell
			ON MFBuy.Clientcode    =   MFSell.Clientcode
			and MFBuy.SchemeName=MFSell.SchemeName
			and MFBuy.SchemeCode=MFSell.SchemeCode
	) T1
		ON T1.Clientcode=IM.ExistCode
		and T1.SchemeCode=VTB.schcode
		and T1.fund_code=VTB.fund_code





		
WHERE (existcode = @client_Code or @client_Code IS NULL) 
		and (SM.SchemeName = @SchemeName or @SchemeName is null)
		and (vtb.tdate > @FromDate or @FromDate IS NULL) and (vtb.tdate <= @ToDate or @FromDate is NULL)
	  and ExistCode IS NOT NULL
ORDER BY ExistCode

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranSummary_Old
-- --------------------------------------------------
--[usp_rpt_TranSummary_New] @FromDate='2012-08-05 00:00:00.000',@ToDate='2012-08-05 00:00:00.000'
CREATE PROCEDURE [dbo].[usp_rpt_MFTranSummary_Old]
(
		 @client_Code VARCHAR(200)  =NULL 
		,@SchemeName VARCHAR(1000)=NULL  
		,@FromDate Date=NULL
		,@ToDate Date=NULL
)
AS
BEGIN
SET NOCOUNT ON 

--exec [usp_rpt_TranSummary_New] @client_Code='rp61'--,@FromDate='2012-08-05 00:00:00.000',@ToDate='2012-08-05 00:00:00.000'

SELECT 
		ExistCode Client_Code	
		,FirstHolderName Client_Name
		,SM.SchemeName
		--,'Opening Bal (Units)' [Opening Bal (Units)]                      --Need to confirm   
		--,'Opening Value(Rs.)' [Opening Value(Rs.)]					   --Need to confirm   	
		,T.Buy_units [Purchase (Units)]
		,T.Cr_amt  '[Purchase Value (Rs.)]'
		,(T.Buy_units + T.Buy_units - ISNULL(T.Sell_units,0))     [Closing Bal (Units)]  ----Change Formula as per [Opening Bal (Units)]
		,(T.Cr_amt + T.Cr_amt - isnull(T.dr_amt,0))  [Closing Value (Rs.)]	 ----Change Formula as per [Opening Value(Rs.)]
		,CASE WHEN ISNULL((T.Buy_units + T.Buy_units - T.Sell_units),0)>0 THEN (T.Buy_units + T.Buy_units - T.Sell_units) ELSE   T.Buy_units END	'No.of Units(As on date)' ----Change Formula as per [Opening Bal (Units)]
		,[dbo].[fn_NavDetails_New] (scheme_code,fund_code)  'NAV(As on Date)'
		,(T.Buy_units + T.Buy_units - T.Sell_units)*([dbo].[fn_NavDetails_New] (scheme_code,fund_code))	'Amount(As on Date)'	   ----Change Formula as per [Opening Bal (Units)]
		,dr_cr	'Action'
		--,VTB.BUYSELL 'Action'
		--,VTS.BUYSELL 'Action'
FROM MutualFund.dbo.investormaster IM WITH(NOLOCK)
	Left join 
	(

		select tdate, OrgTRType, 'Buy' dr_cr, Amount Cr_amt, 0 as dr_amt, Clientcode, TranCode,units Buy_units,0 Sell_units,schcode scheme_code,fund_code from tbl_TransactionBuy_UniqueCode_New WITH(NOLOCK) where Clientcode = @client_Code
		 union all		   
		select tdate, OrgTRType, 'Sell' dr_cr, 0 Cr_amt, Amount dr_amt, Clientcode, TranCode,0,units Sell_units,schcode scheme_code,fund_code from tbl_TransactionSell_UniqueCode WITH(NOLOCK) where Clientcode = @client_Code
	) T ON Clientcode=IM.ExistCode


	LEFT JOIN MutualFund.dbo.SchemeMaster SM  WITH(NOLOCK) 
	ON replace(T.scheme_code,'G','') =SM.SchemeCode
	--left join (Select * from dbo.[fn_NavDetails] fn where fn.fund_code=T.fund_code and scheme_code=Scheme_code) fn

	--INNER JOIN 
	--(
	--		SELECT convert(varchar(200),T.fund_code) fund_code,	convert(varchar(200),T.Scheme_code) Scheme_code , T.NAV_Date NAV_Date , NAV.NAV 
	--		from MutualFund.dbo.vw_NAV NAV WITH (NOLOCK)
	--		inner join 
	--		(
	--		SELECT fund_code,	Scheme_code , convert(date,max(NAV_Date)) NAV_Date 
	--		FROM MutualFund.dbo.vw_NAV WITH (NOLOCK)
	--		--WHERE (Scheme_code = @SchemeName or @SchemeName is null)
			
	--		--WHERE scheme_code ='14051581.002066' 
	--		GROUP BY fund_code,	Scheme_code
	--		) T ON convert(date,NAV.NAV_Date)=T.NAV_Date
	--		and NAV.fund_code=T.fund_code 
	--		and NAV.Scheme_code=T.Scheme_code
	--		) T1
	--		ON 
	--		VTB.fund_code=T1.fund_code 
	--		AND REPLACE(VTB.scheme_code,'G','')=T1.Scheme_code
WHERE (existcode = @client_Code or @client_Code IS NULL) 
		and (SM.SchemeCode = @SchemeName or @SchemeName is null)
		and (T.tdate > @FromDate or @FromDate IS NULL) and (T.tdate <= @ToDate or @FromDate is NULL)
	  


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_MFTranTotal
-- --------------------------------------------------


CREATE PROCEDURE  [dbo].[usp_rpt_MFTranTotal]
(
	@client_Code VARCHAR(500)=NULL
)
AS


BEGIN 
--EXEC [usp_rpt_MFTranTotal] 'K82540'
--EXEC [usp_rpt_MFTranTotal_1111] 'ALWR1937'


Select @client_Code client_Code,
sum((LastNAVPrice*Angel_Qty)) CurrentValue,
max(Cr_amt) CumInflow,
max(dr_amt)	CumOutflow,
--(sum((isnull(LastNAVPrice,0)*isnull(Angel_Qty,0)))+max(isnull(dr_amt,0)))-(max(isnull(Cr_amt,0)))  AS 'Gain/Loss',
--sum((isnull(LastNAVPrice,0)*isnull(Angel_Qty,0)))  - Case when (Sum(isnull(MFBuy.Cr_amt,0)) - Sum(isnull(mfsell.dr_amt,0)))<0 THEN (Sum(isnull(MFBuy.Cr_amt,0)) - Sum(isnull(mfsell.dr_amt,0)))*-1 ELSE (sum(isnull(MFBuy.Cr_amt,0)) - Sum(isnull(mfsell.dr_amt,0))) END  as 'Gain/Loss'
--sum((isnull(LastNAVPrice,0)*isnull(Angel_Qty,0)))  - Case when (Sum(isnull(MFBuy.Cr_amt,0)) - Sum(isnull(mfsell.dr_amt,0)))<0 THEN (Sum(isnull(MFBuy.Cr_amt,0)) - Sum(isnull(mfsell.dr_amt,0)))*-1 ELSE (sum(isnull(MFBuy.Cr_amt,0)) - Sum(isnull(mfsell.dr_amt,0))) END  as 'Gain/Loss'

 --(Cur.Value+Cum.Outflow)-(Cum,Inflow)
 ISNULL((sum((LastNAVPrice*Angel_Qty))+isnull(max(dr_amt),0))-ISNULL(max(Cr_amt),0),0) as 'Gain/Loss'

From 
IWMF_trn_current_holding_syn hldg WITH (NOLOCK) 

Left join 
(
		
			select  Clientcode, sum(Units*nav) Cr_amt--,SUm(units) units
			from 
			tbl_TransactionBuy_UniqueCode_syn WITH (NOLOCK) where Clientcode = @client_Code
			group by Clientcode
) MFBuy ON MFBuy.Clientcode=hldg.party_Code
Left join 
(		
		select Clientcode, sum(Units* nav) dr_amt--,SUm(units) units
		from 
			tbl_TransactionSale_UniqueCode_syn WITH (NOLOCK) where Clientcode = @client_Code
		group by Clientcode

) mfsell ON mfsell.Clientcode=hldg.party_Code


	where party_Code=@client_Code
	group by party_Code

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_SipMaster_16022017
-- --------------------------------------------------
Create  PROCEDURE [dbo].[usp_rpt_SipMaster_16022017]
--Declare 	
	@ClientCode VARCHAR(20) =NULL
	--,
	--@MobileNo VARCHAR(20) = NULL
AS
BEGIN


--exec [usp_rpt_SipMaster]'A108113'
--exec [usp_rpt_SipMaster]'A34430'ClientName
--ABDUL KARIM CHOUDHARY
--EXEC [dbo].[usp_rpt_SipMaster] 'A119382'
--EXEC [dbo].[usp_rpt_SipMaster] 'rp61'


if OBJECT_ID('tempdb.#TwoSipTable') is not null
		drop table #TwoSipTable
		
select * into #TwoSipTable from
		(
			SELECT 
				sClientCode,sMandateID,nInstallmentAmount,dStartDate,dEndDate,dSipRegistrationDate,
				sFrequencyType,sFolioNo,sDpId,sSchemeCodE,sTransactionStatus,sSipRegistrationStatus
				,'XSIP' TransactionType,sOrderStatus
				,sUserRefNo
				,xsip.[Due Date] as DueDate,
				--,xsip.[Client Name] 'Client Name',
				--M.sFrequencyType,
				M.nFrequencyAllowed
			FROM
				[196.1.115.132].mutualfund.dbo.tblXsiporderdetails M WITH (NOLOCK) 
				Left join [196.1.115.132].risk.dbo.tbl_sip_installment_due_data xsip  WITH (NOLOCK)  ON M.sClientCode=xsip.[Client Code]
			AND xsip.[SIP Regn Number]=M.sXSipRegnNo
			WHere sClientCode=@ClientCode

			UNION All
			SELECT 
				X.sClientCode,sMandateRefNo,nInstallmentAmount,dStartDate,dEndDate,dSipRegistrationDate,X.sFrequencyType,sFolioNo,sDpId,X.sSchemeCode,
				sTransactionStatus,sSipRegistrationStatus,
				'SIP' TransactionType,sOrderStatus
				,sUserRefNo
				,sDueDate,
				--sip.sClientName 'Client Name',
				--X.sFrequencyType,
				X.nFrequencyAllowed
			FROM
			[196.1.115.132].mutualfund.dbo.tblsiporderdetails X WITH (NOLOCK) 
			Left join [196.1.115.132].mutualfund.dbo.tblSipInstallmentDueMaster sip WITH (NOLOCK)  
			ON X.sClientCode=sip.sClientCode
			AND sip.sSipRegnNo=X.sSipRegnNo
			where X.sClientCode=@ClientCode

		) T

	SELECT DISTINCT 
		@ClientCode party_code,
		investmst.FirstHolderName as ClientName,
		CASE WHEN ISNULL(T.sFolioNo,'')='' THEN sDpId ELSE T.sFolioNo END   folio_no,
		SCH.AMCName as AMCName,
		SCH.SchemeName SchemeName,
		SCH.SchemeType as Category,
		--T.[Client Name] as ClientNameT, 
		T.sMandateID as MandateRefNo,
		T.nInstallmentAmount as Amount,
		T.dStartDate  as FromDate,
		T.dEndDate  as ToDate,
		T.dSipRegistrationDate as [Registration Date],
		DATEPART(DAY,T.dStartDate) as PeriodDay,
		T.sFrequencyType as Periodicity,
		DueDate NextDueDate,
		TransactionType TransactionType
		,sUserRefNo,
		T.sTransactionStatus
		,sSipRegistrationStatus
		,sOrderStatus
	FROM #TwoSipTable T
	left join MutualFund.dbo.investormaster investmst  WITH (NOLOCK)
		ON T.sClientCode = investmst.existcode
		left join [196.1.115.132].risk.dbo.sip_scheme SCH
		ON SCH.SchemeCode=T.sSchemeCodE
		and SCH.SIPFrequency=T.sFrequencyType
		and SCH.SIPDates=T.nFrequencyAllowed

	WHERE 
		(T.sClientCode=@ClientCode)
		--AND (investmst.Mobile=@MobileNo or @MobileNo IS NULL)
		--AND 	SM.SchemeName IS not null
and T.sSipRegistrationStatus<>'C' 
and  sOrderStatus<>'C'

DROP TABLE #TwoSipTable

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_SipMaster_Bkp16Feb2018
-- --------------------------------------------------


--[usp_rpt_SipMaster]'A34430'
CREATE  PROCEDURE [dbo].[usp_rpt_SipMaster_Bkp16Feb2018]
	@ClientCode VARCHAR(20) ,
	@MobileNo VARCHAR(20) = NULL
AS
BEGIN


--exec [usp_rpt_SipMaster]'A108113'
--exec [usp_rpt_SipMaster]'A34430'
--EXEC [dbo].[usp_rpt_SipMaster] 'A119382'


if OBJECT_ID('tempdb.#TwoSipTable') is not null
		drop table #TwoSipTable
		
		/*
		select * into #TwoSipTable from
		(
				SELECT 
				sclientcode,nAmount,dRegistrationDate RegistrationDate FROM
				[196.1.115.132].mutualfund.dbo.tblxsipmandatedetails M WHere sclientcode=@ClientCode
				UNION 
				SELECT 
				sclientcode,nAmount,InsertedOn RegistrationDate
				--'rp61','MAHINDRA BANK LIMITED','772837','500.00','0222248554'
				FROM
				[196.1.115.132].mutualfund.dbo.tblsipmandatedetails X where sclientcode=@ClientCode
		) T
		*/


		
	
select * into #TwoSipTable from
		(
			SELECT 
				sClientCode,sMandateID,nInstallmentAmount,dStartDate,dEndDate,dSipRegistrationDate,
				sFrequencyType,sFolioNo,sDpId,sSchemeCodE,sTransactionStatus,sSipRegistrationStatus
				,'XSIP' TransactionType,sOrderStatus
				,sUserRefNo
				,xsip.[Due Date] DueDate
			FROM
				[196.1.115.132].mutualfund.dbo.tblXsiporderdetails M WITH (NOLOCK) 
				Left join [196.1.115.132].risk.dbo.tbl_sip_installment_due_data xsip  WITH (NOLOCK)  ON M.sClientCode=xsip.[Client Code]
			AND xsip.[SIP Regn Number]=M.sXSipRegnNo
			WHere sClientCode=@ClientCode

			UNION All
			SELECT 
				X.sClientCode,sMandateRefNo,nInstallmentAmount,dStartDate,dEndDate,dSipRegistrationDate,X.sFrequencyType,sFolioNo,sDpId,X.sSchemeCode,
				sTransactionStatus,sSipRegistrationStatus,
				'SIP' TransactionType,sOrderStatus
				,sUserRefNo
				,sDueDate
			FROM
			[196.1.115.132].mutualfund.dbo.tblsiporderdetails X WITH (NOLOCK) 
			Left join [196.1.115.132].mutualfund.dbo.tblSipInstallmentDueMaster sip WITH (NOLOCK)  
			ON X.sClientCode=sip.sClientCode
			AND sip.sSipRegnNo=X.sSipRegnNo
			where X.sClientCode=@ClientCode

		) T

	SELECT DISTINCT 
		@ClientCode party_code,
		investmst.FirstHolderName as ClientName,
		CASE WHEN ISNULL(T.sFolioNo,'')='' THEN sDpId ELSE T.sFolioNo END   folio_no,
		fndmst.name as AMCName,
		SM.SchemeName,
		SM.SchemeClassDescription as Category, 
		T.sMandateID as MandateRefNo,
		T.nInstallmentAmount as Amount,
		T.dStartDate  as FromDate,
		T.dEndDate  as ToDate,
		T.dSipRegistrationDate as [Registration Date],
		DATEPART(DAY,T.dStartDate) as PeriodDay,
		T.sFrequencyType as Periodicity,
		DueDate NextDueDate,
		TransactionType TransactionType
		,sUserRefNo,
		T.sTransactionStatus
		,sSipRegistrationStatus
		,sOrderStatus
	FROM #TwoSipTable T
	left join MutualFund.dbo.investormaster investmst  WITH (NOLOCK)
		ON T.sClientCode = investmst.existcode
	lEFT JOIN DBO.IWMF_trn_current_holding_syn hldng WITH (NOLOCK)
	on hldng.party_Code=T.sClientCode
	LEFT JOIN MutualFund.dbo.vw_FundMaster fndmst 
	ON hldng.fund_code=fndmst.code
	Left join MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	ON SUBSTRING(hldng.fsSchemeCode,2,LEN(hldng.fsSchemeCode))=SM.SchemeCode
	WHERE 
		(hldng.party_code=@ClientCode)
		AND (investmst.Mobile=@MobileNo or @MobileNo IS NULL)
		AND 	SM.SchemeName IS not null
and T.sSipRegistrationStatus<>'C'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_rpt_SipMaster_V1
-- --------------------------------------------------

--[usp_rpt_SipMaster]'A34430'
CREATE  PROCEDURE [dbo].[usp_rpt_SipMaster_V1]
	@ClientCode VARCHAR(20) ,
	@MobileNo VARCHAR(20) = NULL
AS
BEGIN


--exec [usp_rpt_SipMaster]'A108113'
--exec [usp_rpt_SipMaster]'A34430'
--EXEC [dbo].[usp_rpt_SipMaster] 'A119382'


if OBJECT_ID('tempdb.#TwoSipTable') is not null
		drop table #TwoSipTable
		
		/*
		select * into #TwoSipTable from
		(
				SELECT 
				sclientcode,nAmount,dRegistrationDate RegistrationDate FROM
				[196.1.115.132].mutualfund.dbo.tblxsipmandatedetails M WHere sclientcode=@ClientCode
				UNION 
				SELECT 
				sclientcode,nAmount,InsertedOn RegistrationDate
				--'rp61','MAHINDRA BANK LIMITED','772837','500.00','0222248554'
				FROM
				[196.1.115.132].mutualfund.dbo.tblsipmandatedetails X where sclientcode=@ClientCode
		) T
		*/


		
	
select * into #TwoSipTable from
		(
			SELECT 
				sClientCode,sMandateID,nInstallmentAmount,dStartDate,dEndDate,dSipRegistrationDate,
				sFrequencyType,sFolioNo,sDpId,sSchemeCodE,sTransactionStatus
				,'XSIP' TransactionType
				,sUserRefNo
				,xsip.[Due Date] DueDate
			FROM
				[196.1.115.132].mutualfund.dbo.tblXsiporderdetails M WITH (NOLOCK) 
				Left join [196.1.115.132].risk.dbo.tbl_sip_installment_due_data xsip  WITH (NOLOCK)  ON M.sClientCode=xsip.[Client Code]
			AND xsip.[SIP Regn Number]=M.sXSipRegnNo
			WHere sClientCode=@ClientCode

			UNION All
			SELECT 
				X.sClientCode,sMandateRefNo,nInstallmentAmount,dStartDate,dEndDate,dSipRegistrationDate,X.sFrequencyType,sFolioNo,sDpId,X.sSchemeCode,sTransactionStatus,
				'SIP' TransactionType
				,sUserRefNo
				,sDueDate
			FROM
			[196.1.115.132].mutualfund.dbo.tblsiporderdetails X WITH (NOLOCK) 
			Left join [196.1.115.132].mutualfund.dbo.tblSipInstallmentDueMaster sip WITH (NOLOCK)  
			ON X.sClientCode=sip.sClientCode
			AND sip.sSipRegnNo=X.sSipRegnNo
			where X.sClientCode=@ClientCode

		) T

	SELECT DISTINCT 
		@ClientCode party_code,
		investmst.FirstHolderName as ClientName,
		CASE WHEN ISNULL(T.sFolioNo,'')='' THEN sDpId ELSE T.sFolioNo END   folio_no,
		--fndmst.name as AMCName,
		--SM.SchemeName,
		--SM.SchemeClassDescription as Category, 
		T.sMandateID as MandateRefNo,
		T.nInstallmentAmount as Amount,
		T.dStartDate  as FromDate,
		T.dEndDate  as ToDate,
		T.dSipRegistrationDate as [Registration Date],
		DATEPART(DAY,T.dStartDate) as PeriodDay,
		T.sFrequencyType as Periodicity,
		DueDate NextDueDate,
		TransactionType TransactionType
		,sUserRefNo,
		T.sTransactionStatus
	FROM #TwoSipTable T
	left join MutualFund.dbo.investormaster investmst  WITH (NOLOCK)
		ON T.sClientCode = investmst.existcode
	lEFT JOIN DBO.IWMF_trn_current_holding_syn hldng WITH (NOLOCK)
	on hldng.party_Code=T.sClientCode
	--LEFT JOIN MutualFund.dbo.vw_FundMaster fndmst 
	--ON hldng.fund_code=fndmst.code
	----Left join MutualFund.dbo.SchemeMaster SM WITH (NOLOCK)
	--ON SUBSTRING(hldng.fsSchemeCode,2,LEN(hldng.fsSchemeCode))=SM.SchemeCode
	WHERE 
		(hldng.party_code=@ClientCode)
		AND (investmst.Mobile=@MobileNo or @MobileNo IS NULL)
		--AND 	SM.SchemeName IS not null
and T.sTransactionStatus<>'C'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_SBBrokerageSummary
-- --------------------------------------------------
CREATE PROCEDURE Usp_SBBrokerageSummary
(
	@sub_broker varchar(50)= NULL,
	@fromdt date = NULL,
	@todt date = NULL
)

	--EXEC Usp_SBBrokerageSummary @sub_broker='ET',@fromdt ='2017-04-01',@todt = '2018-01-01'

AS
BEGIN

	SELECT Sub_Broker,0.00 GrossBrokerage,0.00 AS Remisier --SUM(Units) AS Units,SUM(Amount) AS Amount,SUM(Cr_amt) AS Cr_amt,SUM(dr_amt) AS Dr_amt
	FROM
		( 
		SELECT 
				Sub_Broker,Trans.Units
				,Case when Cr_amt>0 Then Cr_amt ELSE dr_amt END Amount,Cr_amt,dr_amt--,Case When Cr_amt>0 Then 'Invested' ELSE 'Redeem' END 'Invested/Redeem'
				
		--INTO #tbl_clientdetails
		FROM MutualFund.dbo.investormaster IM WITH (NOLOCK)
		INNER JOIN
			(
				select s.sub_broker,ISIN,tdate,TrxnMode, 'Cr' DR_CR, Units,Clientcode,Amount Cr_amt, 0 as dr_amt
				from tbl_TransactionBuy_UniqueCode_syn TB WITH (NOLOCK)
				INNER JOIN sb_client_details S WITH (NOLOCK)
				ON S.Party_code = TB.Clientcode
				where (S.sub_broker = @sub_broker or @sub_broker IS NULL)
				and (tdate > @fromdt or @fromdt IS NULL) 
				and (tdate <= @todt or @todt IS NULL)
				
				UNION ALL
				
				select s.sub_broker,ISIN,tdate,TrxnMode,'Dr' AS DR_CR, Units,Clientcode,0 AS Cr_amt, Amount dr_amt
				from tbl_TransactionSale_UniqueCode_syn TB WITH (NOLOCK) 
				INNER JOIN sb_client_details S WITH (NOLOCK)
				ON S.Party_code = TB.Clientcode
				where (S.sub_broker = @sub_broker or @sub_broker IS NULL)
				and (tdate > @fromdt or @fromdt IS NULL) 
				and (tdate <= @todt or @todt IS NULL)
			) Trans
		ON Trans.Clientcode=IM.ExistCode
		)Brokerage
	GROUP BY Sub_Broker

END

--CREATE NONCLUSTERED INDEX inx_sb_client_details_sub_Broker

--CREATE NONCLUSTERED INDEX inx_inx_sb_client_details_Party_code ON sb_client_details(Party_code,sub_broker)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_MFSSRecommended_ReturnValue
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Update_MFSSRecommended_ReturnValue]        
AS        
        
BEGIN        
	BEGIN TRY        
		IF OBJECT_ID('TempDB..#Return') IS NOT NULL        
			DROP TABLE #Return        
		SELECT SrNo=T.ID,ISIN=T.GrowthISIN,oneweek=CAST(R.oneweek AS NUMERIC(7,2)),onemonth=CAST(R.onemonth AS NUMERIC(7,2)),threemonth=CAST(R.threemonth AS NUMERIC(7,2))
			,sixmonth=CAST(R.sixmonth AS NUMERIC(7,2)),oneyear=CAST(R.oneyear AS NUMERIC(7,2)),threeyear=CAST(R.threeyear AS NUMERIC(7,2)),        
			fiveyear=CAST(R.fiveyear AS NUMERIC(7,2)),inception=CAST(R.inception AS NUMERIC(7,2)),AUM=CAST(S.dbdmfsch_size AS varchar(1000)),I.mf_schcode as CoCode        
		INTO #Return        
		FROM [ANGEL_WMS].dbo.ARQ_mfssRecommendedScheme T WITH (NOLOCK)    --   where flag='A' order by GrowthISIN  
		LEFT OUTER JOIN dbo.feed_mfisin I WITH (NOLOCK) ON  I.isin  =  T.GrowthISIN        
		LEFT OUTER JOIN dbo.feed_returnv R WITH (NOLOCK) ON R.mf_schcode = I.mf_schcode        
		LEFT OUTER JOIN dbo.feed_dbdmfsch S WITH (NOLOCK) ON S.mf_schcode = I.mf_schcode
		WHERE T.Flag='A'        
        
		UPDATE T SET       
			T.[1week]=ISNULL(R.oneweek,0),T.[1Month]=ISNULL(R.onemonth,0),T.[3Month]=ISNULL(R.threemonth,0),
			T.[6Month]=ISNULL(R.sixmonth,0),T.[1yrReturn] = ISNULL(R.oneyear,0),T.[3yrReturn] = ISNULL(R.threeyear,0),        
			T.[5yrReturn] = ISNULL(R.fiveyear,0),T.InceptionReturn = ISNULL(R.inception,0),        
			T.AUM = (CASE WHEN T.AUM = '0' THEN CAST(CAST(ISNULL(R.AUM,'0') AS float) AS VARCHAR) ELSE T.AUM END),
			T.CoCode=R.CoCode        
		FROM [ANGEL_WMS].dbo.ARQ_mfssRecommendedScheme T WITH (NOLOCK)        
		INNER JOIN #Return R WITH (NOLOCK) ON R.SrNo = T.ID AND R.ISIN = T.GrowthISIN        
        
		IF OBJECT_ID('TempDB..#scoreReturn') IS NOT NULL        
			DROP TABLE #scoreReturn        
		SELECT SrNo=T.ARS_iid,ISIN=T.ARS_tSchemeISIN,oneyear=CAST(R.oneyear AS NUMERIC(7,2)),threeyear=CAST(R.threeyear AS NUMERIC(7,2)),        
			fiveyear=CAST(R.fiveyear AS NUMERIC(7,2)),inception=CAST(R.inception AS NUMERIC(7,2)),AUM=CAST(S.dbdmfsch_size AS NUMERIC(9,2))        
		INTO #scoreReturn        
		FROM [ANGEL_WMS].dbo.ARQ_Score_Asset_Recommendation T WITH (NOLOCK)        
		LEFT OUTER JOIN dbo.feed_mfisin I WITH (NOLOCK) ON  I.isin  =  T.ARS_tSchemeISIN          
		LEFT OUTER JOIN dbo.feed_returnv R WITH (NOLOCK) ON R.mf_schcode = I.mf_schcode        
		LEFT OUTER JOIN dbo.feed_dbdmfsch S WITH (NOLOCK) ON S.mf_schcode = I.mf_schcode        
        
		UPDATE T SET     
			T.ARS_dOneYrReturn = ISNULL(R.oneyear,0),T.ARS_dThreeYrReturn = ISNULL(R.threeyear,0),        
			T.ARS_dFiveYrReturn = ISNULL(R.fiveyear,0),T.ARS_dInceptionReturn = ISNULL(R.inception,0),        
			T.ARS_dAUM = (CASE WHEN T.ARS_dAUM = 0 THEN ISNULL(R.AUM,0) ELSE T.ARS_dAUM END),        
			T.ARS_dtUpdatedOn = GETDATE(), T.ARS_tUpdatedBy = 'ReturnUpd'        
		FROM [ANGEL_WMS].dbo.ARQ_Score_Asset_Recommendation T WITH (NOLOCK)        
		INNER JOIN #scoreReturn R WITH (NOLOCK) ON R.SrNo = T.ARS_iid AND R.ISIN = T.ARS_tSchemeISIN          
        
		EXEC MSDB.DBO.SP_SEND_DBMAIL          
			@RECIPIENTS = 'angeleye.support@angelbroking.com;deepak.mishra@angelbroking.com',         
			@copy_recipients = 'nazma.khan@angelbroking.com',        
			@PROFILE_NAME = 'SOFTWARE',          
			@BODY_FORMAT ='HTML',          
			@SUBJECT = 'MF Recommended Schemes Uploaded',        
			@BODY = '<br/><br/>MF Recommended Schemes Uploaded and return modified.<br/><br/><br/>';        
	END TRY        
	BEGIN CATCH        
		INSERT INTO SIP_ERROR(ERRTIME,ERROBJECT,ERRLINE,ERRMESSAGE)        
		SELECT GETDATE(),'SIP Recommended Scheme',ERROR_LINE(),ERROR_MESSAGE()        
	END CATCH        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UpdateFreePaid
-- --------------------------------------------------

/*

EXEC [Usp_UpdateFreePaid] 3,18,'Paid','30/04/2018','30/04/2018',null,'Admin','Service'

*/

CREATE PROCEDURE [dbo].[Usp_UpdateFreePaid]
(	
	@Userid INT,
	@ModuleId INT
	,@FreePaid Varchar(100)
	,@FromDate Varchar(20)
	,@Todate Varchar(20)
	,@UpdateDate DateTime=NULL
	,@UpdateBy VArchar(20)
	,@Reason VArchar(2000)
	,@IPaddress Varchar(200)
)

AS
BEGIN

select @FromDate = convert(datetime , @FromDate , 103)
select @Todate = convert(datetime , @Todate , 103)

SELECT @FromDate = CAST( @FromDate AS DATE)
SELECT @Todate = CAST( @Todate AS DATE)

Update UserModuleMappingMaster
Set 
 ModuleId=@ModuleId
,FreePaid=@FreePaid
,FromDate=@FromDate
,Todate=@Todate
,UpdateDate=Getdate()
,UpdateBy=@UpdateBy
,Reason=@Reason
,IPaddress=@IPaddress 

OUTPUT 
 inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason
,inserted.IPaddress
,GETDATE()

INTO UserModuleMappingMaster_log

WHERE Userid=@Userid
and ModuleId=@ModuleId




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UpdateFreePaid_SD
-- --------------------------------------------------

/*

EXEC [Usp_UpdateFreePaid_sd] 3,18,'Paid','30/04/2018','30/04/2018',null,'Admin','Service'

*/

CREATE PROCEDURE [dbo].[Usp_UpdateFreePaid_SD]
(	
	@Userid INT,
	@ModuleId INT
	,@FreePaid Varchar(100)
	,@FromDate Varchar(20)
	,@Todate Varchar(20)
	,@UpdateDate DateTime=NULL
	,@UpdateBy VArchar(20)
	,@Reason VArchar(2000)
)

AS
BEGIN

select @FromDate = convert(datetime , @FromDate , 103)
select @Todate = convert(datetime , @Todate , 103)

SELECT @FromDate = CAST( @FromDate AS DATE)
SELECT @Todate = CAST( @Todate AS DATE)

Update UM 
Set 
 ModuleId=@ModuleId
,FreePaid=@FreePaid
,FromDate=@FromDate
,Todate=@Todate
,UpdateDate=Getdate()
,UpdateBy=@UpdateBy
,Reason=@Reason


OUTPUT inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason

INTO UserModuleMappingMaster_History
(
Userid
,ModuleId
,FreePaid
,FromDate
,Todate
,Active
,createDate
,CreateBy
,UpdateDate
,UpdateBy
,Reason
)

FROM UserModuleMappingMaster UM WITH (NOLOCK)
WHERE Userid=@Userid
and ModuleId=@ModuleId




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UserModuleMappingMaster
-- --------------------------------------------------
CREATE procedure [dbo].[USP_UserModuleMappingMaster]
(
	@Userid INT
	,@ModuleId VARCHAR(MAX)
	,@FromDate DATETIME=NULL
	,@Todate DATETIME=NULL
	--,@Active BIT
	,@createDate DATETIME=NULL
	,@CreateBy VARCHAR(200)='System'
	,@IPaddress Varchar(200)
	,@ExcludedModuleId VARCHAR(MAX)=NULL
)
AS
BEGIN

SET NOCOUNT ON
/*

Begin tran
Select * from UserModuleMappingMaster
where userid = '2680'
and active = 1
Select * from UserModuleMappingMaster
where userid = '2680'
and active = 0
EXEC USP_UserModuleMappingMaster 2680,'4-Free,5-Free,6-Free,7-Free,8-Free,9-Free,10-Free,11-Free,85-Free',NULL,NULL,NULL,'System','172.29.23.177'
Select * from UserModuleMappingMaster
where userid = '2680'
and active = 1
Select * from UserModuleMappingMaster
where userid = '2680'
and active = 0
Rollback tran

*/


Create table #Exclude
(
	ModuleId INT,
	userid INT
)

--Insert into UserModuleExclude



Create table #Include
(
	ModuleId INT,
	userid INT
)

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 

SELECT * INTO #ExcluedModule FROM [dbo].[fn_Split1](@ExcludedModuleId,',' ) 

select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp

select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #ExcluedModule1
from #ExcluedModule



			INSERT INTO UserModuleMappingMaster_log
			(
			Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress,EntryDate,OLDNew
			)
			SELECT 
			Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress,Getdate(),'OLD'
			FROM UserModuleMappingMaster M WITH (NOLOCK)
			WHERE userId=@Userid

			--select * from UserModuleMappingMaster_log
			--WHERE userId=2680
			--and cast(EntryDate as date)  = cast(getdate() as date)
--Select * from #Temp1

INSERT INTO UserModuleMappingMaster(Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,IPaddress)
	
OUTPUT 
 inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason
,inserted.IPaddress
,GETDATE()
,'New'
INTO UserModuleMappingMaster_log

	SELECT 
		@Userid,A.ModuleId,A.FreePaid,getdate(),'',1,Getdate(),@CreateBy,'','',@IPaddress
FROM #Temp1 A
	left join UserModuleMappingMaster B WITH (NOLOCK)
	ON A.Moduleid=B.ModuleID
	and B.Userid=@Userid
where B.ModuleID is null  




Insert into #Include
SELECT A.ModuleId,@Userid FROM UserModuleMappingMaster A WITH (NOLOCK) 
WHERE moduleid in (select ModuleID from #Temp1 B )
and userid=@Userid

Insert into #Exclude
SELECT A.ModuleId,@Userid FROM UserModuleMappingMaster A WITH (NOLOCK) 
WHERE moduleid not in (select ModuleID from #Temp1 B )
and Userid=@Userid

declare @Roleid INT
select @Roleid =Roleid from RoleMaster WITH (NOLOCK)  where rolename in (select top 1 usertype from NXT.dbo.NXTSBLogin where userid=@Userid)

Delete from UserModuleExclude where userid=@Userid

INSERT INTO UserModuleExclude(ModuleId,userid,CreatedBy,CreatedDate,IPaddress,Roleid)
SELECT 
		ModuleId ,
		@Userid ,
		@CreateBy,
		GETDATE(),
		@IPaddress,
		@Roleid
FROM 
#ExcluedModule1



Update A
Set Active=0,Reason = Null,FromDate = Null,Todate = Null,UpdateDate = Getdate(),IPaddress=@IPaddress,A.UpdateBy = CreateBy

OUTPUT inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason
,getdate()
,@IPaddress
,'New'

INTO UserModuleMappingMaster_Exclude
(
Userid
,ModuleId
,FreePaid
,FromDate
,Todate
,Active
,createDate
,CreateBy
,UpdateDate
,UpdateBy
,Reason
,UpdatedOn
,IPaddress
,OLDNew
)

from UserModuleMappingMaster A WITH (NOLOCK) 
Inner join #Exclude B
ON A.ModuleID=B.ModuleId
	And A.Userid=B.userid


--SELECT @IPaddress

Update A
Set Active=1
,UpdateDate = Getdate()
,UpdateBy = @CreateBy

OUTPUT 
 inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason
,@IPaddress
,GETDATE()
,'New'


INTO UserModuleMappingMaster_log

from UserModuleMappingMaster A WITH (NOLOCK) 
Inner join #Include	B
ON A.ModuleID=B.ModuleId
	And A.userid=B.userid

--	select * from UserModuleMappingMaster where Userid=@Userid and ModuleId IN (1,3)
	

--	SELECT @Userid ,@ModuleId

--SELECT * FROM #Include
	
--	select 

--		* from UserModuleMappingMaster A
--Inner join #Include	B
--ON A.ModuleID=B.ModuleId
--	And A.userid=B.userid
--	where A.Userid=@Userid and A.ModuleId=@ModuleId

DROP TABLE #Temp
DROP TABLE #Temp1
DROP TABLE #Exclude
DROP TABLE #Include


END


--select * from [UserModuleMappingMaster] where userid=1
--select * from [UserModuleMappingMaster] where userid=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UserModuleMappingMaster_bkp19Apr2018
-- --------------------------------------------------
CREATE  procedure USP_UserModuleMappingMaster_bkp19Apr2018
(
	@Userid  varchar(100)
	,@ModuleId varchar(MAX)
	--,@ControllerId INT
	--,@ActionId INT
	--,@FreePaid varchar(100)
	,@FromDate Date=NULL
	,@Todate Date=NULL
	,@Active Bit='1'
	,@createDate	datetime=NULL
	,@CreateBy	varchar(100)=NULL
	,@UpdateDate	datetime=NULL
	,@UpdateBy	varchar(100)=NULL
	
)
AS
Begin


--EXEC USP_UserModuleMappingMaster 1,'1-Free,3-Paid'
--Declare @ModuleId varchar(MAX)='1-Free,3-Paid'


IF OBJECT_ID ('TEMPDB..#temp') IS NOT NULL
		DROP TABLE #temp

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 


select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp

--select * from #Temp1

	IF NOT EXISTS (sELECT * FROM UserModuleMappingMaster WHERE Userid=@Userid)
	BEGIN 
		INSERT INTO UserModuleMappingMaster
		
		(
			 Userid
			,ModuleId
			,FreePaid
			,FromDate
			,Todate
			,Active
			,createDate,CreateBy
		)
		SELECT @Userid,
				Moduleid,
				FreePaid,
				@FromDate
				,@Todate
				,@Active
				,getdate() 
			,@CreateBy			
			From #Temp1
			
	END
	--ELSE
	--BEGIN
	--		UPDATE UserModuleMappingMaster
	--		SET 
	--		 ModuleId=@ModuleId
	--		--,FreePaid=@FreePaid
	--		,FromDate=@FromDate
	--		,Todate=@Todate
	--		,Active=@Active
	--		,UpdateDate=getdate()
	--		,UpdateBy=@UpdateBy
	--		WHERE Userid=@Userid


	--END

	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UserModuleMappingMaster_Bkp20July2018
-- --------------------------------------------------
Create procedure [dbo].[USP_UserModuleMappingMaster_Bkp20July2018]
(
	@Userid INT
	,@ModuleId VARCHAR(MAX)
	,@FromDate DATETIME=NULL
	,@Todate DATETIME=NULL
	--,@Active BIT
	,@createDate DATETIME=NULL
	,@CreateBy VARCHAR(200)='System'
	,@IPaddress Varchar(200)
	,@ExcludedModuleId VARCHAR(MAX)=NULL
)
AS
BEGIN

SET NOCOUNT ON
/*

Begin tran
Select * from UserModuleMappingMaster_log
where userid = '2680'
EXEC USP_UserModuleMappingMaster_1 2680,'4-Free,5-Free,6-Free,7-Free,8-Free,9-Free,10-Free,11-Free,85-Free',NULL,NULL,NULL,'System','172.29.23.177'
Select * from UserModuleMappingMaster_log
where userid = '2680'
and cast(EntryDate as date)  = cast(getdate() as date)
Select * from UserModuleMappingMaster_log
where userid = '2680'
and cast(EntryDate as date)  = cast(getdate() as date)
and oldnew = 'new'
Rollback tran

*/


Create table #Exclude
(
	ModuleId INT,
	userid INT
)

--Insert into UserModuleExclude



Create table #Include
(
	ModuleId INT,
	userid INT
)

SELECT * INTO #Temp FROM [dbo].[fn_Split1](@Moduleid,',' ) 

SELECT * INTO #ExcluedModule FROM [dbo].[fn_Split1](@ExcludedModuleId,',' ) 

select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #Temp1
from #Temp

select *,
    SUBSTRING(StringValue, 1, CHARINDEX('-', StringValue) - 1) as Moduleid , 
    SUBSTRING(StringValue, CHARINDEX('-', StringValue) + 1, LEN(StringValue)) as FreePaid 
INTO #ExcluedModule1
from #ExcluedModule



			INSERT INTO UserModuleMappingMaster_log
			(
			Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress,EntryDate,OLDNew
			)
			SELECT 
			Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress,Getdate(),'OLD'
			FROM UserModuleMappingMaster M
			WHERE userId=2680

			--select * from UserModuleMappingMaster_log
			--WHERE userId=2680
			--and cast(EntryDate as date)  = cast(getdate() as date)
--Select * from #Temp1

INSERT INTO UserModuleMappingMaster(Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,IPaddress)
	
OUTPUT 
 inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason
,inserted.IPaddress
,GETDATE()
,'New'
INTO UserModuleMappingMaster_log

	SELECT 
		@Userid,A.ModuleId,A.FreePaid,getdate(),'',1,Getdate(),@CreateBy,'','',@IPaddress
FROM #Temp1 A
	left join UserModuleMappingMaster B
	ON A.Moduleid=B.ModuleID
	and B.Userid=@Userid
where B.ModuleID is null  




Insert into #Include
SELECT A.ModuleId,@Userid FROM UserModuleMappingMaster A 
WHERE moduleid in (select ModuleID from #Temp1 B )
and userid=@Userid

Insert into #Exclude
SELECT A.ModuleId,@Userid FROM UserModuleMappingMaster A 
WHERE moduleid not in (select ModuleID from #Temp1 B )
and Userid=@Userid


Delete from UserModuleExclude where userid=@Userid

INSERT INTO UserModuleExclude(ModuleId,userid,CreatedBy,CreatedDate,IPaddress)
SELECT 
		ModuleId ,
		@Userid ,
		@CreateBy,
		GETDATE(),
		@IPaddress
FROM 
#ExcluedModule1



Update A
Set Active=0,Reason = Null,FromDate = Null,Todate = Null,UpdateDate = Getdate(),IPaddress=@IPaddress,A.UpdateBy = CreateBy

OUTPUT inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason
,getdate()
,@IPaddress
,'New'

INTO UserModuleMappingMaster_Exclude
(
Userid
,ModuleId
,FreePaid
,FromDate
,Todate
,Active
,createDate
,CreateBy
,UpdateDate
,UpdateBy
,Reason
,UpdatedOn
,IPaddress
,OLDNew
)

from UserModuleMappingMaster A
Inner join #Exclude B
ON A.ModuleID=B.ModuleId
	And A.Userid=B.userid


--SELECT @IPaddress

Update A
Set Active=1
,UpdateDate = Getdate()
,UpdateBy = @CreateBy

OUTPUT 
 inserted.Userid
,inserted.ModuleId
,inserted.FreePaid
,inserted.FromDate
,inserted.Todate
,inserted.Active
,inserted.createDate
,inserted.CreateBy
,inserted.UpdateDate
,inserted.UpdateBy
,inserted.Reason
,@IPaddress
,GETDATE()
,'New'


INTO UserModuleMappingMaster_log

from UserModuleMappingMaster A
Inner join #Include	B
ON A.ModuleID=B.ModuleId
	And A.userid=B.userid

--	select * from UserModuleMappingMaster where Userid=@Userid and ModuleId IN (1,3)
	

--	SELECT @Userid ,@ModuleId

--SELECT * FROM #Include
	
--	select 

--		* from UserModuleMappingMaster A
--Inner join #Include	B
--ON A.ModuleID=B.ModuleId
--	And A.userid=B.userid
--	where A.Userid=@Userid and A.ModuleId=@ModuleId

DROP TABLE #Temp
DROP TABLE #Temp1
DROP TABLE #Exclude
DROP TABLE #Include


END


--select * from [UserModuleMappingMaster] where userid=1
--select * from [UserModuleMappingMaster] where userid=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UserModuleMappingMaster_New
-- --------------------------------------------------

CREATE proc usp_UserModuleMappingMaster_New
(@userid INT)

as
begin 

	INSERT INTO UserModuleMappingMaster 
		(Userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress )
		SELECT Userid=@userid,ModuleId,FreePaid,FromDate,Todate,Active,createDate,CreateBy,UpdateDate,UpdateBy,Reason,IPaddress 
		FROM  [UserModuleMappingMaster_Bkp23July2018] 
		WHERE Userid = 50646
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UserRoleCreateAssign
-- --------------------------------------------------


CREATE  PROCEDURE [dbo].[usp_UserRoleCreateAssign]
(
@UserName Varchar(500),
@password varchar(200),
@Role INT,
@Active Bit,
@ProjectId INT
,@Userid int
,@createDate	datetime=NULL
,@CreateBy varchar(100)=NULL
,@UpdateDate datetime=NULL
,@UpdateBy varchar(100)=NULL
)
AS
BEGIN

Set NOCOUNT ON 
--usp_UserRoleCreateAssign 'Yogesh2','Yogesh2','2','1',1

Declare @Identity INT,@Roleid INT

If not exists(select * from UserMaster where name=@UserName)
begin
Insert into UserMaster(Userid,Name,password,Active,createDate,CreateBy,UpdateDate,UpdateBy)
select @Userid,@UserName ,@password ,@Active ,@createDate,@CreateBy,@UpdateDate,@UpdateBy

Select @Identity=@Userid

Select @Identity as IdentColumn
end
ELSE 
BEGIN
 --If not exists(select * from UserMaster where name=@UserName and Userid=@Userid)
 --begin
    Update UserMaster
	Set 
		@Active =@Active
		,UpdateDate=@UpdateDate
		,UpdateBy=@UpdateBy
		,userid=@Userid
	where Name =@UserName 
 --end

 END

 If not exists(select * from UserRolePermission where Userid=@Userid)
begin
Print 'AAA'

 Insert into UserRolePermission(Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @Userid,@Role,@ProjectId,@createDate,@CreateBy,@UpdateDate,@UpdateBy


Insert into [UserRolePermission_Log](Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @Userid,@Role,@ProjectId,@createDate,@CreateBy,'',''

END
ELSE 
BEGIN

--select @Roleid=UR.Roleid, @userid=UM.Userid
--from UserMaster UM
--inner join UserRolePermission UR
--ON UM.Userid=UR.Userid
--where name=@UserName


Update UserRolePermission
Set Roleid=@Role
,UpdateDate=@UpdateDate
,UpdateBy=@UpdateBy
where userid=@userid

Insert into [UserRolePermission_Log](Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @userid,@Role,@ProjectId,'','',@UpdateDate,@UpdateBy
END


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UserRoleCreateAssign_bkp20180830_1PM
-- --------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


CREATE  PROCEDURE [dbo].[usp_UserRoleCreateAssign_bkp20180830_1PM]
(
@UserName Varchar(500),
@password varchar(200),
@Role INT,
@Active Bit,
@ProjectId INT
,@Userid int
,@createDate	datetime=NULL
,@CreateBy varchar(100)=NULL
,@UpdateDate datetime=NULL
,@UpdateBy varchar(100)=NULL
)
AS
BEGIN

Set NOCOUNT ON 
--usp_UserRoleCreateAssign 'Yogesh2','Yogesh2','2','1',1

Declare @Identity INT,@Roleid INT

If not exists(select * from UserMaster where name=@UserName)
begin
Insert into UserMaster(Userid,Name,password,Active,createDate,CreateBy,UpdateDate,UpdateBy)
select @Userid,@UserName ,@password ,@Active ,@createDate,@CreateBy,@UpdateDate,@UpdateBy

Select @Identity=@Userid

Select @Identity as IdentColumn
end
ELSE 
BEGIN
 --If not exists(select * from UserMaster where name=@UserName and Userid=@Userid)
 --begin
    Update UserMaster
	Set 
		@Active =@Active
		,UpdateDate=@UpdateDate
		,UpdateBy=@UpdateBy
		,userid=@Userid
	where Name =@UserName 
 --end

 END

 If not exists(select * from UserRolePermission where Userid=@Userid)
begin
Print 'AAA'

 Insert into UserRolePermission(Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @Userid,@Role,@ProjectId,@createDate,@CreateBy,@UpdateDate,@UpdateBy


Insert into [UserRolePermission_Log](Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @Userid,@Role,@ProjectId,@createDate,@CreateBy,'',''

END
ELSE 
BEGIN

--select @Roleid=UR.Roleid, @userid=UM.Userid
--from UserMaster UM
--inner join UserRolePermission UR
--ON UM.Userid=UR.Userid
--where name=@UserName


Update UserRolePermission
Set Roleid=@Role
,UpdateDate=@UpdateDate
,UpdateBy=@UpdateBy
where userid=@userid

Insert into [UserRolePermission_Log](Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @userid,@Role,@ProjectId,'','',@UpdateDate,@UpdateBy
END


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UserRoleCreateAssign_Bkp28Aug2018
-- --------------------------------------------------

CREATE   PROCEDURE [dbo].[usp_UserRoleCreateAssign_Bkp28Aug2018]
(
@UserName Varchar(500),
@password varchar(200),
@Role INT,
@Active Bit,
@ProjectId INT
,@Userid int
,@createDate	datetime=NULL
,@CreateBy varchar(100)=NULL
,@UpdateDate datetime=NULL
,@UpdateBy varchar(100)=NULL
)
AS
BEGIN

Set NOCOUNT ON 
--usp_UserRoleCreateAssign 'Yogesh2','Yogesh2','2','1',1

Declare @Identity INT,@Roleid INT

If not exists(select * from UserMaster where name=@UserName)
begin
Insert into UserMaster(Userid,Name,password,Active,createDate,CreateBy,UpdateDate,UpdateBy)
select @Userid,@UserName ,@password ,@Active ,@createDate,@CreateBy,@UpdateDate,@UpdateBy

Select @Identity=@Userid


Insert into UserRolePermission(Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @Identity,@Role,@ProjectId,@createDate,@CreateBy,@UpdateDate,@UpdateBy


Insert into [UserRolePermission_Log](Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @Identity,@Role,@ProjectId,@createDate,@CreateBy,'',''

Select @Identity as IdentColumn
end
ELSE 
BEGIN
 If not exists(select * from UserMaster where name=@UserName and Userid=@Userid)
 begin
    Update UserMaster
Set 
@Active =@Active
,UpdateDate=@UpdateDate
,UpdateBy=@UpdateBy
,userid=@Userid
where Name =@UserName 
 end


--select @Roleid=UR.Roleid, @userid=UM.Userid
--from UserMaster UM
--inner join UserRolePermission UR
--ON UM.Userid=UR.Userid
--where name=@UserName


Update UserRolePermission
Set Roleid=@Role
,UpdateDate=@UpdateDate
,UpdateBy=@UpdateBy
where userid=@userid

Insert into [UserRolePermission_Log](Userid,Roleid,ProjectId,createDate,CreateBy,UpdateDate,UpdateBy)
select @userid,@Role,@ProjectId,'','',@UpdateDate,@UpdateBy



END 

END

GO

-- --------------------------------------------------
-- TABLE dbo.ActionMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[ActionMaster]
(
    [ActionId] INT IDENTITY(1,1) NOT NULL,
    [ActionName] VARCHAR(100) NULL,
    [ControllerId] VARCHAR(100) NULL,
    [Active] BIT NULL DEFAULT ((1))
);

GO

-- --------------------------------------------------
-- TABLE dbo.ControllerMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[ControllerMaster]
(
    [ControllerId] INT IDENTITY(1,1) NOT NULL,
    [ControllerName] VARCHAR(100) NULL,
    [Active] BIT NULL DEFAULT ((1))
);

GO

-- --------------------------------------------------
-- TABLE dbo.DealerUserForNxt
-- --------------------------------------------------
CREATE TABLE [dbo].[DealerUserForNxt]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Emp_No] NVARCHAR(100) NULL,
    [password] VARCHAR(500) NULL,
    [sids] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DealerUserForNxt27032019
-- --------------------------------------------------
CREATE TABLE [dbo].[DealerUserForNxt27032019]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Emp_No] NVARCHAR(100) NULL,
    [password] VARCHAR(500) NULL,
    [sids] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IWMF_trn_current_holding
-- --------------------------------------------------
CREATE TABLE [dbo].[IWMF_trn_current_holding]
(
    [AsOnDate] DATE NULL,
    [party_Code] VARCHAR(20) NULL,
    [fund_code] VARCHAR(15) NULL,
    [scheme_code] VARCHAR(100) NULL,
    [folio_no] VARCHAR(100) NULL,
    [AMFI_Code] VARCHAR(25) NULL,
    [DPFlag] VARCHAR(50) NULL,
    [Angel_Qty] DECIMAL(18, 6) NULL,
    [Actual_Qty] DECIMAL(18, 6) NULL,
    [avg_rate] DECIMAL(18, 4) NULL,
    [UpdateTime] DATETIME NULL,
    [fsSchemeCode] VARCHAR(20) NULL,
    [MapID] BIGINT NULL,
    [ProductID] INT NULL,
    [RedeemableUnit] NUMERIC(18, 6) NULL,
    [isElssData] INT NULL,
    [SchemeName] VARCHAR(200) NULL,
    [ISIN] VARCHAR(20) NULL,
    [LastNAVPrice] DECIMAL(13, 4) NULL,
    [LastNAVDate] DATE NULL,
    [PrevNAV] DECIMAL(13, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IWMF_trn_current_holding_Prev
-- --------------------------------------------------
CREATE TABLE [dbo].[IWMF_trn_current_holding_Prev]
(
    [AsOnDate] DATE NULL,
    [party_Code] VARCHAR(20) NULL,
    [fund_code] VARCHAR(15) NULL,
    [scheme_code] VARCHAR(100) NULL,
    [folio_no] VARCHAR(100) NULL,
    [AMFI_Code] VARCHAR(25) NULL,
    [DPFlag] VARCHAR(50) NULL,
    [Angel_Qty] DECIMAL(18, 6) NULL,
    [Actual_Qty] DECIMAL(18, 6) NULL,
    [avg_rate] DECIMAL(18, 4) NULL,
    [UpdateTime] DATETIME NULL,
    [fsSchemeCode] VARCHAR(20) NULL,
    [MapID] BIGINT NULL,
    [ProductID] INT NULL,
    [RedeemableUnit] NUMERIC(18, 6) NULL,
    [isElssData] INT NULL,
    [SchemeName] VARCHAR(200) NULL,
    [ISIN] VARCHAR(20) NULL,
    [LastNAVPrice] DECIMAL(13, 4) NULL,
    [LastNAVDate] DATE NULL,
    [PrevNAV] DECIMAL(13, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMappingMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMappingMaster]
(
    [ModuleId] VARCHAR(100) NULL,
    [ControllerId] VARCHAR(100) NULL,
    [ActionId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [Active] BIT NULL DEFAULT ((1)),
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMappingMaster_13Jun2018_New
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMappingMaster_13Jun2018_New]
(
    [ModuleId] VARCHAR(100) NULL,
    [ControllerId] VARCHAR(100) NULL,
    [ActionId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMappingMaster19032019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMappingMaster19032019]
(
    [ModuleId] VARCHAR(100) NULL,
    [ControllerId] VARCHAR(100) NULL,
    [ActionId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Shortcode] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster_bkp04Jun2020
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster_bkp04Jun2020]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Shortcode] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster_Bkp17Dec2019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster_Bkp17Dec2019]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Shortcode] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster_Bkp18may2019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster_Bkp18may2019]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Shortcode] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster_Bkp19March2019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster_Bkp19March2019]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Shortcode] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster_BKUP_02NOV2021
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster_BKUP_02NOV2021]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Shortcode] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster_temp]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleMaster19032019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleMaster19032019]
(
    [ModuleId] INT IDENTITY(1,1) NOT NULL,
    [Projectid] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Level] INT NULL,
    [Parentid] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Shortcode] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL DEFAULT ((1)),
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping_bkp04Jun2020
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping_bkp04Jun2020]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping_Bkp17May2019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping_Bkp17May2019]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping_Bkp18may2019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping_Bkp18may2019]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping_bkup_23June2021
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping_bkup_23June2021]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping_Log]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [EntryDate] DATETIME NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL,
    [OLDNew] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping_Temp]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping1
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping1]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping19032019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping19032019]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ModuleRoleMapping22032019
-- --------------------------------------------------
CREATE TABLE [dbo].[ModuleRoleMapping22032019]
(
    [Roleid] VARCHAR(100) NULL,
    [ModuleID] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [createDate] DATETIME NULL,
    [FreePaid] VARCHAR(10) NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL,
    [UserIPaddress] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NXTException
-- --------------------------------------------------
CREATE TABLE [dbo].[NXTException]
(
    [GUID] VARCHAR(200) NULL,
    [ModuleName] VARCHAR(500) NULL,
    [Stage] VARCHAR(200) NULL,
    [Exception] VARCHAR(MAX) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.ProjectMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[ProjectMaster]
(
    [ProjectId] INT IDENTITY(1,1) NOT NULL,
    [ProjectName] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RoleMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[RoleMaster]
(
    [Roleid] INT IDENTITY(1,1) NOT NULL,
    [RoleName] VARCHAR(100) NULL,
    [NodeType] VARCHAR(100) NULL,
    [ParentId] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdatedDate] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RoleMaster_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[RoleMaster_Temp]
(
    [Roleid] INT IDENTITY(1,1) NOT NULL,
    [RoleName] VARCHAR(100) NULL,
    [NodeType] VARCHAR(100) NULL,
    [ParentId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RoleWiseAssignedYN
-- --------------------------------------------------
CREATE TABLE [dbo].[RoleWiseAssignedYN]
(
    [Roleid] INT NULL,
    [ModuleId] INT NULL,
    [RoleName] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Parentid] INT NULL,
    [ParentModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(10) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Flag] INT NULL,
    [Level] INT NULL,
    [ControllerName] VARCHAR(100) NULL,
    [ActionName] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RunTotalTestData
-- --------------------------------------------------
CREATE TABLE [dbo].[RunTotalTestData]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [value] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SIP_Scheme_V1
-- --------------------------------------------------
CREATE TABLE [dbo].[SIP_Scheme_V1]
(
    [AMCCode] VARCHAR(50) NULL,
    [AMCName] VARCHAR(50) NULL,
    [SchemeCode] VARCHAR(50) NULL,
    [SchemeName] VARCHAR(MAX) NULL,
    [SIPTransMode] VARCHAR(10) NULL,
    [SIPFrequency] VARCHAR(50) NULL,
    [SIPDates] VARCHAR(50) NULL,
    [SIPMinGap] INT NULL,
    [SIPMaxGap] INT NULL,
    [SIPInstallmentGap] INT NULL,
    [SIPStatus] INT NULL,
    [SIPMinInstallAmt] MONEY NULL,
    [SIPMaxInstallAmt] MONEY NULL,
    [SIPMultiplierAmt] MONEY NULL,
    [SIPMinInstallNo] INT NULL,
    [SIPMaxInstallNo] INT NULL,
    [SchemeISIN] VARCHAR(50) NULL,
    [SchemeType] VARCHAR(50) NULL,
    [Fname] VARCHAR(MAX) NULL,
    [FetchDatetime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t
-- --------------------------------------------------
CREATE TABLE [dbo].[t]
(
    [RoleId] INT NULL,
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [RoleName] VARCHAR(20) NULL,
    [ModuleId] INT NOT NULL,
    [ModuleName] VARCHAR(100) NULL,
    [Shortcode] VARCHAR(100) NULL,
    [Parentid] INT NULL,
    [ParentModuleName] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL,
    [Flag] BIT NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Level] INT NULL,
    [ControllerName] VARCHAR(100) NULL,
    [ControllerId] INT NULL,
    [ActionName] VARCHAR(100) NULL,
    [ActionId] INT NULL,
    [FromDate] VARCHAR(10) NULL,
    [Todate] VARCHAR(10) NULL,
    [Reason] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_FiscalDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_FiscalDetails]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [fiscalYear] VARCHAR(20) NULL,
    [sdate] DATE NOT NULL,
    [edate] DATE NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblArnEuinMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblArnEuinMaster]
(
    [Sr No] VARCHAR(100) NULL,
    [SB Equity Tag] VARCHAR(100) NULL,
    [SB Name] VARCHAR(100) NULL,
    [ARN No] VARCHAR(100) NULL,
    [ARN Holder Name] VARCHAR(100) NULL,
    [Validity From] VARCHAR(100) NULL,
    [Validity To] VARCHAR(100) NULL,
    [EUIN No] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp]
(
    [Roleid] INT NOT NULL,
    [ModuleId] INT NOT NULL,
    [RoleName] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Flag] VARCHAR(1) NOT NULL,
    [Level] INT NULL,
    [ControllerName] VARCHAR(100) NULL,
    [ActionName] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp111
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp111]
(
    [Roleid] INT NOT NULL,
    [ModuleId] INT NOT NULL,
    [RoleName] VARCHAR(100) NULL,
    [ModuleName] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(10) NULL,
    [Flag] VARCHAR(1) NOT NULL,
    [Level] INT NULL,
    [ControllerName] VARCHAR(100) NULL,
    [ActionName] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [FromDate] DATE NULL,
    [ToDate] DATE NULL,
    [Reason] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Testdata
-- --------------------------------------------------
CREATE TABLE [dbo].[Testdata]
(
    [SomeID] VARCHAR(10) NULL,
    [String] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.usermaster_Bkp02Sept2021
-- --------------------------------------------------
CREATE TABLE [dbo].[usermaster_Bkp02Sept2021]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster_Bkp08June2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster_Bkp08June2021]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster_Bkp21Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster_Bkp21Jan2019]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster_Bkp27Oct2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster_Bkp27Oct2021]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster_Bkp28May2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster_Bkp28May2021]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster19032019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster19032019]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster22032019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster22032019]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster22032019_v2
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster22032019_v2]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserMaster27032019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserMaster27032019]
(
    [Userid] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [password] VARCHAR(100) NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude_Bkp03May2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude_Bkp03May2021]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude_Bkp21Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude_Bkp21Jan2019]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude_Bkp28Feb2020
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude_Bkp28Feb2020]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude_Bkp29Jun2022
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude_Bkp29Jun2022]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude_bkup_08122021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude_bkup_08122021]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude_ForLive
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude_ForLive]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleExclude_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleExclude_Log]
(
    [ModuleId] INT NULL,
    [userid] INT NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [IPaddress] VARCHAR(100) NULL,
    [roleid] INT NULL,
    [EntryDate] DATETIME NULL,
    [Status] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleMappingMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleMappingMaster]
(
    [Userid] VARCHAR(100) NULL,
    [ModuleId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [FromDate] DATE NULL,
    [Todate] DATE NULL,
    [Active] BIT NULL DEFAULT ((1)),
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [Reason] VARCHAR(2000) NULL,
    [IPaddress] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleMappingMaster_bkp01Feb2023
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleMappingMaster_bkp01Feb2023]
(
    [Userid] VARCHAR(100) NULL,
    [ModuleId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [FromDate] DATE NULL,
    [Todate] DATE NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [Reason] VARCHAR(2000) NULL,
    [IPaddress] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleMappingMaster_Bkp02Sept2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleMappingMaster_Bkp02Sept2021]
(
    [Userid] VARCHAR(100) NULL,
    [ModuleId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [FromDate] DATE NULL,
    [Todate] DATE NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [Reason] VARCHAR(2000) NULL,
    [IPaddress] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleMappingMaster_Bkp2022May11
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleMappingMaster_Bkp2022May11]
(
    [Userid] VARCHAR(100) NULL,
    [ModuleId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [FromDate] DATE NULL,
    [Todate] DATE NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [Reason] VARCHAR(2000) NULL,
    [IPaddress] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleMappingMaster_Exclude
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleMappingMaster_Exclude]
(
    [Userid] VARCHAR(100) NULL,
    [ModuleId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [FromDate] DATE NULL,
    [Todate] DATE NULL,
    [Active] BIT NULL DEFAULT ((1)),
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [Reason] VARCHAR(2000) NULL,
    [UpdatedOn] DATETIME NULL DEFAULT (getdate()),
    [IPaddress] VARCHAR(100) NULL,
    [OLDNew] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleMappingMaster_History
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleMappingMaster_History]
(
    [Userid] VARCHAR(100) NULL,
    [ModuleId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [FromDate] DATE NULL,
    [Todate] DATE NULL,
    [Active] BIT NULL DEFAULT ((1)),
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [Reason] VARCHAR(2000) NULL,
    [UpdatedOn] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserModuleMappingMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[UserModuleMappingMaster_Log]
(
    [Userid] VARCHAR(100) NULL,
    [ModuleId] VARCHAR(100) NULL,
    [FreePaid] VARCHAR(100) NULL,
    [FromDate] DATE NULL,
    [Todate] DATE NULL,
    [Active] BIT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL,
    [Reason] VARCHAR(2000) NULL,
    [IPaddress] VARCHAR(2000) NULL,
    [EntryDate] DATETIME NULL,
    [OLDNew] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Bkp02Sept2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Bkp02Sept2021]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Bkp08Jun2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Bkp08Jun2021]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Bkp20July2022
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Bkp20July2022]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Bkp20July2022_New
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Bkp20July2022_New]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Bkp21Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Bkp21Jan2019]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Bkp27Oct2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Bkp27Oct2021]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Bkp28May2021
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Bkp28May2021]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission_Log]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission19032019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission19032019]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission22032019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission22032019]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission22032019_v2
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission22032019_v2]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserRolePermission27032019
-- --------------------------------------------------
CREATE TABLE [dbo].[UserRolePermission27032019]
(
    [Userid] INT NULL,
    [Roleid] INT NULL,
    [ProjectId] INT NULL,
    [createDate] DATETIME NULL,
    [CreateBy] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL,
    [UpdateBy] VARCHAR(100) NULL
);

GO

